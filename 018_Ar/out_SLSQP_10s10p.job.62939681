created virtual environment CPython3.10.2.final.0-64 in 1648ms
  creator CPython3Posix(dest=/localscratch/nike.62939681.0/ENV, clear=True, no_vcs_ignore=False, global=False)
  seeder FromAppData(download=False, pip=bundle, setuptools=bundle, wheel=bundle, via=copy, app_data_dir=/home/nike/.local/share/virtualenv)
    added seed packages: pip==23.0.1, setuptools==67.3.3, wheel==0.38.4+computecanada
  activators BashActivator,CShellActivator,FishActivator,NushellActivator,PowerShellActivator,PythonActivator
Looking in links: /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic
Requirement already satisfied: pip in /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages (23.0.1)
Looking in links: /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic
Processing /home/nike/pyscf_ad/dist/pyscf-2.1.1+ad-cp310-cp310-linux_x86_64.whl
Processing /home/nike/pyscf_properties_ad/dist/pyscf_properties-0.1.0+ad-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/absl_py-1.4.0+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic/contourpy-1.0.7+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/cycler-0.11.0+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/fonttools-4.39.0+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2/h5py-3.8.0+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/jax-0.4.2+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic/jaxlib-0.4.2+cuda11.cudnn82.computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/jaxopt-0.6+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2/kiwisolver-1.4.4+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2/matplotlib-3.7.0+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic/numpy-1.24.2+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/opt_einsum-3.3.0+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/packaging-23.0+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2/Pillow-9.4.0+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/pyparsing-3.0.9+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/pyscfad-0.1.2+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/python_dateutil-2.8.2+computecanada-py2.py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic/scipy-1.10.1+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/six-1.16.0+computecanada-py2.py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/typing_extensions-4.5.0+computecanada-py3-none-any.whl
Installing collected packages: typing_extensions, six, pyparsing, Pillow, packaging, numpy, kiwisolver, fonttools, cycler, absl_py, scipy, python-dateutil, opt-einsum, h5py, contourpy, pyscf, matplotlib, jaxlib, pyscf-properties, jax, jaxopt, pyscfad
Successfully installed Pillow-9.4.0+computecanada absl_py-1.4.0+computecanada contourpy-1.0.7+computecanada cycler-0.11.0+computecanada fonttools-4.39.0+computecanada h5py-3.8.0+computecanada jax-0.4.2+computecanada jaxlib-0.4.2+cuda11.cudnn82.computecanada jaxopt-0.6+computecanada kiwisolver-1.4.4+computecanada matplotlib-3.7.0+computecanada numpy-1.24.2+computecanada opt-einsum-3.3.0+computecanada packaging-23.0+computecanada pyparsing-3.0.9+computecanada pyscf-2.1.1+ad pyscf-properties-0.1.0+ad pyscfad-0.1.2+computecanada python-dateutil-2.8.2+computecanada scipy-1.10.1+computecanada six-1.16.0+computecanada typing_extensions-4.5.0+computecanada

real	1m2.852s
user	0m51.897s
sys	0m2.297s
/project/6004934/nike/basis-set-optimization/018_Ar/./input.py:89: OptimizeWarning: Unknown solver options: maxfev
  res = optimize.minimize(
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:55:04 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558552        1
[INPUT] 0    0    [1    /1   ]  7617.52191563        1
[INPUT] 0    0    [1    /1   ]  3617.35086742        1
[INPUT] 0    0    [1    /1   ]  1597.82569303        1
[INPUT] 0    0    [1    /1   ]  382.851149473        1
[INPUT] 0    0    [1    /1   ]  108.121083403        1
[INPUT] 0    0    [1    /1   ]  34.8054690698        1
[INPUT] 0    0    [1    /1   ]  4.58522390534        1
[INPUT] 0    0    [1    /1   ]  0.395313490558       1
[INPUT] 0    0    [1    /1   ]  0.0995313490558      1
[INPUT] 1    0    [1    /1   ]  1362.78320627        1
[INPUT] 1    0    [1    /1   ]  664.745680987        1
[INPUT] 1    0    [1    /1   ]  300.961991574        1
[INPUT] 1    0    [1    /1   ]  314.042273999        1
[INPUT] 1    0    [1    /1   ]  61.6222358638        1
[INPUT] 1    0    [1    /1   ]  7.32989794841        1
[INPUT] 1    0    [1    /1   ]  20.2391201296        1
[INPUT] 1    0    [1    /1   ]  0.772070364573       1
[INPUT] 1    0    [1    /1   ]  2.80887843481        1
[INPUT] 1    0    [1    /1   ]  0.222573632039       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.65585524854, 1.0]], [0, [7617.521915627052, 1.0]], [0, [3617.3508674245704, 1.0]], [0, [1597.8256930291025, 1.0]], [0, [382.85114947300525, 1.0]], [0, [108.1210834029935, 1.0]], [0, [34.80546906975482, 1.0]], [0, [4.585223905343421, 1.0]], [0, [0.39531349055767473, 1.0]], [0, [0.09953134905576748, 1.0]], [1, [1362.7832062666114, 1.0]], [1, [664.7456809871924, 1.0]], [1, [300.9619915744506, 1.0]], [1, [314.0422739991703, 1.0]], [1, [61.622235863813884, 1.0]], [1, [7.329897948406479, 1.0]], [1, [20.239120129550937, 1.0]], [1, [0.7720703645725635, 1.0]], [1, [2.8088784348099196, 1.0]], [1, [0.22257363203907735, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65585525]
bas 1, expnt(s) = [7617.52191563]
bas 2, expnt(s) = [3617.35086742]
bas 3, expnt(s) = [1597.82569303]
bas 4, expnt(s) = [382.85114947]
bas 5, expnt(s) = [108.1210834]
bas 6, expnt(s) = [34.80546907]
bas 7, expnt(s) = [4.58522391]
bas 8, expnt(s) = [0.39531349]
bas 9, expnt(s) = [0.09953135]
bas 10, expnt(s) = [1362.78320627]
bas 11, expnt(s) = [664.74568099]
bas 12, expnt(s) = [300.96199157]
bas 13, expnt(s) = [314.042274]
bas 14, expnt(s) = [61.62223586]
bas 15, expnt(s) = [7.32989795]
bas 16, expnt(s) = [20.23912013]
bas 17, expnt(s) = [0.77207036]
bas 18, expnt(s) = [2.80887843]
bas 19, expnt(s) = [0.22257363]
CPU time:         1.17
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752192e+03 2.06003837e+03
 3.61735087e+03 1.17844143e+03 1.59782569e+03 6.38501724e+02
 3.82851149e+02 2.18669137e+02 1.08121083e+02 8.47125619e+01
 3.48054691e+01 3.62035070e+01 4.58522391e+00 7.91654045e+00
 3.95313491e-01 1.25956693e+00 9.95313491e-02 4.47697781e-01
 1.36278321e+03 2.41556016e+04 6.64745681e+02 9.84699683e+03
 3.00961992e+02 3.65699156e+03 3.14042274e+02 3.85673265e+03
 6.16222359e+01 5.03681741e+02 7.32989795e+00 3.51849390e+01
 2.02391201e+01 1.25234483e+02 7.72070365e-01 2.11132697e+00
 2.80887843e+00 1.06084167e+01 2.22573632e-01 4.45991451e-01]
ecpbas  = []
2023-03-19 08:55:04.798924: W external/org_tensorflow/tensorflow/tsl/platform/default/dso_loader.cc:67] Could not load dynamic library 'libcuda.so.1'; dlerror: libcuda.so.1: cannot open shared object file: No such file or directory
2023-03-19 08:55:04.799027: W external/org_tensorflow/tensorflow/compiler/xla/stream_executor/cuda/cuda_driver.cc:264] failed call to cuInit: UNKNOWN ERROR (303)
No GPU/TPU found, falling back to CPU. (Set TF_CPP_MIN_LOG_LEVEL=0 and rerun for more info.)
Set gradient conv threshold to 3.16228e-05
/localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscfad/gto/moleintor.py:74: UserWarning: AO symmetry is not supported. Setting aosym = s1.
  warnings.warn(msg)
Nelec from initial guess = 17.98440055434898
cond(S) = 99949.82588436008
E1 = -728.4896179252152  E_coul = 202.75087692926047
init E= -525.738740995955
    CPU time for initialize scf      1.26 sec, wall time      0.21 sec
/localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/jax/_src/numpy/lax_numpy.py:3493: UserWarning: 'kind' argument to argsort is ignored; only 'stable' sorts are supported.
  warnings.warn("'kind' argument to argsort is ignored; only 'stable' sorts "
  HOMO = -0.569146705115262  LUMO = 0.302902912989936
  mo_energy =
[-1.18351897e+02 -1.21386562e+01 -9.47882026e+00 -9.47882026e+00
 -9.47882026e+00 -1.24332748e+00 -5.69146705e-01 -5.69146705e-01
 -5.69146705e-01  3.02902913e-01  1.02079491e+00  1.02079491e+00
  1.02079491e+00  7.30918336e+00  7.30918336e+00  7.30918336e+00
  3.34630332e+01  3.34630332e+01  3.34630332e+01  7.51671604e+01
  1.29090072e+02  1.29090072e+02  1.29090072e+02  4.83492820e+02
  4.83492820e+02  4.83492820e+02  5.59605106e+02  1.33539135e+03
  1.33539135e+03  1.33539135e+03  2.63169834e+03  3.02970537e+03
  3.02970537e+03  3.02970537e+03  6.65026330e+03  6.65026330e+03
  6.65026330e+03  9.03934838e+03  2.53962113e+04  7.61400473e+04]
E1 = -727.4772608484498  E_coul = 200.9716434509406
cycle= 1 E= -526.505617397509  delta_E= -0.767  |g|= 0.199  |ddm|=  0.4
    CPU time for cycle= 1      0.33 sec, wall time      0.33 sec
diis-norm(errvec)=0.574088
diis-c [-0.32957739  1.        ]
  HOMO = -0.592144575316195  LUMO = 0.298938743226604
  mo_energy =
[-1.18659148e+02 -1.22523613e+01 -9.60340397e+00 -9.60340397e+00
 -9.60340397e+00 -1.26918947e+00 -5.92144575e-01 -5.92144575e-01
 -5.92144575e-01  2.98938743e-01  1.00568387e+00  1.00568387e+00
  1.00568387e+00  7.23997887e+00  7.23997887e+00  7.23997887e+00
  3.33292280e+01  3.33292280e+01  3.33292280e+01  7.49791386e+01
  1.28873738e+02  1.28873738e+02  1.28873738e+02  4.83191806e+02
  4.83191806e+02  4.83191806e+02  5.59260691e+02  1.33502810e+03
  1.33502810e+03  1.33502810e+03  2.63119476e+03  3.02927298e+03
  3.02927298e+03  3.02927298e+03  6.64971349e+03  6.64971349e+03
  6.64971349e+03  9.03872051e+03  2.53954873e+04  7.61392315e+04]
E1 = -727.8938503689225  E_coul = 201.38766052971465
cycle= 2 E= -526.506189839208  delta_E= -0.000572  |g|= 0.0306  |ddm|= 0.0323
    CPU time for cycle= 2      0.12 sec, wall time      0.12 sec
diis-norm(errvec)=0.0591013
diis-c [-0.00200163  0.06320852  0.93679148]
  HOMO = -0.586226999862876  LUMO = 0.30102552422296
  mo_energy =
[-1.18604368e+02 -1.22241019e+01 -9.57447760e+00 -9.57447760e+00
 -9.57447760e+00 -1.26184899e+00 -5.86227000e-01 -5.86227000e-01
 -5.86227000e-01  3.01025524e-01  1.01011810e+00  1.01011810e+00
  1.01011810e+00  7.25629795e+00  7.25629795e+00  7.25629795e+00
  3.33588266e+01  3.33588266e+01  3.33588266e+01  7.50236883e+01
  1.28917650e+02  1.28917650e+02  1.28917650e+02  4.83245888e+02
  4.83245888e+02  4.83245888e+02  5.59317111e+02  1.33508578e+03
  1.33508578e+03  1.33508578e+03  2.63125497e+03  3.02933247e+03
  3.02933247e+03  3.02933247e+03  6.64977411e+03  6.64977411e+03
  6.64977411e+03  9.03878160e+03  2.53955486e+04  7.61392929e+04]
E1 = -727.797641205619  E_coul = 201.29142366311888
cycle= 3 E= -526.5062175425  delta_E= -2.77e-05  |g|= 0.00403  |ddm|= 0.0109
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00859236
diis-c [-9.65816386e-07 -1.33151516e-03  1.19314977e-01  8.82016538e-01]
  HOMO = -0.587349038258587  LUMO = 0.300679133753624
  mo_energy =
[-1.18611504e+02 -1.22282774e+01 -9.57884037e+00 -9.57884037e+00
 -9.57884037e+00 -1.26309366e+00 -5.87349038e-01 -5.87349038e-01
 -5.87349038e-01  3.00679134e-01  1.00930913e+00  1.00930913e+00
  1.00930913e+00  7.25358130e+00  7.25358130e+00  7.25358130e+00
  3.33544348e+01  3.33544348e+01  3.33544348e+01  7.50178393e+01
  1.28911691e+02  1.28911691e+02  1.28911691e+02  4.83238842e+02
  4.83238842e+02  4.83238842e+02  5.59309762e+02  1.33507828e+03
  1.33507828e+03  1.33507828e+03  2.63124697e+03  3.02932467e+03
  3.02932467e+03  3.02932467e+03  6.64976600e+03  6.64976600e+03
  6.64976600e+03  9.03877332e+03  2.53955401e+04  7.61392844e+04]
E1 = -727.8114303861848  E_coul = 201.30521208950893
cycle= 4 E= -526.506218296676  delta_E= -7.54e-07  |g|= 0.000118  |ddm|= 0.00134
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000118343
diis-c [-8.06408354e-09  3.12389056e-05 -5.13506462e-03 -2.84079123e-02
  1.03351174e+00]
  HOMO = -0.587310518905063  LUMO = 0.300700492972313
  mo_energy =
[-1.18611343e+02 -1.22281299e+01 -9.57869787e+00 -9.57869787e+00
 -9.57869787e+00 -1.26302575e+00 -5.87310519e-01 -5.87310519e-01
 -5.87310519e-01  3.00700493e-01  1.00933873e+00  1.00933873e+00
  1.00933873e+00  7.25368041e+00  7.25368041e+00  7.25368041e+00
  3.33545729e+01  3.33545729e+01  3.33545729e+01  7.50180053e+01
  1.28911848e+02  1.28911848e+02  1.28911848e+02  4.83239003e+02
  4.83239003e+02  4.83239003e+02  5.59309918e+02  1.33507844e+03
  1.33507844e+03  1.33507844e+03  2.63124711e+03  3.02932482e+03
  3.02932482e+03  3.02932482e+03  6.64976614e+03  6.64976614e+03
  6.64976614e+03  9.03877345e+03  2.53955403e+04  7.61392845e+04]
E1 = -727.8109470008714  E_coul = 201.30472870073805
cycle= 5 E= -526.506218300133  delta_E= -3.46e-09  |g|= 2.32e-05  |ddm|= 0.000227
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.79043e-05
diis-c [-1.90428893e-10  1.45701912e-05 -1.30147218e-03 -1.33813452e-02
  7.77335898e-03  1.00689489e+00]
  HOMO = -0.587320708652103  LUMO = 0.300698597962333
  mo_energy =
[-1.18611378e+02 -1.22281571e+01 -9.57872651e+00 -9.57872651e+00
 -9.57872651e+00 -1.26303354e+00 -5.87320709e-01 -5.87320709e-01
 -5.87320709e-01  3.00698598e-01  1.00933182e+00  1.00933182e+00
  1.00933182e+00  7.25366005e+00  7.25366005e+00  7.25366005e+00
  3.33545450e+01  3.33545450e+01  3.33545450e+01  7.50179740e+01
  1.28911816e+02  1.28911816e+02  1.28911816e+02  4.83238968e+02
  4.83238968e+02  4.83238968e+02  5.59309882e+02  1.33507840e+03
  1.33507840e+03  1.33507840e+03  2.63124708e+03  3.02932478e+03
  3.02932478e+03  3.02932478e+03  6.64976610e+03  6.64976610e+03
  6.64976610e+03  9.03877341e+03  2.53955402e+04  7.61392845e+04]
E1 = -727.8110210783918  E_coul = 201.30480277814553
cycle= 6 E= -526.506218300246  delta_E= -1.13e-10  |g|= 2.18e-06  |ddm|= 3.38e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -727.8110210783918  E_coul = 201.30480277814553
  HOMO = -0.587320807992265  LUMO = 0.300698754668182
  mo_energy =
[-1.18611377e+02 -1.22281567e+01 -9.57872613e+00 -9.57872613e+00
 -9.57872613e+00 -1.26303313e+00 -5.87320808e-01 -5.87320808e-01
 -5.87320808e-01  3.00698755e-01  1.00933180e+00  1.00933180e+00
  1.00933180e+00  7.25366020e+00  7.25366020e+00  7.25366020e+00
  3.33545454e+01  3.33545454e+01  3.33545454e+01  7.50179747e+01
  1.28911816e+02  1.28911816e+02  1.28911816e+02  4.83238969e+02
  4.83238969e+02  4.83238969e+02  5.59309883e+02  1.33507840e+03
  1.33507840e+03  1.33507840e+03  2.63124708e+03  3.02932478e+03
  3.02932478e+03  3.02932478e+03  6.64976610e+03  6.64976610e+03
  6.64976610e+03  9.03877341e+03  2.53955402e+04  7.61392845e+04]
E1 = -727.811018193611  E_coul = 201.3047998933623
Extra cycle  E= -526.506218300249  delta_E= -2.39e-12  |g|= 4.53e-07  |ddm|= 4.72e-06
    CPU time for scf_cycle      1.87 sec, wall time      0.82 sec
exp = [2.61826559e+04 7.61752192e+03 3.61735087e+03 1.59782569e+03
 3.82851149e+02 1.08121083e+02 3.48054691e+01 4.58522391e+00
 3.95313491e-01 9.95313491e-02 1.36278321e+03 6.64745681e+02
 3.00961992e+02 3.14042274e+02 6.16222359e+01 7.32989795e+00
 2.02391201e+01 7.72070365e-01 2.80887843e+00 2.22573632e-01]
E = -526.5062183002486
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:55:05 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558552        1
[INPUT] 0    0    [1    /1   ]  7617.52191563        1
[INPUT] 0    0    [1    /1   ]  3617.35086742        1
[INPUT] 0    0    [1    /1   ]  1597.82569303        1
[INPUT] 0    0    [1    /1   ]  382.851149473        1
[INPUT] 0    0    [1    /1   ]  108.121083403        1
[INPUT] 0    0    [1    /1   ]  34.8054690698        1
[INPUT] 0    0    [1    /1   ]  4.58522390534        1
[INPUT] 0    0    [1    /1   ]  0.395313490558       1
[INPUT] 0    0    [1    /1   ]  0.0995313490558      1
[INPUT] 1    0    [1    /1   ]  1362.78320627        1
[INPUT] 1    0    [1    /1   ]  664.745680987        1
[INPUT] 1    0    [1    /1   ]  300.961991574        1
[INPUT] 1    0    [1    /1   ]  314.042273999        1
[INPUT] 1    0    [1    /1   ]  61.6222358638        1
[INPUT] 1    0    [1    /1   ]  7.32989794841        1
[INPUT] 1    0    [1    /1   ]  20.2391201296        1
[INPUT] 1    0    [1    /1   ]  0.772070364573       1
[INPUT] 1    0    [1    /1   ]  2.80887843481        1
[INPUT] 1    0    [1    /1   ]  0.222573632039       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.65585524854, 1.0]], [0, [7617.521915627052, 1.0]], [0, [3617.3508674245704, 1.0]], [0, [1597.8256930291025, 1.0]], [0, [382.85114947300525, 1.0]], [0, [108.1210834029935, 1.0]], [0, [34.80546906975482, 1.0]], [0, [4.585223905343421, 1.0]], [0, [0.39531349055767473, 1.0]], [0, [0.09953134905576748, 1.0]], [1, [1362.7832062666114, 1.0]], [1, [664.7456809871924, 1.0]], [1, [300.9619915744506, 1.0]], [1, [314.0422739991703, 1.0]], [1, [61.622235863813884, 1.0]], [1, [7.329897948406479, 1.0]], [1, [20.239120129550937, 1.0]], [1, [0.7720703645725635, 1.0]], [1, [2.8088784348099196, 1.0]], [1, [0.22257363203907735, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65585525]
bas 1, expnt(s) = [7617.52191563]
bas 2, expnt(s) = [3617.35086742]
bas 3, expnt(s) = [1597.82569303]
bas 4, expnt(s) = [382.85114947]
bas 5, expnt(s) = [108.1210834]
bas 6, expnt(s) = [34.80546907]
bas 7, expnt(s) = [4.58522391]
bas 8, expnt(s) = [0.39531349]
bas 9, expnt(s) = [0.09953135]
bas 10, expnt(s) = [1362.78320627]
bas 11, expnt(s) = [664.74568099]
bas 12, expnt(s) = [300.96199157]
bas 13, expnt(s) = [314.042274]
bas 14, expnt(s) = [61.62223586]
bas 15, expnt(s) = [7.32989795]
bas 16, expnt(s) = [20.23912013]
bas 17, expnt(s) = [0.77207036]
bas 18, expnt(s) = [2.80887843]
bas 19, expnt(s) = [0.22257363]
CPU time:         3.40
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752192e+03 2.06003837e+03
 3.61735087e+03 1.17844143e+03 1.59782569e+03 6.38501724e+02
 3.82851149e+02 2.18669137e+02 1.08121083e+02 8.47125619e+01
 3.48054691e+01 3.62035070e+01 4.58522391e+00 7.91654045e+00
 3.95313491e-01 1.25956693e+00 9.95313491e-02 4.47697781e-01
 1.36278321e+03 2.41556016e+04 6.64745681e+02 9.84699683e+03
 3.00961992e+02 3.65699156e+03 3.14042274e+02 3.85673265e+03
 6.16222359e+01 5.03681741e+02 7.32989795e+00 3.51849390e+01
 2.02391201e+01 1.25234483e+02 7.72070365e-01 2.11132697e+00
 2.80887843e+00 1.06084167e+01 2.22573632e-01 4.45991451e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98440055434898
cond(S) = 99949.82588436008
E1 = -728.4896179252152  E_coul = 202.75087692926047
init E= -525.738740995955
    CPU time for initialize scf      0.67 sec, wall time      0.05 sec
  HOMO = -0.569146705115262  LUMO = 0.302902912989936
  mo_energy =
[-1.18351897e+02 -1.21386562e+01 -9.47882026e+00 -9.47882026e+00
 -9.47882026e+00 -1.24332748e+00 -5.69146705e-01 -5.69146705e-01
 -5.69146705e-01  3.02902913e-01  1.02079491e+00  1.02079491e+00
  1.02079491e+00  7.30918336e+00  7.30918336e+00  7.30918336e+00
  3.34630332e+01  3.34630332e+01  3.34630332e+01  7.51671604e+01
  1.29090072e+02  1.29090072e+02  1.29090072e+02  4.83492820e+02
  4.83492820e+02  4.83492820e+02  5.59605106e+02  1.33539135e+03
  1.33539135e+03  1.33539135e+03  2.63169834e+03  3.02970537e+03
  3.02970537e+03  3.02970537e+03  6.65026330e+03  6.65026330e+03
  6.65026330e+03  9.03934838e+03  2.53962113e+04  7.61400473e+04]
E1 = -727.4772608484498  E_coul = 200.9716434509406
cycle= 1 E= -526.505617397509  delta_E= -0.767  |g|= 0.199  |ddm|=  0.4
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.574088
diis-c [-0.32957739  1.        ]
  HOMO = -0.592144575316195  LUMO = 0.298938743226604
  mo_energy =
[-1.18659148e+02 -1.22523613e+01 -9.60340397e+00 -9.60340397e+00
 -9.60340397e+00 -1.26918947e+00 -5.92144575e-01 -5.92144575e-01
 -5.92144575e-01  2.98938743e-01  1.00568387e+00  1.00568387e+00
  1.00568387e+00  7.23997887e+00  7.23997887e+00  7.23997887e+00
  3.33292280e+01  3.33292280e+01  3.33292280e+01  7.49791386e+01
  1.28873738e+02  1.28873738e+02  1.28873738e+02  4.83191806e+02
  4.83191806e+02  4.83191806e+02  5.59260691e+02  1.33502810e+03
  1.33502810e+03  1.33502810e+03  2.63119476e+03  3.02927298e+03
  3.02927298e+03  3.02927298e+03  6.64971349e+03  6.64971349e+03
  6.64971349e+03  9.03872051e+03  2.53954873e+04  7.61392315e+04]
E1 = -727.8938503689225  E_coul = 201.38766052971465
cycle= 2 E= -526.506189839208  delta_E= -0.000572  |g|= 0.0306  |ddm|= 0.0323
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0591013
diis-c [-0.00200163  0.06320852  0.93679148]
  HOMO = -0.586226999862876  LUMO = 0.30102552422296
  mo_energy =
[-1.18604368e+02 -1.22241019e+01 -9.57447760e+00 -9.57447760e+00
 -9.57447760e+00 -1.26184899e+00 -5.86227000e-01 -5.86227000e-01
 -5.86227000e-01  3.01025524e-01  1.01011810e+00  1.01011810e+00
  1.01011810e+00  7.25629795e+00  7.25629795e+00  7.25629795e+00
  3.33588266e+01  3.33588266e+01  3.33588266e+01  7.50236883e+01
  1.28917650e+02  1.28917650e+02  1.28917650e+02  4.83245888e+02
  4.83245888e+02  4.83245888e+02  5.59317111e+02  1.33508578e+03
  1.33508578e+03  1.33508578e+03  2.63125497e+03  3.02933247e+03
  3.02933247e+03  3.02933247e+03  6.64977411e+03  6.64977411e+03
  6.64977411e+03  9.03878160e+03  2.53955486e+04  7.61392929e+04]
E1 = -727.797641205619  E_coul = 201.29142366311888
cycle= 3 E= -526.5062175425  delta_E= -2.77e-05  |g|= 0.00403  |ddm|= 0.0109
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00859236
diis-c [-9.65816386e-07 -1.33151516e-03  1.19314977e-01  8.82016538e-01]
  HOMO = -0.587349038258587  LUMO = 0.300679133753624
  mo_energy =
[-1.18611504e+02 -1.22282774e+01 -9.57884037e+00 -9.57884037e+00
 -9.57884037e+00 -1.26309366e+00 -5.87349038e-01 -5.87349038e-01
 -5.87349038e-01  3.00679134e-01  1.00930913e+00  1.00930913e+00
  1.00930913e+00  7.25358130e+00  7.25358130e+00  7.25358130e+00
  3.33544348e+01  3.33544348e+01  3.33544348e+01  7.50178393e+01
  1.28911691e+02  1.28911691e+02  1.28911691e+02  4.83238842e+02
  4.83238842e+02  4.83238842e+02  5.59309762e+02  1.33507828e+03
  1.33507828e+03  1.33507828e+03  2.63124697e+03  3.02932467e+03
  3.02932467e+03  3.02932467e+03  6.64976600e+03  6.64976600e+03
  6.64976600e+03  9.03877332e+03  2.53955401e+04  7.61392844e+04]
E1 = -727.8114303861848  E_coul = 201.30521208950893
cycle= 4 E= -526.506218296676  delta_E= -7.54e-07  |g|= 0.000118  |ddm|= 0.00134
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000118343
diis-c [-8.06408354e-09  3.12389056e-05 -5.13506462e-03 -2.84079123e-02
  1.03351174e+00]
  HOMO = -0.587310518905063  LUMO = 0.300700492972313
  mo_energy =
[-1.18611343e+02 -1.22281299e+01 -9.57869787e+00 -9.57869787e+00
 -9.57869787e+00 -1.26302575e+00 -5.87310519e-01 -5.87310519e-01
 -5.87310519e-01  3.00700493e-01  1.00933873e+00  1.00933873e+00
  1.00933873e+00  7.25368041e+00  7.25368041e+00  7.25368041e+00
  3.33545729e+01  3.33545729e+01  3.33545729e+01  7.50180053e+01
  1.28911848e+02  1.28911848e+02  1.28911848e+02  4.83239003e+02
  4.83239003e+02  4.83239003e+02  5.59309918e+02  1.33507844e+03
  1.33507844e+03  1.33507844e+03  2.63124711e+03  3.02932482e+03
  3.02932482e+03  3.02932482e+03  6.64976614e+03  6.64976614e+03
  6.64976614e+03  9.03877345e+03  2.53955403e+04  7.61392845e+04]
E1 = -727.8109470008714  E_coul = 201.30472870073805
cycle= 5 E= -526.506218300133  delta_E= -3.46e-09  |g|= 2.32e-05  |ddm|= 0.000227
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.79043e-05
diis-c [-1.90428893e-10  1.45701912e-05 -1.30147218e-03 -1.33813452e-02
  7.77335898e-03  1.00689489e+00]
  HOMO = -0.587320708652103  LUMO = 0.300698597962333
  mo_energy =
[-1.18611378e+02 -1.22281571e+01 -9.57872651e+00 -9.57872651e+00
 -9.57872651e+00 -1.26303354e+00 -5.87320709e-01 -5.87320709e-01
 -5.87320709e-01  3.00698598e-01  1.00933182e+00  1.00933182e+00
  1.00933182e+00  7.25366005e+00  7.25366005e+00  7.25366005e+00
  3.33545450e+01  3.33545450e+01  3.33545450e+01  7.50179740e+01
  1.28911816e+02  1.28911816e+02  1.28911816e+02  4.83238968e+02
  4.83238968e+02  4.83238968e+02  5.59309882e+02  1.33507840e+03
  1.33507840e+03  1.33507840e+03  2.63124708e+03  3.02932478e+03
  3.02932478e+03  3.02932478e+03  6.64976610e+03  6.64976610e+03
  6.64976610e+03  9.03877341e+03  2.53955402e+04  7.61392845e+04]
E1 = -727.8110210783918  E_coul = 201.30480277814553
cycle= 6 E= -526.506218300246  delta_E= -1.13e-10  |g|= 2.18e-06  |ddm|= 3.38e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -727.8110210783918  E_coul = 201.30480277814553
  HOMO = -0.587320807992265  LUMO = 0.300698754668182
  mo_energy =
[-1.18611377e+02 -1.22281567e+01 -9.57872613e+00 -9.57872613e+00
 -9.57872613e+00 -1.26303313e+00 -5.87320808e-01 -5.87320808e-01
 -5.87320808e-01  3.00698755e-01  1.00933180e+00  1.00933180e+00
  1.00933180e+00  7.25366020e+00  7.25366020e+00  7.25366020e+00
  3.33545454e+01  3.33545454e+01  3.33545454e+01  7.50179747e+01
  1.28911816e+02  1.28911816e+02  1.28911816e+02  4.83238969e+02
  4.83238969e+02  4.83238969e+02  5.59309883e+02  1.33507840e+03
  1.33507840e+03  1.33507840e+03  2.63124708e+03  3.02932478e+03
  3.02932478e+03  3.02932478e+03  6.64976610e+03  6.64976610e+03
  6.64976610e+03  9.03877341e+03  2.53955402e+04  7.61392845e+04]
E1 = -727.811018193611  E_coul = 201.3047998933623
Extra cycle  E= -526.506218300249  delta_E= -2.39e-12  |g|= 4.53e-07  |ddm|= 4.72e-06
    CPU time for scf_cycle      0.90 sec, wall time      0.26 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 99949.82588436008
E1 = -727.811018193611  E_coul = 201.3047998933623
init E= -526.506218300249
    CPU time for initialize scf      6.93 sec, wall time      0.53 sec
  HOMO = -0.587320904784095  LUMO = 0.300698761576254
  mo_energy =
[-1.18611377e+02 -1.22281569e+01 -9.57872635e+00 -9.57872635e+00
 -9.57872635e+00 -1.26303313e+00 -5.87320905e-01 -5.87320905e-01
 -5.87320905e-01  3.00698762e-01  1.00933174e+00  1.00933174e+00
  1.00933174e+00  7.25366004e+00  7.25366004e+00  7.25366004e+00
  3.33545452e+01  3.33545452e+01  3.33545452e+01  7.50179744e+01
  1.28911816e+02  1.28911816e+02  1.28911816e+02  4.83238969e+02
  4.83238969e+02  4.83238969e+02  5.59309883e+02  1.33507840e+03
  1.33507840e+03  1.33507840e+03  2.63124708e+03  3.02932478e+03
  3.02932478e+03  3.02932478e+03  6.64976610e+03  6.64976610e+03
  6.64976610e+03  9.03877341e+03  2.53955402e+04  7.61392845e+04]
E1 = -727.8110185507264  E_coul = 201.30480025047734
cycle= 1 E= -526.506218300249  delta_E= -4.55e-13  |g|= 9.59e-08  |ddm|= 9.26e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.8110185507264  E_coul = 201.30480025047734
  HOMO = -0.587320906745598  LUMO = 0.300698768977646
  mo_energy =
[-1.18611377e+02 -1.22281569e+01 -9.57872632e+00 -9.57872632e+00
 -9.57872632e+00 -1.26303311e+00 -5.87320907e-01 -5.87320907e-01
 -5.87320907e-01  3.00698769e-01  1.00933174e+00  1.00933174e+00
  1.00933174e+00  7.25366005e+00  7.25366005e+00  7.25366005e+00
  3.33545452e+01  3.33545452e+01  3.33545452e+01  7.50179745e+01
  1.28911816e+02  1.28911816e+02  1.28911816e+02  4.83238969e+02
  4.83238969e+02  4.83238969e+02  5.59309883e+02  1.33507840e+03
  1.33507840e+03  1.33507840e+03  2.63124708e+03  3.02932478e+03
  3.02932478e+03  3.02932478e+03  6.64976610e+03  6.64976610e+03
  6.64976610e+03  9.03877341e+03  2.53955402e+04  7.61392845e+04]
E1 = -727.8110183964926  E_coul = 201.30480009624264
Extra cycle  E= -526.50621830025  delta_E= -9.09e-13  |g|= 1.96e-08  |ddm|= 2e-07
    CPU time for scf_cycle      8.07 sec, wall time      1.67 sec
exp = [2.61826559e+04 7.61752192e+03 3.61735087e+03 1.59782569e+03
 3.82851149e+02 1.08121083e+02 3.48054691e+01 4.58522391e+00
 3.95313491e-01 9.95313491e-02 1.36278321e+03 6.64745681e+02
 3.00961992e+02 3.14042274e+02 6.16222359e+01 7.32989795e+00
 2.02391201e+01 7.72070365e-01 2.80887843e+00 2.22573632e-01]
grad_E = [-1.51074249e-06  3.30485634e-06 -1.44253777e-06  6.90208517e-05
  2.36722602e-05 -2.32663979e-05  8.36669962e-05 -3.19653446e-02
 -4.25881788e-01 -1.51531605e-01 -5.10152069e-07  4.98118959e-06
  2.34455950e-05  2.02154308e-05  8.91097408e-06  1.10882091e-03
 -2.53169300e-04 -1.51965970e-03 -1.45169909e-03 -3.79252751e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:55:13 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558568        1
[INPUT] 0    0    [1    /1   ]  7617.52191232        1
[INPUT] 0    0    [1    /1   ]  3617.35086887        1
[INPUT] 0    0    [1    /1   ]  1597.82562401        1
[INPUT] 0    0    [1    /1   ]  382.851125801        1
[INPUT] 0    0    [1    /1   ]  108.121106669        1
[INPUT] 0    0    [1    /1   ]  34.8053854028        1
[INPUT] 0    0    [1    /1   ]  4.61718924992        1
[INPUT] 0    0    [1    /1   ]  0.821195278753       1
[INPUT] 0    0    [1    /1   ]  0.251062954242       1
[INPUT] 1    0    [1    /1   ]  1362.78320678        1
[INPUT] 1    0    [1    /1   ]  664.745676006        1
[INPUT] 1    0    [1    /1   ]  300.961968129        1
[INPUT] 1    0    [1    /1   ]  314.042253784        1
[INPUT] 1    0    [1    /1   ]  61.6222269528        1
[INPUT] 1    0    [1    /1   ]  7.32878912749        1
[INPUT] 1    0    [1    /1   ]  20.2393732989        1
[INPUT] 1    0    [1    /1   ]  0.773590024277       1
[INPUT] 1    0    [1    /1   ]  2.8103301339         1
[INPUT] 1    0    [1    /1   ]  0.226366159545       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.655856759284, 1.0]], [0, [7617.521912322196, 1.0]], [0, [3617.350868867108, 1.0]], [0, [1597.8256240082508, 1.0]], [0, [382.851125800745, 1.0]], [0, [108.12110666939145, 1.0]], [0, [34.80538540275867, 1.0]], [0, [4.617189249916105, 1.0]], [0, [0.8211952787525036, 1.0]], [0, [0.25106295424170294, 1.0]], [1, [1362.7832067767636, 1.0]], [1, [664.7456760060028, 1.0]], [1, [300.96196812885563, 1.0]], [1, [314.04225378373945, 1.0]], [1, [61.62222695283981, 1.0]], [1, [7.3287891274928425, 1.0]], [1, [20.239373298850868, 1.0]], [1, [0.7735900242774747, 1.0]], [1, [2.810330133898768, 1.0]], [1, [0.22636615954464437, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65585676]
bas 1, expnt(s) = [7617.52191232]
bas 2, expnt(s) = [3617.35086887]
bas 3, expnt(s) = [1597.82562401]
bas 4, expnt(s) = [382.8511258]
bas 5, expnt(s) = [108.12110667]
bas 6, expnt(s) = [34.8053854]
bas 7, expnt(s) = [4.61718925]
bas 8, expnt(s) = [0.82119528]
bas 9, expnt(s) = [0.25106295]
bas 10, expnt(s) = [1362.78320678]
bas 11, expnt(s) = [664.74567601]
bas 12, expnt(s) = [300.96196813]
bas 13, expnt(s) = [314.04225378]
bas 14, expnt(s) = [61.62222695]
bas 15, expnt(s) = [7.32878913]
bas 16, expnt(s) = [20.2393733]
bas 17, expnt(s) = [0.77359002]
bas 18, expnt(s) = [2.81033013]
bas 19, expnt(s) = [0.22636616]
CPU time:        19.61
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752191e+03 2.06003836e+03
 3.61735087e+03 1.17844143e+03 1.59782562e+03 6.38501704e+02
 3.82851126e+02 2.18669127e+02 1.08121107e+02 8.47125755e+01
 3.48053854e+01 3.62034418e+01 4.61718925e+00 7.95789640e+00
 8.21195279e-01 2.17946479e+00 2.51062954e-01 8.96090763e-01
 1.36278321e+03 2.41556017e+04 6.64745676e+02 9.84699673e+03
 3.00961968e+02 3.65699120e+03 3.14042254e+02 3.85673234e+03
 6.16222270e+01 5.03681650e+02 7.32878913e+00 3.51782860e+01
 2.02393733e+01 1.25236441e+02 7.73590024e-01 2.11652288e+00
 2.81033013e+00 1.06152706e+01 2.26366160e-01 4.55510897e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.985576905285523
cond(S) = 100216.865980071
E1 = -728.9192842641086  E_coul = 203.1578719168711
init E= -525.761412347237
    CPU time for initialize scf      0.79 sec, wall time      0.05 sec
  HOMO = -0.56027532791629  LUMO = 1.04127058818542
  mo_energy =
[-1.18322903e+02 -1.21334214e+01 -9.44538691e+00 -9.44538691e+00
 -9.44538691e+00 -1.22680599e+00 -5.60275328e-01 -5.60275328e-01
 -5.60275328e-01  1.04127059e+00  1.04127059e+00  1.04127059e+00
  1.37655660e+00  7.35535621e+00  7.35535621e+00  7.35535621e+00
  3.35148226e+01  3.35148226e+01  3.35148226e+01  7.76906815e+01
  1.29135454e+02  1.29135454e+02  1.29135454e+02  4.83533753e+02
  4.83533753e+02  4.83533753e+02  5.61479669e+02  1.33543131e+03
  1.33543131e+03  1.33543131e+03  2.63326978e+03  3.02974439e+03
  3.02974439e+03  3.02974439e+03  6.65030148e+03  6.65030148e+03
  6.65030148e+03  9.04077739e+03  2.53975616e+04  7.61413059e+04]
E1 = -727.195992198652  E_coul = 200.63999399432547
cycle= 1 E= -526.555998204327  delta_E= -0.795  |g|= 0.234  |ddm|= 0.524
    CPU time for cycle= 1      0.08 sec, wall time      0.02 sec
diis-norm(errvec)=0.637698
diis-c [-0.4066582  1.       ]
  HOMO = -0.599502599694784  LUMO = 1.01490775411434
  mo_energy =
[-1.18711210e+02 -1.22959810e+01 -9.62850115e+00 -9.62850115e+00
 -9.62850115e+00 -1.26764000e+00 -5.99502600e-01 -5.99502600e-01
 -5.99502600e-01  1.01490775e+00  1.01490775e+00  1.01490775e+00
  1.33850827e+00  7.24739997e+00  7.24739997e+00  7.24739997e+00
  3.33231796e+01  3.33231796e+01  3.33231796e+01  7.74312905e+01
  1.28847808e+02  1.28847808e+02  1.28847808e+02  4.83152210e+02
  4.83152210e+02  4.83152210e+02  5.61051056e+02  1.33498252e+03
  1.33498252e+03  1.33498252e+03  2.63267415e+03  3.02922289e+03
  3.02922289e+03  3.02922289e+03  6.64965817e+03  6.64965817e+03
  6.64965817e+03  9.04005353e+03  2.53967393e+04  7.61403903e+04]
E1 = -727.8901250294533  E_coul = 201.33282131834844
cycle= 2 E= -526.557303711105  delta_E= -0.00131  |g|= 0.0466  |ddm|= 0.0624
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0867938
diis-c [-0.00338735  0.09205854  0.90794146]
  HOMO = -0.58878639483595  LUMO = 1.02294771329815
  mo_energy =
[-1.18629548e+02 -1.22503216e+01 -9.58127636e+00 -9.58127636e+00
 -9.58127636e+00 -1.25414077e+00 -5.88786395e-01 -5.88786395e-01
 -5.88786395e-01  1.02294771e+00  1.02294771e+00  1.02294771e+00
  1.35253438e+00  7.27548873e+00  7.27548873e+00  7.27548873e+00
  3.33708919e+01  3.33708919e+01  3.33708919e+01  7.74989148e+01
  1.28915054e+02  1.28915054e+02  1.28915054e+02  4.83232907e+02
  4.83232907e+02  4.83232907e+02  5.61134710e+02  1.33506790e+03
  1.33506790e+03  1.33506790e+03  2.63276284e+03  3.02931061e+03
  3.02931061e+03  3.02931061e+03  6.64974743e+03  6.64974743e+03
  6.64974743e+03  9.04014345e+03  2.53968296e+04  7.61404807e+04]
E1 = -727.7108099899219  E_coul = 201.15341306058218
cycle= 3 E= -526.55739692934  delta_E= -9.32e-05  |g|= 0.00672  |ddm|= 0.0242
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0143581
diis-c [-4.73998708e-06 -2.25525365e-03  1.30785967e-01  8.71469287e-01]
  HOMO = -0.590570586618314  LUMO = 1.02168951078681
  mo_energy =
[-1.18640388e+02 -1.22568347e+01 -9.58828911e+00 -9.58828911e+00
 -9.58828911e+00 -1.25588205e+00 -5.90570587e-01 -5.90570587e-01
 -5.90570587e-01  1.02168951e+00  1.02168951e+00  1.02168951e+00
  1.35080367e+00  7.27111658e+00  7.27111658e+00  7.27111658e+00
  3.33639248e+01  3.33639248e+01  3.33639248e+01  7.74899895e+01
  1.28905854e+02  1.28905854e+02  1.28905854e+02  4.83222202e+02
  4.83222202e+02  4.83222202e+02  5.61123564e+02  1.33505654e+03
  1.33505654e+03  1.33505654e+03  2.63275067e+03  3.02929878e+03
  3.02929878e+03  3.02929878e+03  6.64973509e+03  6.64973509e+03
  6.64973509e+03  9.04013081e+03  2.53968167e+04  7.61404677e+04]
E1 = -727.7365638006377  E_coul = 201.17916396903763
cycle= 4 E= -526.5573998316  delta_E= -2.9e-06  |g|= 0.000402  |ddm|= 0.0027
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000372272
diis-c [-2.78592193e-08  1.42271456e-04 -1.41182581e-02 -1.08898420e-01
  1.12287441e+00]
  HOMO = -0.590527663033661  LUMO = 1.02173043576823
  mo_energy =
[-1.18640296e+02 -1.22566836e+01 -9.58817919e+00 -9.58817919e+00
 -9.58817919e+00 -1.25573854e+00 -5.90527663e-01 -5.90527663e-01
 -5.90527663e-01  1.02173044e+00  1.02173044e+00  1.02173044e+00
  1.35095666e+00  7.27121395e+00  7.27121395e+00  7.27121395e+00
  3.33640361e+01  3.33640361e+01  3.33640361e+01  7.74901325e+01
  1.28905963e+02  1.28905963e+02  1.28905963e+02  4.83222296e+02
  4.83222296e+02  4.83222296e+02  5.61123636e+02  1.33505660e+03
  1.33505660e+03  1.33505660e+03  2.63275068e+03  3.02929882e+03
  3.02929882e+03  3.02929882e+03  6.64973508e+03  6.64973508e+03
  6.64973508e+03  9.04013078e+03  2.53968166e+04  7.61404676e+04]
E1 = -727.736107332851  E_coul = 201.178707466735
cycle= 5 E= -526.557399866116  delta_E= -3.45e-08  |g|= 5.77e-05  |ddm|= 0.000653
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000102809
diis-c [-5.07316878e-10  2.58049166e-05 -1.57587043e-03 -1.73692022e-02
  2.06589226e-02  9.98260345e-01]
  HOMO = -0.590547195295194  LUMO = 1.02171752875833
  mo_energy =
[-1.18640377e+02 -1.22567442e+01 -9.58824539e+00 -9.58824539e+00
 -9.58824539e+00 -1.25575105e+00 -5.90547195e-01 -5.90547195e-01
 -5.90547195e-01  1.02171753e+00  1.02171753e+00  1.02171753e+00
  1.35094519e+00  7.27116981e+00  7.27116981e+00  7.27116981e+00
  3.33639725e+01  3.33639725e+01  3.33639725e+01  7.74900610e+01
  1.28905888e+02  1.28905888e+02  1.28905888e+02  4.83222215e+02
  4.83222215e+02  4.83222215e+02  5.61123554e+02  1.33505652e+03
  1.33505652e+03  1.33505652e+03  2.63275059e+03  3.02929874e+03
  3.02929874e+03  3.02929874e+03  6.64973500e+03  6.64973500e+03
  6.64973500e+03  9.04013069e+03  2.53968165e+04  7.61404675e+04]
E1 = -727.7363360305928  E_coul = 201.17893616395486
cycle= 6 E= -526.557399866638  delta_E= -5.22e-10  |g|= 3.01e-06  |ddm|= 5.78e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -727.7363360305928  E_coul = 201.17893616395486
  HOMO = -0.59054644446318  LUMO = 1.02171812736321
  mo_energy =
[-1.18640373e+02 -1.22567415e+01 -9.58824269e+00 -9.58824269e+00
 -9.58824269e+00 -1.25574967e+00 -5.90546444e-01 -5.90546444e-01
 -5.90546444e-01  1.02171813e+00  1.02171813e+00  1.02171813e+00
  1.35094661e+00  7.27117164e+00  7.27117164e+00  7.27117164e+00
  3.33639752e+01  3.33639752e+01  3.33639752e+01  7.74900644e+01
  1.28905892e+02  1.28905892e+02  1.28905892e+02  4.83222219e+02
  4.83222219e+02  4.83222219e+02  5.61123558e+02  1.33505653e+03
  1.33505653e+03  1.33505653e+03  2.63275059e+03  3.02929874e+03
  3.02929874e+03  3.02929874e+03  6.64973500e+03  6.64973500e+03
  6.64973500e+03  9.04013069e+03  2.53968165e+04  7.61404675e+04]
E1 = -727.7363256023606  E_coul = 201.17892573572038
Extra cycle  E= -526.55739986664  delta_E= -2.27e-12  |g|= 7.15e-07  |ddm|= 4.11e-06
    CPU time for scf_cycle      1.04 sec, wall time      0.25 sec
exp = [2.61826559e+04 7.61752191e+03 3.61735087e+03 1.59782562e+03
 3.82851126e+02 1.08121107e+02 3.48053854e+01 4.61718925e+00
 8.21195279e-01 2.51062954e-01 1.36278321e+03 6.64745676e+02
 3.00961968e+02 3.14042254e+02 6.16222270e+01 7.32878913e+00
 2.02393733e+01 7.73590024e-01 2.81033013e+00 2.26366160e-01]
E = -526.5573998666403
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:55:14 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558568        1
[INPUT] 0    0    [1    /1   ]  7617.52191232        1
[INPUT] 0    0    [1    /1   ]  3617.35086887        1
[INPUT] 0    0    [1    /1   ]  1597.82562401        1
[INPUT] 0    0    [1    /1   ]  382.851125801        1
[INPUT] 0    0    [1    /1   ]  108.121106669        1
[INPUT] 0    0    [1    /1   ]  34.8053854028        1
[INPUT] 0    0    [1    /1   ]  4.61718924992        1
[INPUT] 0    0    [1    /1   ]  0.821195278753       1
[INPUT] 0    0    [1    /1   ]  0.251062954242       1
[INPUT] 1    0    [1    /1   ]  1362.78320678        1
[INPUT] 1    0    [1    /1   ]  664.745676006        1
[INPUT] 1    0    [1    /1   ]  300.961968129        1
[INPUT] 1    0    [1    /1   ]  314.042253784        1
[INPUT] 1    0    [1    /1   ]  61.6222269528        1
[INPUT] 1    0    [1    /1   ]  7.32878912749        1
[INPUT] 1    0    [1    /1   ]  20.2393732989        1
[INPUT] 1    0    [1    /1   ]  0.773590024277       1
[INPUT] 1    0    [1    /1   ]  2.8103301339         1
[INPUT] 1    0    [1    /1   ]  0.226366159545       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.655856759284, 1.0]], [0, [7617.521912322196, 1.0]], [0, [3617.350868867108, 1.0]], [0, [1597.8256240082508, 1.0]], [0, [382.851125800745, 1.0]], [0, [108.12110666939145, 1.0]], [0, [34.80538540275867, 1.0]], [0, [4.617189249916105, 1.0]], [0, [0.8211952787525036, 1.0]], [0, [0.25106295424170294, 1.0]], [1, [1362.7832067767636, 1.0]], [1, [664.7456760060028, 1.0]], [1, [300.96196812885563, 1.0]], [1, [314.04225378373945, 1.0]], [1, [61.62222695283981, 1.0]], [1, [7.3287891274928425, 1.0]], [1, [20.239373298850868, 1.0]], [1, [0.7735900242774747, 1.0]], [1, [2.810330133898768, 1.0]], [1, [0.22636615954464437, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65585676]
bas 1, expnt(s) = [7617.52191232]
bas 2, expnt(s) = [3617.35086887]
bas 3, expnt(s) = [1597.82562401]
bas 4, expnt(s) = [382.8511258]
bas 5, expnt(s) = [108.12110667]
bas 6, expnt(s) = [34.8053854]
bas 7, expnt(s) = [4.61718925]
bas 8, expnt(s) = [0.82119528]
bas 9, expnt(s) = [0.25106295]
bas 10, expnt(s) = [1362.78320678]
bas 11, expnt(s) = [664.74567601]
bas 12, expnt(s) = [300.96196813]
bas 13, expnt(s) = [314.04225378]
bas 14, expnt(s) = [61.62222695]
bas 15, expnt(s) = [7.32878913]
bas 16, expnt(s) = [20.2393733]
bas 17, expnt(s) = [0.77359002]
bas 18, expnt(s) = [2.81033013]
bas 19, expnt(s) = [0.22636616]
CPU time:        20.70
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752191e+03 2.06003836e+03
 3.61735087e+03 1.17844143e+03 1.59782562e+03 6.38501704e+02
 3.82851126e+02 2.18669127e+02 1.08121107e+02 8.47125755e+01
 3.48053854e+01 3.62034418e+01 4.61718925e+00 7.95789640e+00
 8.21195279e-01 2.17946479e+00 2.51062954e-01 8.96090763e-01
 1.36278321e+03 2.41556017e+04 6.64745676e+02 9.84699673e+03
 3.00961968e+02 3.65699120e+03 3.14042254e+02 3.85673234e+03
 6.16222270e+01 5.03681650e+02 7.32878913e+00 3.51782860e+01
 2.02393733e+01 1.25236441e+02 7.73590024e-01 2.11652288e+00
 2.81033013e+00 1.06152706e+01 2.26366160e-01 4.55510897e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.985576905285523
cond(S) = 100216.865980071
E1 = -728.9192842641086  E_coul = 203.1578719168711
init E= -525.761412347237
    CPU time for initialize scf      0.60 sec, wall time      0.04 sec
  HOMO = -0.56027532791629  LUMO = 1.04127058818542
  mo_energy =
[-1.18322903e+02 -1.21334214e+01 -9.44538691e+00 -9.44538691e+00
 -9.44538691e+00 -1.22680599e+00 -5.60275328e-01 -5.60275328e-01
 -5.60275328e-01  1.04127059e+00  1.04127059e+00  1.04127059e+00
  1.37655660e+00  7.35535621e+00  7.35535621e+00  7.35535621e+00
  3.35148226e+01  3.35148226e+01  3.35148226e+01  7.76906815e+01
  1.29135454e+02  1.29135454e+02  1.29135454e+02  4.83533753e+02
  4.83533753e+02  4.83533753e+02  5.61479669e+02  1.33543131e+03
  1.33543131e+03  1.33543131e+03  2.63326978e+03  3.02974439e+03
  3.02974439e+03  3.02974439e+03  6.65030148e+03  6.65030148e+03
  6.65030148e+03  9.04077739e+03  2.53975616e+04  7.61413059e+04]
E1 = -727.195992198652  E_coul = 200.63999399432547
cycle= 1 E= -526.555998204327  delta_E= -0.795  |g|= 0.234  |ddm|= 0.524
    CPU time for cycle= 1      0.07 sec, wall time      0.02 sec
diis-norm(errvec)=0.637698
diis-c [-0.4066582  1.       ]
  HOMO = -0.599502599694784  LUMO = 1.01490775411434
  mo_energy =
[-1.18711210e+02 -1.22959810e+01 -9.62850115e+00 -9.62850115e+00
 -9.62850115e+00 -1.26764000e+00 -5.99502600e-01 -5.99502600e-01
 -5.99502600e-01  1.01490775e+00  1.01490775e+00  1.01490775e+00
  1.33850827e+00  7.24739997e+00  7.24739997e+00  7.24739997e+00
  3.33231796e+01  3.33231796e+01  3.33231796e+01  7.74312905e+01
  1.28847808e+02  1.28847808e+02  1.28847808e+02  4.83152210e+02
  4.83152210e+02  4.83152210e+02  5.61051056e+02  1.33498252e+03
  1.33498252e+03  1.33498252e+03  2.63267415e+03  3.02922289e+03
  3.02922289e+03  3.02922289e+03  6.64965817e+03  6.64965817e+03
  6.64965817e+03  9.04005353e+03  2.53967393e+04  7.61403903e+04]
E1 = -727.8901250294533  E_coul = 201.33282131834844
cycle= 2 E= -526.557303711105  delta_E= -0.00131  |g|= 0.0466  |ddm|= 0.0624
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0867938
diis-c [-0.00338735  0.09205854  0.90794146]
  HOMO = -0.58878639483595  LUMO = 1.02294771329815
  mo_energy =
[-1.18629548e+02 -1.22503216e+01 -9.58127636e+00 -9.58127636e+00
 -9.58127636e+00 -1.25414077e+00 -5.88786395e-01 -5.88786395e-01
 -5.88786395e-01  1.02294771e+00  1.02294771e+00  1.02294771e+00
  1.35253438e+00  7.27548873e+00  7.27548873e+00  7.27548873e+00
  3.33708919e+01  3.33708919e+01  3.33708919e+01  7.74989148e+01
  1.28915054e+02  1.28915054e+02  1.28915054e+02  4.83232907e+02
  4.83232907e+02  4.83232907e+02  5.61134710e+02  1.33506790e+03
  1.33506790e+03  1.33506790e+03  2.63276284e+03  3.02931061e+03
  3.02931061e+03  3.02931061e+03  6.64974743e+03  6.64974743e+03
  6.64974743e+03  9.04014345e+03  2.53968296e+04  7.61404807e+04]
E1 = -727.7108099899219  E_coul = 201.15341306058218
cycle= 3 E= -526.55739692934  delta_E= -9.32e-05  |g|= 0.00672  |ddm|= 0.0242
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0143581
diis-c [-4.73998708e-06 -2.25525365e-03  1.30785967e-01  8.71469287e-01]
  HOMO = -0.590570586618314  LUMO = 1.02168951078681
  mo_energy =
[-1.18640388e+02 -1.22568347e+01 -9.58828911e+00 -9.58828911e+00
 -9.58828911e+00 -1.25588205e+00 -5.90570587e-01 -5.90570587e-01
 -5.90570587e-01  1.02168951e+00  1.02168951e+00  1.02168951e+00
  1.35080367e+00  7.27111658e+00  7.27111658e+00  7.27111658e+00
  3.33639248e+01  3.33639248e+01  3.33639248e+01  7.74899895e+01
  1.28905854e+02  1.28905854e+02  1.28905854e+02  4.83222202e+02
  4.83222202e+02  4.83222202e+02  5.61123564e+02  1.33505654e+03
  1.33505654e+03  1.33505654e+03  2.63275067e+03  3.02929878e+03
  3.02929878e+03  3.02929878e+03  6.64973509e+03  6.64973509e+03
  6.64973509e+03  9.04013081e+03  2.53968167e+04  7.61404677e+04]
E1 = -727.7365638006377  E_coul = 201.17916396903763
cycle= 4 E= -526.5573998316  delta_E= -2.9e-06  |g|= 0.000402  |ddm|= 0.0027
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000372272
diis-c [-2.78592193e-08  1.42271456e-04 -1.41182581e-02 -1.08898420e-01
  1.12287441e+00]
  HOMO = -0.590527663033661  LUMO = 1.02173043576823
  mo_energy =
[-1.18640296e+02 -1.22566836e+01 -9.58817919e+00 -9.58817919e+00
 -9.58817919e+00 -1.25573854e+00 -5.90527663e-01 -5.90527663e-01
 -5.90527663e-01  1.02173044e+00  1.02173044e+00  1.02173044e+00
  1.35095666e+00  7.27121395e+00  7.27121395e+00  7.27121395e+00
  3.33640361e+01  3.33640361e+01  3.33640361e+01  7.74901325e+01
  1.28905963e+02  1.28905963e+02  1.28905963e+02  4.83222296e+02
  4.83222296e+02  4.83222296e+02  5.61123636e+02  1.33505660e+03
  1.33505660e+03  1.33505660e+03  2.63275068e+03  3.02929882e+03
  3.02929882e+03  3.02929882e+03  6.64973508e+03  6.64973508e+03
  6.64973508e+03  9.04013078e+03  2.53968166e+04  7.61404676e+04]
E1 = -727.736107332851  E_coul = 201.178707466735
cycle= 5 E= -526.557399866116  delta_E= -3.45e-08  |g|= 5.77e-05  |ddm|= 0.000653
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000102809
diis-c [-5.07316878e-10  2.58049166e-05 -1.57587043e-03 -1.73692022e-02
  2.06589226e-02  9.98260345e-01]
  HOMO = -0.590547195295194  LUMO = 1.02171752875833
  mo_energy =
[-1.18640377e+02 -1.22567442e+01 -9.58824539e+00 -9.58824539e+00
 -9.58824539e+00 -1.25575105e+00 -5.90547195e-01 -5.90547195e-01
 -5.90547195e-01  1.02171753e+00  1.02171753e+00  1.02171753e+00
  1.35094519e+00  7.27116981e+00  7.27116981e+00  7.27116981e+00
  3.33639725e+01  3.33639725e+01  3.33639725e+01  7.74900610e+01
  1.28905888e+02  1.28905888e+02  1.28905888e+02  4.83222215e+02
  4.83222215e+02  4.83222215e+02  5.61123554e+02  1.33505652e+03
  1.33505652e+03  1.33505652e+03  2.63275059e+03  3.02929874e+03
  3.02929874e+03  3.02929874e+03  6.64973500e+03  6.64973500e+03
  6.64973500e+03  9.04013069e+03  2.53968165e+04  7.61404675e+04]
E1 = -727.7363360305928  E_coul = 201.17893616395486
cycle= 6 E= -526.557399866638  delta_E= -5.22e-10  |g|= 3.01e-06  |ddm|= 5.78e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -727.7363360305928  E_coul = 201.17893616395486
  HOMO = -0.59054644446318  LUMO = 1.02171812736321
  mo_energy =
[-1.18640373e+02 -1.22567415e+01 -9.58824269e+00 -9.58824269e+00
 -9.58824269e+00 -1.25574967e+00 -5.90546444e-01 -5.90546444e-01
 -5.90546444e-01  1.02171813e+00  1.02171813e+00  1.02171813e+00
  1.35094661e+00  7.27117164e+00  7.27117164e+00  7.27117164e+00
  3.33639752e+01  3.33639752e+01  3.33639752e+01  7.74900644e+01
  1.28905892e+02  1.28905892e+02  1.28905892e+02  4.83222219e+02
  4.83222219e+02  4.83222219e+02  5.61123558e+02  1.33505653e+03
  1.33505653e+03  1.33505653e+03  2.63275059e+03  3.02929874e+03
  3.02929874e+03  3.02929874e+03  6.64973500e+03  6.64973500e+03
  6.64973500e+03  9.04013069e+03  2.53968165e+04  7.61404675e+04]
E1 = -727.7363256023606  E_coul = 201.17892573572038
Extra cycle  E= -526.55739986664  delta_E= -2.27e-12  |g|= 7.15e-07  |ddm|= 4.11e-06
    CPU time for scf_cycle      0.84 sec, wall time      0.25 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 100216.865980071
E1 = -727.7363256023606  E_coul = 201.17892573572038
init E= -526.55739986664
    CPU time for initialize scf      3.79 sec, wall time      0.21 sec
  HOMO = -0.590546656729316  LUMO = 1.02171798517668
  mo_energy =
[-1.18640374e+02 -1.22567423e+01 -9.58824351e+00 -9.58824351e+00
 -9.58824351e+00 -1.25574981e+00 -5.90546657e-01 -5.90546657e-01
 -5.90546657e-01  1.02171799e+00  1.02171799e+00  1.02171799e+00
  1.35094648e+00  7.27117113e+00  7.27117113e+00  7.27117113e+00
  3.33639744e+01  3.33639744e+01  3.33639744e+01  7.74900634e+01
  1.28905891e+02  1.28905891e+02  1.28905891e+02  4.83222218e+02
  4.83222218e+02  4.83222218e+02  5.61123557e+02  1.33505652e+03
  1.33505652e+03  1.33505652e+03  2.63275059e+03  3.02929874e+03
  3.02929874e+03  3.02929874e+03  6.64973500e+03  6.64973500e+03
  6.64973500e+03  9.04013069e+03  2.53968165e+04  7.61404675e+04]
E1 = -727.7363285340269  E_coul = 201.17892866738828
cycle= 1 E= -526.557399866639  delta_E= 1.59e-12  |g|= 1.96e-07  |ddm|= 5.97e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.7363285340269  E_coul = 201.17892866738828
  HOMO = -0.590546601924259  LUMO = 1.02171802733823
  mo_energy =
[-1.18640374e+02 -1.22567421e+01 -9.58824329e+00 -9.58824329e+00
 -9.58824329e+00 -1.25574972e+00 -5.90546602e-01 -5.90546602e-01
 -5.90546602e-01  1.02171803e+00  1.02171803e+00  1.02171803e+00
  1.35094656e+00  7.27117127e+00  7.27117127e+00  7.27117127e+00
  3.33639746e+01  3.33639746e+01  3.33639746e+01  7.74900637e+01
  1.28905891e+02  1.28905891e+02  1.28905891e+02  4.83222218e+02
  4.83222218e+02  4.83222218e+02  5.61123557e+02  1.33505652e+03
  1.33505652e+03  1.33505652e+03  2.63275059e+03  3.02929874e+03
  3.02929874e+03  3.02929874e+03  6.64973500e+03  6.64973500e+03
  6.64973500e+03  9.04013069e+03  2.53968165e+04  7.61404675e+04]
E1 = -727.7363277027002  E_coul = 201.17892783606075
Extra cycle  E= -526.557399866639  delta_E= -7.96e-13  |g|= 5.02e-08  |ddm|= 1.94e-07
    CPU time for scf_cycle      4.11 sec, wall time      0.53 sec
exp = [2.61826559e+04 7.61752191e+03 3.61735087e+03 1.59782562e+03
 3.82851126e+02 1.08121107e+02 3.48053854e+01 4.61718925e+00
 8.21195279e-01 2.51062954e-01 1.36278321e+03 6.64745676e+02
 3.00961968e+02 3.14042254e+02 6.16222270e+01 7.32878913e+00
 2.02393733e+01 7.73590024e-01 2.81033013e+00 2.26366160e-01]
grad_E = [-1.51115554e-06  3.32691835e-06 -1.42266610e-06  6.99681890e-05
 -1.10964410e-05  4.08029555e-04 -1.99184686e-03 -1.36272715e-01
  6.01147779e-02 -4.59721982e-01 -5.09192732e-07  5.00776297e-06
  2.35979555e-05  2.03467070e-05 -4.44036460e-06  7.58840082e-04
 -1.21230829e-04 -2.95173933e-02 -3.33860001e-04  8.98399913e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:55:18 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558616        1
[INPUT] 0    0    [1    /1   ]  7617.52190163        1
[INPUT] 0    0    [1    /1   ]  3617.35087349        1
[INPUT] 0    0    [1    /1   ]  1597.8254001         1
[INPUT] 0    0    [1    /1   ]  382.85109484         1
[INPUT] 0    0    [1    /1   ]  108.120618453        1
[INPUT] 0    0    [1    /1   ]  34.8078261219        1
[INPUT] 0    0    [1    /1   ]  4.85653922982        1
[INPUT] 0    0    [1    /1   ]  1.56042109279        1
[INPUT] 0    0    [1    /1   ]  1.14241965949        1
[INPUT] 1    0    [1    /1   ]  1362.78320842        1
[INPUT] 1    0    [1    /1   ]  664.745659901        1
[INPUT] 1    0    [1    /1   ]  300.961892292        1
[INPUT] 1    0    [1    /1   ]  314.042188395        1
[INPUT] 1    0    [1    /1   ]  61.622215642         1
[INPUT] 1    0    [1    /1   ]  7.32566902759        1
[INPUT] 1    0    [1    /1   ]  20.240017738         1
[INPUT] 1    0    [1    /1   ]  0.815057881677       1
[INPUT] 1    0    [1    /1   ]  2.8135535672         1
[INPUT] 1    0    [1    /1   ]  0.11631643456        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.655861633644, 1.0]], [0, [7617.521901631554, 1.0]], [0, [3617.3508734949405, 1.0]], [0, [1597.8254001021928, 1.0]], [0, [382.85109483964834, 1.0]], [0, [108.12061845330315, 1.0]], [0, [34.80782612190818, 1.0]], [0, [4.856539229817065, 1.0]], [0, [1.560421092788159, 1.0]], [0, [1.1424196594875562, 1.0]], [1, [1362.783208421317, 1.0]], [1, [664.7456599014345, 1.0]], [1, [300.961892291814, 1.0]], [1, [314.0421883950976, 1.0]], [1, [61.62221564201871, 1.0]], [1, [7.325669027594542, 1.0]], [1, [20.24001773802327, 1.0]], [1, [0.8150578816773424, 1.0]], [1, [2.8135535671950795, 1.0]], [1, [0.11631643455965619, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65586163]
bas 1, expnt(s) = [7617.52190163]
bas 2, expnt(s) = [3617.35087349]
bas 3, expnt(s) = [1597.8254001]
bas 4, expnt(s) = [382.85109484]
bas 5, expnt(s) = [108.12061845]
bas 6, expnt(s) = [34.80782612]
bas 7, expnt(s) = [4.85653923]
bas 8, expnt(s) = [1.56042109]
bas 9, expnt(s) = [1.14241966]
bas 10, expnt(s) = [1362.78320842]
bas 11, expnt(s) = [664.7456599]
bas 12, expnt(s) = [300.96189229]
bas 13, expnt(s) = [314.0421884]
bas 14, expnt(s) = [61.62221564]
bas 15, expnt(s) = [7.32566903]
bas 16, expnt(s) = [20.24001774]
bas 17, expnt(s) = [0.81505788]
bas 18, expnt(s) = [2.81355357]
bas 19, expnt(s) = [0.11631643]
CPU time:        30.62
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752190e+03 2.06003836e+03
 3.61735087e+03 1.17844143e+03 1.59782540e+03 6.38501637e+02
 3.82851095e+02 2.18669113e+02 1.08120618e+02 8.47122887e+01
 3.48078261e+01 3.62053458e+01 4.85653923e+00 8.26533004e+00
 1.56042109e+00 3.52733237e+00 1.14241966e+00 2.79179982e+00
 1.36278321e+03 2.41556017e+04 6.64745660e+02 9.84699644e+03
 3.00961892e+02 3.65699005e+03 3.14042188e+02 3.85673133e+03
 6.16222156e+01 5.03681534e+02 7.32566903e+00 3.51595663e+01
 2.02400177e+01 1.25241426e+02 8.15057882e-01 2.25927947e+00
 2.81355357e+00 1.06304923e+01 1.16316435e-01 1.98169012e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.551181154034445
cond(S) = 101654.99057047712
E1 = -722.3808962634846  E_coul = 200.4695567029919
init E= -521.911339560493
    CPU time for initialize scf      7.47 sec, wall time      0.35 sec
  HOMO = -0.62970626707551  LUMO = 0.436887655736266
  mo_energy =
[-1.18509082e+02 -1.23222560e+01 -9.62133573e+00 -9.62133573e+00
 -9.62133573e+00 -9.18078919e-01 -6.29706267e-01 -6.29706267e-01
 -6.29706267e-01  4.36887656e-01  4.36887656e-01  4.36887656e-01
  6.23163807e+00  6.97282114e+00  6.97282114e+00  6.97282114e+00
  3.32094138e+01  3.32094138e+01  3.32094138e+01  8.56942632e+01
  1.28861439e+02  1.28861439e+02  1.28861439e+02  4.83279998e+02
  4.83279998e+02  4.83279998e+02  5.67687162e+02  1.33519106e+03
  1.33519106e+03  1.33519106e+03  2.63846546e+03  3.02950845e+03
  3.02950845e+03  3.02950845e+03  6.65007028e+03  6.65007028e+03
  6.65007028e+03  9.04548335e+03  2.54019944e+04  7.61454189e+04]
E1 = -729.5261610547761  E_coul = 204.00797204003027
cycle= 1 E= -525.518189014746  delta_E= -3.61  |g|= 0.326  |ddm|= 28.4
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.538902
diis-c [-0.29041545  1.        ]
  HOMO = -0.491172354900465  LUMO = 0.577494830029259
  mo_energy =
[-1.18355315e+02 -1.20496122e+01 -9.34356999e+00 -9.34356999e+00
 -9.34356999e+00 -8.56205092e-01 -4.91172355e-01 -4.91172355e-01
 -4.91172355e-01  5.77494830e-01  5.77494830e-01  5.77494830e-01
  6.42638041e+00  7.19226814e+00  7.19226814e+00  7.19226814e+00
  3.34612649e+01  3.34612649e+01  3.34612649e+01  8.59438961e+01
  1.29081442e+02  1.29081442e+02  1.29081442e+02  4.83438816e+02
  4.83438816e+02  4.83438816e+02  5.67803555e+02  1.33529047e+03
  1.33529047e+03  1.33529047e+03  2.63843348e+03  3.02954388e+03
  3.02954388e+03  3.02954388e+03  6.64999331e+03  6.64999331e+03
  6.64999331e+03  9.04533139e+03  2.54017483e+04  7.61450825e+04]
E1 = -727.1055124522171  E_coul = 201.57248577489867
cycle= 2 E= -525.533026677319  delta_E= -0.0148  |g|= 0.115  |ddm|= 2.66
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.145673
diis-c [-0.01610495  0.1201523   0.8798477 ]
  HOMO = -0.549137576252679  LUMO = 0.538570985810841
  mo_energy =
[-1.18535069e+02 -1.22047676e+01 -9.49920630e+00 -9.49920630e+00
 -9.49920630e+00 -9.50553163e-01 -5.49137576e-01 -5.49137576e-01
 -5.49137576e-01  5.38570986e-01  5.38570986e-01  5.38570986e-01
  6.30399540e+00  7.06862243e+00  7.06862243e+00  7.06862243e+00
  3.33078218e+01  3.33078218e+01  3.33078218e+01  8.57740734e+01
  1.28910961e+02  1.28910961e+02  1.28910961e+02  4.83259952e+02
  4.83259952e+02  4.83259952e+02  5.67623928e+02  1.33510968e+03
  1.33510968e+03  1.33510968e+03  2.63825279e+03  3.02936277e+03
  3.02936277e+03  3.02936277e+03  6.64981257e+03  6.64981257e+03
  6.64981257e+03  9.04515100e+03  2.54015682e+04  7.61449026e+04]
E1 = -728.1130781637644  E_coul = 202.57819978834553
cycle= 3 E= -525.534878375419  delta_E= -0.00185  |g|= 0.035  |ddm|= 0.973
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.066574
diis-c [-3.10400150e-04  1.84167283e-02  3.09916014e-01  6.71667258e-01]
  HOMO = -0.54015302178555  LUMO = 0.544757464705877
  mo_energy =
[-1.18490311e+02 -1.21736914e+01 -9.46677827e+00 -9.46677827e+00
 -9.46677827e+00 -9.36434593e-01 -5.40153022e-01 -5.40153022e-01
 -5.40153022e-01  5.44757465e-01  5.44757465e-01  5.44757465e-01
  6.32371203e+00  7.09064029e+00  7.09064029e+00  7.09064029e+00
  3.33398099e+01  3.33398099e+01  3.33398099e+01  8.58129993e+01
  1.28950503e+02  1.28950503e+02  1.28950503e+02  4.83304291e+02
  4.83304291e+02  4.83304291e+02  5.67669373e+02  1.33515581e+03
  1.33515581e+03  1.33515581e+03  2.63830065e+03  3.02940999e+03
  3.02940999e+03  3.02940999e+03  6.64986080e+03  6.64986080e+03
  6.64986080e+03  9.04519975e+03  2.54016174e+04  7.61449521e+04]
E1 = -727.911314283369  E_coul = 202.37627630838278
cycle= 4 E= -525.535037974986  delta_E= -0.00016  |g|= 0.00397  |ddm|= 0.0519
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00734597
diis-c [-1.10087254e-06 -2.75311028e-04  1.12877753e-02 -9.54189901e-02
  1.08440653e+00]
  HOMO = -0.538935949027206  LUMO = 0.545615773869958
  mo_energy =
[-1.18485415e+02 -1.21696142e+01 -9.46243591e+00 -9.46243591e+00
 -9.46243591e+00 -9.34633287e-01 -5.38935949e-01 -5.38935949e-01
 -5.38935949e-01  5.45615774e-01  5.45615774e-01  5.45615774e-01
  6.32616481e+00  7.09364459e+00  7.09364459e+00  7.09364459e+00
  3.33439623e+01  3.33439623e+01  3.33439623e+01  8.58174934e+01
  1.28955133e+02  1.28955133e+02  1.28955133e+02  4.83309151e+02
  4.83309151e+02  4.83309151e+02  5.67674311e+02  1.33516078e+03
  1.33516078e+03  1.33516078e+03  2.63830582e+03  3.02941507e+03
  3.02941507e+03  3.02941507e+03  6.64986601e+03  6.64986601e+03
  6.64986601e+03  9.04520504e+03  2.54016228e+04  7.61449575e+04]
E1 = -727.8826497076859  E_coul = 202.3476089002678
cycle= 5 E= -525.535040807418  delta_E= -2.83e-06  |g|= 0.000231  |ddm|= 0.0138
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000322642
diis-c [-2.89011171e-09  3.79470714e-05 -3.19843369e-03 -3.38760143e-03
 -6.71903879e-02  1.07373848e+00]
  HOMO = -0.538961944171692  LUMO = 0.54559713103552
  mo_energy =
[-1.18485344e+02 -1.21696234e+01 -9.46241538e+00 -9.46241538e+00
 -9.46241538e+00 -9.34697922e-01 -5.38961944e-01 -5.38961944e-01
 -5.38961944e-01  5.45597131e-01  5.45597131e-01  5.45597131e-01
  6.32608874e+00  7.09361814e+00  7.09361814e+00  7.09361814e+00
  3.33439761e+01  3.33439761e+01  3.33439761e+01  8.58175168e+01
  1.28955175e+02  1.28955175e+02  1.28955175e+02  4.83309219e+02
  4.83309219e+02  4.83309219e+02  5.67674396e+02  1.33516087e+03
  1.33516087e+03  1.33516087e+03  2.63830596e+03  3.02941519e+03
  3.02941519e+03  3.02941519e+03  6.64986615e+03  6.64986615e+03
  6.64986615e+03  9.04520520e+03  2.54016229e+04  7.61449577e+04]
E1 = -727.8824884848597  E_coul = 202.3474476739329
cycle= 6 E= -525.535040810927  delta_E= -3.51e-09  |g|= 2.53e-06  |ddm|= 0.0034
    CPU time for cycle= 6      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=4.57122e-06
diis-c [-7.94576959e-13  7.53555259e-08  1.15439484e-04 -7.15085353e-05
  3.98848293e-03 -4.44632657e-02  1.04043078e+00]
  HOMO = -0.538961742212461  LUMO = 0.545596974083488
  mo_energy =
[-1.18485343e+02 -1.21696237e+01 -9.46241543e+00 -9.46241543e+00
 -9.46241543e+00 -9.34697789e-01 -5.38961742e-01 -5.38961742e-01
 -5.38961742e-01  5.45596974e-01  5.45596974e-01  5.45596974e-01
  6.32608884e+00  7.09361811e+00  7.09361811e+00  7.09361811e+00
  3.33439763e+01  3.33439763e+01  3.33439763e+01  8.58175175e+01
  1.28955175e+02  1.28955175e+02  1.28955175e+02  4.83309220e+02
  4.83309220e+02  4.83309220e+02  5.67674398e+02  1.33516087e+03
  1.33516087e+03  1.33516087e+03  2.63830596e+03  3.02941519e+03
  3.02941519e+03  3.02941519e+03  6.64986616e+03  6.64986616e+03
  6.64986616e+03  9.04520521e+03  2.54016229e+04  7.61449577e+04]
E1 = -727.8824924591745  E_coul = 202.34745164824747
cycle= 7 E= -525.535040810927  delta_E= -2.27e-13  |g|= 1.09e-07  |ddm|= 2.58e-05
    CPU time for cycle= 7      0.04 sec, wall time      0.04 sec
E1 = -727.8824924591745  E_coul = 202.34745164824747
  HOMO = -0.538961694607623  LUMO = 0.545597017945364
  mo_energy =
[-1.18485342e+02 -1.21696235e+01 -9.46241527e+00 -9.46241527e+00
 -9.46241527e+00 -9.34697705e-01 -5.38961695e-01 -5.38961695e-01
 -5.38961695e-01  5.45597018e-01  5.45597018e-01  5.45597018e-01
  6.32608895e+00  7.09361823e+00  7.09361823e+00  7.09361823e+00
  3.33439764e+01  3.33439764e+01  3.33439764e+01  8.58175177e+01
  1.28955176e+02  1.28955176e+02  1.28955176e+02  4.83309221e+02
  4.83309221e+02  4.83309221e+02  5.67674398e+02  1.33516088e+03
  1.33516088e+03  1.33516088e+03  2.63830596e+03  3.02941519e+03
  3.02941519e+03  3.02941519e+03  6.64986616e+03  6.64986616e+03
  6.64986616e+03  9.04520521e+03  2.54016229e+04  7.61449577e+04]
E1 = -727.8824914040906  E_coul = 202.34745059316347
Extra cycle  E= -525.535040810927  delta_E= -1.14e-13  |g|= 5.01e-08  |ddm|= 6.28e-07
    CPU time for scf_cycle      7.78 sec, wall time      0.65 sec
exp = [2.61826559e+04 7.61752190e+03 3.61735087e+03 1.59782540e+03
 3.82851095e+02 1.08120618e+02 3.48078261e+01 4.85653923e+00
 1.56042109e+00 1.14241966e+00 1.36278321e+03 6.64745660e+02
 3.00961892e+02 3.14042188e+02 6.16222156e+01 7.32566903e+00
 2.02400177e+01 8.15057882e-01 2.81355357e+00 1.16316435e-01]
E = -525.5350408109272
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:55:19 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558575        1
[INPUT] 0    0    [1    /1   ]  7617.52191079        1
[INPUT] 0    0    [1    /1   ]  3617.35086953        1
[INPUT] 0    0    [1    /1   ]  1597.82559201        1
[INPUT] 0    0    [1    /1   ]  382.851121377        1
[INPUT] 0    0    [1    /1   ]  108.121036908        1
[INPUT] 0    0    [1    /1   ]  34.8057341565        1
[INPUT] 0    0    [1    /1   ]  4.65138990428        1
[INPUT] 0    0    [1    /1   ]  0.92682305685        1
[INPUT] 0    0    [1    /1   ]  0.37842867454        1
[INPUT] 1    0    [1    /1   ]  1362.78320701        1
[INPUT] 1    0    [1    /1   ]  664.745673705        1
[INPUT] 1    0    [1    /1   ]  300.961957293        1
[INPUT] 1    0    [1    /1   ]  314.04224444         1
[INPUT] 1    0    [1    /1   ]  61.6222253366        1
[INPUT] 1    0    [1    /1   ]  7.32834329726        1
[INPUT] 1    0    [1    /1   ]  20.2394653826        1
[INPUT] 1    0    [1    /1   ]  0.779515355288       1
[INPUT] 1    0    [1    /1   ]  2.81079072942        1
[INPUT] 1    0    [1    /1   ]  0.210641183888       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.65585745578, 1.0]], [0, [7617.521910794613, 1.0]], [0, [3617.3508695283776, 1.0]], [0, [1597.8255920143743, 1.0]], [0, [382.85112137672223, 1.0]], [0, [108.12103690832568, 1.0]], [0, [34.80573415646265, 1.0]], [0, [4.651389904282691, 1.0]], [0, [0.9268230568503043, 1.0]], [0, [0.3784286745399317, 1.0]], [1, [1362.7832070117533, 1.0]], [1, [664.7456737048253, 1.0]], [1, [300.9619572925211, 1.0]], [1, [314.04224444037396, 1.0]], [1, [61.62222533663962, 1.0]], [1, [7.328343297256069, 1.0]], [1, [20.23946538259119, 1.0]], [1, [0.7795153552879164, 1.0]], [1, [2.81079072941704, 1.0]], [1, [0.21064118388804798, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65585746]
bas 1, expnt(s) = [7617.52191079]
bas 2, expnt(s) = [3617.35086953]
bas 3, expnt(s) = [1597.82559201]
bas 4, expnt(s) = [382.85112138]
bas 5, expnt(s) = [108.12103691]
bas 6, expnt(s) = [34.80573416]
bas 7, expnt(s) = [4.6513899]
bas 8, expnt(s) = [0.92682306]
bas 9, expnt(s) = [0.37842867]
bas 10, expnt(s) = [1362.78320701]
bas 11, expnt(s) = [664.7456737]
bas 12, expnt(s) = [300.96195729]
bas 13, expnt(s) = [314.04224444]
bas 14, expnt(s) = [61.62222534]
bas 15, expnt(s) = [7.3283433]
bas 16, expnt(s) = [20.23946538]
bas 17, expnt(s) = [0.77951536]
bas 18, expnt(s) = [2.81079073]
bas 19, expnt(s) = [0.21064118]
CPU time:        38.48
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752191e+03 2.06003836e+03
 3.61735087e+03 1.17844143e+03 1.59782559e+03 6.38501694e+02
 3.82851121e+02 2.18669125e+02 1.08121037e+02 8.47125345e+01
 3.48057342e+01 3.62037138e+01 4.65138990e+00 8.00206516e+00
 9.26823057e-01 2.38650664e+00 3.78428675e-01 1.21899816e+00
 1.36278321e+03 2.41556017e+04 6.64745674e+02 9.84699669e+03
 3.00961957e+02 3.65699104e+03 3.14042244e+02 3.85673220e+03
 6.16222253e+01 5.03681633e+02 7.32834330e+00 3.51756110e+01
 2.02394654e+01 1.25237154e+02 7.79515355e-01 2.13680670e+00
 2.81079073e+00 1.06174453e+01 2.10641184e-01 4.16306797e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.984211221578892
cond(S) = 100376.61662850894
E1 = -728.6959193088599  E_coul = 202.95553570227284
init E= -525.740383606587
    CPU time for initialize scf      5.72 sec, wall time      0.27 sec
  HOMO = -0.55817665638602  LUMO = 0.985114996641562
  mo_energy =
[-1.18348570e+02 -1.21572026e+01 -9.46651368e+00 -9.46651368e+00
 -9.46651368e+00 -1.22907819e+00 -5.58176656e-01 -5.58176656e-01
 -5.58176656e-01  9.85114997e-01  9.85114997e-01  9.85114997e-01
  2.10314781e+00  7.30840161e+00  7.30840161e+00  7.30840161e+00
  3.34730845e+01  3.34730845e+01  3.34730845e+01  7.87999912e+01
  1.29095075e+02  1.29095075e+02  1.29095075e+02  4.83496013e+02
  4.83496013e+02  4.83496013e+02  5.62317977e+02  1.33539592e+03
  1.33539592e+03  1.33539592e+03  2.63396866e+03  3.02970963e+03
  3.02970963e+03  3.02970963e+03  6.65026751e+03  6.65026751e+03
  6.65026751e+03  9.04140983e+03  2.53981572e+04  7.61418584e+04]
E1 = -727.3919601322159  E_coul = 200.81972824656603
cycle= 1 E= -526.57223188565  delta_E= -0.832  |g|= 0.23  |ddm|= 0.441
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.633795
diis-c [-0.40169604  1.        ]
  HOMO = -0.589092144599384  LUMO = 0.964302065651079
  mo_energy =
[-1.18704242e+02 -1.22871896e+01 -9.61670322e+00 -9.61670322e+00
 -9.61670322e+00 -1.26804455e+00 -5.89092145e-01 -5.89092145e-01
 -5.89092145e-01  9.64302066e-01  9.64302066e-01  9.64302066e-01
  2.05635742e+00  7.22090469e+00  7.22090469e+00  7.22090469e+00
  3.33116381e+01  3.33116381e+01  3.33116381e+01  7.85770792e+01
  1.28840452e+02  1.28840452e+02  1.28840452e+02  4.83147383e+02
  4.83147383e+02  4.83147383e+02  5.61920930e+02  1.33497830e+03
  1.33497830e+03  1.33497830e+03  2.63340241e+03  3.02921839e+03
  3.02921839e+03  3.02921839e+03  6.64965306e+03  6.64965306e+03
  6.64965306e+03  9.04071403e+03  2.53973621e+04  7.61409695e+04]
E1 = -727.9794112283022  E_coul = 201.40625521113512
cycle= 2 E= -526.573156017167  delta_E= -0.000924  |g|= 0.0415  |ddm|= 0.0728
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0809767
diis-c [-0.00307648  0.0854594   0.9145406 ]
  HOMO = -0.580627620186272  LUMO = 0.970430654790319
  mo_energy =
[-1.18631541e+02 -1.22484669e+01 -9.57625389e+00 -9.57625389e+00
 -9.57625389e+00 -1.25790823e+00 -5.80627620e-01 -5.80627620e-01
 -5.80627620e-01  9.70430655e-01  9.70430655e-01  9.70430655e-01
  2.06926031e+00  7.24414949e+00  7.24414949e+00  7.24414949e+00
  3.33525755e+01  3.33525755e+01  3.33525755e+01  7.86363495e+01
  1.28899564e+02  1.28899564e+02  1.28899564e+02  4.83219191e+02
  4.83219191e+02  4.83219191e+02  5.61995601e+02  1.33505463e+03
  1.33505463e+03  1.33505463e+03  2.63348215e+03  3.02929707e+03
  3.02929707e+03  3.02929707e+03  6.64973340e+03  6.64973340e+03
  6.64973340e+03  9.04079511e+03  2.53974436e+04  7.61410512e+04]
E1 = -727.8250202591457  E_coul = 201.25180039541752
cycle= 3 E= -526.573219863728  delta_E= -6.38e-05  |g|= 0.00604  |ddm|= 0.0186
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0124832
diis-c [-1.73097758e-06 -1.86134948e-03  1.24390105e-01  8.77471244e-01]
  HOMO = -0.582258881772418  LUMO = 0.969254771993653
  mo_energy =
[-1.18641579e+02 -1.22544975e+01 -9.58264986e+00 -9.58264986e+00
 -9.58264986e+00 -1.25990013e+00 -5.82258882e-01 -5.82258882e-01
 -5.82258882e-01  9.69254772e-01  9.69254772e-01  9.69254772e-01
  2.06683363e+00  7.24009878e+00  7.24009878e+00  7.24009878e+00
  3.33461760e+01  3.33461760e+01  3.33461760e+01  7.86280399e+01
  1.28891065e+02  1.28891065e+02  1.28891065e+02  4.83209274e+02
  4.83209274e+02  4.83209274e+02  5.61985299e+02  1.33504412e+03
  1.33504412e+03  1.33504412e+03  2.63347099e+03  3.02928618e+03
  3.02928618e+03  3.02928618e+03  6.64972210e+03  6.64972210e+03
  6.64972210e+03  9.04078357e+03  2.53974319e+04  7.61410393e+04]
E1 = -727.8488752707781  E_coul = 201.27565342852597
cycle= 4 E= -526.573221842252  delta_E= -1.98e-06  |g|= 0.000163  |ddm|= 0.00333
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000255545
diis-c [-1.61658982e-08 -6.67865030e-05  6.17618071e-04  2.36028348e-02
  9.75846334e-01]
  HOMO = -0.582178215321776  LUMO = 0.969309612813754
  mo_energy =
[-1.18641281e+02 -1.22542335e+01 -9.58238315e+00 -9.58238315e+00
 -9.58238315e+00 -1.25981131e+00 -5.82178215e-01 -5.82178215e-01
 -5.82178215e-01  9.69309613e-01  9.69309613e-01  9.69309613e-01
  2.06693775e+00  7.24028433e+00  7.24028433e+00  7.24028433e+00
  3.33464319e+01  3.33464319e+01  3.33464319e+01  7.86283289e+01
  1.28891351e+02  1.28891351e+02  1.28891351e+02  4.83209570e+02
  4.83209570e+02  4.83209570e+02  5.61985592e+02  1.33504442e+03
  1.33504442e+03  1.33504442e+03  2.63347128e+03  3.02928646e+03
  3.02928646e+03  3.02928646e+03  6.64972238e+03  6.64972238e+03
  6.64972238e+03  9.04078385e+03  2.53974321e+04  7.61410396e+04]
E1 = -727.8479142580567  E_coul = 201.27469241264689
cycle= 5 E= -526.57322184541  delta_E= -3.16e-09  |g|= 2.56e-05  |ddm|= 0.000112
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.91002e-05
diis-c [-3.35658019e-11  2.91699427e-06 -2.40441094e-04 -4.01753684e-03
  3.46782876e-02  9.69576773e-01]
  HOMO = -0.582187952282473  LUMO = 0.969302399714519
  mo_energy =
[-1.18641322e+02 -1.22542643e+01 -9.58241475e+00 -9.58241475e+00
 -9.58241475e+00 -1.25982464e+00 -5.82187952e-01 -5.82187952e-01
 -5.82187952e-01  9.69302400e-01  9.69302400e-01  9.69302400e-01
  2.06692179e+00  7.24026208e+00  7.24026208e+00  7.24026208e+00
  3.33464007e+01  3.33464007e+01  3.33464007e+01  7.86282922e+01
  1.28891314e+02  1.28891314e+02  1.28891314e+02  4.83209530e+02
  4.83209530e+02  4.83209530e+02  5.61985551e+02  1.33504438e+03
  1.33504438e+03  1.33504438e+03  2.63347123e+03  3.02928642e+03
  3.02928642e+03  3.02928642e+03  6.64972234e+03  6.64972234e+03
  6.64972234e+03  9.04078381e+03  2.53974321e+04  7.61410396e+04]
E1 = -727.8480271050346  E_coul = 201.27480525956486
cycle= 6 E= -526.57322184547  delta_E= -6e-11  |g|= 1.93e-06  |ddm|= 2.89e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -727.8480271050346  E_coul = 201.27480525956486
  HOMO = -0.582187555824919  LUMO = 0.96930262295872
  mo_energy =
[-1.18641319e+02 -1.22542628e+01 -9.58241306e+00 -9.58241306e+00
 -9.58241306e+00 -1.25982447e+00 -5.82187556e-01 -5.82187556e-01
 -5.82187556e-01  9.69302623e-01  9.69302623e-01  9.69302623e-01
  2.06692197e+00  7.24026311e+00  7.24026311e+00  7.24026311e+00
  3.33464024e+01  3.33464024e+01  3.33464024e+01  7.86282941e+01
  1.28891316e+02  1.28891316e+02  1.28891316e+02  4.83209533e+02
  4.83209533e+02  4.83209533e+02  5.61985554e+02  1.33504438e+03
  1.33504438e+03  1.33504438e+03  2.63347124e+03  3.02928643e+03
  3.02928643e+03  3.02928643e+03  6.64972234e+03  6.64972234e+03
  6.64972234e+03  9.04078381e+03  2.53974321e+04  7.61410396e+04]
E1 = -727.8480205919707  E_coul = 201.27479874649885
Extra cycle  E= -526.573221845472  delta_E= -2.05e-12  |g|= 4.82e-07  |ddm|= 2.61e-06
    CPU time for scf_cycle      5.94 sec, wall time      0.50 sec
exp = [2.61826559e+04 7.61752191e+03 3.61735087e+03 1.59782559e+03
 3.82851121e+02 1.08121037e+02 3.48057342e+01 4.65138990e+00
 9.26823057e-01 3.78428675e-01 1.36278321e+03 6.64745674e+02
 3.00961957e+02 3.14042244e+02 6.16222253e+01 7.32834330e+00
 2.02394654e+01 7.79515355e-01 2.81079073e+00 2.10641184e-01]
E = -526.5732218454718
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:55:20 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558575        1
[INPUT] 0    0    [1    /1   ]  7617.52191079        1
[INPUT] 0    0    [1    /1   ]  3617.35086953        1
[INPUT] 0    0    [1    /1   ]  1597.82559201        1
[INPUT] 0    0    [1    /1   ]  382.851121377        1
[INPUT] 0    0    [1    /1   ]  108.121036908        1
[INPUT] 0    0    [1    /1   ]  34.8057341565        1
[INPUT] 0    0    [1    /1   ]  4.65138990428        1
[INPUT] 0    0    [1    /1   ]  0.92682305685        1
[INPUT] 0    0    [1    /1   ]  0.37842867454        1
[INPUT] 1    0    [1    /1   ]  1362.78320701        1
[INPUT] 1    0    [1    /1   ]  664.745673705        1
[INPUT] 1    0    [1    /1   ]  300.961957293        1
[INPUT] 1    0    [1    /1   ]  314.04224444         1
[INPUT] 1    0    [1    /1   ]  61.6222253366        1
[INPUT] 1    0    [1    /1   ]  7.32834329726        1
[INPUT] 1    0    [1    /1   ]  20.2394653826        1
[INPUT] 1    0    [1    /1   ]  0.779515355288       1
[INPUT] 1    0    [1    /1   ]  2.81079072942        1
[INPUT] 1    0    [1    /1   ]  0.210641183888       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.65585745578, 1.0]], [0, [7617.521910794613, 1.0]], [0, [3617.3508695283776, 1.0]], [0, [1597.8255920143743, 1.0]], [0, [382.85112137672223, 1.0]], [0, [108.12103690832568, 1.0]], [0, [34.80573415646265, 1.0]], [0, [4.651389904282691, 1.0]], [0, [0.9268230568503043, 1.0]], [0, [0.3784286745399317, 1.0]], [1, [1362.7832070117533, 1.0]], [1, [664.7456737048253, 1.0]], [1, [300.9619572925211, 1.0]], [1, [314.04224444037396, 1.0]], [1, [61.62222533663962, 1.0]], [1, [7.328343297256069, 1.0]], [1, [20.23946538259119, 1.0]], [1, [0.7795153552879164, 1.0]], [1, [2.81079072941704, 1.0]], [1, [0.21064118388804798, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65585746]
bas 1, expnt(s) = [7617.52191079]
bas 2, expnt(s) = [3617.35086953]
bas 3, expnt(s) = [1597.82559201]
bas 4, expnt(s) = [382.85112138]
bas 5, expnt(s) = [108.12103691]
bas 6, expnt(s) = [34.80573416]
bas 7, expnt(s) = [4.6513899]
bas 8, expnt(s) = [0.92682306]
bas 9, expnt(s) = [0.37842867]
bas 10, expnt(s) = [1362.78320701]
bas 11, expnt(s) = [664.7456737]
bas 12, expnt(s) = [300.96195729]
bas 13, expnt(s) = [314.04224444]
bas 14, expnt(s) = [61.62222534]
bas 15, expnt(s) = [7.3283433]
bas 16, expnt(s) = [20.23946538]
bas 17, expnt(s) = [0.77951536]
bas 18, expnt(s) = [2.81079073]
bas 19, expnt(s) = [0.21064118]
CPU time:        44.49
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752191e+03 2.06003836e+03
 3.61735087e+03 1.17844143e+03 1.59782559e+03 6.38501694e+02
 3.82851121e+02 2.18669125e+02 1.08121037e+02 8.47125345e+01
 3.48057342e+01 3.62037138e+01 4.65138990e+00 8.00206516e+00
 9.26823057e-01 2.38650664e+00 3.78428675e-01 1.21899816e+00
 1.36278321e+03 2.41556017e+04 6.64745674e+02 9.84699669e+03
 3.00961957e+02 3.65699104e+03 3.14042244e+02 3.85673220e+03
 6.16222253e+01 5.03681633e+02 7.32834330e+00 3.51756110e+01
 2.02394654e+01 1.25237154e+02 7.79515355e-01 2.13680670e+00
 2.81079073e+00 1.06174453e+01 2.10641184e-01 4.16306797e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.984211221578892
cond(S) = 100376.61662850894
E1 = -728.6959193088599  E_coul = 202.95553570227284
init E= -525.740383606587
    CPU time for initialize scf      7.69 sec, wall time      0.35 sec
  HOMO = -0.55817665638602  LUMO = 0.985114996641562
  mo_energy =
[-1.18348570e+02 -1.21572026e+01 -9.46651368e+00 -9.46651368e+00
 -9.46651368e+00 -1.22907819e+00 -5.58176656e-01 -5.58176656e-01
 -5.58176656e-01  9.85114997e-01  9.85114997e-01  9.85114997e-01
  2.10314781e+00  7.30840161e+00  7.30840161e+00  7.30840161e+00
  3.34730845e+01  3.34730845e+01  3.34730845e+01  7.87999912e+01
  1.29095075e+02  1.29095075e+02  1.29095075e+02  4.83496013e+02
  4.83496013e+02  4.83496013e+02  5.62317977e+02  1.33539592e+03
  1.33539592e+03  1.33539592e+03  2.63396866e+03  3.02970963e+03
  3.02970963e+03  3.02970963e+03  6.65026751e+03  6.65026751e+03
  6.65026751e+03  9.04140983e+03  2.53981572e+04  7.61418584e+04]
E1 = -727.3919601322159  E_coul = 200.81972824656603
cycle= 1 E= -526.57223188565  delta_E= -0.832  |g|= 0.23  |ddm|= 0.441
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.633795
diis-c [-0.40169604  1.        ]
  HOMO = -0.589092144599384  LUMO = 0.964302065651079
  mo_energy =
[-1.18704242e+02 -1.22871896e+01 -9.61670322e+00 -9.61670322e+00
 -9.61670322e+00 -1.26804455e+00 -5.89092145e-01 -5.89092145e-01
 -5.89092145e-01  9.64302066e-01  9.64302066e-01  9.64302066e-01
  2.05635742e+00  7.22090469e+00  7.22090469e+00  7.22090469e+00
  3.33116381e+01  3.33116381e+01  3.33116381e+01  7.85770792e+01
  1.28840452e+02  1.28840452e+02  1.28840452e+02  4.83147383e+02
  4.83147383e+02  4.83147383e+02  5.61920930e+02  1.33497830e+03
  1.33497830e+03  1.33497830e+03  2.63340241e+03  3.02921839e+03
  3.02921839e+03  3.02921839e+03  6.64965306e+03  6.64965306e+03
  6.64965306e+03  9.04071403e+03  2.53973621e+04  7.61409695e+04]
E1 = -727.9794112283022  E_coul = 201.40625521113512
cycle= 2 E= -526.573156017167  delta_E= -0.000924  |g|= 0.0415  |ddm|= 0.0728
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0809767
diis-c [-0.00307648  0.0854594   0.9145406 ]
  HOMO = -0.580627620186272  LUMO = 0.970430654790319
  mo_energy =
[-1.18631541e+02 -1.22484669e+01 -9.57625389e+00 -9.57625389e+00
 -9.57625389e+00 -1.25790823e+00 -5.80627620e-01 -5.80627620e-01
 -5.80627620e-01  9.70430655e-01  9.70430655e-01  9.70430655e-01
  2.06926031e+00  7.24414949e+00  7.24414949e+00  7.24414949e+00
  3.33525755e+01  3.33525755e+01  3.33525755e+01  7.86363495e+01
  1.28899564e+02  1.28899564e+02  1.28899564e+02  4.83219191e+02
  4.83219191e+02  4.83219191e+02  5.61995601e+02  1.33505463e+03
  1.33505463e+03  1.33505463e+03  2.63348215e+03  3.02929707e+03
  3.02929707e+03  3.02929707e+03  6.64973340e+03  6.64973340e+03
  6.64973340e+03  9.04079511e+03  2.53974436e+04  7.61410512e+04]
E1 = -727.8250202591457  E_coul = 201.25180039541752
cycle= 3 E= -526.573219863728  delta_E= -6.38e-05  |g|= 0.00604  |ddm|= 0.0186
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0124832
diis-c [-1.73097758e-06 -1.86134948e-03  1.24390105e-01  8.77471244e-01]
  HOMO = -0.582258881772418  LUMO = 0.969254771993653
  mo_energy =
[-1.18641579e+02 -1.22544975e+01 -9.58264986e+00 -9.58264986e+00
 -9.58264986e+00 -1.25990013e+00 -5.82258882e-01 -5.82258882e-01
 -5.82258882e-01  9.69254772e-01  9.69254772e-01  9.69254772e-01
  2.06683363e+00  7.24009878e+00  7.24009878e+00  7.24009878e+00
  3.33461760e+01  3.33461760e+01  3.33461760e+01  7.86280399e+01
  1.28891065e+02  1.28891065e+02  1.28891065e+02  4.83209274e+02
  4.83209274e+02  4.83209274e+02  5.61985299e+02  1.33504412e+03
  1.33504412e+03  1.33504412e+03  2.63347099e+03  3.02928618e+03
  3.02928618e+03  3.02928618e+03  6.64972210e+03  6.64972210e+03
  6.64972210e+03  9.04078357e+03  2.53974319e+04  7.61410393e+04]
E1 = -727.8488752707781  E_coul = 201.27565342852597
cycle= 4 E= -526.573221842252  delta_E= -1.98e-06  |g|= 0.000163  |ddm|= 0.00333
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000255545
diis-c [-1.61658982e-08 -6.67865030e-05  6.17618071e-04  2.36028348e-02
  9.75846334e-01]
  HOMO = -0.582178215321776  LUMO = 0.969309612813754
  mo_energy =
[-1.18641281e+02 -1.22542335e+01 -9.58238315e+00 -9.58238315e+00
 -9.58238315e+00 -1.25981131e+00 -5.82178215e-01 -5.82178215e-01
 -5.82178215e-01  9.69309613e-01  9.69309613e-01  9.69309613e-01
  2.06693775e+00  7.24028433e+00  7.24028433e+00  7.24028433e+00
  3.33464319e+01  3.33464319e+01  3.33464319e+01  7.86283289e+01
  1.28891351e+02  1.28891351e+02  1.28891351e+02  4.83209570e+02
  4.83209570e+02  4.83209570e+02  5.61985592e+02  1.33504442e+03
  1.33504442e+03  1.33504442e+03  2.63347128e+03  3.02928646e+03
  3.02928646e+03  3.02928646e+03  6.64972238e+03  6.64972238e+03
  6.64972238e+03  9.04078385e+03  2.53974321e+04  7.61410396e+04]
E1 = -727.8479142580567  E_coul = 201.27469241264689
cycle= 5 E= -526.57322184541  delta_E= -3.16e-09  |g|= 2.56e-05  |ddm|= 0.000112
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.91002e-05
diis-c [-3.35658019e-11  2.91699427e-06 -2.40441094e-04 -4.01753684e-03
  3.46782876e-02  9.69576773e-01]
  HOMO = -0.582187952282473  LUMO = 0.969302399714519
  mo_energy =
[-1.18641322e+02 -1.22542643e+01 -9.58241475e+00 -9.58241475e+00
 -9.58241475e+00 -1.25982464e+00 -5.82187952e-01 -5.82187952e-01
 -5.82187952e-01  9.69302400e-01  9.69302400e-01  9.69302400e-01
  2.06692179e+00  7.24026208e+00  7.24026208e+00  7.24026208e+00
  3.33464007e+01  3.33464007e+01  3.33464007e+01  7.86282922e+01
  1.28891314e+02  1.28891314e+02  1.28891314e+02  4.83209530e+02
  4.83209530e+02  4.83209530e+02  5.61985551e+02  1.33504438e+03
  1.33504438e+03  1.33504438e+03  2.63347123e+03  3.02928642e+03
  3.02928642e+03  3.02928642e+03  6.64972234e+03  6.64972234e+03
  6.64972234e+03  9.04078381e+03  2.53974321e+04  7.61410396e+04]
E1 = -727.8480271050346  E_coul = 201.27480525956486
cycle= 6 E= -526.57322184547  delta_E= -6e-11  |g|= 1.93e-06  |ddm|= 2.89e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -727.8480271050346  E_coul = 201.27480525956486
  HOMO = -0.582187555824919  LUMO = 0.96930262295872
  mo_energy =
[-1.18641319e+02 -1.22542628e+01 -9.58241306e+00 -9.58241306e+00
 -9.58241306e+00 -1.25982447e+00 -5.82187556e-01 -5.82187556e-01
 -5.82187556e-01  9.69302623e-01  9.69302623e-01  9.69302623e-01
  2.06692197e+00  7.24026311e+00  7.24026311e+00  7.24026311e+00
  3.33464024e+01  3.33464024e+01  3.33464024e+01  7.86282941e+01
  1.28891316e+02  1.28891316e+02  1.28891316e+02  4.83209533e+02
  4.83209533e+02  4.83209533e+02  5.61985554e+02  1.33504438e+03
  1.33504438e+03  1.33504438e+03  2.63347124e+03  3.02928643e+03
  3.02928643e+03  3.02928643e+03  6.64972234e+03  6.64972234e+03
  6.64972234e+03  9.04078381e+03  2.53974321e+04  7.61410396e+04]
E1 = -727.8480205919707  E_coul = 201.27479874649885
Extra cycle  E= -526.573221845472  delta_E= -2.05e-12  |g|= 4.82e-07  |ddm|= 2.61e-06
    CPU time for scf_cycle      7.92 sec, wall time      0.56 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 100376.61662850894
E1 = -727.8480205919707  E_coul = 201.27479874649885
init E= -526.573221845472
    CPU time for initialize scf     15.71 sec, wall time      0.75 sec
  HOMO = -0.582187689404767  LUMO = 0.969302517701695
  mo_energy =
[-1.18641320e+02 -1.22542632e+01 -9.58241354e+00 -9.58241354e+00
 -9.58241354e+00 -1.25982469e+00 -5.82187689e-01 -5.82187689e-01
 -5.82187689e-01  9.69302518e-01  9.69302518e-01  9.69302518e-01
  2.06692171e+00  7.24026280e+00  7.24026280e+00  7.24026280e+00
  3.33464019e+01  3.33464019e+01  3.33464019e+01  7.86282934e+01
  1.28891316e+02  1.28891316e+02  1.28891316e+02  4.83209532e+02
  4.83209532e+02  4.83209532e+02  5.61985553e+02  1.33504438e+03
  1.33504438e+03  1.33504438e+03  2.63347124e+03  3.02928642e+03
  3.02928642e+03  3.02928642e+03  6.64972234e+03  6.64972234e+03
  6.64972234e+03  9.04078381e+03  2.53974321e+04  7.61410396e+04]
E1 = -727.8480223074874  E_coul = 201.27480046201632
cycle= 1 E= -526.573221845471  delta_E= 6.82e-13  |g|= 1.1e-07  |ddm|= 7.04e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.8480223074874  E_coul = 201.27480046201632
  HOMO = -0.582187657862501  LUMO = 0.969302538611634
  mo_energy =
[-1.18641320e+02 -1.22542631e+01 -9.58241340e+00 -9.58241340e+00
 -9.58241340e+00 -1.25982466e+00 -5.82187658e-01 -5.82187658e-01
 -5.82187658e-01  9.69302539e-01  9.69302539e-01  9.69302539e-01
  2.06692174e+00  7.24026288e+00  7.24026288e+00  7.24026288e+00
  3.33464020e+01  3.33464020e+01  3.33464020e+01  7.86282936e+01
  1.28891316e+02  1.28891316e+02  1.28891316e+02  4.83209532e+02
  4.83209532e+02  4.83209532e+02  5.61985553e+02  1.33504438e+03
  1.33504438e+03  1.33504438e+03  2.63347124e+03  3.02928642e+03
  3.02928642e+03  3.02928642e+03  6.64972234e+03  6.64972234e+03
  6.64972234e+03  9.04078381e+03  2.53974321e+04  7.61410396e+04]
E1 = -727.8480217972219  E_coul = 201.274799951751
Extra cycle  E= -526.573221845471  delta_E= 2.27e-13  |g|= 3.14e-08  |ddm|= 7.34e-08
    CPU time for scf_cycle     15.83 sec, wall time      0.86 sec
exp = [2.61826559e+04 7.61752191e+03 3.61735087e+03 1.59782559e+03
 3.82851121e+02 1.08121037e+02 3.48057342e+01 4.65138990e+00
 9.26823057e-01 3.78428675e-01 1.36278321e+03 6.64745674e+02
 3.00961957e+02 3.14042244e+02 6.16222253e+01 7.32834330e+00
 2.02394654e+01 7.79515355e-01 2.81079073e+00 2.10641184e-01]
grad_E = [-1.51152964e-06  3.33512295e-06 -1.41821076e-06  7.03190476e-05
 -2.47040194e-05  5.60554278e-04 -2.82542847e-03 -1.80603975e-01
 -1.84577043e-02  1.79561695e-01 -5.07430342e-07  5.04352282e-06
  2.38190447e-05  2.05343861e-05 -4.05103691e-05 -1.56266024e-03
  2.49275833e-04  1.08895914e-01  1.14644181e-04 -3.85495270e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:55:25 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.65586          1
[INPUT] 0    0    [1    /1   ]  7617.52190519        1
[INPUT] 0    0    [1    /1   ]  3617.35087193        1
[INPUT] 0    0    [1    /1   ]  1597.82547428        1
[INPUT] 0    0    [1    /1   ]  382.851136461        1
[INPUT] 0    0    [1    /1   ]  108.120406308        1
[INPUT] 0    0    [1    /1   ]  34.8088892904        1
[INPUT] 0    0    [1    /1   ]  4.87265755156        1
[INPUT] 0    0    [1    /1   ]  1.07258004526        1
[INPUT] 0    0    [1    /1   ]  0.564855980377       1
[INPUT] 1    0    [1    /1   ]  1362.78320787        1
[INPUT] 1    0    [1    /1   ]  664.745665255        1
[INPUT] 1    0    [1    /1   ]  300.961917446        1
[INPUT] 1    0    [1    /1   ]  314.042210086        1
[INPUT] 1    0    [1    /1   ]  61.6222539954        1
[INPUT] 1    0    [1    /1   ]  7.32862703356        1
[INPUT] 1    0    [1    /1   ]  20.2394499734        1
[INPUT] 1    0    [1    /1   ]  0.717055701873       1
[INPUT] 1    0    [1    /1   ]  2.81146085074        1
[INPUT] 1    0    [1    /1   ]  0.443572589292       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.65586000102, 1.0]], [0, [7617.521905193927, 1.0]], [0, [3617.3508719289616, 1.0]], [0, [1597.8254742847691, 1.0]], [0, [382.85113646139155, 1.0]], [0, [108.1204063082332, 1.0]], [0, [34.80888929043238, 1.0]], [0, [4.872657551556986, 1.0]], [0, [1.0725800452645877, 1.0]], [0, [0.5648559803767189, 1.0]], [1, [1362.7832078684348, 1.0]], [1, [664.7456652548145, 1.0]], [1, [300.9619174458676, 1.0]], [1, [314.04221008578236, 1.0]], [1, [61.62225399536096, 1.0]], [1, [7.328627033561943, 1.0]], [1, [20.239449973431896, 1.0]], [1, [0.717055701873301, 1.0]], [1, [2.8114608507386487, 1.0]], [1, [0.4435725892919731, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65586]
bas 1, expnt(s) = [7617.52190519]
bas 2, expnt(s) = [3617.35087193]
bas 3, expnt(s) = [1597.82547428]
bas 4, expnt(s) = [382.85113646]
bas 5, expnt(s) = [108.12040631]
bas 6, expnt(s) = [34.80888929]
bas 7, expnt(s) = [4.87265755]
bas 8, expnt(s) = [1.07258005]
bas 9, expnt(s) = [0.56485598]
bas 10, expnt(s) = [1362.78320787]
bas 11, expnt(s) = [664.74566525]
bas 12, expnt(s) = [300.96191745]
bas 13, expnt(s) = [314.04221009]
bas 14, expnt(s) = [61.622254]
bas 15, expnt(s) = [7.32862703]
bas 16, expnt(s) = [20.23944997]
bas 17, expnt(s) = [0.7170557]
bas 18, expnt(s) = [2.81146085]
bas 19, expnt(s) = [0.44357259]
CPU time:        72.96
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752191e+03 2.06003836e+03
 3.61735087e+03 1.17844143e+03 1.59782547e+03 6.38501659e+02
 3.82851136e+02 2.18669131e+02 1.08120406e+02 8.47121640e+01
 3.48088893e+01 3.62061752e+01 4.87265755e+00 8.28589531e+00
 1.07258005e+00 2.66279240e+00 5.64855980e-01 1.64614589e+00
 1.36278321e+03 2.41556017e+04 6.64745665e+02 9.84699653e+03
 3.00961917e+02 3.65699043e+03 3.14042210e+02 3.85673167e+03
 6.16222540e+01 5.03681926e+02 7.32862703e+00 3.51773134e+01
 2.02394500e+01 1.25237034e+02 7.17055702e-01 1.92497684e+00
 2.81146085e+00 1.06206096e+01 4.43572589e-01 1.05606407e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.7889579825585
cond(S) = 100746.26064122678
E1 = -726.7154145789027  E_coul = 202.01088769199825
init E= -524.704526886904
    CPU time for initialize scf      7.76 sec, wall time      0.37 sec
  HOMO = -0.548029875258246  LUMO = 1.61736198012642
  mo_energy =
[-1.18413585e+02 -1.22389863e+01 -9.53050631e+00 -9.53050631e+00
 -9.53050631e+00 -1.23054456e+00 -5.48029875e-01 -5.48029875e-01
 -5.48029875e-01  1.61736198e+00  1.61736198e+00  1.61736198e+00
  3.12990348e+00  7.96311501e+00  7.96311501e+00  7.96311501e+00
  3.39351304e+01  3.39351304e+01  3.39351304e+01  8.11386527e+01
  1.29418020e+02  1.29418020e+02  1.29418020e+02  4.83719937e+02
  4.83719937e+02  4.83719937e+02  5.64177739e+02  1.33558060e+03
  1.33558060e+03  1.33558060e+03  2.63552997e+03  3.02987398e+03
  3.02987398e+03  3.02987398e+03  6.65041101e+03  6.65041101e+03
  6.65041101e+03  9.04282411e+03  2.53994891e+04  7.61430937e+04]
E1 = -731.6593356410033  E_coul = 205.42333449071515
cycle= 1 E= -526.236001150288  delta_E= -1.53  |g|= 0.217  |ddm|=  5.7
    CPU time for cycle= 1      0.03 sec, wall time      0.06 sec
diis-norm(errvec)=0.531255
diis-c [-0.28223233  1.        ]
  HOMO = -0.39119269268904  LUMO = 1.77295686284382
  mo_energy =
[-1.18319108e+02 -1.19854084e+01 -9.28796885e+00 -9.28796885e+00
 -9.28796885e+00 -1.06518632e+00 -3.91192693e-01 -3.91192693e-01
 -3.91192693e-01  1.77295686e+00  1.77295686e+00  1.77295686e+00
  3.33827359e+00  8.19482756e+00  8.19482756e+00  8.19482756e+00
  3.41601553e+01  3.41601553e+01  3.41601553e+01  8.13373225e+01
  1.29589455e+02  1.29589455e+02  1.29589455e+02  4.83819239e+02
  4.83819239e+02  4.83819239e+02  5.64232720e+02  1.33561805e+03
  1.33561805e+03  1.33561805e+03  2.63542639e+03  3.02984261e+03
  3.02984261e+03  3.02984261e+03  6.65026093e+03  6.65026093e+03
  6.65026093e+03  9.04259511e+03  2.53991628e+04  7.61426749e+04]
E1 = -731.2298189819875  E_coul = 204.99221332918734
cycle= 2 E= -526.2376056528  delta_E= -0.0016  |g|= 0.0154  |ddm|= 0.162
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0254564
diis-c [-5.07019834e-04 -2.28841520e-02  1.02288415e+00]
  HOMO = -0.400983973244099  LUMO = 1.76496868199125
  mo_energy =
[-1.18356942e+02 -1.20196618e+01 -9.32362332e+00 -9.32362332e+00
 -9.32362332e+00 -1.07721237e+00 -4.00983973e-01 -4.00983973e-01
 -4.00983973e-01  1.76496868e+00  1.76496868e+00  1.76496868e+00
  3.32129050e+00  8.17151165e+00  8.17151165e+00  8.17151165e+00
  3.41263413e+01  3.41263413e+01  3.41263413e+01  8.13011651e+01
  1.29552339e+02  1.29552339e+02  1.29552339e+02  4.83781698e+02
  4.83781698e+02  4.83781698e+02  5.64195263e+02  1.33558049e+03
  1.33558049e+03  1.33558049e+03  2.63538853e+03  3.02980496e+03
  3.02980496e+03  3.02980496e+03  6.65022291e+03  6.65022291e+03
  6.65022291e+03  9.04255681e+03  2.53991241e+04  7.61426359e+04]
E1 = -731.2991405790755  E_coul = 205.06151927017402
cycle= 3 E= -526.237621308901  delta_E= -1.57e-05  |g|= 0.00456  |ddm|= 0.0271
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00899568
diis-c [-6.51519225e-06 -1.19792047e-03  2.63130318e-01  7.38067602e-01]
  HOMO = -0.399902374923626  LUMO = 1.76588851413851
  mo_energy =
[-1.18349727e+02 -1.20152076e+01 -9.31893298e+00 -9.31893298e+00
 -9.31893298e+00 -1.07594622e+00 -3.99902375e-01 -3.99902375e-01
 -3.99902375e-01  1.76588851e+00  1.76588851e+00  1.76588851e+00
  3.32321402e+00  8.17428833e+00  8.17428833e+00  8.17428833e+00
  3.41309802e+01  3.41309802e+01  3.41309802e+01  8.13072887e+01
  1.29558523e+02  1.29558523e+02  1.29558523e+02  4.83788824e+02
  4.83788824e+02  4.83788824e+02  5.64202578e+02  1.33558794e+03
  1.33558794e+03  1.33558794e+03  2.63539622e+03  3.02981257e+03
  3.02981257e+03  3.02981257e+03  6.65023066e+03  6.65023066e+03
  6.65023066e+03  9.04256462e+03  2.53991320e+04  7.61426438e+04]
E1 = -731.2879981319528  E_coul = 205.05037610931424
cycle= 4 E= -526.237622022639  delta_E= -7.14e-07  |g|= 0.000362  |ddm|= 0.00304
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00065058
diis-c [-2.67121927e-08 -1.42054060e-04  3.76123504e-03 -6.77725213e-02
  1.06415334e+00]
  HOMO = -0.399761090883435  LUMO = 1.76600628483502
  mo_energy =
[-1.18349082e+02 -1.20147166e+01 -9.31842140e+00 -9.31842140e+00
 -9.31842140e+00 -1.07579043e+00 -3.99761091e-01 -3.99761091e-01
 -3.99761091e-01  1.76600628e+00  1.76600628e+00  1.76600628e+00
  3.32344423e+00  8.17462034e+00  8.17462034e+00  8.17462034e+00
  3.41314788e+01  3.41314788e+01  3.41314788e+01  8.13078876e+01
  1.29559122e+02  1.29559122e+02  1.29559122e+02  4.83789462e+02
  4.83789462e+02  4.83789462e+02  5.64203214e+02  1.33558858e+03
  1.33558858e+03  1.33558858e+03  2.63539685e+03  3.02981321e+03
  3.02981321e+03  3.02981321e+03  6.65023128e+03  6.65023128e+03
  6.65023128e+03  9.04256524e+03  2.53991326e+04  7.61426444e+04]
E1 = -731.2869387675162  E_coul = 205.04931673900677
cycle= 5 E= -526.237622028509  delta_E= -5.87e-09  |g|= 8.82e-06  |ddm|= 0.000235
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.01859e-05
diis-c [-2.51637444e-11  3.40255924e-06 -3.39169215e-04  3.27245379e-03
 -5.72699711e-02  1.05433328e+00]
  HOMO = -0.399761163019953  LUMO = 1.76600611172556
  mo_energy =
[-1.18349086e+02 -1.20147196e+01 -9.31842403e+00 -9.31842403e+00
 -9.31842403e+00 -1.07579180e+00 -3.99761163e-01 -3.99761163e-01
 -3.99761163e-01  1.76600611e+00  1.76600611e+00  1.76600611e+00
  3.32344231e+00  8.17461939e+00  8.17461939e+00  8.17461939e+00
  3.41314765e+01  3.41314765e+01  3.41314765e+01  8.13078843e+01
  1.29559119e+02  1.29559119e+02  1.29559119e+02  4.83789459e+02
  4.83789459e+02  4.83789459e+02  5.64203210e+02  1.33558857e+03
  1.33558857e+03  1.33558857e+03  2.63539684e+03  3.02981320e+03
  3.02981320e+03  3.02981320e+03  6.65023128e+03  6.65023128e+03
  6.65023128e+03  9.04256524e+03  2.53991326e+04  7.61426444e+04]
E1 = -731.2869457771761  E_coul = 205.04932374865993
cycle= 6 E= -526.237622028516  delta_E= -6.82e-12  |g|= 7.26e-07  |ddm|= 1.9e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -731.2869457771761  E_coul = 205.04932374865993
  HOMO = -0.399761058435846  LUMO = 1.76600618895551
  mo_energy =
[-1.18349085e+02 -1.20147192e+01 -9.31842345e+00 -9.31842345e+00
 -9.31842345e+00 -1.07579175e+00 -3.99761058e-01 -3.99761058e-01
 -3.99761058e-01  1.76600619e+00  1.76600619e+00  1.76600619e+00
  3.32344239e+00  8.17461969e+00  8.17461969e+00  8.17461969e+00
  3.41314771e+01  3.41314771e+01  3.41314771e+01  8.13078850e+01
  1.29559120e+02  1.29559120e+02  1.29559120e+02  4.83789460e+02
  4.83789460e+02  4.83789460e+02  5.64203211e+02  1.33558857e+03
  1.33558857e+03  1.33558857e+03  2.63539684e+03  3.02981321e+03
  3.02981321e+03  3.02981321e+03  6.65023128e+03  6.65023128e+03
  6.65023128e+03  9.04256524e+03  2.53991326e+04  7.61426444e+04]
E1 = -731.286944177095  E_coul = 205.04932214857982
Extra cycle  E= -526.237622028515  delta_E= 9.09e-13  |g|= 1.42e-07  |ddm|= 1.31e-06
    CPU time for scf_cycle      7.97 sec, wall time      0.62 sec
exp = [2.61826559e+04 7.61752191e+03 3.61735087e+03 1.59782547e+03
 3.82851136e+02 1.08120406e+02 3.48088893e+01 4.87265755e+00
 1.07258005e+00 5.64855980e-01 1.36278321e+03 6.64745665e+02
 3.00961917e+02 3.14042210e+02 6.16222540e+01 7.32862703e+00
 2.02394500e+01 7.17055702e-01 2.81146085e+00 4.43572589e-01]
E = -526.2376220285153
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:55:25 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558578        1
[INPUT] 0    0    [1    /1   ]  7617.52191012        1
[INPUT] 0    0    [1    /1   ]  3617.35086982        1
[INPUT] 0    0    [1    /1   ]  1597.82557791        1
[INPUT] 0    0    [1    /1   ]  382.851123184        1
[INPUT] 0    0    [1    /1   ]  108.120961343        1
[INPUT] 0    0    [1    /1   ]  34.8061122381        1
[INPUT] 0    0    [1    /1   ]  4.67790454552        1
[INPUT] 0    0    [1    /1   ]  0.944289208381       1
[INPUT] 0    0    [1    /1   ]  0.400768375769       1
[INPUT] 1    0    [1    /1   ]  1362.78320711        1
[INPUT] 1    0    [1    /1   ]  664.745672692        1
[INPUT] 1    0    [1    /1   ]  300.961952518        1
[INPUT] 1    0    [1    /1   ]  314.042240324        1
[INPUT] 1    0    [1    /1   ]  61.6222287708        1
[INPUT] 1    0    [1    /1   ]  7.32837729756        1
[INPUT] 1    0    [1    /1   ]  20.2394635361        1
[INPUT] 1    0    [1    /1   ]  0.772030775763       1
[INPUT] 1    0    [1    /1   ]  2.81087103048        1
[INPUT] 1    0    [1    /1   ]  0.238553500596       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.655857760776, 1.0]], [0, [7617.52191012348, 1.0]], [0, [3617.3508698160413, 1.0]], [0, [1597.8255779067617, 1.0]], [0, [382.85112318432766, 1.0]], [0, [108.12096134312026, 1.0]], [0, [34.806112238149254, 1.0]], [0, [4.677904545523158, 1.0]], [0, [0.9442892083808293, 1.0]], [0, [0.40076837576865004, 1.0]], [1, [1362.78320711441, 1.0]], [1, [664.7456726922552, 1.0]], [1, [300.9619525176716, 1.0]], [1, [314.04224032364164, 1.0]], [1, [61.622228770832216, 1.0]], [1, [7.328377297555932, 1.0]], [1, [20.239463536101947, 1.0]], [1, [0.7720307757631047, 1.0]], [1, [2.810871030476182, 1.0]], [1, [0.23855350059590624, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65585776]
bas 1, expnt(s) = [7617.52191012]
bas 2, expnt(s) = [3617.35086982]
bas 3, expnt(s) = [1597.82557791]
bas 4, expnt(s) = [382.85112318]
bas 5, expnt(s) = [108.12096134]
bas 6, expnt(s) = [34.80611224]
bas 7, expnt(s) = [4.67790455]
bas 8, expnt(s) = [0.94428921]
bas 9, expnt(s) = [0.40076838]
bas 10, expnt(s) = [1362.78320711]
bas 11, expnt(s) = [664.74567269]
bas 12, expnt(s) = [300.96195252]
bas 13, expnt(s) = [314.04224032]
bas 14, expnt(s) = [61.62222877]
bas 15, expnt(s) = [7.3283773]
bas 16, expnt(s) = [20.23946354]
bas 17, expnt(s) = [0.77203078]
bas 18, expnt(s) = [2.81087103]
bas 19, expnt(s) = [0.2385535]
CPU time:        80.99
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752191e+03 2.06003836e+03
 3.61735087e+03 1.17844143e+03 1.59782558e+03 6.38501690e+02
 3.82851123e+02 2.18669126e+02 1.08120961e+02 8.47124901e+01
 3.48061122e+01 3.62040088e+01 4.67790455e+00 8.03625189e+00
 9.44289208e-01 2.42015841e+00 4.00768376e-01 1.27258004e+00
 1.36278321e+03 2.41556017e+04 6.64745673e+02 9.84699667e+03
 3.00961953e+02 3.65699096e+03 3.14042240e+02 3.85673213e+03
 6.16222288e+01 5.03681668e+02 7.32837730e+00 3.51758150e+01
 2.02394635e+01 1.25237139e+02 7.72030776e-01 2.11119165e+00
 2.81087103e+00 1.06178245e+01 2.38553501e-01 4.86369838e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97870401438046
cond(S) = 100417.92682136144
E1 = -728.6701813517917  E_coul = 202.9359425783045
init E= -525.734238773487
    CPU time for initialize scf      3.98 sec, wall time      0.19 sec
  HOMO = -0.556557389793526  LUMO = 1.08814932210358
  mo_energy =
[-1.18351835e+02 -1.21626133e+01 -9.46948600e+00 -9.46948600e+00
 -9.46948600e+00 -1.22562818e+00 -5.56557390e-01 -5.56557390e-01
 -5.56557390e-01  1.08814932e+00  1.08814932e+00  1.08814932e+00
  2.23132805e+00  7.38790913e+00  7.38790913e+00  7.38790913e+00
  3.35255036e+01  3.35255036e+01  3.35255036e+01  7.90837597e+01
  1.29131872e+02  1.29131872e+02  1.29131872e+02  4.83522405e+02
  4.83522405e+02  4.83522405e+02  5.62542977e+02  1.33541828e+03
  1.33541828e+03  1.33541828e+03  2.63415808e+03  3.02972989e+03
  3.02972989e+03  3.02972989e+03  6.65028563e+03  6.65028563e+03
  6.65028563e+03  9.04158179e+03  2.53983194e+04  7.61420091e+04]
E1 = -727.9979922037729  E_coul = 201.42583236696572
cycle= 1 E= -526.572159836807  delta_E= -0.838  |g|= 0.219  |ddm|= 0.61
    CPU time for cycle= 1      0.06 sec, wall time      0.03 sec
diis-norm(errvec)=0.617956
diis-c [-0.38186973  1.        ]
  HOMO = -0.566331164559324  LUMO = 1.08241315116952
  mo_energy =
[-1.18658180e+02 -1.22492150e+01 -9.57532784e+00 -9.57532784e+00
 -9.57532784e+00 -1.24117930e+00 -5.66331165e-01 -5.66331165e-01
 -5.66331165e-01  1.08241315e+00  1.08241315e+00  1.08241315e+00
  2.21105837e+00  7.33825275e+00  7.33825275e+00  7.33825275e+00
  3.34077885e+01  3.34077885e+01  3.34077885e+01  7.89075006e+01
  1.28924476e+02  1.28924476e+02  1.28924476e+02  4.83222896e+02
  4.83222896e+02  4.83222896e+02  5.62195366e+02  1.33505037e+03
  1.33505037e+03  1.33505037e+03  2.63364227e+03  3.02928881e+03
  3.02928881e+03  3.02928881e+03  6.64972179e+03  6.64972179e+03
  6.64972179e+03  9.04093685e+03  2.53975753e+04  7.61411714e+04]
E1 = -728.4072558637097  E_coul = 201.83447684511776
cycle= 2 E= -526.572779018592  delta_E= -0.000619  |g|= 0.0335  |ddm|= 0.0525
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.065337
diis-c [-0.00222331  0.06838461  0.93161539]
  HOMO = -0.5611507669348  LUMO = 1.08636687372997
  mo_energy =
[-1.18601632e+02 -1.22221530e+01 -9.54695866e+00 -9.54695866e+00
 -9.54695866e+00 -1.23503295e+00 -5.61150767e-01 -5.61150767e-01
 -5.61150767e-01  1.08636687e+00  1.08636687e+00  1.08636687e+00
  2.21948254e+00  7.35349049e+00  7.35349049e+00  7.35349049e+00
  3.34368925e+01  3.34368925e+01  3.34368925e+01  7.89524223e+01
  1.28969125e+02  1.28969125e+02  1.28969125e+02  4.83278697e+02
  4.83278697e+02  4.83278697e+02  5.62253712e+02  1.33511017e+03
  1.33511017e+03  1.33511017e+03  2.63370506e+03  3.02935069e+03
  3.02935069e+03  3.02935069e+03  6.64978510e+03  6.64978510e+03
  6.64978510e+03  9.04100078e+03  2.53976396e+04  7.61412359e+04]
E1 = -728.3041030634595  E_coul = 201.73129292301033
cycle= 3 E= -526.572810140449  delta_E= -3.11e-05  |g|= 0.00466  |ddm|= 0.0127
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00991947
diis-c [-1.30670975e-06 -1.73946158e-03  1.21678440e-01  8.80061021e-01]
  HOMO = -0.56225658802738  LUMO = 1.0855397090413
  mo_energy =
[-1.18609419e+02 -1.22265823e+01 -9.55168690e+00 -9.55168690e+00
 -9.55168690e+00 -1.23638424e+00 -5.62256588e-01 -5.62256588e-01
 -5.62256588e-01  1.08553971e+00  1.08553971e+00  1.08553971e+00
  2.21776284e+00  7.35062296e+00  7.35062296e+00  7.35062296e+00
  3.34321477e+01  3.34321477e+01  3.34321477e+01  7.89460924e+01
  1.28962638e+02  1.28962638e+02  1.28962638e+02  4.83271010e+02
  4.83271010e+02  4.83271010e+02  5.62245691e+02  1.33510198e+03
  1.33510198e+03  1.33510198e+03  2.63369630e+03  3.02934216e+03
  3.02934216e+03  3.02934216e+03  6.64977621e+03  6.64977621e+03
  6.64977621e+03  9.04099169e+03  2.53976304e+04  7.61412265e+04]
E1 = -728.3204289356557  E_coul = 201.74761782815003
cycle= 4 E= -526.572811107506  delta_E= -9.67e-07  |g|= 0.000136  |ddm|= 0.00243
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000214709
diis-c [-1.23794040e-08 -4.91163467e-05 -3.66161713e-05  1.99219828e-02
  9.80163750e-01]
  HOMO = -0.562187012719062  LUMO = 1.08558895430838
  mo_energy =
[-1.18609157e+02 -1.22263552e+01 -9.55145755e+00 -9.55145755e+00
 -9.55145755e+00 -1.23630683e+00 -5.62187013e-01 -5.62187013e-01
 -5.62187013e-01  1.08558895e+00  1.08558895e+00  1.08558895e+00
  2.21785718e+00  7.35078213e+00  7.35078213e+00  7.35078213e+00
  3.34323689e+01  3.34323689e+01  3.34323689e+01  7.89463457e+01
  1.28962889e+02  1.28962889e+02  1.28962889e+02  4.83271270e+02
  4.83271270e+02  4.83271270e+02  5.62245948e+02  1.33510224e+03
  1.33510224e+03  1.33510224e+03  2.63369655e+03  3.02934241e+03
  3.02934241e+03  3.02934241e+03  6.64977646e+03  6.64977646e+03
  6.64977646e+03  9.04099193e+03  2.53976306e+04  7.61412267e+04]
E1 = -728.3196949836054  E_coul = 201.7468838742836
cycle= 5 E= -526.572811109322  delta_E= -1.82e-09  |g|= 2.07e-05  |ddm|= 8.79e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.47058e-05
diis-c [-1.31420080e-11  1.96149548e-06 -1.86302333e-04 -3.89293425e-03
  3.97354889e-02  9.64341786e-01]
  HOMO = -0.562194724768927  LUMO = 1.08558313285154
  mo_energy =
[-1.18609192e+02 -1.22263810e+01 -9.55148431e+00 -9.55148431e+00
 -9.55148431e+00 -1.23631709e+00 -5.62194725e-01 -5.62194725e-01
 -5.62194725e-01  1.08558313e+00  1.08558313e+00  1.08558313e+00
  2.21784452e+00  7.35076397e+00  7.35076397e+00  7.35076397e+00
  3.34323426e+01  3.34323426e+01  3.34323426e+01  7.89463144e+01
  1.28962857e+02  1.28962857e+02  1.28962857e+02  4.83271236e+02
  4.83271236e+02  4.83271236e+02  5.62245913e+02  1.33510220e+03
  1.33510220e+03  1.33510220e+03  2.63369651e+03  3.02934238e+03
  3.02934238e+03  3.02934238e+03  6.64977642e+03  6.64977642e+03
  6.64977642e+03  9.04099190e+03  2.53976306e+04  7.61412267e+04]
E1 = -728.3197815507586  E_coul = 201.74697044140257
cycle= 6 E= -526.572811109356  delta_E= -3.43e-11  |g|= 1.22e-06  |ddm|= 2.16e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3197815507586  E_coul = 201.74697044140257
  HOMO = -0.56219445847089  LUMO = 1.08558329232416
  mo_energy =
[-1.18609190e+02 -1.22263800e+01 -9.55148319e+00 -9.55148319e+00
 -9.55148319e+00 -1.23631696e+00 -5.62194458e-01 -5.62194458e-01
 -5.62194458e-01  1.08558329e+00  1.08558329e+00  1.08558329e+00
  2.21784467e+00  7.35076466e+00  7.35076466e+00  7.35076466e+00
  3.34323437e+01  3.34323437e+01  3.34323437e+01  7.89463157e+01
  1.28962858e+02  1.28962858e+02  1.28962858e+02  4.83271237e+02
  4.83271237e+02  4.83271237e+02  5.62245915e+02  1.33510220e+03
  1.33510220e+03  1.33510220e+03  2.63369651e+03  3.02934238e+03
  3.02934238e+03  3.02934238e+03  6.64977642e+03  6.64977642e+03
  6.64977642e+03  9.04099190e+03  2.53976306e+04  7.61412267e+04]
E1 = -728.319777645624  E_coul = 201.7469665362692
Extra cycle  E= -526.572811109355  delta_E= 1.36e-12  |g|= 2.95e-07  |ddm|= 1.7e-06
    CPU time for scf_cycle      4.22 sec, wall time      0.40 sec
exp = [2.61826559e+04 7.61752191e+03 3.61735087e+03 1.59782558e+03
 3.82851123e+02 1.08120961e+02 3.48061122e+01 4.67790455e+00
 9.44289208e-01 4.00768376e-01 1.36278321e+03 6.64745673e+02
 3.00961953e+02 3.14042240e+02 6.16222288e+01 7.32837730e+00
 2.02394635e+01 7.72030776e-01 2.81087103e+00 2.38553501e-01]
E = -526.5728111093547
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:55:26 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558576        1
[INPUT] 0    0    [1    /1   ]  7617.52191047        1
[INPUT] 0    0    [1    /1   ]  3617.35086967        1
[INPUT] 0    0    [1    /1   ]  1597.82558518        1
[INPUT] 0    0    [1    /1   ]  382.851122252        1
[INPUT] 0    0    [1    /1   ]  108.121000312        1
[INPUT] 0    0    [1    /1   ]  34.8059172641        1
[INPUT] 0    0    [1    /1   ]  4.66423113305        1
[INPUT] 0    0    [1    /1   ]  0.935282037889       1
[INPUT] 0    0    [1    /1   ]  0.389247950256       1
[INPUT] 1    0    [1    /1   ]  1362.78320706        1
[INPUT] 1    0    [1    /1   ]  664.745673214        1
[INPUT] 1    0    [1    /1   ]  300.96195498         1
[INPUT] 1    0    [1    /1   ]  314.042242447        1
[INPUT] 1    0    [1    /1   ]  61.6222269998        1
[INPUT] 1    0    [1    /1   ]  7.32835976384        1
[INPUT] 1    0    [1    /1   ]  20.2394644883        1
[INPUT] 1    0    [1    /1   ]  0.775890520351       1
[INPUT] 1    0    [1    /1   ]  2.81082961979        1
[INPUT] 1    0    [1    /1   ]  0.224159316796       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.65585760349, 1.0]], [0, [7617.521910469578, 1.0]], [0, [3617.350869667695, 1.0]], [0, [1597.8255851819574, 1.0]], [0, [382.85112225215835, 1.0]], [0, [108.12100031156086, 1.0]], [0, [34.80591726410445, 1.0]], [0, [4.664231133050869, 1.0]], [0, [0.9352820378890832, 1.0]], [0, [0.3892479502559046, 1.0]], [1, [1362.7832070614706, 1.0]], [1, [664.7456732144304, 1.0]], [1, [300.9619549800276, 1.0]], [1, [314.04224244661134, 1.0]], [1, [61.62222699984345, 1.0]], [1, [7.328359763842388, 1.0]], [1, [20.239464488323357, 1.0]], [1, [0.7758905203508688, 1.0]], [1, [2.8108296197893976, 1.0]], [1, [0.22415931679600548, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.6558576]
bas 1, expnt(s) = [7617.52191047]
bas 2, expnt(s) = [3617.35086967]
bas 3, expnt(s) = [1597.82558518]
bas 4, expnt(s) = [382.85112225]
bas 5, expnt(s) = [108.12100031]
bas 6, expnt(s) = [34.80591726]
bas 7, expnt(s) = [4.66423113]
bas 8, expnt(s) = [0.93528204]
bas 9, expnt(s) = [0.38924795]
bas 10, expnt(s) = [1362.78320706]
bas 11, expnt(s) = [664.74567321]
bas 12, expnt(s) = [300.96195498]
bas 13, expnt(s) = [314.04224245]
bas 14, expnt(s) = [61.622227]
bas 15, expnt(s) = [7.32835976]
bas 16, expnt(s) = [20.23946449]
bas 17, expnt(s) = [0.77589052]
bas 18, expnt(s) = [2.81082962]
bas 19, expnt(s) = [0.22415932]
CPU time:        85.26
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752191e+03 2.06003836e+03
 3.61735087e+03 1.17844143e+03 1.59782559e+03 6.38501692e+02
 3.82851122e+02 2.18669125e+02 1.08121000e+02 8.47125130e+01
 3.48059173e+01 3.62038567e+01 4.66423113e+00 8.01862810e+00
 9.35282038e-01 2.40282405e+00 3.89247950e-01 1.24504422e+00
 1.36278321e+03 2.41556017e+04 6.64745673e+02 9.84699668e+03
 3.00961955e+02 3.65699100e+03 3.14042242e+02 3.85673216e+03
 6.16222270e+01 5.03681650e+02 7.32835976e+00 3.51757098e+01
 2.02394645e+01 1.25237147e+02 7.75890520e-01 2.12439343e+00
 2.81082962e+00 1.06176290e+01 2.24159317e-01 4.49966711e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.983158652466148
cond(S) = 100396.50030981765
E1 = -728.7014722566461  E_coul = 202.95447510444953
init E= -525.746997152197
    CPU time for initialize scf      7.64 sec, wall time      0.36 sec
  HOMO = -0.557397797067941  LUMO = 1.03644610943894
  mo_energy =
[-1.18349710e+02 -1.21593802e+01 -9.46749995e+00 -9.46749995e+00
 -9.46749995e+00 -1.22698369e+00 -5.57397797e-01 -5.57397797e-01
 -5.57397797e-01  1.03644611e+00  1.03644611e+00  1.03644611e+00
  2.16575568e+00  7.34704766e+00  7.34704766e+00  7.34704766e+00
  3.34985273e+01  3.34985273e+01  3.34985273e+01  7.89378229e+01
  1.29113018e+02  1.29113018e+02  1.29113018e+02  4.83508990e+02
  4.83508990e+02  4.83508990e+02  5.62427298e+02  1.33540697e+03
  1.33540697e+03  1.33540697e+03  2.63406075e+03  3.02971968e+03
  3.02971968e+03  3.02971968e+03  6.65027655e+03  6.65027655e+03
  6.65027655e+03  9.04149347e+03  2.53982361e+04  7.61419318e+04]
E1 = -727.687488001106  E_coul = 201.1121887382273
cycle= 1 E= -526.575299262879  delta_E= -0.828  |g|= 0.224  |ddm|= 0.415
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.626227
diis-c [-0.39215995  1.        ]
  HOMO = -0.578376940839761  LUMO = 1.02234115059215
  mo_energy =
[-1.18682331e+02 -1.22690035e+01 -9.59687289e+00 -9.59687289e+00
 -9.59687289e+00 -1.25495998e+00 -5.78376941e-01 -5.78376941e-01
 -5.78376941e-01  1.02234115e+00  1.02234115e+00  1.02234115e+00
  2.13127550e+00  7.27743270e+00  7.27743270e+00  7.27743270e+00
  3.33576104e+01  3.33576104e+01  3.33576104e+01  7.87367391e+01
  1.28880501e+02  1.28880501e+02  1.28880501e+02  4.83183317e+02
  4.83183317e+02  4.83183317e+02  5.62053346e+02  1.33501258e+03
  1.33501258e+03  1.33501258e+03  2.63351807e+03  3.02925188e+03
  3.02925188e+03  3.02925188e+03  6.64968574e+03  6.64968574e+03
  6.64968574e+03  9.04082143e+03  2.53974648e+04  7.61410668e+04]
E1 = -728.1860862671853  E_coul = 201.61002973734668
cycle= 2 E= -526.576056529839  delta_E= -0.000757  |g|= 0.0375  |ddm|= 0.063
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0732935
diis-c [-0.00264696  0.07718548  0.92281452]
  HOMO = -0.571559327923529  LUMO = 1.02739868920455
  mo_energy =
[-1.18617541e+02 -1.22360449e+01 -9.56238948e+00 -9.56238948e+00
 -9.56238948e+00 -1.24682765e+00 -5.71559328e-01 -5.71559328e-01
 -5.71559328e-01  1.02739869e+00  1.02739869e+00  1.02739869e+00
  2.14196749e+00  7.29668950e+00  7.29668950e+00  7.29668950e+00
  3.33927049e+01  3.33927049e+01  3.33927049e+01  7.87889599e+01
  1.28932509e+02  1.28932509e+02  1.28932509e+02  4.83247283e+02
  4.83247283e+02  4.83247283e+02  5.62120025e+02  1.33508081e+03
  1.33508081e+03  1.33508081e+03  2.63358952e+03  3.02932234e+03
  3.02932234e+03  3.02932234e+03  6.64975775e+03  6.64975775e+03
  6.64975775e+03  9.04089413e+03  2.53975380e+04  7.61411400e+04]
E1 = -728.0582327227767  E_coul = 201.48213064011927
cycle= 3 E= -526.576102082657  delta_E= -4.56e-05  |g|= 0.00534  |ddm|= 0.0156
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0112088
diis-c [-1.48163428e-06 -1.79900308e-03  1.23071779e-01  8.78727224e-01]
  HOMO = -0.572918397953534  LUMO = 1.02640074730349
  mo_energy =
[-1.18626455e+02 -1.22412634e+01 -9.56794112e+00 -9.56794112e+00
 -9.56794112e+00 -1.24848736e+00 -5.72918398e-01 -5.72918398e-01
 -5.72918398e-01  1.02640075e+00  1.02640075e+00  1.02640075e+00
  2.13990241e+00  7.29324521e+00  7.29324521e+00  7.29324521e+00
  3.33871429e+01  3.33871429e+01  3.33871429e+01  7.87816445e+01
  1.28925020e+02  1.28925020e+02  1.28925020e+02  4.83238481e+02
  4.83238481e+02  4.83238481e+02  5.62110862e+02  1.33507147e+03
  1.33507147e+03  1.33507147e+03  2.63357955e+03  3.02931262e+03
  3.02931262e+03  3.02931262e+03  6.64974765e+03  6.64974765e+03
  6.64974765e+03  9.04088381e+03  2.53975275e+04  7.61411294e+04]
E1 = -728.0781078618489  E_coul = 201.50200437508212
cycle= 4 E= -526.576103486767  delta_E= -1.4e-06  |g|= 0.000146  |ddm|= 0.00286
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000229493
diis-c [-1.37981653e-08 -5.70520546e-05  2.95700841e-04  2.12622140e-02
  9.78499137e-01]
  HOMO = -0.572844581743799  LUMO = 1.02645191720561
  mo_energy =
[-1.18626180e+02 -1.22410221e+01 -9.56769744e+00 -9.56769744e+00
 -9.56769744e+00 -1.24840580e+00 -5.72844582e-01 -5.72844582e-01
 -5.72844582e-01  1.02645192e+00  1.02645192e+00  1.02645192e+00
  2.13999986e+00  7.29341454e+00  7.29341454e+00  7.29341454e+00
  3.33873772e+01  3.33873772e+01  3.33873772e+01  7.87819109e+01
  1.28925283e+02  1.28925283e+02  1.28925283e+02  4.83238754e+02
  4.83238754e+02  4.83238754e+02  5.62111132e+02  1.33507174e+03
  1.33507174e+03  1.33507174e+03  2.63357981e+03  3.02931289e+03
  3.02931289e+03  3.02931289e+03  6.64974791e+03  6.64974791e+03
  6.64974791e+03  9.04088407e+03  2.53975277e+04  7.61411297e+04]
E1 = -728.0772807474211  E_coul = 201.50117725832197
cycle= 5 E= -526.576103489099  delta_E= -2.33e-09  |g|= 2.28e-05  |ddm|= 9.75e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.64284e-05
diis-c [-2.10220538e-11  2.26832362e-06 -2.02105916e-04 -3.83634951e-03
  3.73092709e-02  9.66726916e-01]
  HOMO = -0.572853174011519  LUMO = 1.02644548580088
  mo_energy =
[-1.18626217e+02 -1.22410501e+01 -9.56772626e+00 -9.56772626e+00
 -9.56772626e+00 -1.24841742e+00 -5.72853174e-01 -5.72853174e-01
 -5.72853174e-01  1.02644549e+00  1.02644549e+00  1.02644549e+00
  2.13998574e+00  7.29339462e+00  7.29339462e+00  7.29339462e+00
  3.33873489e+01  3.33873489e+01  3.33873489e+01  7.87818773e+01
  1.28925249e+02  1.28925249e+02  1.28925249e+02  4.83238718e+02
  4.83238718e+02  4.83238718e+02  5.62111094e+02  1.33507170e+03
  1.33507170e+03  1.33507170e+03  2.63357978e+03  3.02931285e+03
  3.02931285e+03  3.02931285e+03  6.64974787e+03  6.64974787e+03
  6.64974787e+03  9.04088403e+03  2.53975277e+04  7.61411296e+04]
E1 = -728.0773785325881  E_coul = 201.50127504344545
cycle= 6 E= -526.576103489143  delta_E= -4.35e-11  |g|= 1.56e-06  |ddm|= 2.5e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.0773785325881  E_coul = 201.50127504344545
  HOMO = -0.572852850063316  LUMO = 1.02644567274374
  mo_energy =
[-1.18626215e+02 -1.22410488e+01 -9.56772489e+00 -9.56772489e+00
 -9.56772489e+00 -1.24841728e+00 -5.72852850e-01 -5.72852850e-01
 -5.72852850e-01  1.02644567e+00  1.02644567e+00  1.02644567e+00
  2.13998589e+00  7.29339546e+00  7.29339546e+00  7.29339546e+00
  3.33873502e+01  3.33873502e+01  3.33873502e+01  7.87818788e+01
  1.28925251e+02  1.28925251e+02  1.28925251e+02  4.83238720e+02
  4.83238720e+02  4.83238720e+02  5.62111096e+02  1.33507170e+03
  1.33507170e+03  1.33507170e+03  2.63357978e+03  3.02931285e+03
  3.02931285e+03  3.02931285e+03  6.64974787e+03  6.64974787e+03
  6.64974787e+03  9.04088403e+03  2.53975277e+04  7.61411296e+04]
E1 = -728.077373475808  E_coul = 201.50126998666263
Extra cycle  E= -526.576103489145  delta_E= -2.73e-12  |g|= 3.81e-07  |ddm|= 2.16e-06
    CPU time for scf_cycle      7.86 sec, wall time      0.57 sec
exp = [2.61826559e+04 7.61752191e+03 3.61735087e+03 1.59782559e+03
 3.82851122e+02 1.08121000e+02 3.48059173e+01 4.66423113e+00
 9.35282038e-01 3.89247950e-01 1.36278321e+03 6.64745673e+02
 3.00961955e+02 3.14042242e+02 6.16222270e+01 7.32835976e+00
 2.02394645e+01 7.75890520e-01 2.81082962e+00 2.24159317e-01]
E = -526.5761034891455
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:55:26 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558576        1
[INPUT] 0    0    [1    /1   ]  7617.52191047        1
[INPUT] 0    0    [1    /1   ]  3617.35086967        1
[INPUT] 0    0    [1    /1   ]  1597.82558518        1
[INPUT] 0    0    [1    /1   ]  382.851122252        1
[INPUT] 0    0    [1    /1   ]  108.121000312        1
[INPUT] 0    0    [1    /1   ]  34.8059172641        1
[INPUT] 0    0    [1    /1   ]  4.66423113305        1
[INPUT] 0    0    [1    /1   ]  0.935282037889       1
[INPUT] 0    0    [1    /1   ]  0.389247950256       1
[INPUT] 1    0    [1    /1   ]  1362.78320706        1
[INPUT] 1    0    [1    /1   ]  664.745673214        1
[INPUT] 1    0    [1    /1   ]  300.96195498         1
[INPUT] 1    0    [1    /1   ]  314.042242447        1
[INPUT] 1    0    [1    /1   ]  61.6222269998        1
[INPUT] 1    0    [1    /1   ]  7.32835976384        1
[INPUT] 1    0    [1    /1   ]  20.2394644883        1
[INPUT] 1    0    [1    /1   ]  0.775890520351       1
[INPUT] 1    0    [1    /1   ]  2.81082961979        1
[INPUT] 1    0    [1    /1   ]  0.224159316796       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.65585760349, 1.0]], [0, [7617.521910469578, 1.0]], [0, [3617.350869667695, 1.0]], [0, [1597.8255851819574, 1.0]], [0, [382.85112225215835, 1.0]], [0, [108.12100031156086, 1.0]], [0, [34.80591726410445, 1.0]], [0, [4.664231133050869, 1.0]], [0, [0.9352820378890832, 1.0]], [0, [0.3892479502559046, 1.0]], [1, [1362.7832070614706, 1.0]], [1, [664.7456732144304, 1.0]], [1, [300.9619549800276, 1.0]], [1, [314.04224244661134, 1.0]], [1, [61.62222699984345, 1.0]], [1, [7.328359763842388, 1.0]], [1, [20.239464488323357, 1.0]], [1, [0.7758905203508688, 1.0]], [1, [2.8108296197893976, 1.0]], [1, [0.22415931679600548, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.6558576]
bas 1, expnt(s) = [7617.52191047]
bas 2, expnt(s) = [3617.35086967]
bas 3, expnt(s) = [1597.82558518]
bas 4, expnt(s) = [382.85112225]
bas 5, expnt(s) = [108.12100031]
bas 6, expnt(s) = [34.80591726]
bas 7, expnt(s) = [4.66423113]
bas 8, expnt(s) = [0.93528204]
bas 9, expnt(s) = [0.38924795]
bas 10, expnt(s) = [1362.78320706]
bas 11, expnt(s) = [664.74567321]
bas 12, expnt(s) = [300.96195498]
bas 13, expnt(s) = [314.04224245]
bas 14, expnt(s) = [61.622227]
bas 15, expnt(s) = [7.32835976]
bas 16, expnt(s) = [20.23946449]
bas 17, expnt(s) = [0.77589052]
bas 18, expnt(s) = [2.81082962]
bas 19, expnt(s) = [0.22415932]
CPU time:        93.20
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752191e+03 2.06003836e+03
 3.61735087e+03 1.17844143e+03 1.59782559e+03 6.38501692e+02
 3.82851122e+02 2.18669125e+02 1.08121000e+02 8.47125130e+01
 3.48059173e+01 3.62038567e+01 4.66423113e+00 8.01862810e+00
 9.35282038e-01 2.40282405e+00 3.89247950e-01 1.24504422e+00
 1.36278321e+03 2.41556017e+04 6.64745673e+02 9.84699668e+03
 3.00961955e+02 3.65699100e+03 3.14042242e+02 3.85673216e+03
 6.16222270e+01 5.03681650e+02 7.32835976e+00 3.51757098e+01
 2.02394645e+01 1.25237147e+02 7.75890520e-01 2.12439343e+00
 2.81082962e+00 1.06176290e+01 2.24159317e-01 4.49966711e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.983158652466148
cond(S) = 100396.50030981765
E1 = -728.7014722566461  E_coul = 202.95447510444953
init E= -525.746997152197
    CPU time for initialize scf      7.56 sec, wall time      0.36 sec
  HOMO = -0.557397797067941  LUMO = 1.03644610943894
  mo_energy =
[-1.18349710e+02 -1.21593802e+01 -9.46749995e+00 -9.46749995e+00
 -9.46749995e+00 -1.22698369e+00 -5.57397797e-01 -5.57397797e-01
 -5.57397797e-01  1.03644611e+00  1.03644611e+00  1.03644611e+00
  2.16575568e+00  7.34704766e+00  7.34704766e+00  7.34704766e+00
  3.34985273e+01  3.34985273e+01  3.34985273e+01  7.89378229e+01
  1.29113018e+02  1.29113018e+02  1.29113018e+02  4.83508990e+02
  4.83508990e+02  4.83508990e+02  5.62427298e+02  1.33540697e+03
  1.33540697e+03  1.33540697e+03  2.63406075e+03  3.02971968e+03
  3.02971968e+03  3.02971968e+03  6.65027655e+03  6.65027655e+03
  6.65027655e+03  9.04149347e+03  2.53982361e+04  7.61419318e+04]
E1 = -727.687488001106  E_coul = 201.1121887382273
cycle= 1 E= -526.575299262879  delta_E= -0.828  |g|= 0.224  |ddm|= 0.415
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.626227
diis-c [-0.39215995  1.        ]
  HOMO = -0.578376940839761  LUMO = 1.02234115059215
  mo_energy =
[-1.18682331e+02 -1.22690035e+01 -9.59687289e+00 -9.59687289e+00
 -9.59687289e+00 -1.25495998e+00 -5.78376941e-01 -5.78376941e-01
 -5.78376941e-01  1.02234115e+00  1.02234115e+00  1.02234115e+00
  2.13127550e+00  7.27743270e+00  7.27743270e+00  7.27743270e+00
  3.33576104e+01  3.33576104e+01  3.33576104e+01  7.87367391e+01
  1.28880501e+02  1.28880501e+02  1.28880501e+02  4.83183317e+02
  4.83183317e+02  4.83183317e+02  5.62053346e+02  1.33501258e+03
  1.33501258e+03  1.33501258e+03  2.63351807e+03  3.02925188e+03
  3.02925188e+03  3.02925188e+03  6.64968574e+03  6.64968574e+03
  6.64968574e+03  9.04082143e+03  2.53974648e+04  7.61410668e+04]
E1 = -728.1860862671853  E_coul = 201.61002973734668
cycle= 2 E= -526.576056529839  delta_E= -0.000757  |g|= 0.0375  |ddm|= 0.063
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0732935
diis-c [-0.00264696  0.07718548  0.92281452]
  HOMO = -0.571559327923529  LUMO = 1.02739868920455
  mo_energy =
[-1.18617541e+02 -1.22360449e+01 -9.56238948e+00 -9.56238948e+00
 -9.56238948e+00 -1.24682765e+00 -5.71559328e-01 -5.71559328e-01
 -5.71559328e-01  1.02739869e+00  1.02739869e+00  1.02739869e+00
  2.14196749e+00  7.29668950e+00  7.29668950e+00  7.29668950e+00
  3.33927049e+01  3.33927049e+01  3.33927049e+01  7.87889599e+01
  1.28932509e+02  1.28932509e+02  1.28932509e+02  4.83247283e+02
  4.83247283e+02  4.83247283e+02  5.62120025e+02  1.33508081e+03
  1.33508081e+03  1.33508081e+03  2.63358952e+03  3.02932234e+03
  3.02932234e+03  3.02932234e+03  6.64975775e+03  6.64975775e+03
  6.64975775e+03  9.04089413e+03  2.53975380e+04  7.61411400e+04]
E1 = -728.0582327227767  E_coul = 201.48213064011927
cycle= 3 E= -526.576102082657  delta_E= -4.56e-05  |g|= 0.00534  |ddm|= 0.0156
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0112088
diis-c [-1.48163428e-06 -1.79900308e-03  1.23071779e-01  8.78727224e-01]
  HOMO = -0.572918397953534  LUMO = 1.02640074730349
  mo_energy =
[-1.18626455e+02 -1.22412634e+01 -9.56794112e+00 -9.56794112e+00
 -9.56794112e+00 -1.24848736e+00 -5.72918398e-01 -5.72918398e-01
 -5.72918398e-01  1.02640075e+00  1.02640075e+00  1.02640075e+00
  2.13990241e+00  7.29324521e+00  7.29324521e+00  7.29324521e+00
  3.33871429e+01  3.33871429e+01  3.33871429e+01  7.87816445e+01
  1.28925020e+02  1.28925020e+02  1.28925020e+02  4.83238481e+02
  4.83238481e+02  4.83238481e+02  5.62110862e+02  1.33507147e+03
  1.33507147e+03  1.33507147e+03  2.63357955e+03  3.02931262e+03
  3.02931262e+03  3.02931262e+03  6.64974765e+03  6.64974765e+03
  6.64974765e+03  9.04088381e+03  2.53975275e+04  7.61411294e+04]
E1 = -728.0781078618489  E_coul = 201.50200437508212
cycle= 4 E= -526.576103486767  delta_E= -1.4e-06  |g|= 0.000146  |ddm|= 0.00286
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000229493
diis-c [-1.37981653e-08 -5.70520546e-05  2.95700841e-04  2.12622140e-02
  9.78499137e-01]
  HOMO = -0.572844581743799  LUMO = 1.02645191720561
  mo_energy =
[-1.18626180e+02 -1.22410221e+01 -9.56769744e+00 -9.56769744e+00
 -9.56769744e+00 -1.24840580e+00 -5.72844582e-01 -5.72844582e-01
 -5.72844582e-01  1.02645192e+00  1.02645192e+00  1.02645192e+00
  2.13999986e+00  7.29341454e+00  7.29341454e+00  7.29341454e+00
  3.33873772e+01  3.33873772e+01  3.33873772e+01  7.87819109e+01
  1.28925283e+02  1.28925283e+02  1.28925283e+02  4.83238754e+02
  4.83238754e+02  4.83238754e+02  5.62111132e+02  1.33507174e+03
  1.33507174e+03  1.33507174e+03  2.63357981e+03  3.02931289e+03
  3.02931289e+03  3.02931289e+03  6.64974791e+03  6.64974791e+03
  6.64974791e+03  9.04088407e+03  2.53975277e+04  7.61411297e+04]
E1 = -728.0772807474211  E_coul = 201.50117725832197
cycle= 5 E= -526.576103489099  delta_E= -2.33e-09  |g|= 2.28e-05  |ddm|= 9.75e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.64284e-05
diis-c [-2.10220538e-11  2.26832362e-06 -2.02105916e-04 -3.83634951e-03
  3.73092709e-02  9.66726916e-01]
  HOMO = -0.572853174011519  LUMO = 1.02644548580088
  mo_energy =
[-1.18626217e+02 -1.22410501e+01 -9.56772626e+00 -9.56772626e+00
 -9.56772626e+00 -1.24841742e+00 -5.72853174e-01 -5.72853174e-01
 -5.72853174e-01  1.02644549e+00  1.02644549e+00  1.02644549e+00
  2.13998574e+00  7.29339462e+00  7.29339462e+00  7.29339462e+00
  3.33873489e+01  3.33873489e+01  3.33873489e+01  7.87818773e+01
  1.28925249e+02  1.28925249e+02  1.28925249e+02  4.83238718e+02
  4.83238718e+02  4.83238718e+02  5.62111094e+02  1.33507170e+03
  1.33507170e+03  1.33507170e+03  2.63357978e+03  3.02931285e+03
  3.02931285e+03  3.02931285e+03  6.64974787e+03  6.64974787e+03
  6.64974787e+03  9.04088403e+03  2.53975277e+04  7.61411296e+04]
E1 = -728.0773785325881  E_coul = 201.50127504344545
cycle= 6 E= -526.576103489143  delta_E= -4.35e-11  |g|= 1.56e-06  |ddm|= 2.5e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.0773785325881  E_coul = 201.50127504344545
  HOMO = -0.572852850063316  LUMO = 1.02644567274374
  mo_energy =
[-1.18626215e+02 -1.22410488e+01 -9.56772489e+00 -9.56772489e+00
 -9.56772489e+00 -1.24841728e+00 -5.72852850e-01 -5.72852850e-01
 -5.72852850e-01  1.02644567e+00  1.02644567e+00  1.02644567e+00
  2.13998589e+00  7.29339546e+00  7.29339546e+00  7.29339546e+00
  3.33873502e+01  3.33873502e+01  3.33873502e+01  7.87818788e+01
  1.28925251e+02  1.28925251e+02  1.28925251e+02  4.83238720e+02
  4.83238720e+02  4.83238720e+02  5.62111096e+02  1.33507170e+03
  1.33507170e+03  1.33507170e+03  2.63357978e+03  3.02931285e+03
  3.02931285e+03  3.02931285e+03  6.64974787e+03  6.64974787e+03
  6.64974787e+03  9.04088403e+03  2.53975277e+04  7.61411296e+04]
E1 = -728.077373475808  E_coul = 201.50126998666263
Extra cycle  E= -526.576103489145  delta_E= -2.73e-12  |g|= 3.81e-07  |ddm|= 2.16e-06
    CPU time for scf_cycle      7.77 sec, wall time      0.57 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 100396.50030981765
E1 = -728.077373475808  E_coul = 201.50126998666263
init E= -526.576103489145
    CPU time for initialize scf     15.86 sec, wall time      0.74 sec
  HOMO = -0.572852951438505  LUMO = 1.02644559120275
  mo_energy =
[-1.18626215e+02 -1.22410492e+01 -9.56772526e+00 -9.56772526e+00
 -9.56772526e+00 -1.24841744e+00 -5.72852951e-01 -5.72852951e-01
 -5.72852951e-01  1.02644559e+00  1.02644559e+00  1.02644559e+00
  2.13998569e+00  7.29339521e+00  7.29339521e+00  7.29339521e+00
  3.33873498e+01  3.33873498e+01  3.33873498e+01  7.87818783e+01
  1.28925251e+02  1.28925251e+02  1.28925251e+02  4.83238719e+02
  4.83238719e+02  4.83238719e+02  5.62111096e+02  1.33507170e+03
  1.33507170e+03  1.33507170e+03  2.63357978e+03  3.02931285e+03
  3.02931285e+03  3.02931285e+03  6.64974787e+03  6.64974787e+03
  6.64974787e+03  9.04088403e+03  2.53975277e+04  7.61411296e+04]
E1 = -728.0773747473897  E_coul = 201.50127125824628
cycle= 1 E= -526.576103489143  delta_E= 2.05e-12  |g|= 8.4e-08  |ddm|= 5.7e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.02 sec
E1 = -728.0773747473897  E_coul = 201.50127125824628
  HOMO = -0.57285292867741  LUMO = 1.02644560647178
  mo_energy =
[-1.18626215e+02 -1.22410491e+01 -9.56772516e+00 -9.56772516e+00
 -9.56772516e+00 -1.24841742e+00 -5.72852929e-01 -5.72852929e-01
 -5.72852929e-01  1.02644561e+00  1.02644561e+00  1.02644561e+00
  2.13998571e+00  7.29339527e+00  7.29339527e+00  7.29339527e+00
  3.33873499e+01  3.33873499e+01  3.33873499e+01  7.87818784e+01
  1.28925251e+02  1.28925251e+02  1.28925251e+02  4.83238719e+02
  4.83238719e+02  4.83238719e+02  5.62111096e+02  1.33507170e+03
  1.33507170e+03  1.33507170e+03  2.63357978e+03  3.02931285e+03
  3.02931285e+03  3.02931285e+03  6.64974787e+03  6.64974787e+03
  6.64974787e+03  9.04088403e+03  2.53975277e+04  7.61411296e+04]
E1 = -728.0773743834385  E_coul = 201.50127089429415
Extra cycle  E= -526.576103489144  delta_E= -9.09e-13  |g|= 2.31e-08  |ddm|= 5.8e-08
    CPU time for scf_cycle     15.97 sec, wall time      0.85 sec
exp = [2.61826559e+04 7.61752191e+03 3.61735087e+03 1.59782559e+03
 3.82851122e+02 1.08121000e+02 3.48059173e+01 4.66423113e+00
 9.35282038e-01 3.89247950e-01 1.36278321e+03 6.64745673e+02
 3.00961955e+02 3.14042242e+02 6.16222270e+01 7.32835976e+00
 2.02394645e+01 7.75890520e-01 2.81082962e+00 2.24159317e-01]
grad_E = [-1.51162044e-06  3.33487630e-06 -1.42033083e-06  7.03105000e-05
 -2.50156613e-05  5.52744970e-04 -2.85693144e-03 -1.79091478e-01
 -1.82121579e-02  2.17511651e-01 -5.08514276e-07  5.01961052e-06
  2.36715417e-05  2.04092359e-05 -1.62394254e-05  8.60333808e-05
 -5.03901343e-06 -2.72892552e-03 -3.30309753e-04  2.09474265e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:55:31 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558601        1
[INPUT] 0    0    [1    /1   ]  7617.52190492        1
[INPUT] 0    0    [1    /1   ]  3617.35087204        1
[INPUT] 0    0    [1    /1   ]  1597.82546837        1
[INPUT] 0    0    [1    /1   ]  382.851152462        1
[INPUT] 0    0    [1    /1   ]  108.120204838        1
[INPUT] 0    0    [1    /1   ]  34.8099712454        1
[INPUT] 0    0    [1    /1   ]  4.92794613923        1
[INPUT] 0    0    [1    /1   ]  0.977000802844       1
[INPUT] 0    0    [1    /1   ]  0.366126834258       1
[INPUT] 1    0    [1    /1   ]  1362.78320791        1
[INPUT] 1    0    [1    /1   ]  664.74566486         1
[INPUT] 1    0    [1    /1   ]  300.96191559         1
[INPUT] 1    0    [1    /1   ]  314.042208485        1
[INPUT] 1    0    [1    /1   ]  61.6222498831        1
[INPUT] 1    0    [1    /1   ]  7.32806520854        1
[INPUT] 1    0    [1    /1   ]  20.2395115854        1
[INPUT] 1    0    [1    /1   ]  0.774767700843       1
[INPUT] 1    0    [1    /1   ]  2.81143736599        1
[INPUT] 1    0    [1    /1   ]  0.224532981697       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.65586012077, 1.0]], [0, [7617.5219049221005, 1.0]], [0, [3617.3508720363857, 1.0]], [0, [1597.8254683699327, 1.0]], [0, [382.85115246246136, 1.0]], [0, [108.12020483799255, 1.0]], [0, [34.80997124538842, 1.0]], [0, [4.927946139225213, 1.0]], [0, [0.9770008028438639, 1.0]], [0, [0.3661268342582623, 1.0]], [1, [1362.7832079087043, 1.0]], [1, [664.7456648600295, 1.0]], [1, [300.9619155895273, 1.0]], [1, [314.04220848453684, 1.0]], [1, [61.62224988312352, 1.0]], [1, [7.328065208542084, 1.0]], [1, [20.239511585383095, 1.0]], [1, [0.7747677008430813, 1.0]], [1, [2.811437365990884, 1.0]], [1, [0.2245329816965658, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65586012]
bas 1, expnt(s) = [7617.52190492]
bas 2, expnt(s) = [3617.35087204]
bas 3, expnt(s) = [1597.82546837]
bas 4, expnt(s) = [382.85115246]
bas 5, expnt(s) = [108.12020484]
bas 6, expnt(s) = [34.80997125]
bas 7, expnt(s) = [4.92794614]
bas 8, expnt(s) = [0.9770008]
bas 9, expnt(s) = [0.36612683]
bas 10, expnt(s) = [1362.78320791]
bas 11, expnt(s) = [664.74566486]
bas 12, expnt(s) = [300.96191559]
bas 13, expnt(s) = [314.04220848]
bas 14, expnt(s) = [61.62224988]
bas 15, expnt(s) = [7.32806521]
bas 16, expnt(s) = [20.23951159]
bas 17, expnt(s) = [0.7747677]
bas 18, expnt(s) = [2.81143737]
bas 19, expnt(s) = [0.22453298]
CPU time:       121.88
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752190e+03 2.06003836e+03
 3.61735087e+03 1.17844143e+03 1.59782547e+03 6.38501657e+02
 3.82851152e+02 2.18669138e+02 1.08120205e+02 8.47120456e+01
 3.48099712e+01 3.62070192e+01 4.92794614e+00 8.35630895e+00
 9.77000803e-01 2.48276843e+00 3.66126834e-01 1.18915563e+00
 1.36278321e+03 2.41556017e+04 6.64745665e+02 9.84699653e+03
 3.00961916e+02 3.65699040e+03 3.14042208e+02 3.85673164e+03
 6.16222499e+01 5.03681884e+02 7.32806521e+00 3.51739425e+01
 2.02395116e+01 1.25237511e+02 7.74767701e-01 2.12055127e+00
 2.81143737e+00 1.06204987e+01 2.24532982e-01 4.50904503e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98568330401664
cond(S) = 100453.11163846038
E1 = -729.1487544077336  E_coul = 203.1313617061604
init E= -526.017392701573
    CPU time for initialize scf      3.21 sec, wall time      0.16 sec
  HOMO = -0.557385380800127  LUMO = 1.03775549541649
  mo_energy =
[-1.18326487e+02 -1.21630824e+01 -9.45002160e+00 -9.45002160e+00
 -9.45002160e+00 -1.22884126e+00 -5.57385381e-01 -5.57385381e-01
 -5.57385381e-01  1.03775550e+00  1.03775550e+00  1.03775550e+00
  2.21265022e+00  7.35170664e+00  7.35170664e+00  7.35170664e+00
  3.35132155e+01  3.35132155e+01  3.35132155e+01  8.02014720e+01
  1.29133342e+02  1.29133342e+02  1.29133342e+02  4.83533235e+02
  4.83533235e+02  4.83533235e+02  5.63515915e+02  1.33542976e+03
  1.33542976e+03  1.33542976e+03  2.63499317e+03  3.02974283e+03
  3.02974283e+03  3.02974283e+03  6.65029982e+03  6.65029982e+03
  6.65029982e+03  9.04234507e+03  2.53990418e+04  7.61426833e+04]
E1 = -727.7672843922206  E_coul = 201.15658867505846
cycle= 1 E= -526.610695717162  delta_E= -0.593  |g|= 0.205  |ddm|= 0.381
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.58219
diis-c [-0.33894483  1.        ]
  HOMO = -0.584127916241325  LUMO = 1.01975882021249
  mo_energy =
[-1.18651991e+02 -1.22884492e+01 -9.59119558e+00 -9.59119558e+00
 -9.59119558e+00 -1.26113010e+00 -5.84127916e-01 -5.84127916e-01
 -5.84127916e-01  1.01975882e+00  1.01975882e+00  1.01975882e+00
  2.17073456e+00  7.27144207e+00  7.27144207e+00  7.27144207e+00
  3.33636017e+01  3.33636017e+01  3.33636017e+01  7.99888491e+01
  1.28898874e+02  1.28898874e+02  1.28898874e+02  4.83212688e+02
  4.83212688e+02  4.83212688e+02  5.63152052e+02  1.33504693e+03
  1.33504693e+03  1.33504693e+03  2.63446954e+03  3.02929058e+03
  3.02929058e+03  3.02929058e+03  6.64972995e+03  6.64972995e+03
  6.64972995e+03  9.04169711e+03  2.53982975e+04  7.61418474e+04]
E1 = -728.3034177800973  E_coul = 201.69199242995083
cycle= 2 E= -526.611425350147  delta_E= -0.00073  |g|= 0.0376  |ddm|= 0.0544
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0732031
diis-c [-0.00281124  0.08008394  0.91991606]
  HOMO = -0.576217751679473  LUMO = 1.02563911489971
  mo_energy =
[-1.18585722e+02 -1.22528727e+01 -9.55415154e+00 -9.55415154e+00
 -9.55415154e+00 -1.25149084e+00 -5.76217752e-01 -5.76217752e-01
 -5.76217752e-01  1.02563911e+00  1.02563911e+00  1.02563911e+00
  2.18371781e+00  7.29288902e+00  7.29288902e+00  7.29288902e+00
  3.34011392e+01  3.34011392e+01  3.34011392e+01  8.00428390e+01
  1.28952844e+02  1.28952844e+02  1.28952844e+02  4.83278133e+02
  4.83278133e+02  4.83278133e+02  5.63220116e+02  1.33511651e+03
  1.33511651e+03  1.33511651e+03  2.63454229e+03  3.02936233e+03
  3.02936233e+03  3.02936233e+03  6.64980326e+03  6.64980326e+03
  6.64980326e+03  9.04177112e+03  2.53983720e+04  7.61419220e+04]
E1 = -728.1659954321321  E_coul = 201.55451834667454
cycle= 3 E= -526.611477085458  delta_E= -5.17e-05  |g|= 0.00568  |ddm|= 0.0176
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.011972
diis-c [-1.16234879e-06 -1.58475554e-03  1.33275903e-01  8.68308853e-01]
  HOMO = -0.577607634242793  LUMO = 1.02463086130884
  mo_energy =
[-1.18594993e+02 -1.22582977e+01 -9.55992931e+00 -9.55992931e+00
 -9.55992931e+00 -1.25310269e+00 -5.77607634e-01 -5.77607634e-01
 -5.77607634e-01  1.02463086e+00  1.02463086e+00  1.02463086e+00
  2.18162325e+00  7.28933879e+00  7.28933879e+00  7.28933879e+00
  3.33953608e+01  3.33953608e+01  3.33953608e+01  8.00352127e+01
  1.28945053e+02  1.28945053e+02  1.28945053e+02  4.83268977e+02
  4.83268977e+02  4.83268977e+02  5.63210594e+02  1.33510679e+03
  1.33510679e+03  1.33510679e+03  2.63453194e+03  3.02935224e+03
  3.02935224e+03  3.02935224e+03  6.64979278e+03  6.64979278e+03
  6.64979278e+03  9.04176042e+03  2.53983611e+04  7.61419110e+04]
E1 = -728.1869871857322  E_coul = 201.5755084912195
cycle= 4 E= -526.611478694513  delta_E= -1.61e-06  |g|= 0.00011  |ddm|= 0.00242
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=8.97027e-05
diis-c [-6.78992168e-09 -2.43369279e-06 -2.55380472e-03 -1.31693803e-02
  1.01572562e+00]
  HOMO = -0.577556002596491  LUMO = 1.02466912597718
  mo_energy =
[-1.18594833e+02 -1.22581356e+01 -9.55977607e+00 -9.55977607e+00
 -9.55977607e+00 -1.25303048e+00 -5.77556003e-01 -5.77556003e-01
 -5.77556003e-01  1.02466913e+00  1.02466913e+00  1.02466913e+00
  2.18171344e+00  7.28945190e+00  7.28945190e+00  7.28945190e+00
  3.33955092e+01  3.33955092e+01  3.33955092e+01  8.00353817e+01
  1.28945213e+02  1.28945213e+02  1.28945213e+02  4.83269137e+02
  4.83269137e+02  4.83269137e+02  5.63210747e+02  1.33510694e+03
  1.33510694e+03  1.33510694e+03  2.63453208e+03  3.02935238e+03
  3.02935238e+03  3.02935238e+03  6.64979291e+03  6.64979291e+03
  6.64979291e+03  9.04176054e+03  2.53983612e+04  7.61419111e+04]
E1 = -728.1864825540412  E_coul = 201.57500385830411
cycle= 5 E= -526.611478695737  delta_E= -1.22e-09  |g|= 2.46e-05  |ddm|= 0.000147
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.00577e-05
diis-c [-2.93336317e-11  7.73529189e-06 -8.61124916e-04 -9.19539679e-03
  6.78487692e-02  9.42200017e-01]
  HOMO = -0.577563884110388  LUMO = 1.02466370119915
  mo_energy =
[-1.18594870e+02 -1.22581625e+01 -9.55980511e+00 -9.55980511e+00
 -9.55980511e+00 -1.25303816e+00 -5.77563884e-01 -5.77563884e-01
 -5.77563884e-01  1.02466370e+00  1.02466370e+00  1.02466370e+00
  2.18170383e+00  7.28943284e+00  7.28943284e+00  7.28943284e+00
  3.33954809e+01  3.33954809e+01  3.33954809e+01  8.00353487e+01
  1.28945179e+02  1.28945179e+02  1.28945179e+02  4.83269100e+02
  4.83269100e+02  4.83269100e+02  5.63210708e+02  1.33510690e+03
  1.33510690e+03  1.33510690e+03  2.63453203e+03  3.02935234e+03
  3.02935234e+03  3.02935234e+03  6.64979287e+03  6.64979287e+03
  6.64979287e+03  9.04176049e+03  2.53983612e+04  7.61419111e+04]
E1 = -728.1865854745873  E_coul = 201.57510677879486
cycle= 6 E= -526.611478695792  delta_E= -5.54e-11  |g|= 1.79e-06  |ddm|= 1.29e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.1865854745873  E_coul = 201.57510677879486
  HOMO = -0.577564176105147  LUMO = 1.0246635350311
  mo_energy =
[-1.18594872e+02 -1.22581636e+01 -9.55980644e+00 -9.55980644e+00
 -9.55980644e+00 -1.25303821e+00 -5.77564176e-01 -5.77564176e-01
 -5.77564176e-01  1.02466354e+00  1.02466354e+00  1.02466354e+00
  2.18170377e+00  7.28943206e+00  7.28943206e+00  7.28943206e+00
  3.33954797e+01  3.33954797e+01  3.33954797e+01  8.00353472e+01
  1.28945178e+02  1.28945178e+02  1.28945178e+02  4.83269098e+02
  4.83269098e+02  4.83269098e+02  5.63210707e+02  1.33510690e+03
  1.33510690e+03  1.33510690e+03  2.63453203e+03  3.02935234e+03
  3.02935234e+03  3.02935234e+03  6.64979286e+03  6.64979286e+03
  6.64979286e+03  9.04176049e+03  2.53983612e+04  7.61419111e+04]
E1 = -728.1865904632843  E_coul = 201.5751117674909
Extra cycle  E= -526.611478695793  delta_E= -1.02e-12  |g|= 4.11e-07  |ddm|= 2.28e-06
    CPU time for scf_cycle      3.44 sec, wall time      0.37 sec
exp = [2.61826559e+04 7.61752190e+03 3.61735087e+03 1.59782547e+03
 3.82851152e+02 1.08120205e+02 3.48099712e+01 4.92794614e+00
 9.77000803e-01 3.66126834e-01 1.36278321e+03 6.64745665e+02
 3.00961916e+02 3.14042208e+02 6.16222499e+01 7.32806521e+00
 2.02395116e+01 7.74767701e-01 2.81143737e+00 2.24532982e-01]
E = -526.6114786957935
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:55:32 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558601        1
[INPUT] 0    0    [1    /1   ]  7617.52190492        1
[INPUT] 0    0    [1    /1   ]  3617.35087204        1
[INPUT] 0    0    [1    /1   ]  1597.82546837        1
[INPUT] 0    0    [1    /1   ]  382.851152462        1
[INPUT] 0    0    [1    /1   ]  108.120204838        1
[INPUT] 0    0    [1    /1   ]  34.8099712454        1
[INPUT] 0    0    [1    /1   ]  4.92794613923        1
[INPUT] 0    0    [1    /1   ]  0.977000802844       1
[INPUT] 0    0    [1    /1   ]  0.366126834258       1
[INPUT] 1    0    [1    /1   ]  1362.78320791        1
[INPUT] 1    0    [1    /1   ]  664.74566486         1
[INPUT] 1    0    [1    /1   ]  300.96191559         1
[INPUT] 1    0    [1    /1   ]  314.042208485        1
[INPUT] 1    0    [1    /1   ]  61.6222498831        1
[INPUT] 1    0    [1    /1   ]  7.32806520854        1
[INPUT] 1    0    [1    /1   ]  20.2395115854        1
[INPUT] 1    0    [1    /1   ]  0.774767700843       1
[INPUT] 1    0    [1    /1   ]  2.81143736599        1
[INPUT] 1    0    [1    /1   ]  0.224532981697       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.65586012077, 1.0]], [0, [7617.5219049221005, 1.0]], [0, [3617.3508720363857, 1.0]], [0, [1597.8254683699327, 1.0]], [0, [382.85115246246136, 1.0]], [0, [108.12020483799255, 1.0]], [0, [34.80997124538842, 1.0]], [0, [4.927946139225213, 1.0]], [0, [0.9770008028438639, 1.0]], [0, [0.3661268342582623, 1.0]], [1, [1362.7832079087043, 1.0]], [1, [664.7456648600295, 1.0]], [1, [300.9619155895273, 1.0]], [1, [314.04220848453684, 1.0]], [1, [61.62224988312352, 1.0]], [1, [7.328065208542084, 1.0]], [1, [20.239511585383095, 1.0]], [1, [0.7747677008430813, 1.0]], [1, [2.811437365990884, 1.0]], [1, [0.2245329816965658, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65586012]
bas 1, expnt(s) = [7617.52190492]
bas 2, expnt(s) = [3617.35087204]
bas 3, expnt(s) = [1597.82546837]
bas 4, expnt(s) = [382.85115246]
bas 5, expnt(s) = [108.12020484]
bas 6, expnt(s) = [34.80997125]
bas 7, expnt(s) = [4.92794614]
bas 8, expnt(s) = [0.9770008]
bas 9, expnt(s) = [0.36612683]
bas 10, expnt(s) = [1362.78320791]
bas 11, expnt(s) = [664.74566486]
bas 12, expnt(s) = [300.96191559]
bas 13, expnt(s) = [314.04220848]
bas 14, expnt(s) = [61.62224988]
bas 15, expnt(s) = [7.32806521]
bas 16, expnt(s) = [20.23951159]
bas 17, expnt(s) = [0.7747677]
bas 18, expnt(s) = [2.81143737]
bas 19, expnt(s) = [0.22453298]
CPU time:       125.38
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752190e+03 2.06003836e+03
 3.61735087e+03 1.17844143e+03 1.59782547e+03 6.38501657e+02
 3.82851152e+02 2.18669138e+02 1.08120205e+02 8.47120456e+01
 3.48099712e+01 3.62070192e+01 4.92794614e+00 8.35630895e+00
 9.77000803e-01 2.48276843e+00 3.66126834e-01 1.18915563e+00
 1.36278321e+03 2.41556017e+04 6.64745665e+02 9.84699653e+03
 3.00961916e+02 3.65699040e+03 3.14042208e+02 3.85673164e+03
 6.16222499e+01 5.03681884e+02 7.32806521e+00 3.51739425e+01
 2.02395116e+01 1.25237511e+02 7.74767701e-01 2.12055127e+00
 2.81143737e+00 1.06204987e+01 2.24532982e-01 4.50904503e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98568330401664
cond(S) = 100453.11163846038
E1 = -729.1487544077336  E_coul = 203.1313617061604
init E= -526.017392701573
    CPU time for initialize scf      7.48 sec, wall time      0.35 sec
  HOMO = -0.557385380800127  LUMO = 1.03775549541649
  mo_energy =
[-1.18326487e+02 -1.21630824e+01 -9.45002160e+00 -9.45002160e+00
 -9.45002160e+00 -1.22884126e+00 -5.57385381e-01 -5.57385381e-01
 -5.57385381e-01  1.03775550e+00  1.03775550e+00  1.03775550e+00
  2.21265022e+00  7.35170664e+00  7.35170664e+00  7.35170664e+00
  3.35132155e+01  3.35132155e+01  3.35132155e+01  8.02014720e+01
  1.29133342e+02  1.29133342e+02  1.29133342e+02  4.83533235e+02
  4.83533235e+02  4.83533235e+02  5.63515915e+02  1.33542976e+03
  1.33542976e+03  1.33542976e+03  2.63499317e+03  3.02974283e+03
  3.02974283e+03  3.02974283e+03  6.65029982e+03  6.65029982e+03
  6.65029982e+03  9.04234507e+03  2.53990418e+04  7.61426833e+04]
E1 = -727.7672843922206  E_coul = 201.15658867505846
cycle= 1 E= -526.610695717162  delta_E= -0.593  |g|= 0.205  |ddm|= 0.381
    CPU time for cycle= 1      0.06 sec, wall time      0.03 sec
diis-norm(errvec)=0.58219
diis-c [-0.33894483  1.        ]
  HOMO = -0.584127916241325  LUMO = 1.01975882021249
  mo_energy =
[-1.18651991e+02 -1.22884492e+01 -9.59119558e+00 -9.59119558e+00
 -9.59119558e+00 -1.26113010e+00 -5.84127916e-01 -5.84127916e-01
 -5.84127916e-01  1.01975882e+00  1.01975882e+00  1.01975882e+00
  2.17073456e+00  7.27144207e+00  7.27144207e+00  7.27144207e+00
  3.33636017e+01  3.33636017e+01  3.33636017e+01  7.99888491e+01
  1.28898874e+02  1.28898874e+02  1.28898874e+02  4.83212688e+02
  4.83212688e+02  4.83212688e+02  5.63152052e+02  1.33504693e+03
  1.33504693e+03  1.33504693e+03  2.63446954e+03  3.02929058e+03
  3.02929058e+03  3.02929058e+03  6.64972995e+03  6.64972995e+03
  6.64972995e+03  9.04169711e+03  2.53982975e+04  7.61418474e+04]
E1 = -728.3034177800973  E_coul = 201.69199242995083
cycle= 2 E= -526.611425350147  delta_E= -0.00073  |g|= 0.0376  |ddm|= 0.0544
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0732031
diis-c [-0.00281124  0.08008394  0.91991606]
  HOMO = -0.576217751679473  LUMO = 1.02563911489971
  mo_energy =
[-1.18585722e+02 -1.22528727e+01 -9.55415154e+00 -9.55415154e+00
 -9.55415154e+00 -1.25149084e+00 -5.76217752e-01 -5.76217752e-01
 -5.76217752e-01  1.02563911e+00  1.02563911e+00  1.02563911e+00
  2.18371781e+00  7.29288902e+00  7.29288902e+00  7.29288902e+00
  3.34011392e+01  3.34011392e+01  3.34011392e+01  8.00428390e+01
  1.28952844e+02  1.28952844e+02  1.28952844e+02  4.83278133e+02
  4.83278133e+02  4.83278133e+02  5.63220116e+02  1.33511651e+03
  1.33511651e+03  1.33511651e+03  2.63454229e+03  3.02936233e+03
  3.02936233e+03  3.02936233e+03  6.64980326e+03  6.64980326e+03
  6.64980326e+03  9.04177112e+03  2.53983720e+04  7.61419220e+04]
E1 = -728.1659954321321  E_coul = 201.55451834667454
cycle= 3 E= -526.611477085458  delta_E= -5.17e-05  |g|= 0.00568  |ddm|= 0.0176
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.011972
diis-c [-1.16234879e-06 -1.58475554e-03  1.33275903e-01  8.68308853e-01]
  HOMO = -0.577607634242793  LUMO = 1.02463086130884
  mo_energy =
[-1.18594993e+02 -1.22582977e+01 -9.55992931e+00 -9.55992931e+00
 -9.55992931e+00 -1.25310269e+00 -5.77607634e-01 -5.77607634e-01
 -5.77607634e-01  1.02463086e+00  1.02463086e+00  1.02463086e+00
  2.18162325e+00  7.28933879e+00  7.28933879e+00  7.28933879e+00
  3.33953608e+01  3.33953608e+01  3.33953608e+01  8.00352127e+01
  1.28945053e+02  1.28945053e+02  1.28945053e+02  4.83268977e+02
  4.83268977e+02  4.83268977e+02  5.63210594e+02  1.33510679e+03
  1.33510679e+03  1.33510679e+03  2.63453194e+03  3.02935224e+03
  3.02935224e+03  3.02935224e+03  6.64979278e+03  6.64979278e+03
  6.64979278e+03  9.04176042e+03  2.53983611e+04  7.61419110e+04]
E1 = -728.1869871857322  E_coul = 201.5755084912195
cycle= 4 E= -526.611478694513  delta_E= -1.61e-06  |g|= 0.00011  |ddm|= 0.00242
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=8.97027e-05
diis-c [-6.78992168e-09 -2.43369279e-06 -2.55380472e-03 -1.31693803e-02
  1.01572562e+00]
  HOMO = -0.577556002596491  LUMO = 1.02466912597718
  mo_energy =
[-1.18594833e+02 -1.22581356e+01 -9.55977607e+00 -9.55977607e+00
 -9.55977607e+00 -1.25303048e+00 -5.77556003e-01 -5.77556003e-01
 -5.77556003e-01  1.02466913e+00  1.02466913e+00  1.02466913e+00
  2.18171344e+00  7.28945190e+00  7.28945190e+00  7.28945190e+00
  3.33955092e+01  3.33955092e+01  3.33955092e+01  8.00353817e+01
  1.28945213e+02  1.28945213e+02  1.28945213e+02  4.83269137e+02
  4.83269137e+02  4.83269137e+02  5.63210747e+02  1.33510694e+03
  1.33510694e+03  1.33510694e+03  2.63453208e+03  3.02935238e+03
  3.02935238e+03  3.02935238e+03  6.64979291e+03  6.64979291e+03
  6.64979291e+03  9.04176054e+03  2.53983612e+04  7.61419111e+04]
E1 = -728.1864825540412  E_coul = 201.57500385830411
cycle= 5 E= -526.611478695737  delta_E= -1.22e-09  |g|= 2.46e-05  |ddm|= 0.000147
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.00577e-05
diis-c [-2.93336317e-11  7.73529189e-06 -8.61124916e-04 -9.19539679e-03
  6.78487692e-02  9.42200017e-01]
  HOMO = -0.577563884110388  LUMO = 1.02466370119915
  mo_energy =
[-1.18594870e+02 -1.22581625e+01 -9.55980511e+00 -9.55980511e+00
 -9.55980511e+00 -1.25303816e+00 -5.77563884e-01 -5.77563884e-01
 -5.77563884e-01  1.02466370e+00  1.02466370e+00  1.02466370e+00
  2.18170383e+00  7.28943284e+00  7.28943284e+00  7.28943284e+00
  3.33954809e+01  3.33954809e+01  3.33954809e+01  8.00353487e+01
  1.28945179e+02  1.28945179e+02  1.28945179e+02  4.83269100e+02
  4.83269100e+02  4.83269100e+02  5.63210708e+02  1.33510690e+03
  1.33510690e+03  1.33510690e+03  2.63453203e+03  3.02935234e+03
  3.02935234e+03  3.02935234e+03  6.64979287e+03  6.64979287e+03
  6.64979287e+03  9.04176049e+03  2.53983612e+04  7.61419111e+04]
E1 = -728.1865854745873  E_coul = 201.57510677879486
cycle= 6 E= -526.611478695792  delta_E= -5.54e-11  |g|= 1.79e-06  |ddm|= 1.29e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.1865854745873  E_coul = 201.57510677879486
  HOMO = -0.577564176105147  LUMO = 1.0246635350311
  mo_energy =
[-1.18594872e+02 -1.22581636e+01 -9.55980644e+00 -9.55980644e+00
 -9.55980644e+00 -1.25303821e+00 -5.77564176e-01 -5.77564176e-01
 -5.77564176e-01  1.02466354e+00  1.02466354e+00  1.02466354e+00
  2.18170377e+00  7.28943206e+00  7.28943206e+00  7.28943206e+00
  3.33954797e+01  3.33954797e+01  3.33954797e+01  8.00353472e+01
  1.28945178e+02  1.28945178e+02  1.28945178e+02  4.83269098e+02
  4.83269098e+02  4.83269098e+02  5.63210707e+02  1.33510690e+03
  1.33510690e+03  1.33510690e+03  2.63453203e+03  3.02935234e+03
  3.02935234e+03  3.02935234e+03  6.64979286e+03  6.64979286e+03
  6.64979286e+03  9.04176049e+03  2.53983612e+04  7.61419111e+04]
E1 = -728.1865904632843  E_coul = 201.5751117674909
Extra cycle  E= -526.611478695793  delta_E= -1.02e-12  |g|= 4.11e-07  |ddm|= 2.28e-06
    CPU time for scf_cycle      7.72 sec, wall time      0.55 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 100453.11163846038
E1 = -728.1865904632843  E_coul = 201.5751117674909
init E= -526.611478695793
    CPU time for initialize scf     14.49 sec, wall time      0.69 sec
  HOMO = -0.577564075579337  LUMO = 1.0246636161532
  mo_energy =
[-1.18594872e+02 -1.22581632e+01 -9.55980608e+00 -9.55980608e+00
 -9.55980608e+00 -1.25303804e+00 -5.77564076e-01 -5.77564076e-01
 -5.77564076e-01  1.02466362e+00  1.02466362e+00  1.02466362e+00
  2.18170399e+00  7.28943230e+00  7.28943230e+00  7.28943230e+00
  3.33954800e+01  3.33954800e+01  3.33954800e+01  8.00353477e+01
  1.28945178e+02  1.28945178e+02  1.28945178e+02  4.83269099e+02
  4.83269099e+02  4.83269099e+02  5.63210707e+02  1.33510690e+03
  1.33510690e+03  1.33510690e+03  2.63453203e+03  3.02935234e+03
  3.02935234e+03  3.02935234e+03  6.64979286e+03  6.64979286e+03
  6.64979286e+03  9.04176049e+03  2.53983612e+04  7.61419111e+04]
E1 = -728.1865892141882  E_coul = 201.57511051839657
cycle= 1 E= -526.611478695792  delta_E= 1.82e-12  |g|= 8.75e-08  |ddm|= 5.55e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.1865892141882  E_coul = 201.57511051839657
  HOMO = -0.577564097606354  LUMO = 1.02466360145431
  mo_energy =
[-1.18594872e+02 -1.22581633e+01 -9.55980618e+00 -9.55980618e+00
 -9.55980618e+00 -1.25303805e+00 -5.77564098e-01 -5.77564098e-01
 -5.77564098e-01  1.02466360e+00  1.02466360e+00  1.02466360e+00
  2.18170396e+00  7.28943224e+00  7.28943224e+00  7.28943224e+00
  3.33954799e+01  3.33954799e+01  3.33954799e+01  8.00353476e+01
  1.28945178e+02  1.28945178e+02  1.28945178e+02  4.83269099e+02
  4.83269099e+02  4.83269099e+02  5.63210707e+02  1.33510690e+03
  1.33510690e+03  1.33510690e+03  2.63453203e+03  3.02935234e+03
  3.02935234e+03  3.02935234e+03  6.64979286e+03  6.64979286e+03
  6.64979286e+03  9.04176049e+03  2.53983612e+04  7.61419111e+04]
E1 = -728.1865895801595  E_coul = 201.5751108843666
Extra cycle  E= -526.611478695793  delta_E= -1.25e-12  |g|= 2.38e-08  |ddm|= 6.23e-08
    CPU time for scf_cycle     14.81 sec, wall time      1.01 sec
exp = [2.61826559e+04 7.61752190e+03 3.61735087e+03 1.59782547e+03
 3.82851152e+02 1.08120205e+02 3.48099712e+01 4.92794614e+00
 9.77000803e-01 3.66126834e-01 1.36278321e+03 6.64745665e+02
 3.00961916e+02 3.14042208e+02 6.16222499e+01 7.32806521e+00
 2.02395116e+01 7.74767701e-01 2.81143737e+00 2.24532982e-01]
grad_E = [-1.51282388e-06  3.31060811e-06 -1.48113181e-06  6.93289407e-05
 -2.71663124e-06  2.67223229e-05 -1.73768104e-03 -5.82430101e-02
 -5.51511718e-02  3.18737610e-02 -5.06791231e-07  5.02347631e-06
  2.37057696e-05  2.04386630e-05 -2.42176620e-05 -1.49319969e-04
  6.77613429e-05 -7.09670110e-03  2.92509449e-04  2.70082524e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:55:37 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558639        1
[INPUT] 0    0    [1    /1   ]  7617.52189674        1
[INPUT] 0    0    [1    /1   ]  3617.35087564        1
[INPUT] 0    0    [1    /1   ]  1597.82529666        1
[INPUT] 0    0    [1    /1   ]  382.85116954         1
[INPUT] 0    0    [1    /1   ]  108.119761792        1
[INPUT] 0    0    [1    /1   ]  34.8146616157        1
[INPUT] 0    0    [1    /1   ]  5.15329539645        1
[INPUT] 0    0    [1    /1   ]  1.10167823567        1
[INPUT] 0    0    [1    /1   ]  0.3889566658         1
[INPUT] 1    0    [1    /1   ]  1362.78320916        1
[INPUT] 1    0    [1    /1   ]  664.745652473        1
[INPUT] 1    0    [1    /1   ]  300.961857155        1
[INPUT] 1    0    [1    /1   ]  314.042158103        1
[INPUT] 1    0    [1    /1   ]  61.6222999935        1
[INPUT] 1    0    [1    /1   ]  7.32819063841        1
[INPUT] 1    0    [1    /1   ]  20.239431012         1
[INPUT] 1    0    [1    /1   ]  0.77505562907        1
[INPUT] 1    0    [1    /1   ]  2.81134782214        1
[INPUT] 1    0    [1    /1   ]  0.223285470777       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.655863851975, 1.0]], [0, [7617.52189673726, 1.0]], [0, [3617.3508756368888, 1.0]], [0, [1597.825296660999, 1.0]], [0, [382.85116953965223, 1.0]], [0, [108.1197617923309, 1.0]], [0, [34.814661615721185, 1.0]], [0, [5.153295396446576, 1.0]], [0, [1.1016782356711654, 1.0]], [0, [0.38895666579973215, 1.0]], [1, [1362.7832091609384, 1.0]], [1, [664.7456524730211, 1.0]], [1, [300.96185715466294, 1.0]], [1, [314.0421581030048, 1.0]], [1, [61.622299993459436, 1.0]], [1, [7.328190638407828, 1.0]], [1, [20.23943101201132, 1.0]], [1, [0.7750556290696972, 1.0]], [1, [2.8113478221390613, 1.0]], [1, [0.22328547077659885, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65586385]
bas 1, expnt(s) = [7617.52189674]
bas 2, expnt(s) = [3617.35087564]
bas 3, expnt(s) = [1597.82529666]
bas 4, expnt(s) = [382.85116954]
bas 5, expnt(s) = [108.11976179]
bas 6, expnt(s) = [34.81466162]
bas 7, expnt(s) = [5.1532954]
bas 8, expnt(s) = [1.10167824]
bas 9, expnt(s) = [0.38895667]
bas 10, expnt(s) = [1362.78320916]
bas 11, expnt(s) = [664.74565247]
bas 12, expnt(s) = [300.96185715]
bas 13, expnt(s) = [314.0421581]
bas 14, expnt(s) = [61.62229999]
bas 15, expnt(s) = [7.32819064]
bas 16, expnt(s) = [20.23943101]
bas 17, expnt(s) = [0.77505563]
bas 18, expnt(s) = [2.81134782]
bas 19, expnt(s) = [0.22328547]
CPU time:       152.83
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752190e+03 2.06003836e+03
 3.61735088e+03 1.17844143e+03 1.59782530e+03 6.38501606e+02
 3.82851170e+02 2.18669145e+02 1.08119762e+02 8.47117853e+01
 3.48146616e+01 3.62106781e+01 5.15329540e+00 8.64129442e+00
 1.10167824e+00 2.71679020e+00 3.88956666e-01 1.24434538e+00
 1.36278321e+03 2.41556017e+04 6.64745652e+02 9.84699630e+03
 3.00961857e+02 3.65698952e+03 3.14042158e+02 3.85673087e+03
 6.16223000e+01 5.03682396e+02 7.32819064e+00 3.51746950e+01
 2.02394310e+01 1.25236888e+02 7.75055629e-01 2.12153639e+00
 2.81134782e+00 1.06200758e+01 2.23285471e-01 4.47775135e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98343917978958
cond(S) = 100584.89535592412
E1 = -729.2886512786503  E_coul = 203.1765536184032
init E= -526.112097660247
    CPU time for initialize scf      7.31 sec, wall time      0.34 sec
  HOMO = -0.556986671375536  LUMO = 1.03300370197908
  mo_energy =
[-1.18320724e+02 -1.21700679e+01 -9.44589896e+00 -9.44589896e+00
 -9.44589896e+00 -1.22578788e+00 -5.56986671e-01 -5.56986671e-01
 -5.56986671e-01  1.03300370e+00  1.03300370e+00  1.03300370e+00
  2.63241832e+00  7.34881422e+00  7.34881422e+00  7.34881422e+00
  3.35149011e+01  3.35149011e+01  3.35149011e+01  8.18320093e+01
  1.29136939e+02  1.29136939e+02  1.29136939e+02  4.83539018e+02
  4.83539018e+02  4.83539018e+02  5.64875774e+02  1.33543494e+03
  1.33543494e+03  1.33543494e+03  2.63615024e+03  3.02974815e+03
  3.02974815e+03  3.02974815e+03  6.65030521e+03  6.65030521e+03
  6.65030521e+03  9.04339910e+03  2.54000375e+04  7.61436106e+04]
E1 = -727.9198008154221  E_coul = 201.2947382258178
cycle= 1 E= -526.625062589604  delta_E= -0.513  |g|= 0.194  |ddm|= 0.344
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.557606
diis-c [-0.31092411  1.        ]
  HOMO = -0.58204805704204  LUMO = 1.01643017801117
  mo_energy =
[-1.18628738e+02 -1.22912705e+01 -9.58061429e+00 -9.58061429e+00
 -9.58061429e+00 -1.25759545e+00 -5.82048057e-01 -5.82048057e-01
 -5.82048057e-01  1.01643018e+00  1.01643018e+00  1.01643018e+00
  2.58657684e+00  7.27207301e+00  7.27207301e+00  7.27207301e+00
  3.33728105e+01  3.33728105e+01  3.33728105e+01  8.16270196e+01
  1.28914754e+02  1.28914754e+02  1.28914754e+02  4.83234809e+02
  4.83234809e+02  4.83234809e+02  5.64530761e+02  1.33507169e+03
  1.33507169e+03  1.33507169e+03  2.63564995e+03  3.02931749e+03
  3.02931749e+03  3.02931749e+03  6.64975962e+03  6.64975962e+03
  6.64975962e+03  9.04277698e+03  2.53993206e+04  7.61428030e+04]
E1 = -728.4250870553678  E_coul = 201.79938763801562
cycle= 2 E= -526.625699417352  delta_E= -0.000637  |g|= 0.0355  |ddm|= 0.0526
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0700584
diis-c [-0.00274223  0.07734958  0.92265042]
  HOMO = -0.574625699005041  LUMO = 1.02193912872471
  mo_energy =
[-1.18565996e+02 -1.22576504e+01 -9.54554608e+00 -9.54554608e+00
 -9.54554608e+00 -1.24854610e+00 -5.74625699e-01 -5.74625699e-01
 -5.74625699e-01  1.02193913e+00  1.02193913e+00  1.02193913e+00
  2.60010252e+00  7.29232636e+00  7.29232636e+00  7.29232636e+00
  3.34083494e+01  3.34083494e+01  3.34083494e+01  8.16779748e+01
  1.28965838e+02  1.28965838e+02  1.28965838e+02  4.83296760e+02
  4.83296760e+02  4.83296760e+02  5.64595222e+02  1.33513760e+03
  1.33513760e+03  1.33513760e+03  2.63571900e+03  3.02938553e+03
  3.02938553e+03  3.02938553e+03  6.64982923e+03  6.64982923e+03
  6.64982923e+03  9.04284732e+03  2.53993914e+04  7.61428740e+04]
E1 = -728.2950875506511  E_coul = 201.6693420781468
cycle= 3 E= -526.625745472504  delta_E= -4.61e-05  |g|= 0.00557  |ddm|= 0.0158
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0116498
diis-c [-8.05891808e-07 -1.41079681e-03  1.36484268e-01  8.64926528e-01]
  HOMO = -0.575941235899886  LUMO = 1.0209791147561
  mo_energy =
[-1.18574990e+02 -1.22628682e+01 -9.55109224e+00 -9.55109224e+00
 -9.55109224e+00 -1.25010565e+00 -5.75941236e-01 -5.75941236e-01
 -5.75941236e-01  1.02097911e+00  1.02097911e+00  1.02097911e+00
  2.59786002e+00  7.28893645e+00  7.28893645e+00  7.28893645e+00
  3.34027936e+01  3.34027936e+01  3.34027936e+01  8.16705769e+01
  1.28958301e+02  1.28958301e+02  1.28958301e+02  4.83287877e+02
  4.83287877e+02  4.83287877e+02  5.64585987e+02  1.33512817e+03
  1.33512817e+03  1.33512817e+03  2.63570898e+03  3.02937575e+03
  3.02937575e+03  3.02937575e+03  6.64981908e+03  6.64981908e+03
  6.64981908e+03  9.04283696e+03  2.53993809e+04  7.61428633e+04]
E1 = -728.3151986946486  E_coul = 201.6894517384095
cycle= 4 E= -526.625746956239  delta_E= -1.48e-06  |g|= 8.69e-05  |ddm|= 0.00235
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=8.52038e-05
diis-c [-5.12884603e-09 -4.41473167e-06 -1.69364568e-03 -6.18240765e-03
  1.00788047e+00]
  HOMO = -0.575896849778688  LUMO = 1.02101130952771
  mo_energy =
[-1.18574845e+02 -1.22627259e+01 -9.55095622e+00 -9.55095622e+00
 -9.55095622e+00 -1.25004740e+00 -5.75896850e-01 -5.75896850e-01
 -5.75896850e-01  1.02101131e+00  1.02101131e+00  1.02101131e+00
  2.59793898e+00  7.28903496e+00  7.28903496e+00  7.28903496e+00
  3.34029249e+01  3.34029249e+01  3.34029249e+01  8.16707258e+01
  1.28958444e+02  1.28958444e+02  1.28958444e+02  4.83288021e+02
  4.83288021e+02  4.83288021e+02  5.64586126e+02  1.33512831e+03
  1.33512831e+03  1.33512831e+03  2.63570910e+03  3.02937588e+03
  3.02937588e+03  3.02937588e+03  6.64981920e+03  6.64981920e+03
  6.64981920e+03  9.04283708e+03  2.53993810e+04  7.61428634e+04]
E1 = -728.3147504080066  E_coul = 201.68900345111118
cycle= 5 E= -526.625746956895  delta_E= -6.56e-10  |g|= 1.92e-05  |ddm|= 9.22e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3147504080066  E_coul = 201.68900345111118
  HOMO = -0.575904984137515  LUMO = 1.02100553210137
  mo_energy =
[-1.18574886e+02 -1.22627543e+01 -9.55098658e+00 -9.55098658e+00
 -9.55098658e+00 -1.25005639e+00 -5.75904984e-01 -5.75904984e-01
 -5.75904984e-01  1.02100553e+00  1.02100553e+00  1.02100553e+00
  2.59792648e+00  7.28901513e+00  7.28901513e+00  7.28901513e+00
  3.34028951e+01  3.34028951e+01  3.34028951e+01  8.16706900e+01
  1.28958407e+02  1.28958407e+02  1.28958407e+02  4.83287980e+02
  4.83287980e+02  4.83287980e+02  5.64586084e+02  1.33512827e+03
  1.33512827e+03  1.33512827e+03  2.63570906e+03  3.02937584e+03
  3.02937584e+03  3.02937584e+03  6.64981916e+03  6.64981916e+03
  6.64981916e+03  9.04283703e+03  2.53993809e+04  7.61428634e+04]
E1 = -728.3148576734341  E_coul = 201.68911071651115
Extra cycle  E= -526.625746956923  delta_E= -2.75e-11  |g|= 6.17e-06  |ddm|= 1.14e-05
    CPU time for scf_cycle      7.54 sec, wall time      0.56 sec
exp = [2.61826559e+04 7.61752190e+03 3.61735088e+03 1.59782530e+03
 3.82851170e+02 1.08119762e+02 3.48146616e+01 5.15329540e+00
 1.10167824e+00 3.88956666e-01 1.36278321e+03 6.64745652e+02
 3.00961857e+02 3.14042158e+02 6.16223000e+01 7.32819064e+00
 2.02394310e+01 7.75055629e-01 2.81134782e+00 2.23285471e-01]
E = -526.625746956923
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:55:38 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558639        1
[INPUT] 0    0    [1    /1   ]  7617.52189674        1
[INPUT] 0    0    [1    /1   ]  3617.35087564        1
[INPUT] 0    0    [1    /1   ]  1597.82529666        1
[INPUT] 0    0    [1    /1   ]  382.85116954         1
[INPUT] 0    0    [1    /1   ]  108.119761792        1
[INPUT] 0    0    [1    /1   ]  34.8146616157        1
[INPUT] 0    0    [1    /1   ]  5.15329539645        1
[INPUT] 0    0    [1    /1   ]  1.10167823567        1
[INPUT] 0    0    [1    /1   ]  0.3889566658         1
[INPUT] 1    0    [1    /1   ]  1362.78320916        1
[INPUT] 1    0    [1    /1   ]  664.745652473        1
[INPUT] 1    0    [1    /1   ]  300.961857155        1
[INPUT] 1    0    [1    /1   ]  314.042158103        1
[INPUT] 1    0    [1    /1   ]  61.6222999935        1
[INPUT] 1    0    [1    /1   ]  7.32819063841        1
[INPUT] 1    0    [1    /1   ]  20.239431012         1
[INPUT] 1    0    [1    /1   ]  0.77505562907        1
[INPUT] 1    0    [1    /1   ]  2.81134782214        1
[INPUT] 1    0    [1    /1   ]  0.223285470777       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.655863851975, 1.0]], [0, [7617.52189673726, 1.0]], [0, [3617.3508756368888, 1.0]], [0, [1597.825296660999, 1.0]], [0, [382.85116953965223, 1.0]], [0, [108.1197617923309, 1.0]], [0, [34.814661615721185, 1.0]], [0, [5.153295396446576, 1.0]], [0, [1.1016782356711654, 1.0]], [0, [0.38895666579973215, 1.0]], [1, [1362.7832091609384, 1.0]], [1, [664.7456524730211, 1.0]], [1, [300.96185715466294, 1.0]], [1, [314.0421581030048, 1.0]], [1, [61.622299993459436, 1.0]], [1, [7.328190638407828, 1.0]], [1, [20.23943101201132, 1.0]], [1, [0.7750556290696972, 1.0]], [1, [2.8113478221390613, 1.0]], [1, [0.22328547077659885, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65586385]
bas 1, expnt(s) = [7617.52189674]
bas 2, expnt(s) = [3617.35087564]
bas 3, expnt(s) = [1597.82529666]
bas 4, expnt(s) = [382.85116954]
bas 5, expnt(s) = [108.11976179]
bas 6, expnt(s) = [34.81466162]
bas 7, expnt(s) = [5.1532954]
bas 8, expnt(s) = [1.10167824]
bas 9, expnt(s) = [0.38895667]
bas 10, expnt(s) = [1362.78320916]
bas 11, expnt(s) = [664.74565247]
bas 12, expnt(s) = [300.96185715]
bas 13, expnt(s) = [314.0421581]
bas 14, expnt(s) = [61.62229999]
bas 15, expnt(s) = [7.32819064]
bas 16, expnt(s) = [20.23943101]
bas 17, expnt(s) = [0.77505563]
bas 18, expnt(s) = [2.81134782]
bas 19, expnt(s) = [0.22328547]
CPU time:       160.47
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752190e+03 2.06003836e+03
 3.61735088e+03 1.17844143e+03 1.59782530e+03 6.38501606e+02
 3.82851170e+02 2.18669145e+02 1.08119762e+02 8.47117853e+01
 3.48146616e+01 3.62106781e+01 5.15329540e+00 8.64129442e+00
 1.10167824e+00 2.71679020e+00 3.88956666e-01 1.24434538e+00
 1.36278321e+03 2.41556017e+04 6.64745652e+02 9.84699630e+03
 3.00961857e+02 3.65698952e+03 3.14042158e+02 3.85673087e+03
 6.16223000e+01 5.03682396e+02 7.32819064e+00 3.51746950e+01
 2.02394310e+01 1.25236888e+02 7.75055629e-01 2.12153639e+00
 2.81134782e+00 1.06200758e+01 2.23285471e-01 4.47775135e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98343917978958
cond(S) = 100584.89535592412
E1 = -729.2886512786503  E_coul = 203.1765536184032
init E= -526.112097660247
    CPU time for initialize scf      7.74 sec, wall time      0.36 sec
  HOMO = -0.556986671375536  LUMO = 1.03300370197908
  mo_energy =
[-1.18320724e+02 -1.21700679e+01 -9.44589896e+00 -9.44589896e+00
 -9.44589896e+00 -1.22578788e+00 -5.56986671e-01 -5.56986671e-01
 -5.56986671e-01  1.03300370e+00  1.03300370e+00  1.03300370e+00
  2.63241832e+00  7.34881422e+00  7.34881422e+00  7.34881422e+00
  3.35149011e+01  3.35149011e+01  3.35149011e+01  8.18320093e+01
  1.29136939e+02  1.29136939e+02  1.29136939e+02  4.83539018e+02
  4.83539018e+02  4.83539018e+02  5.64875774e+02  1.33543494e+03
  1.33543494e+03  1.33543494e+03  2.63615024e+03  3.02974815e+03
  3.02974815e+03  3.02974815e+03  6.65030521e+03  6.65030521e+03
  6.65030521e+03  9.04339910e+03  2.54000375e+04  7.61436106e+04]
E1 = -727.9198008154221  E_coul = 201.2947382258178
cycle= 1 E= -526.625062589604  delta_E= -0.513  |g|= 0.194  |ddm|= 0.344
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.557606
diis-c [-0.31092411  1.        ]
  HOMO = -0.58204805704204  LUMO = 1.01643017801117
  mo_energy =
[-1.18628738e+02 -1.22912705e+01 -9.58061429e+00 -9.58061429e+00
 -9.58061429e+00 -1.25759545e+00 -5.82048057e-01 -5.82048057e-01
 -5.82048057e-01  1.01643018e+00  1.01643018e+00  1.01643018e+00
  2.58657684e+00  7.27207301e+00  7.27207301e+00  7.27207301e+00
  3.33728105e+01  3.33728105e+01  3.33728105e+01  8.16270196e+01
  1.28914754e+02  1.28914754e+02  1.28914754e+02  4.83234809e+02
  4.83234809e+02  4.83234809e+02  5.64530761e+02  1.33507169e+03
  1.33507169e+03  1.33507169e+03  2.63564995e+03  3.02931749e+03
  3.02931749e+03  3.02931749e+03  6.64975962e+03  6.64975962e+03
  6.64975962e+03  9.04277698e+03  2.53993206e+04  7.61428030e+04]
E1 = -728.4250870553678  E_coul = 201.79938763801562
cycle= 2 E= -526.625699417352  delta_E= -0.000637  |g|= 0.0355  |ddm|= 0.0526
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0700584
diis-c [-0.00274223  0.07734958  0.92265042]
  HOMO = -0.574625699005041  LUMO = 1.02193912872471
  mo_energy =
[-1.18565996e+02 -1.22576504e+01 -9.54554608e+00 -9.54554608e+00
 -9.54554608e+00 -1.24854610e+00 -5.74625699e-01 -5.74625699e-01
 -5.74625699e-01  1.02193913e+00  1.02193913e+00  1.02193913e+00
  2.60010252e+00  7.29232636e+00  7.29232636e+00  7.29232636e+00
  3.34083494e+01  3.34083494e+01  3.34083494e+01  8.16779748e+01
  1.28965838e+02  1.28965838e+02  1.28965838e+02  4.83296760e+02
  4.83296760e+02  4.83296760e+02  5.64595222e+02  1.33513760e+03
  1.33513760e+03  1.33513760e+03  2.63571900e+03  3.02938553e+03
  3.02938553e+03  3.02938553e+03  6.64982923e+03  6.64982923e+03
  6.64982923e+03  9.04284732e+03  2.53993914e+04  7.61428740e+04]
E1 = -728.2950875506511  E_coul = 201.6693420781468
cycle= 3 E= -526.625745472504  delta_E= -4.61e-05  |g|= 0.00557  |ddm|= 0.0158
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0116498
diis-c [-8.05891808e-07 -1.41079681e-03  1.36484268e-01  8.64926528e-01]
  HOMO = -0.575941235899886  LUMO = 1.0209791147561
  mo_energy =
[-1.18574990e+02 -1.22628682e+01 -9.55109224e+00 -9.55109224e+00
 -9.55109224e+00 -1.25010565e+00 -5.75941236e-01 -5.75941236e-01
 -5.75941236e-01  1.02097911e+00  1.02097911e+00  1.02097911e+00
  2.59786002e+00  7.28893645e+00  7.28893645e+00  7.28893645e+00
  3.34027936e+01  3.34027936e+01  3.34027936e+01  8.16705769e+01
  1.28958301e+02  1.28958301e+02  1.28958301e+02  4.83287877e+02
  4.83287877e+02  4.83287877e+02  5.64585987e+02  1.33512817e+03
  1.33512817e+03  1.33512817e+03  2.63570898e+03  3.02937575e+03
  3.02937575e+03  3.02937575e+03  6.64981908e+03  6.64981908e+03
  6.64981908e+03  9.04283696e+03  2.53993809e+04  7.61428633e+04]
E1 = -728.3151986946486  E_coul = 201.6894517384095
cycle= 4 E= -526.625746956239  delta_E= -1.48e-06  |g|= 8.69e-05  |ddm|= 0.00235
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=8.52038e-05
diis-c [-5.12884603e-09 -4.41473167e-06 -1.69364568e-03 -6.18240765e-03
  1.00788047e+00]
  HOMO = -0.575896849778688  LUMO = 1.02101130952771
  mo_energy =
[-1.18574845e+02 -1.22627259e+01 -9.55095622e+00 -9.55095622e+00
 -9.55095622e+00 -1.25004740e+00 -5.75896850e-01 -5.75896850e-01
 -5.75896850e-01  1.02101131e+00  1.02101131e+00  1.02101131e+00
  2.59793898e+00  7.28903496e+00  7.28903496e+00  7.28903496e+00
  3.34029249e+01  3.34029249e+01  3.34029249e+01  8.16707258e+01
  1.28958444e+02  1.28958444e+02  1.28958444e+02  4.83288021e+02
  4.83288021e+02  4.83288021e+02  5.64586126e+02  1.33512831e+03
  1.33512831e+03  1.33512831e+03  2.63570910e+03  3.02937588e+03
  3.02937588e+03  3.02937588e+03  6.64981920e+03  6.64981920e+03
  6.64981920e+03  9.04283708e+03  2.53993810e+04  7.61428634e+04]
E1 = -728.3147504080066  E_coul = 201.68900345111118
cycle= 5 E= -526.625746956895  delta_E= -6.56e-10  |g|= 1.92e-05  |ddm|= 9.22e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3147504080066  E_coul = 201.68900345111118
  HOMO = -0.575904984137515  LUMO = 1.02100553210137
  mo_energy =
[-1.18574886e+02 -1.22627543e+01 -9.55098658e+00 -9.55098658e+00
 -9.55098658e+00 -1.25005639e+00 -5.75904984e-01 -5.75904984e-01
 -5.75904984e-01  1.02100553e+00  1.02100553e+00  1.02100553e+00
  2.59792648e+00  7.28901513e+00  7.28901513e+00  7.28901513e+00
  3.34028951e+01  3.34028951e+01  3.34028951e+01  8.16706900e+01
  1.28958407e+02  1.28958407e+02  1.28958407e+02  4.83287980e+02
  4.83287980e+02  4.83287980e+02  5.64586084e+02  1.33512827e+03
  1.33512827e+03  1.33512827e+03  2.63570906e+03  3.02937584e+03
  3.02937584e+03  3.02937584e+03  6.64981916e+03  6.64981916e+03
  6.64981916e+03  9.04283703e+03  2.53993809e+04  7.61428634e+04]
E1 = -728.3148576734341  E_coul = 201.68911071651115
Extra cycle  E= -526.625746956923  delta_E= -2.75e-11  |g|= 6.17e-06  |ddm|= 1.14e-05
    CPU time for scf_cycle      7.97 sec, wall time      0.58 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 100584.89535592412
E1 = -728.3148576734341  E_coul = 201.68911071651115
init E= -526.625746956923
    CPU time for initialize scf     16.30 sec, wall time      0.81 sec
  HOMO = -0.575902926156423  LUMO = 1.02100704672539
  mo_energy =
[-1.18574874e+02 -1.22627465e+01 -9.55097844e+00 -9.55097844e+00
 -9.55097844e+00 -1.25005380e+00 -5.75902926e-01 -5.75902926e-01
 -5.75902926e-01  1.02100705e+00  1.02100705e+00  1.02100705e+00
  2.59793016e+00  7.28902026e+00  7.28902026e+00  7.28902026e+00
  3.34029033e+01  3.34029033e+01  3.34029033e+01  8.16707007e+01
  1.28958418e+02  1.28958418e+02  1.28958418e+02  4.83287993e+02
  4.83287993e+02  4.83287993e+02  5.64586097e+02  1.33512828e+03
  1.33512828e+03  1.33512828e+03  2.63570907e+03  3.02937585e+03
  3.02937585e+03  3.02937585e+03  6.64981917e+03  6.64981917e+03
  6.64981917e+03  9.04283705e+03  2.53993809e+04  7.61428634e+04]
E1 = -728.3148287077363  E_coul = 201.68908175081157
cycle= 1 E= -526.625746956925  delta_E= -1.82e-12  |g|= 1.73e-06  |ddm|= 4.27e-06
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3148287077363  E_coul = 201.68908175081157
  HOMO = -0.575903452263069  LUMO = 1.02100666502457
  mo_energy =
[-1.18574877e+02 -1.22627486e+01 -9.55098066e+00 -9.55098066e+00
 -9.55098066e+00 -1.25005441e+00 -5.75903452e-01 -5.75903452e-01
 -5.75903452e-01  1.02100667e+00  1.02100667e+00  1.02100667e+00
  2.59792928e+00  7.28901891e+00  7.28901891e+00  7.28901891e+00
  3.34029011e+01  3.34029011e+01  3.34029011e+01  8.16706977e+01
  1.28958415e+02  1.28958415e+02  1.28958415e+02  4.83287989e+02
  4.83287989e+02  4.83287989e+02  5.64586093e+02  1.33512828e+03
  1.33512828e+03  1.33512828e+03  2.63570907e+03  3.02937585e+03
  3.02937585e+03  3.02937585e+03  6.64981916e+03  6.64981916e+03
  6.64981916e+03  9.04283704e+03  2.53993809e+04  7.61428634e+04]
E1 = -728.3148367488814  E_coul = 201.6890897919549
Extra cycle  E= -526.625746956926  delta_E= -1.71e-12  |g|= 4.9e-07  |ddm|= 9e-07
    CPU time for scf_cycle     16.43 sec, wall time      0.94 sec
exp = [2.61826559e+04 7.61752190e+03 3.61735088e+03 1.59782530e+03
 3.82851170e+02 1.08119762e+02 3.48146616e+01 5.15329540e+00
 1.10167824e+00 3.88956666e-01 1.36278321e+03 6.64745652e+02
 3.00961857e+02 3.14042158e+02 6.16223000e+01 7.32819064e+00
 2.02394310e+01 7.75055629e-01 2.81134782e+00 2.23285471e-01]
grad_E = [-1.51359416e-06  3.29831011e-06 -1.51620780e-06  6.88391335e-05
  6.81945766e-06 -2.49021781e-04 -1.23754911e-03 -7.15219289e-03
 -7.71972497e-02  6.22950619e-02 -5.05693394e-07  5.02885760e-06
  2.37447821e-05  2.04719322e-05 -3.20556583e-05 -5.01800945e-04
  1.40792274e-04  3.35443579e-03  5.61896431e-04 -6.41510618e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:55:43 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558703        1
[INPUT] 0    0    [1    /1   ]  7617.52188266        1
[INPUT] 0    0    [1    /1   ]  3617.35088193        1
[INPUT] 0    0    [1    /1   ]  1597.82500176        1
[INPUT] 0    0    [1    /1   ]  382.851178636        1
[INPUT] 0    0    [1    /1   ]  108.119644908        1
[INPUT] 0    0    [1    /1   ]  34.8217382718        1
[INPUT] 0    0    [1    /1   ]  5.41936339427        1
[INPUT] 0    0    [1    /1   ]  1.31271359766        1
[INPUT] 0    0    [1    /1   ]  0.415496863998       1
[INPUT] 1    0    [1    /1   ]  1362.78321132        1
[INPUT] 1    0    [1    /1   ]  664.745631105        1
[INPUT] 1    0    [1    /1   ]  300.96175632         1
[INPUT] 1    0    [1    /1   ]  314.042071165        1
[INPUT] 1    0    [1    /1   ]  61.6224035652        1
[INPUT] 1    0    [1    /1   ]  7.32904009377        1
[INPUT] 1    0    [1    /1   ]  20.239135128         1
[INPUT] 1    0    [1    /1   ]  0.773609613834       1
[INPUT] 1    0    [1    /1   ]  2.81038451356        1
[INPUT] 1    0    [1    /1   ]  0.221048059798       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.655870286642, 1.0]], [0, [7617.521882655055, 1.0]], [0, [3617.350881930448, 1.0]], [0, [1597.8250017647915, 1.0]], [0, [382.8511786358656, 1.0]], [0, [108.11964490811977, 1.0]], [0, [34.821738271808556, 1.0]], [0, [5.419363394273422, 1.0]], [0, [1.3127135976602138, 1.0]], [0, [0.41549686399813734, 1.0]], [1, [1362.7832113170793, 1.0]], [1, [664.7456311047871, 1.0]], [1, [300.9617563196017, 1.0]], [1, [314.04207116529903, 1.0]], [1, [61.62240356521818, 1.0]], [1, [7.329040093768667, 1.0]], [1, [20.239135127951638, 1.0]], [1, [0.7736096138341392, 1.0]], [1, [2.8103845135601637, 1.0]], [1, [0.22104805979815306, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65587029]
bas 1, expnt(s) = [7617.52188266]
bas 2, expnt(s) = [3617.35088193]
bas 3, expnt(s) = [1597.82500176]
bas 4, expnt(s) = [382.85117864]
bas 5, expnt(s) = [108.11964491]
bas 6, expnt(s) = [34.82173827]
bas 7, expnt(s) = [5.41936339]
bas 8, expnt(s) = [1.3127136]
bas 9, expnt(s) = [0.41549686]
bas 10, expnt(s) = [1362.78321132]
bas 11, expnt(s) = [664.7456311]
bas 12, expnt(s) = [300.96175632]
bas 13, expnt(s) = [314.04207117]
bas 14, expnt(s) = [61.62240357]
bas 15, expnt(s) = [7.32904009]
bas 16, expnt(s) = [20.23913513]
bas 17, expnt(s) = [0.77360961]
bas 18, expnt(s) = [2.81038451]
bas 19, expnt(s) = [0.22104806]
CPU time:       189.33
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752188e+03 2.06003836e+03
 3.61735088e+03 1.17844143e+03 1.59782500e+03 6.38501517e+02
 3.82851179e+02 2.18669149e+02 1.08119645e+02 8.47117166e+01
 3.48217383e+01 3.62161983e+01 5.41936339e+00 8.97379676e+00
 1.31271360e+00 3.09843587e+00 4.15496864e-01 1.30749741e+00
 1.36278321e+03 2.41556018e+04 6.64745631e+02 9.84699590e+03
 3.00961756e+02 3.65698798e+03 3.14042071e+02 3.85672954e+03
 6.16224036e+01 5.03683454e+02 7.32904009e+00 3.51797918e+01
 2.02391351e+01 1.25234599e+02 7.73609614e-01 2.11658988e+00
 2.81038451e+00 1.06155273e+01 2.21048060e-01 4.42173567e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.979983496661394
cond(S) = 100776.1972690677
E1 = -729.3723022443329  E_coul = 203.2024089012585
init E= -526.169893343074
    CPU time for initialize scf      7.06 sec, wall time      0.35 sec
  HOMO = -0.555918412948813  LUMO = 1.02286285726281
  mo_energy =
[-1.18318921e+02 -1.21781136e+01 -9.44418145e+00 -9.44418145e+00
 -9.44418145e+00 -1.22127123e+00 -5.55918413e-01 -5.55918413e-01
 -5.55918413e-01  1.02286286e+00  1.02286286e+00  1.02286286e+00
  3.31359469e+00  7.33381614e+00  7.33381614e+00  7.33381614e+00
  3.35041525e+01  3.35041525e+01  3.35041525e+01  8.40301540e+01
  1.29129391e+02  1.29129391e+02  1.29129391e+02  4.83534999e+02
  4.83534999e+02  4.83534999e+02  5.66715562e+02  1.33543133e+03
  1.33543133e+03  1.33543133e+03  2.63771627e+03  3.02974491e+03
  3.02974491e+03  3.02974491e+03  6.65030235e+03  6.65030235e+03
  6.65030235e+03  9.04482534e+03  2.54013846e+04  7.61448646e+04]
E1 = -728.0666032013543  E_coul = 201.428779232267
cycle= 1 E= -526.637823969087  delta_E= -0.468  |g|= 0.187  |ddm|= 0.302
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.542127
diis-c [-0.29390185  1.        ]
  HOMO = -0.57838274563232  LUMO = 1.00846717115652
  mo_energy =
[-1.18611640e+02 -1.22927694e+01 -9.57099914e+00 -9.57099914e+00
 -9.57099914e+00 -1.25234137e+00 -5.78382746e-01 -5.78382746e-01
 -5.78382746e-01  1.00846717e+00  1.00846717e+00  1.00846717e+00
  3.26309699e+00  7.26203673e+00  7.26203673e+00  7.26203673e+00
  3.33704569e+01  3.33704569e+01  3.33704569e+01  8.38339060e+01
  1.28919003e+02  1.28919003e+02  1.28919003e+02  4.83245191e+02
  4.83245191e+02  4.83245191e+02  5.66386542e+02  1.33508444e+03
  1.33508444e+03  1.33508444e+03  2.63723463e+03  3.02933183e+03
  3.02933183e+03  3.02933183e+03  6.64977596e+03  6.64977596e+03
  6.64977596e+03  9.04422339e+03  2.54006887e+04  7.61440786e+04]
E1 = -728.5330171580333  E_coul = 201.89463525892967
cycle= 2 E= -526.638381899104  delta_E= -0.000558  |g|= 0.0334  |ddm|= 0.0497
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0671755
diis-c [-0.00264481  0.07414178  0.92585822]
  HOMO = -0.571709540803916  LUMO = 1.01340461332328
  mo_energy =
[-1.18552718e+02 -1.22616991e+01 -9.53848053e+00 -9.53848053e+00
 -9.53848053e+00 -1.24418552e+00 -5.71709541e-01 -5.71709541e-01
 -5.71709541e-01  1.01340461e+00  1.01340461e+00  1.01340461e+00
  3.27701893e+00  7.28058486e+00  7.28058486e+00  7.28058486e+00
  3.34034579e+01  3.34034579e+01  3.34034579e+01  8.38814417e+01
  1.28966782e+02  1.28966782e+02  1.28966782e+02  4.83303353e+02
  4.83303353e+02  4.83303353e+02  5.66447123e+02  1.33514644e+03
  1.33514644e+03  1.33514644e+03  2.63729976e+03  3.02939592e+03
  3.02939592e+03  3.02939592e+03  6.64984165e+03  6.64984165e+03
  6.64984165e+03  9.04428982e+03  2.54007556e+04  7.61441458e+04]
E1 = -728.4127165863422  E_coul = 201.77429508726064
cycle= 3 E= -526.638421499082  delta_E= -3.96e-05  |g|= 0.00537  |ddm|= 0.0134
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0111373
diis-c [-5.98740036e-07 -1.28046294e-03  1.36857464e-01  8.64422999e-01]
  HOMO = -0.572939203339707  LUMO = 1.0125025091102
  mo_energy =
[-1.18561319e+02 -1.22666337e+01 -9.54371610e+00 -9.54371610e+00
 -9.54371610e+00 -1.24569036e+00 -5.72939203e-01 -5.72939203e-01
 -5.72939203e-01  1.01250251e+00  1.01250251e+00  1.01250251e+00
  3.27458729e+00  7.27739663e+00  7.27739663e+00  7.27739663e+00
  3.33982003e+01  3.33982003e+01  3.33982003e+01  8.38743765e+01
  1.28959600e+02  1.28959600e+02  1.28959600e+02  4.83294857e+02
  4.83294857e+02  4.83294857e+02  5.66438294e+02  1.33513742e+03
  1.33513742e+03  1.33513742e+03  2.63729018e+03  3.02938657e+03
  3.02938657e+03  3.02938657e+03  6.64983195e+03  6.64983195e+03
  6.64983195e+03  9.04427993e+03  2.54007456e+04  7.61441356e+04]
E1 = -728.431489858555  E_coul = 201.7930670562401
cycle= 4 E= -526.638422802315  delta_E= -1.3e-06  |g|= 8.09e-05  |ddm|= 0.00221
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00011268
diis-c [-4.45456327e-09 -1.04808183e-05 -4.60748078e-04  5.63556561e-03
  9.94835663e-01]
  HOMO = -0.572899040668936  LUMO = 1.01253066938107
  mo_energy =
[-1.18561169e+02 -1.22664975e+01 -9.54358193e+00 -9.54358193e+00
 -9.54358193e+00 -1.24564278e+00 -5.72899041e-01 -5.72899041e-01
 -5.72899041e-01  1.01253067e+00  1.01253067e+00  1.01253067e+00
  3.27465931e+00  7.27748953e+00  7.27748953e+00  7.27748953e+00
  3.33983293e+01  3.33983293e+01  3.33983293e+01  8.38745231e+01
  1.28959745e+02  1.28959745e+02  1.28959745e+02  4.83295006e+02
  4.83295006e+02  4.83295006e+02  5.66438440e+02  1.33513757e+03
  1.33513757e+03  1.33513757e+03  2.63729031e+03  3.02938671e+03
  3.02938671e+03  3.02938671e+03  6.64983209e+03  6.64983209e+03
  6.64983209e+03  9.04428006e+03  2.54007457e+04  7.61441357e+04]
E1 = -728.4310352503186  E_coul = 201.7926124473871
cycle= 5 E= -526.638422802931  delta_E= -6.17e-10  |g|= 1.5e-05  |ddm|= 5.59e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.4310352503186  E_coul = 201.7926124473871
  HOMO = -0.572905669496514  LUMO = 1.01252582599632
  mo_energy =
[-1.18561201e+02 -1.22665199e+01 -9.54360546e+00 -9.54360546e+00
 -9.54360546e+00 -1.24565108e+00 -5.72905669e-01 -5.72905669e-01
 -5.72905669e-01  1.01252583e+00  1.01252583e+00  1.01252583e+00
  3.27464663e+00  7.27747374e+00  7.27747374e+00  7.27747374e+00
  3.33983061e+01  3.33983061e+01  3.33983061e+01  8.38744950e+01
  1.28959716e+02  1.28959716e+02  1.28959716e+02  4.83294974e+02
  4.83294974e+02  4.83294974e+02  5.66438407e+02  1.33513754e+03
  1.33513754e+03  1.33513754e+03  2.63729028e+03  3.02938668e+03
  3.02938668e+03  3.02938668e+03  6.64983205e+03  6.64983205e+03
  6.64983205e+03  9.04428003e+03  2.54007457e+04  7.61441357e+04]
E1 = -728.4311150468039  E_coul = 201.79269224385703
Extra cycle  E= -526.638422802947  delta_E= -1.55e-11  |g|= 4.59e-06  |ddm|= 1.11e-05
    CPU time for scf_cycle      7.25 sec, wall time      0.54 sec
exp = [2.61826559e+04 7.61752188e+03 3.61735088e+03 1.59782500e+03
 3.82851179e+02 1.08119645e+02 3.48217383e+01 5.41936339e+00
 1.31271360e+00 4.15496864e-01 1.36278321e+03 6.64745631e+02
 3.00961756e+02 3.14042071e+02 6.16224036e+01 7.32904009e+00
 2.02391351e+01 7.73609614e-01 2.81038451e+00 2.21048060e-01]
E = -526.6384228029469
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:55:43 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558703        1
[INPUT] 0    0    [1    /1   ]  7617.52188266        1
[INPUT] 0    0    [1    /1   ]  3617.35088193        1
[INPUT] 0    0    [1    /1   ]  1597.82500176        1
[INPUT] 0    0    [1    /1   ]  382.851178636        1
[INPUT] 0    0    [1    /1   ]  108.119644908        1
[INPUT] 0    0    [1    /1   ]  34.8217382718        1
[INPUT] 0    0    [1    /1   ]  5.41936339427        1
[INPUT] 0    0    [1    /1   ]  1.31271359766        1
[INPUT] 0    0    [1    /1   ]  0.415496863998       1
[INPUT] 1    0    [1    /1   ]  1362.78321132        1
[INPUT] 1    0    [1    /1   ]  664.745631105        1
[INPUT] 1    0    [1    /1   ]  300.96175632         1
[INPUT] 1    0    [1    /1   ]  314.042071165        1
[INPUT] 1    0    [1    /1   ]  61.6224035652        1
[INPUT] 1    0    [1    /1   ]  7.32904009377        1
[INPUT] 1    0    [1    /1   ]  20.239135128         1
[INPUT] 1    0    [1    /1   ]  0.773609613834       1
[INPUT] 1    0    [1    /1   ]  2.81038451356        1
[INPUT] 1    0    [1    /1   ]  0.221048059798       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.655870286642, 1.0]], [0, [7617.521882655055, 1.0]], [0, [3617.350881930448, 1.0]], [0, [1597.8250017647915, 1.0]], [0, [382.8511786358656, 1.0]], [0, [108.11964490811977, 1.0]], [0, [34.821738271808556, 1.0]], [0, [5.419363394273422, 1.0]], [0, [1.3127135976602138, 1.0]], [0, [0.41549686399813734, 1.0]], [1, [1362.7832113170793, 1.0]], [1, [664.7456311047871, 1.0]], [1, [300.9617563196017, 1.0]], [1, [314.04207116529903, 1.0]], [1, [61.62240356521818, 1.0]], [1, [7.329040093768667, 1.0]], [1, [20.239135127951638, 1.0]], [1, [0.7736096138341392, 1.0]], [1, [2.8103845135601637, 1.0]], [1, [0.22104805979815306, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65587029]
bas 1, expnt(s) = [7617.52188266]
bas 2, expnt(s) = [3617.35088193]
bas 3, expnt(s) = [1597.82500176]
bas 4, expnt(s) = [382.85117864]
bas 5, expnt(s) = [108.11964491]
bas 6, expnt(s) = [34.82173827]
bas 7, expnt(s) = [5.41936339]
bas 8, expnt(s) = [1.3127136]
bas 9, expnt(s) = [0.41549686]
bas 10, expnt(s) = [1362.78321132]
bas 11, expnt(s) = [664.7456311]
bas 12, expnt(s) = [300.96175632]
bas 13, expnt(s) = [314.04207117]
bas 14, expnt(s) = [61.62240357]
bas 15, expnt(s) = [7.32904009]
bas 16, expnt(s) = [20.23913513]
bas 17, expnt(s) = [0.77360961]
bas 18, expnt(s) = [2.81038451]
bas 19, expnt(s) = [0.22104806]
CPU time:       196.66
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752188e+03 2.06003836e+03
 3.61735088e+03 1.17844143e+03 1.59782500e+03 6.38501517e+02
 3.82851179e+02 2.18669149e+02 1.08119645e+02 8.47117166e+01
 3.48217383e+01 3.62161983e+01 5.41936339e+00 8.97379676e+00
 1.31271360e+00 3.09843587e+00 4.15496864e-01 1.30749741e+00
 1.36278321e+03 2.41556018e+04 6.64745631e+02 9.84699590e+03
 3.00961756e+02 3.65698798e+03 3.14042071e+02 3.85672954e+03
 6.16224036e+01 5.03683454e+02 7.32904009e+00 3.51797918e+01
 2.02391351e+01 1.25234599e+02 7.73609614e-01 2.11658988e+00
 2.81038451e+00 1.06155273e+01 2.21048060e-01 4.42173567e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.979983496661394
cond(S) = 100776.1972690677
E1 = -729.3723022443329  E_coul = 203.2024089012585
init E= -526.169893343074
    CPU time for initialize scf      7.28 sec, wall time      0.35 sec
  HOMO = -0.555918412948813  LUMO = 1.02286285726281
  mo_energy =
[-1.18318921e+02 -1.21781136e+01 -9.44418145e+00 -9.44418145e+00
 -9.44418145e+00 -1.22127123e+00 -5.55918413e-01 -5.55918413e-01
 -5.55918413e-01  1.02286286e+00  1.02286286e+00  1.02286286e+00
  3.31359469e+00  7.33381614e+00  7.33381614e+00  7.33381614e+00
  3.35041525e+01  3.35041525e+01  3.35041525e+01  8.40301540e+01
  1.29129391e+02  1.29129391e+02  1.29129391e+02  4.83534999e+02
  4.83534999e+02  4.83534999e+02  5.66715562e+02  1.33543133e+03
  1.33543133e+03  1.33543133e+03  2.63771627e+03  3.02974491e+03
  3.02974491e+03  3.02974491e+03  6.65030235e+03  6.65030235e+03
  6.65030235e+03  9.04482534e+03  2.54013846e+04  7.61448646e+04]
E1 = -728.0666032013543  E_coul = 201.428779232267
cycle= 1 E= -526.637823969087  delta_E= -0.468  |g|= 0.187  |ddm|= 0.302
    CPU time for cycle= 1      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.542127
diis-c [-0.29390185  1.        ]
  HOMO = -0.57838274563232  LUMO = 1.00846717115652
  mo_energy =
[-1.18611640e+02 -1.22927694e+01 -9.57099914e+00 -9.57099914e+00
 -9.57099914e+00 -1.25234137e+00 -5.78382746e-01 -5.78382746e-01
 -5.78382746e-01  1.00846717e+00  1.00846717e+00  1.00846717e+00
  3.26309699e+00  7.26203673e+00  7.26203673e+00  7.26203673e+00
  3.33704569e+01  3.33704569e+01  3.33704569e+01  8.38339060e+01
  1.28919003e+02  1.28919003e+02  1.28919003e+02  4.83245191e+02
  4.83245191e+02  4.83245191e+02  5.66386542e+02  1.33508444e+03
  1.33508444e+03  1.33508444e+03  2.63723463e+03  3.02933183e+03
  3.02933183e+03  3.02933183e+03  6.64977596e+03  6.64977596e+03
  6.64977596e+03  9.04422339e+03  2.54006887e+04  7.61440786e+04]
E1 = -728.5330171580333  E_coul = 201.89463525892967
cycle= 2 E= -526.638381899104  delta_E= -0.000558  |g|= 0.0334  |ddm|= 0.0497
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0671755
diis-c [-0.00264481  0.07414178  0.92585822]
  HOMO = -0.571709540803916  LUMO = 1.01340461332328
  mo_energy =
[-1.18552718e+02 -1.22616991e+01 -9.53848053e+00 -9.53848053e+00
 -9.53848053e+00 -1.24418552e+00 -5.71709541e-01 -5.71709541e-01
 -5.71709541e-01  1.01340461e+00  1.01340461e+00  1.01340461e+00
  3.27701893e+00  7.28058486e+00  7.28058486e+00  7.28058486e+00
  3.34034579e+01  3.34034579e+01  3.34034579e+01  8.38814417e+01
  1.28966782e+02  1.28966782e+02  1.28966782e+02  4.83303353e+02
  4.83303353e+02  4.83303353e+02  5.66447123e+02  1.33514644e+03
  1.33514644e+03  1.33514644e+03  2.63729976e+03  3.02939592e+03
  3.02939592e+03  3.02939592e+03  6.64984165e+03  6.64984165e+03
  6.64984165e+03  9.04428982e+03  2.54007556e+04  7.61441458e+04]
E1 = -728.4127165863422  E_coul = 201.77429508726064
cycle= 3 E= -526.638421499082  delta_E= -3.96e-05  |g|= 0.00537  |ddm|= 0.0134
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0111373
diis-c [-5.98740036e-07 -1.28046294e-03  1.36857464e-01  8.64422999e-01]
  HOMO = -0.572939203339707  LUMO = 1.0125025091102
  mo_energy =
[-1.18561319e+02 -1.22666337e+01 -9.54371610e+00 -9.54371610e+00
 -9.54371610e+00 -1.24569036e+00 -5.72939203e-01 -5.72939203e-01
 -5.72939203e-01  1.01250251e+00  1.01250251e+00  1.01250251e+00
  3.27458729e+00  7.27739663e+00  7.27739663e+00  7.27739663e+00
  3.33982003e+01  3.33982003e+01  3.33982003e+01  8.38743765e+01
  1.28959600e+02  1.28959600e+02  1.28959600e+02  4.83294857e+02
  4.83294857e+02  4.83294857e+02  5.66438294e+02  1.33513742e+03
  1.33513742e+03  1.33513742e+03  2.63729018e+03  3.02938657e+03
  3.02938657e+03  3.02938657e+03  6.64983195e+03  6.64983195e+03
  6.64983195e+03  9.04427993e+03  2.54007456e+04  7.61441356e+04]
E1 = -728.431489858555  E_coul = 201.7930670562401
cycle= 4 E= -526.638422802315  delta_E= -1.3e-06  |g|= 8.09e-05  |ddm|= 0.00221
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00011268
diis-c [-4.45456327e-09 -1.04808183e-05 -4.60748078e-04  5.63556561e-03
  9.94835663e-01]
  HOMO = -0.572899040668936  LUMO = 1.01253066938107
  mo_energy =
[-1.18561169e+02 -1.22664975e+01 -9.54358193e+00 -9.54358193e+00
 -9.54358193e+00 -1.24564278e+00 -5.72899041e-01 -5.72899041e-01
 -5.72899041e-01  1.01253067e+00  1.01253067e+00  1.01253067e+00
  3.27465931e+00  7.27748953e+00  7.27748953e+00  7.27748953e+00
  3.33983293e+01  3.33983293e+01  3.33983293e+01  8.38745231e+01
  1.28959745e+02  1.28959745e+02  1.28959745e+02  4.83295006e+02
  4.83295006e+02  4.83295006e+02  5.66438440e+02  1.33513757e+03
  1.33513757e+03  1.33513757e+03  2.63729031e+03  3.02938671e+03
  3.02938671e+03  3.02938671e+03  6.64983209e+03  6.64983209e+03
  6.64983209e+03  9.04428006e+03  2.54007457e+04  7.61441357e+04]
E1 = -728.4310352503186  E_coul = 201.7926124473871
cycle= 5 E= -526.638422802931  delta_E= -6.17e-10  |g|= 1.5e-05  |ddm|= 5.59e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.4310352503186  E_coul = 201.7926124473871
  HOMO = -0.572905669496514  LUMO = 1.01252582599632
  mo_energy =
[-1.18561201e+02 -1.22665199e+01 -9.54360546e+00 -9.54360546e+00
 -9.54360546e+00 -1.24565108e+00 -5.72905669e-01 -5.72905669e-01
 -5.72905669e-01  1.01252583e+00  1.01252583e+00  1.01252583e+00
  3.27464663e+00  7.27747374e+00  7.27747374e+00  7.27747374e+00
  3.33983061e+01  3.33983061e+01  3.33983061e+01  8.38744950e+01
  1.28959716e+02  1.28959716e+02  1.28959716e+02  4.83294974e+02
  4.83294974e+02  4.83294974e+02  5.66438407e+02  1.33513754e+03
  1.33513754e+03  1.33513754e+03  2.63729028e+03  3.02938668e+03
  3.02938668e+03  3.02938668e+03  6.64983205e+03  6.64983205e+03
  6.64983205e+03  9.04428003e+03  2.54007457e+04  7.61441357e+04]
E1 = -728.4311150468039  E_coul = 201.79269224385703
Extra cycle  E= -526.638422802947  delta_E= -1.55e-11  |g|= 4.59e-06  |ddm|= 1.11e-05
    CPU time for scf_cycle      7.50 sec, wall time      0.53 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 100776.1972690677
E1 = -728.4311150468039  E_coul = 201.79269224385703
init E= -526.638422802947
    CPU time for initialize scf     16.08 sec, wall time      0.77 sec
  HOMO = -0.572904183932088  LUMO = 1.01252689896004
  mo_energy =
[-1.18561191e+02 -1.22665140e+01 -9.54359935e+00 -9.54359935e+00
 -9.54359935e+00 -1.24564931e+00 -5.72904184e-01 -5.72904184e-01
 -5.72904184e-01  1.01252690e+00  1.01252690e+00  1.01252690e+00
  3.27464948e+00  7.27747753e+00  7.27747753e+00  7.27747753e+00
  3.33983122e+01  3.33983122e+01  3.33983122e+01  8.38745030e+01
  1.28959724e+02  1.28959724e+02  1.28959724e+02  4.83294984e+02
  4.83294984e+02  4.83294984e+02  5.66438417e+02  1.33513755e+03
  1.33513755e+03  1.33513755e+03  2.63729029e+03  3.02938669e+03
  3.02938669e+03  3.02938669e+03  6.64983206e+03  6.64983206e+03
  6.64983206e+03  9.04428004e+03  2.54007457e+04  7.61441357e+04]
E1 = -728.4310932078062  E_coul = 201.79267040485846
cycle= 1 E= -526.638422802948  delta_E= -7.96e-13  |g|= 1.33e-06  |ddm|= 2.44e-06
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.4310932078062  E_coul = 201.79267040485846
  HOMO = -0.572904579974659  LUMO = 1.01252660845807
  mo_energy =
[-1.18561194e+02 -1.22665156e+01 -9.54360101e+00 -9.54360101e+00
 -9.54360101e+00 -1.24564980e+00 -5.72904580e-01 -5.72904580e-01
 -5.72904580e-01  1.01252661e+00  1.01252661e+00  1.01252661e+00
  3.27464869e+00  7.27747651e+00  7.27747651e+00  7.27747651e+00
  3.33983106e+01  3.33983106e+01  3.33983106e+01  8.38745007e+01
  1.28959722e+02  1.28959722e+02  1.28959722e+02  4.83294981e+02
  4.83294981e+02  4.83294981e+02  5.66438414e+02  1.33513755e+03
  1.33513755e+03  1.33513755e+03  2.63729029e+03  3.02938668e+03
  3.02938668e+03  3.02938668e+03  6.64983206e+03  6.64983206e+03
  6.64983206e+03  9.04428004e+03  2.54007457e+04  7.61441357e+04]
E1 = -728.4310991329501  E_coul = 201.79267633000205
Extra cycle  E= -526.638422802948  delta_E= -3.41e-13  |g|= 3.67e-07  |ddm|= 7.2e-07
    CPU time for scf_cycle     16.21 sec, wall time      0.89 sec
exp = [2.61826559e+04 7.61752188e+03 3.61735088e+03 1.59782500e+03
 3.82851179e+02 1.08119645e+02 3.48217383e+01 5.41936339e+00
 1.31271360e+00 4.15496864e-01 1.36278321e+03 6.64745631e+02
 3.00961756e+02 3.14042071e+02 6.16224036e+01 7.32904009e+00
 2.02391351e+01 7.73609614e-01 2.81038451e+00 2.21048060e-01]
grad_E = [-1.51421637e-06  3.29021344e-06 -1.54346759e-06  6.85267498e-05
  1.11338137e-05 -4.37013740e-04 -1.00243699e-03  1.70087485e-02
 -8.44800371e-02  1.53904444e-01 -5.05183925e-07  5.02927227e-06
  2.37513689e-05  2.04774506e-05 -3.48016054e-05 -6.54029428e-04
  1.64282077e-04  1.48453299e-02  6.27498068e-04 -4.74310244e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:55:48 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558841        1
[INPUT] 0    0    [1    /1   ]  7617.52185248        1
[INPUT] 0    0    [1    /1   ]  3617.35089552        1
[INPUT] 0    0    [1    /1   ]  1597.82437048        1
[INPUT] 0    0    [1    /1   ]  382.851180903        1
[INPUT] 0    0    [1    /1   ]  108.120067463        1
[INPUT] 0    0    [1    /1   ]  34.8360523849        1
[INPUT] 0    0    [1    /1   ]  5.88172564074        1
[INPUT] 0    0    [1    /1   ]  1.71766037722        1
[INPUT] 0    0    [1    /1   ]  0.424524722259       1
[INPUT] 1    0    [1    /1   ]  1362.78321594        1
[INPUT] 1    0    [1    /1   ]  664.745585275        1
[INPUT] 1    0    [1    /1   ]  300.961540036        1
[INPUT] 1    0    [1    /1   ]  314.04188469         1
[INPUT] 1    0    [1    /1   ]  61.6226347313        1
[INPUT] 1    0    [1    /1   ]  7.3311212374         1
[INPUT] 1    0    [1    /1   ]  20.238426025         1
[INPUT] 1    0    [1    /1   ]  0.771152349992       1
[INPUT] 1    0    [1    /1   ]  2.80770605795        1
[INPUT] 1    0    [1    /1   ]  0.218165813851       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.655884088483, 1.0]], [0, [7617.5218524840575, 1.0]], [0, [3617.3508955231136, 1.0]], [0, [1597.824370479923, 1.0]], [0, [382.8511809031264, 1.0]], [0, [108.12006746314853, 1.0]], [0, [34.836052384926035, 1.0]], [0, [5.881725640736037, 1.0]], [0, [1.7176603772232186, 1.0]], [0, [0.4245247222587786, 1.0]], [1, [1362.7832159389259, 1.0]], [1, [664.7455852754455, 1.0]], [1, [300.9615400358619, 1.0]], [1, [314.04188469044186, 1.0]], [1, [61.62263473130126, 1.0]], [1, [7.331121237400119, 1.0]], [1, [20.23842602503346, 1.0]], [1, [0.7711523499920457, 1.0]], [1, [2.8077060579451905, 1.0]], [1, [0.2181658138507286, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65588409]
bas 1, expnt(s) = [7617.52185248]
bas 2, expnt(s) = [3617.35089552]
bas 3, expnt(s) = [1597.82437048]
bas 4, expnt(s) = [382.8511809]
bas 5, expnt(s) = [108.12006746]
bas 6, expnt(s) = [34.83605238]
bas 7, expnt(s) = [5.88172564]
bas 8, expnt(s) = [1.71766038]
bas 9, expnt(s) = [0.42452472]
bas 10, expnt(s) = [1362.78321594]
bas 11, expnt(s) = [664.74558528]
bas 12, expnt(s) = [300.96154004]
bas 13, expnt(s) = [314.04188469]
bas 14, expnt(s) = [61.62263473]
bas 15, expnt(s) = [7.33112124]
bas 16, expnt(s) = [20.23842603]
bas 17, expnt(s) = [0.77115235]
bas 18, expnt(s) = [2.80770606]
bas 19, expnt(s) = [0.21816581]
CPU time:       225.11
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752185e+03 2.06003835e+03
 3.61735090e+03 1.17844143e+03 1.59782437e+03 6.38501328e+02
 3.82851181e+02 2.18669150e+02 1.08120067e+02 8.47119649e+01
 3.48360524e+01 3.62273632e+01 5.88172564e+00 9.54209193e+00
 1.71766038e+00 3.79068762e+00 4.24524722e-01 1.32874690e+00
 1.36278322e+03 2.41556019e+04 6.64745585e+02 9.84699505e+03
 3.00961540e+02 3.65698470e+03 3.14041885e+02 3.85672667e+03
 6.16226347e+01 5.03685816e+02 7.33112124e+00 3.51922792e+01
 2.02384260e+01 1.25229114e+02 7.71152350e-01 2.10818940e+00
 2.80770606e+00 1.06028823e+01 2.18165814e-01 4.34978474e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.978582801800613
cond(S) = 101101.71732750903
E1 = -729.4607969931428  E_coul = 203.23728663943425
init E= -526.223510353709
    CPU time for initialize scf      7.32 sec, wall time      0.34 sec
  HOMO = -0.554658313243954  LUMO = 1.00975856491313
  mo_energy =
[-1.18317200e+02 -1.21872093e+01 -9.44174507e+00 -9.44174507e+00
 -9.44174507e+00 -1.21810911e+00 -5.54658313e-01 -5.54658313e-01
 -5.54658313e-01  1.00975856e+00  1.00975856e+00  1.00975856e+00
  4.52696933e+00  7.31038309e+00  7.31038309e+00  7.31038309e+00
  3.34855121e+01  3.34855121e+01  3.34855121e+01  8.78532702e+01
  1.29115602e+02  1.29115602e+02  1.29115602e+02  4.83526374e+02
  4.83526374e+02  4.83526374e+02  5.69980946e+02  1.33542364e+03
  1.33542364e+03  1.33542364e+03  2.64050466e+03  3.02973763e+03
  3.02973763e+03  3.02973763e+03  6.65029562e+03  6.65029562e+03
  6.65029562e+03  9.04736614e+03  2.54037846e+04  7.61470987e+04]
E1 = -728.0787754203135  E_coul = 201.41999127080115
cycle= 1 E= -526.658784149512  delta_E= -0.435  |g|= 0.185  |ddm|= 0.295
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.53738
diis-c [-0.28877727  1.        ]
  HOMO = -0.57822792528658  LUMO = 0.994882724480434
  mo_energy =
[-1.18610135e+02 -1.23060840e+01 -9.57258128e+00 -9.57258128e+00
 -9.57258128e+00 -1.25112802e+00 -5.78227925e-01 -5.78227925e-01
 -5.78227925e-01  9.94882724e-01  9.94882724e-01  9.94882724e-01
  4.46378984e+00  7.23559282e+00  7.23559282e+00  7.23559282e+00
  3.33485561e+01  3.33485561e+01  3.33485561e+01  8.76521571e+01
  1.28903139e+02  1.28903139e+02  1.28903139e+02  4.83235467e+02
  4.83235467e+02  4.83235467e+02  5.69651936e+02  1.33507680e+03
  1.33507680e+03  1.33507680e+03  2.64002414e+03  3.02932513e+03
  3.02932513e+03  3.02932513e+03  6.64977061e+03  6.64977061e+03
  6.64977061e+03  9.04676606e+03  2.54030910e+04  7.61463154e+04]
E1 = -728.5481787643349  E_coul = 201.88883100494044
cycle= 2 E= -526.659347759394  delta_E= -0.000564  |g|= 0.0337  |ddm|= 0.0443
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0680731
diis-c [-0.00273313  0.07537377  0.92462623]
  HOMO = -0.571537393323373  LUMO = 0.999828048908068
  mo_energy =
[-1.18550938e+02 -1.22748781e+01 -9.53991280e+00 -9.53991280e+00
 -9.53991280e+00 -1.24278980e+00 -5.71537393e-01 -5.71537393e-01
 -5.71537393e-01  9.99828049e-01  9.99828049e-01  9.99828049e-01
  4.48056904e+00  7.25421711e+00  7.25421711e+00  7.25421711e+00
  3.33817346e+01  3.33817346e+01  3.33817346e+01  8.76998441e+01
  1.28951145e+02  1.28951145e+02  1.28951145e+02  4.83293895e+02
  4.83293895e+02  4.83293895e+02  5.69712760e+02  1.33513908e+03
  1.33513908e+03  1.33513908e+03  2.64008959e+03  3.02938954e+03
  3.02938954e+03  3.02938954e+03  6.64983664e+03  6.64983664e+03
  6.64983664e+03  9.04683285e+03  2.54031583e+04  7.61463829e+04]
E1 = -728.429505349785  E_coul = 201.7701180245888
cycle= 3 E= -526.659387325196  delta_E= -3.96e-05  |g|= 0.00534  |ddm|= 0.0124
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0112037
diis-c [-5.52504482e-07 -1.24009756e-03  1.36308096e-01  8.64932002e-01]
  HOMO = -0.572703981388312  LUMO = 0.998974810656435
  mo_energy =
[-1.18559396e+02 -1.22796420e+01 -9.54498532e+00 -9.54498532e+00
 -9.54498532e+00 -1.24422258e+00 -5.72703981e-01 -5.72703981e-01
 -5.72703981e-01  9.98974811e-01  9.98974811e-01  9.98974811e-01
  4.47785308e+00  7.25115903e+00  7.25115903e+00  7.25115903e+00
  3.33766309e+01  3.33766309e+01  3.33766309e+01  8.76929267e+01
  1.28944116e+02  1.28944116e+02  1.28944116e+02  4.83285541e+02
  4.83285541e+02  4.83285541e+02  5.69704073e+02  1.33513020e+03
  1.33513020e+03  1.33513020e+03  2.64008014e+03  3.02938031e+03
  3.02938031e+03  3.02938031e+03  6.64982706e+03  6.64982706e+03
  6.64982706e+03  9.04682308e+03  2.54031484e+04  7.61463729e+04]
E1 = -728.4474088166214  E_coul = 201.78802027539214
cycle= 4 E= -526.659388541229  delta_E= -1.22e-06  |g|= 6.19e-05  |ddm|= 0.00188
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.63241e-05
diis-c [-3.50894428e-09  1.36674240e-05 -3.06933042e-03 -1.67373787e-02
  1.01979304e+00]
  HOMO = -0.572672841119053  LUMO = 0.998996826477471
  mo_energy =
[-1.18559292e+02 -1.22795374e+01 -9.54488686e+00 -9.54488686e+00
 -9.54488686e+00 -1.24418252e+00 -5.72672841e-01 -5.72672841e-01
 -5.72672841e-01  9.98996826e-01  9.98996826e-01  9.98996826e-01
  4.47792142e+00  7.25122909e+00  7.25122909e+00  7.25122909e+00
  3.33767254e+01  3.33767254e+01  3.33767254e+01  8.76930327e+01
  1.28944219e+02  1.28944219e+02  1.28944219e+02  4.83285644e+02
  4.83285644e+02  4.83285644e+02  5.69704172e+02  1.33513030e+03
  1.33513030e+03  1.33513030e+03  2.64008022e+03  3.02938040e+03
  3.02938040e+03  3.02938040e+03  6.64982715e+03  6.64982715e+03
  6.64982715e+03  9.04682316e+03  2.54031484e+04  7.61463730e+04]
E1 = -728.4470931387882  E_coul = 201.7877045972745
cycle= 5 E= -526.659388541514  delta_E= -2.84e-10  |g|= 1.48e-05  |ddm|= 4.47e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.4470931387882  E_coul = 201.7877045972745
  HOMO = -0.572679182134893  LUMO = 0.998992256154297
  mo_energy =
[-1.18559324e+02 -1.22795594e+01 -9.54491019e+00 -9.54491019e+00
 -9.54491019e+00 -1.24419020e+00 -5.72679182e-01 -5.72679182e-01
 -5.72679182e-01  9.98992256e-01  9.98992256e-01  9.98992256e-01
  4.47790787e+00  7.25121371e+00  7.25121371e+00  7.25121371e+00
  3.33767024e+01  3.33767024e+01  3.33767024e+01  8.76930048e+01
  1.28944191e+02  1.28944191e+02  1.28944191e+02  4.83285612e+02
  4.83285612e+02  4.83285612e+02  5.69704140e+02  1.33513027e+03
  1.33513027e+03  1.33513027e+03  2.64008019e+03  3.02938037e+03
  3.02938037e+03  3.02938037e+03  6.64982711e+03  6.64982711e+03
  6.64982711e+03  9.04682313e+03  2.54031484e+04  7.61463729e+04]
E1 = -728.4471715593628  E_coul = 201.78778301783586
Extra cycle  E= -526.659388541527  delta_E= -1.33e-11  |g|= 4.6e-06  |ddm|= 8.55e-06
    CPU time for scf_cycle      7.53 sec, wall time      0.52 sec
exp = [2.61826559e+04 7.61752185e+03 3.61735090e+03 1.59782437e+03
 3.82851181e+02 1.08120067e+02 3.48360524e+01 5.88172564e+00
 1.71766038e+00 4.24524722e-01 1.36278322e+03 6.64745585e+02
 3.00961540e+02 3.14041885e+02 6.16226347e+01 7.33112124e+00
 2.02384260e+01 7.71152350e-01 2.80770606e+00 2.18165814e-01]
E = -526.6593885415269
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:55:49 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558841        1
[INPUT] 0    0    [1    /1   ]  7617.52185248        1
[INPUT] 0    0    [1    /1   ]  3617.35089552        1
[INPUT] 0    0    [1    /1   ]  1597.82437048        1
[INPUT] 0    0    [1    /1   ]  382.851180903        1
[INPUT] 0    0    [1    /1   ]  108.120067463        1
[INPUT] 0    0    [1    /1   ]  34.8360523849        1
[INPUT] 0    0    [1    /1   ]  5.88172564074        1
[INPUT] 0    0    [1    /1   ]  1.71766037722        1
[INPUT] 0    0    [1    /1   ]  0.424524722259       1
[INPUT] 1    0    [1    /1   ]  1362.78321594        1
[INPUT] 1    0    [1    /1   ]  664.745585275        1
[INPUT] 1    0    [1    /1   ]  300.961540036        1
[INPUT] 1    0    [1    /1   ]  314.04188469         1
[INPUT] 1    0    [1    /1   ]  61.6226347313        1
[INPUT] 1    0    [1    /1   ]  7.3311212374         1
[INPUT] 1    0    [1    /1   ]  20.238426025         1
[INPUT] 1    0    [1    /1   ]  0.771152349992       1
[INPUT] 1    0    [1    /1   ]  2.80770605795        1
[INPUT] 1    0    [1    /1   ]  0.218165813851       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.655884088483, 1.0]], [0, [7617.5218524840575, 1.0]], [0, [3617.3508955231136, 1.0]], [0, [1597.824370479923, 1.0]], [0, [382.8511809031264, 1.0]], [0, [108.12006746314853, 1.0]], [0, [34.836052384926035, 1.0]], [0, [5.881725640736037, 1.0]], [0, [1.7176603772232186, 1.0]], [0, [0.4245247222587786, 1.0]], [1, [1362.7832159389259, 1.0]], [1, [664.7455852754455, 1.0]], [1, [300.9615400358619, 1.0]], [1, [314.04188469044186, 1.0]], [1, [61.62263473130126, 1.0]], [1, [7.331121237400119, 1.0]], [1, [20.23842602503346, 1.0]], [1, [0.7711523499920457, 1.0]], [1, [2.8077060579451905, 1.0]], [1, [0.2181658138507286, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65588409]
bas 1, expnt(s) = [7617.52185248]
bas 2, expnt(s) = [3617.35089552]
bas 3, expnt(s) = [1597.82437048]
bas 4, expnt(s) = [382.8511809]
bas 5, expnt(s) = [108.12006746]
bas 6, expnt(s) = [34.83605238]
bas 7, expnt(s) = [5.88172564]
bas 8, expnt(s) = [1.71766038]
bas 9, expnt(s) = [0.42452472]
bas 10, expnt(s) = [1362.78321594]
bas 11, expnt(s) = [664.74558528]
bas 12, expnt(s) = [300.96154004]
bas 13, expnt(s) = [314.04188469]
bas 14, expnt(s) = [61.62263473]
bas 15, expnt(s) = [7.33112124]
bas 16, expnt(s) = [20.23842603]
bas 17, expnt(s) = [0.77115235]
bas 18, expnt(s) = [2.80770606]
bas 19, expnt(s) = [0.21816581]
CPU time:       232.70
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752185e+03 2.06003835e+03
 3.61735090e+03 1.17844143e+03 1.59782437e+03 6.38501328e+02
 3.82851181e+02 2.18669150e+02 1.08120067e+02 8.47119649e+01
 3.48360524e+01 3.62273632e+01 5.88172564e+00 9.54209193e+00
 1.71766038e+00 3.79068762e+00 4.24524722e-01 1.32874690e+00
 1.36278322e+03 2.41556019e+04 6.64745585e+02 9.84699505e+03
 3.00961540e+02 3.65698470e+03 3.14041885e+02 3.85672667e+03
 6.16226347e+01 5.03685816e+02 7.33112124e+00 3.51922792e+01
 2.02384260e+01 1.25229114e+02 7.71152350e-01 2.10818940e+00
 2.80770606e+00 1.06028823e+01 2.18165814e-01 4.34978474e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.978582801800613
cond(S) = 101101.71732750903
E1 = -729.4607969931428  E_coul = 203.23728663943425
init E= -526.223510353709
    CPU time for initialize scf      7.51 sec, wall time      0.36 sec
  HOMO = -0.554658313243954  LUMO = 1.00975856491313
  mo_energy =
[-1.18317200e+02 -1.21872093e+01 -9.44174507e+00 -9.44174507e+00
 -9.44174507e+00 -1.21810911e+00 -5.54658313e-01 -5.54658313e-01
 -5.54658313e-01  1.00975856e+00  1.00975856e+00  1.00975856e+00
  4.52696933e+00  7.31038309e+00  7.31038309e+00  7.31038309e+00
  3.34855121e+01  3.34855121e+01  3.34855121e+01  8.78532702e+01
  1.29115602e+02  1.29115602e+02  1.29115602e+02  4.83526374e+02
  4.83526374e+02  4.83526374e+02  5.69980946e+02  1.33542364e+03
  1.33542364e+03  1.33542364e+03  2.64050466e+03  3.02973763e+03
  3.02973763e+03  3.02973763e+03  6.65029562e+03  6.65029562e+03
  6.65029562e+03  9.04736614e+03  2.54037846e+04  7.61470987e+04]
E1 = -728.0787754203135  E_coul = 201.41999127080115
cycle= 1 E= -526.658784149512  delta_E= -0.435  |g|= 0.185  |ddm|= 0.295
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.53738
diis-c [-0.28877727  1.        ]
  HOMO = -0.57822792528658  LUMO = 0.994882724480434
  mo_energy =
[-1.18610135e+02 -1.23060840e+01 -9.57258128e+00 -9.57258128e+00
 -9.57258128e+00 -1.25112802e+00 -5.78227925e-01 -5.78227925e-01
 -5.78227925e-01  9.94882724e-01  9.94882724e-01  9.94882724e-01
  4.46378984e+00  7.23559282e+00  7.23559282e+00  7.23559282e+00
  3.33485561e+01  3.33485561e+01  3.33485561e+01  8.76521571e+01
  1.28903139e+02  1.28903139e+02  1.28903139e+02  4.83235467e+02
  4.83235467e+02  4.83235467e+02  5.69651936e+02  1.33507680e+03
  1.33507680e+03  1.33507680e+03  2.64002414e+03  3.02932513e+03
  3.02932513e+03  3.02932513e+03  6.64977061e+03  6.64977061e+03
  6.64977061e+03  9.04676606e+03  2.54030910e+04  7.61463154e+04]
E1 = -728.5481787643349  E_coul = 201.88883100494044
cycle= 2 E= -526.659347759394  delta_E= -0.000564  |g|= 0.0337  |ddm|= 0.0443
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0680731
diis-c [-0.00273313  0.07537377  0.92462623]
  HOMO = -0.571537393323373  LUMO = 0.999828048908068
  mo_energy =
[-1.18550938e+02 -1.22748781e+01 -9.53991280e+00 -9.53991280e+00
 -9.53991280e+00 -1.24278980e+00 -5.71537393e-01 -5.71537393e-01
 -5.71537393e-01  9.99828049e-01  9.99828049e-01  9.99828049e-01
  4.48056904e+00  7.25421711e+00  7.25421711e+00  7.25421711e+00
  3.33817346e+01  3.33817346e+01  3.33817346e+01  8.76998441e+01
  1.28951145e+02  1.28951145e+02  1.28951145e+02  4.83293895e+02
  4.83293895e+02  4.83293895e+02  5.69712760e+02  1.33513908e+03
  1.33513908e+03  1.33513908e+03  2.64008959e+03  3.02938954e+03
  3.02938954e+03  3.02938954e+03  6.64983664e+03  6.64983664e+03
  6.64983664e+03  9.04683285e+03  2.54031583e+04  7.61463829e+04]
E1 = -728.429505349785  E_coul = 201.7701180245888
cycle= 3 E= -526.659387325196  delta_E= -3.96e-05  |g|= 0.00534  |ddm|= 0.0124
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0112037
diis-c [-5.52504482e-07 -1.24009756e-03  1.36308096e-01  8.64932002e-01]
  HOMO = -0.572703981388312  LUMO = 0.998974810656435
  mo_energy =
[-1.18559396e+02 -1.22796420e+01 -9.54498532e+00 -9.54498532e+00
 -9.54498532e+00 -1.24422258e+00 -5.72703981e-01 -5.72703981e-01
 -5.72703981e-01  9.98974811e-01  9.98974811e-01  9.98974811e-01
  4.47785308e+00  7.25115903e+00  7.25115903e+00  7.25115903e+00
  3.33766309e+01  3.33766309e+01  3.33766309e+01  8.76929267e+01
  1.28944116e+02  1.28944116e+02  1.28944116e+02  4.83285541e+02
  4.83285541e+02  4.83285541e+02  5.69704073e+02  1.33513020e+03
  1.33513020e+03  1.33513020e+03  2.64008014e+03  3.02938031e+03
  3.02938031e+03  3.02938031e+03  6.64982706e+03  6.64982706e+03
  6.64982706e+03  9.04682308e+03  2.54031484e+04  7.61463729e+04]
E1 = -728.4474088166214  E_coul = 201.78802027539214
cycle= 4 E= -526.659388541229  delta_E= -1.22e-06  |g|= 6.19e-05  |ddm|= 0.00188
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.63241e-05
diis-c [-3.50894428e-09  1.36674240e-05 -3.06933042e-03 -1.67373787e-02
  1.01979304e+00]
  HOMO = -0.572672841119053  LUMO = 0.998996826477471
  mo_energy =
[-1.18559292e+02 -1.22795374e+01 -9.54488686e+00 -9.54488686e+00
 -9.54488686e+00 -1.24418252e+00 -5.72672841e-01 -5.72672841e-01
 -5.72672841e-01  9.98996826e-01  9.98996826e-01  9.98996826e-01
  4.47792142e+00  7.25122909e+00  7.25122909e+00  7.25122909e+00
  3.33767254e+01  3.33767254e+01  3.33767254e+01  8.76930327e+01
  1.28944219e+02  1.28944219e+02  1.28944219e+02  4.83285644e+02
  4.83285644e+02  4.83285644e+02  5.69704172e+02  1.33513030e+03
  1.33513030e+03  1.33513030e+03  2.64008022e+03  3.02938040e+03
  3.02938040e+03  3.02938040e+03  6.64982715e+03  6.64982715e+03
  6.64982715e+03  9.04682316e+03  2.54031484e+04  7.61463730e+04]
E1 = -728.4470931387882  E_coul = 201.7877045972745
cycle= 5 E= -526.659388541514  delta_E= -2.84e-10  |g|= 1.48e-05  |ddm|= 4.47e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.4470931387882  E_coul = 201.7877045972745
  HOMO = -0.572679182134893  LUMO = 0.998992256154297
  mo_energy =
[-1.18559324e+02 -1.22795594e+01 -9.54491019e+00 -9.54491019e+00
 -9.54491019e+00 -1.24419020e+00 -5.72679182e-01 -5.72679182e-01
 -5.72679182e-01  9.98992256e-01  9.98992256e-01  9.98992256e-01
  4.47790787e+00  7.25121371e+00  7.25121371e+00  7.25121371e+00
  3.33767024e+01  3.33767024e+01  3.33767024e+01  8.76930048e+01
  1.28944191e+02  1.28944191e+02  1.28944191e+02  4.83285612e+02
  4.83285612e+02  4.83285612e+02  5.69704140e+02  1.33513027e+03
  1.33513027e+03  1.33513027e+03  2.64008019e+03  3.02938037e+03
  3.02938037e+03  3.02938037e+03  6.64982711e+03  6.64982711e+03
  6.64982711e+03  9.04682313e+03  2.54031484e+04  7.61463729e+04]
E1 = -728.4471715593628  E_coul = 201.78778301783586
Extra cycle  E= -526.659388541527  delta_E= -1.33e-11  |g|= 4.6e-06  |ddm|= 8.55e-06
    CPU time for scf_cycle      7.69 sec, wall time      0.54 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 101101.71732750903
E1 = -728.4471715593628  E_coul = 201.78778301783586
init E= -526.659388541527
    CPU time for initialize scf     16.32 sec, wall time      0.76 sec
  HOMO = -0.572677725688309  LUMO = 0.99899331450937
  mo_energy =
[-1.18559315e+02 -1.22795536e+01 -9.54490422e+00 -9.54490422e+00
 -9.54490422e+00 -1.24418838e+00 -5.72677726e-01 -5.72677726e-01
 -5.72677726e-01  9.98993315e-01  9.98993315e-01  9.98993315e-01
  4.47791124e+00  7.25121741e+00  7.25121741e+00  7.25121741e+00
  3.33767084e+01  3.33767084e+01  3.33767084e+01  8.76930127e+01
  1.28944199e+02  1.28944199e+02  1.28944199e+02  4.83285622e+02
  4.83285622e+02  4.83285622e+02  5.69704149e+02  1.33513028e+03
  1.33513028e+03  1.33513028e+03  2.64008020e+03  3.02938038e+03
  3.02938038e+03  3.02938038e+03  6.64982712e+03  6.64982712e+03
  6.64982712e+03  9.04682314e+03  2.54031484e+04  7.61463729e+04]
E1 = -728.4471508175187  E_coul = 201.78776227599099
cycle= 1 E= -526.659388541528  delta_E= -7.96e-13  |g|= 1.29e-06  |ddm|= 2.32e-06
    CPU time for cycle= 1      0.04 sec, wall time      0.02 sec
E1 = -728.4471508175187  E_coul = 201.78776227599099
  HOMO = -0.572678092548821  LUMO = 0.998993046795296
  mo_energy =
[-1.18559317e+02 -1.22795551e+01 -9.54490580e+00 -9.54490580e+00
 -9.54490580e+00 -1.24418883e+00 -5.72678093e-01 -5.72678093e-01
 -5.72678093e-01  9.98993047e-01  9.98993047e-01  9.98993047e-01
  4.47791039e+00  7.25121645e+00  7.25121645e+00  7.25121645e+00
  3.33767068e+01  3.33767068e+01  3.33767068e+01  8.76930106e+01
  1.28944197e+02  1.28944197e+02  1.28944197e+02  4.83285619e+02
  4.83285619e+02  4.83285619e+02  5.69704147e+02  1.33513027e+03
  1.33513027e+03  1.33513027e+03  2.64008020e+03  3.02938038e+03
  3.02938038e+03  3.02938038e+03  6.64982712e+03  6.64982712e+03
  6.64982712e+03  9.04682314e+03  2.54031484e+04  7.61463729e+04]
E1 = -728.4471563806811  E_coul = 201.7877678391533
Extra cycle  E= -526.659388541528  delta_E= -1.14e-13  |g|= 3.53e-07  |ddm|= 5.91e-07
    CPU time for scf_cycle     16.44 sec, wall time      0.87 sec
exp = [2.61826559e+04 7.61752185e+03 3.61735090e+03 1.59782437e+03
 3.82851181e+02 1.08120067e+02 3.48360524e+01 5.88172564e+00
 1.71766038e+00 4.24524722e-01 1.36278322e+03 6.64745585e+02
 3.00961540e+02 3.14041885e+02 6.16226347e+01 7.33112124e+00
 2.02384260e+01 7.71152350e-01 2.80770606e+00 2.18165814e-01]
grad_E = [-1.51475115e-06  3.28379920e-06 -1.57041471e-06  6.82987430e-05
  1.14919114e-05 -5.91646499e-04 -9.46062192e-04  2.71942451e-02
 -8.08085007e-02  1.94780624e-01 -5.05676114e-07  5.01991965e-06
  2.36953704e-05  2.04293901e-05 -2.80843803e-05 -3.86292482e-04
  8.99330495e-05  2.80863035e-02  1.36894140e-04 -1.01987917e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:55:54 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6559291        1
[INPUT] 0    0    [1    /1   ]  7617.52175423        1
[INPUT] 0    0    [1    /1   ]  3617.35093995        1
[INPUT] 0    0    [1    /1   ]  1597.82231536        1
[INPUT] 0    0    [1    /1   ]  382.851176293        1
[INPUT] 0    0    [1    /1   ]  108.12237471         1
[INPUT] 0    0    [1    /1   ]  34.8819814196        1
[INPUT] 0    0    [1    /1   ]  7.27860333559        1
[INPUT] 0    0    [1    /1   ]  2.97407697284        1
[INPUT] 0    0    [1    /1   ]  0.407105352656       1
[INPUT] 1    0    [1    /1   ]  1362.783231          1
[INPUT] 1    0    [1    /1   ]  664.745436012        1
[INPUT] 1    0    [1    /1   ]  300.960835656        1
[INPUT] 1    0    [1    /1   ]  314.041277388        1
[INPUT] 1    0    [1    /1   ]  61.6233604389        1
[INPUT] 1    0    [1    /1   ]  7.33642829546        1
[INPUT] 1    0    [1    /1   ]  20.2364288095        1
[INPUT] 1    0    [1    /1   ]  0.768790558201       1
[INPUT] 1    0    [1    /1   ]  2.80041713581        1
[INPUT] 1    0    [1    /1   ]  0.216767299242       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.655929054985, 1.0]], [0, [7617.521754233162, 1.0]], [0, [3617.3509399538343, 1.0]], [0, [1597.822315361564, 1.0]], [0, [382.8511762928453, 1.0]], [0, [108.12237471034665, 1.0]], [0, [34.88198141960143, 1.0]], [0, [7.278603335586222, 1.0]], [0, [2.9740769728350136, 1.0]], [0, [0.40710535265612025, 1.0]], [1, [1362.7832309967068, 1.0]], [1, [664.7454360120344, 1.0]], [1, [300.96083565564606, 1.0]], [1, [314.04127738845415, 1.0]], [1, [61.62336043889624, 1.0]], [1, [7.336428295458682, 1.0]], [1, [20.236428809549242, 1.0]], [1, [0.7687905582013675, 1.0]], [1, [2.800417135808252, 1.0]], [1, [0.21676729924150298, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65592905]
bas 1, expnt(s) = [7617.52175423]
bas 2, expnt(s) = [3617.35093995]
bas 3, expnt(s) = [1597.82231536]
bas 4, expnt(s) = [382.85117629]
bas 5, expnt(s) = [108.12237471]
bas 6, expnt(s) = [34.88198142]
bas 7, expnt(s) = [7.27860334]
bas 8, expnt(s) = [2.97407697]
bas 9, expnt(s) = [0.40710535]
bas 10, expnt(s) = [1362.783231]
bas 11, expnt(s) = [664.74543601]
bas 12, expnt(s) = [300.96083566]
bas 13, expnt(s) = [314.04127739]
bas 14, expnt(s) = [61.62336044]
bas 15, expnt(s) = [7.3364283]
bas 16, expnt(s) = [20.23642881]
bas 17, expnt(s) = [0.76879056]
bas 18, expnt(s) = [2.80041714]
bas 19, expnt(s) = [0.2167673]
CPU time:       261.78
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026288e+03 7.61752175e+03 2.06003833e+03
 3.61735094e+03 1.17844144e+03 1.59782232e+03 6.38500712e+02
 3.82851176e+02 2.18669148e+02 1.08122375e+02 8.47133207e+01
 3.48819814e+01 3.62631799e+01 7.27860334e+00 1.11956951e+01
 2.97407697e+00 5.72175394e+00 4.07105353e-01 1.28764200e+00
 1.36278323e+03 2.41556022e+04 6.64745436e+02 9.84699229e+03
 3.00960836e+02 3.65697400e+03 3.14041277e+02 3.85671735e+03
 6.16233604e+01 5.03693231e+02 7.33642830e+00 3.52241271e+01
 2.02364288e+01 1.25213667e+02 7.68790558e-01 2.10012161e+00
 2.80041714e+00 1.05684866e+01 2.16767299e-01 4.31495828e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98233833570888
cond(S) = 102121.68719074178
E1 = -729.4334720555447  E_coul = 203.1785584522197
init E= -526.254913603325
    CPU time for initialize scf      0.66 sec, wall time      0.05 sec
  HOMO = -0.554800804416328  LUMO = 1.00309431748705
  mo_energy =
[-1.18327885e+02 -1.22012898e+01 -9.44740507e+00 -9.44740507e+00
 -9.44740507e+00 -1.22444234e+00 -5.54800804e-01 -5.54800804e-01
 -5.54800804e-01  1.00309432e+00  1.00309432e+00  1.00309432e+00
  7.28270252e+00  7.28270252e+00  7.28270252e+00  8.66644219e+00
  3.34539217e+01  3.34539217e+01  3.34539217e+01  9.91963866e+01
  1.29088398e+02  1.29088398e+02  1.29088398e+02  4.83502526e+02
  4.83502526e+02  4.83502526e+02  5.80082106e+02  1.33540164e+03
  1.33540164e+03  1.33540164e+03  2.64918502e+03  3.02971463e+03
  3.02971463e+03  3.02971463e+03  6.65027239e+03  6.65027239e+03
  6.65027239e+03  9.05528373e+03  2.54112648e+04  7.61540618e+04]
E1 = -728.0008481644838  E_coul = 201.30381100866694
cycle= 1 E= -526.697037155817  delta_E= -0.442  |g|= 0.184  |ddm|= 0.326
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538306
diis-c [-0.28977342  1.        ]
  HOMO = -0.581324179941225  LUMO = 0.986000933869672
  mo_energy =
[-1.18623583e+02 -1.23257661e+01 -9.58133602e+00 -9.58133602e+00
 -9.58133602e+00 -1.25966123e+00 -5.81324180e-01 -5.81324180e-01
 -5.81324180e-01  9.86000934e-01  9.86000934e-01  9.86000934e-01
  7.20456946e+00  7.20456946e+00  7.20456946e+00  8.57783384e+00
  3.33132315e+01  3.33132315e+01  3.33132315e+01  9.89926952e+01
  1.28873450e+02  1.28873450e+02  1.28873450e+02  4.83208491e+02
  4.83208491e+02  4.83208491e+02  5.79748912e+02  1.33504967e+03
  1.33504967e+03  1.33504967e+03  2.64869786e+03  3.02929616e+03
  3.02929616e+03  3.02929616e+03  6.64974008e+03  6.64974008e+03
  6.64974008e+03  9.05467575e+03  2.54105625e+04  7.61532693e+04]
E1 = -728.4662630260017  E_coul = 201.76865184437844
cycle= 2 E= -526.697611181623  delta_E= -0.000574  |g|= 0.0334  |ddm|= 0.0394
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0672998
diis-c [-0.00268934  0.07412244  0.92587756]
  HOMO = -0.57460971591525  LUMO = 0.990984009559279
  mo_energy =
[-1.18564856e+02 -1.22948691e+01 -9.54902276e+00 -9.54902276e+00
 -9.54902276e+00 -1.25111101e+00 -5.74609716e-01 -5.74609716e-01
 -5.74609716e-01  9.90984010e-01  9.90984010e-01  9.90984010e-01
  7.22307752e+00  7.22307752e+00  7.22307752e+00  8.60069737e+00
  3.33461267e+01  3.33461267e+01  3.33461267e+01  9.90400480e+01
  1.28921046e+02  1.28921046e+02  1.28921046e+02  4.83266475e+02
  4.83266475e+02  4.83266475e+02  5.79809147e+02  1.33511146e+03
  1.33511146e+03  1.33511146e+03  2.64876273e+03  3.02936003e+03
  3.02936003e+03  3.02936003e+03  6.64980554e+03  6.64980554e+03
  6.64980554e+03  9.05474195e+03  2.54106292e+04  7.61533362e+04]
E1 = -728.3573518512843  E_coul = 201.65970472600003
cycle= 3 E= -526.697647125284  delta_E= -3.59e-05  |g|= 0.00495  |ddm|= 0.0107
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0105862
diis-c [-3.71241426e-07 -1.12368367e-03  1.31354891e-01  8.69768792e-01]
  HOMO = -0.575607890133312  LUMO = 0.990254229921298
  mo_energy =
[-1.18572676e+02 -1.22991306e+01 -9.55354870e+00 -9.55354870e+00
 -9.55354870e+00 -1.25234062e+00 -5.75607890e-01 -5.75607890e-01
 -5.75607890e-01  9.90254230e-01  9.90254230e-01  9.90254230e-01
  7.22041422e+00  7.22041422e+00  7.22041422e+00  8.59756290e+00
  3.33415485e+01  3.33415485e+01  3.33415485e+01  9.90337160e+01
  1.28914624e+02  1.28914624e+02  1.28914624e+02  4.83258753e+02
  4.83258753e+02  4.83258753e+02  5.79801107e+02  1.33510322e+03
  1.33510322e+03  1.33510322e+03  2.64875392e+03  3.02935145e+03
  3.02935145e+03  3.02935145e+03  6.64979661e+03  6.64979661e+03
  6.64979661e+03  9.05473283e+03  2.54106199e+04  7.61533268e+04]
E1 = -728.3725197060311  E_coul = 201.67487165510022
cycle= 4 E= -526.697648050931  delta_E= -9.26e-07  |g|= 4.61e-05  |ddm|= 0.00144
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=7.54069e-05
diis-c [-1.61134473e-09  4.34871395e-05 -6.47207926e-03 -4.80138126e-02
  1.05444240e+00]
  HOMO = -0.575590680440424  LUMO = 0.990266685103224
  mo_energy =
[-1.18572646e+02 -1.22990809e+01 -9.55350705e+00 -9.55350705e+00
 -9.55350705e+00 -1.25231575e+00 -5.75590680e-01 -5.75590680e-01
 -5.75590680e-01  9.90266685e-01  9.90266685e-01  9.90266685e-01
  7.22044897e+00  7.22044897e+00  7.22044897e+00  8.59761120e+00
  3.33415881e+01  3.33415881e+01  3.33415881e+01  9.90337566e+01
  1.28914661e+02  1.28914661e+02  1.28914661e+02  4.83258783e+02
  4.83258783e+02  4.83258783e+02  5.79801132e+02  1.33510324e+03
  1.33510324e+03  1.33510324e+03  2.64875393e+03  3.02935146e+03
  3.02935146e+03  3.02935146e+03  6.64979662e+03  6.64979662e+03
  6.64979662e+03  9.05473283e+03  2.54106199e+04  7.61533268e+04]
E1 = -728.3724276252208  E_coul = 201.674779574215
cycle= 5 E= -526.697648051006  delta_E= -7.49e-11  |g|= 9.44e-06  |ddm|= 2.56e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3724276252208  E_coul = 201.674779574215
  HOMO = -0.575594786289692  LUMO = 0.990263733827993
  mo_energy =
[-1.18572667e+02 -1.22990954e+01 -9.55352237e+00 -9.55352237e+00
 -9.55352237e+00 -1.25232078e+00 -5.75594786e-01 -5.75594786e-01
 -5.75594786e-01  9.90263734e-01  9.90263734e-01  9.90263734e-01
  7.22043897e+00  7.22043897e+00  7.22043897e+00  8.59760003e+00
  3.33415731e+01  3.33415731e+01  3.33415731e+01  9.90337383e+01
  1.28914642e+02  1.28914642e+02  1.28914642e+02  4.83258763e+02
  4.83258763e+02  4.83258763e+02  5.79801111e+02  1.33510322e+03
  1.33510322e+03  1.33510322e+03  2.64875391e+03  3.02935144e+03
  3.02935144e+03  3.02935144e+03  6.64979660e+03  6.64979660e+03
  6.64979660e+03  9.05473281e+03  2.54106199e+04  7.61533268e+04]
E1 = -728.372475660273  E_coul = 201.6748276092601
Extra cycle  E= -526.697648051013  delta_E= -7.16e-12  |g|= 2.85e-06  |ddm|= 4.93e-06
    CPU time for scf_cycle      0.89 sec, wall time      0.28 sec
exp = [2.61826559e+04 7.61752175e+03 3.61735094e+03 1.59782232e+03
 3.82851176e+02 1.08122375e+02 3.48819814e+01 7.27860334e+00
 2.97407697e+00 4.07105353e-01 1.36278323e+03 6.64745436e+02
 3.00960836e+02 3.14041277e+02 6.16233604e+01 7.33642830e+00
 2.02364288e+01 7.68790558e-01 2.80041714e+00 2.16767299e-01]
E = -526.697648051013
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:55:55 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6559291        1
[INPUT] 0    0    [1    /1   ]  7617.52175423        1
[INPUT] 0    0    [1    /1   ]  3617.35093995        1
[INPUT] 0    0    [1    /1   ]  1597.82231536        1
[INPUT] 0    0    [1    /1   ]  382.851176293        1
[INPUT] 0    0    [1    /1   ]  108.12237471         1
[INPUT] 0    0    [1    /1   ]  34.8819814196        1
[INPUT] 0    0    [1    /1   ]  7.27860333559        1
[INPUT] 0    0    [1    /1   ]  2.97407697284        1
[INPUT] 0    0    [1    /1   ]  0.407105352656       1
[INPUT] 1    0    [1    /1   ]  1362.783231          1
[INPUT] 1    0    [1    /1   ]  664.745436012        1
[INPUT] 1    0    [1    /1   ]  300.960835656        1
[INPUT] 1    0    [1    /1   ]  314.041277388        1
[INPUT] 1    0    [1    /1   ]  61.6233604389        1
[INPUT] 1    0    [1    /1   ]  7.33642829546        1
[INPUT] 1    0    [1    /1   ]  20.2364288095        1
[INPUT] 1    0    [1    /1   ]  0.768790558201       1
[INPUT] 1    0    [1    /1   ]  2.80041713581        1
[INPUT] 1    0    [1    /1   ]  0.216767299242       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.655929054985, 1.0]], [0, [7617.521754233162, 1.0]], [0, [3617.3509399538343, 1.0]], [0, [1597.822315361564, 1.0]], [0, [382.8511762928453, 1.0]], [0, [108.12237471034665, 1.0]], [0, [34.88198141960143, 1.0]], [0, [7.278603335586222, 1.0]], [0, [2.9740769728350136, 1.0]], [0, [0.40710535265612025, 1.0]], [1, [1362.7832309967068, 1.0]], [1, [664.7454360120344, 1.0]], [1, [300.96083565564606, 1.0]], [1, [314.04127738845415, 1.0]], [1, [61.62336043889624, 1.0]], [1, [7.336428295458682, 1.0]], [1, [20.236428809549242, 1.0]], [1, [0.7687905582013675, 1.0]], [1, [2.800417135808252, 1.0]], [1, [0.21676729924150298, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65592905]
bas 1, expnt(s) = [7617.52175423]
bas 2, expnt(s) = [3617.35093995]
bas 3, expnt(s) = [1597.82231536]
bas 4, expnt(s) = [382.85117629]
bas 5, expnt(s) = [108.12237471]
bas 6, expnt(s) = [34.88198142]
bas 7, expnt(s) = [7.27860334]
bas 8, expnt(s) = [2.97407697]
bas 9, expnt(s) = [0.40710535]
bas 10, expnt(s) = [1362.783231]
bas 11, expnt(s) = [664.74543601]
bas 12, expnt(s) = [300.96083566]
bas 13, expnt(s) = [314.04127739]
bas 14, expnt(s) = [61.62336044]
bas 15, expnt(s) = [7.3364283]
bas 16, expnt(s) = [20.23642881]
bas 17, expnt(s) = [0.76879056]
bas 18, expnt(s) = [2.80041714]
bas 19, expnt(s) = [0.2167673]
CPU time:       262.74
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026288e+03 7.61752175e+03 2.06003833e+03
 3.61735094e+03 1.17844144e+03 1.59782232e+03 6.38500712e+02
 3.82851176e+02 2.18669148e+02 1.08122375e+02 8.47133207e+01
 3.48819814e+01 3.62631799e+01 7.27860334e+00 1.11956951e+01
 2.97407697e+00 5.72175394e+00 4.07105353e-01 1.28764200e+00
 1.36278323e+03 2.41556022e+04 6.64745436e+02 9.84699229e+03
 3.00960836e+02 3.65697400e+03 3.14041277e+02 3.85671735e+03
 6.16233604e+01 5.03693231e+02 7.33642830e+00 3.52241271e+01
 2.02364288e+01 1.25213667e+02 7.68790558e-01 2.10012161e+00
 2.80041714e+00 1.05684866e+01 2.16767299e-01 4.31495828e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98233833570888
cond(S) = 102121.68719074178
E1 = -729.4334720555447  E_coul = 203.1785584522197
init E= -526.254913603325
    CPU time for initialize scf      4.09 sec, wall time      0.20 sec
  HOMO = -0.554800804416328  LUMO = 1.00309431748705
  mo_energy =
[-1.18327885e+02 -1.22012898e+01 -9.44740507e+00 -9.44740507e+00
 -9.44740507e+00 -1.22444234e+00 -5.54800804e-01 -5.54800804e-01
 -5.54800804e-01  1.00309432e+00  1.00309432e+00  1.00309432e+00
  7.28270252e+00  7.28270252e+00  7.28270252e+00  8.66644219e+00
  3.34539217e+01  3.34539217e+01  3.34539217e+01  9.91963866e+01
  1.29088398e+02  1.29088398e+02  1.29088398e+02  4.83502526e+02
  4.83502526e+02  4.83502526e+02  5.80082106e+02  1.33540164e+03
  1.33540164e+03  1.33540164e+03  2.64918502e+03  3.02971463e+03
  3.02971463e+03  3.02971463e+03  6.65027239e+03  6.65027239e+03
  6.65027239e+03  9.05528373e+03  2.54112648e+04  7.61540618e+04]
E1 = -728.0008481644838  E_coul = 201.30381100866694
cycle= 1 E= -526.697037155817  delta_E= -0.442  |g|= 0.184  |ddm|= 0.326
    CPU time for cycle= 1      0.06 sec, wall time      0.03 sec
diis-norm(errvec)=0.538306
diis-c [-0.28977342  1.        ]
  HOMO = -0.581324179941225  LUMO = 0.986000933869672
  mo_energy =
[-1.18623583e+02 -1.23257661e+01 -9.58133602e+00 -9.58133602e+00
 -9.58133602e+00 -1.25966123e+00 -5.81324180e-01 -5.81324180e-01
 -5.81324180e-01  9.86000934e-01  9.86000934e-01  9.86000934e-01
  7.20456946e+00  7.20456946e+00  7.20456946e+00  8.57783384e+00
  3.33132315e+01  3.33132315e+01  3.33132315e+01  9.89926952e+01
  1.28873450e+02  1.28873450e+02  1.28873450e+02  4.83208491e+02
  4.83208491e+02  4.83208491e+02  5.79748912e+02  1.33504967e+03
  1.33504967e+03  1.33504967e+03  2.64869786e+03  3.02929616e+03
  3.02929616e+03  3.02929616e+03  6.64974008e+03  6.64974008e+03
  6.64974008e+03  9.05467575e+03  2.54105625e+04  7.61532693e+04]
E1 = -728.4662630260017  E_coul = 201.76865184437844
cycle= 2 E= -526.697611181623  delta_E= -0.000574  |g|= 0.0334  |ddm|= 0.0394
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0672998
diis-c [-0.00268934  0.07412244  0.92587756]
  HOMO = -0.57460971591525  LUMO = 0.990984009559279
  mo_energy =
[-1.18564856e+02 -1.22948691e+01 -9.54902276e+00 -9.54902276e+00
 -9.54902276e+00 -1.25111101e+00 -5.74609716e-01 -5.74609716e-01
 -5.74609716e-01  9.90984010e-01  9.90984010e-01  9.90984010e-01
  7.22307752e+00  7.22307752e+00  7.22307752e+00  8.60069737e+00
  3.33461267e+01  3.33461267e+01  3.33461267e+01  9.90400480e+01
  1.28921046e+02  1.28921046e+02  1.28921046e+02  4.83266475e+02
  4.83266475e+02  4.83266475e+02  5.79809147e+02  1.33511146e+03
  1.33511146e+03  1.33511146e+03  2.64876273e+03  3.02936003e+03
  3.02936003e+03  3.02936003e+03  6.64980554e+03  6.64980554e+03
  6.64980554e+03  9.05474195e+03  2.54106292e+04  7.61533362e+04]
E1 = -728.3573518512843  E_coul = 201.65970472600003
cycle= 3 E= -526.697647125284  delta_E= -3.59e-05  |g|= 0.00495  |ddm|= 0.0107
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0105862
diis-c [-3.71241426e-07 -1.12368367e-03  1.31354891e-01  8.69768792e-01]
  HOMO = -0.575607890133312  LUMO = 0.990254229921298
  mo_energy =
[-1.18572676e+02 -1.22991306e+01 -9.55354870e+00 -9.55354870e+00
 -9.55354870e+00 -1.25234062e+00 -5.75607890e-01 -5.75607890e-01
 -5.75607890e-01  9.90254230e-01  9.90254230e-01  9.90254230e-01
  7.22041422e+00  7.22041422e+00  7.22041422e+00  8.59756290e+00
  3.33415485e+01  3.33415485e+01  3.33415485e+01  9.90337160e+01
  1.28914624e+02  1.28914624e+02  1.28914624e+02  4.83258753e+02
  4.83258753e+02  4.83258753e+02  5.79801107e+02  1.33510322e+03
  1.33510322e+03  1.33510322e+03  2.64875392e+03  3.02935145e+03
  3.02935145e+03  3.02935145e+03  6.64979661e+03  6.64979661e+03
  6.64979661e+03  9.05473283e+03  2.54106199e+04  7.61533268e+04]
E1 = -728.3725197060311  E_coul = 201.67487165510022
cycle= 4 E= -526.697648050931  delta_E= -9.26e-07  |g|= 4.61e-05  |ddm|= 0.00144
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.54069e-05
diis-c [-1.61134473e-09  4.34871395e-05 -6.47207926e-03 -4.80138126e-02
  1.05444240e+00]
  HOMO = -0.575590680440424  LUMO = 0.990266685103224
  mo_energy =
[-1.18572646e+02 -1.22990809e+01 -9.55350705e+00 -9.55350705e+00
 -9.55350705e+00 -1.25231575e+00 -5.75590680e-01 -5.75590680e-01
 -5.75590680e-01  9.90266685e-01  9.90266685e-01  9.90266685e-01
  7.22044897e+00  7.22044897e+00  7.22044897e+00  8.59761120e+00
  3.33415881e+01  3.33415881e+01  3.33415881e+01  9.90337566e+01
  1.28914661e+02  1.28914661e+02  1.28914661e+02  4.83258783e+02
  4.83258783e+02  4.83258783e+02  5.79801132e+02  1.33510324e+03
  1.33510324e+03  1.33510324e+03  2.64875393e+03  3.02935146e+03
  3.02935146e+03  3.02935146e+03  6.64979662e+03  6.64979662e+03
  6.64979662e+03  9.05473283e+03  2.54106199e+04  7.61533268e+04]
E1 = -728.3724276252208  E_coul = 201.674779574215
cycle= 5 E= -526.697648051006  delta_E= -7.49e-11  |g|= 9.44e-06  |ddm|= 2.56e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3724276252208  E_coul = 201.674779574215
  HOMO = -0.575594786289692  LUMO = 0.990263733827993
  mo_energy =
[-1.18572667e+02 -1.22990954e+01 -9.55352237e+00 -9.55352237e+00
 -9.55352237e+00 -1.25232078e+00 -5.75594786e-01 -5.75594786e-01
 -5.75594786e-01  9.90263734e-01  9.90263734e-01  9.90263734e-01
  7.22043897e+00  7.22043897e+00  7.22043897e+00  8.59760003e+00
  3.33415731e+01  3.33415731e+01  3.33415731e+01  9.90337383e+01
  1.28914642e+02  1.28914642e+02  1.28914642e+02  4.83258763e+02
  4.83258763e+02  4.83258763e+02  5.79801111e+02  1.33510322e+03
  1.33510322e+03  1.33510322e+03  2.64875391e+03  3.02935144e+03
  3.02935144e+03  3.02935144e+03  6.64979660e+03  6.64979660e+03
  6.64979660e+03  9.05473281e+03  2.54106199e+04  7.61533268e+04]
E1 = -728.372475660273  E_coul = 201.6748276092601
Extra cycle  E= -526.697648051013  delta_E= -7.16e-12  |g|= 2.85e-06  |ddm|= 4.93e-06
    CPU time for scf_cycle      4.30 sec, wall time      0.38 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102121.68719074178
E1 = -728.372475660273  E_coul = 201.6748276092601
init E= -526.697648051013
    CPU time for initialize scf     11.13 sec, wall time      0.53 sec
  HOMO = -0.57559389780116  LUMO = 0.990264381032996
  mo_energy =
[-1.18572661e+02 -1.22990919e+01 -9.55351873e+00 -9.55351873e+00
 -9.55351873e+00 -1.25231965e+00 -5.75593898e-01 -5.75593898e-01
 -5.75593898e-01  9.90264381e-01  9.90264381e-01  9.90264381e-01
  7.22044123e+00  7.22044123e+00  7.22044123e+00  8.59760273e+00
  3.33415767e+01  3.33415767e+01  3.33415767e+01  9.90337432e+01
  1.28914647e+02  1.28914647e+02  1.28914647e+02  4.83258768e+02
  4.83258768e+02  4.83258768e+02  5.79801117e+02  1.33510323e+03
  1.33510323e+03  1.33510323e+03  2.64875392e+03  3.02935145e+03
  3.02935145e+03  3.02935145e+03  6.64979661e+03  6.64979661e+03
  6.64979661e+03  9.05473281e+03  2.54106199e+04  7.61533268e+04]
E1 = -728.3724639550375  E_coul = 201.67481590402596
cycle= 1 E= -526.697648051011  delta_E= 1.48e-12  |g|= 7.45e-07  |ddm|= 1.21e-06
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3724639550375  E_coul = 201.67481590402596
  HOMO = -0.57559409971589  LUMO = 0.990264233351085
  mo_energy =
[-1.18572662e+02 -1.22990928e+01 -9.55351962e+00 -9.55351962e+00
 -9.55351962e+00 -1.25231990e+00 -5.75594100e-01 -5.75594100e-01
 -5.75594100e-01  9.90264233e-01  9.90264233e-01  9.90264233e-01
  7.22044070e+00  7.22044070e+00  7.22044070e+00  8.59760210e+00
  3.33415758e+01  3.33415758e+01  3.33415758e+01  9.90337419e+01
  1.28914646e+02  1.28914646e+02  1.28914646e+02  4.83258767e+02
  4.83258767e+02  4.83258767e+02  5.79801115e+02  1.33510323e+03
  1.33510323e+03  1.33510323e+03  2.64875391e+03  3.02935145e+03
  3.02935145e+03  3.02935145e+03  6.64979660e+03  6.64979660e+03
  6.64979660e+03  9.05473281e+03  2.54106199e+04  7.61533268e+04]
E1 = -728.3724668864807  E_coul = 201.67481883546773
Extra cycle  E= -526.697648051013  delta_E= -1.48e-12  |g|= 1.92e-07  |ddm|= 2.86e-07
    CPU time for scf_cycle     11.24 sec, wall time      0.64 sec
exp = [2.61826559e+04 7.61752175e+03 3.61735094e+03 1.59782232e+03
 3.82851176e+02 1.08122375e+02 3.48819814e+01 7.27860334e+00
 2.97407697e+00 4.07105353e-01 1.36278323e+03 6.64745436e+02
 3.00960836e+02 3.14041277e+02 6.16233604e+01 7.33642830e+00
 2.02364288e+01 7.68790558e-01 2.80041714e+00 2.16767299e-01]
grad_E = [-1.51784933e-06  3.31663888e-06 -1.56908696e-06  6.96699751e-05
 -4.41360305e-05 -7.51980435e-05 -3.93160286e-03 -1.12555926e-02
  2.24069036e-02  1.13888448e-01 -5.10214027e-07  4.96025015e-06
  2.33275922e-05  2.01141125e-05  2.05595408e-05  1.64574680e-03
 -4.03942725e-04  3.13762384e-02 -2.75115876e-03 -1.25128404e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:55:59 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6559252        1
[INPUT] 0    0    [1    /1   ]  7617.52176276        1
[INPUT] 0    0    [1    /1   ]  3617.35093617        1
[INPUT] 0    0    [1    /1   ]  1597.82249363        1
[INPUT] 0    0    [1    /1   ]  382.851211757        1
[INPUT] 0    0    [1    /1   ]  108.122248149        1
[INPUT] 0    0    [1    /1   ]  34.8799002635        1
[INPUT] 0    0    [1    /1   ]  7.10679828713        1
[INPUT] 0    0    [1    /1   ]  2.79395483292        1
[INPUT] 0    0    [1    /1   ]  0.386187284747       1
[INPUT] 1    0    [1    /1   ]  1362.78322969        1
[INPUT] 1    0    [1    /1   ]  664.74544904         1
[INPUT] 1    0    [1    /1   ]  300.960897208        1
[INPUT] 1    0    [1    /1   ]  314.041330456        1
[INPUT] 1    0    [1    /1   ]  61.6232546446        1
[INPUT] 1    0    [1    /1   ]  7.33404935795        1
[INPUT] 1    0    [1    /1   ]  20.2370517041        1
[INPUT] 1    0    [1    /1   ]  0.771281339228       1
[INPUT] 1    0    [1    /1   ]  2.80357232131        1
[INPUT] 1    0    [1    /1   ]  0.22118025999        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.655925151972, 1.0]], [0, [7617.521762764942, 1.0]], [0, [3617.350936165973, 1.0]], [0, [1597.822493634578, 1.0]], [0, [382.85121175677153, 1.0]], [0, [108.12224814940764, 1.0]], [0, [34.879900263529976, 1.0]], [0, [7.1067982871313955, 1.0]], [0, [2.7939548329234616, 1.0]], [0, [0.38618728474661895, 1.0]], [1, [1362.7832296912493, 1.0]], [1, [664.7454490398677, 1.0]], [1, [300.9608972080482, 1.0]], [1, [314.0413304558445, 1.0]], [1, [61.623254644627536, 1.0]], [1, [7.334049357946129, 1.0]], [1, [20.23705170405448, 1.0]], [1, [0.7712813392283522, 1.0]], [1, [2.8035723213141557, 1.0]], [1, [0.22118025998980606, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65592515]
bas 1, expnt(s) = [7617.52176276]
bas 2, expnt(s) = [3617.35093617]
bas 3, expnt(s) = [1597.82249363]
bas 4, expnt(s) = [382.85121176]
bas 5, expnt(s) = [108.12224815]
bas 6, expnt(s) = [34.87990026]
bas 7, expnt(s) = [7.10679829]
bas 8, expnt(s) = [2.79395483]
bas 9, expnt(s) = [0.38618728]
bas 10, expnt(s) = [1362.78322969]
bas 11, expnt(s) = [664.74544904]
bas 12, expnt(s) = [300.96089721]
bas 13, expnt(s) = [314.04133046]
bas 14, expnt(s) = [61.62325464]
bas 15, expnt(s) = [7.33404936]
bas 16, expnt(s) = [20.2370517]
bas 17, expnt(s) = [0.77128134]
bas 18, expnt(s) = [2.80357232]
bas 19, expnt(s) = [0.22118026]
CPU time:       283.12
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026288e+03 7.61752176e+03 2.06003833e+03
 3.61735094e+03 1.17844144e+03 1.59782249e+03 6.38500766e+02
 3.82851212e+02 2.18669164e+02 1.08122248e+02 8.47132463e+01
 3.48799003e+01 3.62615572e+01 7.10679829e+00 1.09969061e+01
 2.79395483e+00 5.45983553e+00 3.86187285e-01 1.23769462e+00
 1.36278323e+03 2.41556022e+04 6.64745449e+02 9.84699253e+03
 3.00960897e+02 3.65697493e+03 3.14041330e+02 3.85671816e+03
 6.16232546e+01 5.03692150e+02 7.33404936e+00 3.52098503e+01
 2.02370517e+01 1.25218485e+02 7.71281339e-01 2.10863020e+00
 2.80357232e+00 1.05833729e+01 2.21180260e-01 4.42504150e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.984476326029906
cond(S) = 101950.78756253661
E1 = -729.2884212058191  E_coul = 203.06050751652447
init E= -526.227913689295
    CPU time for initialize scf      7.32 sec, wall time      0.35 sec
  HOMO = -0.559885096408038  LUMO = 1.0202175935432
  mo_energy =
[-1.18334576e+02 -1.22116944e+01 -9.45558398e+00 -9.45558398e+00
 -9.45558398e+00 -1.22680747e+00 -5.59885096e-01 -5.59885096e-01
 -5.59885096e-01  1.02021759e+00  1.02021759e+00  1.02021759e+00
  7.30524173e+00  7.30524173e+00  7.30524173e+00  7.92035097e+00
  3.34736797e+01  3.34736797e+01  3.34736797e+01  9.76077460e+01
  1.29100852e+02  1.29100852e+02  1.29100852e+02  4.83510932e+02
  4.83510932e+02  4.83510932e+02  5.78658811e+02  1.33540758e+03
  1.33540758e+03  1.33540758e+03  2.64796063e+03  3.02971983e+03
  3.02971983e+03  3.02971983e+03  6.65027667e+03  6.65027667e+03
  6.65027667e+03  9.05416609e+03  2.54102083e+04  7.61530777e+04]
E1 = -727.7318357830284  E_coul = 201.03458560835466
cycle= 1 E= -526.697250174674  delta_E= -0.469  |g|= 0.193  |ddm|= 0.468
    CPU time for cycle= 1      0.08 sec, wall time      0.03 sec
diis-norm(errvec)=0.556031
diis-c [-0.30917021  1.        ]
  HOMO = -0.587967742336423  LUMO = 1.00172470627528
  mo_energy =
[-1.18649867e+02 -1.23471339e+01 -9.60348681e+00 -9.60348681e+00
 -9.60348681e+00 -1.26045992e+00 -5.87967742e-01 -5.87967742e-01
 -5.87967742e-01  1.00172471e+00  1.00172471e+00  1.00172471e+00
  7.22083268e+00  7.22083268e+00  7.22083268e+00  7.83172503e+00
  3.33199556e+01  3.33199556e+01  3.33199556e+01  9.73865356e+01
  1.28868839e+02  1.28868839e+02  1.28868839e+02  4.83197350e+02
  4.83197350e+02  4.83197350e+02  5.78305955e+02  1.33503575e+03
  1.33503575e+03  1.33503575e+03  2.64745208e+03  3.02928065e+03
  3.02928065e+03  3.02928065e+03  6.64972275e+03  6.64972275e+03
  6.64972275e+03  9.05353593e+03  2.54094834e+04  7.61522623e+04]
E1 = -728.2612012734065  E_coul = 201.56319213305684
cycle= 2 E= -526.69800914035  delta_E= -0.000759  |g|= 0.0373  |ddm|= 0.0452
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0732654
diis-c [-0.00296618  0.08135708  0.91864292]
  HOMO = -0.580108556722281  LUMO = 1.00758451999508
  mo_energy =
[-1.18584715e+02 -1.23121107e+01 -9.56707308e+00 -9.56707308e+00
 -9.56707308e+00 -1.25057459e+00 -5.80108557e-01 -5.80108557e-01
 -5.80108557e-01  1.00758452e+00  1.00758452e+00  1.00758452e+00
  7.24202092e+00  7.24202092e+00  7.24202092e+00  7.85740304e+00
  3.33569703e+01  3.33569703e+01  3.33569703e+01  9.74394027e+01
  1.28921934e+02  1.28921934e+02  1.28921934e+02  4.83261689e+02
  4.83261689e+02  4.83261689e+02  5.78372685e+02  1.33510415e+03
  1.33510415e+03  1.33510415e+03  2.64752363e+03  3.02935121e+03
  3.02935121e+03  3.02935121e+03  6.64979491e+03  6.64979491e+03
  6.64979491e+03  9.05360880e+03  2.54095568e+04  7.61523358e+04]
E1 = -728.1406388236583  E_coul = 201.44258399765874
cycle= 3 E= -526.698054826  delta_E= -4.57e-05  |g|= 0.00522  |ddm|= 0.0123
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0114441
diis-c [-8.57765389e-07 -1.31393839e-03  1.29578570e-01  8.71735368e-01]
  HOMO = -0.581108969267136  LUMO = 1.00685286183392
  mo_energy =
[-1.18592832e+02 -1.23164695e+01 -9.57176096e+00 -9.57176096e+00
 -9.57176096e+00 -1.25174312e+00 -5.81108969e-01 -5.81108969e-01
 -5.81108969e-01  1.00685286e+00  1.00685286e+00  1.00685286e+00
  7.23930375e+00  7.23930375e+00  7.23930375e+00  7.85436937e+00
  3.33522387e+01  3.33522387e+01  3.33522387e+01  9.74328607e+01
  1.28915282e+02  1.28915282e+02  1.28915282e+02  4.83253676e+02
  4.83253676e+02  4.83253676e+02  5.78364324e+02  1.33509557e+03
  1.33509557e+03  1.33509557e+03  2.64751443e+03  3.02934226e+03
  3.02934226e+03  3.02934226e+03  6.64978556e+03  6.64978556e+03
  6.64978556e+03  9.05359924e+03  2.54095470e+04  7.61523259e+04]
E1 = -728.1565216016518  E_coul = 201.45846572911745
cycle= 4 E= -526.698055872534  delta_E= -1.05e-06  |g|= 0.000101  |ddm|= 0.00146
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000215444
diis-c [-1.45187473e-09  8.00849509e-05 -1.03273585e-02 -8.74898555e-02
  1.09773713e+00]
  HOMO = -0.581099069790659  LUMO = 1.00686042889743
  mo_energy =
[-1.18592878e+02 -1.23164571e+01 -9.57176773e+00 -9.57176773e+00
 -9.57176773e+00 -1.25172261e+00 -5.81099070e-01 -5.81099070e-01
 -5.81099070e-01  1.00686043e+00  1.00686043e+00  1.00686043e+00
  7.23931349e+00  7.23931349e+00  7.23931349e+00  7.85440195e+00
  3.33522313e+01  3.33522313e+01  3.33522313e+01  9.74328427e+01
  1.28915256e+02  1.28915256e+02  1.28915256e+02  4.83253631e+02
  4.83253631e+02  4.83253631e+02  5.78364269e+02  1.33509551e+03
  1.33509551e+03  1.33509551e+03  2.64751434e+03  3.02934219e+03
  3.02934219e+03  3.02934219e+03  6.64978547e+03  6.64978547e+03
  6.64978547e+03  9.05359913e+03  2.54095469e+04  7.61523258e+04]
E1 = -728.1566230435308  E_coul = 201.4585671705683
cycle= 5 E= -526.698055872962  delta_E= -4.28e-10  |g|= 8.14e-06  |ddm|= 4.83e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.1566230435308  E_coul = 201.4585671705683
  HOMO = -0.581102691527633  LUMO = 1.00685781096396
  mo_energy =
[-1.18592896e+02 -1.23164698e+01 -9.57178118e+00 -9.57178118e+00
 -9.57178118e+00 -1.25172696e+00 -5.81102692e-01 -5.81102692e-01
 -5.81102692e-01  1.00685781e+00  1.00685781e+00  1.00685781e+00
  7.23930469e+00  7.23930469e+00  7.23930469e+00  7.85439228e+00
  3.33522181e+01  3.33522181e+01  3.33522181e+01  9.74328267e+01
  1.28915240e+02  1.28915240e+02  1.28915240e+02  4.83253613e+02
  4.83253613e+02  4.83253613e+02  5.78364250e+02  1.33509550e+03
  1.33509550e+03  1.33509550e+03  2.64751432e+03  3.02934217e+03
  3.02934217e+03  3.02934217e+03  6.64978545e+03  6.64978545e+03
  6.64978545e+03  9.05359911e+03  2.54095469e+04  7.61523258e+04]
E1 = -728.1566646454928  E_coul = 201.45860877252565
Extra cycle  E= -526.698055872967  delta_E= -4.77e-12  |g|= 2.47e-06  |ddm|= 4.34e-06
    CPU time for scf_cycle      7.55 sec, wall time      0.53 sec
exp = [2.61826559e+04 7.61752176e+03 3.61735094e+03 1.59782249e+03
 3.82851212e+02 1.08122248e+02 3.48799003e+01 7.10679829e+00
 2.79395483e+00 3.86187285e-01 1.36278323e+03 6.64745449e+02
 3.00960897e+02 3.14041330e+02 6.16232546e+01 7.33404936e+00
 2.02370517e+01 7.71281339e-01 2.80357232e+00 2.21180260e-01]
E = -526.6980558729672
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:56:00 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6559269        1
[INPUT] 0    0    [1    /1   ]  7617.52175888        1
[INPUT] 0    0    [1    /1   ]  3617.35093789        1
[INPUT] 0    0    [1    /1   ]  1597.82241248        1
[INPUT] 0    0    [1    /1   ]  382.851195612        1
[INPUT] 0    0    [1    /1   ]  108.122305765        1
[INPUT] 0    0    [1    /1   ]  34.8808476838        1
[INPUT] 0    0    [1    /1   ]  7.18501038478        1
[INPUT] 0    0    [1    /1   ]  2.87595318234        1
[INPUT] 0    0    [1    /1   ]  0.395709973309       1
[INPUT] 1    0    [1    /1   ]  1362.78323029        1
[INPUT] 1    0    [1    /1   ]  664.745443109        1
[INPUT] 1    0    [1    /1   ]  300.960869187        1
[INPUT] 1    0    [1    /1   ]  314.041306298        1
[INPUT] 1    0    [1    /1   ]  61.6233028061        1
[INPUT] 1    0    [1    /1   ]  7.33513233947        1
[INPUT] 1    0    [1    /1   ]  20.2367681391        1
[INPUT] 1    0    [1    /1   ]  0.770147442345       1
[INPUT] 1    0    [1    /1   ]  2.80213596261        1
[INPUT] 1    0    [1    /1   ]  0.219171314851       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.65592692877, 1.0]], [0, [7617.5217588809555, 1.0]], [0, [3617.3509378903495, 1.0]], [0, [1597.82241247802, 1.0]], [0, [382.85119561226304, 1.0]], [0, [108.12230576469084, 1.0]], [0, [34.880847683779535, 1.0]], [0, [7.185010384779889, 1.0]], [0, [2.875953182344037, 1.0]], [0, [0.39570997330944013, 1.0]], [1, [1362.7832302855425, 1.0]], [1, [664.7454431091097, 1.0]], [1, [300.9608691870876, 1.0]], [1, [314.04130629757935, 1.0]], [1, [61.62330280614403, 1.0]], [1, [7.33513233946911, 1.0]], [1, [20.23676813912838, 1.0]], [1, [0.7701474423454864, 1.0]], [1, [2.8021359626092965, 1.0]], [1, [0.2191713148507114, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65592693]
bas 1, expnt(s) = [7617.52175888]
bas 2, expnt(s) = [3617.35093789]
bas 3, expnt(s) = [1597.82241248]
bas 4, expnt(s) = [382.85119561]
bas 5, expnt(s) = [108.12230576]
bas 6, expnt(s) = [34.88084768]
bas 7, expnt(s) = [7.18501038]
bas 8, expnt(s) = [2.87595318]
bas 9, expnt(s) = [0.39570997]
bas 10, expnt(s) = [1362.78323029]
bas 11, expnt(s) = [664.74544311]
bas 12, expnt(s) = [300.96086919]
bas 13, expnt(s) = [314.0413063]
bas 14, expnt(s) = [61.62330281]
bas 15, expnt(s) = [7.33513234]
bas 16, expnt(s) = [20.23676814]
bas 17, expnt(s) = [0.77014744]
bas 18, expnt(s) = [2.80213596]
bas 19, expnt(s) = [0.21917131]
CPU time:       290.74
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026288e+03 7.61752176e+03 2.06003833e+03
 3.61735094e+03 1.17844144e+03 1.59782241e+03 6.38500741e+02
 3.82851196e+02 2.18669157e+02 1.08122306e+02 8.47132802e+01
 3.48808477e+01 3.62622959e+01 7.18501038e+00 1.10875496e+01
 2.87595318e+00 5.57957838e+00 3.95709973e-01 1.26051428e+00
 1.36278323e+03 2.41556022e+04 6.64745443e+02 9.84699242e+03
 3.00960869e+02 3.65697451e+03 3.14041306e+02 3.85671779e+03
 6.16233028e+01 5.03692642e+02 7.33513234e+00 3.52163494e+01
 2.02367681e+01 1.25216292e+02 7.70147442e-01 2.10475592e+00
 2.80213596e+00 1.05765956e+01 2.19171315e-01 4.37485873e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.983840353695868
cond(S) = 102028.24957393201
E1 = -729.3609369618904  E_coul = 203.11511008211454
init E= -526.245826879776
    CPU time for initialize scf      7.36 sec, wall time      0.36 sec
  HOMO = -0.557444449489008  LUMO = 1.01259738677622
  mo_energy =
[-1.18331571e+02 -1.22071022e+01 -9.45186702e+00 -9.45186702e+00
 -9.45186702e+00 -1.22607354e+00 -5.57444449e-01 -5.57444449e-01
 -5.57444449e-01  1.01259739e+00  1.01259739e+00  1.01259739e+00
  7.29504453e+00  7.29504453e+00  7.29504453e+00  8.25908890e+00
  3.34646981e+01  3.34646981e+01  3.34646981e+01  9.83315575e+01
  1.29095148e+02  1.29095148e+02  1.29095148e+02  4.83507066e+02
  4.83507066e+02  4.83507066e+02  5.79306069e+02  1.33540483e+03
  1.33540483e+03  1.33540483e+03  2.64851725e+03  3.02971742e+03
  3.02971742e+03  3.02971742e+03  6.65027468e+03  6.65027468e+03
  6.65027468e+03  9.05467415e+03  2.54106886e+04  7.61535251e+04]
E1 = -727.8542111726581  E_coul = 201.1559236622027
cycle= 1 E= -526.698287510455  delta_E= -0.452  |g|= 0.189  |ddm|= 0.399
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.548065
diis-c [-0.30037523  1.        ]
  HOMO = -0.584914934799357  LUMO = 0.994633525119553
  mo_energy =
[-1.18638165e+02 -1.23376368e+01 -9.59353399e+00 -9.59353399e+00
 -9.59353399e+00 -1.26047069e+00 -5.84914935e-01 -5.84914935e-01
 -5.84914935e-01  9.94633525e-01  9.94633525e-01  9.94633525e-01
  7.21339102e+00  7.21339102e+00  7.21339102e+00  8.17021208e+00
  3.33167694e+01  3.33167694e+01  3.33167694e+01  9.81181557e+01
  1.28870726e+02  1.28870726e+02  1.28870726e+02  4.83202160e+02
  4.83202160e+02  4.83202160e+02  5.78961926e+02  1.33504180e+03
  1.33504180e+03  1.33504180e+03  2.64801815e+03  3.02928740e+03
  3.02928740e+03  3.02928740e+03  6.64973030e+03  6.64973030e+03
  6.64973030e+03  9.05405377e+03  2.54099736e+04  7.61527197e+04]
E1 = -728.3552071441871  E_coul = 201.65625112484537
cycle= 2 E= -526.698956019342  delta_E= -0.000669  |g|= 0.0356  |ddm|= 0.0423
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0706105
diis-c [-0.00284365  0.07821547  0.92178453]
  HOMO = -0.577561563432974  LUMO = 1.00010402414814
  mo_energy =
[-1.18575859e+02 -1.23044383e+01 -9.55893296e+00 -9.55893296e+00
 -9.55893296e+00 -1.25116911e+00 -5.77561563e-01 -5.77561563e-01
 -5.77561563e-01  1.00010402e+00  1.00010402e+00  1.00010402e+00
  7.23339639e+00  7.23339639e+00  7.23339639e+00  8.19467292e+00
  3.33519626e+01  3.33519626e+01  3.33519626e+01  9.81685805e+01
  1.28921386e+02  1.28921386e+02  1.28921386e+02  4.83263685e+02
  4.83263685e+02  4.83263685e+02  5.79025780e+02  1.33510727e+03
  1.33510727e+03  1.33510727e+03  2.64808674e+03  3.02935500e+03
  3.02935500e+03  3.02935500e+03  6.64979949e+03  6.64979949e+03
  6.64979949e+03  9.05412369e+03  2.54100440e+04  7.61527903e+04]
E1 = -728.2397901168854  E_coul = 201.5407929353381
cycle= 3 E= -526.698997181547  delta_E= -4.12e-05  |g|= 0.0051  |ddm|= 0.0116
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0110639
diis-c [-5.96677916e-07 -1.22368113e-03  1.30403696e-01  8.70819986e-01]
  HOMO = -0.578563510325552  LUMO = 0.999371315983499
  mo_energy =
[-1.18583852e+02 -1.23087613e+01 -9.56355527e+00 -9.56355527e+00
 -9.56355527e+00 -1.25236965e+00 -5.78563510e-01 -5.78563510e-01
 -5.78563510e-01  9.99371316e-01  9.99371316e-01  9.99371316e-01
  7.23069812e+00  7.23069812e+00  7.23069812e+00  8.19158302e+00
  3.33472925e+01  3.33472925e+01  3.33472925e+01  9.81621233e+01
  1.28914828e+02  1.28914828e+02  1.28914828e+02  4.83255792e+02
  4.83255792e+02  4.83255792e+02  5.79017553e+02  1.33509884e+03
  1.33509884e+03  1.33509884e+03  2.64807771e+03  3.02934620e+03
  3.02934620e+03  3.02934620e+03  6.64979032e+03  6.64979032e+03
  6.64979032e+03  9.05411431e+03  2.54100345e+04  7.61527807e+04]
E1 = -728.2553646709274  E_coul = 201.55636649781675
cycle= 4 E= -526.698998173111  delta_E= -9.92e-07  |g|= 7.32e-05  |ddm|= 0.00145
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000149545
diis-c [-1.58799853e-09  6.76815844e-05 -9.18297839e-03 -7.36329617e-02
  1.08274826e+00]
  HOMO = -0.578550411243508  LUMO = 0.999381012466854
  mo_energy =
[-1.18583864e+02 -1.23087321e+01 -9.56354002e+00 -9.56354002e+00
 -9.56354002e+00 -1.25234758e+00 -5.78550411e-01 -5.78550411e-01
 -5.78550411e-01  9.99381012e-01  9.99381012e-01  9.99381012e-01
  7.23071910e+00  7.23071910e+00  7.23071910e+00  8.19162200e+00
  3.33473064e+01  3.33473064e+01  3.33473064e+01  9.81621319e+01
  1.28914831e+02  1.28914831e+02  1.28914831e+02  4.83255782e+02
  4.83255782e+02  4.83255782e+02  5.79017534e+02  1.33509882e+03
  1.33509882e+03  1.33509882e+03  2.64807766e+03  3.02934617e+03
  3.02934617e+03  3.02934617e+03  6.64979028e+03  6.64979028e+03
  6.64979028e+03  9.05411426e+03  2.54100344e+04  7.61527806e+04]
E1 = -728.2553772472725  E_coul = 201.55637907396638
cycle= 5 E= -526.698998173306  delta_E= -1.95e-10  |g|= 9e-06  |ddm|= 3.53e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.2553772472725  E_coul = 201.55637907396638
  HOMO = -0.57855437698748  LUMO = 0.999378154480257
  mo_energy =
[-1.18583884e+02 -1.23087461e+01 -9.56355479e+00 -9.56355479e+00
 -9.56355479e+00 -1.25235238e+00 -5.78554377e-01 -5.78554377e-01
 -5.78554377e-01  9.99378154e-01  9.99378154e-01  9.99378154e-01
  7.23070945e+00  7.23070945e+00  7.23070945e+00  8.19161132e+00
  3.33472919e+01  3.33472919e+01  3.33472919e+01  9.81621143e+01
  1.28914814e+02  1.28914814e+02  1.28914814e+02  4.83255762e+02
  4.83255762e+02  4.83255762e+02  5.79017514e+02  1.33509879e+03
  1.33509879e+03  1.33509879e+03  2.64807764e+03  3.02934615e+03
  3.02934615e+03  3.02934615e+03  6.64979026e+03  6.64979026e+03
  6.64979026e+03  9.05411424e+03  2.54100344e+04  7.61527806e+04]
E1 = -728.2554232901965  E_coul = 201.5564251168847
Extra cycle  E= -526.698998173312  delta_E= -5.68e-12  |g|= 2.73e-06  |ddm|= 4.77e-06
    CPU time for scf_cycle      7.55 sec, wall time      0.54 sec
exp = [2.61826559e+04 7.61752176e+03 3.61735094e+03 1.59782241e+03
 3.82851196e+02 1.08122306e+02 3.48808477e+01 7.18501038e+00
 2.87595318e+00 3.95709973e-01 1.36278323e+03 6.64745443e+02
 3.00960869e+02 3.14041306e+02 6.16233028e+01 7.33513234e+00
 2.02367681e+01 7.70147442e-01 2.80213596e+00 2.19171315e-01]
E = -526.6989981733118
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:56:00 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6559269        1
[INPUT] 0    0    [1    /1   ]  7617.52175888        1
[INPUT] 0    0    [1    /1   ]  3617.35093789        1
[INPUT] 0    0    [1    /1   ]  1597.82241248        1
[INPUT] 0    0    [1    /1   ]  382.851195612        1
[INPUT] 0    0    [1    /1   ]  108.122305765        1
[INPUT] 0    0    [1    /1   ]  34.8808476838        1
[INPUT] 0    0    [1    /1   ]  7.18501038478        1
[INPUT] 0    0    [1    /1   ]  2.87595318234        1
[INPUT] 0    0    [1    /1   ]  0.395709973309       1
[INPUT] 1    0    [1    /1   ]  1362.78323029        1
[INPUT] 1    0    [1    /1   ]  664.745443109        1
[INPUT] 1    0    [1    /1   ]  300.960869187        1
[INPUT] 1    0    [1    /1   ]  314.041306298        1
[INPUT] 1    0    [1    /1   ]  61.6233028061        1
[INPUT] 1    0    [1    /1   ]  7.33513233947        1
[INPUT] 1    0    [1    /1   ]  20.2367681391        1
[INPUT] 1    0    [1    /1   ]  0.770147442345       1
[INPUT] 1    0    [1    /1   ]  2.80213596261        1
[INPUT] 1    0    [1    /1   ]  0.219171314851       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.65592692877, 1.0]], [0, [7617.5217588809555, 1.0]], [0, [3617.3509378903495, 1.0]], [0, [1597.82241247802, 1.0]], [0, [382.85119561226304, 1.0]], [0, [108.12230576469084, 1.0]], [0, [34.880847683779535, 1.0]], [0, [7.185010384779889, 1.0]], [0, [2.875953182344037, 1.0]], [0, [0.39570997330944013, 1.0]], [1, [1362.7832302855425, 1.0]], [1, [664.7454431091097, 1.0]], [1, [300.9608691870876, 1.0]], [1, [314.04130629757935, 1.0]], [1, [61.62330280614403, 1.0]], [1, [7.33513233946911, 1.0]], [1, [20.23676813912838, 1.0]], [1, [0.7701474423454864, 1.0]], [1, [2.8021359626092965, 1.0]], [1, [0.2191713148507114, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65592693]
bas 1, expnt(s) = [7617.52175888]
bas 2, expnt(s) = [3617.35093789]
bas 3, expnt(s) = [1597.82241248]
bas 4, expnt(s) = [382.85119561]
bas 5, expnt(s) = [108.12230576]
bas 6, expnt(s) = [34.88084768]
bas 7, expnt(s) = [7.18501038]
bas 8, expnt(s) = [2.87595318]
bas 9, expnt(s) = [0.39570997]
bas 10, expnt(s) = [1362.78323029]
bas 11, expnt(s) = [664.74544311]
bas 12, expnt(s) = [300.96086919]
bas 13, expnt(s) = [314.0413063]
bas 14, expnt(s) = [61.62330281]
bas 15, expnt(s) = [7.33513234]
bas 16, expnt(s) = [20.23676814]
bas 17, expnt(s) = [0.77014744]
bas 18, expnt(s) = [2.80213596]
bas 19, expnt(s) = [0.21917131]
CPU time:       298.36
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026288e+03 7.61752176e+03 2.06003833e+03
 3.61735094e+03 1.17844144e+03 1.59782241e+03 6.38500741e+02
 3.82851196e+02 2.18669157e+02 1.08122306e+02 8.47132802e+01
 3.48808477e+01 3.62622959e+01 7.18501038e+00 1.10875496e+01
 2.87595318e+00 5.57957838e+00 3.95709973e-01 1.26051428e+00
 1.36278323e+03 2.41556022e+04 6.64745443e+02 9.84699242e+03
 3.00960869e+02 3.65697451e+03 3.14041306e+02 3.85671779e+03
 6.16233028e+01 5.03692642e+02 7.33513234e+00 3.52163494e+01
 2.02367681e+01 1.25216292e+02 7.70147442e-01 2.10475592e+00
 2.80213596e+00 1.05765956e+01 2.19171315e-01 4.37485873e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.983840353695868
cond(S) = 102028.24957393201
E1 = -729.3609369618904  E_coul = 203.11511008211454
init E= -526.245826879776
    CPU time for initialize scf      7.24 sec, wall time      0.36 sec
  HOMO = -0.557444449489008  LUMO = 1.01259738677622
  mo_energy =
[-1.18331571e+02 -1.22071022e+01 -9.45186702e+00 -9.45186702e+00
 -9.45186702e+00 -1.22607354e+00 -5.57444449e-01 -5.57444449e-01
 -5.57444449e-01  1.01259739e+00  1.01259739e+00  1.01259739e+00
  7.29504453e+00  7.29504453e+00  7.29504453e+00  8.25908890e+00
  3.34646981e+01  3.34646981e+01  3.34646981e+01  9.83315575e+01
  1.29095148e+02  1.29095148e+02  1.29095148e+02  4.83507066e+02
  4.83507066e+02  4.83507066e+02  5.79306069e+02  1.33540483e+03
  1.33540483e+03  1.33540483e+03  2.64851725e+03  3.02971742e+03
  3.02971742e+03  3.02971742e+03  6.65027468e+03  6.65027468e+03
  6.65027468e+03  9.05467415e+03  2.54106886e+04  7.61535251e+04]
E1 = -727.8542111726581  E_coul = 201.1559236622027
cycle= 1 E= -526.698287510455  delta_E= -0.452  |g|= 0.189  |ddm|= 0.399
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.548065
diis-c [-0.30037523  1.        ]
  HOMO = -0.584914934799357  LUMO = 0.994633525119553
  mo_energy =
[-1.18638165e+02 -1.23376368e+01 -9.59353399e+00 -9.59353399e+00
 -9.59353399e+00 -1.26047069e+00 -5.84914935e-01 -5.84914935e-01
 -5.84914935e-01  9.94633525e-01  9.94633525e-01  9.94633525e-01
  7.21339102e+00  7.21339102e+00  7.21339102e+00  8.17021208e+00
  3.33167694e+01  3.33167694e+01  3.33167694e+01  9.81181557e+01
  1.28870726e+02  1.28870726e+02  1.28870726e+02  4.83202160e+02
  4.83202160e+02  4.83202160e+02  5.78961926e+02  1.33504180e+03
  1.33504180e+03  1.33504180e+03  2.64801815e+03  3.02928740e+03
  3.02928740e+03  3.02928740e+03  6.64973030e+03  6.64973030e+03
  6.64973030e+03  9.05405377e+03  2.54099736e+04  7.61527197e+04]
E1 = -728.3552071441871  E_coul = 201.65625112484537
cycle= 2 E= -526.698956019342  delta_E= -0.000669  |g|= 0.0356  |ddm|= 0.0423
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0706105
diis-c [-0.00284365  0.07821547  0.92178453]
  HOMO = -0.577561563432974  LUMO = 1.00010402414814
  mo_energy =
[-1.18575859e+02 -1.23044383e+01 -9.55893296e+00 -9.55893296e+00
 -9.55893296e+00 -1.25116911e+00 -5.77561563e-01 -5.77561563e-01
 -5.77561563e-01  1.00010402e+00  1.00010402e+00  1.00010402e+00
  7.23339639e+00  7.23339639e+00  7.23339639e+00  8.19467292e+00
  3.33519626e+01  3.33519626e+01  3.33519626e+01  9.81685805e+01
  1.28921386e+02  1.28921386e+02  1.28921386e+02  4.83263685e+02
  4.83263685e+02  4.83263685e+02  5.79025780e+02  1.33510727e+03
  1.33510727e+03  1.33510727e+03  2.64808674e+03  3.02935500e+03
  3.02935500e+03  3.02935500e+03  6.64979949e+03  6.64979949e+03
  6.64979949e+03  9.05412369e+03  2.54100440e+04  7.61527903e+04]
E1 = -728.2397901168854  E_coul = 201.5407929353381
cycle= 3 E= -526.698997181547  delta_E= -4.12e-05  |g|= 0.0051  |ddm|= 0.0116
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0110639
diis-c [-5.96677916e-07 -1.22368113e-03  1.30403696e-01  8.70819986e-01]
  HOMO = -0.578563510325552  LUMO = 0.999371315983499
  mo_energy =
[-1.18583852e+02 -1.23087613e+01 -9.56355527e+00 -9.56355527e+00
 -9.56355527e+00 -1.25236965e+00 -5.78563510e-01 -5.78563510e-01
 -5.78563510e-01  9.99371316e-01  9.99371316e-01  9.99371316e-01
  7.23069812e+00  7.23069812e+00  7.23069812e+00  8.19158302e+00
  3.33472925e+01  3.33472925e+01  3.33472925e+01  9.81621233e+01
  1.28914828e+02  1.28914828e+02  1.28914828e+02  4.83255792e+02
  4.83255792e+02  4.83255792e+02  5.79017553e+02  1.33509884e+03
  1.33509884e+03  1.33509884e+03  2.64807771e+03  3.02934620e+03
  3.02934620e+03  3.02934620e+03  6.64979032e+03  6.64979032e+03
  6.64979032e+03  9.05411431e+03  2.54100345e+04  7.61527807e+04]
E1 = -728.2553646709274  E_coul = 201.55636649781675
cycle= 4 E= -526.698998173111  delta_E= -9.92e-07  |g|= 7.32e-05  |ddm|= 0.00145
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000149545
diis-c [-1.58799853e-09  6.76815844e-05 -9.18297839e-03 -7.36329617e-02
  1.08274826e+00]
  HOMO = -0.578550411243508  LUMO = 0.999381012466854
  mo_energy =
[-1.18583864e+02 -1.23087321e+01 -9.56354002e+00 -9.56354002e+00
 -9.56354002e+00 -1.25234758e+00 -5.78550411e-01 -5.78550411e-01
 -5.78550411e-01  9.99381012e-01  9.99381012e-01  9.99381012e-01
  7.23071910e+00  7.23071910e+00  7.23071910e+00  8.19162200e+00
  3.33473064e+01  3.33473064e+01  3.33473064e+01  9.81621319e+01
  1.28914831e+02  1.28914831e+02  1.28914831e+02  4.83255782e+02
  4.83255782e+02  4.83255782e+02  5.79017534e+02  1.33509882e+03
  1.33509882e+03  1.33509882e+03  2.64807766e+03  3.02934617e+03
  3.02934617e+03  3.02934617e+03  6.64979028e+03  6.64979028e+03
  6.64979028e+03  9.05411426e+03  2.54100344e+04  7.61527806e+04]
E1 = -728.2553772472725  E_coul = 201.55637907396638
cycle= 5 E= -526.698998173306  delta_E= -1.95e-10  |g|= 9e-06  |ddm|= 3.53e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.2553772472725  E_coul = 201.55637907396638
  HOMO = -0.57855437698748  LUMO = 0.999378154480257
  mo_energy =
[-1.18583884e+02 -1.23087461e+01 -9.56355479e+00 -9.56355479e+00
 -9.56355479e+00 -1.25235238e+00 -5.78554377e-01 -5.78554377e-01
 -5.78554377e-01  9.99378154e-01  9.99378154e-01  9.99378154e-01
  7.23070945e+00  7.23070945e+00  7.23070945e+00  8.19161132e+00
  3.33472919e+01  3.33472919e+01  3.33472919e+01  9.81621143e+01
  1.28914814e+02  1.28914814e+02  1.28914814e+02  4.83255762e+02
  4.83255762e+02  4.83255762e+02  5.79017514e+02  1.33509879e+03
  1.33509879e+03  1.33509879e+03  2.64807764e+03  3.02934615e+03
  3.02934615e+03  3.02934615e+03  6.64979026e+03  6.64979026e+03
  6.64979026e+03  9.05411424e+03  2.54100344e+04  7.61527806e+04]
E1 = -728.2554232901965  E_coul = 201.5564251168847
Extra cycle  E= -526.698998173312  delta_E= -5.68e-12  |g|= 2.73e-06  |ddm|= 4.77e-06
    CPU time for scf_cycle      7.42 sec, wall time      0.54 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102028.24957393201
E1 = -728.2554232901965  E_coul = 201.5564251168847
init E= -526.698998173312
    CPU time for initialize scf     15.91 sec, wall time      0.75 sec
  HOMO = -0.578553524300804  LUMO = 0.999378776896113
  mo_energy =
[-1.18583878e+02 -1.23087428e+01 -9.56355130e+00 -9.56355130e+00
 -9.56355130e+00 -1.25235131e+00 -5.78553524e-01 -5.78553524e-01
 -5.78553524e-01  9.99378777e-01  9.99378777e-01  9.99378777e-01
  7.23071161e+00  7.23071161e+00  7.23071161e+00  8.19161387e+00
  3.33472954e+01  3.33472954e+01  3.33472954e+01  9.81621190e+01
  1.28914818e+02  1.28914818e+02  1.28914818e+02  4.83255767e+02
  4.83255767e+02  4.83255767e+02  5.79017519e+02  1.33509880e+03
  1.33509880e+03  1.33509880e+03  2.64807765e+03  3.02934616e+03
  3.02934616e+03  3.02934616e+03  6.64979026e+03  6.64979026e+03
  6.64979026e+03  9.05411424e+03  2.54100344e+04  7.61527806e+04]
E1 = -728.2554120902416  E_coul = 201.5564139169294
cycle= 1 E= -526.698998173312  delta_E= -4.55e-13  |g|= 7.16e-07  |ddm|= 1.15e-06
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.2554120902416  E_coul = 201.5564139169294
  HOMO = -0.578553717017163  LUMO = 0.999378635622413
  mo_energy =
[-1.18583879e+02 -1.23087436e+01 -9.56355215e+00 -9.56355215e+00
 -9.56355215e+00 -1.25235155e+00 -5.78553717e-01 -5.78553717e-01
 -5.78553717e-01  9.99378636e-01  9.99378636e-01  9.99378636e-01
  7.23071110e+00  7.23071110e+00  7.23071110e+00  8.19161328e+00
  3.33472946e+01  3.33472946e+01  3.33472946e+01  9.81621178e+01
  1.28914817e+02  1.28914817e+02  1.28914817e+02  4.83255766e+02
  4.83255766e+02  4.83255766e+02  5.79017518e+02  1.33509880e+03
  1.33509880e+03  1.33509880e+03  2.64807765e+03  3.02934616e+03
  3.02934616e+03  3.02934616e+03  6.64979026e+03  6.64979026e+03
  6.64979026e+03  9.05411424e+03  2.54100344e+04  7.61527806e+04]
E1 = -728.2554148928982  E_coul = 201.55641671958745
Extra cycle  E= -526.698998173311  delta_E= 1.48e-12  |g|= 1.84e-07  |ddm|= 2.74e-07
    CPU time for scf_cycle     16.23 sec, wall time      1.07 sec
exp = [2.61826559e+04 7.61752176e+03 3.61735094e+03 1.59782241e+03
 3.82851196e+02 1.08122306e+02 3.48808477e+01 7.18501038e+00
 2.87595318e+00 3.95709973e-01 1.36278323e+03 6.64745443e+02
 3.00960869e+02 3.14041306e+02 6.16233028e+01 7.33513234e+00
 2.02367681e+01 7.70147442e-01 2.80213596e+00 2.19171315e-01]
grad_E = [-1.51705420e-06  3.30974993e-06 -1.57256454e-06  6.94049974e-05
 -3.53097673e-05 -1.76243303e-04 -3.47774181e-03 -7.41395630e-03
  8.36615916e-03 -2.64723292e-02 -5.09507598e-07  4.97427773e-06
  2.34100856e-05  2.01850558e-05  1.21125847e-05  1.42635681e-03
 -3.25857432e-04  1.94863491e-02 -2.32810087e-03 -8.21055115e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:56:06 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6559282        1
[INPUT] 0    0    [1    /1   ]  7617.52175604        1
[INPUT] 0    0    [1    /1   ]  3617.35093926        1
[INPUT] 0    0    [1    /1   ]  1597.82235293        1
[INPUT] 0    0    [1    /1   ]  382.851233912        1
[INPUT] 0    0    [1    /1   ]  108.122477628        1
[INPUT] 0    0    [1    /1   ]  34.8842632763        1
[INPUT] 0    0    [1    /1   ]  7.18206208784        1
[INPUT] 0    0    [1    /1   ]  2.8629883266         1
[INPUT] 0    0    [1    /1   ]  0.398032082258       1
[INPUT] 1    0    [1    /1   ]  1362.78323072        1
[INPUT] 1    0    [1    /1   ]  664.745438863        1
[INPUT] 1    0    [1    /1   ]  300.960849226        1
[INPUT] 1    0    [1    /1   ]  314.041289085        1
[INPUT] 1    0    [1    /1   ]  61.6232782961        1
[INPUT] 1    0    [1    /1   ]  7.33317706157        1
[INPUT] 1    0    [1    /1   ]  20.2371968328        1
[INPUT] 1    0    [1    /1   ]  0.772271487188       1
[INPUT] 1    0    [1    /1   ]  2.80484052758        1
[INPUT] 1    0    [1    /1   ]  0.223253833874       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.655928230026, 1.0]], [0, [7617.521756043057, 1.0]], [0, [3617.350939255541, 1.0]], [0, [1597.8223529271004, 1.0]], [0, [382.851233911675, 1.0]], [0, [108.1224776279557, 1.0]], [0, [34.8842632763418, 1.0]], [0, [7.182062087844802, 1.0]], [0, [2.862988326597643, 1.0]], [0, [0.39803208225806097, 1.0]], [1, [1362.7832307231854, 1.0]], [1, [664.7454388626901, 1.0]], [1, [300.96084922583304, 1.0]], [1, [314.04128908547375, 1.0]], [1, [61.623278296073345, 1.0]], [1, [7.333177061570277, 1.0]], [1, [20.237196832781464, 1.0]], [1, [0.7722714871884089, 1.0]], [1, [2.804840527581624, 1.0]], [1, [0.2232538338741163, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65592823]
bas 1, expnt(s) = [7617.52175604]
bas 2, expnt(s) = [3617.35093926]
bas 3, expnt(s) = [1597.82235293]
bas 4, expnt(s) = [382.85123391]
bas 5, expnt(s) = [108.12247763]
bas 6, expnt(s) = [34.88426328]
bas 7, expnt(s) = [7.18206209]
bas 8, expnt(s) = [2.86298833]
bas 9, expnt(s) = [0.39803208]
bas 10, expnt(s) = [1362.78323072]
bas 11, expnt(s) = [664.74543886]
bas 12, expnt(s) = [300.96084923]
bas 13, expnt(s) = [314.04128909]
bas 14, expnt(s) = [61.6232783]
bas 15, expnt(s) = [7.33317706]
bas 16, expnt(s) = [20.23719683]
bas 17, expnt(s) = [0.77227149]
bas 18, expnt(s) = [2.80484053]
bas 19, expnt(s) = [0.22325383]
CPU time:       326.74
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026288e+03 7.61752176e+03 2.06003833e+03
 3.61735094e+03 1.17844144e+03 1.59782235e+03 6.38500723e+02
 3.82851234e+02 2.18669173e+02 1.08122478e+02 8.47133811e+01
 3.48842633e+01 3.62649590e+01 7.18206209e+00 1.10841371e+01
 2.86298833e+00 5.56070309e+00 3.98032082e-01 1.26605795e+00
 1.36278323e+03 2.41556022e+04 6.64745439e+02 9.84699234e+03
 3.00960849e+02 3.65697421e+03 3.14041289e+02 3.85671753e+03
 6.16232783e+01 5.03692392e+02 7.33317706e+00 3.52046156e+01
 2.02371968e+01 1.25219607e+02 7.72271487e-01 2.11201449e+00
 2.80484053e+00 1.05893575e+01 2.23253834e-01 4.47695830e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.9832312416566
cond(S) = 102026.68941580641
E1 = -729.3795627606925  E_coul = 203.1298766965953
init E= -526.249686064097
    CPU time for initialize scf      7.54 sec, wall time      0.35 sec
  HOMO = -0.556724170835255  LUMO = 1.03073530123522
  mo_energy =
[-1.18330618e+02 -1.22063750e+01 -9.45092952e+00 -9.45092952e+00
 -9.45092952e+00 -1.22542144e+00 -5.56724171e-01 -5.56724171e-01
 -5.56724171e-01  1.03073530e+00  1.03073530e+00  1.03073530e+00
  7.32399820e+00  7.32399820e+00  7.32399820e+00  8.23646371e+00
  3.34902990e+01  3.34902990e+01  3.34902990e+01  9.82793993e+01
  1.29114045e+02  1.29114045e+02  1.29114045e+02  4.83521412e+02
  4.83521412e+02  4.83521412e+02  5.79267669e+02  1.33541728e+03
  1.33541728e+03  1.33541728e+03  2.64848645e+03  3.02972888e+03
  3.02972888e+03  3.02972888e+03  6.65028513e+03  6.65028513e+03
  6.65028513e+03  9.05464643e+03  2.54106624e+04  7.61535008e+04]
E1 = -727.9448044787085  E_coul = 201.2462227999048
cycle= 1 E= -526.698581678804  delta_E= -0.449  |g|= 0.187  |ddm|= 0.41
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.54592
diis-c [-0.29802904  1.        ]
  HOMO = -0.581748433205989  LUMO = 1.01437436846986
  mo_energy =
[-1.18631042e+02 -1.23315691e+01 -9.58718420e+00 -9.58718420e+00
 -9.58718420e+00 -1.25717920e+00 -5.81748433e-01 -5.81748433e-01
 -5.81748433e-01  1.01437437e+00  1.01437437e+00  1.01437437e+00
  7.24677301e+00  7.24677301e+00  7.24677301e+00  8.15210817e+00
  3.33477377e+01  3.33477377e+01  3.33477377e+01  9.80717507e+01
  1.28895458e+02  1.28895458e+02  1.28895458e+02  4.83222641e+02
  4.83222641e+02  4.83222641e+02  5.78929755e+02  1.33506053e+03
  1.33506053e+03  1.33506053e+03  2.64799381e+03  3.02930524e+03
  3.02930524e+03  3.02930524e+03  6.64974726e+03  6.64974726e+03
  6.64974726e+03  9.05403261e+03  2.54099541e+04  7.61527021e+04]
E1 = -728.4252448652574  E_coul = 201.72603597748935
cycle= 2 E= -526.699208887768  delta_E= -0.000627  |g|= 0.0346  |ddm|= 0.0405
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0688017
diis-c [-0.00273553  0.07600734  0.92399266]
  HOMO = -0.574774695651638  LUMO = 1.01962021199298
  mo_energy =
[-1.18570612e+02 -1.22997074e+01 -9.55395223e+00 -9.55395223e+00
 -9.55395223e+00 -1.24834879e+00 -5.74774696e-01 -5.74774696e-01
 -5.74774696e-01  1.01962021e+00  1.01962021e+00  1.01962021e+00
  7.26587740e+00  7.26587740e+00  7.26587740e+00  8.17547677e+00
  3.33815770e+01  3.33815770e+01  3.33815770e+01  9.81205154e+01
  1.28944449e+02  1.28944449e+02  1.28944449e+02  4.83282306e+02
  4.83282306e+02  4.83282306e+02  5.78991716e+02  1.33512408e+03
  1.33512408e+03  1.33512408e+03  2.64806044e+03  3.02937089e+03
  3.02937089e+03  3.02937089e+03  6.64981447e+03  6.64981447e+03
  6.64981447e+03  9.05410055e+03  2.54100225e+04  7.61527707e+04]
E1 = -728.3149638398817  E_coul = 201.61571702367542
cycle= 3 E= -526.699246816206  delta_E= -3.79e-05  |g|= 0.00498  |ddm|= 0.0111
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0108105
diis-c [-5.72907804e-07 -1.21312034e-03  1.30699578e-01  8.70513543e-01]
  HOMO = -0.575735518591713  LUMO = 1.01891032061576
  mo_energy =
[-1.18578408e+02 -1.23039005e+01 -9.55843820e+00 -9.55843820e+00
 -9.55843820e+00 -1.24950252e+00 -5.75735519e-01 -5.75735519e-01
 -5.75735519e-01  1.01891032e+00  1.01891032e+00  1.01891032e+00
  7.26327133e+00  7.26327133e+00  7.26327133e+00  8.17249148e+00
  3.33770439e+01  3.33770439e+01  3.33770439e+01  9.81142274e+01
  1.28938063e+02  1.28938063e+02  1.28938063e+02  4.83274609e+02
  4.83274609e+02  4.83274609e+02  5.78983691e+02  1.33511585e+03
  1.33511585e+03  1.33511585e+03  2.64805162e+03  3.02936231e+03
  3.02936231e+03  3.02936231e+03  6.64980552e+03  6.64980552e+03
  6.64980552e+03  9.05409140e+03  2.54100132e+04  7.61527613e+04]
E1 = -728.3299706534132  E_coul = 201.63072291073243
cycle= 4 E= -526.699247742681  delta_E= -9.26e-07  |g|= 7.06e-05  |ddm|= 0.0014
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000139374
diis-c [-1.68640785e-09  6.64310942e-05 -9.08457360e-03 -7.20077292e-02
  1.08102587e+00]
  HOMO = -0.575720705754374  LUMO = 1.01892134251928
  mo_energy =
[-1.18578411e+02 -1.23038658e+01 -9.55841684e+00 -9.55841684e+00
 -9.55841684e+00 -1.24947859e+00 -5.75720706e-01 -5.75720706e-01
 -5.75720706e-01  1.01892134e+00  1.01892134e+00  1.01892134e+00
  7.26329638e+00  7.26329638e+00  7.26329638e+00  8.17253442e+00
  3.33770639e+01  3.33770639e+01  3.33770639e+01  9.81142434e+01
  1.28938074e+02  1.28938074e+02  1.28938074e+02  4.83274607e+02
  4.83274607e+02  4.83274607e+02  5.78983681e+02  1.33511584e+03
  1.33511584e+03  1.33511584e+03  2.64805159e+03  3.02936229e+03
  3.02936229e+03  3.02936229e+03  6.64980549e+03  6.64980549e+03
  6.64980549e+03  9.05409135e+03  2.54100132e+04  7.61527612e+04]
E1 = -728.3299648792452  E_coul = 201.63071713638277
cycle= 5 E= -526.699247742862  delta_E= -1.82e-10  |g|= 9.28e-06  |ddm|= 3.52e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3299648792452  E_coul = 201.63071713638277
  HOMO = -0.575724757061092  LUMO = 1.01891839754085
  mo_energy =
[-1.18578431e+02 -1.23038802e+01 -9.55843202e+00 -9.55843202e+00
 -9.55843202e+00 -1.24948349e+00 -5.75724757e-01 -5.75724757e-01
 -5.75724757e-01  1.01891840e+00  1.01891840e+00  1.01891840e+00
  7.26328649e+00  7.26328649e+00  7.26328649e+00  8.17252350e+00
  3.33770490e+01  3.33770490e+01  3.33770490e+01  9.81142254e+01
  1.28938056e+02  1.28938056e+02  1.28938056e+02  4.83274586e+02
  4.83274586e+02  4.83274586e+02  5.78983660e+02  1.33511582e+03
  1.33511582e+03  1.33511582e+03  2.64805156e+03  3.02936226e+03
  3.02936226e+03  3.02936226e+03  6.64980546e+03  6.64980546e+03
  6.64980546e+03  9.05409133e+03  2.54100131e+04  7.61527612e+04]
E1 = -728.33001169243  E_coul = 201.63076394956164
Extra cycle  E= -526.699247742868  delta_E= -6.14e-12  |g|= 2.8e-06  |ddm|= 4.85e-06
    CPU time for scf_cycle      7.75 sec, wall time      0.53 sec
exp = [2.61826559e+04 7.61752176e+03 3.61735094e+03 1.59782235e+03
 3.82851234e+02 1.08122478e+02 3.48842633e+01 7.18206209e+00
 2.86298833e+00 3.98032082e-01 1.36278323e+03 6.64745439e+02
 3.00960849e+02 3.14041289e+02 6.16232783e+01 7.33317706e+00
 2.02371968e+01 7.72271487e-01 2.80484053e+00 2.23253834e-01]
E = -526.6992477428685
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:56:06 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6559282        1
[INPUT] 0    0    [1    /1   ]  7617.52175604        1
[INPUT] 0    0    [1    /1   ]  3617.35093926        1
[INPUT] 0    0    [1    /1   ]  1597.82235293        1
[INPUT] 0    0    [1    /1   ]  382.851233912        1
[INPUT] 0    0    [1    /1   ]  108.122477628        1
[INPUT] 0    0    [1    /1   ]  34.8842632763        1
[INPUT] 0    0    [1    /1   ]  7.18206208784        1
[INPUT] 0    0    [1    /1   ]  2.8629883266         1
[INPUT] 0    0    [1    /1   ]  0.398032082258       1
[INPUT] 1    0    [1    /1   ]  1362.78323072        1
[INPUT] 1    0    [1    /1   ]  664.745438863        1
[INPUT] 1    0    [1    /1   ]  300.960849226        1
[INPUT] 1    0    [1    /1   ]  314.041289085        1
[INPUT] 1    0    [1    /1   ]  61.6232782961        1
[INPUT] 1    0    [1    /1   ]  7.33317706157        1
[INPUT] 1    0    [1    /1   ]  20.2371968328        1
[INPUT] 1    0    [1    /1   ]  0.772271487188       1
[INPUT] 1    0    [1    /1   ]  2.80484052758        1
[INPUT] 1    0    [1    /1   ]  0.223253833874       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.655928230026, 1.0]], [0, [7617.521756043057, 1.0]], [0, [3617.350939255541, 1.0]], [0, [1597.8223529271004, 1.0]], [0, [382.851233911675, 1.0]], [0, [108.1224776279557, 1.0]], [0, [34.8842632763418, 1.0]], [0, [7.182062087844802, 1.0]], [0, [2.862988326597643, 1.0]], [0, [0.39803208225806097, 1.0]], [1, [1362.7832307231854, 1.0]], [1, [664.7454388626901, 1.0]], [1, [300.96084922583304, 1.0]], [1, [314.04128908547375, 1.0]], [1, [61.623278296073345, 1.0]], [1, [7.333177061570277, 1.0]], [1, [20.237196832781464, 1.0]], [1, [0.7722714871884089, 1.0]], [1, [2.804840527581624, 1.0]], [1, [0.2232538338741163, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65592823]
bas 1, expnt(s) = [7617.52175604]
bas 2, expnt(s) = [3617.35093926]
bas 3, expnt(s) = [1597.82235293]
bas 4, expnt(s) = [382.85123391]
bas 5, expnt(s) = [108.12247763]
bas 6, expnt(s) = [34.88426328]
bas 7, expnt(s) = [7.18206209]
bas 8, expnt(s) = [2.86298833]
bas 9, expnt(s) = [0.39803208]
bas 10, expnt(s) = [1362.78323072]
bas 11, expnt(s) = [664.74543886]
bas 12, expnt(s) = [300.96084923]
bas 13, expnt(s) = [314.04128909]
bas 14, expnt(s) = [61.6232783]
bas 15, expnt(s) = [7.33317706]
bas 16, expnt(s) = [20.23719683]
bas 17, expnt(s) = [0.77227149]
bas 18, expnt(s) = [2.80484053]
bas 19, expnt(s) = [0.22325383]
CPU time:       334.57
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026288e+03 7.61752176e+03 2.06003833e+03
 3.61735094e+03 1.17844144e+03 1.59782235e+03 6.38500723e+02
 3.82851234e+02 2.18669173e+02 1.08122478e+02 8.47133811e+01
 3.48842633e+01 3.62649590e+01 7.18206209e+00 1.10841371e+01
 2.86298833e+00 5.56070309e+00 3.98032082e-01 1.26605795e+00
 1.36278323e+03 2.41556022e+04 6.64745439e+02 9.84699234e+03
 3.00960849e+02 3.65697421e+03 3.14041289e+02 3.85671753e+03
 6.16232783e+01 5.03692392e+02 7.33317706e+00 3.52046156e+01
 2.02371968e+01 1.25219607e+02 7.72271487e-01 2.11201449e+00
 2.80484053e+00 1.05893575e+01 2.23253834e-01 4.47695830e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.9832312416566
cond(S) = 102026.68941580641
E1 = -729.3795627606925  E_coul = 203.1298766965953
init E= -526.249686064097
    CPU time for initialize scf      7.50 sec, wall time      0.35 sec
  HOMO = -0.556724170835255  LUMO = 1.03073530123522
  mo_energy =
[-1.18330618e+02 -1.22063750e+01 -9.45092952e+00 -9.45092952e+00
 -9.45092952e+00 -1.22542144e+00 -5.56724171e-01 -5.56724171e-01
 -5.56724171e-01  1.03073530e+00  1.03073530e+00  1.03073530e+00
  7.32399820e+00  7.32399820e+00  7.32399820e+00  8.23646371e+00
  3.34902990e+01  3.34902990e+01  3.34902990e+01  9.82793993e+01
  1.29114045e+02  1.29114045e+02  1.29114045e+02  4.83521412e+02
  4.83521412e+02  4.83521412e+02  5.79267669e+02  1.33541728e+03
  1.33541728e+03  1.33541728e+03  2.64848645e+03  3.02972888e+03
  3.02972888e+03  3.02972888e+03  6.65028513e+03  6.65028513e+03
  6.65028513e+03  9.05464643e+03  2.54106624e+04  7.61535008e+04]
E1 = -727.9448044787085  E_coul = 201.2462227999048
cycle= 1 E= -526.698581678804  delta_E= -0.449  |g|= 0.187  |ddm|= 0.41
    CPU time for cycle= 1      0.06 sec, wall time      0.03 sec
diis-norm(errvec)=0.54592
diis-c [-0.29802904  1.        ]
  HOMO = -0.581748433205989  LUMO = 1.01437436846986
  mo_energy =
[-1.18631042e+02 -1.23315691e+01 -9.58718420e+00 -9.58718420e+00
 -9.58718420e+00 -1.25717920e+00 -5.81748433e-01 -5.81748433e-01
 -5.81748433e-01  1.01437437e+00  1.01437437e+00  1.01437437e+00
  7.24677301e+00  7.24677301e+00  7.24677301e+00  8.15210817e+00
  3.33477377e+01  3.33477377e+01  3.33477377e+01  9.80717507e+01
  1.28895458e+02  1.28895458e+02  1.28895458e+02  4.83222641e+02
  4.83222641e+02  4.83222641e+02  5.78929755e+02  1.33506053e+03
  1.33506053e+03  1.33506053e+03  2.64799381e+03  3.02930524e+03
  3.02930524e+03  3.02930524e+03  6.64974726e+03  6.64974726e+03
  6.64974726e+03  9.05403261e+03  2.54099541e+04  7.61527021e+04]
E1 = -728.4252448652574  E_coul = 201.72603597748935
cycle= 2 E= -526.699208887768  delta_E= -0.000627  |g|= 0.0346  |ddm|= 0.0405
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0688017
diis-c [-0.00273553  0.07600734  0.92399266]
  HOMO = -0.574774695651638  LUMO = 1.01962021199298
  mo_energy =
[-1.18570612e+02 -1.22997074e+01 -9.55395223e+00 -9.55395223e+00
 -9.55395223e+00 -1.24834879e+00 -5.74774696e-01 -5.74774696e-01
 -5.74774696e-01  1.01962021e+00  1.01962021e+00  1.01962021e+00
  7.26587740e+00  7.26587740e+00  7.26587740e+00  8.17547677e+00
  3.33815770e+01  3.33815770e+01  3.33815770e+01  9.81205154e+01
  1.28944449e+02  1.28944449e+02  1.28944449e+02  4.83282306e+02
  4.83282306e+02  4.83282306e+02  5.78991716e+02  1.33512408e+03
  1.33512408e+03  1.33512408e+03  2.64806044e+03  3.02937089e+03
  3.02937089e+03  3.02937089e+03  6.64981447e+03  6.64981447e+03
  6.64981447e+03  9.05410055e+03  2.54100225e+04  7.61527707e+04]
E1 = -728.3149638398817  E_coul = 201.61571702367542
cycle= 3 E= -526.699246816206  delta_E= -3.79e-05  |g|= 0.00498  |ddm|= 0.0111
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0108105
diis-c [-5.72907804e-07 -1.21312034e-03  1.30699578e-01  8.70513543e-01]
  HOMO = -0.575735518591713  LUMO = 1.01891032061576
  mo_energy =
[-1.18578408e+02 -1.23039005e+01 -9.55843820e+00 -9.55843820e+00
 -9.55843820e+00 -1.24950252e+00 -5.75735519e-01 -5.75735519e-01
 -5.75735519e-01  1.01891032e+00  1.01891032e+00  1.01891032e+00
  7.26327133e+00  7.26327133e+00  7.26327133e+00  8.17249148e+00
  3.33770439e+01  3.33770439e+01  3.33770439e+01  9.81142274e+01
  1.28938063e+02  1.28938063e+02  1.28938063e+02  4.83274609e+02
  4.83274609e+02  4.83274609e+02  5.78983691e+02  1.33511585e+03
  1.33511585e+03  1.33511585e+03  2.64805162e+03  3.02936231e+03
  3.02936231e+03  3.02936231e+03  6.64980552e+03  6.64980552e+03
  6.64980552e+03  9.05409140e+03  2.54100132e+04  7.61527613e+04]
E1 = -728.3299706534132  E_coul = 201.63072291073243
cycle= 4 E= -526.699247742681  delta_E= -9.26e-07  |g|= 7.06e-05  |ddm|= 0.0014
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000139374
diis-c [-1.68640785e-09  6.64310942e-05 -9.08457360e-03 -7.20077292e-02
  1.08102587e+00]
  HOMO = -0.575720705754374  LUMO = 1.01892134251928
  mo_energy =
[-1.18578411e+02 -1.23038658e+01 -9.55841684e+00 -9.55841684e+00
 -9.55841684e+00 -1.24947859e+00 -5.75720706e-01 -5.75720706e-01
 -5.75720706e-01  1.01892134e+00  1.01892134e+00  1.01892134e+00
  7.26329638e+00  7.26329638e+00  7.26329638e+00  8.17253442e+00
  3.33770639e+01  3.33770639e+01  3.33770639e+01  9.81142434e+01
  1.28938074e+02  1.28938074e+02  1.28938074e+02  4.83274607e+02
  4.83274607e+02  4.83274607e+02  5.78983681e+02  1.33511584e+03
  1.33511584e+03  1.33511584e+03  2.64805159e+03  3.02936229e+03
  3.02936229e+03  3.02936229e+03  6.64980549e+03  6.64980549e+03
  6.64980549e+03  9.05409135e+03  2.54100132e+04  7.61527612e+04]
E1 = -728.3299648792452  E_coul = 201.63071713638277
cycle= 5 E= -526.699247742862  delta_E= -1.82e-10  |g|= 9.28e-06  |ddm|= 3.52e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3299648792452  E_coul = 201.63071713638277
  HOMO = -0.575724757061092  LUMO = 1.01891839754085
  mo_energy =
[-1.18578431e+02 -1.23038802e+01 -9.55843202e+00 -9.55843202e+00
 -9.55843202e+00 -1.24948349e+00 -5.75724757e-01 -5.75724757e-01
 -5.75724757e-01  1.01891840e+00  1.01891840e+00  1.01891840e+00
  7.26328649e+00  7.26328649e+00  7.26328649e+00  8.17252350e+00
  3.33770490e+01  3.33770490e+01  3.33770490e+01  9.81142254e+01
  1.28938056e+02  1.28938056e+02  1.28938056e+02  4.83274586e+02
  4.83274586e+02  4.83274586e+02  5.78983660e+02  1.33511582e+03
  1.33511582e+03  1.33511582e+03  2.64805156e+03  3.02936226e+03
  3.02936226e+03  3.02936226e+03  6.64980546e+03  6.64980546e+03
  6.64980546e+03  9.05409133e+03  2.54100131e+04  7.61527612e+04]
E1 = -728.33001169243  E_coul = 201.63076394956164
Extra cycle  E= -526.699247742868  delta_E= -6.14e-12  |g|= 2.8e-06  |ddm|= 4.85e-06
    CPU time for scf_cycle      7.71 sec, wall time      0.53 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102026.68941580641
E1 = -728.33001169243  E_coul = 201.63076394956164
init E= -526.699247742868
    CPU time for initialize scf     16.22 sec, wall time      0.78 sec
  HOMO = -0.575723896716983  LUMO = 1.01891903175238
  mo_energy =
[-1.18578426e+02 -1.23038767e+01 -9.55842847e+00 -9.55842847e+00
 -9.55842847e+00 -1.24948242e+00 -5.75723897e-01 -5.75723897e-01
 -5.75723897e-01  1.01891903e+00  1.01891903e+00  1.01891903e+00
  7.26328868e+00  7.26328868e+00  7.26328868e+00  8.17252608e+00
  3.33770526e+01  3.33770526e+01  3.33770526e+01  9.81142301e+01
  1.28938060e+02  1.28938060e+02  1.28938060e+02  4.83274592e+02
  4.83274592e+02  4.83274592e+02  5.78983666e+02  1.33511583e+03
  1.33511583e+03  1.33511583e+03  2.64805157e+03  3.02936227e+03
  3.02936227e+03  3.02936227e+03  6.64980547e+03  6.64980547e+03
  6.64980547e+03  9.05409133e+03  2.54100131e+04  7.61527612e+04]
E1 = -728.3300004045308  E_coul = 201.6307526616619
cycle= 1 E= -526.699247742869  delta_E= -4.55e-13  |g|= 7.27e-07  |ddm|= 1.17e-06
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3300004045308  E_coul = 201.6307526616619
  HOMO = -0.575724089198886  LUMO = 1.01891888923255
  mo_energy =
[-1.18578427e+02 -1.23038776e+01 -9.55842932e+00 -9.55842932e+00
 -9.55842932e+00 -1.24948265e+00 -5.75724089e-01 -5.75724089e-01
 -5.75724089e-01  1.01891889e+00  1.01891889e+00  1.01891889e+00
  7.26328817e+00  7.26328817e+00  7.26328817e+00  8.17252549e+00
  3.33770517e+01  3.33770517e+01  3.33770517e+01  9.81142289e+01
  1.28938059e+02  1.28938059e+02  1.28938059e+02  4.83274591e+02
  4.83274591e+02  4.83274591e+02  5.78983664e+02  1.33511583e+03
  1.33511583e+03  1.33511583e+03  2.64805157e+03  3.02936227e+03
  3.02936227e+03  3.02936227e+03  6.64980547e+03  6.64980547e+03
  6.64980547e+03  9.05409133e+03  2.54100131e+04  7.61527612e+04]
E1 = -728.330003208463  E_coul = 201.6307554655941
Extra cycle  E= -526.699247742869  delta_E=    0  |g|= 1.86e-07  |ddm|= 2.74e-07
    CPU time for scf_cycle     16.34 sec, wall time      0.90 sec
exp = [2.61826559e+04 7.61752176e+03 3.61735094e+03 1.59782235e+03
 3.82851234e+02 1.08122478e+02 3.48842633e+01 7.18206209e+00
 2.86298833e+00 3.98032082e-01 1.36278323e+03 6.64745439e+02
 3.00960849e+02 3.14041289e+02 6.16232783e+01 7.33317706e+00
 2.02371968e+01 7.72271487e-01 2.80484053e+00 2.23253834e-01]
grad_E = [-1.51695420e-06  3.30813965e-06 -1.57375452e-06  6.93395050e-05
 -3.30735920e-05 -2.00946988e-04 -3.38746488e-03 -6.76972994e-03
  6.35374422e-03  3.41617497e-03 -5.08176329e-07  4.99086101e-06
  2.35115211e-05  2.02722636e-05  9.43042596e-08  1.10800662e-03
 -2.12480728e-04 -3.35906683e-03 -1.68318217e-03  1.01683815e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:56:11 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6559318        1
[INPUT] 0    0    [1    /1   ]  7617.52174821        1
[INPUT] 0    0    [1    /1   ]  3617.35094291        1
[INPUT] 0    0    [1    /1   ]  1597.82218892        1
[INPUT] 0    0    [1    /1   ]  382.85128511         1
[INPUT] 0    0    [1    /1   ]  108.122829535        1
[INPUT] 0    0    [1    /1   ]  34.8907625807        1
[INPUT] 0    0    [1    /1   ]  7.23227988462        1
[INPUT] 0    0    [1    /1   ]  2.89285947371        1
[INPUT] 0    0    [1    /1   ]  0.396710683433       1
[INPUT] 1    0    [1    /1   ]  1362.78323193        1
[INPUT] 1    0    [1    /1   ]  664.745427032        1
[INPUT] 1    0    [1    /1   ]  300.960793472        1
[INPUT] 1    0    [1    /1   ]  314.041241013        1
[INPUT] 1    0    [1    /1   ]  61.6232917779        1
[INPUT] 1    0    [1    /1   ]  7.33140011766        1
[INPUT] 1    0    [1    /1   ]  20.2375304594        1
[INPUT] 1    0    [1    /1   ]  0.773673552831       1
[INPUT] 1    0    [1    /1   ]  2.80751450535        1
[INPUT] 1    0    [1    /1   ]  0.224715865967       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.655931817306, 1.0]], [0, [7617.521748213571, 1.0]], [0, [3617.350942911929, 1.0]], [0, [1597.822188920388, 1.0]], [0, [382.85128510970515, 1.0]], [0, [108.12282953549357, 1.0]], [0, [34.89076258071828, 1.0]], [0, [7.232279884620023, 1.0]], [0, [2.8928594737140276, 1.0]], [0, [0.3967106834327324, 1.0]], [1, [1362.7832319254155, 1.0]], [1, [664.7454270321577, 1.0]], [1, [300.96079347164226, 1.0]], [1, [314.04124101343575, 1.0]], [1, [61.6232917778966, 1.0]], [1, [7.331400117659518, 1.0]], [1, [20.23753045935493, 1.0]], [1, [0.7736735528307953, 1.0]], [1, [2.8075145053471977, 1.0]], [1, [0.22471586596718102, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65593182]
bas 1, expnt(s) = [7617.52174821]
bas 2, expnt(s) = [3617.35094291]
bas 3, expnt(s) = [1597.82218892]
bas 4, expnt(s) = [382.85128511]
bas 5, expnt(s) = [108.12282954]
bas 6, expnt(s) = [34.89076258]
bas 7, expnt(s) = [7.23227988]
bas 8, expnt(s) = [2.89285947]
bas 9, expnt(s) = [0.39671068]
bas 10, expnt(s) = [1362.78323193]
bas 11, expnt(s) = [664.74542703]
bas 12, expnt(s) = [300.96079347]
bas 13, expnt(s) = [314.04124101]
bas 14, expnt(s) = [61.62329178]
bas 15, expnt(s) = [7.33140012]
bas 16, expnt(s) = [20.23753046]
bas 17, expnt(s) = [0.77367355]
bas 18, expnt(s) = [2.80751451]
bas 19, expnt(s) = [0.22471587]
CPU time:       363.65
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026288e+03 7.61752175e+03 2.06003833e+03
 3.61735094e+03 1.17844144e+03 1.59782219e+03 6.38500674e+02
 3.82851285e+02 2.18669195e+02 1.08122830e+02 8.47135879e+01
 3.48907626e+01 3.62700263e+01 7.23227988e+00 1.11422127e+01
 2.89285947e+00 5.60416002e+00 3.96710683e-01 1.26290431e+00
 1.36278323e+03 2.41556022e+04 6.64745427e+02 9.84699212e+03
 3.00960793e+02 3.65697336e+03 3.14041241e+02 3.85671679e+03
 6.16232918e+01 5.03692529e+02 7.33140012e+00 3.51939526e+01
 2.02375305e+01 1.25222188e+02 7.73673553e-01 2.11680855e+00
 2.80751451e+00 1.06019781e+01 2.24715866e-01 4.51363632e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98320139038815
cond(S) = 102057.68300565485
E1 = -729.3681182672192  E_coul = 203.12083163035396
init E= -526.247286636865
    CPU time for initialize scf      4.62 sec, wall time      0.23 sec
  HOMO = -0.556977418678183  LUMO = 1.03752756020689
  mo_energy =
[-1.18331389e+02 -1.22069392e+01 -9.45163570e+00 -9.45163570e+00
 -9.45163570e+00 -1.22576472e+00 -5.56977419e-01 -5.56977419e-01
 -5.56977419e-01  1.03752756e+00  1.03752756e+00  1.03752756e+00
  7.33849207e+00  7.33849207e+00  7.33849207e+00  8.35352564e+00
  3.35043901e+01  3.35043901e+01  3.35043901e+01  9.86215419e+01
  1.29124029e+02  1.29124029e+02  1.29124029e+02  4.83528654e+02
  4.83528654e+02  4.83528654e+02  5.79594379e+02  1.33542334e+03
  1.33542334e+03  1.33542334e+03  2.64877161e+03  3.02973424e+03
  3.02973424e+03  3.02973424e+03  6.65028981e+03  6.65028981e+03
  6.65028981e+03  9.05490714e+03  2.54109088e+04  7.61537301e+04]
E1 = -727.9545927530276  E_coul = 201.25588362481486
cycle= 1 E= -526.698709128213  delta_E= -0.451  |g|= 0.187  |ddm|= 0.423
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.545642
diis-c [-0.29772556  1.        ]
  HOMO = -0.581380225329325  LUMO = 1.02154553890825
  mo_energy =
[-1.18630321e+02 -1.23309331e+01 -9.58659375e+00 -9.58659375e+00
 -9.58659375e+00 -1.25664148e+00 -5.81380225e-01 -5.81380225e-01
 -5.81380225e-01  1.02154554e+00  1.02154554e+00  1.02154554e+00
  7.26240445e+00  7.26240445e+00  7.26240445e+00  8.27000016e+00
  3.33631293e+01  3.33631293e+01  3.33631293e+01  9.84152743e+01
  1.28906873e+02  1.28906873e+02  1.28906873e+02  4.83231364e+02
  4.83231364e+02  4.83231364e+02  5.79257950e+02  1.33506807e+03
  1.33506807e+03  1.33506807e+03  2.64828042e+03  3.02931207e+03
  3.02931207e+03  3.02931207e+03  6.64975338e+03  6.64975338e+03
  6.64975338e+03  9.05429476e+03  2.54102019e+04  7.61529328e+04]
E1 = -728.4305827233796  E_coul = 201.7312519419959
cycle= 2 E= -526.699330781384  delta_E= -0.000622  |g|= 0.0344  |ddm|= 0.0402
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0683577
diis-c [-0.00270869  0.07543834  0.92456166]
  HOMO = -0.574481341386228  LUMO = 1.0267581201463
  mo_energy =
[-1.18570301e+02 -1.22993571e+01 -9.55366193e+00 -9.55366193e+00
 -9.55366193e+00 -1.24790971e+00 -5.74481341e-01 -5.74481341e-01
 -5.74481341e-01  1.02675812e+00  1.02675812e+00  1.02675812e+00
  7.28132502e+00  7.28132502e+00  7.28132502e+00  8.29330526e+00
  3.33966731e+01  3.33966731e+01  3.33966731e+01  9.84636852e+01
  1.28955500e+02  1.28955500e+02  1.28955500e+02  4.83290623e+02
  4.83290623e+02  4.83290623e+02  5.79319493e+02  1.33513120e+03
  1.33513120e+03  1.33513120e+03  2.64834661e+03  3.02937729e+03
  3.02937729e+03  3.02937729e+03  6.64982016e+03  6.64982016e+03
  6.64982016e+03  9.05436225e+03  2.54102699e+04  7.61530010e+04]
E1 = -728.3217948621636  E_coul = 201.622426951807
cycle= 3 E= -526.699367910357  delta_E= -3.71e-05  |g|= 0.00493  |ddm|= 0.0109
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0107364
diis-c [-5.76121265e-07 -1.21068300e-03  1.30634680e-01  8.70576003e-01]
  HOMO = -0.575426060884256  LUMO = 1.02605728413309
  mo_energy =
[-1.18578028e+02 -1.23035017e+01 -9.55809708e+00 -9.55809708e+00
 -9.55809708e+00 -1.24904226e+00 -5.75426061e-01 -5.75426061e-01
 -5.75426061e-01  1.02605728e+00  1.02605728e+00  1.02605728e+00
  7.27875438e+00  7.27875438e+00  7.27875438e+00  8.29034337e+00
  3.33921909e+01  3.33921909e+01  3.33921909e+01  9.84574576e+01
  1.28949176e+02  1.28949176e+02  1.28949176e+02  4.83282994e+02
  4.83282994e+02  4.83282994e+02  5.79311537e+02  1.33512304e+03
  1.33512304e+03  1.33512304e+03  2.64833786e+03  3.02936877e+03
  3.02936877e+03  3.02936877e+03  6.64981128e+03  6.64981128e+03
  6.64981128e+03  9.05435317e+03  2.54102606e+04  7.61529916e+04]
E1 = -728.3365863398698  E_coul = 201.6372175253596
cycle= 4 E= -526.69936881451  delta_E= -9.04e-07  |g|= 7.13e-05  |ddm|= 0.00138
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000140732
diis-c [-1.65110144e-09  6.73392563e-05 -9.19689088e-03 -7.30153566e-02
  1.08214491e+00]
  HOMO = -0.575411304271603  LUMO = 1.02606831511277
  mo_energy =
[-1.18578032e+02 -1.23034677e+01 -9.55807646e+00 -9.55807646e+00
 -9.55807646e+00 -1.24901841e+00 -5.75411304e-01 -5.75411304e-01
 -5.75411304e-01  1.02606832e+00  1.02606832e+00  1.02606832e+00
  7.27877914e+00  7.27877914e+00  7.27877914e+00  8.29038616e+00
  3.33922103e+01  3.33922103e+01  3.33922103e+01  9.84574728e+01
  1.28949186e+02  1.28949186e+02  1.28949186e+02  4.83282992e+02
  4.83282992e+02  4.83282992e+02  5.79311526e+02  1.33512303e+03
  1.33512303e+03  1.33512303e+03  2.64833783e+03  3.02936875e+03
  3.02936875e+03  3.02936875e+03  6.64981124e+03  6.64981124e+03
  6.64981124e+03  9.05435312e+03  2.54102606e+04  7.61529916e+04]
E1 = -728.3365846310027  E_coul = 201.63721581630497
cycle= 5 E= -526.699368814698  delta_E= -1.87e-10  |g|= 9.08e-06  |ddm|= 3.53e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3365846310027  E_coul = 201.63721581630497
  HOMO = -0.575415278050793  LUMO = 1.02606541520499
  mo_energy =
[-1.18578052e+02 -1.23034818e+01 -9.55809135e+00 -9.55809135e+00
 -9.55809135e+00 -1.24902322e+00 -5.75415278e-01 -5.75415278e-01
 -5.75415278e-01  1.02606542e+00  1.02606542e+00  1.02606542e+00
  7.27876943e+00  7.27876943e+00  7.27876943e+00  8.29037538e+00
  3.33921957e+01  3.33921957e+01  3.33921957e+01  9.84574550e+01
  1.28949168e+02  1.28949168e+02  1.28949168e+02  4.83282972e+02
  4.83282972e+02  4.83282972e+02  5.79311506e+02  1.33512301e+03
  1.33512301e+03  1.33512301e+03  2.64833780e+03  3.02936873e+03
  3.02936873e+03  3.02936873e+03  6.64981122e+03  6.64981122e+03
  6.64981122e+03  9.05435310e+03  2.54102605e+04  7.61529915e+04]
E1 = -728.33663022834  E_coul = 201.63726141363736
Extra cycle  E= -526.699368814703  delta_E= -5e-12  |g|= 2.73e-06  |ddm|= 4.74e-06
    CPU time for scf_cycle      4.84 sec, wall time      0.43 sec
exp = [2.61826559e+04 7.61752175e+03 3.61735094e+03 1.59782219e+03
 3.82851285e+02 1.08122830e+02 3.48907626e+01 7.23227988e+00
 2.89285947e+00 3.96710683e-01 1.36278323e+03 6.64745427e+02
 3.00960793e+02 3.14041241e+02 6.16232918e+01 7.33140012e+00
 2.02375305e+01 7.73673553e-01 2.80751451e+00 2.24715866e-01]
E = -526.6993688147027
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:56:12 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6559318        1
[INPUT] 0    0    [1    /1   ]  7617.52174821        1
[INPUT] 0    0    [1    /1   ]  3617.35094291        1
[INPUT] 0    0    [1    /1   ]  1597.82218892        1
[INPUT] 0    0    [1    /1   ]  382.85128511         1
[INPUT] 0    0    [1    /1   ]  108.122829535        1
[INPUT] 0    0    [1    /1   ]  34.8907625807        1
[INPUT] 0    0    [1    /1   ]  7.23227988462        1
[INPUT] 0    0    [1    /1   ]  2.89285947371        1
[INPUT] 0    0    [1    /1   ]  0.396710683433       1
[INPUT] 1    0    [1    /1   ]  1362.78323193        1
[INPUT] 1    0    [1    /1   ]  664.745427032        1
[INPUT] 1    0    [1    /1   ]  300.960793472        1
[INPUT] 1    0    [1    /1   ]  314.041241013        1
[INPUT] 1    0    [1    /1   ]  61.6232917779        1
[INPUT] 1    0    [1    /1   ]  7.33140011766        1
[INPUT] 1    0    [1    /1   ]  20.2375304594        1
[INPUT] 1    0    [1    /1   ]  0.773673552831       1
[INPUT] 1    0    [1    /1   ]  2.80751450535        1
[INPUT] 1    0    [1    /1   ]  0.224715865967       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.655931817306, 1.0]], [0, [7617.521748213571, 1.0]], [0, [3617.350942911929, 1.0]], [0, [1597.822188920388, 1.0]], [0, [382.85128510970515, 1.0]], [0, [108.12282953549357, 1.0]], [0, [34.89076258071828, 1.0]], [0, [7.232279884620023, 1.0]], [0, [2.8928594737140276, 1.0]], [0, [0.3967106834327324, 1.0]], [1, [1362.7832319254155, 1.0]], [1, [664.7454270321577, 1.0]], [1, [300.96079347164226, 1.0]], [1, [314.04124101343575, 1.0]], [1, [61.6232917778966, 1.0]], [1, [7.331400117659518, 1.0]], [1, [20.23753045935493, 1.0]], [1, [0.7736735528307953, 1.0]], [1, [2.8075145053471977, 1.0]], [1, [0.22471586596718102, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65593182]
bas 1, expnt(s) = [7617.52174821]
bas 2, expnt(s) = [3617.35094291]
bas 3, expnt(s) = [1597.82218892]
bas 4, expnt(s) = [382.85128511]
bas 5, expnt(s) = [108.12282954]
bas 6, expnt(s) = [34.89076258]
bas 7, expnt(s) = [7.23227988]
bas 8, expnt(s) = [2.89285947]
bas 9, expnt(s) = [0.39671068]
bas 10, expnt(s) = [1362.78323193]
bas 11, expnt(s) = [664.74542703]
bas 12, expnt(s) = [300.96079347]
bas 13, expnt(s) = [314.04124101]
bas 14, expnt(s) = [61.62329178]
bas 15, expnt(s) = [7.33140012]
bas 16, expnt(s) = [20.23753046]
bas 17, expnt(s) = [0.77367355]
bas 18, expnt(s) = [2.80751451]
bas 19, expnt(s) = [0.22471587]
CPU time:       368.58
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026288e+03 7.61752175e+03 2.06003833e+03
 3.61735094e+03 1.17844144e+03 1.59782219e+03 6.38500674e+02
 3.82851285e+02 2.18669195e+02 1.08122830e+02 8.47135879e+01
 3.48907626e+01 3.62700263e+01 7.23227988e+00 1.11422127e+01
 2.89285947e+00 5.60416002e+00 3.96710683e-01 1.26290431e+00
 1.36278323e+03 2.41556022e+04 6.64745427e+02 9.84699212e+03
 3.00960793e+02 3.65697336e+03 3.14041241e+02 3.85671679e+03
 6.16232918e+01 5.03692529e+02 7.33140012e+00 3.51939526e+01
 2.02375305e+01 1.25222188e+02 7.73673553e-01 2.11680855e+00
 2.80751451e+00 1.06019781e+01 2.24715866e-01 4.51363632e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98320139038815
cond(S) = 102057.68300565485
E1 = -729.3681182672192  E_coul = 203.12083163035396
init E= -526.247286636865
    CPU time for initialize scf      6.84 sec, wall time      0.33 sec
  HOMO = -0.556977418678183  LUMO = 1.03752756020689
  mo_energy =
[-1.18331389e+02 -1.22069392e+01 -9.45163570e+00 -9.45163570e+00
 -9.45163570e+00 -1.22576472e+00 -5.56977419e-01 -5.56977419e-01
 -5.56977419e-01  1.03752756e+00  1.03752756e+00  1.03752756e+00
  7.33849207e+00  7.33849207e+00  7.33849207e+00  8.35352564e+00
  3.35043901e+01  3.35043901e+01  3.35043901e+01  9.86215419e+01
  1.29124029e+02  1.29124029e+02  1.29124029e+02  4.83528654e+02
  4.83528654e+02  4.83528654e+02  5.79594379e+02  1.33542334e+03
  1.33542334e+03  1.33542334e+03  2.64877161e+03  3.02973424e+03
  3.02973424e+03  3.02973424e+03  6.65028981e+03  6.65028981e+03
  6.65028981e+03  9.05490714e+03  2.54109088e+04  7.61537301e+04]
E1 = -727.9545927530276  E_coul = 201.25588362481486
cycle= 1 E= -526.698709128213  delta_E= -0.451  |g|= 0.187  |ddm|= 0.423
    CPU time for cycle= 1      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.545642
diis-c [-0.29772556  1.        ]
  HOMO = -0.581380225329325  LUMO = 1.02154553890825
  mo_energy =
[-1.18630321e+02 -1.23309331e+01 -9.58659375e+00 -9.58659375e+00
 -9.58659375e+00 -1.25664148e+00 -5.81380225e-01 -5.81380225e-01
 -5.81380225e-01  1.02154554e+00  1.02154554e+00  1.02154554e+00
  7.26240445e+00  7.26240445e+00  7.26240445e+00  8.27000016e+00
  3.33631293e+01  3.33631293e+01  3.33631293e+01  9.84152743e+01
  1.28906873e+02  1.28906873e+02  1.28906873e+02  4.83231364e+02
  4.83231364e+02  4.83231364e+02  5.79257950e+02  1.33506807e+03
  1.33506807e+03  1.33506807e+03  2.64828042e+03  3.02931207e+03
  3.02931207e+03  3.02931207e+03  6.64975338e+03  6.64975338e+03
  6.64975338e+03  9.05429476e+03  2.54102019e+04  7.61529328e+04]
E1 = -728.4305827233796  E_coul = 201.7312519419959
cycle= 2 E= -526.699330781384  delta_E= -0.000622  |g|= 0.0344  |ddm|= 0.0402
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0683577
diis-c [-0.00270869  0.07543834  0.92456166]
  HOMO = -0.574481341386228  LUMO = 1.0267581201463
  mo_energy =
[-1.18570301e+02 -1.22993571e+01 -9.55366193e+00 -9.55366193e+00
 -9.55366193e+00 -1.24790971e+00 -5.74481341e-01 -5.74481341e-01
 -5.74481341e-01  1.02675812e+00  1.02675812e+00  1.02675812e+00
  7.28132502e+00  7.28132502e+00  7.28132502e+00  8.29330526e+00
  3.33966731e+01  3.33966731e+01  3.33966731e+01  9.84636852e+01
  1.28955500e+02  1.28955500e+02  1.28955500e+02  4.83290623e+02
  4.83290623e+02  4.83290623e+02  5.79319493e+02  1.33513120e+03
  1.33513120e+03  1.33513120e+03  2.64834661e+03  3.02937729e+03
  3.02937729e+03  3.02937729e+03  6.64982016e+03  6.64982016e+03
  6.64982016e+03  9.05436225e+03  2.54102699e+04  7.61530010e+04]
E1 = -728.3217948621636  E_coul = 201.622426951807
cycle= 3 E= -526.699367910357  delta_E= -3.71e-05  |g|= 0.00493  |ddm|= 0.0109
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0107364
diis-c [-5.76121265e-07 -1.21068300e-03  1.30634680e-01  8.70576003e-01]
  HOMO = -0.575426060884256  LUMO = 1.02605728413309
  mo_energy =
[-1.18578028e+02 -1.23035017e+01 -9.55809708e+00 -9.55809708e+00
 -9.55809708e+00 -1.24904226e+00 -5.75426061e-01 -5.75426061e-01
 -5.75426061e-01  1.02605728e+00  1.02605728e+00  1.02605728e+00
  7.27875438e+00  7.27875438e+00  7.27875438e+00  8.29034337e+00
  3.33921909e+01  3.33921909e+01  3.33921909e+01  9.84574576e+01
  1.28949176e+02  1.28949176e+02  1.28949176e+02  4.83282994e+02
  4.83282994e+02  4.83282994e+02  5.79311537e+02  1.33512304e+03
  1.33512304e+03  1.33512304e+03  2.64833786e+03  3.02936877e+03
  3.02936877e+03  3.02936877e+03  6.64981128e+03  6.64981128e+03
  6.64981128e+03  9.05435317e+03  2.54102606e+04  7.61529916e+04]
E1 = -728.3365863398698  E_coul = 201.6372175253596
cycle= 4 E= -526.69936881451  delta_E= -9.04e-07  |g|= 7.13e-05  |ddm|= 0.00138
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000140732
diis-c [-1.65110144e-09  6.73392563e-05 -9.19689088e-03 -7.30153566e-02
  1.08214491e+00]
  HOMO = -0.575411304271603  LUMO = 1.02606831511277
  mo_energy =
[-1.18578032e+02 -1.23034677e+01 -9.55807646e+00 -9.55807646e+00
 -9.55807646e+00 -1.24901841e+00 -5.75411304e-01 -5.75411304e-01
 -5.75411304e-01  1.02606832e+00  1.02606832e+00  1.02606832e+00
  7.27877914e+00  7.27877914e+00  7.27877914e+00  8.29038616e+00
  3.33922103e+01  3.33922103e+01  3.33922103e+01  9.84574728e+01
  1.28949186e+02  1.28949186e+02  1.28949186e+02  4.83282992e+02
  4.83282992e+02  4.83282992e+02  5.79311526e+02  1.33512303e+03
  1.33512303e+03  1.33512303e+03  2.64833783e+03  3.02936875e+03
  3.02936875e+03  3.02936875e+03  6.64981124e+03  6.64981124e+03
  6.64981124e+03  9.05435312e+03  2.54102606e+04  7.61529916e+04]
E1 = -728.3365846310027  E_coul = 201.63721581630497
cycle= 5 E= -526.699368814698  delta_E= -1.87e-10  |g|= 9.08e-06  |ddm|= 3.53e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3365846310027  E_coul = 201.63721581630497
  HOMO = -0.575415278050793  LUMO = 1.02606541520499
  mo_energy =
[-1.18578052e+02 -1.23034818e+01 -9.55809135e+00 -9.55809135e+00
 -9.55809135e+00 -1.24902322e+00 -5.75415278e-01 -5.75415278e-01
 -5.75415278e-01  1.02606542e+00  1.02606542e+00  1.02606542e+00
  7.27876943e+00  7.27876943e+00  7.27876943e+00  8.29037538e+00
  3.33921957e+01  3.33921957e+01  3.33921957e+01  9.84574550e+01
  1.28949168e+02  1.28949168e+02  1.28949168e+02  4.83282972e+02
  4.83282972e+02  4.83282972e+02  5.79311506e+02  1.33512301e+03
  1.33512301e+03  1.33512301e+03  2.64833780e+03  3.02936873e+03
  3.02936873e+03  3.02936873e+03  6.64981122e+03  6.64981122e+03
  6.64981122e+03  9.05435310e+03  2.54102605e+04  7.61529915e+04]
E1 = -728.33663022834  E_coul = 201.63726141363736
Extra cycle  E= -526.699368814703  delta_E= -5e-12  |g|= 2.73e-06  |ddm|= 4.74e-06
    CPU time for scf_cycle      7.07 sec, wall time      0.51 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102057.68300565485
E1 = -728.33663022834  E_coul = 201.63726141363736
init E= -526.699368814703
    CPU time for initialize scf     15.95 sec, wall time      0.77 sec
  HOMO = -0.575414442129709  LUMO = 1.02606603382202
  mo_energy =
[-1.18578046e+02 -1.23034784e+01 -9.55808789e+00 -9.55808789e+00
 -9.55808789e+00 -1.24902217e+00 -5.75414442e-01 -5.75414442e-01
 -5.75414442e-01  1.02606603e+00  1.02606603e+00  1.02606603e+00
  7.27877156e+00  7.27877156e+00  7.27877156e+00  8.29037791e+00
  3.33921992e+01  3.33921992e+01  3.33921992e+01  9.84574597e+01
  1.28949173e+02  1.28949173e+02  1.28949173e+02  4.83282977e+02
  4.83282977e+02  4.83282977e+02  5.79311512e+02  1.33512301e+03
  1.33512301e+03  1.33512301e+03  2.64833781e+03  3.02936873e+03
  3.02936873e+03  3.02936873e+03  6.64981122e+03  6.64981122e+03
  6.64981122e+03  9.05435311e+03  2.54102605e+04  7.61529916e+04]
E1 = -728.3366192816222  E_coul = 201.6372504669192
cycle= 1 E= -526.699368814703  delta_E= -3.41e-13  |g|= 7.07e-07  |ddm|= 1.13e-06
    CPU time for cycle= 1      0.04 sec, wall time      0.02 sec
E1 = -728.3366192816222  E_coul = 201.6372504669192
  HOMO = -0.575414628261379  LUMO = 1.02606589543153
  mo_energy =
[-1.18578048e+02 -1.23034792e+01 -9.55808872e+00 -9.55808872e+00
 -9.55808872e+00 -1.24902240e+00 -5.75414628e-01 -5.75414628e-01
 -5.75414628e-01  1.02606590e+00  1.02606590e+00  1.02606590e+00
  7.27877107e+00  7.27877107e+00  7.27877107e+00  8.29037733e+00
  3.33921983e+01  3.33921983e+01  3.33921983e+01  9.84574585e+01
  1.28949172e+02  1.28949172e+02  1.28949172e+02  4.83282976e+02
  4.83282976e+02  4.83282976e+02  5.79311510e+02  1.33512301e+03
  1.33512301e+03  1.33512301e+03  2.64833781e+03  3.02936873e+03
  3.02936873e+03  3.02936873e+03  6.64981122e+03  6.64981122e+03
  6.64981122e+03  9.05435311e+03  2.54102605e+04  7.61529915e+04]
E1 = -728.3366219886581  E_coul = 201.63725317395398
Extra cycle  E= -526.699368814704  delta_E= -1.02e-12  |g|= 1.8e-07  |ddm|= 2.64e-07
    CPU time for scf_cycle     16.08 sec, wall time      0.89 sec
exp = [2.61826559e+04 7.61752175e+03 3.61735094e+03 1.59782219e+03
 3.82851285e+02 1.08122830e+02 3.48907626e+01 7.23227988e+00
 2.89285947e+00 3.96710683e-01 1.36278323e+03 6.64745427e+02
 3.00960793e+02 3.14041241e+02 6.16232918e+01 7.33140012e+00
 2.02375305e+01 7.73673553e-01 2.80751451e+00 2.24715866e-01]
grad_E = [-1.51693374e-06  3.30790131e-06 -1.57418752e-06  6.93316222e-05
 -3.30208671e-05 -2.00796216e-04 -3.42136265e-03 -7.02926835e-03
  8.58865755e-03 -1.05800040e-02 -5.06872796e-07  5.00890781e-06
  2.36216532e-05  2.03667650e-05 -1.35698625e-05  6.20956316e-04
 -7.99199344e-05 -9.20643772e-03 -1.01233921e-03  3.61816178e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:56:17 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6559397        1
[INPUT] 0    0    [1    /1   ]  7617.52173109        1
[INPUT] 0    0    [1    /1   ]  3617.35095099        1
[INPUT] 0    0    [1    /1   ]  1597.82183012        1
[INPUT] 0    0    [1    /1   ]  382.851426589        1
[INPUT] 0    0    [1    /1   ]  108.123741493        1
[INPUT] 0    0    [1    /1   ]  34.9066737341        1
[INPUT] 0    0    [1    /1   ]  7.30253156722        1
[INPUT] 0    0    [1    /1   ]  2.91805401126        1
[INPUT] 0    0    [1    /1   ]  0.396440024247       1
[INPUT] 1    0    [1    /1   ]  1362.78323455        1
[INPUT] 1    0    [1    /1   ]  664.745401154        1
[INPUT] 1    0    [1    /1   ]  300.960671503        1
[INPUT] 1    0    [1    /1   ]  314.041135851        1
[INPUT] 1    0    [1    /1   ]  61.6233250074        1
[INPUT] 1    0    [1    /1   ]  7.32736132616        1
[INPUT] 1    0    [1    /1   ]  20.2382610935        1
[INPUT] 1    0    [1    /1   ]  0.775499899976       1
[INPUT] 1    0    [1    /1   ]  2.81396255253        1
[INPUT] 1    0    [1    /1   ]  0.22593050593        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.65593966652, 1.0]], [0, [7617.521731089754, 1.0]], [0, [3617.3509509855066, 1.0]], [0, [1597.821830119753, 1.0]], [0, [382.85142658927333, 1.0]], [0, [108.12374149342128, 1.0]], [0, [34.906673734134415, 1.0]], [0, [7.3025315672194315, 1.0]], [0, [2.9180540112591653, 1.0]], [0, [0.3964400242471324, 1.0]], [1, [1362.7832345537684, 1.0]], [1, [664.7454011536423, 1.0]], [1, [300.96067150341116, 1.0]], [1, [314.04113585072866, 1.0]], [1, [61.62332500743631, 1.0]], [1, [7.327361326157586, 1.0]], [1, [20.238261093459826, 1.0]], [1, [0.775499899975949, 1.0]], [1, [2.813962552526367, 1.0]], [1, [0.22593050593016606, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65593967]
bas 1, expnt(s) = [7617.52173109]
bas 2, expnt(s) = [3617.35095099]
bas 3, expnt(s) = [1597.82183012]
bas 4, expnt(s) = [382.85142659]
bas 5, expnt(s) = [108.12374149]
bas 6, expnt(s) = [34.90667373]
bas 7, expnt(s) = [7.30253157]
bas 8, expnt(s) = [2.91805401]
bas 9, expnt(s) = [0.39644002]
bas 10, expnt(s) = [1362.78323455]
bas 11, expnt(s) = [664.74540115]
bas 12, expnt(s) = [300.9606715]
bas 13, expnt(s) = [314.04113585]
bas 14, expnt(s) = [61.62332501]
bas 15, expnt(s) = [7.32736133]
bas 16, expnt(s) = [20.23826109]
bas 17, expnt(s) = [0.7754999]
bas 18, expnt(s) = [2.81396255]
bas 19, expnt(s) = [0.22593051]
CPU time:       396.51
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026288e+03 7.61752173e+03 2.06003833e+03
 3.61735095e+03 1.17844145e+03 1.59782183e+03 6.38500567e+02
 3.82851427e+02 2.18669256e+02 1.08123741e+02 8.47141238e+01
 3.49066737e+01 3.62824307e+01 7.30253157e+00 1.12232880e+01
 2.91805401e+00 5.64072619e+00 3.96440024e-01 1.26225804e+00
 1.36278323e+03 2.41556023e+04 6.64745401e+02 9.84699164e+03
 3.00960672e+02 3.65697151e+03 3.14041136e+02 3.85671518e+03
 6.16233250e+01 5.03692869e+02 7.32736133e+00 3.51697193e+01
 2.02382611e+01 1.25227839e+02 7.75499900e-01 2.12305661e+00
 2.81396255e+00 1.06324239e+01 2.25930506e-01 4.54415342e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.983050756219598
cond(S) = 102094.76864221857
E1 = -729.3653896881636  E_coul = 203.11804185164436
init E= -526.247347836519
    CPU time for initialize scf      7.31 sec, wall time      0.36 sec
  HOMO = -0.557028752132523  LUMO = 1.04384664121823
  mo_energy =
[-1.18331641e+02 -1.22072631e+01 -9.45186918e+00 -9.45186918e+00
 -9.45186918e+00 -1.22584482e+00 -5.57028752e-01 -5.57028752e-01
 -5.57028752e-01  1.04384664e+00  1.04384664e+00  1.04384664e+00
  7.35969765e+00  7.35969765e+00  7.35969765e+00  8.48490822e+00
  3.35281156e+01  3.35281156e+01  3.35281156e+01  9.90470274e+01
  1.29141027e+02  1.29141027e+02  1.29141027e+02  4.83541335e+02
  4.83541335e+02  4.83541335e+02  5.80021796e+02  1.33543403e+03
  1.33543403e+03  1.33543403e+03  2.64914960e+03  3.02974373e+03
  3.02974373e+03  3.02974373e+03  6.65029815e+03  6.65029815e+03
  6.65029815e+03  9.05525348e+03  2.54112361e+04  7.61540349e+04]
E1 = -727.9701668254203  E_coul = 201.27117921427572
cycle= 1 E= -526.698987611145  delta_E= -0.452  |g|= 0.186  |ddm|= 0.43
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.54509
diis-c [-0.29712345  1.        ]
  HOMO = -0.580882963139385  LUMO = 1.02818985320733
  mo_energy =
[-1.18628894e+02 -1.23300596e+01 -9.58555344e+00 -9.58555344e+00
 -9.58555344e+00 -1.25603957e+00 -5.80882963e-01 -5.80882963e-01
 -5.80882963e-01  1.02818985e+00  1.02818985e+00  1.02818985e+00
  7.28460713e+00  7.28460713e+00  7.28460713e+00  8.40195905e+00
  3.33881681e+01  3.33881681e+01  3.33881681e+01  9.88420764e+01
  1.28925386e+02  1.28925386e+02  1.28925386e+02  4.83245684e+02
  4.83245684e+02  4.83245684e+02  5.79687096e+02  1.33508050e+03
  1.33508050e+03  1.33508050e+03  2.64866021e+03  3.02932332e+03
  3.02932332e+03  3.02932332e+03  6.64976353e+03  6.64976353e+03
  6.64976353e+03  9.05464294e+03  2.54105311e+04  7.61532394e+04]
E1 = -728.4412900077938  E_coul = 201.7416886334352
cycle= 2 E= -526.699601374359  delta_E= -0.000614  |g|= 0.0341  |ddm|= 0.0397
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0679114
diis-c [-0.0026841   0.07485948  0.92514052]
  HOMO = -0.574070248372323  LUMO = 1.03336203625004
  mo_energy =
[-1.18569329e+02 -1.22987957e+01 -9.55294751e+00 -9.55294751e+00
 -9.55294751e+00 -1.24741597e+00 -5.74070248e-01 -5.74070248e-01
 -5.74070248e-01  1.03336204e+00  1.03336204e+00  1.03336204e+00
  7.30333212e+00  7.30333212e+00  7.30333212e+00  8.42517955e+00
  3.34213884e+01  3.34213884e+01  3.34213884e+01  9.88900972e+01
  1.28973612e+02  1.28973612e+02  1.28973612e+02  4.83304492e+02
  4.83304492e+02  4.83304492e+02  5.79748175e+02  1.33514316e+03
  1.33514316e+03  1.33514316e+03  2.64872592e+03  3.02938806e+03
  3.02938806e+03  3.02938806e+03  6.64982982e+03  6.64982982e+03
  6.64982982e+03  9.05470994e+03  2.54105986e+04  7.61533071e+04]
E1 = -728.3339260643867  E_coul = 201.6342883697184
cycle= 3 E= -526.699637694668  delta_E= -3.63e-05  |g|= 0.0049  |ddm|= 0.0107
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106636
diis-c [-5.71566152e-07 -1.20522879e-03  1.30610688e-01  8.70594541e-01]
  HOMO = -0.575001979841273  LUMO = 1.03266761683423
  mo_energy =
[-1.18576994e+02 -1.23028977e+01 -9.55733760e+00 -9.55733760e+00
 -9.55733760e+00 -1.24853288e+00 -5.75001980e-01 -5.75001980e-01
 -5.75001980e-01  1.03266762e+00  1.03266762e+00  1.03266762e+00
  7.30078996e+00  7.30078996e+00  7.30078996e+00  8.42223210e+00
  3.34169514e+01  3.34169514e+01  3.34169514e+01  9.88839229e+01
  1.28967343e+02  1.28967343e+02  1.28967343e+02  4.83296925e+02
  4.83296925e+02  4.83296925e+02  5.79740283e+02  1.33513506e+03
  1.33513506e+03  1.33513506e+03  2.64871724e+03  3.02937961e+03
  3.02937961e+03  3.02937961e+03  6.64982101e+03  6.64982101e+03
  6.64982101e+03  9.05470093e+03  2.54105894e+04  7.61532978e+04]
E1 = -728.3485267520828  E_coul = 201.6488881734804
cycle= 4 E= -526.699638578602  delta_E= -8.84e-07  |g|= 7.09e-05  |ddm|= 0.00136
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000139842
diis-c [-1.63623617e-09  6.75918628e-05 -9.23639917e-03 -7.32882520e-02
  1.08245706e+00]
  HOMO = -0.574987205767639  LUMO = 1.032678699752
  mo_energy =
[-1.18576997e+02 -1.23028636e+01 -9.55731682e+00 -9.55731682e+00
 -9.55731682e+00 -1.24850911e+00 -5.74987206e-01 -5.74987206e-01
 -5.74987206e-01  1.03267870e+00  1.03267870e+00  1.03267870e+00
  7.30081482e+00  7.30081482e+00  7.30081482e+00  8.42227493e+00
  3.34169710e+01  3.34169710e+01  3.34169710e+01  9.88839383e+01
  1.28967354e+02  1.28967354e+02  1.28967354e+02  4.83296923e+02
  4.83296923e+02  4.83296923e+02  5.79740273e+02  1.33513505e+03
  1.33513505e+03  1.33513505e+03  2.64871720e+03  3.02937959e+03
  3.02937959e+03  3.02937959e+03  6.64982097e+03  6.64982097e+03
  6.64982097e+03  9.05470088e+03  2.54105894e+04  7.61532978e+04]
E1 = -728.3485249385573  E_coul = 201.6488863597697
cycle= 5 E= -526.699638578788  delta_E= -1.85e-10  |g|= 8.98e-06  |ddm|= 3.47e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3485249385573  E_coul = 201.6488863597697
  HOMO = -0.574991138017128  LUMO = 1.03267581755919
  mo_energy =
[-1.18577017e+02 -1.23028776e+01 -9.55733154e+00 -9.55733154e+00
 -9.55733154e+00 -1.24851387e+00 -5.74991138e-01 -5.74991138e-01
 -5.74991138e-01  1.03267582e+00  1.03267582e+00  1.03267582e+00
  7.30080521e+00  7.30080521e+00  7.30080521e+00  8.42226419e+00
  3.34169566e+01  3.34169566e+01  3.34169566e+01  9.88839208e+01
  1.28967336e+02  1.28967336e+02  1.28967336e+02  4.83296903e+02
  4.83296903e+02  4.83296903e+02  5.79740253e+02  1.33513503e+03
  1.33513503e+03  1.33513503e+03  2.64871718e+03  3.02937957e+03
  3.02937957e+03  3.02937957e+03  6.64982095e+03  6.64982095e+03
  6.64982095e+03  9.05470086e+03  2.54105893e+04  7.61532977e+04]
E1 = -728.3485697940067  E_coul = 201.64893121521393
Extra cycle  E= -526.699638578793  delta_E= -5.23e-12  |g|= 2.69e-06  |ddm|= 4.66e-06
    CPU time for scf_cycle      7.49 sec, wall time      0.54 sec
exp = [2.61826559e+04 7.61752173e+03 3.61735095e+03 1.59782183e+03
 3.82851427e+02 1.08123741e+02 3.49066737e+01 7.30253157e+00
 2.91805401e+00 3.96440024e-01 1.36278323e+03 6.64745401e+02
 3.00960672e+02 3.14041136e+02 6.16233250e+01 7.32736133e+00
 2.02382611e+01 7.75499900e-01 2.81396255e+00 2.25930506e-01]
E = -526.6996385787928
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:56:18 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6559397        1
[INPUT] 0    0    [1    /1   ]  7617.52173109        1
[INPUT] 0    0    [1    /1   ]  3617.35095099        1
[INPUT] 0    0    [1    /1   ]  1597.82183012        1
[INPUT] 0    0    [1    /1   ]  382.851426589        1
[INPUT] 0    0    [1    /1   ]  108.123741493        1
[INPUT] 0    0    [1    /1   ]  34.9066737341        1
[INPUT] 0    0    [1    /1   ]  7.30253156722        1
[INPUT] 0    0    [1    /1   ]  2.91805401126        1
[INPUT] 0    0    [1    /1   ]  0.396440024247       1
[INPUT] 1    0    [1    /1   ]  1362.78323455        1
[INPUT] 1    0    [1    /1   ]  664.745401154        1
[INPUT] 1    0    [1    /1   ]  300.960671503        1
[INPUT] 1    0    [1    /1   ]  314.041135851        1
[INPUT] 1    0    [1    /1   ]  61.6233250074        1
[INPUT] 1    0    [1    /1   ]  7.32736132616        1
[INPUT] 1    0    [1    /1   ]  20.2382610935        1
[INPUT] 1    0    [1    /1   ]  0.775499899976       1
[INPUT] 1    0    [1    /1   ]  2.81396255253        1
[INPUT] 1    0    [1    /1   ]  0.22593050593        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.65593966652, 1.0]], [0, [7617.521731089754, 1.0]], [0, [3617.3509509855066, 1.0]], [0, [1597.821830119753, 1.0]], [0, [382.85142658927333, 1.0]], [0, [108.12374149342128, 1.0]], [0, [34.906673734134415, 1.0]], [0, [7.3025315672194315, 1.0]], [0, [2.9180540112591653, 1.0]], [0, [0.3964400242471324, 1.0]], [1, [1362.7832345537684, 1.0]], [1, [664.7454011536423, 1.0]], [1, [300.96067150341116, 1.0]], [1, [314.04113585072866, 1.0]], [1, [61.62332500743631, 1.0]], [1, [7.327361326157586, 1.0]], [1, [20.238261093459826, 1.0]], [1, [0.775499899975949, 1.0]], [1, [2.813962552526367, 1.0]], [1, [0.22593050593016606, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65593967]
bas 1, expnt(s) = [7617.52173109]
bas 2, expnt(s) = [3617.35095099]
bas 3, expnt(s) = [1597.82183012]
bas 4, expnt(s) = [382.85142659]
bas 5, expnt(s) = [108.12374149]
bas 6, expnt(s) = [34.90667373]
bas 7, expnt(s) = [7.30253157]
bas 8, expnt(s) = [2.91805401]
bas 9, expnt(s) = [0.39644002]
bas 10, expnt(s) = [1362.78323455]
bas 11, expnt(s) = [664.74540115]
bas 12, expnt(s) = [300.9606715]
bas 13, expnt(s) = [314.04113585]
bas 14, expnt(s) = [61.62332501]
bas 15, expnt(s) = [7.32736133]
bas 16, expnt(s) = [20.23826109]
bas 17, expnt(s) = [0.7754999]
bas 18, expnt(s) = [2.81396255]
bas 19, expnt(s) = [0.22593051]
CPU time:       404.08
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026288e+03 7.61752173e+03 2.06003833e+03
 3.61735095e+03 1.17844145e+03 1.59782183e+03 6.38500567e+02
 3.82851427e+02 2.18669256e+02 1.08123741e+02 8.47141238e+01
 3.49066737e+01 3.62824307e+01 7.30253157e+00 1.12232880e+01
 2.91805401e+00 5.64072619e+00 3.96440024e-01 1.26225804e+00
 1.36278323e+03 2.41556023e+04 6.64745401e+02 9.84699164e+03
 3.00960672e+02 3.65697151e+03 3.14041136e+02 3.85671518e+03
 6.16233250e+01 5.03692869e+02 7.32736133e+00 3.51697193e+01
 2.02382611e+01 1.25227839e+02 7.75499900e-01 2.12305661e+00
 2.81396255e+00 1.06324239e+01 2.25930506e-01 4.54415342e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.983050756219598
cond(S) = 102094.76864221857
E1 = -729.3653896881636  E_coul = 203.11804185164436
init E= -526.247347836519
    CPU time for initialize scf      7.32 sec, wall time      0.35 sec
  HOMO = -0.557028752132523  LUMO = 1.04384664121823
  mo_energy =
[-1.18331641e+02 -1.22072631e+01 -9.45186918e+00 -9.45186918e+00
 -9.45186918e+00 -1.22584482e+00 -5.57028752e-01 -5.57028752e-01
 -5.57028752e-01  1.04384664e+00  1.04384664e+00  1.04384664e+00
  7.35969765e+00  7.35969765e+00  7.35969765e+00  8.48490822e+00
  3.35281156e+01  3.35281156e+01  3.35281156e+01  9.90470274e+01
  1.29141027e+02  1.29141027e+02  1.29141027e+02  4.83541335e+02
  4.83541335e+02  4.83541335e+02  5.80021796e+02  1.33543403e+03
  1.33543403e+03  1.33543403e+03  2.64914960e+03  3.02974373e+03
  3.02974373e+03  3.02974373e+03  6.65029815e+03  6.65029815e+03
  6.65029815e+03  9.05525348e+03  2.54112361e+04  7.61540349e+04]
E1 = -727.9701668254203  E_coul = 201.27117921427572
cycle= 1 E= -526.698987611145  delta_E= -0.452  |g|= 0.186  |ddm|= 0.43
    CPU time for cycle= 1      0.08 sec, wall time      0.03 sec
diis-norm(errvec)=0.54509
diis-c [-0.29712345  1.        ]
  HOMO = -0.580882963139385  LUMO = 1.02818985320733
  mo_energy =
[-1.18628894e+02 -1.23300596e+01 -9.58555344e+00 -9.58555344e+00
 -9.58555344e+00 -1.25603957e+00 -5.80882963e-01 -5.80882963e-01
 -5.80882963e-01  1.02818985e+00  1.02818985e+00  1.02818985e+00
  7.28460713e+00  7.28460713e+00  7.28460713e+00  8.40195905e+00
  3.33881681e+01  3.33881681e+01  3.33881681e+01  9.88420764e+01
  1.28925386e+02  1.28925386e+02  1.28925386e+02  4.83245684e+02
  4.83245684e+02  4.83245684e+02  5.79687096e+02  1.33508050e+03
  1.33508050e+03  1.33508050e+03  2.64866021e+03  3.02932332e+03
  3.02932332e+03  3.02932332e+03  6.64976353e+03  6.64976353e+03
  6.64976353e+03  9.05464294e+03  2.54105311e+04  7.61532394e+04]
E1 = -728.4412900077938  E_coul = 201.7416886334352
cycle= 2 E= -526.699601374359  delta_E= -0.000614  |g|= 0.0341  |ddm|= 0.0397
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0679114
diis-c [-0.0026841   0.07485948  0.92514052]
  HOMO = -0.574070248372323  LUMO = 1.03336203625004
  mo_energy =
[-1.18569329e+02 -1.22987957e+01 -9.55294751e+00 -9.55294751e+00
 -9.55294751e+00 -1.24741597e+00 -5.74070248e-01 -5.74070248e-01
 -5.74070248e-01  1.03336204e+00  1.03336204e+00  1.03336204e+00
  7.30333212e+00  7.30333212e+00  7.30333212e+00  8.42517955e+00
  3.34213884e+01  3.34213884e+01  3.34213884e+01  9.88900972e+01
  1.28973612e+02  1.28973612e+02  1.28973612e+02  4.83304492e+02
  4.83304492e+02  4.83304492e+02  5.79748175e+02  1.33514316e+03
  1.33514316e+03  1.33514316e+03  2.64872592e+03  3.02938806e+03
  3.02938806e+03  3.02938806e+03  6.64982982e+03  6.64982982e+03
  6.64982982e+03  9.05470994e+03  2.54105986e+04  7.61533071e+04]
E1 = -728.3339260643867  E_coul = 201.6342883697184
cycle= 3 E= -526.699637694668  delta_E= -3.63e-05  |g|= 0.0049  |ddm|= 0.0107
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106636
diis-c [-5.71566152e-07 -1.20522879e-03  1.30610688e-01  8.70594541e-01]
  HOMO = -0.575001979841273  LUMO = 1.03266761683423
  mo_energy =
[-1.18576994e+02 -1.23028977e+01 -9.55733760e+00 -9.55733760e+00
 -9.55733760e+00 -1.24853288e+00 -5.75001980e-01 -5.75001980e-01
 -5.75001980e-01  1.03266762e+00  1.03266762e+00  1.03266762e+00
  7.30078996e+00  7.30078996e+00  7.30078996e+00  8.42223210e+00
  3.34169514e+01  3.34169514e+01  3.34169514e+01  9.88839229e+01
  1.28967343e+02  1.28967343e+02  1.28967343e+02  4.83296925e+02
  4.83296925e+02  4.83296925e+02  5.79740283e+02  1.33513506e+03
  1.33513506e+03  1.33513506e+03  2.64871724e+03  3.02937961e+03
  3.02937961e+03  3.02937961e+03  6.64982101e+03  6.64982101e+03
  6.64982101e+03  9.05470093e+03  2.54105894e+04  7.61532978e+04]
E1 = -728.3485267520828  E_coul = 201.6488881734804
cycle= 4 E= -526.699638578602  delta_E= -8.84e-07  |g|= 7.09e-05  |ddm|= 0.00136
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000139842
diis-c [-1.63623617e-09  6.75918628e-05 -9.23639917e-03 -7.32882520e-02
  1.08245706e+00]
  HOMO = -0.574987205767639  LUMO = 1.032678699752
  mo_energy =
[-1.18576997e+02 -1.23028636e+01 -9.55731682e+00 -9.55731682e+00
 -9.55731682e+00 -1.24850911e+00 -5.74987206e-01 -5.74987206e-01
 -5.74987206e-01  1.03267870e+00  1.03267870e+00  1.03267870e+00
  7.30081482e+00  7.30081482e+00  7.30081482e+00  8.42227493e+00
  3.34169710e+01  3.34169710e+01  3.34169710e+01  9.88839383e+01
  1.28967354e+02  1.28967354e+02  1.28967354e+02  4.83296923e+02
  4.83296923e+02  4.83296923e+02  5.79740273e+02  1.33513505e+03
  1.33513505e+03  1.33513505e+03  2.64871720e+03  3.02937959e+03
  3.02937959e+03  3.02937959e+03  6.64982097e+03  6.64982097e+03
  6.64982097e+03  9.05470088e+03  2.54105894e+04  7.61532978e+04]
E1 = -728.3485249385573  E_coul = 201.6488863597697
cycle= 5 E= -526.699638578788  delta_E= -1.85e-10  |g|= 8.98e-06  |ddm|= 3.47e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3485249385573  E_coul = 201.6488863597697
  HOMO = -0.574991138017128  LUMO = 1.03267581755919
  mo_energy =
[-1.18577017e+02 -1.23028776e+01 -9.55733154e+00 -9.55733154e+00
 -9.55733154e+00 -1.24851387e+00 -5.74991138e-01 -5.74991138e-01
 -5.74991138e-01  1.03267582e+00  1.03267582e+00  1.03267582e+00
  7.30080521e+00  7.30080521e+00  7.30080521e+00  8.42226419e+00
  3.34169566e+01  3.34169566e+01  3.34169566e+01  9.88839208e+01
  1.28967336e+02  1.28967336e+02  1.28967336e+02  4.83296903e+02
  4.83296903e+02  4.83296903e+02  5.79740253e+02  1.33513503e+03
  1.33513503e+03  1.33513503e+03  2.64871718e+03  3.02937957e+03
  3.02937957e+03  3.02937957e+03  6.64982095e+03  6.64982095e+03
  6.64982095e+03  9.05470086e+03  2.54105893e+04  7.61532977e+04]
E1 = -728.3485697940067  E_coul = 201.64893121521393
Extra cycle  E= -526.699638578793  delta_E= -5.23e-12  |g|= 2.69e-06  |ddm|= 4.66e-06
    CPU time for scf_cycle      7.55 sec, wall time      0.53 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102094.76864221857
E1 = -728.3485697940067  E_coul = 201.64893121521393
init E= -526.699638578793
    CPU time for initialize scf     15.88 sec, wall time      0.74 sec
  HOMO = -0.574990317514707  LUMO = 1.03267642740848
  mo_energy =
[-1.18577011e+02 -1.23028743e+01 -9.55732814e+00 -9.55732814e+00
 -9.55732814e+00 -1.24851285e+00 -5.74990318e-01 -5.74990318e-01
 -5.74990318e-01  1.03267643e+00  1.03267643e+00  1.03267643e+00
  7.30080730e+00  7.30080730e+00  7.30080730e+00  8.42226669e+00
  3.34169600e+01  3.34169600e+01  3.34169600e+01  9.88839254e+01
  1.28967340e+02  1.28967340e+02  1.28967340e+02  4.83296909e+02
  4.83296909e+02  4.83296909e+02  5.79740259e+02  1.33513503e+03
  1.33513503e+03  1.33513503e+03  2.64871719e+03  3.02937958e+03
  3.02937958e+03  3.02937958e+03  6.64982096e+03  6.64982096e+03
  6.64982096e+03  9.05470087e+03  2.54105893e+04  7.61532978e+04]
E1 = -728.3485590615935  E_coul = 201.6489204828012
cycle= 1 E= -526.699638578792  delta_E= 5.68e-13  |g|= 6.95e-07  |ddm|= 1.1e-06
    CPU time for cycle= 1      0.04 sec, wall time      0.02 sec
E1 = -728.3485590615935  E_coul = 201.6489204828012
  HOMO = -0.574990499593179  LUMO = 1.03267629141205
  mo_energy =
[-1.18577013e+02 -1.23028751e+01 -9.55732896e+00 -9.55732896e+00
 -9.55732896e+00 -1.24851307e+00 -5.74990500e-01 -5.74990500e-01
 -5.74990500e-01  1.03267629e+00  1.03267629e+00  1.03267629e+00
  7.30080682e+00  7.30080682e+00  7.30080682e+00  8.42226612e+00
  3.34169592e+01  3.34169592e+01  3.34169592e+01  9.88839242e+01
  1.28967339e+02  1.28967339e+02  1.28967339e+02  4.83296907e+02
  4.83296907e+02  4.83296907e+02  5.79740257e+02  1.33513503e+03
  1.33513503e+03  1.33513503e+03  2.64871719e+03  3.02937957e+03
  3.02937957e+03  3.02937957e+03  6.64982096e+03  6.64982096e+03
  6.64982096e+03  9.05470087e+03  2.54105893e+04  7.61532977e+04]
E1 = -728.3485617059455  E_coul = 201.64892312715318
Extra cycle  E= -526.699638578792  delta_E=    0  |g|= 1.76e-07  |ddm|= 2.58e-07
    CPU time for scf_cycle     16.01 sec, wall time      0.85 sec
exp = [2.61826559e+04 7.61752173e+03 3.61735095e+03 1.59782183e+03
 3.82851427e+02 1.08123741e+02 3.49066737e+01 7.30253157e+00
 2.91805401e+00 3.96440024e-01 1.36278323e+03 6.64745401e+02
 3.00960672e+02 3.14041136e+02 6.16233250e+01 7.32736133e+00
 2.02382611e+01 7.75499900e-01 2.81396255e+00 2.25930506e-01]
grad_E = [-1.51670306e-06  3.30486311e-06 -1.57662090e-06  6.92120770e-05
 -2.92848249e-05 -2.39966732e-04 -3.32815328e-03 -6.39974108e-03
  8.73327141e-03 -1.38671057e-02 -5.03595186e-07  5.05378297e-06
  2.38961529e-05  2.06022347e-05 -4.82166819e-05 -6.99183707e-04
  2.60833742e-04 -1.22546299e-02  7.36889414e-04  5.33290239e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:56:23 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.655971         1
[INPUT] 0    0    [1    /1   ]  7617.52166278        1
[INPUT] 0    0    [1    /1   ]  3617.35098327        1
[INPUT] 0    0    [1    /1   ]  1597.82039895        1
[INPUT] 0    0    [1    /1   ]  382.852000826        1
[INPUT] 0    0    [1    /1   ]  108.127648915        1
[INPUT] 0    0    [1    /1   ]  34.9711266352        1
[INPUT] 0    0    [1    /1   ]  7.54765485849        1
[INPUT] 0    0    [1    /1   ]  2.98700563341        1
[INPUT] 0    0    [1    /1   ]  0.3968264331         1
[INPUT] 1    0    [1    /1   ]  1362.78324503        1
[INPUT] 1    0    [1    /1   ]  664.745297754        1
[INPUT] 1    0    [1    /1   ]  300.960183957        1
[INPUT] 1    0    [1    /1   ]  314.040715486        1
[INPUT] 1    0    [1    /1   ]  61.6235744514        1
[INPUT] 1    0    [1    /1   ]  7.31555145645        1
[INPUT] 1    0    [1    /1   ]  20.240054317         1
[INPUT] 1    0    [1    /1   ]  0.77791137874        1
[INPUT] 1    0    [1    /1   ]  2.83446324331        1
[INPUT] 1    0    [1    /1   ]  0.226821912463       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.655970985157, 1.0]], [0, [7617.521662780925, 1.0]], [0, [3617.350983268856, 1.0]], [0, [1597.8203989516644, 1.0]], [0, [382.8520008255589, 1.0]], [0, [108.12764891514297, 1.0]], [0, [34.971126635154484, 1.0]], [0, [7.54765485849359, 1.0]], [0, [2.987005633413576, 1.0]], [0, [0.396826433099775, 1.0]], [1, [1362.7832450288013, 1.0]], [1, [664.7452977542886, 1.0]], [1, [300.96018395727225, 1.0]], [1, [314.04071548572904, 1.0]], [1, [61.62357445143431, 1.0]], [1, [7.315551456448499, 1.0]], [1, [20.240054317008475, 1.0]], [1, [0.7779113787402706, 1.0]], [1, [2.834463243314093, 1.0]], [1, [0.22682191246293418, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65597099]
bas 1, expnt(s) = [7617.52166278]
bas 2, expnt(s) = [3617.35098327]
bas 3, expnt(s) = [1597.82039895]
bas 4, expnt(s) = [382.85200083]
bas 5, expnt(s) = [108.12764892]
bas 6, expnt(s) = [34.97112664]
bas 7, expnt(s) = [7.54765486]
bas 8, expnt(s) = [2.98700563]
bas 9, expnt(s) = [0.39682643]
bas 10, expnt(s) = [1362.78324503]
bas 11, expnt(s) = [664.74529775]
bas 12, expnt(s) = [300.96018396]
bas 13, expnt(s) = [314.04071549]
bas 14, expnt(s) = [61.62357445]
bas 15, expnt(s) = [7.31555146]
bas 16, expnt(s) = [20.24005432]
bas 17, expnt(s) = [0.77791138]
bas 18, expnt(s) = [2.83446324]
bas 19, expnt(s) = [0.22682191]
CPU time:       432.38
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826560e+04 5.20026288e+03 7.61752166e+03 2.06003831e+03
 3.61735098e+03 1.17844145e+03 1.59782040e+03 6.38500138e+02
 3.82852001e+02 2.18669502e+02 1.08127649e+02 8.47164199e+01
 3.49711266e+01 3.63326640e+01 7.54765486e+00 1.15046669e+01
 2.98700563e+00 5.74039867e+00 3.96826433e-01 1.26318066e+00
 1.36278325e+03 2.41556025e+04 6.64745298e+02 9.84698973e+03
 3.00960184e+02 3.65696410e+03 3.14040715e+02 3.85670872e+03
 6.16235745e+01 5.03695418e+02 7.31555146e+00 3.50988776e+01
 2.02400543e+01 1.25241709e+02 7.77911379e-01 2.13131209e+00
 2.83446324e+00 1.07293381e+01 2.26821912e-01 4.56657561e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98281615628388
cond(S) = 102212.9308677045
E1 = -729.3666398579913  E_coul = 203.1167317961116
init E= -526.24990806188
    CPU time for initialize scf      7.58 sec, wall time      0.35 sec
  HOMO = -0.557040842028814  LUMO = 1.04962287161895
  mo_energy =
[-1.18331776e+02 -1.22078132e+01 -9.45197357e+00 -9.45197357e+00
 -9.45197357e+00 -1.22583555e+00 -5.57040842e-01 -5.57040842e-01
 -5.57040842e-01  1.04962287e+00  1.04962287e+00  1.04962287e+00
  7.40320850e+00  7.40320850e+00  7.40320850e+00  8.90806140e+00
  3.35854851e+01  3.35854851e+01  3.35854851e+01  1.00467644e+02
  1.29182293e+02  1.29182293e+02  1.29182293e+02  4.83572363e+02
  4.83572363e+02  4.83572363e+02  5.81483601e+02  1.33545990e+03
  1.33545990e+03  1.33545990e+03  2.65045000e+03  3.02976625e+03
  3.02976625e+03  3.02976625e+03  6.65031757e+03  6.65031757e+03
  6.65031757e+03  9.05644608e+03  2.54123635e+04  7.61550844e+04]
E1 = -727.9887077044967  E_coul = 201.288931453796
cycle= 1 E= -526.699776250701  delta_E= -0.45  |g|= 0.185  |ddm|= 0.443
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.543863
diis-c [-0.29578655  1.        ]
  HOMO = -0.58043923298971  LUMO = 1.03420327473393
  mo_energy =
[-1.18626553e+02 -1.23294383e+01 -9.58431869e+00 -9.58431869e+00
 -9.58431869e+00 -1.25554783e+00 -5.80439233e-01 -5.80439233e-01
 -5.80439233e-01  1.03420327e+00  1.03420327e+00  1.03420327e+00
  7.32894117e+00  7.32894117e+00  7.32894117e+00  8.82434329e+00
  3.34470415e+01  3.34470415e+01  3.34470415e+01  1.00263943e+02
  1.28968648e+02  1.28968648e+02  1.28968648e+02  4.83279045e+02
  4.83279045e+02  4.83279045e+02  5.81151585e+02  1.33510908e+03
  1.33510908e+03  1.33510908e+03  2.64996358e+03  3.02934867e+03
  3.02934867e+03  3.02934867e+03  6.64978598e+03  6.64978598e+03
  6.64978598e+03  9.05583869e+03  2.54116617e+04  7.61542923e+04]
E1 = -728.4533243926152  E_coul = 201.75294600510736
cycle= 2 E= -526.700378387508  delta_E= -0.000602  |g|= 0.0338  |ddm|= 0.0391
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0673281
diis-c [-0.00265935  0.07403221  0.92596779]
  HOMO = -0.573738269984838  LUMO = 1.03932026899908
  mo_energy =
[-1.18567622e+02 -1.22985842e+01 -9.55214625e+00 -9.55214625e+00
 -9.55214625e+00 -1.24705867e+00 -5.73738270e-01 -5.73738270e-01
 -5.73738270e-01  1.03932027e+00  1.03932027e+00  1.03932027e+00
  7.34743605e+00  7.34743605e+00  7.34743605e+00  8.84771566e+00
  3.34798289e+01  3.34798289e+01  3.34798289e+01  1.00311445e+02
  1.29016320e+02  1.29016320e+02  1.29016320e+02  4.83337224e+02
  4.83337224e+02  4.83337224e+02  5.81212011e+02  1.33517108e+03
  1.33517108e+03  1.33517108e+03  2.65002861e+03  3.02941274e+03
  3.02941274e+03  3.02941274e+03  6.64985159e+03  6.64985159e+03
  6.64985159e+03  9.05590501e+03  2.54117285e+04  7.61543593e+04]
E1 = -728.3479204355571  E_coul = 201.64750686270082
cycle= 3 E= -526.700413572856  delta_E= -3.52e-05  |g|= 0.00484  |ddm|= 0.0104
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0105542
diis-c [-5.49392902e-07 -1.18774064e-03  1.30486758e-01  8.70700982e-01]
  HOMO = -0.574654351756148  LUMO = 1.03863330980025
  mo_energy =
[-1.18575196e+02 -1.23026269e+01 -9.55647209e+00 -9.55647209e+00
 -9.55647209e+00 -1.24815944e+00 -5.74654352e-01 -5.74654352e-01
 -5.74654352e-01  1.03863331e+00  1.03863331e+00  1.03863331e+00
  7.34492824e+00  7.34492824e+00  7.34492824e+00  8.84475152e+00
  3.34754560e+01  3.34754560e+01  3.34754560e+01  1.00305342e+02
  1.29010132e+02  1.29010132e+02  1.29010132e+02  4.83329746e+02
  4.83329746e+02  4.83329746e+02  5.81204212e+02  1.33516308e+03
  1.33516308e+03  1.33516308e+03  2.65002003e+03  3.02940439e+03
  3.02940439e+03  3.02940439e+03  6.64984288e+03  6.64984288e+03
  6.64984288e+03  9.05589610e+03  2.54117194e+04  7.61543501e+04]
E1 = -728.3622374537151  E_coul = 201.661823027129
cycle= 4 E= -526.700414426586  delta_E= -8.54e-07  |g|= 6.86e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00013661
diis-c [-1.57540595e-09  6.75901547e-05 -9.25141510e-03 -7.33102471e-02
  1.08249407e+00]
  HOMO = -0.574640071966597  LUMO = 1.03864405083829
  mo_energy =
[-1.18575199e+02 -1.23025935e+01 -9.55645175e+00 -9.55645175e+00
 -9.55645175e+00 -1.24813665e+00 -5.74640072e-01 -5.74640072e-01
 -5.74640072e-01  1.03864405e+00  1.03864405e+00  1.03864405e+00
  7.34495243e+00  7.34495243e+00  7.34495243e+00  8.84479309e+00
  3.34754751e+01  3.34754751e+01  3.34754751e+01  1.00305357e+02
  1.29010142e+02  1.29010142e+02  1.29010142e+02  4.83329744e+02
  4.83329744e+02  4.83329744e+02  5.81204202e+02  1.33516307e+03
  1.33516307e+03  1.33516307e+03  2.65002000e+03  3.02940437e+03
  3.02940437e+03  3.02940437e+03  6.64984284e+03  6.64984284e+03
  6.64984284e+03  9.05589606e+03  2.54117194e+04  7.61543500e+04]
E1 = -728.3622353040037  E_coul = 201.66182087725238
cycle= 5 E= -526.700414426751  delta_E= -1.65e-10  |g|= 8.69e-06  |ddm|= 3.18e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3622353040037  E_coul = 201.66182087725238
  HOMO = -0.574643894944776  LUMO = 1.03864123220411
  mo_energy =
[-1.18575219e+02 -1.23026071e+01 -9.55646602e+00 -9.55646602e+00
 -9.55646602e+00 -1.24814130e+00 -5.74643895e-01 -5.74643895e-01
 -5.74643895e-01  1.03864123e+00  1.03864123e+00  1.03864123e+00
  7.34494308e+00  7.34494308e+00  7.34494308e+00  8.84478247e+00
  3.34754611e+01  3.34754611e+01  3.34754611e+01  1.00305340e+02
  1.29010125e+02  1.29010125e+02  1.29010125e+02  4.83329725e+02
  4.83329725e+02  4.83329725e+02  5.81204182e+02  1.33516305e+03
  1.33516305e+03  1.33516305e+03  2.65001998e+03  3.02940435e+03
  3.02940435e+03  3.02940435e+03  6.64984282e+03  6.64984282e+03
  6.64984282e+03  9.05589604e+03  2.54117194e+04  7.61543500e+04]
E1 = -728.3622783425402  E_coul = 201.66186391578447
Extra cycle  E= -526.700414426756  delta_E= -4.43e-12  |g|= 2.58e-06  |ddm|= 4.48e-06
    CPU time for scf_cycle      7.79 sec, wall time      0.53 sec
exp = [2.61826560e+04 7.61752166e+03 3.61735098e+03 1.59782040e+03
 3.82852001e+02 1.08127649e+02 3.49711266e+01 7.54765486e+00
 2.98700563e+00 3.96826433e-01 1.36278325e+03 6.64745298e+02
 3.00960184e+02 3.14040715e+02 6.16235745e+01 7.31555146e+00
 2.02400543e+01 7.77911379e-01 2.83446324e+00 2.26821912e-01]
E = -526.7004144267557
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:56:23 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.655971         1
[INPUT] 0    0    [1    /1   ]  7617.52166278        1
[INPUT] 0    0    [1    /1   ]  3617.35098327        1
[INPUT] 0    0    [1    /1   ]  1597.82039895        1
[INPUT] 0    0    [1    /1   ]  382.852000826        1
[INPUT] 0    0    [1    /1   ]  108.127648915        1
[INPUT] 0    0    [1    /1   ]  34.9711266352        1
[INPUT] 0    0    [1    /1   ]  7.54765485849        1
[INPUT] 0    0    [1    /1   ]  2.98700563341        1
[INPUT] 0    0    [1    /1   ]  0.3968264331         1
[INPUT] 1    0    [1    /1   ]  1362.78324503        1
[INPUT] 1    0    [1    /1   ]  664.745297754        1
[INPUT] 1    0    [1    /1   ]  300.960183957        1
[INPUT] 1    0    [1    /1   ]  314.040715486        1
[INPUT] 1    0    [1    /1   ]  61.6235744514        1
[INPUT] 1    0    [1    /1   ]  7.31555145645        1
[INPUT] 1    0    [1    /1   ]  20.240054317         1
[INPUT] 1    0    [1    /1   ]  0.77791137874        1
[INPUT] 1    0    [1    /1   ]  2.83446324331        1
[INPUT] 1    0    [1    /1   ]  0.226821912463       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.655970985157, 1.0]], [0, [7617.521662780925, 1.0]], [0, [3617.350983268856, 1.0]], [0, [1597.8203989516644, 1.0]], [0, [382.8520008255589, 1.0]], [0, [108.12764891514297, 1.0]], [0, [34.971126635154484, 1.0]], [0, [7.54765485849359, 1.0]], [0, [2.987005633413576, 1.0]], [0, [0.396826433099775, 1.0]], [1, [1362.7832450288013, 1.0]], [1, [664.7452977542886, 1.0]], [1, [300.96018395727225, 1.0]], [1, [314.04071548572904, 1.0]], [1, [61.62357445143431, 1.0]], [1, [7.315551456448499, 1.0]], [1, [20.240054317008475, 1.0]], [1, [0.7779113787402706, 1.0]], [1, [2.834463243314093, 1.0]], [1, [0.22682191246293418, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65597099]
bas 1, expnt(s) = [7617.52166278]
bas 2, expnt(s) = [3617.35098327]
bas 3, expnt(s) = [1597.82039895]
bas 4, expnt(s) = [382.85200083]
bas 5, expnt(s) = [108.12764892]
bas 6, expnt(s) = [34.97112664]
bas 7, expnt(s) = [7.54765486]
bas 8, expnt(s) = [2.98700563]
bas 9, expnt(s) = [0.39682643]
bas 10, expnt(s) = [1362.78324503]
bas 11, expnt(s) = [664.74529775]
bas 12, expnt(s) = [300.96018396]
bas 13, expnt(s) = [314.04071549]
bas 14, expnt(s) = [61.62357445]
bas 15, expnt(s) = [7.31555146]
bas 16, expnt(s) = [20.24005432]
bas 17, expnt(s) = [0.77791138]
bas 18, expnt(s) = [2.83446324]
bas 19, expnt(s) = [0.22682191]
CPU time:       440.24
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826560e+04 5.20026288e+03 7.61752166e+03 2.06003831e+03
 3.61735098e+03 1.17844145e+03 1.59782040e+03 6.38500138e+02
 3.82852001e+02 2.18669502e+02 1.08127649e+02 8.47164199e+01
 3.49711266e+01 3.63326640e+01 7.54765486e+00 1.15046669e+01
 2.98700563e+00 5.74039867e+00 3.96826433e-01 1.26318066e+00
 1.36278325e+03 2.41556025e+04 6.64745298e+02 9.84698973e+03
 3.00960184e+02 3.65696410e+03 3.14040715e+02 3.85670872e+03
 6.16235745e+01 5.03695418e+02 7.31555146e+00 3.50988776e+01
 2.02400543e+01 1.25241709e+02 7.77911379e-01 2.13131209e+00
 2.83446324e+00 1.07293381e+01 2.26821912e-01 4.56657561e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98281615628388
cond(S) = 102212.9308677045
E1 = -729.3666398579913  E_coul = 203.1167317961116
init E= -526.24990806188
    CPU time for initialize scf      7.29 sec, wall time      0.34 sec
  HOMO = -0.557040842028814  LUMO = 1.04962287161895
  mo_energy =
[-1.18331776e+02 -1.22078132e+01 -9.45197357e+00 -9.45197357e+00
 -9.45197357e+00 -1.22583555e+00 -5.57040842e-01 -5.57040842e-01
 -5.57040842e-01  1.04962287e+00  1.04962287e+00  1.04962287e+00
  7.40320850e+00  7.40320850e+00  7.40320850e+00  8.90806140e+00
  3.35854851e+01  3.35854851e+01  3.35854851e+01  1.00467644e+02
  1.29182293e+02  1.29182293e+02  1.29182293e+02  4.83572363e+02
  4.83572363e+02  4.83572363e+02  5.81483601e+02  1.33545990e+03
  1.33545990e+03  1.33545990e+03  2.65045000e+03  3.02976625e+03
  3.02976625e+03  3.02976625e+03  6.65031757e+03  6.65031757e+03
  6.65031757e+03  9.05644608e+03  2.54123635e+04  7.61550844e+04]
E1 = -727.9887077044967  E_coul = 201.288931453796
cycle= 1 E= -526.699776250701  delta_E= -0.45  |g|= 0.185  |ddm|= 0.443
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.543863
diis-c [-0.29578655  1.        ]
  HOMO = -0.58043923298971  LUMO = 1.03420327473393
  mo_energy =
[-1.18626553e+02 -1.23294383e+01 -9.58431869e+00 -9.58431869e+00
 -9.58431869e+00 -1.25554783e+00 -5.80439233e-01 -5.80439233e-01
 -5.80439233e-01  1.03420327e+00  1.03420327e+00  1.03420327e+00
  7.32894117e+00  7.32894117e+00  7.32894117e+00  8.82434329e+00
  3.34470415e+01  3.34470415e+01  3.34470415e+01  1.00263943e+02
  1.28968648e+02  1.28968648e+02  1.28968648e+02  4.83279045e+02
  4.83279045e+02  4.83279045e+02  5.81151585e+02  1.33510908e+03
  1.33510908e+03  1.33510908e+03  2.64996358e+03  3.02934867e+03
  3.02934867e+03  3.02934867e+03  6.64978598e+03  6.64978598e+03
  6.64978598e+03  9.05583869e+03  2.54116617e+04  7.61542923e+04]
E1 = -728.4533243926152  E_coul = 201.75294600510736
cycle= 2 E= -526.700378387508  delta_E= -0.000602  |g|= 0.0338  |ddm|= 0.0391
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0673281
diis-c [-0.00265935  0.07403221  0.92596779]
  HOMO = -0.573738269984838  LUMO = 1.03932026899908
  mo_energy =
[-1.18567622e+02 -1.22985842e+01 -9.55214625e+00 -9.55214625e+00
 -9.55214625e+00 -1.24705867e+00 -5.73738270e-01 -5.73738270e-01
 -5.73738270e-01  1.03932027e+00  1.03932027e+00  1.03932027e+00
  7.34743605e+00  7.34743605e+00  7.34743605e+00  8.84771566e+00
  3.34798289e+01  3.34798289e+01  3.34798289e+01  1.00311445e+02
  1.29016320e+02  1.29016320e+02  1.29016320e+02  4.83337224e+02
  4.83337224e+02  4.83337224e+02  5.81212011e+02  1.33517108e+03
  1.33517108e+03  1.33517108e+03  2.65002861e+03  3.02941274e+03
  3.02941274e+03  3.02941274e+03  6.64985159e+03  6.64985159e+03
  6.64985159e+03  9.05590501e+03  2.54117285e+04  7.61543593e+04]
E1 = -728.3479204355571  E_coul = 201.64750686270082
cycle= 3 E= -526.700413572856  delta_E= -3.52e-05  |g|= 0.00484  |ddm|= 0.0104
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0105542
diis-c [-5.49392902e-07 -1.18774064e-03  1.30486758e-01  8.70700982e-01]
  HOMO = -0.574654351756148  LUMO = 1.03863330980025
  mo_energy =
[-1.18575196e+02 -1.23026269e+01 -9.55647209e+00 -9.55647209e+00
 -9.55647209e+00 -1.24815944e+00 -5.74654352e-01 -5.74654352e-01
 -5.74654352e-01  1.03863331e+00  1.03863331e+00  1.03863331e+00
  7.34492824e+00  7.34492824e+00  7.34492824e+00  8.84475152e+00
  3.34754560e+01  3.34754560e+01  3.34754560e+01  1.00305342e+02
  1.29010132e+02  1.29010132e+02  1.29010132e+02  4.83329746e+02
  4.83329746e+02  4.83329746e+02  5.81204212e+02  1.33516308e+03
  1.33516308e+03  1.33516308e+03  2.65002003e+03  3.02940439e+03
  3.02940439e+03  3.02940439e+03  6.64984288e+03  6.64984288e+03
  6.64984288e+03  9.05589610e+03  2.54117194e+04  7.61543501e+04]
E1 = -728.3622374537151  E_coul = 201.661823027129
cycle= 4 E= -526.700414426586  delta_E= -8.54e-07  |g|= 6.86e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00013661
diis-c [-1.57540595e-09  6.75901547e-05 -9.25141510e-03 -7.33102471e-02
  1.08249407e+00]
  HOMO = -0.574640071966597  LUMO = 1.03864405083829
  mo_energy =
[-1.18575199e+02 -1.23025935e+01 -9.55645175e+00 -9.55645175e+00
 -9.55645175e+00 -1.24813665e+00 -5.74640072e-01 -5.74640072e-01
 -5.74640072e-01  1.03864405e+00  1.03864405e+00  1.03864405e+00
  7.34495243e+00  7.34495243e+00  7.34495243e+00  8.84479309e+00
  3.34754751e+01  3.34754751e+01  3.34754751e+01  1.00305357e+02
  1.29010142e+02  1.29010142e+02  1.29010142e+02  4.83329744e+02
  4.83329744e+02  4.83329744e+02  5.81204202e+02  1.33516307e+03
  1.33516307e+03  1.33516307e+03  2.65002000e+03  3.02940437e+03
  3.02940437e+03  3.02940437e+03  6.64984284e+03  6.64984284e+03
  6.64984284e+03  9.05589606e+03  2.54117194e+04  7.61543500e+04]
E1 = -728.3622353040037  E_coul = 201.66182087725238
cycle= 5 E= -526.700414426751  delta_E= -1.65e-10  |g|= 8.69e-06  |ddm|= 3.18e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3622353040037  E_coul = 201.66182087725238
  HOMO = -0.574643894944776  LUMO = 1.03864123220411
  mo_energy =
[-1.18575219e+02 -1.23026071e+01 -9.55646602e+00 -9.55646602e+00
 -9.55646602e+00 -1.24814130e+00 -5.74643895e-01 -5.74643895e-01
 -5.74643895e-01  1.03864123e+00  1.03864123e+00  1.03864123e+00
  7.34494308e+00  7.34494308e+00  7.34494308e+00  8.84478247e+00
  3.34754611e+01  3.34754611e+01  3.34754611e+01  1.00305340e+02
  1.29010125e+02  1.29010125e+02  1.29010125e+02  4.83329725e+02
  4.83329725e+02  4.83329725e+02  5.81204182e+02  1.33516305e+03
  1.33516305e+03  1.33516305e+03  2.65001998e+03  3.02940435e+03
  3.02940435e+03  3.02940435e+03  6.64984282e+03  6.64984282e+03
  6.64984282e+03  9.05589604e+03  2.54117194e+04  7.61543500e+04]
E1 = -728.3622783425402  E_coul = 201.66186391578447
Extra cycle  E= -526.700414426756  delta_E= -4.43e-12  |g|= 2.58e-06  |ddm|= 4.48e-06
    CPU time for scf_cycle      7.48 sec, wall time      0.52 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102212.9308677045
E1 = -728.3622783425402  E_coul = 201.66186391578447
init E= -526.700414426756
    CPU time for initialize scf     16.49 sec, wall time      0.77 sec
  HOMO = -0.574643109490255  LUMO = 1.03864181913216
  mo_energy =
[-1.18575213e+02 -1.23026040e+01 -9.55646275e+00 -9.55646275e+00
 -9.55646275e+00 -1.24814032e+00 -5.74643109e-01 -5.74643109e-01
 -5.74643109e-01  1.03864182e+00  1.03864182e+00  1.03864182e+00
  7.34494509e+00  7.34494509e+00  7.34494509e+00  8.84478491e+00
  3.34754644e+01  3.34754644e+01  3.34754644e+01  1.00305344e+02
  1.29010129e+02  1.29010129e+02  1.29010129e+02  4.83329730e+02
  4.83329730e+02  4.83329730e+02  5.81204188e+02  1.33516305e+03
  1.33516305e+03  1.33516305e+03  2.65001999e+03  3.02940435e+03
  3.02940435e+03  3.02940435e+03  6.64984283e+03  6.64984283e+03
  6.64984283e+03  9.05589604e+03  2.54117194e+04  7.61543500e+04]
E1 = -728.3622680949994  E_coul = 201.66185366824365
cycle= 1 E= -526.700414426756  delta_E=    0  |g|= 6.65e-07  |ddm|= 1.04e-06
    CPU time for cycle= 1      0.04 sec, wall time      0.02 sec
E1 = -728.3622680949994  E_coul = 201.66185366824365
  HOMO = -0.574643283061365  LUMO = 1.03864168873211
  mo_energy =
[-1.18575215e+02 -1.23026047e+01 -9.55646353e+00 -9.55646353e+00
 -9.55646353e+00 -1.24814054e+00 -5.74643283e-01 -5.74643283e-01
 -5.74643283e-01  1.03864169e+00  1.03864169e+00  1.03864169e+00
  7.34494463e+00  7.34494463e+00  7.34494463e+00  8.84478435e+00
  3.34754636e+01  3.34754636e+01  3.34754636e+01  1.00305343e+02
  1.29010128e+02  1.29010128e+02  1.29010128e+02  4.83329728e+02
  4.83329728e+02  4.83329728e+02  5.81204186e+02  1.33516305e+03
  1.33516305e+03  1.33516305e+03  2.65001998e+03  3.02940435e+03
  3.02940435e+03  3.02940435e+03  6.64984283e+03  6.64984283e+03
  6.64984283e+03  9.05589604e+03  2.54117194e+04  7.61543500e+04]
E1 = -728.3622706039473  E_coul = 201.6618561771924
Extra cycle  E= -526.700414426755  delta_E= 7.96e-13  |g|= 1.68e-07  |ddm|= 2.43e-07
    CPU time for scf_cycle     16.83 sec, wall time      1.10 sec
exp = [2.61826560e+04 7.61752166e+03 3.61735098e+03 1.59782040e+03
 3.82852001e+02 1.08127649e+02 3.49711266e+01 7.54765486e+00
 2.98700563e+00 3.96826433e-01 1.36278325e+03 6.64745298e+02
 3.00960184e+02 3.14040715e+02 6.16235745e+01 7.31555146e+00
 2.02400543e+01 7.77911379e-01 2.83446324e+00 2.26821912e-01]
grad_E = [-1.51567099e-06  3.29158063e-06 -1.58643803e-06  6.86871531e-05
 -1.24889114e-05 -4.13135025e-04 -2.87147953e-03 -3.65225595e-03
  6.43394039e-03 -1.27091835e-02 -4.93336821e-07  5.19159782e-06
  2.47394940e-05  2.13259661e-05 -1.54027795e-04 -4.80689631e-03
  1.31664129e-03 -1.18975965e-02  6.26920107e-03  5.77122962e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:56:29 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6559949        1
[INPUT] 0    0    [1    /1   ]  7617.52161065        1
[INPUT] 0    0    [1    /1   ]  3617.35100797        1
[INPUT] 0    0    [1    /1   ]  1597.81930711        1
[INPUT] 0    0    [1    /1   ]  382.852426574        1
[INPUT] 0    0    [1    /1   ]  108.130994989        1
[INPUT] 0    0    [1    /1   ]  35.0204369797        1
[INPUT] 0    0    [1    /1   ]  7.70982688348        1
[INPUT] 0    0    [1    /1   ]  3.02044845387        1
[INPUT] 0    0    [1    /1   ]  0.397702239508       1
[INPUT] 1    0    [1    /1   ]  1362.78325301        1
[INPUT] 1    0    [1    /1   ]  664.745218585        1
[INPUT] 1    0    [1    /1   ]  300.959810342        1
[INPUT] 1    0    [1    /1   ]  314.040393358        1
[INPUT] 1    0    [1    /1   ]  61.6239390924        1
[INPUT] 1    0    [1    /1   ]  7.31315265844        1
[INPUT] 1    0    [1    /1   ]  20.2397048763        1
[INPUT] 1    0    [1    /1   ]  0.776999480719       1
[INPUT] 1    0    [1    /1   ]  2.84142307577        1
[INPUT] 1    0    [1    /1   ]  0.225390864792       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.655994896155, 1.0]], [0, [7617.521610651099, 1.0]], [0, [3617.351007972277, 1.0]], [0, [1597.8193071135029, 1.0]], [0, [382.8524265743323, 1.0]], [0, [108.13099498912958, 1.0]], [0, [35.02043697974156, 1.0]], [0, [7.709826883484759, 1.0]], [0, [3.020448453874099, 1.0]], [0, [0.3977022395077899, 1.0]], [1, [1362.7832530089768, 1.0]], [1, [664.7452185853725, 1.0]], [1, [300.95981034201424, 1.0]], [1, [314.04039335812064, 1.0]], [1, [61.62393909237241, 1.0]], [1, [7.3131526584407665, 1.0]], [1, [20.239704876296255, 1.0]], [1, [0.7769994807194599, 1.0]], [1, [2.8414230757743493, 1.0]], [1, [0.22539086479169237, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.6559949]
bas 1, expnt(s) = [7617.52161065]
bas 2, expnt(s) = [3617.35100797]
bas 3, expnt(s) = [1597.81930711]
bas 4, expnt(s) = [382.85242657]
bas 5, expnt(s) = [108.13099499]
bas 6, expnt(s) = [35.02043698]
bas 7, expnt(s) = [7.70982688]
bas 8, expnt(s) = [3.02044845]
bas 9, expnt(s) = [0.39770224]
bas 10, expnt(s) = [1362.78325301]
bas 11, expnt(s) = [664.74521859]
bas 12, expnt(s) = [300.95981034]
bas 13, expnt(s) = [314.04039336]
bas 14, expnt(s) = [61.62393909]
bas 15, expnt(s) = [7.31315266]
bas 16, expnt(s) = [20.23970488]
bas 17, expnt(s) = [0.77699948]
bas 18, expnt(s) = [2.84142308]
bas 19, expnt(s) = [0.22539086]
CPU time:       469.56
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826560e+04 5.20026289e+03 7.61752161e+03 2.06003830e+03
 3.61735101e+03 1.17844146e+03 1.59781931e+03 6.38499810e+02
 3.82852427e+02 2.18669684e+02 1.08130995e+02 8.47183861e+01
 3.50204370e+01 3.63710798e+01 7.70982688e+00 1.16895689e+01
 3.02044845e+00 5.78853410e+00 3.97702240e-01 1.26527099e+00
 1.36278325e+03 2.41556027e+04 6.64745219e+02 9.84698826e+03
 3.00959810e+02 3.65695843e+03 3.14040393e+02 3.85670378e+03
 6.16239391e+01 5.03699143e+02 7.31315266e+00 3.50844919e+01
 2.02397049e+01 1.25239006e+02 7.76999481e-01 2.12818953e+00
 2.84142308e+00 1.07622796e+01 2.25390865e-01 4.53059019e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98286950654917
cond(S) = 102282.3378878263
E1 = -729.3725646464461  E_coul = 203.12002738927927
init E= -526.252537257167
    CPU time for initialize scf      0.66 sec, wall time      0.05 sec
  HOMO = -0.556985692085828  LUMO = 1.04339708227252
  mo_energy =
[-1.18331483e+02 -1.22078438e+01 -9.45169204e+00 -9.45169204e+00
 -9.45169204e+00 -1.22567651e+00 -5.56985692e-01 -5.56985692e-01
 -5.56985692e-01  1.04339708e+00  1.04339708e+00  1.04339708e+00
  7.40525665e+00  7.40525665e+00  7.40525665e+00  9.16390730e+00
  3.35972711e+01  3.35972711e+01  3.35972711e+01  1.01366581e+02
  1.29191370e+02  1.29191370e+02  1.29191370e+02  4.83579342e+02
  4.83579342e+02  4.83579342e+02  5.82435097e+02  1.33546529e+03
  1.33546529e+03  1.33546529e+03  2.65130235e+03  3.02977029e+03
  3.02977029e+03  3.02977029e+03  6.65032049e+03  6.65032049e+03
  6.65032049e+03  9.05722862e+03  2.54131033e+04  7.61557731e+04]
E1 = -727.9758664512381  E_coul = 201.2756989311136
cycle= 1 E= -526.700167520125  delta_E= -0.448  |g|= 0.185  |ddm|= 0.441
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.543612
diis-c [-0.29551394  1.        ]
  HOMO = -0.580990862015424  LUMO = 1.02757171348582
  mo_energy =
[-1.18626991e+02 -1.23307027e+01 -9.58524650e+00 -9.58524650e+00
 -9.58524650e+00 -1.25622140e+00 -5.80990862e-01 -5.80990862e-01
 -5.80990862e-01  1.02757171e+00  1.02757171e+00  1.02757171e+00
  7.32985107e+00  7.32985107e+00  7.32985107e+00  9.07787020e+00
  3.34577355e+01  3.34577355e+01  3.34577355e+01  1.01161431e+02
  1.28976772e+02  1.28976772e+02  1.28976772e+02  4.83285202e+02
  4.83285202e+02  4.83285202e+02  5.82102493e+02  1.33511389e+03
  1.33511389e+03  1.33511389e+03  2.65081552e+03  3.02935219e+03
  3.02935219e+03  3.02935219e+03  6.64978851e+03  6.64978851e+03
  6.64978851e+03  9.05662094e+03  2.54124013e+04  7.61549809e+04]
E1 = -728.4432188601328  E_coul = 201.74244555900728
cycle= 2 E= -526.700773301126  delta_E= -0.000606  |g|= 0.0339  |ddm|= 0.0392
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0675802
diis-c [-0.00268238  0.07426736  0.92573264]
  HOMO = -0.574236542665605  LUMO = 1.03271298528518
  mo_energy =
[-1.18567828e+02 -1.22996617e+01 -9.55288831e+00 -9.55288831e+00
 -9.55288831e+00 -1.24765788e+00 -5.74236543e-01 -5.74236543e-01
 -5.74236543e-01  1.03271299e+00  1.03271299e+00  1.03271299e+00
  7.34848810e+00  7.34848810e+00  7.34848810e+00  9.10166042e+00
  3.34907065e+01  3.34907065e+01  3.34907065e+01  1.01209164e+02
  1.29024656e+02  1.29024656e+02  1.29024656e+02  4.83343610e+02
  4.83343610e+02  4.83343610e+02  5.82163147e+02  1.33517613e+03
  1.33517613e+03  1.33517613e+03  2.65088080e+03  3.02941650e+03
  3.02941650e+03  3.02941650e+03  6.64985437e+03  6.64985437e+03
  6.64985437e+03  9.05668751e+03  2.54124683e+04  7.61550481e+04]
E1 = -728.337176674856  E_coul = 201.63636785103935
cycle= 3 E= -526.700808823817  delta_E= -3.55e-05  |g|= 0.00485  |ddm|= 0.0104
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0105789
diis-c [-5.34706233e-07 -1.17904819e-03  1.30394758e-01  8.70784290e-01]
  HOMO = -0.575160271078128  LUMO = 1.03202201382967
  mo_energy =
[-1.18575428e+02 -1.23037215e+01 -9.55723072e+00 -9.55723072e+00
 -9.55723072e+00 -1.24877076e+00 -5.75160271e-01 -5.75160271e-01
 -5.75160271e-01  1.03202201e+00  1.03202201e+00  1.03202201e+00
  7.34596400e+00  7.34596400e+00  7.34596400e+00  9.09864315e+00
  3.34863161e+01  3.34863161e+01  3.34863161e+01  1.01203035e+02
  1.29018446e+02  1.29018446e+02  1.29018446e+02  4.83336107e+02
  4.83336107e+02  4.83336107e+02  5.82155323e+02  1.33516810e+03
  1.33516810e+03  1.33516810e+03  2.65087219e+03  3.02940813e+03
  3.02940813e+03  3.02940813e+03  6.64984564e+03  6.64984564e+03
  6.64984564e+03  9.05667857e+03  2.54124592e+04  7.61550389e+04]
E1 = -728.3515451491206  E_coul = 201.65073546638678
cycle= 4 E= -526.700809682734  delta_E= -8.59e-07  |g|= 6.7e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000135915
diis-c [-1.52336913e-09  6.73635432e-05 -9.22192727e-03 -7.31375438e-02
  1.08229211e+00]
  HOMO = -0.575146768648484  LUMO = 1.03203212898633
  mo_energy =
[-1.18575432e+02 -1.23036898e+01 -9.55721191e+00 -9.55721191e+00
 -9.55721191e+00 -1.24874914e+00 -5.75146769e-01 -5.75146769e-01
 -5.75146769e-01  1.03203213e+00  1.03203213e+00  1.03203213e+00
  7.34598677e+00  7.34598677e+00  7.34598677e+00  9.09868273e+00
  3.34863337e+01  3.34863337e+01  3.34863337e+01  1.01203048e+02
  1.29018455e+02  1.29018455e+02  1.29018455e+02  4.83336103e+02
  4.83336103e+02  4.83336103e+02  5.82155311e+02  1.33516809e+03
  1.33516809e+03  1.33516809e+03  2.65087216e+03  3.02940810e+03
  3.02940810e+03  3.02940810e+03  6.64984560e+03  6.64984560e+03
  6.64984560e+03  9.05667853e+03  2.54124592e+04  7.61550389e+04]
E1 = -728.3515451807186  E_coul = 201.6507354978343
cycle= 5 E= -526.700809682884  delta_E= -1.51e-10  |g|= 8.49e-06  |ddm|= 2.96e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.04 sec
E1 = -728.3515451807186  E_coul = 201.6507354978343
  HOMO = -0.575150526068626  LUMO = 1.03202936465782
  mo_energy =
[-1.18575451e+02 -1.23037031e+01 -9.55722588e+00 -9.55722588e+00
 -9.55722588e+00 -1.24875373e+00 -5.75150526e-01 -5.75150526e-01
 -5.75150526e-01  1.03202936e+00  1.03202936e+00  1.03202936e+00
  7.34597759e+00  7.34597759e+00  7.34597759e+00  9.09867220e+00
  3.34863200e+01  3.34863200e+01  3.34863200e+01  1.01203031e+02
  1.29018438e+02  1.29018438e+02  1.29018438e+02  4.83336084e+02
  4.83336084e+02  4.83336084e+02  5.82155292e+02  1.33516807e+03
  1.33516807e+03  1.33516807e+03  2.65087214e+03  3.02940808e+03
  3.02940808e+03  3.02940808e+03  6.64984558e+03  6.64984558e+03
  6.64984558e+03  9.05667851e+03  2.54124592e+04  7.61550388e+04]
E1 = -728.3515872986993  E_coul = 201.65077761581145
Extra cycle  E= -526.700809682888  delta_E= -3.52e-12  |g|= 2.52e-06  |ddm|= 4.38e-06
    CPU time for scf_cycle      0.87 sec, wall time      0.26 sec
exp = [2.61826560e+04 7.61752161e+03 3.61735101e+03 1.59781931e+03
 3.82852427e+02 1.08130995e+02 3.50204370e+01 7.70982688e+00
 3.02044845e+00 3.97702240e-01 1.36278325e+03 6.64745219e+02
 3.00959810e+02 3.14040393e+02 6.16239391e+01 7.31315266e+00
 2.02397049e+01 7.76999481e-01 2.84142308e+00 2.25390865e-01]
E = -526.7008096828879
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:56:29 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6559949        1
[INPUT] 0    0    [1    /1   ]  7617.52161065        1
[INPUT] 0    0    [1    /1   ]  3617.35100797        1
[INPUT] 0    0    [1    /1   ]  1597.81930711        1
[INPUT] 0    0    [1    /1   ]  382.852426574        1
[INPUT] 0    0    [1    /1   ]  108.130994989        1
[INPUT] 0    0    [1    /1   ]  35.0204369797        1
[INPUT] 0    0    [1    /1   ]  7.70982688348        1
[INPUT] 0    0    [1    /1   ]  3.02044845387        1
[INPUT] 0    0    [1    /1   ]  0.397702239508       1
[INPUT] 1    0    [1    /1   ]  1362.78325301        1
[INPUT] 1    0    [1    /1   ]  664.745218585        1
[INPUT] 1    0    [1    /1   ]  300.959810342        1
[INPUT] 1    0    [1    /1   ]  314.040393358        1
[INPUT] 1    0    [1    /1   ]  61.6239390924        1
[INPUT] 1    0    [1    /1   ]  7.31315265844        1
[INPUT] 1    0    [1    /1   ]  20.2397048763        1
[INPUT] 1    0    [1    /1   ]  0.776999480719       1
[INPUT] 1    0    [1    /1   ]  2.84142307577        1
[INPUT] 1    0    [1    /1   ]  0.225390864792       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.655994896155, 1.0]], [0, [7617.521610651099, 1.0]], [0, [3617.351007972277, 1.0]], [0, [1597.8193071135029, 1.0]], [0, [382.8524265743323, 1.0]], [0, [108.13099498912958, 1.0]], [0, [35.02043697974156, 1.0]], [0, [7.709826883484759, 1.0]], [0, [3.020448453874099, 1.0]], [0, [0.3977022395077899, 1.0]], [1, [1362.7832530089768, 1.0]], [1, [664.7452185853725, 1.0]], [1, [300.95981034201424, 1.0]], [1, [314.04039335812064, 1.0]], [1, [61.62393909237241, 1.0]], [1, [7.3131526584407665, 1.0]], [1, [20.239704876296255, 1.0]], [1, [0.7769994807194599, 1.0]], [1, [2.8414230757743493, 1.0]], [1, [0.22539086479169237, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.6559949]
bas 1, expnt(s) = [7617.52161065]
bas 2, expnt(s) = [3617.35100797]
bas 3, expnt(s) = [1597.81930711]
bas 4, expnt(s) = [382.85242657]
bas 5, expnt(s) = [108.13099499]
bas 6, expnt(s) = [35.02043698]
bas 7, expnt(s) = [7.70982688]
bas 8, expnt(s) = [3.02044845]
bas 9, expnt(s) = [0.39770224]
bas 10, expnt(s) = [1362.78325301]
bas 11, expnt(s) = [664.74521859]
bas 12, expnt(s) = [300.95981034]
bas 13, expnt(s) = [314.04039336]
bas 14, expnt(s) = [61.62393909]
bas 15, expnt(s) = [7.31315266]
bas 16, expnt(s) = [20.23970488]
bas 17, expnt(s) = [0.77699948]
bas 18, expnt(s) = [2.84142308]
bas 19, expnt(s) = [0.22539086]
CPU time:       470.52
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826560e+04 5.20026289e+03 7.61752161e+03 2.06003830e+03
 3.61735101e+03 1.17844146e+03 1.59781931e+03 6.38499810e+02
 3.82852427e+02 2.18669684e+02 1.08130995e+02 8.47183861e+01
 3.50204370e+01 3.63710798e+01 7.70982688e+00 1.16895689e+01
 3.02044845e+00 5.78853410e+00 3.97702240e-01 1.26527099e+00
 1.36278325e+03 2.41556027e+04 6.64745219e+02 9.84698826e+03
 3.00959810e+02 3.65695843e+03 3.14040393e+02 3.85670378e+03
 6.16239391e+01 5.03699143e+02 7.31315266e+00 3.50844919e+01
 2.02397049e+01 1.25239006e+02 7.76999481e-01 2.12818953e+00
 2.84142308e+00 1.07622796e+01 2.25390865e-01 4.53059019e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98286950654917
cond(S) = 102282.3378878263
E1 = -729.3725646464461  E_coul = 203.12002738927927
init E= -526.252537257167
    CPU time for initialize scf      4.34 sec, wall time      0.21 sec
  HOMO = -0.556985692085828  LUMO = 1.04339708227252
  mo_energy =
[-1.18331483e+02 -1.22078438e+01 -9.45169204e+00 -9.45169204e+00
 -9.45169204e+00 -1.22567651e+00 -5.56985692e-01 -5.56985692e-01
 -5.56985692e-01  1.04339708e+00  1.04339708e+00  1.04339708e+00
  7.40525665e+00  7.40525665e+00  7.40525665e+00  9.16390730e+00
  3.35972711e+01  3.35972711e+01  3.35972711e+01  1.01366581e+02
  1.29191370e+02  1.29191370e+02  1.29191370e+02  4.83579342e+02
  4.83579342e+02  4.83579342e+02  5.82435097e+02  1.33546529e+03
  1.33546529e+03  1.33546529e+03  2.65130235e+03  3.02977029e+03
  3.02977029e+03  3.02977029e+03  6.65032049e+03  6.65032049e+03
  6.65032049e+03  9.05722862e+03  2.54131033e+04  7.61557731e+04]
E1 = -727.9758664512381  E_coul = 201.2756989311136
cycle= 1 E= -526.700167520125  delta_E= -0.448  |g|= 0.185  |ddm|= 0.441
    CPU time for cycle= 1      0.06 sec, wall time      0.03 sec
diis-norm(errvec)=0.543612
diis-c [-0.29551394  1.        ]
  HOMO = -0.580990862015424  LUMO = 1.02757171348582
  mo_energy =
[-1.18626991e+02 -1.23307027e+01 -9.58524650e+00 -9.58524650e+00
 -9.58524650e+00 -1.25622140e+00 -5.80990862e-01 -5.80990862e-01
 -5.80990862e-01  1.02757171e+00  1.02757171e+00  1.02757171e+00
  7.32985107e+00  7.32985107e+00  7.32985107e+00  9.07787020e+00
  3.34577355e+01  3.34577355e+01  3.34577355e+01  1.01161431e+02
  1.28976772e+02  1.28976772e+02  1.28976772e+02  4.83285202e+02
  4.83285202e+02  4.83285202e+02  5.82102493e+02  1.33511389e+03
  1.33511389e+03  1.33511389e+03  2.65081552e+03  3.02935219e+03
  3.02935219e+03  3.02935219e+03  6.64978851e+03  6.64978851e+03
  6.64978851e+03  9.05662094e+03  2.54124013e+04  7.61549809e+04]
E1 = -728.4432188601328  E_coul = 201.74244555900728
cycle= 2 E= -526.700773301126  delta_E= -0.000606  |g|= 0.0339  |ddm|= 0.0392
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0675802
diis-c [-0.00268238  0.07426736  0.92573264]
  HOMO = -0.574236542665605  LUMO = 1.03271298528518
  mo_energy =
[-1.18567828e+02 -1.22996617e+01 -9.55288831e+00 -9.55288831e+00
 -9.55288831e+00 -1.24765788e+00 -5.74236543e-01 -5.74236543e-01
 -5.74236543e-01  1.03271299e+00  1.03271299e+00  1.03271299e+00
  7.34848810e+00  7.34848810e+00  7.34848810e+00  9.10166042e+00
  3.34907065e+01  3.34907065e+01  3.34907065e+01  1.01209164e+02
  1.29024656e+02  1.29024656e+02  1.29024656e+02  4.83343610e+02
  4.83343610e+02  4.83343610e+02  5.82163147e+02  1.33517613e+03
  1.33517613e+03  1.33517613e+03  2.65088080e+03  3.02941650e+03
  3.02941650e+03  3.02941650e+03  6.64985437e+03  6.64985437e+03
  6.64985437e+03  9.05668751e+03  2.54124683e+04  7.61550481e+04]
E1 = -728.337176674856  E_coul = 201.63636785103935
cycle= 3 E= -526.700808823817  delta_E= -3.55e-05  |g|= 0.00485  |ddm|= 0.0104
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0105789
diis-c [-5.34706233e-07 -1.17904819e-03  1.30394758e-01  8.70784290e-01]
  HOMO = -0.575160271078128  LUMO = 1.03202201382967
  mo_energy =
[-1.18575428e+02 -1.23037215e+01 -9.55723072e+00 -9.55723072e+00
 -9.55723072e+00 -1.24877076e+00 -5.75160271e-01 -5.75160271e-01
 -5.75160271e-01  1.03202201e+00  1.03202201e+00  1.03202201e+00
  7.34596400e+00  7.34596400e+00  7.34596400e+00  9.09864315e+00
  3.34863161e+01  3.34863161e+01  3.34863161e+01  1.01203035e+02
  1.29018446e+02  1.29018446e+02  1.29018446e+02  4.83336107e+02
  4.83336107e+02  4.83336107e+02  5.82155323e+02  1.33516810e+03
  1.33516810e+03  1.33516810e+03  2.65087219e+03  3.02940813e+03
  3.02940813e+03  3.02940813e+03  6.64984564e+03  6.64984564e+03
  6.64984564e+03  9.05667857e+03  2.54124592e+04  7.61550389e+04]
E1 = -728.3515451491206  E_coul = 201.65073546638678
cycle= 4 E= -526.700809682734  delta_E= -8.59e-07  |g|= 6.7e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000135915
diis-c [-1.52336913e-09  6.73635432e-05 -9.22192727e-03 -7.31375438e-02
  1.08229211e+00]
  HOMO = -0.575146768648484  LUMO = 1.03203212898633
  mo_energy =
[-1.18575432e+02 -1.23036898e+01 -9.55721191e+00 -9.55721191e+00
 -9.55721191e+00 -1.24874914e+00 -5.75146769e-01 -5.75146769e-01
 -5.75146769e-01  1.03203213e+00  1.03203213e+00  1.03203213e+00
  7.34598677e+00  7.34598677e+00  7.34598677e+00  9.09868273e+00
  3.34863337e+01  3.34863337e+01  3.34863337e+01  1.01203048e+02
  1.29018455e+02  1.29018455e+02  1.29018455e+02  4.83336103e+02
  4.83336103e+02  4.83336103e+02  5.82155311e+02  1.33516809e+03
  1.33516809e+03  1.33516809e+03  2.65087216e+03  3.02940810e+03
  3.02940810e+03  3.02940810e+03  6.64984560e+03  6.64984560e+03
  6.64984560e+03  9.05667853e+03  2.54124592e+04  7.61550389e+04]
E1 = -728.3515451807186  E_coul = 201.6507354978343
cycle= 5 E= -526.700809682884  delta_E= -1.51e-10  |g|= 8.49e-06  |ddm|= 2.96e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3515451807186  E_coul = 201.6507354978343
  HOMO = -0.575150526068626  LUMO = 1.03202936465782
  mo_energy =
[-1.18575451e+02 -1.23037031e+01 -9.55722588e+00 -9.55722588e+00
 -9.55722588e+00 -1.24875373e+00 -5.75150526e-01 -5.75150526e-01
 -5.75150526e-01  1.03202936e+00  1.03202936e+00  1.03202936e+00
  7.34597759e+00  7.34597759e+00  7.34597759e+00  9.09867220e+00
  3.34863200e+01  3.34863200e+01  3.34863200e+01  1.01203031e+02
  1.29018438e+02  1.29018438e+02  1.29018438e+02  4.83336084e+02
  4.83336084e+02  4.83336084e+02  5.82155292e+02  1.33516807e+03
  1.33516807e+03  1.33516807e+03  2.65087214e+03  3.02940808e+03
  3.02940808e+03  3.02940808e+03  6.64984558e+03  6.64984558e+03
  6.64984558e+03  9.05667851e+03  2.54124592e+04  7.61550388e+04]
E1 = -728.3515872986993  E_coul = 201.65077761581145
Extra cycle  E= -526.700809682888  delta_E= -3.52e-12  |g|= 2.52e-06  |ddm|= 4.38e-06
    CPU time for scf_cycle      4.56 sec, wall time      0.39 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102282.3378878263
E1 = -728.3515872986993  E_coul = 201.65077761581145
init E= -526.700809682888
    CPU time for initialize scf     16.39 sec, wall time      0.78 sec
  HOMO = -0.575149756055051  LUMO = 1.03202993843647
  mo_energy =
[-1.18575446e+02 -1.23037000e+01 -9.55722268e+00 -9.55722268e+00
 -9.55722268e+00 -1.24875277e+00 -5.75149756e-01 -5.75149756e-01
 -5.75149756e-01  1.03202994e+00  1.03202994e+00  1.03202994e+00
  7.34597956e+00  7.34597956e+00  7.34597956e+00  9.09867461e+00
  3.34863232e+01  3.34863232e+01  3.34863232e+01  1.01203035e+02
  1.29018442e+02  1.29018442e+02  1.29018442e+02  4.83336089e+02
  4.83336089e+02  4.83336089e+02  5.82155297e+02  1.33516807e+03
  1.33516807e+03  1.33516807e+03  2.65087214e+03  3.02940809e+03
  3.02940809e+03  3.02940809e+03  6.64984558e+03  6.64984558e+03
  6.64984558e+03  9.05667851e+03  2.54124592e+04  7.61550388e+04]
E1 = -728.3515772610988  E_coul = 201.6507675782086
cycle= 1 E= -526.70080968289  delta_E= -2.27e-12  |g|= 6.5e-07  |ddm|= 1.01e-06
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3515772610988  E_coul = 201.6507675782086
  HOMO = -0.575149926523256  LUMO = 1.0320298107125
  mo_energy =
[-1.18575447e+02 -1.23037008e+01 -9.55722345e+00 -9.55722345e+00
 -9.55722345e+00 -1.24875298e+00 -5.75149927e-01 -5.75149927e-01
 -5.75149927e-01  1.03202981e+00  1.03202981e+00  1.03202981e+00
  7.34597911e+00  7.34597911e+00  7.34597911e+00  9.09867406e+00
  3.34863224e+01  3.34863224e+01  3.34863224e+01  1.01203034e+02
  1.29018441e+02  1.29018441e+02  1.29018441e+02  4.83336088e+02
  4.83336088e+02  4.83336088e+02  5.82155296e+02  1.33516807e+03
  1.33516807e+03  1.33516807e+03  2.65087214e+03  3.02940809e+03
  3.02940809e+03  3.02940809e+03  6.64984558e+03  6.64984558e+03
  6.64984558e+03  9.05667851e+03  2.54124592e+04  7.61550388e+04]
E1 = -728.3515797180904  E_coul = 201.6507700352019
Extra cycle  E= -526.700809682889  delta_E= 1.59e-12  |g|= 1.64e-07  |ddm|= 2.38e-07
    CPU time for scf_cycle     16.51 sec, wall time      0.90 sec
exp = [2.61826560e+04 7.61752161e+03 3.61735101e+03 1.59781931e+03
 3.82852427e+02 1.08130995e+02 3.50204370e+01 7.70982688e+00
 3.02044845e+00 3.97702240e-01 1.36278325e+03 6.64745219e+02
 3.00959810e+02 3.14040393e+02 6.16239391e+01 7.31315266e+00
 2.02397049e+01 7.76999481e-01 2.84142308e+00 2.25390865e-01]
grad_E = [-1.51482499e-06  3.28101110e-06 -1.59365494e-06  6.82683111e-05
  1.15773786e-06 -5.51355447e-04 -2.48305291e-03 -1.56251848e-03
  2.96412848e-03 -6.43785976e-03 -4.90537372e-07  5.22839363e-06
  2.49653167e-05  2.15197641e-05 -1.82876251e-04 -6.05010687e-03
  1.61833813e-03 -5.22590168e-03  8.03411313e-03  2.82780211e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:56:34 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6560177        1
[INPUT] 0    0    [1    /1   ]  7617.52156101        1
[INPUT] 0    0    [1    /1   ]  3617.35103155        1
[INPUT] 0    0    [1    /1   ]  1597.81826811        1
[INPUT] 0    0    [1    /1   ]  382.852792042        1
[INPUT] 0    0    [1    /1   ]  108.134656421        1
[INPUT] 0    0    [1    /1   ]  35.0664562745        1
[INPUT] 0    0    [1    /1   ]  7.85266771386        1
[INPUT] 0    0    [1    /1   ]  3.04942138234        1
[INPUT] 0    0    [1    /1   ]  0.398570636779       1
[INPUT] 1    0    [1    /1   ]  1362.78326059        1
[INPUT] 1    0    [1    /1   ]  664.745142901        1
[INPUT] 1    0    [1    /1   ]  300.959452822        1
[INPUT] 1    0    [1    /1   ]  314.040085114        1
[INPUT] 1    0    [1    /1   ]  61.6244776521        1
[INPUT] 1    0    [1    /1   ]  7.3183877039         1
[INPUT] 1    0    [1    /1   ]  20.2374516765        1
[INPUT] 1    0    [1    /1   ]  0.774922111529       1
[INPUT] 1    0    [1    /1   ]  2.83774742775        1
[INPUT] 1    0    [1    /1   ]  0.223456114227       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.656017677684, 1.0]], [0, [7617.521561013654, 1.0]], [0, [3617.3510315469775, 1.0]], [0, [1597.81826811138, 1.0]], [0, [382.8527920421694, 1.0]], [0, [108.13465642063332, 1.0]], [0, [35.066456274486136, 1.0]], [0, [7.852667713861157, 1.0]], [0, [3.049421382344171, 1.0]], [0, [0.39857063677907556, 1.0]], [1, [1362.7832605943427, 1.0]], [1, [664.7451429007783, 1.0]], [1, [300.9594528217328, 1.0]], [1, [314.0400851135324, 1.0]], [1, [61.62447765206369, 1.0]], [1, [7.3183877039043015, 1.0]], [1, [20.237451676541752, 1.0]], [1, [0.7749221115291057, 1.0]], [1, [2.8377474277501165, 1.0]], [1, [0.22345611422746253, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65601768]
bas 1, expnt(s) = [7617.52156101]
bas 2, expnt(s) = [3617.35103155]
bas 3, expnt(s) = [1597.81826811]
bas 4, expnt(s) = [382.85279204]
bas 5, expnt(s) = [108.13465642]
bas 6, expnt(s) = [35.06645627]
bas 7, expnt(s) = [7.85266771]
bas 8, expnt(s) = [3.04942138]
bas 9, expnt(s) = [0.39857064]
bas 10, expnt(s) = [1362.78326059]
bas 11, expnt(s) = [664.7451429]
bas 12, expnt(s) = [300.95945282]
bas 13, expnt(s) = [314.04008511]
bas 14, expnt(s) = [61.62447765]
bas 15, expnt(s) = [7.3183877]
bas 16, expnt(s) = [20.23745168]
bas 17, expnt(s) = [0.77492211]
bas 18, expnt(s) = [2.83774743]
bas 19, expnt(s) = [0.22345611]
CPU time:       496.45
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826560e+04 5.20026289e+03 7.61752156e+03 2.06003829e+03
 3.61735103e+03 1.17844147e+03 1.59781827e+03 6.38499499e+02
 3.82852792e+02 2.18669841e+02 1.08134656e+02 8.47205376e+01
 3.50664563e+01 3.64069195e+01 7.85266771e+00 1.18516260e+01
 3.04942138e+00 5.83012821e+00 3.98570637e-01 1.26734250e+00
 1.36278326e+03 2.41556028e+04 6.64745143e+02 9.84698686e+03
 3.00959453e+02 3.65695300e+03 3.14040085e+02 3.85669905e+03
 6.16244777e+01 5.03704646e+02 7.31838770e+00 3.51158883e+01
 2.02374517e+01 1.25221578e+02 7.74922112e-01 2.12107956e+00
 2.83774743e+00 1.07448799e+01 2.23456114e-01 4.48202934e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982971176937284
cond(S) = 102340.40142803671
E1 = -729.3783441807901  E_coul = 203.1235564625436
init E= -526.254787718246
    CPU time for initialize scf      7.15 sec, wall time      0.35 sec
  HOMO = -0.556919630746069  LUMO = 1.03405656467948
  mo_energy =
[-1.18331196e+02 -1.22076886e+01 -9.45140967e+00 -9.45140967e+00
 -9.45140967e+00 -1.22555127e+00 -5.56919631e-01 -5.56919631e-01
 -5.56919631e-01  1.03405656e+00  1.03405656e+00  1.03405656e+00
  7.38537635e+00  7.38537635e+00  7.38537635e+00  9.39078808e+00
  3.35824698e+01  3.35824698e+01  3.35824698e+01  1.02159771e+02
  1.29181976e+02  1.29181976e+02  1.29181976e+02  4.83572377e+02
  4.83572377e+02  4.83572377e+02  5.83283681e+02  1.33545870e+03
  1.33545870e+03  1.33545870e+03  2.65206488e+03  3.02976336e+03
  3.02976336e+03  3.02976336e+03  6.65031348e+03  6.65031348e+03
  6.65031348e+03  9.05792902e+03  2.54137654e+04  7.61563896e+04]
E1 = -727.9570528442152  E_coul = 201.25663842352813
cycle= 1 E= -526.700414420687  delta_E= -0.446  |g|= 0.185  |ddm|= 0.43
    CPU time for cycle= 1      0.08 sec, wall time      0.03 sec
diis-norm(errvec)=0.543374
diis-c [-0.29525518  1.        ]
  HOMO = -0.581696653093546  LUMO = 1.01776204581876
  mo_energy =
[-1.18628041e+02 -1.23322208e+01 -9.58659759e+00 -9.58659759e+00
 -9.58659759e+00 -1.25714080e+00 -5.81696653e-01 -5.81696653e-01
 -5.81696653e-01  1.01776205e+00  1.01776205e+00  1.01776205e+00
  7.30856791e+00  7.30856791e+00  7.30856791e+00  9.30212642e+00
  3.34413702e+01  3.34413702e+01  3.34413702e+01  1.01952768e+02
  1.28965889e+02  1.28965889e+02  1.28965889e+02  4.83276832e+02
  4.83276832e+02  4.83276832e+02  5.82949846e+02  1.33510606e+03
  1.33510606e+03  1.33510606e+03  2.65157695e+03  3.02934408e+03
  3.02934408e+03  3.02934408e+03  6.64978043e+03  6.64978043e+03
  6.64978043e+03  9.05732033e+03  2.54130625e+04  7.61555964e+04]
E1 = -728.4286454304307  E_coul = 201.72761938077574
cycle= 2 E= -526.701026049655  delta_E= -0.000612  |g|= 0.034  |ddm|= 0.0395
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.06793
diis-c [-0.00271167  0.07463079  0.92536921]
  HOMO = -0.574859637340026  LUMO = 1.02293463444847
  mo_energy =
[-1.18568508e+02 -1.23008961e+01 -9.55395190e+00 -9.55395190e+00
 -9.55395190e+00 -1.24846602e+00 -5.74859637e-01 -5.74859637e-01
 -5.74859637e-01  1.02293463e+00  1.02293463e+00  1.02293463e+00
  7.32739305e+00  7.32739305e+00  7.32739305e+00  9.32637468e+00
  3.34746292e+01  3.34746292e+01  3.34746292e+01  1.02000852e+02
  1.29014108e+02  1.29014108e+02  1.29014108e+02  4.83335606e+02
  4.83335606e+02  4.83335606e+02  5.83010869e+02  1.33516869e+03
  1.33516869e+03  1.33516869e+03  2.65164261e+03  3.02940878e+03
  3.02940878e+03  3.02940878e+03  6.64984669e+03  6.64984669e+03
  6.64984669e+03  9.05738730e+03  2.54131300e+04  7.61556641e+04]
E1 = -728.3215209722915  E_coul = 201.62045882064038
cycle= 3 E= -526.701062151651  delta_E= -3.61e-05  |g|= 0.00488  |ddm|= 0.0105
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106233
diis-c [-5.18077152e-07 -1.17115455e-03  1.30357104e-01  8.70814051e-01]
  HOMO = -0.575795285162969  LUMO = 1.02223844910379
  mo_energy =
[-1.18576155e+02 -1.23049883e+01 -9.55832642e+00 -9.55832642e+00
 -9.55832642e+00 -1.24959633e+00 -5.75795285e-01 -5.75795285e-01
 -5.75795285e-01  1.02223845e+00  1.02223845e+00  1.02223845e+00
  7.32484535e+00  7.32484535e+00  7.32484535e+00  9.32329648e+00
  3.34702050e+01  3.34702050e+01  3.34702050e+01  1.01994677e+02
  1.29007857e+02  1.29007857e+02  1.29007857e+02  4.83328056e+02
  4.83328056e+02  4.83328056e+02  5.83002997e+02  1.33516061e+03
  1.33516061e+03  1.33516061e+03  2.65163396e+03  3.02940035e+03
  3.02940035e+03  3.02940035e+03  6.64983790e+03  6.64983790e+03
  6.64983790e+03  9.05737831e+03  2.54131208e+04  7.61556548e+04]
E1 = -728.3360039698337  E_coul = 201.63494094746156
cycle= 4 E= -526.701063022372  delta_E= -8.71e-07  |g|= 6.53e-05  |ddm|= 0.00134
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000135008
diis-c [-1.46700899e-09  6.68747583e-05 -9.16777073e-03 -7.27328649e-02
  1.08183376e+00]
  HOMO = -0.575782605628927  LUMO = 1.02224788696723
  mo_energy =
[-1.18576162e+02 -1.23049584e+01 -9.55830929e+00 -9.55830929e+00
 -9.55830929e+00 -1.24957592e+00 -5.75782606e-01 -5.75782606e-01
 -5.75782606e-01  1.02224789e+00  1.02224789e+00  1.02224789e+00
  7.32486658e+00  7.32486658e+00  7.32486658e+00  9.32333388e+00
  3.34702208e+01  3.34702208e+01  3.34702208e+01  1.01994688e+02
  1.29007864e+02  1.29007864e+02  1.29007864e+02  4.83328050e+02
  4.83328050e+02  4.83328050e+02  5.83002984e+02  1.33516059e+03
  1.33516059e+03  1.33516059e+03  2.65163392e+03  3.02940033e+03
  3.02940033e+03  3.02940033e+03  6.64983786e+03  6.64983786e+03
  6.64983786e+03  9.05737826e+03  2.54131207e+04  7.61556548e+04]
E1 = -728.3360063962242  E_coul = 201.63494337371512
cycle= 5 E= -526.701063022509  delta_E= -1.37e-10  |g|= 8.29e-06  |ddm|= 2.75e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3360063962242  E_coul = 201.63494337371512
  HOMO = -0.575786294115432  LUMO = 1.02224518651226
  mo_energy =
[-1.18576180e+02 -1.23049714e+01 -9.55832295e+00 -9.55832295e+00
 -9.55832295e+00 -1.24958044e+00 -5.75786294e-01 -5.75786294e-01
 -5.75786294e-01  1.02224519e+00  1.02224519e+00  1.02224519e+00
  7.32485759e+00  7.32485759e+00  7.32485759e+00  9.32332348e+00
  3.34702074e+01  3.34702074e+01  3.34702074e+01  1.01994672e+02
  1.29007847e+02  1.29007847e+02  1.29007847e+02  4.83328032e+02
  4.83328032e+02  4.83328032e+02  5.83002965e+02  1.33516057e+03
  1.33516057e+03  1.33516057e+03  2.65163390e+03  3.02940031e+03
  3.02940031e+03  3.02940031e+03  6.64983784e+03  6.64983784e+03
  6.64983784e+03  9.05737824e+03  2.54131207e+04  7.61556548e+04]
E1 = -728.3360476402237  E_coul = 201.63498461771113
Extra cycle  E= -526.701063022513  delta_E= -3.52e-12  |g|= 2.47e-06  |ddm|= 4.28e-06
    CPU time for scf_cycle      7.38 sec, wall time      0.52 sec
exp = [2.61826560e+04 7.61752156e+03 3.61735103e+03 1.59781827e+03
 3.82852792e+02 1.08134656e+02 3.50664563e+01 7.85266771e+00
 3.04942138e+00 3.98570637e-01 1.36278326e+03 6.64745143e+02
 3.00959453e+02 3.14040085e+02 6.16244777e+01 7.31838770e+00
 2.02374517e+01 7.74922112e-01 2.83774743e+00 2.23456114e-01]
E = -526.7010630225126
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:56:35 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6560177        1
[INPUT] 0    0    [1    /1   ]  7617.52156101        1
[INPUT] 0    0    [1    /1   ]  3617.35103155        1
[INPUT] 0    0    [1    /1   ]  1597.81826811        1
[INPUT] 0    0    [1    /1   ]  382.852792042        1
[INPUT] 0    0    [1    /1   ]  108.134656421        1
[INPUT] 0    0    [1    /1   ]  35.0664562745        1
[INPUT] 0    0    [1    /1   ]  7.85266771386        1
[INPUT] 0    0    [1    /1   ]  3.04942138234        1
[INPUT] 0    0    [1    /1   ]  0.398570636779       1
[INPUT] 1    0    [1    /1   ]  1362.78326059        1
[INPUT] 1    0    [1    /1   ]  664.745142901        1
[INPUT] 1    0    [1    /1   ]  300.959452822        1
[INPUT] 1    0    [1    /1   ]  314.040085114        1
[INPUT] 1    0    [1    /1   ]  61.6244776521        1
[INPUT] 1    0    [1    /1   ]  7.3183877039         1
[INPUT] 1    0    [1    /1   ]  20.2374516765        1
[INPUT] 1    0    [1    /1   ]  0.774922111529       1
[INPUT] 1    0    [1    /1   ]  2.83774742775        1
[INPUT] 1    0    [1    /1   ]  0.223456114227       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.656017677684, 1.0]], [0, [7617.521561013654, 1.0]], [0, [3617.3510315469775, 1.0]], [0, [1597.81826811138, 1.0]], [0, [382.8527920421694, 1.0]], [0, [108.13465642063332, 1.0]], [0, [35.066456274486136, 1.0]], [0, [7.852667713861157, 1.0]], [0, [3.049421382344171, 1.0]], [0, [0.39857063677907556, 1.0]], [1, [1362.7832605943427, 1.0]], [1, [664.7451429007783, 1.0]], [1, [300.9594528217328, 1.0]], [1, [314.0400851135324, 1.0]], [1, [61.62447765206369, 1.0]], [1, [7.3183877039043015, 1.0]], [1, [20.237451676541752, 1.0]], [1, [0.7749221115291057, 1.0]], [1, [2.8377474277501165, 1.0]], [1, [0.22345611422746253, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65601768]
bas 1, expnt(s) = [7617.52156101]
bas 2, expnt(s) = [3617.35103155]
bas 3, expnt(s) = [1597.81826811]
bas 4, expnt(s) = [382.85279204]
bas 5, expnt(s) = [108.13465642]
bas 6, expnt(s) = [35.06645627]
bas 7, expnt(s) = [7.85266771]
bas 8, expnt(s) = [3.04942138]
bas 9, expnt(s) = [0.39857064]
bas 10, expnt(s) = [1362.78326059]
bas 11, expnt(s) = [664.7451429]
bas 12, expnt(s) = [300.95945282]
bas 13, expnt(s) = [314.04008511]
bas 14, expnt(s) = [61.62447765]
bas 15, expnt(s) = [7.3183877]
bas 16, expnt(s) = [20.23745168]
bas 17, expnt(s) = [0.77492211]
bas 18, expnt(s) = [2.83774743]
bas 19, expnt(s) = [0.22345611]
CPU time:       503.92
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826560e+04 5.20026289e+03 7.61752156e+03 2.06003829e+03
 3.61735103e+03 1.17844147e+03 1.59781827e+03 6.38499499e+02
 3.82852792e+02 2.18669841e+02 1.08134656e+02 8.47205376e+01
 3.50664563e+01 3.64069195e+01 7.85266771e+00 1.18516260e+01
 3.04942138e+00 5.83012821e+00 3.98570637e-01 1.26734250e+00
 1.36278326e+03 2.41556028e+04 6.64745143e+02 9.84698686e+03
 3.00959453e+02 3.65695300e+03 3.14040085e+02 3.85669905e+03
 6.16244777e+01 5.03704646e+02 7.31838770e+00 3.51158883e+01
 2.02374517e+01 1.25221578e+02 7.74922112e-01 2.12107956e+00
 2.83774743e+00 1.07448799e+01 2.23456114e-01 4.48202934e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982971176937284
cond(S) = 102340.40142803671
E1 = -729.3783441807901  E_coul = 203.1235564625436
init E= -526.254787718246
    CPU time for initialize scf      7.11 sec, wall time      0.35 sec
  HOMO = -0.556919630746069  LUMO = 1.03405656467948
  mo_energy =
[-1.18331196e+02 -1.22076886e+01 -9.45140967e+00 -9.45140967e+00
 -9.45140967e+00 -1.22555127e+00 -5.56919631e-01 -5.56919631e-01
 -5.56919631e-01  1.03405656e+00  1.03405656e+00  1.03405656e+00
  7.38537635e+00  7.38537635e+00  7.38537635e+00  9.39078808e+00
  3.35824698e+01  3.35824698e+01  3.35824698e+01  1.02159771e+02
  1.29181976e+02  1.29181976e+02  1.29181976e+02  4.83572377e+02
  4.83572377e+02  4.83572377e+02  5.83283681e+02  1.33545870e+03
  1.33545870e+03  1.33545870e+03  2.65206488e+03  3.02976336e+03
  3.02976336e+03  3.02976336e+03  6.65031348e+03  6.65031348e+03
  6.65031348e+03  9.05792902e+03  2.54137654e+04  7.61563896e+04]
E1 = -727.9570528442152  E_coul = 201.25663842352813
cycle= 1 E= -526.700414420687  delta_E= -0.446  |g|= 0.185  |ddm|= 0.43
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.543374
diis-c [-0.29525518  1.        ]
  HOMO = -0.581696653093546  LUMO = 1.01776204581876
  mo_energy =
[-1.18628041e+02 -1.23322208e+01 -9.58659759e+00 -9.58659759e+00
 -9.58659759e+00 -1.25714080e+00 -5.81696653e-01 -5.81696653e-01
 -5.81696653e-01  1.01776205e+00  1.01776205e+00  1.01776205e+00
  7.30856791e+00  7.30856791e+00  7.30856791e+00  9.30212642e+00
  3.34413702e+01  3.34413702e+01  3.34413702e+01  1.01952768e+02
  1.28965889e+02  1.28965889e+02  1.28965889e+02  4.83276832e+02
  4.83276832e+02  4.83276832e+02  5.82949846e+02  1.33510606e+03
  1.33510606e+03  1.33510606e+03  2.65157695e+03  3.02934408e+03
  3.02934408e+03  3.02934408e+03  6.64978043e+03  6.64978043e+03
  6.64978043e+03  9.05732033e+03  2.54130625e+04  7.61555964e+04]
E1 = -728.4286454304307  E_coul = 201.72761938077574
cycle= 2 E= -526.701026049655  delta_E= -0.000612  |g|= 0.034  |ddm|= 0.0395
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.06793
diis-c [-0.00271167  0.07463079  0.92536921]
  HOMO = -0.574859637340026  LUMO = 1.02293463444847
  mo_energy =
[-1.18568508e+02 -1.23008961e+01 -9.55395190e+00 -9.55395190e+00
 -9.55395190e+00 -1.24846602e+00 -5.74859637e-01 -5.74859637e-01
 -5.74859637e-01  1.02293463e+00  1.02293463e+00  1.02293463e+00
  7.32739305e+00  7.32739305e+00  7.32739305e+00  9.32637468e+00
  3.34746292e+01  3.34746292e+01  3.34746292e+01  1.02000852e+02
  1.29014108e+02  1.29014108e+02  1.29014108e+02  4.83335606e+02
  4.83335606e+02  4.83335606e+02  5.83010869e+02  1.33516869e+03
  1.33516869e+03  1.33516869e+03  2.65164261e+03  3.02940878e+03
  3.02940878e+03  3.02940878e+03  6.64984669e+03  6.64984669e+03
  6.64984669e+03  9.05738730e+03  2.54131300e+04  7.61556641e+04]
E1 = -728.3215209722915  E_coul = 201.62045882064038
cycle= 3 E= -526.701062151651  delta_E= -3.61e-05  |g|= 0.00488  |ddm|= 0.0105
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106233
diis-c [-5.18077152e-07 -1.17115455e-03  1.30357104e-01  8.70814051e-01]
  HOMO = -0.575795285162969  LUMO = 1.02223844910379
  mo_energy =
[-1.18576155e+02 -1.23049883e+01 -9.55832642e+00 -9.55832642e+00
 -9.55832642e+00 -1.24959633e+00 -5.75795285e-01 -5.75795285e-01
 -5.75795285e-01  1.02223845e+00  1.02223845e+00  1.02223845e+00
  7.32484535e+00  7.32484535e+00  7.32484535e+00  9.32329648e+00
  3.34702050e+01  3.34702050e+01  3.34702050e+01  1.01994677e+02
  1.29007857e+02  1.29007857e+02  1.29007857e+02  4.83328056e+02
  4.83328056e+02  4.83328056e+02  5.83002997e+02  1.33516061e+03
  1.33516061e+03  1.33516061e+03  2.65163396e+03  3.02940035e+03
  3.02940035e+03  3.02940035e+03  6.64983790e+03  6.64983790e+03
  6.64983790e+03  9.05737831e+03  2.54131208e+04  7.61556548e+04]
E1 = -728.3360039698337  E_coul = 201.63494094746156
cycle= 4 E= -526.701063022372  delta_E= -8.71e-07  |g|= 6.53e-05  |ddm|= 0.00134
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000135008
diis-c [-1.46700899e-09  6.68747583e-05 -9.16777073e-03 -7.27328649e-02
  1.08183376e+00]
  HOMO = -0.575782605628927  LUMO = 1.02224788696723
  mo_energy =
[-1.18576162e+02 -1.23049584e+01 -9.55830929e+00 -9.55830929e+00
 -9.55830929e+00 -1.24957592e+00 -5.75782606e-01 -5.75782606e-01
 -5.75782606e-01  1.02224789e+00  1.02224789e+00  1.02224789e+00
  7.32486658e+00  7.32486658e+00  7.32486658e+00  9.32333388e+00
  3.34702208e+01  3.34702208e+01  3.34702208e+01  1.01994688e+02
  1.29007864e+02  1.29007864e+02  1.29007864e+02  4.83328050e+02
  4.83328050e+02  4.83328050e+02  5.83002984e+02  1.33516059e+03
  1.33516059e+03  1.33516059e+03  2.65163392e+03  3.02940033e+03
  3.02940033e+03  3.02940033e+03  6.64983786e+03  6.64983786e+03
  6.64983786e+03  9.05737826e+03  2.54131207e+04  7.61556548e+04]
E1 = -728.3360063962242  E_coul = 201.63494337371512
cycle= 5 E= -526.701063022509  delta_E= -1.37e-10  |g|= 8.29e-06  |ddm|= 2.75e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3360063962242  E_coul = 201.63494337371512
  HOMO = -0.575786294115432  LUMO = 1.02224518651226
  mo_energy =
[-1.18576180e+02 -1.23049714e+01 -9.55832295e+00 -9.55832295e+00
 -9.55832295e+00 -1.24958044e+00 -5.75786294e-01 -5.75786294e-01
 -5.75786294e-01  1.02224519e+00  1.02224519e+00  1.02224519e+00
  7.32485759e+00  7.32485759e+00  7.32485759e+00  9.32332348e+00
  3.34702074e+01  3.34702074e+01  3.34702074e+01  1.01994672e+02
  1.29007847e+02  1.29007847e+02  1.29007847e+02  4.83328032e+02
  4.83328032e+02  4.83328032e+02  5.83002965e+02  1.33516057e+03
  1.33516057e+03  1.33516057e+03  2.65163390e+03  3.02940031e+03
  3.02940031e+03  3.02940031e+03  6.64983784e+03  6.64983784e+03
  6.64983784e+03  9.05737824e+03  2.54131207e+04  7.61556548e+04]
E1 = -728.3360476402237  E_coul = 201.63498461771113
Extra cycle  E= -526.701063022513  delta_E= -3.52e-12  |g|= 2.47e-06  |ddm|= 4.28e-06
    CPU time for scf_cycle      7.29 sec, wall time      0.53 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102340.40142803671
E1 = -728.3360476402237  E_coul = 201.63498461771113
init E= -526.701063022513
    CPU time for initialize scf     15.81 sec, wall time      0.76 sec
  HOMO = -0.57578553820443  LUMO = 1.02224574669901
  mo_energy =
[-1.18576175e+02 -1.23049684e+01 -9.55831983e+00 -9.55831983e+00
 -9.55831983e+00 -1.24957950e+00 -5.75785538e-01 -5.75785538e-01
 -5.75785538e-01  1.02224575e+00  1.02224575e+00  1.02224575e+00
  7.32485953e+00  7.32485953e+00  7.32485953e+00  9.32332586e+00
  3.34702105e+01  3.34702105e+01  3.34702105e+01  1.01994676e+02
  1.29007852e+02  1.29007852e+02  1.29007852e+02  4.83328037e+02
  4.83328037e+02  4.83328037e+02  5.83002970e+02  1.33516058e+03
  1.33516058e+03  1.33516058e+03  2.65163391e+03  3.02940031e+03
  3.02940031e+03  3.02940031e+03  6.64983785e+03  6.64983785e+03
  6.64983785e+03  9.05737825e+03  2.54131207e+04  7.61556548e+04]
E1 = -728.3360377926684  E_coul = 201.63497477015494
cycle= 1 E= -526.701063022513  delta_E= -9.09e-13  |g|= 6.36e-07  |ddm|= 9.89e-07
    CPU time for cycle= 1      0.04 sec, wall time      0.02 sec
E1 = -728.3360377926684  E_coul = 201.63497477015494
  HOMO = -0.575785706000562  LUMO = 1.02224562166313
  mo_energy =
[-1.18576176e+02 -1.23049691e+01 -9.55832057e+00 -9.55832057e+00
 -9.55832057e+00 -1.24957970e+00 -5.75785706e-01 -5.75785706e-01
 -5.75785706e-01  1.02224562e+00  1.02224562e+00  1.02224562e+00
  7.32485908e+00  7.32485908e+00  7.32485908e+00  9.32332531e+00
  3.34702098e+01  3.34702098e+01  3.34702098e+01  1.01994675e+02
  1.29007851e+02  1.29007851e+02  1.29007851e+02  4.83328036e+02
  4.83328036e+02  4.83328036e+02  5.83002969e+02  1.33516058e+03
  1.33516058e+03  1.33516058e+03  2.65163391e+03  3.02940031e+03
  3.02940031e+03  3.02940031e+03  6.64983785e+03  6.64983785e+03
  6.64983785e+03  9.05737825e+03  2.54131207e+04  7.61556548e+04]
E1 = -728.3360402053837  E_coul = 201.6349771828715
Extra cycle  E= -526.701063022512  delta_E= 1.25e-12  |g|= 1.61e-07  |ddm|= 2.32e-07
    CPU time for scf_cycle     15.94 sec, wall time      0.87 sec
exp = [2.61826560e+04 7.61752156e+03 3.61735103e+03 1.59781827e+03
 3.82852792e+02 1.08134656e+02 3.50664563e+01 7.85266771e+00
 3.04942138e+00 3.98570637e-01 1.36278326e+03 6.64745143e+02
 3.00959453e+02 3.14040085e+02 6.16244777e+01 7.31838770e+00
 2.02374517e+01 7.74922112e-01 2.83774743e+00 2.23456114e-01]
grad_E = [-1.51406123e-06  3.27163523e-06 -1.59974975e-06  6.78963439e-05
  1.33747875e-05 -6.72577369e-04 -2.14515158e-03  1.52071753e-05
  1.27803440e-04  2.56512391e-04 -4.93973593e-07  5.18229302e-06
  2.46846392e-05  2.12786406e-05 -1.49514479e-04 -4.98987134e-03
  1.30580163e-03  1.87938438e-03  6.76111730e-03 -5.08020294e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:56:40 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6560339        1
[INPUT] 0    0    [1    /1   ]  7617.52152562        1
[INPUT] 0    0    [1    /1   ]  3617.35104841        1
[INPUT] 0    0    [1    /1   ]  1597.81752805        1
[INPUT] 0    0    [1    /1   ]  382.853001055        1
[INPUT] 0    0    [1    /1   ]  108.137829725        1
[INPUT] 0    0    [1    /1   ]  35.0979901497        1
[INPUT] 0    0    [1    /1   ]  7.94455920466        1
[INPUT] 0    0    [1    /1   ]  3.06972984355        1
[INPUT] 0    0    [1    /1   ]  0.39894215269        1
[INPUT] 1    0    [1    /1   ]  1362.783266          1
[INPUT] 1    0    [1    /1   ]  664.745088709        1
[INPUT] 1    0    [1    /1   ]  300.959196602        1
[INPUT] 1    0    [1    /1   ]  314.039864212        1
[INPUT] 1    0    [1    /1   ]  61.6249893385        1
[INPUT] 1    0    [1    /1   ]  7.32741508539        1
[INPUT] 1    0    [1    /1   ]  20.2345392788        1
[INPUT] 1    0    [1    /1   ]  0.77342438596        1
[INPUT] 1    0    [1    /1   ]  2.82754546481        1
[INPUT] 1    0    [1    /1   ]  0.222549173472       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.65603393808, 1.0]], [0, [7617.521525620446, 1.0]], [0, [3617.3510484125854, 1.0]], [0, [1597.8175280496569, 1.0]], [0, [382.8530010553296, 1.0]], [0, [108.13782972459784, 1.0]], [0, [35.097990149709936, 1.0]], [0, [7.944559204655998, 1.0]], [0, [3.069729843554094, 1.0]], [0, [0.3989421526903426, 1.0]], [1, [1362.7832659973906, 1.0]], [1, [664.7450887089492, 1.0]], [1, [300.95919660155664, 1.0]], [1, [314.0398642115649, 1.0]], [1, [61.624989338466754, 1.0]], [1, [7.32741508539232, 1.0]], [1, [20.234539278752443, 1.0]], [1, [0.773424385959666, 1.0]], [1, [2.8275454648056684, 1.0]], [1, [0.22254917347243558, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65603394]
bas 1, expnt(s) = [7617.52152562]
bas 2, expnt(s) = [3617.35104841]
bas 3, expnt(s) = [1597.81752805]
bas 4, expnt(s) = [382.85300106]
bas 5, expnt(s) = [108.13782972]
bas 6, expnt(s) = [35.09799015]
bas 7, expnt(s) = [7.9445592]
bas 8, expnt(s) = [3.06972984]
bas 9, expnt(s) = [0.39894215]
bas 10, expnt(s) = [1362.783266]
bas 11, expnt(s) = [664.74508871]
bas 12, expnt(s) = [300.9591966]
bas 13, expnt(s) = [314.03986421]
bas 14, expnt(s) = [61.62498934]
bas 15, expnt(s) = [7.32741509]
bas 16, expnt(s) = [20.23453928]
bas 17, expnt(s) = [0.77342439]
bas 18, expnt(s) = [2.82754546]
bas 19, expnt(s) = [0.22254917]
CPU time:       531.95
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826560e+04 5.20026289e+03 7.61752153e+03 2.06003829e+03
 3.61735105e+03 1.17844147e+03 1.59781753e+03 6.38499277e+02
 3.82853001e+02 2.18669930e+02 1.08137830e+02 8.47224022e+01
 3.50979901e+01 3.64314712e+01 7.94455920e+00 1.19554899e+01
 3.06972984e+00 5.85922454e+00 3.98942153e-01 1.26822839e+00
 1.36278327e+03 2.41556030e+04 6.64745089e+02 9.84698586e+03
 3.00959197e+02 3.65694910e+03 3.14039864e+02 3.85669566e+03
 6.16249893e+01 5.03709874e+02 7.32741509e+00 3.51700419e+01
 2.02345393e+01 1.25199053e+02 7.73424386e-01 2.11595642e+00
 2.82754546e+00 1.06966156e+01 2.22549173e-01 4.45930189e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98301508414979
cond(S) = 102376.76888993819
E1 = -729.380441136409  E_coul = 203.12462229545278
init E= -526.255818840956
    CPU time for initialize scf      7.26 sec, wall time      0.35 sec
  HOMO = -0.55689180566358  LUMO = 1.02910696204888
  mo_energy =
[-1.18331137e+02 -1.22076026e+01 -9.45134081e+00 -9.45134081e+00
 -9.45134081e+00 -1.22552727e+00 -5.56891806e-01 -5.56891806e-01
 -5.56891806e-01  1.02910696e+00  1.02910696e+00  1.02910696e+00
  7.36172843e+00  7.36172843e+00  7.36172843e+00  9.54126644e+00
  3.35577994e+01  3.35577994e+01  3.35577994e+01  1.02679478e+02
  1.29165645e+02  1.29165645e+02  1.29165645e+02  4.83560090e+02
  4.83560090e+02  4.83560090e+02  5.83844623e+02  1.33544768e+03
  1.33544768e+03  1.33544768e+03  2.65257057e+03  3.02975260e+03
  3.02975260e+03  3.02975260e+03  6.65030319e+03  6.65030319e+03
  6.65030319e+03  9.05839373e+03  2.54142048e+04  7.61567986e+04]
E1 = -727.9491081505529  E_coul = 201.24857257469654
cycle= 1 E= -526.700535575856  delta_E= -0.445  |g|= 0.185  |ddm|= 0.42
    CPU time for cycle= 1      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.543013
diis-c [-0.2948633  1.       ]
  HOMO = -0.581950491942316  LUMO = 1.01267476770861
  mo_energy =
[-1.18628498e+02 -1.23328713e+01 -9.58721314e+00 -9.58721314e+00
 -9.58721314e+00 -1.25752005e+00 -5.81950492e-01 -5.81950492e-01
 -5.81950492e-01  1.01267477e+00  1.01267477e+00  1.01267477e+00
  7.28442469e+00  7.28442469e+00  7.28442469e+00  9.45123530e+00
  3.34160301e+01  3.34160301e+01  3.34160301e+01  1.02471694e+02
  1.28948949e+02  1.28948949e+02  1.28948949e+02  4.83263995e+02
  4.83263995e+02  4.83263995e+02  5.83510322e+02  1.33509458e+03
  1.33509458e+03  1.33509458e+03  2.65208224e+03  3.02933288e+03
  3.02933288e+03  3.02933288e+03  6.64976975e+03  6.64976975e+03
  6.64976975e+03  9.05778467e+03  2.54135015e+04  7.61560051e+04]
E1 = -728.4221321648355  E_coul = 201.72098345024702
cycle= 2 E= -526.701148714588  delta_E= -0.000613  |g|= 0.0341  |ddm|= 0.0395
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0680032
diis-c [-0.00272171  0.07467656  0.92532344]
  HOMO = -0.575081922507952  LUMO = 1.01785082659592
  mo_energy =
[-1.18568844e+02 -1.23014484e+01 -9.55446916e+00 -9.55446916e+00
 -9.55446916e+00 -1.24880226e+00 -5.75081923e-01 -5.75081923e-01
 -5.75081923e-01  1.01785083e+00  1.01785083e+00  1.01785083e+00
  7.30329875e+00  7.30329875e+00  7.30329875e+00  9.47571466e+00
  3.34493919e+01  3.34493919e+01  3.34493919e+01  1.02519901e+02
  1.28997279e+02  1.28997279e+02  1.28997279e+02  4.83322889e+02
  4.83322889e+02  4.83322889e+02  5.83571464e+02  1.33515732e+03
  1.33515732e+03  1.33515732e+03  2.65214803e+03  3.02939771e+03
  3.02939771e+03  3.02939771e+03  6.64983614e+03  6.64983614e+03
  6.64983614e+03  9.05785178e+03  2.54135691e+04  7.61560729e+04]
E1 = -728.3146716652567  E_coul = 201.61348667970762
cycle= 3 E= -526.701184985549  delta_E= -3.63e-05  |g|= 0.00489  |ddm|= 0.0105
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106332
diis-c [-5.06075437e-07 -1.16574071e-03  1.30385199e-01  8.70780542e-01]
  HOMO = -0.576021636877099  LUMO = 1.01715404217287
  mo_energy =
[-1.18576510e+02 -1.23055522e+01 -9.55885451e+00 -9.55885451e+00
 -9.55885451e+00 -1.24993917e+00 -5.76021637e-01 -5.76021637e-01
 -5.76021637e-01  1.01715404e+00  1.01715404e+00  1.01715404e+00
  7.30074558e+00  7.30074558e+00  7.30074558e+00  9.47260507e+00
  3.34449552e+01  3.34449552e+01  3.34449552e+01  1.02513708e+02
  1.28991013e+02  1.28991013e+02  1.28991013e+02  4.83315320e+02
  4.83315320e+02  4.83315320e+02  5.83563575e+02  1.33514923e+03
  1.33514923e+03  1.33514923e+03  2.65213936e+03  3.02938926e+03
  3.02938926e+03  3.02938926e+03  6.64982733e+03  6.64982733e+03
  6.64982733e+03  9.05784277e+03  2.54135599e+04  7.61560637e+04]
E1 = -728.329186358177  E_coul = 201.62800049853962
cycle= 4 E= -526.701185859637  delta_E= -8.74e-07  |g|= 6.42e-05  |ddm|= 0.00134
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000134217
diis-c [-1.42553335e-09  6.65500954e-05 -9.14097606e-03 -7.24983123e-02
  1.08157274e+00]
  HOMO = -0.576009452892207  LUMO = 1.01716307416486
  mo_energy =
[-1.18576517e+02 -1.23055236e+01 -9.55883847e+00 -9.55883847e+00
 -9.55883847e+00 -1.24991950e+00 -5.76009453e-01 -5.76009453e-01
 -5.76009453e-01  1.01716307e+00  1.01716307e+00  1.01716307e+00
  7.30076585e+00  7.30076585e+00  7.30076585e+00  9.47264108e+00
  3.34449699e+01  3.34449699e+01  3.34449699e+01  1.02513717e+02
  1.28991018e+02  1.28991018e+02  1.28991018e+02  4.83315313e+02
  4.83315313e+02  4.83315313e+02  5.83563560e+02  1.33514921e+03
  1.33514921e+03  1.33514921e+03  2.65213932e+03  3.02938923e+03
  3.02938923e+03  3.02938923e+03  6.64982729e+03  6.64982729e+03
  6.64982729e+03  9.05784272e+03  2.54135599e+04  7.61560636e+04]
E1 = -728.3291906198413  E_coul = 201.6280047600735
cycle= 5 E= -526.701185859768  delta_E= -1.3e-10  |g|= 8.13e-06  |ddm|= 2.62e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3291906198413  E_coul = 201.6280047600735
  HOMO = -0.576013080481192  LUMO = 1.01716042701282
  mo_energy =
[-1.18576535e+02 -1.23055363e+01 -9.55885188e+00 -9.55885188e+00
 -9.55885188e+00 -1.24992396e+00 -5.76013080e-01 -5.76013080e-01
 -5.76013080e-01  1.01716043e+00  1.01716043e+00  1.01716043e+00
  7.30075703e+00  7.30075703e+00  7.30075703e+00  9.47263081e+00
  3.34449568e+01  3.34449568e+01  3.34449568e+01  1.02513701e+02
  1.28991002e+02  1.28991002e+02  1.28991002e+02  4.83315296e+02
  4.83315296e+02  4.83315296e+02  5.83563542e+02  1.33514919e+03
  1.33514919e+03  1.33514919e+03  2.65213930e+03  3.02938921e+03
  3.02938921e+03  3.02938921e+03  6.64982727e+03  6.64982727e+03
  6.64982727e+03  9.05784270e+03  2.54135598e+04  7.61560636e+04]
E1 = -728.3292310852423  E_coul = 201.6280452254689
Extra cycle  E= -526.701185859773  delta_E= -5.68e-12  |g|= 2.42e-06  |ddm|= 4.2e-06
    CPU time for scf_cycle      7.49 sec, wall time      0.53 sec
exp = [2.61826560e+04 7.61752153e+03 3.61735105e+03 1.59781753e+03
 3.82853001e+02 1.08137830e+02 3.50979901e+01 7.94455920e+00
 3.06972984e+00 3.98942153e-01 1.36278327e+03 6.64745089e+02
 3.00959197e+02 3.14039864e+02 6.16249893e+01 7.32741509e+00
 2.02345393e+01 7.73424386e-01 2.82754546e+00 2.22549173e-01]
E = -526.7011858597734
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:56:40 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6560339        1
[INPUT] 0    0    [1    /1   ]  7617.52152562        1
[INPUT] 0    0    [1    /1   ]  3617.35104841        1
[INPUT] 0    0    [1    /1   ]  1597.81752805        1
[INPUT] 0    0    [1    /1   ]  382.853001055        1
[INPUT] 0    0    [1    /1   ]  108.137829725        1
[INPUT] 0    0    [1    /1   ]  35.0979901497        1
[INPUT] 0    0    [1    /1   ]  7.94455920466        1
[INPUT] 0    0    [1    /1   ]  3.06972984355        1
[INPUT] 0    0    [1    /1   ]  0.39894215269        1
[INPUT] 1    0    [1    /1   ]  1362.783266          1
[INPUT] 1    0    [1    /1   ]  664.745088709        1
[INPUT] 1    0    [1    /1   ]  300.959196602        1
[INPUT] 1    0    [1    /1   ]  314.039864212        1
[INPUT] 1    0    [1    /1   ]  61.6249893385        1
[INPUT] 1    0    [1    /1   ]  7.32741508539        1
[INPUT] 1    0    [1    /1   ]  20.2345392788        1
[INPUT] 1    0    [1    /1   ]  0.77342438596        1
[INPUT] 1    0    [1    /1   ]  2.82754546481        1
[INPUT] 1    0    [1    /1   ]  0.222549173472       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.65603393808, 1.0]], [0, [7617.521525620446, 1.0]], [0, [3617.3510484125854, 1.0]], [0, [1597.8175280496569, 1.0]], [0, [382.8530010553296, 1.0]], [0, [108.13782972459784, 1.0]], [0, [35.097990149709936, 1.0]], [0, [7.944559204655998, 1.0]], [0, [3.069729843554094, 1.0]], [0, [0.3989421526903426, 1.0]], [1, [1362.7832659973906, 1.0]], [1, [664.7450887089492, 1.0]], [1, [300.95919660155664, 1.0]], [1, [314.0398642115649, 1.0]], [1, [61.624989338466754, 1.0]], [1, [7.32741508539232, 1.0]], [1, [20.234539278752443, 1.0]], [1, [0.773424385959666, 1.0]], [1, [2.8275454648056684, 1.0]], [1, [0.22254917347243558, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65603394]
bas 1, expnt(s) = [7617.52152562]
bas 2, expnt(s) = [3617.35104841]
bas 3, expnt(s) = [1597.81752805]
bas 4, expnt(s) = [382.85300106]
bas 5, expnt(s) = [108.13782972]
bas 6, expnt(s) = [35.09799015]
bas 7, expnt(s) = [7.9445592]
bas 8, expnt(s) = [3.06972984]
bas 9, expnt(s) = [0.39894215]
bas 10, expnt(s) = [1362.783266]
bas 11, expnt(s) = [664.74508871]
bas 12, expnt(s) = [300.9591966]
bas 13, expnt(s) = [314.03986421]
bas 14, expnt(s) = [61.62498934]
bas 15, expnt(s) = [7.32741509]
bas 16, expnt(s) = [20.23453928]
bas 17, expnt(s) = [0.77342439]
bas 18, expnt(s) = [2.82754546]
bas 19, expnt(s) = [0.22254917]
CPU time:       539.53
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826560e+04 5.20026289e+03 7.61752153e+03 2.06003829e+03
 3.61735105e+03 1.17844147e+03 1.59781753e+03 6.38499277e+02
 3.82853001e+02 2.18669930e+02 1.08137830e+02 8.47224022e+01
 3.50979901e+01 3.64314712e+01 7.94455920e+00 1.19554899e+01
 3.06972984e+00 5.85922454e+00 3.98942153e-01 1.26822839e+00
 1.36278327e+03 2.41556030e+04 6.64745089e+02 9.84698586e+03
 3.00959197e+02 3.65694910e+03 3.14039864e+02 3.85669566e+03
 6.16249893e+01 5.03709874e+02 7.32741509e+00 3.51700419e+01
 2.02345393e+01 1.25199053e+02 7.73424386e-01 2.11595642e+00
 2.82754546e+00 1.06966156e+01 2.22549173e-01 4.45930189e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98301508414979
cond(S) = 102376.76888993819
E1 = -729.380441136409  E_coul = 203.12462229545278
init E= -526.255818840956
    CPU time for initialize scf      7.30 sec, wall time      0.35 sec
  HOMO = -0.55689180566358  LUMO = 1.02910696204888
  mo_energy =
[-1.18331137e+02 -1.22076026e+01 -9.45134081e+00 -9.45134081e+00
 -9.45134081e+00 -1.22552727e+00 -5.56891806e-01 -5.56891806e-01
 -5.56891806e-01  1.02910696e+00  1.02910696e+00  1.02910696e+00
  7.36172843e+00  7.36172843e+00  7.36172843e+00  9.54126644e+00
  3.35577994e+01  3.35577994e+01  3.35577994e+01  1.02679478e+02
  1.29165645e+02  1.29165645e+02  1.29165645e+02  4.83560090e+02
  4.83560090e+02  4.83560090e+02  5.83844623e+02  1.33544768e+03
  1.33544768e+03  1.33544768e+03  2.65257057e+03  3.02975260e+03
  3.02975260e+03  3.02975260e+03  6.65030319e+03  6.65030319e+03
  6.65030319e+03  9.05839373e+03  2.54142048e+04  7.61567986e+04]
E1 = -727.9491081505529  E_coul = 201.24857257469654
cycle= 1 E= -526.700535575856  delta_E= -0.445  |g|= 0.185  |ddm|= 0.42
    CPU time for cycle= 1      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.543013
diis-c [-0.2948633  1.       ]
  HOMO = -0.581950491942316  LUMO = 1.01267476770861
  mo_energy =
[-1.18628498e+02 -1.23328713e+01 -9.58721314e+00 -9.58721314e+00
 -9.58721314e+00 -1.25752005e+00 -5.81950492e-01 -5.81950492e-01
 -5.81950492e-01  1.01267477e+00  1.01267477e+00  1.01267477e+00
  7.28442469e+00  7.28442469e+00  7.28442469e+00  9.45123530e+00
  3.34160301e+01  3.34160301e+01  3.34160301e+01  1.02471694e+02
  1.28948949e+02  1.28948949e+02  1.28948949e+02  4.83263995e+02
  4.83263995e+02  4.83263995e+02  5.83510322e+02  1.33509458e+03
  1.33509458e+03  1.33509458e+03  2.65208224e+03  3.02933288e+03
  3.02933288e+03  3.02933288e+03  6.64976975e+03  6.64976975e+03
  6.64976975e+03  9.05778467e+03  2.54135015e+04  7.61560051e+04]
E1 = -728.4221321648355  E_coul = 201.72098345024702
cycle= 2 E= -526.701148714588  delta_E= -0.000613  |g|= 0.0341  |ddm|= 0.0395
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0680032
diis-c [-0.00272171  0.07467656  0.92532344]
  HOMO = -0.575081922507952  LUMO = 1.01785082659592
  mo_energy =
[-1.18568844e+02 -1.23014484e+01 -9.55446916e+00 -9.55446916e+00
 -9.55446916e+00 -1.24880226e+00 -5.75081923e-01 -5.75081923e-01
 -5.75081923e-01  1.01785083e+00  1.01785083e+00  1.01785083e+00
  7.30329875e+00  7.30329875e+00  7.30329875e+00  9.47571466e+00
  3.34493919e+01  3.34493919e+01  3.34493919e+01  1.02519901e+02
  1.28997279e+02  1.28997279e+02  1.28997279e+02  4.83322889e+02
  4.83322889e+02  4.83322889e+02  5.83571464e+02  1.33515732e+03
  1.33515732e+03  1.33515732e+03  2.65214803e+03  3.02939771e+03
  3.02939771e+03  3.02939771e+03  6.64983614e+03  6.64983614e+03
  6.64983614e+03  9.05785178e+03  2.54135691e+04  7.61560729e+04]
E1 = -728.3146716652567  E_coul = 201.61348667970762
cycle= 3 E= -526.701184985549  delta_E= -3.63e-05  |g|= 0.00489  |ddm|= 0.0105
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106332
diis-c [-5.06075437e-07 -1.16574071e-03  1.30385199e-01  8.70780542e-01]
  HOMO = -0.576021636877099  LUMO = 1.01715404217287
  mo_energy =
[-1.18576510e+02 -1.23055522e+01 -9.55885451e+00 -9.55885451e+00
 -9.55885451e+00 -1.24993917e+00 -5.76021637e-01 -5.76021637e-01
 -5.76021637e-01  1.01715404e+00  1.01715404e+00  1.01715404e+00
  7.30074558e+00  7.30074558e+00  7.30074558e+00  9.47260507e+00
  3.34449552e+01  3.34449552e+01  3.34449552e+01  1.02513708e+02
  1.28991013e+02  1.28991013e+02  1.28991013e+02  4.83315320e+02
  4.83315320e+02  4.83315320e+02  5.83563575e+02  1.33514923e+03
  1.33514923e+03  1.33514923e+03  2.65213936e+03  3.02938926e+03
  3.02938926e+03  3.02938926e+03  6.64982733e+03  6.64982733e+03
  6.64982733e+03  9.05784277e+03  2.54135599e+04  7.61560637e+04]
E1 = -728.329186358177  E_coul = 201.62800049853962
cycle= 4 E= -526.701185859637  delta_E= -8.74e-07  |g|= 6.42e-05  |ddm|= 0.00134
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000134217
diis-c [-1.42553335e-09  6.65500954e-05 -9.14097606e-03 -7.24983123e-02
  1.08157274e+00]
  HOMO = -0.576009452892207  LUMO = 1.01716307416486
  mo_energy =
[-1.18576517e+02 -1.23055236e+01 -9.55883847e+00 -9.55883847e+00
 -9.55883847e+00 -1.24991950e+00 -5.76009453e-01 -5.76009453e-01
 -5.76009453e-01  1.01716307e+00  1.01716307e+00  1.01716307e+00
  7.30076585e+00  7.30076585e+00  7.30076585e+00  9.47264108e+00
  3.34449699e+01  3.34449699e+01  3.34449699e+01  1.02513717e+02
  1.28991018e+02  1.28991018e+02  1.28991018e+02  4.83315313e+02
  4.83315313e+02  4.83315313e+02  5.83563560e+02  1.33514921e+03
  1.33514921e+03  1.33514921e+03  2.65213932e+03  3.02938923e+03
  3.02938923e+03  3.02938923e+03  6.64982729e+03  6.64982729e+03
  6.64982729e+03  9.05784272e+03  2.54135599e+04  7.61560636e+04]
E1 = -728.3291906198413  E_coul = 201.6280047600735
cycle= 5 E= -526.701185859768  delta_E= -1.3e-10  |g|= 8.13e-06  |ddm|= 2.62e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3291906198413  E_coul = 201.6280047600735
  HOMO = -0.576013080481192  LUMO = 1.01716042701282
  mo_energy =
[-1.18576535e+02 -1.23055363e+01 -9.55885188e+00 -9.55885188e+00
 -9.55885188e+00 -1.24992396e+00 -5.76013080e-01 -5.76013080e-01
 -5.76013080e-01  1.01716043e+00  1.01716043e+00  1.01716043e+00
  7.30075703e+00  7.30075703e+00  7.30075703e+00  9.47263081e+00
  3.34449568e+01  3.34449568e+01  3.34449568e+01  1.02513701e+02
  1.28991002e+02  1.28991002e+02  1.28991002e+02  4.83315296e+02
  4.83315296e+02  4.83315296e+02  5.83563542e+02  1.33514919e+03
  1.33514919e+03  1.33514919e+03  2.65213930e+03  3.02938921e+03
  3.02938921e+03  3.02938921e+03  6.64982727e+03  6.64982727e+03
  6.64982727e+03  9.05784270e+03  2.54135598e+04  7.61560636e+04]
E1 = -728.3292310852423  E_coul = 201.6280452254689
Extra cycle  E= -526.701185859773  delta_E= -5.68e-12  |g|= 2.42e-06  |ddm|= 4.2e-06
    CPU time for scf_cycle      7.53 sec, wall time      0.53 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102376.76888993819
E1 = -728.3292310852423  E_coul = 201.6280452254689
init E= -526.701185859773
    CPU time for initialize scf     15.71 sec, wall time      0.75 sec
  HOMO = -0.576012338232558  LUMO = 1.01716097509477
  mo_energy =
[-1.18576530e+02 -1.23055334e+01 -9.55884881e+00 -9.55884881e+00
 -9.55884881e+00 -1.24992303e+00 -5.76012338e-01 -5.76012338e-01
 -5.76012338e-01  1.01716098e+00  1.01716098e+00  1.01716098e+00
  7.30075892e+00  7.30075892e+00  7.30075892e+00  9.47263315e+00
  3.34449598e+01  3.34449598e+01  3.34449598e+01  1.02513705e+02
  1.28991006e+02  1.28991006e+02  1.28991006e+02  4.83315300e+02
  4.83315300e+02  4.83315300e+02  5.83563547e+02  1.33514920e+03
  1.33514920e+03  1.33514920e+03  2.65213931e+03  3.02938922e+03
  3.02938922e+03  3.02938922e+03  6.64982728e+03  6.64982728e+03
  6.64982728e+03  9.05784271e+03  2.54135599e+04  7.61560636e+04]
E1 = -728.3292214213303  E_coul = 201.62803556155703
cycle= 1 E= -526.701185859773  delta_E= 1.14e-13  |g|= 6.24e-07  |ddm|= 9.67e-07
    CPU time for cycle= 1      0.05 sec, wall time      0.02 sec
E1 = -728.3292214213303  E_coul = 201.62803556155703
  HOMO = -0.576012503088713  LUMO = 1.01716085269137
  mo_energy =
[-1.18576532e+02 -1.23055341e+01 -9.55884954e+00 -9.55884954e+00
 -9.55884954e+00 -1.24992323e+00 -5.76012503e-01 -5.76012503e-01
 -5.76012503e-01  1.01716085e+00  1.01716085e+00  1.01716085e+00
  7.30075849e+00  7.30075849e+00  7.30075849e+00  9.47263261e+00
  3.34449591e+01  3.34449591e+01  3.34449591e+01  1.02513704e+02
  1.28991005e+02  1.28991005e+02  1.28991005e+02  4.83315299e+02
  4.83315299e+02  4.83315299e+02  5.83563546e+02  1.33514920e+03
  1.33514920e+03  1.33514920e+03  2.65213931e+03  3.02938922e+03
  3.02938922e+03  3.02938922e+03  6.64982728e+03  6.64982728e+03
  6.64982728e+03  9.05784271e+03  2.54135598e+04  7.61560636e+04]
E1 = -728.3292237886283  E_coul = 201.62803792885535
Extra cycle  E= -526.701185859773  delta_E= 3.41e-13  |g|= 1.57e-07  |ddm|= 2.27e-07
    CPU time for scf_cycle     16.06 sec, wall time      1.08 sec
exp = [2.61826560e+04 7.61752153e+03 3.61735105e+03 1.59781753e+03
 3.82853001e+02 1.08137830e+02 3.50979901e+01 7.94455920e+00
 3.06972984e+00 3.98942153e-01 1.36278327e+03 6.64745089e+02
 3.00959197e+02 3.14039864e+02 6.16249893e+01 7.32741509e+00
 2.02345393e+01 7.73424386e-01 2.82754546e+00 2.22549173e-01]
grad_E = [-1.51356833e-06  3.26570077e-06 -1.60344279e-06  6.76607999e-05
  2.11575756e-05 -7.48260284e-04 -1.94056857e-03  7.99559177e-04
 -1.14813094e-03  3.01312096e-03 -5.00766599e-07  5.09067439e-06
  2.41253123e-05  2.07984690e-05 -8.08773473e-05 -2.53844178e-03
  6.41397203e-04  3.81479374e-03  3.56824608e-03 -1.61756621e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:56:45 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6560422        1
[INPUT] 0    0    [1    /1   ]  7617.52150778        1
[INPUT] 0    0    [1    /1   ]  3617.35105698        1
[INPUT] 0    0    [1    /1   ]  1597.8171559         1
[INPUT] 0    0    [1    /1   ]  382.853046792        1
[INPUT] 0    0    [1    /1   ]  108.140085097        1
[INPUT] 0    0    [1    /1   ]  35.1124362365        1
[INPUT] 0    0    [1    /1   ]  7.97886784311        1
[INPUT] 0    0    [1    /1   ]  3.07869171855        1
[INPUT] 0    0    [1    /1   ]  0.398877992059       1
[INPUT] 1    0    [1    /1   ]  1362.78326872        1
[INPUT] 1    0    [1    /1   ]  664.745061252        1
[INPUT] 1    0    [1    /1   ]  300.959066694        1
[INPUT] 1    0    [1    /1   ]  314.039752213        1
[INPUT] 1    0    [1    /1   ]  61.6253015173        1
[INPUT] 1    0    [1    /1   ]  7.33461668458        1
[INPUT] 1    0    [1    /1   ]  20.2324774802        1
[INPUT] 1    0    [1    /1   ]  0.773106298906       1
[INPUT] 1    0    [1    /1   ]  2.81829324875        1
[INPUT] 1    0    [1    /1   ]  0.222678412162       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.65604215401, 1.0]], [0, [7617.521507778819, 1.0]], [0, [3617.3510569806836, 1.0]], [0, [1597.817155895539, 1.0]], [0, [382.853046792331, 1.0]], [0, [108.14008509710398, 1.0]], [0, [35.11243623646066, 1.0]], [0, [7.978867843114069, 1.0]], [0, [3.078691718551146, 1.0]], [0, [0.3988779920594811, 1.0]], [1, [1362.783268723757, 1.0]], [1, [664.7450612522249, 1.0]], [1, [300.9590666935076, 1.0]], [1, [314.0397522125236, 1.0]], [1, [61.62530151727741, 1.0]], [1, [7.3346166845787035, 1.0]], [1, [20.2324774802101, 1.0]], [1, [0.7731062989057707, 1.0]], [1, [2.818293248749691, 1.0]], [1, [0.2226784121618058, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65604215]
bas 1, expnt(s) = [7617.52150778]
bas 2, expnt(s) = [3617.35105698]
bas 3, expnt(s) = [1597.8171559]
bas 4, expnt(s) = [382.85304679]
bas 5, expnt(s) = [108.1400851]
bas 6, expnt(s) = [35.11243624]
bas 7, expnt(s) = [7.97886784]
bas 8, expnt(s) = [3.07869172]
bas 9, expnt(s) = [0.39887799]
bas 10, expnt(s) = [1362.78326872]
bas 11, expnt(s) = [664.74506125]
bas 12, expnt(s) = [300.95906669]
bas 13, expnt(s) = [314.03975221]
bas 14, expnt(s) = [61.62530152]
bas 15, expnt(s) = [7.33461668]
bas 16, expnt(s) = [20.23247748]
bas 17, expnt(s) = [0.7731063]
bas 18, expnt(s) = [2.81829325]
bas 19, expnt(s) = [0.22267841]
CPU time:       567.92
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826560e+04 5.20026290e+03 7.61752151e+03 2.06003828e+03
 3.61735106e+03 1.17844147e+03 1.59781716e+03 6.38499166e+02
 3.82853047e+02 2.18669950e+02 1.08140085e+02 8.47237275e+01
 3.51124362e+01 3.64427169e+01 7.97886784e+00 1.19941915e+01
 3.07869172e+00 5.87204908e+00 3.98877992e-01 1.26807541e+00
 1.36278327e+03 2.41556030e+04 6.64745061e+02 9.84698535e+03
 3.00959067e+02 3.65694713e+03 3.14039752e+02 3.85669394e+03
 6.16253015e+01 5.03713063e+02 7.33461668e+00 3.52132549e+01
 2.02324775e+01 1.25183106e+02 7.73106299e-01 2.11486869e+00
 2.81829325e+00 1.06528820e+01 2.22678412e-01 4.46253913e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98301013526773
cond(S) = 102389.9806746372
E1 = -729.3795570136136  E_coul = 203.1237079327276
init E= -526.255849080886
    CPU time for initialize scf      7.27 sec, wall time      0.35 sec
  HOMO = -0.556905594521676  LUMO = 1.02919874079998
  mo_energy =
[-1.18331238e+02 -1.22076453e+01 -9.45142619e+00 -9.45142619e+00
 -9.45142619e+00 -1.22556488e+00 -5.56905595e-01 -5.56905595e-01
 -5.56905595e-01  1.02919874e+00  1.02919874e+00  1.02919874e+00
  7.34751349e+00  7.34751349e+00  7.34751349e+00  9.60033097e+00
  3.35397235e+01  3.35397235e+01  3.35397235e+01  1.02883994e+02
  1.29153614e+02  1.29153614e+02  1.29153614e+02  4.83551007e+02
  4.83551007e+02  4.83551007e+02  5.84071097e+02  1.33543963e+03
  1.33543963e+03  1.33543963e+03  2.65277674e+03  3.02974487e+03
  3.02974487e+03  3.02974487e+03  6.65029590e+03  6.65029590e+03
  6.65029590e+03  9.05858343e+03  2.54143841e+04  7.61569655e+04]
E1 = -727.9510717816747  E_coul = 201.25049107519342
cycle= 1 E= -526.700580706481  delta_E= -0.445  |g|= 0.185  |ddm|= 0.416
    CPU time for cycle= 1      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.542691
diis-c [-0.29451351  1.        ]
  HOMO = -0.581832544213072  LUMO = 1.01287440610554
  mo_energy =
[-1.18628358e+02 -1.23327835e+01 -9.58713285e+00 -9.58713285e+00
 -9.58713285e+00 -1.25740429e+00 -5.81832544e-01 -5.81832544e-01
 -5.81832544e-01  1.01287441e+00  1.01287441e+00  1.01287441e+00
  7.27046101e+00  7.27046101e+00  7.27046101e+00  9.51018348e+00
  3.33981089e+01  3.33981089e+01  3.33981089e+01  1.02676378e+02
  1.28937117e+02  1.28937117e+02  1.28937117e+02  4.83255144e+02
  4.83255144e+02  4.83255144e+02  5.83737046e+02  1.33508677e+03
  1.33508677e+03  1.33508677e+03  2.65228867e+03  3.02932540e+03
  3.02932540e+03  3.02932540e+03  6.64976272e+03  6.64976272e+03
  6.64976272e+03  9.05797465e+03  2.54136811e+04  7.61561724e+04]
E1 = -728.4231745822775  E_coul = 201.72198259216296
cycle= 2 E= -526.701191990115  delta_E= -0.000611  |g|= 0.034  |ddm|= 0.0395
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0678747
diis-c [-0.00271614  0.07450101  0.92549899]
  HOMO = -0.574977635502121  LUMO = 1.01803686451731
  mo_energy =
[-1.18568791e+02 -1.23014181e+01 -9.55444955e+00 -9.55444955e+00
 -9.55444955e+00 -1.24870407e+00 -5.74977636e-01 -5.74977636e-01
 -5.74977636e-01  1.01803686e+00  1.01803686e+00  1.01803686e+00
  7.28927870e+00  7.28927870e+00  7.28927870e+00  9.53467741e+00
  3.34314150e+01  3.34314150e+01  3.34314150e+01  1.02724516e+02
  1.28985372e+02  1.28985372e+02  1.28985372e+02  4.83313953e+02
  4.83313953e+02  4.83313953e+02  5.83798100e+02  1.33514943e+03
  1.33514943e+03  1.33514943e+03  2.65235437e+03  3.02939014e+03
  3.02939014e+03  3.02939014e+03  6.64982902e+03  6.64982902e+03
  6.64982902e+03  9.05804167e+03  2.54137486e+04  7.61562401e+04]
E1 = -728.3160032696778  E_coul = 201.6147751761311
cycle= 3 E= -526.701228093547  delta_E= -3.61e-05  |g|= 0.00489  |ddm|= 0.0104
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106171
diis-c [-5.01263482e-07 -1.16352502e-03  1.30440096e-01  8.70723429e-01]
  HOMO = -0.5759145502722  LUMO = 1.01734252610057
  mo_energy =
[-1.18576447e+02 -1.23055146e+01 -9.55882685e+00 -9.55882685e+00
 -9.55882685e+00 -1.24983782e+00 -5.75914550e-01 -5.75914550e-01
 -5.75914550e-01  1.01734253e+00  1.01734253e+00  1.01734253e+00
  7.28673407e+00  7.28673407e+00  7.28673407e+00  9.53156601e+00
  3.34269854e+01  3.34269854e+01  3.34269854e+01  1.02718330e+02
  1.28979115e+02  1.28979115e+02  1.28979115e+02  4.83306393e+02
  4.83306393e+02  4.83306393e+02  5.83790221e+02  1.33514135e+03
  1.33514135e+03  1.33514135e+03  2.65234571e+03  3.02938170e+03
  3.02938170e+03  3.02938170e+03  6.64982022e+03  6.64982022e+03
  6.64982022e+03  9.05803267e+03  2.54137395e+04  7.61562308e+04]
E1 = -728.3304789850255  E_coul = 201.6292500212306
cycle= 4 E= -526.701228963795  delta_E= -8.7e-07  |g|= 6.39e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000134
diis-c [-1.40584199e-09  6.65221317e-05 -9.14914486e-03 -7.25385094e-02
  1.08162113e+00]
  HOMO = -0.57590252220494  LUMO = 1.01735143637703
  mo_energy =
[-1.18576455e+02 -1.23054865e+01 -9.55881128e+00 -9.55881128e+00
 -9.55881128e+00 -1.24981840e+00 -5.75902522e-01 -5.75902522e-01
 -5.75902522e-01  1.01735144e+00  1.01735144e+00  1.01735144e+00
  7.28675399e+00  7.28675399e+00  7.28675399e+00  9.53160151e+00
  3.34269996e+01  3.34269996e+01  3.34269996e+01  1.02718339e+02
  1.28979119e+02  1.28979119e+02  1.28979119e+02  4.83306386e+02
  4.83306386e+02  4.83306386e+02  5.83790206e+02  1.33514133e+03
  1.33514133e+03  1.33514133e+03  2.65234567e+03  3.02938168e+03
  3.02938168e+03  3.02938168e+03  6.64982018e+03  6.64982018e+03
  6.64982018e+03  9.05803262e+03  2.54137394e+04  7.61562307e+04]
E1 = -728.3304844527872  E_coul = 201.629255488863
cycle= 5 E= -526.701228963924  delta_E= -1.29e-10  |g|= 8.04e-06  |ddm|= 2.58e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3304844527872  E_coul = 201.629255488863
  HOMO = -0.575906111612384  LUMO = 1.01734881861067
  mo_energy =
[-1.18576473e+02 -1.23054991e+01 -9.55882454e+00 -9.55882454e+00
 -9.55882454e+00 -1.24982280e+00 -5.75906112e-01 -5.75906112e-01
 -5.75906112e-01  1.01734882e+00  1.01734882e+00  1.01734882e+00
  7.28674528e+00  7.28674528e+00  7.28674528e+00  9.53159133e+00
  3.34269866e+01  3.34269866e+01  3.34269866e+01  1.02718323e+02
  1.28979103e+02  1.28979103e+02  1.28979103e+02  4.83306368e+02
  4.83306368e+02  4.83306368e+02  5.83790188e+02  1.33514131e+03
  1.33514131e+03  1.33514131e+03  2.65234565e+03  3.02938166e+03
  3.02938166e+03  3.02938166e+03  6.64982016e+03  6.64982016e+03
  6.64982016e+03  9.05803261e+03  2.54137394e+04  7.61562307e+04]
E1 = -728.3305244133826  E_coul = 201.62929544945604
Extra cycle  E= -526.701228963926  delta_E= -2.27e-12  |g|= 2.39e-06  |ddm|= 4.14e-06
    CPU time for scf_cycle      7.49 sec, wall time      0.53 sec
exp = [2.61826560e+04 7.61752151e+03 3.61735106e+03 1.59781716e+03
 3.82853047e+02 1.08140085e+02 3.51124362e+01 7.97886784e+00
 3.07869172e+00 3.98877992e-01 1.36278327e+03 6.64745061e+02
 3.00959067e+02 3.14039752e+02 6.16253015e+01 7.33461668e+00
 2.02324775e+01 7.73106299e-01 2.81829325e+00 2.22678412e-01]
E = -526.7012289639265
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:56:46 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6560422        1
[INPUT] 0    0    [1    /1   ]  7617.52150778        1
[INPUT] 0    0    [1    /1   ]  3617.35105698        1
[INPUT] 0    0    [1    /1   ]  1597.8171559         1
[INPUT] 0    0    [1    /1   ]  382.853046792        1
[INPUT] 0    0    [1    /1   ]  108.140085097        1
[INPUT] 0    0    [1    /1   ]  35.1124362365        1
[INPUT] 0    0    [1    /1   ]  7.97886784311        1
[INPUT] 0    0    [1    /1   ]  3.07869171855        1
[INPUT] 0    0    [1    /1   ]  0.398877992059       1
[INPUT] 1    0    [1    /1   ]  1362.78326872        1
[INPUT] 1    0    [1    /1   ]  664.745061252        1
[INPUT] 1    0    [1    /1   ]  300.959066694        1
[INPUT] 1    0    [1    /1   ]  314.039752213        1
[INPUT] 1    0    [1    /1   ]  61.6253015173        1
[INPUT] 1    0    [1    /1   ]  7.33461668458        1
[INPUT] 1    0    [1    /1   ]  20.2324774802        1
[INPUT] 1    0    [1    /1   ]  0.773106298906       1
[INPUT] 1    0    [1    /1   ]  2.81829324875        1
[INPUT] 1    0    [1    /1   ]  0.222678412162       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.65604215401, 1.0]], [0, [7617.521507778819, 1.0]], [0, [3617.3510569806836, 1.0]], [0, [1597.817155895539, 1.0]], [0, [382.853046792331, 1.0]], [0, [108.14008509710398, 1.0]], [0, [35.11243623646066, 1.0]], [0, [7.978867843114069, 1.0]], [0, [3.078691718551146, 1.0]], [0, [0.3988779920594811, 1.0]], [1, [1362.783268723757, 1.0]], [1, [664.7450612522249, 1.0]], [1, [300.9590666935076, 1.0]], [1, [314.0397522125236, 1.0]], [1, [61.62530151727741, 1.0]], [1, [7.3346166845787035, 1.0]], [1, [20.2324774802101, 1.0]], [1, [0.7731062989057707, 1.0]], [1, [2.818293248749691, 1.0]], [1, [0.2226784121618058, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65604215]
bas 1, expnt(s) = [7617.52150778]
bas 2, expnt(s) = [3617.35105698]
bas 3, expnt(s) = [1597.8171559]
bas 4, expnt(s) = [382.85304679]
bas 5, expnt(s) = [108.1400851]
bas 6, expnt(s) = [35.11243624]
bas 7, expnt(s) = [7.97886784]
bas 8, expnt(s) = [3.07869172]
bas 9, expnt(s) = [0.39887799]
bas 10, expnt(s) = [1362.78326872]
bas 11, expnt(s) = [664.74506125]
bas 12, expnt(s) = [300.95906669]
bas 13, expnt(s) = [314.03975221]
bas 14, expnt(s) = [61.62530152]
bas 15, expnt(s) = [7.33461668]
bas 16, expnt(s) = [20.23247748]
bas 17, expnt(s) = [0.7731063]
bas 18, expnt(s) = [2.81829325]
bas 19, expnt(s) = [0.22267841]
CPU time:       575.50
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826560e+04 5.20026290e+03 7.61752151e+03 2.06003828e+03
 3.61735106e+03 1.17844147e+03 1.59781716e+03 6.38499166e+02
 3.82853047e+02 2.18669950e+02 1.08140085e+02 8.47237275e+01
 3.51124362e+01 3.64427169e+01 7.97886784e+00 1.19941915e+01
 3.07869172e+00 5.87204908e+00 3.98877992e-01 1.26807541e+00
 1.36278327e+03 2.41556030e+04 6.64745061e+02 9.84698535e+03
 3.00959067e+02 3.65694713e+03 3.14039752e+02 3.85669394e+03
 6.16253015e+01 5.03713063e+02 7.33461668e+00 3.52132549e+01
 2.02324775e+01 1.25183106e+02 7.73106299e-01 2.11486869e+00
 2.81829325e+00 1.06528820e+01 2.22678412e-01 4.46253913e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98301013526773
cond(S) = 102389.9806746372
E1 = -729.3795570136136  E_coul = 203.1237079327276
init E= -526.255849080886
    CPU time for initialize scf      7.25 sec, wall time      0.35 sec
  HOMO = -0.556905594521676  LUMO = 1.02919874079998
  mo_energy =
[-1.18331238e+02 -1.22076453e+01 -9.45142619e+00 -9.45142619e+00
 -9.45142619e+00 -1.22556488e+00 -5.56905595e-01 -5.56905595e-01
 -5.56905595e-01  1.02919874e+00  1.02919874e+00  1.02919874e+00
  7.34751349e+00  7.34751349e+00  7.34751349e+00  9.60033097e+00
  3.35397235e+01  3.35397235e+01  3.35397235e+01  1.02883994e+02
  1.29153614e+02  1.29153614e+02  1.29153614e+02  4.83551007e+02
  4.83551007e+02  4.83551007e+02  5.84071097e+02  1.33543963e+03
  1.33543963e+03  1.33543963e+03  2.65277674e+03  3.02974487e+03
  3.02974487e+03  3.02974487e+03  6.65029590e+03  6.65029590e+03
  6.65029590e+03  9.05858343e+03  2.54143841e+04  7.61569655e+04]
E1 = -727.9510717816747  E_coul = 201.25049107519342
cycle= 1 E= -526.700580706481  delta_E= -0.445  |g|= 0.185  |ddm|= 0.416
    CPU time for cycle= 1      0.08 sec, wall time      0.03 sec
diis-norm(errvec)=0.542691
diis-c [-0.29451351  1.        ]
  HOMO = -0.581832544213072  LUMO = 1.01287440610554
  mo_energy =
[-1.18628358e+02 -1.23327835e+01 -9.58713285e+00 -9.58713285e+00
 -9.58713285e+00 -1.25740429e+00 -5.81832544e-01 -5.81832544e-01
 -5.81832544e-01  1.01287441e+00  1.01287441e+00  1.01287441e+00
  7.27046101e+00  7.27046101e+00  7.27046101e+00  9.51018348e+00
  3.33981089e+01  3.33981089e+01  3.33981089e+01  1.02676378e+02
  1.28937117e+02  1.28937117e+02  1.28937117e+02  4.83255144e+02
  4.83255144e+02  4.83255144e+02  5.83737046e+02  1.33508677e+03
  1.33508677e+03  1.33508677e+03  2.65228867e+03  3.02932540e+03
  3.02932540e+03  3.02932540e+03  6.64976272e+03  6.64976272e+03
  6.64976272e+03  9.05797465e+03  2.54136811e+04  7.61561724e+04]
E1 = -728.4231745822775  E_coul = 201.72198259216296
cycle= 2 E= -526.701191990115  delta_E= -0.000611  |g|= 0.034  |ddm|= 0.0395
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0678747
diis-c [-0.00271614  0.07450101  0.92549899]
  HOMO = -0.574977635502121  LUMO = 1.01803686451731
  mo_energy =
[-1.18568791e+02 -1.23014181e+01 -9.55444955e+00 -9.55444955e+00
 -9.55444955e+00 -1.24870407e+00 -5.74977636e-01 -5.74977636e-01
 -5.74977636e-01  1.01803686e+00  1.01803686e+00  1.01803686e+00
  7.28927870e+00  7.28927870e+00  7.28927870e+00  9.53467741e+00
  3.34314150e+01  3.34314150e+01  3.34314150e+01  1.02724516e+02
  1.28985372e+02  1.28985372e+02  1.28985372e+02  4.83313953e+02
  4.83313953e+02  4.83313953e+02  5.83798100e+02  1.33514943e+03
  1.33514943e+03  1.33514943e+03  2.65235437e+03  3.02939014e+03
  3.02939014e+03  3.02939014e+03  6.64982902e+03  6.64982902e+03
  6.64982902e+03  9.05804167e+03  2.54137486e+04  7.61562401e+04]
E1 = -728.3160032696778  E_coul = 201.6147751761311
cycle= 3 E= -526.701228093547  delta_E= -3.61e-05  |g|= 0.00489  |ddm|= 0.0104
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106171
diis-c [-5.01263482e-07 -1.16352502e-03  1.30440096e-01  8.70723429e-01]
  HOMO = -0.5759145502722  LUMO = 1.01734252610057
  mo_energy =
[-1.18576447e+02 -1.23055146e+01 -9.55882685e+00 -9.55882685e+00
 -9.55882685e+00 -1.24983782e+00 -5.75914550e-01 -5.75914550e-01
 -5.75914550e-01  1.01734253e+00  1.01734253e+00  1.01734253e+00
  7.28673407e+00  7.28673407e+00  7.28673407e+00  9.53156601e+00
  3.34269854e+01  3.34269854e+01  3.34269854e+01  1.02718330e+02
  1.28979115e+02  1.28979115e+02  1.28979115e+02  4.83306393e+02
  4.83306393e+02  4.83306393e+02  5.83790221e+02  1.33514135e+03
  1.33514135e+03  1.33514135e+03  2.65234571e+03  3.02938170e+03
  3.02938170e+03  3.02938170e+03  6.64982022e+03  6.64982022e+03
  6.64982022e+03  9.05803267e+03  2.54137395e+04  7.61562308e+04]
E1 = -728.3304789850255  E_coul = 201.6292500212306
cycle= 4 E= -526.701228963795  delta_E= -8.7e-07  |g|= 6.39e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000134
diis-c [-1.40584199e-09  6.65221317e-05 -9.14914486e-03 -7.25385094e-02
  1.08162113e+00]
  HOMO = -0.57590252220494  LUMO = 1.01735143637703
  mo_energy =
[-1.18576455e+02 -1.23054865e+01 -9.55881128e+00 -9.55881128e+00
 -9.55881128e+00 -1.24981840e+00 -5.75902522e-01 -5.75902522e-01
 -5.75902522e-01  1.01735144e+00  1.01735144e+00  1.01735144e+00
  7.28675399e+00  7.28675399e+00  7.28675399e+00  9.53160151e+00
  3.34269996e+01  3.34269996e+01  3.34269996e+01  1.02718339e+02
  1.28979119e+02  1.28979119e+02  1.28979119e+02  4.83306386e+02
  4.83306386e+02  4.83306386e+02  5.83790206e+02  1.33514133e+03
  1.33514133e+03  1.33514133e+03  2.65234567e+03  3.02938168e+03
  3.02938168e+03  3.02938168e+03  6.64982018e+03  6.64982018e+03
  6.64982018e+03  9.05803262e+03  2.54137394e+04  7.61562307e+04]
E1 = -728.3304844527872  E_coul = 201.629255488863
cycle= 5 E= -526.701228963924  delta_E= -1.29e-10  |g|= 8.04e-06  |ddm|= 2.58e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3304844527872  E_coul = 201.629255488863
  HOMO = -0.575906111612384  LUMO = 1.01734881861067
  mo_energy =
[-1.18576473e+02 -1.23054991e+01 -9.55882454e+00 -9.55882454e+00
 -9.55882454e+00 -1.24982280e+00 -5.75906112e-01 -5.75906112e-01
 -5.75906112e-01  1.01734882e+00  1.01734882e+00  1.01734882e+00
  7.28674528e+00  7.28674528e+00  7.28674528e+00  9.53159133e+00
  3.34269866e+01  3.34269866e+01  3.34269866e+01  1.02718323e+02
  1.28979103e+02  1.28979103e+02  1.28979103e+02  4.83306368e+02
  4.83306368e+02  4.83306368e+02  5.83790188e+02  1.33514131e+03
  1.33514131e+03  1.33514131e+03  2.65234565e+03  3.02938166e+03
  3.02938166e+03  3.02938166e+03  6.64982016e+03  6.64982016e+03
  6.64982016e+03  9.05803261e+03  2.54137394e+04  7.61562307e+04]
E1 = -728.3305244133826  E_coul = 201.62929544945604
Extra cycle  E= -526.701228963926  delta_E= -2.27e-12  |g|= 2.39e-06  |ddm|= 4.14e-06
    CPU time for scf_cycle      7.48 sec, wall time      0.53 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102389.9806746372
E1 = -728.3305244133826  E_coul = 201.62929544945604
init E= -526.701228963926
    CPU time for initialize scf     15.65 sec, wall time      0.76 sec
  HOMO = -0.575905379090523  LUMO = 1.01734935918113
  mo_energy =
[-1.18576468e+02 -1.23054962e+01 -9.55882151e+00 -9.55882151e+00
 -9.55882151e+00 -1.24982189e+00 -5.75905379e-01 -5.75905379e-01
 -5.75905379e-01  1.01734936e+00  1.01734936e+00  1.01734936e+00
  7.28674715e+00  7.28674715e+00  7.28674715e+00  9.53159365e+00
  3.34269896e+01  3.34269896e+01  3.34269896e+01  1.02718327e+02
  1.28979107e+02  1.28979107e+02  1.28979107e+02  4.83306373e+02
  4.83306373e+02  4.83306373e+02  5.83790192e+02  1.33514131e+03
  1.33514131e+03  1.33514131e+03  2.65234566e+03  3.02938166e+03
  3.02938166e+03  3.02938166e+03  6.64982017e+03  6.64982017e+03
  6.64982017e+03  9.05803261e+03  2.54137394e+04  7.61562307e+04]
E1 = -728.3305148792782  E_coul = 201.62928591535112
cycle= 1 E= -526.701228963927  delta_E= -5.68e-13  |g|= 6.16e-07  |ddm|= 9.53e-07
    CPU time for cycle= 1      0.05 sec, wall time      0.02 sec
E1 = -728.3305148792782  E_coul = 201.62928591535112
  HOMO = -0.575905541619057  LUMO = 1.01734923857618
  mo_energy =
[-1.18576469e+02 -1.23054969e+01 -9.55882223e+00 -9.55882223e+00
 -9.55882223e+00 -1.24982209e+00 -5.75905542e-01 -5.75905542e-01
 -5.75905542e-01  1.01734924e+00  1.01734924e+00  1.01734924e+00
  7.28674672e+00  7.28674672e+00  7.28674672e+00  9.53159312e+00
  3.34269889e+01  3.34269889e+01  3.34269889e+01  1.02718326e+02
  1.28979106e+02  1.28979106e+02  1.28979106e+02  4.83306372e+02
  4.83306372e+02  4.83306372e+02  5.83790191e+02  1.33514131e+03
  1.33514131e+03  1.33514131e+03  2.65234566e+03  3.02938166e+03
  3.02938166e+03  3.02938166e+03  6.64982017e+03  6.64982017e+03
  6.64982017e+03  9.05803261e+03  2.54137394e+04  7.61562307e+04]
E1 = -728.3305172124751  E_coul = 201.62928824854785
Extra cycle  E= -526.701228963927  delta_E= -2.27e-13  |g|= 1.55e-07  |ddm|= 2.24e-07
    CPU time for scf_cycle     15.78 sec, wall time      0.87 sec
exp = [2.61826560e+04 7.61752151e+03 3.61735106e+03 1.59781716e+03
 3.82853047e+02 1.08140085e+02 3.51124362e+01 7.97886784e+00
 3.07869172e+00 3.98877992e-01 1.36278327e+03 6.64745061e+02
 3.00959067e+02 3.14039752e+02 6.16253015e+01 7.33461668e+00
 2.02324775e+01 7.73106299e-01 2.81829325e+00 2.22678412e-01]
grad_E = [-1.51336254e-06  3.26329946e-06 -1.60485241e-06  6.75654271e-05
  2.43437306e-05 -7.78686417e-04 -1.86256946e-03  9.89967540e-04
 -1.28228611e-03  2.12387574e-03 -5.06370279e-07  5.01421920e-06
  2.36580815e-05  2.03975679e-05 -2.25754817e-05 -3.82369423e-04
  7.41527258e-05  2.03300913e-03  6.74763395e-04 -9.55387578e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:56:51 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6560442        1
[INPUT] 0    0    [1    /1   ]  7617.52150335        1
[INPUT] 0    0    [1    /1   ]  3617.35105918        1
[INPUT] 0    0    [1    /1   ]  1597.81706451        1
[INPUT] 0    0    [1    /1   ]  382.852995858        1
[INPUT] 0    0    [1    /1   ]  108.14134064         1
[INPUT] 0    0    [1    /1   ]  35.1145349118        1
[INPUT] 0    0    [1    /1   ]  7.97385269831        1
[INPUT] 0    0    [1    /1   ]  3.07863358557        1
[INPUT] 0    0    [1    /1   ]  0.398732209179       1
[INPUT] 1    0    [1    /1   ]  1362.78326941        1
[INPUT] 1    0    [1    /1   ]  664.745054367        1
[INPUT] 1    0    [1    /1   ]  300.959034124        1
[INPUT] 1    0    [1    /1   ]  314.039724133        1
[INPUT] 1    0    [1    /1   ]  61.625378973         1
[INPUT] 1    0    [1    /1   ]  7.33704865077        1
[INPUT] 1    0    [1    /1   ]  20.2318996055        1
[INPUT] 1    0    [1    /1   ]  0.773389735784       1
[INPUT] 1    0    [1    /1   ]  2.81463377354        1
[INPUT] 1    0    [1    /1   ]  0.223044926299       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.65604421296, 1.0]], [0, [7617.521503351585, 1.0]], [0, [3617.351059178421, 1.0]], [0, [1597.8170645063328, 1.0]], [0, [382.85299585764875, 1.0]], [0, [108.14134063971198, 1.0]], [0, [35.1145349118157, 1.0]], [0, [7.973852698305251, 1.0]], [0, [3.078633585570201, 1.0]], [0, [0.39873220917856267, 1.0]], [1, [1362.7832694085632, 1.0]], [1, [664.7450543672015, 1.0]], [1, [300.95903412424445, 1.0]], [1, [314.0397241334547, 1.0]], [1, [61.62537897296221, 1.0]], [1, [7.337048650772514, 1.0]], [1, [20.231899605484923, 1.0]], [1, [0.7733897357842084, 1.0]], [1, [2.8146337735418485, 1.0]], [1, [0.22304492629868766, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65604421]
bas 1, expnt(s) = [7617.52150335]
bas 2, expnt(s) = [3617.35105918]
bas 3, expnt(s) = [1597.81706451]
bas 4, expnt(s) = [382.85299586]
bas 5, expnt(s) = [108.14134064]
bas 6, expnt(s) = [35.11453491]
bas 7, expnt(s) = [7.9738527]
bas 8, expnt(s) = [3.07863359]
bas 9, expnt(s) = [0.39873221]
bas 10, expnt(s) = [1362.78326941]
bas 11, expnt(s) = [664.74505437]
bas 12, expnt(s) = [300.95903412]
bas 13, expnt(s) = [314.03972413]
bas 14, expnt(s) = [61.62537897]
bas 15, expnt(s) = [7.33704865]
bas 16, expnt(s) = [20.23189961]
bas 17, expnt(s) = [0.77338974]
bas 18, expnt(s) = [2.81463377]
bas 19, expnt(s) = [0.22304493]
CPU time:       603.60
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826560e+04 5.20026290e+03 7.61752150e+03 2.06003828e+03
 3.61735106e+03 1.17844147e+03 1.59781706e+03 6.38499138e+02
 3.82852996e+02 2.18669928e+02 1.08141341e+02 8.47244652e+01
 3.51145349e+01 3.64443505e+01 7.97385270e+00 1.19885368e+01
 3.07863359e+00 5.87196592e+00 3.98732209e-01 1.26772780e+00
 1.36278327e+03 2.41556030e+04 6.64745054e+02 9.84698522e+03
 3.00959034e+02 3.65694664e+03 3.14039724e+02 3.85669351e+03
 6.16253790e+01 5.03713855e+02 7.33704865e+00 3.52278502e+01
 2.02318996e+01 1.25178637e+02 7.73389736e-01 2.11583793e+00
 2.81463377e+00 1.06355943e+01 2.23044926e-01 4.47172233e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98299086651132
cond(S) = 102387.80847414026
E1 = -729.378466036399  E_coul = 203.12283925756384
init E= -526.255626778835
    CPU time for initialize scf      7.37 sec, wall time      0.37 sec
  HOMO = -0.556921298260892  LUMO = 1.03080547468806
  mo_energy =
[-1.18331318e+02 -1.22077017e+01 -9.45149992e+00 -9.45149992e+00
 -9.45149992e+00 -1.22559582e+00 -5.56921298e-01 -5.56921298e-01
 -5.56921298e-01  1.03080547e+00  1.03080547e+00  1.03080547e+00
  7.34451899e+00  7.34451899e+00  7.34451899e+00  9.59435098e+00
  3.35340572e+01  3.35340572e+01  3.35340572e+01  1.02867624e+02
  1.29149778e+02  1.29149778e+02  1.29149778e+02  4.83548119e+02
  4.83548119e+02  4.83548119e+02  5.84061644e+02  1.33543709e+03
  1.33543709e+03  1.33543709e+03  2.65277102e+03  3.02974244e+03
  3.02974244e+03  3.02974244e+03  6.65029362e+03  6.65029362e+03
  6.65029362e+03  9.05857853e+03  2.54143795e+04  7.61569612e+04]
E1 = -727.9548911125663  E_coul = 201.25429660202116
cycle= 1 E= -526.700594510545  delta_E= -0.445  |g|= 0.185  |ddm|= 0.416
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.542555
diis-c [-0.29436635  1.        ]
  HOMO = -0.581674647758539  LUMO = 1.0145945897528
  mo_energy =
[-1.18628114e+02 -1.23325312e+01 -9.58688811e+00 -9.58688811e+00
 -9.58688811e+00 -1.25721142e+00 -5.81674648e-01 -5.81674648e-01
 -5.81674648e-01  1.01459459e+00  1.01459459e+00  1.01459459e+00
  7.26778746e+00  7.26778746e+00  7.26778746e+00  9.50453381e+00
  3.33927495e+01  3.33927495e+01  3.33927495e+01  1.02660360e+02
  1.28933602e+02  1.28933602e+02  1.28933602e+02  4.83252585e+02
  4.83252585e+02  4.83252585e+02  5.83727910e+02  1.33508455e+03
  1.33508455e+03  1.33508455e+03  2.65228325e+03  3.02932329e+03
  3.02932329e+03  3.02932329e+03  6.64976075e+03  6.64976075e+03
  6.64976075e+03  9.05797005e+03  2.54136768e+04  7.61561683e+04]
E1 = -728.4259305232204  E_coul = 201.72472650273707
cycle= 2 E= -526.701204020483  delta_E= -0.00061  |g|= 0.034  |ddm|= 0.0394
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0677628
diis-c [-0.00270931  0.07436517  0.92563483]
  HOMO = -0.574838622703284  LUMO = 1.01974689740278
  mo_energy =
[-1.18568642e+02 -1.23012349e+01 -9.55427587e+00 -9.55427587e+00
 -9.55427587e+00 -1.24853618e+00 -5.74838623e-01 -5.74838623e-01
 -5.74838623e-01  1.01974690e+00  1.01974690e+00  1.01974690e+00
  7.28655116e+00  7.28655116e+00  7.28655116e+00  9.52896721e+00
  3.34259866e+01  3.34259866e+01  3.34259866e+01  1.02708413e+02
  1.28981772e+02  1.28981772e+02  1.28981772e+02  4.83311300e+02
  4.83311300e+02  4.83311300e+02  5.83788868e+02  1.33514711e+03
  1.33514711e+03  1.33514711e+03  2.65234886e+03  3.02938793e+03
  3.02938793e+03  3.02938793e+03  6.64982695e+03  6.64982695e+03
  6.64982695e+03  9.05803697e+03  2.54137442e+04  7.61562359e+04]
E1 = -728.3190544056484  E_coul = 201.61781444590926
cycle= 3 E= -526.701239959739  delta_E= -3.59e-05  |g|= 0.00488  |ddm|= 0.0104
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106033
diis-c [-5.01213905e-07 -1.16350879e-03  1.30476111e-01  8.70687397e-01]
  HOMO = -0.575772464272437  LUMO = 1.01905432744739
  mo_energy =
[-1.18576287e+02 -1.23053231e+01 -9.55864465e+00 -9.55864465e+00
 -9.55864465e+00 -1.24966589e+00 -5.75772464e-01 -5.75772464e-01
 -5.75772464e-01  1.01905433e+00  1.01905433e+00  1.01905433e+00
  7.28401396e+00  7.28401396e+00  7.28401396e+00  9.52586387e+00
  3.34215653e+01  3.34215653e+01  3.34215653e+01  1.02702237e+02
  1.28975525e+02  1.28975525e+02  1.28975525e+02  4.83303752e+02
  4.83303752e+02  4.83303752e+02  5.83781000e+02  1.33513903e+03
  1.33513903e+03  1.33513903e+03  2.65234021e+03  3.02937950e+03
  3.02937950e+03  3.02937950e+03  6.64981816e+03  6.64981816e+03
  6.64981816e+03  9.05802799e+03  2.54137350e+04  7.61562266e+04]
E1 = -728.3334950222458  E_coul = 201.63225419577049
cycle= 4 E= -526.701240826475  delta_E= -8.67e-07  |g|= 6.4e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000134058
diis-c [-1.40453766e-09  6.65894234e-05 -9.16211971e-03 -7.26258587e-02
  1.08172139e+00]
  HOMO = -0.57576039819438  LUMO = 1.01906327296076
  mo_energy =
[-1.18576295e+02 -1.23052950e+01 -9.55862908e+00 -9.55862908e+00
 -9.55862908e+00 -1.24964641e+00 -5.75760398e-01 -5.75760398e-01
 -5.75760398e-01  1.01906327e+00  1.01906327e+00  1.01906327e+00
  7.28403392e+00  7.28403392e+00  7.28403392e+00  9.52589944e+00
  3.34215795e+01  3.34215795e+01  3.34215795e+01  1.02702246e+02
  1.28975529e+02  1.28975529e+02  1.28975529e+02  4.83303744e+02
  4.83303744e+02  4.83303744e+02  5.83780985e+02  1.33513902e+03
  1.33513902e+03  1.33513902e+03  2.65234017e+03  3.02937948e+03
  3.02937948e+03  3.02937948e+03  6.64981812e+03  6.64981812e+03
  6.64981812e+03  9.05802794e+03  2.54137350e+04  7.61562266e+04]
E1 = -728.3335007479609  E_coul = 201.63225992135574
cycle= 5 E= -526.701240826605  delta_E= -1.3e-10  |g|= 8.03e-06  |ddm|= 2.59e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3335007479609  E_coul = 201.63225992135574
  HOMO = -0.575763979428103  LUMO = 1.01906065948069
  mo_energy =
[-1.18576313e+02 -1.23053076e+01 -9.55864231e+00 -9.55864231e+00
 -9.55864231e+00 -1.24965081e+00 -5.75763979e-01 -5.75763979e-01
 -5.75763979e-01  1.01906066e+00  1.01906066e+00  1.01906066e+00
  7.28402523e+00  7.28402523e+00  7.28402523e+00  9.52588928e+00
  3.34215665e+01  3.34215665e+01  3.34215665e+01  1.02702230e+02
  1.28975513e+02  1.28975513e+02  1.28975513e+02  4.83303727e+02
  4.83303727e+02  4.83303727e+02  5.83780967e+02  1.33513900e+03
  1.33513900e+03  1.33513900e+03  2.65234015e+03  3.02937946e+03
  3.02937946e+03  3.02937946e+03  6.64981810e+03  6.64981810e+03
  6.64981810e+03  9.05802792e+03  2.54137349e+04  7.61562266e+04]
E1 = -728.3335405949564  E_coul = 201.63229976834927
Extra cycle  E= -526.701240826607  delta_E= -1.93e-12  |g|= 2.38e-06  |ddm|= 4.13e-06
    CPU time for scf_cycle      7.55 sec, wall time      0.55 sec
exp = [2.61826560e+04 7.61752150e+03 3.61735106e+03 1.59781706e+03
 3.82852996e+02 1.08141341e+02 3.51145349e+01 7.97385270e+00
 3.07863359e+00 3.98732209e-01 1.36278327e+03 6.64745054e+02
 3.00959034e+02 3.14039724e+02 6.16253790e+01 7.33704865e+00
 2.02318996e+01 7.73389736e-01 2.81463377e+00 2.23044926e-01]
E = -526.7012408266071
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:56:52 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6560442        1
[INPUT] 0    0    [1    /1   ]  7617.52150335        1
[INPUT] 0    0    [1    /1   ]  3617.35105918        1
[INPUT] 0    0    [1    /1   ]  1597.81706451        1
[INPUT] 0    0    [1    /1   ]  382.852995858        1
[INPUT] 0    0    [1    /1   ]  108.14134064         1
[INPUT] 0    0    [1    /1   ]  35.1145349118        1
[INPUT] 0    0    [1    /1   ]  7.97385269831        1
[INPUT] 0    0    [1    /1   ]  3.07863358557        1
[INPUT] 0    0    [1    /1   ]  0.398732209179       1
[INPUT] 1    0    [1    /1   ]  1362.78326941        1
[INPUT] 1    0    [1    /1   ]  664.745054367        1
[INPUT] 1    0    [1    /1   ]  300.959034124        1
[INPUT] 1    0    [1    /1   ]  314.039724133        1
[INPUT] 1    0    [1    /1   ]  61.625378973         1
[INPUT] 1    0    [1    /1   ]  7.33704865077        1
[INPUT] 1    0    [1    /1   ]  20.2318996055        1
[INPUT] 1    0    [1    /1   ]  0.773389735784       1
[INPUT] 1    0    [1    /1   ]  2.81463377354        1
[INPUT] 1    0    [1    /1   ]  0.223044926299       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.65604421296, 1.0]], [0, [7617.521503351585, 1.0]], [0, [3617.351059178421, 1.0]], [0, [1597.8170645063328, 1.0]], [0, [382.85299585764875, 1.0]], [0, [108.14134063971198, 1.0]], [0, [35.1145349118157, 1.0]], [0, [7.973852698305251, 1.0]], [0, [3.078633585570201, 1.0]], [0, [0.39873220917856267, 1.0]], [1, [1362.7832694085632, 1.0]], [1, [664.7450543672015, 1.0]], [1, [300.95903412424445, 1.0]], [1, [314.0397241334547, 1.0]], [1, [61.62537897296221, 1.0]], [1, [7.337048650772514, 1.0]], [1, [20.231899605484923, 1.0]], [1, [0.7733897357842084, 1.0]], [1, [2.8146337735418485, 1.0]], [1, [0.22304492629868766, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65604421]
bas 1, expnt(s) = [7617.52150335]
bas 2, expnt(s) = [3617.35105918]
bas 3, expnt(s) = [1597.81706451]
bas 4, expnt(s) = [382.85299586]
bas 5, expnt(s) = [108.14134064]
bas 6, expnt(s) = [35.11453491]
bas 7, expnt(s) = [7.9738527]
bas 8, expnt(s) = [3.07863359]
bas 9, expnt(s) = [0.39873221]
bas 10, expnt(s) = [1362.78326941]
bas 11, expnt(s) = [664.74505437]
bas 12, expnt(s) = [300.95903412]
bas 13, expnt(s) = [314.03972413]
bas 14, expnt(s) = [61.62537897]
bas 15, expnt(s) = [7.33704865]
bas 16, expnt(s) = [20.23189961]
bas 17, expnt(s) = [0.77338974]
bas 18, expnt(s) = [2.81463377]
bas 19, expnt(s) = [0.22304493]
CPU time:       611.24
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826560e+04 5.20026290e+03 7.61752150e+03 2.06003828e+03
 3.61735106e+03 1.17844147e+03 1.59781706e+03 6.38499138e+02
 3.82852996e+02 2.18669928e+02 1.08141341e+02 8.47244652e+01
 3.51145349e+01 3.64443505e+01 7.97385270e+00 1.19885368e+01
 3.07863359e+00 5.87196592e+00 3.98732209e-01 1.26772780e+00
 1.36278327e+03 2.41556030e+04 6.64745054e+02 9.84698522e+03
 3.00959034e+02 3.65694664e+03 3.14039724e+02 3.85669351e+03
 6.16253790e+01 5.03713855e+02 7.33704865e+00 3.52278502e+01
 2.02318996e+01 1.25178637e+02 7.73389736e-01 2.11583793e+00
 2.81463377e+00 1.06355943e+01 2.23044926e-01 4.47172233e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98299086651132
cond(S) = 102387.80847414026
E1 = -729.378466036399  E_coul = 203.12283925756384
init E= -526.255626778835
    CPU time for initialize scf      7.37 sec, wall time      0.36 sec
  HOMO = -0.556921298260892  LUMO = 1.03080547468806
  mo_energy =
[-1.18331318e+02 -1.22077017e+01 -9.45149992e+00 -9.45149992e+00
 -9.45149992e+00 -1.22559582e+00 -5.56921298e-01 -5.56921298e-01
 -5.56921298e-01  1.03080547e+00  1.03080547e+00  1.03080547e+00
  7.34451899e+00  7.34451899e+00  7.34451899e+00  9.59435098e+00
  3.35340572e+01  3.35340572e+01  3.35340572e+01  1.02867624e+02
  1.29149778e+02  1.29149778e+02  1.29149778e+02  4.83548119e+02
  4.83548119e+02  4.83548119e+02  5.84061644e+02  1.33543709e+03
  1.33543709e+03  1.33543709e+03  2.65277102e+03  3.02974244e+03
  3.02974244e+03  3.02974244e+03  6.65029362e+03  6.65029362e+03
  6.65029362e+03  9.05857853e+03  2.54143795e+04  7.61569612e+04]
E1 = -727.9548911125663  E_coul = 201.25429660202116
cycle= 1 E= -526.700594510545  delta_E= -0.445  |g|= 0.185  |ddm|= 0.416
    CPU time for cycle= 1      0.08 sec, wall time      0.03 sec
diis-norm(errvec)=0.542555
diis-c [-0.29436635  1.        ]
  HOMO = -0.581674647758539  LUMO = 1.0145945897528
  mo_energy =
[-1.18628114e+02 -1.23325312e+01 -9.58688811e+00 -9.58688811e+00
 -9.58688811e+00 -1.25721142e+00 -5.81674648e-01 -5.81674648e-01
 -5.81674648e-01  1.01459459e+00  1.01459459e+00  1.01459459e+00
  7.26778746e+00  7.26778746e+00  7.26778746e+00  9.50453381e+00
  3.33927495e+01  3.33927495e+01  3.33927495e+01  1.02660360e+02
  1.28933602e+02  1.28933602e+02  1.28933602e+02  4.83252585e+02
  4.83252585e+02  4.83252585e+02  5.83727910e+02  1.33508455e+03
  1.33508455e+03  1.33508455e+03  2.65228325e+03  3.02932329e+03
  3.02932329e+03  3.02932329e+03  6.64976075e+03  6.64976075e+03
  6.64976075e+03  9.05797005e+03  2.54136768e+04  7.61561683e+04]
E1 = -728.4259305232204  E_coul = 201.72472650273707
cycle= 2 E= -526.701204020483  delta_E= -0.00061  |g|= 0.034  |ddm|= 0.0394
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0677628
diis-c [-0.00270931  0.07436517  0.92563483]
  HOMO = -0.574838622703284  LUMO = 1.01974689740278
  mo_energy =
[-1.18568642e+02 -1.23012349e+01 -9.55427587e+00 -9.55427587e+00
 -9.55427587e+00 -1.24853618e+00 -5.74838623e-01 -5.74838623e-01
 -5.74838623e-01  1.01974690e+00  1.01974690e+00  1.01974690e+00
  7.28655116e+00  7.28655116e+00  7.28655116e+00  9.52896721e+00
  3.34259866e+01  3.34259866e+01  3.34259866e+01  1.02708413e+02
  1.28981772e+02  1.28981772e+02  1.28981772e+02  4.83311300e+02
  4.83311300e+02  4.83311300e+02  5.83788868e+02  1.33514711e+03
  1.33514711e+03  1.33514711e+03  2.65234886e+03  3.02938793e+03
  3.02938793e+03  3.02938793e+03  6.64982695e+03  6.64982695e+03
  6.64982695e+03  9.05803697e+03  2.54137442e+04  7.61562359e+04]
E1 = -728.3190544056484  E_coul = 201.61781444590926
cycle= 3 E= -526.701239959739  delta_E= -3.59e-05  |g|= 0.00488  |ddm|= 0.0104
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106033
diis-c [-5.01213905e-07 -1.16350879e-03  1.30476111e-01  8.70687397e-01]
  HOMO = -0.575772464272437  LUMO = 1.01905432744739
  mo_energy =
[-1.18576287e+02 -1.23053231e+01 -9.55864465e+00 -9.55864465e+00
 -9.55864465e+00 -1.24966589e+00 -5.75772464e-01 -5.75772464e-01
 -5.75772464e-01  1.01905433e+00  1.01905433e+00  1.01905433e+00
  7.28401396e+00  7.28401396e+00  7.28401396e+00  9.52586387e+00
  3.34215653e+01  3.34215653e+01  3.34215653e+01  1.02702237e+02
  1.28975525e+02  1.28975525e+02  1.28975525e+02  4.83303752e+02
  4.83303752e+02  4.83303752e+02  5.83781000e+02  1.33513903e+03
  1.33513903e+03  1.33513903e+03  2.65234021e+03  3.02937950e+03
  3.02937950e+03  3.02937950e+03  6.64981816e+03  6.64981816e+03
  6.64981816e+03  9.05802799e+03  2.54137350e+04  7.61562266e+04]
E1 = -728.3334950222458  E_coul = 201.63225419577049
cycle= 4 E= -526.701240826475  delta_E= -8.67e-07  |g|= 6.4e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000134058
diis-c [-1.40453766e-09  6.65894234e-05 -9.16211971e-03 -7.26258587e-02
  1.08172139e+00]
  HOMO = -0.57576039819438  LUMO = 1.01906327296076
  mo_energy =
[-1.18576295e+02 -1.23052950e+01 -9.55862908e+00 -9.55862908e+00
 -9.55862908e+00 -1.24964641e+00 -5.75760398e-01 -5.75760398e-01
 -5.75760398e-01  1.01906327e+00  1.01906327e+00  1.01906327e+00
  7.28403392e+00  7.28403392e+00  7.28403392e+00  9.52589944e+00
  3.34215795e+01  3.34215795e+01  3.34215795e+01  1.02702246e+02
  1.28975529e+02  1.28975529e+02  1.28975529e+02  4.83303744e+02
  4.83303744e+02  4.83303744e+02  5.83780985e+02  1.33513902e+03
  1.33513902e+03  1.33513902e+03  2.65234017e+03  3.02937948e+03
  3.02937948e+03  3.02937948e+03  6.64981812e+03  6.64981812e+03
  6.64981812e+03  9.05802794e+03  2.54137350e+04  7.61562266e+04]
E1 = -728.3335007479609  E_coul = 201.63225992135574
cycle= 5 E= -526.701240826605  delta_E= -1.3e-10  |g|= 8.03e-06  |ddm|= 2.59e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3335007479609  E_coul = 201.63225992135574
  HOMO = -0.575763979428103  LUMO = 1.01906065948069
  mo_energy =
[-1.18576313e+02 -1.23053076e+01 -9.55864231e+00 -9.55864231e+00
 -9.55864231e+00 -1.24965081e+00 -5.75763979e-01 -5.75763979e-01
 -5.75763979e-01  1.01906066e+00  1.01906066e+00  1.01906066e+00
  7.28402523e+00  7.28402523e+00  7.28402523e+00  9.52588928e+00
  3.34215665e+01  3.34215665e+01  3.34215665e+01  1.02702230e+02
  1.28975513e+02  1.28975513e+02  1.28975513e+02  4.83303727e+02
  4.83303727e+02  4.83303727e+02  5.83780967e+02  1.33513900e+03
  1.33513900e+03  1.33513900e+03  2.65234015e+03  3.02937946e+03
  3.02937946e+03  3.02937946e+03  6.64981810e+03  6.64981810e+03
  6.64981810e+03  9.05802792e+03  2.54137349e+04  7.61562266e+04]
E1 = -728.3335405949564  E_coul = 201.63229976834927
Extra cycle  E= -526.701240826607  delta_E= -1.93e-12  |g|= 2.38e-06  |ddm|= 4.13e-06
    CPU time for scf_cycle      7.60 sec, wall time      0.54 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102387.80847414026
E1 = -728.3335405949564  E_coul = 201.63229976834927
init E= -526.701240826607
    CPU time for initialize scf     15.81 sec, wall time      0.77 sec
  HOMO = -0.57576324949857  LUMO = 1.01906119852488
  mo_energy =
[-1.18576308e+02 -1.23053047e+01 -9.55863929e+00 -9.55863929e+00
 -9.55863929e+00 -1.24964989e+00 -5.75763249e-01 -5.75763249e-01
 -5.75763249e-01  1.01906120e+00  1.01906120e+00  1.01906120e+00
  7.28402709e+00  7.28402709e+00  7.28402709e+00  9.52589159e+00
  3.34215696e+01  3.34215696e+01  3.34215696e+01  1.02702234e+02
  1.28975518e+02  1.28975518e+02  1.28975518e+02  4.83303731e+02
  4.83303731e+02  4.83303731e+02  5.83780972e+02  1.33513900e+03
  1.33513900e+03  1.33513900e+03  2.65234016e+03  3.02937946e+03
  3.02937946e+03  3.02937946e+03  6.64981811e+03  6.64981811e+03
  6.64981811e+03  9.05802792e+03  2.54137350e+04  7.61562266e+04]
E1 = -728.3335310946197  E_coul = 201.632290268011
cycle= 1 E= -526.701240826609  delta_E= -1.59e-12  |g|= 6.15e-07  |ddm|= 9.49e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3335310946197  E_coul = 201.632290268011
  HOMO = -0.575763411317318  LUMO = 1.01906107835907
  mo_energy =
[-1.18576310e+02 -1.23053054e+01 -9.55864001e+00 -9.55864001e+00
 -9.55864001e+00 -1.24965009e+00 -5.75763411e-01 -5.75763411e-01
 -5.75763411e-01  1.01906108e+00  1.01906108e+00  1.01906108e+00
  7.28402666e+00  7.28402666e+00  7.28402666e+00  9.52589106e+00
  3.34215688e+01  3.34215688e+01  3.34215688e+01  1.02702233e+02
  1.28975517e+02  1.28975517e+02  1.28975517e+02  4.83303730e+02
  4.83303730e+02  4.83303730e+02  5.83780970e+02  1.33513900e+03
  1.33513900e+03  1.33513900e+03  2.65234015e+03  3.02937946e+03
  3.02937946e+03  3.02937946e+03  6.64981811e+03  6.64981811e+03
  6.64981811e+03  9.05802792e+03  2.54137349e+04  7.61562266e+04]
E1 = -728.3335334181937  E_coul = 201.63229259158456
Extra cycle  E= -526.701240826609  delta_E= -4.55e-13  |g|= 1.55e-07  |ddm|= 2.23e-07
    CPU time for scf_cycle     15.92 sec, wall time      0.88 sec
exp = [2.61826560e+04 7.61752150e+03 3.61735106e+03 1.59781706e+03
 3.82852996e+02 1.08141341e+02 3.51145349e+01 7.97385270e+00
 3.07863359e+00 3.98732209e-01 1.36278327e+03 6.64745054e+02
 3.00959034e+02 3.14039724e+02 6.16253790e+01 7.33704865e+00
 2.02318996e+01 7.73389736e-01 2.81463377e+00 2.23044926e-01]
grad_E = [-1.51334845e-06  3.26319399e-06 -1.60484004e-06  6.75610691e-05
  2.45352302e-05 -7.80301764e-04 -1.86110206e-03  8.94047046e-04
 -9.98980475e-04  7.75534636e-04 -5.08367627e-07  4.98682408e-06
  2.34905117e-05  2.02538327e-05 -1.40477602e-06  4.28322903e-04
 -1.33662757e-04  3.59734262e-04 -4.49180174e-04 -1.88097588e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:56:57 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6560468        1
[INPUT] 0    0    [1    /1   ]  7617.52149784        1
[INPUT] 0    0    [1    /1   ]  3617.35106196        1
[INPUT] 0    0    [1    /1   ]  1597.81695137        1
[INPUT] 0    0    [1    /1   ]  382.852892853        1
[INPUT] 0    0    [1    /1   ]  108.143357325        1
[INPUT] 0    0    [1    /1   ]  35.1162304505        1
[INPUT] 0    0    [1    /1   ]  7.95803568977        1
[INPUT] 0    0    [1    /1   ]  3.07608865364        1
[INPUT] 0    0    [1    /1   ]  0.398588907729       1
[INPUT] 1    0    [1    /1   ]  1362.78327027        1
[INPUT] 1    0    [1    /1   ]  664.745045823        1
[INPUT] 1    0    [1    /1   ]  300.958993808        1
[INPUT] 1    0    [1    /1   ]  314.039689374        1
[INPUT] 1    0    [1    /1   ]  61.6254203481        1
[INPUT] 1    0    [1    /1   ]  7.33841368348        1
[INPUT] 1    0    [1    /1   ]  20.2316780053        1
[INPUT] 1    0    [1    /1   ]  0.773731299156       1
[INPUT] 1    0    [1    /1   ]  2.81208463405        1
[INPUT] 1    0    [1    /1   ]  0.223412749848       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.6560467889, 1.0]], [0, [7617.521497840985, 1.0]], [0, [3617.3510619619915, 1.0]], [0, [1597.8169513698988, 1.0]], [0, [382.85289285335847, 1.0]], [0, [108.1433573254224, 1.0]], [0, [35.11623045051313, 1.0]], [0, [7.958035689769393, 1.0]], [0, [3.0760886536360252, 1.0]], [0, [0.39858890772870315, 1.0]], [1, [1362.783270271543, 1.0]], [1, [664.7450458227521, 1.0]], [1, [300.95899380847084, 1.0]], [1, [314.0396893741729, 1.0]], [1, [61.62542034806259, 1.0]], [1, [7.338413683484704, 1.0]], [1, [20.231678005268485, 1.0]], [1, [0.7737312991562012, 1.0]], [1, [2.8120846340459957, 1.0]], [1, [0.22341274984800769, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65604679]
bas 1, expnt(s) = [7617.52149784]
bas 2, expnt(s) = [3617.35106196]
bas 3, expnt(s) = [1597.81695137]
bas 4, expnt(s) = [382.85289285]
bas 5, expnt(s) = [108.14335733]
bas 6, expnt(s) = [35.11623045]
bas 7, expnt(s) = [7.95803569]
bas 8, expnt(s) = [3.07608865]
bas 9, expnt(s) = [0.39858891]
bas 10, expnt(s) = [1362.78327027]
bas 11, expnt(s) = [664.74504582]
bas 12, expnt(s) = [300.95899381]
bas 13, expnt(s) = [314.03968937]
bas 14, expnt(s) = [61.62542035]
bas 15, expnt(s) = [7.33841368]
bas 16, expnt(s) = [20.23167801]
bas 17, expnt(s) = [0.7737313]
bas 18, expnt(s) = [2.81208463]
bas 19, expnt(s) = [0.22341275]
CPU time:       639.86
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826560e+04 5.20026290e+03 7.61752150e+03 2.06003828e+03
 3.61735106e+03 1.17844147e+03 1.59781695e+03 6.38499104e+02
 3.82852893e+02 2.18669884e+02 1.08143357e+02 8.47256502e+01
 3.51162305e+01 3.64456703e+01 7.95803569e+00 1.19706969e+01
 3.07608865e+00 5.86832503e+00 3.98588908e-01 1.26738607e+00
 1.36278327e+03 2.41556031e+04 6.64745046e+02 9.84698506e+03
 3.00958994e+02 3.65694602e+03 3.14039689e+02 3.85669297e+03
 6.16254203e+01 5.03714277e+02 7.33841368e+00 3.52360429e+01
 2.02316780e+01 1.25176923e+02 7.73731299e-01 2.11700605e+00
 2.81208463e+00 1.06235551e+01 2.23412750e-01 4.48094213e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98297095708865
cond(S) = 102381.40892335957
E1 = -729.3775380401311  E_coul = 203.12214580103227
init E= -526.255392239099
    CPU time for initialize scf      7.27 sec, wall time      0.35 sec
  HOMO = -0.556933209390067  LUMO = 1.03248474252758
  mo_energy =
[-1.18331382e+02 -1.22077507e+01 -9.45155792e+00 -9.45155792e+00
 -9.45155792e+00 -1.22562160e+00 -5.56933209e-01 -5.56933209e-01
 -5.56933209e-01  1.03248474e+00  1.03248474e+00  1.03248474e+00
  7.34331732e+00  7.34331732e+00  7.34331732e+00  9.57074257e+00
  3.35302757e+01  3.35302757e+01  3.35302757e+01  1.02796825e+02
  1.29147076e+02  1.29147076e+02  1.29147076e+02  4.83546125e+02
  4.83546125e+02  4.83546125e+02  5.84001077e+02  1.33543531e+03
  1.33543531e+03  1.33543531e+03  2.65272167e+03  3.02974069e+03
  3.02974069e+03  3.02974069e+03  6.65029194e+03  6.65029194e+03
  6.65029194e+03  9.05853385e+03  2.54143372e+04  7.61569218e+04]
E1 = -727.9587057781978  E_coul = 201.25809762232416
cycle= 1 E= -526.700608155874  delta_E= -0.445  |g|= 0.185  |ddm|= 0.417
    CPU time for cycle= 1      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.542457
diis-c [-0.29425937  1.        ]
  HOMO = -0.581524328754505  LUMO = 1.01637728601264
  mo_energy =
[-1.18627877e+02 -1.23322728e+01 -9.58663395e+00 -9.58663395e+00
 -9.58663395e+00 -1.25702525e+00 -5.81524329e-01 -5.81524329e-01
 -5.81524329e-01  1.01637729e+00  1.01637729e+00  1.01637729e+00
  7.26688687e+00  7.26688687e+00  7.26688687e+00  9.48132462e+00
  3.33892687e+01  3.33892687e+01  3.33892687e+01  1.02589911e+02
  1.28931206e+02  1.28931206e+02  1.28931206e+02  4.83250902e+02
  4.83250902e+02  4.83250902e+02  5.83667636e+02  1.33508306e+03
  1.33508306e+03  1.33508306e+03  2.65223419e+03  3.02932183e+03
  3.02932183e+03  3.02932183e+03  6.64975935e+03  6.64975935e+03
  6.64975935e+03  9.05792566e+03  2.54136348e+04  7.61561292e+04]
E1 = -728.4287895477015  E_coul = 201.7275734500508
cycle= 2 E= -526.701216097651  delta_E= -0.000608  |g|= 0.0339  |ddm|= 0.0393
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0676665
diis-c [-0.00270302  0.07425343  0.92574657]
  HOMO = -0.574705708695294  LUMO = 1.02152119514331
  mo_energy =
[-1.18568491e+02 -1.23010390e+01 -9.55408564e+00 -9.55408564e+00
 -9.55408564e+00 -1.24837320e+00 -5.74705709e-01 -5.74705709e-01
 -5.74705709e-01  1.02152120e+00  1.02152120e+00  1.02152120e+00
  7.28560305e+00  7.28560305e+00  7.28560305e+00  9.50568470e+00
  3.34224431e+01  3.34224431e+01  3.34224431e+01  1.02637887e+02
  1.28979299e+02  1.28979299e+02  1.28979299e+02  4.83309531e+02
  4.83309531e+02  4.83309531e+02  5.83728508e+02  1.33514554e+03
  1.33514554e+03  1.33514554e+03  2.65229970e+03  3.02938638e+03
  3.02938638e+03  3.02938638e+03  6.64982546e+03  6.64982546e+03
  6.64982546e+03  9.05799247e+03  2.54137021e+04  7.61561967e+04]
E1 = -728.3221667551304  E_coul = 201.62091485873825
cycle= 3 E= -526.701251896392  delta_E= -3.58e-05  |g|= 0.00487  |ddm|= 0.0104
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.010592
diis-c [-5.01952390e-07 -1.16393900e-03  1.30511136e-01  8.70652803e-01]
  HOMO = -0.57563687392699  LUMO = 1.0208300331509
  mo_energy =
[-1.18576126e+02 -1.23051203e+01 -9.55844724e+00 -9.55844724e+00
 -9.55844724e+00 -1.24949926e+00 -5.75636874e-01 -5.75636874e-01
 -5.75636874e-01  1.02083003e+00  1.02083003e+00  1.02083003e+00
  7.28307205e+00  7.28307205e+00  7.28307205e+00  9.50259082e+00
  3.34180290e+01  3.34180290e+01  3.34180290e+01  1.02631720e+02
  1.28973060e+02  1.28973060e+02  1.28973060e+02  4.83301993e+02
  4.83301993e+02  4.83301993e+02  5.83720649e+02  1.33513747e+03
  1.33513747e+03  1.33513747e+03  2.65229106e+03  3.02937797e+03
  3.02937797e+03  3.02937797e+03  6.64981669e+03  6.64981669e+03
  6.64981669e+03  9.05798350e+03  2.54136930e+04  7.61561875e+04]
E1 = -728.3365792567396  E_coul = 201.63532649643048
cycle= 4 E= -526.701252760309  delta_E= -8.64e-07  |g|= 6.42e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000134132
diis-c [-1.40729583e-09  6.66610730e-05 -9.17419575e-03 -7.27026707e-02
  1.08181021e+00]
  HOMO = -0.575624729015064  LUMO = 1.02083904577256
  mo_energy =
[-1.18576134e+02 -1.23050921e+01 -9.55843155e+00 -9.55843155e+00
 -9.55843155e+00 -1.24947967e+00 -5.75624729e-01 -5.75624729e-01
 -5.75624729e-01  1.02083905e+00  1.02083905e+00  1.02083905e+00
  7.28309214e+00  7.28309214e+00  7.28309214e+00  9.50262657e+00
  3.34180434e+01  3.34180434e+01  3.34180434e+01  1.02631729e+02
  1.28973065e+02  1.28973065e+02  1.28973065e+02  4.83301986e+02
  4.83301986e+02  4.83301986e+02  5.83720634e+02  1.33513746e+03
  1.33513746e+03  1.33513746e+03  2.65229102e+03  3.02937794e+03
  3.02937794e+03  3.02937794e+03  6.64981665e+03  6.64981665e+03
  6.64981665e+03  9.05798346e+03  2.54136929e+04  7.61561874e+04]
E1 = -728.3365849787292  E_coul = 201.63533221828956
cycle= 5 E= -526.70125276044  delta_E= -1.31e-10  |g|= 8.03e-06  |ddm|= 2.61e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3365849787292  E_coul = 201.63533221828956
  HOMO = -0.575628309496597  LUMO = 1.02083643089831
  mo_energy =
[-1.18576152e+02 -1.23051047e+01 -9.55844479e+00 -9.55844479e+00
 -9.55844479e+00 -1.24948406e+00 -5.75628309e-01 -5.75628309e-01
 -5.75628309e-01  1.02083643e+00  1.02083643e+00  1.02083643e+00
  7.28308345e+00  7.28308345e+00  7.28308345e+00  9.50261642e+00
  3.34180304e+01  3.34180304e+01  3.34180304e+01  1.02631713e+02
  1.28973049e+02  1.28973049e+02  1.28973049e+02  4.83301968e+02
  4.83301968e+02  4.83301968e+02  5.83720616e+02  1.33513744e+03
  1.33513744e+03  1.33513744e+03  2.65229100e+03  3.02937792e+03
  3.02937792e+03  3.02937792e+03  6.64981663e+03  6.64981663e+03
  6.64981663e+03  9.05798344e+03  2.54136929e+04  7.61561874e+04]
E1 = -728.3366248146388  E_coul = 201.63537205419487
Extra cycle  E= -526.701252760444  delta_E= -4.21e-12  |g|= 2.38e-06  |ddm|= 4.13e-06
    CPU time for scf_cycle      7.49 sec, wall time      0.53 sec
exp = [2.61826560e+04 7.61752150e+03 3.61735106e+03 1.59781695e+03
 3.82852893e+02 1.08143357e+02 3.51162305e+01 7.95803569e+00
 3.07608865e+00 3.98588908e-01 1.36278327e+03 6.64745046e+02
 3.00958994e+02 3.14039689e+02 6.16254203e+01 7.33841368e+00
 2.02316780e+01 7.73731299e-01 2.81208463e+00 2.23412750e-01]
E = -526.7012527604438
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:56:58 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6560468        1
[INPUT] 0    0    [1    /1   ]  7617.52149784        1
[INPUT] 0    0    [1    /1   ]  3617.35106196        1
[INPUT] 0    0    [1    /1   ]  1597.81695137        1
[INPUT] 0    0    [1    /1   ]  382.852892853        1
[INPUT] 0    0    [1    /1   ]  108.143357325        1
[INPUT] 0    0    [1    /1   ]  35.1162304505        1
[INPUT] 0    0    [1    /1   ]  7.95803568977        1
[INPUT] 0    0    [1    /1   ]  3.07608865364        1
[INPUT] 0    0    [1    /1   ]  0.398588907729       1
[INPUT] 1    0    [1    /1   ]  1362.78327027        1
[INPUT] 1    0    [1    /1   ]  664.745045823        1
[INPUT] 1    0    [1    /1   ]  300.958993808        1
[INPUT] 1    0    [1    /1   ]  314.039689374        1
[INPUT] 1    0    [1    /1   ]  61.6254203481        1
[INPUT] 1    0    [1    /1   ]  7.33841368348        1
[INPUT] 1    0    [1    /1   ]  20.2316780053        1
[INPUT] 1    0    [1    /1   ]  0.773731299156       1
[INPUT] 1    0    [1    /1   ]  2.81208463405        1
[INPUT] 1    0    [1    /1   ]  0.223412749848       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.6560467889, 1.0]], [0, [7617.521497840985, 1.0]], [0, [3617.3510619619915, 1.0]], [0, [1597.8169513698988, 1.0]], [0, [382.85289285335847, 1.0]], [0, [108.1433573254224, 1.0]], [0, [35.11623045051313, 1.0]], [0, [7.958035689769393, 1.0]], [0, [3.0760886536360252, 1.0]], [0, [0.39858890772870315, 1.0]], [1, [1362.783270271543, 1.0]], [1, [664.7450458227521, 1.0]], [1, [300.95899380847084, 1.0]], [1, [314.0396893741729, 1.0]], [1, [61.62542034806259, 1.0]], [1, [7.338413683484704, 1.0]], [1, [20.231678005268485, 1.0]], [1, [0.7737312991562012, 1.0]], [1, [2.8120846340459957, 1.0]], [1, [0.22341274984800769, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65604679]
bas 1, expnt(s) = [7617.52149784]
bas 2, expnt(s) = [3617.35106196]
bas 3, expnt(s) = [1597.81695137]
bas 4, expnt(s) = [382.85289285]
bas 5, expnt(s) = [108.14335733]
bas 6, expnt(s) = [35.11623045]
bas 7, expnt(s) = [7.95803569]
bas 8, expnt(s) = [3.07608865]
bas 9, expnt(s) = [0.39858891]
bas 10, expnt(s) = [1362.78327027]
bas 11, expnt(s) = [664.74504582]
bas 12, expnt(s) = [300.95899381]
bas 13, expnt(s) = [314.03968937]
bas 14, expnt(s) = [61.62542035]
bas 15, expnt(s) = [7.33841368]
bas 16, expnt(s) = [20.23167801]
bas 17, expnt(s) = [0.7737313]
bas 18, expnt(s) = [2.81208463]
bas 19, expnt(s) = [0.22341275]
CPU time:       647.46
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826560e+04 5.20026290e+03 7.61752150e+03 2.06003828e+03
 3.61735106e+03 1.17844147e+03 1.59781695e+03 6.38499104e+02
 3.82852893e+02 2.18669884e+02 1.08143357e+02 8.47256502e+01
 3.51162305e+01 3.64456703e+01 7.95803569e+00 1.19706969e+01
 3.07608865e+00 5.86832503e+00 3.98588908e-01 1.26738607e+00
 1.36278327e+03 2.41556031e+04 6.64745046e+02 9.84698506e+03
 3.00958994e+02 3.65694602e+03 3.14039689e+02 3.85669297e+03
 6.16254203e+01 5.03714277e+02 7.33841368e+00 3.52360429e+01
 2.02316780e+01 1.25176923e+02 7.73731299e-01 2.11700605e+00
 2.81208463e+00 1.06235551e+01 2.23412750e-01 4.48094213e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98297095708865
cond(S) = 102381.40892335957
E1 = -729.3775380401311  E_coul = 203.12214580103227
init E= -526.255392239099
    CPU time for initialize scf      7.41 sec, wall time      0.36 sec
  HOMO = -0.556933209390067  LUMO = 1.03248474252758
  mo_energy =
[-1.18331382e+02 -1.22077507e+01 -9.45155792e+00 -9.45155792e+00
 -9.45155792e+00 -1.22562160e+00 -5.56933209e-01 -5.56933209e-01
 -5.56933209e-01  1.03248474e+00  1.03248474e+00  1.03248474e+00
  7.34331732e+00  7.34331732e+00  7.34331732e+00  9.57074257e+00
  3.35302757e+01  3.35302757e+01  3.35302757e+01  1.02796825e+02
  1.29147076e+02  1.29147076e+02  1.29147076e+02  4.83546125e+02
  4.83546125e+02  4.83546125e+02  5.84001077e+02  1.33543531e+03
  1.33543531e+03  1.33543531e+03  2.65272167e+03  3.02974069e+03
  3.02974069e+03  3.02974069e+03  6.65029194e+03  6.65029194e+03
  6.65029194e+03  9.05853385e+03  2.54143372e+04  7.61569218e+04]
E1 = -727.9587057781978  E_coul = 201.25809762232416
cycle= 1 E= -526.700608155874  delta_E= -0.445  |g|= 0.185  |ddm|= 0.417
    CPU time for cycle= 1      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.542457
diis-c [-0.29425937  1.        ]
  HOMO = -0.581524328754505  LUMO = 1.01637728601264
  mo_energy =
[-1.18627877e+02 -1.23322728e+01 -9.58663395e+00 -9.58663395e+00
 -9.58663395e+00 -1.25702525e+00 -5.81524329e-01 -5.81524329e-01
 -5.81524329e-01  1.01637729e+00  1.01637729e+00  1.01637729e+00
  7.26688687e+00  7.26688687e+00  7.26688687e+00  9.48132462e+00
  3.33892687e+01  3.33892687e+01  3.33892687e+01  1.02589911e+02
  1.28931206e+02  1.28931206e+02  1.28931206e+02  4.83250902e+02
  4.83250902e+02  4.83250902e+02  5.83667636e+02  1.33508306e+03
  1.33508306e+03  1.33508306e+03  2.65223419e+03  3.02932183e+03
  3.02932183e+03  3.02932183e+03  6.64975935e+03  6.64975935e+03
  6.64975935e+03  9.05792566e+03  2.54136348e+04  7.61561292e+04]
E1 = -728.4287895477015  E_coul = 201.7275734500508
cycle= 2 E= -526.701216097651  delta_E= -0.000608  |g|= 0.0339  |ddm|= 0.0393
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0676665
diis-c [-0.00270302  0.07425343  0.92574657]
  HOMO = -0.574705708695294  LUMO = 1.02152119514331
  mo_energy =
[-1.18568491e+02 -1.23010390e+01 -9.55408564e+00 -9.55408564e+00
 -9.55408564e+00 -1.24837320e+00 -5.74705709e-01 -5.74705709e-01
 -5.74705709e-01  1.02152120e+00  1.02152120e+00  1.02152120e+00
  7.28560305e+00  7.28560305e+00  7.28560305e+00  9.50568470e+00
  3.34224431e+01  3.34224431e+01  3.34224431e+01  1.02637887e+02
  1.28979299e+02  1.28979299e+02  1.28979299e+02  4.83309531e+02
  4.83309531e+02  4.83309531e+02  5.83728508e+02  1.33514554e+03
  1.33514554e+03  1.33514554e+03  2.65229970e+03  3.02938638e+03
  3.02938638e+03  3.02938638e+03  6.64982546e+03  6.64982546e+03
  6.64982546e+03  9.05799247e+03  2.54137021e+04  7.61561967e+04]
E1 = -728.3221667551304  E_coul = 201.62091485873825
cycle= 3 E= -526.701251896392  delta_E= -3.58e-05  |g|= 0.00487  |ddm|= 0.0104
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.010592
diis-c [-5.01952390e-07 -1.16393900e-03  1.30511136e-01  8.70652803e-01]
  HOMO = -0.57563687392699  LUMO = 1.0208300331509
  mo_energy =
[-1.18576126e+02 -1.23051203e+01 -9.55844724e+00 -9.55844724e+00
 -9.55844724e+00 -1.24949926e+00 -5.75636874e-01 -5.75636874e-01
 -5.75636874e-01  1.02083003e+00  1.02083003e+00  1.02083003e+00
  7.28307205e+00  7.28307205e+00  7.28307205e+00  9.50259082e+00
  3.34180290e+01  3.34180290e+01  3.34180290e+01  1.02631720e+02
  1.28973060e+02  1.28973060e+02  1.28973060e+02  4.83301993e+02
  4.83301993e+02  4.83301993e+02  5.83720649e+02  1.33513747e+03
  1.33513747e+03  1.33513747e+03  2.65229106e+03  3.02937797e+03
  3.02937797e+03  3.02937797e+03  6.64981669e+03  6.64981669e+03
  6.64981669e+03  9.05798350e+03  2.54136930e+04  7.61561875e+04]
E1 = -728.3365792567396  E_coul = 201.63532649643048
cycle= 4 E= -526.701252760309  delta_E= -8.64e-07  |g|= 6.42e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000134132
diis-c [-1.40729583e-09  6.66610730e-05 -9.17419575e-03 -7.27026707e-02
  1.08181021e+00]
  HOMO = -0.575624729015064  LUMO = 1.02083904577256
  mo_energy =
[-1.18576134e+02 -1.23050921e+01 -9.55843155e+00 -9.55843155e+00
 -9.55843155e+00 -1.24947967e+00 -5.75624729e-01 -5.75624729e-01
 -5.75624729e-01  1.02083905e+00  1.02083905e+00  1.02083905e+00
  7.28309214e+00  7.28309214e+00  7.28309214e+00  9.50262657e+00
  3.34180434e+01  3.34180434e+01  3.34180434e+01  1.02631729e+02
  1.28973065e+02  1.28973065e+02  1.28973065e+02  4.83301986e+02
  4.83301986e+02  4.83301986e+02  5.83720634e+02  1.33513746e+03
  1.33513746e+03  1.33513746e+03  2.65229102e+03  3.02937794e+03
  3.02937794e+03  3.02937794e+03  6.64981665e+03  6.64981665e+03
  6.64981665e+03  9.05798346e+03  2.54136929e+04  7.61561874e+04]
E1 = -728.3365849787292  E_coul = 201.63533221828956
cycle= 5 E= -526.70125276044  delta_E= -1.31e-10  |g|= 8.03e-06  |ddm|= 2.61e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3365849787292  E_coul = 201.63533221828956
  HOMO = -0.575628309496597  LUMO = 1.02083643089831
  mo_energy =
[-1.18576152e+02 -1.23051047e+01 -9.55844479e+00 -9.55844479e+00
 -9.55844479e+00 -1.24948406e+00 -5.75628309e-01 -5.75628309e-01
 -5.75628309e-01  1.02083643e+00  1.02083643e+00  1.02083643e+00
  7.28308345e+00  7.28308345e+00  7.28308345e+00  9.50261642e+00
  3.34180304e+01  3.34180304e+01  3.34180304e+01  1.02631713e+02
  1.28973049e+02  1.28973049e+02  1.28973049e+02  4.83301968e+02
  4.83301968e+02  4.83301968e+02  5.83720616e+02  1.33513744e+03
  1.33513744e+03  1.33513744e+03  2.65229100e+03  3.02937792e+03
  3.02937792e+03  3.02937792e+03  6.64981663e+03  6.64981663e+03
  6.64981663e+03  9.05798344e+03  2.54136929e+04  7.61561874e+04]
E1 = -728.3366248146388  E_coul = 201.63537205419487
Extra cycle  E= -526.701252760444  delta_E= -4.21e-12  |g|= 2.38e-06  |ddm|= 4.13e-06
    CPU time for scf_cycle      7.64 sec, wall time      0.54 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102381.40892335957
E1 = -728.3366248146388  E_coul = 201.63537205419487
init E= -526.701252760444
    CPU time for initialize scf     15.79 sec, wall time      0.76 sec
  HOMO = -0.575627580228125  LUMO = 1.02083696990508
  mo_energy =
[-1.18576147e+02 -1.23051017e+01 -9.55844177e+00 -9.55844177e+00
 -9.55844177e+00 -1.24948315e+00 -5.75627580e-01 -5.75627580e-01
 -5.75627580e-01  1.02083697e+00  1.02083697e+00  1.02083697e+00
  7.28308531e+00  7.28308531e+00  7.28308531e+00  9.50261873e+00
  3.34180334e+01  3.34180334e+01  3.34180334e+01  1.02631717e+02
  1.28973054e+02  1.28973054e+02  1.28973054e+02  4.83301973e+02
  4.83301973e+02  4.83301973e+02  5.83720621e+02  1.33513744e+03
  1.33513744e+03  1.33513744e+03  2.65229101e+03  3.02937793e+03
  3.02937793e+03  3.02937793e+03  6.64981663e+03  6.64981663e+03
  6.64981663e+03  9.05798344e+03  2.54136929e+04  7.61561874e+04]
E1 = -728.3366153219155  E_coul = 201.6353625614713
cycle= 1 E= -526.701252760444  delta_E= -3.41e-13  |g|= 6.14e-07  |ddm|= 9.49e-07
    CPU time for cycle= 1      0.05 sec, wall time      0.02 sec
E1 = -728.3366153219155  E_coul = 201.6353625614713
  HOMO = -0.575627741792086  LUMO = 1.02083684982669
  mo_energy =
[-1.18576149e+02 -1.23051024e+01 -9.55844249e+00 -9.55844249e+00
 -9.55844249e+00 -1.24948335e+00 -5.75627742e-01 -5.75627742e-01
 -5.75627742e-01  1.02083685e+00  1.02083685e+00  1.02083685e+00
  7.28308488e+00  7.28308488e+00  7.28308488e+00  9.50261820e+00
  3.34180327e+01  3.34180327e+01  3.34180327e+01  1.02631716e+02
  1.28973052e+02  1.28973052e+02  1.28973052e+02  4.83301972e+02
  4.83301972e+02  4.83301972e+02  5.83720620e+02  1.33513744e+03
  1.33513744e+03  1.33513744e+03  2.65229101e+03  3.02937793e+03
  3.02937793e+03  3.02937793e+03  6.64981663e+03  6.64981663e+03
  6.64981663e+03  9.05798344e+03  2.54136929e+04  7.61561874e+04]
E1 = -728.3366176427298  E_coul = 201.63536488228598
Extra cycle  E= -526.701252760444  delta_E= 3.41e-13  |g|= 1.55e-07  |ddm|= 2.23e-07
    CPU time for scf_cycle     15.93 sec, wall time      0.87 sec
exp = [2.61826560e+04 7.61752150e+03 3.61735106e+03 1.59781695e+03
 3.82852893e+02 1.08143357e+02 3.51162305e+01 7.95803569e+00
 3.07608865e+00 3.98588908e-01 1.36278327e+03 6.64745046e+02
 3.00958994e+02 3.14039689e+02 6.16254203e+01 7.33841368e+00
 2.02316780e+01 7.73731299e-01 2.81208463e+00 2.23412750e-01]
grad_E = [-1.51334922e-06  3.26329577e-06 -1.60464420e-06  6.75646894e-05
  2.45086335e-05 -7.79848507e-04 -1.86498380e-03  7.23780401e-04
 -6.22192491e-04 -4.48422450e-04 -5.09594496e-07  4.96998189e-06
  2.33874108e-05  2.01654100e-05  1.17456211e-05  9.52431495e-04
 -2.64541911e-04 -1.13680143e-03 -1.19563410e-03  5.23924662e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:57:03 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6560549        1
[INPUT] 0    0    [1    /1   ]  7617.52148033        1
[INPUT] 0    0    [1    /1   ]  3617.35107069        1
[INPUT] 0    0    [1    /1   ]  1597.81659034        1
[INPUT] 0    0    [1    /1   ]  382.852667593        1
[INPUT] 0    0    [1    /1   ]  108.148630747        1
[INPUT] 0    0    [1    /1   ]  35.1240699316        1
[INPUT] 0    0    [1    /1   ]  7.92961000536        1
[INPUT] 0    0    [1    /1   ]  3.07104828945        1
[INPUT] 0    0    [1    /1   ]  0.398414062485       1
[INPUT] 1    0    [1    /1   ]  1362.78327301        1
[INPUT] 1    0    [1    /1   ]  664.745018863        1
[INPUT] 1    0    [1    /1   ]  300.95886669         1
[INPUT] 1    0    [1    /1   ]  314.039579773        1
[INPUT] 1    0    [1    /1   ]  61.62549793          1
[INPUT] 1    0    [1    /1   ]  7.33964507047        1
[INPUT] 1    0    [1    /1   ]  20.2316137467        1
[INPUT] 1    0    [1    /1   ]  0.774138290546       1
[INPUT] 1    0    [1    /1   ]  2.80904973504        1
[INPUT] 1    0    [1    /1   ]  0.223857016556       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.656054940308, 1.0]], [0, [7617.5214803322715, 1.0]], [0, [3617.3510706897873, 1.0]], [0, [1597.8165903380811, 1.0]], [0, [382.85266759320365, 1.0]], [0, [108.14863074663587, 1.0]], [0, [35.124069931567945, 1.0]], [0, [7.929610005364342, 1.0]], [0, [3.0710482894509763, 1.0]], [0, [0.398414062485171, 1.0]], [1, [1362.7832730050902, 1.0]], [1, [664.745018862558, 1.0]], [1, [300.95886668990516, 1.0]], [1, [314.03957977346766, 1.0]], [1, [61.62549792999669, 1.0]], [1, [7.339645070465656, 1.0]], [1, [20.23161374668615, 1.0]], [1, [0.7741382905458318, 1.0]], [1, [2.8090497350359693, 1.0]], [1, [0.22385701655569906, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65605494]
bas 1, expnt(s) = [7617.52148033]
bas 2, expnt(s) = [3617.35107069]
bas 3, expnt(s) = [1597.81659034]
bas 4, expnt(s) = [382.85266759]
bas 5, expnt(s) = [108.14863075]
bas 6, expnt(s) = [35.12406993]
bas 7, expnt(s) = [7.92961001]
bas 8, expnt(s) = [3.07104829]
bas 9, expnt(s) = [0.39841406]
bas 10, expnt(s) = [1362.78327301]
bas 11, expnt(s) = [664.74501886]
bas 12, expnt(s) = [300.95886669]
bas 13, expnt(s) = [314.03957977]
bas 14, expnt(s) = [61.62549793]
bas 15, expnt(s) = [7.33964507]
bas 16, expnt(s) = [20.23161375]
bas 17, expnt(s) = [0.77413829]
bas 18, expnt(s) = [2.80904974]
bas 19, expnt(s) = [0.22385702]
CPU time:       675.90
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826561e+04 5.20026290e+03 7.61752148e+03 2.06003828e+03
 3.61735107e+03 1.17844148e+03 1.59781659e+03 6.38498996e+02
 3.82852668e+02 2.18669787e+02 1.08148631e+02 8.47287488e+01
 3.51240699e+01 3.64517723e+01 7.92961001e+00 1.19386136e+01
 3.07104829e+00 5.86111184e+00 3.98414062e-01 1.26696909e+00
 1.36278327e+03 2.41556031e+04 6.64745019e+02 9.84698457e+03
 3.00958867e+02 3.65694409e+03 3.14039580e+02 3.85669129e+03
 6.16254979e+01 5.03715070e+02 7.33964507e+00 3.52434339e+01
 2.02316137e+01 1.25176426e+02 7.74138291e-01 2.11839810e+00
 2.80904974e+00 1.06092254e+01 2.23857017e-01 4.49208310e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98294706263526
cond(S) = 102370.18694104672
E1 = -729.3765248944528  E_coul = 203.1214402439175
init E= -526.255084650535
    CPU time for initialize scf      7.26 sec, wall time      0.35 sec
  HOMO = -0.556944032531793  LUMO = 1.03451145992637
  mo_energy =
[-1.18331451e+02 -1.22078047e+01 -9.45161598e+00 -9.45161598e+00
 -9.45161598e+00 -1.22565133e+00 -5.56944033e-01 -5.56944033e-01
 -5.56944033e-01  1.03451146e+00  1.03451146e+00  1.03451146e+00
  7.34180235e+00  7.34180235e+00  7.34180235e+00  9.52777552e+00
  3.35249990e+01  3.35249990e+01  3.35249990e+01  1.02677757e+02
  1.29143085e+02  1.29143085e+02  1.29143085e+02  4.83543265e+02
  4.83543265e+02  4.83543265e+02  5.83912637e+02  1.33543265e+03
  1.33543265e+03  1.33543265e+03  2.65265503e+03  3.02973791e+03
  3.02973791e+03  3.02973791e+03  6.65028913e+03  6.65028913e+03
  6.65028913e+03  9.05847431e+03  2.54142809e+04  7.61568693e+04]
E1 = -727.963416821733  E_coul = 201.26278310945105
cycle= 1 E= -526.700633712282  delta_E= -0.446  |g|= 0.185  |ddm|= 0.418
    CPU time for cycle= 1      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.542328
diis-c [-0.29411978  1.        ]
  HOMO = -0.581342768200204  LUMO = 1.0185272660196
  mo_energy =
[-1.18627591e+02 -1.23319544e+01 -9.58631446e+00 -9.58631446e+00
 -9.58631446e+00 -1.25680239e+00 -5.81342768e-01 -5.81342768e-01
 -5.81342768e-01  1.01852727e+00  1.01852727e+00  1.01852727e+00
  7.26573334e+00  7.26573334e+00  7.26573334e+00  9.43889645e+00
  3.33843563e+01  3.33843563e+01  3.33843563e+01  1.02471270e+02
  1.28927580e+02  1.28927580e+02  1.28927580e+02  4.83248414e+02
  4.83248414e+02  4.83248414e+02  5.83579543e+02  1.33508077e+03
  1.33508077e+03  1.33508077e+03  2.65216789e+03  3.02931940e+03
  3.02931940e+03  3.02931940e+03  6.64975688e+03  6.64975688e+03
  6.64975688e+03  9.05786644e+03  2.54135788e+04  7.61560770e+04]
E1 = -728.4323987715732  E_coul = 201.73115895833288
cycle= 2 E= -526.70123981324  delta_E= -0.000606  |g|= 0.0339  |ddm|= 0.0392
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0675548
diis-c [-0.00269563  0.07412746  0.92587254]
  HOMO = -0.574544245442055  LUMO = 1.02366165872809
  mo_energy =
[-1.18568304e+02 -1.23007931e+01 -9.55383966e+00 -9.55383966e+00
 -9.55383966e+00 -1.24817731e+00 -5.74544245e-01 -5.74544245e-01
 -5.74544245e-01  1.02366166e+00  1.02366166e+00  1.02366166e+00
  7.28439437e+00  7.28439437e+00  7.28439437e+00  9.46315587e+00
  3.34174582e+01  3.34174582e+01  3.34174582e+01  1.02519158e+02
  1.28975585e+02  1.28975585e+02  1.28975585e+02  4.83306945e+02
  4.83306945e+02  4.83306945e+02  5.83640316e+02  1.33514314e+03
  1.33514314e+03  1.33514314e+03  2.65223330e+03  3.02938385e+03
  3.02938385e+03  3.02938385e+03  6.64982288e+03  6.64982288e+03
  6.64982288e+03  9.05793315e+03  2.54136460e+04  7.61561444e+04]
E1 = -728.3260557480319  E_coul = 201.6247802924913
cycle= 3 E= -526.701275455541  delta_E= -3.56e-05  |g|= 0.00487  |ddm|= 0.0104
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0105801
diis-c [-5.02957136e-07 -1.16464215e-03  1.30562912e-01  8.70601730e-01]
  HOMO = -0.575472447228162  LUMO = 1.02297201853958
  mo_energy =
[-1.18575929e+02 -1.23048668e+01 -9.55819367e+00 -9.55819367e+00
 -9.55819367e+00 -1.24929923e+00 -5.75472447e-01 -5.75472447e-01
 -5.75472447e-01  1.02297202e+00  1.02297202e+00  1.02297202e+00
  7.28187021e+00  7.28187021e+00  7.28187021e+00  9.46007455e+00
  3.34130518e+01  3.34130518e+01  3.34130518e+01  1.02513000e+02
  1.28969355e+02  1.28969355e+02  1.28969355e+02  4.83299417e+02
  4.83299417e+02  4.83299417e+02  5.83632468e+02  1.33513508e+03
  1.33513508e+03  1.33513508e+03  2.65222467e+03  3.02937544e+03
  3.02937544e+03  3.02937544e+03  6.64981412e+03  6.64981412e+03
  6.64981412e+03  9.05792419e+03  2.54136368e+04  7.61561351e+04]
E1 = -728.340439749974  E_coul = 201.639163433366
cycle= 4 E= -526.701276316608  delta_E= -8.61e-07  |g|= 6.44e-05  |ddm|= 0.00132
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000134187
diis-c [-1.41268733e-09  6.67477773e-05 -9.18870045e-03 -7.27828426e-02
  1.08190480e+00]
  HOMO = -0.575460180310784  LUMO = 1.02298113283836
  mo_energy =
[-1.18575936e+02 -1.23048384e+01 -9.55817777e+00 -9.55817777e+00
 -9.55817777e+00 -1.24927946e+00 -5.75460180e-01 -5.75460180e-01
 -5.75460180e-01  1.02298113e+00  1.02298113e+00  1.02298113e+00
  7.28189051e+00  7.28189051e+00  7.28189051e+00  9.46011060e+00
  3.34130664e+01  3.34130664e+01  3.34130664e+01  1.02513010e+02
  1.28969360e+02  1.28969360e+02  1.28969360e+02  4.83299410e+02
  4.83299410e+02  4.83299410e+02  5.83632453e+02  1.33513507e+03
  1.33513507e+03  1.33513507e+03  2.65222463e+03  3.02937542e+03
  3.02937542e+03  3.02937542e+03  6.64981408e+03  6.64981408e+03
  6.64981408e+03  9.05792414e+03  2.54136368e+04  7.61561351e+04]
E1 = -728.3404453013308  E_coul = 201.63916898459087
cycle= 5 E= -526.70127631674  delta_E= -1.32e-10  |g|= 8.05e-06  |ddm|= 2.65e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3404453013308  E_coul = 201.63916898459087
  HOMO = -0.57546376361219  LUMO = 1.02297851361269
  mo_energy =
[-1.18575954e+02 -1.23048510e+01 -9.55819103e+00 -9.55819103e+00
 -9.55819103e+00 -1.24928386e+00 -5.75463764e-01 -5.75463764e-01
 -5.75463764e-01  1.02297851e+00  1.02297851e+00  1.02297851e+00
  7.28188181e+00  7.28188181e+00  7.28188181e+00  9.46010045e+00
  3.34130533e+01  3.34130533e+01  3.34130533e+01  1.02512994e+02
  1.28969344e+02  1.28969344e+02  1.28969344e+02  4.83299393e+02
  4.83299393e+02  4.83299393e+02  5.83632435e+02  1.33513505e+03
  1.33513505e+03  1.33513505e+03  2.65222461e+03  3.02937540e+03
  3.02937540e+03  3.02937540e+03  6.64981406e+03  6.64981406e+03
  6.64981406e+03  9.05792413e+03  2.54136368e+04  7.61561351e+04]
E1 = -728.3404851820851  E_coul = 201.63920886534086
Extra cycle  E= -526.701276316744  delta_E= -4.32e-12  |g|= 2.39e-06  |ddm|= 4.13e-06
    CPU time for scf_cycle      7.48 sec, wall time      0.53 sec
exp = [2.61826561e+04 7.61752148e+03 3.61735107e+03 1.59781659e+03
 3.82852668e+02 1.08148631e+02 3.51240699e+01 7.92961001e+00
 3.07104829e+00 3.98414062e-01 1.36278327e+03 6.64745019e+02
 3.00958867e+02 3.14039580e+02 6.16254979e+01 7.33964507e+00
 2.02316137e+01 7.74138291e-01 2.80904974e+00 2.23857017e-01]
E = -526.7012763167443
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:57:03 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6560549        1
[INPUT] 0    0    [1    /1   ]  7617.52148033        1
[INPUT] 0    0    [1    /1   ]  3617.35107069        1
[INPUT] 0    0    [1    /1   ]  1597.81659034        1
[INPUT] 0    0    [1    /1   ]  382.852667593        1
[INPUT] 0    0    [1    /1   ]  108.148630747        1
[INPUT] 0    0    [1    /1   ]  35.1240699316        1
[INPUT] 0    0    [1    /1   ]  7.92961000536        1
[INPUT] 0    0    [1    /1   ]  3.07104828945        1
[INPUT] 0    0    [1    /1   ]  0.398414062485       1
[INPUT] 1    0    [1    /1   ]  1362.78327301        1
[INPUT] 1    0    [1    /1   ]  664.745018863        1
[INPUT] 1    0    [1    /1   ]  300.95886669         1
[INPUT] 1    0    [1    /1   ]  314.039579773        1
[INPUT] 1    0    [1    /1   ]  61.62549793          1
[INPUT] 1    0    [1    /1   ]  7.33964507047        1
[INPUT] 1    0    [1    /1   ]  20.2316137467        1
[INPUT] 1    0    [1    /1   ]  0.774138290546       1
[INPUT] 1    0    [1    /1   ]  2.80904973504        1
[INPUT] 1    0    [1    /1   ]  0.223857016556       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.656054940308, 1.0]], [0, [7617.5214803322715, 1.0]], [0, [3617.3510706897873, 1.0]], [0, [1597.8165903380811, 1.0]], [0, [382.85266759320365, 1.0]], [0, [108.14863074663587, 1.0]], [0, [35.124069931567945, 1.0]], [0, [7.929610005364342, 1.0]], [0, [3.0710482894509763, 1.0]], [0, [0.398414062485171, 1.0]], [1, [1362.7832730050902, 1.0]], [1, [664.745018862558, 1.0]], [1, [300.95886668990516, 1.0]], [1, [314.03957977346766, 1.0]], [1, [61.62549792999669, 1.0]], [1, [7.339645070465656, 1.0]], [1, [20.23161374668615, 1.0]], [1, [0.7741382905458318, 1.0]], [1, [2.8090497350359693, 1.0]], [1, [0.22385701655569906, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65605494]
bas 1, expnt(s) = [7617.52148033]
bas 2, expnt(s) = [3617.35107069]
bas 3, expnt(s) = [1597.81659034]
bas 4, expnt(s) = [382.85266759]
bas 5, expnt(s) = [108.14863075]
bas 6, expnt(s) = [35.12406993]
bas 7, expnt(s) = [7.92961001]
bas 8, expnt(s) = [3.07104829]
bas 9, expnt(s) = [0.39841406]
bas 10, expnt(s) = [1362.78327301]
bas 11, expnt(s) = [664.74501886]
bas 12, expnt(s) = [300.95886669]
bas 13, expnt(s) = [314.03957977]
bas 14, expnt(s) = [61.62549793]
bas 15, expnt(s) = [7.33964507]
bas 16, expnt(s) = [20.23161375]
bas 17, expnt(s) = [0.77413829]
bas 18, expnt(s) = [2.80904974]
bas 19, expnt(s) = [0.22385702]
CPU time:       683.47
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826561e+04 5.20026290e+03 7.61752148e+03 2.06003828e+03
 3.61735107e+03 1.17844148e+03 1.59781659e+03 6.38498996e+02
 3.82852668e+02 2.18669787e+02 1.08148631e+02 8.47287488e+01
 3.51240699e+01 3.64517723e+01 7.92961001e+00 1.19386136e+01
 3.07104829e+00 5.86111184e+00 3.98414062e-01 1.26696909e+00
 1.36278327e+03 2.41556031e+04 6.64745019e+02 9.84698457e+03
 3.00958867e+02 3.65694409e+03 3.14039580e+02 3.85669129e+03
 6.16254979e+01 5.03715070e+02 7.33964507e+00 3.52434339e+01
 2.02316137e+01 1.25176426e+02 7.74138291e-01 2.11839810e+00
 2.80904974e+00 1.06092254e+01 2.23857017e-01 4.49208310e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98294706263526
cond(S) = 102370.18694104672
E1 = -729.3765248944528  E_coul = 203.1214402439175
init E= -526.255084650535
    CPU time for initialize scf      7.42 sec, wall time      0.36 sec
  HOMO = -0.556944032531793  LUMO = 1.03451145992637
  mo_energy =
[-1.18331451e+02 -1.22078047e+01 -9.45161598e+00 -9.45161598e+00
 -9.45161598e+00 -1.22565133e+00 -5.56944033e-01 -5.56944033e-01
 -5.56944033e-01  1.03451146e+00  1.03451146e+00  1.03451146e+00
  7.34180235e+00  7.34180235e+00  7.34180235e+00  9.52777552e+00
  3.35249990e+01  3.35249990e+01  3.35249990e+01  1.02677757e+02
  1.29143085e+02  1.29143085e+02  1.29143085e+02  4.83543265e+02
  4.83543265e+02  4.83543265e+02  5.83912637e+02  1.33543265e+03
  1.33543265e+03  1.33543265e+03  2.65265503e+03  3.02973791e+03
  3.02973791e+03  3.02973791e+03  6.65028913e+03  6.65028913e+03
  6.65028913e+03  9.05847431e+03  2.54142809e+04  7.61568693e+04]
E1 = -727.963416821733  E_coul = 201.26278310945105
cycle= 1 E= -526.700633712282  delta_E= -0.446  |g|= 0.185  |ddm|= 0.418
    CPU time for cycle= 1      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.542328
diis-c [-0.29411978  1.        ]
  HOMO = -0.581342768200204  LUMO = 1.0185272660196
  mo_energy =
[-1.18627591e+02 -1.23319544e+01 -9.58631446e+00 -9.58631446e+00
 -9.58631446e+00 -1.25680239e+00 -5.81342768e-01 -5.81342768e-01
 -5.81342768e-01  1.01852727e+00  1.01852727e+00  1.01852727e+00
  7.26573334e+00  7.26573334e+00  7.26573334e+00  9.43889645e+00
  3.33843563e+01  3.33843563e+01  3.33843563e+01  1.02471270e+02
  1.28927580e+02  1.28927580e+02  1.28927580e+02  4.83248414e+02
  4.83248414e+02  4.83248414e+02  5.83579543e+02  1.33508077e+03
  1.33508077e+03  1.33508077e+03  2.65216789e+03  3.02931940e+03
  3.02931940e+03  3.02931940e+03  6.64975688e+03  6.64975688e+03
  6.64975688e+03  9.05786644e+03  2.54135788e+04  7.61560770e+04]
E1 = -728.4323987715732  E_coul = 201.73115895833288
cycle= 2 E= -526.70123981324  delta_E= -0.000606  |g|= 0.0339  |ddm|= 0.0392
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0675548
diis-c [-0.00269563  0.07412746  0.92587254]
  HOMO = -0.574544245442055  LUMO = 1.02366165872809
  mo_energy =
[-1.18568304e+02 -1.23007931e+01 -9.55383966e+00 -9.55383966e+00
 -9.55383966e+00 -1.24817731e+00 -5.74544245e-01 -5.74544245e-01
 -5.74544245e-01  1.02366166e+00  1.02366166e+00  1.02366166e+00
  7.28439437e+00  7.28439437e+00  7.28439437e+00  9.46315587e+00
  3.34174582e+01  3.34174582e+01  3.34174582e+01  1.02519158e+02
  1.28975585e+02  1.28975585e+02  1.28975585e+02  4.83306945e+02
  4.83306945e+02  4.83306945e+02  5.83640316e+02  1.33514314e+03
  1.33514314e+03  1.33514314e+03  2.65223330e+03  3.02938385e+03
  3.02938385e+03  3.02938385e+03  6.64982288e+03  6.64982288e+03
  6.64982288e+03  9.05793315e+03  2.54136460e+04  7.61561444e+04]
E1 = -728.3260557480319  E_coul = 201.6247802924913
cycle= 3 E= -526.701275455541  delta_E= -3.56e-05  |g|= 0.00487  |ddm|= 0.0104
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0105801
diis-c [-5.02957136e-07 -1.16464215e-03  1.30562912e-01  8.70601730e-01]
  HOMO = -0.575472447228162  LUMO = 1.02297201853958
  mo_energy =
[-1.18575929e+02 -1.23048668e+01 -9.55819367e+00 -9.55819367e+00
 -9.55819367e+00 -1.24929923e+00 -5.75472447e-01 -5.75472447e-01
 -5.75472447e-01  1.02297202e+00  1.02297202e+00  1.02297202e+00
  7.28187021e+00  7.28187021e+00  7.28187021e+00  9.46007455e+00
  3.34130518e+01  3.34130518e+01  3.34130518e+01  1.02513000e+02
  1.28969355e+02  1.28969355e+02  1.28969355e+02  4.83299417e+02
  4.83299417e+02  4.83299417e+02  5.83632468e+02  1.33513508e+03
  1.33513508e+03  1.33513508e+03  2.65222467e+03  3.02937544e+03
  3.02937544e+03  3.02937544e+03  6.64981412e+03  6.64981412e+03
  6.64981412e+03  9.05792419e+03  2.54136368e+04  7.61561351e+04]
E1 = -728.340439749974  E_coul = 201.639163433366
cycle= 4 E= -526.701276316608  delta_E= -8.61e-07  |g|= 6.44e-05  |ddm|= 0.00132
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000134187
diis-c [-1.41268733e-09  6.67477773e-05 -9.18870045e-03 -7.27828426e-02
  1.08190480e+00]
  HOMO = -0.575460180310784  LUMO = 1.02298113283836
  mo_energy =
[-1.18575936e+02 -1.23048384e+01 -9.55817777e+00 -9.55817777e+00
 -9.55817777e+00 -1.24927946e+00 -5.75460180e-01 -5.75460180e-01
 -5.75460180e-01  1.02298113e+00  1.02298113e+00  1.02298113e+00
  7.28189051e+00  7.28189051e+00  7.28189051e+00  9.46011060e+00
  3.34130664e+01  3.34130664e+01  3.34130664e+01  1.02513010e+02
  1.28969360e+02  1.28969360e+02  1.28969360e+02  4.83299410e+02
  4.83299410e+02  4.83299410e+02  5.83632453e+02  1.33513507e+03
  1.33513507e+03  1.33513507e+03  2.65222463e+03  3.02937542e+03
  3.02937542e+03  3.02937542e+03  6.64981408e+03  6.64981408e+03
  6.64981408e+03  9.05792414e+03  2.54136368e+04  7.61561351e+04]
E1 = -728.3404453013308  E_coul = 201.63916898459087
cycle= 5 E= -526.70127631674  delta_E= -1.32e-10  |g|= 8.05e-06  |ddm|= 2.65e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3404453013308  E_coul = 201.63916898459087
  HOMO = -0.57546376361219  LUMO = 1.02297851361269
  mo_energy =
[-1.18575954e+02 -1.23048510e+01 -9.55819103e+00 -9.55819103e+00
 -9.55819103e+00 -1.24928386e+00 -5.75463764e-01 -5.75463764e-01
 -5.75463764e-01  1.02297851e+00  1.02297851e+00  1.02297851e+00
  7.28188181e+00  7.28188181e+00  7.28188181e+00  9.46010045e+00
  3.34130533e+01  3.34130533e+01  3.34130533e+01  1.02512994e+02
  1.28969344e+02  1.28969344e+02  1.28969344e+02  4.83299393e+02
  4.83299393e+02  4.83299393e+02  5.83632435e+02  1.33513505e+03
  1.33513505e+03  1.33513505e+03  2.65222461e+03  3.02937540e+03
  3.02937540e+03  3.02937540e+03  6.64981406e+03  6.64981406e+03
  6.64981406e+03  9.05792413e+03  2.54136368e+04  7.61561351e+04]
E1 = -728.3404851820851  E_coul = 201.63920886534086
Extra cycle  E= -526.701276316744  delta_E= -4.32e-12  |g|= 2.39e-06  |ddm|= 4.13e-06
    CPU time for scf_cycle      7.64 sec, wall time      0.54 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102370.18694104672
E1 = -728.3404851820851  E_coul = 201.63920886534086
init E= -526.701276316744
    CPU time for initialize scf     15.75 sec, wall time      0.77 sec
  HOMO = -0.575463034057338  LUMO = 1.0229790533739
  mo_energy =
[-1.18575950e+02 -1.23048481e+01 -9.55818801e+00 -9.55818801e+00
 -9.55818801e+00 -1.24928294e+00 -5.75463034e-01 -5.75463034e-01
 -5.75463034e-01  1.02297905e+00  1.02297905e+00  1.02297905e+00
  7.28188367e+00  7.28188367e+00  7.28188367e+00  9.46010276e+00
  3.34130564e+01  3.34130564e+01  3.34130564e+01  1.02512998e+02
  1.28969348e+02  1.28969348e+02  1.28969348e+02  4.83299397e+02
  4.83299397e+02  4.83299397e+02  5.83632440e+02  1.33513505e+03
  1.33513505e+03  1.33513505e+03  2.65222462e+03  3.02937540e+03
  3.02937540e+03  3.02937540e+03  6.64981407e+03  6.64981407e+03
  6.64981407e+03  9.05792413e+03  2.54136368e+04  7.61561351e+04]
E1 = -728.3404756834922  E_coul = 201.63919936674776
cycle= 1 E= -526.701276316744  delta_E= -1.14e-13  |g|= 6.15e-07  |ddm|= 9.5e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3404756834922  E_coul = 201.63919936674776
  HOMO = -0.575463195574175  LUMO = 1.02297893320931
  mo_energy =
[-1.18575951e+02 -1.23048488e+01 -9.55818873e+00 -9.55818873e+00
 -9.55818873e+00 -1.24928314e+00 -5.75463196e-01 -5.75463196e-01
 -5.75463196e-01  1.02297893e+00  1.02297893e+00  1.02297893e+00
  7.28188324e+00  7.28188324e+00  7.28188324e+00  9.46010223e+00
  3.34130556e+01  3.34130556e+01  3.34130556e+01  1.02512997e+02
  1.28969347e+02  1.28969347e+02  1.28969347e+02  4.83299396e+02
  4.83299396e+02  4.83299396e+02  5.83632439e+02  1.33513505e+03
  1.33513505e+03  1.33513505e+03  2.65222461e+03  3.02937540e+03
  3.02937540e+03  3.02937540e+03  6.64981407e+03  6.64981407e+03
  6.64981407e+03  9.05792413e+03  2.54136368e+04  7.61561351e+04]
E1 = -728.3404780050395  E_coul = 201.639201688295
Extra cycle  E= -526.701276316744  delta_E= -1.14e-13  |g|= 1.55e-07  |ddm|= 2.23e-07
    CPU time for scf_cycle     15.86 sec, wall time      0.88 sec
exp = [2.61826561e+04 7.61752148e+03 3.61735107e+03 1.59781659e+03
 3.82852668e+02 1.08148631e+02 3.51240699e+01 7.92961001e+00
 3.07104829e+00 3.98414062e-01 1.36278327e+03 6.64745019e+02
 3.00958867e+02 3.14039580e+02 6.16254979e+01 7.33964507e+00
 2.02316137e+01 7.74138291e-01 2.80904974e+00 2.23857017e-01]
grad_E = [-1.51328698e-06  3.26276062e-06 -1.60464734e-06  6.75423109e-05
  2.54864557e-05 -7.89032974e-04 -1.84394273e-03  4.46261569e-04
 -7.52967765e-05 -1.84785116e-03 -5.10861808e-07  4.95256164e-06
  2.32807125e-05  2.00739100e-05  2.54730808e-05  1.52451991e-03
 -4.03393423e-04 -2.92678807e-03 -2.02801471e-03  1.37939536e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:57:08 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6560806        1
[INPUT] 0    0    [1    /1   ]  7617.52142508        1
[INPUT] 0    0    [1    /1   ]  3617.35109801        1
[INPUT] 0    0    [1    /1   ]  1597.81544829        1
[INPUT] 0    0    [1    /1   ]  382.852140466        1
[INPUT] 0    0    [1    /1   ]  108.163205765        1
[INPUT] 0    0    [1    /1   ]  35.1531727347        1
[INPUT] 0    0    [1    /1   ]  7.88146608688        1
[INPUT] 0    0    [1    /1   ]  3.06243252328        1
[INPUT] 0    0    [1    /1   ]  0.398183438229       1
[INPUT] 1    0    [1    /1   ]  1362.78328161        1
[INPUT] 1    0    [1    /1   ]  664.744934032        1
[INPUT] 1    0    [1    /1   ]  300.958466734        1
[INPUT] 1    0    [1    /1   ]  314.039234933        1
[INPUT] 1    0    [1    /1   ]  61.6257214934        1
[INPUT] 1    0    [1    /1   ]  7.34074864204        1
[INPUT] 1    0    [1    /1   ]  20.2318236555        1
[INPUT] 1    0    [1    /1   ]  0.774619768128       1
[INPUT] 1    0    [1    /1   ]  2.80471530533        1
[INPUT] 1    0    [1    /1   ]  0.224422386641       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.65608060137, 1.0]], [0, [7617.5214250846475, 1.0]], [0, [3617.3510980147803, 1.0]], [0, [1597.8154482885939, 1.0]], [0, [382.85214046623435, 1.0]], [0, [108.16320576453472, 1.0]], [0, [35.15317273472529, 1.0]], [0, [7.881466086875332, 1.0]], [0, [3.062432523280826, 1.0]], [0, [0.39818343822873886, 1.0]], [1, [1362.7832816080988, 1.0]], [1, [664.7449340322291, 1.0]], [1, [300.958466734286, 1.0]], [1, [314.03923493324635, 1.0]], [1, [61.62572149339588, 1.0]], [1, [7.340748642039802, 1.0]], [1, [20.231823655458133, 1.0]], [1, [0.7746197681283807, 1.0]], [1, [2.8047153053274823, 1.0]], [1, [0.2244223866414009, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.6560806]
bas 1, expnt(s) = [7617.52142508]
bas 2, expnt(s) = [3617.35109801]
bas 3, expnt(s) = [1597.81544829]
bas 4, expnt(s) = [382.85214047]
bas 5, expnt(s) = [108.16320576]
bas 6, expnt(s) = [35.15317273]
bas 7, expnt(s) = [7.88146609]
bas 8, expnt(s) = [3.06243252]
bas 9, expnt(s) = [0.39818344]
bas 10, expnt(s) = [1362.78328161]
bas 11, expnt(s) = [664.74493403]
bas 12, expnt(s) = [300.95846673]
bas 13, expnt(s) = [314.03923493]
bas 14, expnt(s) = [61.62572149]
bas 15, expnt(s) = [7.34074864]
bas 16, expnt(s) = [20.23182366]
bas 17, expnt(s) = [0.77461977]
bas 18, expnt(s) = [2.80471531]
bas 19, expnt(s) = [0.22442239]
CPU time:       711.71
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826561e+04 5.20026290e+03 7.61752143e+03 2.06003827e+03
 3.61735110e+03 1.17844148e+03 1.59781545e+03 6.38498654e+02
 3.82852140e+02 2.18669561e+02 1.08163206e+02 8.47373127e+01
 3.51531727e+01 3.64744222e+01 7.88146609e+00 1.18842090e+01
 3.06243252e+00 5.84877508e+00 3.98183438e-01 1.26641900e+00
 1.36278328e+03 2.41556033e+04 6.64744934e+02 9.84698299e+03
 3.00958467e+02 3.65693802e+03 3.14039235e+02 3.85668600e+03
 6.16257215e+01 5.03717354e+02 7.34074864e+00 3.52500579e+01
 2.02318237e+01 1.25178050e+02 7.74619768e-01 2.12004516e+00
 2.80471531e+00 1.05887665e+01 2.24422387e-01 4.50626900e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98291721747345
cond(S) = 102352.04081052111
E1 = -729.3753054026125  E_coul = 203.12069234145355
init E= -526.254613061159
    CPU time for initialize scf      7.27 sec, wall time      0.35 sec
  HOMO = -0.556953297114051  LUMO = 1.03705697420412
  mo_energy =
[-1.18331536e+02 -1.22078687e+01 -9.45167512e+00 -9.45167512e+00
 -9.45167512e+00 -1.22569180e+00 -5.56953297e-01 -5.56953297e-01
 -5.56953297e-01  1.03705697e+00  1.03705697e+00  1.03705697e+00
  7.33880854e+00  7.33880854e+00  7.33880854e+00  9.45593608e+00
  3.35155756e+01  3.35155756e+01  3.35155756e+01  1.02508607e+02
  1.29135627e+02  1.29135627e+02  1.29135627e+02  4.83538074e+02
  4.83538074e+02  4.83538074e+02  5.83835444e+02  1.33542758e+03
  1.33542758e+03  1.33542758e+03  2.65261968e+03  3.02973219e+03
  3.02973219e+03  3.02973219e+03  6.65028307e+03  6.65028307e+03
  6.65028307e+03  9.05844627e+03  2.54142543e+04  7.61568442e+04]
E1 = -727.9697153709693  E_coul = 201.2690244385209
cycle= 1 E= -526.700690932448  delta_E= -0.446  |g|= 0.185  |ddm|= 0.42
    CPU time for cycle= 1      0.08 sec, wall time      0.03 sec
diis-norm(errvec)=0.542096
diis-c [-0.2938683  1.       ]
  HOMO = -0.581107618467936  LUMO = 1.02123193014504
  mo_energy =
[-1.18627202e+02 -1.23315372e+01 -9.58588057e+00 -9.58588057e+00
 -9.58588057e+00 -1.25652147e+00 -5.81107618e-01 -5.81107618e-01
 -5.81107618e-01  1.02123193e+00  1.02123193e+00  1.02123193e+00
  7.26321031e+00  7.26321031e+00  7.26321031e+00  9.36781365e+00
  3.33754128e+01  3.33754128e+01  3.33754128e+01  1.02302677e+02
  1.28920603e+02  1.28920603e+02  1.28920603e+02  4.83243728e+02
  4.83243728e+02  4.83243728e+02  5.83502826e+02  1.33507619e+03
  1.33507619e+03  1.33507619e+03  2.65213301e+03  3.02931416e+03
  3.02931416e+03  3.02931416e+03  6.64975129e+03  6.64975129e+03
  6.64975129e+03  9.05783885e+03  2.54135526e+04  7.61560524e+04]
E1 = -728.4372975975847  E_coul = 201.73600302089892
cycle= 2 E= -526.701294576686  delta_E= -0.000604  |g|= 0.0338  |ddm|= 0.0391
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0674078
diis-c [-0.00268627  0.07396314  0.92603686]
  HOMO = -0.574334184611283  LUMO = 1.02635416057388
  mo_energy =
[-1.18568045e+02 -1.23004680e+01 -9.55349852e+00 -9.55349852e+00
 -9.55349852e+00 -1.24793029e+00 -5.74334185e-01 -5.74334185e-01
 -5.74334185e-01  1.02635416e+00  1.02635416e+00  1.02635416e+00
  7.28180062e+00  7.28180062e+00  7.28180062e+00  9.39192791e+00
  3.34084226e+01  3.34084226e+01  3.34084226e+01  1.02350454e+02
  1.28968494e+02  1.28968494e+02  1.28968494e+02  4.83302131e+02
  4.83302131e+02  4.83302131e+02  5.83563471e+02  1.33513843e+03
  1.33513843e+03  1.33513843e+03  2.65219828e+03  3.02937847e+03
  3.02937847e+03  3.02937847e+03  6.64981715e+03  6.64981715e+03
  6.64981715e+03  9.05790542e+03  2.54136197e+04  7.61561197e+04]
E1 = -728.3312916961323  E_coul = 201.62996167017693
cycle= 3 E= -526.701330025955  delta_E= -3.54e-05  |g|= 0.00486  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.010566
diis-c [-5.03601583e-07 -1.16544811e-03  1.30652613e-01  8.70512835e-01]
  HOMO = -0.57525890396279  LUMO = 1.02566630955375
  mo_energy =
[-1.18575658e+02 -1.23045334e+01 -9.55784410e+00 -9.55784410e+00
 -9.55784410e+00 -1.24904722e+00 -5.75258904e-01 -5.75258904e-01
 -5.75258904e-01  1.02566631e+00  1.02566631e+00  1.02566631e+00
  7.27928459e+00  7.27928459e+00  7.27928459e+00  9.38886391e+00
  3.34040248e+01  3.34040248e+01  3.34040248e+01  1.02344307e+02
  1.28962274e+02  1.28962274e+02  1.28962274e+02  4.83294615e+02
  4.83294615e+02  4.83294615e+02  5.83555635e+02  1.33513039e+03
  1.33513039e+03  1.33513039e+03  2.65218966e+03  3.02937008e+03
  3.02937008e+03  3.02937008e+03  6.64980841e+03  6.64980841e+03
  6.64980841e+03  9.05789648e+03  2.54136106e+04  7.61561104e+04]
E1 = -728.3456456639914  E_coul = 201.64431477997852
cycle= 4 E= -526.701330884013  delta_E= -8.58e-07  |g|= 6.47e-05  |ddm|= 0.00132
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000134104
diis-c [-1.42086944e-09  6.68534545e-05 -9.20750509e-03 -7.28570223e-02
  1.08199767e+00]
  HOMO = -0.575246451873314  LUMO = 1.02567557629356
  mo_energy =
[-1.18575665e+02 -1.23045046e+01 -9.55782784e+00 -9.55782784e+00
 -9.55782784e+00 -1.24902718e+00 -5.75246452e-01 -5.75246452e-01
 -5.75246452e-01  1.02567558e+00  1.02567558e+00  1.02567558e+00
  7.27930522e+00  7.27930522e+00  7.27930522e+00  9.38890043e+00
  3.34040398e+01  3.34040398e+01  3.34040398e+01  1.02344317e+02
  1.28962280e+02  1.28962280e+02  1.28962280e+02  4.83294609e+02
  4.83294609e+02  4.83294609e+02  5.83555620e+02  1.33513037e+03
  1.33513037e+03  1.33513037e+03  2.65218963e+03  3.02937006e+03
  3.02937006e+03  3.02937006e+03  6.64980837e+03  6.64980837e+03
  6.64980837e+03  9.05789643e+03  2.54136105e+04  7.61561104e+04]
E1 = -728.3456507628283  E_coul = 201.6443198786802
cycle= 5 E= -526.701330884148  delta_E= -1.35e-10  |g|= 8.08e-06  |ddm|= 2.7e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3456507628283  E_coul = 201.6443198786802
  HOMO = -0.575250041201268  LUMO = 1.02567294996637
  mo_energy =
[-1.18575683e+02 -1.23045172e+01 -9.55784114e+00 -9.55784114e+00
 -9.55784114e+00 -1.24903158e+00 -5.75250041e-01 -5.75250041e-01
 -5.75250041e-01  1.02567295e+00  1.02567295e+00  1.02567295e+00
  7.27929651e+00  7.27929651e+00  7.27929651e+00  9.38889028e+00
  3.34040267e+01  3.34040267e+01  3.34040267e+01  1.02344301e+02
  1.28962264e+02  1.28962264e+02  1.28962264e+02  4.83294591e+02
  4.83294591e+02  4.83294591e+02  5.83555602e+02  1.33513035e+03
  1.33513035e+03  1.33513035e+03  2.65218961e+03  3.02937004e+03
  3.02937004e+03  3.02937004e+03  6.64980835e+03  6.64980835e+03
  6.64980835e+03  9.05789641e+03  2.54136105e+04  7.61561104e+04]
E1 = -728.3456907503138  E_coul = 201.64435986616195
Extra cycle  E= -526.701330884152  delta_E= -3.75e-12  |g|= 2.4e-06  |ddm|= 4.15e-06
    CPU time for scf_cycle      7.49 sec, wall time      0.53 sec
exp = [2.61826561e+04 7.61752143e+03 3.61735110e+03 1.59781545e+03
 3.82852140e+02 1.08163206e+02 3.51531727e+01 7.88146609e+00
 3.06243252e+00 3.98183438e-01 1.36278328e+03 6.64744934e+02
 3.00958467e+02 3.14039235e+02 6.16257215e+01 7.34074864e+00
 2.02318237e+01 7.74619768e-01 2.80471531e+00 2.24422387e-01]
E = -526.7013308841518
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:57:09 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6560806        1
[INPUT] 0    0    [1    /1   ]  7617.52142508        1
[INPUT] 0    0    [1    /1   ]  3617.35109801        1
[INPUT] 0    0    [1    /1   ]  1597.81544829        1
[INPUT] 0    0    [1    /1   ]  382.852140466        1
[INPUT] 0    0    [1    /1   ]  108.163205765        1
[INPUT] 0    0    [1    /1   ]  35.1531727347        1
[INPUT] 0    0    [1    /1   ]  7.88146608688        1
[INPUT] 0    0    [1    /1   ]  3.06243252328        1
[INPUT] 0    0    [1    /1   ]  0.398183438229       1
[INPUT] 1    0    [1    /1   ]  1362.78328161        1
[INPUT] 1    0    [1    /1   ]  664.744934032        1
[INPUT] 1    0    [1    /1   ]  300.958466734        1
[INPUT] 1    0    [1    /1   ]  314.039234933        1
[INPUT] 1    0    [1    /1   ]  61.6257214934        1
[INPUT] 1    0    [1    /1   ]  7.34074864204        1
[INPUT] 1    0    [1    /1   ]  20.2318236555        1
[INPUT] 1    0    [1    /1   ]  0.774619768128       1
[INPUT] 1    0    [1    /1   ]  2.80471530533        1
[INPUT] 1    0    [1    /1   ]  0.224422386641       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.65608060137, 1.0]], [0, [7617.5214250846475, 1.0]], [0, [3617.3510980147803, 1.0]], [0, [1597.8154482885939, 1.0]], [0, [382.85214046623435, 1.0]], [0, [108.16320576453472, 1.0]], [0, [35.15317273472529, 1.0]], [0, [7.881466086875332, 1.0]], [0, [3.062432523280826, 1.0]], [0, [0.39818343822873886, 1.0]], [1, [1362.7832816080988, 1.0]], [1, [664.7449340322291, 1.0]], [1, [300.958466734286, 1.0]], [1, [314.03923493324635, 1.0]], [1, [61.62572149339588, 1.0]], [1, [7.340748642039802, 1.0]], [1, [20.231823655458133, 1.0]], [1, [0.7746197681283807, 1.0]], [1, [2.8047153053274823, 1.0]], [1, [0.2244223866414009, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.6560806]
bas 1, expnt(s) = [7617.52142508]
bas 2, expnt(s) = [3617.35109801]
bas 3, expnt(s) = [1597.81544829]
bas 4, expnt(s) = [382.85214047]
bas 5, expnt(s) = [108.16320576]
bas 6, expnt(s) = [35.15317273]
bas 7, expnt(s) = [7.88146609]
bas 8, expnt(s) = [3.06243252]
bas 9, expnt(s) = [0.39818344]
bas 10, expnt(s) = [1362.78328161]
bas 11, expnt(s) = [664.74493403]
bas 12, expnt(s) = [300.95846673]
bas 13, expnt(s) = [314.03923493]
bas 14, expnt(s) = [61.62572149]
bas 15, expnt(s) = [7.34074864]
bas 16, expnt(s) = [20.23182366]
bas 17, expnt(s) = [0.77461977]
bas 18, expnt(s) = [2.80471531]
bas 19, expnt(s) = [0.22442239]
CPU time:       719.30
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826561e+04 5.20026290e+03 7.61752143e+03 2.06003827e+03
 3.61735110e+03 1.17844148e+03 1.59781545e+03 6.38498654e+02
 3.82852140e+02 2.18669561e+02 1.08163206e+02 8.47373127e+01
 3.51531727e+01 3.64744222e+01 7.88146609e+00 1.18842090e+01
 3.06243252e+00 5.84877508e+00 3.98183438e-01 1.26641900e+00
 1.36278328e+03 2.41556033e+04 6.64744934e+02 9.84698299e+03
 3.00958467e+02 3.65693802e+03 3.14039235e+02 3.85668600e+03
 6.16257215e+01 5.03717354e+02 7.34074864e+00 3.52500579e+01
 2.02318237e+01 1.25178050e+02 7.74619768e-01 2.12004516e+00
 2.80471531e+00 1.05887665e+01 2.24422387e-01 4.50626900e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98291721747345
cond(S) = 102352.04081052111
E1 = -729.3753054026125  E_coul = 203.12069234145355
init E= -526.254613061159
    CPU time for initialize scf      7.31 sec, wall time      0.36 sec
  HOMO = -0.556953297114051  LUMO = 1.03705697420412
  mo_energy =
[-1.18331536e+02 -1.22078687e+01 -9.45167512e+00 -9.45167512e+00
 -9.45167512e+00 -1.22569180e+00 -5.56953297e-01 -5.56953297e-01
 -5.56953297e-01  1.03705697e+00  1.03705697e+00  1.03705697e+00
  7.33880854e+00  7.33880854e+00  7.33880854e+00  9.45593608e+00
  3.35155756e+01  3.35155756e+01  3.35155756e+01  1.02508607e+02
  1.29135627e+02  1.29135627e+02  1.29135627e+02  4.83538074e+02
  4.83538074e+02  4.83538074e+02  5.83835444e+02  1.33542758e+03
  1.33542758e+03  1.33542758e+03  2.65261968e+03  3.02973219e+03
  3.02973219e+03  3.02973219e+03  6.65028307e+03  6.65028307e+03
  6.65028307e+03  9.05844627e+03  2.54142543e+04  7.61568442e+04]
E1 = -727.9697153709693  E_coul = 201.2690244385209
cycle= 1 E= -526.700690932448  delta_E= -0.446  |g|= 0.185  |ddm|= 0.42
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.542096
diis-c [-0.2938683  1.       ]
  HOMO = -0.581107618467936  LUMO = 1.02123193014504
  mo_energy =
[-1.18627202e+02 -1.23315372e+01 -9.58588057e+00 -9.58588057e+00
 -9.58588057e+00 -1.25652147e+00 -5.81107618e-01 -5.81107618e-01
 -5.81107618e-01  1.02123193e+00  1.02123193e+00  1.02123193e+00
  7.26321031e+00  7.26321031e+00  7.26321031e+00  9.36781365e+00
  3.33754128e+01  3.33754128e+01  3.33754128e+01  1.02302677e+02
  1.28920603e+02  1.28920603e+02  1.28920603e+02  4.83243728e+02
  4.83243728e+02  4.83243728e+02  5.83502826e+02  1.33507619e+03
  1.33507619e+03  1.33507619e+03  2.65213301e+03  3.02931416e+03
  3.02931416e+03  3.02931416e+03  6.64975129e+03  6.64975129e+03
  6.64975129e+03  9.05783885e+03  2.54135526e+04  7.61560524e+04]
E1 = -728.4372975975847  E_coul = 201.73600302089892
cycle= 2 E= -526.701294576686  delta_E= -0.000604  |g|= 0.0338  |ddm|= 0.0391
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0674078
diis-c [-0.00268627  0.07396314  0.92603686]
  HOMO = -0.574334184611283  LUMO = 1.02635416057388
  mo_energy =
[-1.18568045e+02 -1.23004680e+01 -9.55349852e+00 -9.55349852e+00
 -9.55349852e+00 -1.24793029e+00 -5.74334185e-01 -5.74334185e-01
 -5.74334185e-01  1.02635416e+00  1.02635416e+00  1.02635416e+00
  7.28180062e+00  7.28180062e+00  7.28180062e+00  9.39192791e+00
  3.34084226e+01  3.34084226e+01  3.34084226e+01  1.02350454e+02
  1.28968494e+02  1.28968494e+02  1.28968494e+02  4.83302131e+02
  4.83302131e+02  4.83302131e+02  5.83563471e+02  1.33513843e+03
  1.33513843e+03  1.33513843e+03  2.65219828e+03  3.02937847e+03
  3.02937847e+03  3.02937847e+03  6.64981715e+03  6.64981715e+03
  6.64981715e+03  9.05790542e+03  2.54136197e+04  7.61561197e+04]
E1 = -728.3312916961323  E_coul = 201.62996167017693
cycle= 3 E= -526.701330025955  delta_E= -3.54e-05  |g|= 0.00486  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.010566
diis-c [-5.03601583e-07 -1.16544811e-03  1.30652613e-01  8.70512835e-01]
  HOMO = -0.57525890396279  LUMO = 1.02566630955375
  mo_energy =
[-1.18575658e+02 -1.23045334e+01 -9.55784410e+00 -9.55784410e+00
 -9.55784410e+00 -1.24904722e+00 -5.75258904e-01 -5.75258904e-01
 -5.75258904e-01  1.02566631e+00  1.02566631e+00  1.02566631e+00
  7.27928459e+00  7.27928459e+00  7.27928459e+00  9.38886391e+00
  3.34040248e+01  3.34040248e+01  3.34040248e+01  1.02344307e+02
  1.28962274e+02  1.28962274e+02  1.28962274e+02  4.83294615e+02
  4.83294615e+02  4.83294615e+02  5.83555635e+02  1.33513039e+03
  1.33513039e+03  1.33513039e+03  2.65218966e+03  3.02937008e+03
  3.02937008e+03  3.02937008e+03  6.64980841e+03  6.64980841e+03
  6.64980841e+03  9.05789648e+03  2.54136106e+04  7.61561104e+04]
E1 = -728.3456456639914  E_coul = 201.64431477997852
cycle= 4 E= -526.701330884013  delta_E= -8.58e-07  |g|= 6.47e-05  |ddm|= 0.00132
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000134104
diis-c [-1.42086944e-09  6.68534545e-05 -9.20750509e-03 -7.28570223e-02
  1.08199767e+00]
  HOMO = -0.575246451873314  LUMO = 1.02567557629356
  mo_energy =
[-1.18575665e+02 -1.23045046e+01 -9.55782784e+00 -9.55782784e+00
 -9.55782784e+00 -1.24902718e+00 -5.75246452e-01 -5.75246452e-01
 -5.75246452e-01  1.02567558e+00  1.02567558e+00  1.02567558e+00
  7.27930522e+00  7.27930522e+00  7.27930522e+00  9.38890043e+00
  3.34040398e+01  3.34040398e+01  3.34040398e+01  1.02344317e+02
  1.28962280e+02  1.28962280e+02  1.28962280e+02  4.83294609e+02
  4.83294609e+02  4.83294609e+02  5.83555620e+02  1.33513037e+03
  1.33513037e+03  1.33513037e+03  2.65218963e+03  3.02937006e+03
  3.02937006e+03  3.02937006e+03  6.64980837e+03  6.64980837e+03
  6.64980837e+03  9.05789643e+03  2.54136105e+04  7.61561104e+04]
E1 = -728.3456507628283  E_coul = 201.6443198786802
cycle= 5 E= -526.701330884148  delta_E= -1.35e-10  |g|= 8.08e-06  |ddm|= 2.7e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3456507628283  E_coul = 201.6443198786802
  HOMO = -0.575250041201268  LUMO = 1.02567294996637
  mo_energy =
[-1.18575683e+02 -1.23045172e+01 -9.55784114e+00 -9.55784114e+00
 -9.55784114e+00 -1.24903158e+00 -5.75250041e-01 -5.75250041e-01
 -5.75250041e-01  1.02567295e+00  1.02567295e+00  1.02567295e+00
  7.27929651e+00  7.27929651e+00  7.27929651e+00  9.38889028e+00
  3.34040267e+01  3.34040267e+01  3.34040267e+01  1.02344301e+02
  1.28962264e+02  1.28962264e+02  1.28962264e+02  4.83294591e+02
  4.83294591e+02  4.83294591e+02  5.83555602e+02  1.33513035e+03
  1.33513035e+03  1.33513035e+03  2.65218961e+03  3.02937004e+03
  3.02937004e+03  3.02937004e+03  6.64980835e+03  6.64980835e+03
  6.64980835e+03  9.05789641e+03  2.54136105e+04  7.61561104e+04]
E1 = -728.3456907503138  E_coul = 201.64435986616195
Extra cycle  E= -526.701330884152  delta_E= -3.75e-12  |g|= 2.4e-06  |ddm|= 4.15e-06
    CPU time for scf_cycle      7.50 sec, wall time      0.54 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102352.04081052111
E1 = -728.3456907503138  E_coul = 201.64435986616195
init E= -526.701330884152
    CPU time for initialize scf     16.00 sec, wall time      0.80 sec
  HOMO = -0.575249310359763  LUMO = 1.02567349133514
  mo_energy =
[-1.18575678e+02 -1.23045143e+01 -9.55783811e+00 -9.55783811e+00
 -9.55783811e+00 -1.24903066e+00 -5.75249310e-01 -5.75249310e-01
 -5.75249310e-01  1.02567349e+00  1.02567349e+00  1.02567349e+00
  7.27929837e+00  7.27929837e+00  7.27929837e+00  9.38889259e+00
  3.34040298e+01  3.34040298e+01  3.34040298e+01  1.02344306e+02
  1.28962268e+02  1.28962268e+02  1.28962268e+02  4.83294596e+02
  4.83294596e+02  4.83294596e+02  5.83555607e+02  1.33513036e+03
  1.33513036e+03  1.33513036e+03  2.65218961e+03  3.02937004e+03
  3.02937004e+03  3.02937004e+03  6.64980835e+03  6.64980835e+03
  6.64980835e+03  9.05789642e+03  2.54136105e+04  7.61561104e+04]
E1 = -728.3456812309919  E_coul = 201.64435034684038
cycle= 1 E= -526.701330884152  delta_E= 3.41e-13  |g|= 6.17e-07  |ddm|= 9.54e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3456812309919  E_coul = 201.64435034684038
  HOMO = -0.575249472041466  LUMO = 1.02567337090475
  mo_energy =
[-1.18575679e+02 -1.23045150e+01 -9.55783883e+00 -9.55783883e+00
 -9.55783883e+00 -1.24903086e+00 -5.75249472e-01 -5.75249472e-01
 -5.75249472e-01  1.02567337e+00  1.02567337e+00  1.02567337e+00
  7.27929794e+00  7.27929794e+00  7.27929794e+00  9.38889206e+00
  3.34040291e+01  3.34040291e+01  3.34040291e+01  1.02344305e+02
  1.28962267e+02  1.28962267e+02  1.28962267e+02  4.83294594e+02
  4.83294594e+02  4.83294594e+02  5.83555606e+02  1.33513036e+03
  1.33513036e+03  1.33513036e+03  2.65218961e+03  3.02937004e+03
  3.02937004e+03  3.02937004e+03  6.64980835e+03  6.64980835e+03
  6.64980835e+03  9.05789642e+03  2.54136105e+04  7.61561104e+04]
E1 = -728.3456835571859  E_coul = 201.64435267303367
Extra cycle  E= -526.701330884152  delta_E= -6.82e-13  |g|= 1.55e-07  |ddm|= 2.24e-07
    CPU time for scf_cycle     16.12 sec, wall time      0.92 sec
exp = [2.61826561e+04 7.61752143e+03 3.61735110e+03 1.59781545e+03
 3.82852140e+02 1.08163206e+02 3.51531727e+01 7.88146609e+00
 3.06243252e+00 3.98183438e-01 1.36278328e+03 6.64744934e+02
 3.00958467e+02 3.14039235e+02 6.16257215e+01 7.34074864e+00
 2.02318237e+01 7.74619768e-01 2.80471531e+00 2.24422387e-01]
grad_E = [-1.51298176e-06  3.25963896e-06 -1.60571399e-06  6.74153314e-05
  3.03163496e-05 -8.35217417e-04 -1.72564305e-03 -1.51194071e-05
  7.57487669e-04 -3.55936944e-03 -5.12361412e-07  4.93190798e-06
  2.31541612e-05  1.99653867e-05  4.19152892e-05  2.25457237e-03
 -5.73689775e-04 -5.24216503e-03 -3.11764596e-03  2.48352599e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:57:14 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6561462        1
[INPUT] 0    0    [1    /1   ]  7617.52128375        1
[INPUT] 0    0    [1    /1   ]  3617.35116763        1
[INPUT] 0    0    [1    /1   ]  1597.8125229         1
[INPUT] 0    0    [1    /1   ]  382.8510347          1
[INPUT] 0    0    [1    /1   ]  108.197741126        1
[INPUT] 0    0    [1    /1   ]  35.23336097          1
[INPUT] 0    0    [1    /1   ]  7.81591165689        1
[INPUT] 0    0    [1    /1   ]  3.05118223143        1
[INPUT] 0    0    [1    /1   ]  0.397932790495       1
[INPUT] 1    0    [1    /1   ]  1362.78330358        1
[INPUT] 1    0    [1    /1   ]  664.744717302        1
[INPUT] 1    0    [1    /1   ]  300.95744488         1
[INPUT] 1    0    [1    /1   ]  314.038353894        1
[INPUT] 1    0    [1    /1   ]  61.6262921647        1
[INPUT] 1    0    [1    /1   ]  7.34076939647        1
[INPUT] 1    0    [1    /1   ]  20.2326561363        1
[INPUT] 1    0    [1    /1   ]  0.775016497154       1
[INPUT] 1    0    [1    /1   ]  2.79941864768        1
[INPUT] 1    0    [1    /1   ]  0.224979091765       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.656146167832, 1.0]], [0, [7617.521283748706, 1.0]], [0, [3617.3511676280054, 1.0]], [0, [1597.812522896378, 1.0]], [0, [382.85103469992976, 1.0]], [0, [108.197741126174, 1.0]], [0, [35.233360969980005, 1.0]], [0, [7.815911656891508, 1.0]], [0, [3.0511822314302375, 1.0]], [0, [0.3979327904953237, 1.0]], [1, [1362.7833035839355, 1.0]], [1, [664.7447173016775, 1.0]], [1, [300.9574448804038, 1.0]], [1, [314.03835389375246, 1.0]], [1, [61.626292164687065, 1.0]], [1, [7.340769396466938, 1.0]], [1, [20.2326561363379, 1.0]], [1, [0.7750164971536917, 1.0]], [1, [2.7994186476805343, 1.0]], [1, [0.22497909176470327, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65614617]
bas 1, expnt(s) = [7617.52128375]
bas 2, expnt(s) = [3617.35116763]
bas 3, expnt(s) = [1597.8125229]
bas 4, expnt(s) = [382.8510347]
bas 5, expnt(s) = [108.19774113]
bas 6, expnt(s) = [35.23336097]
bas 7, expnt(s) = [7.81591166]
bas 8, expnt(s) = [3.05118223]
bas 9, expnt(s) = [0.39793279]
bas 10, expnt(s) = [1362.78330358]
bas 11, expnt(s) = [664.7447173]
bas 12, expnt(s) = [300.95744488]
bas 13, expnt(s) = [314.03835389]
bas 14, expnt(s) = [61.62629216]
bas 15, expnt(s) = [7.3407694]
bas 16, expnt(s) = [20.23265614]
bas 17, expnt(s) = [0.7750165]
bas 18, expnt(s) = [2.79941865]
bas 19, expnt(s) = [0.22497909]
CPU time:       748.00
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826561e+04 5.20026291e+03 7.61752128e+03 2.06003824e+03
 3.61735117e+03 1.17844150e+03 1.59781252e+03 6.38497777e+02
 3.82851035e+02 2.18669088e+02 1.08197741e+02 8.47576037e+01
 3.52333610e+01 3.65368060e+01 7.81591166e+00 1.18099961e+01
 3.05118223e+00 5.83265292e+00 3.97932790e-01 1.26582107e+00
 1.36278330e+03 2.41556038e+04 6.64744717e+02 9.84697898e+03
 3.00957445e+02 3.65692250e+03 3.14038354e+02 3.85667247e+03
 6.16262922e+01 5.03723185e+02 7.34076940e+00 3.52501825e+01
 2.02326561e+01 1.25184488e+02 7.75016497e-01 2.12140250e+00
 2.79941865e+00 1.05637766e+01 2.24979092e-01 4.52024622e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982891288363053
cond(S) = 102329.6635847676
E1 = -729.3740647366878  E_coul = 203.12014106102257
init E= -526.253923675665
    CPU time for initialize scf      7.60 sec, wall time      0.36 sec
  HOMO = -0.556957060557739  LUMO = 1.03949189347537
  mo_energy =
[-1.18331619e+02 -1.22079354e+01 -9.45171302e+00 -9.45171302e+00
 -9.45171302e+00 -1.22574233e+00 -5.56957061e-01 -5.56957061e-01
 -5.56957061e-01  1.03949189e+00  1.03949189e+00  1.03949189e+00
  7.33352389e+00  7.33352389e+00  7.33352389e+00  9.36159080e+00
  3.35002581e+01  3.35002581e+01  3.35002581e+01  1.02364233e+02
  1.29122941e+02  1.29122941e+02  1.29122941e+02  4.83529529e+02
  4.83529529e+02  4.83529529e+02  5.83919078e+02  1.33541867e+03
  1.33541867e+03  1.33541867e+03  2.65277281e+03  3.02972130e+03
  3.02972130e+03  3.02972130e+03  6.65027100e+03  6.65027100e+03
  6.65027100e+03  9.05859707e+03  2.54143966e+04  7.61569762e+04]
E1 = -727.9766007001908  E_coul = 201.27579348414412
cycle= 1 E= -526.700807216047  delta_E= -0.447  |g|= 0.185  |ddm|= 0.422
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.541673
diis-c [-0.29340917  1.        ]
  HOMO = -0.580868643233093  LUMO = 1.0238294177333
  mo_energy =
[-1.18626734e+02 -1.23311117e+01 -9.58539733e+00 -9.58539733e+00
 -9.58539733e+00 -1.25625277e+00 -5.80868643e-01 -5.80868643e-01
 -5.80868643e-01  1.02382942e+00  1.02382942e+00  1.02382942e+00
  7.25842001e+00  7.25842001e+00  7.25842001e+00  9.27431565e+00
  3.33606180e+01  3.33606180e+01  3.33606180e+01  1.02158879e+02
  1.28908449e+02  1.28908449e+02  1.28908449e+02  4.83235784e+02
  4.83235784e+02  4.83235784e+02  5.83587053e+02  1.33506792e+03
  1.33506792e+03  1.33506792e+03  2.65228675e+03  3.02930390e+03
  3.02930390e+03  3.02930390e+03  6.64973983e+03  6.64973983e+03
  6.64973983e+03  9.05799026e+03  2.54136956e+04  7.61561850e+04]
E1 = -728.4427134253895  E_coul = 201.7413054315677
cycle= 2 E= -526.701407993822  delta_E= -0.000601  |g|= 0.0337  |ddm|= 0.0391
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0672409
diis-c [-0.00267697  0.07377253  0.92622747]
  HOMO = -0.574120150012403  LUMO = 1.02893867278059
  mo_energy =
[-1.18567720e+02 -1.23001386e+01 -9.55311102e+00 -9.55311102e+00
 -9.55311102e+00 -1.24769561e+00 -5.74120150e-01 -5.74120150e-01
 -5.74120150e-01  1.02893867e+00  1.02893867e+00  1.02893867e+00
  7.27693589e+00  7.27693589e+00  7.27693589e+00  9.29825962e+00
  3.33935317e+01  3.33935317e+01  3.33935317e+01  1.02206549e+02
  1.28956218e+02  1.28956218e+02  1.28956218e+02  4.83294047e+02
  4.83294047e+02  4.83294047e+02  5.83647558e+02  1.33513002e+03
  1.33513002e+03  1.33513002e+03  2.65235188e+03  3.02936806e+03
  3.02936806e+03  3.02936806e+03  6.64980555e+03  6.64980555e+03
  6.64980555e+03  9.05805669e+03  2.54137625e+04  7.61562521e+04]
E1 = -728.3370330493977  E_coul = 201.63558980412643
cycle= 3 E= -526.701443245271  delta_E= -3.53e-05  |g|= 0.00486  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0105527
diis-c [-5.01987865e-07 -1.16551359e-03  1.30793594e-01  8.70371920e-01]
  HOMO = -0.575041807683726  LUMO = 1.02825243148739
  mo_energy =
[-1.18575324e+02 -1.23041975e+01 -9.55744988e+00 -9.55744988e+00
 -9.55744988e+00 -1.24880802e+00 -5.75041808e-01 -5.75041808e-01
 -5.75041808e-01  1.02825243e+00  1.02825243e+00  1.02825243e+00
  7.27442736e+00  7.27442736e+00  7.27442736e+00  9.29521451e+00
  3.33891410e+01  3.33891410e+01  3.33891410e+01  1.02200408e+02
  1.28950007e+02  1.28950007e+02  1.28950007e+02  4.83286540e+02
  4.83286540e+02  4.83286540e+02  5.83639731e+02  1.33512199e+03
  1.33512199e+03  1.33512199e+03  2.65234327e+03  3.02935968e+03
  3.02935968e+03  3.02935968e+03  6.64979681e+03  6.64979681e+03
  6.64979681e+03  9.05804775e+03  2.54137534e+04  7.61562429e+04]
E1 = -728.3513656590459  E_coul = 201.6499215578913
cycle= 4 E= -526.701444101155  delta_E= -8.56e-07  |g|= 6.49e-05  |ddm|= 0.00132
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000133611
diis-c [-1.42873303e-09  6.69532224e-05 -9.22805338e-03 -7.28747188e-02
  1.08203582e+00]
  HOMO = -0.575029135442117  LUMO = 1.02826187784608
  mo_energy =
[-1.18575331e+02 -1.23041682e+01 -9.55743313e+00 -9.55743313e+00
 -9.55743313e+00 -1.24878765e+00 -5.75029135e-01 -5.75029135e-01
 -5.75029135e-01  1.02826188e+00  1.02826188e+00  1.02826188e+00
  7.27444841e+00  7.27444841e+00  7.27444841e+00  9.29525159e+00
  3.33891565e+01  3.33891565e+01  3.33891565e+01  1.02200419e+02
  1.28950013e+02  1.28950013e+02  1.28950013e+02  4.83286534e+02
  4.83286534e+02  4.83286534e+02  5.83639718e+02  1.33512197e+03
  1.33512197e+03  1.33512197e+03  2.65234323e+03  3.02935966e+03
  3.02935966e+03  3.02935966e+03  6.64979677e+03  6.64979677e+03
  6.64979677e+03  9.05804770e+03  2.54137534e+04  7.61562428e+04]
E1 = -728.3513699062202  E_coul = 201.64992580492665
cycle= 5 E= -526.701444101294  delta_E= -1.39e-10  |g|= 8.12e-06  |ddm|= 2.76e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3513699062202  E_coul = 201.64992580492665
  HOMO = -0.575032730701369  LUMO = 1.0282592449425
  mo_energy =
[-1.18575349e+02 -1.23041809e+01 -9.55744648e+00 -9.55744648e+00
 -9.55744648e+00 -1.24879205e+00 -5.75032731e-01 -5.75032731e-01
 -5.75032731e-01  1.02825924e+00  1.02825924e+00  1.02825924e+00
  7.27443967e+00  7.27443967e+00  7.27443967e+00  9.29524145e+00
  3.33891434e+01  3.33891434e+01  3.33891434e+01  1.02200403e+02
  1.28949997e+02  1.28949997e+02  1.28949997e+02  4.83286516e+02
  4.83286516e+02  4.83286516e+02  5.83639700e+02  1.33512195e+03
  1.33512195e+03  1.33512195e+03  2.65234322e+03  3.02935964e+03
  3.02935964e+03  3.02935964e+03  6.64979675e+03  6.64979675e+03
  6.64979675e+03  9.05804769e+03  2.54137533e+04  7.61562428e+04]
E1 = -728.3514100349113  E_coul = 201.6499659336141
Extra cycle  E= -526.701444101297  delta_E= -3.64e-12  |g|= 2.41e-06  |ddm|= 4.16e-06
    CPU time for scf_cycle      7.83 sec, wall time      0.57 sec
exp = [2.61826561e+04 7.61752128e+03 3.61735117e+03 1.59781252e+03
 3.82851035e+02 1.08197741e+02 3.52333610e+01 7.81591166e+00
 3.05118223e+00 3.97932790e-01 1.36278330e+03 6.64744717e+02
 3.00957445e+02 3.14038354e+02 6.16262922e+01 7.34076940e+00
 2.02326561e+01 7.75016497e-01 2.79941865e+00 2.24979092e-01]
E = -526.7014441012972
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:57:15 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6561462        1
[INPUT] 0    0    [1    /1   ]  7617.52128375        1
[INPUT] 0    0    [1    /1   ]  3617.35116763        1
[INPUT] 0    0    [1    /1   ]  1597.8125229         1
[INPUT] 0    0    [1    /1   ]  382.8510347          1
[INPUT] 0    0    [1    /1   ]  108.197741126        1
[INPUT] 0    0    [1    /1   ]  35.23336097          1
[INPUT] 0    0    [1    /1   ]  7.81591165689        1
[INPUT] 0    0    [1    /1   ]  3.05118223143        1
[INPUT] 0    0    [1    /1   ]  0.397932790495       1
[INPUT] 1    0    [1    /1   ]  1362.78330358        1
[INPUT] 1    0    [1    /1   ]  664.744717302        1
[INPUT] 1    0    [1    /1   ]  300.95744488         1
[INPUT] 1    0    [1    /1   ]  314.038353894        1
[INPUT] 1    0    [1    /1   ]  61.6262921647        1
[INPUT] 1    0    [1    /1   ]  7.34076939647        1
[INPUT] 1    0    [1    /1   ]  20.2326561363        1
[INPUT] 1    0    [1    /1   ]  0.775016497154       1
[INPUT] 1    0    [1    /1   ]  2.79941864768        1
[INPUT] 1    0    [1    /1   ]  0.224979091765       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.656146167832, 1.0]], [0, [7617.521283748706, 1.0]], [0, [3617.3511676280054, 1.0]], [0, [1597.812522896378, 1.0]], [0, [382.85103469992976, 1.0]], [0, [108.197741126174, 1.0]], [0, [35.233360969980005, 1.0]], [0, [7.815911656891508, 1.0]], [0, [3.0511822314302375, 1.0]], [0, [0.3979327904953237, 1.0]], [1, [1362.7833035839355, 1.0]], [1, [664.7447173016775, 1.0]], [1, [300.9574448804038, 1.0]], [1, [314.03835389375246, 1.0]], [1, [61.626292164687065, 1.0]], [1, [7.340769396466938, 1.0]], [1, [20.2326561363379, 1.0]], [1, [0.7750164971536917, 1.0]], [1, [2.7994186476805343, 1.0]], [1, [0.22497909176470327, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65614617]
bas 1, expnt(s) = [7617.52128375]
bas 2, expnt(s) = [3617.35116763]
bas 3, expnt(s) = [1597.8125229]
bas 4, expnt(s) = [382.8510347]
bas 5, expnt(s) = [108.19774113]
bas 6, expnt(s) = [35.23336097]
bas 7, expnt(s) = [7.81591166]
bas 8, expnt(s) = [3.05118223]
bas 9, expnt(s) = [0.39793279]
bas 10, expnt(s) = [1362.78330358]
bas 11, expnt(s) = [664.7447173]
bas 12, expnt(s) = [300.95744488]
bas 13, expnt(s) = [314.03835389]
bas 14, expnt(s) = [61.62629216]
bas 15, expnt(s) = [7.3407694]
bas 16, expnt(s) = [20.23265614]
bas 17, expnt(s) = [0.7750165]
bas 18, expnt(s) = [2.79941865]
bas 19, expnt(s) = [0.22497909]
CPU time:       755.95
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826561e+04 5.20026291e+03 7.61752128e+03 2.06003824e+03
 3.61735117e+03 1.17844150e+03 1.59781252e+03 6.38497777e+02
 3.82851035e+02 2.18669088e+02 1.08197741e+02 8.47576037e+01
 3.52333610e+01 3.65368060e+01 7.81591166e+00 1.18099961e+01
 3.05118223e+00 5.83265292e+00 3.97932790e-01 1.26582107e+00
 1.36278330e+03 2.41556038e+04 6.64744717e+02 9.84697898e+03
 3.00957445e+02 3.65692250e+03 3.14038354e+02 3.85667247e+03
 6.16262922e+01 5.03723185e+02 7.34076940e+00 3.52501825e+01
 2.02326561e+01 1.25184488e+02 7.75016497e-01 2.12140250e+00
 2.79941865e+00 1.05637766e+01 2.24979092e-01 4.52024622e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982891288363053
cond(S) = 102329.6635847676
E1 = -729.3740647366878  E_coul = 203.12014106102257
init E= -526.253923675665
    CPU time for initialize scf      7.35 sec, wall time      0.35 sec
  HOMO = -0.556957060557739  LUMO = 1.03949189347537
  mo_energy =
[-1.18331619e+02 -1.22079354e+01 -9.45171302e+00 -9.45171302e+00
 -9.45171302e+00 -1.22574233e+00 -5.56957061e-01 -5.56957061e-01
 -5.56957061e-01  1.03949189e+00  1.03949189e+00  1.03949189e+00
  7.33352389e+00  7.33352389e+00  7.33352389e+00  9.36159080e+00
  3.35002581e+01  3.35002581e+01  3.35002581e+01  1.02364233e+02
  1.29122941e+02  1.29122941e+02  1.29122941e+02  4.83529529e+02
  4.83529529e+02  4.83529529e+02  5.83919078e+02  1.33541867e+03
  1.33541867e+03  1.33541867e+03  2.65277281e+03  3.02972130e+03
  3.02972130e+03  3.02972130e+03  6.65027100e+03  6.65027100e+03
  6.65027100e+03  9.05859707e+03  2.54143966e+04  7.61569762e+04]
E1 = -727.9766007001908  E_coul = 201.27579348414412
cycle= 1 E= -526.700807216047  delta_E= -0.447  |g|= 0.185  |ddm|= 0.422
    CPU time for cycle= 1      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.541673
diis-c [-0.29340917  1.        ]
  HOMO = -0.580868643233093  LUMO = 1.0238294177333
  mo_energy =
[-1.18626734e+02 -1.23311117e+01 -9.58539733e+00 -9.58539733e+00
 -9.58539733e+00 -1.25625277e+00 -5.80868643e-01 -5.80868643e-01
 -5.80868643e-01  1.02382942e+00  1.02382942e+00  1.02382942e+00
  7.25842001e+00  7.25842001e+00  7.25842001e+00  9.27431565e+00
  3.33606180e+01  3.33606180e+01  3.33606180e+01  1.02158879e+02
  1.28908449e+02  1.28908449e+02  1.28908449e+02  4.83235784e+02
  4.83235784e+02  4.83235784e+02  5.83587053e+02  1.33506792e+03
  1.33506792e+03  1.33506792e+03  2.65228675e+03  3.02930390e+03
  3.02930390e+03  3.02930390e+03  6.64973983e+03  6.64973983e+03
  6.64973983e+03  9.05799026e+03  2.54136956e+04  7.61561850e+04]
E1 = -728.4427134253895  E_coul = 201.7413054315677
cycle= 2 E= -526.701407993822  delta_E= -0.000601  |g|= 0.0337  |ddm|= 0.0391
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0672409
diis-c [-0.00267697  0.07377253  0.92622747]
  HOMO = -0.574120150012403  LUMO = 1.02893867278059
  mo_energy =
[-1.18567720e+02 -1.23001386e+01 -9.55311102e+00 -9.55311102e+00
 -9.55311102e+00 -1.24769561e+00 -5.74120150e-01 -5.74120150e-01
 -5.74120150e-01  1.02893867e+00  1.02893867e+00  1.02893867e+00
  7.27693589e+00  7.27693589e+00  7.27693589e+00  9.29825962e+00
  3.33935317e+01  3.33935317e+01  3.33935317e+01  1.02206549e+02
  1.28956218e+02  1.28956218e+02  1.28956218e+02  4.83294047e+02
  4.83294047e+02  4.83294047e+02  5.83647558e+02  1.33513002e+03
  1.33513002e+03  1.33513002e+03  2.65235188e+03  3.02936806e+03
  3.02936806e+03  3.02936806e+03  6.64980555e+03  6.64980555e+03
  6.64980555e+03  9.05805669e+03  2.54137625e+04  7.61562521e+04]
E1 = -728.3370330493977  E_coul = 201.63558980412643
cycle= 3 E= -526.701443245271  delta_E= -3.53e-05  |g|= 0.00486  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0105527
diis-c [-5.01987865e-07 -1.16551359e-03  1.30793594e-01  8.70371920e-01]
  HOMO = -0.575041807683726  LUMO = 1.02825243148739
  mo_energy =
[-1.18575324e+02 -1.23041975e+01 -9.55744988e+00 -9.55744988e+00
 -9.55744988e+00 -1.24880802e+00 -5.75041808e-01 -5.75041808e-01
 -5.75041808e-01  1.02825243e+00  1.02825243e+00  1.02825243e+00
  7.27442736e+00  7.27442736e+00  7.27442736e+00  9.29521451e+00
  3.33891410e+01  3.33891410e+01  3.33891410e+01  1.02200408e+02
  1.28950007e+02  1.28950007e+02  1.28950007e+02  4.83286540e+02
  4.83286540e+02  4.83286540e+02  5.83639731e+02  1.33512199e+03
  1.33512199e+03  1.33512199e+03  2.65234327e+03  3.02935968e+03
  3.02935968e+03  3.02935968e+03  6.64979681e+03  6.64979681e+03
  6.64979681e+03  9.05804775e+03  2.54137534e+04  7.61562429e+04]
E1 = -728.3513656590459  E_coul = 201.6499215578913
cycle= 4 E= -526.701444101155  delta_E= -8.56e-07  |g|= 6.49e-05  |ddm|= 0.00132
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000133611
diis-c [-1.42873303e-09  6.69532224e-05 -9.22805338e-03 -7.28747188e-02
  1.08203582e+00]
  HOMO = -0.575029135442117  LUMO = 1.02826187784608
  mo_energy =
[-1.18575331e+02 -1.23041682e+01 -9.55743313e+00 -9.55743313e+00
 -9.55743313e+00 -1.24878765e+00 -5.75029135e-01 -5.75029135e-01
 -5.75029135e-01  1.02826188e+00  1.02826188e+00  1.02826188e+00
  7.27444841e+00  7.27444841e+00  7.27444841e+00  9.29525159e+00
  3.33891565e+01  3.33891565e+01  3.33891565e+01  1.02200419e+02
  1.28950013e+02  1.28950013e+02  1.28950013e+02  4.83286534e+02
  4.83286534e+02  4.83286534e+02  5.83639718e+02  1.33512197e+03
  1.33512197e+03  1.33512197e+03  2.65234323e+03  3.02935966e+03
  3.02935966e+03  3.02935966e+03  6.64979677e+03  6.64979677e+03
  6.64979677e+03  9.05804770e+03  2.54137534e+04  7.61562428e+04]
E1 = -728.3513699062202  E_coul = 201.64992580492665
cycle= 5 E= -526.701444101294  delta_E= -1.39e-10  |g|= 8.12e-06  |ddm|= 2.76e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3513699062202  E_coul = 201.64992580492665
  HOMO = -0.575032730701369  LUMO = 1.0282592449425
  mo_energy =
[-1.18575349e+02 -1.23041809e+01 -9.55744648e+00 -9.55744648e+00
 -9.55744648e+00 -1.24879205e+00 -5.75032731e-01 -5.75032731e-01
 -5.75032731e-01  1.02825924e+00  1.02825924e+00  1.02825924e+00
  7.27443967e+00  7.27443967e+00  7.27443967e+00  9.29524145e+00
  3.33891434e+01  3.33891434e+01  3.33891434e+01  1.02200403e+02
  1.28949997e+02  1.28949997e+02  1.28949997e+02  4.83286516e+02
  4.83286516e+02  4.83286516e+02  5.83639700e+02  1.33512195e+03
  1.33512195e+03  1.33512195e+03  2.65234322e+03  3.02935964e+03
  3.02935964e+03  3.02935964e+03  6.64979675e+03  6.64979675e+03
  6.64979675e+03  9.05804769e+03  2.54137533e+04  7.61562428e+04]
E1 = -728.3514100349113  E_coul = 201.6499659336141
Extra cycle  E= -526.701444101297  delta_E= -3.64e-12  |g|= 2.41e-06  |ddm|= 4.16e-06
    CPU time for scf_cycle      7.58 sec, wall time      0.54 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102329.6635847676
E1 = -728.3514100349113  E_coul = 201.6499659336141
init E= -526.701444101297
    CPU time for initialize scf     16.11 sec, wall time      0.79 sec
  HOMO = -0.575031997933228  LUMO = 1.0282597883145
  mo_energy =
[-1.18575344e+02 -1.23041780e+01 -9.55744343e+00 -9.55744343e+00
 -9.55744343e+00 -1.24879114e+00 -5.75031998e-01 -5.75031998e-01
 -5.75031998e-01  1.02825979e+00  1.02825979e+00  1.02825979e+00
  7.27444154e+00  7.27444154e+00  7.27444154e+00  9.29524377e+00
  3.33891465e+01  3.33891465e+01  3.33891465e+01  1.02200407e+02
  1.28950001e+02  1.28950001e+02  1.28950001e+02  4.83286521e+02
  4.83286521e+02  4.83286521e+02  5.83639705e+02  1.33512196e+03
  1.33512196e+03  1.33512196e+03  2.65234322e+03  3.02935965e+03
  3.02935965e+03  3.02935965e+03  6.64979676e+03  6.64979676e+03
  6.64979676e+03  9.05804769e+03  2.54137533e+04  7.61562428e+04]
E1 = -728.3514004847452  E_coul = 201.649956383448
cycle= 1 E= -526.701444101297  delta_E= -1.14e-13  |g|= 6.2e-07  |ddm|= 9.59e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3514004847452  E_coul = 201.649956383448
  HOMO = -0.575032159950411  LUMO = 1.02825966751153
  mo_energy =
[-1.18575345e+02 -1.23041787e+01 -9.55744416e+00 -9.55744416e+00
 -9.55744416e+00 -1.24879134e+00 -5.75032160e-01 -5.75032160e-01
 -5.75032160e-01  1.02825967e+00  1.02825967e+00  1.02825967e+00
  7.27444111e+00  7.27444111e+00  7.27444111e+00  9.29524324e+00
  3.33891457e+01  3.33891457e+01  3.33891457e+01  1.02200406e+02
  1.28950000e+02  1.28950000e+02  1.28950000e+02  4.83286520e+02
  4.83286520e+02  4.83286520e+02  5.83639703e+02  1.33512196e+03
  1.33512196e+03  1.33512196e+03  2.65234322e+03  3.02935964e+03
  3.02935964e+03  3.02935964e+03  6.64979676e+03  6.64979676e+03
  6.64979676e+03  9.05804769e+03  2.54137533e+04  7.61562428e+04]
E1 = -728.3514028187261  E_coul = 201.64995871742818
Extra cycle  E= -526.701444101298  delta_E= -6.82e-13  |g|= 1.56e-07  |ddm|= 2.25e-07
    CPU time for scf_cycle     16.22 sec, wall time      0.91 sec
exp = [2.61826561e+04 7.61752128e+03 3.61735117e+03 1.59781252e+03
 3.82851035e+02 1.08197741e+02 3.52333610e+01 7.81591166e+00
 3.05118223e+00 3.97932790e-01 1.36278330e+03 6.64744717e+02
 3.00957445e+02 3.14038354e+02 6.16262922e+01 7.34076940e+00
 2.02326561e+01 7.75016497e-01 2.79941865e+00 2.24979092e-01]
grad_E = [-1.51205716e-06  3.24977082e-06 -1.60981912e-06  6.70165012e-05
  4.49552666e-05 -9.75465053e-04 -1.35567683e-03 -6.53364671e-04
  1.79279220e-03 -5.22967501e-03 -5.13590260e-07  4.91498904e-06
  2.30504459e-05  1.98764229e-05  5.56669538e-05  2.97074082e-03
 -7.25799652e-04 -7.60875247e-03 -4.24841456e-03  3.60711462e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:57:20 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6562709        1
[INPUT] 0    0    [1    /1   ]  7617.52101474        1
[INPUT] 0    0    [1    /1   ]  3617.35129978        1
[INPUT] 0    0    [1    /1   ]  1597.80695063        1
[INPUT] 0    0    [1    /1   ]  382.849209551        1
[INPUT] 0    0    [1    /1   ]  108.260266174        1
[INPUT] 0    0    [1    /1   ]  35.3925387265        1
[INPUT] 0    0    [1    /1   ]  7.76281599146        1
[INPUT] 0    0    [1    /1   ]  3.0437432174         1
[INPUT] 0    0    [1    /1   ]  0.397812175598       1
[INPUT] 1    0    [1    /1   ]  1362.78334537        1
[INPUT] 1    0    [1    /1   ]  664.74430511         1
[INPUT] 1    0    [1    /1   ]  300.955501405        1
[INPUT] 1    0    [1    /1   ]  314.036678234        1
[INPUT] 1    0    [1    /1   ]  61.6273918664        1
[INPUT] 1    0    [1    /1   ]  7.33780840956        1
[INPUT] 1    0    [1    /1   ]  20.2344678469        1
[INPUT] 1    0    [1    /1   ]  0.774920954454       1
[INPUT] 1    0    [1    /1   ]  2.79591066486        1
[INPUT] 1    0    [1    /1   ]  0.225100371966       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.656270866086, 1.0]], [0, [7617.521014744665, 1.0]], [0, [3617.3512997764096, 1.0]], [0, [1597.8069506257389, 1.0]], [0, [382.8492095510369, 1.0]], [0, [108.26026617435295, 1.0]], [0, [35.392538726524236, 1.0]], [0, [7.762815991456903, 1.0]], [0, [3.043743217399656, 1.0]], [0, [0.3978121755979523, 1.0]], [1, [1362.7833453709131, 1.0]], [1, [664.7443051101128, 1.0]], [1, [300.95550140463524, 1.0]], [1, [314.0366782339427, 1.0]], [1, [61.62739186641524, 1.0]], [1, [7.337808409555339, 1.0]], [1, [20.23446784693444, 1.0]], [1, [0.7749209544544158, 1.0]], [1, [2.7959106648556733, 1.0]], [1, [0.22510037196618662, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65627087]
bas 1, expnt(s) = [7617.52101474]
bas 2, expnt(s) = [3617.35129978]
bas 3, expnt(s) = [1597.80695063]
bas 4, expnt(s) = [382.84920955]
bas 5, expnt(s) = [108.26026617]
bas 6, expnt(s) = [35.39253873]
bas 7, expnt(s) = [7.76281599]
bas 8, expnt(s) = [3.04374322]
bas 9, expnt(s) = [0.39781218]
bas 10, expnt(s) = [1362.78334537]
bas 11, expnt(s) = [664.74430511]
bas 12, expnt(s) = [300.9555014]
bas 13, expnt(s) = [314.03667823]
bas 14, expnt(s) = [61.62739187]
bas 15, expnt(s) = [7.33780841]
bas 16, expnt(s) = [20.23446785]
bas 17, expnt(s) = [0.77492095]
bas 18, expnt(s) = [2.79591066]
bas 19, expnt(s) = [0.22510037]
CPU time:       784.61
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826563e+04 5.20026293e+03 7.61752101e+03 2.06003818e+03
 3.61735130e+03 1.17844153e+03 1.59780695e+03 6.38496107e+02
 3.82849210e+02 2.18668306e+02 1.08260266e+02 8.47943357e+01
 3.53925387e+01 3.66605361e+01 7.76281599e+00 1.17497735e+01
 3.04374322e+00 5.82198433e+00 3.97812176e-01 1.26553330e+00
 1.36278335e+03 2.41556047e+04 6.64744305e+02 9.84697135e+03
 3.00955501e+02 3.65689298e+03 3.14036678e+02 3.85664675e+03
 6.16273919e+01 5.03734421e+02 7.33780841e+00 3.52324101e+01
 2.02344678e+01 1.25198500e+02 7.74920954e-01 2.12107560e+00
 2.79591066e+00 1.05472322e+01 2.25100372e-01 4.52329235e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982901765335424
cond(S) = 102317.15284949071
E1 = -729.3734974266314  E_coul = 203.12034073327382
init E= -526.253156693358
    CPU time for initialize scf      7.37 sec, wall time      0.36 sec
  HOMO = -0.556951034643043  LUMO = 1.03986039589572
  mo_energy =
[-1.18331617e+02 -1.22079899e+01 -9.45168368e+00 -9.45168368e+00
 -9.45168368e+00 -1.22578243e+00 -5.56951035e-01 -5.56951035e-01
 -5.56951035e-01  1.03986040e+00  1.03986040e+00  1.03986040e+00
  7.32685113e+00  7.32685113e+00  7.32685113e+00  9.29387845e+00
  3.34819690e+01  3.34819690e+01  3.34819690e+01  1.02449652e+02
  1.29106778e+02  1.29106778e+02  1.29106778e+02  4.83519152e+02
  4.83519152e+02  4.83519152e+02  5.84427855e+02  1.33540676e+03
  1.33540676e+03  1.33540676e+03  2.65336723e+03  3.02970525e+03
  3.02970525e+03  3.02970525e+03  6.65025227e+03  6.65025227e+03
  6.65025227e+03  9.05916097e+03  2.54149294e+04  7.61574713e+04]
E1 = -727.9797036189563  E_coul = 201.27871385794367
cycle= 1 E= -526.700989761013  delta_E= -0.448  |g|= 0.185  |ddm|= 0.422
    CPU time for cycle= 1      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.541039
diis-c [-0.29272298  1.        ]
  HOMO = -0.580805466735573  LUMO = 1.02424415564914
  mo_energy =
[-1.18626367e+02 -1.23310218e+01 -9.58516821e+00 -9.58516821e+00
 -9.58516821e+00 -1.25621703e+00 -5.80805467e-01 -5.80805467e-01
 -5.80805467e-01  1.02424416e+00  1.02424416e+00  1.02424416e+00
  7.25193069e+00  7.25193069e+00  7.25193069e+00  9.20698881e+00
  3.33425753e+01  3.33425753e+01  3.33425753e+01  1.02244476e+02
  1.28892570e+02  1.28892570e+02  1.28892570e+02  4.83225835e+02
  4.83225835e+02  4.83225835e+02  5.84096324e+02  1.33505660e+03
  1.33505660e+03  1.33505660e+03  2.65288177e+03  3.02928842e+03
  3.02928842e+03  3.02928842e+03  6.64972171e+03  6.64972171e+03
  6.64972171e+03  9.05855478e+03  2.54142291e+04  7.61566807e+04]
E1 = -728.4452160033733  E_coul = 201.74362733471077
cycle= 2 E= -526.701588668662  delta_E= -0.000599  |g|= 0.0337  |ddm|= 0.0391
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0671428
diis-c [-0.00267494  0.07364606  0.92635394]
  HOMO = -0.57406354909328  LUMO = 1.02934794414211
  mo_energy =
[-1.18567429e+02 -1.23000859e+01 -9.55291696e+00 -9.55291696e+00
 -9.55291696e+00 -1.24766962e+00 -5.74063549e-01 -5.74063549e-01
 -5.74063549e-01  1.02934794e+00  1.02934794e+00  1.02934794e+00
  7.27041698e+00  7.27041698e+00  7.27041698e+00  9.23083821e+00
  3.33754511e+01  3.33754511e+01  3.33754511e+01  1.02292120e+02
  1.28940282e+02  1.28940282e+02  1.28940282e+02  4.83284023e+02
  4.83284023e+02  4.83284023e+02  5.84156759e+02  1.33511861e+03
  1.33511861e+03  1.33511861e+03  2.65294681e+03  3.02935251e+03
  3.02935251e+03  3.02935251e+03  6.64978735e+03  6.64978735e+03
  6.64978735e+03  9.05862112e+03  2.54142959e+04  7.61567478e+04]
E1 = -728.3396164853684  E_coul = 201.63799264308355
cycle= 3 E= -526.701623842285  delta_E= -3.52e-05  |g|= 0.00486  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0105499
diis-c [-4.95057735e-07 -1.16305499e-03  1.30955298e-01  8.70207757e-01]
  HOMO = -0.574985205246718  LUMO = 1.02866181007471
  mo_energy =
[-1.18575035e+02 -1.23041467e+01 -9.55725736e+00 -9.55725736e+00
 -9.55725736e+00 -1.24878173e+00 -5.74985205e-01 -5.74985205e-01
 -5.74985205e-01  1.02866181e+00  1.02866181e+00  1.02866181e+00
  7.26790939e+00  7.26790939e+00  7.26790939e+00  9.22780074e+00
  3.33710593e+01  3.33710593e+01  3.33710593e+01  1.02285973e+02
  1.28934068e+02  1.28934068e+02  1.28934068e+02  4.83276514e+02
  4.83276514e+02  4.83276514e+02  5.84148930e+02  1.33511058e+03
  1.33511058e+03  1.33511058e+03  2.65293821e+03  3.02934413e+03
  3.02934413e+03  3.02934413e+03  6.64977861e+03  6.64977861e+03
  6.64977861e+03  9.05861219e+03  2.54142868e+04  7.61567386e+04]
E1 = -728.353960207231  E_coul = 201.6523355080376
cycle= 4 E= -526.701624699193  delta_E= -8.57e-07  |g|= 6.47e-05  |ddm|= 0.00132
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000132433
diis-c [-1.42587843e-09  6.69894943e-05 -9.24095198e-03 -7.27652674e-02
  1.08193923e+00]
  HOMO = -0.574972428095627  LUMO = 1.02867134075745
  mo_energy =
[-1.18575041e+02 -1.23041171e+01 -9.55724025e+00 -9.55724025e+00
 -9.55724025e+00 -1.24876121e+00 -5.74972428e-01 -5.74972428e-01
 -5.74972428e-01  1.02867134e+00  1.02867134e+00  1.02867134e+00
  7.26793068e+00  7.26793068e+00  7.26793068e+00  9.22783812e+00
  3.33710752e+01  3.33710752e+01  3.33710752e+01  1.02285985e+02
  1.28934075e+02  1.28934075e+02  1.28934075e+02  4.83276509e+02
  4.83276509e+02  4.83276509e+02  5.84148918e+02  1.33511057e+03
  1.33511057e+03  1.33511057e+03  2.65293817e+03  3.02934410e+03
  3.02934410e+03  3.02934410e+03  6.64977857e+03  6.64977857e+03
  6.64977857e+03  9.05861214e+03  2.54142867e+04  7.61567385e+04]
E1 = -728.3539634710868  E_coul = 201.65233877175368
cycle= 5 E= -526.701624699333  delta_E= -1.4e-10  |g|= 8.12e-06  |ddm|= 2.8e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3539634710868  E_coul = 201.65233877175368
  HOMO = -0.574976017831756  LUMO = 1.02866871230239
  mo_energy =
[-1.18575059e+02 -1.23041298e+01 -9.55725359e+00 -9.55725359e+00
 -9.55725359e+00 -1.24876559e+00 -5.74976018e-01 -5.74976018e-01
 -5.74976018e-01  1.02866871e+00  1.02866871e+00  1.02866871e+00
  7.26792196e+00  7.26792196e+00  7.26792196e+00  9.22782801e+00
  3.33710621e+01  3.33710621e+01  3.33710621e+01  1.02285969e+02
  1.28934059e+02  1.28934059e+02  1.28934059e+02  4.83276491e+02
  4.83276491e+02  4.83276491e+02  5.84148899e+02  1.33511055e+03
  1.33511055e+03  1.33511055e+03  2.65293815e+03  3.02934408e+03
  3.02934408e+03  3.02934408e+03  6.64977855e+03  6.64977855e+03
  6.64977855e+03  9.05861212e+03  2.54142867e+04  7.61567385e+04]
E1 = -728.3540036300228  E_coul = 201.65237893068596
Extra cycle  E= -526.701624699337  delta_E= -3.75e-12  |g|= 2.41e-06  |ddm|= 4.16e-06
    CPU time for scf_cycle      7.60 sec, wall time      0.54 sec
exp = [2.61826563e+04 7.61752101e+03 3.61735130e+03 1.59780695e+03
 3.82849210e+02 1.08260266e+02 3.53925387e+01 7.76281599e+00
 3.04374322e+00 3.97812176e-01 1.36278335e+03 6.64744305e+02
 3.00955501e+02 3.14036678e+02 6.16273919e+01 7.33780841e+00
 2.02344678e+01 7.74920954e-01 2.79591066e+00 2.25100372e-01]
E = -526.7016246993369
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:57:21 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6562709        1
[INPUT] 0    0    [1    /1   ]  7617.52101474        1
[INPUT] 0    0    [1    /1   ]  3617.35129978        1
[INPUT] 0    0    [1    /1   ]  1597.80695063        1
[INPUT] 0    0    [1    /1   ]  382.849209551        1
[INPUT] 0    0    [1    /1   ]  108.260266174        1
[INPUT] 0    0    [1    /1   ]  35.3925387265        1
[INPUT] 0    0    [1    /1   ]  7.76281599146        1
[INPUT] 0    0    [1    /1   ]  3.0437432174         1
[INPUT] 0    0    [1    /1   ]  0.397812175598       1
[INPUT] 1    0    [1    /1   ]  1362.78334537        1
[INPUT] 1    0    [1    /1   ]  664.74430511         1
[INPUT] 1    0    [1    /1   ]  300.955501405        1
[INPUT] 1    0    [1    /1   ]  314.036678234        1
[INPUT] 1    0    [1    /1   ]  61.6273918664        1
[INPUT] 1    0    [1    /1   ]  7.33780840956        1
[INPUT] 1    0    [1    /1   ]  20.2344678469        1
[INPUT] 1    0    [1    /1   ]  0.774920954454       1
[INPUT] 1    0    [1    /1   ]  2.79591066486        1
[INPUT] 1    0    [1    /1   ]  0.225100371966       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.656270866086, 1.0]], [0, [7617.521014744665, 1.0]], [0, [3617.3512997764096, 1.0]], [0, [1597.8069506257389, 1.0]], [0, [382.8492095510369, 1.0]], [0, [108.26026617435295, 1.0]], [0, [35.392538726524236, 1.0]], [0, [7.762815991456903, 1.0]], [0, [3.043743217399656, 1.0]], [0, [0.3978121755979523, 1.0]], [1, [1362.7833453709131, 1.0]], [1, [664.7443051101128, 1.0]], [1, [300.95550140463524, 1.0]], [1, [314.0366782339427, 1.0]], [1, [61.62739186641524, 1.0]], [1, [7.337808409555339, 1.0]], [1, [20.23446784693444, 1.0]], [1, [0.7749209544544158, 1.0]], [1, [2.7959106648556733, 1.0]], [1, [0.22510037196618662, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65627087]
bas 1, expnt(s) = [7617.52101474]
bas 2, expnt(s) = [3617.35129978]
bas 3, expnt(s) = [1597.80695063]
bas 4, expnt(s) = [382.84920955]
bas 5, expnt(s) = [108.26026617]
bas 6, expnt(s) = [35.39253873]
bas 7, expnt(s) = [7.76281599]
bas 8, expnt(s) = [3.04374322]
bas 9, expnt(s) = [0.39781218]
bas 10, expnt(s) = [1362.78334537]
bas 11, expnt(s) = [664.74430511]
bas 12, expnt(s) = [300.9555014]
bas 13, expnt(s) = [314.03667823]
bas 14, expnt(s) = [61.62739187]
bas 15, expnt(s) = [7.33780841]
bas 16, expnt(s) = [20.23446785]
bas 17, expnt(s) = [0.77492095]
bas 18, expnt(s) = [2.79591066]
bas 19, expnt(s) = [0.22510037]
CPU time:       792.31
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826563e+04 5.20026293e+03 7.61752101e+03 2.06003818e+03
 3.61735130e+03 1.17844153e+03 1.59780695e+03 6.38496107e+02
 3.82849210e+02 2.18668306e+02 1.08260266e+02 8.47943357e+01
 3.53925387e+01 3.66605361e+01 7.76281599e+00 1.17497735e+01
 3.04374322e+00 5.82198433e+00 3.97812176e-01 1.26553330e+00
 1.36278335e+03 2.41556047e+04 6.64744305e+02 9.84697135e+03
 3.00955501e+02 3.65689298e+03 3.14036678e+02 3.85664675e+03
 6.16273919e+01 5.03734421e+02 7.33780841e+00 3.52324101e+01
 2.02344678e+01 1.25198500e+02 7.74920954e-01 2.12107560e+00
 2.79591066e+00 1.05472322e+01 2.25100372e-01 4.52329235e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982901765335424
cond(S) = 102317.15284949071
E1 = -729.3734974266314  E_coul = 203.12034073327382
init E= -526.253156693358
    CPU time for initialize scf      7.27 sec, wall time      0.35 sec
  HOMO = -0.556951034643043  LUMO = 1.03986039589572
  mo_energy =
[-1.18331617e+02 -1.22079899e+01 -9.45168368e+00 -9.45168368e+00
 -9.45168368e+00 -1.22578243e+00 -5.56951035e-01 -5.56951035e-01
 -5.56951035e-01  1.03986040e+00  1.03986040e+00  1.03986040e+00
  7.32685113e+00  7.32685113e+00  7.32685113e+00  9.29387845e+00
  3.34819690e+01  3.34819690e+01  3.34819690e+01  1.02449652e+02
  1.29106778e+02  1.29106778e+02  1.29106778e+02  4.83519152e+02
  4.83519152e+02  4.83519152e+02  5.84427855e+02  1.33540676e+03
  1.33540676e+03  1.33540676e+03  2.65336723e+03  3.02970525e+03
  3.02970525e+03  3.02970525e+03  6.65025227e+03  6.65025227e+03
  6.65025227e+03  9.05916097e+03  2.54149294e+04  7.61574713e+04]
E1 = -727.9797036189563  E_coul = 201.27871385794367
cycle= 1 E= -526.700989761013  delta_E= -0.448  |g|= 0.185  |ddm|= 0.422
    CPU time for cycle= 1      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.541039
diis-c [-0.29272298  1.        ]
  HOMO = -0.580805466735573  LUMO = 1.02424415564914
  mo_energy =
[-1.18626367e+02 -1.23310218e+01 -9.58516821e+00 -9.58516821e+00
 -9.58516821e+00 -1.25621703e+00 -5.80805467e-01 -5.80805467e-01
 -5.80805467e-01  1.02424416e+00  1.02424416e+00  1.02424416e+00
  7.25193069e+00  7.25193069e+00  7.25193069e+00  9.20698881e+00
  3.33425753e+01  3.33425753e+01  3.33425753e+01  1.02244476e+02
  1.28892570e+02  1.28892570e+02  1.28892570e+02  4.83225835e+02
  4.83225835e+02  4.83225835e+02  5.84096324e+02  1.33505660e+03
  1.33505660e+03  1.33505660e+03  2.65288177e+03  3.02928842e+03
  3.02928842e+03  3.02928842e+03  6.64972171e+03  6.64972171e+03
  6.64972171e+03  9.05855478e+03  2.54142291e+04  7.61566807e+04]
E1 = -728.4452160033733  E_coul = 201.74362733471077
cycle= 2 E= -526.701588668662  delta_E= -0.000599  |g|= 0.0337  |ddm|= 0.0391
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0671428
diis-c [-0.00267494  0.07364606  0.92635394]
  HOMO = -0.57406354909328  LUMO = 1.02934794414211
  mo_energy =
[-1.18567429e+02 -1.23000859e+01 -9.55291696e+00 -9.55291696e+00
 -9.55291696e+00 -1.24766962e+00 -5.74063549e-01 -5.74063549e-01
 -5.74063549e-01  1.02934794e+00  1.02934794e+00  1.02934794e+00
  7.27041698e+00  7.27041698e+00  7.27041698e+00  9.23083821e+00
  3.33754511e+01  3.33754511e+01  3.33754511e+01  1.02292120e+02
  1.28940282e+02  1.28940282e+02  1.28940282e+02  4.83284023e+02
  4.83284023e+02  4.83284023e+02  5.84156759e+02  1.33511861e+03
  1.33511861e+03  1.33511861e+03  2.65294681e+03  3.02935251e+03
  3.02935251e+03  3.02935251e+03  6.64978735e+03  6.64978735e+03
  6.64978735e+03  9.05862112e+03  2.54142959e+04  7.61567478e+04]
E1 = -728.3396164853684  E_coul = 201.63799264308355
cycle= 3 E= -526.701623842285  delta_E= -3.52e-05  |g|= 0.00486  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0105499
diis-c [-4.95057735e-07 -1.16305499e-03  1.30955298e-01  8.70207757e-01]
  HOMO = -0.574985205246718  LUMO = 1.02866181007471
  mo_energy =
[-1.18575035e+02 -1.23041467e+01 -9.55725736e+00 -9.55725736e+00
 -9.55725736e+00 -1.24878173e+00 -5.74985205e-01 -5.74985205e-01
 -5.74985205e-01  1.02866181e+00  1.02866181e+00  1.02866181e+00
  7.26790939e+00  7.26790939e+00  7.26790939e+00  9.22780074e+00
  3.33710593e+01  3.33710593e+01  3.33710593e+01  1.02285973e+02
  1.28934068e+02  1.28934068e+02  1.28934068e+02  4.83276514e+02
  4.83276514e+02  4.83276514e+02  5.84148930e+02  1.33511058e+03
  1.33511058e+03  1.33511058e+03  2.65293821e+03  3.02934413e+03
  3.02934413e+03  3.02934413e+03  6.64977861e+03  6.64977861e+03
  6.64977861e+03  9.05861219e+03  2.54142868e+04  7.61567386e+04]
E1 = -728.353960207231  E_coul = 201.6523355080376
cycle= 4 E= -526.701624699193  delta_E= -8.57e-07  |g|= 6.47e-05  |ddm|= 0.00132
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000132433
diis-c [-1.42587843e-09  6.69894943e-05 -9.24095198e-03 -7.27652674e-02
  1.08193923e+00]
  HOMO = -0.574972428095627  LUMO = 1.02867134075745
  mo_energy =
[-1.18575041e+02 -1.23041171e+01 -9.55724025e+00 -9.55724025e+00
 -9.55724025e+00 -1.24876121e+00 -5.74972428e-01 -5.74972428e-01
 -5.74972428e-01  1.02867134e+00  1.02867134e+00  1.02867134e+00
  7.26793068e+00  7.26793068e+00  7.26793068e+00  9.22783812e+00
  3.33710752e+01  3.33710752e+01  3.33710752e+01  1.02285985e+02
  1.28934075e+02  1.28934075e+02  1.28934075e+02  4.83276509e+02
  4.83276509e+02  4.83276509e+02  5.84148918e+02  1.33511057e+03
  1.33511057e+03  1.33511057e+03  2.65293817e+03  3.02934410e+03
  3.02934410e+03  3.02934410e+03  6.64977857e+03  6.64977857e+03
  6.64977857e+03  9.05861214e+03  2.54142867e+04  7.61567385e+04]
E1 = -728.3539634710868  E_coul = 201.65233877175368
cycle= 5 E= -526.701624699333  delta_E= -1.4e-10  |g|= 8.12e-06  |ddm|= 2.8e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3539634710868  E_coul = 201.65233877175368
  HOMO = -0.574976017831756  LUMO = 1.02866871230239
  mo_energy =
[-1.18575059e+02 -1.23041298e+01 -9.55725359e+00 -9.55725359e+00
 -9.55725359e+00 -1.24876559e+00 -5.74976018e-01 -5.74976018e-01
 -5.74976018e-01  1.02866871e+00  1.02866871e+00  1.02866871e+00
  7.26792196e+00  7.26792196e+00  7.26792196e+00  9.22782801e+00
  3.33710621e+01  3.33710621e+01  3.33710621e+01  1.02285969e+02
  1.28934059e+02  1.28934059e+02  1.28934059e+02  4.83276491e+02
  4.83276491e+02  4.83276491e+02  5.84148899e+02  1.33511055e+03
  1.33511055e+03  1.33511055e+03  2.65293815e+03  3.02934408e+03
  3.02934408e+03  3.02934408e+03  6.64977855e+03  6.64977855e+03
  6.64977855e+03  9.05861212e+03  2.54142867e+04  7.61567385e+04]
E1 = -728.3540036300228  E_coul = 201.65237893068596
Extra cycle  E= -526.701624699337  delta_E= -3.75e-12  |g|= 2.41e-06  |ddm|= 4.16e-06
    CPU time for scf_cycle      7.50 sec, wall time      0.53 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102317.15284949071
E1 = -728.3540036300228  E_coul = 201.65237893068596
init E= -526.701624699337
    CPU time for initialize scf     15.77 sec, wall time      0.77 sec
  HOMO = -0.574975284679512  LUMO = 1.02866925592792
  mo_energy =
[-1.18575054e+02 -1.23041269e+01 -9.55725055e+00 -9.55725055e+00
 -9.55725055e+00 -1.24876468e+00 -5.74975285e-01 -5.74975285e-01
 -5.74975285e-01  1.02866926e+00  1.02866926e+00  1.02866926e+00
  7.26792383e+00  7.26792383e+00  7.26792383e+00  9.22783032e+00
  3.33710651e+01  3.33710651e+01  3.33710651e+01  1.02285973e+02
  1.28934063e+02  1.28934063e+02  1.28934063e+02  4.83276496e+02
  4.83276496e+02  4.83276496e+02  5.84148904e+02  1.33511055e+03
  1.33511055e+03  1.33511055e+03  2.65293816e+03  3.02934409e+03
  3.02934409e+03  3.02934409e+03  6.64977856e+03  6.64977856e+03
  6.64977856e+03  9.05861213e+03  2.54142867e+04  7.61567385e+04]
E1 = -728.3539940696132  E_coul = 201.65236937027606
cycle= 1 E= -526.701624699337  delta_E= -2.27e-13  |g|= 6.2e-07  |ddm|= 9.62e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3539940696132  E_coul = 201.65236937027606
  HOMO = -0.5749754468175  LUMO = 1.02866913504927
  mo_energy =
[-1.18575055e+02 -1.23041276e+01 -9.55725127e+00 -9.55725127e+00
 -9.55725127e+00 -1.24876488e+00 -5.74975447e-01 -5.74975447e-01
 -5.74975447e-01  1.02866914e+00  1.02866914e+00  1.02866914e+00
  7.26792340e+00  7.26792340e+00  7.26792340e+00  9.22782979e+00
  3.33710644e+01  3.33710644e+01  3.33710644e+01  1.02285972e+02
  1.28934062e+02  1.28934062e+02  1.28934062e+02  4.83276495e+02
  4.83276495e+02  4.83276495e+02  5.84148903e+02  1.33511055e+03
  1.33511055e+03  1.33511055e+03  2.65293816e+03  3.02934409e+03
  3.02934409e+03  3.02934409e+03  6.64977855e+03  6.64977855e+03
  6.64977855e+03  9.05861213e+03  2.54142867e+04  7.61567385e+04]
E1 = -728.3539964074263  E_coul = 201.65237170808842
Extra cycle  E= -526.701624699338  delta_E= -6.82e-13  |g|= 1.56e-07  |ddm|= 2.25e-07
    CPU time for scf_cycle     15.88 sec, wall time      0.89 sec
exp = [2.61826563e+04 7.61752101e+03 3.61735130e+03 1.59780695e+03
 3.82849210e+02 1.08260266e+02 3.53925387e+01 7.76281599e+00
 3.04374322e+00 3.97812176e-01 1.36278335e+03 6.64744305e+02
 3.00955501e+02 3.14036678e+02 6.16273919e+01 7.33780841e+00
 2.02344678e+01 7.74920954e-01 2.79591066e+00 2.25100372e-01]
grad_E = [-1.51013426e-06  3.22885307e-06 -1.61914241e-06  6.61733785e-05
  7.54040668e-05 -1.26593406e-03 -5.76030364e-04 -1.17172458e-03
  2.44036560e-03 -5.78344024e-03 -5.13081737e-07  4.92220255e-06
  2.30945797e-05  1.99141608e-05  5.05823898e-05  3.04524776e-03
 -7.01552628e-04 -8.33428235e-03 -4.54472720e-03  3.94414795e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:57:26 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6564075        1
[INPUT] 0    0    [1    /1   ]  7617.52071992        1
[INPUT] 0    0    [1    /1   ]  3617.3514443         1
[INPUT] 0    0    [1    /1   ]  1597.80083972        1
[INPUT] 0    0    [1    /1   ]  382.847437557        1
[INPUT] 0    0    [1    /1   ]  108.326095277        1
[INPUT] 0    0    [1    /1   ]  35.5722770215        1
[INPUT] 0    0    [1    /1   ]  7.7742319751         1
[INPUT] 0    0    [1    /1   ]  3.04940166287        1
[INPUT] 0    0    [1    /1   ]  0.398024526782       1
[INPUT] 1    0    [1    /1   ]  1362.78339114        1
[INPUT] 1    0    [1    /1   ]  664.743853599        1
[INPUT] 1    0    [1    /1   ]  300.953372482        1
[INPUT] 1    0    [1    /1   ]  314.034842682        1
[INPUT] 1    0    [1    /1   ]  61.6286136226        1
[INPUT] 1    0    [1    /1   ]  7.33153273645        1
[INPUT] 1    0    [1    /1   ]  20.2366668221        1
[INPUT] 1    0    [1    /1   ]  0.774027886187       1
[INPUT] 1    0    [1    /1   ]  2.79878298092        1
[INPUT] 1    0    [1    /1   ]  0.224333932953       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.656407455543, 1.0]], [0, [7617.520719915336, 1.0]], [0, [3617.3514443040062, 1.0]], [0, [1597.800839721844, 1.0]], [0, [382.8474375571105, 1.0]], [0, [108.32609527735431, 1.0]], [0, [35.57227702154802, 1.0]], [0, [7.7742319751047155, 1.0]], [0, [3.049401662874749, 1.0]], [0, [0.39802452678195693, 1.0]], [1, [1362.7833911355822, 1.0]], [1, [664.7438535988807, 1.0]], [1, [300.9533724819555, 1.0]], [1, [314.0348426820996, 1.0]], [1, [61.628613622573766, 1.0]], [1, [7.331532736453099, 1.0]], [1, [20.236666822094314, 1.0]], [1, [0.7740278861871179, 1.0]], [1, [2.798782980915651, 1.0]], [1, [0.22433393295289808, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65640746]
bas 1, expnt(s) = [7617.52071992]
bas 2, expnt(s) = [3617.3514443]
bas 3, expnt(s) = [1597.80083972]
bas 4, expnt(s) = [382.84743756]
bas 5, expnt(s) = [108.32609528]
bas 6, expnt(s) = [35.57227702]
bas 7, expnt(s) = [7.77423198]
bas 8, expnt(s) = [3.04940166]
bas 9, expnt(s) = [0.39802453]
bas 10, expnt(s) = [1362.78339114]
bas 11, expnt(s) = [664.7438536]
bas 12, expnt(s) = [300.95337248]
bas 13, expnt(s) = [314.03484268]
bas 14, expnt(s) = [61.62861362]
bas 15, expnt(s) = [7.33153274]
bas 16, expnt(s) = [20.23666682]
bas 17, expnt(s) = [0.77402789]
bas 18, expnt(s) = [2.79878298]
bas 19, expnt(s) = [0.22433393]
CPU time:       820.53
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826564e+04 5.20026295e+03 7.61752072e+03 2.06003812e+03
 3.61735144e+03 1.17844157e+03 1.59780084e+03 6.38494276e+02
 3.82847438e+02 2.18667547e+02 1.08326095e+02 8.48330030e+01
 3.55722770e+01 3.68000809e+01 7.77423198e+00 1.17627305e+01
 3.04940166e+00 5.83009993e+00 3.98024527e-01 1.26603992e+00
 1.36278339e+03 2.41556057e+04 6.64743854e+02 9.84696299e+03
 3.00953372e+02 3.65686064e+03 3.14034843e+02 3.85661857e+03
 6.16286136e+01 5.03746904e+02 7.33153274e+00 3.51947484e+01
 2.02366668e+01 1.25215508e+02 7.74027886e-01 2.11802046e+00
 2.79878298e+00 1.05607782e+01 2.24333933e-01 4.50404899e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982971769275434
cond(S) = 102332.78079741853
E1 = -729.3745923080807  E_coul = 203.12174571950368
init E= -526.252846588577
    CPU time for initialize scf      7.31 sec, wall time      0.36 sec
  HOMO = -0.556934394370506  LUMO = 1.03620560245936
  mo_energy =
[-1.18331448e+02 -1.22079922e+01 -9.45155555e+00 -9.45155555e+00
 -9.45155555e+00 -1.22576803e+00 -5.56934394e-01 -5.56934394e-01
 -5.56934394e-01  1.03620560e+00  1.03620560e+00  1.03620560e+00
  7.32354159e+00  7.32354159e+00  7.32354159e+00  9.32868016e+00
  3.34735532e+01  3.34735532e+01  3.34735532e+01  1.02893051e+02
  1.29097634e+02  1.29097634e+02  1.29097634e+02  4.83514098e+02
  4.83514098e+02  4.83514098e+02  5.85322466e+02  1.33539913e+03
  1.33539913e+03  1.33539913e+03  2.65431090e+03  3.02969267e+03
  3.02969267e+03  3.02969267e+03  6.65023631e+03  6.65023631e+03
  6.65023631e+03  9.06004604e+03  2.54157659e+04  7.61582491e+04]
E1 = -727.9733134024877  E_coul = 201.27216094971186
cycle= 1 E= -526.701152452776  delta_E= -0.448  |g|= 0.185  |ddm|= 0.419
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.540535
diis-c [-0.29217802  1.        ]
  HOMO = -0.581118207197984  LUMO = 1.02038331718849
  mo_energy =
[-1.18626466e+02 -1.23316391e+01 -9.58559774e+00 -9.58559774e+00
 -9.58559774e+00 -1.25663258e+00 -5.81118207e-01 -5.81118207e-01
 -5.81118207e-01  1.02038332e+00  1.02038332e+00  1.02038332e+00
  7.24808281e+00  7.24808281e+00  7.24808281e+00  9.24101731e+00
  3.33336969e+01  3.33336969e+01  3.33336969e+01  1.02687164e+02
  1.28883023e+02  1.28883023e+02  1.28883023e+02  4.83220543e+02
  4.83220543e+02  4.83220543e+02  5.84990851e+02  1.33504898e+03
  1.33504898e+03  1.33504898e+03  2.65382551e+03  3.02927585e+03
  3.02927585e+03  3.02927585e+03  6.64970585e+03  6.64970585e+03
  6.64970585e+03  9.05943999e+03  2.54150657e+04  7.61574587e+04]
E1 = -728.4403373773591  E_coul = 201.7385844583652
cycle= 2 E= -526.701752918994  delta_E= -0.0006  |g|= 0.0337  |ddm|= 0.0392
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0672557
diis-c [-0.00268824  0.07374665  0.92625335]
  HOMO = -0.574343436107957  LUMO = 1.02550047384724
  mo_energy =
[-1.18567417e+02 -1.23006004e+01 -9.55323979e+00 -9.55323979e+00
 -9.55323979e+00 -1.24804206e+00 -5.74343436e-01 -5.74343436e-01
 -5.74343436e-01  1.02550047e+00  1.02550047e+00  1.02550047e+00
  7.26664735e+00  7.26664735e+00  7.26664735e+00  9.26498913e+00
  3.33666741e+01  3.33666741e+01  3.33666741e+01  1.02734959e+02
  1.28930846e+02  1.28930846e+02  1.28930846e+02  4.83278842e+02
  4.83278842e+02  4.83278842e+02  5.85051403e+02  1.33511111e+03
  1.33511111e+03  1.33511111e+03  2.65389067e+03  3.02934006e+03
  3.02934006e+03  3.02934006e+03  6.64977161e+03  6.64977161e+03
  6.64977161e+03  9.05950646e+03  2.54151327e+04  7.61575259e+04]
E1 = -728.3343002062909  E_coul = 201.63251190436165
cycle= 3 E= -526.701788301929  delta_E= -3.54e-05  |g|= 0.00487  |ddm|= 0.0104
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0105691
diis-c [-4.84050526e-07 -1.15787557e-03  1.31020917e-01  8.70136958e-01]
  HOMO = -0.575270653858782  LUMO = 1.02481160098145
  mo_energy =
[-1.18575044e+02 -1.23046769e+01 -9.55759559e+00 -9.55759559e+00
 -9.55759559e+00 -1.24916178e+00 -5.75270654e-01 -5.75270654e-01
 -5.75270654e-01  1.02481160e+00  1.02481160e+00  1.02481160e+00
  7.26412793e+00  7.26412793e+00  7.26412793e+00  9.26193256e+00
  3.33622672e+01  3.33622672e+01  3.33622672e+01  1.02728788e+02
  1.28924613e+02  1.28924613e+02  1.28924613e+02  4.83271312e+02
  4.83271312e+02  4.83271312e+02  5.85043552e+02  1.33510306e+03
  1.33510306e+03  1.33510306e+03  2.65388204e+03  3.02933166e+03
  3.02933166e+03  3.02933166e+03  6.64976285e+03  6.64976285e+03
  6.64976285e+03  9.05949750e+03  2.54151235e+04  7.61575167e+04]
E1 = -728.3487054263335  E_coul = 201.64691626141024
cycle= 4 E= -526.701789164923  delta_E= -8.63e-07  |g|= 6.4e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000131032
diis-c [-1.40498348e-09  6.69046105e-05 -9.23202023e-03 -7.25397829e-02
  1.08170490e+00]
  HOMO = -0.57525807867061  LUMO = 1.02482096533005
  mo_energy =
[-1.18575050e+02 -1.23046476e+01 -9.55757869e+00 -9.55757869e+00
 -9.55757869e+00 -1.24914155e+00 -5.75258079e-01 -5.75258079e-01
 -5.75258079e-01  1.02482097e+00  1.02482097e+00  1.02482097e+00
  7.26414892e+00  7.26414892e+00  7.26414892e+00  9.26196947e+00
  3.33622828e+01  3.33622828e+01  3.33622828e+01  1.02728799e+02
  1.28924619e+02  1.28924619e+02  1.28924619e+02  4.83271306e+02
  4.83271306e+02  4.83271306e+02  5.85043540e+02  1.33510304e+03
  1.33510304e+03  1.33510304e+03  2.65388201e+03  3.02933163e+03
  3.02933163e+03  3.02933163e+03  6.64976281e+03  6.64976281e+03
  6.64976281e+03  9.05949746e+03  2.54151235e+04  7.61575166e+04]
E1 = -728.3487084019058  E_coul = 201.64691923684526
cycle= 5 E= -526.701789165061  delta_E= -1.37e-10  |g|= 8.06e-06  |ddm|= 2.75e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3487084019058  E_coul = 201.64691923684526
  HOMO = -0.57526164489245  LUMO = 1.02481835878572
  mo_energy =
[-1.18575068e+02 -1.23046602e+01 -9.55759194e+00 -9.55759194e+00
 -9.55759194e+00 -1.24914592e+00 -5.75261645e-01 -5.75261645e-01
 -5.75261645e-01  1.02481836e+00  1.02481836e+00  1.02481836e+00
  7.26414026e+00  7.26414026e+00  7.26414026e+00  9.26195942e+00
  3.33622698e+01  3.33622698e+01  3.33622698e+01  1.02728783e+02
  1.28924603e+02  1.28924603e+02  1.28924603e+02  4.83271289e+02
  4.83271289e+02  4.83271289e+02  5.85043522e+02  1.33510302e+03
  1.33510302e+03  1.33510302e+03  2.65388199e+03  3.02933161e+03
  3.02933161e+03  3.02933161e+03  6.64976279e+03  6.64976279e+03
  6.64976279e+03  9.05949744e+03  2.54151235e+04  7.61575166e+04]
E1 = -728.3487483420679  E_coul = 201.646959177004
Extra cycle  E= -526.701789165064  delta_E= -3.41e-12  |g|= 2.39e-06  |ddm|= 4.14e-06
    CPU time for scf_cycle      7.49 sec, wall time      0.55 sec
exp = [2.61826564e+04 7.61752072e+03 3.61735144e+03 1.59780084e+03
 3.82847438e+02 1.08326095e+02 3.55722770e+01 7.77423198e+00
 3.04940166e+00 3.98024527e-01 1.36278339e+03 6.64743854e+02
 3.00953372e+02 3.14034843e+02 6.16286136e+01 7.33153274e+00
 2.02366668e+01 7.74027886e-01 2.79878298e+00 2.24333933e-01]
E = -526.7017891650639
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:57:27 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6564075        1
[INPUT] 0    0    [1    /1   ]  7617.52071992        1
[INPUT] 0    0    [1    /1   ]  3617.3514443         1
[INPUT] 0    0    [1    /1   ]  1597.80083972        1
[INPUT] 0    0    [1    /1   ]  382.847437557        1
[INPUT] 0    0    [1    /1   ]  108.326095277        1
[INPUT] 0    0    [1    /1   ]  35.5722770215        1
[INPUT] 0    0    [1    /1   ]  7.7742319751         1
[INPUT] 0    0    [1    /1   ]  3.04940166287        1
[INPUT] 0    0    [1    /1   ]  0.398024526782       1
[INPUT] 1    0    [1    /1   ]  1362.78339114        1
[INPUT] 1    0    [1    /1   ]  664.743853599        1
[INPUT] 1    0    [1    /1   ]  300.953372482        1
[INPUT] 1    0    [1    /1   ]  314.034842682        1
[INPUT] 1    0    [1    /1   ]  61.6286136226        1
[INPUT] 1    0    [1    /1   ]  7.33153273645        1
[INPUT] 1    0    [1    /1   ]  20.2366668221        1
[INPUT] 1    0    [1    /1   ]  0.774027886187       1
[INPUT] 1    0    [1    /1   ]  2.79878298092        1
[INPUT] 1    0    [1    /1   ]  0.224333932953       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.656407455543, 1.0]], [0, [7617.520719915336, 1.0]], [0, [3617.3514443040062, 1.0]], [0, [1597.800839721844, 1.0]], [0, [382.8474375571105, 1.0]], [0, [108.32609527735431, 1.0]], [0, [35.57227702154802, 1.0]], [0, [7.7742319751047155, 1.0]], [0, [3.049401662874749, 1.0]], [0, [0.39802452678195693, 1.0]], [1, [1362.7833911355822, 1.0]], [1, [664.7438535988807, 1.0]], [1, [300.9533724819555, 1.0]], [1, [314.0348426820996, 1.0]], [1, [61.628613622573766, 1.0]], [1, [7.331532736453099, 1.0]], [1, [20.236666822094314, 1.0]], [1, [0.7740278861871179, 1.0]], [1, [2.798782980915651, 1.0]], [1, [0.22433393295289808, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65640746]
bas 1, expnt(s) = [7617.52071992]
bas 2, expnt(s) = [3617.3514443]
bas 3, expnt(s) = [1597.80083972]
bas 4, expnt(s) = [382.84743756]
bas 5, expnt(s) = [108.32609528]
bas 6, expnt(s) = [35.57227702]
bas 7, expnt(s) = [7.77423198]
bas 8, expnt(s) = [3.04940166]
bas 9, expnt(s) = [0.39802453]
bas 10, expnt(s) = [1362.78339114]
bas 11, expnt(s) = [664.7438536]
bas 12, expnt(s) = [300.95337248]
bas 13, expnt(s) = [314.03484268]
bas 14, expnt(s) = [61.62861362]
bas 15, expnt(s) = [7.33153274]
bas 16, expnt(s) = [20.23666682]
bas 17, expnt(s) = [0.77402789]
bas 18, expnt(s) = [2.79878298]
bas 19, expnt(s) = [0.22433393]
CPU time:       828.13
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826564e+04 5.20026295e+03 7.61752072e+03 2.06003812e+03
 3.61735144e+03 1.17844157e+03 1.59780084e+03 6.38494276e+02
 3.82847438e+02 2.18667547e+02 1.08326095e+02 8.48330030e+01
 3.55722770e+01 3.68000809e+01 7.77423198e+00 1.17627305e+01
 3.04940166e+00 5.83009993e+00 3.98024527e-01 1.26603992e+00
 1.36278339e+03 2.41556057e+04 6.64743854e+02 9.84696299e+03
 3.00953372e+02 3.65686064e+03 3.14034843e+02 3.85661857e+03
 6.16286136e+01 5.03746904e+02 7.33153274e+00 3.51947484e+01
 2.02366668e+01 1.25215508e+02 7.74027886e-01 2.11802046e+00
 2.79878298e+00 1.05607782e+01 2.24333933e-01 4.50404899e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982971769275434
cond(S) = 102332.78079741853
E1 = -729.3745923080807  E_coul = 203.12174571950368
init E= -526.252846588577
    CPU time for initialize scf      7.31 sec, wall time      0.36 sec
  HOMO = -0.556934394370506  LUMO = 1.03620560245936
  mo_energy =
[-1.18331448e+02 -1.22079922e+01 -9.45155555e+00 -9.45155555e+00
 -9.45155555e+00 -1.22576803e+00 -5.56934394e-01 -5.56934394e-01
 -5.56934394e-01  1.03620560e+00  1.03620560e+00  1.03620560e+00
  7.32354159e+00  7.32354159e+00  7.32354159e+00  9.32868016e+00
  3.34735532e+01  3.34735532e+01  3.34735532e+01  1.02893051e+02
  1.29097634e+02  1.29097634e+02  1.29097634e+02  4.83514098e+02
  4.83514098e+02  4.83514098e+02  5.85322466e+02  1.33539913e+03
  1.33539913e+03  1.33539913e+03  2.65431090e+03  3.02969267e+03
  3.02969267e+03  3.02969267e+03  6.65023631e+03  6.65023631e+03
  6.65023631e+03  9.06004604e+03  2.54157659e+04  7.61582491e+04]
E1 = -727.9733134024877  E_coul = 201.27216094971186
cycle= 1 E= -526.701152452776  delta_E= -0.448  |g|= 0.185  |ddm|= 0.419
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.540535
diis-c [-0.29217802  1.        ]
  HOMO = -0.581118207197984  LUMO = 1.02038331718849
  mo_energy =
[-1.18626466e+02 -1.23316391e+01 -9.58559774e+00 -9.58559774e+00
 -9.58559774e+00 -1.25663258e+00 -5.81118207e-01 -5.81118207e-01
 -5.81118207e-01  1.02038332e+00  1.02038332e+00  1.02038332e+00
  7.24808281e+00  7.24808281e+00  7.24808281e+00  9.24101731e+00
  3.33336969e+01  3.33336969e+01  3.33336969e+01  1.02687164e+02
  1.28883023e+02  1.28883023e+02  1.28883023e+02  4.83220543e+02
  4.83220543e+02  4.83220543e+02  5.84990851e+02  1.33504898e+03
  1.33504898e+03  1.33504898e+03  2.65382551e+03  3.02927585e+03
  3.02927585e+03  3.02927585e+03  6.64970585e+03  6.64970585e+03
  6.64970585e+03  9.05943999e+03  2.54150657e+04  7.61574587e+04]
E1 = -728.4403373773591  E_coul = 201.7385844583652
cycle= 2 E= -526.701752918994  delta_E= -0.0006  |g|= 0.0337  |ddm|= 0.0392
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0672557
diis-c [-0.00268824  0.07374665  0.92625335]
  HOMO = -0.574343436107957  LUMO = 1.02550047384724
  mo_energy =
[-1.18567417e+02 -1.23006004e+01 -9.55323979e+00 -9.55323979e+00
 -9.55323979e+00 -1.24804206e+00 -5.74343436e-01 -5.74343436e-01
 -5.74343436e-01  1.02550047e+00  1.02550047e+00  1.02550047e+00
  7.26664735e+00  7.26664735e+00  7.26664735e+00  9.26498913e+00
  3.33666741e+01  3.33666741e+01  3.33666741e+01  1.02734959e+02
  1.28930846e+02  1.28930846e+02  1.28930846e+02  4.83278842e+02
  4.83278842e+02  4.83278842e+02  5.85051403e+02  1.33511111e+03
  1.33511111e+03  1.33511111e+03  2.65389067e+03  3.02934006e+03
  3.02934006e+03  3.02934006e+03  6.64977161e+03  6.64977161e+03
  6.64977161e+03  9.05950646e+03  2.54151327e+04  7.61575259e+04]
E1 = -728.3343002062909  E_coul = 201.63251190436165
cycle= 3 E= -526.701788301929  delta_E= -3.54e-05  |g|= 0.00487  |ddm|= 0.0104
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0105691
diis-c [-4.84050526e-07 -1.15787557e-03  1.31020917e-01  8.70136958e-01]
  HOMO = -0.575270653858782  LUMO = 1.02481160098145
  mo_energy =
[-1.18575044e+02 -1.23046769e+01 -9.55759559e+00 -9.55759559e+00
 -9.55759559e+00 -1.24916178e+00 -5.75270654e-01 -5.75270654e-01
 -5.75270654e-01  1.02481160e+00  1.02481160e+00  1.02481160e+00
  7.26412793e+00  7.26412793e+00  7.26412793e+00  9.26193256e+00
  3.33622672e+01  3.33622672e+01  3.33622672e+01  1.02728788e+02
  1.28924613e+02  1.28924613e+02  1.28924613e+02  4.83271312e+02
  4.83271312e+02  4.83271312e+02  5.85043552e+02  1.33510306e+03
  1.33510306e+03  1.33510306e+03  2.65388204e+03  3.02933166e+03
  3.02933166e+03  3.02933166e+03  6.64976285e+03  6.64976285e+03
  6.64976285e+03  9.05949750e+03  2.54151235e+04  7.61575167e+04]
E1 = -728.3487054263335  E_coul = 201.64691626141024
cycle= 4 E= -526.701789164923  delta_E= -8.63e-07  |g|= 6.4e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000131032
diis-c [-1.40498348e-09  6.69046105e-05 -9.23202023e-03 -7.25397829e-02
  1.08170490e+00]
  HOMO = -0.57525807867061  LUMO = 1.02482096533005
  mo_energy =
[-1.18575050e+02 -1.23046476e+01 -9.55757869e+00 -9.55757869e+00
 -9.55757869e+00 -1.24914155e+00 -5.75258079e-01 -5.75258079e-01
 -5.75258079e-01  1.02482097e+00  1.02482097e+00  1.02482097e+00
  7.26414892e+00  7.26414892e+00  7.26414892e+00  9.26196947e+00
  3.33622828e+01  3.33622828e+01  3.33622828e+01  1.02728799e+02
  1.28924619e+02  1.28924619e+02  1.28924619e+02  4.83271306e+02
  4.83271306e+02  4.83271306e+02  5.85043540e+02  1.33510304e+03
  1.33510304e+03  1.33510304e+03  2.65388201e+03  3.02933163e+03
  3.02933163e+03  3.02933163e+03  6.64976281e+03  6.64976281e+03
  6.64976281e+03  9.05949746e+03  2.54151235e+04  7.61575166e+04]
E1 = -728.3487084019058  E_coul = 201.64691923684526
cycle= 5 E= -526.701789165061  delta_E= -1.37e-10  |g|= 8.06e-06  |ddm|= 2.75e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3487084019058  E_coul = 201.64691923684526
  HOMO = -0.57526164489245  LUMO = 1.02481835878572
  mo_energy =
[-1.18575068e+02 -1.23046602e+01 -9.55759194e+00 -9.55759194e+00
 -9.55759194e+00 -1.24914592e+00 -5.75261645e-01 -5.75261645e-01
 -5.75261645e-01  1.02481836e+00  1.02481836e+00  1.02481836e+00
  7.26414026e+00  7.26414026e+00  7.26414026e+00  9.26195942e+00
  3.33622698e+01  3.33622698e+01  3.33622698e+01  1.02728783e+02
  1.28924603e+02  1.28924603e+02  1.28924603e+02  4.83271289e+02
  4.83271289e+02  4.83271289e+02  5.85043522e+02  1.33510302e+03
  1.33510302e+03  1.33510302e+03  2.65388199e+03  3.02933161e+03
  3.02933161e+03  3.02933161e+03  6.64976279e+03  6.64976279e+03
  6.64976279e+03  9.05949744e+03  2.54151235e+04  7.61575166e+04]
E1 = -728.3487483420679  E_coul = 201.646959177004
Extra cycle  E= -526.701789165064  delta_E= -3.41e-12  |g|= 2.39e-06  |ddm|= 4.14e-06
    CPU time for scf_cycle      7.50 sec, wall time      0.54 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102332.78079741853
E1 = -728.3487483420679  E_coul = 201.646959177004
init E= -526.701789165064
    CPU time for initialize scf     15.85 sec, wall time      0.77 sec
  HOMO = -0.575260914907208  LUMO = 1.02481889897573
  mo_energy =
[-1.18575063e+02 -1.23046573e+01 -9.55758891e+00 -9.55758891e+00
 -9.55758891e+00 -1.24914500e+00 -5.75260915e-01 -5.75260915e-01
 -5.75260915e-01  1.02481890e+00  1.02481890e+00  1.02481890e+00
  7.26414212e+00  7.26414212e+00  7.26414212e+00  9.26196172e+00
  3.33622729e+01  3.33622729e+01  3.33622729e+01  1.02728787e+02
  1.28924608e+02  1.28924608e+02  1.28924608e+02  4.83271294e+02
  4.83271294e+02  4.83271294e+02  5.85043526e+02  1.33510303e+03
  1.33510303e+03  1.33510303e+03  2.65388200e+03  3.02933162e+03
  3.02933162e+03  3.02933162e+03  6.64976280e+03  6.64976280e+03
  6.64976280e+03  9.05949744e+03  2.54151235e+04  7.61575166e+04]
E1 = -728.3487388224153  E_coul = 201.6469496573505
cycle= 1 E= -526.701789165065  delta_E= -9.09e-13  |g|= 6.17e-07  |ddm|= 9.57e-07
    CPU time for cycle= 1      0.04 sec, wall time      0.02 sec
E1 = -728.3487388224153  E_coul = 201.6469496573505
  HOMO = -0.575261076587435  LUMO = 1.02481877868472
  mo_energy =
[-1.18575064e+02 -1.23046580e+01 -9.55758963e+00 -9.55758963e+00
 -9.55758963e+00 -1.24914520e+00 -5.75261077e-01 -5.75261077e-01
 -5.75261077e-01  1.02481878e+00  1.02481878e+00  1.02481878e+00
  7.26414169e+00  7.26414169e+00  7.26414169e+00  9.26196119e+00
  3.33622721e+01  3.33622721e+01  3.33622721e+01  1.02728786e+02
  1.28924607e+02  1.28924607e+02  1.28924607e+02  4.83271292e+02
  4.83271292e+02  4.83271292e+02  5.85043525e+02  1.33510303e+03
  1.33510303e+03  1.33510303e+03  2.65388199e+03  3.02933162e+03
  3.02933162e+03  3.02933162e+03  6.64976279e+03  6.64976279e+03
  6.64976279e+03  9.05949744e+03  2.54151235e+04  7.61575166e+04]
E1 = -728.3487411524624  E_coul = 201.64695198739915
Extra cycle  E= -526.701789165063  delta_E= 1.59e-12  |g|= 1.55e-07  |ddm|= 2.24e-07
    CPU time for scf_cycle     15.98 sec, wall time      0.88 sec
exp = [2.61826564e+04 7.61752072e+03 3.61735144e+03 1.59780084e+03
 3.82847438e+02 1.08326095e+02 3.55722770e+01 7.77423198e+00
 3.04940166e+00 3.98024527e-01 1.36278339e+03 6.64743854e+02
 3.00953372e+02 3.14034843e+02 6.16286136e+01 7.33153274e+00
 2.02366668e+01 7.74027886e-01 2.79878298e+00 2.24333933e-01]
grad_E = [-1.50791990e-06  3.20444807e-06 -1.63043865e-06  6.51911340e-05
  1.10518744e-04 -1.59864122e-03  3.27489922e-04 -1.00072460e-03
  1.81553029e-03 -3.97118071e-03 -5.09611056e-07  4.97023980e-06
  2.33888583e-05  2.01663627e-05  1.32869387e-05  1.80884447e-03
 -3.55300538e-04 -5.45146122e-03 -2.98118097e-03  2.57133311e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:57:32 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6564595        1
[INPUT] 0    0    [1    /1   ]  7617.52060761        1
[INPUT] 0    0    [1    /1   ]  3617.3514992         1
[INPUT] 0    0    [1    /1   ]  1597.79851056        1
[INPUT] 0    0    [1    /1   ]  382.846839407        1
[INPUT] 0    0    [1    /1   ]  108.350110478        1
[INPUT] 0    0    [1    /1   ]  35.6423840734        1
[INPUT] 0    0    [1    /1   ]  7.82361430768        1
[INPUT] 0    0    [1    /1   ]  3.06023025471        1
[INPUT] 0    0    [1    /1   ]  0.398371350322       1
[INPUT] 1    0    [1    /1   ]  1362.78340855        1
[INPUT] 1    0    [1    /1   ]  664.743681698        1
[INPUT] 1    0    [1    /1   ]  300.952561913        1
[INPUT] 1    0    [1    /1   ]  314.034143812        1
[INPUT] 1    0    [1    /1   ]  61.6290905626        1
[INPUT] 1    0    [1    /1   ]  7.32674728712        1
[INPUT] 1    0    [1    /1   ]  20.2376821041        1
[INPUT] 1    0    [1    /1   ]  0.773101637456       1
[INPUT] 1    0    [1    /1   ]  2.80519056374        1
[INPUT] 1    0    [1    /1   ]  0.223362718369       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.656459450987, 1.0]], [0, [7617.520607610151, 1.0]], [0, [3617.3514992049227, 1.0]], [0, [1597.7985105597147, 1.0]], [0, [382.8468394065818, 1.0]], [0, [108.35011047814032, 1.0]], [0, [35.64238407339725, 1.0]], [0, [7.8236143076845055, 1.0]], [0, [3.0602302547141793, 1.0]], [0, [0.3983713503221148, 1.0]], [1, [1362.7834085536522, 1.0]], [1, [664.7436816980272, 1.0]], [1, [300.95256191343805, 1.0]], [1, [314.0341438122302, 1.0]], [1, [61.62909056262243, 1.0]], [1, [7.326747287117507, 1.0]], [1, [20.237682104103516, 1.0]], [1, [0.773101637456125, 1.0]], [1, [2.8051905637421632, 1.0]], [1, [0.22336271836919647, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65645945]
bas 1, expnt(s) = [7617.52060761]
bas 2, expnt(s) = [3617.3514992]
bas 3, expnt(s) = [1597.79851056]
bas 4, expnt(s) = [382.84683941]
bas 5, expnt(s) = [108.35011048]
bas 6, expnt(s) = [35.64238407]
bas 7, expnt(s) = [7.82361431]
bas 8, expnt(s) = [3.06023025]
bas 9, expnt(s) = [0.39837135]
bas 10, expnt(s) = [1362.78340855]
bas 11, expnt(s) = [664.7436817]
bas 12, expnt(s) = [300.95256191]
bas 13, expnt(s) = [314.03414381]
bas 14, expnt(s) = [61.62909056]
bas 15, expnt(s) = [7.32674729]
bas 16, expnt(s) = [20.2376821]
bas 17, expnt(s) = [0.77310164]
bas 18, expnt(s) = [2.80519056]
bas 19, expnt(s) = [0.22336272]
CPU time:       856.42
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826565e+04 5.20026296e+03 7.61752061e+03 2.06003810e+03
 3.61735150e+03 1.17844158e+03 1.59779851e+03 6.38493578e+02
 3.82846839e+02 2.18667291e+02 1.08350110e+02 8.48471078e+01
 3.56423841e+01 3.68544627e+01 7.82361431e+00 1.18187242e+01
 3.06023025e+00 5.84562030e+00 3.98371350e-01 1.26686722e+00
 1.36278341e+03 2.41556061e+04 6.64743682e+02 9.84695981e+03
 3.00952562e+02 3.65684833e+03 3.14034144e+02 3.85660784e+03
 6.16290906e+01 5.03751777e+02 7.32674729e+00 3.51660353e+01
 2.02376821e+01 1.25223361e+02 7.73101637e-01 2.11485275e+00
 2.80519056e+00 1.05910094e+01 2.23362718e-01 4.47968783e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.983034118510737
cond(S) = 102357.73563013438
E1 = -729.3765030316429  E_coul = 203.12333155634641
init E= -526.253171475296
    CPU time for initialize scf      1.10 sec, wall time      0.07 sec
  HOMO = -0.556914265637236  LUMO = 1.03175547685603
  mo_energy =
[-1.18331285e+02 -1.22079235e+01 -9.45141862e+00 -9.45141862e+00
 -9.45141862e+00 -1.22571681e+00 -5.56914266e-01 -5.56914266e-01
 -5.56914266e-01  1.03175548e+00  1.03175548e+00  1.03175548e+00
  7.32571416e+00  7.32571416e+00  7.32571416e+00  9.41233200e+00
  3.34797838e+01  3.34797838e+01  3.34797838e+01  1.03284386e+02
  1.29101153e+02  1.29101153e+02  1.29101153e+02  4.83517340e+02
  4.83517340e+02  4.83517340e+02  5.85875716e+02  1.33540067e+03
  1.33540067e+03  1.33540067e+03  2.65485447e+03  3.02969198e+03
  3.02969198e+03  3.02969198e+03  6.65023397e+03  6.65023397e+03
  6.65023397e+03  9.06055143e+03  2.54162436e+04  7.61586935e+04]
E1 = -727.9636784479815  E_coul = 201.26247154358396
cycle= 1 E= -526.701206904398  delta_E= -0.448  |g|= 0.185  |ddm|= 0.417
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.54052
diis-c [-0.29216137  1.        ]
  HOMO = -0.581520768156663  LUMO = 1.01566261266893
  mo_energy =
[-1.18626927e+02 -1.23323785e+01 -9.58625286e+00 -9.58625286e+00
 -9.58625286e+00 -1.25713441e+00 -5.81520768e-01 -5.81520768e-01
 -5.81520768e-01  1.01566261e+00  1.01566261e+00  1.01566261e+00
  7.24949029e+00  7.24949029e+00  7.24949029e+00  9.32352635e+00
  3.33391998e+01  3.33391998e+01  3.33391998e+01  1.03077558e+02
  1.28885843e+02  1.28885843e+02  1.28885843e+02  4.83223145e+02
  4.83223145e+02  4.83223145e+02  5.85543570e+02  1.33505002e+03
  1.33505002e+03  1.33505002e+03  2.65436864e+03  3.02927467e+03
  3.02927467e+03  3.02927467e+03  6.64970308e+03  6.64970308e+03
  6.64970308e+03  9.05994498e+03  2.54155431e+04  7.61579028e+04]
E1 = -728.4329534928643  E_coul = 201.73114271932877
cycle= 2 E= -526.701810773535  delta_E= -0.000604  |g|= 0.0338  |ddm|= 0.0393
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0674702
diis-c [-0.002705    0.07397607  0.92602393]
  HOMO = -0.57470282192097  LUMO = 1.02079973344807
  mo_energy =
[-1.18567683e+02 -1.23011903e+01 -9.55374238e+00 -9.55374238e+00
 -9.55374238e+00 -1.24848628e+00 -5.74702822e-01 -5.74702822e-01
 -5.74702822e-01  1.02079973e+00  1.02079973e+00  1.02079973e+00
  7.26817010e+00  7.26817010e+00  7.26817010e+00  9.34770444e+00
  3.33723258e+01  3.33723258e+01  3.33723258e+01  1.03125548e+02
  1.28933842e+02  1.28933842e+02  1.28933842e+02  4.83281636e+02
  4.83281636e+02  4.83281636e+02  5.85604316e+02  1.33511235e+03
  1.33511235e+03  1.33511235e+03  2.65443401e+03  3.02933908e+03
  3.02933908e+03  3.02933908e+03  6.64976904e+03  6.64976904e+03
  6.64976904e+03  9.06001166e+03  2.54156102e+04  7.61579702e+04]
E1 = -728.3263286887192  E_coul = 201.62448221705364
cycle= 3 E= -526.701846471665  delta_E= -3.57e-05  |g|= 0.00488  |ddm|= 0.0104
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0105946
diis-c [-4.77876671e-07 -1.15446219e-03  1.30964222e-01  8.70190240e-01]
  HOMO = -0.575636637839903  LUMO = 1.02010747734895
  mo_energy =
[-1.18575335e+02 -1.23052838e+01 -9.55811533e+00 -9.55811533e+00
 -9.55811533e+00 -1.24961520e+00 -5.75636638e-01 -5.75636638e-01
 -5.75636638e-01  1.02010748e+00  1.02010748e+00  1.02010748e+00
  7.26563574e+00  7.26563574e+00  7.26563574e+00  9.34462078e+00
  3.33679017e+01  3.33679017e+01  3.33679017e+01  1.03119352e+02
  1.28927588e+02  1.28927588e+02  1.28927588e+02  4.83274082e+02
  4.83274082e+02  4.83274082e+02  5.85596441e+02  1.33510427e+03
  1.33510427e+03  1.33510427e+03  2.65442536e+03  3.02933065e+03
  3.02933065e+03  3.02933065e+03  6.64976026e+03  6.64976026e+03
  6.64976026e+03  9.06000268e+03  2.54156011e+04  7.61579610e+04]
E1 = -728.340799444657  E_coul = 201.6389521034435
cycle= 4 E= -526.701847341214  delta_E= -8.7e-07  |g|= 6.34e-05  |ddm|= 0.00134
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000130394
diis-c [-1.38740094e-09  6.67561004e-05 -9.20816222e-03 -7.23456225e-02
  1.08148703e+00]
  HOMO = -0.575624340883008  LUMO = 1.02011661239848
  mo_energy =
[-1.18575341e+02 -1.23052551e+01 -9.55809886e+00 -9.55809886e+00
 -9.55809886e+00 -1.24959538e+00 -5.75624341e-01 -5.75624341e-01
 -5.75624341e-01  1.02011661e+00  1.02011661e+00  1.02011661e+00
  7.26565626e+00  7.26565626e+00  7.26565626e+00  9.34465702e+00
  3.33679170e+01  3.33679170e+01  3.33679170e+01  1.03119363e+02
  1.28927594e+02  1.28927594e+02  1.28927594e+02  4.83274076e+02
  4.83274076e+02  4.83274076e+02  5.85596428e+02  1.33510425e+03
  1.33510425e+03  1.33510425e+03  2.65442532e+03  3.02933063e+03
  3.02933063e+03  3.02933063e+03  6.64976022e+03  6.64976022e+03
  6.64976022e+03  9.06000263e+03  2.54156010e+04  7.61579609e+04]
E1 = -728.3408026390156  E_coul = 201.63895529767075
cycle= 5 E= -526.701847341345  delta_E= -1.31e-10  |g|= 8.01e-06  |ddm|= 2.68e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3408026390156  E_coul = 201.63895529767075
  HOMO = -0.575627891320859  LUMO = 1.02011402239094
  mo_energy =
[-1.18575359e+02 -1.23052676e+01 -9.55811203e+00 -9.55811203e+00
 -9.55811203e+00 -1.24959973e+00 -5.75627891e-01 -5.75627891e-01
 -5.75627891e-01  1.02011402e+00  1.02011402e+00  1.02011402e+00
  7.26564764e+00  7.26564764e+00  7.26564764e+00  9.34464700e+00
  3.33679040e+01  3.33679040e+01  3.33679040e+01  1.03119347e+02
  1.28927578e+02  1.28927578e+02  1.28927578e+02  4.83274058e+02
  4.83274058e+02  4.83274058e+02  5.85596410e+02  1.33510423e+03
  1.33510423e+03  1.33510423e+03  2.65442530e+03  3.02933061e+03
  3.02933061e+03  3.02933061e+03  6.64976020e+03  6.64976020e+03
  6.64976020e+03  9.06000261e+03  2.54156010e+04  7.61579609e+04]
E1 = -728.3408423921381  E_coul = 201.63899505079098
Extra cycle  E= -526.701847341347  delta_E= -2.39e-12  |g|= 2.38e-06  |ddm|= 4.12e-06
    CPU time for scf_cycle      1.29 sec, wall time      0.25 sec
exp = [2.61826565e+04 7.61752061e+03 3.61735150e+03 1.59779851e+03
 3.82846839e+02 1.08350110e+02 3.56423841e+01 7.82361431e+00
 3.06023025e+00 3.98371350e-01 1.36278341e+03 6.64743682e+02
 3.00952562e+02 3.14034144e+02 6.16290906e+01 7.32674729e+00
 2.02376821e+01 7.73101637e-01 2.80519056e+00 2.23362718e-01]
E = -526.7018473413472
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:57:32 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6564595        1
[INPUT] 0    0    [1    /1   ]  7617.52060761        1
[INPUT] 0    0    [1    /1   ]  3617.3514992         1
[INPUT] 0    0    [1    /1   ]  1597.79851056        1
[INPUT] 0    0    [1    /1   ]  382.846839407        1
[INPUT] 0    0    [1    /1   ]  108.350110478        1
[INPUT] 0    0    [1    /1   ]  35.6423840734        1
[INPUT] 0    0    [1    /1   ]  7.82361430768        1
[INPUT] 0    0    [1    /1   ]  3.06023025471        1
[INPUT] 0    0    [1    /1   ]  0.398371350322       1
[INPUT] 1    0    [1    /1   ]  1362.78340855        1
[INPUT] 1    0    [1    /1   ]  664.743681698        1
[INPUT] 1    0    [1    /1   ]  300.952561913        1
[INPUT] 1    0    [1    /1   ]  314.034143812        1
[INPUT] 1    0    [1    /1   ]  61.6290905626        1
[INPUT] 1    0    [1    /1   ]  7.32674728712        1
[INPUT] 1    0    [1    /1   ]  20.2376821041        1
[INPUT] 1    0    [1    /1   ]  0.773101637456       1
[INPUT] 1    0    [1    /1   ]  2.80519056374        1
[INPUT] 1    0    [1    /1   ]  0.223362718369       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.656459450987, 1.0]], [0, [7617.520607610151, 1.0]], [0, [3617.3514992049227, 1.0]], [0, [1597.7985105597147, 1.0]], [0, [382.8468394065818, 1.0]], [0, [108.35011047814032, 1.0]], [0, [35.64238407339725, 1.0]], [0, [7.8236143076845055, 1.0]], [0, [3.0602302547141793, 1.0]], [0, [0.3983713503221148, 1.0]], [1, [1362.7834085536522, 1.0]], [1, [664.7436816980272, 1.0]], [1, [300.95256191343805, 1.0]], [1, [314.0341438122302, 1.0]], [1, [61.62909056262243, 1.0]], [1, [7.326747287117507, 1.0]], [1, [20.237682104103516, 1.0]], [1, [0.773101637456125, 1.0]], [1, [2.8051905637421632, 1.0]], [1, [0.22336271836919647, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65645945]
bas 1, expnt(s) = [7617.52060761]
bas 2, expnt(s) = [3617.3514992]
bas 3, expnt(s) = [1597.79851056]
bas 4, expnt(s) = [382.84683941]
bas 5, expnt(s) = [108.35011048]
bas 6, expnt(s) = [35.64238407]
bas 7, expnt(s) = [7.82361431]
bas 8, expnt(s) = [3.06023025]
bas 9, expnt(s) = [0.39837135]
bas 10, expnt(s) = [1362.78340855]
bas 11, expnt(s) = [664.7436817]
bas 12, expnt(s) = [300.95256191]
bas 13, expnt(s) = [314.03414381]
bas 14, expnt(s) = [61.62909056]
bas 15, expnt(s) = [7.32674729]
bas 16, expnt(s) = [20.2376821]
bas 17, expnt(s) = [0.77310164]
bas 18, expnt(s) = [2.80519056]
bas 19, expnt(s) = [0.22336272]
CPU time:       857.82
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826565e+04 5.20026296e+03 7.61752061e+03 2.06003810e+03
 3.61735150e+03 1.17844158e+03 1.59779851e+03 6.38493578e+02
 3.82846839e+02 2.18667291e+02 1.08350110e+02 8.48471078e+01
 3.56423841e+01 3.68544627e+01 7.82361431e+00 1.18187242e+01
 3.06023025e+00 5.84562030e+00 3.98371350e-01 1.26686722e+00
 1.36278341e+03 2.41556061e+04 6.64743682e+02 9.84695981e+03
 3.00952562e+02 3.65684833e+03 3.14034144e+02 3.85660784e+03
 6.16290906e+01 5.03751777e+02 7.32674729e+00 3.51660353e+01
 2.02376821e+01 1.25223361e+02 7.73101637e-01 2.11485275e+00
 2.80519056e+00 1.05910094e+01 2.23362718e-01 4.47968783e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.983034118510737
cond(S) = 102357.73563013438
E1 = -729.3765030316429  E_coul = 203.12333155634641
init E= -526.253171475296
    CPU time for initialize scf      0.63 sec, wall time      0.05 sec
  HOMO = -0.556914265637236  LUMO = 1.03175547685603
  mo_energy =
[-1.18331285e+02 -1.22079235e+01 -9.45141862e+00 -9.45141862e+00
 -9.45141862e+00 -1.22571681e+00 -5.56914266e-01 -5.56914266e-01
 -5.56914266e-01  1.03175548e+00  1.03175548e+00  1.03175548e+00
  7.32571416e+00  7.32571416e+00  7.32571416e+00  9.41233200e+00
  3.34797838e+01  3.34797838e+01  3.34797838e+01  1.03284386e+02
  1.29101153e+02  1.29101153e+02  1.29101153e+02  4.83517340e+02
  4.83517340e+02  4.83517340e+02  5.85875716e+02  1.33540067e+03
  1.33540067e+03  1.33540067e+03  2.65485447e+03  3.02969198e+03
  3.02969198e+03  3.02969198e+03  6.65023397e+03  6.65023397e+03
  6.65023397e+03  9.06055143e+03  2.54162436e+04  7.61586935e+04]
E1 = -727.9636784479815  E_coul = 201.26247154358396
cycle= 1 E= -526.701206904398  delta_E= -0.448  |g|= 0.185  |ddm|= 0.417
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.54052
diis-c [-0.29216137  1.        ]
  HOMO = -0.581520768156663  LUMO = 1.01566261266893
  mo_energy =
[-1.18626927e+02 -1.23323785e+01 -9.58625286e+00 -9.58625286e+00
 -9.58625286e+00 -1.25713441e+00 -5.81520768e-01 -5.81520768e-01
 -5.81520768e-01  1.01566261e+00  1.01566261e+00  1.01566261e+00
  7.24949029e+00  7.24949029e+00  7.24949029e+00  9.32352635e+00
  3.33391998e+01  3.33391998e+01  3.33391998e+01  1.03077558e+02
  1.28885843e+02  1.28885843e+02  1.28885843e+02  4.83223145e+02
  4.83223145e+02  4.83223145e+02  5.85543570e+02  1.33505002e+03
  1.33505002e+03  1.33505002e+03  2.65436864e+03  3.02927467e+03
  3.02927467e+03  3.02927467e+03  6.64970308e+03  6.64970308e+03
  6.64970308e+03  9.05994498e+03  2.54155431e+04  7.61579028e+04]
E1 = -728.4329534928643  E_coul = 201.73114271932877
cycle= 2 E= -526.701810773535  delta_E= -0.000604  |g|= 0.0338  |ddm|= 0.0393
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0674702
diis-c [-0.002705    0.07397607  0.92602393]
  HOMO = -0.57470282192097  LUMO = 1.02079973344807
  mo_energy =
[-1.18567683e+02 -1.23011903e+01 -9.55374238e+00 -9.55374238e+00
 -9.55374238e+00 -1.24848628e+00 -5.74702822e-01 -5.74702822e-01
 -5.74702822e-01  1.02079973e+00  1.02079973e+00  1.02079973e+00
  7.26817010e+00  7.26817010e+00  7.26817010e+00  9.34770444e+00
  3.33723258e+01  3.33723258e+01  3.33723258e+01  1.03125548e+02
  1.28933842e+02  1.28933842e+02  1.28933842e+02  4.83281636e+02
  4.83281636e+02  4.83281636e+02  5.85604316e+02  1.33511235e+03
  1.33511235e+03  1.33511235e+03  2.65443401e+03  3.02933908e+03
  3.02933908e+03  3.02933908e+03  6.64976904e+03  6.64976904e+03
  6.64976904e+03  9.06001166e+03  2.54156102e+04  7.61579702e+04]
E1 = -728.3263286887192  E_coul = 201.62448221705364
cycle= 3 E= -526.701846471665  delta_E= -3.57e-05  |g|= 0.00488  |ddm|= 0.0104
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0105946
diis-c [-4.77876671e-07 -1.15446219e-03  1.30964222e-01  8.70190240e-01]
  HOMO = -0.575636637839903  LUMO = 1.02010747734895
  mo_energy =
[-1.18575335e+02 -1.23052838e+01 -9.55811533e+00 -9.55811533e+00
 -9.55811533e+00 -1.24961520e+00 -5.75636638e-01 -5.75636638e-01
 -5.75636638e-01  1.02010748e+00  1.02010748e+00  1.02010748e+00
  7.26563574e+00  7.26563574e+00  7.26563574e+00  9.34462078e+00
  3.33679017e+01  3.33679017e+01  3.33679017e+01  1.03119352e+02
  1.28927588e+02  1.28927588e+02  1.28927588e+02  4.83274082e+02
  4.83274082e+02  4.83274082e+02  5.85596441e+02  1.33510427e+03
  1.33510427e+03  1.33510427e+03  2.65442536e+03  3.02933065e+03
  3.02933065e+03  3.02933065e+03  6.64976026e+03  6.64976026e+03
  6.64976026e+03  9.06000268e+03  2.54156011e+04  7.61579610e+04]
E1 = -728.340799444657  E_coul = 201.6389521034435
cycle= 4 E= -526.701847341214  delta_E= -8.7e-07  |g|= 6.34e-05  |ddm|= 0.00134
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000130394
diis-c [-1.38740094e-09  6.67561004e-05 -9.20816222e-03 -7.23456225e-02
  1.08148703e+00]
  HOMO = -0.575624340883008  LUMO = 1.02011661239848
  mo_energy =
[-1.18575341e+02 -1.23052551e+01 -9.55809886e+00 -9.55809886e+00
 -9.55809886e+00 -1.24959538e+00 -5.75624341e-01 -5.75624341e-01
 -5.75624341e-01  1.02011661e+00  1.02011661e+00  1.02011661e+00
  7.26565626e+00  7.26565626e+00  7.26565626e+00  9.34465702e+00
  3.33679170e+01  3.33679170e+01  3.33679170e+01  1.03119363e+02
  1.28927594e+02  1.28927594e+02  1.28927594e+02  4.83274076e+02
  4.83274076e+02  4.83274076e+02  5.85596428e+02  1.33510425e+03
  1.33510425e+03  1.33510425e+03  2.65442532e+03  3.02933063e+03
  3.02933063e+03  3.02933063e+03  6.64976022e+03  6.64976022e+03
  6.64976022e+03  9.06000263e+03  2.54156010e+04  7.61579609e+04]
E1 = -728.3408026390156  E_coul = 201.63895529767075
cycle= 5 E= -526.701847341345  delta_E= -1.31e-10  |g|= 8.01e-06  |ddm|= 2.68e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3408026390156  E_coul = 201.63895529767075
  HOMO = -0.575627891320859  LUMO = 1.02011402239094
  mo_energy =
[-1.18575359e+02 -1.23052676e+01 -9.55811203e+00 -9.55811203e+00
 -9.55811203e+00 -1.24959973e+00 -5.75627891e-01 -5.75627891e-01
 -5.75627891e-01  1.02011402e+00  1.02011402e+00  1.02011402e+00
  7.26564764e+00  7.26564764e+00  7.26564764e+00  9.34464700e+00
  3.33679040e+01  3.33679040e+01  3.33679040e+01  1.03119347e+02
  1.28927578e+02  1.28927578e+02  1.28927578e+02  4.83274058e+02
  4.83274058e+02  4.83274058e+02  5.85596410e+02  1.33510423e+03
  1.33510423e+03  1.33510423e+03  2.65442530e+03  3.02933061e+03
  3.02933061e+03  3.02933061e+03  6.64976020e+03  6.64976020e+03
  6.64976020e+03  9.06000261e+03  2.54156010e+04  7.61579609e+04]
E1 = -728.3408423921381  E_coul = 201.63899505079098
Extra cycle  E= -526.701847341347  delta_E= -2.39e-12  |g|= 2.38e-06  |ddm|= 4.12e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102357.73563013438
E1 = -728.3408423921381  E_coul = 201.63899505079098
init E= -526.701847341347
    CPU time for initialize scf      3.78 sec, wall time      0.20 sec
  HOMO = -0.575627163646753  LUMO = 1.02011455967322
  mo_energy =
[-1.18575354e+02 -1.23052647e+01 -9.55810902e+00 -9.55810902e+00
 -9.55810902e+00 -1.24959882e+00 -5.75627164e-01 -5.75627164e-01
 -5.75627164e-01  1.02011456e+00  1.02011456e+00  1.02011456e+00
  7.26564949e+00  7.26564949e+00  7.26564949e+00  9.34464930e+00
  3.33679071e+01  3.33679071e+01  3.33679071e+01  1.03119351e+02
  1.28927582e+02  1.28927582e+02  1.28927582e+02  4.83274063e+02
  4.83274063e+02  4.83274063e+02  5.85596415e+02  1.33510424e+03
  1.33510424e+03  1.33510424e+03  2.65442531e+03  3.02933062e+03
  3.02933062e+03  3.02933062e+03  6.64976020e+03  6.64976020e+03
  6.64976020e+03  9.06000262e+03  2.54156010e+04  7.61579609e+04]
E1 = -728.3408329056697  E_coul = 201.6389855643224
cycle= 1 E= -526.701847341347  delta_E= -1.14e-13  |g|= 6.14e-07  |ddm|= 9.52e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3408329056697  E_coul = 201.6389855643224
  HOMO = -0.575627325077707  LUMO = 1.02011443983511
  mo_energy =
[-1.18575355e+02 -1.23052654e+01 -9.55810973e+00 -9.55810973e+00
 -9.55810973e+00 -1.24959902e+00 -5.75627325e-01 -5.75627325e-01
 -5.75627325e-01  1.02011444e+00  1.02011444e+00  1.02011444e+00
  7.26564906e+00  7.26564906e+00  7.26564906e+00  9.34464877e+00
  3.33679063e+01  3.33679063e+01  3.33679063e+01  1.03119350e+02
  1.28927581e+02  1.28927581e+02  1.28927581e+02  4.83274062e+02
  4.83274062e+02  4.83274062e+02  5.85596414e+02  1.33510424e+03
  1.33510424e+03  1.33510424e+03  2.65442531e+03  3.02933061e+03
  3.02933061e+03  3.02933061e+03  6.64976020e+03  6.64976020e+03
  6.64976020e+03  9.06000262e+03  2.54156010e+04  7.61579609e+04]
E1 = -728.3408352293574  E_coul = 201.63898788800967
Extra cycle  E= -526.701847341348  delta_E= -4.55e-13  |g|= 1.55e-07  |ddm|= 2.24e-07
    CPU time for scf_cycle      3.89 sec, wall time      0.31 sec
exp = [2.61826565e+04 7.61752061e+03 3.61735150e+03 1.59779851e+03
 3.82846839e+02 1.08350110e+02 3.56423841e+01 7.82361431e+00
 3.06023025e+00 3.98371350e-01 1.36278341e+03 6.64743682e+02
 3.00952562e+02 3.14034144e+02 6.16290906e+01 7.32674729e+00
 2.02376821e+01 7.73101637e-01 2.80519056e+00 2.23362718e-01]
grad_E = [-1.50707133e-06  3.19486808e-06 -1.63520386e-06  6.48060029e-05
  1.24139163e-04 -1.72876909e-03  6.84612579e-04 -4.50954190e-04
  6.87359340e-04 -1.24649263e-03 -5.05952213e-07  5.02035151e-06
  2.36958368e-05  2.04295873e-05 -2.58354286e-05  3.03889447e-04
  2.91784787e-05 -1.51785138e-03 -9.06531932e-04  7.10620678e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:57:36 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.656458         1
[INPUT] 0    0    [1    /1   ]  7617.52061067        1
[INPUT] 0    0    [1    /1   ]  3617.35149768        1
[INPUT] 0    0    [1    /1   ]  1597.79857435        1
[INPUT] 0    0    [1    /1   ]  382.846812113        1
[INPUT] 0    0    [1    /1   ]  108.34970104         1
[INPUT] 0    0    [1    /1   ]  35.6392211873        1
[INPUT] 0    0    [1    /1   ]  7.84774102824        1
[INPUT] 0    0    [1    /1   ]  3.06451607218        1
[INPUT] 0    0    [1    /1   ]  0.398522609457       1
[INPUT] 1    0    [1    /1   ]  1362.78340808        1
[INPUT] 1    0    [1    /1   ]  664.743686313        1
[INPUT] 1    0    [1    /1   ]  300.952583621        1
[INPUT] 1    0    [1    /1   ]  314.034162529        1
[INPUT] 1    0    [1    /1   ]  61.6291015583        1
[INPUT] 1    0    [1    /1   ]  7.32561551524        1
[INPUT] 1    0    [1    /1   ]  20.2376404229        1
[INPUT] 1    0    [1    /1   ]  0.772780975367       1
[INPUT] 1    0    [1    /1   ]  2.80834121825        1
[INPUT] 1    0    [1    /1   ]  0.222983621685       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.65645803854, 1.0]], [0, [7617.520610668126, 1.0]], [0, [3617.351497681676, 1.0]], [0, [1597.7985743501763, 1.0]], [0, [382.8468121129885, 1.0]], [0, [108.34970104030887, 1.0]], [0, [35.63922118733279, 1.0]], [0, [7.847741028235434, 1.0]], [0, [3.06451607218019, 1.0]], [0, [0.3985226094566921, 1.0]], [1, [1362.783408078883, 1.0]], [1, [664.7436863130636, 1.0]], [1, [300.95258362051425, 1.0]], [1, [314.03416252917077, 1.0]], [1, [61.629101558296405, 1.0]], [1, [7.325615515244813, 1.0]], [1, [20.23764042288289, 1.0]], [1, [0.7727809753671219, 1.0]], [1, [2.8083412182492524, 1.0]], [1, [0.22298362168490132, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65645804]
bas 1, expnt(s) = [7617.52061067]
bas 2, expnt(s) = [3617.35149768]
bas 3, expnt(s) = [1597.79857435]
bas 4, expnt(s) = [382.84681211]
bas 5, expnt(s) = [108.34970104]
bas 6, expnt(s) = [35.63922119]
bas 7, expnt(s) = [7.84774103]
bas 8, expnt(s) = [3.06451607]
bas 9, expnt(s) = [0.39852261]
bas 10, expnt(s) = [1362.78340808]
bas 11, expnt(s) = [664.74368631]
bas 12, expnt(s) = [300.95258362]
bas 13, expnt(s) = [314.03416253]
bas 14, expnt(s) = [61.62910156]
bas 15, expnt(s) = [7.32561552]
bas 16, expnt(s) = [20.23764042]
bas 17, expnt(s) = [0.77278098]
bas 18, expnt(s) = [2.80834122]
bas 19, expnt(s) = [0.22298362]
CPU time:       867.55
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826565e+04 5.20026296e+03 7.61752061e+03 2.06003810e+03
 3.61735150e+03 1.17844158e+03 1.59779857e+03 6.38493597e+02
 3.82846812e+02 2.18667279e+02 1.08349701e+02 8.48468673e+01
 3.56392212e+01 3.68520098e+01 7.84774103e+00 1.18460489e+01
 3.06451607e+00 5.85175927e+00 3.98522609e-01 1.26722796e+00
 1.36278341e+03 2.41556061e+04 6.64743686e+02 9.84695989e+03
 3.00952584e+02 3.65684866e+03 3.14034163e+02 3.85660813e+03
 6.16291016e+01 5.03751890e+02 7.32561552e+00 3.51592453e+01
 2.02376404e+01 1.25223038e+02 7.72780975e-01 2.11375632e+00
 2.80834122e+00 1.06058806e+01 2.22983622e-01 4.47018605e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.983052418325883
cond(S) = 102367.65929209524
E1 = -729.3774264682061  E_coul = 203.1239472630614
init E= -526.253479205145
    CPU time for initialize scf      0.69 sec, wall time      0.06 sec
  HOMO = -0.556905594724761  LUMO = 1.03005456009234
  mo_energy =
[-1.18331238e+02 -1.22078819e+01 -9.45136680e+00 -9.45136680e+00
 -9.45136680e+00 -1.22568865e+00 -5.56905595e-01 -5.56905595e-01
 -5.56905595e-01  1.03005456e+00  1.03005456e+00  1.03005456e+00
  7.32802848e+00  7.32802848e+00  7.32802848e+00  9.44902063e+00
  3.34861259e+01  3.34861259e+01  3.34861259e+01  1.03394293e+02
  1.29106039e+02  1.29106039e+02  1.29106039e+02  4.83520908e+02
  4.83520908e+02  4.83520908e+02  5.85973791e+02  1.33540378e+03
  1.33540378e+03  1.33540378e+03  2.65493763e+03  3.02969490e+03
  3.02969490e+03  3.02969490e+03  6.65023667e+03  6.65023667e+03
  6.65023667e+03  9.06062717e+03  2.54163152e+04  7.61587602e+04]
E1 = -727.9595818046046  E_coul = 201.2583668008404
cycle= 1 E= -526.701215003764  delta_E= -0.448  |g|= 0.185  |ddm|= 0.416
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.540648
diis-c [-0.29229999  1.        ]
  HOMO = -0.581679576673387  LUMO = 1.01385343783325
  mo_energy =
[-1.18627192e+02 -1.23326620e+01 -9.58653356e+00 -9.58653356e+00
 -9.58653356e+00 -1.25732496e+00 -5.81679577e-01 -5.81679577e-01
 -5.81679577e-01  1.01385344e+00  1.01385344e+00  1.01385344e+00
  7.25148383e+00  7.25148383e+00  7.25148383e+00  9.35974885e+00
  3.33452231e+01  3.33452231e+01  3.33452231e+01  1.03187081e+02
  1.28890408e+02  1.28890408e+02  1.28890408e+02  4.83226385e+02
  4.83226385e+02  4.83226385e+02  5.85641338e+02  1.33505281e+03
  1.33505281e+03  1.33505281e+03  2.65445151e+03  3.02927729e+03
  3.02927729e+03  3.02927729e+03  6.64970549e+03  6.64970549e+03
  6.64970549e+03  9.06002043e+03  2.54156144e+04  7.61579693e+04]
E1 = -728.4298397098011  E_coul = 201.72801914701785
cycle= 2 E= -526.701820562783  delta_E= -0.000606  |g|= 0.0339  |ddm|= 0.0394
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.067572
diis-c [-0.00271168  0.07409128  0.92590872]
  HOMO = -0.57484383639532  LUMO = 1.01899942129294
  mo_energy =
[-1.18567859e+02 -1.23014092e+01 -9.55395766e+00 -9.55395766e+00
 -9.55395766e+00 -1.24865298e+00 -5.74843836e-01 -5.74843836e-01
 -5.74843836e-01  1.01899942e+00  1.01899942e+00  1.01899942e+00
  7.27021375e+00  7.27021375e+00  7.27021375e+00  9.38401562e+00
  3.33784137e+01  3.33784137e+01  3.33784137e+01  1.03235150e+02
  1.28938486e+02  1.28938486e+02  1.28938486e+02  4.83284964e+02
  4.83284964e+02  4.83284964e+02  5.85702174e+02  1.33511523e+03
  1.33511523e+03  1.33511523e+03  2.65451697e+03  3.02934179e+03
  3.02934179e+03  3.02934179e+03  6.64977155e+03  6.64977155e+03
  6.64977155e+03  9.06008721e+03  2.54156816e+04  7.61580367e+04]
E1 = -728.3229671301275  E_coul = 201.62111072904037
cycle= 3 E= -526.701856401087  delta_E= -3.58e-05  |g|= 0.00489  |ddm|= 0.0104
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106055
diis-c [-4.77242033e-07 -1.15390224e-03  1.30915797e-01  8.70238105e-01]
  HOMO = -0.575780226627453  LUMO = 1.01830580067322
  mo_energy =
[-1.18575519e+02 -1.23055092e+01 -9.55833720e+00 -9.55833720e+00
 -9.55833720e+00 -1.24978548e+00 -5.75780227e-01 -5.75780227e-01
 -5.75780227e-01  1.01830580e+00  1.01830580e+00  1.01830580e+00
  7.26767328e+00  7.26767328e+00  7.26767328e+00  9.38092109e+00
  3.33739829e+01  3.33739829e+01  3.33739829e+01  1.03228946e+02
  1.28932224e+02  1.28932224e+02  1.28932224e+02  4.83277401e+02
  4.83277401e+02  4.83277401e+02  5.85694290e+02  1.33510715e+03
  1.33510715e+03  1.33510715e+03  2.65450831e+03  3.02933335e+03
  3.02933335e+03  3.02933335e+03  6.64976275e+03  6.64976275e+03
  6.64976275e+03  9.06007822e+03  2.54156725e+04  7.61580275e+04]
E1 = -728.3374627814774  E_coul = 201.6356055083269
cycle= 4 E= -526.70185727315  delta_E= -8.72e-07  |g|= 6.32e-05  |ddm|= 0.00134
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000130416
diis-c [-1.38298627e-09  6.67009122e-05 -9.19743189e-03 -7.22972821e-02
  1.08142801e+00]
  HOMO = -0.575768037454485  LUMO = 1.01831484671034
  mo_energy =
[-1.18575526e+02 -1.23054807e+01 -9.55832093e+00 -9.55832093e+00
 -9.55832093e+00 -1.24976581e+00 -5.75768037e-01 -5.75768037e-01
 -5.75768037e-01  1.01831485e+00  1.01831485e+00  1.01831485e+00
  7.26769361e+00  7.26769361e+00  7.26769361e+00  9.38095708e+00
  3.33739980e+01  3.33739980e+01  3.33739980e+01  1.03228957e+02
  1.28932230e+02  1.28932230e+02  1.28932230e+02  4.83277395e+02
  4.83277395e+02  4.83277395e+02  5.85694277e+02  1.33510713e+03
  1.33510713e+03  1.33510713e+03  2.65450827e+03  3.02933333e+03
  3.02933333e+03  3.02933333e+03  6.64976271e+03  6.64976271e+03
  6.64976271e+03  9.06007817e+03  2.54156724e+04  7.61580274e+04]
E1 = -728.3374661851118  E_coul = 201.63560891183138
cycle= 5 E= -526.70185727328  delta_E= -1.3e-10  |g|= 8e-06  |ddm|= 2.65e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3374661851118  E_coul = 201.63560891183138
  HOMO = -0.57577158578742  LUMO = 1.01831226001623
  mo_energy =
[-1.18575544e+02 -1.23054932e+01 -9.55833408e+00 -9.55833408e+00
 -9.55833408e+00 -1.24977016e+00 -5.75771586e-01 -5.75771586e-01
 -5.75771586e-01  1.01831226e+00  1.01831226e+00  1.01831226e+00
  7.26768500e+00  7.26768500e+00  7.26768500e+00  9.38094705e+00
  3.33739850e+01  3.33739850e+01  3.33739850e+01  1.03228941e+02
  1.28932215e+02  1.28932215e+02  1.28932215e+02  4.83277377e+02
  4.83277377e+02  4.83277377e+02  5.85694259e+02  1.33510711e+03
  1.33510711e+03  1.33510711e+03  2.65450825e+03  3.02933331e+03
  3.02933331e+03  3.02933331e+03  6.64976270e+03  6.64976270e+03
  6.64976270e+03  9.06007815e+03  2.54156724e+04  7.61580274e+04]
E1 = -728.3375059012963  E_coul = 201.63564862801235
Extra cycle  E= -526.701857273284  delta_E= -3.41e-12  |g|= 2.38e-06  |ddm|= 4.11e-06
    CPU time for scf_cycle      0.92 sec, wall time      0.29 sec
exp = [2.61826565e+04 7.61752061e+03 3.61735150e+03 1.59779857e+03
 3.82846812e+02 1.08349701e+02 3.56392212e+01 7.84774103e+00
 3.06451607e+00 3.98522609e-01 1.36278341e+03 6.64743686e+02
 3.00952584e+02 3.14034163e+02 6.16291016e+01 7.32561552e+00
 2.02376404e+01 7.72780975e-01 2.80834122e+00 2.22983622e-01]
E = -526.7018572732838
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:57:37 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.656458         1
[INPUT] 0    0    [1    /1   ]  7617.52061067        1
[INPUT] 0    0    [1    /1   ]  3617.35149768        1
[INPUT] 0    0    [1    /1   ]  1597.79857435        1
[INPUT] 0    0    [1    /1   ]  382.846812113        1
[INPUT] 0    0    [1    /1   ]  108.34970104         1
[INPUT] 0    0    [1    /1   ]  35.6392211873        1
[INPUT] 0    0    [1    /1   ]  7.84774102824        1
[INPUT] 0    0    [1    /1   ]  3.06451607218        1
[INPUT] 0    0    [1    /1   ]  0.398522609457       1
[INPUT] 1    0    [1    /1   ]  1362.78340808        1
[INPUT] 1    0    [1    /1   ]  664.743686313        1
[INPUT] 1    0    [1    /1   ]  300.952583621        1
[INPUT] 1    0    [1    /1   ]  314.034162529        1
[INPUT] 1    0    [1    /1   ]  61.6291015583        1
[INPUT] 1    0    [1    /1   ]  7.32561551524        1
[INPUT] 1    0    [1    /1   ]  20.2376404229        1
[INPUT] 1    0    [1    /1   ]  0.772780975367       1
[INPUT] 1    0    [1    /1   ]  2.80834121825        1
[INPUT] 1    0    [1    /1   ]  0.222983621685       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.65645803854, 1.0]], [0, [7617.520610668126, 1.0]], [0, [3617.351497681676, 1.0]], [0, [1597.7985743501763, 1.0]], [0, [382.8468121129885, 1.0]], [0, [108.34970104030887, 1.0]], [0, [35.63922118733279, 1.0]], [0, [7.847741028235434, 1.0]], [0, [3.06451607218019, 1.0]], [0, [0.3985226094566921, 1.0]], [1, [1362.783408078883, 1.0]], [1, [664.7436863130636, 1.0]], [1, [300.95258362051425, 1.0]], [1, [314.03416252917077, 1.0]], [1, [61.629101558296405, 1.0]], [1, [7.325615515244813, 1.0]], [1, [20.23764042288289, 1.0]], [1, [0.7727809753671219, 1.0]], [1, [2.8083412182492524, 1.0]], [1, [0.22298362168490132, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65645804]
bas 1, expnt(s) = [7617.52061067]
bas 2, expnt(s) = [3617.35149768]
bas 3, expnt(s) = [1597.79857435]
bas 4, expnt(s) = [382.84681211]
bas 5, expnt(s) = [108.34970104]
bas 6, expnt(s) = [35.63922119]
bas 7, expnt(s) = [7.84774103]
bas 8, expnt(s) = [3.06451607]
bas 9, expnt(s) = [0.39852261]
bas 10, expnt(s) = [1362.78340808]
bas 11, expnt(s) = [664.74368631]
bas 12, expnt(s) = [300.95258362]
bas 13, expnt(s) = [314.03416253]
bas 14, expnt(s) = [61.62910156]
bas 15, expnt(s) = [7.32561552]
bas 16, expnt(s) = [20.23764042]
bas 17, expnt(s) = [0.77278098]
bas 18, expnt(s) = [2.80834122]
bas 19, expnt(s) = [0.22298362]
CPU time:       868.70
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826565e+04 5.20026296e+03 7.61752061e+03 2.06003810e+03
 3.61735150e+03 1.17844158e+03 1.59779857e+03 6.38493597e+02
 3.82846812e+02 2.18667279e+02 1.08349701e+02 8.48468673e+01
 3.56392212e+01 3.68520098e+01 7.84774103e+00 1.18460489e+01
 3.06451607e+00 5.85175927e+00 3.98522609e-01 1.26722796e+00
 1.36278341e+03 2.41556061e+04 6.64743686e+02 9.84695989e+03
 3.00952584e+02 3.65684866e+03 3.14034163e+02 3.85660813e+03
 6.16291016e+01 5.03751890e+02 7.32561552e+00 3.51592453e+01
 2.02376404e+01 1.25223038e+02 7.72780975e-01 2.11375632e+00
 2.80834122e+00 1.06058806e+01 2.22983622e-01 4.47018605e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.983052418325883
cond(S) = 102367.65929209524
E1 = -729.3774264682061  E_coul = 203.1239472630614
init E= -526.253479205145
    CPU time for initialize scf      0.66 sec, wall time      0.05 sec
  HOMO = -0.556905594724761  LUMO = 1.03005456009234
  mo_energy =
[-1.18331238e+02 -1.22078819e+01 -9.45136680e+00 -9.45136680e+00
 -9.45136680e+00 -1.22568865e+00 -5.56905595e-01 -5.56905595e-01
 -5.56905595e-01  1.03005456e+00  1.03005456e+00  1.03005456e+00
  7.32802848e+00  7.32802848e+00  7.32802848e+00  9.44902063e+00
  3.34861259e+01  3.34861259e+01  3.34861259e+01  1.03394293e+02
  1.29106039e+02  1.29106039e+02  1.29106039e+02  4.83520908e+02
  4.83520908e+02  4.83520908e+02  5.85973791e+02  1.33540378e+03
  1.33540378e+03  1.33540378e+03  2.65493763e+03  3.02969490e+03
  3.02969490e+03  3.02969490e+03  6.65023667e+03  6.65023667e+03
  6.65023667e+03  9.06062717e+03  2.54163152e+04  7.61587602e+04]
E1 = -727.9595818046046  E_coul = 201.2583668008404
cycle= 1 E= -526.701215003764  delta_E= -0.448  |g|= 0.185  |ddm|= 0.416
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.540648
diis-c [-0.29229999  1.        ]
  HOMO = -0.581679576673387  LUMO = 1.01385343783325
  mo_energy =
[-1.18627192e+02 -1.23326620e+01 -9.58653356e+00 -9.58653356e+00
 -9.58653356e+00 -1.25732496e+00 -5.81679577e-01 -5.81679577e-01
 -5.81679577e-01  1.01385344e+00  1.01385344e+00  1.01385344e+00
  7.25148383e+00  7.25148383e+00  7.25148383e+00  9.35974885e+00
  3.33452231e+01  3.33452231e+01  3.33452231e+01  1.03187081e+02
  1.28890408e+02  1.28890408e+02  1.28890408e+02  4.83226385e+02
  4.83226385e+02  4.83226385e+02  5.85641338e+02  1.33505281e+03
  1.33505281e+03  1.33505281e+03  2.65445151e+03  3.02927729e+03
  3.02927729e+03  3.02927729e+03  6.64970549e+03  6.64970549e+03
  6.64970549e+03  9.06002043e+03  2.54156144e+04  7.61579693e+04]
E1 = -728.4298397098011  E_coul = 201.72801914701785
cycle= 2 E= -526.701820562783  delta_E= -0.000606  |g|= 0.0339  |ddm|= 0.0394
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.067572
diis-c [-0.00271168  0.07409128  0.92590872]
  HOMO = -0.57484383639532  LUMO = 1.01899942129294
  mo_energy =
[-1.18567859e+02 -1.23014092e+01 -9.55395766e+00 -9.55395766e+00
 -9.55395766e+00 -1.24865298e+00 -5.74843836e-01 -5.74843836e-01
 -5.74843836e-01  1.01899942e+00  1.01899942e+00  1.01899942e+00
  7.27021375e+00  7.27021375e+00  7.27021375e+00  9.38401562e+00
  3.33784137e+01  3.33784137e+01  3.33784137e+01  1.03235150e+02
  1.28938486e+02  1.28938486e+02  1.28938486e+02  4.83284964e+02
  4.83284964e+02  4.83284964e+02  5.85702174e+02  1.33511523e+03
  1.33511523e+03  1.33511523e+03  2.65451697e+03  3.02934179e+03
  3.02934179e+03  3.02934179e+03  6.64977155e+03  6.64977155e+03
  6.64977155e+03  9.06008721e+03  2.54156816e+04  7.61580367e+04]
E1 = -728.3229671301275  E_coul = 201.62111072904037
cycle= 3 E= -526.701856401087  delta_E= -3.58e-05  |g|= 0.00489  |ddm|= 0.0104
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106055
diis-c [-4.77242033e-07 -1.15390224e-03  1.30915797e-01  8.70238105e-01]
  HOMO = -0.575780226627453  LUMO = 1.01830580067322
  mo_energy =
[-1.18575519e+02 -1.23055092e+01 -9.55833720e+00 -9.55833720e+00
 -9.55833720e+00 -1.24978548e+00 -5.75780227e-01 -5.75780227e-01
 -5.75780227e-01  1.01830580e+00  1.01830580e+00  1.01830580e+00
  7.26767328e+00  7.26767328e+00  7.26767328e+00  9.38092109e+00
  3.33739829e+01  3.33739829e+01  3.33739829e+01  1.03228946e+02
  1.28932224e+02  1.28932224e+02  1.28932224e+02  4.83277401e+02
  4.83277401e+02  4.83277401e+02  5.85694290e+02  1.33510715e+03
  1.33510715e+03  1.33510715e+03  2.65450831e+03  3.02933335e+03
  3.02933335e+03  3.02933335e+03  6.64976275e+03  6.64976275e+03
  6.64976275e+03  9.06007822e+03  2.54156725e+04  7.61580275e+04]
E1 = -728.3374627814774  E_coul = 201.6356055083269
cycle= 4 E= -526.70185727315  delta_E= -8.72e-07  |g|= 6.32e-05  |ddm|= 0.00134
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000130416
diis-c [-1.38298627e-09  6.67009122e-05 -9.19743189e-03 -7.22972821e-02
  1.08142801e+00]
  HOMO = -0.575768037454485  LUMO = 1.01831484671034
  mo_energy =
[-1.18575526e+02 -1.23054807e+01 -9.55832093e+00 -9.55832093e+00
 -9.55832093e+00 -1.24976581e+00 -5.75768037e-01 -5.75768037e-01
 -5.75768037e-01  1.01831485e+00  1.01831485e+00  1.01831485e+00
  7.26769361e+00  7.26769361e+00  7.26769361e+00  9.38095708e+00
  3.33739980e+01  3.33739980e+01  3.33739980e+01  1.03228957e+02
  1.28932230e+02  1.28932230e+02  1.28932230e+02  4.83277395e+02
  4.83277395e+02  4.83277395e+02  5.85694277e+02  1.33510713e+03
  1.33510713e+03  1.33510713e+03  2.65450827e+03  3.02933333e+03
  3.02933333e+03  3.02933333e+03  6.64976271e+03  6.64976271e+03
  6.64976271e+03  9.06007817e+03  2.54156724e+04  7.61580274e+04]
E1 = -728.3374661851118  E_coul = 201.63560891183138
cycle= 5 E= -526.70185727328  delta_E= -1.3e-10  |g|= 8e-06  |ddm|= 2.65e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3374661851118  E_coul = 201.63560891183138
  HOMO = -0.57577158578742  LUMO = 1.01831226001623
  mo_energy =
[-1.18575544e+02 -1.23054932e+01 -9.55833408e+00 -9.55833408e+00
 -9.55833408e+00 -1.24977016e+00 -5.75771586e-01 -5.75771586e-01
 -5.75771586e-01  1.01831226e+00  1.01831226e+00  1.01831226e+00
  7.26768500e+00  7.26768500e+00  7.26768500e+00  9.38094705e+00
  3.33739850e+01  3.33739850e+01  3.33739850e+01  1.03228941e+02
  1.28932215e+02  1.28932215e+02  1.28932215e+02  4.83277377e+02
  4.83277377e+02  4.83277377e+02  5.85694259e+02  1.33510711e+03
  1.33510711e+03  1.33510711e+03  2.65450825e+03  3.02933331e+03
  3.02933331e+03  3.02933331e+03  6.64976270e+03  6.64976270e+03
  6.64976270e+03  9.06007815e+03  2.54156724e+04  7.61580274e+04]
E1 = -728.3375059012963  E_coul = 201.63564862801235
Extra cycle  E= -526.701857273284  delta_E= -3.41e-12  |g|= 2.38e-06  |ddm|= 4.11e-06
    CPU time for scf_cycle      0.88 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102367.65929209524
E1 = -728.3375059012963  E_coul = 201.63564862801235
init E= -526.701857273284
    CPU time for initialize scf     16.49 sec, wall time      0.77 sec
  HOMO = -0.575770858335321  LUMO = 1.01831279670227
  mo_energy =
[-1.18575539e+02 -1.23054903e+01 -9.55833106e+00 -9.55833106e+00
 -9.55833106e+00 -1.24976925e+00 -5.75770858e-01 -5.75770858e-01
 -5.75770858e-01  1.01831280e+00  1.01831280e+00  1.01831280e+00
  7.26768685e+00  7.26768685e+00  7.26768685e+00  9.38094935e+00
  3.33739880e+01  3.33739880e+01  3.33739880e+01  1.03228945e+02
  1.28932219e+02  1.28932219e+02  1.28932219e+02  4.83277382e+02
  4.83277382e+02  4.83277382e+02  5.85694263e+02  1.33510712e+03
  1.33510712e+03  1.33510712e+03  2.65450826e+03  3.02933331e+03
  3.02933331e+03  3.02933331e+03  6.64976270e+03  6.64976270e+03
  6.64976270e+03  9.06007816e+03  2.54156724e+04  7.61580274e+04]
E1 = -728.337496419429  E_coul = 201.63563914614403
cycle= 1 E= -526.701857273285  delta_E= -1.14e-12  |g|= 6.13e-07  |ddm|= 9.51e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.337496419429  E_coul = 201.63563914614403
  HOMO = -0.575771019816055  LUMO = 1.01831267692254
  mo_energy =
[-1.18575540e+02 -1.23054910e+01 -9.55833178e+00 -9.55833178e+00
 -9.55833178e+00 -1.24976945e+00 -5.75771020e-01 -5.75771020e-01
 -5.75771020e-01  1.01831268e+00  1.01831268e+00  1.01831268e+00
  7.26768642e+00  7.26768642e+00  7.26768642e+00  9.38094882e+00
  3.33739873e+01  3.33739873e+01  3.33739873e+01  1.03228944e+02
  1.28932218e+02  1.28932218e+02  1.28932218e+02  4.83277381e+02
  4.83277381e+02  4.83277381e+02  5.85694262e+02  1.33510712e+03
  1.33510712e+03  1.33510712e+03  2.65450826e+03  3.02933331e+03
  3.02933331e+03  3.02933331e+03  6.64976270e+03  6.64976270e+03
  6.64976270e+03  9.06007815e+03  2.54156724e+04  7.61580274e+04]
E1 = -728.3374987425713  E_coul = 201.6356414692868
Extra cycle  E= -526.701857273284  delta_E= 5.68e-13  |g|= 1.55e-07  |ddm|= 2.23e-07
    CPU time for scf_cycle     16.61 sec, wall time      0.90 sec
exp = [2.61826565e+04 7.61752061e+03 3.61735150e+03 1.59779857e+03
 3.82846812e+02 1.08349701e+02 3.56392212e+01 7.84774103e+00
 3.06451607e+00 3.98522609e-01 1.36278341e+03 6.64743686e+02
 3.00952584e+02 3.14034163e+02 6.16291016e+01 7.32561552e+00
 2.02376404e+01 7.72780975e-01 2.80834122e+00 2.22983622e-01]
grad_E = [-1.50714801e-06  3.19556332e-06 -1.63511266e-06  6.48337083e-05
  1.23149021e-04 -1.72222599e-03  6.71322161e-04 -1.82049701e-04
  1.70376772e-04 -7.67671970e-05 -5.04715554e-07  5.03717378e-06
  2.37989490e-05  2.05180272e-05 -3.91091919e-05 -2.66163977e-04
  1.65924331e-04  6.70332900e-05 -7.55058303e-05 -4.13887109e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:57:42 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6564552        1
[INPUT] 0    0    [1    /1   ]  7617.52061694        1
[INPUT] 0    0    [1    /1   ]  3617.35149469        1
[INPUT] 0    0    [1    /1   ]  1597.79870638        1
[INPUT] 0    0    [1    /1   ]  382.846688938        1
[INPUT] 0    0    [1    /1   ]  108.349778474        1
[INPUT] 0    0    [1    /1   ]  35.6312688008        1
[INPUT] 0    0    [1    /1   ]  7.85954670015        1
[INPUT] 0    0    [1    /1   ]  3.06643116917        1
[INPUT] 0    0    [1    /1   ]  0.398595185948       1
[INPUT] 1    0    [1    /1   ]  1362.78340712        1
[INPUT] 1    0    [1    /1   ]  664.743695695        1
[INPUT] 1    0    [1    /1   ]  300.95262777         1
[INPUT] 1    0    [1    /1   ]  314.034200597        1
[INPUT] 1    0    [1    /1   ]  61.6291189179        1
[INPUT] 1    0    [1    /1   ]  7.32550311461        1
[INPUT] 1    0    [1    /1   ]  20.2373582369        1
[INPUT] 1    0    [1    /1   ]  0.772656251508       1
[INPUT] 1    0    [1    /1   ]  2.81004510989        1
[INPUT] 1    0    [1    /1   ]  0.222813489729       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.656455171298, 1.0]], [0, [7617.52061693828, 1.0]], [0, [3617.3514946873033, 1.0]], [0, [1597.7987063758453, 1.0]], [0, [382.8466889376538, 1.0]], [0, [108.34977847412064, 1.0]], [0, [35.63126880079509, 1.0]], [0, [7.859546700151233, 1.0]], [0, [3.0664311691676445, 1.0]], [0, [0.3985951859475535, 1.0]], [1, [1362.783407117372, 1.0]], [1, [664.7436956946315, 1.0]], [1, [300.9526277702398, 1.0]], [1, [314.03420059724516, 1.0]], [1, [61.62911891793575, 1.0]], [1, [7.325503114613745, 1.0]], [1, [20.23735823689675, 1.0]], [1, [0.7726562515082448, 1.0]], [1, [2.810045109885867, 1.0]], [1, [0.22281348972905163, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65645517]
bas 1, expnt(s) = [7617.52061694]
bas 2, expnt(s) = [3617.35149469]
bas 3, expnt(s) = [1597.79870638]
bas 4, expnt(s) = [382.84668894]
bas 5, expnt(s) = [108.34977847]
bas 6, expnt(s) = [35.6312688]
bas 7, expnt(s) = [7.8595467]
bas 8, expnt(s) = [3.06643117]
bas 9, expnt(s) = [0.39859519]
bas 10, expnt(s) = [1362.78340712]
bas 11, expnt(s) = [664.74369569]
bas 12, expnt(s) = [300.95262777]
bas 13, expnt(s) = [314.0342006]
bas 14, expnt(s) = [61.62911892]
bas 15, expnt(s) = [7.32550311]
bas 16, expnt(s) = [20.23735824]
bas 17, expnt(s) = [0.77265625]
bas 18, expnt(s) = [2.81004511]
bas 19, expnt(s) = [0.22281349]
CPU time:       891.25
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826565e+04 5.20026296e+03 7.61752062e+03 2.06003810e+03
 3.61735149e+03 1.17844158e+03 1.59779871e+03 6.38493636e+02
 3.82846689e+02 2.18667226e+02 1.08349778e+02 8.48469128e+01
 3.56312688e+01 3.68458424e+01 7.85954670e+00 1.18594118e+01
 3.06643117e+00 5.85450174e+00 3.98595186e-01 1.26740105e+00
 1.36278341e+03 2.41556061e+04 6.64743696e+02 9.84696006e+03
 3.00952628e+02 3.65684933e+03 3.14034201e+02 3.85660871e+03
 6.16291189e+01 5.03752067e+02 7.32550311e+00 3.51585709e+01
 2.02373582e+01 1.25220856e+02 7.72656252e-01 2.11332989e+00
 2.81004511e+00 1.06139248e+01 2.22813490e-01 4.46592313e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.983059096180373
cond(S) = 102372.24781243168
E1 = -729.3779069827666  E_coul = 203.1242319761699
init E= -526.253675006597
    CPU time for initialize scf      0.64 sec, wall time      0.05 sec
  HOMO = -0.556901100331726  LUMO = 1.02930862339295
  mo_energy =
[-1.18331222e+02 -1.22078590e+01 -9.45134345e+00 -9.45134345e+00
 -9.45134345e+00 -1.22567411e+00 -5.56901100e-01 -5.56901100e-01
 -5.56901100e-01  1.02930862e+00  1.02930862e+00  1.02930862e+00
  7.32974835e+00  7.32974835e+00  7.32974835e+00  9.46622599e+00
  3.34908354e+01  3.34908354e+01  3.34908354e+01  1.03435075e+02
  1.29109929e+02  1.29109929e+02  1.29109929e+02  4.83523693e+02
  4.83523693e+02  4.83523693e+02  5.85998146e+02  1.33540625e+03
  1.33540625e+03  1.33540625e+03  2.65495507e+03  3.02969729e+03
  3.02969729e+03  3.02969729e+03  6.65023894e+03  6.65023894e+03
  6.65023894e+03  9.06064261e+03  2.54163298e+04  7.61587738e+04]
E1 = -727.9576630218319  E_coul = 201.25644284640885
cycle= 1 E= -526.701220175423  delta_E= -0.448  |g|= 0.185  |ddm|= 0.416
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.540739
diis-c [-0.29239854  1.        ]
  HOMO = -0.581751590848017  LUMO = 1.01305737887853
  mo_energy =
[-1.18627332e+02 -1.23327883e+01 -9.58666575e+00 -9.58666575e+00
 -9.58666575e+00 -1.25741038e+00 -5.81751591e-01 -5.81751591e-01
 -5.81751591e-01  1.01305738e+00  1.01305738e+00  1.01305738e+00
  7.25305081e+00  7.25305081e+00  7.25305081e+00  9.37673948e+00
  3.33497800e+01  3.33497800e+01  3.33497800e+01  1.03227685e+02
  1.28894143e+02  1.28894143e+02  1.28894143e+02  4.83229004e+02
  4.83229004e+02  4.83229004e+02  5.85665531e+02  1.33505512e+03
  1.33505512e+03  1.33505512e+03  2.65446879e+03  3.02927952e+03
  3.02927952e+03  3.02927952e+03  6.64970760e+03  6.64970760e+03
  6.64970760e+03  9.06003572e+03  2.54156288e+04  7.61579827e+04]
E1 = -728.4283882951102  E_coul = 201.72656171996633
cycle= 2 E= -526.701826575144  delta_E= -0.000606  |g|= 0.0339  |ddm|= 0.0394
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0676222
diis-c [-0.00271473  0.07414906  0.92585094]
  HOMO = -0.57490759468281  LUMO = 1.01820771629375
  mo_energy =
[-1.18567956e+02 -1.23015050e+01 -9.55405895e+00 -9.55405895e+00
 -9.55405895e+00 -1.24872730e+00 -5.74907595e-01 -5.74907595e-01
 -5.74907595e-01  1.01820772e+00  1.01820772e+00  1.01820772e+00
  7.27180504e+00  7.27180504e+00  7.27180504e+00  9.40104783e+00
  3.33830012e+01  3.33830012e+01  3.33830012e+01  1.03275791e+02
  1.28942259e+02  1.28942259e+02  1.28942259e+02  4.83287626e+02
  4.83287626e+02  4.83287626e+02  5.85726410e+02  1.33511758e+03
  1.33511758e+03  1.33511758e+03  2.65453430e+03  3.02934406e+03
  3.02934406e+03  3.02934406e+03  6.64977370e+03  6.64977370e+03
  6.64977370e+03  9.06010253e+03  2.54156961e+04  7.61580503e+04]
E1 = -728.3213995213966  E_coul = 201.61953704074315
cycle= 3 E= -526.701862480654  delta_E= -3.59e-05  |g|= 0.00489  |ddm|= 0.0104
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106107
diis-c [-4.77338275e-07 -1.15380716e-03  1.30888182e-01  8.70265625e-01]
  HOMO = -0.575845149465356  LUMO = 1.0175134534149
  mo_energy =
[-1.18575621e+02 -1.23056079e+01 -9.55844146e+00 -9.55844146e+00
 -9.55844146e+00 -1.24986142e+00 -5.75845149e-01 -5.75845149e-01
 -5.75845149e-01  1.01751345e+00  1.01751345e+00  1.01751345e+00
  7.26926167e+00  7.26926167e+00  7.26926167e+00  9.39794836e+00
  3.33785675e+01  3.33785675e+01  3.33785675e+01  1.03269584e+02
  1.28935994e+02  1.28935994e+02  1.28935994e+02  4.83280059e+02
  4.83280059e+02  4.83280059e+02  5.85718522e+02  1.33510949e+03
  1.33510949e+03  1.33510949e+03  2.65452563e+03  3.02933562e+03
  3.02933562e+03  3.02933562e+03  6.64976490e+03  6.64976490e+03
  6.64976490e+03  9.06009354e+03  2.54156870e+04  7.61580410e+04]
E1 = -728.33590628991  E_coul = 201.63404293606172
cycle= 4 E= -526.701863353848  delta_E= -8.73e-07  |g|= 6.32e-05  |ddm|= 0.00134
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000130485
diis-c [-1.38145104e-09  6.66743164e-05 -9.19216157e-03 -7.22806379e-02
  1.08140613e+00]
  HOMO = -0.575833008826266  LUMO = 1.01752245945199
  mo_energy =
[-1.18575628e+02 -1.23055795e+01 -9.55842528e+00 -9.55842528e+00
 -9.55842528e+00 -1.24984183e+00 -5.75833009e-01 -5.75833009e-01
 -5.75833009e-01  1.01752246e+00  1.01752246e+00  1.01752246e+00
  7.26928192e+00  7.26928192e+00  7.26928192e+00  9.39798423e+00
  3.33785824e+01  3.33785824e+01  3.33785824e+01  1.03269594e+02
  1.28935999e+02  1.28935999e+02  1.28935999e+02  4.83280053e+02
  4.83280053e+02  4.83280053e+02  5.85718509e+02  1.33510947e+03
  1.33510947e+03  1.33510947e+03  2.65452559e+03  3.02933559e+03
  3.02933559e+03  3.02933559e+03  6.64976486e+03  6.64976486e+03
  6.64976486e+03  9.06009349e+03  2.54156869e+04  7.61580409e+04]
E1 = -728.3359098144881  E_coul = 201.6340464605118
cycle= 5 E= -526.701863353976  delta_E= -1.28e-10  |g|= 7.99e-06  |ddm|= 2.64e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3359098144881  E_coul = 201.6340464605118
  HOMO = -0.575836557114138  LUMO = 1.01751987350669
  mo_energy =
[-1.18575645e+02 -1.23055920e+01 -9.55843843e+00 -9.55843843e+00
 -9.55843843e+00 -1.24984618e+00 -5.75836557e-01 -5.75836557e-01
 -5.75836557e-01  1.01751987e+00  1.01751987e+00  1.01751987e+00
  7.26927330e+00  7.26927330e+00  7.26927330e+00  9.39797419e+00
  3.33785695e+01  3.33785695e+01  3.33785695e+01  1.03269578e+02
  1.28935984e+02  1.28935984e+02  1.28935984e+02  4.83280036e+02
  4.83280036e+02  4.83280036e+02  5.85718491e+02  1.33510945e+03
  1.33510945e+03  1.33510945e+03  2.65452557e+03  3.02933558e+03
  3.02933558e+03  3.02933558e+03  6.64976484e+03  6.64976484e+03
  6.64976484e+03  9.06009347e+03  2.54156869e+04  7.61580409e+04]
E1 = -728.3359495221596  E_coul = 201.63408616817975
Extra cycle  E= -526.70186335398  delta_E= -3.64e-12  |g|= 2.38e-06  |ddm|= 4.11e-06
    CPU time for scf_cycle      0.84 sec, wall time      0.23 sec
exp = [2.61826565e+04 7.61752062e+03 3.61735149e+03 1.59779871e+03
 3.82846689e+02 1.08349778e+02 3.56312688e+01 7.85954670e+00
 3.06643117e+00 3.98595186e-01 1.36278341e+03 6.64743696e+02
 3.00952628e+02 3.14034201e+02 6.16291189e+01 7.32550311e+00
 2.02373582e+01 7.72656252e-01 2.81004511e+00 2.22813490e-01]
E = -526.7018633539799
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:57:42 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6564552        1
[INPUT] 0    0    [1    /1   ]  7617.52061694        1
[INPUT] 0    0    [1    /1   ]  3617.35149469        1
[INPUT] 0    0    [1    /1   ]  1597.79870638        1
[INPUT] 0    0    [1    /1   ]  382.846688938        1
[INPUT] 0    0    [1    /1   ]  108.349778474        1
[INPUT] 0    0    [1    /1   ]  35.6312688008        1
[INPUT] 0    0    [1    /1   ]  7.85954670015        1
[INPUT] 0    0    [1    /1   ]  3.06643116917        1
[INPUT] 0    0    [1    /1   ]  0.398595185948       1
[INPUT] 1    0    [1    /1   ]  1362.78340712        1
[INPUT] 1    0    [1    /1   ]  664.743695695        1
[INPUT] 1    0    [1    /1   ]  300.95262777         1
[INPUT] 1    0    [1    /1   ]  314.034200597        1
[INPUT] 1    0    [1    /1   ]  61.6291189179        1
[INPUT] 1    0    [1    /1   ]  7.32550311461        1
[INPUT] 1    0    [1    /1   ]  20.2373582369        1
[INPUT] 1    0    [1    /1   ]  0.772656251508       1
[INPUT] 1    0    [1    /1   ]  2.81004510989        1
[INPUT] 1    0    [1    /1   ]  0.222813489729       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.656455171298, 1.0]], [0, [7617.52061693828, 1.0]], [0, [3617.3514946873033, 1.0]], [0, [1597.7987063758453, 1.0]], [0, [382.8466889376538, 1.0]], [0, [108.34977847412064, 1.0]], [0, [35.63126880079509, 1.0]], [0, [7.859546700151233, 1.0]], [0, [3.0664311691676445, 1.0]], [0, [0.3985951859475535, 1.0]], [1, [1362.783407117372, 1.0]], [1, [664.7436956946315, 1.0]], [1, [300.9526277702398, 1.0]], [1, [314.03420059724516, 1.0]], [1, [61.62911891793575, 1.0]], [1, [7.325503114613745, 1.0]], [1, [20.23735823689675, 1.0]], [1, [0.7726562515082448, 1.0]], [1, [2.810045109885867, 1.0]], [1, [0.22281348972905163, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65645517]
bas 1, expnt(s) = [7617.52061694]
bas 2, expnt(s) = [3617.35149469]
bas 3, expnt(s) = [1597.79870638]
bas 4, expnt(s) = [382.84668894]
bas 5, expnt(s) = [108.34977847]
bas 6, expnt(s) = [35.6312688]
bas 7, expnt(s) = [7.8595467]
bas 8, expnt(s) = [3.06643117]
bas 9, expnt(s) = [0.39859519]
bas 10, expnt(s) = [1362.78340712]
bas 11, expnt(s) = [664.74369569]
bas 12, expnt(s) = [300.95262777]
bas 13, expnt(s) = [314.0342006]
bas 14, expnt(s) = [61.62911892]
bas 15, expnt(s) = [7.32550311]
bas 16, expnt(s) = [20.23735824]
bas 17, expnt(s) = [0.77265625]
bas 18, expnt(s) = [2.81004511]
bas 19, expnt(s) = [0.22281349]
CPU time:       892.21
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826565e+04 5.20026296e+03 7.61752062e+03 2.06003810e+03
 3.61735149e+03 1.17844158e+03 1.59779871e+03 6.38493636e+02
 3.82846689e+02 2.18667226e+02 1.08349778e+02 8.48469128e+01
 3.56312688e+01 3.68458424e+01 7.85954670e+00 1.18594118e+01
 3.06643117e+00 5.85450174e+00 3.98595186e-01 1.26740105e+00
 1.36278341e+03 2.41556061e+04 6.64743696e+02 9.84696006e+03
 3.00952628e+02 3.65684933e+03 3.14034201e+02 3.85660871e+03
 6.16291189e+01 5.03752067e+02 7.32550311e+00 3.51585709e+01
 2.02373582e+01 1.25220856e+02 7.72656252e-01 2.11332989e+00
 2.81004511e+00 1.06139248e+01 2.22813490e-01 4.46592313e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.983059096180373
cond(S) = 102372.24781243168
E1 = -729.3779069827666  E_coul = 203.1242319761699
init E= -526.253675006597
    CPU time for initialize scf      0.64 sec, wall time      0.05 sec
  HOMO = -0.556901100331726  LUMO = 1.02930862339295
  mo_energy =
[-1.18331222e+02 -1.22078590e+01 -9.45134345e+00 -9.45134345e+00
 -9.45134345e+00 -1.22567411e+00 -5.56901100e-01 -5.56901100e-01
 -5.56901100e-01  1.02930862e+00  1.02930862e+00  1.02930862e+00
  7.32974835e+00  7.32974835e+00  7.32974835e+00  9.46622599e+00
  3.34908354e+01  3.34908354e+01  3.34908354e+01  1.03435075e+02
  1.29109929e+02  1.29109929e+02  1.29109929e+02  4.83523693e+02
  4.83523693e+02  4.83523693e+02  5.85998146e+02  1.33540625e+03
  1.33540625e+03  1.33540625e+03  2.65495507e+03  3.02969729e+03
  3.02969729e+03  3.02969729e+03  6.65023894e+03  6.65023894e+03
  6.65023894e+03  9.06064261e+03  2.54163298e+04  7.61587738e+04]
E1 = -727.9576630218319  E_coul = 201.25644284640885
cycle= 1 E= -526.701220175423  delta_E= -0.448  |g|= 0.185  |ddm|= 0.416
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.540739
diis-c [-0.29239854  1.        ]
  HOMO = -0.581751590848017  LUMO = 1.01305737887853
  mo_energy =
[-1.18627332e+02 -1.23327883e+01 -9.58666575e+00 -9.58666575e+00
 -9.58666575e+00 -1.25741038e+00 -5.81751591e-01 -5.81751591e-01
 -5.81751591e-01  1.01305738e+00  1.01305738e+00  1.01305738e+00
  7.25305081e+00  7.25305081e+00  7.25305081e+00  9.37673948e+00
  3.33497800e+01  3.33497800e+01  3.33497800e+01  1.03227685e+02
  1.28894143e+02  1.28894143e+02  1.28894143e+02  4.83229004e+02
  4.83229004e+02  4.83229004e+02  5.85665531e+02  1.33505512e+03
  1.33505512e+03  1.33505512e+03  2.65446879e+03  3.02927952e+03
  3.02927952e+03  3.02927952e+03  6.64970760e+03  6.64970760e+03
  6.64970760e+03  9.06003572e+03  2.54156288e+04  7.61579827e+04]
E1 = -728.4283882951102  E_coul = 201.72656171996633
cycle= 2 E= -526.701826575144  delta_E= -0.000606  |g|= 0.0339  |ddm|= 0.0394
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0676222
diis-c [-0.00271473  0.07414906  0.92585094]
  HOMO = -0.57490759468281  LUMO = 1.01820771629375
  mo_energy =
[-1.18567956e+02 -1.23015050e+01 -9.55405895e+00 -9.55405895e+00
 -9.55405895e+00 -1.24872730e+00 -5.74907595e-01 -5.74907595e-01
 -5.74907595e-01  1.01820772e+00  1.01820772e+00  1.01820772e+00
  7.27180504e+00  7.27180504e+00  7.27180504e+00  9.40104783e+00
  3.33830012e+01  3.33830012e+01  3.33830012e+01  1.03275791e+02
  1.28942259e+02  1.28942259e+02  1.28942259e+02  4.83287626e+02
  4.83287626e+02  4.83287626e+02  5.85726410e+02  1.33511758e+03
  1.33511758e+03  1.33511758e+03  2.65453430e+03  3.02934406e+03
  3.02934406e+03  3.02934406e+03  6.64977370e+03  6.64977370e+03
  6.64977370e+03  9.06010253e+03  2.54156961e+04  7.61580503e+04]
E1 = -728.3213995213966  E_coul = 201.61953704074315
cycle= 3 E= -526.701862480654  delta_E= -3.59e-05  |g|= 0.00489  |ddm|= 0.0104
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106107
diis-c [-4.77338275e-07 -1.15380716e-03  1.30888182e-01  8.70265625e-01]
  HOMO = -0.575845149465356  LUMO = 1.0175134534149
  mo_energy =
[-1.18575621e+02 -1.23056079e+01 -9.55844146e+00 -9.55844146e+00
 -9.55844146e+00 -1.24986142e+00 -5.75845149e-01 -5.75845149e-01
 -5.75845149e-01  1.01751345e+00  1.01751345e+00  1.01751345e+00
  7.26926167e+00  7.26926167e+00  7.26926167e+00  9.39794836e+00
  3.33785675e+01  3.33785675e+01  3.33785675e+01  1.03269584e+02
  1.28935994e+02  1.28935994e+02  1.28935994e+02  4.83280059e+02
  4.83280059e+02  4.83280059e+02  5.85718522e+02  1.33510949e+03
  1.33510949e+03  1.33510949e+03  2.65452563e+03  3.02933562e+03
  3.02933562e+03  3.02933562e+03  6.64976490e+03  6.64976490e+03
  6.64976490e+03  9.06009354e+03  2.54156870e+04  7.61580410e+04]
E1 = -728.33590628991  E_coul = 201.63404293606172
cycle= 4 E= -526.701863353848  delta_E= -8.73e-07  |g|= 6.32e-05  |ddm|= 0.00134
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000130485
diis-c [-1.38145104e-09  6.66743164e-05 -9.19216157e-03 -7.22806379e-02
  1.08140613e+00]
  HOMO = -0.575833008826266  LUMO = 1.01752245945199
  mo_energy =
[-1.18575628e+02 -1.23055795e+01 -9.55842528e+00 -9.55842528e+00
 -9.55842528e+00 -1.24984183e+00 -5.75833009e-01 -5.75833009e-01
 -5.75833009e-01  1.01752246e+00  1.01752246e+00  1.01752246e+00
  7.26928192e+00  7.26928192e+00  7.26928192e+00  9.39798423e+00
  3.33785824e+01  3.33785824e+01  3.33785824e+01  1.03269594e+02
  1.28935999e+02  1.28935999e+02  1.28935999e+02  4.83280053e+02
  4.83280053e+02  4.83280053e+02  5.85718509e+02  1.33510947e+03
  1.33510947e+03  1.33510947e+03  2.65452559e+03  3.02933559e+03
  3.02933559e+03  3.02933559e+03  6.64976486e+03  6.64976486e+03
  6.64976486e+03  9.06009349e+03  2.54156869e+04  7.61580409e+04]
E1 = -728.3359098144881  E_coul = 201.6340464605118
cycle= 5 E= -526.701863353976  delta_E= -1.28e-10  |g|= 7.99e-06  |ddm|= 2.64e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3359098144881  E_coul = 201.6340464605118
  HOMO = -0.575836557114138  LUMO = 1.01751987350669
  mo_energy =
[-1.18575645e+02 -1.23055920e+01 -9.55843843e+00 -9.55843843e+00
 -9.55843843e+00 -1.24984618e+00 -5.75836557e-01 -5.75836557e-01
 -5.75836557e-01  1.01751987e+00  1.01751987e+00  1.01751987e+00
  7.26927330e+00  7.26927330e+00  7.26927330e+00  9.39797419e+00
  3.33785695e+01  3.33785695e+01  3.33785695e+01  1.03269578e+02
  1.28935984e+02  1.28935984e+02  1.28935984e+02  4.83280036e+02
  4.83280036e+02  4.83280036e+02  5.85718491e+02  1.33510945e+03
  1.33510945e+03  1.33510945e+03  2.65452557e+03  3.02933558e+03
  3.02933558e+03  3.02933558e+03  6.64976484e+03  6.64976484e+03
  6.64976484e+03  9.06009347e+03  2.54156869e+04  7.61580409e+04]
E1 = -728.3359495221596  E_coul = 201.63408616817975
Extra cycle  E= -526.70186335398  delta_E= -3.64e-12  |g|= 2.38e-06  |ddm|= 4.11e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102372.24781243168
E1 = -728.3359495221596  E_coul = 201.63408616817975
init E= -526.70186335398
    CPU time for initialize scf      3.77 sec, wall time      0.20 sec
  HOMO = -0.57583582960587  LUMO = 1.01752041005631
  mo_energy =
[-1.18575641e+02 -1.23055891e+01 -9.55843542e+00 -9.55843542e+00
 -9.55843542e+00 -1.24984527e+00 -5.75835830e-01 -5.75835830e-01
 -5.75835830e-01  1.01752041e+00  1.01752041e+00  1.01752041e+00
  7.26927516e+00  7.26927516e+00  7.26927516e+00  9.39797649e+00
  3.33785725e+01  3.33785725e+01  3.33785725e+01  1.03269582e+02
  1.28935988e+02  1.28935988e+02  1.28935988e+02  4.83280040e+02
  4.83280040e+02  4.83280040e+02  5.85718496e+02  1.33510946e+03
  1.33510946e+03  1.33510946e+03  2.65452558e+03  3.02933558e+03
  3.02933558e+03  3.02933558e+03  6.64976485e+03  6.64976485e+03
  6.64976485e+03  9.06009348e+03  2.54156869e+04  7.61580409e+04]
E1 = -728.3359400404499  E_coul = 201.6340766864703
cycle= 1 E= -526.70186335398  delta_E= 2.27e-13  |g|= 6.13e-07  |ddm|= 9.5e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3359400404499  E_coul = 201.6340766864703
  HOMO = -0.575835991143122  LUMO = 1.01752029027482
  mo_energy =
[-1.18575642e+02 -1.23055898e+01 -9.55843614e+00 -9.55843614e+00
 -9.55843614e+00 -1.24984547e+00 -5.75835991e-01 -5.75835991e-01
 -5.75835991e-01  1.01752029e+00  1.01752029e+00  1.01752029e+00
  7.26927473e+00  7.26927473e+00  7.26927473e+00  9.39797596e+00
  3.33785718e+01  3.33785718e+01  3.33785718e+01  1.03269581e+02
  1.28935987e+02  1.28935987e+02  1.28935987e+02  4.83280039e+02
  4.83280039e+02  4.83280039e+02  5.85718494e+02  1.33510946e+03
  1.33510946e+03  1.33510946e+03  2.65452558e+03  3.02933558e+03
  3.02933558e+03  3.02933558e+03  6.64976485e+03  6.64976485e+03
  6.64976485e+03  9.06009348e+03  2.54156869e+04  7.61580409e+04]
E1 = -728.3359423638271  E_coul = 201.63407900984646
Extra cycle  E= -526.701863353981  delta_E= -1.02e-12  |g|= 1.55e-07  |ddm|= 2.23e-07
    CPU time for scf_cycle      3.89 sec, wall time      0.31 sec
exp = [2.61826565e+04 7.61752062e+03 3.61735149e+03 1.59779871e+03
 3.82846689e+02 1.08349778e+02 3.56312688e+01 7.85954670e+00
 3.06643117e+00 3.98595186e-01 1.36278341e+03 6.64743696e+02
 3.00952628e+02 3.14034201e+02 6.16291189e+01 7.32550311e+00
 2.02373582e+01 7.72656252e-01 2.81004511e+00 2.22813490e-01]
grad_E = [-1.50731559e-06  3.19731760e-06 -1.63442485e-06  6.49032575e-05
  1.20802113e-04 -1.70383179e-03  6.27555962e-04 -5.10918994e-05
 -7.45238088e-05  4.86595319e-04 -5.04304747e-07  5.04274444e-06
  2.38332279e-05  2.05474191e-05 -4.37141420e-05 -5.03730413e-04
  2.17589756e-04  7.95958541e-04  2.96702093e-04 -3.89108611e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:57:46 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.656458         1
[INPUT] 0    0    [1    /1   ]  7617.52061127        1
[INPUT] 0    0    [1    /1   ]  3617.35149787        1
[INPUT] 0    0    [1    /1   ]  1597.7985978         1
[INPUT] 0    0    [1    /1   ]  382.845974659        1
[INPUT] 0    0    [1    /1   ]  108.357510968        1
[INPUT] 0    0    [1    /1   ]  35.617415777         1
[INPUT] 0    0    [1    /1   ]  7.88042988306        1
[INPUT] 0    0    [1    /1   ]  3.06975329536        1
[INPUT] 0    0    [1    /1   ]  0.39872491127        1
[INPUT] 1    0    [1    /1   ]  1362.78340805        1
[INPUT] 1    0    [1    /1   ]  664.743686085        1
[INPUT] 1    0    [1    /1   ]  300.952582145        1
[INPUT] 1    0    [1    /1   ]  314.034161269        1
[INPUT] 1    0    [1    /1   ]  61.629308141         1
[INPUT] 1    0    [1    /1   ]  7.32600533498        1
[INPUT] 1    0    [1    /1   ]  20.2363384769        1
[INPUT] 1    0    [1    /1   ]  0.772487112173       1
[INPUT] 1    0    [1    /1   ]  2.81358715344        1
[INPUT] 1    0    [1    /1   ]  0.222523592587       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.65645796727, 1.0]], [0, [7617.520611266395, 1.0]], [0, [3617.351497870658, 1.0]], [0, [1597.798597800817, 1.0]], [0, [382.84597465857127, 1.0]], [0, [108.35751096754477, 1.0]], [0, [35.61741577696339, 1.0]], [0, [7.880429883059338, 1.0]], [0, [3.069753295356769, 1.0]], [0, [0.39872491127038867, 1.0]], [1, [1362.7834080526497, 1.0]], [1, [664.7436860853796, 1.0]], [1, [300.9525821454172, 1.0]], [1, [314.03416126859094, 1.0]], [1, [61.62930814100714, 1.0]], [1, [7.326005334983989, 1.0]], [1, [20.23633847694447, 1.0]], [1, [0.7724871121727483, 1.0]], [1, [2.8135871534383723, 1.0]], [1, [0.22252359258730064, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65645797]
bas 1, expnt(s) = [7617.52061127]
bas 2, expnt(s) = [3617.35149787]
bas 3, expnt(s) = [1597.7985978]
bas 4, expnt(s) = [382.84597466]
bas 5, expnt(s) = [108.35751097]
bas 6, expnt(s) = [35.61741578]
bas 7, expnt(s) = [7.88042988]
bas 8, expnt(s) = [3.0697533]
bas 9, expnt(s) = [0.39872491]
bas 10, expnt(s) = [1362.78340805]
bas 11, expnt(s) = [664.74368609]
bas 12, expnt(s) = [300.95258215]
bas 13, expnt(s) = [314.03416127]
bas 14, expnt(s) = [61.62930814]
bas 15, expnt(s) = [7.32600533]
bas 16, expnt(s) = [20.23633848]
bas 17, expnt(s) = [0.77248711]
bas 18, expnt(s) = [2.81358715]
bas 19, expnt(s) = [0.22252359]
CPU time:       901.70
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826565e+04 5.20026296e+03 7.61752061e+03 2.06003810e+03
 3.61735150e+03 1.17844158e+03 1.59779860e+03 6.38493604e+02
 3.82845975e+02 2.18666920e+02 1.08357511e+02 8.48514542e+01
 3.56174158e+01 3.68350979e+01 7.88042988e+00 1.18830372e+01
 3.06975330e+00 5.85925811e+00 3.98724911e-01 1.26771040e+00
 1.36278341e+03 2.41556061e+04 6.64743686e+02 9.84695989e+03
 3.00952582e+02 3.65684864e+03 3.14034161e+02 3.85660811e+03
 6.16293081e+01 5.03754000e+02 7.32600533e+00 3.51615839e+01
 2.02363385e+01 1.25212968e+02 7.72487112e-01 2.11275163e+00
 2.81358715e+00 1.06306509e+01 2.22523593e-01 4.45866118e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.983068066645615
cond(S) = 102380.74708944389
E1 = -729.3787963929244  E_coul = 203.12474470385638
init E= -526.254051689068
    CPU time for initialize scf      0.63 sec, wall time      0.05 sec
  HOMO = -0.556892189935794  LUMO = 1.0280780095579
  mo_energy =
[-1.18331198e+02 -1.22078159e+01 -9.45130188e+00 -9.45130188e+00
 -9.45130188e+00 -1.22564786e+00 -5.56892190e-01 -5.56892190e-01
 -5.56892190e-01  1.02807801e+00  1.02807801e+00  1.02807801e+00
  7.33413383e+00  7.33413383e+00  7.33413383e+00  9.49649348e+00
  3.35025768e+01  3.35025768e+01  3.35025768e+01  1.03510409e+02
  1.29119910e+02  1.29119910e+02  1.29119910e+02  4.83530895e+02
  4.83530895e+02  4.83530895e+02  5.86060718e+02  1.33541239e+03
  1.33541239e+03  1.33541239e+03  2.65501232e+03  3.02970283e+03
  3.02970283e+03  3.02970283e+03  6.65024388e+03  6.65024388e+03
  6.65024388e+03  9.06069532e+03  2.54163796e+04  7.61588201e+04]
E1 = -727.9543352313719  E_coul = 201.25309938040414
cycle= 1 E= -526.701235850968  delta_E= -0.447  |g|= 0.185  |ddm|= 0.416
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.540918
diis-c [-0.2925922  1.       ]
  HOMO = -0.581876258972695  LUMO = 1.01173769875328
  mo_energy =
[-1.18627585e+02 -1.23330044e+01 -9.58689550e+00 -9.58689550e+00
 -9.58689550e+00 -1.25755900e+00 -5.81876259e-01 -5.81876259e-01
 -5.81876259e-01  1.01173770e+00  1.01173770e+00  1.01173770e+00
  7.25715968e+00  7.25715968e+00  7.25715968e+00  9.40663149e+00
  3.33612535e+01  3.33612535e+01  3.33612535e+01  1.03302704e+02
  1.28903854e+02  1.28903854e+02  1.28903854e+02  4.83235913e+02
  4.83235913e+02  4.83235913e+02  5.85727814e+02  1.33506097e+03
  1.33506097e+03  1.33506097e+03  2.65452575e+03  3.02928476e+03
  3.02928476e+03  3.02928476e+03  6.64971225e+03  6.64971225e+03
  6.64971225e+03  9.06008816e+03  2.54156783e+04  7.61580288e+04]
E1 = -728.4258744919896  E_coul = 201.72403076318335
cycle= 2 E= -526.701843728806  delta_E= -0.000608  |g|= 0.0339  |ddm|= 0.0395
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0677111
diis-c [-0.00272006  0.07425038  0.92574962]
  HOMO = -0.57501793564507  LUMO = 1.01689604249935
  mo_energy =
[-1.18568133e+02 -1.23016680e+01 -9.55423497e+00 -9.55423497e+00
 -9.55423497e+00 -1.24885664e+00 -5.75017936e-01 -5.75017936e-01
 -5.75017936e-01  1.01689604e+00  1.01689604e+00  1.01689604e+00
  7.27595819e+00  7.27595819e+00  7.27595819e+00  9.43101250e+00
  3.33945283e+01  3.33945283e+01  3.33945283e+01  1.03350876e+02
  1.28952036e+02  1.28952036e+02  1.28952036e+02  4.83294610e+02
  4.83294610e+02  4.83294610e+02  5.85788768e+02  1.33512351e+03
  1.33512351e+03  1.33512351e+03  2.65459134e+03  3.02934939e+03
  3.02934939e+03  3.02934939e+03  6.64977844e+03  6.64977844e+03
  6.64977844e+03  9.06015505e+03  2.54157457e+04  7.61580964e+04]
E1 = -728.3186840856613  E_coul = 201.61680433412576
cycle= 3 E= -526.701879751536  delta_E= -3.6e-05  |g|= 0.0049  |ddm|= 0.0105
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106199
diis-c [-4.77640662e-07 -1.15365461e-03  1.30838481e-01  8.70315173e-01]
  HOMO = -0.575957507198663  LUMO = 1.01620060698598
  mo_energy =
[-1.18575805e+02 -1.23057758e+01 -9.55862258e+00 -9.55862258e+00
 -9.55862258e+00 -1.24999356e+00 -5.75957507e-01 -5.75957507e-01
 -5.75957507e-01  1.01620061e+00  1.01620061e+00  1.01620061e+00
  7.27340953e+00  7.27340953e+00  7.27340953e+00  9.42790444e+00
  3.33900893e+01  3.33900893e+01  3.33900893e+01  1.03344662e+02
  1.28945765e+02  1.28945765e+02  1.28945765e+02  4.83287036e+02
  4.83287036e+02  4.83287036e+02  5.85780874e+02  1.33511541e+03
  1.33511541e+03  1.33511541e+03  2.65458266e+03  3.02934094e+03
  3.02934094e+03  3.02934094e+03  6.64976963e+03  6.64976963e+03
  6.64976963e+03  9.06014605e+03  2.54157365e+04  7.61580871e+04]
E1 = -728.3332098747409  E_coul = 201.63132924807374
cycle= 4 E= -526.701880626667  delta_E= -8.75e-07  |g|= 6.31e-05  |ddm|= 0.00134
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000130629
diis-c [-1.37879985e-09  6.66263247e-05 -9.18299245e-03 -7.22547088e-02
  1.08137107e+00]
  HOMO = -0.575945451387998  LUMO = 1.01620954373724
  mo_energy =
[-1.18575811e+02 -1.23057475e+01 -9.55860657e+00 -9.55860657e+00
 -9.55860657e+00 -1.24997409e+00 -5.75945451e-01 -5.75945451e-01
 -5.75945451e-01  1.01620954e+00  1.01620954e+00  1.01620954e+00
  7.27342963e+00  7.27342963e+00  7.27342963e+00  9.42794010e+00
  3.33901041e+01  3.33901041e+01  3.33901041e+01  1.03344672e+02
  1.28945770e+02  1.28945770e+02  1.28945770e+02  4.83287030e+02
  4.83287030e+02  4.83287030e+02  5.85780860e+02  1.33511539e+03
  1.33511539e+03  1.33511539e+03  2.65458263e+03  3.02934091e+03
  3.02934091e+03  3.02934091e+03  6.64976959e+03  6.64976959e+03
  6.64976959e+03  9.06014600e+03  2.54157365e+04  7.61580870e+04]
E1 = -728.3332136190087  E_coul = 201.63133299221323
cycle= 5 E= -526.701880626795  delta_E= -1.28e-10  |g|= 7.99e-06  |ddm|= 2.62e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3332136190087  E_coul = 201.63133299221323
  HOMO = -0.575948999970823  LUMO = 1.01620695859772
  mo_energy =
[-1.18575829e+02 -1.23057600e+01 -9.55861971e+00 -9.55861971e+00
 -9.55861971e+00 -1.24997844e+00 -5.75949000e-01 -5.75949000e-01
 -5.75949000e-01  1.01620696e+00  1.01620696e+00  1.01620696e+00
  7.27342101e+00  7.27342101e+00  7.27342101e+00  9.42793006e+00
  3.33900912e+01  3.33900912e+01  3.33900912e+01  1.03344657e+02
  1.28945754e+02  1.28945754e+02  1.28945754e+02  4.83287013e+02
  4.83287013e+02  4.83287013e+02  5.85780842e+02  1.33511538e+03
  1.33511538e+03  1.33511538e+03  2.65458261e+03  3.02934090e+03
  3.02934090e+03  3.02934090e+03  6.64976957e+03  6.64976957e+03
  6.64976957e+03  9.06014599e+03  2.54157365e+04  7.61580870e+04]
E1 = -728.3332533149776  E_coul = 201.63137268817985
Extra cycle  E= -526.701880626798  delta_E= -2.27e-12  |g|= 2.37e-06  |ddm|= 4.11e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.22 sec
exp = [2.61826565e+04 7.61752061e+03 3.61735150e+03 1.59779860e+03
 3.82845975e+02 1.08357511e+02 3.56174158e+01 7.88042988e+00
 3.06975330e+00 3.98724911e-01 1.36278341e+03 6.64743686e+02
 3.00952582e+02 3.14034161e+02 6.16293081e+01 7.32600533e+00
 2.02363385e+01 7.72487112e-01 2.81358715e+00 2.22523593e-01]
E = -526.7018806267977
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:57:47 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.656458         1
[INPUT] 0    0    [1    /1   ]  7617.52061127        1
[INPUT] 0    0    [1    /1   ]  3617.35149787        1
[INPUT] 0    0    [1    /1   ]  1597.7985978         1
[INPUT] 0    0    [1    /1   ]  382.845974659        1
[INPUT] 0    0    [1    /1   ]  108.357510968        1
[INPUT] 0    0    [1    /1   ]  35.617415777         1
[INPUT] 0    0    [1    /1   ]  7.88042988306        1
[INPUT] 0    0    [1    /1   ]  3.06975329536        1
[INPUT] 0    0    [1    /1   ]  0.39872491127        1
[INPUT] 1    0    [1    /1   ]  1362.78340805        1
[INPUT] 1    0    [1    /1   ]  664.743686085        1
[INPUT] 1    0    [1    /1   ]  300.952582145        1
[INPUT] 1    0    [1    /1   ]  314.034161269        1
[INPUT] 1    0    [1    /1   ]  61.629308141         1
[INPUT] 1    0    [1    /1   ]  7.32600533498        1
[INPUT] 1    0    [1    /1   ]  20.2363384769        1
[INPUT] 1    0    [1    /1   ]  0.772487112173       1
[INPUT] 1    0    [1    /1   ]  2.81358715344        1
[INPUT] 1    0    [1    /1   ]  0.222523592587       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.65645796727, 1.0]], [0, [7617.520611266395, 1.0]], [0, [3617.351497870658, 1.0]], [0, [1597.798597800817, 1.0]], [0, [382.84597465857127, 1.0]], [0, [108.35751096754477, 1.0]], [0, [35.61741577696339, 1.0]], [0, [7.880429883059338, 1.0]], [0, [3.069753295356769, 1.0]], [0, [0.39872491127038867, 1.0]], [1, [1362.7834080526497, 1.0]], [1, [664.7436860853796, 1.0]], [1, [300.9525821454172, 1.0]], [1, [314.03416126859094, 1.0]], [1, [61.62930814100714, 1.0]], [1, [7.326005334983989, 1.0]], [1, [20.23633847694447, 1.0]], [1, [0.7724871121727483, 1.0]], [1, [2.8135871534383723, 1.0]], [1, [0.22252359258730064, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65645797]
bas 1, expnt(s) = [7617.52061127]
bas 2, expnt(s) = [3617.35149787]
bas 3, expnt(s) = [1597.7985978]
bas 4, expnt(s) = [382.84597466]
bas 5, expnt(s) = [108.35751097]
bas 6, expnt(s) = [35.61741578]
bas 7, expnt(s) = [7.88042988]
bas 8, expnt(s) = [3.0697533]
bas 9, expnt(s) = [0.39872491]
bas 10, expnt(s) = [1362.78340805]
bas 11, expnt(s) = [664.74368609]
bas 12, expnt(s) = [300.95258215]
bas 13, expnt(s) = [314.03416127]
bas 14, expnt(s) = [61.62930814]
bas 15, expnt(s) = [7.32600533]
bas 16, expnt(s) = [20.23633848]
bas 17, expnt(s) = [0.77248711]
bas 18, expnt(s) = [2.81358715]
bas 19, expnt(s) = [0.22252359]
CPU time:       902.65
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826565e+04 5.20026296e+03 7.61752061e+03 2.06003810e+03
 3.61735150e+03 1.17844158e+03 1.59779860e+03 6.38493604e+02
 3.82845975e+02 2.18666920e+02 1.08357511e+02 8.48514542e+01
 3.56174158e+01 3.68350979e+01 7.88042988e+00 1.18830372e+01
 3.06975330e+00 5.85925811e+00 3.98724911e-01 1.26771040e+00
 1.36278341e+03 2.41556061e+04 6.64743686e+02 9.84695989e+03
 3.00952582e+02 3.65684864e+03 3.14034161e+02 3.85660811e+03
 6.16293081e+01 5.03754000e+02 7.32600533e+00 3.51615839e+01
 2.02363385e+01 1.25212968e+02 7.72487112e-01 2.11275163e+00
 2.81358715e+00 1.06306509e+01 2.22523593e-01 4.45866118e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.983068066645615
cond(S) = 102380.74708944389
E1 = -729.3787963929244  E_coul = 203.12474470385638
init E= -526.254051689068
    CPU time for initialize scf      0.62 sec, wall time      0.05 sec
  HOMO = -0.556892189935794  LUMO = 1.0280780095579
  mo_energy =
[-1.18331198e+02 -1.22078159e+01 -9.45130188e+00 -9.45130188e+00
 -9.45130188e+00 -1.22564786e+00 -5.56892190e-01 -5.56892190e-01
 -5.56892190e-01  1.02807801e+00  1.02807801e+00  1.02807801e+00
  7.33413383e+00  7.33413383e+00  7.33413383e+00  9.49649348e+00
  3.35025768e+01  3.35025768e+01  3.35025768e+01  1.03510409e+02
  1.29119910e+02  1.29119910e+02  1.29119910e+02  4.83530895e+02
  4.83530895e+02  4.83530895e+02  5.86060718e+02  1.33541239e+03
  1.33541239e+03  1.33541239e+03  2.65501232e+03  3.02970283e+03
  3.02970283e+03  3.02970283e+03  6.65024388e+03  6.65024388e+03
  6.65024388e+03  9.06069532e+03  2.54163796e+04  7.61588201e+04]
E1 = -727.9543352313719  E_coul = 201.25309938040414
cycle= 1 E= -526.701235850968  delta_E= -0.447  |g|= 0.185  |ddm|= 0.416
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.540918
diis-c [-0.2925922  1.       ]
  HOMO = -0.581876258972695  LUMO = 1.01173769875328
  mo_energy =
[-1.18627585e+02 -1.23330044e+01 -9.58689550e+00 -9.58689550e+00
 -9.58689550e+00 -1.25755900e+00 -5.81876259e-01 -5.81876259e-01
 -5.81876259e-01  1.01173770e+00  1.01173770e+00  1.01173770e+00
  7.25715968e+00  7.25715968e+00  7.25715968e+00  9.40663149e+00
  3.33612535e+01  3.33612535e+01  3.33612535e+01  1.03302704e+02
  1.28903854e+02  1.28903854e+02  1.28903854e+02  4.83235913e+02
  4.83235913e+02  4.83235913e+02  5.85727814e+02  1.33506097e+03
  1.33506097e+03  1.33506097e+03  2.65452575e+03  3.02928476e+03
  3.02928476e+03  3.02928476e+03  6.64971225e+03  6.64971225e+03
  6.64971225e+03  9.06008816e+03  2.54156783e+04  7.61580288e+04]
E1 = -728.4258744919896  E_coul = 201.72403076318335
cycle= 2 E= -526.701843728806  delta_E= -0.000608  |g|= 0.0339  |ddm|= 0.0395
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0677111
diis-c [-0.00272006  0.07425038  0.92574962]
  HOMO = -0.57501793564507  LUMO = 1.01689604249935
  mo_energy =
[-1.18568133e+02 -1.23016680e+01 -9.55423497e+00 -9.55423497e+00
 -9.55423497e+00 -1.24885664e+00 -5.75017936e-01 -5.75017936e-01
 -5.75017936e-01  1.01689604e+00  1.01689604e+00  1.01689604e+00
  7.27595819e+00  7.27595819e+00  7.27595819e+00  9.43101250e+00
  3.33945283e+01  3.33945283e+01  3.33945283e+01  1.03350876e+02
  1.28952036e+02  1.28952036e+02  1.28952036e+02  4.83294610e+02
  4.83294610e+02  4.83294610e+02  5.85788768e+02  1.33512351e+03
  1.33512351e+03  1.33512351e+03  2.65459134e+03  3.02934939e+03
  3.02934939e+03  3.02934939e+03  6.64977844e+03  6.64977844e+03
  6.64977844e+03  9.06015505e+03  2.54157457e+04  7.61580964e+04]
E1 = -728.3186840856613  E_coul = 201.61680433412576
cycle= 3 E= -526.701879751536  delta_E= -3.6e-05  |g|= 0.0049  |ddm|= 0.0105
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106199
diis-c [-4.77640662e-07 -1.15365461e-03  1.30838481e-01  8.70315173e-01]
  HOMO = -0.575957507198663  LUMO = 1.01620060698598
  mo_energy =
[-1.18575805e+02 -1.23057758e+01 -9.55862258e+00 -9.55862258e+00
 -9.55862258e+00 -1.24999356e+00 -5.75957507e-01 -5.75957507e-01
 -5.75957507e-01  1.01620061e+00  1.01620061e+00  1.01620061e+00
  7.27340953e+00  7.27340953e+00  7.27340953e+00  9.42790444e+00
  3.33900893e+01  3.33900893e+01  3.33900893e+01  1.03344662e+02
  1.28945765e+02  1.28945765e+02  1.28945765e+02  4.83287036e+02
  4.83287036e+02  4.83287036e+02  5.85780874e+02  1.33511541e+03
  1.33511541e+03  1.33511541e+03  2.65458266e+03  3.02934094e+03
  3.02934094e+03  3.02934094e+03  6.64976963e+03  6.64976963e+03
  6.64976963e+03  9.06014605e+03  2.54157365e+04  7.61580871e+04]
E1 = -728.3332098747409  E_coul = 201.63132924807374
cycle= 4 E= -526.701880626667  delta_E= -8.75e-07  |g|= 6.31e-05  |ddm|= 0.00134
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000130629
diis-c [-1.37879985e-09  6.66263247e-05 -9.18299245e-03 -7.22547088e-02
  1.08137107e+00]
  HOMO = -0.575945451387998  LUMO = 1.01620954373724
  mo_energy =
[-1.18575811e+02 -1.23057475e+01 -9.55860657e+00 -9.55860657e+00
 -9.55860657e+00 -1.24997409e+00 -5.75945451e-01 -5.75945451e-01
 -5.75945451e-01  1.01620954e+00  1.01620954e+00  1.01620954e+00
  7.27342963e+00  7.27342963e+00  7.27342963e+00  9.42794010e+00
  3.33901041e+01  3.33901041e+01  3.33901041e+01  1.03344672e+02
  1.28945770e+02  1.28945770e+02  1.28945770e+02  4.83287030e+02
  4.83287030e+02  4.83287030e+02  5.85780860e+02  1.33511539e+03
  1.33511539e+03  1.33511539e+03  2.65458263e+03  3.02934091e+03
  3.02934091e+03  3.02934091e+03  6.64976959e+03  6.64976959e+03
  6.64976959e+03  9.06014600e+03  2.54157365e+04  7.61580870e+04]
E1 = -728.3332136190087  E_coul = 201.63133299221323
cycle= 5 E= -526.701880626795  delta_E= -1.28e-10  |g|= 7.99e-06  |ddm|= 2.62e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3332136190087  E_coul = 201.63133299221323
  HOMO = -0.575948999970823  LUMO = 1.01620695859772
  mo_energy =
[-1.18575829e+02 -1.23057600e+01 -9.55861971e+00 -9.55861971e+00
 -9.55861971e+00 -1.24997844e+00 -5.75949000e-01 -5.75949000e-01
 -5.75949000e-01  1.01620696e+00  1.01620696e+00  1.01620696e+00
  7.27342101e+00  7.27342101e+00  7.27342101e+00  9.42793006e+00
  3.33900912e+01  3.33900912e+01  3.33900912e+01  1.03344657e+02
  1.28945754e+02  1.28945754e+02  1.28945754e+02  4.83287013e+02
  4.83287013e+02  4.83287013e+02  5.85780842e+02  1.33511538e+03
  1.33511538e+03  1.33511538e+03  2.65458261e+03  3.02934090e+03
  3.02934090e+03  3.02934090e+03  6.64976957e+03  6.64976957e+03
  6.64976957e+03  9.06014599e+03  2.54157365e+04  7.61580870e+04]
E1 = -728.3332533149776  E_coul = 201.63137268817985
Extra cycle  E= -526.701880626798  delta_E= -2.27e-12  |g|= 2.37e-06  |ddm|= 4.11e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.22 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102380.74708944389
E1 = -728.3332533149776  E_coul = 201.63137268817985
init E= -526.701880626798
    CPU time for initialize scf      3.75 sec, wall time      0.20 sec
  HOMO = -0.575948272308633  LUMO = 1.01620749500084
  mo_energy =
[-1.18575824e+02 -1.23057571e+01 -9.55861670e+00 -9.55861670e+00
 -9.55861670e+00 -1.24997753e+00 -5.75948272e-01 -5.75948272e-01
 -5.75948272e-01  1.01620750e+00  1.01620750e+00  1.01620750e+00
  7.27342286e+00  7.27342286e+00  7.27342286e+00  9.42793236e+00
  3.33900942e+01  3.33900942e+01  3.33900942e+01  1.03344661e+02
  1.28945758e+02  1.28945758e+02  1.28945758e+02  4.83287017e+02
  4.83287017e+02  4.83287017e+02  5.85780847e+02  1.33511538e+03
  1.33511538e+03  1.33511538e+03  2.65458261e+03  3.02934090e+03
  3.02934090e+03  3.02934090e+03  6.64976958e+03  6.64976958e+03
  6.64976958e+03  9.06014599e+03  2.54157365e+04  7.61580870e+04]
E1 = -728.3332438329093  E_coul = 201.63136320611
cycle= 1 E= -526.701880626799  delta_E= -1.59e-12  |g|= 6.13e-07  |ddm|= 9.5e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3332438329093  E_coul = 201.63136320611
  HOMO = -0.575948433954231  LUMO = 1.01620737519518
  mo_energy =
[-1.18575826e+02 -1.23057578e+01 -9.55861742e+00 -9.55861742e+00
 -9.55861742e+00 -1.24997773e+00 -5.75948434e-01 -5.75948434e-01
 -5.75948434e-01  1.01620738e+00  1.01620738e+00  1.01620738e+00
  7.27342243e+00  7.27342243e+00  7.27342243e+00  9.42793183e+00
  3.33900934e+01  3.33900934e+01  3.33900934e+01  1.03344660e+02
  1.28945757e+02  1.28945757e+02  1.28945757e+02  4.83287016e+02
  4.83287016e+02  4.83287016e+02  5.85780846e+02  1.33511538e+03
  1.33511538e+03  1.33511538e+03  2.65458261e+03  3.02934090e+03
  3.02934090e+03  3.02934090e+03  6.64976958e+03  6.64976958e+03
  6.64976958e+03  9.06014599e+03  2.54157365e+04  7.61580870e+04]
E1 = -728.3332461567742  E_coul = 201.63136552997517
Extra cycle  E= -526.701880626799  delta_E= 2.27e-13  |g|= 1.55e-07  |ddm|= 2.23e-07
    CPU time for scf_cycle      3.86 sec, wall time      0.31 sec
exp = [2.61826565e+04 7.61752061e+03 3.61735150e+03 1.59779860e+03
 3.82845975e+02 1.08357511e+02 3.56174158e+01 7.88042988e+00
 3.06975330e+00 3.98724911e-01 1.36278341e+03 6.64743686e+02
 3.00952582e+02 3.14034161e+02 6.16293081e+01 7.32600533e+00
 2.02363385e+01 7.72487112e-01 2.81358715e+00 2.22523593e-01]
grad_E = [-1.50775686e-06  3.20198377e-06 -1.63246844e-06  6.50864992e-05
  1.14907216e-04 -1.66121157e-03  5.33993585e-04  1.78599359e-04
 -5.07613459e-04  1.50399368e-03 -5.03864351e-07  5.04870547e-06
  2.38703601e-05  2.05792096e-05 -4.93007961e-05 -8.90499728e-04
  2.90942608e-04  2.08977997e-03  9.53641917e-04 -1.00649884e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:57:51 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6564862        1
[INPUT] 0    0    [1    /1   ]  7617.52055131        1
[INPUT] 0    0    [1    /1   ]  3617.35152848        1
[INPUT] 0    0    [1    /1   ]  1597.7973808         1
[INPUT] 0    0    [1    /1   ]  382.843680753        1
[INPUT] 0    0    [1    /1   ]  108.389516519        1
[INPUT] 0    0    [1    /1   ]  35.60483975          1
[INPUT] 0    0    [1    /1   ]  7.91085218684        1
[INPUT] 0    0    [1    /1   ]  3.07473884242        1
[INPUT] 0    0    [1    /1   ]  0.398910782063       1
[INPUT] 1    0    [1    /1   ]  1362.78341752        1
[INPUT] 1    0    [1    /1   ]  664.743591653        1
[INPUT] 1    0    [1    /1   ]  300.952136041        1
[INPUT] 1    0    [1    /1   ]  314.033776664        1
[INPUT] 1    0    [1    /1   ]  61.6300068569        1
[INPUT] 1    0    [1    /1   ]  7.3282157744         1
[INPUT] 1    0    [1    /1   ]  20.2337124105        1
[INPUT] 1    0    [1    /1   ]  0.772366514427       1
[INPUT] 1    0    [1    /1   ]  2.81990733385        1
[INPUT] 1    0    [1    /1   ]  0.222136429958       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.65648623325, 1.0]], [0, [7617.520551306088, 1.0]], [0, [3617.3515284766163, 1.0]], [0, [1597.7973807993278, 1.0]], [0, [382.84368075268986, 1.0]], [0, [108.38951651869493, 1.0]], [0, [35.60483975000319, 1.0]], [0, [7.910852186836633, 1.0]], [0, [3.074738842417663, 1.0]], [0, [0.39891078206250546, 1.0]], [1, [1362.7834175213336, 1.0]], [1, [664.7435916532804, 1.0]], [1, [300.95213604144163, 1.0]], [1, [314.0337766635407, 1.0]], [1, [61.63000685689374, 1.0]], [1, [7.328215774399799, 1.0]], [1, [20.233712410490654, 1.0]], [1, [0.7723665144268984, 1.0]], [1, [2.8199073338504976, 1.0]], [1, [0.22213642995820873, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65648623]
bas 1, expnt(s) = [7617.52055131]
bas 2, expnt(s) = [3617.35152848]
bas 3, expnt(s) = [1597.7973808]
bas 4, expnt(s) = [382.84368075]
bas 5, expnt(s) = [108.38951652]
bas 6, expnt(s) = [35.60483975]
bas 7, expnt(s) = [7.91085219]
bas 8, expnt(s) = [3.07473884]
bas 9, expnt(s) = [0.39891078]
bas 10, expnt(s) = [1362.78341752]
bas 11, expnt(s) = [664.74359165]
bas 12, expnt(s) = [300.95213604]
bas 13, expnt(s) = [314.03377666]
bas 14, expnt(s) = [61.63000686]
bas 15, expnt(s) = [7.32821577]
bas 16, expnt(s) = [20.23371241]
bas 17, expnt(s) = [0.77236651]
bas 18, expnt(s) = [2.81990733]
bas 19, expnt(s) = [0.22213643]
CPU time:       912.09
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826565e+04 5.20026296e+03 7.61752055e+03 2.06003809e+03
 3.61735153e+03 1.17844159e+03 1.59779738e+03 6.38493239e+02
 3.82843681e+02 2.18665938e+02 1.08389517e+02 8.48702504e+01
 3.56048398e+01 3.68253430e+01 7.91085219e+00 1.19174263e+01
 3.07473884e+00 5.86639362e+00 3.98910782e-01 1.26815359e+00
 1.36278342e+03 2.41556063e+04 6.64743592e+02 9.84695814e+03
 3.00952136e+02 3.65684186e+03 3.14033777e+02 3.85660221e+03
 6.16300069e+01 5.03761139e+02 7.32821577e+00 3.51748459e+01
 2.02337124e+01 1.25192658e+02 7.72366514e-01 2.11233935e+00
 2.81990733e+00 1.06605089e+01 2.22136430e-01 4.44896642e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.983074376012805
cond(S) = 102394.50467060402
E1 = -729.3801006872071  E_coul = 203.1254830389748
init E= -526.254617648232
    CPU time for initialize scf      0.63 sec, wall time      0.05 sec
  HOMO = -0.556877715117003  LUMO = 1.02653345837595
  mo_energy =
[-1.18331177e+02 -1.22077507e+01 -9.45124263e+00 -9.45124263e+00
 -9.45124263e+00 -1.22561153e+00 -5.56877715e-01 -5.56877715e-01
 -5.56877715e-01  1.02653346e+00  1.02653346e+00  1.02653346e+00
  7.34354638e+00  7.34354638e+00  7.34354638e+00  9.54125225e+00
  3.35271044e+01  3.35271044e+01  3.35271044e+01  1.03643760e+02
  1.29141182e+02  1.29141182e+02  1.29141182e+02  4.83546390e+02
  4.83546390e+02  4.83546390e+02  5.86232198e+02  1.33542510e+03
  1.33542510e+03  1.33542510e+03  2.65519468e+03  3.02971334e+03
  3.02971334e+03  3.02971334e+03  6.65025249e+03  6.65025249e+03
  6.65025249e+03  9.06086653e+03  2.54165412e+04  7.61589704e+04]
E1 = -727.9498415335536  E_coul = 201.24856726801477
cycle= 1 E= -526.701274265539  delta_E= -0.447  |g|= 0.185  |ddm|= 0.416
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.541188
diis-c [-0.29288393  1.        ]
  HOMO = -0.582047173090943  LUMO = 1.0100657644617
  mo_energy =
[-1.18627931e+02 -1.23332927e+01 -9.58720607e+00 -9.58720607e+00
 -9.58720607e+00 -1.25776672e+00 -5.82047173e-01 -5.82047173e-01
 -5.82047173e-01  1.01006576e+00  1.01006576e+00  1.01006576e+00
  7.26616799e+00  7.26616799e+00  7.26616799e+00  9.45086013e+00
  3.33854140e+01  3.33854140e+01  3.33854140e+01  1.03435612e+02
  1.28924767e+02  1.28924767e+02  1.28924767e+02  4.83251018e+02
  4.83251018e+02  4.83251018e+02  5.85898902e+02  1.33507328e+03
  1.33507328e+03  1.33507328e+03  2.65470775e+03  3.02929490e+03
  3.02929490e+03  3.02929490e+03  6.64972049e+03  6.64972049e+03
  6.64972049e+03  9.06025901e+03  2.54158397e+04  7.61581787e+04]
E1 = -728.4224682370742  E_coul = 201.72058411660728
cycle= 2 E= -526.701884120467  delta_E= -0.00061  |g|= 0.034  |ddm|= 0.0396
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0678324
diis-c [-0.00272741  0.07438411  0.92561589]
  HOMO = -0.575169620968313  LUMO = 1.0152358513977
  mo_energy =
[-1.18568378e+02 -1.23018852e+01 -9.55447373e+00 -9.55447373e+00
 -9.55447373e+00 -1.24903831e+00 -5.75169621e-01 -5.75169621e-01
 -5.75169621e-01  1.01523585e+00  1.01523585e+00  1.01523585e+00
  7.28503108e+00  7.28503108e+00  7.28503108e+00  9.47534284e+00
  3.34187610e+01  3.34187610e+01  3.34187610e+01  1.03483874e+02
  1.28973036e+02  1.28973036e+02  1.28973036e+02  4.83309815e+02
  4.83309815e+02  4.83309815e+02  5.85959957e+02  1.33513592e+03
  1.33513592e+03  1.33513592e+03  2.65477344e+03  3.02935963e+03
  3.02935963e+03  3.02935963e+03  6.64978678e+03  6.64978678e+03
  6.64978678e+03  9.06032602e+03  2.54159071e+04  7.61582464e+04]
E1 = -728.3150105103375  E_coul = 201.61309021163447
cycle= 3 E= -526.701920298703  delta_E= -3.62e-05  |g|= 0.0049  |ddm|= 0.0105
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106322
diis-c [-4.77956849e-07 -1.15324897e-03  1.30769773e-01  8.70383476e-01]
  HOMO = -0.57611192047304  LUMO = 1.01453868696764
  mo_energy =
[-1.18576059e+02 -1.23059995e+01 -9.55886803e+00 -9.55886803e+00
 -9.55886803e+00 -1.25017908e+00 -5.76111920e-01 -5.76111920e-01
 -5.76111920e-01  1.01453869e+00  1.01453869e+00  1.01453869e+00
  7.28247465e+00  7.28247465e+00  7.28247465e+00  9.47222273e+00
  3.34143151e+01  3.34143151e+01  3.34143151e+01  1.03477652e+02
  1.28966756e+02  1.28966756e+02  1.28966756e+02  4.83302232e+02
  4.83302232e+02  4.83302232e+02  5.85952053e+02  1.33512781e+03
  1.33512781e+03  1.33512781e+03  2.65476476e+03  3.02935117e+03
  3.02935117e+03  3.02935117e+03  6.64977797e+03  6.64977797e+03
  6.64977797e+03  9.06031701e+03  2.54158980e+04  7.61582371e+04]
E1 = -728.3295609168672  E_coul = 201.62763974052754
cycle= 4 E= -526.70192117634  delta_E= -8.78e-07  |g|= 6.29e-05  |ddm|= 0.00134
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000130817
diis-c [-1.37443019e-09  6.65517373e-05 -9.17032631e-03 -7.22185826e-02
  1.08132236e+00]
  HOMO = -0.576099985740361  LUMO = 1.01454752655631
  mo_energy =
[-1.18576066e+02 -1.23059714e+01 -9.55885226e+00 -9.55885226e+00
 -9.55885226e+00 -1.25015978e+00 -5.76099986e-01 -5.76099986e-01
 -5.76099986e-01  1.01454753e+00  1.01454753e+00  1.01454753e+00
  7.28249453e+00  7.28249453e+00  7.28249453e+00  9.47225809e+00
  3.34143296e+01  3.34143296e+01  3.34143296e+01  1.03477661e+02
  1.28966762e+02  1.28966762e+02  1.28966762e+02  4.83302225e+02
  4.83302225e+02  4.83302225e+02  5.85952039e+02  1.33512780e+03
  1.33512780e+03  1.33512780e+03  2.65476472e+03  3.02935115e+03
  3.02935115e+03  3.02935115e+03  6.64977793e+03  6.64977793e+03
  6.64977793e+03  9.06031696e+03  2.54158979e+04  7.61582370e+04]
E1 = -728.3295649574056  E_coul = 201.6276437809408
cycle= 5 E= -526.701921176465  delta_E= -1.25e-10  |g|= 7.98e-06  |ddm|= 2.59e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3295649574056  E_coul = 201.6276437809408
  HOMO = -0.576103534397759  LUMO = 1.01454494222886
  mo_energy =
[-1.18576084e+02 -1.23059839e+01 -9.55886539e+00 -9.55886539e+00
 -9.55886539e+00 -1.25016414e+00 -5.76103534e-01 -5.76103534e-01
 -5.76103534e-01  1.01454494e+00  1.01454494e+00  1.01454494e+00
  7.28248591e+00  7.28248591e+00  7.28248591e+00  9.47224804e+00
  3.34143167e+01  3.34143167e+01  3.34143167e+01  1.03477646e+02
  1.28966746e+02  1.28966746e+02  1.28966746e+02  4.83302208e+02
  4.83302208e+02  4.83302208e+02  5.85952021e+02  1.33512778e+03
  1.33512778e+03  1.33512778e+03  2.65476470e+03  3.02935113e+03
  3.02935113e+03  3.02935113e+03  6.64977791e+03  6.64977791e+03
  6.64977791e+03  9.06031694e+03  2.54158979e+04  7.61582370e+04]
E1 = -728.3296046299948  E_coul = 201.62768345352518
Extra cycle  E= -526.70192117647  delta_E= -4.89e-12  |g|= 2.37e-06  |ddm|= 4.11e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.23 sec
exp = [2.61826565e+04 7.61752055e+03 3.61735153e+03 1.59779738e+03
 3.82843681e+02 1.08389517e+02 3.56048398e+01 7.91085219e+00
 3.07473884e+00 3.98910782e-01 1.36278342e+03 6.64743592e+02
 3.00952136e+02 3.14033777e+02 6.16300069e+01 7.32821577e+00
 2.02337124e+01 7.72366514e-01 2.81990733e+00 2.22136430e-01]
E = -526.7019211764697
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:57:51 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6564862        1
[INPUT] 0    0    [1    /1   ]  7617.52055131        1
[INPUT] 0    0    [1    /1   ]  3617.35152848        1
[INPUT] 0    0    [1    /1   ]  1597.7973808         1
[INPUT] 0    0    [1    /1   ]  382.843680753        1
[INPUT] 0    0    [1    /1   ]  108.389516519        1
[INPUT] 0    0    [1    /1   ]  35.60483975          1
[INPUT] 0    0    [1    /1   ]  7.91085218684        1
[INPUT] 0    0    [1    /1   ]  3.07473884242        1
[INPUT] 0    0    [1    /1   ]  0.398910782063       1
[INPUT] 1    0    [1    /1   ]  1362.78341752        1
[INPUT] 1    0    [1    /1   ]  664.743591653        1
[INPUT] 1    0    [1    /1   ]  300.952136041        1
[INPUT] 1    0    [1    /1   ]  314.033776664        1
[INPUT] 1    0    [1    /1   ]  61.6300068569        1
[INPUT] 1    0    [1    /1   ]  7.3282157744         1
[INPUT] 1    0    [1    /1   ]  20.2337124105        1
[INPUT] 1    0    [1    /1   ]  0.772366514427       1
[INPUT] 1    0    [1    /1   ]  2.81990733385        1
[INPUT] 1    0    [1    /1   ]  0.222136429958       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.65648623325, 1.0]], [0, [7617.520551306088, 1.0]], [0, [3617.3515284766163, 1.0]], [0, [1597.7973807993278, 1.0]], [0, [382.84368075268986, 1.0]], [0, [108.38951651869493, 1.0]], [0, [35.60483975000319, 1.0]], [0, [7.910852186836633, 1.0]], [0, [3.074738842417663, 1.0]], [0, [0.39891078206250546, 1.0]], [1, [1362.7834175213336, 1.0]], [1, [664.7435916532804, 1.0]], [1, [300.95213604144163, 1.0]], [1, [314.0337766635407, 1.0]], [1, [61.63000685689374, 1.0]], [1, [7.328215774399799, 1.0]], [1, [20.233712410490654, 1.0]], [1, [0.7723665144268984, 1.0]], [1, [2.8199073338504976, 1.0]], [1, [0.22213642995820873, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65648623]
bas 1, expnt(s) = [7617.52055131]
bas 2, expnt(s) = [3617.35152848]
bas 3, expnt(s) = [1597.7973808]
bas 4, expnt(s) = [382.84368075]
bas 5, expnt(s) = [108.38951652]
bas 6, expnt(s) = [35.60483975]
bas 7, expnt(s) = [7.91085219]
bas 8, expnt(s) = [3.07473884]
bas 9, expnt(s) = [0.39891078]
bas 10, expnt(s) = [1362.78341752]
bas 11, expnt(s) = [664.74359165]
bas 12, expnt(s) = [300.95213604]
bas 13, expnt(s) = [314.03377666]
bas 14, expnt(s) = [61.63000686]
bas 15, expnt(s) = [7.32821577]
bas 16, expnt(s) = [20.23371241]
bas 17, expnt(s) = [0.77236651]
bas 18, expnt(s) = [2.81990733]
bas 19, expnt(s) = [0.22213643]
CPU time:       913.05
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826565e+04 5.20026296e+03 7.61752055e+03 2.06003809e+03
 3.61735153e+03 1.17844159e+03 1.59779738e+03 6.38493239e+02
 3.82843681e+02 2.18665938e+02 1.08389517e+02 8.48702504e+01
 3.56048398e+01 3.68253430e+01 7.91085219e+00 1.19174263e+01
 3.07473884e+00 5.86639362e+00 3.98910782e-01 1.26815359e+00
 1.36278342e+03 2.41556063e+04 6.64743592e+02 9.84695814e+03
 3.00952136e+02 3.65684186e+03 3.14033777e+02 3.85660221e+03
 6.16300069e+01 5.03761139e+02 7.32821577e+00 3.51748459e+01
 2.02337124e+01 1.25192658e+02 7.72366514e-01 2.11233935e+00
 2.81990733e+00 1.06605089e+01 2.22136430e-01 4.44896642e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.983074376012805
cond(S) = 102394.50467060402
E1 = -729.3801006872071  E_coul = 203.1254830389748
init E= -526.254617648232
    CPU time for initialize scf      0.63 sec, wall time      0.05 sec
  HOMO = -0.556877715117003  LUMO = 1.02653345837595
  mo_energy =
[-1.18331177e+02 -1.22077507e+01 -9.45124263e+00 -9.45124263e+00
 -9.45124263e+00 -1.22561153e+00 -5.56877715e-01 -5.56877715e-01
 -5.56877715e-01  1.02653346e+00  1.02653346e+00  1.02653346e+00
  7.34354638e+00  7.34354638e+00  7.34354638e+00  9.54125225e+00
  3.35271044e+01  3.35271044e+01  3.35271044e+01  1.03643760e+02
  1.29141182e+02  1.29141182e+02  1.29141182e+02  4.83546390e+02
  4.83546390e+02  4.83546390e+02  5.86232198e+02  1.33542510e+03
  1.33542510e+03  1.33542510e+03  2.65519468e+03  3.02971334e+03
  3.02971334e+03  3.02971334e+03  6.65025249e+03  6.65025249e+03
  6.65025249e+03  9.06086653e+03  2.54165412e+04  7.61589704e+04]
E1 = -727.9498415335536  E_coul = 201.24856726801477
cycle= 1 E= -526.701274265539  delta_E= -0.447  |g|= 0.185  |ddm|= 0.416
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.541188
diis-c [-0.29288393  1.        ]
  HOMO = -0.582047173090943  LUMO = 1.0100657644617
  mo_energy =
[-1.18627931e+02 -1.23332927e+01 -9.58720607e+00 -9.58720607e+00
 -9.58720607e+00 -1.25776672e+00 -5.82047173e-01 -5.82047173e-01
 -5.82047173e-01  1.01006576e+00  1.01006576e+00  1.01006576e+00
  7.26616799e+00  7.26616799e+00  7.26616799e+00  9.45086013e+00
  3.33854140e+01  3.33854140e+01  3.33854140e+01  1.03435612e+02
  1.28924767e+02  1.28924767e+02  1.28924767e+02  4.83251018e+02
  4.83251018e+02  4.83251018e+02  5.85898902e+02  1.33507328e+03
  1.33507328e+03  1.33507328e+03  2.65470775e+03  3.02929490e+03
  3.02929490e+03  3.02929490e+03  6.64972049e+03  6.64972049e+03
  6.64972049e+03  9.06025901e+03  2.54158397e+04  7.61581787e+04]
E1 = -728.4224682370742  E_coul = 201.72058411660728
cycle= 2 E= -526.701884120467  delta_E= -0.00061  |g|= 0.034  |ddm|= 0.0396
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0678324
diis-c [-0.00272741  0.07438411  0.92561589]
  HOMO = -0.575169620968313  LUMO = 1.0152358513977
  mo_energy =
[-1.18568378e+02 -1.23018852e+01 -9.55447373e+00 -9.55447373e+00
 -9.55447373e+00 -1.24903831e+00 -5.75169621e-01 -5.75169621e-01
 -5.75169621e-01  1.01523585e+00  1.01523585e+00  1.01523585e+00
  7.28503108e+00  7.28503108e+00  7.28503108e+00  9.47534284e+00
  3.34187610e+01  3.34187610e+01  3.34187610e+01  1.03483874e+02
  1.28973036e+02  1.28973036e+02  1.28973036e+02  4.83309815e+02
  4.83309815e+02  4.83309815e+02  5.85959957e+02  1.33513592e+03
  1.33513592e+03  1.33513592e+03  2.65477344e+03  3.02935963e+03
  3.02935963e+03  3.02935963e+03  6.64978678e+03  6.64978678e+03
  6.64978678e+03  9.06032602e+03  2.54159071e+04  7.61582464e+04]
E1 = -728.3150105103375  E_coul = 201.61309021163447
cycle= 3 E= -526.701920298703  delta_E= -3.62e-05  |g|= 0.0049  |ddm|= 0.0105
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106322
diis-c [-4.77956849e-07 -1.15324897e-03  1.30769773e-01  8.70383476e-01]
  HOMO = -0.57611192047304  LUMO = 1.01453868696764
  mo_energy =
[-1.18576059e+02 -1.23059995e+01 -9.55886803e+00 -9.55886803e+00
 -9.55886803e+00 -1.25017908e+00 -5.76111920e-01 -5.76111920e-01
 -5.76111920e-01  1.01453869e+00  1.01453869e+00  1.01453869e+00
  7.28247465e+00  7.28247465e+00  7.28247465e+00  9.47222273e+00
  3.34143151e+01  3.34143151e+01  3.34143151e+01  1.03477652e+02
  1.28966756e+02  1.28966756e+02  1.28966756e+02  4.83302232e+02
  4.83302232e+02  4.83302232e+02  5.85952053e+02  1.33512781e+03
  1.33512781e+03  1.33512781e+03  2.65476476e+03  3.02935117e+03
  3.02935117e+03  3.02935117e+03  6.64977797e+03  6.64977797e+03
  6.64977797e+03  9.06031701e+03  2.54158980e+04  7.61582371e+04]
E1 = -728.3295609168672  E_coul = 201.62763974052754
cycle= 4 E= -526.70192117634  delta_E= -8.78e-07  |g|= 6.29e-05  |ddm|= 0.00134
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000130817
diis-c [-1.37443019e-09  6.65517373e-05 -9.17032631e-03 -7.22185826e-02
  1.08132236e+00]
  HOMO = -0.576099985740361  LUMO = 1.01454752655631
  mo_energy =
[-1.18576066e+02 -1.23059714e+01 -9.55885226e+00 -9.55885226e+00
 -9.55885226e+00 -1.25015978e+00 -5.76099986e-01 -5.76099986e-01
 -5.76099986e-01  1.01454753e+00  1.01454753e+00  1.01454753e+00
  7.28249453e+00  7.28249453e+00  7.28249453e+00  9.47225809e+00
  3.34143296e+01  3.34143296e+01  3.34143296e+01  1.03477661e+02
  1.28966762e+02  1.28966762e+02  1.28966762e+02  4.83302225e+02
  4.83302225e+02  4.83302225e+02  5.85952039e+02  1.33512780e+03
  1.33512780e+03  1.33512780e+03  2.65476472e+03  3.02935115e+03
  3.02935115e+03  3.02935115e+03  6.64977793e+03  6.64977793e+03
  6.64977793e+03  9.06031696e+03  2.54158979e+04  7.61582370e+04]
E1 = -728.3295649574056  E_coul = 201.6276437809408
cycle= 5 E= -526.701921176465  delta_E= -1.25e-10  |g|= 7.98e-06  |ddm|= 2.59e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3295649574056  E_coul = 201.6276437809408
  HOMO = -0.576103534397759  LUMO = 1.01454494222886
  mo_energy =
[-1.18576084e+02 -1.23059839e+01 -9.55886539e+00 -9.55886539e+00
 -9.55886539e+00 -1.25016414e+00 -5.76103534e-01 -5.76103534e-01
 -5.76103534e-01  1.01454494e+00  1.01454494e+00  1.01454494e+00
  7.28248591e+00  7.28248591e+00  7.28248591e+00  9.47224804e+00
  3.34143167e+01  3.34143167e+01  3.34143167e+01  1.03477646e+02
  1.28966746e+02  1.28966746e+02  1.28966746e+02  4.83302208e+02
  4.83302208e+02  4.83302208e+02  5.85952021e+02  1.33512778e+03
  1.33512778e+03  1.33512778e+03  2.65476470e+03  3.02935113e+03
  3.02935113e+03  3.02935113e+03  6.64977791e+03  6.64977791e+03
  6.64977791e+03  9.06031694e+03  2.54158979e+04  7.61582370e+04]
E1 = -728.3296046299948  E_coul = 201.62768345352518
Extra cycle  E= -526.70192117647  delta_E= -4.89e-12  |g|= 2.37e-06  |ddm|= 4.11e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102394.50467060402
E1 = -728.3296046299948  E_coul = 201.62768345352518
init E= -526.70192117647
    CPU time for initialize scf      3.75 sec, wall time      0.20 sec
  HOMO = -0.576102806654529  LUMO = 1.01454547844439
  mo_energy =
[-1.18576079e+02 -1.23059810e+01 -9.55886238e+00 -9.55886238e+00
 -9.55886238e+00 -1.25016323e+00 -5.76102807e-01 -5.76102807e-01
 -5.76102807e-01  1.01454548e+00  1.01454548e+00  1.01454548e+00
  7.28248776e+00  7.28248776e+00  7.28248776e+00  9.47225034e+00
  3.34143197e+01  3.34143197e+01  3.34143197e+01  1.03477650e+02
  1.28966750e+02  1.28966750e+02  1.28966750e+02  4.83302212e+02
  4.83302212e+02  4.83302212e+02  5.85952026e+02  1.33512778e+03
  1.33512778e+03  1.33512778e+03  2.65476471e+03  3.02935113e+03
  3.02935113e+03  3.02935113e+03  6.64977792e+03  6.64977792e+03
  6.64977792e+03  9.06031695e+03  2.54158979e+04  7.61582370e+04]
E1 = -728.3295951494209  E_coul = 201.62767397295107
cycle= 1 E= -526.70192117647  delta_E= -1.14e-13  |g|= 6.12e-07  |ddm|= 9.49e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3295951494209  E_coul = 201.62767397295107
  HOMO = -0.576102968419535  LUMO = 1.01454535860315
  mo_energy =
[-1.18576080e+02 -1.23059817e+01 -9.55886310e+00 -9.55886310e+00
 -9.55886310e+00 -1.25016343e+00 -5.76102968e-01 -5.76102968e-01
 -5.76102968e-01  1.01454536e+00  1.01454536e+00  1.01454536e+00
  7.28248734e+00  7.28248734e+00  7.28248734e+00  9.47224981e+00
  3.34143190e+01  3.34143190e+01  3.34143190e+01  1.03477649e+02
  1.28966749e+02  1.28966749e+02  1.28966749e+02  4.83302211e+02
  4.83302211e+02  4.83302211e+02  5.85952024e+02  1.33512778e+03
  1.33512778e+03  1.33512778e+03  2.65476471e+03  3.02935113e+03
  3.02935113e+03  3.02935113e+03  6.64977791e+03  6.64977791e+03
  6.64977791e+03  9.06031694e+03  2.54158979e+04  7.61582370e+04]
E1 = -728.3295974733768  E_coul = 201.62767629690805
Extra cycle  E= -526.701921176469  delta_E= 1.02e-12  |g|= 1.55e-07  |ddm|= 2.23e-07
    CPU time for scf_cycle      3.87 sec, wall time      0.31 sec
exp = [2.61826565e+04 7.61752055e+03 3.61735153e+03 1.59779738e+03
 3.82843681e+02 1.08389517e+02 3.56048398e+01 7.91085219e+00
 3.07473884e+00 3.98910782e-01 1.36278342e+03 6.64743592e+02
 3.00952136e+02 3.14033777e+02 6.16300069e+01 7.32821577e+00
 2.02337124e+01 7.72366514e-01 2.81990733e+00 2.22136430e-01]
grad_E = [-1.50865946e-06  3.21158377e-06 -1.62823932e-06  6.54597281e-05
  1.03512539e-04 -1.58762991e-03  3.92636369e-04  4.99971452e-04
 -1.11647546e-03  2.98542497e-03 -5.03838544e-07  5.04904475e-06
  2.38741408e-05  2.05822628e-05 -5.20349076e-05 -1.38651509e-03
  3.60262520e-04  3.94986416e-03  1.91412296e-03 -1.89349803e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:57:55 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.656594         1
[INPUT] 0    0    [1    /1   ]  7617.52032165        1
[INPUT] 0    0    [1    /1   ]  3617.35164453        1
[INPUT] 0    0    [1    /1   ]  1597.7926932         1
[INPUT] 0    0    [1    /1   ]  382.836894591        1
[INPUT] 0    0    [1    /1   ]  108.493193285        1
[INPUT] 0    0    [1    /1   ]  35.6073961917        1
[INPUT] 0    0    [1    /1   ]  7.95878217842        1
[INPUT] 0    0    [1    /1   ]  3.08308307418        1
[INPUT] 0    0    [1    /1   ]  0.399184878891       1
[INPUT] 1    0    [1    /1   ]  1362.78345363        1
[INPUT] 1    0    [1    /1   ]  664.743232709        1
[INPUT] 1    0    [1    /1   ]  300.950441303        1
[INPUT] 1    0    [1    /1   ]  314.032315532        1
[INPUT] 1    0    [1    /1   ]  61.6321803827        1
[INPUT] 1    0    [1    /1   ]  7.33525188963        1
[INPUT] 1    0    [1    /1   ]  20.2268222183        1
[INPUT] 1    0    [1    /1   ]  0.772511224213       1
[INPUT] 1    0    [1    /1   ]  2.83260698249        1
[INPUT] 1    0    [1    /1   ]  0.221638328555       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.65659400107, 1.0]], [0, [7617.520321653033, 1.0]], [0, [3617.3516445302594, 1.0]], [0, [1597.7926931992833, 1.0]], [0, [382.83689459088475, 1.0]], [0, [108.49319328499874, 1.0]], [0, [35.607396191738964, 1.0]], [0, [7.958782178418724, 1.0]], [0, [3.08308307418116, 1.0]], [0, [0.39918487889085286, 1.0]], [1, [1362.7834536281725, 1.0]], [1, [664.7432327090127, 1.0]], [1, [300.9504413028476, 1.0]], [1, [314.0323155320424, 1.0]], [1, [61.632180382739264, 1.0]], [1, [7.335251889625853, 1.0]], [1, [20.226822218267017, 1.0]], [1, [0.7725112242132686, 1.0]], [1, [2.8326069824888447, 1.0]], [1, [0.2216383285550127, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.656594]
bas 1, expnt(s) = [7617.52032165]
bas 2, expnt(s) = [3617.35164453]
bas 3, expnt(s) = [1597.7926932]
bas 4, expnt(s) = [382.83689459]
bas 5, expnt(s) = [108.49319328]
bas 6, expnt(s) = [35.60739619]
bas 7, expnt(s) = [7.95878218]
bas 8, expnt(s) = [3.08308307]
bas 9, expnt(s) = [0.39918488]
bas 10, expnt(s) = [1362.78345363]
bas 11, expnt(s) = [664.74323271]
bas 12, expnt(s) = [300.9504413]
bas 13, expnt(s) = [314.03231553]
bas 14, expnt(s) = [61.63218038]
bas 15, expnt(s) = [7.33525189]
bas 16, expnt(s) = [20.22682222]
bas 17, expnt(s) = [0.77251122]
bas 18, expnt(s) = [2.83260698]
bas 19, expnt(s) = [0.22163833]
CPU time:       922.52
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826566e+04 5.20026298e+03 7.61752032e+03 2.06003804e+03
 3.61735164e+03 1.17844162e+03 1.59779269e+03 6.38491834e+02
 3.82836895e+02 2.18663031e+02 1.08493193e+02 8.49311282e+01
 3.56073962e+01 3.68273261e+01 7.95878218e+00 1.19715391e+01
 3.08308307e+00 5.87832975e+00 3.99184879e-01 1.26880706e+00
 1.36278345e+03 2.41556071e+04 6.64743233e+02 9.84695149e+03
 3.00950441e+02 3.65681612e+03 3.14032316e+02 3.85657978e+03
 6.16321804e+01 5.03783347e+02 7.33525189e+00 3.52170669e+01
 2.02268222e+01 1.25139370e+02 7.72511224e-01 2.11283406e+00
 2.83260698e+00 1.07205556e+01 2.21638329e-01 4.43649989e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98306716259473
cond(S) = 102419.75440074867
E1 = -729.3820784769384  E_coul = 203.12656421153397
init E= -526.255514265404
    CPU time for initialize scf      0.63 sec, wall time      0.05 sec
  HOMO = -0.556853088649203  LUMO = 1.02482914861166
  mo_energy =
[-1.18331178e+02 -1.22076475e+01 -9.45115679e+00 -9.45115679e+00
 -9.45115679e+00 -1.22556134e+00 -5.56853089e-01 -5.56853089e-01
 -5.56853089e-01  1.02482915e+00  1.02482915e+00  1.02482915e+00
  7.36579685e+00  7.36579685e+00  7.36579685e+00  9.61387464e+00
  3.35835882e+01  3.35835882e+01  3.35835882e+01  1.03920436e+02
  1.29190889e+02  1.29190889e+02  1.29190889e+02  4.83582895e+02
  4.83582895e+02  4.83582895e+02  5.86719426e+02  1.33545407e+03
  1.33545407e+03  1.33545407e+03  2.65574691e+03  3.02973553e+03
  3.02973553e+03  3.02973553e+03  6.65026904e+03  6.65026904e+03
  6.65026904e+03  9.06138879e+03  2.54170344e+04  7.61594286e+04]
E1 = -727.9438995441066  E_coul = 201.24252657536167
cycle= 1 E= -526.701372968745  delta_E= -0.446  |g|= 0.185  |ddm|= 0.416
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.541617
diis-c [-0.29334909  1.        ]
  HOMO = -0.582281223122078  LUMO = 1.00817280617315
  mo_energy =
[-1.18628397e+02 -1.23336665e+01 -9.58761807e+00 -9.58761807e+00
 -9.58761807e+00 -1.25806058e+00 -5.82281223e-01 -5.82281223e-01
 -5.82281223e-01  1.00817281e+00  1.00817281e+00  1.00817281e+00
  7.28779972e+00  7.28779972e+00  7.28779972e+00  9.52270828e+00
  3.34414007e+01  3.34414007e+01  3.34414007e+01  1.03711648e+02
  1.28974018e+02  1.28974018e+02  1.28974018e+02  4.83287026e+02
  4.83287026e+02  4.83287026e+02  5.86385618e+02  1.33510174e+03
  1.33510174e+03  1.33510174e+03  2.65525955e+03  3.02931663e+03
  3.02931663e+03  3.02931663e+03  6.64973662e+03  6.64973662e+03
  6.64973662e+03  9.06078087e+03  2.54163324e+04  7.61586365e+04]
E1 = -728.417918122231  E_coul = 201.7159327571501
cycle= 2 E= -526.701985365081  delta_E= -0.000612  |g|= 0.034  |ddm|= 0.0397
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0679949
diis-c [-0.00273751  0.07454931  0.92545069]
  HOMO = -0.575378766422962  LUMO = 1.01336097097077
  mo_energy =
[-1.18568717e+02 -1.23021672e+01 -9.55479366e+00 -9.55479366e+00
 -9.55479366e+00 -1.24929800e+00 -5.75378766e-01 -5.75378766e-01
 -5.75378766e-01  1.01336097e+00  1.01336097e+00  1.01336097e+00
  7.30676108e+00  7.30676108e+00  7.30676108e+00  9.54733760e+00
  3.34748417e+01  3.34748417e+01  3.34748417e+01  1.03760034e+02
  1.29022396e+02  1.29022396e+02  1.29022396e+02  4.83345947e+02
  4.83345947e+02  4.83345947e+02  5.86446801e+02  1.33516451e+03
  1.33516451e+03  1.33516451e+03  2.65532538e+03  3.02938149e+03
  3.02938149e+03  3.02938149e+03  6.64980304e+03  6.64980304e+03
  6.64980304e+03  9.06084801e+03  2.54164000e+04  7.61587043e+04]
E1 = -728.3101267011125  E_coul = 201.6081049634491
cycle= 3 E= -526.702021737663  delta_E= -3.64e-05  |g|= 0.00491  |ddm|= 0.0105
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106482
diis-c [-4.78063481e-07 -1.15209645e-03  1.30674423e-01  8.70477673e-01]
  HOMO = -0.576324633830341  LUMO = 1.01266113907928
  mo_energy =
[-1.18576408e+02 -1.23062895e+01 -9.55919611e+00 -9.55919611e+00
 -9.55919611e+00 -1.25044392e+00 -5.76324634e-01 -5.76324634e-01
 -5.76324634e-01  1.01266114e+00  1.01266114e+00  1.01266114e+00
  7.30419271e+00  7.30419271e+00  7.30419271e+00  9.54420008e+00
  3.34703872e+01  3.34703872e+01  3.34703872e+01  1.03753800e+02
  1.29016107e+02  1.29016107e+02  1.29016107e+02  4.83338354e+02
  4.83338354e+02  4.83338354e+02  5.86438885e+02  1.33515639e+03
  1.33515639e+03  1.33515639e+03  2.65531668e+03  3.02937302e+03
  3.02937302e+03  3.02937302e+03  6.64979421e+03  6.64979421e+03
  6.64979421e+03  9.06083898e+03  2.54163908e+04  7.61586950e+04]
E1 = -728.3247057014789  E_coul = 201.62268308328595
cycle= 4 E= -526.702022618193  delta_E= -8.81e-07  |g|= 6.27e-05  |ddm|= 0.00134
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000131057
diis-c [-1.36604324e-09  6.64332531e-05 -9.15360249e-03 -7.21749334e-02
  1.08126210e+00]
  HOMO = -0.576312882642782  LUMO = 1.01266983616381
  mo_energy =
[-1.18576416e+02 -1.23062618e+01 -9.55918069e+00 -9.55918069e+00
 -9.55918069e+00 -1.25042489e+00 -5.76312883e-01 -5.76312883e-01
 -5.76312883e-01  1.01266984e+00  1.01266984e+00  1.01266984e+00
  7.30421226e+00  7.30421226e+00  7.30421226e+00  9.54423499e+00
  3.34704013e+01  3.34704013e+01  3.34704013e+01  1.03753809e+02
  1.29016112e+02  1.29016112e+02  1.29016112e+02  4.83338347e+02
  4.83338347e+02  4.83338347e+02  5.86438871e+02  1.33515638e+03
  1.33515638e+03  1.33515638e+03  2.65531665e+03  3.02937300e+03
  3.02937300e+03  3.02937300e+03  6.64979417e+03  6.64979417e+03
  6.64979417e+03  9.06083893e+03  2.54163907e+04  7.61586949e+04]
E1 = -728.3247101727841  E_coul = 201.62268755446735
cycle= 5 E= -526.702022618317  delta_E= -1.24e-10  |g|= 7.95e-06  |ddm|= 2.54e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3247101727841  E_coul = 201.62268755446735
  HOMO = -0.576316429659481  LUMO = 1.01266725270888
  mo_energy =
[-1.18576433e+02 -1.23062743e+01 -9.55919379e+00 -9.55919379e+00
 -9.55919379e+00 -1.25042925e+00 -5.76316430e-01 -5.76316430e-01
 -5.76316430e-01  1.01266725e+00  1.01266725e+00  1.01266725e+00
  7.30420364e+00  7.30420364e+00  7.30420364e+00  9.54422492e+00
  3.34703884e+01  3.34703884e+01  3.34703884e+01  1.03753793e+02
  1.29016097e+02  1.29016097e+02  1.29016097e+02  4.83338329e+02
  4.83338329e+02  4.83338329e+02  5.86438853e+02  1.33515636e+03
  1.33515636e+03  1.33515636e+03  2.65531663e+03  3.02937298e+03
  3.02937298e+03  3.02937298e+03  6.64979415e+03  6.64979415e+03
  6.64979415e+03  9.06083891e+03  2.54163907e+04  7.61586949e+04]
E1 = -728.3247497813707  E_coul = 201.62272716304903
Extra cycle  E= -526.702022618322  delta_E= -4.89e-12  |g|= 2.36e-06  |ddm|= 4.1e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.22 sec
exp = [2.61826566e+04 7.61752032e+03 3.61735164e+03 1.59779269e+03
 3.82836895e+02 1.08493193e+02 3.56073962e+01 7.95878218e+00
 3.08308307e+00 3.99184879e-01 1.36278345e+03 6.64743233e+02
 3.00950441e+02 3.14032316e+02 6.16321804e+01 7.33525189e+00
 2.02268222e+01 7.72511224e-01 2.83260698e+00 2.21638329e-01]
E = -526.7020226183216
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:57:56 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.656594         1
[INPUT] 0    0    [1    /1   ]  7617.52032165        1
[INPUT] 0    0    [1    /1   ]  3617.35164453        1
[INPUT] 0    0    [1    /1   ]  1597.7926932         1
[INPUT] 0    0    [1    /1   ]  382.836894591        1
[INPUT] 0    0    [1    /1   ]  108.493193285        1
[INPUT] 0    0    [1    /1   ]  35.6073961917        1
[INPUT] 0    0    [1    /1   ]  7.95878217842        1
[INPUT] 0    0    [1    /1   ]  3.08308307418        1
[INPUT] 0    0    [1    /1   ]  0.399184878891       1
[INPUT] 1    0    [1    /1   ]  1362.78345363        1
[INPUT] 1    0    [1    /1   ]  664.743232709        1
[INPUT] 1    0    [1    /1   ]  300.950441303        1
[INPUT] 1    0    [1    /1   ]  314.032315532        1
[INPUT] 1    0    [1    /1   ]  61.6321803827        1
[INPUT] 1    0    [1    /1   ]  7.33525188963        1
[INPUT] 1    0    [1    /1   ]  20.2268222183        1
[INPUT] 1    0    [1    /1   ]  0.772511224213       1
[INPUT] 1    0    [1    /1   ]  2.83260698249        1
[INPUT] 1    0    [1    /1   ]  0.221638328555       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.65659400107, 1.0]], [0, [7617.520321653033, 1.0]], [0, [3617.3516445302594, 1.0]], [0, [1597.7926931992833, 1.0]], [0, [382.83689459088475, 1.0]], [0, [108.49319328499874, 1.0]], [0, [35.607396191738964, 1.0]], [0, [7.958782178418724, 1.0]], [0, [3.08308307418116, 1.0]], [0, [0.39918487889085286, 1.0]], [1, [1362.7834536281725, 1.0]], [1, [664.7432327090127, 1.0]], [1, [300.9504413028476, 1.0]], [1, [314.0323155320424, 1.0]], [1, [61.632180382739264, 1.0]], [1, [7.335251889625853, 1.0]], [1, [20.226822218267017, 1.0]], [1, [0.7725112242132686, 1.0]], [1, [2.8326069824888447, 1.0]], [1, [0.2216383285550127, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.656594]
bas 1, expnt(s) = [7617.52032165]
bas 2, expnt(s) = [3617.35164453]
bas 3, expnt(s) = [1597.7926932]
bas 4, expnt(s) = [382.83689459]
bas 5, expnt(s) = [108.49319328]
bas 6, expnt(s) = [35.60739619]
bas 7, expnt(s) = [7.95878218]
bas 8, expnt(s) = [3.08308307]
bas 9, expnt(s) = [0.39918488]
bas 10, expnt(s) = [1362.78345363]
bas 11, expnt(s) = [664.74323271]
bas 12, expnt(s) = [300.9504413]
bas 13, expnt(s) = [314.03231553]
bas 14, expnt(s) = [61.63218038]
bas 15, expnt(s) = [7.33525189]
bas 16, expnt(s) = [20.22682222]
bas 17, expnt(s) = [0.77251122]
bas 18, expnt(s) = [2.83260698]
bas 19, expnt(s) = [0.22163833]
CPU time:       923.47
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826566e+04 5.20026298e+03 7.61752032e+03 2.06003804e+03
 3.61735164e+03 1.17844162e+03 1.59779269e+03 6.38491834e+02
 3.82836895e+02 2.18663031e+02 1.08493193e+02 8.49311282e+01
 3.56073962e+01 3.68273261e+01 7.95878218e+00 1.19715391e+01
 3.08308307e+00 5.87832975e+00 3.99184879e-01 1.26880706e+00
 1.36278345e+03 2.41556071e+04 6.64743233e+02 9.84695149e+03
 3.00950441e+02 3.65681612e+03 3.14032316e+02 3.85657978e+03
 6.16321804e+01 5.03783347e+02 7.33525189e+00 3.52170669e+01
 2.02268222e+01 1.25139370e+02 7.72511224e-01 2.11283406e+00
 2.83260698e+00 1.07205556e+01 2.21638329e-01 4.43649989e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98306716259473
cond(S) = 102419.75440074867
E1 = -729.3820784769384  E_coul = 203.12656421153397
init E= -526.255514265404
    CPU time for initialize scf      0.62 sec, wall time      0.05 sec
  HOMO = -0.556853088649203  LUMO = 1.02482914861166
  mo_energy =
[-1.18331178e+02 -1.22076475e+01 -9.45115679e+00 -9.45115679e+00
 -9.45115679e+00 -1.22556134e+00 -5.56853089e-01 -5.56853089e-01
 -5.56853089e-01  1.02482915e+00  1.02482915e+00  1.02482915e+00
  7.36579685e+00  7.36579685e+00  7.36579685e+00  9.61387464e+00
  3.35835882e+01  3.35835882e+01  3.35835882e+01  1.03920436e+02
  1.29190889e+02  1.29190889e+02  1.29190889e+02  4.83582895e+02
  4.83582895e+02  4.83582895e+02  5.86719426e+02  1.33545407e+03
  1.33545407e+03  1.33545407e+03  2.65574691e+03  3.02973553e+03
  3.02973553e+03  3.02973553e+03  6.65026904e+03  6.65026904e+03
  6.65026904e+03  9.06138879e+03  2.54170344e+04  7.61594286e+04]
E1 = -727.9438995441066  E_coul = 201.24252657536167
cycle= 1 E= -526.701372968745  delta_E= -0.446  |g|= 0.185  |ddm|= 0.416
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.541617
diis-c [-0.29334909  1.        ]
  HOMO = -0.582281223122078  LUMO = 1.00817280617315
  mo_energy =
[-1.18628397e+02 -1.23336665e+01 -9.58761807e+00 -9.58761807e+00
 -9.58761807e+00 -1.25806058e+00 -5.82281223e-01 -5.82281223e-01
 -5.82281223e-01  1.00817281e+00  1.00817281e+00  1.00817281e+00
  7.28779972e+00  7.28779972e+00  7.28779972e+00  9.52270828e+00
  3.34414007e+01  3.34414007e+01  3.34414007e+01  1.03711648e+02
  1.28974018e+02  1.28974018e+02  1.28974018e+02  4.83287026e+02
  4.83287026e+02  4.83287026e+02  5.86385618e+02  1.33510174e+03
  1.33510174e+03  1.33510174e+03  2.65525955e+03  3.02931663e+03
  3.02931663e+03  3.02931663e+03  6.64973662e+03  6.64973662e+03
  6.64973662e+03  9.06078087e+03  2.54163324e+04  7.61586365e+04]
E1 = -728.417918122231  E_coul = 201.7159327571501
cycle= 2 E= -526.701985365081  delta_E= -0.000612  |g|= 0.034  |ddm|= 0.0397
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0679949
diis-c [-0.00273751  0.07454931  0.92545069]
  HOMO = -0.575378766422962  LUMO = 1.01336097097077
  mo_energy =
[-1.18568717e+02 -1.23021672e+01 -9.55479366e+00 -9.55479366e+00
 -9.55479366e+00 -1.24929800e+00 -5.75378766e-01 -5.75378766e-01
 -5.75378766e-01  1.01336097e+00  1.01336097e+00  1.01336097e+00
  7.30676108e+00  7.30676108e+00  7.30676108e+00  9.54733760e+00
  3.34748417e+01  3.34748417e+01  3.34748417e+01  1.03760034e+02
  1.29022396e+02  1.29022396e+02  1.29022396e+02  4.83345947e+02
  4.83345947e+02  4.83345947e+02  5.86446801e+02  1.33516451e+03
  1.33516451e+03  1.33516451e+03  2.65532538e+03  3.02938149e+03
  3.02938149e+03  3.02938149e+03  6.64980304e+03  6.64980304e+03
  6.64980304e+03  9.06084801e+03  2.54164000e+04  7.61587043e+04]
E1 = -728.3101267011125  E_coul = 201.6081049634491
cycle= 3 E= -526.702021737663  delta_E= -3.64e-05  |g|= 0.00491  |ddm|= 0.0105
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106482
diis-c [-4.78063481e-07 -1.15209645e-03  1.30674423e-01  8.70477673e-01]
  HOMO = -0.576324633830341  LUMO = 1.01266113907928
  mo_energy =
[-1.18576408e+02 -1.23062895e+01 -9.55919611e+00 -9.55919611e+00
 -9.55919611e+00 -1.25044392e+00 -5.76324634e-01 -5.76324634e-01
 -5.76324634e-01  1.01266114e+00  1.01266114e+00  1.01266114e+00
  7.30419271e+00  7.30419271e+00  7.30419271e+00  9.54420008e+00
  3.34703872e+01  3.34703872e+01  3.34703872e+01  1.03753800e+02
  1.29016107e+02  1.29016107e+02  1.29016107e+02  4.83338354e+02
  4.83338354e+02  4.83338354e+02  5.86438885e+02  1.33515639e+03
  1.33515639e+03  1.33515639e+03  2.65531668e+03  3.02937302e+03
  3.02937302e+03  3.02937302e+03  6.64979421e+03  6.64979421e+03
  6.64979421e+03  9.06083898e+03  2.54163908e+04  7.61586950e+04]
E1 = -728.3247057014789  E_coul = 201.62268308328595
cycle= 4 E= -526.702022618193  delta_E= -8.81e-07  |g|= 6.27e-05  |ddm|= 0.00134
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000131057
diis-c [-1.36604324e-09  6.64332531e-05 -9.15360249e-03 -7.21749334e-02
  1.08126210e+00]
  HOMO = -0.576312882642782  LUMO = 1.01266983616381
  mo_energy =
[-1.18576416e+02 -1.23062618e+01 -9.55918069e+00 -9.55918069e+00
 -9.55918069e+00 -1.25042489e+00 -5.76312883e-01 -5.76312883e-01
 -5.76312883e-01  1.01266984e+00  1.01266984e+00  1.01266984e+00
  7.30421226e+00  7.30421226e+00  7.30421226e+00  9.54423499e+00
  3.34704013e+01  3.34704013e+01  3.34704013e+01  1.03753809e+02
  1.29016112e+02  1.29016112e+02  1.29016112e+02  4.83338347e+02
  4.83338347e+02  4.83338347e+02  5.86438871e+02  1.33515638e+03
  1.33515638e+03  1.33515638e+03  2.65531665e+03  3.02937300e+03
  3.02937300e+03  3.02937300e+03  6.64979417e+03  6.64979417e+03
  6.64979417e+03  9.06083893e+03  2.54163907e+04  7.61586949e+04]
E1 = -728.3247101727841  E_coul = 201.62268755446735
cycle= 5 E= -526.702022618317  delta_E= -1.24e-10  |g|= 7.95e-06  |ddm|= 2.54e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3247101727841  E_coul = 201.62268755446735
  HOMO = -0.576316429659481  LUMO = 1.01266725270888
  mo_energy =
[-1.18576433e+02 -1.23062743e+01 -9.55919379e+00 -9.55919379e+00
 -9.55919379e+00 -1.25042925e+00 -5.76316430e-01 -5.76316430e-01
 -5.76316430e-01  1.01266725e+00  1.01266725e+00  1.01266725e+00
  7.30420364e+00  7.30420364e+00  7.30420364e+00  9.54422492e+00
  3.34703884e+01  3.34703884e+01  3.34703884e+01  1.03753793e+02
  1.29016097e+02  1.29016097e+02  1.29016097e+02  4.83338329e+02
  4.83338329e+02  4.83338329e+02  5.86438853e+02  1.33515636e+03
  1.33515636e+03  1.33515636e+03  2.65531663e+03  3.02937298e+03
  3.02937298e+03  3.02937298e+03  6.64979415e+03  6.64979415e+03
  6.64979415e+03  9.06083891e+03  2.54163907e+04  7.61586949e+04]
E1 = -728.3247497813707  E_coul = 201.62272716304903
Extra cycle  E= -526.702022618322  delta_E= -4.89e-12  |g|= 2.36e-06  |ddm|= 4.1e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.22 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102419.75440074867
E1 = -728.3247497813707  E_coul = 201.62272716304903
init E= -526.702022618322
    CPU time for initialize scf      3.76 sec, wall time      0.20 sec
  HOMO = -0.576315702386216  LUMO = 1.01266778854936
  mo_energy =
[-1.18576429e+02 -1.23062714e+01 -9.55919079e+00 -9.55919079e+00
 -9.55919079e+00 -1.25042834e+00 -5.76315702e-01 -5.76315702e-01
 -5.76315702e-01  1.01266779e+00  1.01266779e+00  1.01266779e+00
  7.30420549e+00  7.30420549e+00  7.30420549e+00  9.54422723e+00
  3.34703914e+01  3.34703914e+01  3.34703914e+01  1.03753798e+02
  1.29016101e+02  1.29016101e+02  1.29016101e+02  4.83338334e+02
  4.83338334e+02  4.83338334e+02  5.86438858e+02  1.33515636e+03
  1.33515636e+03  1.33515636e+03  2.65531663e+03  3.02937298e+03
  3.02937298e+03  3.02937298e+03  6.64979416e+03  6.64979416e+03
  6.64979416e+03  9.06083892e+03  2.54163907e+04  7.61586949e+04]
E1 = -728.3247403114227  E_coul = 201.62271769310172
cycle= 1 E= -526.702022618321  delta_E= 5.68e-13  |g|= 6.11e-07  |ddm|= 9.47e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3247403114227  E_coul = 201.62271769310172
  HOMO = -0.576315864173016  LUMO = 1.01266766869411
  mo_energy =
[-1.18576430e+02 -1.23062721e+01 -9.55919150e+00 -9.55919150e+00
 -9.55919150e+00 -1.25042854e+00 -5.76315864e-01 -5.76315864e-01
 -5.76315864e-01  1.01266767e+00  1.01266767e+00  1.01266767e+00
  7.30420506e+00  7.30420506e+00  7.30420506e+00  9.54422670e+00
  3.34703907e+01  3.34703907e+01  3.34703907e+01  1.03753797e+02
  1.29016100e+02  1.29016100e+02  1.29016100e+02  4.83338333e+02
  4.83338333e+02  4.83338333e+02  5.86438857e+02  1.33515636e+03
  1.33515636e+03  1.33515636e+03  2.65531663e+03  3.02937298e+03
  3.02937298e+03  3.02937298e+03  6.64979416e+03  6.64979416e+03
  6.64979416e+03  9.06083892e+03  2.54163907e+04  7.61586949e+04]
E1 = -728.3247426331062  E_coul = 201.62272001478388
Extra cycle  E= -526.702022618322  delta_E= -1.25e-12  |g|= 1.54e-07  |ddm|= 2.23e-07
    CPU time for scf_cycle      3.87 sec, wall time      0.31 sec
exp = [2.61826566e+04 7.61752032e+03 3.61735164e+03 1.59779269e+03
 3.82836895e+02 1.08493193e+02 3.56073962e+01 7.95878218e+00
 3.08308307e+00 3.99184879e-01 1.36278345e+03 6.64743233e+02
 3.00950441e+02 3.14032316e+02 6.16321804e+01 7.33525189e+00
 2.02268222e+01 7.72511224e-01 2.83260698e+00 2.21638329e-01]
grad_E = [-1.51069034e-06  3.23332122e-06 -1.61817732e-06  6.62972657e-05
  7.91906104e-05 -1.44902698e-03  1.72492101e-04  9.72180793e-04
 -2.01406421e-03  5.20857100e-03 -5.05286162e-07  5.02940084e-06
  2.37584533e-05  2.04824816e-05 -4.32815882e-05 -1.99898654e-03
  3.78484847e-04  6.72713704e-03  3.42381008e-03 -3.21571946e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:58:00 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6568894        1
[INPUT] 0    0    [1    /1   ]  7617.51969103        1
[INPUT] 0    0    [1    /1   ]  3617.35196201        1
[INPUT] 0    0    [1    /1   ]  1597.77979415        1
[INPUT] 0    0    [1    /1   ]  382.820299253        1
[INPUT] 0    0    [1    /1   ]  108.758691222        1
[INPUT] 0    0    [1    /1   ]  35.6656975365        1
[INPUT] 0    0    [1    /1   ]  8.02233043563        1
[INPUT] 0    0    [1    /1   ]  3.09537867525        1
[INPUT] 0    0    [1    /1   ]  0.399496050729       1
[INPUT] 1    0    [1    /1   ]  1362.78355262        1
[INPUT] 1    0    [1    /1   ]  664.742249898        1
[INPUT] 1    0    [1    /1   ]  300.945802023        1
[INPUT] 1    0    [1    /1   ]  314.028315715        1
[INPUT] 1    0    [1    /1   ]  61.6376112099        1
[INPUT] 1    0    [1    /1   ]  7.35278704726        1
[INPUT] 1    0    [1    /1   ]  20.2113041817        1
[INPUT] 1    0    [1    /1   ]  0.773510846424       1
[INPUT] 1    0    [1    /1   ]  2.85577040439        1
[INPUT] 1    0    [1    /1   ]  0.221260551716       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.656889423863, 1.0]], [0, [7617.519691029862, 1.0]], [0, [3617.3519620082243, 1.0]], [0, [1597.779794146619, 1.0]], [0, [382.8202992528488, 1.0]], [0, [108.75869122160154, 1.0]], [0, [35.66569753652914, 1.0]], [0, [8.02233043563477, 1.0]], [0, [3.095378675249313, 1.0]], [0, [0.39949605072858624, 1.0]], [1, [1362.7835526166643, 1.0]], [1, [664.7422498977822, 1.0]], [1, [300.94580202258436, 1.0]], [1, [314.028315715052, 1.0]], [1, [61.63761120993843, 1.0]], [1, [7.352787047258465, 1.0]], [1, [20.21130418168035, 1.0]], [1, [0.7735108464244633, 1.0]], [1, [2.85577040439136, 1.0]], [1, [0.22126055171614747, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65688942]
bas 1, expnt(s) = [7617.51969103]
bas 2, expnt(s) = [3617.35196201]
bas 3, expnt(s) = [1597.77979415]
bas 4, expnt(s) = [382.82029925]
bas 5, expnt(s) = [108.75869122]
bas 6, expnt(s) = [35.66569754]
bas 7, expnt(s) = [8.02233044]
bas 8, expnt(s) = [3.09537868]
bas 9, expnt(s) = [0.39949605]
bas 10, expnt(s) = [1362.78355262]
bas 11, expnt(s) = [664.7422499]
bas 12, expnt(s) = [300.94580202]
bas 13, expnt(s) = [314.02831572]
bas 14, expnt(s) = [61.63761121]
bas 15, expnt(s) = [7.35278705]
bas 16, expnt(s) = [20.21130418]
bas 17, expnt(s) = [0.77351085]
bas 18, expnt(s) = [2.8557704]
bas 19, expnt(s) = [0.22126055]
CPU time:       933.15
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826569e+04 5.20026302e+03 7.61751969e+03 2.06003791e+03
 3.61735196e+03 1.17844169e+03 1.59777979e+03 6.38487968e+02
 3.82820299e+02 2.18655921e+02 1.08758691e+02 8.50869593e+01
 3.56656975e+01 3.68725409e+01 8.02233044e+00 1.20431594e+01
 3.09537868e+00 5.89590346e+00 3.99496051e-01 1.26954878e+00
 1.36278355e+03 2.41556093e+04 6.64742250e+02 9.84693329e+03
 3.00945802e+02 3.65674566e+03 3.14028316e+02 3.85651837e+03
 6.16376112e+01 5.03838838e+02 7.35278705e+00 3.53223328e+01
 2.02113042e+01 1.25019373e+02 7.73510846e-01 2.11625210e+00
 2.85577040e+00 1.08302505e+01 2.21260552e-01 4.42704953e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.983020586044287
cond(S) = 102461.66794946701
E1 = -729.3844804728878  E_coul = 203.12776883035693
init E= -526.256711642531
    CPU time for initialize scf      2.42 sec, wall time      0.14 sec
  HOMO = -0.556818422925485  LUMO = 1.02438056503383
  mo_energy =
[-1.18331262e+02 -1.22075152e+01 -9.45106200e+00 -9.45106200e+00
 -9.45106200e+00 -1.22551217e+00 -5.56818423e-01 -5.56818423e-01
 -5.56818423e-01  1.02438057e+00  1.02438057e+00  1.02438057e+00
  7.41267325e+00  7.41267325e+00  7.41267325e+00  9.71545251e+00
  3.36997580e+01  3.36997580e+01  3.36997580e+01  1.04450070e+02
  1.29294343e+02  1.29294343e+02  1.29294343e+02  4.83659423e+02
  4.83659423e+02  4.83659423e+02  5.87891242e+02  1.33551317e+03
  1.33551317e+03  1.33551317e+03  2.65712030e+03  3.02977768e+03
  3.02977768e+03  3.02977768e+03  6.65029745e+03  6.65029745e+03
  6.65029745e+03  9.06269247e+03  2.54182654e+04  7.61605721e+04]
E1 = -727.938839483276  E_coul = 201.2372477157677
cycle= 1 E= -526.701591767508  delta_E= -0.445  |g|= 0.185  |ddm|= 0.415
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.542191
diis-c [-0.2939706  1.       ]
  HOMO = -0.582504491649381  LUMO = 1.00750460088528
  mo_energy =
[-1.18628812e+02 -1.23339666e+01 -9.58797218e+00 -9.58797218e+00
 -9.58797218e+00 -1.25836337e+00 -5.82504492e-01 -5.82504492e-01
 -5.82504492e-01  1.00750460e+00  1.00750460e+00  1.00750460e+00
  7.33391326e+00  7.33391326e+00  7.33391326e+00  9.62341478e+00
  3.35571151e+01  3.35571151e+01  3.35571151e+01  1.04240581e+02
  1.29077139e+02  1.29077139e+02  1.29077139e+02  4.83363187e+02
  4.83363187e+02  4.83363187e+02  5.87557015e+02  1.33516048e+03
  1.33516048e+03  1.33516048e+03  2.65663274e+03  3.02935852e+03
  3.02935852e+03  3.02935852e+03  6.64976482e+03  6.64976482e+03
  6.64976482e+03  9.06208439e+03  2.54175632e+04  7.61597798e+04]
E1 = -728.413905186405  E_coul = 201.7116990822268
cycle= 2 E= -526.702206104178  delta_E= -0.000614  |g|= 0.0341  |ddm|= 0.0398
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0681383
diis-c [-0.00274723  0.07465572  0.92534428]
  HOMO = -0.575582519794703  LUMO = 1.01271548989541
  mo_energy =
[-1.18569040e+02 -1.23023964e+01 -9.55507802e+00 -9.55507802e+00
 -9.55507802e+00 -1.24957270e+00 -5.75582520e-01 -5.75582520e-01
 -5.75582520e-01  1.01271549e+00  1.01271549e+00  1.01271549e+00
  7.35299409e+00  7.35299409e+00  7.35299409e+00  9.64820458e+00
  3.35906313e+01  3.35906313e+01  3.35906313e+01  1.04289082e+02
  1.29125592e+02  1.29125592e+02  1.29125592e+02  4.83422197e+02
  4.83422197e+02  4.83422197e+02  5.87618293e+02  1.33522335e+03
  1.33522335e+03  1.33522335e+03  2.65669866e+03  3.02942347e+03
  3.02942347e+03  3.02942347e+03  6.64983134e+03  6.64983134e+03
  6.64983134e+03  9.06215162e+03  2.54176309e+04  7.61598478e+04]
E1 = -728.3058907529572  E_coul = 201.60364814586225
cycle= 3 E= -526.702242607095  delta_E= -3.65e-05  |g|= 0.00491  |ddm|= 0.0105
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106607
diis-c [-4.77250609e-07 -1.14933963e-03  1.30579748e-01  8.70569592e-01]
  HOMO = -0.576531244633247  LUMO = 1.0120123203046
  mo_energy =
[-1.18576737e+02 -1.23065235e+01 -9.55948521e+00 -9.55948521e+00
 -9.55948521e+00 -1.25072313e+00 -5.76531245e-01 -5.76531245e-01
 -5.76531245e-01  1.01201232e+00  1.01201232e+00  1.01201232e+00
  7.35041106e+00  7.35041106e+00  7.35041106e+00  9.64504803e+00
  3.35861711e+01  3.35861711e+01  3.35861711e+01  1.04282839e+02
  1.29119299e+02  1.29119299e+02  1.29119299e+02  4.83414598e+02
  4.83414598e+02  4.83414598e+02  5.87610371e+02  1.33521522e+03
  1.33521522e+03  1.33521522e+03  2.65668995e+03  3.02941500e+03
  3.02941500e+03  3.02941500e+03  6.64982251e+03  6.64982251e+03
  6.64982251e+03  9.06214259e+03  2.54176217e+04  7.61598385e+04]
E1 = -728.3204819586434  E_coul = 201.6182384698248
cycle= 4 E= -526.702243488819  delta_E= -8.82e-07  |g|= 6.23e-05  |ddm|= 0.00134
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000131259
diis-c [-1.35110273e-09  6.62838237e-05 -9.14019511e-03 -7.21584248e-02
  1.08123234e+00]
  HOMO = -0.576519722037336  LUMO = 1.01202085162647
  mo_energy =
[-1.18576745e+02 -1.23064963e+01 -9.55947023e+00 -9.55947023e+00
 -9.55947023e+00 -1.25070445e+00 -5.76519722e-01 -5.76519722e-01
 -5.76519722e-01  1.01202085e+00  1.01202085e+00  1.01202085e+00
  7.35043021e+00  7.35043021e+00  7.35043021e+00  9.64508237e+00
  3.35861848e+01  3.35861848e+01  3.35861848e+01  1.04282847e+02
  1.29119303e+02  1.29119303e+02  1.29119303e+02  4.83414590e+02
  4.83414590e+02  4.83414590e+02  5.87610356e+02  1.33521520e+03
  1.33521520e+03  1.33521520e+03  2.65668992e+03  3.02941497e+03
  3.02941497e+03  3.02941497e+03  6.64982247e+03  6.64982247e+03
  6.64982247e+03  9.06214254e+03  2.54176217e+04  7.61598384e+04]
E1 = -728.3204869675925  E_coul = 201.6182434786528
cycle= 5 E= -526.70224348894  delta_E= -1.21e-10  |g|= 7.92e-06  |ddm|= 2.47e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3204869675925  E_coul = 201.6182434786528
  HOMO = -0.576523261768462  LUMO = 1.01201826895892
  mo_energy =
[-1.18576763e+02 -1.23065087e+01 -9.55948328e+00 -9.55948328e+00
 -9.55948328e+00 -1.25070880e+00 -5.76523262e-01 -5.76523262e-01
 -5.76523262e-01  1.01201827e+00  1.01201827e+00  1.01201827e+00
  7.35042158e+00  7.35042158e+00  7.35042158e+00  9.64507229e+00
  3.35861719e+01  3.35861719e+01  3.35861719e+01  1.04282832e+02
  1.29119288e+02  1.29119288e+02  1.29119288e+02  4.83414573e+02
  4.83414573e+02  4.83414573e+02  5.87610338e+02  1.33521519e+03
  1.33521519e+03  1.33521519e+03  2.65668990e+03  3.02941495e+03
  3.02941495e+03  3.02941495e+03  6.64982245e+03  6.64982245e+03
  6.64982245e+03  9.06214252e+03  2.54176217e+04  7.61598384e+04]
E1 = -728.3205264153406  E_coul = 201.6182829263972
Extra cycle  E= -526.702243488943  delta_E= -3.64e-12  |g|= 2.35e-06  |ddm|= 4.09e-06
    CPU time for scf_cycle      2.62 sec, wall time      0.34 sec
exp = [2.61826569e+04 7.61751969e+03 3.61735196e+03 1.59777979e+03
 3.82820299e+02 1.08758691e+02 3.56656975e+01 8.02233044e+00
 3.09537868e+00 3.99496051e-01 1.36278355e+03 6.64742250e+02
 3.00945802e+02 3.14028316e+02 6.16376112e+01 7.35278705e+00
 2.02113042e+01 7.73510846e-01 2.85577040e+00 2.21260552e-01]
E = -526.7022434889434
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:58:00 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6568894        1
[INPUT] 0    0    [1    /1   ]  7617.51969103        1
[INPUT] 0    0    [1    /1   ]  3617.35196201        1
[INPUT] 0    0    [1    /1   ]  1597.77979415        1
[INPUT] 0    0    [1    /1   ]  382.820299253        1
[INPUT] 0    0    [1    /1   ]  108.758691222        1
[INPUT] 0    0    [1    /1   ]  35.6656975365        1
[INPUT] 0    0    [1    /1   ]  8.02233043563        1
[INPUT] 0    0    [1    /1   ]  3.09537867525        1
[INPUT] 0    0    [1    /1   ]  0.399496050729       1
[INPUT] 1    0    [1    /1   ]  1362.78355262        1
[INPUT] 1    0    [1    /1   ]  664.742249898        1
[INPUT] 1    0    [1    /1   ]  300.945802023        1
[INPUT] 1    0    [1    /1   ]  314.028315715        1
[INPUT] 1    0    [1    /1   ]  61.6376112099        1
[INPUT] 1    0    [1    /1   ]  7.35278704726        1
[INPUT] 1    0    [1    /1   ]  20.2113041817        1
[INPUT] 1    0    [1    /1   ]  0.773510846424       1
[INPUT] 1    0    [1    /1   ]  2.85577040439        1
[INPUT] 1    0    [1    /1   ]  0.221260551716       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.656889423863, 1.0]], [0, [7617.519691029862, 1.0]], [0, [3617.3519620082243, 1.0]], [0, [1597.779794146619, 1.0]], [0, [382.8202992528488, 1.0]], [0, [108.75869122160154, 1.0]], [0, [35.66569753652914, 1.0]], [0, [8.02233043563477, 1.0]], [0, [3.095378675249313, 1.0]], [0, [0.39949605072858624, 1.0]], [1, [1362.7835526166643, 1.0]], [1, [664.7422498977822, 1.0]], [1, [300.94580202258436, 1.0]], [1, [314.028315715052, 1.0]], [1, [61.63761120993843, 1.0]], [1, [7.352787047258465, 1.0]], [1, [20.21130418168035, 1.0]], [1, [0.7735108464244633, 1.0]], [1, [2.85577040439136, 1.0]], [1, [0.22126055171614747, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65688942]
bas 1, expnt(s) = [7617.51969103]
bas 2, expnt(s) = [3617.35196201]
bas 3, expnt(s) = [1597.77979415]
bas 4, expnt(s) = [382.82029925]
bas 5, expnt(s) = [108.75869122]
bas 6, expnt(s) = [35.66569754]
bas 7, expnt(s) = [8.02233044]
bas 8, expnt(s) = [3.09537868]
bas 9, expnt(s) = [0.39949605]
bas 10, expnt(s) = [1362.78355262]
bas 11, expnt(s) = [664.7422499]
bas 12, expnt(s) = [300.94580202]
bas 13, expnt(s) = [314.02831572]
bas 14, expnt(s) = [61.63761121]
bas 15, expnt(s) = [7.35278705]
bas 16, expnt(s) = [20.21130418]
bas 17, expnt(s) = [0.77351085]
bas 18, expnt(s) = [2.8557704]
bas 19, expnt(s) = [0.22126055]
CPU time:       935.94
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826569e+04 5.20026302e+03 7.61751969e+03 2.06003791e+03
 3.61735196e+03 1.17844169e+03 1.59777979e+03 6.38487968e+02
 3.82820299e+02 2.18655921e+02 1.08758691e+02 8.50869593e+01
 3.56656975e+01 3.68725409e+01 8.02233044e+00 1.20431594e+01
 3.09537868e+00 5.89590346e+00 3.99496051e-01 1.26954878e+00
 1.36278355e+03 2.41556093e+04 6.64742250e+02 9.84693329e+03
 3.00945802e+02 3.65674566e+03 3.14028316e+02 3.85651837e+03
 6.16376112e+01 5.03838838e+02 7.35278705e+00 3.53223328e+01
 2.02113042e+01 1.25019373e+02 7.73510846e-01 2.11625210e+00
 2.85577040e+00 1.08302505e+01 2.21260552e-01 4.42704953e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.983020586044287
cond(S) = 102461.66794946701
E1 = -729.3844804728878  E_coul = 203.12776883035693
init E= -526.256711642531
    CPU time for initialize scf      7.63 sec, wall time      0.36 sec
  HOMO = -0.556818422925485  LUMO = 1.02438056503383
  mo_energy =
[-1.18331262e+02 -1.22075152e+01 -9.45106200e+00 -9.45106200e+00
 -9.45106200e+00 -1.22551217e+00 -5.56818423e-01 -5.56818423e-01
 -5.56818423e-01  1.02438057e+00  1.02438057e+00  1.02438057e+00
  7.41267325e+00  7.41267325e+00  7.41267325e+00  9.71545251e+00
  3.36997580e+01  3.36997580e+01  3.36997580e+01  1.04450070e+02
  1.29294343e+02  1.29294343e+02  1.29294343e+02  4.83659423e+02
  4.83659423e+02  4.83659423e+02  5.87891242e+02  1.33551317e+03
  1.33551317e+03  1.33551317e+03  2.65712030e+03  3.02977768e+03
  3.02977768e+03  3.02977768e+03  6.65029745e+03  6.65029745e+03
  6.65029745e+03  9.06269247e+03  2.54182654e+04  7.61605721e+04]
E1 = -727.938839483276  E_coul = 201.2372477157677
cycle= 1 E= -526.701591767508  delta_E= -0.445  |g|= 0.185  |ddm|= 0.415
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.542191
diis-c [-0.2939706  1.       ]
  HOMO = -0.582504491649381  LUMO = 1.00750460088528
  mo_energy =
[-1.18628812e+02 -1.23339666e+01 -9.58797218e+00 -9.58797218e+00
 -9.58797218e+00 -1.25836337e+00 -5.82504492e-01 -5.82504492e-01
 -5.82504492e-01  1.00750460e+00  1.00750460e+00  1.00750460e+00
  7.33391326e+00  7.33391326e+00  7.33391326e+00  9.62341478e+00
  3.35571151e+01  3.35571151e+01  3.35571151e+01  1.04240581e+02
  1.29077139e+02  1.29077139e+02  1.29077139e+02  4.83363187e+02
  4.83363187e+02  4.83363187e+02  5.87557015e+02  1.33516048e+03
  1.33516048e+03  1.33516048e+03  2.65663274e+03  3.02935852e+03
  3.02935852e+03  3.02935852e+03  6.64976482e+03  6.64976482e+03
  6.64976482e+03  9.06208439e+03  2.54175632e+04  7.61597798e+04]
E1 = -728.413905186405  E_coul = 201.7116990822268
cycle= 2 E= -526.702206104178  delta_E= -0.000614  |g|= 0.0341  |ddm|= 0.0398
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0681383
diis-c [-0.00274723  0.07465572  0.92534428]
  HOMO = -0.575582519794703  LUMO = 1.01271548989541
  mo_energy =
[-1.18569040e+02 -1.23023964e+01 -9.55507802e+00 -9.55507802e+00
 -9.55507802e+00 -1.24957270e+00 -5.75582520e-01 -5.75582520e-01
 -5.75582520e-01  1.01271549e+00  1.01271549e+00  1.01271549e+00
  7.35299409e+00  7.35299409e+00  7.35299409e+00  9.64820458e+00
  3.35906313e+01  3.35906313e+01  3.35906313e+01  1.04289082e+02
  1.29125592e+02  1.29125592e+02  1.29125592e+02  4.83422197e+02
  4.83422197e+02  4.83422197e+02  5.87618293e+02  1.33522335e+03
  1.33522335e+03  1.33522335e+03  2.65669866e+03  3.02942347e+03
  3.02942347e+03  3.02942347e+03  6.64983134e+03  6.64983134e+03
  6.64983134e+03  9.06215162e+03  2.54176309e+04  7.61598478e+04]
E1 = -728.3058907529572  E_coul = 201.60364814586225
cycle= 3 E= -526.702242607095  delta_E= -3.65e-05  |g|= 0.00491  |ddm|= 0.0105
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106607
diis-c [-4.77250609e-07 -1.14933963e-03  1.30579748e-01  8.70569592e-01]
  HOMO = -0.576531244633247  LUMO = 1.0120123203046
  mo_energy =
[-1.18576737e+02 -1.23065235e+01 -9.55948521e+00 -9.55948521e+00
 -9.55948521e+00 -1.25072313e+00 -5.76531245e-01 -5.76531245e-01
 -5.76531245e-01  1.01201232e+00  1.01201232e+00  1.01201232e+00
  7.35041106e+00  7.35041106e+00  7.35041106e+00  9.64504803e+00
  3.35861711e+01  3.35861711e+01  3.35861711e+01  1.04282839e+02
  1.29119299e+02  1.29119299e+02  1.29119299e+02  4.83414598e+02
  4.83414598e+02  4.83414598e+02  5.87610371e+02  1.33521522e+03
  1.33521522e+03  1.33521522e+03  2.65668995e+03  3.02941500e+03
  3.02941500e+03  3.02941500e+03  6.64982251e+03  6.64982251e+03
  6.64982251e+03  9.06214259e+03  2.54176217e+04  7.61598385e+04]
E1 = -728.3204819586434  E_coul = 201.6182384698248
cycle= 4 E= -526.702243488819  delta_E= -8.82e-07  |g|= 6.23e-05  |ddm|= 0.00134
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000131259
diis-c [-1.35110273e-09  6.62838237e-05 -9.14019511e-03 -7.21584248e-02
  1.08123234e+00]
  HOMO = -0.576519722037336  LUMO = 1.01202085162647
  mo_energy =
[-1.18576745e+02 -1.23064963e+01 -9.55947023e+00 -9.55947023e+00
 -9.55947023e+00 -1.25070445e+00 -5.76519722e-01 -5.76519722e-01
 -5.76519722e-01  1.01202085e+00  1.01202085e+00  1.01202085e+00
  7.35043021e+00  7.35043021e+00  7.35043021e+00  9.64508237e+00
  3.35861848e+01  3.35861848e+01  3.35861848e+01  1.04282847e+02
  1.29119303e+02  1.29119303e+02  1.29119303e+02  4.83414590e+02
  4.83414590e+02  4.83414590e+02  5.87610356e+02  1.33521520e+03
  1.33521520e+03  1.33521520e+03  2.65668992e+03  3.02941497e+03
  3.02941497e+03  3.02941497e+03  6.64982247e+03  6.64982247e+03
  6.64982247e+03  9.06214254e+03  2.54176217e+04  7.61598384e+04]
E1 = -728.3204869675925  E_coul = 201.6182434786528
cycle= 5 E= -526.70224348894  delta_E= -1.21e-10  |g|= 7.92e-06  |ddm|= 2.47e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3204869675925  E_coul = 201.6182434786528
  HOMO = -0.576523261768462  LUMO = 1.01201826895892
  mo_energy =
[-1.18576763e+02 -1.23065087e+01 -9.55948328e+00 -9.55948328e+00
 -9.55948328e+00 -1.25070880e+00 -5.76523262e-01 -5.76523262e-01
 -5.76523262e-01  1.01201827e+00  1.01201827e+00  1.01201827e+00
  7.35042158e+00  7.35042158e+00  7.35042158e+00  9.64507229e+00
  3.35861719e+01  3.35861719e+01  3.35861719e+01  1.04282832e+02
  1.29119288e+02  1.29119288e+02  1.29119288e+02  4.83414573e+02
  4.83414573e+02  4.83414573e+02  5.87610338e+02  1.33521519e+03
  1.33521519e+03  1.33521519e+03  2.65668990e+03  3.02941495e+03
  3.02941495e+03  3.02941495e+03  6.64982245e+03  6.64982245e+03
  6.64982245e+03  9.06214252e+03  2.54176217e+04  7.61598384e+04]
E1 = -728.3205264153406  E_coul = 201.6182829263972
Extra cycle  E= -526.702243488943  delta_E= -3.64e-12  |g|= 2.35e-06  |ddm|= 4.09e-06
    CPU time for scf_cycle      7.83 sec, wall time      0.55 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102461.66794946701
E1 = -728.3205264153406  E_coul = 201.6182829263972
init E= -526.702243488943
    CPU time for initialize scf     16.25 sec, wall time      0.76 sec
  HOMO = -0.576522536777201  LUMO = 1.01201880395371
  mo_energy =
[-1.18576758e+02 -1.23065058e+01 -9.55948029e+00 -9.55948029e+00
 -9.55948029e+00 -1.25070790e+00 -5.76522537e-01 -5.76522537e-01
 -5.76522537e-01  1.01201880e+00  1.01201880e+00  1.01201880e+00
  7.35042343e+00  7.35042343e+00  7.35042343e+00  9.64507460e+00
  3.35861749e+01  3.35861749e+01  3.35861749e+01  1.04282836e+02
  1.29119292e+02  1.29119292e+02  1.29119292e+02  4.83414578e+02
  4.83414578e+02  4.83414578e+02  5.87610343e+02  1.33521519e+03
  1.33521519e+03  1.33521519e+03  2.65668990e+03  3.02941496e+03
  3.02941496e+03  3.02941496e+03  6.64982245e+03  6.64982245e+03
  6.64982245e+03  9.06214253e+03  2.54176217e+04  7.61598384e+04]
E1 = -728.320516982176  E_coul = 201.61827349323264
cycle= 1 E= -526.702243488943  delta_E= 1.14e-13  |g|= 6.08e-07  |ddm|= 9.42e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.320516982176  E_coul = 201.61827349323264
  HOMO = -0.576522698139476  LUMO = 1.01201868421602
  mo_energy =
[-1.18576759e+02 -1.23065065e+01 -9.55948100e+00 -9.55948100e+00
 -9.55948100e+00 -1.25070810e+00 -5.76522698e-01 -5.76522698e-01
 -5.76522698e-01  1.01201868e+00  1.01201868e+00  1.01201868e+00
  7.35042300e+00  7.35042300e+00  7.35042300e+00  9.64507406e+00
  3.35861742e+01  3.35861742e+01  3.35861742e+01  1.04282835e+02
  1.29119291e+02  1.29119291e+02  1.29119291e+02  4.83414576e+02
  4.83414576e+02  4.83414576e+02  5.87610341e+02  1.33521519e+03
  1.33521519e+03  1.33521519e+03  2.65668990e+03  3.02941496e+03
  3.02941496e+03  3.02941496e+03  6.64982245e+03  6.64982245e+03
  6.64982245e+03  9.06214253e+03  2.54176217e+04  7.61598384e+04]
E1 = -728.3205192941973  E_coul = 201.61827580525403
Extra cycle  E= -526.702243488943  delta_E=    0  |g|= 1.53e-07  |ddm|= 2.22e-07
    CPU time for scf_cycle     16.38 sec, wall time      0.89 sec
exp = [2.61826569e+04 7.61751969e+03 3.61735196e+03 1.59777979e+03
 3.82820299e+02 1.08758691e+02 3.56656975e+01 8.02233044e+00
 3.09537868e+00 3.99496051e-01 1.36278355e+03 6.64742250e+02
 3.00945802e+02 3.14028316e+02 6.16376112e+01 7.35278705e+00
 2.02113042e+01 7.73510846e-01 2.85577040e+00 2.21260552e-01]
grad_E = [-1.51480442e-06  3.27777734e-06 -1.59627725e-06  6.79959738e-05
  3.22497781e-05 -1.21528494e-03 -1.07486105e-04  1.52869161e-03
 -3.06033486e-03  7.80194337e-03 -5.10536380e-07  4.95764040e-06
  2.33295239e-05  2.01133444e-05 -1.93760016e-06 -2.43321271e-03
  1.97743524e-04  9.97909467e-03  5.41957870e-03 -4.75699075e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:58:06 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6575176        1
[INPUT] 0    0    [1    /1   ]  7617.51834877        1
[INPUT] 0    0    [1    /1   ]  3617.35263636        1
[INPUT] 0    0    [1    /1   ]  1597.7523079         1
[INPUT] 0    0    [1    /1   ]  382.787311501        1
[INPUT] 0    0    [1    /1   ]  109.30205763         1
[INPUT] 0    0    [1    /1   ]  35.8475151975        1
[INPUT] 0    0    [1    /1   ]  8.07809520648        1
[INPUT] 0    0    [1    /1   ]  3.10879436549        1
[INPUT] 0    0    [1    /1   ]  0.399657298782       1
[INPUT] 1    0    [1    /1   ]  1362.78376313        1
[INPUT] 1    0    [1    /1   ]  664.740161394        1
[INPUT] 1    0    [1    /1   ]  300.935944712        1
[INPUT] 1    0    [1    /1   ]  314.019817071        1
[INPUT] 1    0    [1    /1   ]  61.6484906602        1
[INPUT] 1    0    [1    /1   ]  7.38743029869        1
[INPUT] 1    0    [1    /1   ]  20.1825896181        1
[INPUT] 1    0    [1    /1   ]  0.776288380834       1
[INPUT] 1    0    [1    /1   ]  2.89132759562        1
[INPUT] 1    0    [1    /1   ]  0.221570049708       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.657517637712, 1.0]], [0, [7617.518348769782, 1.0]], [0, [3617.3526363594506, 1.0]], [0, [1597.7523079024675, 1.0]], [0, [382.7873115006204, 1.0]], [0, [109.30205762992136, 1.0]], [0, [35.847515197505125, 1.0]], [0, [8.078095206479556, 1.0]], [0, [3.108794365486066, 1.0]], [0, [0.3996572987823121, 1.0]], [1, [1362.7837631323207, 1.0]], [1, [664.7401613943192, 1.0]], [1, [300.9359447115343, 1.0]], [1, [314.0198170714051, 1.0]], [1, [61.648490660214925, 1.0]], [1, [7.387430298686451, 1.0]], [1, [20.18258961810142, 1.0]], [1, [0.7762883808337392, 1.0]], [1, [2.8913275956196958, 1.0]], [1, [0.22157004970796132, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65751764]
bas 1, expnt(s) = [7617.51834877]
bas 2, expnt(s) = [3617.35263636]
bas 3, expnt(s) = [1597.7523079]
bas 4, expnt(s) = [382.7873115]
bas 5, expnt(s) = [109.30205763]
bas 6, expnt(s) = [35.8475152]
bas 7, expnt(s) = [8.07809521]
bas 8, expnt(s) = [3.10879437]
bas 9, expnt(s) = [0.3996573]
bas 10, expnt(s) = [1362.78376313]
bas 11, expnt(s) = [664.74016139]
bas 12, expnt(s) = [300.93594471]
bas 13, expnt(s) = [314.01981707]
bas 14, expnt(s) = [61.64849066]
bas 15, expnt(s) = [7.3874303]
bas 16, expnt(s) = [20.18258962]
bas 17, expnt(s) = [0.77628838]
bas 18, expnt(s) = [2.8913276]
bas 19, expnt(s) = [0.22157005]
CPU time:       965.02
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826575e+04 5.20026312e+03 7.61751835e+03 2.06003764e+03
 3.61735264e+03 1.17844186e+03 1.59775231e+03 6.38479730e+02
 3.82787312e+02 2.18641790e+02 1.09302058e+02 8.54055861e+01
 3.58475152e+01 3.70134287e+01 8.07809521e+00 1.21058907e+01
 3.10879437e+00 5.91505819e+00 3.99657299e-01 1.26993308e+00
 1.36278376e+03 2.41556140e+04 6.64740161e+02 9.84689462e+03
 3.00935945e+02 3.65659594e+03 3.14019817e+02 3.85638791e+03
 6.16484907e+01 5.03950004e+02 7.38743030e+00 3.55304852e+01
 2.01825896e+01 1.24797391e+02 7.76288381e-01 2.12575520e+00
 2.89132760e+00 1.09990713e+01 2.21570050e-01 4.43479155e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982904841759762
cond(S) = 102518.24790089003
E1 = -729.3862358690633  E_coul = 203.12834632722064
init E= -526.257889541843
    CPU time for initialize scf      7.35 sec, wall time      0.34 sec
  HOMO = -0.556785304798396  LUMO = 1.02818077414156
  mo_energy =
[-1.18331510e+02 -1.22074233e+01 -9.45101624e+00 -9.45101624e+00
 -9.45101624e+00 -1.22550076e+00 -5.56785305e-01 -5.56785305e-01
 -5.56785305e-01  1.02818077e+00  1.02818077e+00  1.02818077e+00
  7.49524676e+00  7.49524676e+00  7.49524676e+00  9.81627684e+00
  3.38996362e+01  3.38996362e+01  3.38996362e+01  1.05304475e+02
  1.29474362e+02  1.29474362e+02  1.29474362e+02  4.83793596e+02
  4.83793596e+02  4.83793596e+02  5.90182127e+02  1.33561424e+03
  1.33561424e+03  1.33561424e+03  2.65986941e+03  3.02984469e+03
  3.02984469e+03  3.02984469e+03  6.65033732e+03  6.65033732e+03
  6.65033732e+03  9.06530916e+03  2.54207363e+04  7.61628673e+04]
E1 = -727.9403809786286  E_coul = 201.23839192024772
cycle= 1 E= -526.701989058381  delta_E= -0.444  |g|= 0.185  |ddm|= 0.413
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.54275
diis-c [-0.29457733  1.        ]
  HOMO = -0.582515483884309  LUMO = 1.01116818210185
  mo_energy =
[-1.18628751e+02 -1.23338309e+01 -9.58787802e+00 -9.58787802e+00
 -9.58787802e+00 -1.25843549e+00 -5.82515484e-01 -5.82515484e-01
 -5.82515484e-01  1.01116818e+00  1.01116818e+00  1.01116818e+00
  7.41591700e+00  7.41591700e+00  7.41591700e+00  9.72380196e+00
  3.37570207e+01  3.37570207e+01  3.37570207e+01  1.05094640e+02
  1.29257442e+02  1.29257442e+02  1.29257442e+02  4.83497650e+02
  4.83497650e+02  4.83497650e+02  5.89848075e+02  1.33526188e+03
  1.33526188e+03  1.33526188e+03  2.65938246e+03  3.02942603e+03
  3.02942603e+03  3.02942603e+03  6.64980528e+03  6.64980528e+03
  6.64980528e+03  9.06470176e+03  2.54200349e+04  7.61620757e+04]
E1 = -728.414677821417  E_coul = 201.7120757090025
cycle= 2 E= -526.702602112414  delta_E= -0.000613  |g|= 0.034  |ddm|= 0.0397
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0681178
diis-c [-0.00274827  0.07451417  0.92548583]
  HOMO = -0.575605432245066  LUMO = 1.01639802004604
  mo_energy =
[-1.18569059e+02 -1.23023054e+01 -9.55503320e+00 -9.55503320e+00
 -9.55503320e+00 -1.24965728e+00 -5.75605432e-01 -5.75605432e-01
 -5.75605432e-01  1.01639802e+00  1.01639802e+00  1.01639802e+00
  7.43508429e+00  7.43508429e+00  7.43508429e+00  9.74866175e+00
  3.37904995e+01  3.37904995e+01  3.37904995e+01  1.05143152e+02
  1.29305814e+02  1.29305814e+02  1.29305814e+02  4.83556577e+02
  4.83556577e+02  4.83556577e+02  5.89909280e+02  1.33532466e+03
  1.33532466e+03  1.33532466e+03  2.65944829e+03  3.02949090e+03
  3.02949090e+03  3.02949090e+03  6.64987171e+03  6.64987171e+03
  6.64987171e+03  9.06476891e+03  2.54201025e+04  7.61621436e+04]
E1 = -728.3069398165062  E_coul = 201.6043013580806
cycle= 3 E= -526.702638458426  delta_E= -3.63e-05  |g|= 0.0049  |ddm|= 0.0105
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106537
diis-c [-4.74575016e-07 -1.14414224e-03  1.30556357e-01  8.70587785e-01]
  HOMO = -0.57655250930449  LUMO = 1.01569221141405
  mo_energy =
[-1.18576743e+02 -1.23064241e+01 -9.55943127e+00 -9.55943127e+00
 -9.55943127e+00 -1.25080652e+00 -5.76552509e-01 -5.76552509e-01
 -5.76552509e-01  1.01569221e+00  1.01569221e+00  1.01569221e+00
  7.43249053e+00  7.43249053e+00  7.43249053e+00  9.74549739e+00
  3.37860468e+01  3.37860468e+01  3.37860468e+01  1.05136910e+02
  1.29299535e+02  1.29299535e+02  1.29299535e+02  4.83548991e+02
  4.83548991e+02  4.83548991e+02  5.89901370e+02  1.33531654e+03
  1.33531654e+03  1.33531654e+03  2.65943960e+03  3.02948244e+03
  3.02948244e+03  3.02948244e+03  6.64986289e+03  6.64986289e+03
  6.64986289e+03  9.06475989e+03  2.54200933e+04  7.61621343e+04]
E1 = -728.3214848595354  E_coul = 201.61884552413537
cycle= 4 E= -526.7026393354  delta_E= -8.77e-07  |g|= 6.2e-05  |ddm|= 0.00134
    CPU time for cycle= 4      0.03 sec, wall time      0.04 sec
diis-norm(errvec)=0.000131302
diis-c [-1.32886650e-09  6.61924376e-05 -9.14991619e-03 -7.22678048e-02
  1.08135153e+00]
  HOMO = -0.576541170959112  LUMO = 1.01570063681147
  mo_energy =
[-1.18576752e+02 -1.23063972e+01 -9.55941665e+00 -9.55941665e+00
 -9.55941665e+00 -1.25078813e+00 -5.76541171e-01 -5.76541171e-01
 -5.76541171e-01  1.01570064e+00  1.01570064e+00  1.01570064e+00
  7.43250935e+00  7.43250935e+00  7.43250935e+00  9.74553124e+00
  3.37860602e+01  3.37860602e+01  3.37860602e+01  1.05136918e+02
  1.29299539e+02  1.29299539e+02  1.29299539e+02  4.83548983e+02
  4.83548983e+02  4.83548983e+02  5.89901354e+02  1.33531653e+03
  1.33531653e+03  1.33531653e+03  2.65943956e+03  3.02948241e+03
  3.02948241e+03  3.02948241e+03  6.64986285e+03  6.64986285e+03
  6.64986285e+03  9.06475984e+03  2.54200933e+04  7.61621342e+04]
E1 = -728.321490428961  E_coul = 201.61885109344385
cycle= 5 E= -526.702639335517  delta_E= -1.17e-10  |g|= 7.86e-06  |ddm|= 2.42e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.321490428961  E_coul = 201.61885109344385
  HOMO = -0.576544692064041  LUMO = 1.01569805418323
  mo_energy =
[-1.18576769e+02 -1.23064096e+01 -9.55942962e+00 -9.55942962e+00
 -9.55942962e+00 -1.25079246e+00 -5.76544692e-01 -5.76544692e-01
 -5.76544692e-01  1.01569805e+00  1.01569805e+00  1.01569805e+00
  7.43250073e+00  7.43250073e+00  7.43250073e+00  9.74552119e+00
  3.37860474e+01  3.37860474e+01  3.37860474e+01  1.05136902e+02
  1.29299523e+02  1.29299523e+02  1.29299523e+02  4.83548966e+02
  4.83548966e+02  4.83548966e+02  5.89901337e+02  1.33531651e+03
  1.33531651e+03  1.33531651e+03  2.65943954e+03  3.02948239e+03
  3.02948239e+03  3.02948239e+03  6.64986284e+03  6.64986284e+03
  6.64986284e+03  9.06475983e+03  2.54200932e+04  7.61621342e+04]
E1 = -728.3215295537798  E_coul = 201.618890218259
Extra cycle  E= -526.702639335521  delta_E= -3.52e-12  |g|= 2.33e-06  |ddm|= 4.06e-06
    CPU time for scf_cycle      7.56 sec, wall time      0.54 sec
exp = [2.61826575e+04 7.61751835e+03 3.61735264e+03 1.59775231e+03
 3.82787312e+02 1.09302058e+02 3.58475152e+01 8.07809521e+00
 3.10879437e+00 3.99657299e-01 1.36278376e+03 6.64740161e+02
 3.00935945e+02 3.14019817e+02 6.16484907e+01 7.38743030e+00
 2.01825896e+01 7.76288381e-01 2.89132760e+00 2.21570050e-01]
E = -526.7026393355208
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:58:06 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6575176        1
[INPUT] 0    0    [1    /1   ]  7617.51834877        1
[INPUT] 0    0    [1    /1   ]  3617.35263636        1
[INPUT] 0    0    [1    /1   ]  1597.7523079         1
[INPUT] 0    0    [1    /1   ]  382.787311501        1
[INPUT] 0    0    [1    /1   ]  109.30205763         1
[INPUT] 0    0    [1    /1   ]  35.8475151975        1
[INPUT] 0    0    [1    /1   ]  8.07809520648        1
[INPUT] 0    0    [1    /1   ]  3.10879436549        1
[INPUT] 0    0    [1    /1   ]  0.399657298782       1
[INPUT] 1    0    [1    /1   ]  1362.78376313        1
[INPUT] 1    0    [1    /1   ]  664.740161394        1
[INPUT] 1    0    [1    /1   ]  300.935944712        1
[INPUT] 1    0    [1    /1   ]  314.019817071        1
[INPUT] 1    0    [1    /1   ]  61.6484906602        1
[INPUT] 1    0    [1    /1   ]  7.38743029869        1
[INPUT] 1    0    [1    /1   ]  20.1825896181        1
[INPUT] 1    0    [1    /1   ]  0.776288380834       1
[INPUT] 1    0    [1    /1   ]  2.89132759562        1
[INPUT] 1    0    [1    /1   ]  0.221570049708       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.657517637712, 1.0]], [0, [7617.518348769782, 1.0]], [0, [3617.3526363594506, 1.0]], [0, [1597.7523079024675, 1.0]], [0, [382.7873115006204, 1.0]], [0, [109.30205762992136, 1.0]], [0, [35.847515197505125, 1.0]], [0, [8.078095206479556, 1.0]], [0, [3.108794365486066, 1.0]], [0, [0.3996572987823121, 1.0]], [1, [1362.7837631323207, 1.0]], [1, [664.7401613943192, 1.0]], [1, [300.9359447115343, 1.0]], [1, [314.0198170714051, 1.0]], [1, [61.648490660214925, 1.0]], [1, [7.387430298686451, 1.0]], [1, [20.18258961810142, 1.0]], [1, [0.7762883808337392, 1.0]], [1, [2.8913275956196958, 1.0]], [1, [0.22157004970796132, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65751764]
bas 1, expnt(s) = [7617.51834877]
bas 2, expnt(s) = [3617.35263636]
bas 3, expnt(s) = [1597.7523079]
bas 4, expnt(s) = [382.7873115]
bas 5, expnt(s) = [109.30205763]
bas 6, expnt(s) = [35.8475152]
bas 7, expnt(s) = [8.07809521]
bas 8, expnt(s) = [3.10879437]
bas 9, expnt(s) = [0.3996573]
bas 10, expnt(s) = [1362.78376313]
bas 11, expnt(s) = [664.74016139]
bas 12, expnt(s) = [300.93594471]
bas 13, expnt(s) = [314.01981707]
bas 14, expnt(s) = [61.64849066]
bas 15, expnt(s) = [7.3874303]
bas 16, expnt(s) = [20.18258962]
bas 17, expnt(s) = [0.77628838]
bas 18, expnt(s) = [2.8913276]
bas 19, expnt(s) = [0.22157005]
CPU time:       972.73
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826575e+04 5.20026312e+03 7.61751835e+03 2.06003764e+03
 3.61735264e+03 1.17844186e+03 1.59775231e+03 6.38479730e+02
 3.82787312e+02 2.18641790e+02 1.09302058e+02 8.54055861e+01
 3.58475152e+01 3.70134287e+01 8.07809521e+00 1.21058907e+01
 3.10879437e+00 5.91505819e+00 3.99657299e-01 1.26993308e+00
 1.36278376e+03 2.41556140e+04 6.64740161e+02 9.84689462e+03
 3.00935945e+02 3.65659594e+03 3.14019817e+02 3.85638791e+03
 6.16484907e+01 5.03950004e+02 7.38743030e+00 3.55304852e+01
 2.01825896e+01 1.24797391e+02 7.76288381e-01 2.12575520e+00
 2.89132760e+00 1.09990713e+01 2.21570050e-01 4.43479155e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982904841759762
cond(S) = 102518.24790089003
E1 = -729.3862358690633  E_coul = 203.12834632722064
init E= -526.257889541843
    CPU time for initialize scf      7.49 sec, wall time      0.36 sec
  HOMO = -0.556785304798396  LUMO = 1.02818077414156
  mo_energy =
[-1.18331510e+02 -1.22074233e+01 -9.45101624e+00 -9.45101624e+00
 -9.45101624e+00 -1.22550076e+00 -5.56785305e-01 -5.56785305e-01
 -5.56785305e-01  1.02818077e+00  1.02818077e+00  1.02818077e+00
  7.49524676e+00  7.49524676e+00  7.49524676e+00  9.81627684e+00
  3.38996362e+01  3.38996362e+01  3.38996362e+01  1.05304475e+02
  1.29474362e+02  1.29474362e+02  1.29474362e+02  4.83793596e+02
  4.83793596e+02  4.83793596e+02  5.90182127e+02  1.33561424e+03
  1.33561424e+03  1.33561424e+03  2.65986941e+03  3.02984469e+03
  3.02984469e+03  3.02984469e+03  6.65033732e+03  6.65033732e+03
  6.65033732e+03  9.06530916e+03  2.54207363e+04  7.61628673e+04]
E1 = -727.9403809786286  E_coul = 201.23839192024772
cycle= 1 E= -526.701989058381  delta_E= -0.444  |g|= 0.185  |ddm|= 0.413
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.54275
diis-c [-0.29457733  1.        ]
  HOMO = -0.582515483884309  LUMO = 1.01116818210185
  mo_energy =
[-1.18628751e+02 -1.23338309e+01 -9.58787802e+00 -9.58787802e+00
 -9.58787802e+00 -1.25843549e+00 -5.82515484e-01 -5.82515484e-01
 -5.82515484e-01  1.01116818e+00  1.01116818e+00  1.01116818e+00
  7.41591700e+00  7.41591700e+00  7.41591700e+00  9.72380196e+00
  3.37570207e+01  3.37570207e+01  3.37570207e+01  1.05094640e+02
  1.29257442e+02  1.29257442e+02  1.29257442e+02  4.83497650e+02
  4.83497650e+02  4.83497650e+02  5.89848075e+02  1.33526188e+03
  1.33526188e+03  1.33526188e+03  2.65938246e+03  3.02942603e+03
  3.02942603e+03  3.02942603e+03  6.64980528e+03  6.64980528e+03
  6.64980528e+03  9.06470176e+03  2.54200349e+04  7.61620757e+04]
E1 = -728.414677821417  E_coul = 201.7120757090025
cycle= 2 E= -526.702602112414  delta_E= -0.000613  |g|= 0.034  |ddm|= 0.0397
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0681178
diis-c [-0.00274827  0.07451417  0.92548583]
  HOMO = -0.575605432245066  LUMO = 1.01639802004604
  mo_energy =
[-1.18569059e+02 -1.23023054e+01 -9.55503320e+00 -9.55503320e+00
 -9.55503320e+00 -1.24965728e+00 -5.75605432e-01 -5.75605432e-01
 -5.75605432e-01  1.01639802e+00  1.01639802e+00  1.01639802e+00
  7.43508429e+00  7.43508429e+00  7.43508429e+00  9.74866175e+00
  3.37904995e+01  3.37904995e+01  3.37904995e+01  1.05143152e+02
  1.29305814e+02  1.29305814e+02  1.29305814e+02  4.83556577e+02
  4.83556577e+02  4.83556577e+02  5.89909280e+02  1.33532466e+03
  1.33532466e+03  1.33532466e+03  2.65944829e+03  3.02949090e+03
  3.02949090e+03  3.02949090e+03  6.64987171e+03  6.64987171e+03
  6.64987171e+03  9.06476891e+03  2.54201025e+04  7.61621436e+04]
E1 = -728.3069398165062  E_coul = 201.6043013580806
cycle= 3 E= -526.702638458426  delta_E= -3.63e-05  |g|= 0.0049  |ddm|= 0.0105
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106537
diis-c [-4.74575016e-07 -1.14414224e-03  1.30556357e-01  8.70587785e-01]
  HOMO = -0.57655250930449  LUMO = 1.01569221141405
  mo_energy =
[-1.18576743e+02 -1.23064241e+01 -9.55943127e+00 -9.55943127e+00
 -9.55943127e+00 -1.25080652e+00 -5.76552509e-01 -5.76552509e-01
 -5.76552509e-01  1.01569221e+00  1.01569221e+00  1.01569221e+00
  7.43249053e+00  7.43249053e+00  7.43249053e+00  9.74549739e+00
  3.37860468e+01  3.37860468e+01  3.37860468e+01  1.05136910e+02
  1.29299535e+02  1.29299535e+02  1.29299535e+02  4.83548991e+02
  4.83548991e+02  4.83548991e+02  5.89901370e+02  1.33531654e+03
  1.33531654e+03  1.33531654e+03  2.65943960e+03  3.02948244e+03
  3.02948244e+03  3.02948244e+03  6.64986289e+03  6.64986289e+03
  6.64986289e+03  9.06475989e+03  2.54200933e+04  7.61621343e+04]
E1 = -728.3214848595354  E_coul = 201.61884552413537
cycle= 4 E= -526.7026393354  delta_E= -8.77e-07  |g|= 6.2e-05  |ddm|= 0.00134
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000131302
diis-c [-1.32886650e-09  6.61924376e-05 -9.14991619e-03 -7.22678048e-02
  1.08135153e+00]
  HOMO = -0.576541170959112  LUMO = 1.01570063681147
  mo_energy =
[-1.18576752e+02 -1.23063972e+01 -9.55941665e+00 -9.55941665e+00
 -9.55941665e+00 -1.25078813e+00 -5.76541171e-01 -5.76541171e-01
 -5.76541171e-01  1.01570064e+00  1.01570064e+00  1.01570064e+00
  7.43250935e+00  7.43250935e+00  7.43250935e+00  9.74553124e+00
  3.37860602e+01  3.37860602e+01  3.37860602e+01  1.05136918e+02
  1.29299539e+02  1.29299539e+02  1.29299539e+02  4.83548983e+02
  4.83548983e+02  4.83548983e+02  5.89901354e+02  1.33531653e+03
  1.33531653e+03  1.33531653e+03  2.65943956e+03  3.02948241e+03
  3.02948241e+03  3.02948241e+03  6.64986285e+03  6.64986285e+03
  6.64986285e+03  9.06475984e+03  2.54200933e+04  7.61621342e+04]
E1 = -728.321490428961  E_coul = 201.61885109344385
cycle= 5 E= -526.702639335517  delta_E= -1.17e-10  |g|= 7.86e-06  |ddm|= 2.42e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.321490428961  E_coul = 201.61885109344385
  HOMO = -0.576544692064041  LUMO = 1.01569805418323
  mo_energy =
[-1.18576769e+02 -1.23064096e+01 -9.55942962e+00 -9.55942962e+00
 -9.55942962e+00 -1.25079246e+00 -5.76544692e-01 -5.76544692e-01
 -5.76544692e-01  1.01569805e+00  1.01569805e+00  1.01569805e+00
  7.43250073e+00  7.43250073e+00  7.43250073e+00  9.74552119e+00
  3.37860474e+01  3.37860474e+01  3.37860474e+01  1.05136902e+02
  1.29299523e+02  1.29299523e+02  1.29299523e+02  4.83548966e+02
  4.83548966e+02  4.83548966e+02  5.89901337e+02  1.33531651e+03
  1.33531651e+03  1.33531651e+03  2.65943954e+03  3.02948239e+03
  3.02948239e+03  3.02948239e+03  6.64986284e+03  6.64986284e+03
  6.64986284e+03  9.06475983e+03  2.54200932e+04  7.61621342e+04]
E1 = -728.3215295537798  E_coul = 201.618890218259
Extra cycle  E= -526.702639335521  delta_E= -3.52e-12  |g|= 2.33e-06  |ddm|= 4.06e-06
    CPU time for scf_cycle      7.69 sec, wall time      0.55 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102518.24790089003
E1 = -728.3215295537798  E_coul = 201.618890218259
init E= -526.702639335521
    CPU time for initialize scf     16.09 sec, wall time      0.76 sec
  HOMO = -0.576543973014144  LUMO = 1.01569858755703
  mo_energy =
[-1.18576764e+02 -1.23064067e+01 -9.55942666e+00 -9.55942666e+00
 -9.55942666e+00 -1.25079156e+00 -5.76543973e-01 -5.76543973e-01
 -5.76543973e-01  1.01569859e+00  1.01569859e+00  1.01569859e+00
  7.43250258e+00  7.43250258e+00  7.43250258e+00  9.74552348e+00
  3.37860504e+01  3.37860504e+01  3.37860504e+01  1.05136906e+02
  1.29299527e+02  1.29299527e+02  1.29299527e+02  4.83548971e+02
  4.83548971e+02  4.83548971e+02  5.89901342e+02  1.33531651e+03
  1.33531651e+03  1.33531651e+03  2.65943955e+03  3.02948239e+03
  3.02948239e+03  3.02948239e+03  6.64986284e+03  6.64986284e+03
  6.64986284e+03  9.06475983e+03  2.54200932e+04  7.61621342e+04]
E1 = -728.3215202062626  E_coul = 201.61888087074135
cycle= 1 E= -526.702639335521  delta_E= -4.55e-13  |g|= 6.02e-07  |ddm|= 9.33e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3215202062626  E_coul = 201.61888087074135
  HOMO = -0.576544132946915  LUMO = 1.01569846824428
  mo_energy =
[-1.18576766e+02 -1.23064074e+01 -9.55942736e+00 -9.55942736e+00
 -9.55942736e+00 -1.25079176e+00 -5.76544133e-01 -5.76544133e-01
 -5.76544133e-01  1.01569847e+00  1.01569847e+00  1.01569847e+00
  7.43250215e+00  7.43250215e+00  7.43250215e+00  9.74552295e+00
  3.37860497e+01  3.37860497e+01  3.37860497e+01  1.05136905e+02
  1.29299526e+02  1.29299526e+02  1.29299526e+02  4.83548969e+02
  4.83548969e+02  4.83548969e+02  5.89901340e+02  1.33531651e+03
  1.33531651e+03  1.33531651e+03  2.65943955e+03  3.02948239e+03
  3.02948239e+03  3.02948239e+03  6.64986284e+03  6.64986284e+03
  6.64986284e+03  9.06475983e+03  2.54200932e+04  7.61621342e+04]
E1 = -728.3215224943572  E_coul = 201.6188831588356
Extra cycle  E= -526.702639335522  delta_E= -3.41e-13  |g|= 1.52e-07  |ddm|= 2.2e-07
    CPU time for scf_cycle     16.23 sec, wall time      0.88 sec
exp = [2.61826575e+04 7.61751835e+03 3.61735264e+03 1.59775231e+03
 3.82787312e+02 1.09302058e+02 3.58475152e+01 8.07809521e+00
 3.10879437e+00 3.99657299e-01 1.36278376e+03 6.64740161e+02
 3.00935945e+02 3.14019817e+02 6.16484907e+01 7.38743030e+00
 2.01825896e+01 7.76288381e-01 2.89132760e+00 2.21570050e-01]
grad_E = [-1.52182009e-06  3.35474106e-06 -1.55501534e-06  7.09115297e-05
 -4.39535158e-05 -8.91357985e-04 -3.32073183e-04  1.92691036e-03
 -3.77076130e-03  9.22958715e-03 -5.22389404e-07  4.79216681e-06
  2.23354907e-05  1.92589646e-05  1.01871230e-04 -2.05154115e-03
 -4.11224453e-04  1.19394480e-02  7.26709228e-03 -5.65452991e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:58:11 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6584195        1
[INPUT] 0    0    [1    /1   ]  7617.51642057        1
[INPUT] 0    0    [1    /1   ]  3617.35360364        1
[INPUT] 0    0    [1    /1   ]  1597.71279081        1
[INPUT] 0    0    [1    /1   ]  382.742326887        1
[INPUT] 0    0    [1    /1   ]  110.060807003        1
[INPUT] 0    0    [1    /1   ]  36.166120349         1
[INPUT] 0    0    [1    /1   ]  8.06509867945        1
[INPUT] 0    0    [1    /1   ]  3.11236058193        1
[INPUT] 0    0    [1    /1   ]  0.399379652914       1
[INPUT] 1    0    [1    /1   ]  1362.78406537        1
[INPUT] 1    0    [1    /1   ]  664.73716493         1
[INPUT] 1    0    [1    /1   ]  300.92180364         1
[INPUT] 1    0    [1    /1   ]  314.007625075        1
[INPUT] 1    0    [1    /1   ]  61.663274799         1
[INPUT] 1    0    [1    /1   ]  7.43332932504        1
[INPUT] 1    0    [1    /1   ]  20.146689275         1
[INPUT] 1    0    [1    /1   ]  0.780788827198       1
[INPUT] 1    0    [1    /1   ]  2.92700278341        1
[INPUT] 1    0    [1    /1   ]  0.223102312617       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.658419478717, 1.0]], [0, [7617.51642056991, 1.0]], [0, [3617.353603644074, 1.0]], [0, [1597.7127908064347, 1.0]], [0, [382.74232688678563, 1.0]], [0, [110.06080700322846, 1.0]], [0, [36.16612034901289, 1.0]], [0, [8.065098679450728, 1.0]], [0, [3.1123605819328546, 1.0]], [0, [0.3993796529138816, 1.0]], [1, [1362.7840653739172, 1.0]], [1, [664.737164929729, 1.0]], [1, [300.92180363971767, 1.0]], [1, [314.00762507543885, 1.0]], [1, [61.663274799032294, 1.0]], [1, [7.433329325035505, 1.0]], [1, [20.14668927498277, 1.0]], [1, [0.780788827197718, 1.0]], [1, [2.9270027834096157, 1.0]], [1, [0.2231023126173463, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65841948]
bas 1, expnt(s) = [7617.51642057]
bas 2, expnt(s) = [3617.35360364]
bas 3, expnt(s) = [1597.71279081]
bas 4, expnt(s) = [382.74232689]
bas 5, expnt(s) = [110.060807]
bas 6, expnt(s) = [36.16612035]
bas 7, expnt(s) = [8.06509868]
bas 8, expnt(s) = [3.11236058]
bas 9, expnt(s) = [0.39937965]
bas 10, expnt(s) = [1362.78406537]
bas 11, expnt(s) = [664.73716493]
bas 12, expnt(s) = [300.92180364]
bas 13, expnt(s) = [314.00762508]
bas 14, expnt(s) = [61.6632748]
bas 15, expnt(s) = [7.43332933]
bas 16, expnt(s) = [20.14668927]
bas 17, expnt(s) = [0.78078883]
bas 18, expnt(s) = [2.92700278]
bas 19, expnt(s) = [0.22310231]
CPU time:      1001.58
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826584e+04 5.20026325e+03 7.61751642e+03 2.06003725e+03
 3.61735360e+03 1.17844209e+03 1.59771279e+03 6.38467887e+02
 3.82742327e+02 2.18622519e+02 1.10060807e+02 8.58498506e+01
 3.61661203e+01 3.72598813e+01 8.06509868e+00 1.20912803e+01
 3.11236058e+00 5.92014650e+00 3.99379653e-01 1.26927135e+00
 1.36278407e+03 2.41556207e+04 6.64737165e+02 9.84683914e+03
 3.00921804e+02 3.65638116e+03 3.14007625e+02 3.85620075e+03
 6.16632748e+01 5.04101076e+02 7.43332933e+00 3.58066433e+01
 2.01466893e+01 1.24519969e+02 7.80788827e-01 2.14117114e+00
 2.92700278e+00 1.11689748e+01 2.23102313e-01 4.47316051e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98273455657691
cond(S) = 102560.28794640253
E1 = -729.3854907518374  E_coul = 203.12720419427606
init E= -526.258286557561
    CPU time for initialize scf      7.33 sec, wall time      0.34 sec
  HOMO = -0.556777605450899  LUMO = 1.03820479097311
  mo_energy =
[-1.18331895e+02 -1.22075216e+01 -9.45110719e+00 -9.45110719e+00
 -9.45110719e+00 -1.22556805e+00 -5.56777605e-01 -5.56777605e-01
 -5.56777605e-01  1.03820479e+00  1.03820479e+00  1.03820479e+00
  7.59295205e+00  7.59295205e+00  7.59295205e+00  9.82275175e+00
  3.41306438e+01  3.41306438e+01  3.41306438e+01  1.06192475e+02
  1.29685263e+02  1.29685263e+02  1.29685263e+02  4.83952323e+02
  4.83952323e+02  4.83952323e+02  5.93201335e+02  1.33573014e+03
  1.33573014e+03  1.33573014e+03  2.66358694e+03  3.02991407e+03
  3.02991407e+03  3.02991407e+03  6.65037019e+03  6.65037019e+03
  6.65037019e+03  9.06885849e+03  2.54240884e+04  7.61659807e+04]
E1 = -727.9543352906467  E_coul = 201.25185328600213
cycle= 1 E= -526.702482004644  delta_E= -0.444  |g|= 0.184  |ddm|= 0.413
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.54292
diis-c [-0.29476188  1.        ]
  HOMO = -0.58207143178799  LUMO = 1.02133090978189
  mo_energy =
[-1.18627772e+02 -1.23329407e+01 -9.58694139e+00 -9.58694139e+00
 -9.58694139e+00 -1.25795758e+00 -5.82071432e-01 -5.82071432e-01
 -5.82071432e-01  1.02133091e+00  1.02133091e+00  1.02133091e+00
  7.51386641e+00  7.51386641e+00  7.51386641e+00  9.73112571e+00
  3.39890207e+01  3.39890207e+01  3.39890207e+01  1.05983233e+02
  1.29469663e+02  1.29469663e+02  1.29469663e+02  4.83657779e+02
  4.83657779e+02  4.83657779e+02  5.92868509e+02  1.33537926e+03
  1.33537926e+03  1.33537926e+03  2.66310179e+03  3.02949709e+03
  3.02949709e+03  3.02949709e+03  6.64983995e+03  6.64983995e+03
  6.64983995e+03  9.06825299e+03  2.54233889e+04  7.61651910e+04]
E1 = -728.424789540082  E_coul = 201.72170119596063
cycle= 2 E= -526.703088344121  delta_E= -0.000606  |g|= 0.0338  |ddm|= 0.0395
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.067795
diis-c [-0.00273152  0.07399427  0.92600573]
  HOMO = -0.575228587143175  LUMO = 1.0265589875495
  mo_energy =
[-1.18568445e+02 -1.23016599e+01 -9.55434880e+00 -9.55434880e+00
 -9.55434880e+00 -1.24926575e+00 -5.75228587e-01 -5.75228587e-01
 -5.75228587e-01  1.02655899e+00  1.02655899e+00  1.02655899e+00
  7.53299263e+00  7.53299263e+00  7.53299263e+00  9.75580456e+00
  3.40222640e+01  3.40222640e+01  3.40222640e+01  1.06031541e+02
  1.29517702e+02  1.29517702e+02  1.29517702e+02  4.83716341e+02
  4.83716341e+02  4.83716341e+02  5.92929364e+02  1.33544166e+03
  1.33544166e+03  1.33544166e+03  2.66316723e+03  3.02956157e+03
  3.02956157e+03  3.02956157e+03  6.64990599e+03  6.64990599e+03
  6.64990599e+03  9.06831974e+03  2.54234561e+04  7.61652585e+04]
E1 = -728.3181222357549  E_coul = 201.61499815315753
cycle= 3 E= -526.703124082597  delta_E= -3.57e-05  |g|= 0.00487  |ddm|= 0.0104
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106133
diis-c [-4.70068128e-07 -1.13766272e-03  1.30681408e-01  8.70456255e-01]
  HOMO = -0.576165993226777  LUMO = 1.0258538300959
  mo_energy =
[-1.18576086e+02 -1.23057494e+01 -9.55871640e+00 -9.55871640e+00
 -9.55871640e+00 -1.25040281e+00 -5.76165993e-01 -5.76165993e-01
 -5.76165993e-01  1.02585383e+00  1.02585383e+00  1.02585383e+00
  7.53040369e+00  7.53040369e+00  7.53040369e+00  9.75266317e+00
  3.40178400e+01  3.40178400e+01  3.40178400e+01  1.06025322e+02
  1.29511462e+02  1.29511462e+02  1.29511462e+02  4.83708798e+02
  4.83708798e+02  4.83708798e+02  5.92921495e+02  1.33543359e+03
  1.33543359e+03  1.33543359e+03  2.66315859e+03  3.02955316e+03
  3.02955316e+03  3.02955316e+03  6.64989722e+03  6.64989722e+03
  6.64989722e+03  9.06831078e+03  2.54234470e+04  7.61652492e+04]
E1 = -728.3325378237671  E_coul = 201.62941287729365
cycle= 4 E= -526.703124946474  delta_E= -8.64e-07  |g|= 6.19e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000131006
diis-c [-1.30960563e-09  6.63003171e-05 -9.20086757e-03 -7.25693556e-02
  1.08170392e+00]
  HOMO = -0.576154593825262  LUMO = 1.0258623670391
  mo_energy =
[-1.18576094e+02 -1.23057225e+01 -9.55870169e+00 -9.55870169e+00
 -9.55870169e+00 -1.25038435e+00 -5.76154594e-01 -5.76154594e-01
 -5.76154594e-01  1.02586237e+00  1.02586237e+00  1.02586237e+00
  7.53042262e+00  7.53042262e+00  7.53042262e+00  9.75269715e+00
  3.40178535e+01  3.40178535e+01  3.40178535e+01  1.06025331e+02
  1.29511467e+02  1.29511467e+02  1.29511467e+02  4.83708790e+02
  4.83708790e+02  4.83708790e+02  5.92921479e+02  1.33543358e+03
  1.33543358e+03  1.33543358e+03  2.66315855e+03  3.02955313e+03
  3.02955313e+03  3.02955313e+03  6.64989718e+03  6.64989718e+03
  6.64989718e+03  9.06831073e+03  2.54234469e+04  7.61652491e+04]
E1 = -728.3325434824485  E_coul = 201.629418535855
cycle= 5 E= -526.703124946594  delta_E= -1.2e-10  |g|= 7.82e-06  |ddm|= 2.43e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3325434824485  E_coul = 201.629418535855
  HOMO = -0.57615809017524  LUMO = 1.02585977993504
  mo_energy =
[-1.18576112e+02 -1.23057348e+01 -9.55871458e+00 -9.55871458e+00
 -9.55871458e+00 -1.25038866e+00 -5.76158090e-01 -5.76158090e-01
 -5.76158090e-01  1.02585978e+00  1.02585978e+00  1.02585978e+00
  7.53041401e+00  7.53041401e+00  7.53041401e+00  9.75268715e+00
  3.40178408e+01  3.40178408e+01  3.40178408e+01  1.06025315e+02
  1.29511451e+02  1.29511451e+02  1.29511451e+02  4.83708773e+02
  4.83708773e+02  4.83708773e+02  5.92921462e+02  1.33543356e+03
  1.33543356e+03  1.33543356e+03  2.66315853e+03  3.02955311e+03
  3.02955311e+03  3.02955311e+03  6.64989716e+03  6.64989716e+03
  6.64989716e+03  9.06831071e+03  2.54234469e+04  7.61652491e+04]
E1 = -728.3325822357389  E_coul = 201.62945728914357
Extra cycle  E= -526.703124946595  delta_E= -1.71e-12  |g|= 2.31e-06  |ddm|= 4.03e-06
    CPU time for scf_cycle      7.54 sec, wall time      0.52 sec
exp = [2.61826584e+04 7.61751642e+03 3.61735360e+03 1.59771279e+03
 3.82742327e+02 1.10060807e+02 3.61661203e+01 8.06509868e+00
 3.11236058e+00 3.99379653e-01 1.36278407e+03 6.64737165e+02
 3.00921804e+02 3.14007625e+02 6.16632748e+01 7.43332933e+00
 2.01466893e+01 7.80788827e-01 2.92700278e+00 2.23102313e-01]
E = -526.7031249465953
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:58:12 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6584195        1
[INPUT] 0    0    [1    /1   ]  7617.51642057        1
[INPUT] 0    0    [1    /1   ]  3617.35360364        1
[INPUT] 0    0    [1    /1   ]  1597.71279081        1
[INPUT] 0    0    [1    /1   ]  382.742326887        1
[INPUT] 0    0    [1    /1   ]  110.060807003        1
[INPUT] 0    0    [1    /1   ]  36.166120349         1
[INPUT] 0    0    [1    /1   ]  8.06509867945        1
[INPUT] 0    0    [1    /1   ]  3.11236058193        1
[INPUT] 0    0    [1    /1   ]  0.399379652914       1
[INPUT] 1    0    [1    /1   ]  1362.78406537        1
[INPUT] 1    0    [1    /1   ]  664.73716493         1
[INPUT] 1    0    [1    /1   ]  300.92180364         1
[INPUT] 1    0    [1    /1   ]  314.007625075        1
[INPUT] 1    0    [1    /1   ]  61.663274799         1
[INPUT] 1    0    [1    /1   ]  7.43332932504        1
[INPUT] 1    0    [1    /1   ]  20.146689275         1
[INPUT] 1    0    [1    /1   ]  0.780788827198       1
[INPUT] 1    0    [1    /1   ]  2.92700278341        1
[INPUT] 1    0    [1    /1   ]  0.223102312617       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.658419478717, 1.0]], [0, [7617.51642056991, 1.0]], [0, [3617.353603644074, 1.0]], [0, [1597.7127908064347, 1.0]], [0, [382.74232688678563, 1.0]], [0, [110.06080700322846, 1.0]], [0, [36.16612034901289, 1.0]], [0, [8.065098679450728, 1.0]], [0, [3.1123605819328546, 1.0]], [0, [0.3993796529138816, 1.0]], [1, [1362.7840653739172, 1.0]], [1, [664.737164929729, 1.0]], [1, [300.92180363971767, 1.0]], [1, [314.00762507543885, 1.0]], [1, [61.663274799032294, 1.0]], [1, [7.433329325035505, 1.0]], [1, [20.14668927498277, 1.0]], [1, [0.780788827197718, 1.0]], [1, [2.9270027834096157, 1.0]], [1, [0.2231023126173463, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65841948]
bas 1, expnt(s) = [7617.51642057]
bas 2, expnt(s) = [3617.35360364]
bas 3, expnt(s) = [1597.71279081]
bas 4, expnt(s) = [382.74232689]
bas 5, expnt(s) = [110.060807]
bas 6, expnt(s) = [36.16612035]
bas 7, expnt(s) = [8.06509868]
bas 8, expnt(s) = [3.11236058]
bas 9, expnt(s) = [0.39937965]
bas 10, expnt(s) = [1362.78406537]
bas 11, expnt(s) = [664.73716493]
bas 12, expnt(s) = [300.92180364]
bas 13, expnt(s) = [314.00762508]
bas 14, expnt(s) = [61.6632748]
bas 15, expnt(s) = [7.43332933]
bas 16, expnt(s) = [20.14668927]
bas 17, expnt(s) = [0.78078883]
bas 18, expnt(s) = [2.92700278]
bas 19, expnt(s) = [0.22310231]
CPU time:      1009.25
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826584e+04 5.20026325e+03 7.61751642e+03 2.06003725e+03
 3.61735360e+03 1.17844209e+03 1.59771279e+03 6.38467887e+02
 3.82742327e+02 2.18622519e+02 1.10060807e+02 8.58498506e+01
 3.61661203e+01 3.72598813e+01 8.06509868e+00 1.20912803e+01
 3.11236058e+00 5.92014650e+00 3.99379653e-01 1.26927135e+00
 1.36278407e+03 2.41556207e+04 6.64737165e+02 9.84683914e+03
 3.00921804e+02 3.65638116e+03 3.14007625e+02 3.85620075e+03
 6.16632748e+01 5.04101076e+02 7.43332933e+00 3.58066433e+01
 2.01466893e+01 1.24519969e+02 7.80788827e-01 2.14117114e+00
 2.92700278e+00 1.11689748e+01 2.23102313e-01 4.47316051e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98273455657691
cond(S) = 102560.28794640253
E1 = -729.3854907518374  E_coul = 203.12720419427606
init E= -526.258286557561
    CPU time for initialize scf      7.72 sec, wall time      0.36 sec
  HOMO = -0.556777605450899  LUMO = 1.03820479097311
  mo_energy =
[-1.18331895e+02 -1.22075216e+01 -9.45110719e+00 -9.45110719e+00
 -9.45110719e+00 -1.22556805e+00 -5.56777605e-01 -5.56777605e-01
 -5.56777605e-01  1.03820479e+00  1.03820479e+00  1.03820479e+00
  7.59295205e+00  7.59295205e+00  7.59295205e+00  9.82275175e+00
  3.41306438e+01  3.41306438e+01  3.41306438e+01  1.06192475e+02
  1.29685263e+02  1.29685263e+02  1.29685263e+02  4.83952323e+02
  4.83952323e+02  4.83952323e+02  5.93201335e+02  1.33573014e+03
  1.33573014e+03  1.33573014e+03  2.66358694e+03  3.02991407e+03
  3.02991407e+03  3.02991407e+03  6.65037019e+03  6.65037019e+03
  6.65037019e+03  9.06885849e+03  2.54240884e+04  7.61659807e+04]
E1 = -727.9543352906467  E_coul = 201.25185328600213
cycle= 1 E= -526.702482004644  delta_E= -0.444  |g|= 0.184  |ddm|= 0.413
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.54292
diis-c [-0.29476188  1.        ]
  HOMO = -0.58207143178799  LUMO = 1.02133090978189
  mo_energy =
[-1.18627772e+02 -1.23329407e+01 -9.58694139e+00 -9.58694139e+00
 -9.58694139e+00 -1.25795758e+00 -5.82071432e-01 -5.82071432e-01
 -5.82071432e-01  1.02133091e+00  1.02133091e+00  1.02133091e+00
  7.51386641e+00  7.51386641e+00  7.51386641e+00  9.73112571e+00
  3.39890207e+01  3.39890207e+01  3.39890207e+01  1.05983233e+02
  1.29469663e+02  1.29469663e+02  1.29469663e+02  4.83657779e+02
  4.83657779e+02  4.83657779e+02  5.92868509e+02  1.33537926e+03
  1.33537926e+03  1.33537926e+03  2.66310179e+03  3.02949709e+03
  3.02949709e+03  3.02949709e+03  6.64983995e+03  6.64983995e+03
  6.64983995e+03  9.06825299e+03  2.54233889e+04  7.61651910e+04]
E1 = -728.424789540082  E_coul = 201.72170119596063
cycle= 2 E= -526.703088344121  delta_E= -0.000606  |g|= 0.0338  |ddm|= 0.0395
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.067795
diis-c [-0.00273152  0.07399427  0.92600573]
  HOMO = -0.575228587143175  LUMO = 1.0265589875495
  mo_energy =
[-1.18568445e+02 -1.23016599e+01 -9.55434880e+00 -9.55434880e+00
 -9.55434880e+00 -1.24926575e+00 -5.75228587e-01 -5.75228587e-01
 -5.75228587e-01  1.02655899e+00  1.02655899e+00  1.02655899e+00
  7.53299263e+00  7.53299263e+00  7.53299263e+00  9.75580456e+00
  3.40222640e+01  3.40222640e+01  3.40222640e+01  1.06031541e+02
  1.29517702e+02  1.29517702e+02  1.29517702e+02  4.83716341e+02
  4.83716341e+02  4.83716341e+02  5.92929364e+02  1.33544166e+03
  1.33544166e+03  1.33544166e+03  2.66316723e+03  3.02956157e+03
  3.02956157e+03  3.02956157e+03  6.64990599e+03  6.64990599e+03
  6.64990599e+03  9.06831974e+03  2.54234561e+04  7.61652585e+04]
E1 = -728.3181222357549  E_coul = 201.61499815315753
cycle= 3 E= -526.703124082597  delta_E= -3.57e-05  |g|= 0.00487  |ddm|= 0.0104
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106133
diis-c [-4.70068128e-07 -1.13766272e-03  1.30681408e-01  8.70456255e-01]
  HOMO = -0.576165993226777  LUMO = 1.0258538300959
  mo_energy =
[-1.18576086e+02 -1.23057494e+01 -9.55871640e+00 -9.55871640e+00
 -9.55871640e+00 -1.25040281e+00 -5.76165993e-01 -5.76165993e-01
 -5.76165993e-01  1.02585383e+00  1.02585383e+00  1.02585383e+00
  7.53040369e+00  7.53040369e+00  7.53040369e+00  9.75266317e+00
  3.40178400e+01  3.40178400e+01  3.40178400e+01  1.06025322e+02
  1.29511462e+02  1.29511462e+02  1.29511462e+02  4.83708798e+02
  4.83708798e+02  4.83708798e+02  5.92921495e+02  1.33543359e+03
  1.33543359e+03  1.33543359e+03  2.66315859e+03  3.02955316e+03
  3.02955316e+03  3.02955316e+03  6.64989722e+03  6.64989722e+03
  6.64989722e+03  9.06831078e+03  2.54234470e+04  7.61652492e+04]
E1 = -728.3325378237671  E_coul = 201.62941287729365
cycle= 4 E= -526.703124946474  delta_E= -8.64e-07  |g|= 6.19e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000131006
diis-c [-1.30960563e-09  6.63003171e-05 -9.20086757e-03 -7.25693556e-02
  1.08170392e+00]
  HOMO = -0.576154593825262  LUMO = 1.0258623670391
  mo_energy =
[-1.18576094e+02 -1.23057225e+01 -9.55870169e+00 -9.55870169e+00
 -9.55870169e+00 -1.25038435e+00 -5.76154594e-01 -5.76154594e-01
 -5.76154594e-01  1.02586237e+00  1.02586237e+00  1.02586237e+00
  7.53042262e+00  7.53042262e+00  7.53042262e+00  9.75269715e+00
  3.40178535e+01  3.40178535e+01  3.40178535e+01  1.06025331e+02
  1.29511467e+02  1.29511467e+02  1.29511467e+02  4.83708790e+02
  4.83708790e+02  4.83708790e+02  5.92921479e+02  1.33543358e+03
  1.33543358e+03  1.33543358e+03  2.66315855e+03  3.02955313e+03
  3.02955313e+03  3.02955313e+03  6.64989718e+03  6.64989718e+03
  6.64989718e+03  9.06831073e+03  2.54234469e+04  7.61652491e+04]
E1 = -728.3325434824485  E_coul = 201.629418535855
cycle= 5 E= -526.703124946594  delta_E= -1.2e-10  |g|= 7.82e-06  |ddm|= 2.43e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3325434824485  E_coul = 201.629418535855
  HOMO = -0.57615809017524  LUMO = 1.02585977993504
  mo_energy =
[-1.18576112e+02 -1.23057348e+01 -9.55871458e+00 -9.55871458e+00
 -9.55871458e+00 -1.25038866e+00 -5.76158090e-01 -5.76158090e-01
 -5.76158090e-01  1.02585978e+00  1.02585978e+00  1.02585978e+00
  7.53041401e+00  7.53041401e+00  7.53041401e+00  9.75268715e+00
  3.40178408e+01  3.40178408e+01  3.40178408e+01  1.06025315e+02
  1.29511451e+02  1.29511451e+02  1.29511451e+02  4.83708773e+02
  4.83708773e+02  4.83708773e+02  5.92921462e+02  1.33543356e+03
  1.33543356e+03  1.33543356e+03  2.66315853e+03  3.02955311e+03
  3.02955311e+03  3.02955311e+03  6.64989716e+03  6.64989716e+03
  6.64989716e+03  9.06831071e+03  2.54234469e+04  7.61652491e+04]
E1 = -728.3325822357389  E_coul = 201.62945728914357
Extra cycle  E= -526.703124946595  delta_E= -1.71e-12  |g|= 2.31e-06  |ddm|= 4.03e-06
    CPU time for scf_cycle      7.93 sec, wall time      0.54 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102560.28794640253
E1 = -728.3325822357389  E_coul = 201.62945728914357
init E= -526.703124946595
    CPU time for initialize scf     16.12 sec, wall time      0.76 sec
  HOMO = -0.576157379408737  LUMO = 1.02586031194624
  mo_energy =
[-1.18576107e+02 -1.23057319e+01 -9.55871164e+00 -9.55871164e+00
 -9.55871164e+00 -1.25038777e+00 -5.76157379e-01 -5.76157379e-01
 -5.76157379e-01  1.02586031e+00  1.02586031e+00  1.02586031e+00
  7.53041585e+00  7.53041585e+00  7.53041585e+00  9.75268942e+00
  3.40178438e+01  3.40178438e+01  3.40178438e+01  1.06025319e+02
  1.29511455e+02  1.29511455e+02  1.29511455e+02  4.83708778e+02
  4.83708778e+02  4.83708778e+02  5.92921467e+02  1.33543356e+03
  1.33543356e+03  1.33543356e+03  2.66315854e+03  3.02955312e+03
  3.02955312e+03  3.02955312e+03  6.64989716e+03  6.64989716e+03
  6.64989716e+03  9.06831071e+03  2.54234469e+04  7.61652491e+04]
E1 = -728.3325729989945  E_coul = 201.62944805239775
cycle= 1 E= -526.703124946597  delta_E= -1.48e-12  |g|= 5.96e-07  |ddm|= 9.23e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3325729989945  E_coul = 201.62944805239775
  HOMO = -0.576157537101112  LUMO = 1.02586019321542
  mo_energy =
[-1.18576108e+02 -1.23057326e+01 -9.55871234e+00 -9.55871234e+00
 -9.55871234e+00 -1.25038796e+00 -5.76157537e-01 -5.76157537e-01
 -5.76157537e-01  1.02586019e+00  1.02586019e+00  1.02586019e+00
  7.53041543e+00  7.53041543e+00  7.53041543e+00  9.75268890e+00
  3.40178431e+01  3.40178431e+01  3.40178431e+01  1.06025318e+02
  1.29511454e+02  1.29511454e+02  1.29511454e+02  4.83708777e+02
  4.83708777e+02  4.83708777e+02  5.92921465e+02  1.33543356e+03
  1.33543356e+03  1.33543356e+03  2.66315854e+03  3.02955312e+03
  3.02955312e+03  3.02955312e+03  6.64989716e+03  6.64989716e+03
  6.64989716e+03  9.06831071e+03  2.54234469e+04  7.61652491e+04]
E1 = -728.3325752546641  E_coul = 201.62945030806878
Extra cycle  E= -526.703124946595  delta_E= 1.36e-12  |g|= 1.5e-07  |ddm|= 2.17e-07
    CPU time for scf_cycle     16.24 sec, wall time      0.89 sec
exp = [2.61826584e+04 7.61751642e+03 3.61735360e+03 1.59771279e+03
 3.82742327e+02 1.10060807e+02 3.61661203e+01 8.06509868e+00
 3.11236058e+00 3.99379653e-01 1.36278407e+03 6.64737165e+02
 3.00921804e+02 3.14007625e+02 6.16632748e+01 7.43332933e+00
 2.01466893e+01 7.80788827e-01 2.92700278e+00 2.23102313e-01]
grad_E = [-1.52998863e-06  3.44617342e-06 -1.50083501e-06  7.43395006e-05
 -1.27360094e-04 -6.12267614e-04 -2.62787059e-04  1.69886957e-03
 -3.28307206e-03  7.00206561e-03 -5.38973300e-07  4.55124251e-06
  2.08834608e-05  1.80128455e-05  2.63293752e-04 -2.94487552e-04
 -1.47598406e-03  9.71510021e-03  7.42925917e-03 -4.48947753e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:58:17 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6591211        1
[INPUT] 0    0    [1    /1   ]  7617.51491936        1
[INPUT] 0    0    [1    /1   ]  3617.35435556        1
[INPUT] 0    0    [1    /1   ]  1597.68199853        1
[INPUT] 0    0    [1    /1   ]  382.709207861        1
[INPUT] 0    0    [1    /1   ]  110.635292992        1
[INPUT] 0    0    [1    /1   ]  36.4559211818        1
[INPUT] 0    0    [1    /1   ]  7.9602816772         1
[INPUT] 0    0    [1    /1   ]  3.09865308224        1
[INPUT] 0    0    [1    /1   ]  0.39876599504        1
[INPUT] 1    0    [1    /1   ]  1362.78430057        1
[INPUT] 1    0    [1    /1   ]  664.734835449        1
[INPUT] 1    0    [1    /1   ]  300.910812044        1
[INPUT] 1    0    [1    /1   ]  313.998148423        1
[INPUT] 1    0    [1    /1   ]  61.6738547356        1
[INPUT] 1    0    [1    /1   ]  7.46440767871        1
[INPUT] 1    0    [1    /1   ]  20.1245617194        1
[INPUT] 1    0    [1    /1   ]  0.784301822937       1
[INPUT] 1    0    [1    /1   ]  2.93982257923        1
[INPUT] 1    0    [1    /1   ]  0.225042434479       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.659121115143, 1.0]], [0, [7617.5149193591915, 1.0]], [0, [3617.3543555608153, 1.0]], [0, [1597.681998525072, 1.0]], [0, [382.7092078611702, 1.0]], [0, [110.63529299195307, 1.0]], [0, [36.455921181779615, 1.0]], [0, [7.960281677204238, 1.0]], [0, [3.098653082241593, 1.0]], [0, [0.3987659950396219, 1.0]], [1, [1362.78430057108, 1.0]], [1, [664.73483544856, 1.0]], [1, [300.9108120439073, 1.0]], [1, [313.99814842251044, 1.0]], [1, [61.67385473563387, 1.0]], [1, [7.464407678708921, 1.0]], [1, [20.124561719424946, 1.0]], [1, [0.7843018229373747, 1.0]], [1, [2.939822579226835, 1.0]], [1, [0.22504243447855685, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65912112]
bas 1, expnt(s) = [7617.51491936]
bas 2, expnt(s) = [3617.35435556]
bas 3, expnt(s) = [1597.68199853]
bas 4, expnt(s) = [382.70920786]
bas 5, expnt(s) = [110.63529299]
bas 6, expnt(s) = [36.45592118]
bas 7, expnt(s) = [7.96028168]
bas 8, expnt(s) = [3.09865308]
bas 9, expnt(s) = [0.398766]
bas 10, expnt(s) = [1362.78430057]
bas 11, expnt(s) = [664.73483545]
bas 12, expnt(s) = [300.91081204]
bas 13, expnt(s) = [313.99814842]
bas 14, expnt(s) = [61.67385474]
bas 15, expnt(s) = [7.46440768]
bas 16, expnt(s) = [20.12456172]
bas 17, expnt(s) = [0.78430182]
bas 18, expnt(s) = [2.93982258]
bas 19, expnt(s) = [0.22504243]
CPU time:      1038.38
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826591e+04 5.20026335e+03 7.61751492e+03 2.06003695e+03
 3.61735436e+03 1.17844228e+03 1.59768200e+03 6.38458658e+02
 3.82709208e+02 2.18608331e+02 1.10635293e+02 8.61857156e+01
 3.64559212e+01 3.74835816e+01 7.96028168e+00 1.19732307e+01
 3.09865308e+00 5.90058052e+00 3.98765995e-01 1.26780836e+00
 1.36278430e+03 2.41556259e+04 6.64734835e+02 9.84679600e+03
 3.00910812e+02 3.65621422e+03 3.13998148e+02 3.85605528e+03
 6.16738547e+01 5.04209193e+02 7.46440768e+00 3.59938731e+01
 2.01245617e+01 1.24349038e+02 7.84301823e-01 2.15322009e+00
 2.93982258e+00 1.12301561e+01 2.25042434e-01 4.52183711e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982599218919248
cond(S) = 102551.73816150785
E1 = -729.382543149141  E_coul = 203.1249679168014
init E= -526.25757523234
    CPU time for initialize scf      7.39 sec, wall time      0.34 sec
  HOMO = -0.556788769291808  LUMO = 1.04882491591899
  mo_energy =
[-1.18332186e+02 -1.22077726e+01 -9.45129456e+00 -9.45129456e+00
 -9.45129456e+00 -1.22569050e+00 -5.56788769e-01 -5.56788769e-01
 -5.56788769e-01  1.04882492e+00  1.04882492e+00  1.04882492e+00
  7.64530522e+00  7.64530522e+00  7.64530522e+00  9.68458284e+00
  3.42521078e+01  3.42521078e+01  3.42521078e+01  1.06505443e+02
  1.29799399e+02  1.29799399e+02  1.29799399e+02  4.84040016e+02
  4.84040016e+02  4.84040016e+02  5.95229064e+02  1.33578944e+03
  1.33578944e+03  1.33578944e+03  2.66620376e+03  3.02993967e+03
  3.02993967e+03  3.02993967e+03  6.65036997e+03  6.65036997e+03
  6.65036997e+03  9.07136989e+03  2.54264605e+04  7.61681834e+04]
E1 = -727.9740798218535  E_coul = 201.27126471648108
cycle= 1 E= -526.702815105372  delta_E= -0.445  |g|= 0.184  |ddm|= 0.418
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.542528
diis-c [-0.294337  1.      ]
  HOMO = -0.581367384374984  LUMO = 1.03233432997737
  mo_energy =
[-1.18626361e+02 -1.23317325e+01 -9.58560381e+00 -9.58560381e+00
 -9.58560381e+00 -1.25715609e+00 -5.81367384e-01 -5.81367384e-01
 -5.81367384e-01  1.03233433e+00  1.03233433e+00  1.03233433e+00
  7.56724867e+00  7.56724867e+00  7.56724867e+00  9.59486969e+00
  3.41119698e+01  3.41119698e+01  3.41119698e+01  1.06297508e+02
  1.29585477e+02  1.29585477e+02  1.29585477e+02  4.83747269e+02
  4.83747269e+02  4.83747269e+02  5.94897879e+02  1.33544044e+03
  1.33544044e+03  1.33544044e+03  2.66572068e+03  3.02952468e+03
  3.02952468e+03  3.02952468e+03  6.64984180e+03  6.64984180e+03
  6.64984180e+03  9.07076651e+03  2.54257631e+04  7.61673958e+04]
E1 = -728.4396287245578  E_coul = 201.73621602353984
cycle= 2 E= -526.703412701018  delta_E= -0.000598  |g|= 0.0336  |ddm|= 0.0392
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0673347
diis-c [-0.00270517  0.07337806  0.92662194]
  HOMO = -0.574611835504749  LUMO = 1.03753679406271
  mo_energy =
[-1.18567493e+02 -1.23007706e+01 -9.55333451e+00 -9.55333451e+00
 -9.55333451e+00 -1.24858002e+00 -5.74611836e-01 -5.74611836e-01
 -5.74611836e-01  1.03753679e+00  1.03753679e+00  1.03753679e+00
  7.58621563e+00  7.58621563e+00  7.58621563e+00  9.61916319e+00
  3.41449013e+01  3.41449013e+01  3.41449013e+01  1.06345501e+02
  1.29633106e+02  1.29633106e+02  1.29633106e+02  4.83805375e+02
  4.83805375e+02  4.83805375e+02  5.94958289e+02  1.33550237e+03
  1.33550237e+03  1.33550237e+03  2.66578564e+03  3.02958869e+03
  3.02958869e+03  3.02958869e+03  6.64990736e+03  6.64990736e+03
  6.64990736e+03  9.07083278e+03  2.54258298e+04  7.61674628e+04]
E1 = -728.3342247257809  E_coul = 201.63077700459516
cycle= 3 E= -526.703447721186  delta_E= -3.5e-05  |g|= 0.00484  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0105616
diis-c [-4.65373608e-07 -1.13343445e-03  1.30909787e-01  8.70223647e-01]
  HOMO = -0.575537011108763  LUMO = 1.03683552353757
  mo_energy =
[-1.18575087e+02 -1.23048274e+01 -9.55766829e+00 -9.55766829e+00
 -9.55766829e+00 -1.24970058e+00 -5.75537011e-01 -5.75537011e-01
 -5.75537011e-01  1.03683552e+00  1.03683552e+00  1.03683552e+00
  7.58364487e+00  7.58364487e+00  7.58364487e+00  9.61606809e+00
  3.41405105e+01  3.41405105e+01  3.41405105e+01  1.06339314e+02
  1.29626909e+02  1.29626909e+02  1.29626909e+02  4.83797879e+02
  4.83797879e+02  4.83797879e+02  5.94950465e+02  1.33549435e+03
  1.33549435e+03  1.33549435e+03  2.66577705e+03  3.02958032e+03
  3.02958032e+03  3.02958032e+03  6.64989864e+03  6.64989864e+03
  6.64989864e+03  9.07082386e+03  2.54258207e+04  7.61674536e+04]
E1 = -728.3485070451376  E_coul = 201.64505847350694
cycle= 4 E= -526.703448571631  delta_E= -8.5e-07  |g|= 6.22e-05  |ddm|= 0.00132
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000130085
diis-c [-1.30913449e-09  6.64769211e-05 -9.25861421e-03 -7.27899323e-02
  1.08198207e+00]
  HOMO = -0.575525229965405  LUMO = 1.03684441286641
  mo_energy =
[-1.18575094e+02 -1.23047997e+01 -9.55765277e+00 -9.55765277e+00
 -9.55765277e+00 -1.24968158e+00 -5.75525230e-01 -5.75525230e-01
 -5.75525230e-01  1.03684441e+00  1.03684441e+00  1.03684441e+00
  7.58366453e+00  7.58366453e+00  7.58366453e+00  9.61610303e+00
  3.41405249e+01  3.41405249e+01  3.41405249e+01  1.06339323e+02
  1.29626914e+02  1.29626914e+02  1.29626914e+02  4.83797873e+02
  4.83797873e+02  4.83797873e+02  5.94950452e+02  1.33549433e+03
  1.33549433e+03  1.33549433e+03  2.66577702e+03  3.02958030e+03
  3.02958030e+03  3.02958030e+03  6.64989860e+03  6.64989860e+03
  6.64989860e+03  9.07082382e+03  2.54258207e+04  7.61674536e+04]
E1 = -728.3485114559443  E_coul = 201.64506288419128
cycle= 5 E= -526.703448571753  delta_E= -1.22e-10  |g|= 7.84e-06  |ddm|= 2.52e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3485114559443  E_coul = 201.64506288419128
  HOMO = -0.575528718521118  LUMO = 1.03684181335672
  mo_energy =
[-1.18575112e+02 -1.23048120e+01 -9.55766567e+00 -9.55766567e+00
 -9.55766567e+00 -1.24968586e+00 -5.75528719e-01 -5.75528719e-01
 -5.75528719e-01  1.03684181e+00  1.03684181e+00  1.03684181e+00
  7.58365590e+00  7.58365590e+00  7.58365590e+00  9.61609308e+00
  3.41405122e+01  3.41405122e+01  3.41405122e+01  1.06339307e+02
  1.29626898e+02  1.29626898e+02  1.29626898e+02  4.83797856e+02
  4.83797856e+02  4.83797856e+02  5.94950434e+02  1.33549432e+03
  1.33549432e+03  1.33549432e+03  2.66577700e+03  3.02958028e+03
  3.02958028e+03  3.02958028e+03  6.64989858e+03  6.64989858e+03
  6.64989858e+03  9.07082380e+03  2.54258207e+04  7.61674535e+04]
E1 = -728.3485501401233  E_coul = 201.64510156836755
Extra cycle  E= -526.703448571756  delta_E= -2.73e-12  |g|= 2.31e-06  |ddm|= 4.03e-06
    CPU time for scf_cycle      7.59 sec, wall time      0.52 sec
exp = [2.61826591e+04 7.61751492e+03 3.61735436e+03 1.59768200e+03
 3.82709208e+02 1.10635293e+02 3.64559212e+01 7.96028168e+00
 3.09865308e+00 3.98765995e-01 1.36278430e+03 6.64734835e+02
 3.00910812e+02 3.13998148e+02 6.16738547e+01 7.46440768e+00
 2.01245617e+01 7.84301823e-01 2.93982258e+00 2.25042434e-01]
E = -526.7034485717558
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:58:18 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6591211        1
[INPUT] 0    0    [1    /1   ]  7617.51491936        1
[INPUT] 0    0    [1    /1   ]  3617.35435556        1
[INPUT] 0    0    [1    /1   ]  1597.68199853        1
[INPUT] 0    0    [1    /1   ]  382.709207861        1
[INPUT] 0    0    [1    /1   ]  110.635292992        1
[INPUT] 0    0    [1    /1   ]  36.4559211818        1
[INPUT] 0    0    [1    /1   ]  7.9602816772         1
[INPUT] 0    0    [1    /1   ]  3.09865308224        1
[INPUT] 0    0    [1    /1   ]  0.39876599504        1
[INPUT] 1    0    [1    /1   ]  1362.78430057        1
[INPUT] 1    0    [1    /1   ]  664.734835449        1
[INPUT] 1    0    [1    /1   ]  300.910812044        1
[INPUT] 1    0    [1    /1   ]  313.998148423        1
[INPUT] 1    0    [1    /1   ]  61.6738547356        1
[INPUT] 1    0    [1    /1   ]  7.46440767871        1
[INPUT] 1    0    [1    /1   ]  20.1245617194        1
[INPUT] 1    0    [1    /1   ]  0.784301822937       1
[INPUT] 1    0    [1    /1   ]  2.93982257923        1
[INPUT] 1    0    [1    /1   ]  0.225042434479       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.659121115143, 1.0]], [0, [7617.5149193591915, 1.0]], [0, [3617.3543555608153, 1.0]], [0, [1597.681998525072, 1.0]], [0, [382.7092078611702, 1.0]], [0, [110.63529299195307, 1.0]], [0, [36.455921181779615, 1.0]], [0, [7.960281677204238, 1.0]], [0, [3.098653082241593, 1.0]], [0, [0.3987659950396219, 1.0]], [1, [1362.78430057108, 1.0]], [1, [664.73483544856, 1.0]], [1, [300.9108120439073, 1.0]], [1, [313.99814842251044, 1.0]], [1, [61.67385473563387, 1.0]], [1, [7.464407678708921, 1.0]], [1, [20.124561719424946, 1.0]], [1, [0.7843018229373747, 1.0]], [1, [2.939822579226835, 1.0]], [1, [0.22504243447855685, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65912112]
bas 1, expnt(s) = [7617.51491936]
bas 2, expnt(s) = [3617.35435556]
bas 3, expnt(s) = [1597.68199853]
bas 4, expnt(s) = [382.70920786]
bas 5, expnt(s) = [110.63529299]
bas 6, expnt(s) = [36.45592118]
bas 7, expnt(s) = [7.96028168]
bas 8, expnt(s) = [3.09865308]
bas 9, expnt(s) = [0.398766]
bas 10, expnt(s) = [1362.78430057]
bas 11, expnt(s) = [664.73483545]
bas 12, expnt(s) = [300.91081204]
bas 13, expnt(s) = [313.99814842]
bas 14, expnt(s) = [61.67385474]
bas 15, expnt(s) = [7.46440768]
bas 16, expnt(s) = [20.12456172]
bas 17, expnt(s) = [0.78430182]
bas 18, expnt(s) = [2.93982258]
bas 19, expnt(s) = [0.22504243]
CPU time:      1046.11
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826591e+04 5.20026335e+03 7.61751492e+03 2.06003695e+03
 3.61735436e+03 1.17844228e+03 1.59768200e+03 6.38458658e+02
 3.82709208e+02 2.18608331e+02 1.10635293e+02 8.61857156e+01
 3.64559212e+01 3.74835816e+01 7.96028168e+00 1.19732307e+01
 3.09865308e+00 5.90058052e+00 3.98765995e-01 1.26780836e+00
 1.36278430e+03 2.41556259e+04 6.64734835e+02 9.84679600e+03
 3.00910812e+02 3.65621422e+03 3.13998148e+02 3.85605528e+03
 6.16738547e+01 5.04209193e+02 7.46440768e+00 3.59938731e+01
 2.01245617e+01 1.24349038e+02 7.84301823e-01 2.15322009e+00
 2.93982258e+00 1.12301561e+01 2.25042434e-01 4.52183711e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982599218919248
cond(S) = 102551.73816150785
E1 = -729.382543149141  E_coul = 203.1249679168014
init E= -526.25757523234
    CPU time for initialize scf      7.66 sec, wall time      1.58 sec
  HOMO = -0.556788769291808  LUMO = 1.04882491591899
  mo_energy =
[-1.18332186e+02 -1.22077726e+01 -9.45129456e+00 -9.45129456e+00
 -9.45129456e+00 -1.22569050e+00 -5.56788769e-01 -5.56788769e-01
 -5.56788769e-01  1.04882492e+00  1.04882492e+00  1.04882492e+00
  7.64530522e+00  7.64530522e+00  7.64530522e+00  9.68458284e+00
  3.42521078e+01  3.42521078e+01  3.42521078e+01  1.06505443e+02
  1.29799399e+02  1.29799399e+02  1.29799399e+02  4.84040016e+02
  4.84040016e+02  4.84040016e+02  5.95229064e+02  1.33578944e+03
  1.33578944e+03  1.33578944e+03  2.66620376e+03  3.02993967e+03
  3.02993967e+03  3.02993967e+03  6.65036997e+03  6.65036997e+03
  6.65036997e+03  9.07136989e+03  2.54264605e+04  7.61681834e+04]
E1 = -727.9740798218535  E_coul = 201.27126471648108
cycle= 1 E= -526.702815105372  delta_E= -0.445  |g|= 0.184  |ddm|= 0.418
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.542528
diis-c [-0.294337  1.      ]
  HOMO = -0.581367384374984  LUMO = 1.03233432997737
  mo_energy =
[-1.18626361e+02 -1.23317325e+01 -9.58560381e+00 -9.58560381e+00
 -9.58560381e+00 -1.25715609e+00 -5.81367384e-01 -5.81367384e-01
 -5.81367384e-01  1.03233433e+00  1.03233433e+00  1.03233433e+00
  7.56724867e+00  7.56724867e+00  7.56724867e+00  9.59486969e+00
  3.41119698e+01  3.41119698e+01  3.41119698e+01  1.06297508e+02
  1.29585477e+02  1.29585477e+02  1.29585477e+02  4.83747269e+02
  4.83747269e+02  4.83747269e+02  5.94897879e+02  1.33544044e+03
  1.33544044e+03  1.33544044e+03  2.66572068e+03  3.02952468e+03
  3.02952468e+03  3.02952468e+03  6.64984180e+03  6.64984180e+03
  6.64984180e+03  9.07076651e+03  2.54257631e+04  7.61673958e+04]
E1 = -728.4396287245578  E_coul = 201.73621602353984
cycle= 2 E= -526.703412701018  delta_E= -0.000598  |g|= 0.0336  |ddm|= 0.0392
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0673347
diis-c [-0.00270517  0.07337806  0.92662194]
  HOMO = -0.574611835504749  LUMO = 1.03753679406271
  mo_energy =
[-1.18567493e+02 -1.23007706e+01 -9.55333451e+00 -9.55333451e+00
 -9.55333451e+00 -1.24858002e+00 -5.74611836e-01 -5.74611836e-01
 -5.74611836e-01  1.03753679e+00  1.03753679e+00  1.03753679e+00
  7.58621563e+00  7.58621563e+00  7.58621563e+00  9.61916319e+00
  3.41449013e+01  3.41449013e+01  3.41449013e+01  1.06345501e+02
  1.29633106e+02  1.29633106e+02  1.29633106e+02  4.83805375e+02
  4.83805375e+02  4.83805375e+02  5.94958289e+02  1.33550237e+03
  1.33550237e+03  1.33550237e+03  2.66578564e+03  3.02958869e+03
  3.02958869e+03  3.02958869e+03  6.64990736e+03  6.64990736e+03
  6.64990736e+03  9.07083278e+03  2.54258298e+04  7.61674628e+04]
E1 = -728.3342247257809  E_coul = 201.63077700459516
cycle= 3 E= -526.703447721186  delta_E= -3.5e-05  |g|= 0.00484  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0105616
diis-c [-4.65373608e-07 -1.13343445e-03  1.30909787e-01  8.70223647e-01]
  HOMO = -0.575537011108763  LUMO = 1.03683552353757
  mo_energy =
[-1.18575087e+02 -1.23048274e+01 -9.55766829e+00 -9.55766829e+00
 -9.55766829e+00 -1.24970058e+00 -5.75537011e-01 -5.75537011e-01
 -5.75537011e-01  1.03683552e+00  1.03683552e+00  1.03683552e+00
  7.58364487e+00  7.58364487e+00  7.58364487e+00  9.61606809e+00
  3.41405105e+01  3.41405105e+01  3.41405105e+01  1.06339314e+02
  1.29626909e+02  1.29626909e+02  1.29626909e+02  4.83797879e+02
  4.83797879e+02  4.83797879e+02  5.94950465e+02  1.33549435e+03
  1.33549435e+03  1.33549435e+03  2.66577705e+03  3.02958032e+03
  3.02958032e+03  3.02958032e+03  6.64989864e+03  6.64989864e+03
  6.64989864e+03  9.07082386e+03  2.54258207e+04  7.61674536e+04]
E1 = -728.3485070451376  E_coul = 201.64505847350694
cycle= 4 E= -526.703448571631  delta_E= -8.5e-07  |g|= 6.22e-05  |ddm|= 0.00132
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000130085
diis-c [-1.30913449e-09  6.64769211e-05 -9.25861421e-03 -7.27899323e-02
  1.08198207e+00]
  HOMO = -0.575525229965405  LUMO = 1.03684441286641
  mo_energy =
[-1.18575094e+02 -1.23047997e+01 -9.55765277e+00 -9.55765277e+00
 -9.55765277e+00 -1.24968158e+00 -5.75525230e-01 -5.75525230e-01
 -5.75525230e-01  1.03684441e+00  1.03684441e+00  1.03684441e+00
  7.58366453e+00  7.58366453e+00  7.58366453e+00  9.61610303e+00
  3.41405249e+01  3.41405249e+01  3.41405249e+01  1.06339323e+02
  1.29626914e+02  1.29626914e+02  1.29626914e+02  4.83797873e+02
  4.83797873e+02  4.83797873e+02  5.94950452e+02  1.33549433e+03
  1.33549433e+03  1.33549433e+03  2.66577702e+03  3.02958030e+03
  3.02958030e+03  3.02958030e+03  6.64989860e+03  6.64989860e+03
  6.64989860e+03  9.07082382e+03  2.54258207e+04  7.61674536e+04]
E1 = -728.3485114559443  E_coul = 201.64506288419128
cycle= 5 E= -526.703448571753  delta_E= -1.22e-10  |g|= 7.84e-06  |ddm|= 2.52e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3485114559443  E_coul = 201.64506288419128
  HOMO = -0.575528718521118  LUMO = 1.03684181335672
  mo_energy =
[-1.18575112e+02 -1.23048120e+01 -9.55766567e+00 -9.55766567e+00
 -9.55766567e+00 -1.24968586e+00 -5.75528719e-01 -5.75528719e-01
 -5.75528719e-01  1.03684181e+00  1.03684181e+00  1.03684181e+00
  7.58365590e+00  7.58365590e+00  7.58365590e+00  9.61609308e+00
  3.41405122e+01  3.41405122e+01  3.41405122e+01  1.06339307e+02
  1.29626898e+02  1.29626898e+02  1.29626898e+02  4.83797856e+02
  4.83797856e+02  4.83797856e+02  5.94950434e+02  1.33549432e+03
  1.33549432e+03  1.33549432e+03  2.66577700e+03  3.02958028e+03
  3.02958028e+03  3.02958028e+03  6.64989858e+03  6.64989858e+03
  6.64989858e+03  9.07082380e+03  2.54258207e+04  7.61674535e+04]
E1 = -728.3485501401233  E_coul = 201.64510156836755
Extra cycle  E= -526.703448571756  delta_E= -2.73e-12  |g|= 2.31e-06  |ddm|= 4.03e-06
    CPU time for scf_cycle      7.86 sec, wall time      1.76 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102551.73816150785
E1 = -728.3485501401233  E_coul = 201.64510156836755
init E= -526.703448571756
    CPU time for initialize scf     16.04 sec, wall time      0.75 sec
  HOMO = -0.575528011182954  LUMO = 1.036842346781
  mo_energy =
[-1.18575107e+02 -1.23048092e+01 -9.55766273e+00 -9.55766273e+00
 -9.55766273e+00 -1.24968498e+00 -5.75528011e-01 -5.75528011e-01
 -5.75528011e-01  1.03684235e+00  1.03684235e+00  1.03684235e+00
  7.58365774e+00  7.58365774e+00  7.58365774e+00  9.61609534e+00
  3.41405151e+01  3.41405151e+01  3.41405151e+01  1.06339311e+02
  1.29626902e+02  1.29626902e+02  1.29626902e+02  4.83797860e+02
  4.83797860e+02  4.83797860e+02  5.94950439e+02  1.33549432e+03
  1.33549432e+03  1.33549432e+03  2.66577700e+03  3.02958028e+03
  3.02958028e+03  3.02958028e+03  6.64989858e+03  6.64989858e+03
  6.64989858e+03  9.07082380e+03  2.54258207e+04  7.61674535e+04]
E1 = -728.3485409414795  E_coul = 201.64509236972253
cycle= 1 E= -526.703448571757  delta_E= -1.25e-12  |g|= 5.95e-07  |ddm|= 9.23e-07
    CPU time for cycle= 1      0.04 sec, wall time      0.02 sec
E1 = -728.3485409414795  E_coul = 201.64509236972253
  HOMO = -0.575528167669462  LUMO = 1.03684222806286
  mo_energy =
[-1.18575108e+02 -1.23048099e+01 -9.55766343e+00 -9.55766343e+00
 -9.55766343e+00 -1.24968517e+00 -5.75528168e-01 -5.75528168e-01
 -5.75528168e-01  1.03684223e+00  1.03684223e+00  1.03684223e+00
  7.58365732e+00  7.58365732e+00  7.58365732e+00  9.61609482e+00
  3.41405144e+01  3.41405144e+01  3.41405144e+01  1.06339310e+02
  1.29626901e+02  1.29626901e+02  1.29626901e+02  4.83797859e+02
  4.83797859e+02  4.83797859e+02  5.94950437e+02  1.33549432e+03
  1.33549432e+03  1.33549432e+03  2.66577700e+03  3.02958028e+03
  3.02958028e+03  3.02958028e+03  6.64989858e+03  6.64989858e+03
  6.64989858e+03  9.07082380e+03  2.54258207e+04  7.61674535e+04]
E1 = -728.348543183912  E_coul = 201.64509461215457
Extra cycle  E= -526.703448571757  delta_E= -4.55e-13  |g|= 1.49e-07  |ddm|= 2.16e-07
    CPU time for scf_cycle     16.17 sec, wall time      0.86 sec
exp = [2.61826591e+04 7.61751492e+03 3.61735436e+03 1.59768200e+03
 3.82709208e+02 1.10635293e+02 3.64559212e+01 7.96028168e+00
 3.09865308e+00 3.98765995e-01 1.36278430e+03 6.64734835e+02
 3.00910812e+02 3.13998148e+02 6.16738547e+01 7.46440768e+00
 2.01245617e+01 7.84301823e-01 2.93982258e+00 2.25042434e-01]
grad_E = [-1.53489120e-06  3.50216333e-06 -1.46440041e-06  7.64085729e-05
 -1.72556468e-04 -5.33041726e-04  9.88258470e-05  6.48147966e-04
 -1.31537468e-03  2.17042831e-03 -5.51344003e-07  4.36282311e-06
  1.97435137e-05  1.70362552e-05  3.99000237e-04  2.13995916e-03
 -2.47398074e-03  3.94403891e-03  5.29311321e-03 -1.64180550e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:58:25 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6592755        1
[INPUT] 0    0    [1    /1   ]  7617.51458824        1
[INPUT] 0    0    [1    /1   ]  3617.35452056        1
[INPUT] 0    0    [1    /1   ]  1597.67518891        1
[INPUT] 0    0    [1    /1   ]  382.703150473        1
[INPUT] 0    0    [1    /1   ]  110.752560687        1
[INPUT] 0    0    [1    /1   ]  36.5420450571        1
[INPUT] 0    0    [1    /1   ]  7.87261472283        1
[INPUT] 0    0    [1    /1   ]  3.08419303127        1
[INPUT] 0    0    [1    /1   ]  0.398395193137       1
[INPUT] 1    0    [1    /1   ]  1362.78435239        1
[INPUT] 1    0    [1    /1   ]  664.734324453        1
[INPUT] 1    0    [1    /1   ]  300.908402687        1
[INPUT] 1    0    [1    /1   ]  313.996071107        1
[INPUT] 1    0    [1    /1   ]  61.6752896094        1
[INPUT] 1    0    [1    /1   ]  7.46630442715        1
[INPUT] 1    0    [1    /1   ]  20.1252432917        1
[INPUT] 1    0    [1    /1   ]  0.784668026934       1
[INPUT] 1    0    [1    /1   ]  2.93043639313        1
[INPUT] 1    0    [1    /1   ]  0.22582580794        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.659275518905, 1.0]], [0, [7617.514588244702, 1.0]], [0, [3617.354520555128, 1.0]], [0, [1597.6751889058369, 1.0]], [0, [382.7031504725071, 1.0]], [0, [110.75256068725045, 1.0]], [0, [36.5420450571049, 1.0]], [0, [7.872614722832535, 1.0]], [0, [3.0841930312695904, 1.0]], [0, [0.3983951931373165, 1.0]], [1, [1362.7843523910317, 1.0]], [1, [664.73432445336, 1.0]], [1, [300.9084026874701, 1.0]], [1, [313.9960711067496, 1.0]], [1, [61.67528960936457, 1.0]], [1, [7.466304427145704, 1.0]], [1, [20.12524329172031, 1.0]], [1, [0.7846680269343999, 1.0]], [1, [2.93043639312667, 1.0]], [1, [0.22582580794023302, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65927552]
bas 1, expnt(s) = [7617.51458824]
bas 2, expnt(s) = [3617.35452056]
bas 3, expnt(s) = [1597.67518891]
bas 4, expnt(s) = [382.70315047]
bas 5, expnt(s) = [110.75256069]
bas 6, expnt(s) = [36.54204506]
bas 7, expnt(s) = [7.87261472]
bas 8, expnt(s) = [3.08419303]
bas 9, expnt(s) = [0.39839519]
bas 10, expnt(s) = [1362.78435239]
bas 11, expnt(s) = [664.73432445]
bas 12, expnt(s) = [300.90840269]
bas 13, expnt(s) = [313.99607111]
bas 14, expnt(s) = [61.67528961]
bas 15, expnt(s) = [7.46630443]
bas 16, expnt(s) = [20.12524329]
bas 17, expnt(s) = [0.78466803]
bas 18, expnt(s) = [2.93043639]
bas 19, expnt(s) = [0.22582581]
CPU time:      1075.24
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826593e+04 5.20026338e+03 7.61751459e+03 2.06003688e+03
 3.61735452e+03 1.17844232e+03 1.59767519e+03 6.38456617e+02
 3.82703150e+02 2.18605736e+02 1.10752561e+02 8.62542208e+01
 3.65420451e+01 3.75499757e+01 7.87261472e+00 1.18741976e+01
 3.08419303e+00 5.87991689e+00 3.98395193e-01 1.26692408e+00
 1.36278435e+03 2.41556270e+04 6.64734324e+02 9.84678654e+03
 3.00908403e+02 3.65617763e+03 3.13996071e+02 3.85602339e+03
 6.16752896e+01 5.04223856e+02 7.46630443e+00 3.60053063e+01
 2.01252433e+01 1.24354303e+02 7.84668027e-01 2.15447688e+00
 2.93043639e+00 1.11853549e+01 2.25825808e-01 4.54152133e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982580337498945
cond(S) = 102519.35712315462
E1 = -729.3806095572986  E_coul = 203.1237797225716
init E= -526.256829834727
    CPU time for initialize scf      7.60 sec, wall time      0.35 sec
  HOMO = -0.556796022042419  LUMO = 1.05209410701909
  mo_energy =
[-1.18332265e+02 -1.22079025e+01 -9.45140354e+00 -9.45140354e+00
 -9.45140354e+00 -1.22576665e+00 -5.56796022e-01 -5.56796022e-01
 -5.56796022e-01  1.05209411e+00  1.05209411e+00  1.05209411e+00
  7.63444520e+00  7.63444520e+00  7.63444520e+00  9.55626421e+00
  3.42271716e+01  3.42271716e+01  3.42271716e+01  1.06302834e+02
  1.29779995e+02  1.29779995e+02  1.29779995e+02  4.84027324e+02
  4.84027324e+02  4.84027324e+02  5.95439236e+02  1.33577490e+03
  1.33577490e+03  1.33577490e+03  2.66657462e+03  3.02991991e+03
  3.02991991e+03  3.02991991e+03  6.65034684e+03  6.65034684e+03
  6.65034684e+03  9.07173541e+03  2.54268057e+04  7.61685035e+04]
E1 = -727.9835296858892  E_coul = 201.28061329558756
cycle= 1 E= -526.702916390302  delta_E= -0.446  |g|= 0.184  |ddm|= 0.423
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.542103
diis-c [-0.29387583  1.        ]
  HOMO = -0.581004445902107  LUMO = 1.03585940960942
  mo_energy =
[-1.18625729e+02 -1.23311557e+01 -9.58496345e+00 -9.58496345e+00
 -9.58496345e+00 -1.25674845e+00 -5.81004446e-01 -5.81004446e-01
 -5.81004446e-01  1.03585941e+00  1.03585941e+00  1.03585941e+00
  7.55713335e+00  7.55713335e+00  7.55713335e+00  9.46774078e+00
  3.40877597e+01  3.40877597e+01  3.40877597e+01  1.06095683e+02
  1.29566790e+02  1.29566790e+02  1.29566790e+02  4.83735353e+02
  4.83735353e+02  4.83735353e+02  5.95108770e+02  1.33542668e+03
  1.33542668e+03  1.33542668e+03  2.66609234e+03  3.02950572e+03
  3.02950572e+03  3.02950572e+03  6.64981947e+03  6.64981947e+03
  6.64981947e+03  9.07113283e+03  2.54261090e+04  7.61677167e+04]
E1 = -728.4469757434231  E_coul = 201.74346571520925
cycle= 2 E= -526.703510028214  delta_E= -0.000594  |g|= 0.0335  |ddm|= 0.039
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0671107
diis-c [-0.00269166  0.07312079  0.92687921]
  HOMO = -0.574286131541174  LUMO = 1.04104009494756
  mo_energy =
[-1.18567057e+02 -1.23003333e+01 -9.55283271e+00 -9.55283271e+00
 -9.55283271e+00 -1.24822335e+00 -5.74286132e-01 -5.74286132e-01
 -5.74286132e-01  1.04104009e+00  1.04104009e+00  1.04104009e+00
  7.57598696e+00  7.57598696e+00  7.57598696e+00  9.49179584e+00
  3.41205536e+01  3.41205536e+01  3.41205536e+01  1.06143523e+02
  1.29614248e+02  1.29614248e+02  1.29614248e+02  4.83793267e+02
  4.83793267e+02  4.83793267e+02  5.95168990e+02  1.33548841e+03
  1.33548841e+03  1.33548841e+03  2.66615711e+03  3.02956952e+03
  3.02956952e+03  3.02956952e+03  6.64988482e+03  6.64988482e+03
  6.64988482e+03  9.07119890e+03  2.54261756e+04  7.61677835e+04]
E1 = -728.342058417211  E_coul = 201.6385136529176
cycle= 3 E= -526.703544764293  delta_E= -3.47e-05  |g|= 0.00484  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0105401
diis-c [-4.63229844e-07 -1.13307845e-03  1.31057963e-01  8.70075116e-01]
  HOMO = -0.575206381661635  LUMO = 1.04034179192105
  mo_energy =
[-1.18574635e+02 -1.23043793e+01 -9.55715524e+00 -9.55715524e+00
 -9.55715524e+00 -1.24933680e+00 -5.75206382e-01 -5.75206382e-01
 -5.75206382e-01  1.04034179e+00  1.04034179e+00  1.04034179e+00
  7.57342853e+00  7.57342853e+00  7.57342853e+00  9.48872791e+00
  3.41161744e+01  3.41161744e+01  3.41161744e+01  1.06137348e+02
  1.29608064e+02  1.29608064e+02  1.29608064e+02  4.83785786e+02
  4.83785786e+02  4.83785786e+02  5.95161182e+02  1.33548041e+03
  1.33548041e+03  1.33548041e+03  2.66614853e+03  3.02956117e+03
  3.02956117e+03  3.02956117e+03  6.64987612e+03  6.64987612e+03
  6.64987612e+03  9.07119000e+03  2.54261665e+04  7.61677743e+04]
E1 = -728.3563016959826  E_coul = 201.65275608522285
cycle= 4 E= -526.70354561076  delta_E= -8.46e-07  |g|= 6.25e-05  |ddm|= 0.00132
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000129281
diis-c [-1.31879693e-09  6.65162291e-05 -9.27660221e-03 -7.27595346e-02
  1.08196962e+00]
  HOMO = -0.57519428627939  LUMO = 1.04035093632353
  mo_energy =
[-1.18574642e+02 -1.23043509e+01 -9.55713901e+00 -9.55713901e+00
 -9.55713901e+00 -1.24931734e+00 -5.75194286e-01 -5.75194286e-01
 -5.75194286e-01  1.04035094e+00  1.04035094e+00  1.04035094e+00
  7.57344880e+00  7.57344880e+00  7.57344880e+00  9.48876363e+00
  3.41161895e+01  3.41161895e+01  3.41161895e+01  1.06137358e+02
  1.29608071e+02  1.29608071e+02  1.29608071e+02  4.83785781e+02
  4.83785781e+02  4.83785781e+02  5.95161169e+02  1.33548040e+03
  1.33548040e+03  1.33548040e+03  2.66614850e+03  3.02956115e+03
  3.02956115e+03  3.02956115e+03  6.64987608e+03  6.64987608e+03
  6.64987608e+03  9.07118995e+03  2.54261665e+04  7.61677743e+04]
E1 = -728.3563048090203  E_coul = 201.6527591981348
cycle= 5 E= -526.703545610886  delta_E= -1.26e-10  |g|= 7.88e-06  |ddm|= 2.6e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3563048090203  E_coul = 201.6527591981348
  HOMO = -0.575197782017056  LUMO = 1.04034832911582
  mo_energy =
[-1.18574659e+02 -1.23043632e+01 -9.55715196e+00 -9.55715196e+00
 -9.55715196e+00 -1.24932163e+00 -5.75197782e-01 -5.75197782e-01
 -5.75197782e-01  1.04034833e+00  1.04034833e+00  1.04034833e+00
  7.57344015e+00  7.57344015e+00  7.57344015e+00  9.48875370e+00
  3.41161767e+01  3.41161767e+01  3.41161767e+01  1.06137342e+02
  1.29608055e+02  1.29608055e+02  1.29608055e+02  4.83785763e+02
  4.83785763e+02  4.83785763e+02  5.95161151e+02  1.33548038e+03
  1.33548038e+03  1.33548038e+03  2.66614848e+03  3.02956113e+03
  3.02956113e+03  3.02956113e+03  6.64987607e+03  6.64987607e+03
  6.64987607e+03  9.07118994e+03  2.54261664e+04  7.61677742e+04]
E1 = -728.3563436522949  E_coul = 201.65279804140525
Extra cycle  E= -526.70354561089  delta_E= -3.98e-12  |g|= 2.33e-06  |ddm|= 4.04e-06
    CPU time for scf_cycle      7.80 sec, wall time      0.53 sec
exp = [2.61826593e+04 7.61751459e+03 3.61735452e+03 1.59767519e+03
 3.82703150e+02 1.10752561e+02 3.65420451e+01 7.87261472e+00
 3.08419303e+00 3.98395193e-01 1.36278435e+03 6.64734324e+02
 3.00908403e+02 3.13996071e+02 6.16752896e+01 7.46630443e+00
 2.01252433e+01 7.84668027e-01 2.93043639e+00 2.25825808e-01]
E = -526.7035456108896
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:58:25 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6592755        1
[INPUT] 0    0    [1    /1   ]  7617.51458824        1
[INPUT] 0    0    [1    /1   ]  3617.35452056        1
[INPUT] 0    0    [1    /1   ]  1597.67518891        1
[INPUT] 0    0    [1    /1   ]  382.703150473        1
[INPUT] 0    0    [1    /1   ]  110.752560687        1
[INPUT] 0    0    [1    /1   ]  36.5420450571        1
[INPUT] 0    0    [1    /1   ]  7.87261472283        1
[INPUT] 0    0    [1    /1   ]  3.08419303127        1
[INPUT] 0    0    [1    /1   ]  0.398395193137       1
[INPUT] 1    0    [1    /1   ]  1362.78435239        1
[INPUT] 1    0    [1    /1   ]  664.734324453        1
[INPUT] 1    0    [1    /1   ]  300.908402687        1
[INPUT] 1    0    [1    /1   ]  313.996071107        1
[INPUT] 1    0    [1    /1   ]  61.6752896094        1
[INPUT] 1    0    [1    /1   ]  7.46630442715        1
[INPUT] 1    0    [1    /1   ]  20.1252432917        1
[INPUT] 1    0    [1    /1   ]  0.784668026934       1
[INPUT] 1    0    [1    /1   ]  2.93043639313        1
[INPUT] 1    0    [1    /1   ]  0.22582580794        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.659275518905, 1.0]], [0, [7617.514588244702, 1.0]], [0, [3617.354520555128, 1.0]], [0, [1597.6751889058369, 1.0]], [0, [382.7031504725071, 1.0]], [0, [110.75256068725045, 1.0]], [0, [36.5420450571049, 1.0]], [0, [7.872614722832535, 1.0]], [0, [3.0841930312695904, 1.0]], [0, [0.3983951931373165, 1.0]], [1, [1362.7843523910317, 1.0]], [1, [664.73432445336, 1.0]], [1, [300.9084026874701, 1.0]], [1, [313.9960711067496, 1.0]], [1, [61.67528960936457, 1.0]], [1, [7.466304427145704, 1.0]], [1, [20.12524329172031, 1.0]], [1, [0.7846680269343999, 1.0]], [1, [2.93043639312667, 1.0]], [1, [0.22582580794023302, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65927552]
bas 1, expnt(s) = [7617.51458824]
bas 2, expnt(s) = [3617.35452056]
bas 3, expnt(s) = [1597.67518891]
bas 4, expnt(s) = [382.70315047]
bas 5, expnt(s) = [110.75256069]
bas 6, expnt(s) = [36.54204506]
bas 7, expnt(s) = [7.87261472]
bas 8, expnt(s) = [3.08419303]
bas 9, expnt(s) = [0.39839519]
bas 10, expnt(s) = [1362.78435239]
bas 11, expnt(s) = [664.73432445]
bas 12, expnt(s) = [300.90840269]
bas 13, expnt(s) = [313.99607111]
bas 14, expnt(s) = [61.67528961]
bas 15, expnt(s) = [7.46630443]
bas 16, expnt(s) = [20.12524329]
bas 17, expnt(s) = [0.78466803]
bas 18, expnt(s) = [2.93043639]
bas 19, expnt(s) = [0.22582581]
CPU time:      1083.19
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826593e+04 5.20026338e+03 7.61751459e+03 2.06003688e+03
 3.61735452e+03 1.17844232e+03 1.59767519e+03 6.38456617e+02
 3.82703150e+02 2.18605736e+02 1.10752561e+02 8.62542208e+01
 3.65420451e+01 3.75499757e+01 7.87261472e+00 1.18741976e+01
 3.08419303e+00 5.87991689e+00 3.98395193e-01 1.26692408e+00
 1.36278435e+03 2.41556270e+04 6.64734324e+02 9.84678654e+03
 3.00908403e+02 3.65617763e+03 3.13996071e+02 3.85602339e+03
 6.16752896e+01 5.04223856e+02 7.46630443e+00 3.60053063e+01
 2.01252433e+01 1.24354303e+02 7.84668027e-01 2.15447688e+00
 2.93043639e+00 1.11853549e+01 2.25825808e-01 4.54152133e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982580337498945
cond(S) = 102519.35712315462
E1 = -729.3806095572986  E_coul = 203.1237797225716
init E= -526.256829834727
    CPU time for initialize scf      7.35 sec, wall time      0.34 sec
  HOMO = -0.556796022042419  LUMO = 1.05209410701909
  mo_energy =
[-1.18332265e+02 -1.22079025e+01 -9.45140354e+00 -9.45140354e+00
 -9.45140354e+00 -1.22576665e+00 -5.56796022e-01 -5.56796022e-01
 -5.56796022e-01  1.05209411e+00  1.05209411e+00  1.05209411e+00
  7.63444520e+00  7.63444520e+00  7.63444520e+00  9.55626421e+00
  3.42271716e+01  3.42271716e+01  3.42271716e+01  1.06302834e+02
  1.29779995e+02  1.29779995e+02  1.29779995e+02  4.84027324e+02
  4.84027324e+02  4.84027324e+02  5.95439236e+02  1.33577490e+03
  1.33577490e+03  1.33577490e+03  2.66657462e+03  3.02991991e+03
  3.02991991e+03  3.02991991e+03  6.65034684e+03  6.65034684e+03
  6.65034684e+03  9.07173541e+03  2.54268057e+04  7.61685035e+04]
E1 = -727.9835296858892  E_coul = 201.28061329558756
cycle= 1 E= -526.702916390302  delta_E= -0.446  |g|= 0.184  |ddm|= 0.423
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.542103
diis-c [-0.29387583  1.        ]
  HOMO = -0.581004445902107  LUMO = 1.03585940960942
  mo_energy =
[-1.18625729e+02 -1.23311557e+01 -9.58496345e+00 -9.58496345e+00
 -9.58496345e+00 -1.25674845e+00 -5.81004446e-01 -5.81004446e-01
 -5.81004446e-01  1.03585941e+00  1.03585941e+00  1.03585941e+00
  7.55713335e+00  7.55713335e+00  7.55713335e+00  9.46774078e+00
  3.40877597e+01  3.40877597e+01  3.40877597e+01  1.06095683e+02
  1.29566790e+02  1.29566790e+02  1.29566790e+02  4.83735353e+02
  4.83735353e+02  4.83735353e+02  5.95108770e+02  1.33542668e+03
  1.33542668e+03  1.33542668e+03  2.66609234e+03  3.02950572e+03
  3.02950572e+03  3.02950572e+03  6.64981947e+03  6.64981947e+03
  6.64981947e+03  9.07113283e+03  2.54261090e+04  7.61677167e+04]
E1 = -728.4469757434231  E_coul = 201.74346571520925
cycle= 2 E= -526.703510028214  delta_E= -0.000594  |g|= 0.0335  |ddm|= 0.039
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0671107
diis-c [-0.00269166  0.07312079  0.92687921]
  HOMO = -0.574286131541174  LUMO = 1.04104009494756
  mo_energy =
[-1.18567057e+02 -1.23003333e+01 -9.55283271e+00 -9.55283271e+00
 -9.55283271e+00 -1.24822335e+00 -5.74286132e-01 -5.74286132e-01
 -5.74286132e-01  1.04104009e+00  1.04104009e+00  1.04104009e+00
  7.57598696e+00  7.57598696e+00  7.57598696e+00  9.49179584e+00
  3.41205536e+01  3.41205536e+01  3.41205536e+01  1.06143523e+02
  1.29614248e+02  1.29614248e+02  1.29614248e+02  4.83793267e+02
  4.83793267e+02  4.83793267e+02  5.95168990e+02  1.33548841e+03
  1.33548841e+03  1.33548841e+03  2.66615711e+03  3.02956952e+03
  3.02956952e+03  3.02956952e+03  6.64988482e+03  6.64988482e+03
  6.64988482e+03  9.07119890e+03  2.54261756e+04  7.61677835e+04]
E1 = -728.342058417211  E_coul = 201.6385136529176
cycle= 3 E= -526.703544764293  delta_E= -3.47e-05  |g|= 0.00484  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0105401
diis-c [-4.63229844e-07 -1.13307845e-03  1.31057963e-01  8.70075116e-01]
  HOMO = -0.575206381661635  LUMO = 1.04034179192105
  mo_energy =
[-1.18574635e+02 -1.23043793e+01 -9.55715524e+00 -9.55715524e+00
 -9.55715524e+00 -1.24933680e+00 -5.75206382e-01 -5.75206382e-01
 -5.75206382e-01  1.04034179e+00  1.04034179e+00  1.04034179e+00
  7.57342853e+00  7.57342853e+00  7.57342853e+00  9.48872791e+00
  3.41161744e+01  3.41161744e+01  3.41161744e+01  1.06137348e+02
  1.29608064e+02  1.29608064e+02  1.29608064e+02  4.83785786e+02
  4.83785786e+02  4.83785786e+02  5.95161182e+02  1.33548041e+03
  1.33548041e+03  1.33548041e+03  2.66614853e+03  3.02956117e+03
  3.02956117e+03  3.02956117e+03  6.64987612e+03  6.64987612e+03
  6.64987612e+03  9.07119000e+03  2.54261665e+04  7.61677743e+04]
E1 = -728.3563016959826  E_coul = 201.65275608522285
cycle= 4 E= -526.70354561076  delta_E= -8.46e-07  |g|= 6.25e-05  |ddm|= 0.00132
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000129281
diis-c [-1.31879693e-09  6.65162291e-05 -9.27660221e-03 -7.27595346e-02
  1.08196962e+00]
  HOMO = -0.57519428627939  LUMO = 1.04035093632353
  mo_energy =
[-1.18574642e+02 -1.23043509e+01 -9.55713901e+00 -9.55713901e+00
 -9.55713901e+00 -1.24931734e+00 -5.75194286e-01 -5.75194286e-01
 -5.75194286e-01  1.04035094e+00  1.04035094e+00  1.04035094e+00
  7.57344880e+00  7.57344880e+00  7.57344880e+00  9.48876363e+00
  3.41161895e+01  3.41161895e+01  3.41161895e+01  1.06137358e+02
  1.29608071e+02  1.29608071e+02  1.29608071e+02  4.83785781e+02
  4.83785781e+02  4.83785781e+02  5.95161169e+02  1.33548040e+03
  1.33548040e+03  1.33548040e+03  2.66614850e+03  3.02956115e+03
  3.02956115e+03  3.02956115e+03  6.64987608e+03  6.64987608e+03
  6.64987608e+03  9.07118995e+03  2.54261665e+04  7.61677743e+04]
E1 = -728.3563048090203  E_coul = 201.6527591981348
cycle= 5 E= -526.703545610886  delta_E= -1.26e-10  |g|= 7.88e-06  |ddm|= 2.6e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3563048090203  E_coul = 201.6527591981348
  HOMO = -0.575197782017056  LUMO = 1.04034832911582
  mo_energy =
[-1.18574659e+02 -1.23043632e+01 -9.55715196e+00 -9.55715196e+00
 -9.55715196e+00 -1.24932163e+00 -5.75197782e-01 -5.75197782e-01
 -5.75197782e-01  1.04034833e+00  1.04034833e+00  1.04034833e+00
  7.57344015e+00  7.57344015e+00  7.57344015e+00  9.48875370e+00
  3.41161767e+01  3.41161767e+01  3.41161767e+01  1.06137342e+02
  1.29608055e+02  1.29608055e+02  1.29608055e+02  4.83785763e+02
  4.83785763e+02  4.83785763e+02  5.95161151e+02  1.33548038e+03
  1.33548038e+03  1.33548038e+03  2.66614848e+03  3.02956113e+03
  3.02956113e+03  3.02956113e+03  6.64987607e+03  6.64987607e+03
  6.64987607e+03  9.07118994e+03  2.54261664e+04  7.61677742e+04]
E1 = -728.3563436522949  E_coul = 201.65279804140525
Extra cycle  E= -526.70354561089  delta_E= -3.98e-12  |g|= 2.33e-06  |ddm|= 4.04e-06
    CPU time for scf_cycle      7.55 sec, wall time      0.53 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102519.35712315462
E1 = -728.3563436522949  E_coul = 201.65279804140525
init E= -526.70354561089
    CPU time for initialize scf     16.20 sec, wall time      0.75 sec
  HOMO = -0.575197072772094  LUMO = 1.04034886461575
  mo_energy =
[-1.18574654e+02 -1.23043604e+01 -9.55714901e+00 -9.55714901e+00
 -9.55714901e+00 -1.24932075e+00 -5.75197073e-01 -5.75197073e-01
 -5.75197073e-01  1.04034886e+00  1.04034886e+00  1.04034886e+00
  7.57344200e+00  7.57344200e+00  7.57344200e+00  9.48875595e+00
  3.41161797e+01  3.41161797e+01  3.41161797e+01  1.06137346e+02
  1.29608059e+02  1.29608059e+02  1.29608059e+02  4.83785768e+02
  4.83785768e+02  4.83785768e+02  5.95161156e+02  1.33548038e+03
  1.33548038e+03  1.33548038e+03  2.66614849e+03  3.02956113e+03
  3.02956113e+03  3.02956113e+03  6.64987607e+03  6.64987607e+03
  6.64987607e+03  9.07118994e+03  2.54261664e+04  7.61677742e+04]
E1 = -728.3563344218798  E_coul = 201.65278881098962
cycle= 1 E= -526.70354561089  delta_E= -5.68e-13  |g|= 5.98e-07  |ddm|= 9.28e-07
    CPU time for cycle= 1      0.04 sec, wall time      0.02 sec
E1 = -728.3563344218798  E_coul = 201.65278881098962
  HOMO = -0.575197229515358  LUMO = 1.04034874556535
  mo_energy =
[-1.18574656e+02 -1.23043610e+01 -9.55714971e+00 -9.55714971e+00
 -9.55714971e+00 -1.24932094e+00 -5.75197230e-01 -5.75197230e-01
 -5.75197230e-01  1.04034875e+00  1.04034875e+00  1.04034875e+00
  7.57344157e+00  7.57344157e+00  7.57344157e+00  9.48875544e+00
  3.41161790e+01  3.41161790e+01  3.41161790e+01  1.06137345e+02
  1.29608058e+02  1.29608058e+02  1.29608058e+02  4.83785767e+02
  4.83785767e+02  4.83785767e+02  5.95161154e+02  1.33548038e+03
  1.33548038e+03  1.33548038e+03  2.66614849e+03  3.02956113e+03
  3.02956113e+03  3.02956113e+03  6.64987607e+03  6.64987607e+03
  6.64987607e+03  9.07118994e+03  2.54261664e+04  7.61677742e+04]
E1 = -728.3563366718196  E_coul = 201.6527910609298
Extra cycle  E= -526.70354561089  delta_E= 3.41e-13  |g|= 1.5e-07  |ddm|= 2.17e-07
    CPU time for scf_cycle     16.56 sec, wall time      1.09 sec
exp = [2.61826593e+04 7.61751459e+03 3.61735452e+03 1.59767519e+03
 3.82703150e+02 1.10752561e+02 3.65420451e+01 7.87261472e+00
 3.08419303e+00 3.98395193e-01 1.36278435e+03 6.64734324e+02
 3.00908403e+02 3.13996071e+02 6.16752896e+01 7.46630443e+00
 2.01252433e+01 7.84668027e-01 2.93043639e+00 2.25825808e-01]
grad_E = [-1.53525263e-06  3.50657092e-06 -1.46060764e-06  7.65549243e-05
 -1.72933685e-04 -5.83418060e-04  3.41089990e-04 -2.62746805e-04
  3.29373107e-04 -5.08079544e-04 -5.53932030e-07  4.32225507e-06
  1.94950596e-05  1.68238700e-05  4.33262476e-04  3.51335858e-03
 -2.81464262e-03  3.35502023e-07  3.12036938e-03  1.79796225e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:58:30 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6592526        1
[INPUT] 0    0    [1    /1   ]  7617.5146365         1
[INPUT] 0    0    [1    /1   ]  3617.35449545        1
[INPUT] 0    0    [1    /1   ]  1597.67616088        1
[INPUT] 0    0    [1    /1   ]  382.705385409        1
[INPUT] 0    0    [1    /1   ]  110.72619643         1
[INPUT] 0    0    [1    /1   ]  36.5485313525        1
[INPUT] 0    0    [1    /1   ]  7.83709213841        1
[INPUT] 0    0    [1    /1   ]  3.07777985816        1
[INPUT] 0    0    [1    /1   ]  0.398258259823       1
[INPUT] 1    0    [1    /1   ]  1362.78434479        1
[INPUT] 1    0    [1    /1   ]  664.73440244         1
[INPUT] 1    0    [1    /1   ]  300.908772763        1
[INPUT] 1    0    [1    /1   ]  313.996390136        1
[INPUT] 1    0    [1    /1   ]  61.67388             1
[INPUT] 1    0    [1    /1   ]  7.45840744311        1
[INPUT] 1    0    [1    /1   ]  20.1326037843        1
[INPUT] 1    0    [1    /1   ]  0.783972023634       1
[INPUT] 1    0    [1    /1   ]  2.9183856477         1
[INPUT] 1    0    [1    /1   ]  0.225938403616       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.65925260179, 1.0]], [0, [7617.5146365003475, 1.0]], [0, [3617.3544954525855, 1.0]], [0, [1597.6761608832328, 1.0]], [0, [382.7053854086177, 1.0]], [0, [110.72619643043552, 1.0]], [0, [36.548531352548686, 1.0]], [0, [7.83709213840941, 1.0]], [0, [3.0777798581645888, 1.0]], [0, [0.3982582598232212, 1.0]], [1, [1362.784344788882, 1.0]], [1, [664.7344024401867, 1.0]], [1, [300.9087727630285, 1.0]], [1, [313.9963901362952, 1.0]], [1, [61.67387999996212, 1.0]], [1, [7.458407443108055, 1.0]], [1, [20.132603784250072, 1.0]], [1, [0.7839720236335811, 1.0]], [1, [2.918385647700533, 1.0]], [1, [0.22593840361580492, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.6592526]
bas 1, expnt(s) = [7617.5146365]
bas 2, expnt(s) = [3617.35449545]
bas 3, expnt(s) = [1597.67616088]
bas 4, expnt(s) = [382.70538541]
bas 5, expnt(s) = [110.72619643]
bas 6, expnt(s) = [36.54853135]
bas 7, expnt(s) = [7.83709214]
bas 8, expnt(s) = [3.07777986]
bas 9, expnt(s) = [0.39825826]
bas 10, expnt(s) = [1362.78434479]
bas 11, expnt(s) = [664.73440244]
bas 12, expnt(s) = [300.90877276]
bas 13, expnt(s) = [313.99639014]
bas 14, expnt(s) = [61.67388]
bas 15, expnt(s) = [7.45840744]
bas 16, expnt(s) = [20.13260378]
bas 17, expnt(s) = [0.78397202]
bas 18, expnt(s) = [2.91838565]
bas 19, expnt(s) = [0.2259384]
CPU time:      1112.10
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826593e+04 5.20026337e+03 7.61751464e+03 2.06003689e+03
 3.61735450e+03 1.17844231e+03 1.59767616e+03 6.38456908e+02
 3.82705385e+02 2.18606693e+02 1.10726196e+02 8.62388210e+01
 3.65485314e+01 3.75549745e+01 7.83709214e+00 1.18339911e+01
 3.07777986e+00 5.87074462e+00 3.98258260e-01 1.26659748e+00
 1.36278434e+03 2.41556269e+04 6.64734402e+02 9.84678799e+03
 3.00908773e+02 3.65618325e+03 3.13996390e+02 3.85602829e+03
 6.16738800e+01 5.04209451e+02 7.45840744e+00 3.59577098e+01
 2.01326038e+01 1.24411156e+02 7.83972024e-01 2.15208836e+00
 2.91838565e+00 1.11278879e+01 2.25938404e-01 4.54435198e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982604609926387
cond(S) = 102497.82406906794
E1 = -729.3798472122184  E_coul = 203.12332467450815
init E= -526.25652253771
    CPU time for initialize scf      7.40 sec, wall time      0.34 sec
  HOMO = -0.55680432662789  LUMO = 1.05183113697495
  mo_energy =
[-1.18332279e+02 -1.22079467e+01 -9.45144947e+00 -9.45144947e+00
 -9.45144947e+00 -1.22579586e+00 -5.56804327e-01 -5.56804327e-01
 -5.56804327e-01  1.05183114e+00  1.05183114e+00  1.05183114e+00
  7.60933792e+00  7.60933792e+00  7.60933792e+00  9.50202043e+00
  3.41686414e+01  3.41686414e+01  3.41686414e+01  1.06132881e+02
  1.29728942e+02  1.29728942e+02  1.29728942e+02  4.83990622e+02
  4.83990622e+02  4.83990622e+02  5.95235271e+02  1.33574378e+03
  1.33574378e+03  1.33574378e+03  2.66636837e+03  3.02989221e+03
  3.02989221e+03  3.02989221e+03  6.65032244e+03  6.65032244e+03
  6.65032244e+03  9.07154294e+03  2.54266238e+04  7.61683343e+04]
E1 = -727.9859091956943  E_coul = 201.28294225454917
cycle= 1 E= -526.702966941145  delta_E= -0.446  |g|= 0.184  |ddm|= 0.424
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.54187
diis-c [-0.29362339  1.        ]
  HOMO = -0.580900414990463  LUMO = 1.03570393520298
  mo_energy =
[-1.18625605e+02 -1.23310202e+01 -9.58481404e+00 -9.58481404e+00
 -9.58481404e+00 -1.25662814e+00 -5.80900415e-01 -5.80900415e-01
 -5.80900415e-01  1.03570394e+00  1.03570394e+00  1.03570394e+00
  7.53237156e+00  7.53237156e+00  7.53237156e+00  9.41389880e+00
  3.40294212e+01  3.40294212e+01  3.40294212e+01  1.05925975e+02
  1.29515874e+02  1.29515874e+02  1.29515874e+02  4.83698813e+02
  4.83698813e+02  4.83698813e+02  5.94904960e+02  1.33539572e+03
  1.33539572e+03  1.33539572e+03  2.66588622e+03  3.02947816e+03
  3.02947816e+03  3.02947816e+03  6.64979520e+03  6.64979520e+03
  6.64979520e+03  9.07094049e+03  2.54259273e+04  7.61675477e+04]
E1 = -728.4489326139304  E_coul = 201.74537293318855
cycle= 2 E= -526.703559680742  delta_E= -0.000593  |g|= 0.0335  |ddm|= 0.039
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0670466
diis-c [-0.00268782  0.07306078  0.92693922]
  HOMO = -0.5741893601234  LUMO = 1.04087311381283
  mo_energy =
[-1.18566970e+02 -1.23002266e+01 -9.55271091e+00 -9.55271091e+00
 -9.55271091e+00 -1.24811384e+00 -5.74189360e-01 -5.74189360e-01
 -5.74189360e-01  1.04087311e+00  1.04087311e+00  1.04087311e+00
  7.55117159e+00  7.55117159e+00  7.55117159e+00  9.43787607e+00
  3.40621851e+01  3.40621851e+01  3.40621851e+01  1.05973779e+02
  1.29563303e+02  1.29563303e+02  1.29563303e+02  4.83756690e+02
  4.83756690e+02  4.83756690e+02  5.94965144e+02  1.33545742e+03
  1.33545742e+03  1.33545742e+03  2.66595095e+03  3.02954193e+03
  3.02954193e+03  3.02954193e+03  6.64986052e+03  6.64986052e+03
  6.64986052e+03  9.07100651e+03  2.54259938e+04  7.61676144e+04]
E1 = -728.3440895197064  E_coul = 201.64049515114777
cycle= 3 E= -526.703594368559  delta_E= -3.47e-05  |g|= 0.00484  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0105363
diis-c [-4.62673119e-07 -1.13365916e-03  1.31124217e-01  8.70009442e-01]
  HOMO = -0.575108736015543  LUMO = 1.04017633371849
  mo_energy =
[-1.18574549e+02 -1.23042721e+01 -9.55703292e+00 -9.55703292e+00
 -9.55703292e+00 -1.24922580e+00 -5.75108736e-01 -5.75108736e-01
 -5.75108736e-01  1.04017633e+00  1.04017633e+00  1.04017633e+00
  7.54861909e+00  7.54861909e+00  7.54861909e+00  9.43481640e+00
  3.40578068e+01  3.40578068e+01  3.40578068e+01  1.05967604e+02
  1.29557119e+02  1.29557119e+02  1.29557119e+02  4.83749210e+02
  4.83749210e+02  4.83749210e+02  5.94957336e+02  1.33544942e+03
  1.33544942e+03  1.33544942e+03  2.66594237e+03  3.02953358e+03
  3.02953358e+03  3.02953358e+03  6.64985181e+03  6.64985181e+03
  6.64985181e+03  9.07099762e+03  2.54259847e+04  7.61676052e+04]
E1 = -728.3583339589509  E_coul = 201.65473874380996
cycle= 4 E= -526.703595215141  delta_E= -8.47e-07  |g|= 6.26e-05  |ddm|= 0.00132
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000128977
diis-c [-1.32519814e-09  6.65246870e-05 -9.27934086e-03 -7.27092991e-02
  1.08192212e+00]
  HOMO = -0.575096516189885  LUMO = 1.04018556733274
  mo_energy =
[-1.18574555e+02 -1.23042435e+01 -9.55701642e+00 -9.55701642e+00
 -9.55701642e+00 -1.24920616e+00 -5.75096516e-01 -5.75096516e-01
 -5.75096516e-01  1.04018557e+00  1.04018557e+00  1.04018557e+00
  7.54863959e+00  7.54863959e+00  7.54863959e+00  9.43485242e+00
  3.40578222e+01  3.40578222e+01  3.40578222e+01  1.05967615e+02
  1.29557125e+02  1.29557125e+02  1.29557125e+02  4.83749205e+02
  4.83749205e+02  4.83749205e+02  5.94957323e+02  1.33544940e+03
  1.33544940e+03  1.33544940e+03  2.66594234e+03  3.02953355e+03
  3.02953355e+03  3.02953355e+03  6.64985178e+03  6.64985178e+03
  6.64985178e+03  9.07099757e+03  2.54259847e+04  7.61676052e+04]
E1 = -728.3583366034057  E_coul = 201.65474138813858
cycle= 5 E= -526.703595215267  delta_E= -1.26e-10  |g|= 7.9e-06  |ddm|= 2.64e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3583366034057  E_coul = 201.65474138813858
  HOMO = -0.575100016143088  LUMO = 1.0401829601851
  mo_energy =
[-1.18574572e+02 -1.23042558e+01 -9.55702940e+00 -9.55702940e+00
 -9.55702940e+00 -1.24921045e+00 -5.75100016e-01 -5.75100016e-01
 -5.75100016e-01  1.04018296e+00  1.04018296e+00  1.04018296e+00
  7.54863094e+00  7.54863094e+00  7.54863094e+00  9.43484249e+00
  3.40578094e+01  3.40578094e+01  3.40578094e+01  1.05967599e+02
  1.29557109e+02  1.29557109e+02  1.29557109e+02  4.83749187e+02
  4.83749187e+02  4.83749187e+02  5.94957306e+02  1.33544938e+03
  1.33544938e+03  1.33544938e+03  2.66594232e+03  3.02953354e+03
  3.02953354e+03  3.02953354e+03  6.64985176e+03  6.64985176e+03
  6.64985176e+03  9.07099755e+03  2.54259847e+04  7.61676052e+04]
E1 = -728.3583755402409  E_coul = 201.65478032497015
Extra cycle  E= -526.703595215271  delta_E= -3.64e-12  |g|= 2.33e-06  |ddm|= 4.05e-06
    CPU time for scf_cycle      7.60 sec, wall time      0.52 sec
exp = [2.61826593e+04 7.61751464e+03 3.61735450e+03 1.59767616e+03
 3.82705385e+02 1.10726196e+02 3.65485314e+01 7.83709214e+00
 3.07777986e+00 3.98258260e-01 1.36278434e+03 6.64734402e+02
 3.00908773e+02 3.13996390e+02 6.16738800e+01 7.45840744e+00
 2.01326038e+01 7.83972024e-01 2.91838565e+00 2.25938404e-01]
E = -526.7035952152708
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:58:31 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6592526        1
[INPUT] 0    0    [1    /1   ]  7617.5146365         1
[INPUT] 0    0    [1    /1   ]  3617.35449545        1
[INPUT] 0    0    [1    /1   ]  1597.67616088        1
[INPUT] 0    0    [1    /1   ]  382.705385409        1
[INPUT] 0    0    [1    /1   ]  110.72619643         1
[INPUT] 0    0    [1    /1   ]  36.5485313525        1
[INPUT] 0    0    [1    /1   ]  7.83709213841        1
[INPUT] 0    0    [1    /1   ]  3.07777985816        1
[INPUT] 0    0    [1    /1   ]  0.398258259823       1
[INPUT] 1    0    [1    /1   ]  1362.78434479        1
[INPUT] 1    0    [1    /1   ]  664.73440244         1
[INPUT] 1    0    [1    /1   ]  300.908772763        1
[INPUT] 1    0    [1    /1   ]  313.996390136        1
[INPUT] 1    0    [1    /1   ]  61.67388             1
[INPUT] 1    0    [1    /1   ]  7.45840744311        1
[INPUT] 1    0    [1    /1   ]  20.1326037843        1
[INPUT] 1    0    [1    /1   ]  0.783972023634       1
[INPUT] 1    0    [1    /1   ]  2.9183856477         1
[INPUT] 1    0    [1    /1   ]  0.225938403616       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.65925260179, 1.0]], [0, [7617.5146365003475, 1.0]], [0, [3617.3544954525855, 1.0]], [0, [1597.6761608832328, 1.0]], [0, [382.7053854086177, 1.0]], [0, [110.72619643043552, 1.0]], [0, [36.548531352548686, 1.0]], [0, [7.83709213840941, 1.0]], [0, [3.0777798581645888, 1.0]], [0, [0.3982582598232212, 1.0]], [1, [1362.784344788882, 1.0]], [1, [664.7344024401867, 1.0]], [1, [300.9087727630285, 1.0]], [1, [313.9963901362952, 1.0]], [1, [61.67387999996212, 1.0]], [1, [7.458407443108055, 1.0]], [1, [20.132603784250072, 1.0]], [1, [0.7839720236335811, 1.0]], [1, [2.918385647700533, 1.0]], [1, [0.22593840361580492, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.6592526]
bas 1, expnt(s) = [7617.5146365]
bas 2, expnt(s) = [3617.35449545]
bas 3, expnt(s) = [1597.67616088]
bas 4, expnt(s) = [382.70538541]
bas 5, expnt(s) = [110.72619643]
bas 6, expnt(s) = [36.54853135]
bas 7, expnt(s) = [7.83709214]
bas 8, expnt(s) = [3.07777986]
bas 9, expnt(s) = [0.39825826]
bas 10, expnt(s) = [1362.78434479]
bas 11, expnt(s) = [664.73440244]
bas 12, expnt(s) = [300.90877276]
bas 13, expnt(s) = [313.99639014]
bas 14, expnt(s) = [61.67388]
bas 15, expnt(s) = [7.45840744]
bas 16, expnt(s) = [20.13260378]
bas 17, expnt(s) = [0.78397202]
bas 18, expnt(s) = [2.91838565]
bas 19, expnt(s) = [0.2259384]
CPU time:      1119.85
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826593e+04 5.20026337e+03 7.61751464e+03 2.06003689e+03
 3.61735450e+03 1.17844231e+03 1.59767616e+03 6.38456908e+02
 3.82705385e+02 2.18606693e+02 1.10726196e+02 8.62388210e+01
 3.65485314e+01 3.75549745e+01 7.83709214e+00 1.18339911e+01
 3.07777986e+00 5.87074462e+00 3.98258260e-01 1.26659748e+00
 1.36278434e+03 2.41556269e+04 6.64734402e+02 9.84678799e+03
 3.00908773e+02 3.65618325e+03 3.13996390e+02 3.85602829e+03
 6.16738800e+01 5.04209451e+02 7.45840744e+00 3.59577098e+01
 2.01326038e+01 1.24411156e+02 7.83972024e-01 2.15208836e+00
 2.91838565e+00 1.11278879e+01 2.25938404e-01 4.54435198e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982604609926387
cond(S) = 102497.82406906794
E1 = -729.3798472122184  E_coul = 203.12332467450815
init E= -526.25652253771
    CPU time for initialize scf      7.58 sec, wall time      0.35 sec
  HOMO = -0.55680432662789  LUMO = 1.05183113697495
  mo_energy =
[-1.18332279e+02 -1.22079467e+01 -9.45144947e+00 -9.45144947e+00
 -9.45144947e+00 -1.22579586e+00 -5.56804327e-01 -5.56804327e-01
 -5.56804327e-01  1.05183114e+00  1.05183114e+00  1.05183114e+00
  7.60933792e+00  7.60933792e+00  7.60933792e+00  9.50202043e+00
  3.41686414e+01  3.41686414e+01  3.41686414e+01  1.06132881e+02
  1.29728942e+02  1.29728942e+02  1.29728942e+02  4.83990622e+02
  4.83990622e+02  4.83990622e+02  5.95235271e+02  1.33574378e+03
  1.33574378e+03  1.33574378e+03  2.66636837e+03  3.02989221e+03
  3.02989221e+03  3.02989221e+03  6.65032244e+03  6.65032244e+03
  6.65032244e+03  9.07154294e+03  2.54266238e+04  7.61683343e+04]
E1 = -727.9859091956943  E_coul = 201.28294225454917
cycle= 1 E= -526.702966941145  delta_E= -0.446  |g|= 0.184  |ddm|= 0.424
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.54187
diis-c [-0.29362339  1.        ]
  HOMO = -0.580900414990463  LUMO = 1.03570393520298
  mo_energy =
[-1.18625605e+02 -1.23310202e+01 -9.58481404e+00 -9.58481404e+00
 -9.58481404e+00 -1.25662814e+00 -5.80900415e-01 -5.80900415e-01
 -5.80900415e-01  1.03570394e+00  1.03570394e+00  1.03570394e+00
  7.53237156e+00  7.53237156e+00  7.53237156e+00  9.41389880e+00
  3.40294212e+01  3.40294212e+01  3.40294212e+01  1.05925975e+02
  1.29515874e+02  1.29515874e+02  1.29515874e+02  4.83698813e+02
  4.83698813e+02  4.83698813e+02  5.94904960e+02  1.33539572e+03
  1.33539572e+03  1.33539572e+03  2.66588622e+03  3.02947816e+03
  3.02947816e+03  3.02947816e+03  6.64979520e+03  6.64979520e+03
  6.64979520e+03  9.07094049e+03  2.54259273e+04  7.61675477e+04]
E1 = -728.4489326139304  E_coul = 201.74537293318855
cycle= 2 E= -526.703559680742  delta_E= -0.000593  |g|= 0.0335  |ddm|= 0.039
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0670466
diis-c [-0.00268782  0.07306078  0.92693922]
  HOMO = -0.5741893601234  LUMO = 1.04087311381283
  mo_energy =
[-1.18566970e+02 -1.23002266e+01 -9.55271091e+00 -9.55271091e+00
 -9.55271091e+00 -1.24811384e+00 -5.74189360e-01 -5.74189360e-01
 -5.74189360e-01  1.04087311e+00  1.04087311e+00  1.04087311e+00
  7.55117159e+00  7.55117159e+00  7.55117159e+00  9.43787607e+00
  3.40621851e+01  3.40621851e+01  3.40621851e+01  1.05973779e+02
  1.29563303e+02  1.29563303e+02  1.29563303e+02  4.83756690e+02
  4.83756690e+02  4.83756690e+02  5.94965144e+02  1.33545742e+03
  1.33545742e+03  1.33545742e+03  2.66595095e+03  3.02954193e+03
  3.02954193e+03  3.02954193e+03  6.64986052e+03  6.64986052e+03
  6.64986052e+03  9.07100651e+03  2.54259938e+04  7.61676144e+04]
E1 = -728.3440895197064  E_coul = 201.64049515114777
cycle= 3 E= -526.703594368559  delta_E= -3.47e-05  |g|= 0.00484  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0105363
diis-c [-4.62673119e-07 -1.13365916e-03  1.31124217e-01  8.70009442e-01]
  HOMO = -0.575108736015543  LUMO = 1.04017633371849
  mo_energy =
[-1.18574549e+02 -1.23042721e+01 -9.55703292e+00 -9.55703292e+00
 -9.55703292e+00 -1.24922580e+00 -5.75108736e-01 -5.75108736e-01
 -5.75108736e-01  1.04017633e+00  1.04017633e+00  1.04017633e+00
  7.54861909e+00  7.54861909e+00  7.54861909e+00  9.43481640e+00
  3.40578068e+01  3.40578068e+01  3.40578068e+01  1.05967604e+02
  1.29557119e+02  1.29557119e+02  1.29557119e+02  4.83749210e+02
  4.83749210e+02  4.83749210e+02  5.94957336e+02  1.33544942e+03
  1.33544942e+03  1.33544942e+03  2.66594237e+03  3.02953358e+03
  3.02953358e+03  3.02953358e+03  6.64985181e+03  6.64985181e+03
  6.64985181e+03  9.07099762e+03  2.54259847e+04  7.61676052e+04]
E1 = -728.3583339589509  E_coul = 201.65473874380996
cycle= 4 E= -526.703595215141  delta_E= -8.47e-07  |g|= 6.26e-05  |ddm|= 0.00132
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000128977
diis-c [-1.32519814e-09  6.65246870e-05 -9.27934086e-03 -7.27092991e-02
  1.08192212e+00]
  HOMO = -0.575096516189885  LUMO = 1.04018556733274
  mo_energy =
[-1.18574555e+02 -1.23042435e+01 -9.55701642e+00 -9.55701642e+00
 -9.55701642e+00 -1.24920616e+00 -5.75096516e-01 -5.75096516e-01
 -5.75096516e-01  1.04018557e+00  1.04018557e+00  1.04018557e+00
  7.54863959e+00  7.54863959e+00  7.54863959e+00  9.43485242e+00
  3.40578222e+01  3.40578222e+01  3.40578222e+01  1.05967615e+02
  1.29557125e+02  1.29557125e+02  1.29557125e+02  4.83749205e+02
  4.83749205e+02  4.83749205e+02  5.94957323e+02  1.33544940e+03
  1.33544940e+03  1.33544940e+03  2.66594234e+03  3.02953355e+03
  3.02953355e+03  3.02953355e+03  6.64985178e+03  6.64985178e+03
  6.64985178e+03  9.07099757e+03  2.54259847e+04  7.61676052e+04]
E1 = -728.3583366034057  E_coul = 201.65474138813858
cycle= 5 E= -526.703595215267  delta_E= -1.26e-10  |g|= 7.9e-06  |ddm|= 2.64e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3583366034057  E_coul = 201.65474138813858
  HOMO = -0.575100016143088  LUMO = 1.0401829601851
  mo_energy =
[-1.18574572e+02 -1.23042558e+01 -9.55702940e+00 -9.55702940e+00
 -9.55702940e+00 -1.24921045e+00 -5.75100016e-01 -5.75100016e-01
 -5.75100016e-01  1.04018296e+00  1.04018296e+00  1.04018296e+00
  7.54863094e+00  7.54863094e+00  7.54863094e+00  9.43484249e+00
  3.40578094e+01  3.40578094e+01  3.40578094e+01  1.05967599e+02
  1.29557109e+02  1.29557109e+02  1.29557109e+02  4.83749187e+02
  4.83749187e+02  4.83749187e+02  5.94957306e+02  1.33544938e+03
  1.33544938e+03  1.33544938e+03  2.66594232e+03  3.02953354e+03
  3.02953354e+03  3.02953354e+03  6.64985176e+03  6.64985176e+03
  6.64985176e+03  9.07099755e+03  2.54259847e+04  7.61676052e+04]
E1 = -728.3583755402409  E_coul = 201.65478032497015
Extra cycle  E= -526.703595215271  delta_E= -3.64e-12  |g|= 2.33e-06  |ddm|= 4.05e-06
    CPU time for scf_cycle      7.77 sec, wall time      0.54 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102497.82406906794
E1 = -728.3583755402409  E_coul = 201.65478032497015
init E= -526.703595215271
    CPU time for initialize scf     15.86 sec, wall time      0.76 sec
  HOMO = -0.57509930544125  LUMO = 1.04018349617741
  mo_energy =
[-1.18574568e+02 -1.23042530e+01 -9.55702644e+00 -9.55702644e+00
 -9.55702644e+00 -1.24920956e+00 -5.75099305e-01 -5.75099305e-01
 -5.75099305e-01  1.04018350e+00  1.04018350e+00  1.04018350e+00
  7.54863278e+00  7.54863278e+00  7.54863278e+00  9.43484475e+00
  3.40578124e+01  3.40578124e+01  3.40578124e+01  1.05967603e+02
  1.29557113e+02  1.29557113e+02  1.29557113e+02  4.83749192e+02
  4.83749192e+02  4.83749192e+02  5.94957310e+02  1.33544939e+03
  1.33544939e+03  1.33544939e+03  2.66594233e+03  3.02953354e+03
  3.02953354e+03  3.02953354e+03  6.64985176e+03  6.64985176e+03
  6.64985176e+03  9.07099756e+03  2.54259847e+04  7.61676052e+04]
E1 = -728.3583662875693  E_coul = 201.65477107229808
cycle= 1 E= -526.703595215271  delta_E= -4.55e-13  |g|= 6e-07  |ddm|= 9.31e-07
    CPU time for cycle= 1      0.05 sec, wall time      0.02 sec
E1 = -728.3583662875693  E_coul = 201.65477107229808
  HOMO = -0.575099462479429  LUMO = 1.0401833770445
  mo_energy =
[-1.18574569e+02 -1.23042537e+01 -9.55702715e+00 -9.55702715e+00
 -9.55702715e+00 -1.24920976e+00 -5.75099462e-01 -5.75099462e-01
 -5.75099462e-01  1.04018338e+00  1.04018338e+00  1.04018338e+00
  7.54863236e+00  7.54863236e+00  7.54863236e+00  9.43484423e+00
  3.40578117e+01  3.40578117e+01  3.40578117e+01  1.05967602e+02
  1.29557112e+02  1.29557112e+02  1.29557112e+02  4.83749191e+02
  4.83749191e+02  4.83749191e+02  5.94957309e+02  1.33544939e+03
  1.33544939e+03  1.33544939e+03  2.66594232e+03  3.02953354e+03
  3.02953354e+03  3.02953354e+03  6.64985176e+03  6.64985176e+03
  6.64985176e+03  9.07099756e+03  2.54259847e+04  7.61676052e+04]
E1 = -728.3583685435194  E_coul = 201.65477332824773
Extra cycle  E= -526.703595215272  delta_E= -4.55e-13  |g|= 1.51e-07  |ddm|= 2.18e-07
    CPU time for scf_cycle     16.00 sec, wall time      0.87 sec
exp = [2.61826593e+04 7.61751464e+03 3.61735450e+03 1.59767616e+03
 3.82705385e+02 1.10726196e+02 3.65485314e+01 7.83709214e+00
 3.07777986e+00 3.98258260e-01 1.36278434e+03 6.64734402e+02
 3.00908773e+02 3.13996390e+02 6.16738800e+01 7.45840744e+00
 2.01326038e+01 7.83972024e-01 2.91838565e+00 2.25938404e-01]
grad_E = [-1.53459245e-06  3.49913806e-06 -1.46500869e-06  7.62693123e-05
 -1.64831141e-04 -6.33534497e-04  4.43273799e-04 -6.41543270e-04
  9.93618679e-04 -1.49034248e-03 -5.52607291e-07  4.34313398e-06
  1.96191938e-05  1.69303222e-05  4.21629948e-04  3.98344702e-03
 -2.80866499e-03 -1.68723136e-03  1.87883971e-03  9.11180944e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:58:36 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6592209        1
[INPUT] 0    0    [1    /1   ]  7617.51470247        1
[INPUT] 0    0    [1    /1   ]  3617.35446017        1
[INPUT] 0    0    [1    /1   ]  1597.67747458        1
[INPUT] 0    0    [1    /1   ]  382.709271319        1
[INPUT] 0    0    [1    /1   ]  110.687177643        1
[INPUT] 0    0    [1    /1   ]  36.5556796102        1
[INPUT] 0    0    [1    /1   ]  7.79836882133        1
[INPUT] 0    0    [1    /1   ]  3.0711111663         1
[INPUT] 0    0    [1    /1   ]  0.398094264995       1
[INPUT] 1    0    [1    /1   ]  1362.7843344         1
[INPUT] 1    0    [1    /1   ]  664.734512514        1
[INPUT] 1    0    [1    /1   ]  300.909297703        1
[INPUT] 1    0    [1    /1   ]  313.996842625        1
[INPUT] 1    0    [1    /1   ]  61.670582452         1
[INPUT] 1    0    [1    /1   ]  7.436636295          1
[INPUT] 1    0    [1    /1   ]  20.1512802535        1
[INPUT] 1    0    [1    /1   ]  0.782116195299       1
[INPUT] 1    0    [1    /1   ]  2.89284996571        1
[INPUT] 1    0    [1    /1   ]  0.225853671218       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.65922093482, 1.0]], [0, [7617.514702471665, 1.0]], [0, [3617.3544601692456, 1.0]], [0, [1597.6774745794812, 1.0]], [0, [382.7092713192513, 1.0]], [0, [110.68717764276767, 1.0]], [0, [36.55567961018283, 1.0]], [0, [7.798368821330743, 1.0]], [0, [3.071111166297414, 1.0]], [0, [0.39809426499477424, 1.0]], [1, [1362.7843343994598, 1.0]], [1, [664.7345125137188, 1.0]], [1, [300.9092977027126, 1.0]], [1, [313.9968426247688, 1.0]], [1, [61.67058245196843, 1.0]], [1, [7.43663629500315, 1.0]], [1, [20.151280253456285, 1.0]], [1, [0.782116195299495, 1.0]], [1, [2.8928499657067683, 1.0]], [1, [0.22585367121804495, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65922093]
bas 1, expnt(s) = [7617.51470247]
bas 2, expnt(s) = [3617.35446017]
bas 3, expnt(s) = [1597.67747458]
bas 4, expnt(s) = [382.70927132]
bas 5, expnt(s) = [110.68717764]
bas 6, expnt(s) = [36.55567961]
bas 7, expnt(s) = [7.79836882]
bas 8, expnt(s) = [3.07111117]
bas 9, expnt(s) = [0.39809426]
bas 10, expnt(s) = [1362.7843344]
bas 11, expnt(s) = [664.73451251]
bas 12, expnt(s) = [300.9092977]
bas 13, expnt(s) = [313.99684262]
bas 14, expnt(s) = [61.67058245]
bas 15, expnt(s) = [7.4366363]
bas 16, expnt(s) = [20.15128025]
bas 17, expnt(s) = [0.7821162]
bas 18, expnt(s) = [2.89284997]
bas 19, expnt(s) = [0.22585367]
CPU time:      1148.64
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826592e+04 5.20026337e+03 7.61751470e+03 2.06003690e+03
 3.61735446e+03 1.17844230e+03 1.59767747e+03 6.38457302e+02
 3.82709271e+02 2.18608358e+02 1.10687178e+02 8.62160277e+01
 3.65556796e+01 3.75604832e+01 7.79836882e+00 1.17901099e+01
 3.07111117e+00 5.86120184e+00 3.98094265e-01 1.26620629e+00
 1.36278433e+03 2.41556266e+04 6.64734513e+02 9.84679003e+03
 3.00909298e+02 3.65619122e+03 3.13996843e+02 3.85603524e+03
 6.16705825e+01 5.04175753e+02 7.43663630e+00 3.58265567e+01
 2.01512803e+01 1.24555439e+02 7.82116195e-01 2.14572218e+00
 2.89284997e+00 1.10063110e+01 2.25853671e-01 4.54222178e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982670583216972
cond(S) = 102463.57861447756
E1 = -729.3788936832939  E_coul = 203.1226800317862
init E= -526.256213651508
    CPU time for initialize scf      7.08 sec, wall time      0.35 sec
  HOMO = -0.556826851411957  LUMO = 1.04969979816966
  mo_energy =
[-1.18332301e+02 -1.22079989e+01 -9.45151320e+00 -9.45151320e+00
 -9.45151320e+00 -1.22583716e+00 -5.56826851e-01 -5.56826851e-01
 -5.56826851e-01  1.04969980e+00  1.04969980e+00  1.04969980e+00
  7.55187311e+00  7.55187311e+00  7.55187311e+00  9.44380184e+00
  3.40324709e+01  3.40324709e+01  3.40324709e+01  1.05944713e+02
  1.29609771e+02  1.29609771e+02  1.29609771e+02  4.83905574e+02
  4.83905574e+02  4.83905574e+02  5.94989499e+02  1.33567121e+03
  1.33567121e+03  1.33567121e+03  2.66611192e+03  3.02982671e+03
  3.02982671e+03  3.02982671e+03  6.65026397e+03  6.65026397e+03
  6.65026397e+03  9.07130298e+03  2.54263971e+04  7.61681235e+04]
E1 = -727.9876683883952  E_coul = 201.28459236815598
cycle= 1 E= -526.703076020239  delta_E= -0.447  |g|= 0.184  |ddm|= 0.425
    CPU time for cycle= 1      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.541497
diis-c [-0.29321908  1.        ]
  HOMO = -0.580815575287689  LUMO = 1.03371900993058
  mo_energy =
[-1.18625551e+02 -1.23309388e+01 -9.58472217e+00 -9.58472217e+00
 -9.58472217e+00 -1.25652375e+00 -5.80815575e-01 -5.80815575e-01
 -5.80815575e-01  1.03371901e+00  1.03371901e+00  1.03371901e+00
  7.47543514e+00  7.47543514e+00  7.47543514e+00  9.35606742e+00
  3.38934146e+01  3.38934146e+01  3.38934146e+01  1.05738004e+02
  1.29396752e+02  1.29396752e+02  1.29396752e+02  4.83613862e+02
  4.83613862e+02  4.83613862e+02  5.94659292e+02  1.33532325e+03
  1.33532325e+03  1.33532325e+03  2.66562985e+03  3.02941274e+03
  3.02941274e+03  3.02941274e+03  6.64973680e+03  6.64973680e+03
  6.64973680e+03  9.07070058e+03  2.54257006e+04  7.61673369e+04]
E1 = -728.4504952641825  E_coul = 201.74682712817994
cycle= 2 E= -526.703668136003  delta_E= -0.000592  |g|= 0.0334  |ddm|= 0.039
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0669766
diis-c [-0.00268439  0.07299562  0.92700438]
  HOMO = -0.574107266909687  LUMO = 1.03886853809453
  mo_energy =
[-1.18566929e+02 -1.23001590e+01 -9.55263076e+00 -9.55263076e+00
 -9.55263076e+00 -1.24801489e+00 -5.74107267e-01 -5.74107267e-01
 -5.74107267e-01  1.03886854e+00  1.03886854e+00  1.03886854e+00
  7.49414865e+00  7.49414865e+00  7.49414865e+00  9.37997484e+00
  3.39261598e+01  3.39261598e+01  3.39261598e+01  1.05785792e+02
  1.29444178e+02  1.29444178e+02  1.29444178e+02  4.83671729e+02
  4.83671729e+02  4.83671729e+02  5.94719464e+02  1.33538494e+03
  1.33538494e+03  1.33538494e+03  2.66569456e+03  3.02947650e+03
  3.02947650e+03  3.02947650e+03  6.64980211e+03  6.64980211e+03
  6.64980211e+03  9.07076660e+03  2.54257671e+04  7.61674036e+04]
E1 = -728.3456466316037  E_coul = 201.64194381880662
cycle= 3 E= -526.703702812797  delta_E= -3.47e-05  |g|= 0.00484  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0105353
diis-c [-4.61731267e-07 -1.13451515e-03  1.31235761e-01  8.69898754e-01]
  HOMO = -0.575026655910523  LUMO = 1.03817418207824
  mo_energy =
[-1.18574513e+02 -1.23042077e+01 -9.55695607e+00 -9.55695607e+00
 -9.55695607e+00 -1.24912643e+00 -5.75026656e-01 -5.75026656e-01
 -5.75026656e-01  1.03817418e+00  1.03817418e+00  1.03817418e+00
  7.49160568e+00  7.49160568e+00  7.49160568e+00  9.37692106e+00
  3.39217791e+01  3.39217791e+01  3.39217791e+01  1.05779613e+02
  1.29437988e+02  1.29437988e+02  1.29437988e+02  4.83664242e+02
  4.83664242e+02  4.83664242e+02  5.94711650e+02  1.33537693e+03
  1.33537693e+03  1.33537693e+03  2.66568598e+03  3.02946814e+03
  3.02946814e+03  3.02946814e+03  6.64979340e+03  6.64979340e+03
  6.64979340e+03  9.07075770e+03  2.54257581e+04  7.61673944e+04]
E1 = -728.3599083506905  E_coul = 201.65620468955382
cycle= 4 E= -526.703703661137  delta_E= -8.48e-07  |g|= 6.27e-05  |ddm|= 0.00132
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000128532
diis-c [-1.33538412e-09  6.65103360e-05 -9.27821616e-03 -7.25905272e-02
  1.08180223e+00]
  HOMO = -0.575014292834647  LUMO = 1.03818350295403
  mo_energy =
[-1.18574519e+02 -1.23041788e+01 -9.55693925e+00 -9.55693925e+00
 -9.55693925e+00 -1.24910658e+00 -5.75014293e-01 -5.75014293e-01
 -5.75014293e-01  1.03818350e+00  1.03818350e+00  1.03818350e+00
  7.49162644e+00  7.49162644e+00  7.49162644e+00  9.37695742e+00
  3.39217947e+01  3.39217947e+01  3.39217947e+01  1.05779624e+02
  1.29437995e+02  1.29437995e+02  1.29437995e+02  4.83664238e+02
  4.83664238e+02  4.83664238e+02  5.94711638e+02  1.33537691e+03
  1.33537691e+03  1.33537691e+03  2.66568595e+03  3.02946812e+03
  3.02946812e+03  3.02946812e+03  6.64979337e+03  6.64979337e+03
  6.64979337e+03  9.07075765e+03  2.54257580e+04  7.61673944e+04]
E1 = -728.3599104423203  E_coul = 201.65620678105577
cycle= 5 E= -526.703703661265  delta_E= -1.28e-10  |g|= 7.92e-06  |ddm|= 2.67e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3599104423203  E_coul = 201.65620678105577
  HOMO = -0.575017797531445  LUMO = 1.03818090112963
  mo_energy =
[-1.18574536e+02 -1.23041912e+01 -9.55695226e+00 -9.55695226e+00
 -9.55695226e+00 -1.24911088e+00 -5.75017798e-01 -5.75017798e-01
 -5.75017798e-01  1.03818090e+00  1.03818090e+00  1.03818090e+00
  7.49161781e+00  7.49161781e+00  7.49161781e+00  9.37694750e+00
  3.39217820e+01  3.39217820e+01  3.39217820e+01  1.05779608e+02
  1.29437979e+02  1.29437979e+02  1.29437979e+02  4.83664220e+02
  4.83664220e+02  4.83664220e+02  5.94711620e+02  1.33537690e+03
  1.33537690e+03  1.33537690e+03  2.66568593e+03  3.02946810e+03
  3.02946810e+03  3.02946810e+03  6.64979335e+03  6.64979335e+03
  6.64979335e+03  9.07075763e+03  2.54257580e+04  7.61673944e+04]
E1 = -728.3599494974246  E_coul = 201.65624583615545
Extra cycle  E= -526.703703661269  delta_E= -4.66e-12  |g|= 2.34e-06  |ddm|= 4.06e-06
    CPU time for scf_cycle      7.31 sec, wall time      0.53 sec
exp = [2.61826592e+04 7.61751470e+03 3.61735446e+03 1.59767747e+03
 3.82709271e+02 1.10687178e+02 3.65556796e+01 7.79836882e+00
 3.07111117e+00 3.98094265e-01 1.36278433e+03 6.64734513e+02
 3.00909298e+02 3.13996843e+02 6.16705825e+01 7.43663630e+00
 2.01512803e+01 7.82116195e-01 2.89284997e+00 2.25853671e-01]
E = -526.7037036612692
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:58:37 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6592209        1
[INPUT] 0    0    [1    /1   ]  7617.51470247        1
[INPUT] 0    0    [1    /1   ]  3617.35446017        1
[INPUT] 0    0    [1    /1   ]  1597.67747458        1
[INPUT] 0    0    [1    /1   ]  382.709271319        1
[INPUT] 0    0    [1    /1   ]  110.687177643        1
[INPUT] 0    0    [1    /1   ]  36.5556796102        1
[INPUT] 0    0    [1    /1   ]  7.79836882133        1
[INPUT] 0    0    [1    /1   ]  3.0711111663         1
[INPUT] 0    0    [1    /1   ]  0.398094264995       1
[INPUT] 1    0    [1    /1   ]  1362.7843344         1
[INPUT] 1    0    [1    /1   ]  664.734512514        1
[INPUT] 1    0    [1    /1   ]  300.909297703        1
[INPUT] 1    0    [1    /1   ]  313.996842625        1
[INPUT] 1    0    [1    /1   ]  61.670582452         1
[INPUT] 1    0    [1    /1   ]  7.436636295          1
[INPUT] 1    0    [1    /1   ]  20.1512802535        1
[INPUT] 1    0    [1    /1   ]  0.782116195299       1
[INPUT] 1    0    [1    /1   ]  2.89284996571        1
[INPUT] 1    0    [1    /1   ]  0.225853671218       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.65922093482, 1.0]], [0, [7617.514702471665, 1.0]], [0, [3617.3544601692456, 1.0]], [0, [1597.6774745794812, 1.0]], [0, [382.7092713192513, 1.0]], [0, [110.68717764276767, 1.0]], [0, [36.55567961018283, 1.0]], [0, [7.798368821330743, 1.0]], [0, [3.071111166297414, 1.0]], [0, [0.39809426499477424, 1.0]], [1, [1362.7843343994598, 1.0]], [1, [664.7345125137188, 1.0]], [1, [300.9092977027126, 1.0]], [1, [313.9968426247688, 1.0]], [1, [61.67058245196843, 1.0]], [1, [7.43663629500315, 1.0]], [1, [20.151280253456285, 1.0]], [1, [0.782116195299495, 1.0]], [1, [2.8928499657067683, 1.0]], [1, [0.22585367121804495, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65922093]
bas 1, expnt(s) = [7617.51470247]
bas 2, expnt(s) = [3617.35446017]
bas 3, expnt(s) = [1597.67747458]
bas 4, expnt(s) = [382.70927132]
bas 5, expnt(s) = [110.68717764]
bas 6, expnt(s) = [36.55567961]
bas 7, expnt(s) = [7.79836882]
bas 8, expnt(s) = [3.07111117]
bas 9, expnt(s) = [0.39809426]
bas 10, expnt(s) = [1362.7843344]
bas 11, expnt(s) = [664.73451251]
bas 12, expnt(s) = [300.9092977]
bas 13, expnt(s) = [313.99684262]
bas 14, expnt(s) = [61.67058245]
bas 15, expnt(s) = [7.4366363]
bas 16, expnt(s) = [20.15128025]
bas 17, expnt(s) = [0.7821162]
bas 18, expnt(s) = [2.89284997]
bas 19, expnt(s) = [0.22585367]
CPU time:      1156.10
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826592e+04 5.20026337e+03 7.61751470e+03 2.06003690e+03
 3.61735446e+03 1.17844230e+03 1.59767747e+03 6.38457302e+02
 3.82709271e+02 2.18608358e+02 1.10687178e+02 8.62160277e+01
 3.65556796e+01 3.75604832e+01 7.79836882e+00 1.17901099e+01
 3.07111117e+00 5.86120184e+00 3.98094265e-01 1.26620629e+00
 1.36278433e+03 2.41556266e+04 6.64734513e+02 9.84679003e+03
 3.00909298e+02 3.65619122e+03 3.13996843e+02 3.85603524e+03
 6.16705825e+01 5.04175753e+02 7.43663630e+00 3.58265567e+01
 2.01512803e+01 1.24555439e+02 7.82116195e-01 2.14572218e+00
 2.89284997e+00 1.10063110e+01 2.25853671e-01 4.54222178e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982670583216972
cond(S) = 102463.57861447756
E1 = -729.3788936832939  E_coul = 203.1226800317862
init E= -526.256213651508
    CPU time for initialize scf      7.25 sec, wall time      0.35 sec
  HOMO = -0.556826851411957  LUMO = 1.04969979816966
  mo_energy =
[-1.18332301e+02 -1.22079989e+01 -9.45151320e+00 -9.45151320e+00
 -9.45151320e+00 -1.22583716e+00 -5.56826851e-01 -5.56826851e-01
 -5.56826851e-01  1.04969980e+00  1.04969980e+00  1.04969980e+00
  7.55187311e+00  7.55187311e+00  7.55187311e+00  9.44380184e+00
  3.40324709e+01  3.40324709e+01  3.40324709e+01  1.05944713e+02
  1.29609771e+02  1.29609771e+02  1.29609771e+02  4.83905574e+02
  4.83905574e+02  4.83905574e+02  5.94989499e+02  1.33567121e+03
  1.33567121e+03  1.33567121e+03  2.66611192e+03  3.02982671e+03
  3.02982671e+03  3.02982671e+03  6.65026397e+03  6.65026397e+03
  6.65026397e+03  9.07130298e+03  2.54263971e+04  7.61681235e+04]
E1 = -727.9876683883952  E_coul = 201.28459236815598
cycle= 1 E= -526.703076020239  delta_E= -0.447  |g|= 0.184  |ddm|= 0.425
    CPU time for cycle= 1      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.541497
diis-c [-0.29321908  1.        ]
  HOMO = -0.580815575287689  LUMO = 1.03371900993058
  mo_energy =
[-1.18625551e+02 -1.23309388e+01 -9.58472217e+00 -9.58472217e+00
 -9.58472217e+00 -1.25652375e+00 -5.80815575e-01 -5.80815575e-01
 -5.80815575e-01  1.03371901e+00  1.03371901e+00  1.03371901e+00
  7.47543514e+00  7.47543514e+00  7.47543514e+00  9.35606742e+00
  3.38934146e+01  3.38934146e+01  3.38934146e+01  1.05738004e+02
  1.29396752e+02  1.29396752e+02  1.29396752e+02  4.83613862e+02
  4.83613862e+02  4.83613862e+02  5.94659292e+02  1.33532325e+03
  1.33532325e+03  1.33532325e+03  2.66562985e+03  3.02941274e+03
  3.02941274e+03  3.02941274e+03  6.64973680e+03  6.64973680e+03
  6.64973680e+03  9.07070058e+03  2.54257006e+04  7.61673369e+04]
E1 = -728.4504952641825  E_coul = 201.74682712817994
cycle= 2 E= -526.703668136003  delta_E= -0.000592  |g|= 0.0334  |ddm|= 0.039
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0669766
diis-c [-0.00268439  0.07299562  0.92700438]
  HOMO = -0.574107266909687  LUMO = 1.03886853809453
  mo_energy =
[-1.18566929e+02 -1.23001590e+01 -9.55263076e+00 -9.55263076e+00
 -9.55263076e+00 -1.24801489e+00 -5.74107267e-01 -5.74107267e-01
 -5.74107267e-01  1.03886854e+00  1.03886854e+00  1.03886854e+00
  7.49414865e+00  7.49414865e+00  7.49414865e+00  9.37997484e+00
  3.39261598e+01  3.39261598e+01  3.39261598e+01  1.05785792e+02
  1.29444178e+02  1.29444178e+02  1.29444178e+02  4.83671729e+02
  4.83671729e+02  4.83671729e+02  5.94719464e+02  1.33538494e+03
  1.33538494e+03  1.33538494e+03  2.66569456e+03  3.02947650e+03
  3.02947650e+03  3.02947650e+03  6.64980211e+03  6.64980211e+03
  6.64980211e+03  9.07076660e+03  2.54257671e+04  7.61674036e+04]
E1 = -728.3456466316037  E_coul = 201.64194381880662
cycle= 3 E= -526.703702812797  delta_E= -3.47e-05  |g|= 0.00484  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0105353
diis-c [-4.61731267e-07 -1.13451515e-03  1.31235761e-01  8.69898754e-01]
  HOMO = -0.575026655910523  LUMO = 1.03817418207824
  mo_energy =
[-1.18574513e+02 -1.23042077e+01 -9.55695607e+00 -9.55695607e+00
 -9.55695607e+00 -1.24912643e+00 -5.75026656e-01 -5.75026656e-01
 -5.75026656e-01  1.03817418e+00  1.03817418e+00  1.03817418e+00
  7.49160568e+00  7.49160568e+00  7.49160568e+00  9.37692106e+00
  3.39217791e+01  3.39217791e+01  3.39217791e+01  1.05779613e+02
  1.29437988e+02  1.29437988e+02  1.29437988e+02  4.83664242e+02
  4.83664242e+02  4.83664242e+02  5.94711650e+02  1.33537693e+03
  1.33537693e+03  1.33537693e+03  2.66568598e+03  3.02946814e+03
  3.02946814e+03  3.02946814e+03  6.64979340e+03  6.64979340e+03
  6.64979340e+03  9.07075770e+03  2.54257581e+04  7.61673944e+04]
E1 = -728.3599083506905  E_coul = 201.65620468955382
cycle= 4 E= -526.703703661137  delta_E= -8.48e-07  |g|= 6.27e-05  |ddm|= 0.00132
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000128532
diis-c [-1.33538412e-09  6.65103360e-05 -9.27821616e-03 -7.25905272e-02
  1.08180223e+00]
  HOMO = -0.575014292834647  LUMO = 1.03818350295403
  mo_energy =
[-1.18574519e+02 -1.23041788e+01 -9.55693925e+00 -9.55693925e+00
 -9.55693925e+00 -1.24910658e+00 -5.75014293e-01 -5.75014293e-01
 -5.75014293e-01  1.03818350e+00  1.03818350e+00  1.03818350e+00
  7.49162644e+00  7.49162644e+00  7.49162644e+00  9.37695742e+00
  3.39217947e+01  3.39217947e+01  3.39217947e+01  1.05779624e+02
  1.29437995e+02  1.29437995e+02  1.29437995e+02  4.83664238e+02
  4.83664238e+02  4.83664238e+02  5.94711638e+02  1.33537691e+03
  1.33537691e+03  1.33537691e+03  2.66568595e+03  3.02946812e+03
  3.02946812e+03  3.02946812e+03  6.64979337e+03  6.64979337e+03
  6.64979337e+03  9.07075765e+03  2.54257580e+04  7.61673944e+04]
E1 = -728.3599104423203  E_coul = 201.65620678105577
cycle= 5 E= -526.703703661265  delta_E= -1.28e-10  |g|= 7.92e-06  |ddm|= 2.67e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.04 sec
E1 = -728.3599104423203  E_coul = 201.65620678105577
  HOMO = -0.575017797531445  LUMO = 1.03818090112963
  mo_energy =
[-1.18574536e+02 -1.23041912e+01 -9.55695226e+00 -9.55695226e+00
 -9.55695226e+00 -1.24911088e+00 -5.75017798e-01 -5.75017798e-01
 -5.75017798e-01  1.03818090e+00  1.03818090e+00  1.03818090e+00
  7.49161781e+00  7.49161781e+00  7.49161781e+00  9.37694750e+00
  3.39217820e+01  3.39217820e+01  3.39217820e+01  1.05779608e+02
  1.29437979e+02  1.29437979e+02  1.29437979e+02  4.83664220e+02
  4.83664220e+02  4.83664220e+02  5.94711620e+02  1.33537690e+03
  1.33537690e+03  1.33537690e+03  2.66568593e+03  3.02946810e+03
  3.02946810e+03  3.02946810e+03  6.64979335e+03  6.64979335e+03
  6.64979335e+03  9.07075763e+03  2.54257580e+04  7.61673944e+04]
E1 = -728.3599494974246  E_coul = 201.65624583615545
Extra cycle  E= -526.703703661269  delta_E= -4.66e-12  |g|= 2.34e-06  |ddm|= 4.06e-06
    CPU time for scf_cycle      7.47 sec, wall time      0.54 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102463.57861447756
E1 = -728.3599494974246  E_coul = 201.65624583615545
init E= -526.703703661269
    CPU time for initialize scf     15.42 sec, wall time      0.76 sec
  HOMO = -0.575017084841252  LUMO = 1.03818143684192
  mo_energy =
[-1.18574531e+02 -1.23041884e+01 -9.55694930e+00 -9.55694930e+00
 -9.55694930e+00 -1.24910999e+00 -5.75017085e-01 -5.75017085e-01
 -5.75017085e-01  1.03818144e+00  1.03818144e+00  1.03818144e+00
  7.49161965e+00  7.49161965e+00  7.49161965e+00  9.37694976e+00
  3.39217849e+01  3.39217849e+01  3.39217849e+01  1.05779612e+02
  1.29437983e+02  1.29437983e+02  1.29437983e+02  4.83664225e+02
  4.83664225e+02  4.83664225e+02  5.94711625e+02  1.33537690e+03
  1.33537690e+03  1.33537690e+03  2.66568594e+03  3.02946811e+03
  3.02946811e+03  3.02946811e+03  6.64979335e+03  6.64979335e+03
  6.64979335e+03  9.07075764e+03  2.54257580e+04  7.61673944e+04]
E1 = -728.3599402146594  E_coul = 201.6562365533916
cycle= 1 E= -526.703703661268  delta_E= 1.36e-12  |g|= 6.02e-07  |ddm|= 9.35e-07
    CPU time for cycle= 1      0.06 sec, wall time      0.02 sec
E1 = -728.3599402146594  E_coul = 201.6562365533916
  HOMO = -0.575017242316243  LUMO = 1.03818131778519
  mo_energy =
[-1.18574533e+02 -1.23041890e+01 -9.55695001e+00 -9.55695001e+00
 -9.55695001e+00 -1.24911018e+00 -5.75017242e-01 -5.75017242e-01
 -5.75017242e-01  1.03818132e+00  1.03818132e+00  1.03818132e+00
  7.49161923e+00  7.49161923e+00  7.49161923e+00  9.37694924e+00
  3.39217842e+01  3.39217842e+01  3.39217842e+01  1.05779611e+02
  1.29437982e+02  1.29437982e+02  1.29437982e+02  4.83664224e+02
  4.83664224e+02  4.83664224e+02  5.94711624e+02  1.33537690e+03
  1.33537690e+03  1.33537690e+03  2.66568593e+03  3.02946811e+03
  3.02946811e+03  3.02946811e+03  6.64979335e+03  6.64979335e+03
  6.64979335e+03  9.07075764e+03  2.54257580e+04  7.61673944e+04]
E1 = -728.3599424791854  E_coul = 201.6562388179169
Extra cycle  E= -526.703703661268  delta_E= -6.82e-13  |g|= 1.51e-07  |ddm|= 2.19e-07
    CPU time for scf_cycle     15.57 sec, wall time      0.87 sec
exp = [2.61826592e+04 7.61751470e+03 3.61735446e+03 1.59767747e+03
 3.82709271e+02 1.10687178e+02 3.65556796e+01 7.79836882e+00
 3.07111117e+00 3.98094265e-01 1.36278433e+03 6.64734513e+02
 3.00909298e+02 3.13996843e+02 6.16705825e+01 7.43663630e+00
 2.01512803e+01 7.82116195e-01 2.89284997e+00 2.25853671e-01]
grad_E = [-1.53367652e-06  3.48880533e-06 -1.47116817e-06  7.58730755e-05
 -1.53706753e-04 -7.01084604e-04  5.76787259e-04 -1.08784390e-03
  1.79248402e-03 -2.72526520e-03 -5.47529303e-07  4.42240608e-06
  2.00957249e-05  1.73385108e-05  3.69829068e-04  4.34580223e-03
 -2.57506748e-03 -3.85552299e-03 -1.39331967e-05  1.82749671e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:58:42 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.659318         1
[INPUT] 0    0    [1    /1   ]  7617.51449181        1
[INPUT] 0    0    [1    /1   ]  3617.35456185        1
[INPUT] 0    0    [1    /1   ]  1597.67309138        1
[INPUT] 0    0    [1    /1   ]  382.708134191        1
[INPUT] 0    0    [1    /1   ]  110.753744732        1
[INPUT] 0    0    [1    /1   ]  36.5973679384        1
[INPUT] 0    0    [1    /1   ]  7.77706751248        1
[INPUT] 0    0    [1    /1   ]  3.06861607172        1
[INPUT] 0    0    [1    /1   ]  0.397965706439       1
[INPUT] 1    0    [1    /1   ]  1362.7843674         1
[INPUT] 1    0    [1    /1   ]  664.734199405        1
[INPUT] 1    0    [1    /1   ]  300.907830918        1
[INPUT] 1    0    [1    /1   ]  313.99557782         1
[INPUT] 1    0    [1    /1   ]  61.6666744423        1
[INPUT] 1    0    [1    /1   ]  7.39918164614        1
[INPUT] 1    0    [1    /1   ]  20.1819854663        1
[INPUT] 1    0    [1    /1   ]  0.779093885934       1
[INPUT] 1    0    [1    /1   ]  2.85539131526        1
[INPUT] 1    0    [1    /1   ]  0.225456232308       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.6593180293, 1.0]], [0, [7617.5144918076485, 1.0]], [0, [3617.3545618493413, 1.0]], [0, [1597.6730913751007, 1.0]], [0, [382.7081341906452, 1.0]], [0, [110.75374473171959, 1.0]], [0, [36.597367938408745, 1.0]], [0, [7.777067512478849, 1.0]], [0, [3.0686160717192505, 1.0]], [0, [0.39796570643910795, 1.0]], [1, [1362.784367400354, 1.0]], [1, [664.7341994054904, 1.0]], [1, [300.90783091766326, 1.0]], [1, [313.995577820482, 1.0]], [1, [61.66667444233057, 1.0]], [1, [7.39918164613978, 1.0]], [1, [20.181985466274263, 1.0]], [1, [0.7790938859342174, 1.0]], [1, [2.855391315263013, 1.0]], [1, [0.2254562323082127, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65931803]
bas 1, expnt(s) = [7617.51449181]
bas 2, expnt(s) = [3617.35456185]
bas 3, expnt(s) = [1597.67309138]
bas 4, expnt(s) = [382.70813419]
bas 5, expnt(s) = [110.75374473]
bas 6, expnt(s) = [36.59736794]
bas 7, expnt(s) = [7.77706751]
bas 8, expnt(s) = [3.06861607]
bas 9, expnt(s) = [0.39796571]
bas 10, expnt(s) = [1362.7843674]
bas 11, expnt(s) = [664.73419941]
bas 12, expnt(s) = [300.90783092]
bas 13, expnt(s) = [313.99557782]
bas 14, expnt(s) = [61.66667444]
bas 15, expnt(s) = [7.39918165]
bas 16, expnt(s) = [20.18198547]
bas 17, expnt(s) = [0.77909389]
bas 18, expnt(s) = [2.85539132]
bas 19, expnt(s) = [0.22545623]
CPU time:      1183.91
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826593e+04 5.20026338e+03 7.61751449e+03 2.06003686e+03
 3.61735456e+03 1.17844233e+03 1.59767309e+03 6.38455988e+02
 3.82708134e+02 2.18607871e+02 1.10753745e+02 8.62549124e+01
 3.65973679e+01 3.75926043e+01 7.77706751e+00 1.17659480e+01
 3.06861607e+00 5.85763007e+00 3.97965706e-01 1.26589960e+00
 1.36278437e+03 2.41556274e+04 6.64734199e+02 9.84678423e+03
 3.00907831e+02 3.65616894e+03 3.13995578e+02 3.85601582e+03
 6.16666744e+01 5.04135816e+02 7.39918165e+00 3.56011481e+01
 2.01819855e+01 1.24792721e+02 7.79093886e-01 2.13536263e+00
 2.85539132e+00 1.08284535e+01 2.25456232e-01 4.53223269e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982776095473714
cond(S) = 102425.36928767934
E1 = -729.3781981086556  E_coul = 203.12199577562046
init E= -526.256202333035
    CPU time for initialize scf      6.95 sec, wall time      0.35 sec
  HOMO = -0.55686816775704  LUMO = 1.04527527750913
  mo_energy =
[-1.18332353e+02 -1.22080464e+01 -9.45156942e+00 -9.45156942e+00
 -9.45156942e+00 -1.22588102e+00 -5.56868168e-01 -5.56868168e-01
 -5.56868168e-01  1.04527528e+00  1.04527528e+00  1.04527528e+00
  7.46376308e+00  7.46376308e+00  7.46376308e+00  9.41596546e+00
  3.38197442e+01  3.38197442e+01  3.38197442e+01  1.05955134e+02
  1.29424519e+02  1.29424519e+02  1.29424519e+02  4.83775475e+02
  4.83775475e+02  4.83775475e+02  5.95216641e+02  1.33555689e+03
  1.33555689e+03  1.33555689e+03  2.66641743e+03  3.02971745e+03
  3.02971745e+03  3.02971745e+03  6.65016144e+03  6.65016144e+03
  6.65016144e+03  9.07159847e+03  2.54266762e+04  7.61683825e+04]
E1 = -727.9876659731361  E_coul = 201.28440318989536
cycle= 1 E= -526.703262783241  delta_E= -0.447  |g|= 0.184  |ddm|= 0.423
    CPU time for cycle= 1      0.08 sec, wall time      0.03 sec
diis-norm(errvec)=0.541101
diis-c [-0.29278977  1.        ]
  HOMO = -0.580809553361757  LUMO = 1.0294398384099
  mo_energy =
[-1.18625625e+02 -1.23309875e+01 -9.58475824e+00 -9.58475824e+00
 -9.58475824e+00 -1.25649836e+00 -5.80809553e-01 -5.80809553e-01
 -5.80809553e-01  1.02943984e+00  1.02943984e+00  1.02943984e+00
  7.38794417e+00  7.38794417e+00  7.38794417e+00  9.32837454e+00
  3.36807373e+01  3.36807373e+01  3.36807373e+01  1.05748362e+02
  1.29211397e+02  1.29211397e+02  1.29211397e+02  4.83483741e+02
  4.83483741e+02  4.83483741e+02  5.94886417e+02  1.33520895e+03
  1.33520895e+03  1.33520895e+03  2.66593539e+03  3.02930351e+03
  3.02930351e+03  3.02930351e+03  6.64963430e+03  6.64963430e+03
  6.64963430e+03  9.07099611e+03  2.54259798e+04  7.61675960e+04]
E1 = -728.450732761244  E_coul = 201.74687778264678
cycle= 2 E= -526.703854978597  delta_E= -0.000592  |g|= 0.0335  |ddm|= 0.039
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0669212
diis-c [-0.00268346  0.07292368  0.92707632]
  HOMO = -0.574095827913101  LUMO = 1.03456373757827
  mo_energy =
[-1.18566971e+02 -1.23001908e+01 -9.55264793e+00 -9.55264793e+00
 -9.55264793e+00 -1.24798409e+00 -5.74095828e-01 -5.74095828e-01
 -5.74095828e-01  1.03456374e+00  1.03456374e+00  1.03456374e+00
  7.40654914e+00  7.40654914e+00  7.40654914e+00  9.35226864e+00
  3.37134895e+01  3.37134895e+01  3.37134895e+01  1.05796186e+02
  1.29258864e+02  1.29258864e+02  1.29258864e+02  4.83541643e+02
  4.83541643e+02  4.83541643e+02  5.94946625e+02  1.33527066e+03
  1.33527066e+03  1.33527066e+03  2.66600014e+03  3.02936730e+03
  3.02936730e+03  3.02936730e+03  6.64969965e+03  6.64969965e+03
  6.64969965e+03  9.07106217e+03  2.54260463e+04  7.61676627e+04]
E1 = -728.3457547797633  E_coul = 201.6418650743122
cycle= 3 E= -526.703889705451  delta_E= -3.47e-05  |g|= 0.00485  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0105402
diis-c [-4.60446321e-07 -1.13484597e-03  1.31393003e-01  8.69741843e-01]
  HOMO = -0.575016873594616  LUMO = 1.03387219353269
  mo_energy =
[-1.18574570e+02 -1.23042481e+01 -9.55698188e+00 -9.55698188e+00
 -9.55698188e+00 -1.24909744e+00 -5.75016874e-01 -5.75016874e-01
 -5.75016874e-01  1.03387219e+00  1.03387219e+00  1.03387219e+00
  7.40401779e+00  7.40401779e+00  7.40401779e+00  9.34921210e+00
  3.37091015e+01  3.37091015e+01  3.37091015e+01  1.05789994e+02
  1.29252660e+02  1.29252660e+02  1.29252660e+02  4.83534142e+02
  4.83534142e+02  4.83534142e+02  5.94938797e+02  1.33526264e+03
  1.33526264e+03  1.33526264e+03  2.66599155e+03  3.02935893e+03
  3.02935893e+03  3.02935893e+03  6.64969092e+03  6.64969092e+03
  6.64969092e+03  9.07105325e+03  2.54260372e+04  7.61676535e+04]
E1 = -728.3600538682265  E_coul = 201.65616331058777
cycle= 4 E= -526.703890557639  delta_E= -8.52e-07  |g|= 6.26e-05  |ddm|= 0.00132
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000128041
diis-c [-1.34799391e-09  6.64484727e-05 -9.27153705e-03 -7.24022915e-02
  1.08160738e+00]
  HOMO = -0.57500440795521  LUMO = 1.03388155140469
  mo_energy =
[-1.18574575e+02 -1.23042190e+01 -9.55696482e+00 -9.55696482e+00
 -9.55696482e+00 -1.24907746e+00 -5.75004408e-01 -5.75004408e-01
 -5.75004408e-01  1.03388155e+00  1.03388155e+00  1.03388155e+00
  7.40403874e+00  7.40403874e+00  7.40403874e+00  9.34924868e+00
  3.37091174e+01  3.37091174e+01  3.37091174e+01  1.05790005e+02
  1.29252667e+02  1.29252667e+02  1.29252667e+02  4.83534137e+02
  4.83534137e+02  4.83534137e+02  5.94938785e+02  1.33526263e+03
  1.33526263e+03  1.33526263e+03  2.66599152e+03  3.02935890e+03
  3.02935890e+03  3.02935890e+03  6.64969089e+03  6.64969089e+03
  6.64969089e+03  9.07105320e+03  2.54260372e+04  7.61676535e+04]
E1 = -728.3600554822652  E_coul = 201.65616492449854
cycle= 5 E= -526.703890557767  delta_E= -1.28e-10  |g|= 7.94e-06  |ddm|= 2.69e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3600554822652  E_coul = 201.65616492449854
  HOMO = -0.575007916721738  LUMO = 1.03387896118957
  mo_energy =
[-1.18574592e+02 -1.23042314e+01 -9.55697785e+00 -9.55697785e+00
 -9.55697785e+00 -1.24908176e+00 -5.75007917e-01 -5.75007917e-01
 -5.75007917e-01  1.03387896e+00  1.03387896e+00  1.03387896e+00
  7.40403014e+00  7.40403014e+00  7.40403014e+00  9.34923875e+00
  3.37091046e+01  3.37091046e+01  3.37091046e+01  1.05789990e+02
  1.29252651e+02  1.29252651e+02  1.29252651e+02  4.83534120e+02
  4.83534120e+02  4.83534120e+02  5.94938767e+02  1.33526261e+03
  1.33526261e+03  1.33526261e+03  2.66599150e+03  3.02935888e+03
  3.02935888e+03  3.02935888e+03  6.64969087e+03  6.64969087e+03
  6.64969087e+03  9.07105318e+03  2.54260372e+04  7.61676535e+04]
E1 = -728.3600946425606  E_coul = 201.65620408479015
Extra cycle  E= -526.70389055777  delta_E= -3.75e-12  |g|= 2.35e-06  |ddm|= 4.07e-06
    CPU time for scf_cycle      7.19 sec, wall time      0.53 sec
exp = [2.61826593e+04 7.61751449e+03 3.61735456e+03 1.59767309e+03
 3.82708134e+02 1.10753745e+02 3.65973679e+01 7.77706751e+00
 3.06861607e+00 3.97965706e-01 1.36278437e+03 6.64734199e+02
 3.00907831e+02 3.13995578e+02 6.16666744e+01 7.39918165e+00
 2.01819855e+01 7.79093886e-01 2.85539132e+00 2.25456232e-01]
E = -526.7038905577705
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:58:43 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.659318         1
[INPUT] 0    0    [1    /1   ]  7617.51449181        1
[INPUT] 0    0    [1    /1   ]  3617.35456185        1
[INPUT] 0    0    [1    /1   ]  1597.67309138        1
[INPUT] 0    0    [1    /1   ]  382.708134191        1
[INPUT] 0    0    [1    /1   ]  110.753744732        1
[INPUT] 0    0    [1    /1   ]  36.5973679384        1
[INPUT] 0    0    [1    /1   ]  7.77706751248        1
[INPUT] 0    0    [1    /1   ]  3.06861607172        1
[INPUT] 0    0    [1    /1   ]  0.397965706439       1
[INPUT] 1    0    [1    /1   ]  1362.7843674         1
[INPUT] 1    0    [1    /1   ]  664.734199405        1
[INPUT] 1    0    [1    /1   ]  300.907830918        1
[INPUT] 1    0    [1    /1   ]  313.99557782         1
[INPUT] 1    0    [1    /1   ]  61.6666744423        1
[INPUT] 1    0    [1    /1   ]  7.39918164614        1
[INPUT] 1    0    [1    /1   ]  20.1819854663        1
[INPUT] 1    0    [1    /1   ]  0.779093885934       1
[INPUT] 1    0    [1    /1   ]  2.85539131526        1
[INPUT] 1    0    [1    /1   ]  0.225456232308       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.6593180293, 1.0]], [0, [7617.5144918076485, 1.0]], [0, [3617.3545618493413, 1.0]], [0, [1597.6730913751007, 1.0]], [0, [382.7081341906452, 1.0]], [0, [110.75374473171959, 1.0]], [0, [36.597367938408745, 1.0]], [0, [7.777067512478849, 1.0]], [0, [3.0686160717192505, 1.0]], [0, [0.39796570643910795, 1.0]], [1, [1362.784367400354, 1.0]], [1, [664.7341994054904, 1.0]], [1, [300.90783091766326, 1.0]], [1, [313.995577820482, 1.0]], [1, [61.66667444233057, 1.0]], [1, [7.39918164613978, 1.0]], [1, [20.181985466274263, 1.0]], [1, [0.7790938859342174, 1.0]], [1, [2.855391315263013, 1.0]], [1, [0.2254562323082127, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65931803]
bas 1, expnt(s) = [7617.51449181]
bas 2, expnt(s) = [3617.35456185]
bas 3, expnt(s) = [1597.67309138]
bas 4, expnt(s) = [382.70813419]
bas 5, expnt(s) = [110.75374473]
bas 6, expnt(s) = [36.59736794]
bas 7, expnt(s) = [7.77706751]
bas 8, expnt(s) = [3.06861607]
bas 9, expnt(s) = [0.39796571]
bas 10, expnt(s) = [1362.7843674]
bas 11, expnt(s) = [664.73419941]
bas 12, expnt(s) = [300.90783092]
bas 13, expnt(s) = [313.99557782]
bas 14, expnt(s) = [61.66667444]
bas 15, expnt(s) = [7.39918165]
bas 16, expnt(s) = [20.18198547]
bas 17, expnt(s) = [0.77909389]
bas 18, expnt(s) = [2.85539132]
bas 19, expnt(s) = [0.22545623]
CPU time:      1191.25
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826593e+04 5.20026338e+03 7.61751449e+03 2.06003686e+03
 3.61735456e+03 1.17844233e+03 1.59767309e+03 6.38455988e+02
 3.82708134e+02 2.18607871e+02 1.10753745e+02 8.62549124e+01
 3.65973679e+01 3.75926043e+01 7.77706751e+00 1.17659480e+01
 3.06861607e+00 5.85763007e+00 3.97965706e-01 1.26589960e+00
 1.36278437e+03 2.41556274e+04 6.64734199e+02 9.84678423e+03
 3.00907831e+02 3.65616894e+03 3.13995578e+02 3.85601582e+03
 6.16666744e+01 5.04135816e+02 7.39918165e+00 3.56011481e+01
 2.01819855e+01 1.24792721e+02 7.79093886e-01 2.13536263e+00
 2.85539132e+00 1.08284535e+01 2.25456232e-01 4.53223269e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982776095473714
cond(S) = 102425.36928767934
E1 = -729.3781981086556  E_coul = 203.12199577562046
init E= -526.256202333035
    CPU time for initialize scf      6.97 sec, wall time      0.35 sec
  HOMO = -0.55686816775704  LUMO = 1.04527527750913
  mo_energy =
[-1.18332353e+02 -1.22080464e+01 -9.45156942e+00 -9.45156942e+00
 -9.45156942e+00 -1.22588102e+00 -5.56868168e-01 -5.56868168e-01
 -5.56868168e-01  1.04527528e+00  1.04527528e+00  1.04527528e+00
  7.46376308e+00  7.46376308e+00  7.46376308e+00  9.41596546e+00
  3.38197442e+01  3.38197442e+01  3.38197442e+01  1.05955134e+02
  1.29424519e+02  1.29424519e+02  1.29424519e+02  4.83775475e+02
  4.83775475e+02  4.83775475e+02  5.95216641e+02  1.33555689e+03
  1.33555689e+03  1.33555689e+03  2.66641743e+03  3.02971745e+03
  3.02971745e+03  3.02971745e+03  6.65016144e+03  6.65016144e+03
  6.65016144e+03  9.07159847e+03  2.54266762e+04  7.61683825e+04]
E1 = -727.9876659731361  E_coul = 201.28440318989536
cycle= 1 E= -526.703262783241  delta_E= -0.447  |g|= 0.184  |ddm|= 0.423
    CPU time for cycle= 1      0.08 sec, wall time      0.03 sec
diis-norm(errvec)=0.541101
diis-c [-0.29278977  1.        ]
  HOMO = -0.580809553361757  LUMO = 1.0294398384099
  mo_energy =
[-1.18625625e+02 -1.23309875e+01 -9.58475824e+00 -9.58475824e+00
 -9.58475824e+00 -1.25649836e+00 -5.80809553e-01 -5.80809553e-01
 -5.80809553e-01  1.02943984e+00  1.02943984e+00  1.02943984e+00
  7.38794417e+00  7.38794417e+00  7.38794417e+00  9.32837454e+00
  3.36807373e+01  3.36807373e+01  3.36807373e+01  1.05748362e+02
  1.29211397e+02  1.29211397e+02  1.29211397e+02  4.83483741e+02
  4.83483741e+02  4.83483741e+02  5.94886417e+02  1.33520895e+03
  1.33520895e+03  1.33520895e+03  2.66593539e+03  3.02930351e+03
  3.02930351e+03  3.02930351e+03  6.64963430e+03  6.64963430e+03
  6.64963430e+03  9.07099611e+03  2.54259798e+04  7.61675960e+04]
E1 = -728.450732761244  E_coul = 201.74687778264678
cycle= 2 E= -526.703854978597  delta_E= -0.000592  |g|= 0.0335  |ddm|= 0.039
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0669212
diis-c [-0.00268346  0.07292368  0.92707632]
  HOMO = -0.574095827913101  LUMO = 1.03456373757827
  mo_energy =
[-1.18566971e+02 -1.23001908e+01 -9.55264793e+00 -9.55264793e+00
 -9.55264793e+00 -1.24798409e+00 -5.74095828e-01 -5.74095828e-01
 -5.74095828e-01  1.03456374e+00  1.03456374e+00  1.03456374e+00
  7.40654914e+00  7.40654914e+00  7.40654914e+00  9.35226864e+00
  3.37134895e+01  3.37134895e+01  3.37134895e+01  1.05796186e+02
  1.29258864e+02  1.29258864e+02  1.29258864e+02  4.83541643e+02
  4.83541643e+02  4.83541643e+02  5.94946625e+02  1.33527066e+03
  1.33527066e+03  1.33527066e+03  2.66600014e+03  3.02936730e+03
  3.02936730e+03  3.02936730e+03  6.64969965e+03  6.64969965e+03
  6.64969965e+03  9.07106217e+03  2.54260463e+04  7.61676627e+04]
E1 = -728.3457547797633  E_coul = 201.6418650743122
cycle= 3 E= -526.703889705451  delta_E= -3.47e-05  |g|= 0.00485  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0105402
diis-c [-4.60446321e-07 -1.13484597e-03  1.31393003e-01  8.69741843e-01]
  HOMO = -0.575016873594616  LUMO = 1.03387219353269
  mo_energy =
[-1.18574570e+02 -1.23042481e+01 -9.55698188e+00 -9.55698188e+00
 -9.55698188e+00 -1.24909744e+00 -5.75016874e-01 -5.75016874e-01
 -5.75016874e-01  1.03387219e+00  1.03387219e+00  1.03387219e+00
  7.40401779e+00  7.40401779e+00  7.40401779e+00  9.34921210e+00
  3.37091015e+01  3.37091015e+01  3.37091015e+01  1.05789994e+02
  1.29252660e+02  1.29252660e+02  1.29252660e+02  4.83534142e+02
  4.83534142e+02  4.83534142e+02  5.94938797e+02  1.33526264e+03
  1.33526264e+03  1.33526264e+03  2.66599155e+03  3.02935893e+03
  3.02935893e+03  3.02935893e+03  6.64969092e+03  6.64969092e+03
  6.64969092e+03  9.07105325e+03  2.54260372e+04  7.61676535e+04]
E1 = -728.3600538682265  E_coul = 201.65616331058777
cycle= 4 E= -526.703890557639  delta_E= -8.52e-07  |g|= 6.26e-05  |ddm|= 0.00132
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000128041
diis-c [-1.34799391e-09  6.64484727e-05 -9.27153705e-03 -7.24022915e-02
  1.08160738e+00]
  HOMO = -0.57500440795521  LUMO = 1.03388155140469
  mo_energy =
[-1.18574575e+02 -1.23042190e+01 -9.55696482e+00 -9.55696482e+00
 -9.55696482e+00 -1.24907746e+00 -5.75004408e-01 -5.75004408e-01
 -5.75004408e-01  1.03388155e+00  1.03388155e+00  1.03388155e+00
  7.40403874e+00  7.40403874e+00  7.40403874e+00  9.34924868e+00
  3.37091174e+01  3.37091174e+01  3.37091174e+01  1.05790005e+02
  1.29252667e+02  1.29252667e+02  1.29252667e+02  4.83534137e+02
  4.83534137e+02  4.83534137e+02  5.94938785e+02  1.33526263e+03
  1.33526263e+03  1.33526263e+03  2.66599152e+03  3.02935890e+03
  3.02935890e+03  3.02935890e+03  6.64969089e+03  6.64969089e+03
  6.64969089e+03  9.07105320e+03  2.54260372e+04  7.61676535e+04]
E1 = -728.3600554822652  E_coul = 201.65616492449854
cycle= 5 E= -526.703890557767  delta_E= -1.28e-10  |g|= 7.94e-06  |ddm|= 2.69e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3600554822652  E_coul = 201.65616492449854
  HOMO = -0.575007916721738  LUMO = 1.03387896118957
  mo_energy =
[-1.18574592e+02 -1.23042314e+01 -9.55697785e+00 -9.55697785e+00
 -9.55697785e+00 -1.24908176e+00 -5.75007917e-01 -5.75007917e-01
 -5.75007917e-01  1.03387896e+00  1.03387896e+00  1.03387896e+00
  7.40403014e+00  7.40403014e+00  7.40403014e+00  9.34923875e+00
  3.37091046e+01  3.37091046e+01  3.37091046e+01  1.05789990e+02
  1.29252651e+02  1.29252651e+02  1.29252651e+02  4.83534120e+02
  4.83534120e+02  4.83534120e+02  5.94938767e+02  1.33526261e+03
  1.33526261e+03  1.33526261e+03  2.66599150e+03  3.02935888e+03
  3.02935888e+03  3.02935888e+03  6.64969087e+03  6.64969087e+03
  6.64969087e+03  9.07105318e+03  2.54260372e+04  7.61676535e+04]
E1 = -728.3600946425606  E_coul = 201.65620408479015
Extra cycle  E= -526.70389055777  delta_E= -3.75e-12  |g|= 2.35e-06  |ddm|= 4.07e-06
    CPU time for scf_cycle      7.21 sec, wall time      0.54 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102425.36928767934
E1 = -728.3600946425606  E_coul = 201.65620408479015
init E= -526.70389055777
    CPU time for initialize scf     15.41 sec, wall time      0.79 sec
  HOMO = -0.575007202059273  LUMO = 1.03387949537085
  mo_energy =
[-1.18574588e+02 -1.23042285e+01 -9.55697488e+00 -9.55697488e+00
 -9.55697488e+00 -1.24908087e+00 -5.75007202e-01 -5.75007202e-01
 -5.75007202e-01  1.03387950e+00  1.03387950e+00  1.03387950e+00
  7.40403198e+00  7.40403198e+00  7.40403198e+00  9.34924102e+00
  3.37091075e+01  3.37091075e+01  3.37091075e+01  1.05789994e+02
  1.29252655e+02  1.29252655e+02  1.29252655e+02  4.83534124e+02
  4.83534124e+02  4.83534124e+02  5.94938772e+02  1.33526261e+03
  1.33526261e+03  1.33526261e+03  2.66599150e+03  3.02935889e+03
  3.02935889e+03  3.02935889e+03  6.64969087e+03  6.64969087e+03
  6.64969087e+03  9.07105319e+03  2.54260372e+04  7.61676535e+04]
E1 = -728.3600853305793  E_coul = 201.65619477280788
cycle= 1 E= -526.703890557771  delta_E= -9.09e-13  |g|= 6.04e-07  |ddm|= 9.37e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3600853305793  E_coul = 201.65619477280788
  HOMO = -0.575007360009605  LUMO = 1.03387937664082
  mo_energy =
[-1.18574589e+02 -1.23042292e+01 -9.55697558e+00 -9.55697558e+00
 -9.55697558e+00 -1.24908106e+00 -5.75007360e-01 -5.75007360e-01
 -5.75007360e-01  1.03387938e+00  1.03387938e+00  1.03387938e+00
  7.40403156e+00  7.40403156e+00  7.40403156e+00  9.34924050e+00
  3.37091068e+01  3.37091068e+01  3.37091068e+01  1.05789993e+02
  1.29252654e+02  1.29252654e+02  1.29252654e+02  4.83534123e+02
  4.83534123e+02  4.83534123e+02  5.94938771e+02  1.33526261e+03
  1.33526261e+03  1.33526261e+03  2.66599150e+03  3.02935889e+03
  3.02935889e+03  3.02935889e+03  6.64969087e+03  6.64969087e+03
  6.64969087e+03  9.07105319e+03  2.54260372e+04  7.61676535e+04]
E1 = -728.3600876038743  E_coul = 201.65619704610293
Extra cycle  E= -526.703890557771  delta_E= 1.14e-13  |g|= 1.52e-07  |ddm|= 2.19e-07
    CPU time for scf_cycle     15.53 sec, wall time      0.91 sec
exp = [2.61826593e+04 7.61751449e+03 3.61735456e+03 1.59767309e+03
 3.82708134e+02 1.10753745e+02 3.65973679e+01 7.77706751e+00
 3.06861607e+00 3.97965706e-01 1.36278437e+03 6.64734199e+02
 3.00907831e+02 3.13995578e+02 6.16666744e+01 7.39918165e+00
 2.01819855e+01 7.79093886e-01 2.85539132e+00 2.25456232e-01]
grad_E = [-1.53403614e-06  3.49296558e-06 -1.46824110e-06  7.60226016e-05
 -1.56193911e-04 -7.11630006e-04  6.68216139e-04 -1.38414378e-03
  2.35775790e-03 -3.84276089e-03 -5.37202254e-07  4.57960183e-06
  2.10446558e-05  1.81513979e-05  2.62923599e-04  4.12146735e-03
 -1.96879342e-03 -5.68500362e-03 -1.96416429e-03  2.59274745e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:58:48 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6597291        1
[INPUT] 0    0    [1    /1   ]  7617.51360822        1
[INPUT] 0    0    [1    /1   ]  3617.35499884        1
[INPUT] 0    0    [1    /1   ]  1597.65488566        1
[INPUT] 0    0    [1    /1   ]  382.69271501         1
[INPUT] 0    0    [1    /1   ]  111.086973775        1
[INPUT] 0    0    [1    /1   ]  36.7158559142        1
[INPUT] 0    0    [1    /1   ]  7.79662828508        1
[INPUT] 0    0    [1    /1   ]  3.07520425436        1
[INPUT] 0    0    [1    /1   ]  0.397975538785       1
[INPUT] 1    0    [1    /1   ]  1362.78450596        1
[INPUT] 1    0    [1    /1   ]  664.732849266        1
[INPUT] 1    0    [1    /1   ]  300.901477389        1
[INPUT] 1    0    [1    /1   ]  313.990099703        1
[INPUT] 1    0    [1    /1   ]  61.6642443096        1
[INPUT] 1    0    [1    /1   ]  7.34677869099        1
[INPUT] 1    0    [1    /1   ]  20.2233027924        1
[INPUT] 1    0    [1    /1   ]  0.775003248294       1
[INPUT] 1    0    [1    /1   ]  2.81031545271        1
[INPUT] 1    0    [1    /1   ]  0.224581734737       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.659729109393, 1.0]], [0, [7617.513608217312, 1.0]], [0, [3617.3549988447626, 1.0]], [0, [1597.654885655356, 1.0]], [0, [382.6927150101244, 1.0]], [0, [111.08697377482795, 1.0]], [0, [36.715855914180814, 1.0]], [0, [7.796628285083848, 1.0]], [0, [3.075204254364934, 1.0]], [0, [0.39797553878472247, 1.0]], [1, [1362.784505961068, 1.0]], [1, [664.7328492658776, 1.0]], [1, [300.9014773894941, 1.0]], [1, [313.990099702899, 1.0]], [1, [61.66424430962493, 1.0]], [1, [7.346778690992587, 1.0]], [1, [20.223302792364716, 1.0]], [1, [0.7750032482942675, 1.0]], [1, [2.8103154527146317, 1.0]], [1, [0.22458173473694346, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65972911]
bas 1, expnt(s) = [7617.51360822]
bas 2, expnt(s) = [3617.35499884]
bas 3, expnt(s) = [1597.65488566]
bas 4, expnt(s) = [382.69271501]
bas 5, expnt(s) = [111.08697377]
bas 6, expnt(s) = [36.71585591]
bas 7, expnt(s) = [7.79662829]
bas 8, expnt(s) = [3.07520425]
bas 9, expnt(s) = [0.39797554]
bas 10, expnt(s) = [1362.78450596]
bas 11, expnt(s) = [664.73284927]
bas 12, expnt(s) = [300.90147739]
bas 13, expnt(s) = [313.9900997]
bas 14, expnt(s) = [61.66424431]
bas 15, expnt(s) = [7.34677869]
bas 16, expnt(s) = [20.22330279]
bas 17, expnt(s) = [0.77500325]
bas 18, expnt(s) = [2.81031545]
bas 19, expnt(s) = [0.22458173]
CPU time:      1218.78
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826597e+04 5.20026344e+03 7.61751361e+03 2.06003668e+03
 3.61735500e+03 1.17844244e+03 1.59765489e+03 6.38450532e+02
 3.82692715e+02 2.18601265e+02 1.11086974e+02 8.64494782e+01
 3.67158559e+01 3.76838500e+01 7.79662829e+00 1.17881362e+01
 3.07520425e+00 5.86705959e+00 3.97975539e-01 1.26592305e+00
 1.36278451e+03 2.41556304e+04 6.64732849e+02 9.84675923e+03
 3.00901477e+02 3.65607244e+03 3.13990100e+02 3.85593173e+03
 6.16642443e+01 5.04110983e+02 7.34677869e+00 3.52862567e+01
 2.02233028e+01 1.25112153e+02 7.75003248e-01 2.12135717e+00
 2.81031545e+00 1.06152012e+01 2.24581735e-01 4.51026888e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98291819364825
cond(S) = 102395.12249816289
E1 = -729.3785347649442  E_coul = 203.12163823543133
init E= -526.256896529513
    CPU time for initialize scf      6.94 sec, wall time      0.35 sec
  HOMO = -0.556925077495446  LUMO = 1.03806964689742
  mo_energy =
[-1.18332444e+02 -1.22080632e+01 -9.45157329e+00 -9.45157329e+00
 -9.45157329e+00 -1.22590825e+00 -5.56925077e-01 -5.56925077e-01
 -5.56925077e-01  1.03806965e+00  1.03806965e+00  1.03806965e+00
  7.35246623e+00  7.35246623e+00  7.35246623e+00  9.45747452e+00
  3.35459522e+01  3.35459522e+01  3.35459522e+01  1.06428767e+02
  1.29188456e+02  1.29188456e+02  1.29188456e+02  4.83613582e+02
  4.83613582e+02  4.83613582e+02  5.96580501e+02  1.33540803e+03
  1.33540803e+03  1.33540803e+03  2.66808469e+03  3.02956341e+03
  3.02956341e+03  3.02956341e+03  6.65000773e+03  6.65000773e+03
  6.65000773e+03  9.07319230e+03  2.54281819e+04  7.61697810e+04]
E1 = -727.9839531734103  E_coul = 201.28042319996138
cycle= 1 E= -526.703529973449  delta_E= -0.447  |g|= 0.184  |ddm|= 0.418
    CPU time for cycle= 1      0.10 sec, wall time      0.03 sec
diis-norm(errvec)=0.540906
diis-c [-0.29257892  1.        ]
  HOMO = -0.580967417610651  LUMO = 1.02231106008319
  mo_energy =
[-1.18625966e+02 -1.23312947e+01 -9.58504207e+00 -9.58504207e+00
 -9.58504207e+00 -1.25664995e+00 -5.80967418e-01 -5.80967418e-01
 -5.80967418e-01  1.02231106e+00  1.02231106e+00  1.02231106e+00
  7.27716847e+00  7.27716847e+00  7.27716847e+00  9.36946801e+00
  3.34067212e+01  3.34067212e+01  3.34067212e+01  1.06221343e+02
  1.28974936e+02  1.28974936e+02  1.28974936e+02  4.83321560e+02
  4.83321560e+02  4.83321560e+02  5.96249965e+02  1.33505987e+03
  1.33505987e+03  1.33505987e+03  2.66760258e+03  3.02914934e+03
  3.02914934e+03  3.02914934e+03  6.64948051e+03  6.64948051e+03
  6.64948051e+03  9.07258992e+03  2.54274854e+04  7.61689944e+04]
E1 = -728.4481073243163  E_coul = 201.7439835585827
cycle= 2 E= -526.704123765734  delta_E= -0.000594  |g|= 0.0335  |ddm|= 0.039
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0669315
diis-c [-0.00268877  0.07287459  0.92712541]
  HOMO = -0.574233493334984  LUMO = 1.0274084855158
  mo_energy =
[-1.18567191e+02 -1.23004221e+01 -9.55285435e+00 -9.55285435e+00
 -9.55285435e+00 -1.24810987e+00 -5.74233493e-01 -5.74233493e-01
 -5.74233493e-01  1.02740849e+00  1.02740849e+00  1.02740849e+00
  7.29566983e+00  7.29566983e+00  7.29566983e+00  9.39346860e+00
  3.34395339e+01  3.34395339e+01  3.34395339e+01  1.06269315e+02
  1.29022526e+02  1.29022526e+02  1.29022526e+02  4.83379585e+02
  4.83379585e+02  4.83379585e+02  5.96310302e+02  1.33512172e+03
  1.33512172e+03  1.33512172e+03  2.66766746e+03  3.02921326e+03
  3.02921326e+03  3.02921326e+03  6.64954598e+03  6.64954598e+03
  6.64954598e+03  9.07265610e+03  2.54275521e+04  7.61690613e+04]
E1 = -728.342782303638  E_coul = 201.6386236457406
cycle= 3 E= -526.704158657897  delta_E= -3.49e-05  |g|= 0.00487  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0105561
diis-c [-4.58702963e-07 -1.13355737e-03  1.31569820e-01  8.69563737e-01]
  HOMO = -0.575159098990278  LUMO = 1.02671915189431
  mo_energy =
[-1.18574817e+02 -1.23044959e+01 -9.55720499e+00 -9.55720499e+00
 -9.55720499e+00 -1.24922916e+00 -5.75159099e-01 -5.75159099e-01
 -5.75159099e-01  1.02671915e+00  1.02671915e+00  1.02671915e+00
  7.29314860e+00  7.29314860e+00  7.29314860e+00  9.39039251e+00
  3.34351309e+01  3.34351309e+01  3.34351309e+01  1.06263094e+02
  1.29016297e+02  1.29016297e+02  1.29016297e+02  4.83372056e+02
  4.83372056e+02  4.83372056e+02  5.96302445e+02  1.33511366e+03
  1.33511366e+03  1.33511366e+03  2.66765884e+03  3.02920486e+03
  3.02920486e+03  3.02920486e+03  6.64953723e+03  6.64953723e+03
  6.64953723e+03  9.07264716e+03  2.54275430e+04  7.61690521e+04]
E1 = -728.3571469176394  E_coul = 201.65298740076608
cycle= 4 E= -526.704159516873  delta_E= -8.59e-07  |g|= 6.24e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00012754
diis-c [-1.36165758e-09  6.62705861e-05 -9.25137313e-03 -7.21089195e-02
  1.08129402e+00]
  HOMO = -0.575146638218632  LUMO = 1.0267284439652
  mo_energy =
[-1.18574822e+02 -1.23044668e+01 -9.55718785e+00 -9.55718785e+00
 -9.55718785e+00 -1.24920922e+00 -5.75146638e-01 -5.75146638e-01
 -5.75146638e-01  1.02672844e+00  1.02672844e+00  1.02672844e+00
  7.29316954e+00  7.29316954e+00  7.29316954e+00  9.39042905e+00
  3.34351469e+01  3.34351469e+01  3.34351469e+01  1.06263105e+02
  1.29016304e+02  1.29016304e+02  1.29016304e+02  4.83372052e+02
  4.83372052e+02  4.83372052e+02  5.96302433e+02  1.33511365e+03
  1.33511365e+03  1.33511365e+03  2.66765880e+03  3.02920483e+03
  3.02920483e+03  3.02920483e+03  6.64953719e+03  6.64953719e+03
  6.64953719e+03  9.07264711e+03  2.54275429e+04  7.61690520e+04]
E1 = -728.357148134402  E_coul = 201.65298861740018
cycle= 5 E= -526.704159517002  delta_E= -1.28e-10  |g|= 7.94e-06  |ddm|= 2.66e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.357148134402  E_coul = 201.65298861740018
  HOMO = -0.575150151520294  LUMO = 1.02672587045351
  mo_energy =
[-1.18574840e+02 -1.23044792e+01 -9.55720089e+00 -9.55720089e+00
 -9.55720089e+00 -1.24921352e+00 -5.75150152e-01 -5.75150152e-01
 -5.75150152e-01  1.02672587e+00  1.02672587e+00  1.02672587e+00
  7.29316100e+00  7.29316100e+00  7.29316100e+00  9.39041910e+00
  3.34351340e+01  3.34351340e+01  3.34351340e+01  1.06263090e+02
  1.29016288e+02  1.29016288e+02  1.29016288e+02  4.83372034e+02
  4.83372034e+02  4.83372034e+02  5.96302416e+02  1.33511363e+03
  1.33511363e+03  1.33511363e+03  2.66765878e+03  3.02920482e+03
  3.02920482e+03  3.02920482e+03  6.64953717e+03  6.64953717e+03
  6.64953717e+03  9.07264709e+03  2.54275429e+04  7.61690520e+04]
E1 = -728.3571873724717  E_coul = 201.65302785546587
Extra cycle  E= -526.704159517006  delta_E= -3.98e-12  |g|= 2.35e-06  |ddm|= 4.07e-06
    CPU time for scf_cycle      7.20 sec, wall time      0.53 sec
exp = [2.61826597e+04 7.61751361e+03 3.61735500e+03 1.59765489e+03
 3.82692715e+02 1.11086974e+02 3.67158559e+01 7.79662829e+00
 3.07520425e+00 3.97975539e-01 1.36278451e+03 6.64732849e+02
 3.00901477e+02 3.13990100e+02 6.16642443e+01 7.34677869e+00
 2.02233028e+01 7.75003248e-01 2.81031545e+00 2.24581735e-01]
E = -526.7041595170058
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:58:49 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6597291        1
[INPUT] 0    0    [1    /1   ]  7617.51360822        1
[INPUT] 0    0    [1    /1   ]  3617.35499884        1
[INPUT] 0    0    [1    /1   ]  1597.65488566        1
[INPUT] 0    0    [1    /1   ]  382.69271501         1
[INPUT] 0    0    [1    /1   ]  111.086973775        1
[INPUT] 0    0    [1    /1   ]  36.7158559142        1
[INPUT] 0    0    [1    /1   ]  7.79662828508        1
[INPUT] 0    0    [1    /1   ]  3.07520425436        1
[INPUT] 0    0    [1    /1   ]  0.397975538785       1
[INPUT] 1    0    [1    /1   ]  1362.78450596        1
[INPUT] 1    0    [1    /1   ]  664.732849266        1
[INPUT] 1    0    [1    /1   ]  300.901477389        1
[INPUT] 1    0    [1    /1   ]  313.990099703        1
[INPUT] 1    0    [1    /1   ]  61.6642443096        1
[INPUT] 1    0    [1    /1   ]  7.34677869099        1
[INPUT] 1    0    [1    /1   ]  20.2233027924        1
[INPUT] 1    0    [1    /1   ]  0.775003248294       1
[INPUT] 1    0    [1    /1   ]  2.81031545271        1
[INPUT] 1    0    [1    /1   ]  0.224581734737       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.659729109393, 1.0]], [0, [7617.513608217312, 1.0]], [0, [3617.3549988447626, 1.0]], [0, [1597.654885655356, 1.0]], [0, [382.6927150101244, 1.0]], [0, [111.08697377482795, 1.0]], [0, [36.715855914180814, 1.0]], [0, [7.796628285083848, 1.0]], [0, [3.075204254364934, 1.0]], [0, [0.39797553878472247, 1.0]], [1, [1362.784505961068, 1.0]], [1, [664.7328492658776, 1.0]], [1, [300.9014773894941, 1.0]], [1, [313.990099702899, 1.0]], [1, [61.66424430962493, 1.0]], [1, [7.346778690992587, 1.0]], [1, [20.223302792364716, 1.0]], [1, [0.7750032482942675, 1.0]], [1, [2.8103154527146317, 1.0]], [1, [0.22458173473694346, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65972911]
bas 1, expnt(s) = [7617.51360822]
bas 2, expnt(s) = [3617.35499884]
bas 3, expnt(s) = [1597.65488566]
bas 4, expnt(s) = [382.69271501]
bas 5, expnt(s) = [111.08697377]
bas 6, expnt(s) = [36.71585591]
bas 7, expnt(s) = [7.79662829]
bas 8, expnt(s) = [3.07520425]
bas 9, expnt(s) = [0.39797554]
bas 10, expnt(s) = [1362.78450596]
bas 11, expnt(s) = [664.73284927]
bas 12, expnt(s) = [300.90147739]
bas 13, expnt(s) = [313.9900997]
bas 14, expnt(s) = [61.66424431]
bas 15, expnt(s) = [7.34677869]
bas 16, expnt(s) = [20.22330279]
bas 17, expnt(s) = [0.77500325]
bas 18, expnt(s) = [2.81031545]
bas 19, expnt(s) = [0.22458173]
CPU time:      1226.12
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826597e+04 5.20026344e+03 7.61751361e+03 2.06003668e+03
 3.61735500e+03 1.17844244e+03 1.59765489e+03 6.38450532e+02
 3.82692715e+02 2.18601265e+02 1.11086974e+02 8.64494782e+01
 3.67158559e+01 3.76838500e+01 7.79662829e+00 1.17881362e+01
 3.07520425e+00 5.86705959e+00 3.97975539e-01 1.26592305e+00
 1.36278451e+03 2.41556304e+04 6.64732849e+02 9.84675923e+03
 3.00901477e+02 3.65607244e+03 3.13990100e+02 3.85593173e+03
 6.16642443e+01 5.04110983e+02 7.34677869e+00 3.52862567e+01
 2.02233028e+01 1.25112153e+02 7.75003248e-01 2.12135717e+00
 2.81031545e+00 1.06152012e+01 2.24581735e-01 4.51026888e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98291819364825
cond(S) = 102395.12249816289
E1 = -729.3785347649442  E_coul = 203.12163823543133
init E= -526.256896529513
    CPU time for initialize scf      7.24 sec, wall time      0.35 sec
  HOMO = -0.556925077495446  LUMO = 1.03806964689742
  mo_energy =
[-1.18332444e+02 -1.22080632e+01 -9.45157329e+00 -9.45157329e+00
 -9.45157329e+00 -1.22590825e+00 -5.56925077e-01 -5.56925077e-01
 -5.56925077e-01  1.03806965e+00  1.03806965e+00  1.03806965e+00
  7.35246623e+00  7.35246623e+00  7.35246623e+00  9.45747452e+00
  3.35459522e+01  3.35459522e+01  3.35459522e+01  1.06428767e+02
  1.29188456e+02  1.29188456e+02  1.29188456e+02  4.83613582e+02
  4.83613582e+02  4.83613582e+02  5.96580501e+02  1.33540803e+03
  1.33540803e+03  1.33540803e+03  2.66808469e+03  3.02956341e+03
  3.02956341e+03  3.02956341e+03  6.65000773e+03  6.65000773e+03
  6.65000773e+03  9.07319230e+03  2.54281819e+04  7.61697810e+04]
E1 = -727.9839531734103  E_coul = 201.28042319996138
cycle= 1 E= -526.703529973449  delta_E= -0.447  |g|= 0.184  |ddm|= 0.418
    CPU time for cycle= 1      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.540906
diis-c [-0.29257892  1.        ]
  HOMO = -0.580967417610651  LUMO = 1.02231106008319
  mo_energy =
[-1.18625966e+02 -1.23312947e+01 -9.58504207e+00 -9.58504207e+00
 -9.58504207e+00 -1.25664995e+00 -5.80967418e-01 -5.80967418e-01
 -5.80967418e-01  1.02231106e+00  1.02231106e+00  1.02231106e+00
  7.27716847e+00  7.27716847e+00  7.27716847e+00  9.36946801e+00
  3.34067212e+01  3.34067212e+01  3.34067212e+01  1.06221343e+02
  1.28974936e+02  1.28974936e+02  1.28974936e+02  4.83321560e+02
  4.83321560e+02  4.83321560e+02  5.96249965e+02  1.33505987e+03
  1.33505987e+03  1.33505987e+03  2.66760258e+03  3.02914934e+03
  3.02914934e+03  3.02914934e+03  6.64948051e+03  6.64948051e+03
  6.64948051e+03  9.07258992e+03  2.54274854e+04  7.61689944e+04]
E1 = -728.4481073243163  E_coul = 201.7439835585827
cycle= 2 E= -526.704123765734  delta_E= -0.000594  |g|= 0.0335  |ddm|= 0.039
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0669315
diis-c [-0.00268877  0.07287459  0.92712541]
  HOMO = -0.574233493334984  LUMO = 1.0274084855158
  mo_energy =
[-1.18567191e+02 -1.23004221e+01 -9.55285435e+00 -9.55285435e+00
 -9.55285435e+00 -1.24810987e+00 -5.74233493e-01 -5.74233493e-01
 -5.74233493e-01  1.02740849e+00  1.02740849e+00  1.02740849e+00
  7.29566983e+00  7.29566983e+00  7.29566983e+00  9.39346860e+00
  3.34395339e+01  3.34395339e+01  3.34395339e+01  1.06269315e+02
  1.29022526e+02  1.29022526e+02  1.29022526e+02  4.83379585e+02
  4.83379585e+02  4.83379585e+02  5.96310302e+02  1.33512172e+03
  1.33512172e+03  1.33512172e+03  2.66766746e+03  3.02921326e+03
  3.02921326e+03  3.02921326e+03  6.64954598e+03  6.64954598e+03
  6.64954598e+03  9.07265610e+03  2.54275521e+04  7.61690613e+04]
E1 = -728.342782303638  E_coul = 201.6386236457406
cycle= 3 E= -526.704158657897  delta_E= -3.49e-05  |g|= 0.00487  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0105561
diis-c [-4.58702963e-07 -1.13355737e-03  1.31569820e-01  8.69563737e-01]
  HOMO = -0.575159098990278  LUMO = 1.02671915189431
  mo_energy =
[-1.18574817e+02 -1.23044959e+01 -9.55720499e+00 -9.55720499e+00
 -9.55720499e+00 -1.24922916e+00 -5.75159099e-01 -5.75159099e-01
 -5.75159099e-01  1.02671915e+00  1.02671915e+00  1.02671915e+00
  7.29314860e+00  7.29314860e+00  7.29314860e+00  9.39039251e+00
  3.34351309e+01  3.34351309e+01  3.34351309e+01  1.06263094e+02
  1.29016297e+02  1.29016297e+02  1.29016297e+02  4.83372056e+02
  4.83372056e+02  4.83372056e+02  5.96302445e+02  1.33511366e+03
  1.33511366e+03  1.33511366e+03  2.66765884e+03  3.02920486e+03
  3.02920486e+03  3.02920486e+03  6.64953723e+03  6.64953723e+03
  6.64953723e+03  9.07264716e+03  2.54275430e+04  7.61690521e+04]
E1 = -728.3571469176394  E_coul = 201.65298740076608
cycle= 4 E= -526.704159516873  delta_E= -8.59e-07  |g|= 6.24e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00012754
diis-c [-1.36165758e-09  6.62705861e-05 -9.25137313e-03 -7.21089195e-02
  1.08129402e+00]
  HOMO = -0.575146638218632  LUMO = 1.0267284439652
  mo_energy =
[-1.18574822e+02 -1.23044668e+01 -9.55718785e+00 -9.55718785e+00
 -9.55718785e+00 -1.24920922e+00 -5.75146638e-01 -5.75146638e-01
 -5.75146638e-01  1.02672844e+00  1.02672844e+00  1.02672844e+00
  7.29316954e+00  7.29316954e+00  7.29316954e+00  9.39042905e+00
  3.34351469e+01  3.34351469e+01  3.34351469e+01  1.06263105e+02
  1.29016304e+02  1.29016304e+02  1.29016304e+02  4.83372052e+02
  4.83372052e+02  4.83372052e+02  5.96302433e+02  1.33511365e+03
  1.33511365e+03  1.33511365e+03  2.66765880e+03  3.02920483e+03
  3.02920483e+03  3.02920483e+03  6.64953719e+03  6.64953719e+03
  6.64953719e+03  9.07264711e+03  2.54275429e+04  7.61690520e+04]
E1 = -728.357148134402  E_coul = 201.65298861740018
cycle= 5 E= -526.704159517002  delta_E= -1.28e-10  |g|= 7.94e-06  |ddm|= 2.66e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.357148134402  E_coul = 201.65298861740018
  HOMO = -0.575150151520294  LUMO = 1.02672587045351
  mo_energy =
[-1.18574840e+02 -1.23044792e+01 -9.55720089e+00 -9.55720089e+00
 -9.55720089e+00 -1.24921352e+00 -5.75150152e-01 -5.75150152e-01
 -5.75150152e-01  1.02672587e+00  1.02672587e+00  1.02672587e+00
  7.29316100e+00  7.29316100e+00  7.29316100e+00  9.39041910e+00
  3.34351340e+01  3.34351340e+01  3.34351340e+01  1.06263090e+02
  1.29016288e+02  1.29016288e+02  1.29016288e+02  4.83372034e+02
  4.83372034e+02  4.83372034e+02  5.96302416e+02  1.33511363e+03
  1.33511363e+03  1.33511363e+03  2.66765878e+03  3.02920482e+03
  3.02920482e+03  3.02920482e+03  6.64953717e+03  6.64953717e+03
  6.64953717e+03  9.07264709e+03  2.54275429e+04  7.61690520e+04]
E1 = -728.3571873724717  E_coul = 201.65302785546587
Extra cycle  E= -526.704159517006  delta_E= -3.98e-12  |g|= 2.35e-06  |ddm|= 4.07e-06
    CPU time for scf_cycle      7.47 sec, wall time      0.53 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102395.12249816289
E1 = -728.3571873724717  E_coul = 201.65302785546587
init E= -526.704159517006
    CPU time for initialize scf      4.06 sec, wall time      0.21 sec
  HOMO = -0.575149434947641  LUMO = 1.02672640184412
  mo_energy =
[-1.18574835e+02 -1.23044763e+01 -9.55719792e+00 -9.55719792e+00
 -9.55719792e+00 -1.24921262e+00 -5.75149435e-01 -5.75149435e-01
 -5.75149435e-01  1.02672640e+00  1.02672640e+00  1.02672640e+00
  7.29316283e+00  7.29316283e+00  7.29316283e+00  9.39042137e+00
  3.34351370e+01  3.34351370e+01  3.34351370e+01  1.06263094e+02
  1.29016292e+02  1.29016292e+02  1.29016292e+02  4.83372039e+02
  4.83372039e+02  4.83372039e+02  5.96302420e+02  1.33511364e+03
  1.33511364e+03  1.33511364e+03  2.66765879e+03  3.02920482e+03
  3.02920482e+03  3.02920482e+03  6.64953718e+03  6.64953718e+03
  6.64953718e+03  9.07264710e+03  2.54275429e+04  7.61690520e+04]
E1 = -728.3571780346148  E_coul = 201.65301851760898
cycle= 1 E= -526.704159517006  delta_E=    0  |g|= 6.05e-07  |ddm|= 9.37e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3571780346148  E_coul = 201.65301851760898
  HOMO = -0.575149593440938  LUMO = 1.02672628366278
  mo_energy =
[-1.18574836e+02 -1.23044770e+01 -9.55719863e+00 -9.55719863e+00
 -9.55719863e+00 -1.24921282e+00 -5.75149593e-01 -5.75149593e-01
 -5.75149593e-01  1.02672628e+00  1.02672628e+00  1.02672628e+00
  7.29316241e+00  7.29316241e+00  7.29316241e+00  9.39042085e+00
  3.34351363e+01  3.34351363e+01  3.34351363e+01  1.06263093e+02
  1.29016291e+02  1.29016291e+02  1.29016291e+02  4.83372038e+02
  4.83372038e+02  4.83372038e+02  5.96302419e+02  1.33511364e+03
  1.33511364e+03  1.33511364e+03  2.66765879e+03  3.02920482e+03
  3.02920482e+03  3.02920482e+03  6.64953718e+03  6.64953718e+03
  6.64953718e+03  9.07264710e+03  2.54275429e+04  7.61690520e+04]
E1 = -728.3571803160972  E_coul = 201.6530207990926
Extra cycle  E= -526.704159517005  delta_E= 1.14e-12  |g|= 1.52e-07  |ddm|= 2.2e-07
    CPU time for scf_cycle      4.17 sec, wall time      0.32 sec
exp = [2.61826597e+04 7.61751361e+03 3.61735500e+03 1.59765489e+03
 3.82692715e+02 1.11086974e+02 3.67158559e+01 7.79662829e+00
 3.07520425e+00 3.97975539e-01 1.36278451e+03 6.64732849e+02
 3.00901477e+02 3.13990100e+02 6.16642443e+01 7.34677869e+00
 2.02233028e+01 7.75003248e-01 2.81031545e+00 2.24581735e-01]
grad_E = [-1.53779290e-06  3.53595764e-06 -1.44049252e-06  7.76359790e-05
 -1.95445563e-04 -5.58371760e-04  5.98177795e-04 -1.26385036e-03
  2.24709647e-03 -4.10586189e-03 -5.20175630e-07  4.82818253e-06
  2.25496794e-05  1.94414816e-05  9.17404977e-05  2.70195045e-03
 -8.55105227e-04 -5.96550106e-03 -3.14544136e-03  2.70596151e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:58:53 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6603258        1
[INPUT] 0    0    [1    /1   ]  7617.51232911        1
[INPUT] 0    0    [1    /1   ]  3617.35563592        1
[INPUT] 0    0    [1    /1   ]  1597.62860622        1
[INPUT] 0    0    [1    /1   ]  382.665903182        1
[INPUT] 0    0    [1    /1   ]  111.592113025        1
[INPUT] 0    0    [1    /1   ]  36.8643168983        1
[INPUT] 0    0    [1    /1   ]  7.85692519025        1
[INPUT] 0    0    [1    /1   ]  3.08882224615        1
[INPUT] 0    0    [1    /1   ]  0.398204365655       1
[INPUT] 1    0    [1    /1   ]  1362.78470658        1
[INPUT] 1    0    [1    /1   ]  664.730878834        1
[INPUT] 1    0    [1    /1   ]  300.892192614        1
[INPUT] 1    0    [1    /1   ]  313.982094433        1
[INPUT] 1    0    [1    /1   ]  61.6668659716        1
[INPUT] 1    0    [1    /1   ]  7.3178827509         1
[INPUT] 1    0    [1    /1   ]  20.2445212199        1
[INPUT] 1    0    [1    /1   ]  0.772660823426       1
[INPUT] 1    0    [1    /1   ]  2.79260072454        1
[INPUT] 1    0    [1    /1   ]  0.223658849113       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.66032582157, 1.0]], [0, [7617.5123291120235, 1.0]], [0, [3617.355635916305, 1.0]], [0, [1597.6286062166891, 1.0]], [0, [382.6659031817091, 1.0]], [0, [111.59211302536221, 1.0]], [0, [36.86431689829739, 1.0]], [0, [7.856925190247954, 1.0]], [0, [3.0888222461549333, 1.0]], [0, [0.3982043656552181, 1.0]], [1, [1362.7847065815945, 1.0]], [1, [664.7308788344096, 1.0]], [1, [300.89219261369954, 1.0]], [1, [313.98209443266484, 1.0]], [1, [61.6668659715613, 1.0]], [1, [7.317882750898351, 1.0]], [1, [20.24452121988532, 1.0]], [1, [0.7726608234263783, 1.0]], [1, [2.7926007245386386, 1.0]], [1, [0.22365884911293532, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66032582]
bas 1, expnt(s) = [7617.51232911]
bas 2, expnt(s) = [3617.35563592]
bas 3, expnt(s) = [1597.62860622]
bas 4, expnt(s) = [382.66590318]
bas 5, expnt(s) = [111.59211303]
bas 6, expnt(s) = [36.8643169]
bas 7, expnt(s) = [7.85692519]
bas 8, expnt(s) = [3.08882225]
bas 9, expnt(s) = [0.39820437]
bas 10, expnt(s) = [1362.78470658]
bas 11, expnt(s) = [664.73087883]
bas 12, expnt(s) = [300.89219261]
bas 13, expnt(s) = [313.98209443]
bas 14, expnt(s) = [61.66686597]
bas 15, expnt(s) = [7.31788275]
bas 16, expnt(s) = [20.24452122]
bas 17, expnt(s) = [0.77266082]
bas 18, expnt(s) = [2.79260072]
bas 19, expnt(s) = [0.22365885]
CPU time:      1242.54
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826603e+04 5.20026353e+03 7.61751233e+03 2.06003642e+03
 3.61735564e+03 1.17844259e+03 1.59762861e+03 6.38442656e+02
 3.82665903e+02 2.18589778e+02 1.11592113e+02 8.67441409e+01
 3.68643169e+01 3.77980737e+01 7.85692519e+00 1.18564449e+01
 3.08882225e+00 5.88653474e+00 3.98204366e-01 1.26646892e+00
 1.36278471e+03 2.41556349e+04 6.64730879e+02 9.84672274e+03
 3.00892193e+02 3.65593143e+03 3.13982094e+02 3.85580884e+03
 6.16668660e+01 5.04137774e+02 7.31788275e+00 3.51128597e+01
 2.02445212e+01 1.25276260e+02 7.72660823e-01 2.11334552e+00
 2.79260072e+00 1.05316265e+01 2.23658849e-01 4.48711293e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.983005215878404
cond(S) = 102401.38036187769
E1 = -729.3802473258735  E_coul = 203.12222698837525
init E= -526.258020337498
    CPU time for initialize scf      0.64 sec, wall time      0.05 sec
  HOMO = -0.556947137272934  LUMO = 1.03241065286908
  mo_energy =
[-1.18332484e+02 -1.22079992e+01 -9.45150479e+00 -9.45150479e+00
 -9.45150479e+00 -1.22588137e+00 -5.56947137e-01 -5.56947137e-01
 -5.56947137e-01  1.03241065e+00  1.03241065e+00  1.03241065e+00
  7.30129798e+00  7.30129798e+00  7.30129798e+00  9.56205548e+00
  3.34175237e+01  3.34175237e+01  3.34175237e+01  1.07227608e+02
  1.29080632e+02  1.29080632e+02  1.29080632e+02  4.83544620e+02
  4.83544620e+02  4.83544620e+02  5.98662926e+02  1.33533496e+03
  1.33533496e+03  1.33533496e+03  2.67060584e+03  3.02947144e+03
  3.02947144e+03  3.02947144e+03  6.64990419e+03  6.64990419e+03
  6.64990419e+03  9.07559944e+03  2.54304560e+04  7.61718935e+04]
E1 = -727.9769043477746  E_coul = 201.27318471156286
cycle= 1 E= -526.703719636212  delta_E= -0.446  |g|= 0.184  |ddm|= 0.415
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.541293
diis-c [-0.29299791  1.        ]
  HOMO = -0.581254679006591  LUMO = 1.0165462536943
  mo_energy =
[-1.18626509e+02 -1.23317843e+01 -9.58554315e+00 -9.58554315e+00
 -9.58554315e+00 -1.25696898e+00 -5.81254679e-01 -5.81254679e-01
 -5.81254679e-01  1.01654625e+00  1.01654625e+00  1.01654625e+00
  7.22585426e+00  7.22585426e+00  7.22585426e+00  9.47309683e+00
  3.32777644e+01  3.32777644e+01  3.32777644e+01  1.07019073e+02
  1.28866510e+02  1.28866510e+02  1.28866510e+02  4.83252035e+02
  4.83252035e+02  4.83252035e+02  5.98331756e+02  1.33498628e+03
  1.33498628e+03  1.33498628e+03  2.67012345e+03  3.02905699e+03
  3.02905699e+03  3.02905699e+03  6.64937668e+03  6.64937668e+03
  6.64937668e+03  9.07499683e+03  2.54297594e+04  7.61711067e+04]
E1 = -728.4427772636989  E_coul = 201.73846080714523
cycle= 2 E= -526.704316456554  delta_E= -0.000597  |g|= 0.0336  |ddm|= 0.039
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0670698
diis-c [-0.00270102  0.07294542  0.92705458]
  HOMO = -0.574490797015215  LUMO = 1.02164065652768
  mo_energy =
[-1.18567555e+02 -1.23007945e+01 -9.55323765e+00 -9.55323765e+00
 -9.55323765e+00 -1.24838841e+00 -5.74490797e-01 -5.74490797e-01
 -5.74490797e-01  1.02164066e+00  1.02164066e+00  1.02164066e+00
  7.24436287e+00  7.24436287e+00  7.24436287e+00  9.49730097e+00
  3.33106854e+01  3.33106854e+01  3.33106854e+01  1.07067261e+02
  1.28914263e+02  1.28914263e+02  1.28914263e+02  4.83310237e+02
  4.83310237e+02  4.83310237e+02  5.98392281e+02  1.33504831e+03
  1.33504831e+03  1.33504831e+03  2.67018852e+03  3.02912109e+03
  3.02912109e+03  3.02912109e+03  6.64944234e+03  6.64944234e+03
  6.64944234e+03  9.07506321e+03  2.54298262e+04  7.61711738e+04]
E1 = -728.3369991246037  E_coul = 201.63264753362816
cycle= 3 E= -526.704351590976  delta_E= -3.51e-05  |g|= 0.00488  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.010579
diis-c [-4.57569335e-07 -1.13081476e-03  1.31603331e-01  8.69527483e-01]
  HOMO = -0.575422015984884  LUMO = 1.02095050368355
  mo_energy =
[-1.18575207e+02 -1.23048845e+01 -9.55760480e+00 -9.55760480e+00
 -9.55760480e+00 -1.24951550e+00 -5.75422016e-01 -5.75422016e-01
 -5.75422016e-01  1.02095050e+00  1.02095050e+00  1.02095050e+00
  7.24183896e+00  7.24183896e+00  7.24183896e+00  9.49419595e+00
  3.33062667e+01  3.33062667e+01  3.33062667e+01  1.07061010e+02
  1.28908011e+02  1.28908011e+02  1.28908011e+02  4.83302684e+02
  4.83302684e+02  4.83302684e+02  5.98384396e+02  1.33504023e+03
  1.33504023e+03  1.33504023e+03  2.67017987e+03  3.02911267e+03
  3.02911267e+03  3.02911267e+03  6.64943356e+03  6.64943356e+03
  6.64943356e+03  9.07505423e+03  2.54298171e+04  7.61711646e+04]
E1 = -728.3514235085188  E_coul = 201.64707105235465
cycle= 4 E= -526.704352456164  delta_E= -8.65e-07  |g|= 6.2e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000127429
diis-c [-1.36482808e-09  6.60466693e-05 -9.22429444e-03 -7.18877793e-02
  1.08104603e+00]
  HOMO = -0.575409715098721  LUMO = 1.02095963309319
  mo_energy =
[-1.18575212e+02 -1.23048556e+01 -9.55758788e+00 -9.55758788e+00
 -9.55758788e+00 -1.24949581e+00 -5.75409715e-01 -5.75409715e-01
 -5.75409715e-01  1.02095963e+00  1.02095963e+00  1.02095963e+00
  7.24185964e+00  7.24185964e+00  7.24185964e+00  9.49423209e+00
  3.33062823e+01  3.33062823e+01  3.33062823e+01  1.07061021e+02
  1.28908018e+02  1.28908018e+02  1.28908018e+02  4.83302679e+02
  4.83302679e+02  4.83302679e+02  5.98384384e+02  1.33504022e+03
  1.33504022e+03  1.33504022e+03  2.67017983e+03  3.02911264e+03
  3.02911264e+03  3.02911264e+03  6.64943352e+03  6.64943352e+03
  6.64943352e+03  9.07505419e+03  2.54298170e+04  7.61711645e+04]
E1 = -728.3514247343231  E_coul = 201.64707227803473
cycle= 5 E= -526.704352456288  delta_E= -1.24e-10  |g|= 7.93e-06  |ddm|= 2.6e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3514247343231  E_coul = 201.64707227803473
  HOMO = -0.575413231401489  LUMO = 1.0209570691029
  mo_energy =
[-1.18575230e+02 -1.23048680e+01 -9.55760092e+00 -9.55760092e+00
 -9.55760092e+00 -1.24950012e+00 -5.75413231e-01 -5.75413231e-01
 -5.75413231e-01  1.02095707e+00  1.02095707e+00  1.02095707e+00
  7.24185112e+00  7.24185112e+00  7.24185112e+00  9.49422210e+00
  3.33062695e+01  3.33062695e+01  3.33062695e+01  1.07061005e+02
  1.28908002e+02  1.28908002e+02  1.28908002e+02  4.83302661e+02
  4.83302661e+02  4.83302661e+02  5.98384367e+02  1.33504020e+03
  1.33504020e+03  1.33504020e+03  2.67017982e+03  3.02911262e+03
  3.02911262e+03  3.02911262e+03  6.64943350e+03  6.64943350e+03
  6.64943350e+03  9.07505417e+03  2.54298170e+04  7.61711645e+04]
E1 = -728.3514639666713  E_coul = 201.64711151037895
Extra cycle  E= -526.704352456292  delta_E= -3.87e-12  |g|= 2.35e-06  |ddm|= 4.06e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.23 sec
exp = [2.61826603e+04 7.61751233e+03 3.61735564e+03 1.59762861e+03
 3.82665903e+02 1.11592113e+02 3.68643169e+01 7.85692519e+00
 3.08882225e+00 3.98204366e-01 1.36278471e+03 6.64730879e+02
 3.00892193e+02 3.13982094e+02 6.16668660e+01 7.31788275e+00
 2.02445212e+01 7.72660823e-01 2.79260072e+00 2.23658849e-01]
E = -526.7043524562923
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:58:53 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6603258        1
[INPUT] 0    0    [1    /1   ]  7617.51232911        1
[INPUT] 0    0    [1    /1   ]  3617.35563592        1
[INPUT] 0    0    [1    /1   ]  1597.62860622        1
[INPUT] 0    0    [1    /1   ]  382.665903182        1
[INPUT] 0    0    [1    /1   ]  111.592113025        1
[INPUT] 0    0    [1    /1   ]  36.8643168983        1
[INPUT] 0    0    [1    /1   ]  7.85692519025        1
[INPUT] 0    0    [1    /1   ]  3.08882224615        1
[INPUT] 0    0    [1    /1   ]  0.398204365655       1
[INPUT] 1    0    [1    /1   ]  1362.78470658        1
[INPUT] 1    0    [1    /1   ]  664.730878834        1
[INPUT] 1    0    [1    /1   ]  300.892192614        1
[INPUT] 1    0    [1    /1   ]  313.982094433        1
[INPUT] 1    0    [1    /1   ]  61.6668659716        1
[INPUT] 1    0    [1    /1   ]  7.3178827509         1
[INPUT] 1    0    [1    /1   ]  20.2445212199        1
[INPUT] 1    0    [1    /1   ]  0.772660823426       1
[INPUT] 1    0    [1    /1   ]  2.79260072454        1
[INPUT] 1    0    [1    /1   ]  0.223658849113       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.66032582157, 1.0]], [0, [7617.5123291120235, 1.0]], [0, [3617.355635916305, 1.0]], [0, [1597.6286062166891, 1.0]], [0, [382.6659031817091, 1.0]], [0, [111.59211302536221, 1.0]], [0, [36.86431689829739, 1.0]], [0, [7.856925190247954, 1.0]], [0, [3.0888222461549333, 1.0]], [0, [0.3982043656552181, 1.0]], [1, [1362.7847065815945, 1.0]], [1, [664.7308788344096, 1.0]], [1, [300.89219261369954, 1.0]], [1, [313.98209443266484, 1.0]], [1, [61.6668659715613, 1.0]], [1, [7.317882750898351, 1.0]], [1, [20.24452121988532, 1.0]], [1, [0.7726608234263783, 1.0]], [1, [2.7926007245386386, 1.0]], [1, [0.22365884911293532, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66032582]
bas 1, expnt(s) = [7617.51232911]
bas 2, expnt(s) = [3617.35563592]
bas 3, expnt(s) = [1597.62860622]
bas 4, expnt(s) = [382.66590318]
bas 5, expnt(s) = [111.59211303]
bas 6, expnt(s) = [36.8643169]
bas 7, expnt(s) = [7.85692519]
bas 8, expnt(s) = [3.08882225]
bas 9, expnt(s) = [0.39820437]
bas 10, expnt(s) = [1362.78470658]
bas 11, expnt(s) = [664.73087883]
bas 12, expnt(s) = [300.89219261]
bas 13, expnt(s) = [313.98209443]
bas 14, expnt(s) = [61.66686597]
bas 15, expnt(s) = [7.31788275]
bas 16, expnt(s) = [20.24452122]
bas 17, expnt(s) = [0.77266082]
bas 18, expnt(s) = [2.79260072]
bas 19, expnt(s) = [0.22365885]
CPU time:      1243.52
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826603e+04 5.20026353e+03 7.61751233e+03 2.06003642e+03
 3.61735564e+03 1.17844259e+03 1.59762861e+03 6.38442656e+02
 3.82665903e+02 2.18589778e+02 1.11592113e+02 8.67441409e+01
 3.68643169e+01 3.77980737e+01 7.85692519e+00 1.18564449e+01
 3.08882225e+00 5.88653474e+00 3.98204366e-01 1.26646892e+00
 1.36278471e+03 2.41556349e+04 6.64730879e+02 9.84672274e+03
 3.00892193e+02 3.65593143e+03 3.13982094e+02 3.85580884e+03
 6.16668660e+01 5.04137774e+02 7.31788275e+00 3.51128597e+01
 2.02445212e+01 1.25276260e+02 7.72660823e-01 2.11334552e+00
 2.79260072e+00 1.05316265e+01 2.23658849e-01 4.48711293e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.983005215878404
cond(S) = 102401.38036187769
E1 = -729.3802473258735  E_coul = 203.12222698837525
init E= -526.258020337498
    CPU time for initialize scf      0.63 sec, wall time      0.05 sec
  HOMO = -0.556947137272934  LUMO = 1.03241065286908
  mo_energy =
[-1.18332484e+02 -1.22079992e+01 -9.45150479e+00 -9.45150479e+00
 -9.45150479e+00 -1.22588137e+00 -5.56947137e-01 -5.56947137e-01
 -5.56947137e-01  1.03241065e+00  1.03241065e+00  1.03241065e+00
  7.30129798e+00  7.30129798e+00  7.30129798e+00  9.56205548e+00
  3.34175237e+01  3.34175237e+01  3.34175237e+01  1.07227608e+02
  1.29080632e+02  1.29080632e+02  1.29080632e+02  4.83544620e+02
  4.83544620e+02  4.83544620e+02  5.98662926e+02  1.33533496e+03
  1.33533496e+03  1.33533496e+03  2.67060584e+03  3.02947144e+03
  3.02947144e+03  3.02947144e+03  6.64990419e+03  6.64990419e+03
  6.64990419e+03  9.07559944e+03  2.54304560e+04  7.61718935e+04]
E1 = -727.9769043477746  E_coul = 201.27318471156286
cycle= 1 E= -526.703719636212  delta_E= -0.446  |g|= 0.184  |ddm|= 0.415
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.541293
diis-c [-0.29299791  1.        ]
  HOMO = -0.581254679006591  LUMO = 1.0165462536943
  mo_energy =
[-1.18626509e+02 -1.23317843e+01 -9.58554315e+00 -9.58554315e+00
 -9.58554315e+00 -1.25696898e+00 -5.81254679e-01 -5.81254679e-01
 -5.81254679e-01  1.01654625e+00  1.01654625e+00  1.01654625e+00
  7.22585426e+00  7.22585426e+00  7.22585426e+00  9.47309683e+00
  3.32777644e+01  3.32777644e+01  3.32777644e+01  1.07019073e+02
  1.28866510e+02  1.28866510e+02  1.28866510e+02  4.83252035e+02
  4.83252035e+02  4.83252035e+02  5.98331756e+02  1.33498628e+03
  1.33498628e+03  1.33498628e+03  2.67012345e+03  3.02905699e+03
  3.02905699e+03  3.02905699e+03  6.64937668e+03  6.64937668e+03
  6.64937668e+03  9.07499683e+03  2.54297594e+04  7.61711067e+04]
E1 = -728.4427772636989  E_coul = 201.73846080714523
cycle= 2 E= -526.704316456554  delta_E= -0.000597  |g|= 0.0336  |ddm|= 0.039
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0670698
diis-c [-0.00270102  0.07294542  0.92705458]
  HOMO = -0.574490797015215  LUMO = 1.02164065652768
  mo_energy =
[-1.18567555e+02 -1.23007945e+01 -9.55323765e+00 -9.55323765e+00
 -9.55323765e+00 -1.24838841e+00 -5.74490797e-01 -5.74490797e-01
 -5.74490797e-01  1.02164066e+00  1.02164066e+00  1.02164066e+00
  7.24436287e+00  7.24436287e+00  7.24436287e+00  9.49730097e+00
  3.33106854e+01  3.33106854e+01  3.33106854e+01  1.07067261e+02
  1.28914263e+02  1.28914263e+02  1.28914263e+02  4.83310237e+02
  4.83310237e+02  4.83310237e+02  5.98392281e+02  1.33504831e+03
  1.33504831e+03  1.33504831e+03  2.67018852e+03  3.02912109e+03
  3.02912109e+03  3.02912109e+03  6.64944234e+03  6.64944234e+03
  6.64944234e+03  9.07506321e+03  2.54298262e+04  7.61711738e+04]
E1 = -728.3369991246037  E_coul = 201.63264753362816
cycle= 3 E= -526.704351590976  delta_E= -3.51e-05  |g|= 0.00488  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.010579
diis-c [-4.57569335e-07 -1.13081476e-03  1.31603331e-01  8.69527483e-01]
  HOMO = -0.575422015984884  LUMO = 1.02095050368355
  mo_energy =
[-1.18575207e+02 -1.23048845e+01 -9.55760480e+00 -9.55760480e+00
 -9.55760480e+00 -1.24951550e+00 -5.75422016e-01 -5.75422016e-01
 -5.75422016e-01  1.02095050e+00  1.02095050e+00  1.02095050e+00
  7.24183896e+00  7.24183896e+00  7.24183896e+00  9.49419595e+00
  3.33062667e+01  3.33062667e+01  3.33062667e+01  1.07061010e+02
  1.28908011e+02  1.28908011e+02  1.28908011e+02  4.83302684e+02
  4.83302684e+02  4.83302684e+02  5.98384396e+02  1.33504023e+03
  1.33504023e+03  1.33504023e+03  2.67017987e+03  3.02911267e+03
  3.02911267e+03  3.02911267e+03  6.64943356e+03  6.64943356e+03
  6.64943356e+03  9.07505423e+03  2.54298171e+04  7.61711646e+04]
E1 = -728.3514235085188  E_coul = 201.64707105235465
cycle= 4 E= -526.704352456164  delta_E= -8.65e-07  |g|= 6.2e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000127429
diis-c [-1.36482808e-09  6.60466693e-05 -9.22429444e-03 -7.18877793e-02
  1.08104603e+00]
  HOMO = -0.575409715098721  LUMO = 1.02095963309319
  mo_energy =
[-1.18575212e+02 -1.23048556e+01 -9.55758788e+00 -9.55758788e+00
 -9.55758788e+00 -1.24949581e+00 -5.75409715e-01 -5.75409715e-01
 -5.75409715e-01  1.02095963e+00  1.02095963e+00  1.02095963e+00
  7.24185964e+00  7.24185964e+00  7.24185964e+00  9.49423209e+00
  3.33062823e+01  3.33062823e+01  3.33062823e+01  1.07061021e+02
  1.28908018e+02  1.28908018e+02  1.28908018e+02  4.83302679e+02
  4.83302679e+02  4.83302679e+02  5.98384384e+02  1.33504022e+03
  1.33504022e+03  1.33504022e+03  2.67017983e+03  3.02911264e+03
  3.02911264e+03  3.02911264e+03  6.64943352e+03  6.64943352e+03
  6.64943352e+03  9.07505419e+03  2.54298170e+04  7.61711645e+04]
E1 = -728.3514247343231  E_coul = 201.64707227803473
cycle= 5 E= -526.704352456288  delta_E= -1.24e-10  |g|= 7.93e-06  |ddm|= 2.6e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3514247343231  E_coul = 201.64707227803473
  HOMO = -0.575413231401489  LUMO = 1.0209570691029
  mo_energy =
[-1.18575230e+02 -1.23048680e+01 -9.55760092e+00 -9.55760092e+00
 -9.55760092e+00 -1.24950012e+00 -5.75413231e-01 -5.75413231e-01
 -5.75413231e-01  1.02095707e+00  1.02095707e+00  1.02095707e+00
  7.24185112e+00  7.24185112e+00  7.24185112e+00  9.49422210e+00
  3.33062695e+01  3.33062695e+01  3.33062695e+01  1.07061005e+02
  1.28908002e+02  1.28908002e+02  1.28908002e+02  4.83302661e+02
  4.83302661e+02  4.83302661e+02  5.98384367e+02  1.33504020e+03
  1.33504020e+03  1.33504020e+03  2.67017982e+03  3.02911262e+03
  3.02911262e+03  3.02911262e+03  6.64943350e+03  6.64943350e+03
  6.64943350e+03  9.07505417e+03  2.54298170e+04  7.61711645e+04]
E1 = -728.3514639666713  E_coul = 201.64711151037895
Extra cycle  E= -526.704352456292  delta_E= -3.87e-12  |g|= 2.35e-06  |ddm|= 4.06e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102401.38036187769
E1 = -728.3514639666713  E_coul = 201.64711151037895
init E= -526.704352456292
    CPU time for initialize scf      3.76 sec, wall time      0.20 sec
  HOMO = -0.575412514121576  LUMO = 1.02095759846254
  mo_energy =
[-1.18575225e+02 -1.23048651e+01 -9.55759794e+00 -9.55759794e+00
 -9.55759794e+00 -1.24949923e+00 -5.75412514e-01 -5.75412514e-01
 -5.75412514e-01  1.02095760e+00  1.02095760e+00  1.02095760e+00
  7.24185294e+00  7.24185294e+00  7.24185294e+00  9.49422439e+00
  3.33062725e+01  3.33062725e+01  3.33062725e+01  1.07061009e+02
  1.28908006e+02  1.28908006e+02  1.28908006e+02  4.83302666e+02
  4.83302666e+02  4.83302666e+02  5.98384371e+02  1.33504021e+03
  1.33504021e+03  1.33504021e+03  2.67017982e+03  3.02911263e+03
  3.02911263e+03  3.02911263e+03  6.64943351e+03  6.64943351e+03
  6.64943351e+03  9.07505417e+03  2.54298170e+04  7.61711645e+04]
E1 = -728.3514546232916  E_coul = 201.64710216699896
cycle= 1 E= -526.704352456293  delta_E= -3.41e-13  |g|= 6.05e-07  |ddm|= 9.35e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3514546232916  E_coul = 201.64710216699896
  HOMO = -0.575412672927712  LUMO = 1.02095748062151
  mo_energy =
[-1.18575226e+02 -1.23048658e+01 -9.55759865e+00 -9.55759865e+00
 -9.55759865e+00 -1.24949942e+00 -5.75412673e-01 -5.75412673e-01
 -5.75412673e-01  1.02095748e+00  1.02095748e+00  1.02095748e+00
  7.24185252e+00  7.24185252e+00  7.24185252e+00  9.49422386e+00
  3.33062718e+01  3.33062718e+01  3.33062718e+01  1.07061008e+02
  1.28908005e+02  1.28908005e+02  1.28908005e+02  4.83302665e+02
  4.83302665e+02  4.83302665e+02  5.98384370e+02  1.33504020e+03
  1.33504020e+03  1.33504020e+03  2.67017982e+03  3.02911263e+03
  3.02911263e+03  3.02911263e+03  6.64943351e+03  6.64943351e+03
  6.64943351e+03  9.07505417e+03  2.54298170e+04  7.61711645e+04]
E1 = -728.3514569070301  E_coul = 201.6471044507371
Extra cycle  E= -526.704352456293  delta_E= -3.41e-13  |g|= 1.52e-07  |ddm|= 2.19e-07
    CPU time for scf_cycle      3.87 sec, wall time      0.31 sec
exp = [2.61826603e+04 7.61751233e+03 3.61735564e+03 1.59762861e+03
 3.82665903e+02 1.11592113e+02 3.68643169e+01 7.85692519e+00
 3.08882225e+00 3.98204366e-01 1.36278471e+03 6.64730879e+02
 3.00892193e+02 3.13982094e+02 6.16668660e+01 7.31788275e+00
 2.02445212e+01 7.72660823e-01 2.79260072e+00 2.23658849e-01]
grad_E = [-1.54404676e-06  3.60835948e-06 -1.39196663e-06  8.03585491e-05
 -2.62528487e-04 -2.64328092e-04  3.17574893e-04 -6.69345498e-04
  1.24968942e-03 -2.59782133e-03 -5.09007875e-07  4.98545065e-06
  2.35062872e-05  2.02616402e-05 -1.96889762e-05  8.84804569e-04
 -1.89830577e-05 -3.68571154e-03 -2.29531100e-03  1.70446178e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:58:57 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6607057        1
[INPUT] 0    0    [1    /1   ]  7617.51151615        1
[INPUT] 0    0    [1    /1   ]  3617.35604259        1
[INPUT] 0    0    [1    /1   ]  1597.61193393        1
[INPUT] 0    0    [1    /1   ]  382.647052036        1
[INPUT] 0    0    [1    /1   ]  111.922526961        1
[INPUT] 0    0    [1    /1   ]  36.9486152358        1
[INPUT] 0    0    [1    /1   ]  7.90766204467        1
[INPUT] 0    0    [1    /1   ]  3.09889854612        1
[INPUT] 0    0    [1    /1   ]  0.39845087302        1
[INPUT] 1    0    [1    /1   ]  1362.78483407        1
[INPUT] 1    0    [1    /1   ]  664.729619546        1
[INPUT] 1    0    [1    /1   ]  300.886253164        1
[INPUT] 1    0    [1    /1   ]  313.976973582        1
[INPUT] 1    0    [1    /1   ]  61.6713727807        1
[INPUT] 1    0    [1    /1   ]  7.32155939491        1
[INPUT] 1    0    [1    /1   ]  20.2400738533        1
[INPUT] 1    0    [1    /1   ]  0.772670640089       1
[INPUT] 1    0    [1    /1   ]  2.80308949518        1
[INPUT] 1    0    [1    /1   ]  0.22315912169        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.660705723338, 1.0]], [0, [7617.511516146175, 1.0]], [0, [3617.356042589368, 1.0]], [0, [1597.6119339328031, 1.0]], [0, [382.64705203638215, 1.0]], [0, [111.92252696075082, 1.0]], [0, [36.94861523582964, 1.0]], [0, [7.907662044668682, 1.0]], [0, [3.098898546118817, 1.0]], [0, [0.3984508730200759, 1.0]], [1, [1362.784834065757, 1.0]], [1, [664.7296195463982, 1.0]], [1, [300.8862531635644, 1.0]], [1, [313.9769735816251, 1.0]], [1, [61.671372780700196, 1.0]], [1, [7.321559394906012, 1.0]], [1, [20.240073853258874, 1.0]], [1, [0.7726706400893358, 1.0]], [1, [2.803089495182604, 1.0]], [1, [0.22315912169048172, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66070572]
bas 1, expnt(s) = [7617.51151615]
bas 2, expnt(s) = [3617.35604259]
bas 3, expnt(s) = [1597.61193393]
bas 4, expnt(s) = [382.64705204]
bas 5, expnt(s) = [111.92252696]
bas 6, expnt(s) = [36.94861524]
bas 7, expnt(s) = [7.90766204]
bas 8, expnt(s) = [3.09889855]
bas 9, expnt(s) = [0.39845087]
bas 10, expnt(s) = [1362.78483407]
bas 11, expnt(s) = [664.72961955]
bas 12, expnt(s) = [300.88625316]
bas 13, expnt(s) = [313.97697358]
bas 14, expnt(s) = [61.67137278]
bas 15, expnt(s) = [7.32155939]
bas 16, expnt(s) = [20.24007385]
bas 17, expnt(s) = [0.77267064]
bas 18, expnt(s) = [2.8030895]
bas 19, expnt(s) = [0.22315912]
CPU time:      1252.98
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826607e+04 5.20026359e+03 7.61751152e+03 2.06003626e+03
 3.61735604e+03 1.17844269e+03 1.59761193e+03 6.38437659e+02
 3.82647052e+02 2.18581702e+02 1.11922527e+02 8.69367007e+01
 3.69486152e+01 3.78628804e+01 7.90766204e+00 1.19138218e+01
 3.09889855e+00 5.90093109e+00 3.98450873e-01 1.26705688e+00
 1.36278483e+03 2.41556377e+04 6.64729620e+02 9.84669943e+03
 3.00886253e+02 3.65584122e+03 3.13976974e+02 3.85573024e+03
 6.16713728e+01 5.04183829e+02 7.32155939e+00 3.51349128e+01
 2.02400739e+01 1.25241860e+02 7.72670640e-01 2.11337909e+00
 2.80308950e+00 1.05810946e+01 2.23159122e-01 4.47458432e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.983014909493374
cond(S) = 102427.37536888814
E1 = -729.3819167878073  E_coul = 203.1231546498306
init E= -526.258762137977
    CPU time for initialize scf      0.63 sec, wall time      0.05 sec
  HOMO = -0.556931800897554  LUMO = 1.03058650109673
  mo_energy =
[-1.18332450e+02 -1.22079034e+01 -9.45143656e+00 -9.45143656e+00
 -9.45143656e+00 -1.22583628e+00 -5.56931801e-01 -5.56931801e-01
 -5.56931801e-01  1.03058650e+00  1.03058650e+00  1.03058650e+00
  7.31827891e+00  7.31827891e+00  7.31827891e+00  9.64569074e+00
  3.34593459e+01  3.34593459e+01  3.34593459e+01  1.07776685e+02
  1.29119580e+02  1.29119580e+02  1.29119580e+02  4.83576519e+02
  4.83576519e+02  4.83576519e+02  6.00024572e+02  1.33535366e+03
  1.33535366e+03  1.33535366e+03  2.67224718e+03  3.02947291e+03
  3.02947291e+03  3.02947291e+03  6.64989282e+03  6.64989282e+03
  6.64989282e+03  9.07716579e+03  2.54319360e+04  7.61732684e+04]
E1 = -727.9709657824047  E_coul = 201.26718405260937
cycle= 1 E= -526.703781729795  delta_E= -0.445  |g|= 0.185  |ddm|= 0.414
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.541847
diis-c [-0.29359834  1.        ]
  HOMO = -0.581488010565215  LUMO = 1.0145421219884
  mo_energy =
[-1.18626919e+02 -1.23321571e+01 -9.58596523e+00 -9.58596523e+00
 -9.58596523e+00 -1.25725269e+00 -5.81488011e-01 -5.81488011e-01
 -5.81488011e-01  1.01454212e+00  1.01454212e+00  1.01454212e+00
  7.24227305e+00  7.24227305e+00  7.24227305e+00  9.55592415e+00
  3.33191021e+01  3.33191021e+01  3.33191021e+01  1.07567321e+02
  1.28905006e+02  1.28905006e+02  1.28905006e+02  4.83283454e+02
  4.83283454e+02  4.83283454e+02  5.99692854e+02  1.33500452e+03
  1.33500452e+03  1.33500452e+03  2.67176446e+03  3.02905808e+03
  3.02905808e+03  3.02905808e+03  6.64936496e+03  6.64936496e+03
  6.64936496e+03  9.07656289e+03  2.54312390e+04  7.61724813e+04]
E1 = -728.4381908726374  E_coul = 201.7338097995062
cycle= 2 E= -526.704381073131  delta_E= -0.000599  |g|= 0.0337  |ddm|= 0.0391
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0672305
diis-c [-0.00271194  0.0730771   0.9269229 ]
  HOMO = -0.574700561351159  LUMO = 1.01965250640234
  mo_energy =
[-1.18567835e+02 -1.23010769e+01 -9.55356934e+00 -9.55356934e+00
 -9.55356934e+00 -1.24863971e+00 -5.74700561e-01 -5.74700561e-01
 -5.74700561e-01  1.01965251e+00  1.01965251e+00  1.01965251e+00
  7.26086927e+00  7.26086927e+00  7.26086927e+00  9.58028674e+00
  3.33521145e+01  3.33521145e+01  3.33521145e+01  1.07615663e+02
  1.28952870e+02  1.28952870e+02  1.28952870e+02  4.83341784e+02
  4.83341784e+02  4.83341784e+02  5.99753516e+02  1.33506668e+03
  1.33506668e+03  1.33506668e+03  2.67182967e+03  3.02912232e+03
  3.02912232e+03  3.02912232e+03  6.64943077e+03  6.64943077e+03
  6.64943077e+03  9.07662941e+03  2.54313060e+04  7.61725486e+04]
E1 = -728.3320958677554  E_coul = 201.62767947714855
cycle= 3 E= -526.704416390607  delta_E= -3.53e-05  |g|= 0.00489  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0105962
diis-c [-4.57262793e-07 -1.12868415e-03  1.31526458e-01  8.69602226e-01]
  HOMO = -0.575635326526769  LUMO = 1.0189598488836
  mo_energy =
[-1.18575498e+02 -1.23051753e+01 -9.55794498e+00 -9.55794498e+00
 -9.55794498e+00 -1.24977193e+00 -5.75635327e-01 -5.75635327e-01
 -5.75635327e-01  1.01895985e+00  1.01895985e+00  1.01895985e+00
  7.25833446e+00  7.25833446e+00  7.25833446e+00  9.57716235e+00
  3.33476869e+01  3.33476869e+01  3.33476869e+01  1.07609396e+02
  1.28946608e+02  1.28946608e+02  1.28946608e+02  4.83334218e+02
  4.83334218e+02  4.83334218e+02  5.99745618e+02  1.33505859e+03
  1.33505859e+03  1.33505859e+03  2.67182101e+03  3.02911388e+03
  3.02911388e+03  3.02911388e+03  6.64942197e+03  6.64942197e+03
  6.64942197e+03  9.07662042e+03  2.54312968e+04  7.61725393e+04]
E1 = -728.346548485246  E_coul = 201.64213122652689
cycle= 4 E= -526.704417258719  delta_E= -8.68e-07  |g|= 6.18e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00012768
diis-c [-1.35686664e-09  6.59269669e-05 -9.20956573e-03 -7.18511938e-02
  1.08099483e+00]
  HOMO = -0.575623213706629  LUMO = 1.01896883027019
  mo_energy =
[-1.18575504e+02 -1.23051467e+01 -9.55792843e+00 -9.55792843e+00
 -9.55792843e+00 -1.24975253e+00 -5.75623214e-01 -5.75623214e-01
 -5.75623214e-01  1.01896883e+00  1.01896883e+00  1.01896883e+00
  7.25835481e+00  7.25835481e+00  7.25835481e+00  9.57719803e+00
  3.33477022e+01  3.33477022e+01  3.33477022e+01  1.07609406e+02
  1.28946614e+02  1.28946614e+02  1.28946614e+02  4.83334213e+02
  4.83334213e+02  4.83334213e+02  5.99745605e+02  1.33505857e+03
  1.33505857e+03  1.33505857e+03  2.67182097e+03  3.02911385e+03
  3.02911385e+03  3.02911385e+03  6.64942193e+03  6.64942193e+03
  6.64942193e+03  9.07662037e+03  2.54312968e+04  7.61725392e+04]
E1 = -728.346550172185  E_coul = 201.6421329133446
cycle= 5 E= -526.70441725884  delta_E= -1.21e-10  |g|= 7.91e-06  |ddm|= 2.54e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.346550172185  E_coul = 201.6421329133446
  HOMO = -0.575626727852724  LUMO = 1.01896626807391
  mo_energy =
[-1.18575522e+02 -1.23051591e+01 -9.55794143e+00 -9.55794143e+00
 -9.55794143e+00 -1.24975684e+00 -5.75626728e-01 -5.75626728e-01
 -5.75626728e-01  1.01896627e+00  1.01896627e+00  1.01896627e+00
  7.25834629e+00  7.25834629e+00  7.25834629e+00  9.57718803e+00
  3.33476894e+01  3.33476894e+01  3.33476894e+01  1.07609390e+02
  1.28946598e+02  1.28946598e+02  1.28946598e+02  4.83334196e+02
  4.83334196e+02  4.83334196e+02  5.99745588e+02  1.33505855e+03
  1.33505855e+03  1.33505855e+03  2.67182095e+03  3.02911383e+03
  3.02911383e+03  3.02911383e+03  6.64942192e+03  6.64942192e+03
  6.64942192e+03  9.07662035e+03  2.54312968e+04  7.61725392e+04]
E1 = -728.346589324501  E_coul = 201.6421720656571
Extra cycle  E= -526.704417258844  delta_E= -3.64e-12  |g|= 2.34e-06  |ddm|= 4.05e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.23 sec
exp = [2.61826607e+04 7.61751152e+03 3.61735604e+03 1.59761193e+03
 3.82647052e+02 1.11922527e+02 3.69486152e+01 7.90766204e+00
 3.09889855e+00 3.98450873e-01 1.36278483e+03 6.64729620e+02
 3.00886253e+02 3.13976974e+02 6.16713728e+01 7.32155939e+00
 2.02400739e+01 7.72670640e-01 2.80308950e+00 2.23159122e-01]
E = -526.7044172588439
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:58:58 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6607057        1
[INPUT] 0    0    [1    /1   ]  7617.51151615        1
[INPUT] 0    0    [1    /1   ]  3617.35604259        1
[INPUT] 0    0    [1    /1   ]  1597.61193393        1
[INPUT] 0    0    [1    /1   ]  382.647052036        1
[INPUT] 0    0    [1    /1   ]  111.922526961        1
[INPUT] 0    0    [1    /1   ]  36.9486152358        1
[INPUT] 0    0    [1    /1   ]  7.90766204467        1
[INPUT] 0    0    [1    /1   ]  3.09889854612        1
[INPUT] 0    0    [1    /1   ]  0.39845087302        1
[INPUT] 1    0    [1    /1   ]  1362.78483407        1
[INPUT] 1    0    [1    /1   ]  664.729619546        1
[INPUT] 1    0    [1    /1   ]  300.886253164        1
[INPUT] 1    0    [1    /1   ]  313.976973582        1
[INPUT] 1    0    [1    /1   ]  61.6713727807        1
[INPUT] 1    0    [1    /1   ]  7.32155939491        1
[INPUT] 1    0    [1    /1   ]  20.2400738533        1
[INPUT] 1    0    [1    /1   ]  0.772670640089       1
[INPUT] 1    0    [1    /1   ]  2.80308949518        1
[INPUT] 1    0    [1    /1   ]  0.22315912169        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.660705723338, 1.0]], [0, [7617.511516146175, 1.0]], [0, [3617.356042589368, 1.0]], [0, [1597.6119339328031, 1.0]], [0, [382.64705203638215, 1.0]], [0, [111.92252696075082, 1.0]], [0, [36.94861523582964, 1.0]], [0, [7.907662044668682, 1.0]], [0, [3.098898546118817, 1.0]], [0, [0.3984508730200759, 1.0]], [1, [1362.784834065757, 1.0]], [1, [664.7296195463982, 1.0]], [1, [300.8862531635644, 1.0]], [1, [313.9769735816251, 1.0]], [1, [61.671372780700196, 1.0]], [1, [7.321559394906012, 1.0]], [1, [20.240073853258874, 1.0]], [1, [0.7726706400893358, 1.0]], [1, [2.803089495182604, 1.0]], [1, [0.22315912169048172, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66070572]
bas 1, expnt(s) = [7617.51151615]
bas 2, expnt(s) = [3617.35604259]
bas 3, expnt(s) = [1597.61193393]
bas 4, expnt(s) = [382.64705204]
bas 5, expnt(s) = [111.92252696]
bas 6, expnt(s) = [36.94861524]
bas 7, expnt(s) = [7.90766204]
bas 8, expnt(s) = [3.09889855]
bas 9, expnt(s) = [0.39845087]
bas 10, expnt(s) = [1362.78483407]
bas 11, expnt(s) = [664.72961955]
bas 12, expnt(s) = [300.88625316]
bas 13, expnt(s) = [313.97697358]
bas 14, expnt(s) = [61.67137278]
bas 15, expnt(s) = [7.32155939]
bas 16, expnt(s) = [20.24007385]
bas 17, expnt(s) = [0.77267064]
bas 18, expnt(s) = [2.8030895]
bas 19, expnt(s) = [0.22315912]
CPU time:      1253.96
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826607e+04 5.20026359e+03 7.61751152e+03 2.06003626e+03
 3.61735604e+03 1.17844269e+03 1.59761193e+03 6.38437659e+02
 3.82647052e+02 2.18581702e+02 1.11922527e+02 8.69367007e+01
 3.69486152e+01 3.78628804e+01 7.90766204e+00 1.19138218e+01
 3.09889855e+00 5.90093109e+00 3.98450873e-01 1.26705688e+00
 1.36278483e+03 2.41556377e+04 6.64729620e+02 9.84669943e+03
 3.00886253e+02 3.65584122e+03 3.13976974e+02 3.85573024e+03
 6.16713728e+01 5.04183829e+02 7.32155939e+00 3.51349128e+01
 2.02400739e+01 1.25241860e+02 7.72670640e-01 2.11337909e+00
 2.80308950e+00 1.05810946e+01 2.23159122e-01 4.47458432e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.983014909493374
cond(S) = 102427.37536888814
E1 = -729.3819167878073  E_coul = 203.1231546498306
init E= -526.258762137977
    CPU time for initialize scf      0.63 sec, wall time      0.05 sec
  HOMO = -0.556931800897554  LUMO = 1.03058650109673
  mo_energy =
[-1.18332450e+02 -1.22079034e+01 -9.45143656e+00 -9.45143656e+00
 -9.45143656e+00 -1.22583628e+00 -5.56931801e-01 -5.56931801e-01
 -5.56931801e-01  1.03058650e+00  1.03058650e+00  1.03058650e+00
  7.31827891e+00  7.31827891e+00  7.31827891e+00  9.64569074e+00
  3.34593459e+01  3.34593459e+01  3.34593459e+01  1.07776685e+02
  1.29119580e+02  1.29119580e+02  1.29119580e+02  4.83576519e+02
  4.83576519e+02  4.83576519e+02  6.00024572e+02  1.33535366e+03
  1.33535366e+03  1.33535366e+03  2.67224718e+03  3.02947291e+03
  3.02947291e+03  3.02947291e+03  6.64989282e+03  6.64989282e+03
  6.64989282e+03  9.07716579e+03  2.54319360e+04  7.61732684e+04]
E1 = -727.9709657824047  E_coul = 201.26718405260937
cycle= 1 E= -526.703781729795  delta_E= -0.445  |g|= 0.185  |ddm|= 0.414
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.541847
diis-c [-0.29359834  1.        ]
  HOMO = -0.581488010565215  LUMO = 1.0145421219884
  mo_energy =
[-1.18626919e+02 -1.23321571e+01 -9.58596523e+00 -9.58596523e+00
 -9.58596523e+00 -1.25725269e+00 -5.81488011e-01 -5.81488011e-01
 -5.81488011e-01  1.01454212e+00  1.01454212e+00  1.01454212e+00
  7.24227305e+00  7.24227305e+00  7.24227305e+00  9.55592415e+00
  3.33191021e+01  3.33191021e+01  3.33191021e+01  1.07567321e+02
  1.28905006e+02  1.28905006e+02  1.28905006e+02  4.83283454e+02
  4.83283454e+02  4.83283454e+02  5.99692854e+02  1.33500452e+03
  1.33500452e+03  1.33500452e+03  2.67176446e+03  3.02905808e+03
  3.02905808e+03  3.02905808e+03  6.64936496e+03  6.64936496e+03
  6.64936496e+03  9.07656289e+03  2.54312390e+04  7.61724813e+04]
E1 = -728.4381908726374  E_coul = 201.7338097995062
cycle= 2 E= -526.704381073131  delta_E= -0.000599  |g|= 0.0337  |ddm|= 0.0391
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0672305
diis-c [-0.00271194  0.0730771   0.9269229 ]
  HOMO = -0.574700561351159  LUMO = 1.01965250640234
  mo_energy =
[-1.18567835e+02 -1.23010769e+01 -9.55356934e+00 -9.55356934e+00
 -9.55356934e+00 -1.24863971e+00 -5.74700561e-01 -5.74700561e-01
 -5.74700561e-01  1.01965251e+00  1.01965251e+00  1.01965251e+00
  7.26086927e+00  7.26086927e+00  7.26086927e+00  9.58028674e+00
  3.33521145e+01  3.33521145e+01  3.33521145e+01  1.07615663e+02
  1.28952870e+02  1.28952870e+02  1.28952870e+02  4.83341784e+02
  4.83341784e+02  4.83341784e+02  5.99753516e+02  1.33506668e+03
  1.33506668e+03  1.33506668e+03  2.67182967e+03  3.02912232e+03
  3.02912232e+03  3.02912232e+03  6.64943077e+03  6.64943077e+03
  6.64943077e+03  9.07662941e+03  2.54313060e+04  7.61725486e+04]
E1 = -728.3320958677554  E_coul = 201.62767947714855
cycle= 3 E= -526.704416390607  delta_E= -3.53e-05  |g|= 0.00489  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0105962
diis-c [-4.57262793e-07 -1.12868415e-03  1.31526458e-01  8.69602226e-01]
  HOMO = -0.575635326526769  LUMO = 1.0189598488836
  mo_energy =
[-1.18575498e+02 -1.23051753e+01 -9.55794498e+00 -9.55794498e+00
 -9.55794498e+00 -1.24977193e+00 -5.75635327e-01 -5.75635327e-01
 -5.75635327e-01  1.01895985e+00  1.01895985e+00  1.01895985e+00
  7.25833446e+00  7.25833446e+00  7.25833446e+00  9.57716235e+00
  3.33476869e+01  3.33476869e+01  3.33476869e+01  1.07609396e+02
  1.28946608e+02  1.28946608e+02  1.28946608e+02  4.83334218e+02
  4.83334218e+02  4.83334218e+02  5.99745618e+02  1.33505859e+03
  1.33505859e+03  1.33505859e+03  2.67182101e+03  3.02911388e+03
  3.02911388e+03  3.02911388e+03  6.64942197e+03  6.64942197e+03
  6.64942197e+03  9.07662042e+03  2.54312968e+04  7.61725393e+04]
E1 = -728.346548485246  E_coul = 201.64213122652689
cycle= 4 E= -526.704417258719  delta_E= -8.68e-07  |g|= 6.18e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00012768
diis-c [-1.35686664e-09  6.59269669e-05 -9.20956573e-03 -7.18511938e-02
  1.08099483e+00]
  HOMO = -0.575623213706629  LUMO = 1.01896883027019
  mo_energy =
[-1.18575504e+02 -1.23051467e+01 -9.55792843e+00 -9.55792843e+00
 -9.55792843e+00 -1.24975253e+00 -5.75623214e-01 -5.75623214e-01
 -5.75623214e-01  1.01896883e+00  1.01896883e+00  1.01896883e+00
  7.25835481e+00  7.25835481e+00  7.25835481e+00  9.57719803e+00
  3.33477022e+01  3.33477022e+01  3.33477022e+01  1.07609406e+02
  1.28946614e+02  1.28946614e+02  1.28946614e+02  4.83334213e+02
  4.83334213e+02  4.83334213e+02  5.99745605e+02  1.33505857e+03
  1.33505857e+03  1.33505857e+03  2.67182097e+03  3.02911385e+03
  3.02911385e+03  3.02911385e+03  6.64942193e+03  6.64942193e+03
  6.64942193e+03  9.07662037e+03  2.54312968e+04  7.61725392e+04]
E1 = -728.346550172185  E_coul = 201.6421329133446
cycle= 5 E= -526.70441725884  delta_E= -1.21e-10  |g|= 7.91e-06  |ddm|= 2.54e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.346550172185  E_coul = 201.6421329133446
  HOMO = -0.575626727852724  LUMO = 1.01896626807391
  mo_energy =
[-1.18575522e+02 -1.23051591e+01 -9.55794143e+00 -9.55794143e+00
 -9.55794143e+00 -1.24975684e+00 -5.75626728e-01 -5.75626728e-01
 -5.75626728e-01  1.01896627e+00  1.01896627e+00  1.01896627e+00
  7.25834629e+00  7.25834629e+00  7.25834629e+00  9.57718803e+00
  3.33476894e+01  3.33476894e+01  3.33476894e+01  1.07609390e+02
  1.28946598e+02  1.28946598e+02  1.28946598e+02  4.83334196e+02
  4.83334196e+02  4.83334196e+02  5.99745588e+02  1.33505855e+03
  1.33505855e+03  1.33505855e+03  2.67182095e+03  3.02911383e+03
  3.02911383e+03  3.02911383e+03  6.64942192e+03  6.64942192e+03
  6.64942192e+03  9.07662035e+03  2.54312968e+04  7.61725392e+04]
E1 = -728.346589324501  E_coul = 201.6421720656571
Extra cycle  E= -526.704417258844  delta_E= -3.64e-12  |g|= 2.34e-06  |ddm|= 4.05e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102427.37536888814
E1 = -728.346589324501  E_coul = 201.6421720656571
init E= -526.704417258844
    CPU time for initialize scf      3.78 sec, wall time      0.21 sec
  HOMO = -0.575626011390264  LUMO = 1.01896679668236
  mo_energy =
[-1.18575517e+02 -1.23051562e+01 -9.55793846e+00 -9.55793846e+00
 -9.55793846e+00 -1.24975594e+00 -5.75626011e-01 -5.75626011e-01
 -5.75626011e-01  1.01896680e+00  1.01896680e+00  1.01896680e+00
  7.25834811e+00  7.25834811e+00  7.25834811e+00  9.57719031e+00
  3.33476924e+01  3.33476924e+01  3.33476924e+01  1.07609394e+02
  1.28946602e+02  1.28946602e+02  1.28946602e+02  4.83334201e+02
  4.83334201e+02  4.83334201e+02  5.99745592e+02  1.33505856e+03
  1.33505856e+03  1.33505856e+03  2.67182096e+03  3.02911384e+03
  3.02911384e+03  3.02911384e+03  6.64942192e+03  6.64942192e+03
  6.64942192e+03  9.07662036e+03  2.54312968e+04  7.61725392e+04]
E1 = -728.3465799965874  E_coul = 201.6421627377418
cycle= 1 E= -526.704417258846  delta_E= -1.59e-12  |g|= 6.04e-07  |ddm|= 9.32e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3465799965874  E_coul = 201.6421627377418
  HOMO = -0.57562617012291  LUMO = 1.01896667892347
  mo_energy =
[-1.18575518e+02 -1.23051569e+01 -9.55793917e+00 -9.55793917e+00
 -9.55793917e+00 -1.24975614e+00 -5.75626170e-01 -5.75626170e-01
 -5.75626170e-01  1.01896668e+00  1.01896668e+00  1.01896668e+00
  7.25834769e+00  7.25834769e+00  7.25834769e+00  9.57718979e+00
  3.33476917e+01  3.33476917e+01  3.33476917e+01  1.07609393e+02
  1.28946601e+02  1.28946601e+02  1.28946601e+02  4.83334199e+02
  4.83334199e+02  4.83334199e+02  5.99745591e+02  1.33505856e+03
  1.33505856e+03  1.33505856e+03  2.67182096e+03  3.02911384e+03
  3.02911384e+03  3.02911384e+03  6.64942192e+03  6.64942192e+03
  6.64942192e+03  9.07662036e+03  2.54312968e+04  7.61725392e+04]
E1 = -728.3465822765645  E_coul = 201.64216501772026
Extra cycle  E= -526.704417258844  delta_E= 1.25e-12  |g|= 1.52e-07  |ddm|= 2.19e-07
    CPU time for scf_cycle      3.90 sec, wall time      0.32 sec
exp = [2.61826607e+04 7.61751152e+03 3.61735604e+03 1.59761193e+03
 3.82647052e+02 1.11922527e+02 3.69486152e+01 7.90766204e+00
 3.09889855e+00 3.98450873e-01 1.36278483e+03 6.64729620e+02
 3.00886253e+02 3.13976974e+02 6.16713728e+01 7.32155939e+00
 2.02400739e+01 7.72670640e-01 2.80308950e+00 2.23159122e-01]
grad_E = [-1.54833829e-06  3.65868633e-06 -1.35677482e-06  8.22512174e-05
 -3.09103854e-04 -4.89579092e-05  6.29426395e-05 -1.46131401e-04
  2.95074114e-04 -7.09759693e-04 -5.09448801e-07  4.97998993e-06
  2.34781043e-05  2.02366563e-05 -2.19065065e-05  6.67550449e-05
  8.45844937e-05 -1.02262018e-03 -7.17519869e-04  4.72038377e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:59:02 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6607562        1
[INPUT] 0    0    [1    /1   ]  7617.51140818        1
[INPUT] 0    0    [1    /1   ]  3617.35609668        1
[INPUT] 0    0    [1    /1   ]  1597.60972221        1
[INPUT] 0    0    [1    /1   ]  382.644367381        1
[INPUT] 0    0    [1    /1   ]  111.96792692         1
[INPUT] 0    0    [1    /1   ]  36.95616668          1
[INPUT] 0    0    [1    /1   ]  7.92005936044        1
[INPUT] 0    0    [1    /1   ]  3.10096630002        1
[INPUT] 0    0    [1    /1   ]  0.398527543259       1
[INPUT] 1    0    [1    /1   ]  1362.78485093        1
[INPUT] 1    0    [1    /1   ]  664.729450951        1
[INPUT] 1    0    [1    /1   ]  300.885456424        1
[INPUT] 1    0    [1    /1   ]  313.976286686        1
[INPUT] 1    0    [1    /1   ]  61.6727702896        1
[INPUT] 1    0    [1    /1   ]  7.32818360971        1
[INPUT] 1    0    [1    /1   ]  20.2343898954        1
[INPUT] 1    0    [1    /1   ]  0.773092172524       1
[INPUT] 1    0    [1    /1   ]  2.81114305694        1
[INPUT] 1    0    [1    /1   ]  0.223081493112       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.66075621896, 1.0]], [0, [7617.5114081830725, 1.0]], [0, [3617.3560966827004, 1.0]], [0, [1597.6097222138849, 1.0]], [0, [382.644367380583, 1.0]], [0, [111.96792691964288, 1.0]], [0, [36.95616667997155, 1.0]], [0, [7.920059360442268, 1.0]], [0, [3.1009663000162506, 1.0]], [0, [0.3985275432588769, 1.0]], [1, [1362.7848509343685, 1.0]], [1, [664.7294509514505, 1.0]], [1, [300.8854564241889, 1.0]], [1, [313.9762866857451, 1.0]], [1, [61.67277028963656, 1.0]], [1, [7.328183609713597, 1.0]], [1, [20.234389895379838, 1.0]], [1, [0.7730921725243294, 1.0]], [1, [2.8111430569370515, 1.0]], [1, [0.223081493111839, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66075622]
bas 1, expnt(s) = [7617.51140818]
bas 2, expnt(s) = [3617.35609668]
bas 3, expnt(s) = [1597.60972221]
bas 4, expnt(s) = [382.64436738]
bas 5, expnt(s) = [111.96792692]
bas 6, expnt(s) = [36.95616668]
bas 7, expnt(s) = [7.92005936]
bas 8, expnt(s) = [3.1009663]
bas 9, expnt(s) = [0.39852754]
bas 10, expnt(s) = [1362.78485093]
bas 11, expnt(s) = [664.72945095]
bas 12, expnt(s) = [300.88545642]
bas 13, expnt(s) = [313.97628669]
bas 14, expnt(s) = [61.67277029]
bas 15, expnt(s) = [7.32818361]
bas 16, expnt(s) = [20.2343899]
bas 17, expnt(s) = [0.77309217]
bas 18, expnt(s) = [2.81114306]
bas 19, expnt(s) = [0.22308149]
CPU time:      1263.49
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826608e+04 5.20026360e+03 7.61751141e+03 2.06003623e+03
 3.61735610e+03 1.17844270e+03 1.59760972e+03 6.38436996e+02
 3.82644367e+02 2.18580552e+02 1.11967927e+02 8.69631480e+01
 3.69561667e+01 3.78686839e+01 7.92005936e+00 1.19278276e+01
 3.10096630e+00 5.90388391e+00 3.98527543e-01 1.26723973e+00
 1.36278485e+03 2.41556381e+04 6.64729451e+02 9.84669630e+03
 3.00885456e+02 3.65582912e+03 3.13976287e+02 3.85571969e+03
 6.16727703e+01 5.04198110e+02 7.32818361e+00 3.51746529e+01
 2.02343899e+01 1.25197897e+02 7.73092173e-01 2.11482038e+00
 2.81114306e+00 1.06191089e+01 2.23081493e-01 4.47263874e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.983004571846035
cond(S) = 102437.98396464952
E1 = -729.3824435366454  E_coul = 203.12350979954672
init E= -526.258933737099
    CPU time for initialize scf      0.63 sec, wall time      0.05 sec
  HOMO = -0.556920955500674  LUMO = 1.03070757217069
  mo_energy =
[-1.18332428e+02 -1.22078707e+01 -9.45141367e+00 -9.45141367e+00
 -9.45141367e+00 -1.22581914e+00 -5.56920956e-01 -5.56920956e-01
 -5.56920956e-01  1.03070757e+00  1.03070757e+00  1.03070757e+00
  7.33521503e+00  7.33521503e+00  7.33521503e+00  9.66476975e+00
  3.35012724e+01  3.35012724e+01  3.35012724e+01  1.07869366e+02
  1.29156386e+02  1.29156386e+02  1.29156386e+02  4.83603091e+02
  4.83603091e+02  4.83603091e+02  6.00220586e+02  1.33537537e+03
  1.33537537e+03  1.33537537e+03  2.67247852e+03  3.02949079e+03
  3.02949079e+03  3.02949079e+03  6.64990738e+03  6.64990738e+03
  6.64990738e+03  9.07738606e+03  2.54321441e+04  7.61734618e+04]
E1 = -727.9693325599659  E_coul = 201.2655466427357
cycle= 1 E= -526.70378591723  delta_E= -0.445  |g|= 0.185  |ddm|= 0.414
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.542023
diis-c [-0.29378853  1.        ]
  HOMO = -0.581552199879695  LUMO = 1.0145935820314
  mo_energy =
[-1.18627023e+02 -1.23322547e+01 -9.58608021e+00 -9.58608021e+00
 -9.58608021e+00 -1.25733475e+00 -5.81552200e-01 -5.81552200e-01
 -5.81552200e-01  1.01459358e+00  1.01459358e+00  1.01459358e+00
  7.25896346e+00  7.25896346e+00  7.25896346e+00  9.57479171e+00
  3.33608873e+01  3.33608873e+01  3.33608873e+01  1.07659817e+02
  1.28941699e+02  1.28941699e+02  1.28941699e+02  4.83309893e+02
  4.83309893e+02  4.83309893e+02  5.99888723e+02  1.33502608e+03
  1.33502608e+03  1.33502608e+03  2.67199568e+03  3.02907583e+03
  3.02907583e+03  3.02907583e+03  6.64937940e+03  6.64937940e+03
  6.64937940e+03  9.07678305e+03  2.54314470e+04  7.61726746e+04]
E1 = -728.4369231410604  E_coul = 201.73253718151608
cycle= 2 E= -526.704385959544  delta_E= -0.0006  |g|= 0.0337  |ddm|= 0.0391
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0672839
diis-c [-0.00271502  0.07313223  0.92686777]
  HOMO = -0.574758304389989  LUMO = 1.01971249134254
  mo_energy =
[-1.18567907e+02 -1.23011506e+01 -9.55366037e+00 -9.55366037e+00
 -9.55366037e+00 -1.24871285e+00 -5.74758304e-01 -5.74758304e-01
 -5.74758304e-01  1.01971249e+00  1.01971249e+00  1.01971249e+00
  7.27760105e+00  7.27760105e+00  7.27760105e+00  9.59919271e+00
  3.33939257e+01  3.33939257e+01  3.33939257e+01  1.07708193e+02
  1.28989590e+02  1.28989590e+02  1.28989590e+02  4.83368254e+02
  4.83368254e+02  4.83368254e+02  5.99949417e+02  1.33508828e+03
  1.33508828e+03  1.33508828e+03  2.67206092e+03  3.02914011e+03
  3.02914011e+03  3.02914011e+03  6.64944524e+03  6.64944524e+03
  6.64944524e+03  9.07684960e+03  2.54315141e+04  7.61727419e+04]
E1 = -728.33074905347  E_coul = 201.6263277277144
cycle= 3 E= -526.704421325756  delta_E= -3.54e-05  |g|= 0.00489  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106007
diis-c [-4.57374884e-07 -1.12827527e-03  1.31484997e-01  8.69643278e-01]
  HOMO = -0.57569383114123  LUMO = 1.01901873889692
  mo_energy =
[-1.18575572e+02 -1.23052502e+01 -9.55803737e+00 -9.55803737e+00
 -9.55803737e+00 -1.24984620e+00 -5.75693831e-01 -5.75693831e-01
 -5.75693831e-01  1.01901874e+00  1.01901874e+00  1.01901874e+00
  7.27506142e+00  7.27506142e+00  7.27506142e+00  9.59606437e+00
  3.33894964e+01  3.33894964e+01  3.33894964e+01  1.07701924e+02
  1.28983326e+02  1.28983326e+02  1.28983326e+02  4.83360687e+02
  4.83360687e+02  4.83360687e+02  5.99941518e+02  1.33508018e+03
  1.33508018e+03  1.33508018e+03  2.67205225e+03  3.02913167e+03
  3.02913167e+03  3.02913167e+03  6.64943644e+03  6.64943644e+03
  6.64943644e+03  9.07684061e+03  2.54315049e+04  7.61727326e+04]
E1 = -728.3452057536174  E_coul = 201.64078355933455
cycle= 4 E= -526.704422194283  delta_E= -8.69e-07  |g|= 6.17e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000127832
diis-c [-1.35263274e-09  6.59160238e-05 -9.20777945e-03 -7.18759232e-02
  1.08101779e+00]
  HOMO = -0.57568177956298  LUMO = 1.0190276785077
  mo_energy =
[-1.18575578e+02 -1.23052218e+01 -9.55802095e+00 -9.55802095e+00
 -9.55802095e+00 -1.24982688e+00 -5.75681780e-01 -5.75681780e-01
 -5.75681780e-01  1.01902768e+00  1.01902768e+00  1.01902768e+00
  7.27508165e+00  7.27508165e+00  7.27508165e+00  9.59609990e+00
  3.33895116e+01  3.33895116e+01  3.33895116e+01  1.07701934e+02
  1.28983333e+02  1.28983333e+02  1.28983333e+02  4.83360682e+02
  4.83360682e+02  4.83360682e+02  5.99941505e+02  1.33508017e+03
  1.33508017e+03  1.33508017e+03  2.67205222e+03  3.02913164e+03
  3.02913164e+03  3.02913164e+03  6.64943641e+03  6.64943641e+03
  6.64943641e+03  9.07684056e+03  2.54315048e+04  7.61727325e+04]
E1 = -728.3452076731035  E_coul = 201.64078547870002
cycle= 5 E= -526.704422194403  delta_E= -1.21e-10  |g|= 7.9e-06  |ddm|= 2.53e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3452076731035  E_coul = 201.64078547870002
  HOMO = -0.575685292257952  LUMO = 1.01902511542109
  mo_energy =
[-1.18575595e+02 -1.23052341e+01 -9.55803394e+00 -9.55803394e+00
 -9.55803394e+00 -1.24983120e+00 -5.75685292e-01 -5.75685292e-01
 -5.75685292e-01  1.01902512e+00  1.01902512e+00  1.01902512e+00
  7.27507312e+00  7.27507312e+00  7.27507312e+00  9.59608989e+00
  3.33894988e+01  3.33894988e+01  3.33894988e+01  1.07701918e+02
  1.28983317e+02  1.28983317e+02  1.28983317e+02  4.83360665e+02
  4.83360665e+02  4.83360665e+02  5.99941487e+02  1.33508015e+03
  1.33508015e+03  1.33508015e+03  2.67205220e+03  3.02913162e+03
  3.02913162e+03  3.02913162e+03  6.64943639e+03  6.64943639e+03
  6.64943639e+03  9.07684055e+03  2.54315048e+04  7.61727325e+04]
E1 = -728.3452467925848  E_coul = 201.64082459817624
Extra cycle  E= -526.704422194409  delta_E= -5.23e-12  |g|= 2.34e-06  |ddm|= 4.05e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.22 sec
exp = [2.61826608e+04 7.61751141e+03 3.61735610e+03 1.59760972e+03
 3.82644367e+02 1.11967927e+02 3.69561667e+01 7.92005936e+00
 3.10096630e+00 3.98527543e-01 1.36278485e+03 6.64729451e+02
 3.00885456e+02 3.13976287e+02 6.16727703e+01 7.32818361e+00
 2.02343899e+01 7.73092173e-01 2.81114306e+00 2.23081493e-01]
E = -526.7044221944086
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:59:02 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6607562        1
[INPUT] 0    0    [1    /1   ]  7617.51140818        1
[INPUT] 0    0    [1    /1   ]  3617.35609668        1
[INPUT] 0    0    [1    /1   ]  1597.60972221        1
[INPUT] 0    0    [1    /1   ]  382.644367381        1
[INPUT] 0    0    [1    /1   ]  111.96792692         1
[INPUT] 0    0    [1    /1   ]  36.95616668          1
[INPUT] 0    0    [1    /1   ]  7.92005936044        1
[INPUT] 0    0    [1    /1   ]  3.10096630002        1
[INPUT] 0    0    [1    /1   ]  0.398527543259       1
[INPUT] 1    0    [1    /1   ]  1362.78485093        1
[INPUT] 1    0    [1    /1   ]  664.729450951        1
[INPUT] 1    0    [1    /1   ]  300.885456424        1
[INPUT] 1    0    [1    /1   ]  313.976286686        1
[INPUT] 1    0    [1    /1   ]  61.6727702896        1
[INPUT] 1    0    [1    /1   ]  7.32818360971        1
[INPUT] 1    0    [1    /1   ]  20.2343898954        1
[INPUT] 1    0    [1    /1   ]  0.773092172524       1
[INPUT] 1    0    [1    /1   ]  2.81114305694        1
[INPUT] 1    0    [1    /1   ]  0.223081493112       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.66075621896, 1.0]], [0, [7617.5114081830725, 1.0]], [0, [3617.3560966827004, 1.0]], [0, [1597.6097222138849, 1.0]], [0, [382.644367380583, 1.0]], [0, [111.96792691964288, 1.0]], [0, [36.95616667997155, 1.0]], [0, [7.920059360442268, 1.0]], [0, [3.1009663000162506, 1.0]], [0, [0.3985275432588769, 1.0]], [1, [1362.7848509343685, 1.0]], [1, [664.7294509514505, 1.0]], [1, [300.8854564241889, 1.0]], [1, [313.9762866857451, 1.0]], [1, [61.67277028963656, 1.0]], [1, [7.328183609713597, 1.0]], [1, [20.234389895379838, 1.0]], [1, [0.7730921725243294, 1.0]], [1, [2.8111430569370515, 1.0]], [1, [0.223081493111839, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66075622]
bas 1, expnt(s) = [7617.51140818]
bas 2, expnt(s) = [3617.35609668]
bas 3, expnt(s) = [1597.60972221]
bas 4, expnt(s) = [382.64436738]
bas 5, expnt(s) = [111.96792692]
bas 6, expnt(s) = [36.95616668]
bas 7, expnt(s) = [7.92005936]
bas 8, expnt(s) = [3.1009663]
bas 9, expnt(s) = [0.39852754]
bas 10, expnt(s) = [1362.78485093]
bas 11, expnt(s) = [664.72945095]
bas 12, expnt(s) = [300.88545642]
bas 13, expnt(s) = [313.97628669]
bas 14, expnt(s) = [61.67277029]
bas 15, expnt(s) = [7.32818361]
bas 16, expnt(s) = [20.2343899]
bas 17, expnt(s) = [0.77309217]
bas 18, expnt(s) = [2.81114306]
bas 19, expnt(s) = [0.22308149]
CPU time:      1264.47
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826608e+04 5.20026360e+03 7.61751141e+03 2.06003623e+03
 3.61735610e+03 1.17844270e+03 1.59760972e+03 6.38436996e+02
 3.82644367e+02 2.18580552e+02 1.11967927e+02 8.69631480e+01
 3.69561667e+01 3.78686839e+01 7.92005936e+00 1.19278276e+01
 3.10096630e+00 5.90388391e+00 3.98527543e-01 1.26723973e+00
 1.36278485e+03 2.41556381e+04 6.64729451e+02 9.84669630e+03
 3.00885456e+02 3.65582912e+03 3.13976287e+02 3.85571969e+03
 6.16727703e+01 5.04198110e+02 7.32818361e+00 3.51746529e+01
 2.02343899e+01 1.25197897e+02 7.73092173e-01 2.11482038e+00
 2.81114306e+00 1.06191089e+01 2.23081493e-01 4.47263874e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.983004571846035
cond(S) = 102437.98396464952
E1 = -729.3824435366454  E_coul = 203.12350979954672
init E= -526.258933737099
    CPU time for initialize scf      0.63 sec, wall time      0.05 sec
  HOMO = -0.556920955500674  LUMO = 1.03070757217069
  mo_energy =
[-1.18332428e+02 -1.22078707e+01 -9.45141367e+00 -9.45141367e+00
 -9.45141367e+00 -1.22581914e+00 -5.56920956e-01 -5.56920956e-01
 -5.56920956e-01  1.03070757e+00  1.03070757e+00  1.03070757e+00
  7.33521503e+00  7.33521503e+00  7.33521503e+00  9.66476975e+00
  3.35012724e+01  3.35012724e+01  3.35012724e+01  1.07869366e+02
  1.29156386e+02  1.29156386e+02  1.29156386e+02  4.83603091e+02
  4.83603091e+02  4.83603091e+02  6.00220586e+02  1.33537537e+03
  1.33537537e+03  1.33537537e+03  2.67247852e+03  3.02949079e+03
  3.02949079e+03  3.02949079e+03  6.64990738e+03  6.64990738e+03
  6.64990738e+03  9.07738606e+03  2.54321441e+04  7.61734618e+04]
E1 = -727.9693325599659  E_coul = 201.2655466427357
cycle= 1 E= -526.70378591723  delta_E= -0.445  |g|= 0.185  |ddm|= 0.414
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.542023
diis-c [-0.29378853  1.        ]
  HOMO = -0.581552199879695  LUMO = 1.0145935820314
  mo_energy =
[-1.18627023e+02 -1.23322547e+01 -9.58608021e+00 -9.58608021e+00
 -9.58608021e+00 -1.25733475e+00 -5.81552200e-01 -5.81552200e-01
 -5.81552200e-01  1.01459358e+00  1.01459358e+00  1.01459358e+00
  7.25896346e+00  7.25896346e+00  7.25896346e+00  9.57479171e+00
  3.33608873e+01  3.33608873e+01  3.33608873e+01  1.07659817e+02
  1.28941699e+02  1.28941699e+02  1.28941699e+02  4.83309893e+02
  4.83309893e+02  4.83309893e+02  5.99888723e+02  1.33502608e+03
  1.33502608e+03  1.33502608e+03  2.67199568e+03  3.02907583e+03
  3.02907583e+03  3.02907583e+03  6.64937940e+03  6.64937940e+03
  6.64937940e+03  9.07678305e+03  2.54314470e+04  7.61726746e+04]
E1 = -728.4369231410604  E_coul = 201.73253718151608
cycle= 2 E= -526.704385959544  delta_E= -0.0006  |g|= 0.0337  |ddm|= 0.0391
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0672839
diis-c [-0.00271502  0.07313223  0.92686777]
  HOMO = -0.574758304389989  LUMO = 1.01971249134254
  mo_energy =
[-1.18567907e+02 -1.23011506e+01 -9.55366037e+00 -9.55366037e+00
 -9.55366037e+00 -1.24871285e+00 -5.74758304e-01 -5.74758304e-01
 -5.74758304e-01  1.01971249e+00  1.01971249e+00  1.01971249e+00
  7.27760105e+00  7.27760105e+00  7.27760105e+00  9.59919271e+00
  3.33939257e+01  3.33939257e+01  3.33939257e+01  1.07708193e+02
  1.28989590e+02  1.28989590e+02  1.28989590e+02  4.83368254e+02
  4.83368254e+02  4.83368254e+02  5.99949417e+02  1.33508828e+03
  1.33508828e+03  1.33508828e+03  2.67206092e+03  3.02914011e+03
  3.02914011e+03  3.02914011e+03  6.64944524e+03  6.64944524e+03
  6.64944524e+03  9.07684960e+03  2.54315141e+04  7.61727419e+04]
E1 = -728.33074905347  E_coul = 201.6263277277144
cycle= 3 E= -526.704421325756  delta_E= -3.54e-05  |g|= 0.00489  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106007
diis-c [-4.57374884e-07 -1.12827527e-03  1.31484997e-01  8.69643278e-01]
  HOMO = -0.57569383114123  LUMO = 1.01901873889692
  mo_energy =
[-1.18575572e+02 -1.23052502e+01 -9.55803737e+00 -9.55803737e+00
 -9.55803737e+00 -1.24984620e+00 -5.75693831e-01 -5.75693831e-01
 -5.75693831e-01  1.01901874e+00  1.01901874e+00  1.01901874e+00
  7.27506142e+00  7.27506142e+00  7.27506142e+00  9.59606437e+00
  3.33894964e+01  3.33894964e+01  3.33894964e+01  1.07701924e+02
  1.28983326e+02  1.28983326e+02  1.28983326e+02  4.83360687e+02
  4.83360687e+02  4.83360687e+02  5.99941518e+02  1.33508018e+03
  1.33508018e+03  1.33508018e+03  2.67205225e+03  3.02913167e+03
  3.02913167e+03  3.02913167e+03  6.64943644e+03  6.64943644e+03
  6.64943644e+03  9.07684061e+03  2.54315049e+04  7.61727326e+04]
E1 = -728.3452057536174  E_coul = 201.64078355933455
cycle= 4 E= -526.704422194283  delta_E= -8.69e-07  |g|= 6.17e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000127832
diis-c [-1.35263274e-09  6.59160238e-05 -9.20777945e-03 -7.18759232e-02
  1.08101779e+00]
  HOMO = -0.57568177956298  LUMO = 1.0190276785077
  mo_energy =
[-1.18575578e+02 -1.23052218e+01 -9.55802095e+00 -9.55802095e+00
 -9.55802095e+00 -1.24982688e+00 -5.75681780e-01 -5.75681780e-01
 -5.75681780e-01  1.01902768e+00  1.01902768e+00  1.01902768e+00
  7.27508165e+00  7.27508165e+00  7.27508165e+00  9.59609990e+00
  3.33895116e+01  3.33895116e+01  3.33895116e+01  1.07701934e+02
  1.28983333e+02  1.28983333e+02  1.28983333e+02  4.83360682e+02
  4.83360682e+02  4.83360682e+02  5.99941505e+02  1.33508017e+03
  1.33508017e+03  1.33508017e+03  2.67205222e+03  3.02913164e+03
  3.02913164e+03  3.02913164e+03  6.64943641e+03  6.64943641e+03
  6.64943641e+03  9.07684056e+03  2.54315048e+04  7.61727325e+04]
E1 = -728.3452076731035  E_coul = 201.64078547870002
cycle= 5 E= -526.704422194403  delta_E= -1.21e-10  |g|= 7.9e-06  |ddm|= 2.53e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3452076731035  E_coul = 201.64078547870002
  HOMO = -0.575685292257952  LUMO = 1.01902511542109
  mo_energy =
[-1.18575595e+02 -1.23052341e+01 -9.55803394e+00 -9.55803394e+00
 -9.55803394e+00 -1.24983120e+00 -5.75685292e-01 -5.75685292e-01
 -5.75685292e-01  1.01902512e+00  1.01902512e+00  1.01902512e+00
  7.27507312e+00  7.27507312e+00  7.27507312e+00  9.59608989e+00
  3.33894988e+01  3.33894988e+01  3.33894988e+01  1.07701918e+02
  1.28983317e+02  1.28983317e+02  1.28983317e+02  4.83360665e+02
  4.83360665e+02  4.83360665e+02  5.99941487e+02  1.33508015e+03
  1.33508015e+03  1.33508015e+03  2.67205220e+03  3.02913162e+03
  3.02913162e+03  3.02913162e+03  6.64943639e+03  6.64943639e+03
  6.64943639e+03  9.07684055e+03  2.54315048e+04  7.61727325e+04]
E1 = -728.3452467925848  E_coul = 201.64082459817624
Extra cycle  E= -526.704422194409  delta_E= -5.23e-12  |g|= 2.34e-06  |ddm|= 4.05e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102437.98396464952
E1 = -728.3452467925848  E_coul = 201.64082459817624
init E= -526.704422194409
    CPU time for initialize scf      3.76 sec, wall time      0.20 sec
  HOMO = -0.575684576223344  LUMO = 1.01902564409165
  mo_energy =
[-1.18575591e+02 -1.23052313e+01 -9.55803098e+00 -9.55803098e+00
 -9.55803098e+00 -1.24983030e+00 -5.75684576e-01 -5.75684576e-01
 -5.75684576e-01  1.01902564e+00  1.01902564e+00  1.01902564e+00
  7.27507495e+00  7.27507495e+00  7.27507495e+00  9.59609218e+00
  3.33895018e+01  3.33895018e+01  3.33895018e+01  1.07701922e+02
  1.28983321e+02  1.28983321e+02  1.28983321e+02  4.83360669e+02
  4.83360669e+02  4.83360669e+02  5.99941492e+02  1.33508016e+03
  1.33508016e+03  1.33508016e+03  2.67205221e+03  3.02913163e+03
  3.02913163e+03  3.02913163e+03  6.64943639e+03  6.64943639e+03
  6.64943639e+03  9.07684055e+03  2.54315048e+04  7.61727325e+04]
E1 = -728.3452374716753  E_coul = 201.6408152772669
cycle= 1 E= -526.704422194408  delta_E= 2.27e-13  |g|= 6.03e-07  |ddm|= 9.32e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3452374716753  E_coul = 201.6408152772669
  HOMO = -0.575684734889778  LUMO = 1.01902552629504
  mo_energy =
[-1.18575592e+02 -1.23052319e+01 -9.55803168e+00 -9.55803168e+00
 -9.55803168e+00 -1.24983050e+00 -5.75684735e-01 -5.75684735e-01
 -5.75684735e-01  1.01902553e+00  1.01902553e+00  1.01902553e+00
  7.27507453e+00  7.27507453e+00  7.27507453e+00  9.59609165e+00
  3.33895011e+01  3.33895011e+01  3.33895011e+01  1.07701921e+02
  1.28983320e+02  1.28983320e+02  1.28983320e+02  4.83360668e+02
  4.83360668e+02  4.83360668e+02  5.99941491e+02  1.33508015e+03
  1.33508015e+03  1.33508015e+03  2.67205221e+03  3.02913163e+03
  3.02913163e+03  3.02913163e+03  6.64943639e+03  6.64943639e+03
  6.64943639e+03  9.07684055e+03  2.54315048e+04  7.61727325e+04]
E1 = -728.3452397498861  E_coul = 201.64081755547798
Extra cycle  E= -526.704422194408  delta_E= 2.27e-13  |g|= 1.52e-07  |ddm|= 2.19e-07
    CPU time for scf_cycle      3.87 sec, wall time      0.31 sec
exp = [2.61826608e+04 7.61751141e+03 3.61735610e+03 1.59760972e+03
 3.82644367e+02 1.11967927e+02 3.69561667e+01 7.92005936e+00
 3.10096630e+00 3.98527543e-01 1.36278485e+03 6.64729451e+02
 3.00885456e+02 3.13976287e+02 6.16727703e+01 7.32818361e+00
 2.02343899e+01 7.73092173e-01 2.81114306e+00 2.23081493e-01]
grad_E = [-1.54900884e-06  3.66658564e-06 -1.35119198e-06  8.25494267e-05
 -3.16621276e-04 -1.06384716e-05  4.82476493e-06 -7.18450693e-06
  2.04797405e-05 -8.08878747e-05 -5.11512476e-07  4.95150471e-06
  2.33070630e-05  2.00896258e-05 -4.62113479e-06 -1.98474073e-05
 -4.72935485e-06 -1.09981576e-04 -9.72524160e-05  4.63324728e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:59:07 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6607488        1
[INPUT] 0    0    [1    /1   ]  7617.51142376        1
[INPUT] 0    0    [1    /1   ]  3617.35608846        1
[INPUT] 0    0    [1    /1   ]  1597.6100354         1
[INPUT] 0    0    [1    /1   ]  382.645054091        1
[INPUT] 0    0    [1    /1   ]  111.960654435        1
[INPUT] 0    0    [1    /1   ]  36.9530763477        1
[INPUT] 0    0    [1    /1   ]  7.92067934904        1
[INPUT] 0    0    [1    /1   ]  3.1009656724         1
[INPUT] 0    0    [1    /1   ]  0.398536676326       1
[INPUT] 1    0    [1    /1   ]  1362.78484842        1
[INPUT] 1    0    [1    /1   ]  664.729475473        1
[INPUT] 1    0    [1    /1   ]  300.885571812        1
[INPUT] 1    0    [1    /1   ]  313.976386182        1
[INPUT] 1    0    [1    /1   ]  61.6728293425        1
[INPUT] 1    0    [1    /1   ]  7.32930648141        1
[INPUT] 1    0    [1    /1   ]  20.233480605         1
[INPUT] 1    0    [1    /1   ]  0.773179707889       1
[INPUT] 1    0    [1    /1   ]  2.81241708478        1
[INPUT] 1    0    [1    /1   ]  0.223081634181       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.660748798953, 1.0]], [0, [7617.511423758118, 1.0]], [0, [3617.356088464416, 1.0]], [0, [1597.610035400765, 1.0]], [0, [382.64505409064435, 1.0]], [0, [111.96065443521361, 1.0]], [0, [36.953076347674745, 1.0]], [0, [7.920679349043963, 1.0]], [0, [3.100965672403581, 1.0]], [0, [0.3985366763263863, 1.0]], [1, [1362.7848484217159, 1.0]], [1, [664.729475473013, 1.0]], [1, [300.88557181222933, 1.0]], [1, [313.97638618219924, 1.0]], [1, [61.6728293424927, 1.0]], [1, [7.32930648141295, 1.0]], [1, [20.23348060501174, 1.0]], [1, [0.7731797078887681, 1.0]], [1, [2.812417084777714, 1.0]], [1, [0.22308163418117688, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.6607488]
bas 1, expnt(s) = [7617.51142376]
bas 2, expnt(s) = [3617.35608846]
bas 3, expnt(s) = [1597.6100354]
bas 4, expnt(s) = [382.64505409]
bas 5, expnt(s) = [111.96065444]
bas 6, expnt(s) = [36.95307635]
bas 7, expnt(s) = [7.92067935]
bas 8, expnt(s) = [3.10096567]
bas 9, expnt(s) = [0.39853668]
bas 10, expnt(s) = [1362.78484842]
bas 11, expnt(s) = [664.72947547]
bas 12, expnt(s) = [300.88557181]
bas 13, expnt(s) = [313.97638618]
bas 14, expnt(s) = [61.67282934]
bas 15, expnt(s) = [7.32930648]
bas 16, expnt(s) = [20.23348061]
bas 17, expnt(s) = [0.77317971]
bas 18, expnt(s) = [2.81241708]
bas 19, expnt(s) = [0.22308163]
CPU time:      1273.98
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826607e+04 5.20026360e+03 7.61751142e+03 2.06003624e+03
 3.61735609e+03 1.17844270e+03 1.59761004e+03 6.38437090e+02
 3.82645054e+02 2.18580846e+02 1.11960654e+02 8.69589116e+01
 3.69530763e+01 3.78663089e+01 7.92067935e+00 1.19285278e+01
 3.10096567e+00 5.90388301e+00 3.98536676e-01 1.26726151e+00
 1.36278485e+03 2.41556380e+04 6.64729475e+02 9.84669676e+03
 3.00885572e+02 3.65583087e+03 3.13976386e+02 3.85572122e+03
 6.16728293e+01 5.04198714e+02 7.32930648e+00 3.51813901e+01
 2.02334806e+01 1.25190865e+02 7.73179708e-01 2.11511971e+00
 2.81241708e+00 1.06251251e+01 2.23081634e-01 4.47264227e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.983002118860988
cond(S) = 102439.06571885802
E1 = -729.3825153241214  E_coul = 203.12356595610834
init E= -526.258949368013
    CPU time for initialize scf      0.63 sec, wall time      0.05 sec
  HOMO = -0.556918909814128  LUMO = 1.0307924670194
  mo_energy =
[-1.18332424e+02 -1.22078670e+01 -9.45141003e+00 -9.45141003e+00
 -9.45141003e+00 -1.22581644e+00 -5.56918910e-01 -5.56918910e-01
 -5.56918910e-01  1.03079247e+00  1.03079247e+00  1.03079247e+00
  7.33804477e+00  7.33804477e+00  7.33804477e+00  9.66535823e+00
  3.35081839e+01  3.35081839e+01  3.35081839e+01  1.07862916e+02
  1.29162378e+02  1.29162378e+02  1.29162378e+02  4.83607262e+02
  4.83607262e+02  4.83607262e+02  6.00193934e+02  1.33537913e+03
  1.33537913e+03  1.33537913e+03  2.67244522e+03  3.02949456e+03
  3.02949456e+03  3.02949456e+03  6.64991105e+03  6.64991105e+03
  6.64991105e+03  9.07735428e+03  2.54321141e+04  7.61734339e+04]
E1 = -727.9691957946841  E_coul = 201.2654097466881
cycle= 1 E= -526.703786047996  delta_E= -0.445  |g|= 0.185  |ddm|= 0.414
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.542037
diis-c [-0.29380444  1.        ]
  HOMO = -0.581557940340152  LUMO = 1.01466969224759
  mo_energy =
[-1.18627032e+02 -1.23322627e+01 -9.58608934e+00 -9.58608934e+00
 -9.58608934e+00 -1.25734228e+00 -5.81557940e-01 -5.81557940e-01
 -5.81557940e-01  1.01466969e+00  1.01466969e+00  1.01466969e+00
  7.26176142e+00  7.26176142e+00  7.26176142e+00  9.57536535e+00
  3.33677853e+01  3.33677853e+01  3.33677853e+01  1.07653359e+02
  1.28947681e+02  1.28947681e+02  1.28947681e+02  4.83314050e+02
  4.83314050e+02  4.83314050e+02  5.99862059e+02  1.33502983e+03
  1.33502983e+03  1.33502983e+03  2.67196237e+03  3.02907958e+03
  3.02907958e+03  3.02907958e+03  6.64938306e+03  6.64938306e+03
  6.64938306e+03  9.07675125e+03  2.54314170e+04  7.61726467e+04]
E1 = -728.4368211961189  E_coul = 201.73243503905513
cycle= 2 E= -526.704386157064  delta_E= -0.0006  |g|= 0.0337  |ddm|= 0.0391
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0672902
diis-c [-0.0027153   0.07314084  0.92685916]
  HOMO = -0.57476345483453  LUMO = 1.0197898578465
  mo_energy =
[-1.18567913e+02 -1.23011564e+01 -9.55366729e+00 -9.55366729e+00
 -9.55366729e+00 -1.24871956e+00 -5.74763455e-01 -5.74763455e-01
 -5.74763455e-01  1.01978986e+00  1.01978986e+00  1.01978986e+00
  7.28040460e+00  7.28040460e+00  7.28040460e+00  9.59976856e+00
  3.34008262e+01  3.34008262e+01  3.34008262e+01  1.07701737e+02
  1.28995574e+02  1.28995574e+02  1.28995574e+02  4.83372415e+02
  4.83372415e+02  4.83372415e+02  5.99922756e+02  1.33509202e+03
  1.33509202e+03  1.33509202e+03  2.67202761e+03  3.02914386e+03
  3.02914386e+03  3.02914386e+03  6.64944890e+03  6.64944890e+03
  6.64944890e+03  9.07681781e+03  2.54314840e+04  7.61727140e+04]
E1 = -728.3306394963463  E_coul = 201.62621796810302
cycle= 3 E= -526.704421528243  delta_E= -3.54e-05  |g|= 0.00489  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106011
diis-c [-4.57432881e-07 -1.12829818e-03  1.31478416e-01  8.69649882e-01]
  HOMO = -0.575699036748334  LUMO = 1.01909595195028
  mo_energy =
[-1.18575577e+02 -1.23052560e+01 -9.55804433e+00 -9.55804433e+00
 -9.55804433e+00 -1.24985299e+00 -5.75699037e-01 -5.75699037e-01
 -5.75699037e-01  1.01909595e+00  1.01909595e+00  1.01909595e+00
  7.27786432e+00  7.27786432e+00  7.27786432e+00  9.59664010e+00
  3.33963969e+01  3.33963969e+01  3.33963969e+01  1.07695468e+02
  1.28989311e+02  1.28989311e+02  1.28989311e+02  4.83364847e+02
  4.83364847e+02  4.83364847e+02  5.99914856e+02  1.33508393e+03
  1.33508393e+03  1.33508393e+03  2.67201894e+03  3.02913542e+03
  3.02913542e+03  3.02913542e+03  6.64944010e+03  6.64944010e+03
  6.64944010e+03  9.07680882e+03  2.54314748e+04  7.61727047e+04]
E1 = -728.3450963564384  E_coul = 201.64067395965336
cycle= 4 E= -526.704422396785  delta_E= -8.69e-07  |g|= 6.17e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000127853
diis-c [-1.35221645e-09  6.59174309e-05 -9.20767450e-03 -7.18805891e-02
  1.08102235e+00]
  HOMO = -0.57568699024967  LUMO = 1.01910488882372
  mo_energy =
[-1.18575583e+02 -1.23052276e+01 -9.55802792e+00 -9.55802792e+00
 -9.55802792e+00 -1.24983368e+00 -5.75686990e-01 -5.75686990e-01
 -5.75686990e-01  1.01910489e+00  1.01910489e+00  1.01910489e+00
  7.27788455e+00  7.27788455e+00  7.27788455e+00  9.59667562e+00
  3.33964120e+01  3.33964120e+01  3.33964120e+01  1.07695478e+02
  1.28989317e+02  1.28989317e+02  1.28989317e+02  4.83364842e+02
  4.83364842e+02  4.83364842e+02  5.99914844e+02  1.33508392e+03
  1.33508392e+03  1.33508392e+03  2.67201891e+03  3.02913539e+03
  3.02913539e+03  3.02913539e+03  6.64944006e+03  6.64944006e+03
  6.64944006e+03  9.07680877e+03  2.54314748e+04  7.61727046e+04]
E1 = -728.3450982948303  E_coul = 201.64067589792438
cycle= 5 E= -526.704422396906  delta_E= -1.21e-10  |g|= 7.9e-06  |ddm|= 2.53e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3450982948303  E_coul = 201.64067589792438
  HOMO = -0.575690502995909  LUMO = 1.01910232529287
  mo_energy =
[-1.18575601e+02 -1.23052400e+01 -9.55804092e+00 -9.55804092e+00
 -9.55804092e+00 -1.24983799e+00 -5.75690503e-01 -5.75690503e-01
 -5.75690503e-01  1.01910233e+00  1.01910233e+00  1.01910233e+00
  7.27787602e+00  7.27787602e+00  7.27787602e+00  9.59666561e+00
  3.33963993e+01  3.33963993e+01  3.33963993e+01  1.07695462e+02
  1.28989301e+02  1.28989301e+02  1.28989301e+02  4.83364825e+02
  4.83364825e+02  4.83364825e+02  5.99914826e+02  1.33508390e+03
  1.33508390e+03  1.33508390e+03  2.67201889e+03  3.02913538e+03
  3.02913538e+03  3.02913538e+03  6.64944004e+03  6.64944004e+03
  6.64944004e+03  9.07680875e+03  2.54314748e+04  7.61727046e+04]
E1 = -728.3451374142004  E_coul = 201.6407150172908
Extra cycle  E= -526.70442239691  delta_E= -3.64e-12  |g|= 2.34e-06  |ddm|= 4.05e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.22 sec
exp = [2.61826607e+04 7.61751142e+03 3.61735609e+03 1.59761004e+03
 3.82645054e+02 1.11960654e+02 3.69530763e+01 7.92067935e+00
 3.10096567e+00 3.98536676e-01 1.36278485e+03 6.64729475e+02
 3.00885572e+02 3.13976386e+02 6.16728293e+01 7.32930648e+00
 2.02334806e+01 7.73179708e-01 2.81241708e+00 2.23081634e-01]
E = -526.7044223969096
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:59:07 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6607488        1
[INPUT] 0    0    [1    /1   ]  7617.51142376        1
[INPUT] 0    0    [1    /1   ]  3617.35608846        1
[INPUT] 0    0    [1    /1   ]  1597.6100354         1
[INPUT] 0    0    [1    /1   ]  382.645054091        1
[INPUT] 0    0    [1    /1   ]  111.960654435        1
[INPUT] 0    0    [1    /1   ]  36.9530763477        1
[INPUT] 0    0    [1    /1   ]  7.92067934904        1
[INPUT] 0    0    [1    /1   ]  3.1009656724         1
[INPUT] 0    0    [1    /1   ]  0.398536676326       1
[INPUT] 1    0    [1    /1   ]  1362.78484842        1
[INPUT] 1    0    [1    /1   ]  664.729475473        1
[INPUT] 1    0    [1    /1   ]  300.885571812        1
[INPUT] 1    0    [1    /1   ]  313.976386182        1
[INPUT] 1    0    [1    /1   ]  61.6728293425        1
[INPUT] 1    0    [1    /1   ]  7.32930648141        1
[INPUT] 1    0    [1    /1   ]  20.233480605         1
[INPUT] 1    0    [1    /1   ]  0.773179707889       1
[INPUT] 1    0    [1    /1   ]  2.81241708478        1
[INPUT] 1    0    [1    /1   ]  0.223081634181       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.660748798953, 1.0]], [0, [7617.511423758118, 1.0]], [0, [3617.356088464416, 1.0]], [0, [1597.610035400765, 1.0]], [0, [382.64505409064435, 1.0]], [0, [111.96065443521361, 1.0]], [0, [36.953076347674745, 1.0]], [0, [7.920679349043963, 1.0]], [0, [3.100965672403581, 1.0]], [0, [0.3985366763263863, 1.0]], [1, [1362.7848484217159, 1.0]], [1, [664.729475473013, 1.0]], [1, [300.88557181222933, 1.0]], [1, [313.97638618219924, 1.0]], [1, [61.6728293424927, 1.0]], [1, [7.32930648141295, 1.0]], [1, [20.23348060501174, 1.0]], [1, [0.7731797078887681, 1.0]], [1, [2.812417084777714, 1.0]], [1, [0.22308163418117688, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.6607488]
bas 1, expnt(s) = [7617.51142376]
bas 2, expnt(s) = [3617.35608846]
bas 3, expnt(s) = [1597.6100354]
bas 4, expnt(s) = [382.64505409]
bas 5, expnt(s) = [111.96065444]
bas 6, expnt(s) = [36.95307635]
bas 7, expnt(s) = [7.92067935]
bas 8, expnt(s) = [3.10096567]
bas 9, expnt(s) = [0.39853668]
bas 10, expnt(s) = [1362.78484842]
bas 11, expnt(s) = [664.72947547]
bas 12, expnt(s) = [300.88557181]
bas 13, expnt(s) = [313.97638618]
bas 14, expnt(s) = [61.67282934]
bas 15, expnt(s) = [7.32930648]
bas 16, expnt(s) = [20.23348061]
bas 17, expnt(s) = [0.77317971]
bas 18, expnt(s) = [2.81241708]
bas 19, expnt(s) = [0.22308163]
CPU time:      1274.97
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826607e+04 5.20026360e+03 7.61751142e+03 2.06003624e+03
 3.61735609e+03 1.17844270e+03 1.59761004e+03 6.38437090e+02
 3.82645054e+02 2.18580846e+02 1.11960654e+02 8.69589116e+01
 3.69530763e+01 3.78663089e+01 7.92067935e+00 1.19285278e+01
 3.10096567e+00 5.90388301e+00 3.98536676e-01 1.26726151e+00
 1.36278485e+03 2.41556380e+04 6.64729475e+02 9.84669676e+03
 3.00885572e+02 3.65583087e+03 3.13976386e+02 3.85572122e+03
 6.16728293e+01 5.04198714e+02 7.32930648e+00 3.51813901e+01
 2.02334806e+01 1.25190865e+02 7.73179708e-01 2.11511971e+00
 2.81241708e+00 1.06251251e+01 2.23081634e-01 4.47264227e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.983002118860988
cond(S) = 102439.06571885802
E1 = -729.3825153241214  E_coul = 203.12356595610834
init E= -526.258949368013
    CPU time for initialize scf      0.62 sec, wall time      0.05 sec
  HOMO = -0.556918909814128  LUMO = 1.0307924670194
  mo_energy =
[-1.18332424e+02 -1.22078670e+01 -9.45141003e+00 -9.45141003e+00
 -9.45141003e+00 -1.22581644e+00 -5.56918910e-01 -5.56918910e-01
 -5.56918910e-01  1.03079247e+00  1.03079247e+00  1.03079247e+00
  7.33804477e+00  7.33804477e+00  7.33804477e+00  9.66535823e+00
  3.35081839e+01  3.35081839e+01  3.35081839e+01  1.07862916e+02
  1.29162378e+02  1.29162378e+02  1.29162378e+02  4.83607262e+02
  4.83607262e+02  4.83607262e+02  6.00193934e+02  1.33537913e+03
  1.33537913e+03  1.33537913e+03  2.67244522e+03  3.02949456e+03
  3.02949456e+03  3.02949456e+03  6.64991105e+03  6.64991105e+03
  6.64991105e+03  9.07735428e+03  2.54321141e+04  7.61734339e+04]
E1 = -727.9691957946841  E_coul = 201.2654097466881
cycle= 1 E= -526.703786047996  delta_E= -0.445  |g|= 0.185  |ddm|= 0.414
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.542037
diis-c [-0.29380444  1.        ]
  HOMO = -0.581557940340152  LUMO = 1.01466969224759
  mo_energy =
[-1.18627032e+02 -1.23322627e+01 -9.58608934e+00 -9.58608934e+00
 -9.58608934e+00 -1.25734228e+00 -5.81557940e-01 -5.81557940e-01
 -5.81557940e-01  1.01466969e+00  1.01466969e+00  1.01466969e+00
  7.26176142e+00  7.26176142e+00  7.26176142e+00  9.57536535e+00
  3.33677853e+01  3.33677853e+01  3.33677853e+01  1.07653359e+02
  1.28947681e+02  1.28947681e+02  1.28947681e+02  4.83314050e+02
  4.83314050e+02  4.83314050e+02  5.99862059e+02  1.33502983e+03
  1.33502983e+03  1.33502983e+03  2.67196237e+03  3.02907958e+03
  3.02907958e+03  3.02907958e+03  6.64938306e+03  6.64938306e+03
  6.64938306e+03  9.07675125e+03  2.54314170e+04  7.61726467e+04]
E1 = -728.4368211961189  E_coul = 201.73243503905513
cycle= 2 E= -526.704386157064  delta_E= -0.0006  |g|= 0.0337  |ddm|= 0.0391
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0672902
diis-c [-0.0027153   0.07314084  0.92685916]
  HOMO = -0.57476345483453  LUMO = 1.0197898578465
  mo_energy =
[-1.18567913e+02 -1.23011564e+01 -9.55366729e+00 -9.55366729e+00
 -9.55366729e+00 -1.24871956e+00 -5.74763455e-01 -5.74763455e-01
 -5.74763455e-01  1.01978986e+00  1.01978986e+00  1.01978986e+00
  7.28040460e+00  7.28040460e+00  7.28040460e+00  9.59976856e+00
  3.34008262e+01  3.34008262e+01  3.34008262e+01  1.07701737e+02
  1.28995574e+02  1.28995574e+02  1.28995574e+02  4.83372415e+02
  4.83372415e+02  4.83372415e+02  5.99922756e+02  1.33509202e+03
  1.33509202e+03  1.33509202e+03  2.67202761e+03  3.02914386e+03
  3.02914386e+03  3.02914386e+03  6.64944890e+03  6.64944890e+03
  6.64944890e+03  9.07681781e+03  2.54314840e+04  7.61727140e+04]
E1 = -728.3306394963463  E_coul = 201.62621796810302
cycle= 3 E= -526.704421528243  delta_E= -3.54e-05  |g|= 0.00489  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106011
diis-c [-4.57432881e-07 -1.12829818e-03  1.31478416e-01  8.69649882e-01]
  HOMO = -0.575699036748334  LUMO = 1.01909595195028
  mo_energy =
[-1.18575577e+02 -1.23052560e+01 -9.55804433e+00 -9.55804433e+00
 -9.55804433e+00 -1.24985299e+00 -5.75699037e-01 -5.75699037e-01
 -5.75699037e-01  1.01909595e+00  1.01909595e+00  1.01909595e+00
  7.27786432e+00  7.27786432e+00  7.27786432e+00  9.59664010e+00
  3.33963969e+01  3.33963969e+01  3.33963969e+01  1.07695468e+02
  1.28989311e+02  1.28989311e+02  1.28989311e+02  4.83364847e+02
  4.83364847e+02  4.83364847e+02  5.99914856e+02  1.33508393e+03
  1.33508393e+03  1.33508393e+03  2.67201894e+03  3.02913542e+03
  3.02913542e+03  3.02913542e+03  6.64944010e+03  6.64944010e+03
  6.64944010e+03  9.07680882e+03  2.54314748e+04  7.61727047e+04]
E1 = -728.3450963564384  E_coul = 201.64067395965336
cycle= 4 E= -526.704422396785  delta_E= -8.69e-07  |g|= 6.17e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000127853
diis-c [-1.35221645e-09  6.59174309e-05 -9.20767450e-03 -7.18805891e-02
  1.08102235e+00]
  HOMO = -0.57568699024967  LUMO = 1.01910488882372
  mo_energy =
[-1.18575583e+02 -1.23052276e+01 -9.55802792e+00 -9.55802792e+00
 -9.55802792e+00 -1.24983368e+00 -5.75686990e-01 -5.75686990e-01
 -5.75686990e-01  1.01910489e+00  1.01910489e+00  1.01910489e+00
  7.27788455e+00  7.27788455e+00  7.27788455e+00  9.59667562e+00
  3.33964120e+01  3.33964120e+01  3.33964120e+01  1.07695478e+02
  1.28989317e+02  1.28989317e+02  1.28989317e+02  4.83364842e+02
  4.83364842e+02  4.83364842e+02  5.99914844e+02  1.33508392e+03
  1.33508392e+03  1.33508392e+03  2.67201891e+03  3.02913539e+03
  3.02913539e+03  3.02913539e+03  6.64944006e+03  6.64944006e+03
  6.64944006e+03  9.07680877e+03  2.54314748e+04  7.61727046e+04]
E1 = -728.3450982948303  E_coul = 201.64067589792438
cycle= 5 E= -526.704422396906  delta_E= -1.21e-10  |g|= 7.9e-06  |ddm|= 2.53e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3450982948303  E_coul = 201.64067589792438
  HOMO = -0.575690502995909  LUMO = 1.01910232529287
  mo_energy =
[-1.18575601e+02 -1.23052400e+01 -9.55804092e+00 -9.55804092e+00
 -9.55804092e+00 -1.24983799e+00 -5.75690503e-01 -5.75690503e-01
 -5.75690503e-01  1.01910233e+00  1.01910233e+00  1.01910233e+00
  7.27787602e+00  7.27787602e+00  7.27787602e+00  9.59666561e+00
  3.33963993e+01  3.33963993e+01  3.33963993e+01  1.07695462e+02
  1.28989301e+02  1.28989301e+02  1.28989301e+02  4.83364825e+02
  4.83364825e+02  4.83364825e+02  5.99914826e+02  1.33508390e+03
  1.33508390e+03  1.33508390e+03  2.67201889e+03  3.02913538e+03
  3.02913538e+03  3.02913538e+03  6.64944004e+03  6.64944004e+03
  6.64944004e+03  9.07680875e+03  2.54314748e+04  7.61727046e+04]
E1 = -728.3451374142004  E_coul = 201.6407150172908
Extra cycle  E= -526.70442239691  delta_E= -3.64e-12  |g|= 2.34e-06  |ddm|= 4.05e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.22 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102439.06571885802
E1 = -728.3451374142004  E_coul = 201.6407150172908
init E= -526.70442239691
    CPU time for initialize scf      3.87 sec, wall time      0.21 sec
  HOMO = -0.575689786947569  LUMO = 1.01910285405648
  mo_energy =
[-1.18575596e+02 -1.23052371e+01 -9.55803795e+00 -9.55803795e+00
 -9.55803795e+00 -1.24983710e+00 -5.75689787e-01 -5.75689787e-01
 -5.75689787e-01  1.01910285e+00  1.01910285e+00  1.01910285e+00
  7.27787785e+00  7.27787785e+00  7.27787785e+00  9.59666790e+00
  3.33964022e+01  3.33964022e+01  3.33964022e+01  1.07695466e+02
  1.28989305e+02  1.28989305e+02  1.28989305e+02  4.83364829e+02
  4.83364829e+02  4.83364829e+02  5.99914831e+02  1.33508390e+03
  1.33508390e+03  1.33508390e+03  2.67201890e+03  3.02913538e+03
  3.02913538e+03  3.02913538e+03  6.64944005e+03  6.64944005e+03
  6.64944005e+03  9.07680876e+03  2.54314748e+04  7.61727046e+04]
E1 = -728.3451280931749  E_coul = 201.640705696264
cycle= 1 E= -526.704422396911  delta_E= -1.25e-12  |g|= 6.03e-07  |ddm|= 9.32e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3451280931749  E_coul = 201.640705696264
  HOMO = -0.575689945619772  LUMO = 1.01910273623585
  mo_energy =
[-1.18575597e+02 -1.23052378e+01 -9.55803866e+00 -9.55803866e+00
 -9.55803866e+00 -1.24983729e+00 -5.75689946e-01 -5.75689946e-01
 -5.75689946e-01  1.01910274e+00  1.01910274e+00  1.01910274e+00
  7.27787743e+00  7.27787743e+00  7.27787743e+00  9.59666737e+00
  3.33964015e+01  3.33964015e+01  3.33964015e+01  1.07695465e+02
  1.28989304e+02  1.28989304e+02  1.28989304e+02  4.83364828e+02
  4.83364828e+02  4.83364828e+02  5.99914829e+02  1.33508390e+03
  1.33508390e+03  1.33508390e+03  2.67201890e+03  3.02913538e+03
  3.02913538e+03  3.02913538e+03  6.64944005e+03  6.64944005e+03
  6.64944005e+03  9.07680875e+03  2.54314748e+04  7.61727046e+04]
E1 = -728.345130371422  E_coul = 201.6407079745129
Extra cycle  E= -526.704422396909  delta_E= 1.82e-12  |g|= 1.52e-07  |ddm|= 2.19e-07
    CPU time for scf_cycle      3.98 sec, wall time      0.32 sec
exp = [2.61826607e+04 7.61751142e+03 3.61735609e+03 1.59761004e+03
 3.82645054e+02 1.11960654e+02 3.69530763e+01 7.92067935e+00
 3.10096567e+00 3.98536676e-01 1.36278485e+03 6.64729475e+02
 3.00885572e+02 3.13976386e+02 6.16728293e+01 7.32930648e+00
 2.02334806e+01 7.73179708e-01 2.81241708e+00 2.23081634e-01]
grad_E = [-1.54893888e-06  3.66575444e-06 -1.35180924e-06  8.25187438e-05
 -3.15953549e-04 -1.25964171e-05  3.37521074e-06  3.78180471e-06
 -5.65116730e-06  3.71409342e-06 -5.11845902e-07  4.94686158e-06
  2.32790563e-05  2.00655774e-05 -1.67298151e-06 -2.50501614e-05
 -2.12026809e-05  5.37847336e-06 -9.96934622e-06 -3.56155580e-05]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:59:11 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6607426        1
[INPUT] 0    0    [1    /1   ]  7617.51143628        1
[INPUT] 0    0    [1    /1   ]  3617.35608106        1
[INPUT] 0    0    [1    /1   ]  1597.610275          1
[INPUT] 0    0    [1    /1   ]  382.646269082        1
[INPUT] 0    0    [1    /1   ]  111.95239774         1
[INPUT] 0    0    [1    /1   ]  36.949812824         1
[INPUT] 0    0    [1    /1   ]  7.92092401108        1
[INPUT] 0    0    [1    /1   ]  3.10090226507        1
[INPUT] 0    0    [1    /1   ]  0.398543707065       1
[INPUT] 1    0    [1    /1   ]  1362.7848463         1
[INPUT] 1    0    [1    /1   ]  664.729496409        1
[INPUT] 1    0    [1    /1   ]  300.885670442        1
[INPUT] 1    0    [1    /1   ]  313.976471236        1
[INPUT] 1    0    [1    /1   ]  61.6728387054        1
[INPUT] 1    0    [1    /1   ]  7.33014632811        1
[INPUT] 1    0    [1    /1   ]  20.232864938         1
[INPUT] 1    0    [1    /1   ]  0.773245264073       1
[INPUT] 1    0    [1    /1   ]  2.81337548482        1
[INPUT] 1    0    [1    /1   ]  0.223081196238       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.66074256219, 1.0]], [0, [7617.511436278341, 1.0]], [0, [3617.3560810585523, 1.0]], [0, [1597.6102749965694, 1.0]], [0, [382.6462690818694, 1.0]], [0, [111.95239774045854, 1.0]], [0, [36.94981282404388, 1.0]], [0, [7.920924011082272, 1.0]], [0, [3.1009022650748785, 1.0]], [0, [0.3985437070645262, 1.0]], [1, [1362.7848462981722, 1.0]], [1, [664.729496408727, 1.0]], [1, [300.8856704419982, 1.0]], [1, [313.9764712359465, 1.0]], [1, [61.67283870536478, 1.0]], [1, [7.33014632810711, 1.0]], [1, [20.232864937990897, 1.0]], [1, [0.7732452640727251, 1.0]], [1, [2.8133754848150936, 1.0]], [1, [0.2230811962382832, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66074256]
bas 1, expnt(s) = [7617.51143628]
bas 2, expnt(s) = [3617.35608106]
bas 3, expnt(s) = [1597.610275]
bas 4, expnt(s) = [382.64626908]
bas 5, expnt(s) = [111.95239774]
bas 6, expnt(s) = [36.94981282]
bas 7, expnt(s) = [7.92092401]
bas 8, expnt(s) = [3.10090227]
bas 9, expnt(s) = [0.39854371]
bas 10, expnt(s) = [1362.7848463]
bas 11, expnt(s) = [664.72949641]
bas 12, expnt(s) = [300.88567044]
bas 13, expnt(s) = [313.97647124]
bas 14, expnt(s) = [61.67283871]
bas 15, expnt(s) = [7.33014633]
bas 16, expnt(s) = [20.23286494]
bas 17, expnt(s) = [0.77324526]
bas 18, expnt(s) = [2.81337548]
bas 19, expnt(s) = [0.2230812]
CPU time:      1284.89
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826607e+04 5.20026360e+03 7.61751144e+03 2.06003624e+03
 3.61735608e+03 1.17844270e+03 1.59761027e+03 6.38437161e+02
 3.82646269e+02 2.18581366e+02 1.11952398e+02 8.69541019e+01
 3.69498128e+01 3.78638008e+01 7.92092401e+00 1.19288042e+01
 3.10090227e+00 5.90379247e+00 3.98543707e-01 1.26727828e+00
 1.36278485e+03 2.41556380e+04 6.64729496e+02 9.84669715e+03
 3.00885670e+02 3.65583237e+03 3.13976471e+02 3.85572253e+03
 6.16728387e+01 5.04198810e+02 7.33014633e+00 3.51864294e+01
 2.02328649e+01 1.25186103e+02 7.73245264e-01 2.11534388e+00
 2.81337548e+00 1.06296513e+01 2.23081196e-01 4.47263130e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.983000366990662
cond(S) = 102439.69594558816
E1 = -729.3825727028251  E_coul = 203.12361209071958
init E= -526.258960612106
    CPU time for initialize scf      1.13 sec, wall time      0.07 sec
  HOMO = -0.556917282007528  LUMO = 1.03085409142311
  mo_energy =
[-1.18332420e+02 -1.22078642e+01 -9.45140694e+00 -9.45140694e+00
 -9.45140694e+00 -1.22581426e+00 -5.56917282e-01 -5.56917282e-01
 -5.56917282e-01  1.03085409e+00  1.03085409e+00  1.03085409e+00
  7.34016825e+00  7.34016825e+00  7.34016825e+00  9.66537102e+00
  3.35134139e+01  3.35134139e+01  3.35134139e+01  1.07853929e+02
  1.29167021e+02  1.29167021e+02  1.29167021e+02  4.83610520e+02
  4.83610520e+02  4.83610520e+02  6.00162838e+02  1.33538207e+03
  1.33538207e+03  1.33538207e+03  2.67240763e+03  3.02949752e+03
  3.02949752e+03  3.02949752e+03  6.64991395e+03  6.64991395e+03
  6.64991395e+03  9.07731870e+03  2.54320804e+04  7.61734026e+04]
E1 = -727.9690842121374  E_coul = 201.2652979933425
cycle= 1 E= -526.703786218795  delta_E= -0.445  |g|= 0.185  |ddm|= 0.414
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.542047
diis-c [-0.29381483  1.        ]
  HOMO = -0.581562609921356  LUMO = 1.01472441558147
  mo_energy =
[-1.18627039e+02 -1.23322694e+01 -9.58609663e+00 -9.58609663e+00
 -9.58609663e+00 -1.25734829e+00 -5.81562610e-01 -5.81562610e-01
 -5.81562610e-01  1.01472442e+00  1.01472442e+00  1.01472442e+00
  7.26386029e+00  7.26386029e+00  7.26386029e+00  9.57536811e+00
  3.33730042e+01  3.33730042e+01  3.33730042e+01  1.07644368e+02
  1.28952316e+02  1.28952316e+02  1.28952316e+02  4.83317297e+02
  4.83317297e+02  4.83317297e+02  5.99830954e+02  1.33503276e+03
  1.33503276e+03  1.33503276e+03  2.67192476e+03  3.02908253e+03
  3.02908253e+03  3.02908253e+03  6.64938595e+03  6.64938595e+03
  6.64938595e+03  9.07671566e+03  2.54313833e+04  7.61726154e+04]
E1 = -728.43674008528  E_coul = 201.73235370038677
cycle= 2 E= -526.704386384893  delta_E= -0.0006  |g|= 0.0337  |ddm|= 0.0391
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0672953
diis-c [-0.00271552  0.07314839  0.92685161]
  HOMO = -0.574767609522779  LUMO = 1.01984557257405
  mo_energy =
[-1.18567918e+02 -1.23011612e+01 -9.55367265e+00 -9.55367265e+00
 -9.55367265e+00 -1.24872487e+00 -5.74767610e-01 -5.74767610e-01
 -5.74767610e-01  1.01984557e+00  1.01984557e+00  1.01984557e+00
  7.28250786e+00  7.28250786e+00  7.28250786e+00  9.59977274e+00
  3.34060474e+01  3.34060474e+01  3.34060474e+01  1.07692748e+02
  1.29000211e+02  1.29000211e+02  1.29000211e+02  4.83375664e+02
  4.83375664e+02  4.83375664e+02  5.99891653e+02  1.33509495e+03
  1.33509495e+03  1.33509495e+03  2.67199001e+03  3.02914681e+03
  3.02914681e+03  3.02914681e+03  6.64945179e+03  6.64945179e+03
  6.64945179e+03  9.07678221e+03  2.54314504e+04  7.61726827e+04]
E1 = -728.3305512619223  E_coul = 201.6261295013125
cycle= 3 E= -526.70442176061  delta_E= -3.54e-05  |g|= 0.00489  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106015
diis-c [-4.57490153e-07 -1.12833618e-03  1.31473169e-01  8.69655167e-01]
  HOMO = -0.575703242926168  LUMO = 1.01915154507415
  mo_energy =
[-1.18575582e+02 -1.23052609e+01 -9.55804975e+00 -9.55804975e+00
 -9.55804975e+00 -1.24985837e+00 -5.75703243e-01 -5.75703243e-01
 -5.75703243e-01  1.01915155e+00  1.01915155e+00  1.01915155e+00
  7.27996707e+00  7.27996707e+00  7.27996707e+00  9.59664421e+00
  3.34016179e+01  3.34016179e+01  3.34016179e+01  1.07686478e+02
  1.28993947e+02  1.28993947e+02  1.28993947e+02  4.83368097e+02
  4.83368097e+02  4.83368097e+02  5.99883753e+02  1.33508686e+03
  1.33508686e+03  1.33508686e+03  2.67198134e+03  3.02913837e+03
  3.02913837e+03  3.02913837e+03  6.64944299e+03  6.64944299e+03
  6.64944299e+03  9.07677322e+03  2.54314412e+04  7.61726734e+04]
E1 = -728.3450084222815  E_coul = 201.64058579310375
cycle= 4 E= -526.704422629178  delta_E= -8.69e-07  |g|= 6.17e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000127869
diis-c [-1.35196088e-09  6.59187159e-05 -9.20754065e-03 -7.18837985e-02
  1.08102542e+00]
  HOMO = -0.575691199708763  LUMO = 1.01916048029528
  mo_energy =
[-1.18575588e+02 -1.23052325e+01 -9.55803335e+00 -9.55803335e+00
 -9.55803335e+00 -1.24983906e+00 -5.75691200e-01 -5.75691200e-01
 -5.75691200e-01  1.01916048e+00  1.01916048e+00  1.01916048e+00
  7.27998730e+00  7.27998730e+00  7.27998730e+00  9.59667973e+00
  3.34016330e+01  3.34016330e+01  3.34016330e+01  1.07686488e+02
  1.28993953e+02  1.28993953e+02  1.28993953e+02  4.83368091e+02
  4.83368091e+02  4.83368091e+02  5.99883741e+02  1.33508685e+03
  1.33508685e+03  1.33508685e+03  2.67198131e+03  3.02913835e+03
  3.02913835e+03  3.02913835e+03  6.64944296e+03  6.64944296e+03
  6.64944296e+03  9.07677318e+03  2.54314412e+04  7.61726733e+04]
E1 = -728.3450103718815  E_coul = 201.64058774258302
cycle= 5 E= -526.704422629299  delta_E= -1.21e-10  |g|= 7.9e-06  |ddm|= 2.53e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3450103718815  E_coul = 201.64058774258302
  HOMO = -0.57569471259162  LUMO = 1.01915791636284
  mo_energy =
[-1.18575606e+02 -1.23052449e+01 -9.55804634e+00 -9.55804634e+00
 -9.55804634e+00 -1.24984337e+00 -5.75694713e-01 -5.75694713e-01
 -5.75694713e-01  1.01915792e+00  1.01915792e+00  1.01915792e+00
  7.27997876e+00  7.27997876e+00  7.27997876e+00  9.59666972e+00
  3.34016203e+01  3.34016203e+01  3.34016203e+01  1.07686473e+02
  1.28993938e+02  1.28993938e+02  1.28993938e+02  4.83368074e+02
  4.83368074e+02  4.83368074e+02  5.99883723e+02  1.33508683e+03
  1.33508683e+03  1.33508683e+03  2.67198129e+03  3.02913833e+03
  3.02913833e+03  3.02913833e+03  6.64944294e+03  6.64944294e+03
  6.64944294e+03  9.07677316e+03  2.54314411e+04  7.61726733e+04]
E1 = -728.3450494927608  E_coul = 201.6406268634588
Extra cycle  E= -526.704422629302  delta_E= -3.52e-12  |g|= 2.34e-06  |ddm|= 4.05e-06
    CPU time for scf_cycle      1.31 sec, wall time      0.25 sec
exp = [2.61826607e+04 7.61751144e+03 3.61735608e+03 1.59761027e+03
 3.82646269e+02 1.11952398e+02 3.69498128e+01 7.92092401e+00
 3.10090227e+00 3.98543707e-01 1.36278485e+03 6.64729496e+02
 3.00885670e+02 3.13976471e+02 6.16728387e+01 7.33014633e+00
 2.02328649e+01 7.73245264e-01 2.81337548e+00 2.23081196e-01]
E = -526.704422629302
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:59:12 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6607426        1
[INPUT] 0    0    [1    /1   ]  7617.51143628        1
[INPUT] 0    0    [1    /1   ]  3617.35608106        1
[INPUT] 0    0    [1    /1   ]  1597.610275          1
[INPUT] 0    0    [1    /1   ]  382.646269082        1
[INPUT] 0    0    [1    /1   ]  111.95239774         1
[INPUT] 0    0    [1    /1   ]  36.949812824         1
[INPUT] 0    0    [1    /1   ]  7.92092401108        1
[INPUT] 0    0    [1    /1   ]  3.10090226507        1
[INPUT] 0    0    [1    /1   ]  0.398543707065       1
[INPUT] 1    0    [1    /1   ]  1362.7848463         1
[INPUT] 1    0    [1    /1   ]  664.729496409        1
[INPUT] 1    0    [1    /1   ]  300.885670442        1
[INPUT] 1    0    [1    /1   ]  313.976471236        1
[INPUT] 1    0    [1    /1   ]  61.6728387054        1
[INPUT] 1    0    [1    /1   ]  7.33014632811        1
[INPUT] 1    0    [1    /1   ]  20.232864938         1
[INPUT] 1    0    [1    /1   ]  0.773245264073       1
[INPUT] 1    0    [1    /1   ]  2.81337548482        1
[INPUT] 1    0    [1    /1   ]  0.223081196238       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.66074256219, 1.0]], [0, [7617.511436278341, 1.0]], [0, [3617.3560810585523, 1.0]], [0, [1597.6102749965694, 1.0]], [0, [382.6462690818694, 1.0]], [0, [111.95239774045854, 1.0]], [0, [36.94981282404388, 1.0]], [0, [7.920924011082272, 1.0]], [0, [3.1009022650748785, 1.0]], [0, [0.3985437070645262, 1.0]], [1, [1362.7848462981722, 1.0]], [1, [664.729496408727, 1.0]], [1, [300.8856704419982, 1.0]], [1, [313.9764712359465, 1.0]], [1, [61.67283870536478, 1.0]], [1, [7.33014632810711, 1.0]], [1, [20.232864937990897, 1.0]], [1, [0.7732452640727251, 1.0]], [1, [2.8133754848150936, 1.0]], [1, [0.2230811962382832, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66074256]
bas 1, expnt(s) = [7617.51143628]
bas 2, expnt(s) = [3617.35608106]
bas 3, expnt(s) = [1597.610275]
bas 4, expnt(s) = [382.64626908]
bas 5, expnt(s) = [111.95239774]
bas 6, expnt(s) = [36.94981282]
bas 7, expnt(s) = [7.92092401]
bas 8, expnt(s) = [3.10090227]
bas 9, expnt(s) = [0.39854371]
bas 10, expnt(s) = [1362.7848463]
bas 11, expnt(s) = [664.72949641]
bas 12, expnt(s) = [300.88567044]
bas 13, expnt(s) = [313.97647124]
bas 14, expnt(s) = [61.67283871]
bas 15, expnt(s) = [7.33014633]
bas 16, expnt(s) = [20.23286494]
bas 17, expnt(s) = [0.77324526]
bas 18, expnt(s) = [2.81337548]
bas 19, expnt(s) = [0.2230812]
CPU time:      1286.40
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826607e+04 5.20026360e+03 7.61751144e+03 2.06003624e+03
 3.61735608e+03 1.17844270e+03 1.59761027e+03 6.38437161e+02
 3.82646269e+02 2.18581366e+02 1.11952398e+02 8.69541019e+01
 3.69498128e+01 3.78638008e+01 7.92092401e+00 1.19288042e+01
 3.10090227e+00 5.90379247e+00 3.98543707e-01 1.26727828e+00
 1.36278485e+03 2.41556380e+04 6.64729496e+02 9.84669715e+03
 3.00885670e+02 3.65583237e+03 3.13976471e+02 3.85572253e+03
 6.16728387e+01 5.04198810e+02 7.33014633e+00 3.51864294e+01
 2.02328649e+01 1.25186103e+02 7.73245264e-01 2.11534388e+00
 2.81337548e+00 1.06296513e+01 2.23081196e-01 4.47263130e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.983000366990662
cond(S) = 102439.69594558816
E1 = -729.3825727028251  E_coul = 203.12361209071958
init E= -526.258960612106
    CPU time for initialize scf      0.98 sec, wall time      0.06 sec
  HOMO = -0.556917282007528  LUMO = 1.03085409142311
  mo_energy =
[-1.18332420e+02 -1.22078642e+01 -9.45140694e+00 -9.45140694e+00
 -9.45140694e+00 -1.22581426e+00 -5.56917282e-01 -5.56917282e-01
 -5.56917282e-01  1.03085409e+00  1.03085409e+00  1.03085409e+00
  7.34016825e+00  7.34016825e+00  7.34016825e+00  9.66537102e+00
  3.35134139e+01  3.35134139e+01  3.35134139e+01  1.07853929e+02
  1.29167021e+02  1.29167021e+02  1.29167021e+02  4.83610520e+02
  4.83610520e+02  4.83610520e+02  6.00162838e+02  1.33538207e+03
  1.33538207e+03  1.33538207e+03  2.67240763e+03  3.02949752e+03
  3.02949752e+03  3.02949752e+03  6.64991395e+03  6.64991395e+03
  6.64991395e+03  9.07731870e+03  2.54320804e+04  7.61734026e+04]
E1 = -727.9690842121374  E_coul = 201.2652979933425
cycle= 1 E= -526.703786218795  delta_E= -0.445  |g|= 0.185  |ddm|= 0.414
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.542047
diis-c [-0.29381483  1.        ]
  HOMO = -0.581562609921356  LUMO = 1.01472441558147
  mo_energy =
[-1.18627039e+02 -1.23322694e+01 -9.58609663e+00 -9.58609663e+00
 -9.58609663e+00 -1.25734829e+00 -5.81562610e-01 -5.81562610e-01
 -5.81562610e-01  1.01472442e+00  1.01472442e+00  1.01472442e+00
  7.26386029e+00  7.26386029e+00  7.26386029e+00  9.57536811e+00
  3.33730042e+01  3.33730042e+01  3.33730042e+01  1.07644368e+02
  1.28952316e+02  1.28952316e+02  1.28952316e+02  4.83317297e+02
  4.83317297e+02  4.83317297e+02  5.99830954e+02  1.33503276e+03
  1.33503276e+03  1.33503276e+03  2.67192476e+03  3.02908253e+03
  3.02908253e+03  3.02908253e+03  6.64938595e+03  6.64938595e+03
  6.64938595e+03  9.07671566e+03  2.54313833e+04  7.61726154e+04]
E1 = -728.43674008528  E_coul = 201.73235370038677
cycle= 2 E= -526.704386384893  delta_E= -0.0006  |g|= 0.0337  |ddm|= 0.0391
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0672953
diis-c [-0.00271552  0.07314839  0.92685161]
  HOMO = -0.574767609522779  LUMO = 1.01984557257405
  mo_energy =
[-1.18567918e+02 -1.23011612e+01 -9.55367265e+00 -9.55367265e+00
 -9.55367265e+00 -1.24872487e+00 -5.74767610e-01 -5.74767610e-01
 -5.74767610e-01  1.01984557e+00  1.01984557e+00  1.01984557e+00
  7.28250786e+00  7.28250786e+00  7.28250786e+00  9.59977274e+00
  3.34060474e+01  3.34060474e+01  3.34060474e+01  1.07692748e+02
  1.29000211e+02  1.29000211e+02  1.29000211e+02  4.83375664e+02
  4.83375664e+02  4.83375664e+02  5.99891653e+02  1.33509495e+03
  1.33509495e+03  1.33509495e+03  2.67199001e+03  3.02914681e+03
  3.02914681e+03  3.02914681e+03  6.64945179e+03  6.64945179e+03
  6.64945179e+03  9.07678221e+03  2.54314504e+04  7.61726827e+04]
E1 = -728.3305512619223  E_coul = 201.6261295013125
cycle= 3 E= -526.70442176061  delta_E= -3.54e-05  |g|= 0.00489  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106015
diis-c [-4.57490153e-07 -1.12833618e-03  1.31473169e-01  8.69655167e-01]
  HOMO = -0.575703242926168  LUMO = 1.01915154507415
  mo_energy =
[-1.18575582e+02 -1.23052609e+01 -9.55804975e+00 -9.55804975e+00
 -9.55804975e+00 -1.24985837e+00 -5.75703243e-01 -5.75703243e-01
 -5.75703243e-01  1.01915155e+00  1.01915155e+00  1.01915155e+00
  7.27996707e+00  7.27996707e+00  7.27996707e+00  9.59664421e+00
  3.34016179e+01  3.34016179e+01  3.34016179e+01  1.07686478e+02
  1.28993947e+02  1.28993947e+02  1.28993947e+02  4.83368097e+02
  4.83368097e+02  4.83368097e+02  5.99883753e+02  1.33508686e+03
  1.33508686e+03  1.33508686e+03  2.67198134e+03  3.02913837e+03
  3.02913837e+03  3.02913837e+03  6.64944299e+03  6.64944299e+03
  6.64944299e+03  9.07677322e+03  2.54314412e+04  7.61726734e+04]
E1 = -728.3450084222815  E_coul = 201.64058579310375
cycle= 4 E= -526.704422629178  delta_E= -8.69e-07  |g|= 6.17e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000127869
diis-c [-1.35196088e-09  6.59187159e-05 -9.20754065e-03 -7.18837985e-02
  1.08102542e+00]
  HOMO = -0.575691199708763  LUMO = 1.01916048029528
  mo_energy =
[-1.18575588e+02 -1.23052325e+01 -9.55803335e+00 -9.55803335e+00
 -9.55803335e+00 -1.24983906e+00 -5.75691200e-01 -5.75691200e-01
 -5.75691200e-01  1.01916048e+00  1.01916048e+00  1.01916048e+00
  7.27998730e+00  7.27998730e+00  7.27998730e+00  9.59667973e+00
  3.34016330e+01  3.34016330e+01  3.34016330e+01  1.07686488e+02
  1.28993953e+02  1.28993953e+02  1.28993953e+02  4.83368091e+02
  4.83368091e+02  4.83368091e+02  5.99883741e+02  1.33508685e+03
  1.33508685e+03  1.33508685e+03  2.67198131e+03  3.02913835e+03
  3.02913835e+03  3.02913835e+03  6.64944296e+03  6.64944296e+03
  6.64944296e+03  9.07677318e+03  2.54314412e+04  7.61726733e+04]
E1 = -728.3450103718815  E_coul = 201.64058774258302
cycle= 5 E= -526.704422629299  delta_E= -1.21e-10  |g|= 7.9e-06  |ddm|= 2.53e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3450103718815  E_coul = 201.64058774258302
  HOMO = -0.57569471259162  LUMO = 1.01915791636284
  mo_energy =
[-1.18575606e+02 -1.23052449e+01 -9.55804634e+00 -9.55804634e+00
 -9.55804634e+00 -1.24984337e+00 -5.75694713e-01 -5.75694713e-01
 -5.75694713e-01  1.01915792e+00  1.01915792e+00  1.01915792e+00
  7.27997876e+00  7.27997876e+00  7.27997876e+00  9.59666972e+00
  3.34016203e+01  3.34016203e+01  3.34016203e+01  1.07686473e+02
  1.28993938e+02  1.28993938e+02  1.28993938e+02  4.83368074e+02
  4.83368074e+02  4.83368074e+02  5.99883723e+02  1.33508683e+03
  1.33508683e+03  1.33508683e+03  2.67198129e+03  3.02913833e+03
  3.02913833e+03  3.02913833e+03  6.64944294e+03  6.64944294e+03
  6.64944294e+03  9.07677316e+03  2.54314411e+04  7.61726733e+04]
E1 = -728.3450494927608  E_coul = 201.6406268634588
Extra cycle  E= -526.704422629302  delta_E= -3.52e-12  |g|= 2.34e-06  |ddm|= 4.05e-06
    CPU time for scf_cycle      1.18 sec, wall time      0.24 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102439.69594558816
E1 = -728.3450494927608  E_coul = 201.6406268634588
init E= -526.704422629302
    CPU time for initialize scf      3.77 sec, wall time      0.20 sec
  HOMO = -0.575693996501952  LUMO = 1.01915844521755
  mo_energy =
[-1.18575601e+02 -1.23052420e+01 -9.55804338e+00 -9.55804338e+00
 -9.55804338e+00 -1.24984248e+00 -5.75693997e-01 -5.75693997e-01
 -5.75693997e-01  1.01915845e+00  1.01915845e+00  1.01915845e+00
  7.27998059e+00  7.27998059e+00  7.27998059e+00  9.59667200e+00
  3.34016232e+01  3.34016232e+01  3.34016232e+01  1.07686477e+02
  1.28993942e+02  1.28993942e+02  1.28993942e+02  4.83368079e+02
  4.83368079e+02  4.83368079e+02  5.99883728e+02  1.33508683e+03
  1.33508683e+03  1.33508683e+03  2.67198129e+03  3.02913833e+03
  3.02913833e+03  3.02913833e+03  6.64944294e+03  6.64944294e+03
  6.64944294e+03  9.07677316e+03  2.54314411e+04  7.61726733e+04]
E1 = -728.3450401712215  E_coul = 201.6406175419183
cycle= 1 E= -526.704422629303  delta_E= -1.25e-12  |g|= 6.03e-07  |ddm|= 9.32e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3450401712215  E_coul = 201.6406175419183
  HOMO = -0.575694155188499  LUMO = 1.01915832737343
  mo_energy =
[-1.18575602e+02 -1.23052427e+01 -9.55804408e+00 -9.55804408e+00
 -9.55804408e+00 -1.24984268e+00 -5.75694155e-01 -5.75694155e-01
 -5.75694155e-01  1.01915833e+00  1.01915833e+00  1.01915833e+00
  7.27998017e+00  7.27998017e+00  7.27998017e+00  9.59667148e+00
  3.34016225e+01  3.34016225e+01  3.34016225e+01  1.07686476e+02
  1.28993941e+02  1.28993941e+02  1.28993941e+02  4.83368078e+02
  4.83368078e+02  4.83368078e+02  5.99883726e+02  1.33508683e+03
  1.33508683e+03  1.33508683e+03  2.67198129e+03  3.02913833e+03
  3.02913833e+03  3.02913833e+03  6.64944294e+03  6.64944294e+03
  6.64944294e+03  9.07677316e+03  2.54314411e+04  7.61726733e+04]
E1 = -728.3450424496235  E_coul = 201.64061982032075
Extra cycle  E= -526.704422629303  delta_E= 4.55e-13  |g|= 1.52e-07  |ddm|= 2.19e-07
    CPU time for scf_cycle      3.88 sec, wall time      0.31 sec
exp = [2.61826607e+04 7.61751144e+03 3.61735608e+03 1.59761027e+03
 3.82646269e+02 1.11952398e+02 3.69498128e+01 7.92092401e+00
 3.10090227e+00 3.98543707e-01 1.36278485e+03 6.64729496e+02
 3.00885670e+02 3.13976471e+02 6.16728387e+01 7.33014633e+00
 2.02328649e+01 7.73245264e-01 2.81337548e+00 2.23081196e-01]
grad_E = [-1.54885049e-06  3.66470629e-06 -1.35258500e-06  8.24800427e-05
 -3.15097381e-04 -1.54697809e-05  3.27459801e-06  1.05779715e-05
 -2.34519533e-05  7.05346430e-05 -5.12072349e-07  4.94370005e-06
  2.32599729e-05  2.00491944e-05  3.44207155e-07 -3.22463585e-05
 -3.22360070e-05  9.60499732e-05  5.85145883e-05 -4.24915077e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:59:16 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6607381        1
[INPUT] 0    0    [1    /1   ]  7617.51144275        1
[INPUT] 0    0    [1    /1   ]  3617.35607352        1
[INPUT] 0    0    [1    /1   ]  1597.61034258        1
[INPUT] 0    0    [1    /1   ]  382.649953597        1
[INPUT] 0    0    [1    /1   ]  111.937192256        1
[INPUT] 0    0    [1    /1   ]  36.943738059         1
[INPUT] 0    0    [1    /1   ]  7.92126272           1
[INPUT] 0    0    [1    /1   ]  3.1007555351         1
[INPUT] 0    0    [1    /1   ]  0.398556828519       1
[INPUT] 1    0    [1    /1   ]  1362.7848447         1
[INPUT] 1    0    [1    /1   ]  664.729512635        1
[INPUT] 1    0    [1    /1   ]  300.885747033        1
[INPUT] 1    0    [1    /1   ]  313.976537326        1
[INPUT] 1    0    [1    /1   ]  61.6728489264        1
[INPUT] 1    0    [1    /1   ]  7.33168838607        1
[INPUT] 1    0    [1    /1   ]  20.2319177019        1
[INPUT] 1    0    [1    /1   ]  0.773361808667       1
[INPUT] 1    0    [1    /1   ]  2.81509849137        1
[INPUT] 1    0    [1    /1   ]  0.223079186941       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.660738077222, 1.0]], [0, [7617.511442750814, 1.0]], [0, [3617.3560735156134, 1.0]], [0, [1597.6103425809397, 1.0]], [0, [382.64995359651647, 1.0]], [0, [111.93719225636436, 1.0]], [0, [36.94373805898653, 1.0]], [0, [7.921262719999386, 1.0]], [0, [3.1007555351024227, 1.0]], [0, [0.3985568285191867, 1.0]], [1, [1362.7848447018, 1.0]], [1, [664.7295126352643, 1.0]], [1, [300.8857470334423, 1.0]], [1, [313.9765373261045, 1.0]], [1, [61.672848926421544, 1.0]], [1, [7.331688386074367, 1.0]], [1, [20.23191770189335, 1.0]], [1, [0.7733618086667691, 1.0]], [1, [2.815098491367996, 1.0]], [1, [0.22307918694059944, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66073808]
bas 1, expnt(s) = [7617.51144275]
bas 2, expnt(s) = [3617.35607352]
bas 3, expnt(s) = [1597.61034258]
bas 4, expnt(s) = [382.6499536]
bas 5, expnt(s) = [111.93719226]
bas 6, expnt(s) = [36.94373806]
bas 7, expnt(s) = [7.92126272]
bas 8, expnt(s) = [3.10075554]
bas 9, expnt(s) = [0.39855683]
bas 10, expnt(s) = [1362.7848447]
bas 11, expnt(s) = [664.72951264]
bas 12, expnt(s) = [300.88574703]
bas 13, expnt(s) = [313.97653733]
bas 14, expnt(s) = [61.67284893]
bas 15, expnt(s) = [7.33168839]
bas 16, expnt(s) = [20.2319177]
bas 17, expnt(s) = [0.77336181]
bas 18, expnt(s) = [2.81509849]
bas 19, expnt(s) = [0.22307919]
CPU time:      1296.20
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826607e+04 5.20026359e+03 7.61751144e+03 2.06003624e+03
 3.61735607e+03 1.17844270e+03 1.59761034e+03 6.38437182e+02
 3.82649954e+02 2.18582945e+02 1.11937192e+02 8.69452441e+01
 3.69437381e+01 3.78591319e+01 7.92126272e+00 1.19291867e+01
 3.10075554e+00 5.90358295e+00 3.98556829e-01 1.26730957e+00
 1.36278484e+03 2.41556379e+04 6.64729513e+02 9.84669745e+03
 3.00885747e+02 3.65583353e+03 3.13976537e+02 3.85572354e+03
 6.16728489e+01 5.04198914e+02 7.33168839e+00 3.51956824e+01
 2.02319177e+01 1.25178777e+02 7.73361809e-01 2.11574242e+00
 2.81509849e+00 1.06377893e+01 2.23079187e-01 4.47258094e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982997303138916
cond(S) = 102440.59406715143
E1 = -729.3826806633949  E_coul = 203.1236992818822
init E= -526.258981381513
    CPU time for initialize scf      0.62 sec, wall time      0.05 sec
  HOMO = -0.556914271779095  LUMO = 1.03095906782015
  mo_energy =
[-1.18332413e+02 -1.22078591e+01 -9.45140098e+00 -9.45140098e+00
 -9.45140098e+00 -1.22581019e+00 -5.56914272e-01 -5.56914272e-01
 -5.56914272e-01  1.03095907e+00  1.03095907e+00  1.03095907e+00
  7.34398401e+00  7.34398401e+00  7.34398401e+00  9.66519630e+00
  3.35229884e+01  3.35229884e+01  3.35229884e+01  1.07836675e+02
  1.29175902e+02  1.29175902e+02  1.29175902e+02  4.83616913e+02
  4.83616913e+02  4.83616913e+02  6.00105786e+02  1.33538765e+03
  1.33538765e+03  1.33538765e+03  2.67234132e+03  3.02950284e+03
  3.02950284e+03  3.02950284e+03  6.64991895e+03  6.64991895e+03
  6.64991895e+03  9.07725681e+03  2.54320220e+04  7.61733482e+04]
E1 = -727.9688685745851  E_coul = 201.2650818053622
cycle= 1 E= -526.703786769223  delta_E= -0.445  |g|= 0.185  |ddm|= 0.414
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.542064
diis-c [-0.29383332  1.        ]
  HOMO = -0.581571527338528  LUMO = 1.0148166082204
  mo_energy =
[-1.18627054e+02 -1.23322826e+01 -9.58611074e+00 -9.58611074e+00
 -9.58611074e+00 -1.25735970e+00 -5.81571527e-01 -5.81571527e-01
 -5.81571527e-01  1.01481661e+00  1.01481661e+00  1.01481661e+00
  7.26763059e+00  7.26763059e+00  7.26763059e+00  9.57517493e+00
  3.33825571e+01  3.33825571e+01  3.33825571e+01  1.07627106e+02
  1.28961181e+02  1.28961181e+02  1.28961181e+02  4.83323670e+02
  4.83323670e+02  4.83323670e+02  5.99773883e+02  1.33503831e+03
  1.33503831e+03  1.33503831e+03  2.67185842e+03  3.02908783e+03
  3.02908783e+03  3.02908783e+03  6.64939092e+03  6.64939092e+03
  6.64939092e+03  9.07665374e+03  2.54313248e+04  7.61725609e+04]
E1 = -728.4365844738161  E_coul = 201.73219742716003
cycle= 2 E= -526.704387046656  delta_E= -0.0006  |g|= 0.0337  |ddm|= 0.0392
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.067305
diis-c [-0.00271594  0.07316281  0.92683719]
  HOMO = -0.574775510309888  LUMO = 1.01993959688678
  mo_energy =
[-1.18567928e+02 -1.23011707e+01 -9.55368294e+00 -9.55368294e+00
 -9.55368294e+00 -1.24873490e+00 -5.74775510e-01 -5.74775510e-01
 -5.74775510e-01  1.01993960e+00  1.01993960e+00  1.01993960e+00
  7.28628628e+00  7.28628628e+00  7.28628628e+00  9.59958217e+00
  3.34156046e+01  3.34156046e+01  3.34156046e+01  1.07675488e+02
  1.29009079e+02  1.29009079e+02  1.29009079e+02  4.83382041e+02
  4.83382041e+02  4.83382041e+02  5.99834586e+02  1.33510052e+03
  1.33510052e+03  1.33510052e+03  2.67192367e+03  3.02915211e+03
  3.02915211e+03  3.02915211e+03  6.64945676e+03  6.64945676e+03
  6.64945676e+03  9.07672030e+03  2.54313919e+04  7.61726282e+04]
E1 = -728.3303813130951  E_coul = 201.62595888169494
cycle= 3 E= -526.7044224314  delta_E= -3.54e-05  |g|= 0.00489  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106022
diis-c [-4.57601746e-07 -1.12841344e-03  1.31463606e-01  8.69664807e-01]
  HOMO = -0.575711249130641  LUMO = 1.01924534382163
  mo_energy =
[-1.18575592e+02 -1.23052706e+01 -9.55806019e+00 -9.55806019e+00
 -9.55806019e+00 -1.24986854e+00 -5.75711249e-01 -5.75711249e-01
 -5.75711249e-01  1.01924534e+00  1.01924534e+00  1.01924534e+00
  7.28374456e+00  7.28374456e+00  7.28374456e+00  9.59645353e+00
  3.34111749e+01  3.34111749e+01  3.34111749e+01  1.07669219e+02
  1.29002815e+02  1.29002815e+02  1.29002815e+02  4.83374474e+02
  4.83374474e+02  4.83374474e+02  5.99826687e+02  1.33509242e+03
  1.33509242e+03  1.33509242e+03  2.67191500e+03  3.02914367e+03
  3.02914367e+03  3.02914367e+03  6.64944797e+03  6.64944797e+03
  6.64944797e+03  9.07671131e+03  2.54313827e+04  7.61726189e+04]
E1 = -728.344839204194  E_coul = 201.6404159041595
cycle= 4 E= -526.704423300034  delta_E= -8.69e-07  |g|= 6.17e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000127899
diis-c [-1.35152505e-09  6.59212574e-05 -9.20726233e-03 -7.18894442e-02
  1.08103079e+00]
  HOMO = -0.57569921180157  LUMO = 1.01925427605741
  mo_energy =
[-1.18575598e+02 -1.23052421e+01 -9.55804381e+00 -9.55804381e+00
 -9.55804381e+00 -1.24984924e+00 -5.75699212e-01 -5.75699212e-01
 -5.75699212e-01  1.01925428e+00  1.01925428e+00  1.01925428e+00
  7.28376477e+00  7.28376477e+00  7.28376477e+00  9.59648903e+00
  3.34111901e+01  3.34111901e+01  3.34111901e+01  1.07669229e+02
  1.29002822e+02  1.29002822e+02  1.29002822e+02  4.83374468e+02
  4.83374468e+02  4.83374468e+02  5.99826674e+02  1.33509241e+03
  1.33509241e+03  1.33509241e+03  2.67191497e+03  3.02914365e+03
  3.02914365e+03  3.02914365e+03  6.64944793e+03  6.64944793e+03
  6.64944793e+03  9.07671126e+03  2.54313826e+04  7.61726189e+04]
E1 = -728.3448411742081  E_coul = 201.64041787405176
cycle= 5 E= -526.704423300156  delta_E= -1.22e-10  |g|= 7.9e-06  |ddm|= 2.53e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3448411742081  E_coul = 201.64041787405176
  HOMO = -0.575702724980002  LUMO = 1.01925171137627
  mo_energy =
[-1.18575616e+02 -1.23052545e+01 -9.55805680e+00 -9.55805680e+00
 -9.55805680e+00 -1.24985355e+00 -5.75702725e-01 -5.75702725e-01
 -5.75702725e-01  1.01925171e+00  1.01925171e+00  1.01925171e+00
  7.28375623e+00  7.28375623e+00  7.28375623e+00  9.59647903e+00
  3.34111773e+01  3.34111773e+01  3.34111773e+01  1.07669213e+02
  1.29002806e+02  1.29002806e+02  1.29002806e+02  4.83374451e+02
  4.83374451e+02  4.83374451e+02  5.99826656e+02  1.33509239e+03
  1.33509239e+03  1.33509239e+03  2.67191495e+03  3.02914363e+03
  3.02914363e+03  3.02914363e+03  6.64944791e+03  6.64944791e+03
  6.64944791e+03  9.07671124e+03  2.54313826e+04  7.61726188e+04]
E1 = -728.3448802986146  E_coul = 201.64045699845343
Extra cycle  E= -526.704423300161  delta_E= -4.77e-12  |g|= 2.34e-06  |ddm|= 4.05e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.22 sec
exp = [2.61826607e+04 7.61751144e+03 3.61735607e+03 1.59761034e+03
 3.82649954e+02 1.11937192e+02 3.69437381e+01 7.92126272e+00
 3.10075554e+00 3.98556829e-01 1.36278484e+03 6.64729513e+02
 3.00885747e+02 3.13976537e+02 6.16728489e+01 7.33168839e+00
 2.02319177e+01 7.73361809e-01 2.81509849e+00 2.23079187e-01]
E = -526.7044233001611
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:59:17 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6607381        1
[INPUT] 0    0    [1    /1   ]  7617.51144275        1
[INPUT] 0    0    [1    /1   ]  3617.35607352        1
[INPUT] 0    0    [1    /1   ]  1597.61034258        1
[INPUT] 0    0    [1    /1   ]  382.649953597        1
[INPUT] 0    0    [1    /1   ]  111.937192256        1
[INPUT] 0    0    [1    /1   ]  36.943738059         1
[INPUT] 0    0    [1    /1   ]  7.92126272           1
[INPUT] 0    0    [1    /1   ]  3.1007555351         1
[INPUT] 0    0    [1    /1   ]  0.398556828519       1
[INPUT] 1    0    [1    /1   ]  1362.7848447         1
[INPUT] 1    0    [1    /1   ]  664.729512635        1
[INPUT] 1    0    [1    /1   ]  300.885747033        1
[INPUT] 1    0    [1    /1   ]  313.976537326        1
[INPUT] 1    0    [1    /1   ]  61.6728489264        1
[INPUT] 1    0    [1    /1   ]  7.33168838607        1
[INPUT] 1    0    [1    /1   ]  20.2319177019        1
[INPUT] 1    0    [1    /1   ]  0.773361808667       1
[INPUT] 1    0    [1    /1   ]  2.81509849137        1
[INPUT] 1    0    [1    /1   ]  0.223079186941       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.660738077222, 1.0]], [0, [7617.511442750814, 1.0]], [0, [3617.3560735156134, 1.0]], [0, [1597.6103425809397, 1.0]], [0, [382.64995359651647, 1.0]], [0, [111.93719225636436, 1.0]], [0, [36.94373805898653, 1.0]], [0, [7.921262719999386, 1.0]], [0, [3.1007555351024227, 1.0]], [0, [0.3985568285191867, 1.0]], [1, [1362.7848447018, 1.0]], [1, [664.7295126352643, 1.0]], [1, [300.8857470334423, 1.0]], [1, [313.9765373261045, 1.0]], [1, [61.672848926421544, 1.0]], [1, [7.331688386074367, 1.0]], [1, [20.23191770189335, 1.0]], [1, [0.7733618086667691, 1.0]], [1, [2.815098491367996, 1.0]], [1, [0.22307918694059944, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66073808]
bas 1, expnt(s) = [7617.51144275]
bas 2, expnt(s) = [3617.35607352]
bas 3, expnt(s) = [1597.61034258]
bas 4, expnt(s) = [382.6499536]
bas 5, expnt(s) = [111.93719226]
bas 6, expnt(s) = [36.94373806]
bas 7, expnt(s) = [7.92126272]
bas 8, expnt(s) = [3.10075554]
bas 9, expnt(s) = [0.39855683]
bas 10, expnt(s) = [1362.7848447]
bas 11, expnt(s) = [664.72951264]
bas 12, expnt(s) = [300.88574703]
bas 13, expnt(s) = [313.97653733]
bas 14, expnt(s) = [61.67284893]
bas 15, expnt(s) = [7.33168839]
bas 16, expnt(s) = [20.2319177]
bas 17, expnt(s) = [0.77336181]
bas 18, expnt(s) = [2.81509849]
bas 19, expnt(s) = [0.22307919]
CPU time:      1297.19
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826607e+04 5.20026359e+03 7.61751144e+03 2.06003624e+03
 3.61735607e+03 1.17844270e+03 1.59761034e+03 6.38437182e+02
 3.82649954e+02 2.18582945e+02 1.11937192e+02 8.69452441e+01
 3.69437381e+01 3.78591319e+01 7.92126272e+00 1.19291867e+01
 3.10075554e+00 5.90358295e+00 3.98556829e-01 1.26730957e+00
 1.36278484e+03 2.41556379e+04 6.64729513e+02 9.84669745e+03
 3.00885747e+02 3.65583353e+03 3.13976537e+02 3.85572354e+03
 6.16728489e+01 5.04198914e+02 7.33168839e+00 3.51956824e+01
 2.02319177e+01 1.25178777e+02 7.73361809e-01 2.11574242e+00
 2.81509849e+00 1.06377893e+01 2.23079187e-01 4.47258094e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982997303138916
cond(S) = 102440.59406715143
E1 = -729.3826806633949  E_coul = 203.1236992818822
init E= -526.258981381513
    CPU time for initialize scf      0.63 sec, wall time      0.05 sec
  HOMO = -0.556914271779095  LUMO = 1.03095906782015
  mo_energy =
[-1.18332413e+02 -1.22078591e+01 -9.45140098e+00 -9.45140098e+00
 -9.45140098e+00 -1.22581019e+00 -5.56914272e-01 -5.56914272e-01
 -5.56914272e-01  1.03095907e+00  1.03095907e+00  1.03095907e+00
  7.34398401e+00  7.34398401e+00  7.34398401e+00  9.66519630e+00
  3.35229884e+01  3.35229884e+01  3.35229884e+01  1.07836675e+02
  1.29175902e+02  1.29175902e+02  1.29175902e+02  4.83616913e+02
  4.83616913e+02  4.83616913e+02  6.00105786e+02  1.33538765e+03
  1.33538765e+03  1.33538765e+03  2.67234132e+03  3.02950284e+03
  3.02950284e+03  3.02950284e+03  6.64991895e+03  6.64991895e+03
  6.64991895e+03  9.07725681e+03  2.54320220e+04  7.61733482e+04]
E1 = -727.9688685745851  E_coul = 201.2650818053622
cycle= 1 E= -526.703786769223  delta_E= -0.445  |g|= 0.185  |ddm|= 0.414
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.542064
diis-c [-0.29383332  1.        ]
  HOMO = -0.581571527338528  LUMO = 1.0148166082204
  mo_energy =
[-1.18627054e+02 -1.23322826e+01 -9.58611074e+00 -9.58611074e+00
 -9.58611074e+00 -1.25735970e+00 -5.81571527e-01 -5.81571527e-01
 -5.81571527e-01  1.01481661e+00  1.01481661e+00  1.01481661e+00
  7.26763059e+00  7.26763059e+00  7.26763059e+00  9.57517493e+00
  3.33825571e+01  3.33825571e+01  3.33825571e+01  1.07627106e+02
  1.28961181e+02  1.28961181e+02  1.28961181e+02  4.83323670e+02
  4.83323670e+02  4.83323670e+02  5.99773883e+02  1.33503831e+03
  1.33503831e+03  1.33503831e+03  2.67185842e+03  3.02908783e+03
  3.02908783e+03  3.02908783e+03  6.64939092e+03  6.64939092e+03
  6.64939092e+03  9.07665374e+03  2.54313248e+04  7.61725609e+04]
E1 = -728.4365844738161  E_coul = 201.73219742716003
cycle= 2 E= -526.704387046656  delta_E= -0.0006  |g|= 0.0337  |ddm|= 0.0392
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.067305
diis-c [-0.00271594  0.07316281  0.92683719]
  HOMO = -0.574775510309888  LUMO = 1.01993959688678
  mo_energy =
[-1.18567928e+02 -1.23011707e+01 -9.55368294e+00 -9.55368294e+00
 -9.55368294e+00 -1.24873490e+00 -5.74775510e-01 -5.74775510e-01
 -5.74775510e-01  1.01993960e+00  1.01993960e+00  1.01993960e+00
  7.28628628e+00  7.28628628e+00  7.28628628e+00  9.59958217e+00
  3.34156046e+01  3.34156046e+01  3.34156046e+01  1.07675488e+02
  1.29009079e+02  1.29009079e+02  1.29009079e+02  4.83382041e+02
  4.83382041e+02  4.83382041e+02  5.99834586e+02  1.33510052e+03
  1.33510052e+03  1.33510052e+03  2.67192367e+03  3.02915211e+03
  3.02915211e+03  3.02915211e+03  6.64945676e+03  6.64945676e+03
  6.64945676e+03  9.07672030e+03  2.54313919e+04  7.61726282e+04]
E1 = -728.3303813130951  E_coul = 201.62595888169494
cycle= 3 E= -526.7044224314  delta_E= -3.54e-05  |g|= 0.00489  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106022
diis-c [-4.57601746e-07 -1.12841344e-03  1.31463606e-01  8.69664807e-01]
  HOMO = -0.575711249130641  LUMO = 1.01924534382163
  mo_energy =
[-1.18575592e+02 -1.23052706e+01 -9.55806019e+00 -9.55806019e+00
 -9.55806019e+00 -1.24986854e+00 -5.75711249e-01 -5.75711249e-01
 -5.75711249e-01  1.01924534e+00  1.01924534e+00  1.01924534e+00
  7.28374456e+00  7.28374456e+00  7.28374456e+00  9.59645353e+00
  3.34111749e+01  3.34111749e+01  3.34111749e+01  1.07669219e+02
  1.29002815e+02  1.29002815e+02  1.29002815e+02  4.83374474e+02
  4.83374474e+02  4.83374474e+02  5.99826687e+02  1.33509242e+03
  1.33509242e+03  1.33509242e+03  2.67191500e+03  3.02914367e+03
  3.02914367e+03  3.02914367e+03  6.64944797e+03  6.64944797e+03
  6.64944797e+03  9.07671131e+03  2.54313827e+04  7.61726189e+04]
E1 = -728.344839204194  E_coul = 201.6404159041595
cycle= 4 E= -526.704423300034  delta_E= -8.69e-07  |g|= 6.17e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000127899
diis-c [-1.35152505e-09  6.59212574e-05 -9.20726233e-03 -7.18894442e-02
  1.08103079e+00]
  HOMO = -0.57569921180157  LUMO = 1.01925427605741
  mo_energy =
[-1.18575598e+02 -1.23052421e+01 -9.55804381e+00 -9.55804381e+00
 -9.55804381e+00 -1.24984924e+00 -5.75699212e-01 -5.75699212e-01
 -5.75699212e-01  1.01925428e+00  1.01925428e+00  1.01925428e+00
  7.28376477e+00  7.28376477e+00  7.28376477e+00  9.59648903e+00
  3.34111901e+01  3.34111901e+01  3.34111901e+01  1.07669229e+02
  1.29002822e+02  1.29002822e+02  1.29002822e+02  4.83374468e+02
  4.83374468e+02  4.83374468e+02  5.99826674e+02  1.33509241e+03
  1.33509241e+03  1.33509241e+03  2.67191497e+03  3.02914365e+03
  3.02914365e+03  3.02914365e+03  6.64944793e+03  6.64944793e+03
  6.64944793e+03  9.07671126e+03  2.54313826e+04  7.61726189e+04]
E1 = -728.3448411742081  E_coul = 201.64041787405176
cycle= 5 E= -526.704423300156  delta_E= -1.22e-10  |g|= 7.9e-06  |ddm|= 2.53e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3448411742081  E_coul = 201.64041787405176
  HOMO = -0.575702724980002  LUMO = 1.01925171137627
  mo_energy =
[-1.18575616e+02 -1.23052545e+01 -9.55805680e+00 -9.55805680e+00
 -9.55805680e+00 -1.24985355e+00 -5.75702725e-01 -5.75702725e-01
 -5.75702725e-01  1.01925171e+00  1.01925171e+00  1.01925171e+00
  7.28375623e+00  7.28375623e+00  7.28375623e+00  9.59647903e+00
  3.34111773e+01  3.34111773e+01  3.34111773e+01  1.07669213e+02
  1.29002806e+02  1.29002806e+02  1.29002806e+02  4.83374451e+02
  4.83374451e+02  4.83374451e+02  5.99826656e+02  1.33509239e+03
  1.33509239e+03  1.33509239e+03  2.67191495e+03  3.02914363e+03
  3.02914363e+03  3.02914363e+03  6.64944791e+03  6.64944791e+03
  6.64944791e+03  9.07671124e+03  2.54313826e+04  7.61726188e+04]
E1 = -728.3448802986146  E_coul = 201.64045699845343
Extra cycle  E= -526.704423300161  delta_E= -4.77e-12  |g|= 2.34e-06  |ddm|= 4.05e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.22 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102440.59406715143
E1 = -728.3448802986146  E_coul = 201.64045699845343
init E= -526.704423300161
    CPU time for initialize scf      3.80 sec, wall time      0.21 sec
  HOMO = -0.575702008798728  LUMO = 1.01925224040748
  mo_energy =
[-1.18575611e+02 -1.23052517e+01 -9.55805384e+00 -9.55805384e+00
 -9.55805384e+00 -1.24985266e+00 -5.75702009e-01 -5.75702009e-01
 -5.75702009e-01  1.01925224e+00  1.01925224e+00  1.01925224e+00
  7.28375806e+00  7.28375806e+00  7.28375806e+00  9.59648131e+00
  3.34111803e+01  3.34111803e+01  3.34111803e+01  1.07669217e+02
  1.29002810e+02  1.29002810e+02  1.29002810e+02  4.83374456e+02
  4.83374456e+02  4.83374456e+02  5.99826661e+02  1.33509240e+03
  1.33509240e+03  1.33509240e+03  2.67191495e+03  3.02914363e+03
  3.02914363e+03  3.02914363e+03  6.64944792e+03  6.64944792e+03
  6.64944792e+03  9.07671125e+03  2.54313826e+04  7.61726188e+04]
E1 = -728.3448709759373  E_coul = 201.64044767577732
cycle= 1 E= -526.70442330016  delta_E= 1.14e-12  |g|= 6.03e-07  |ddm|= 9.32e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3448709759373  E_coul = 201.64044767577732
  HOMO = -0.575702167511743  LUMO = 1.0192521225181
  mo_energy =
[-1.18575613e+02 -1.23052523e+01 -9.55805454e+00 -9.55805454e+00
 -9.55805454e+00 -1.24985285e+00 -5.75702168e-01 -5.75702168e-01
 -5.75702168e-01  1.01925212e+00  1.01925212e+00  1.01925212e+00
  7.28375764e+00  7.28375764e+00  7.28375764e+00  9.59648078e+00
  3.34111795e+01  3.34111795e+01  3.34111795e+01  1.07669216e+02
  1.29002809e+02  1.29002809e+02  1.29002809e+02  4.83374454e+02
  4.83374454e+02  4.83374454e+02  5.99826660e+02  1.33509239e+03
  1.33509239e+03  1.33509239e+03  2.67191495e+03  3.02914363e+03
  3.02914363e+03  3.02914363e+03  6.64944791e+03  6.64944791e+03
  6.64944791e+03  9.07671125e+03  2.54313826e+04  7.61726188e+04]
E1 = -728.3448732546644  E_coul = 201.64044995450354
Extra cycle  E= -526.704423300161  delta_E= -9.09e-13  |g|= 1.52e-07  |ddm|= 2.19e-07
    CPU time for scf_cycle      3.91 sec, wall time      0.32 sec
exp = [2.61826607e+04 7.61751144e+03 3.61735607e+03 1.59761034e+03
 3.82649954e+02 1.11937192e+02 3.69437381e+01 7.92126272e+00
 3.10075554e+00 3.98556829e-01 1.36278484e+03 6.64729513e+02
 3.00885747e+02 3.13976537e+02 6.16728489e+01 7.33168839e+00
 2.02319177e+01 7.73361809e-01 2.81509849e+00 2.23079187e-01]
grad_E = [-1.54867661e-06  3.66264493e-06 -1.35412306e-06  8.24043636e-05
 -3.13453626e-04 -2.09467231e-05  3.20763322e-06  2.24718043e-05
 -5.59887483e-05  1.95584620e-04 -5.12448156e-07  4.93844886e-06
  2.32282683e-05  2.00219746e-05  3.71345010e-06 -4.72645927e-05
 -5.06658101e-05  2.63299736e-04  1.82280271e-04 -1.14668283e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:59:21 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6607503        1
[INPUT] 0    0    [1    /1   ]  7617.51140752        1
[INPUT] 0    0    [1    /1   ]  3617.35607881        1
[INPUT] 0    0    [1    /1   ]  1597.60943294        1
[INPUT] 0    0    [1    /1   ]  382.659323642        1
[INPUT] 0    0    [1    /1   ]  111.914670409        1
[INPUT] 0    0    [1    /1   ]  36.9345137381        1
[INPUT] 0    0    [1    /1   ]  7.92173141603        1
[INPUT] 0    0    [1    /1   ]  3.10051734138        1
[INPUT] 0    0    [1    /1   ]  0.398577636791       1
[INPUT] 1    0    [1    /1   ]  1362.78484859        1
[INPUT] 1    0    [1    /1   ]  664.72947629         1
[INPUT] 1    0    [1    /1   ]  300.885576356        1
[INPUT] 1    0    [1    /1   ]  313.976390316        1
[INPUT] 1    0    [1    /1   ]  61.6728795132        1
[INPUT] 1    0    [1    /1   ]  7.33422926783        1
[INPUT] 1    0    [1    /1   ]  20.2307989757        1
[INPUT] 1    0    [1    /1   ]  0.77354617928        1
[INPUT] 1    0    [1    /1   ]  2.81780913403        1
[INPUT] 1    0    [1    /1   ]  0.223076062788       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.66075034944, 1.0]], [0, [7617.511407522917, 1.0]], [0, [3617.3560788084046, 1.0]], [0, [1597.6094329407338, 1.0]], [0, [382.65932364217383, 1.0]], [0, [111.91467040861927, 1.0]], [0, [36.93451373812741, 1.0]], [0, [7.921731416033198, 1.0]], [0, [3.100517341384112, 1.0]], [0, [0.3985776367906613, 1.0]], [1, [1362.7848485869406, 1.0]], [1, [664.7294762901724, 1.0]], [1, [300.8855763564003, 1.0]], [1, [313.9763903162325, 1.0]], [1, [61.67287951316945, 1.0]], [1, [7.3342292678337895, 1.0]], [1, [20.230798975725754, 1.0]], [1, [0.773546179279611, 1.0]], [1, [2.817809134025372, 1.0]], [1, [0.22307606278782488, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66075035]
bas 1, expnt(s) = [7617.51140752]
bas 2, expnt(s) = [3617.35607881]
bas 3, expnt(s) = [1597.60943294]
bas 4, expnt(s) = [382.65932364]
bas 5, expnt(s) = [111.91467041]
bas 6, expnt(s) = [36.93451374]
bas 7, expnt(s) = [7.92173142]
bas 8, expnt(s) = [3.10051734]
bas 9, expnt(s) = [0.39857764]
bas 10, expnt(s) = [1362.78484859]
bas 11, expnt(s) = [664.72947629]
bas 12, expnt(s) = [300.88557636]
bas 13, expnt(s) = [313.97639032]
bas 14, expnt(s) = [61.67287951]
bas 15, expnt(s) = [7.33422927]
bas 16, expnt(s) = [20.23079898]
bas 17, expnt(s) = [0.77354618]
bas 18, expnt(s) = [2.81780913]
bas 19, expnt(s) = [0.22307606]
CPU time:      1307.01
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826608e+04 5.20026360e+03 7.61751141e+03 2.06003623e+03
 3.61735608e+03 1.17844270e+03 1.59760943e+03 6.38436909e+02
 3.82659324e+02 2.18586959e+02 1.11914670e+02 8.69321237e+01
 3.69345137e+01 3.78520420e+01 7.92173142e+00 1.19297161e+01
 3.10051734e+00 5.90324282e+00 3.98577637e-01 1.26735920e+00
 1.36278485e+03 2.41556380e+04 6.64729476e+02 9.84669677e+03
 3.00885576e+02 3.65583094e+03 3.13976390e+02 3.85572128e+03
 6.16728795e+01 5.04199227e+02 7.33422927e+00 3.52109299e+01
 2.02307990e+01 1.25170125e+02 7.73546179e-01 2.11637294e+00
 2.81780913e+00 1.06505947e+01 2.23076063e-01 4.47250264e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98299241039895
cond(S) = 102441.54981770972
E1 = -729.3828521667228  E_coul = 203.12383823489463
init E= -526.259013931828
    CPU time for initialize scf      0.67 sec, wall time      0.05 sec
  HOMO = -0.556909470923637  LUMO = 1.03112511921758
  mo_energy =
[-1.18332403e+02 -1.22078509e+01 -9.45139141e+00 -9.45139141e+00
 -9.45139141e+00 -1.22580384e+00 -5.56909471e-01 -5.56909471e-01
 -5.56909471e-01  1.03112512e+00  1.03112512e+00  1.03112512e+00
  7.35002108e+00  7.35002108e+00  7.35002108e+00  9.66484706e+00
  3.35385683e+01  3.35385683e+01  3.35385683e+01  1.07810466e+02
  1.29191301e+02  1.29191301e+02  1.29191301e+02  4.83628400e+02
  4.83628400e+02  4.83628400e+02  6.00022949e+02  1.33539718e+03
  1.33539718e+03  1.33539718e+03  2.67225188e+03  3.02951111e+03
  3.02951111e+03  3.02951111e+03  6.64992608e+03  6.64992608e+03
  6.64992608e+03  9.07717581e+03  2.54319454e+04  7.61732767e+04]
E1 = -727.9685320205963  E_coul = 201.2647437624786
cycle= 1 E= -526.703788258118  delta_E= -0.445  |g|= 0.185  |ddm|= 0.414
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.54209
diis-c [-0.29386124  1.        ]
  HOMO = -0.581585488260601  LUMO = 1.01496252716961
  mo_energy =
[-1.18627077e+02 -1.23323034e+01 -9.58613277e+00 -9.58613277e+00
 -9.58613277e+00 -1.25737776e+00 -5.81585488e-01 -5.81585488e-01
 -5.81585488e-01  1.01496253e+00  1.01496253e+00  1.01496253e+00
  7.27359574e+00  7.27359574e+00  7.27359574e+00  9.57479679e+00
  3.33981017e+01  3.33981017e+01  3.33981017e+01  1.07600884e+02
  1.28976553e+02  1.28976553e+02  1.28976553e+02  4.83335123e+02
  4.83335123e+02  4.83335123e+02  5.99691015e+02  1.33504781e+03
  1.33504781e+03  1.33504781e+03  2.67176894e+03  3.02909605e+03
  3.02909605e+03  3.02909605e+03  6.64939800e+03  6.64939800e+03
  6.64939800e+03  9.07657269e+03  2.54312482e+04  7.61724894e+04]
E1 = -728.4363417990547  E_coul = 201.73195309089533
cycle= 2 E= -526.704388708159  delta_E= -0.0006  |g|= 0.0337  |ddm|= 0.0392
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0673202
diis-c [-0.0027166   0.07318549  0.92681451]
  HOMO = -0.574787878163661  LUMO = 1.02008839960612
  mo_energy =
[-1.18567943e+02 -1.23011856e+01 -9.55369898e+00 -9.55369898e+00
 -9.55369898e+00 -1.24875079e+00 -5.74787878e-01 -5.74787878e-01
 -5.74787878e-01  1.02008840e+00  1.02008840e+00  1.02008840e+00
  7.29226428e+00  7.29226428e+00  7.29226428e+00  9.59920802e+00
  3.34311564e+01  3.34311564e+01  3.34311564e+01  1.07649269e+02
  1.29024457e+02  1.29024457e+02  1.29024457e+02  4.83393501e+02
  4.83393501e+02  4.83393501e+02  5.99751726e+02  1.33511002e+03
  1.33511002e+03  1.33511002e+03  2.67183420e+03  3.02916034e+03
  3.02916034e+03  3.02916034e+03  6.64946385e+03  6.64946385e+03
  6.64946385e+03  9.07663926e+03  2.54313153e+04  7.61725566e+04]
E1 = -728.3301160953462  E_coul = 201.62569198828794
cycle= 3 E= -526.704424107058  delta_E= -3.54e-05  |g|= 0.00489  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106033
diis-c [-4.57769507e-07 -1.12853132e-03  1.31448690e-01  8.69679841e-01]
  HOMO = -0.575723783143462  LUMO = 1.01939379048827
  mo_energy =
[-1.18575608e+02 -1.23052857e+01 -9.55807649e+00 -9.55807649e+00
 -9.55807649e+00 -1.24988466e+00 -5.75723783e-01 -5.75723783e-01
 -5.75723783e-01  1.01939379e+00  1.01939379e+00  1.01939379e+00
  7.28972106e+00  7.28972106e+00  7.28972106e+00  9.59607921e+00
  3.34267263e+01  3.34267263e+01  3.34267263e+01  1.07643000e+02
  1.29018194e+02  1.29018194e+02  1.29018194e+02  4.83385934e+02
  4.83385934e+02  4.83385934e+02  5.99743826e+02  1.33510192e+03
  1.33510192e+03  1.33510192e+03  2.67182553e+03  3.02915190e+03
  3.02915190e+03  3.02915190e+03  6.64945506e+03  6.64945506e+03
  6.64945506e+03  9.07663026e+03  2.54313061e+04  7.61725474e+04]
E1 = -728.3445751497778  E_coul = 201.64015017397276
cycle= 4 E= -526.704424975805  delta_E= -8.69e-07  |g|= 6.17e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000127945
diis-c [-1.35082403e-09  6.59242936e-05 -9.20675980e-03 -7.18976678e-02
  1.08103850e+00]
  HOMO = -0.575711755059564  LUMO = 1.01940271805219
  mo_energy =
[-1.18575614e+02 -1.23052573e+01 -9.55806012e+00 -9.55806012e+00
 -9.55806012e+00 -1.24986537e+00 -5.75711755e-01 -5.75711755e-01
 -5.75711755e-01  1.01940272e+00  1.01940272e+00  1.01940272e+00
  7.28974125e+00  7.28974125e+00  7.28974125e+00  9.59611469e+00
  3.34267414e+01  3.34267414e+01  3.34267414e+01  1.07643010e+02
  1.29018200e+02  1.29018200e+02  1.29018200e+02  4.83385929e+02
  4.83385929e+02  4.83385929e+02  5.99743814e+02  1.33510191e+03
  1.33510191e+03  1.33510191e+03  2.67182550e+03  3.02915188e+03
  3.02915188e+03  3.02915188e+03  6.64945502e+03  6.64945502e+03
  6.64945502e+03  9.07663022e+03  2.54313060e+04  7.61725473e+04]
E1 = -728.344577150858  E_coul = 201.64015217493173
cycle= 5 E= -526.704424975926  delta_E= -1.21e-10  |g|= 7.9e-06  |ddm|= 2.53e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.344577150858  E_coul = 201.64015217493173
  HOMO = -0.575715268679939  LUMO = 1.01940015220316
  mo_energy =
[-1.18575632e+02 -1.23052697e+01 -9.55807312e+00 -9.55807312e+00
 -9.55807312e+00 -1.24986968e+00 -5.75715269e-01 -5.75715269e-01
 -5.75715269e-01  1.01940015e+00  1.01940015e+00  1.01940015e+00
  7.28973271e+00  7.28973271e+00  7.28973271e+00  9.59610469e+00
  3.34267286e+01  3.34267286e+01  3.34267286e+01  1.07642995e+02
  1.29018184e+02  1.29018184e+02  1.29018184e+02  4.83385911e+02
  4.83385911e+02  4.83385911e+02  5.99743796e+02  1.33510189e+03
  1.33510189e+03  1.33510189e+03  2.67182548e+03  3.02915186e+03
  3.02915186e+03  3.02915186e+03  6.64945500e+03  6.64945500e+03
  6.64945500e+03  9.07663020e+03  2.54313060e+04  7.61725473e+04]
E1 = -728.3446162807106  E_coul = 201.6401913047808
Extra cycle  E= -526.70442497593  delta_E= -3.52e-12  |g|= 2.34e-06  |ddm|= 4.05e-06
    CPU time for scf_cycle      0.86 sec, wall time      0.23 sec
exp = [2.61826608e+04 7.61751141e+03 3.61735608e+03 1.59760943e+03
 3.82659324e+02 1.11914670e+02 3.69345137e+01 7.92173142e+00
 3.10051734e+00 3.98577637e-01 1.36278485e+03 6.64729476e+02
 3.00885576e+02 3.13976390e+02 6.16728795e+01 7.33422927e+00
 2.02307990e+01 7.73546179e-01 2.81780913e+00 2.23076063e-01]
E = -526.7044249759298
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:59:21 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6607503        1
[INPUT] 0    0    [1    /1   ]  7617.51140752        1
[INPUT] 0    0    [1    /1   ]  3617.35607881        1
[INPUT] 0    0    [1    /1   ]  1597.60943294        1
[INPUT] 0    0    [1    /1   ]  382.659323642        1
[INPUT] 0    0    [1    /1   ]  111.914670409        1
[INPUT] 0    0    [1    /1   ]  36.9345137381        1
[INPUT] 0    0    [1    /1   ]  7.92173141603        1
[INPUT] 0    0    [1    /1   ]  3.10051734138        1
[INPUT] 0    0    [1    /1   ]  0.398577636791       1
[INPUT] 1    0    [1    /1   ]  1362.78484859        1
[INPUT] 1    0    [1    /1   ]  664.72947629         1
[INPUT] 1    0    [1    /1   ]  300.885576356        1
[INPUT] 1    0    [1    /1   ]  313.976390316        1
[INPUT] 1    0    [1    /1   ]  61.6728795132        1
[INPUT] 1    0    [1    /1   ]  7.33422926783        1
[INPUT] 1    0    [1    /1   ]  20.2307989757        1
[INPUT] 1    0    [1    /1   ]  0.77354617928        1
[INPUT] 1    0    [1    /1   ]  2.81780913403        1
[INPUT] 1    0    [1    /1   ]  0.223076062788       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.66075034944, 1.0]], [0, [7617.511407522917, 1.0]], [0, [3617.3560788084046, 1.0]], [0, [1597.6094329407338, 1.0]], [0, [382.65932364217383, 1.0]], [0, [111.91467040861927, 1.0]], [0, [36.93451373812741, 1.0]], [0, [7.921731416033198, 1.0]], [0, [3.100517341384112, 1.0]], [0, [0.3985776367906613, 1.0]], [1, [1362.7848485869406, 1.0]], [1, [664.7294762901724, 1.0]], [1, [300.8855763564003, 1.0]], [1, [313.9763903162325, 1.0]], [1, [61.67287951316945, 1.0]], [1, [7.3342292678337895, 1.0]], [1, [20.230798975725754, 1.0]], [1, [0.773546179279611, 1.0]], [1, [2.817809134025372, 1.0]], [1, [0.22307606278782488, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66075035]
bas 1, expnt(s) = [7617.51140752]
bas 2, expnt(s) = [3617.35607881]
bas 3, expnt(s) = [1597.60943294]
bas 4, expnt(s) = [382.65932364]
bas 5, expnt(s) = [111.91467041]
bas 6, expnt(s) = [36.93451374]
bas 7, expnt(s) = [7.92173142]
bas 8, expnt(s) = [3.10051734]
bas 9, expnt(s) = [0.39857764]
bas 10, expnt(s) = [1362.78484859]
bas 11, expnt(s) = [664.72947629]
bas 12, expnt(s) = [300.88557636]
bas 13, expnt(s) = [313.97639032]
bas 14, expnt(s) = [61.67287951]
bas 15, expnt(s) = [7.33422927]
bas 16, expnt(s) = [20.23079898]
bas 17, expnt(s) = [0.77354618]
bas 18, expnt(s) = [2.81780913]
bas 19, expnt(s) = [0.22307606]
CPU time:      1308.04
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826608e+04 5.20026360e+03 7.61751141e+03 2.06003623e+03
 3.61735608e+03 1.17844270e+03 1.59760943e+03 6.38436909e+02
 3.82659324e+02 2.18586959e+02 1.11914670e+02 8.69321237e+01
 3.69345137e+01 3.78520420e+01 7.92173142e+00 1.19297161e+01
 3.10051734e+00 5.90324282e+00 3.98577637e-01 1.26735920e+00
 1.36278485e+03 2.41556380e+04 6.64729476e+02 9.84669677e+03
 3.00885576e+02 3.65583094e+03 3.13976390e+02 3.85572128e+03
 6.16728795e+01 5.04199227e+02 7.33422927e+00 3.52109299e+01
 2.02307990e+01 1.25170125e+02 7.73546179e-01 2.11637294e+00
 2.81780913e+00 1.06505947e+01 2.23076063e-01 4.47250264e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98299241039895
cond(S) = 102441.54981770972
E1 = -729.3828521667228  E_coul = 203.12383823489463
init E= -526.259013931828
    CPU time for initialize scf      0.63 sec, wall time      0.05 sec
  HOMO = -0.556909470923637  LUMO = 1.03112511921758
  mo_energy =
[-1.18332403e+02 -1.22078509e+01 -9.45139141e+00 -9.45139141e+00
 -9.45139141e+00 -1.22580384e+00 -5.56909471e-01 -5.56909471e-01
 -5.56909471e-01  1.03112512e+00  1.03112512e+00  1.03112512e+00
  7.35002108e+00  7.35002108e+00  7.35002108e+00  9.66484706e+00
  3.35385683e+01  3.35385683e+01  3.35385683e+01  1.07810466e+02
  1.29191301e+02  1.29191301e+02  1.29191301e+02  4.83628400e+02
  4.83628400e+02  4.83628400e+02  6.00022949e+02  1.33539718e+03
  1.33539718e+03  1.33539718e+03  2.67225188e+03  3.02951111e+03
  3.02951111e+03  3.02951111e+03  6.64992608e+03  6.64992608e+03
  6.64992608e+03  9.07717581e+03  2.54319454e+04  7.61732767e+04]
E1 = -727.9685320205963  E_coul = 201.2647437624786
cycle= 1 E= -526.703788258118  delta_E= -0.445  |g|= 0.185  |ddm|= 0.414
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.54209
diis-c [-0.29386124  1.        ]
  HOMO = -0.581585488260601  LUMO = 1.01496252716961
  mo_energy =
[-1.18627077e+02 -1.23323034e+01 -9.58613277e+00 -9.58613277e+00
 -9.58613277e+00 -1.25737776e+00 -5.81585488e-01 -5.81585488e-01
 -5.81585488e-01  1.01496253e+00  1.01496253e+00  1.01496253e+00
  7.27359574e+00  7.27359574e+00  7.27359574e+00  9.57479679e+00
  3.33981017e+01  3.33981017e+01  3.33981017e+01  1.07600884e+02
  1.28976553e+02  1.28976553e+02  1.28976553e+02  4.83335123e+02
  4.83335123e+02  4.83335123e+02  5.99691015e+02  1.33504781e+03
  1.33504781e+03  1.33504781e+03  2.67176894e+03  3.02909605e+03
  3.02909605e+03  3.02909605e+03  6.64939800e+03  6.64939800e+03
  6.64939800e+03  9.07657269e+03  2.54312482e+04  7.61724894e+04]
E1 = -728.4363417990547  E_coul = 201.73195309089533
cycle= 2 E= -526.704388708159  delta_E= -0.0006  |g|= 0.0337  |ddm|= 0.0392
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0673202
diis-c [-0.0027166   0.07318549  0.92681451]
  HOMO = -0.574787878163661  LUMO = 1.02008839960612
  mo_energy =
[-1.18567943e+02 -1.23011856e+01 -9.55369898e+00 -9.55369898e+00
 -9.55369898e+00 -1.24875079e+00 -5.74787878e-01 -5.74787878e-01
 -5.74787878e-01  1.02008840e+00  1.02008840e+00  1.02008840e+00
  7.29226428e+00  7.29226428e+00  7.29226428e+00  9.59920802e+00
  3.34311564e+01  3.34311564e+01  3.34311564e+01  1.07649269e+02
  1.29024457e+02  1.29024457e+02  1.29024457e+02  4.83393501e+02
  4.83393501e+02  4.83393501e+02  5.99751726e+02  1.33511002e+03
  1.33511002e+03  1.33511002e+03  2.67183420e+03  3.02916034e+03
  3.02916034e+03  3.02916034e+03  6.64946385e+03  6.64946385e+03
  6.64946385e+03  9.07663926e+03  2.54313153e+04  7.61725566e+04]
E1 = -728.3301160953462  E_coul = 201.62569198828794
cycle= 3 E= -526.704424107058  delta_E= -3.54e-05  |g|= 0.00489  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106033
diis-c [-4.57769507e-07 -1.12853132e-03  1.31448690e-01  8.69679841e-01]
  HOMO = -0.575723783143462  LUMO = 1.01939379048827
  mo_energy =
[-1.18575608e+02 -1.23052857e+01 -9.55807649e+00 -9.55807649e+00
 -9.55807649e+00 -1.24988466e+00 -5.75723783e-01 -5.75723783e-01
 -5.75723783e-01  1.01939379e+00  1.01939379e+00  1.01939379e+00
  7.28972106e+00  7.28972106e+00  7.28972106e+00  9.59607921e+00
  3.34267263e+01  3.34267263e+01  3.34267263e+01  1.07643000e+02
  1.29018194e+02  1.29018194e+02  1.29018194e+02  4.83385934e+02
  4.83385934e+02  4.83385934e+02  5.99743826e+02  1.33510192e+03
  1.33510192e+03  1.33510192e+03  2.67182553e+03  3.02915190e+03
  3.02915190e+03  3.02915190e+03  6.64945506e+03  6.64945506e+03
  6.64945506e+03  9.07663026e+03  2.54313061e+04  7.61725474e+04]
E1 = -728.3445751497778  E_coul = 201.64015017397276
cycle= 4 E= -526.704424975805  delta_E= -8.69e-07  |g|= 6.17e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000127945
diis-c [-1.35082403e-09  6.59242936e-05 -9.20675980e-03 -7.18976678e-02
  1.08103850e+00]
  HOMO = -0.575711755059564  LUMO = 1.01940271805219
  mo_energy =
[-1.18575614e+02 -1.23052573e+01 -9.55806012e+00 -9.55806012e+00
 -9.55806012e+00 -1.24986537e+00 -5.75711755e-01 -5.75711755e-01
 -5.75711755e-01  1.01940272e+00  1.01940272e+00  1.01940272e+00
  7.28974125e+00  7.28974125e+00  7.28974125e+00  9.59611469e+00
  3.34267414e+01  3.34267414e+01  3.34267414e+01  1.07643010e+02
  1.29018200e+02  1.29018200e+02  1.29018200e+02  4.83385929e+02
  4.83385929e+02  4.83385929e+02  5.99743814e+02  1.33510191e+03
  1.33510191e+03  1.33510191e+03  2.67182550e+03  3.02915188e+03
  3.02915188e+03  3.02915188e+03  6.64945502e+03  6.64945502e+03
  6.64945502e+03  9.07663022e+03  2.54313060e+04  7.61725473e+04]
E1 = -728.344577150858  E_coul = 201.64015217493173
cycle= 5 E= -526.704424975926  delta_E= -1.21e-10  |g|= 7.9e-06  |ddm|= 2.53e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.344577150858  E_coul = 201.64015217493173
  HOMO = -0.575715268679939  LUMO = 1.01940015220316
  mo_energy =
[-1.18575632e+02 -1.23052697e+01 -9.55807312e+00 -9.55807312e+00
 -9.55807312e+00 -1.24986968e+00 -5.75715269e-01 -5.75715269e-01
 -5.75715269e-01  1.01940015e+00  1.01940015e+00  1.01940015e+00
  7.28973271e+00  7.28973271e+00  7.28973271e+00  9.59610469e+00
  3.34267286e+01  3.34267286e+01  3.34267286e+01  1.07642995e+02
  1.29018184e+02  1.29018184e+02  1.29018184e+02  4.83385911e+02
  4.83385911e+02  4.83385911e+02  5.99743796e+02  1.33510189e+03
  1.33510189e+03  1.33510189e+03  2.67182548e+03  3.02915186e+03
  3.02915186e+03  3.02915186e+03  6.64945500e+03  6.64945500e+03
  6.64945500e+03  9.07663020e+03  2.54313060e+04  7.61725473e+04]
E1 = -728.3446162807106  E_coul = 201.6401913047808
Extra cycle  E= -526.70442497593  delta_E= -3.52e-12  |g|= 2.34e-06  |ddm|= 4.05e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102441.54981770972
E1 = -728.3446162807106  E_coul = 201.6401913047808
init E= -526.70442497593
    CPU time for initialize scf      3.82 sec, wall time      0.20 sec
  HOMO = -0.575714552359941  LUMO = 1.01940068150936
  mo_energy =
[-1.18575627e+02 -1.23052668e+01 -9.55807015e+00 -9.55807015e+00
 -9.55807015e+00 -1.24986879e+00 -5.75714552e-01 -5.75714552e-01
 -5.75714552e-01  1.01940068e+00  1.01940068e+00  1.01940068e+00
  7.28973454e+00  7.28973454e+00  7.28973454e+00  9.59610697e+00
  3.34267316e+01  3.34267316e+01  3.34267316e+01  1.07642999e+02
  1.29018188e+02  1.29018188e+02  1.29018188e+02  4.83385916e+02
  4.83385916e+02  4.83385916e+02  5.99743801e+02  1.33510189e+03
  1.33510189e+03  1.33510189e+03  2.67182548e+03  3.02915186e+03
  3.02915186e+03  3.02915186e+03  6.64945500e+03  6.64945500e+03
  6.64945500e+03  9.07663021e+03  2.54313060e+04  7.61725473e+04]
E1 = -728.3446069562814  E_coul = 201.64018198035177
cycle= 1 E= -526.70442497593  delta_E= 1.14e-13  |g|= 6.03e-07  |ddm|= 9.32e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3446069562814  E_coul = 201.64018198035177
  HOMO = -0.575714711115396  LUMO = 1.01940056354963
  mo_energy =
[-1.18575628e+02 -1.23052675e+01 -9.55807086e+00 -9.55807086e+00
 -9.55807086e+00 -1.24986898e+00 -5.75714711e-01 -5.75714711e-01
 -5.75714711e-01  1.01940056e+00  1.01940056e+00  1.01940056e+00
  7.28973412e+00  7.28973412e+00  7.28973412e+00  9.59610644e+00
  3.34267309e+01  3.34267309e+01  3.34267309e+01  1.07642998e+02
  1.29018187e+02  1.29018187e+02  1.29018187e+02  4.83385915e+02
  4.83385915e+02  4.83385915e+02  5.99743799e+02  1.33510189e+03
  1.33510189e+03  1.33510189e+03  2.67182548e+03  3.02915186e+03
  3.02915186e+03  3.02915186e+03  6.64945500e+03  6.64945500e+03
  6.64945500e+03  9.07663020e+03  2.54313060e+04  7.61725473e+04]
E1 = -728.3446092354812  E_coul = 201.64018425955126
Extra cycle  E= -526.70442497593  delta_E= -3.41e-13  |g|= 1.52e-07  |ddm|= 2.19e-07
    CPU time for scf_cycle      3.93 sec, wall time      0.31 sec
exp = [2.61826608e+04 7.61751141e+03 3.61735608e+03 1.59760943e+03
 3.82659324e+02 1.11914670e+02 3.69345137e+01 7.92173142e+00
 3.10051734e+00 3.98577637e-01 1.36278485e+03 6.64729476e+02
 3.00885576e+02 3.13976390e+02 6.16728795e+01 7.33422927e+00
 2.02307990e+01 7.73546179e-01 2.81780913e+00 2.23076063e-01]
grad_E = [-1.54839051e-06  3.65925415e-06 -1.35668665e-06  8.22810132e-05
 -3.10858401e-04 -2.94034843e-05  2.97635487e-06  4.03938154e-05
 -1.05769746e-04  3.95027250e-04 -5.12984972e-07  4.93094507e-06
  2.31829455e-05  1.99830564e-05  8.58593487e-06 -7.07914956e-05
 -7.78996372e-05  5.25875337e-04  3.72890216e-04 -2.28420246e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:59:26 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6608219        1
[INPUT] 0    0    [1    /1   ]  7617.51122865        1
[INPUT] 0    0    [1    /1   ]  3617.35613295        1
[INPUT] 0    0    [1    /1   ]  1597.60522734        1
[INPUT] 0    0    [1    /1   ]  382.684464594        1
[INPUT] 0    0    [1    /1   ]  111.880582448        1
[INPUT] 0    0    [1    /1   ]  36.9199588452        1
[INPUT] 0    0    [1    /1   ]  7.92246499891        1
[INPUT] 0    0    [1    /1   ]  3.10012004017        1
[INPUT] 0    0    [1    /1   ]  0.398612297037       1
[INPUT] 1    0    [1    /1   ]  1362.78487198        1
[INPUT] 1    0    [1    /1   ]  664.729252099        1
[INPUT] 1    0    [1    /1   ]  300.884521901        1
[INPUT] 1    0    [1    /1   ]  313.975481583        1
[INPUT] 1    0    [1    /1   ]  61.6729816088        1
[INPUT] 1    0    [1    /1   ]  7.33888511055        1
[INPUT] 1    0    [1    /1   ]  20.2298255203        1
[INPUT] 1    0    [1    /1   ]  0.77386905255        1
[INPUT] 1    0    [1    /1   ]  2.82244650229        1
[INPUT] 1    0    [1    /1   ]  0.223074468546       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.660821917594, 1.0]], [0, [7617.511228652324, 1.0]], [0, [3617.3561329511817, 1.0]], [0, [1597.605227344698, 1.0]], [0, [382.68446459390657, 1.0]], [0, [111.8805824483484, 1.0]], [0, [36.919958845152955, 1.0]], [0, [7.922464998905158, 1.0]], [0, [3.1001200401719724, 1.0]], [0, [0.39861229703666895, 1.0]], [1, [1362.7848719753044, 1.0]], [1, [664.729252098817, 1.0]], [1, [300.8845219011177, 1.0]], [1, [313.9754815834769, 1.0]], [1, [61.67298160882617, 1.0]], [1, [7.338885110548887, 1.0]], [1, [20.229825520326038, 1.0]], [1, [0.7738690525501879, 1.0]], [1, [2.8224465022918785, 1.0]], [1, [0.22307446854555424, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66082192]
bas 1, expnt(s) = [7617.51122865]
bas 2, expnt(s) = [3617.35613295]
bas 3, expnt(s) = [1597.60522734]
bas 4, expnt(s) = [382.68446459]
bas 5, expnt(s) = [111.88058245]
bas 6, expnt(s) = [36.91995885]
bas 7, expnt(s) = [7.922465]
bas 8, expnt(s) = [3.10012004]
bas 9, expnt(s) = [0.3986123]
bas 10, expnt(s) = [1362.78487198]
bas 11, expnt(s) = [664.7292521]
bas 12, expnt(s) = [300.8845219]
bas 13, expnt(s) = [313.97548158]
bas 14, expnt(s) = [61.67298161]
bas 15, expnt(s) = [7.33888511]
bas 16, expnt(s) = [20.22982552]
bas 17, expnt(s) = [0.77386905]
bas 18, expnt(s) = [2.8224465]
bas 19, expnt(s) = [0.22307447]
CPU time:      1317.51
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826608e+04 5.20026361e+03 7.61751123e+03 2.06003620e+03
 3.61735613e+03 1.17844271e+03 1.59760523e+03 6.38435649e+02
 3.82684465e+02 2.18597730e+02 1.11880582e+02 8.69122640e+01
 3.69199588e+01 3.78408541e+01 7.92246500e+00 1.19305447e+01
 3.10012004e+00 5.90267548e+00 3.98612297e-01 1.26744185e+00
 1.36278487e+03 2.41556385e+04 6.64729252e+02 9.84669262e+03
 3.00884522e+02 3.65581493e+03 3.13975482e+02 3.85570733e+03
 6.16729816e+01 5.04200270e+02 7.33888511e+00 3.52388724e+01
 2.02298255e+01 1.25162596e+02 7.73869053e-01 2.11747719e+00
 2.82244650e+00 1.06725093e+01 2.23074469e-01 4.47246269e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982983569307866
cond(S) = 102442.071671201
E1 = -729.3831371101808  E_coul = 203.12407055016936
init E= -526.259066560011
    CPU time for initialize scf      0.62 sec, wall time      0.05 sec
  HOMO = -0.556901327994621  LUMO = 1.03142964690624
  mo_energy =
[-1.18332386e+02 -1.22078371e+01 -9.45137535e+00 -9.45137535e+00
 -9.45137535e+00 -1.22579341e+00 -5.56901328e-01 -5.56901328e-01
 -5.56901328e-01  1.03142965e+00  1.03142965e+00  1.03142965e+00
  7.36047362e+00  7.36047362e+00  7.36047362e+00  9.66424235e+00
  3.35666011e+01  3.35666011e+01  3.35666011e+01  1.07769608e+02
  1.29221352e+02  1.29221352e+02  1.29221352e+02  4.83651755e+02
  4.83651755e+02  4.83651755e+02  5.99902925e+02  1.33541541e+03
  1.33541541e+03  1.33541541e+03  2.67214176e+03  3.02952494e+03
  3.02952494e+03  3.02952494e+03  6.64993633e+03  6.64993633e+03
  6.64993633e+03  9.07708365e+03  2.54318582e+04  7.61731946e+04]
E1 = -727.967996933507  E_coul = 201.2642045190579
cycle= 1 E= -526.703792414449  delta_E= -0.445  |g|= 0.185  |ddm|= 0.413
    CPU time for cycle= 1      0.05 sec, wall time      0.02 sec
diis-norm(errvec)=0.542131
diis-c [-0.29390569  1.        ]
  HOMO = -0.581607875995826  LUMO = 1.01523348074052
  mo_energy =
[-1.18627114e+02 -1.23323365e+01 -9.58616790e+00 -9.58616790e+00
 -9.58616790e+00 -1.25740716e+00 -5.81607876e-01 -5.81607876e-01
 -5.81607876e-01  1.01523348e+00  1.01523348e+00  1.01523348e+00
  7.28392688e+00  7.28392688e+00  7.28392688e+00  9.57414520e+00
  3.34260743e+01  3.34260743e+01  3.34260743e+01  1.07560004e+02
  1.29006562e+02  1.29006562e+02  1.29006562e+02  4.83358427e+02
  4.83358427e+02  4.83358427e+02  5.99570940e+02  1.33506599e+03
  1.33506599e+03  1.33506599e+03  2.67165875e+03  3.02910981e+03
  3.02910981e+03  3.02910981e+03  6.64940818e+03  6.64940818e+03
  6.64940818e+03  9.07648046e+03  2.54311610e+04  7.61724072e+04]
E1 = -728.4359555333295  E_coul = 201.73156239526665
cycle= 2 E= -526.704393138063  delta_E= -0.000601  |g|= 0.0337  |ddm|= 0.0392
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0673449
diis-c [-0.00271766  0.07322285  0.92677715]
  HOMO = -0.574807743557144  LUMO = 1.02036421374962
  mo_energy =
[-1.18567969e+02 -1.23012095e+01 -9.55372466e+00 -9.55372466e+00
 -9.55372466e+00 -1.24877674e+00 -5.74807744e-01 -5.74807744e-01
 -5.74807744e-01  1.02036421e+00  1.02036421e+00  1.02036421e+00
  7.30261712e+00  7.30261712e+00  7.30261712e+00  9.59856269e+00
  3.34591409e+01  3.34591409e+01  3.34591409e+01  1.07608395e+02
  1.29054475e+02  1.29054475e+02  1.29054475e+02  4.83416817e+02
  4.83416817e+02  4.83416817e+02  5.99631661e+02  1.33512821e+03
  1.33512821e+03  1.33512821e+03  2.67172401e+03  3.02917412e+03
  3.02917412e+03  3.02917412e+03  6.64947405e+03  6.64947405e+03
  6.64947405e+03  9.07654704e+03  2.54312280e+04  7.61724745e+04]
E1 = -728.3296943774341  E_coul = 201.62526581802405
cycle= 3 E= -526.70442855941  delta_E= -3.54e-05  |g|= 0.00489  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.010605
diis-c [-4.58042964e-07 -1.12871868e-03  1.31423689e-01  8.69705029e-01]
  HOMO = -0.575743902483504  LUMO = 1.01966900741425
  mo_energy =
[-1.18575634e+02 -1.23053098e+01 -9.55810251e+00 -9.55810251e+00
 -9.55810251e+00 -1.24991096e+00 -5.75743902e-01 -5.75743902e-01
 -5.75743902e-01  1.01966901e+00  1.01966901e+00  1.01966901e+00
  7.30007138e+00  7.30007138e+00  7.30007138e+00  9.59543366e+00
  3.34547102e+01  3.34547102e+01  3.34547102e+01  1.07602126e+02
  1.29048212e+02  1.29048212e+02  1.29048212e+02  4.83409249e+02
  4.83409249e+02  4.83409249e+02  5.99623762e+02  1.33512012e+03
  1.33512012e+03  1.33512012e+03  2.67171535e+03  3.02916568e+03
  3.02916568e+03  3.02916568e+03  6.64946525e+03  6.64946525e+03
  6.64946525e+03  9.07653805e+03  2.54312189e+04  7.61724652e+04]
E1 = -728.3441550547303  E_coul = 201.63972562642516
cycle= 4 E= -526.704429428305  delta_E= -8.69e-07  |g|= 6.17e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000128021
diis-c [-1.34957831e-09  6.59293248e-05 -9.20593581e-03 -7.19117156e-02
  1.08105172e+00]
  HOMO = -0.575731890095939  LUMO = 1.01967792718822
  mo_energy =
[-1.18575640e+02 -1.23052815e+01 -9.55808617e+00 -9.55808617e+00
 -9.55808617e+00 -1.24989168e+00 -5.75731890e-01 -5.75731890e-01
 -5.75731890e-01  1.01967793e+00  1.01967793e+00  1.01967793e+00
  7.30009155e+00  7.30009155e+00  7.30009155e+00  9.59546911e+00
  3.34547253e+01  3.34547253e+01  3.34547253e+01  1.07602136e+02
  1.29048218e+02  1.29048218e+02  1.29048218e+02  4.83409244e+02
  4.83409244e+02  4.83409244e+02  5.99623749e+02  1.33512010e+03
  1.33512010e+03  1.33512010e+03  2.67171531e+03  3.02916565e+03
  3.02916565e+03  3.02916565e+03  6.64946521e+03  6.64946521e+03
  6.64946521e+03  9.07653800e+03  2.54312188e+04  7.61724652e+04]
E1 = -728.344157110558  E_coul = 201.63972768213176
cycle= 5 E= -526.704429428426  delta_E= -1.21e-10  |g|= 7.9e-06  |ddm|= 2.53e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.344157110558  E_coul = 201.63972768213176
  HOMO = -0.575735404343466  LUMO = 1.0196753594013
  mo_energy =
[-1.18575657e+02 -1.23052939e+01 -9.55809918e+00 -9.55809918e+00
 -9.55809918e+00 -1.24989600e+00 -5.75735404e-01 -5.75735404e-01
 -5.75735404e-01  1.01967536e+00  1.01967536e+00  1.01967536e+00
  7.30008300e+00  7.30008300e+00  7.30008300e+00  9.59545910e+00
  3.34547125e+01  3.34547125e+01  3.34547125e+01  1.07602121e+02
  1.29048202e+02  1.29048202e+02  1.29048202e+02  4.83409226e+02
  4.83409226e+02  4.83409226e+02  5.99623731e+02  1.33512008e+03
  1.33512008e+03  1.33512008e+03  2.67171529e+03  3.02916563e+03
  3.02916563e+03  3.02916563e+03  6.64946519e+03  6.64946519e+03
  6.64946519e+03  9.07653798e+03  2.54312188e+04  7.61724652e+04]
E1 = -728.3441962481602  E_coul = 201.63976681972912
Extra cycle  E= -526.704429428431  delta_E= -4.77e-12  |g|= 2.34e-06  |ddm|= 4.05e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.22 sec
exp = [2.61826608e+04 7.61751123e+03 3.61735613e+03 1.59760523e+03
 3.82684465e+02 1.11880582e+02 3.69199588e+01 7.92246500e+00
 3.10012004e+00 3.98612297e-01 1.36278487e+03 6.64729252e+02
 3.00884522e+02 3.13975482e+02 6.16729816e+01 7.33888511e+00
 2.02298255e+01 7.73869053e-01 2.82244650e+00 2.23074469e-01]
E = -526.704429428431
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:59:26 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6608219        1
[INPUT] 0    0    [1    /1   ]  7617.51122865        1
[INPUT] 0    0    [1    /1   ]  3617.35613295        1
[INPUT] 0    0    [1    /1   ]  1597.60522734        1
[INPUT] 0    0    [1    /1   ]  382.684464594        1
[INPUT] 0    0    [1    /1   ]  111.880582448        1
[INPUT] 0    0    [1    /1   ]  36.9199588452        1
[INPUT] 0    0    [1    /1   ]  7.92246499891        1
[INPUT] 0    0    [1    /1   ]  3.10012004017        1
[INPUT] 0    0    [1    /1   ]  0.398612297037       1
[INPUT] 1    0    [1    /1   ]  1362.78487198        1
[INPUT] 1    0    [1    /1   ]  664.729252099        1
[INPUT] 1    0    [1    /1   ]  300.884521901        1
[INPUT] 1    0    [1    /1   ]  313.975481583        1
[INPUT] 1    0    [1    /1   ]  61.6729816088        1
[INPUT] 1    0    [1    /1   ]  7.33888511055        1
[INPUT] 1    0    [1    /1   ]  20.2298255203        1
[INPUT] 1    0    [1    /1   ]  0.77386905255        1
[INPUT] 1    0    [1    /1   ]  2.82244650229        1
[INPUT] 1    0    [1    /1   ]  0.223074468546       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.660821917594, 1.0]], [0, [7617.511228652324, 1.0]], [0, [3617.3561329511817, 1.0]], [0, [1597.605227344698, 1.0]], [0, [382.68446459390657, 1.0]], [0, [111.8805824483484, 1.0]], [0, [36.919958845152955, 1.0]], [0, [7.922464998905158, 1.0]], [0, [3.1001200401719724, 1.0]], [0, [0.39861229703666895, 1.0]], [1, [1362.7848719753044, 1.0]], [1, [664.729252098817, 1.0]], [1, [300.8845219011177, 1.0]], [1, [313.9754815834769, 1.0]], [1, [61.67298160882617, 1.0]], [1, [7.338885110548887, 1.0]], [1, [20.229825520326038, 1.0]], [1, [0.7738690525501879, 1.0]], [1, [2.8224465022918785, 1.0]], [1, [0.22307446854555424, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66082192]
bas 1, expnt(s) = [7617.51122865]
bas 2, expnt(s) = [3617.35613295]
bas 3, expnt(s) = [1597.60522734]
bas 4, expnt(s) = [382.68446459]
bas 5, expnt(s) = [111.88058245]
bas 6, expnt(s) = [36.91995885]
bas 7, expnt(s) = [7.922465]
bas 8, expnt(s) = [3.10012004]
bas 9, expnt(s) = [0.3986123]
bas 10, expnt(s) = [1362.78487198]
bas 11, expnt(s) = [664.7292521]
bas 12, expnt(s) = [300.8845219]
bas 13, expnt(s) = [313.97548158]
bas 14, expnt(s) = [61.67298161]
bas 15, expnt(s) = [7.33888511]
bas 16, expnt(s) = [20.22982552]
bas 17, expnt(s) = [0.77386905]
bas 18, expnt(s) = [2.8224465]
bas 19, expnt(s) = [0.22307447]
CPU time:      1318.50
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826608e+04 5.20026361e+03 7.61751123e+03 2.06003620e+03
 3.61735613e+03 1.17844271e+03 1.59760523e+03 6.38435649e+02
 3.82684465e+02 2.18597730e+02 1.11880582e+02 8.69122640e+01
 3.69199588e+01 3.78408541e+01 7.92246500e+00 1.19305447e+01
 3.10012004e+00 5.90267548e+00 3.98612297e-01 1.26744185e+00
 1.36278487e+03 2.41556385e+04 6.64729252e+02 9.84669262e+03
 3.00884522e+02 3.65581493e+03 3.13975482e+02 3.85570733e+03
 6.16729816e+01 5.04200270e+02 7.33888511e+00 3.52388724e+01
 2.02298255e+01 1.25162596e+02 7.73869053e-01 2.11747719e+00
 2.82244650e+00 1.06725093e+01 2.23074469e-01 4.47246269e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982983569307866
cond(S) = 102442.071671201
E1 = -729.3831371101808  E_coul = 203.12407055016936
init E= -526.259066560011
    CPU time for initialize scf      0.62 sec, wall time      0.05 sec
  HOMO = -0.556901327994621  LUMO = 1.03142964690624
  mo_energy =
[-1.18332386e+02 -1.22078371e+01 -9.45137535e+00 -9.45137535e+00
 -9.45137535e+00 -1.22579341e+00 -5.56901328e-01 -5.56901328e-01
 -5.56901328e-01  1.03142965e+00  1.03142965e+00  1.03142965e+00
  7.36047362e+00  7.36047362e+00  7.36047362e+00  9.66424235e+00
  3.35666011e+01  3.35666011e+01  3.35666011e+01  1.07769608e+02
  1.29221352e+02  1.29221352e+02  1.29221352e+02  4.83651755e+02
  4.83651755e+02  4.83651755e+02  5.99902925e+02  1.33541541e+03
  1.33541541e+03  1.33541541e+03  2.67214176e+03  3.02952494e+03
  3.02952494e+03  3.02952494e+03  6.64993633e+03  6.64993633e+03
  6.64993633e+03  9.07708365e+03  2.54318582e+04  7.61731946e+04]
E1 = -727.967996933507  E_coul = 201.2642045190579
cycle= 1 E= -526.703792414449  delta_E= -0.445  |g|= 0.185  |ddm|= 0.413
    CPU time for cycle= 1      0.05 sec, wall time      0.02 sec
diis-norm(errvec)=0.542131
diis-c [-0.29390569  1.        ]
  HOMO = -0.581607875995826  LUMO = 1.01523348074052
  mo_energy =
[-1.18627114e+02 -1.23323365e+01 -9.58616790e+00 -9.58616790e+00
 -9.58616790e+00 -1.25740716e+00 -5.81607876e-01 -5.81607876e-01
 -5.81607876e-01  1.01523348e+00  1.01523348e+00  1.01523348e+00
  7.28392688e+00  7.28392688e+00  7.28392688e+00  9.57414520e+00
  3.34260743e+01  3.34260743e+01  3.34260743e+01  1.07560004e+02
  1.29006562e+02  1.29006562e+02  1.29006562e+02  4.83358427e+02
  4.83358427e+02  4.83358427e+02  5.99570940e+02  1.33506599e+03
  1.33506599e+03  1.33506599e+03  2.67165875e+03  3.02910981e+03
  3.02910981e+03  3.02910981e+03  6.64940818e+03  6.64940818e+03
  6.64940818e+03  9.07648046e+03  2.54311610e+04  7.61724072e+04]
E1 = -728.4359555333295  E_coul = 201.73156239526665
cycle= 2 E= -526.704393138063  delta_E= -0.000601  |g|= 0.0337  |ddm|= 0.0392
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0673449
diis-c [-0.00271766  0.07322285  0.92677715]
  HOMO = -0.574807743557144  LUMO = 1.02036421374962
  mo_energy =
[-1.18567969e+02 -1.23012095e+01 -9.55372466e+00 -9.55372466e+00
 -9.55372466e+00 -1.24877674e+00 -5.74807744e-01 -5.74807744e-01
 -5.74807744e-01  1.02036421e+00  1.02036421e+00  1.02036421e+00
  7.30261712e+00  7.30261712e+00  7.30261712e+00  9.59856269e+00
  3.34591409e+01  3.34591409e+01  3.34591409e+01  1.07608395e+02
  1.29054475e+02  1.29054475e+02  1.29054475e+02  4.83416817e+02
  4.83416817e+02  4.83416817e+02  5.99631661e+02  1.33512821e+03
  1.33512821e+03  1.33512821e+03  2.67172401e+03  3.02917412e+03
  3.02917412e+03  3.02917412e+03  6.64947405e+03  6.64947405e+03
  6.64947405e+03  9.07654704e+03  2.54312280e+04  7.61724745e+04]
E1 = -728.3296943774341  E_coul = 201.62526581802405
cycle= 3 E= -526.70442855941  delta_E= -3.54e-05  |g|= 0.00489  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.010605
diis-c [-4.58042964e-07 -1.12871868e-03  1.31423689e-01  8.69705029e-01]
  HOMO = -0.575743902483504  LUMO = 1.01966900741425
  mo_energy =
[-1.18575634e+02 -1.23053098e+01 -9.55810251e+00 -9.55810251e+00
 -9.55810251e+00 -1.24991096e+00 -5.75743902e-01 -5.75743902e-01
 -5.75743902e-01  1.01966901e+00  1.01966901e+00  1.01966901e+00
  7.30007138e+00  7.30007138e+00  7.30007138e+00  9.59543366e+00
  3.34547102e+01  3.34547102e+01  3.34547102e+01  1.07602126e+02
  1.29048212e+02  1.29048212e+02  1.29048212e+02  4.83409249e+02
  4.83409249e+02  4.83409249e+02  5.99623762e+02  1.33512012e+03
  1.33512012e+03  1.33512012e+03  2.67171535e+03  3.02916568e+03
  3.02916568e+03  3.02916568e+03  6.64946525e+03  6.64946525e+03
  6.64946525e+03  9.07653805e+03  2.54312189e+04  7.61724652e+04]
E1 = -728.3441550547303  E_coul = 201.63972562642516
cycle= 4 E= -526.704429428305  delta_E= -8.69e-07  |g|= 6.17e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000128021
diis-c [-1.34957831e-09  6.59293248e-05 -9.20593581e-03 -7.19117156e-02
  1.08105172e+00]
  HOMO = -0.575731890095939  LUMO = 1.01967792718822
  mo_energy =
[-1.18575640e+02 -1.23052815e+01 -9.55808617e+00 -9.55808617e+00
 -9.55808617e+00 -1.24989168e+00 -5.75731890e-01 -5.75731890e-01
 -5.75731890e-01  1.01967793e+00  1.01967793e+00  1.01967793e+00
  7.30009155e+00  7.30009155e+00  7.30009155e+00  9.59546911e+00
  3.34547253e+01  3.34547253e+01  3.34547253e+01  1.07602136e+02
  1.29048218e+02  1.29048218e+02  1.29048218e+02  4.83409244e+02
  4.83409244e+02  4.83409244e+02  5.99623749e+02  1.33512010e+03
  1.33512010e+03  1.33512010e+03  2.67171531e+03  3.02916565e+03
  3.02916565e+03  3.02916565e+03  6.64946521e+03  6.64946521e+03
  6.64946521e+03  9.07653800e+03  2.54312188e+04  7.61724652e+04]
E1 = -728.344157110558  E_coul = 201.63972768213176
cycle= 5 E= -526.704429428426  delta_E= -1.21e-10  |g|= 7.9e-06  |ddm|= 2.53e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.344157110558  E_coul = 201.63972768213176
  HOMO = -0.575735404343466  LUMO = 1.0196753594013
  mo_energy =
[-1.18575657e+02 -1.23052939e+01 -9.55809918e+00 -9.55809918e+00
 -9.55809918e+00 -1.24989600e+00 -5.75735404e-01 -5.75735404e-01
 -5.75735404e-01  1.01967536e+00  1.01967536e+00  1.01967536e+00
  7.30008300e+00  7.30008300e+00  7.30008300e+00  9.59545910e+00
  3.34547125e+01  3.34547125e+01  3.34547125e+01  1.07602121e+02
  1.29048202e+02  1.29048202e+02  1.29048202e+02  4.83409226e+02
  4.83409226e+02  4.83409226e+02  5.99623731e+02  1.33512008e+03
  1.33512008e+03  1.33512008e+03  2.67171529e+03  3.02916563e+03
  3.02916563e+03  3.02916563e+03  6.64946519e+03  6.64946519e+03
  6.64946519e+03  9.07653798e+03  2.54312188e+04  7.61724652e+04]
E1 = -728.3441962481602  E_coul = 201.63976681972912
Extra cycle  E= -526.704429428431  delta_E= -4.77e-12  |g|= 2.34e-06  |ddm|= 4.05e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.22 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102442.071671201
E1 = -728.3441962481602  E_coul = 201.63976681972912
init E= -526.704429428431
    CPU time for initialize scf      3.77 sec, wall time      0.20 sec
  HOMO = -0.575734687817243  LUMO = 1.01967588916139
  mo_energy =
[-1.18575653e+02 -1.23052910e+01 -9.55809621e+00 -9.55809621e+00
 -9.55809621e+00 -1.24989510e+00 -5.75734688e-01 -5.75734688e-01
 -5.75734688e-01  1.01967589e+00  1.01967589e+00  1.01967589e+00
  7.30008483e+00  7.30008483e+00  7.30008483e+00  9.59546138e+00
  3.34547155e+01  3.34547155e+01  3.34547155e+01  1.07602125e+02
  1.29048206e+02  1.29048206e+02  1.29048206e+02  4.83409231e+02
  4.83409231e+02  4.83409231e+02  5.99623736e+02  1.33512009e+03
  1.33512009e+03  1.33512009e+03  2.67171530e+03  3.02916564e+03
  3.02916564e+03  3.02916564e+03  6.64946520e+03  6.64946520e+03
  6.64946520e+03  9.07653799e+03  2.54312188e+04  7.61724652e+04]
E1 = -728.3441869211125  E_coul = 201.63975749268218
cycle= 1 E= -526.70442942843  delta_E= 6.82e-13  |g|= 6.03e-07  |ddm|= 9.33e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3441869211125  E_coul = 201.63975749268218
  HOMO = -0.575734846636908  LUMO = 1.01967577108596
  mo_energy =
[-1.18575654e+02 -1.23052917e+01 -9.55809691e+00 -9.55809691e+00
 -9.55809691e+00 -1.24989530e+00 -5.75734847e-01 -5.75734847e-01
 -5.75734847e-01  1.01967577e+00  1.01967577e+00  1.01967577e+00
  7.30008441e+00  7.30008441e+00  7.30008441e+00  9.59546086e+00
  3.34547148e+01  3.34547148e+01  3.34547148e+01  1.07602124e+02
  1.29048205e+02  1.29048205e+02  1.29048205e+02  4.83409230e+02
  4.83409230e+02  4.83409230e+02  5.99623735e+02  1.33512009e+03
  1.33512009e+03  1.33512009e+03  2.67171530e+03  3.02916564e+03
  3.02916564e+03  3.02916564e+03  6.64946520e+03  6.64946520e+03
  6.64946520e+03  9.07653799e+03  2.54312188e+04  7.61724652e+04]
E1 = -728.3441892010791  E_coul = 201.63975977264857
Extra cycle  E= -526.704429428431  delta_E= -2.27e-13  |g|= 1.52e-07  |ddm|= 2.19e-07
    CPU time for scf_cycle      4.10 sec, wall time      0.53 sec
exp = [2.61826608e+04 7.61751123e+03 3.61735613e+03 1.59760523e+03
 3.82684465e+02 1.11880582e+02 3.69199588e+01 7.92246500e+00
 3.10012004e+00 3.98612297e-01 1.36278487e+03 6.64729252e+02
 3.00884522e+02 3.13975482e+02 6.16729816e+01 7.33888511e+00
 2.02298255e+01 7.73869053e-01 2.82244650e+00 2.23074469e-01]
grad_E = [-1.54787685e-06  3.65316935e-06 -1.36136953e-06  8.20625040e-05
 -3.06472336e-04 -4.32458835e-05  2.47323211e-06  6.96219046e-05
 -1.88151092e-04  7.28410665e-04 -5.13774069e-07  4.91991633e-06
  2.31162844e-05  1.99257945e-05  1.59091840e-05 -1.08663807e-04
 -1.20665438e-04  9.61750185e-04  6.86099759e-04 -4.17565768e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:59:30 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.66107          1
[INPUT] 0    0    [1    /1   ]  7617.51062823        1
[INPUT] 0    0    [1    /1   ]  3617.35633776        1
[INPUT] 0    0    [1    /1   ]  1597.5914597         1
[INPUT] 0    0    [1    /1   ]  382.749879773        1
[INPUT] 0    0    [1    /1   ]  111.834035178        1
[INPUT] 0    0    [1    /1   ]  36.8984590897        1
[INPUT] 0    0    [1    /1   ]  7.92367213335        1
[INPUT] 0    0    [1    /1   ]  3.09951931446        1
[INPUT] 0    0    [1    /1   ]  0.398667861939       1
[INPUT] 1    0    [1    /1   ]  1362.78495358        1
[INPUT] 1    0    [1    /1   ]  664.728465999        1
[INPUT] 1    0    [1    /1   ]  300.880823417        1
[INPUT] 1    0    [1    /1   ]  313.972293875        1
[INPUT] 1    0    [1    /1   ]  61.673285863         1
[INPUT] 1    0    [1    /1   ]  7.34757391691        1
[INPUT] 1    0    [1    /1   ]  20.2305039289        1
[INPUT] 1    0    [1    /1   ]  0.774439642667       1
[INPUT] 1    0    [1    /1   ]  2.830329532          1
[INPUT] 1    0    [1    /1   ]  0.223083676997       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.66106998243, 1.0]], [0, [7617.510628230236, 1.0]], [0, [3617.356337760504, 1.0]], [0, [1597.591459695548, 1.0]], [0, [382.74987977290573, 1.0]], [0, [111.83403517832043, 1.0]], [0, [36.89845908971944, 1.0]], [0, [7.923672133348728, 1.0]], [0, [3.099519314455442, 1.0]], [0, [0.39866786193876375, 1.0]], [1, [1362.7849535803946, 1.0]], [1, [664.7284659986035, 1.0]], [1, [300.880823417119, 1.0]], [1, [313.972293874948, 1.0]], [1, [61.67328586302421, 1.0]], [1, [7.347573916914579, 1.0]], [1, [20.230503928867147, 1.0]], [1, [0.7744396426668321, 1.0]], [1, [2.8303295320045576, 1.0]], [1, [0.223083676997451, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66106998]
bas 1, expnt(s) = [7617.51062823]
bas 2, expnt(s) = [3617.35633776]
bas 3, expnt(s) = [1597.5914597]
bas 4, expnt(s) = [382.74987977]
bas 5, expnt(s) = [111.83403518]
bas 6, expnt(s) = [36.89845909]
bas 7, expnt(s) = [7.92367213]
bas 8, expnt(s) = [3.09951931]
bas 9, expnt(s) = [0.39866786]
bas 10, expnt(s) = [1362.78495358]
bas 11, expnt(s) = [664.728466]
bas 12, expnt(s) = [300.88082342]
bas 13, expnt(s) = [313.97229387]
bas 14, expnt(s) = [61.67328586]
bas 15, expnt(s) = [7.34757392]
bas 16, expnt(s) = [20.23050393]
bas 17, expnt(s) = [0.77443964]
bas 18, expnt(s) = [2.83032953]
bas 19, expnt(s) = [0.22308368]
CPU time:      1328.16
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826611e+04 5.20026364e+03 7.61751063e+03 2.06003608e+03
 3.61735634e+03 1.17844276e+03 1.59759146e+03 6.38431522e+02
 3.82749880e+02 2.18625755e+02 1.11834035e+02 8.68851431e+01
 3.68984591e+01 3.78243259e+01 7.92367213e+00 1.19319080e+01
 3.09951931e+00 5.90181762e+00 3.98667862e-01 1.26757436e+00
 1.36278495e+03 2.41556404e+04 6.64728466e+02 9.84667807e+03
 3.00880823e+02 3.65575875e+03 3.13972294e+02 3.85565840e+03
 6.16732859e+01 5.04203379e+02 7.34757392e+00 3.52910311e+01
 2.02305039e+01 1.25167843e+02 7.74439643e-01 2.11942895e+00
 2.83032953e+00 1.07097824e+01 2.23083677e-01 4.47269347e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982967164128752
cond(S) = 102440.2556020193
E1 = -729.3835902371814  E_coul = 203.1244439936507
init E= -526.259146243531
    CPU time for initialize scf      0.62 sec, wall time      0.05 sec
  HOMO = -0.556887832580228  LUMO = 1.03201095170812
  mo_energy =
[-1.18332363e+02 -1.22078147e+01 -9.45134947e+00 -9.45134947e+00
 -9.45134947e+00 -1.22577705e+00 -5.56887833e-01 -5.56887833e-01
 -5.56887833e-01  1.03201095e+00  1.03201095e+00  1.03201095e+00
  7.37857717e+00  7.37857717e+00  7.37857717e+00  9.66346572e+00
  3.36177108e+01  3.36177108e+01  3.36177108e+01  1.07711300e+02
  1.29281680e+02  1.29281680e+02  1.29281680e+02  4.83700698e+02
  4.83700698e+02  4.83700698e+02  5.99755131e+02  1.33545124e+03
  1.33545124e+03  1.33545124e+03  2.67206380e+03  3.02954766e+03
  3.02954766e+03  3.02954766e+03  6.64994889e+03  6.64994889e+03
  6.64994889e+03  9.07704493e+03  2.54318214e+04  7.61731574e+04]
E1 = -727.9672212552307  E_coul = 201.26341775533768
cycle= 1 E= -526.703803499893  delta_E= -0.445  |g|= 0.185  |ddm|= 0.413
    CPU time for cycle= 1      0.05 sec, wall time      0.02 sec
diis-norm(errvec)=0.542192
diis-c [-0.29397163  1.        ]
  HOMO = -0.581641162936273  LUMO = 1.01576061124293
  mo_energy =
[-1.18627167e+02 -1.23323844e+01 -9.58621901e+00 -9.58621901e+00
 -9.58621901e+00 -1.25745222e+00 -5.81641163e-01 -5.81641163e-01
 -5.81641163e-01  1.01576061e+00  1.01576061e+00  1.01576061e+00
  7.30183046e+00  7.30183046e+00  7.30183046e+00  9.57329679e+00
  3.34770850e+01  3.34770850e+01  3.34770850e+01  1.07501663e+02
  1.29066830e+02  1.29066830e+02  1.29066830e+02  4.83407298e+02
  4.83407298e+02  4.83407298e+02  5.99423067e+02  1.33510173e+03
  1.33510173e+03  1.33510173e+03  2.67158068e+03  3.02913244e+03
  3.02913244e+03  3.02913244e+03  6.64942064e+03  6.64942064e+03
  6.64942064e+03  9.07644163e+03  2.54311241e+04  7.61723699e+04]
E1 = -728.4353926766878  E_coul = 201.7309880609792
cycle= 2 E= -526.704404615709  delta_E= -0.000601  |g|= 0.0337  |ddm|= 0.0392
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0673827
diis-c [-0.00271922  0.07328127  0.92671873]
  HOMO = -0.574837435526283  LUMO = 1.02089932799576
  mo_energy =
[-1.18568006e+02 -1.23012443e+01 -9.55376238e+00 -9.55376238e+00
 -9.55376238e+00 -1.24881683e+00 -5.74837436e-01 -5.74837436e-01
 -5.74837436e-01  1.02089933e+00  1.02089933e+00  1.02089933e+00
  7.32055644e+00  7.32055644e+00  7.32055644e+00  9.59772317e+00
  3.35101709e+01  3.35101709e+01  3.35101709e+01  1.07550061e+02
  1.29114756e+02  1.29114756e+02  1.29114756e+02  4.83465702e+02
  4.83465702e+02  4.83465702e+02  5.99483804e+02  1.33516397e+03
  1.33516397e+03  1.33516397e+03  2.67164597e+03  3.02919676e+03
  3.02919676e+03  3.02919676e+03  6.64948653e+03  6.64948653e+03
  6.64948653e+03  9.07650823e+03  2.54311911e+04  7.61724372e+04]
E1 = -728.3290820455053  E_coul = 201.62464197644977
cycle= 3 E= -526.704440069056  delta_E= -3.55e-05  |g|= 0.00489  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106073
diis-c [-4.58461147e-07 -1.12899048e-03  1.31382672e-01  8.69746319e-01]
  HOMO = -0.575773924476564  LUMO = 1.02020314981444
  mo_energy =
[-1.18575670e+02 -1.23053449e+01 -9.55814049e+00 -9.55814049e+00
 -9.55814049e+00 -1.24995151e+00 -5.75773924e-01 -5.75773924e-01
 -5.75773924e-01  1.02020315e+00  1.02020315e+00  1.02020315e+00
  7.31800656e+00  7.31800656e+00  7.31800656e+00  9.59459397e+00
  3.35057391e+01  3.35057391e+01  3.35057391e+01  1.07543794e+02
  1.29108492e+02  1.29108492e+02  1.29108492e+02  4.83458135e+02
  4.83458135e+02  4.83458135e+02  5.99475905e+02  1.33515588e+03
  1.33515588e+03  1.33515588e+03  2.67163730e+03  3.02918832e+03
  3.02918832e+03  3.02918832e+03  6.64947773e+03  6.64947773e+03
  6.64947773e+03  9.07649923e+03  2.54311820e+04  7.61724280e+04]
E1 = -728.3435441922474  E_coul = 201.639103254174
cycle= 4 E= -526.704440938073  delta_E= -8.69e-07  |g|= 6.18e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000128142
diis-c [-1.34731256e-09  6.59370484e-05 -9.20466270e-03 -7.19355066e-02
  1.08107423e+00]
  HOMO = -0.575761938271752  LUMO = 1.02021205705647
  mo_energy =
[-1.18575677e+02 -1.23053166e+01 -9.55812422e+00 -9.55812422e+00
 -9.55812422e+00 -1.24993227e+00 -5.75761938e-01 -5.75761938e-01
 -5.75761938e-01  1.02021206e+00  1.02021206e+00  1.02021206e+00
  7.31802668e+00  7.31802668e+00  7.31802668e+00  9.59462937e+00
  3.35057542e+01  3.35057542e+01  3.35057542e+01  1.07543804e+02
  1.29108498e+02  1.29108498e+02  1.29108498e+02  4.83458130e+02
  4.83458130e+02  4.83458130e+02  5.99475892e+02  1.33515586e+03
  1.33515586e+03  1.33515586e+03  2.67163727e+03  3.02918830e+03
  3.02918830e+03  3.02918830e+03  6.64947769e+03  6.64947769e+03
  6.64947769e+03  9.07649919e+03  2.54311819e+04  7.61724279e+04]
E1 = -728.3435463432667  E_coul = 201.63910540507294
cycle= 5 E= -526.704440938194  delta_E= -1.2e-10  |g|= 7.9e-06  |ddm|= 2.53e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3435463432667  E_coul = 201.63910540507294
  HOMO = -0.575765453174614  LUMO = 1.02020948616721
  mo_energy =
[-1.18575694e+02 -1.23053290e+01 -9.55813722e+00 -9.55813722e+00
 -9.55813722e+00 -1.24993658e+00 -5.75765453e-01 -5.75765453e-01
 -5.75765453e-01  1.02020949e+00  1.02020949e+00  1.02020949e+00
  7.31801812e+00  7.31801812e+00  7.31801812e+00  9.59461936e+00
  3.35057414e+01  3.35057414e+01  3.35057414e+01  1.07543788e+02
  1.29108483e+02  1.29108483e+02  1.29108483e+02  4.83458112e+02
  4.83458112e+02  4.83458112e+02  5.99475874e+02  1.33515585e+03
  1.33515585e+03  1.33515585e+03  2.67163725e+03  3.02918828e+03
  3.02918828e+03  3.02918828e+03  6.64947767e+03  6.64947767e+03
  6.64947767e+03  9.07649917e+03  2.54311819e+04  7.61724279e+04]
E1 = -728.3435854886715  E_coul = 201.6391445504732
Extra cycle  E= -526.704440938198  delta_E= -4.55e-12  |g|= 2.34e-06  |ddm|= 4.06e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.22 sec
exp = [2.61826611e+04 7.61751063e+03 3.61735634e+03 1.59759146e+03
 3.82749880e+02 1.11834035e+02 3.68984591e+01 7.92367213e+00
 3.09951931e+00 3.98667862e-01 1.36278495e+03 6.64728466e+02
 3.00880823e+02 3.13972294e+02 6.16732859e+01 7.34757392e+00
 2.02305039e+01 7.74439643e-01 2.83032953e+00 2.23083677e-01]
E = -526.7044409381983
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:59:31 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.66107          1
[INPUT] 0    0    [1    /1   ]  7617.51062823        1
[INPUT] 0    0    [1    /1   ]  3617.35633776        1
[INPUT] 0    0    [1    /1   ]  1597.5914597         1
[INPUT] 0    0    [1    /1   ]  382.749879773        1
[INPUT] 0    0    [1    /1   ]  111.834035178        1
[INPUT] 0    0    [1    /1   ]  36.8984590897        1
[INPUT] 0    0    [1    /1   ]  7.92367213335        1
[INPUT] 0    0    [1    /1   ]  3.09951931446        1
[INPUT] 0    0    [1    /1   ]  0.398667861939       1
[INPUT] 1    0    [1    /1   ]  1362.78495358        1
[INPUT] 1    0    [1    /1   ]  664.728465999        1
[INPUT] 1    0    [1    /1   ]  300.880823417        1
[INPUT] 1    0    [1    /1   ]  313.972293875        1
[INPUT] 1    0    [1    /1   ]  61.673285863         1
[INPUT] 1    0    [1    /1   ]  7.34757391691        1
[INPUT] 1    0    [1    /1   ]  20.2305039289        1
[INPUT] 1    0    [1    /1   ]  0.774439642667       1
[INPUT] 1    0    [1    /1   ]  2.830329532          1
[INPUT] 1    0    [1    /1   ]  0.223083676997       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.66106998243, 1.0]], [0, [7617.510628230236, 1.0]], [0, [3617.356337760504, 1.0]], [0, [1597.591459695548, 1.0]], [0, [382.74987977290573, 1.0]], [0, [111.83403517832043, 1.0]], [0, [36.89845908971944, 1.0]], [0, [7.923672133348728, 1.0]], [0, [3.099519314455442, 1.0]], [0, [0.39866786193876375, 1.0]], [1, [1362.7849535803946, 1.0]], [1, [664.7284659986035, 1.0]], [1, [300.880823417119, 1.0]], [1, [313.972293874948, 1.0]], [1, [61.67328586302421, 1.0]], [1, [7.347573916914579, 1.0]], [1, [20.230503928867147, 1.0]], [1, [0.7744396426668321, 1.0]], [1, [2.8303295320045576, 1.0]], [1, [0.223083676997451, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66106998]
bas 1, expnt(s) = [7617.51062823]
bas 2, expnt(s) = [3617.35633776]
bas 3, expnt(s) = [1597.5914597]
bas 4, expnt(s) = [382.74987977]
bas 5, expnt(s) = [111.83403518]
bas 6, expnt(s) = [36.89845909]
bas 7, expnt(s) = [7.92367213]
bas 8, expnt(s) = [3.09951931]
bas 9, expnt(s) = [0.39866786]
bas 10, expnt(s) = [1362.78495358]
bas 11, expnt(s) = [664.728466]
bas 12, expnt(s) = [300.88082342]
bas 13, expnt(s) = [313.97229387]
bas 14, expnt(s) = [61.67328586]
bas 15, expnt(s) = [7.34757392]
bas 16, expnt(s) = [20.23050393]
bas 17, expnt(s) = [0.77443964]
bas 18, expnt(s) = [2.83032953]
bas 19, expnt(s) = [0.22308368]
CPU time:      1329.15
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826611e+04 5.20026364e+03 7.61751063e+03 2.06003608e+03
 3.61735634e+03 1.17844276e+03 1.59759146e+03 6.38431522e+02
 3.82749880e+02 2.18625755e+02 1.11834035e+02 8.68851431e+01
 3.68984591e+01 3.78243259e+01 7.92367213e+00 1.19319080e+01
 3.09951931e+00 5.90181762e+00 3.98667862e-01 1.26757436e+00
 1.36278495e+03 2.41556404e+04 6.64728466e+02 9.84667807e+03
 3.00880823e+02 3.65575875e+03 3.13972294e+02 3.85565840e+03
 6.16732859e+01 5.04203379e+02 7.34757392e+00 3.52910311e+01
 2.02305039e+01 1.25167843e+02 7.74439643e-01 2.11942895e+00
 2.83032953e+00 1.07097824e+01 2.23083677e-01 4.47269347e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982967164128752
cond(S) = 102440.2556020193
E1 = -729.3835902371814  E_coul = 203.1244439936507
init E= -526.259146243531
    CPU time for initialize scf      0.62 sec, wall time      0.05 sec
  HOMO = -0.556887832580228  LUMO = 1.03201095170812
  mo_energy =
[-1.18332363e+02 -1.22078147e+01 -9.45134947e+00 -9.45134947e+00
 -9.45134947e+00 -1.22577705e+00 -5.56887833e-01 -5.56887833e-01
 -5.56887833e-01  1.03201095e+00  1.03201095e+00  1.03201095e+00
  7.37857717e+00  7.37857717e+00  7.37857717e+00  9.66346572e+00
  3.36177108e+01  3.36177108e+01  3.36177108e+01  1.07711300e+02
  1.29281680e+02  1.29281680e+02  1.29281680e+02  4.83700698e+02
  4.83700698e+02  4.83700698e+02  5.99755131e+02  1.33545124e+03
  1.33545124e+03  1.33545124e+03  2.67206380e+03  3.02954766e+03
  3.02954766e+03  3.02954766e+03  6.64994889e+03  6.64994889e+03
  6.64994889e+03  9.07704493e+03  2.54318214e+04  7.61731574e+04]
E1 = -727.9672212552307  E_coul = 201.26341775533768
cycle= 1 E= -526.703803499893  delta_E= -0.445  |g|= 0.185  |ddm|= 0.413
    CPU time for cycle= 1      0.05 sec, wall time      0.02 sec
diis-norm(errvec)=0.542192
diis-c [-0.29397163  1.        ]
  HOMO = -0.581641162936273  LUMO = 1.01576061124293
  mo_energy =
[-1.18627167e+02 -1.23323844e+01 -9.58621901e+00 -9.58621901e+00
 -9.58621901e+00 -1.25745222e+00 -5.81641163e-01 -5.81641163e-01
 -5.81641163e-01  1.01576061e+00  1.01576061e+00  1.01576061e+00
  7.30183046e+00  7.30183046e+00  7.30183046e+00  9.57329679e+00
  3.34770850e+01  3.34770850e+01  3.34770850e+01  1.07501663e+02
  1.29066830e+02  1.29066830e+02  1.29066830e+02  4.83407298e+02
  4.83407298e+02  4.83407298e+02  5.99423067e+02  1.33510173e+03
  1.33510173e+03  1.33510173e+03  2.67158068e+03  3.02913244e+03
  3.02913244e+03  3.02913244e+03  6.64942064e+03  6.64942064e+03
  6.64942064e+03  9.07644163e+03  2.54311241e+04  7.61723699e+04]
E1 = -728.4353926766878  E_coul = 201.7309880609792
cycle= 2 E= -526.704404615709  delta_E= -0.000601  |g|= 0.0337  |ddm|= 0.0392
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0673827
diis-c [-0.00271922  0.07328127  0.92671873]
  HOMO = -0.574837435526283  LUMO = 1.02089932799576
  mo_energy =
[-1.18568006e+02 -1.23012443e+01 -9.55376238e+00 -9.55376238e+00
 -9.55376238e+00 -1.24881683e+00 -5.74837436e-01 -5.74837436e-01
 -5.74837436e-01  1.02089933e+00  1.02089933e+00  1.02089933e+00
  7.32055644e+00  7.32055644e+00  7.32055644e+00  9.59772317e+00
  3.35101709e+01  3.35101709e+01  3.35101709e+01  1.07550061e+02
  1.29114756e+02  1.29114756e+02  1.29114756e+02  4.83465702e+02
  4.83465702e+02  4.83465702e+02  5.99483804e+02  1.33516397e+03
  1.33516397e+03  1.33516397e+03  2.67164597e+03  3.02919676e+03
  3.02919676e+03  3.02919676e+03  6.64948653e+03  6.64948653e+03
  6.64948653e+03  9.07650823e+03  2.54311911e+04  7.61724372e+04]
E1 = -728.3290820455053  E_coul = 201.62464197644977
cycle= 3 E= -526.704440069056  delta_E= -3.55e-05  |g|= 0.00489  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106073
diis-c [-4.58461147e-07 -1.12899048e-03  1.31382672e-01  8.69746319e-01]
  HOMO = -0.575773924476564  LUMO = 1.02020314981444
  mo_energy =
[-1.18575670e+02 -1.23053449e+01 -9.55814049e+00 -9.55814049e+00
 -9.55814049e+00 -1.24995151e+00 -5.75773924e-01 -5.75773924e-01
 -5.75773924e-01  1.02020315e+00  1.02020315e+00  1.02020315e+00
  7.31800656e+00  7.31800656e+00  7.31800656e+00  9.59459397e+00
  3.35057391e+01  3.35057391e+01  3.35057391e+01  1.07543794e+02
  1.29108492e+02  1.29108492e+02  1.29108492e+02  4.83458135e+02
  4.83458135e+02  4.83458135e+02  5.99475905e+02  1.33515588e+03
  1.33515588e+03  1.33515588e+03  2.67163730e+03  3.02918832e+03
  3.02918832e+03  3.02918832e+03  6.64947773e+03  6.64947773e+03
  6.64947773e+03  9.07649923e+03  2.54311820e+04  7.61724280e+04]
E1 = -728.3435441922474  E_coul = 201.639103254174
cycle= 4 E= -526.704440938073  delta_E= -8.69e-07  |g|= 6.18e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000128142
diis-c [-1.34731256e-09  6.59370484e-05 -9.20466270e-03 -7.19355066e-02
  1.08107423e+00]
  HOMO = -0.575761938271752  LUMO = 1.02021205705647
  mo_energy =
[-1.18575677e+02 -1.23053166e+01 -9.55812422e+00 -9.55812422e+00
 -9.55812422e+00 -1.24993227e+00 -5.75761938e-01 -5.75761938e-01
 -5.75761938e-01  1.02021206e+00  1.02021206e+00  1.02021206e+00
  7.31802668e+00  7.31802668e+00  7.31802668e+00  9.59462937e+00
  3.35057542e+01  3.35057542e+01  3.35057542e+01  1.07543804e+02
  1.29108498e+02  1.29108498e+02  1.29108498e+02  4.83458130e+02
  4.83458130e+02  4.83458130e+02  5.99475892e+02  1.33515586e+03
  1.33515586e+03  1.33515586e+03  2.67163727e+03  3.02918830e+03
  3.02918830e+03  3.02918830e+03  6.64947769e+03  6.64947769e+03
  6.64947769e+03  9.07649919e+03  2.54311819e+04  7.61724279e+04]
E1 = -728.3435463432667  E_coul = 201.63910540507294
cycle= 5 E= -526.704440938194  delta_E= -1.2e-10  |g|= 7.9e-06  |ddm|= 2.53e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3435463432667  E_coul = 201.63910540507294
  HOMO = -0.575765453174614  LUMO = 1.02020948616721
  mo_energy =
[-1.18575694e+02 -1.23053290e+01 -9.55813722e+00 -9.55813722e+00
 -9.55813722e+00 -1.24993658e+00 -5.75765453e-01 -5.75765453e-01
 -5.75765453e-01  1.02020949e+00  1.02020949e+00  1.02020949e+00
  7.31801812e+00  7.31801812e+00  7.31801812e+00  9.59461936e+00
  3.35057414e+01  3.35057414e+01  3.35057414e+01  1.07543788e+02
  1.29108483e+02  1.29108483e+02  1.29108483e+02  4.83458112e+02
  4.83458112e+02  4.83458112e+02  5.99475874e+02  1.33515585e+03
  1.33515585e+03  1.33515585e+03  2.67163725e+03  3.02918828e+03
  3.02918828e+03  3.02918828e+03  6.64947767e+03  6.64947767e+03
  6.64947767e+03  9.07649917e+03  2.54311819e+04  7.61724279e+04]
E1 = -728.3435854886715  E_coul = 201.6391445504732
Extra cycle  E= -526.704440938198  delta_E= -4.55e-12  |g|= 2.34e-06  |ddm|= 4.06e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.22 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102440.2556020193
E1 = -728.3435854886715  E_coul = 201.6391445504732
init E= -526.704440938198
    CPU time for initialize scf      3.75 sec, wall time      0.20 sec
  HOMO = -0.575764736412186  LUMO = 1.02021001663844
  mo_energy =
[-1.18575689e+02 -1.23053261e+01 -9.55813425e+00 -9.55813425e+00
 -9.55813425e+00 -1.24993569e+00 -5.75764736e-01 -5.75764736e-01
 -5.75764736e-01  1.02021002e+00  1.02021002e+00  1.02021002e+00
  7.31801995e+00  7.31801995e+00  7.31801995e+00  9.59462164e+00
  3.35057443e+01  3.35057443e+01  3.35057443e+01  1.07543792e+02
  1.29108487e+02  1.29108487e+02  1.29108487e+02  4.83458117e+02
  4.83458117e+02  4.83458117e+02  5.99475879e+02  1.33515585e+03
  1.33515585e+03  1.33515585e+03  2.67163725e+03  3.02918828e+03
  3.02918828e+03  3.02918828e+03  6.64947768e+03  6.64947768e+03
  6.64947768e+03  9.07649918e+03  2.54311819e+04  7.61724279e+04]
E1 = -728.3435761586946  E_coul = 201.63913522049594
cycle= 1 E= -526.704440938199  delta_E= -3.41e-13  |g|= 6.03e-07  |ddm|= 9.33e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3435761586946  E_coul = 201.63913522049594
  HOMO = -0.575764895311053  LUMO = 1.02020989838166
  mo_energy =
[-1.18575691e+02 -1.23053268e+01 -9.55813496e+00 -9.55813496e+00
 -9.55813496e+00 -1.24993589e+00 -5.75764895e-01 -5.75764895e-01
 -5.75764895e-01  1.02020990e+00  1.02020990e+00  1.02020990e+00
  7.31801953e+00  7.31801953e+00  7.31801953e+00  9.59462112e+00
  3.35057436e+01  3.35057436e+01  3.35057436e+01  1.07543791e+02
  1.29108486e+02  1.29108486e+02  1.29108486e+02  4.83458116e+02
  4.83458116e+02  4.83458116e+02  5.99475878e+02  1.33515585e+03
  1.33515585e+03  1.33515585e+03  2.67163725e+03  3.02918828e+03
  3.02918828e+03  3.02918828e+03  6.64947768e+03  6.64947768e+03
  6.64947768e+03  9.07649917e+03  2.54311819e+04  7.61724279e+04]
E1 = -728.3435784395111  E_coul = 201.63913750131277
Extra cycle  E= -526.704440938198  delta_E= 3.41e-13  |g|= 1.52e-07  |ddm|= 2.19e-07
    CPU time for scf_cycle      3.86 sec, wall time      0.31 sec
exp = [2.61826611e+04 7.61751063e+03 3.61735634e+03 1.59759146e+03
 3.82749880e+02 1.11834035e+02 3.68984591e+01 7.92367213e+00
 3.09951931e+00 3.98667862e-01 1.36278495e+03 6.64728466e+02
 3.00880823e+02 3.13972294e+02 6.16732859e+01 7.34757392e+00
 2.02305039e+01 7.74439643e-01 2.83032953e+00 2.23083677e-01]
grad_E = [-1.54694594e-06  3.64215394e-06 -1.37003201e-06  8.16737136e-05
 -2.99177931e-04 -6.51719716e-05  1.48340758e-06  1.15669217e-04
 -3.18786377e-04  1.26612565e-03 -5.14799152e-07  4.90561677e-06
  2.30297209e-05  1.98513735e-05  2.58555286e-05 -1.66841759e-04
 -1.83929405e-04  1.66125855e-03  1.18628770e-03 -7.21322479e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:59:35 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6618137        1
[INPUT] 0    0    [1    /1   ]  7617.50885168        1
[INPUT] 0    0    [1    /1   ]  3617.35697241        1
[INPUT] 0    0    [1    /1   ]  1597.55115741        1
[INPUT] 0    0    [1    /1   ]  382.919867045        1
[INPUT] 0    0    [1    /1   ]  111.78058282         1
[INPUT] 0    0    [1    /1   ]  36.8688880277        1
[INPUT] 0    0    [1    /1   ]  7.92578734163        1
[INPUT] 0    0    [1    /1   ]  3.09867446528        1
[INPUT] 0    0    [1    /1   ]  0.39875569925        1
[INPUT] 1    0    [1    /1   ]  1362.78519888        1
[INPUT] 1    0    [1    /1   ]  664.726098375        1
[INPUT] 1    0    [1    /1   ]  300.869682706        1
[INPUT] 1    0    [1    /1   ]  313.962691332        1
[INPUT] 1    0    [1    /1   ]  61.674145101         1
[INPUT] 1    0    [1    /1   ]  7.36467828993        1
[INPUT] 1    0    [1    /1   ]  20.2373848223        1
[INPUT] 1    0    [1    /1   ]  0.775494489056       1
[INPUT] 1    0    [1    /1   ]  2.84411968841        1
[INPUT] 1    0    [1    /1   ]  0.223131899864       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.661813690356, 1.0]], [0, [7617.508851677612, 1.0]], [0, [3617.3569724077333, 1.0]], [0, [1597.5511574147995, 1.0]], [0, [382.9198670446802, 1.0]], [0, [111.78058282002733, 1.0]], [0, [36.86888802772583, 1.0]], [0, [7.925787341631189, 1.0]], [0, [3.0986744652840654, 1.0]], [0, [0.39875569924964543, 1.0]], [1, [1362.785198881734, 1.0]], [1, [664.7260983753602, 1.0]], [1, [300.86968270598106, 1.0]], [1, [313.9626913324292, 1.0]], [1, [61.67414510096973, 1.0]], [1, [7.364678289931066, 1.0]], [1, [20.237384822322444, 1.0]], [1, [0.7754944890558854, 1.0]], [1, [2.844119688407067, 1.0]], [1, [0.2231318998638766, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66181369]
bas 1, expnt(s) = [7617.50885168]
bas 2, expnt(s) = [3617.35697241]
bas 3, expnt(s) = [1597.55115741]
bas 4, expnt(s) = [382.91986704]
bas 5, expnt(s) = [111.78058282]
bas 6, expnt(s) = [36.86888803]
bas 7, expnt(s) = [7.92578734]
bas 8, expnt(s) = [3.09867447]
bas 9, expnt(s) = [0.3987557]
bas 10, expnt(s) = [1362.78519888]
bas 11, expnt(s) = [664.72609838]
bas 12, expnt(s) = [300.86968271]
bas 13, expnt(s) = [313.96269133]
bas 14, expnt(s) = [61.6741451]
bas 15, expnt(s) = [7.36467829]
bas 16, expnt(s) = [20.23738482]
bas 17, expnt(s) = [0.77549449]
bas 18, expnt(s) = [2.84411969]
bas 19, expnt(s) = [0.2231319]
CPU time:      1338.57
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826618e+04 5.20026376e+03 7.61750885e+03 2.06003572e+03
 3.61735697e+03 1.17844292e+03 1.59755116e+03 6.38419443e+02
 3.82919867e+02 2.18698573e+02 1.11780583e+02 8.68539954e+01
 3.68688880e+01 3.78015888e+01 7.92578734e+00 1.19342968e+01
 3.09867447e+00 5.90061106e+00 3.98755699e-01 1.26778381e+00
 1.36278520e+03 2.41556458e+04 6.64726098e+02 9.84663423e+03
 3.00869683e+02 3.65558955e+03 3.13962691e+02 3.85551100e+03
 6.16741451e+01 5.04212160e+02 7.36467829e+00 3.53937532e+01
 2.02373848e+01 1.25221061e+02 7.75494489e-01 2.12303810e+00
 2.84411969e+00 1.07750484e+01 2.23131900e-01 4.47390205e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98293487373341
cond(S) = 102430.50635484263
E1 = -729.3842951602486  E_coul = 203.12503649756385
init E= -526.259258662685
    CPU time for initialize scf      0.64 sec, wall time      0.05 sec
  HOMO = -0.556865335793066  LUMO = 1.03319834885967
  mo_energy =
[-1.18332335e+02 -1.22077787e+01 -9.45130832e+00 -9.45130832e+00
 -9.45130832e+00 -1.22575201e+00 -5.56865336e-01 -5.56865336e-01
 -5.56865336e-01  1.03319835e+00  1.03319835e+00  1.03319835e+00
  7.41110483e+00  7.41110483e+00  7.41110483e+00  9.66288771e+00
  3.37156101e+01  3.37156101e+01  3.37156101e+01  1.07637310e+02
  1.29409857e+02  1.29409857e+02  1.29409857e+02  4.83808954e+02
  4.83808954e+02  4.83808954e+02  5.99635310e+02  1.33552573e+03
  1.33552573e+03  1.33552573e+03  2.67219594e+03  3.02958548e+03
  3.02958548e+03  3.02958548e+03  6.64995895e+03  6.64995895e+03
  6.64995895e+03  9.07726693e+03  2.54320306e+04  7.61733437e+04]
E1 = -727.9662206193655  E_coul = 201.26238791384077
cycle= 1 E= -526.703832705525  delta_E= -0.445  |g|= 0.185  |ddm|= 0.413
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.542275
diis-c [-0.29406259  1.        ]
  HOMO = -0.581686765489352  LUMO = 1.0168610394275
  mo_energy =
[-1.18627233e+02 -1.23324460e+01 -9.58628548e+00 -9.58628548e+00
 -9.58628548e+00 -1.25751754e+00 -5.81686765e-01 -5.81686765e-01
 -5.81686765e-01  1.01686104e+00  1.01686104e+00  1.01686104e+00
  7.33402630e+00  7.33402630e+00  7.33402630e+00  9.57261444e+00
  3.35748217e+01  3.35748217e+01  3.35748217e+01  1.07427626e+02
  1.29194931e+02  1.29194931e+02  1.29194931e+02  4.83515468e+02
  4.83515468e+02  4.83515468e+02  5.99303133e+02  1.33517613e+03
  1.33517613e+03  1.33517613e+03  2.67171268e+03  3.02917015e+03
  3.02917015e+03  3.02917015e+03  6.64943058e+03  6.64943058e+03
  6.64943058e+03  9.07666351e+03  2.54313331e+04  7.61725562e+04]
E1 = -728.4346575276347  E_coul = 201.73022321071178
cycle= 2 E= -526.704434316923  delta_E= -0.000602  |g|= 0.0337  |ddm|= 0.0393
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0674375
diis-c [-0.0027213   0.07336978  0.92663022]
  HOMO = -0.574878596367766  LUMO = 1.0220129733389
  mo_energy =
[-1.18568055e+02 -1.23012899e+01 -9.55381253e+00 -9.55381253e+00
 -9.55381253e+00 -1.24887585e+00 -5.74878596e-01 -5.74878596e-01
 -5.74878596e-01  1.02201297e+00  1.02201297e+00  1.02201297e+00
  7.35281159e+00  7.35281159e+00  7.35281159e+00  9.59705196e+00
  3.36079378e+01  3.36079378e+01  3.36079378e+01  1.07476033e+02
  1.29242870e+02  1.29242870e+02  1.29242870e+02  4.83573888e+02
  4.83573888e+02  4.83573888e+02  5.99363887e+02  1.33523839e+03
  1.33523839e+03  1.33523839e+03  2.67177798e+03  3.02923449e+03
  3.02923449e+03  3.02923449e+03  6.64949648e+03  6.64949648e+03
  6.64949648e+03  9.07673012e+03  2.54314002e+04  7.61726235e+04]
E1 = -728.3282892711884  E_coul = 201.62381946139107
cycle= 3 E= -526.704469809797  delta_E= -3.55e-05  |g|= 0.00489  |ddm|= 0.0104
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106101
diis-c [-4.59093854e-07 -1.12935327e-03  1.31314884e-01  8.69814469e-01]
  HOMO = -0.57581538989058  LUMO = 1.02131521303962
  mo_energy =
[-1.18575718e+02 -1.23053899e+01 -9.55819027e+00 -9.55819027e+00
 -9.55819027e+00 -1.25001101e+00 -5.75815390e-01 -5.75815390e-01
 -5.75815390e-01  1.02131521e+00  1.02131521e+00  1.02131521e+00
  7.35025490e+00  7.35025490e+00  7.35025490e+00  9.59392300e+00
  3.36035047e+01  3.36035047e+01  3.36035047e+01  1.07469768e+02
  1.29236609e+02  1.29236609e+02  1.29236609e+02  4.83566323e+02
  4.83566323e+02  4.83566323e+02  5.99355989e+02  1.33523030e+03
  1.33523030e+03  1.33523030e+03  2.67176932e+03  3.02922605e+03
  3.02922605e+03  3.02922605e+03  6.64948768e+03  6.64948768e+03
  6.64948768e+03  9.07672113e+03  2.54313910e+04  7.61726142e+04]
E1 = -728.3427505231889  E_coul = 201.63827984451206
cycle= 4 E= -526.704470678677  delta_E= -8.69e-07  |g|= 6.18e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000128337
diis-c [-1.34299010e-09  6.59494807e-05 -9.20295328e-03 -7.19785416e-02
  1.08111555e+00]
  HOMO = -0.575803448274778  LUMO = 1.02132410014687
  mo_energy =
[-1.18575724e+02 -1.23053617e+01 -9.55817410e+00 -9.55817410e+00
 -9.55817410e+00 -1.24999182e+00 -5.75803448e-01 -5.75803448e-01
 -5.75803448e-01  1.02132410e+00  1.02132410e+00  1.02132410e+00
  7.35027493e+00  7.35027493e+00  7.35027493e+00  9.59395830e+00
  3.36035196e+01  3.36035196e+01  3.36035196e+01  1.07469778e+02
  1.29236615e+02  1.29236615e+02  1.29236615e+02  4.83566317e+02
  4.83566317e+02  4.83566317e+02  5.99355976e+02  1.33523028e+03
  1.33523028e+03  1.33523028e+03  2.67176928e+03  3.02922602e+03
  3.02922602e+03  3.02922602e+03  6.64948764e+03  6.64948764e+03
  6.64948764e+03  9.07672109e+03  2.54313910e+04  7.61726141e+04]
E1 = -728.3427528507915  E_coul = 201.63828217199415
cycle= 5 E= -526.704470678797  delta_E= -1.21e-10  |g|= 7.9e-06  |ddm|= 2.52e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3427528507915  E_coul = 201.63828217199415
  HOMO = -0.575806963267327  LUMO = 1.02132152431628
  mo_energy =
[-1.18575742e+02 -1.23053741e+01 -9.55818710e+00 -9.55818710e+00
 -9.55818710e+00 -1.24999614e+00 -5.75806963e-01 -5.75806963e-01
 -5.75806963e-01  1.02132152e+00  1.02132152e+00  1.02132152e+00
  7.35026636e+00  7.35026636e+00  7.35026636e+00  9.59394829e+00
  3.36035068e+01  3.36035068e+01  3.36035068e+01  1.07469762e+02
  1.29236599e+02  1.29236599e+02  1.29236599e+02  4.83566300e+02
  4.83566300e+02  4.83566300e+02  5.99355959e+02  1.33523026e+03
  1.33523026e+03  1.33523026e+03  2.67176927e+03  3.02922600e+03
  3.02922600e+03  3.02922600e+03  6.64948763e+03  6.64948763e+03
  6.64948763e+03  9.07672107e+03  2.54313910e+04  7.61726141e+04]
E1 = -728.3427919957959  E_coul = 201.63832131699567
Extra cycle  E= -526.7044706788  delta_E= -2.84e-12  |g|= 2.34e-06  |ddm|= 4.06e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.22 sec
exp = [2.61826618e+04 7.61750885e+03 3.61735697e+03 1.59755116e+03
 3.82919867e+02 1.11780583e+02 3.68688880e+01 7.92578734e+00
 3.09867447e+00 3.98755699e-01 1.36278520e+03 6.64726098e+02
 3.00869683e+02 3.13962691e+02 6.16741451e+01 7.36467829e+00
 2.02373848e+01 7.75494489e-01 2.84411969e+00 2.23131900e-01]
E = -526.7044706788002
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:59:35 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6618137        1
[INPUT] 0    0    [1    /1   ]  7617.50885168        1
[INPUT] 0    0    [1    /1   ]  3617.35697241        1
[INPUT] 0    0    [1    /1   ]  1597.55115741        1
[INPUT] 0    0    [1    /1   ]  382.919867045        1
[INPUT] 0    0    [1    /1   ]  111.78058282         1
[INPUT] 0    0    [1    /1   ]  36.8688880277        1
[INPUT] 0    0    [1    /1   ]  7.92578734163        1
[INPUT] 0    0    [1    /1   ]  3.09867446528        1
[INPUT] 0    0    [1    /1   ]  0.39875569925        1
[INPUT] 1    0    [1    /1   ]  1362.78519888        1
[INPUT] 1    0    [1    /1   ]  664.726098375        1
[INPUT] 1    0    [1    /1   ]  300.869682706        1
[INPUT] 1    0    [1    /1   ]  313.962691332        1
[INPUT] 1    0    [1    /1   ]  61.674145101         1
[INPUT] 1    0    [1    /1   ]  7.36467828993        1
[INPUT] 1    0    [1    /1   ]  20.2373848223        1
[INPUT] 1    0    [1    /1   ]  0.775494489056       1
[INPUT] 1    0    [1    /1   ]  2.84411968841        1
[INPUT] 1    0    [1    /1   ]  0.223131899864       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.661813690356, 1.0]], [0, [7617.508851677612, 1.0]], [0, [3617.3569724077333, 1.0]], [0, [1597.5511574147995, 1.0]], [0, [382.9198670446802, 1.0]], [0, [111.78058282002733, 1.0]], [0, [36.86888802772583, 1.0]], [0, [7.925787341631189, 1.0]], [0, [3.0986744652840654, 1.0]], [0, [0.39875569924964543, 1.0]], [1, [1362.785198881734, 1.0]], [1, [664.7260983753602, 1.0]], [1, [300.86968270598106, 1.0]], [1, [313.9626913324292, 1.0]], [1, [61.67414510096973, 1.0]], [1, [7.364678289931066, 1.0]], [1, [20.237384822322444, 1.0]], [1, [0.7754944890558854, 1.0]], [1, [2.844119688407067, 1.0]], [1, [0.2231318998638766, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66181369]
bas 1, expnt(s) = [7617.50885168]
bas 2, expnt(s) = [3617.35697241]
bas 3, expnt(s) = [1597.55115741]
bas 4, expnt(s) = [382.91986704]
bas 5, expnt(s) = [111.78058282]
bas 6, expnt(s) = [36.86888803]
bas 7, expnt(s) = [7.92578734]
bas 8, expnt(s) = [3.09867447]
bas 9, expnt(s) = [0.3987557]
bas 10, expnt(s) = [1362.78519888]
bas 11, expnt(s) = [664.72609838]
bas 12, expnt(s) = [300.86968271]
bas 13, expnt(s) = [313.96269133]
bas 14, expnt(s) = [61.6741451]
bas 15, expnt(s) = [7.36467829]
bas 16, expnt(s) = [20.23738482]
bas 17, expnt(s) = [0.77549449]
bas 18, expnt(s) = [2.84411969]
bas 19, expnt(s) = [0.2231319]
CPU time:      1339.58
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826618e+04 5.20026376e+03 7.61750885e+03 2.06003572e+03
 3.61735697e+03 1.17844292e+03 1.59755116e+03 6.38419443e+02
 3.82919867e+02 2.18698573e+02 1.11780583e+02 8.68539954e+01
 3.68688880e+01 3.78015888e+01 7.92578734e+00 1.19342968e+01
 3.09867447e+00 5.90061106e+00 3.98755699e-01 1.26778381e+00
 1.36278520e+03 2.41556458e+04 6.64726098e+02 9.84663423e+03
 3.00869683e+02 3.65558955e+03 3.13962691e+02 3.85551100e+03
 6.16741451e+01 5.04212160e+02 7.36467829e+00 3.53937532e+01
 2.02373848e+01 1.25221061e+02 7.75494489e-01 2.12303810e+00
 2.84411969e+00 1.07750484e+01 2.23131900e-01 4.47390205e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98293487373341
cond(S) = 102430.50635484263
E1 = -729.3842951602486  E_coul = 203.12503649756385
init E= -526.259258662685
    CPU time for initialize scf      0.62 sec, wall time      0.05 sec
  HOMO = -0.556865335793066  LUMO = 1.03319834885967
  mo_energy =
[-1.18332335e+02 -1.22077787e+01 -9.45130832e+00 -9.45130832e+00
 -9.45130832e+00 -1.22575201e+00 -5.56865336e-01 -5.56865336e-01
 -5.56865336e-01  1.03319835e+00  1.03319835e+00  1.03319835e+00
  7.41110483e+00  7.41110483e+00  7.41110483e+00  9.66288771e+00
  3.37156101e+01  3.37156101e+01  3.37156101e+01  1.07637310e+02
  1.29409857e+02  1.29409857e+02  1.29409857e+02  4.83808954e+02
  4.83808954e+02  4.83808954e+02  5.99635310e+02  1.33552573e+03
  1.33552573e+03  1.33552573e+03  2.67219594e+03  3.02958548e+03
  3.02958548e+03  3.02958548e+03  6.64995895e+03  6.64995895e+03
  6.64995895e+03  9.07726693e+03  2.54320306e+04  7.61733437e+04]
E1 = -727.9662206193655  E_coul = 201.26238791384077
cycle= 1 E= -526.703832705525  delta_E= -0.445  |g|= 0.185  |ddm|= 0.413
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.542275
diis-c [-0.29406259  1.        ]
  HOMO = -0.581686765489352  LUMO = 1.0168610394275
  mo_energy =
[-1.18627233e+02 -1.23324460e+01 -9.58628548e+00 -9.58628548e+00
 -9.58628548e+00 -1.25751754e+00 -5.81686765e-01 -5.81686765e-01
 -5.81686765e-01  1.01686104e+00  1.01686104e+00  1.01686104e+00
  7.33402630e+00  7.33402630e+00  7.33402630e+00  9.57261444e+00
  3.35748217e+01  3.35748217e+01  3.35748217e+01  1.07427626e+02
  1.29194931e+02  1.29194931e+02  1.29194931e+02  4.83515468e+02
  4.83515468e+02  4.83515468e+02  5.99303133e+02  1.33517613e+03
  1.33517613e+03  1.33517613e+03  2.67171268e+03  3.02917015e+03
  3.02917015e+03  3.02917015e+03  6.64943058e+03  6.64943058e+03
  6.64943058e+03  9.07666351e+03  2.54313331e+04  7.61725562e+04]
E1 = -728.4346575276347  E_coul = 201.73022321071178
cycle= 2 E= -526.704434316923  delta_E= -0.000602  |g|= 0.0337  |ddm|= 0.0393
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0674375
diis-c [-0.0027213   0.07336978  0.92663022]
  HOMO = -0.574878596367766  LUMO = 1.0220129733389
  mo_energy =
[-1.18568055e+02 -1.23012899e+01 -9.55381253e+00 -9.55381253e+00
 -9.55381253e+00 -1.24887585e+00 -5.74878596e-01 -5.74878596e-01
 -5.74878596e-01  1.02201297e+00  1.02201297e+00  1.02201297e+00
  7.35281159e+00  7.35281159e+00  7.35281159e+00  9.59705196e+00
  3.36079378e+01  3.36079378e+01  3.36079378e+01  1.07476033e+02
  1.29242870e+02  1.29242870e+02  1.29242870e+02  4.83573888e+02
  4.83573888e+02  4.83573888e+02  5.99363887e+02  1.33523839e+03
  1.33523839e+03  1.33523839e+03  2.67177798e+03  3.02923449e+03
  3.02923449e+03  3.02923449e+03  6.64949648e+03  6.64949648e+03
  6.64949648e+03  9.07673012e+03  2.54314002e+04  7.61726235e+04]
E1 = -728.3282892711884  E_coul = 201.62381946139107
cycle= 3 E= -526.704469809797  delta_E= -3.55e-05  |g|= 0.00489  |ddm|= 0.0104
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106101
diis-c [-4.59093854e-07 -1.12935327e-03  1.31314884e-01  8.69814469e-01]
  HOMO = -0.57581538989058  LUMO = 1.02131521303962
  mo_energy =
[-1.18575718e+02 -1.23053899e+01 -9.55819027e+00 -9.55819027e+00
 -9.55819027e+00 -1.25001101e+00 -5.75815390e-01 -5.75815390e-01
 -5.75815390e-01  1.02131521e+00  1.02131521e+00  1.02131521e+00
  7.35025490e+00  7.35025490e+00  7.35025490e+00  9.59392300e+00
  3.36035047e+01  3.36035047e+01  3.36035047e+01  1.07469768e+02
  1.29236609e+02  1.29236609e+02  1.29236609e+02  4.83566323e+02
  4.83566323e+02  4.83566323e+02  5.99355989e+02  1.33523030e+03
  1.33523030e+03  1.33523030e+03  2.67176932e+03  3.02922605e+03
  3.02922605e+03  3.02922605e+03  6.64948768e+03  6.64948768e+03
  6.64948768e+03  9.07672113e+03  2.54313910e+04  7.61726142e+04]
E1 = -728.3427505231889  E_coul = 201.63827984451206
cycle= 4 E= -526.704470678677  delta_E= -8.69e-07  |g|= 6.18e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000128337
diis-c [-1.34299010e-09  6.59494807e-05 -9.20295328e-03 -7.19785416e-02
  1.08111555e+00]
  HOMO = -0.575803448274778  LUMO = 1.02132410014687
  mo_energy =
[-1.18575724e+02 -1.23053617e+01 -9.55817410e+00 -9.55817410e+00
 -9.55817410e+00 -1.24999182e+00 -5.75803448e-01 -5.75803448e-01
 -5.75803448e-01  1.02132410e+00  1.02132410e+00  1.02132410e+00
  7.35027493e+00  7.35027493e+00  7.35027493e+00  9.59395830e+00
  3.36035196e+01  3.36035196e+01  3.36035196e+01  1.07469778e+02
  1.29236615e+02  1.29236615e+02  1.29236615e+02  4.83566317e+02
  4.83566317e+02  4.83566317e+02  5.99355976e+02  1.33523028e+03
  1.33523028e+03  1.33523028e+03  2.67176928e+03  3.02922602e+03
  3.02922602e+03  3.02922602e+03  6.64948764e+03  6.64948764e+03
  6.64948764e+03  9.07672109e+03  2.54313910e+04  7.61726141e+04]
E1 = -728.3427528507915  E_coul = 201.63828217199415
cycle= 5 E= -526.704470678797  delta_E= -1.21e-10  |g|= 7.9e-06  |ddm|= 2.52e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3427528507915  E_coul = 201.63828217199415
  HOMO = -0.575806963267327  LUMO = 1.02132152431628
  mo_energy =
[-1.18575742e+02 -1.23053741e+01 -9.55818710e+00 -9.55818710e+00
 -9.55818710e+00 -1.24999614e+00 -5.75806963e-01 -5.75806963e-01
 -5.75806963e-01  1.02132152e+00  1.02132152e+00  1.02132152e+00
  7.35026636e+00  7.35026636e+00  7.35026636e+00  9.59394829e+00
  3.36035068e+01  3.36035068e+01  3.36035068e+01  1.07469762e+02
  1.29236599e+02  1.29236599e+02  1.29236599e+02  4.83566300e+02
  4.83566300e+02  4.83566300e+02  5.99355959e+02  1.33523026e+03
  1.33523026e+03  1.33523026e+03  2.67176927e+03  3.02922600e+03
  3.02922600e+03  3.02922600e+03  6.64948763e+03  6.64948763e+03
  6.64948763e+03  9.07672107e+03  2.54313910e+04  7.61726141e+04]
E1 = -728.3427919957959  E_coul = 201.63832131699567
Extra cycle  E= -526.7044706788  delta_E= -2.84e-12  |g|= 2.34e-06  |ddm|= 4.06e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.22 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102430.50635484263
E1 = -728.3427919957959  E_coul = 201.63832131699567
init E= -526.7044706788
    CPU time for initialize scf      3.76 sec, wall time      0.20 sec
  HOMO = -0.575806246390808  LUMO = 1.02132205587224
  mo_energy =
[-1.18575737e+02 -1.23053712e+01 -9.55818413e+00 -9.55818413e+00
 -9.55818413e+00 -1.24999524e+00 -5.75806246e-01 -5.75806246e-01
 -5.75806246e-01  1.02132206e+00  1.02132206e+00  1.02132206e+00
  7.35026820e+00  7.35026820e+00  7.35026820e+00  9.59395058e+00
  3.36035098e+01  3.36035098e+01  3.36035098e+01  1.07469766e+02
  1.29236603e+02  1.29236603e+02  1.29236603e+02  4.83566305e+02
  4.83566305e+02  4.83566305e+02  5.99355963e+02  1.33523027e+03
  1.33523027e+03  1.33523027e+03  2.67176927e+03  3.02922601e+03
  3.02922601e+03  3.02922601e+03  6.64948763e+03  6.64948763e+03
  6.64948763e+03  9.07672107e+03  2.54313910e+04  7.61726141e+04]
E1 = -728.3427826646165  E_coul = 201.63831198581516
cycle= 1 E= -526.704470678801  delta_E= -1.02e-12  |g|= 6.03e-07  |ddm|= 9.34e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3427826646165  E_coul = 201.63831198581516
  HOMO = -0.575806405350889  LUMO = 1.02132193734272
  mo_energy =
[-1.18575738e+02 -1.23053719e+01 -9.55818484e+00 -9.55818484e+00
 -9.55818484e+00 -1.24999544e+00 -5.75806405e-01 -5.75806405e-01
 -5.75806405e-01  1.02132194e+00  1.02132194e+00  1.02132194e+00
  7.35026777e+00  7.35026777e+00  7.35026777e+00  9.59395005e+00
  3.36035091e+01  3.36035091e+01  3.36035091e+01  1.07469765e+02
  1.29236602e+02  1.29236602e+02  1.29236602e+02  4.83566304e+02
  4.83566304e+02  4.83566304e+02  5.99355962e+02  1.33523027e+03
  1.33523027e+03  1.33523027e+03  2.67176927e+03  3.02922601e+03
  3.02922601e+03  3.02922601e+03  6.64948763e+03  6.64948763e+03
  6.64948763e+03  9.07672107e+03  2.54313910e+04  7.61726141e+04]
E1 = -728.342784945862  E_coul = 201.63831426706008
Extra cycle  E= -526.704470678802  delta_E= -6.82e-13  |g|= 1.52e-07  |ddm|= 2.19e-07
    CPU time for scf_cycle      3.87 sec, wall time      0.31 sec
exp = [2.61826618e+04 7.61750885e+03 3.61735697e+03 1.59755116e+03
 3.82919867e+02 1.11780583e+02 3.68688880e+01 7.92578734e+00
 3.09867447e+00 3.98755699e-01 1.36278520e+03 6.64726098e+02
 3.00869683e+02 3.13962691e+02 6.16741451e+01 7.36467829e+00
 2.02373848e+01 7.75494489e-01 2.84411969e+00 2.23131900e-01]
grad_E = [-1.54517531e-06  3.62125544e-06 -1.38683432e-06  8.09516694e-05
 -2.86822801e-04 -9.96480973e-05 -3.09275301e-07  1.88205116e-04
 -5.25807432e-04  2.12289999e-03 -5.15828685e-07  4.89141681e-06
  2.29433541e-05  1.97769077e-05  3.71190997e-05 -2.54876005e-04
 -2.71138199e-04  2.77570375e-03  1.98498790e-03 -1.20490085e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:59:39 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6638531        1
[INPUT] 0    0    [1    /1   ]  7617.50401224        1
[INPUT] 0    0    [1    /1   ]  3617.35874106        1
[INPUT] 0    0    [1    /1   ]  1597.44197496        1
[INPUT] 0    0    [1    /1   ]  383.350162377        1
[INPUT] 0    0    [1    /1   ]  111.752096492        1
[INPUT] 0    0    [1    /1   ]  36.8357733726        1
[INPUT] 0    0    [1    /1   ]  7.92964893954        1
[INPUT] 0    0    [1    /1   ]  3.09771483276        1
[INPUT] 0    0    [1    /1   ]  0.398887395209       1
[INPUT] 1    0    [1    /1   ]  1362.78587244        1
[INPUT] 1    0    [1    /1   ]  664.719590854        1
[INPUT] 1    0    [1    /1   ]  300.839060012        1
[INPUT] 1    0    [1    /1   ]  313.936296076        1
[INPUT] 1    0    [1    /1   ]  61.6764394187        1
[INPUT] 1    0    [1    /1   ]  7.39930479387        1
[INPUT] 1    0    [1    /1   ]  20.2628754749        1
[INPUT] 1    0    [1    /1   ]  0.777485230434       1
[INPUT] 1    0    [1    /1   ]  2.86837498275        1
[INPUT] 1    0    [1    /1   ]  0.223294369155       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.66385311634, 1.0]], [0, [7617.504012241427, 1.0]], [0, [3617.358741063937, 1.0]], [0, [1597.4419749570125, 1.0]], [0, [383.350162376537, 1.0]], [0, [111.75209649249479, 1.0]], [0, [36.83577337257332, 1.0]], [0, [7.929648939535364, 1.0]], [0, [3.097714832757152, 1.0]], [0, [0.39888739520902433, 1.0]], [1, [1362.785872442287, 1.0]], [1, [664.7195908536228, 1.0]], [1, [300.8390600117711, 1.0]], [1, [313.9362960761408, 1.0]], [1, [61.676439418693995, 1.0]], [1, [7.399304793873399, 1.0]], [1, [20.262875474946025, 1.0]], [1, [0.7774852304335745, 1.0]], [1, [2.868374982754612, 1.0]], [1, [0.22329436915535472, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66385312]
bas 1, expnt(s) = [7617.50401224]
bas 2, expnt(s) = [3617.35874106]
bas 3, expnt(s) = [1597.44197496]
bas 4, expnt(s) = [383.35016238]
bas 5, expnt(s) = [111.75209649]
bas 6, expnt(s) = [36.83577337]
bas 7, expnt(s) = [7.92964894]
bas 8, expnt(s) = [3.09771483]
bas 9, expnt(s) = [0.3988874]
bas 10, expnt(s) = [1362.78587244]
bas 11, expnt(s) = [664.71959085]
bas 12, expnt(s) = [300.83906001]
bas 13, expnt(s) = [313.93629608]
bas 14, expnt(s) = [61.67643942]
bas 15, expnt(s) = [7.39930479]
bas 16, expnt(s) = [20.26287547]
bas 17, expnt(s) = [0.77748523]
bas 18, expnt(s) = [2.86837498]
bas 19, expnt(s) = [0.22329437]
CPU time:      1349.04
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826639e+04 5.20026406e+03 7.61750401e+03 2.06003473e+03
 3.61735874e+03 1.17844335e+03 1.59744197e+03 6.38386719e+02
 3.83350162e+02 2.18882864e+02 1.11752096e+02 8.68373944e+01
 3.68357734e+01 3.77761217e+01 7.92964894e+00 1.19386575e+01
 3.09771483e+00 5.89924048e+00 3.98887395e-01 1.26809783e+00
 1.36278587e+03 2.41556607e+04 6.64719591e+02 9.84651373e+03
 3.00839060e+02 3.65512447e+03 3.13936296e+02 3.85510583e+03
 6.16764394e+01 5.04235606e+02 7.39930479e+00 3.56018888e+01
 2.02628755e+01 1.25418250e+02 7.77485230e-01 2.12985274e+00
 2.86837498e+00 1.08900356e+01 2.23294369e-01 4.47797441e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982869461961208
cond(S) = 102397.93686249584
E1 = -729.3853205656226  E_coul = 203.12593144020133
init E= -526.259389125421
    CPU time for initialize scf      0.66 sec, wall time      0.05 sec
  HOMO = -0.556828614048396  LUMO = 1.03569987254308
  mo_energy =
[-1.18332315e+02 -1.22077230e+01 -9.45124582e+00 -9.45124582e+00
 -9.45124582e+00 -1.22571657e+00 -5.56828614e-01 -5.56828614e-01
 -5.56828614e-01  1.03569987e+00  1.03569987e+00  1.03569987e+00
  7.47041556e+00  7.47041556e+00  7.47041556e+00  9.66395501e+00
  3.39079290e+01  3.39079290e+01  3.39079290e+01  1.07573598e+02
  1.29688786e+02  1.29688786e+02  1.29688786e+02  4.84052887e+02
  4.84052887e+02  4.84052887e+02  5.99751240e+02  1.33568475e+03
  1.33568475e+03  1.33568475e+03  2.67306087e+03  3.02964755e+03
  3.02964755e+03  3.02964755e+03  6.64994857e+03  6.64994857e+03
  6.64994857e+03  9.07834028e+03  2.54330434e+04  7.61742642e+04]
E1 = -727.9653365901546  E_coul = 201.26142959569685
cycle= 1 E= -526.703906994458  delta_E= -0.445  |g|= 0.185  |ddm|= 0.414
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.542367
diis-c [-0.29416168  1.        ]
  HOMO = -0.581736605045089  LUMO = 1.01922845322952
  mo_energy =
[-1.18627286e+02 -1.23324987e+01 -9.58634542e+00 -9.58634542e+00
 -9.58634542e+00 -1.25759977e+00 -5.81736605e-01 -5.81736605e-01
 -5.81736605e-01  1.01922845e+00  1.01922845e+00  1.01922845e+00
  7.39279834e+00  7.39279834e+00  7.39279834e+00  9.57354995e+00
  3.37668829e+01  3.37668829e+01  3.37668829e+01  1.07363866e+02
  1.29473801e+02  1.29473801e+02  1.29473801e+02  4.83759352e+02
  4.83759352e+02  4.83759352e+02  5.99418920e+02  1.33533509e+03
  1.33533509e+03  1.33533509e+03  2.67257747e+03  3.02923212e+03
  3.02923212e+03  3.02923212e+03  6.64942010e+03  6.64942010e+03
  6.64942010e+03  9.07773676e+03  2.54323458e+04  7.61734765e+04]
E1 = -728.4339781536338  E_coul = 201.7294691449449
cycle= 2 E= -526.704509008689  delta_E= -0.000602  |g|= 0.0337  |ddm|= 0.0393
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0675059
diis-c [-0.0027234   0.07349105  0.92650895]
  HOMO = -0.574925151405247  LUMO = 1.02440175948195
  mo_energy =
[-1.18568101e+02 -1.23013313e+01 -9.55386121e+00 -9.55386121e+00
 -9.55386121e+00 -1.24895282e+00 -5.74925151e-01 -5.74925151e-01
 -5.74925151e-01  1.02440176e+00  1.02440176e+00  1.02440176e+00
  7.41167981e+00  7.41167981e+00  7.41167981e+00  9.59799633e+00
  3.38000436e+01  3.38000436e+01  3.38000436e+01  1.07412274e+02
  1.29521745e+02  1.29521745e+02  1.29521745e+02  4.83817774e+02
  4.83817774e+02  4.83817774e+02  5.99479682e+02  1.33539734e+03
  1.33539734e+03  1.33539734e+03  2.67264277e+03  3.02929645e+03
  3.02929645e+03  3.02929645e+03  6.64948601e+03  6.64948601e+03
  6.64948601e+03  9.07780338e+03  2.54324129e+04  7.61735438e+04]
E1 = -728.3275793913741  E_coul = 201.62303486079642
cycle= 3 E= -526.704544530578  delta_E= -3.55e-05  |g|= 0.00488  |ddm|= 0.0104
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106113
diis-c [-4.59975188e-07 -1.12972237e-03  1.31206165e-01  8.69923558e-01]
  HOMO = -0.57586182353101  LUMO = 1.02370150295921
  mo_energy =
[-1.18575758e+02 -1.23054286e+01 -9.55823626e+00 -9.55823626e+00
 -9.55823626e+00 -1.25008799e+00 -5.75861824e-01 -5.75861824e-01
 -5.75861824e-01  1.02370150e+00  1.02370150e+00  1.02370150e+00
  7.40911219e+00  7.40911219e+00  7.40911219e+00  9.59486909e+00
  3.37956090e+01  3.37956090e+01  3.37956090e+01  1.07406015e+02
  1.29515489e+02  1.29515489e+02  1.29515489e+02  4.83810215e+02
  4.83810215e+02  4.83810215e+02  5.99471790e+02  1.33538926e+03
  1.33538926e+03  1.33538926e+03  2.67263412e+03  3.02928802e+03
  3.02928802e+03  3.02928802e+03  6.64947722e+03  6.64947722e+03
  6.64947722e+03  9.07779440e+03  2.54324038e+04  7.61735345e+04]
E1 = -728.3420306870281  E_coul = 201.637485288665
cycle= 4 E= -526.704545398363  delta_E= -8.68e-07  |g|= 6.18e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000128639
diis-c [-1.33457012e-09  6.59687489e-05 -9.20121011e-03 -7.20572220e-02
  1.08119246e+00]
  HOMO = -0.575849957396873  LUMO = 1.02371035887636
  mo_energy =
[-1.18575765e+02 -1.23054006e+01 -9.55822027e+00 -9.55822027e+00
 -9.55822027e+00 -1.25006889e+00 -5.75849957e-01 -5.75849957e-01
 -5.75849957e-01  1.02371036e+00  1.02371036e+00  1.02371036e+00
  7.40913208e+00  7.40913208e+00  7.40913208e+00  9.59490422e+00
  3.37956238e+01  3.37956238e+01  3.37956238e+01  1.07406024e+02
  1.29515494e+02  1.29515494e+02  1.29515494e+02  4.83810210e+02
  4.83810210e+02  4.83810210e+02  5.99471777e+02  1.33538924e+03
  1.33538924e+03  1.33538924e+03  2.67263408e+03  3.02928800e+03
  3.02928800e+03  3.02928800e+03  6.64947718e+03  6.64947718e+03
  6.64947718e+03  9.07779435e+03  2.54324037e+04  7.61735345e+04]
E1 = -728.342033346867  E_coul = 201.63748794838284
cycle= 5 E= -526.704545398484  delta_E= -1.21e-10  |g|= 7.89e-06  |ddm|= 2.52e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.342033346867  E_coul = 201.63748794838284
  HOMO = -0.57585347002792  LUMO = 1.02370777551844
  mo_energy =
[-1.18575782e+02 -1.23054129e+01 -9.55823326e+00 -9.55823326e+00
 -9.55823326e+00 -1.25007321e+00 -5.75853470e-01 -5.75853470e-01
 -5.75853470e-01  1.02370778e+00  1.02370778e+00  1.02370778e+00
  7.40912348e+00  7.40912348e+00  7.40912348e+00  9.59489422e+00
  3.37956110e+01  3.37956110e+01  3.37956110e+01  1.07406009e+02
  1.29515479e+02  1.29515479e+02  1.29515479e+02  4.83810192e+02
  4.83810192e+02  4.83810192e+02  5.99471759e+02  1.33538923e+03
  1.33538923e+03  1.33538923e+03  2.67263406e+03  3.02928798e+03
  3.02928798e+03  3.02928798e+03  6.64947716e+03  6.64947716e+03
  6.64947716e+03  9.07779433e+03  2.54324037e+04  7.61735345e+04]
E1 = -728.3420724576426  E_coul = 201.63752705915675
Extra cycle  E= -526.704545398486  delta_E= -1.71e-12  |g|= 2.34e-06  |ddm|= 4.06e-06
    CPU time for scf_cycle      0.84 sec, wall time      0.23 sec
exp = [2.61826639e+04 7.61750401e+03 3.61735874e+03 1.59744197e+03
 3.83350162e+02 1.11752096e+02 3.68357734e+01 7.92964894e+00
 3.09771483e+00 3.98887395e-01 1.36278587e+03 6.64719591e+02
 3.00839060e+02 3.13936296e+02 6.16764394e+01 7.39930479e+00
 2.02628755e+01 7.77485230e-01 2.86837498e+00 2.23294369e-01]
E = -526.7045453984858
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:59:40 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6638531        1
[INPUT] 0    0    [1    /1   ]  7617.50401224        1
[INPUT] 0    0    [1    /1   ]  3617.35874106        1
[INPUT] 0    0    [1    /1   ]  1597.44197496        1
[INPUT] 0    0    [1    /1   ]  383.350162377        1
[INPUT] 0    0    [1    /1   ]  111.752096492        1
[INPUT] 0    0    [1    /1   ]  36.8357733726        1
[INPUT] 0    0    [1    /1   ]  7.92964893954        1
[INPUT] 0    0    [1    /1   ]  3.09771483276        1
[INPUT] 0    0    [1    /1   ]  0.398887395209       1
[INPUT] 1    0    [1    /1   ]  1362.78587244        1
[INPUT] 1    0    [1    /1   ]  664.719590854        1
[INPUT] 1    0    [1    /1   ]  300.839060012        1
[INPUT] 1    0    [1    /1   ]  313.936296076        1
[INPUT] 1    0    [1    /1   ]  61.6764394187        1
[INPUT] 1    0    [1    /1   ]  7.39930479387        1
[INPUT] 1    0    [1    /1   ]  20.2628754749        1
[INPUT] 1    0    [1    /1   ]  0.777485230434       1
[INPUT] 1    0    [1    /1   ]  2.86837498275        1
[INPUT] 1    0    [1    /1   ]  0.223294369155       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.66385311634, 1.0]], [0, [7617.504012241427, 1.0]], [0, [3617.358741063937, 1.0]], [0, [1597.4419749570125, 1.0]], [0, [383.350162376537, 1.0]], [0, [111.75209649249479, 1.0]], [0, [36.83577337257332, 1.0]], [0, [7.929648939535364, 1.0]], [0, [3.097714832757152, 1.0]], [0, [0.39888739520902433, 1.0]], [1, [1362.785872442287, 1.0]], [1, [664.7195908536228, 1.0]], [1, [300.8390600117711, 1.0]], [1, [313.9362960761408, 1.0]], [1, [61.676439418693995, 1.0]], [1, [7.399304793873399, 1.0]], [1, [20.262875474946025, 1.0]], [1, [0.7774852304335745, 1.0]], [1, [2.868374982754612, 1.0]], [1, [0.22329436915535472, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66385312]
bas 1, expnt(s) = [7617.50401224]
bas 2, expnt(s) = [3617.35874106]
bas 3, expnt(s) = [1597.44197496]
bas 4, expnt(s) = [383.35016238]
bas 5, expnt(s) = [111.75209649]
bas 6, expnt(s) = [36.83577337]
bas 7, expnt(s) = [7.92964894]
bas 8, expnt(s) = [3.09771483]
bas 9, expnt(s) = [0.3988874]
bas 10, expnt(s) = [1362.78587244]
bas 11, expnt(s) = [664.71959085]
bas 12, expnt(s) = [300.83906001]
bas 13, expnt(s) = [313.93629608]
bas 14, expnt(s) = [61.67643942]
bas 15, expnt(s) = [7.39930479]
bas 16, expnt(s) = [20.26287547]
bas 17, expnt(s) = [0.77748523]
bas 18, expnt(s) = [2.86837498]
bas 19, expnt(s) = [0.22329437]
CPU time:      1350.06
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826639e+04 5.20026406e+03 7.61750401e+03 2.06003473e+03
 3.61735874e+03 1.17844335e+03 1.59744197e+03 6.38386719e+02
 3.83350162e+02 2.18882864e+02 1.11752096e+02 8.68373944e+01
 3.68357734e+01 3.77761217e+01 7.92964894e+00 1.19386575e+01
 3.09771483e+00 5.89924048e+00 3.98887395e-01 1.26809783e+00
 1.36278587e+03 2.41556607e+04 6.64719591e+02 9.84651373e+03
 3.00839060e+02 3.65512447e+03 3.13936296e+02 3.85510583e+03
 6.16764394e+01 5.04235606e+02 7.39930479e+00 3.56018888e+01
 2.02628755e+01 1.25418250e+02 7.77485230e-01 2.12985274e+00
 2.86837498e+00 1.08900356e+01 2.23294369e-01 4.47797441e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982869461961208
cond(S) = 102397.93686249584
E1 = -729.3853205656226  E_coul = 203.12593144020133
init E= -526.259389125421
    CPU time for initialize scf      0.65 sec, wall time      0.05 sec
  HOMO = -0.556828614048396  LUMO = 1.03569987254308
  mo_energy =
[-1.18332315e+02 -1.22077230e+01 -9.45124582e+00 -9.45124582e+00
 -9.45124582e+00 -1.22571657e+00 -5.56828614e-01 -5.56828614e-01
 -5.56828614e-01  1.03569987e+00  1.03569987e+00  1.03569987e+00
  7.47041556e+00  7.47041556e+00  7.47041556e+00  9.66395501e+00
  3.39079290e+01  3.39079290e+01  3.39079290e+01  1.07573598e+02
  1.29688786e+02  1.29688786e+02  1.29688786e+02  4.84052887e+02
  4.84052887e+02  4.84052887e+02  5.99751240e+02  1.33568475e+03
  1.33568475e+03  1.33568475e+03  2.67306087e+03  3.02964755e+03
  3.02964755e+03  3.02964755e+03  6.64994857e+03  6.64994857e+03
  6.64994857e+03  9.07834028e+03  2.54330434e+04  7.61742642e+04]
E1 = -727.9653365901546  E_coul = 201.26142959569685
cycle= 1 E= -526.703906994458  delta_E= -0.445  |g|= 0.185  |ddm|= 0.414
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.542367
diis-c [-0.29416168  1.        ]
  HOMO = -0.581736605045089  LUMO = 1.01922845322952
  mo_energy =
[-1.18627286e+02 -1.23324987e+01 -9.58634542e+00 -9.58634542e+00
 -9.58634542e+00 -1.25759977e+00 -5.81736605e-01 -5.81736605e-01
 -5.81736605e-01  1.01922845e+00  1.01922845e+00  1.01922845e+00
  7.39279834e+00  7.39279834e+00  7.39279834e+00  9.57354995e+00
  3.37668829e+01  3.37668829e+01  3.37668829e+01  1.07363866e+02
  1.29473801e+02  1.29473801e+02  1.29473801e+02  4.83759352e+02
  4.83759352e+02  4.83759352e+02  5.99418920e+02  1.33533509e+03
  1.33533509e+03  1.33533509e+03  2.67257747e+03  3.02923212e+03
  3.02923212e+03  3.02923212e+03  6.64942010e+03  6.64942010e+03
  6.64942010e+03  9.07773676e+03  2.54323458e+04  7.61734765e+04]
E1 = -728.4339781536338  E_coul = 201.7294691449449
cycle= 2 E= -526.704509008689  delta_E= -0.000602  |g|= 0.0337  |ddm|= 0.0393
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0675059
diis-c [-0.0027234   0.07349105  0.92650895]
  HOMO = -0.574925151405247  LUMO = 1.02440175948195
  mo_energy =
[-1.18568101e+02 -1.23013313e+01 -9.55386121e+00 -9.55386121e+00
 -9.55386121e+00 -1.24895282e+00 -5.74925151e-01 -5.74925151e-01
 -5.74925151e-01  1.02440176e+00  1.02440176e+00  1.02440176e+00
  7.41167981e+00  7.41167981e+00  7.41167981e+00  9.59799633e+00
  3.38000436e+01  3.38000436e+01  3.38000436e+01  1.07412274e+02
  1.29521745e+02  1.29521745e+02  1.29521745e+02  4.83817774e+02
  4.83817774e+02  4.83817774e+02  5.99479682e+02  1.33539734e+03
  1.33539734e+03  1.33539734e+03  2.67264277e+03  3.02929645e+03
  3.02929645e+03  3.02929645e+03  6.64948601e+03  6.64948601e+03
  6.64948601e+03  9.07780338e+03  2.54324129e+04  7.61735438e+04]
E1 = -728.3275793913741  E_coul = 201.62303486079642
cycle= 3 E= -526.704544530578  delta_E= -3.55e-05  |g|= 0.00488  |ddm|= 0.0104
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106113
diis-c [-4.59975188e-07 -1.12972237e-03  1.31206165e-01  8.69923558e-01]
  HOMO = -0.57586182353101  LUMO = 1.02370150295921
  mo_energy =
[-1.18575758e+02 -1.23054286e+01 -9.55823626e+00 -9.55823626e+00
 -9.55823626e+00 -1.25008799e+00 -5.75861824e-01 -5.75861824e-01
 -5.75861824e-01  1.02370150e+00  1.02370150e+00  1.02370150e+00
  7.40911219e+00  7.40911219e+00  7.40911219e+00  9.59486909e+00
  3.37956090e+01  3.37956090e+01  3.37956090e+01  1.07406015e+02
  1.29515489e+02  1.29515489e+02  1.29515489e+02  4.83810215e+02
  4.83810215e+02  4.83810215e+02  5.99471790e+02  1.33538926e+03
  1.33538926e+03  1.33538926e+03  2.67263412e+03  3.02928802e+03
  3.02928802e+03  3.02928802e+03  6.64947722e+03  6.64947722e+03
  6.64947722e+03  9.07779440e+03  2.54324038e+04  7.61735345e+04]
E1 = -728.3420306870281  E_coul = 201.637485288665
cycle= 4 E= -526.704545398363  delta_E= -8.68e-07  |g|= 6.18e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000128639
diis-c [-1.33457012e-09  6.59687489e-05 -9.20121011e-03 -7.20572220e-02
  1.08119246e+00]
  HOMO = -0.575849957396873  LUMO = 1.02371035887636
  mo_energy =
[-1.18575765e+02 -1.23054006e+01 -9.55822027e+00 -9.55822027e+00
 -9.55822027e+00 -1.25006889e+00 -5.75849957e-01 -5.75849957e-01
 -5.75849957e-01  1.02371036e+00  1.02371036e+00  1.02371036e+00
  7.40913208e+00  7.40913208e+00  7.40913208e+00  9.59490422e+00
  3.37956238e+01  3.37956238e+01  3.37956238e+01  1.07406024e+02
  1.29515494e+02  1.29515494e+02  1.29515494e+02  4.83810210e+02
  4.83810210e+02  4.83810210e+02  5.99471777e+02  1.33538924e+03
  1.33538924e+03  1.33538924e+03  2.67263408e+03  3.02928800e+03
  3.02928800e+03  3.02928800e+03  6.64947718e+03  6.64947718e+03
  6.64947718e+03  9.07779435e+03  2.54324037e+04  7.61735345e+04]
E1 = -728.342033346867  E_coul = 201.63748794838284
cycle= 5 E= -526.704545398484  delta_E= -1.21e-10  |g|= 7.89e-06  |ddm|= 2.52e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.342033346867  E_coul = 201.63748794838284
  HOMO = -0.57585347002792  LUMO = 1.02370777551844
  mo_energy =
[-1.18575782e+02 -1.23054129e+01 -9.55823326e+00 -9.55823326e+00
 -9.55823326e+00 -1.25007321e+00 -5.75853470e-01 -5.75853470e-01
 -5.75853470e-01  1.02370778e+00  1.02370778e+00  1.02370778e+00
  7.40912348e+00  7.40912348e+00  7.40912348e+00  9.59489422e+00
  3.37956110e+01  3.37956110e+01  3.37956110e+01  1.07406009e+02
  1.29515479e+02  1.29515479e+02  1.29515479e+02  4.83810192e+02
  4.83810192e+02  4.83810192e+02  5.99471759e+02  1.33538923e+03
  1.33538923e+03  1.33538923e+03  2.67263406e+03  3.02928798e+03
  3.02928798e+03  3.02928798e+03  6.64947716e+03  6.64947716e+03
  6.64947716e+03  9.07779433e+03  2.54324037e+04  7.61735345e+04]
E1 = -728.3420724576426  E_coul = 201.63752705915675
Extra cycle  E= -526.704545398486  delta_E= -1.71e-12  |g|= 2.34e-06  |ddm|= 4.06e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.24 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102397.93686249584
E1 = -728.3420724576426  E_coul = 201.63752705915675
init E= -526.704545398486
    CPU time for initialize scf      3.81 sec, wall time      0.20 sec
  HOMO = -0.575852753664782  LUMO = 1.02370830860102
  mo_energy =
[-1.18575778e+02 -1.23054101e+01 -9.55823030e+00 -9.55823030e+00
 -9.55823030e+00 -1.25007231e+00 -5.75852754e-01 -5.75852754e-01
 -5.75852754e-01  1.02370831e+00  1.02370831e+00  1.02370831e+00
  7.40912533e+00  7.40912533e+00  7.40912533e+00  9.59489650e+00
  3.37956140e+01  3.37956140e+01  3.37956140e+01  1.07406013e+02
  1.29515483e+02  1.29515483e+02  1.29515483e+02  4.83810197e+02
  4.83810197e+02  4.83810197e+02  5.99471764e+02  1.33538923e+03
  1.33538923e+03  1.33538923e+03  2.67263407e+03  3.02928798e+03
  3.02928798e+03  3.02928798e+03  6.64947717e+03  6.64947717e+03
  6.64947717e+03  9.07779434e+03  2.54324037e+04  7.61735345e+04]
E1 = -728.3420631338101  E_coul = 201.63751773532408
cycle= 1 E= -526.704545398486  delta_E= -2.27e-13  |g|= 6.03e-07  |ddm|= 9.34e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3420631338101  E_coul = 201.63751773532408
  HOMO = -0.575852912545883  LUMO = 1.02370818969679
  mo_energy =
[-1.18575779e+02 -1.23054107e+01 -9.55823100e+00 -9.55823100e+00
 -9.55823100e+00 -1.25007251e+00 -5.75852913e-01 -5.75852913e-01
 -5.75852913e-01  1.02370819e+00  1.02370819e+00  1.02370819e+00
  7.40912490e+00  7.40912490e+00  7.40912490e+00  9.59489598e+00
  3.37956133e+01  3.37956133e+01  3.37956133e+01  1.07406012e+02
  1.29515482e+02  1.29515482e+02  1.29515482e+02  4.83810196e+02
  4.83810196e+02  4.83810196e+02  5.99471763e+02  1.33538923e+03
  1.33538923e+03  1.33538923e+03  2.67263407e+03  3.02928798e+03
  3.02928798e+03  3.02928798e+03  6.64947717e+03  6.64947717e+03
  6.64947717e+03  9.07779434e+03  2.54324037e+04  7.61735345e+04]
E1 = -728.3420654131362  E_coul = 201.63752001464817
Extra cycle  E= -526.704545398488  delta_E= -1.93e-12  |g|= 1.52e-07  |ddm|= 2.19e-07
    CPU time for scf_cycle      3.93 sec, wall time      0.32 sec
exp = [2.61826639e+04 7.61750401e+03 3.61735874e+03 1.59744197e+03
 3.83350162e+02 1.11752096e+02 3.68357734e+01 7.92964894e+00
 3.09771483e+00 3.98887395e-01 1.36278587e+03 6.64719591e+02
 3.00839060e+02 3.13936296e+02 6.16764394e+01 7.39930479e+00
 2.02628755e+01 7.77485230e-01 2.86837498e+00 2.23294369e-01]
grad_E = [-1.54171905e-06  3.58069159e-06 -1.41998491e-06  7.95839811e-05
 -2.66069644e-04 -1.51169269e-04 -3.63312870e-06  2.97264085e-04
 -8.37802993e-04  3.42618308e-03 -5.15873187e-07  4.89163229e-06
  2.29430435e-05  1.97757287e-05  4.25300523e-05 -3.82505028e-04
 -3.68461124e-04  4.47851043e-03  3.22056815e-03 -1.94128231e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:59:44 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6689887        1
[INPUT] 0    0    [1    /1   ]  7617.49187178        1
[INPUT] 0    0    [1    /1   ]  3617.36323501        1
[INPUT] 0    0    [1    /1   ]  1597.1689372         1
[INPUT] 0    0    [1    /1   ]  384.382774544        1
[INPUT] 0    0    [1    /1   ]  111.848045528        1
[INPUT] 0    0    [1    /1   ]  36.8208205962        1
[INPUT] 0    0    [1    /1   ]  7.9366576917         1
[INPUT] 0    0    [1    /1   ]  3.09724496223        1
[INPUT] 0    0    [1    /1   ]  0.399061446159       1
[INPUT] 1    0    [1    /1   ]  1362.78756982        1
[INPUT] 1    0    [1    /1   ]  664.703182774        1
[INPUT] 1    0    [1    /1   ]  300.761845098        1
[INPUT] 1    0    [1    /1   ]  313.86973983         1
[INPUT] 1    0    [1    /1   ]  61.6821430698        1
[INPUT] 1    0    [1    /1   ]  7.46897568393        1
[INPUT] 1    0    [1    /1   ]  20.3364764295        1
[INPUT] 1    0    [1    /1   ]  0.781193279412       1
[INPUT] 1    0    [1    /1   ]  2.90988132636        1
[INPUT] 1    0    [1    /1   ]  0.223746896969       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.668988670433, 1.0]], [0, [7617.491871779371, 1.0]], [0, [3617.363235009841, 1.0]], [0, [1597.1689371994594, 1.0]], [0, [384.38277454363055, 1.0]], [0, [111.84804552793622, 1.0]], [0, [36.8208205961702, 1.0]], [0, [7.9366576917035525, 1.0]], [0, [3.097244962227707, 1.0]], [0, [0.3990614461594422, 1.0]], [1, [1362.7875698159935, 1.0]], [1, [664.7031827739518, 1.0]], [1, [300.76184509788976, 1.0]], [1, [313.8697398304583, 1.0]], [1, [61.68214306978166, 1.0]], [1, [7.468975683927777, 1.0]], [1, [20.336476429478452, 1.0]], [1, [0.7811932794121906, 1.0]], [1, [2.9098813263556362, 1.0]], [1, [0.2237468969691389, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66898867]
bas 1, expnt(s) = [7617.49187178]
bas 2, expnt(s) = [3617.36323501]
bas 3, expnt(s) = [1597.1689372]
bas 4, expnt(s) = [384.38277454]
bas 5, expnt(s) = [111.84804553]
bas 6, expnt(s) = [36.8208206]
bas 7, expnt(s) = [7.93665769]
bas 8, expnt(s) = [3.09724496]
bas 9, expnt(s) = [0.39906145]
bas 10, expnt(s) = [1362.78756982]
bas 11, expnt(s) = [664.70318277]
bas 12, expnt(s) = [300.7618451]
bas 13, expnt(s) = [313.86973983]
bas 14, expnt(s) = [61.68214307]
bas 15, expnt(s) = [7.46897568]
bas 16, expnt(s) = [20.33647643]
bas 17, expnt(s) = [0.78119328]
bas 18, expnt(s) = [2.90988133]
bas 19, expnt(s) = [0.2237469]
CPU time:      1359.58
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826690e+04 5.20026482e+03 7.61749187e+03 2.06003227e+03
 3.61736324e+03 1.17844445e+03 1.59716894e+03 6.38304881e+02
 3.84382775e+02 2.19324911e+02 1.11848046e+02 8.68933066e+01
 3.68208206e+01 3.77646202e+01 7.93665769e+00 1.19465708e+01
 3.09724496e+00 5.89856936e+00 3.99061446e-01 1.26851280e+00
 1.36278757e+03 2.41556983e+04 6.64703183e+02 9.84620991e+03
 3.00761845e+02 3.65395183e+03 3.13869740e+02 3.85408423e+03
 6.16821431e+01 5.04293895e+02 7.46897568e+00 3.60214092e+01
 2.03364764e+01 1.25987955e+02 7.81193279e-01 2.14255765e+00
 2.90988133e+00 1.10873687e+01 2.23746897e-01 4.48932109e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982738403854224
cond(S) = 102307.74587220143
E1 = -729.3865919423431  E_coul = 203.12713749231148
init E= -526.259454450032
    CPU time for initialize scf      0.63 sec, wall time      0.05 sec
  HOMO = -0.556772326339116  LUMO = 1.04091503443191
  mo_energy =
[-1.18332346e+02 -1.22076446e+01 -9.45116032e+00 -9.45116032e+00
 -9.45116032e+00 -1.22567475e+00 -5.56772326e-01 -5.56772326e-01
 -5.56772326e-01  1.04091503e+00  1.04091503e+00  1.04091503e+00
  7.57685109e+00  7.57685109e+00  7.57685109e+00  9.67050499e+00
  3.42827084e+01  3.42827084e+01  3.42827084e+01  1.07611605e+02
  1.30286653e+02  1.30286653e+02  1.30286653e+02  4.84591277e+02
  4.84591277e+02  4.84591277e+02  6.00675635e+02  1.33602041e+03
  1.33602041e+03  1.33602041e+03  2.67595226e+03  3.02974424e+03
  3.02974424e+03  3.02974424e+03  6.64986818e+03  6.64986818e+03
  6.64986818e+03  9.08170344e+03  2.54362185e+04  7.61771645e+04]
E1 = -727.9658186082385  E_coul = 201.26173427465798
cycle= 1 E= -526.70408433358  delta_E= -0.445  |g|= 0.184  |ddm|= 0.415
    CPU time for cycle= 1      0.04 sec, wall time      0.02 sec
diis-norm(errvec)=0.542393
diis-c [-0.2941898  1.       ]
  HOMO = -0.581753902920707  LUMO = 1.02425648539536
  mo_energy =
[-1.18627225e+02 -1.23324615e+01 -9.58631718e+00 -9.58631718e+00
 -9.58631718e+00 -1.25766638e+00 -5.81753903e-01 -5.81753903e-01
 -5.81753903e-01  1.02425649e+00  1.02425649e+00  1.02425649e+00
  7.49841548e+00  7.49841548e+00  7.49841548e+00  9.57999258e+00
  3.41412896e+01  3.41412896e+01  3.41412896e+01  1.07401871e+02
  1.30071737e+02  1.30071737e+02  1.30071737e+02  4.84297887e+02
  4.84297887e+02  4.84297887e+02  6.00343203e+02  1.33567088e+03
  1.33567088e+03  1.33567088e+03  2.67546888e+03  3.02932889e+03
  3.02932889e+03  3.02932889e+03  6.64933981e+03  6.64933981e+03
  6.64933981e+03  9.08110005e+03  2.54355211e+04  7.61763770e+04]
E1 = -728.4342169813265  E_coul = 201.72953100420105
cycle= 2 E= -526.704685977125  delta_E= -0.000602  |g|= 0.0337  |ddm|= 0.0394
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0675582
diis-c [-0.00272337  0.07361912  0.92638088]
  HOMO = -0.57494708576135  LUMO = 1.02946201590058
  mo_energy =
[-1.18568086e+02 -1.23013128e+01 -9.55385303e+00 -9.55385303e+00
 -9.55385303e+00 -1.24902366e+00 -5.74947086e-01 -5.74947086e-01
 -5.74947086e-01  1.02946202e+00  1.02946202e+00  1.02946202e+00
  7.51744267e+00  7.51744267e+00  7.51744267e+00  9.60442994e+00
  3.41745066e+01  3.41745066e+01  3.41745066e+01  1.07450248e+02
  1.30119642e+02  1.30119642e+02  1.30119642e+02  4.84356256e+02
  4.84356256e+02  4.84356256e+02  6.00403928e+02  1.33573309e+03
  1.33573309e+03  1.33573309e+03  2.67553413e+03  3.02939318e+03
  3.02939318e+03  3.02939318e+03  6.64940566e+03  6.64940566e+03
  6.64940566e+03  9.08116661e+03  2.54355882e+04  7.61764443e+04]
E1 = -728.3279256899825  E_coul = 201.6232042329307
cycle= 3 E= -526.704721457052  delta_E= -3.55e-05  |g|= 0.00487  |ddm|= 0.0104
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106054
diis-c [-4.61001102e-07 -1.12976646e-03  1.31045774e-01  8.70083993e-01]
  HOMO = -0.575882091826476  LUMO = 1.02875813057995
  mo_energy =
[-1.18575727e+02 -1.23054012e+01 -9.55821898e+00 -9.55821898e+00
 -9.55821898e+00 -1.25015702e+00 -5.75882092e-01 -5.75882092e-01
 -5.75882092e-01  1.02875813e+00  1.02875813e+00  1.02875813e+00
  7.51485874e+00  7.51485874e+00  7.51485874e+00  9.60130847e+00
  3.41700716e+01  3.41700716e+01  3.41700716e+01  1.07444002e+02
  1.30113400e+02  1.30113400e+02  1.30113400e+02  4.84348714e+02
  4.84348714e+02  4.84348714e+02  6.00396051e+02  1.33572502e+03
  1.33572502e+03  1.33572502e+03  2.67552549e+03  3.02938477e+03
  3.02938477e+03  3.02938477e+03  6.64939689e+03  6.64939689e+03
  6.64939689e+03  9.08115764e+03  2.54355790e+04  7.61764350e+04]
E1 = -728.3423413411782  E_coul = 201.63761902010089
cycle= 4 E= -526.704722321077  delta_E= -8.64e-07  |g|= 6.18e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000129065
diis-c [-1.31854798e-09  6.59948218e-05 -9.20108185e-03 -7.21978191e-02
  1.08133291e+00]
  HOMO = -0.575870347938851  LUMO = 1.02876694251507
  mo_energy =
[-1.18575734e+02 -1.23053734e+01 -9.55820330e+00 -9.55820330e+00
 -9.55820330e+00 -1.25013808e+00 -5.75870348e-01 -5.75870348e-01
 -5.75870348e-01  1.02876694e+00  1.02876694e+00  1.02876694e+00
  7.51487840e+00  7.51487840e+00  7.51487840e+00  9.60134332e+00
  3.41700860e+01  3.41700860e+01  3.41700860e+01  1.07444011e+02
  1.30113405e+02  1.30113405e+02  1.30113405e+02  4.84348708e+02
  4.84348708e+02  4.84348708e+02  6.00396037e+02  1.33572501e+03
  1.33572501e+03  1.33572501e+03  2.67552545e+03  3.02938474e+03
  3.02938474e+03  3.02938474e+03  6.64939685e+03  6.64939685e+03
  6.64939685e+03  9.08115760e+03  2.54355790e+04  7.61764350e+04]
E1 = -728.342344611706  E_coul = 201.63762229050872
cycle= 5 E= -526.704722321197  delta_E= -1.2e-10  |g|= 7.87e-06  |ddm|= 2.51e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.342344611706  E_coul = 201.63762229050872
  HOMO = -0.575873851078791  LUMO = 1.0287643487962
  mo_energy =
[-1.18575752e+02 -1.23053857e+01 -9.55821625e+00 -9.55821625e+00
 -9.55821625e+00 -1.25014238e+00 -5.75873851e-01 -5.75873851e-01
 -5.75873851e-01  1.02876435e+00  1.02876435e+00  1.02876435e+00
  7.51486976e+00  7.51486976e+00  7.51486976e+00  9.60133334e+00
  3.41700732e+01  3.41700732e+01  3.41700732e+01  1.07443996e+02
  1.30113390e+02  1.30113390e+02  1.30113390e+02  4.84348690e+02
  4.84348690e+02  4.84348690e+02  6.00396020e+02  1.33572499e+03
  1.33572499e+03  1.33572499e+03  2.67552544e+03  3.02938472e+03
  3.02938472e+03  3.02938472e+03  6.64939683e+03  6.64939683e+03
  6.64939683e+03  9.08115758e+03  2.54355789e+04  7.61764349e+04]
E1 = -728.342383591304  E_coul = 201.63766127010308
Extra cycle  E= -526.704722321201  delta_E= -3.64e-12  |g|= 2.33e-06  |ddm|= 4.05e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.22 sec
exp = [2.61826690e+04 7.61749187e+03 3.61736324e+03 1.59716894e+03
 3.84382775e+02 1.11848046e+02 3.68208206e+01 7.93665769e+00
 3.09724496e+00 3.99061446e-01 1.36278757e+03 6.64703183e+02
 3.00761845e+02 3.13869740e+02 6.16821431e+01 7.46897568e+00
 2.03364764e+01 7.81193279e-01 2.90988133e+00 2.23746897e-01]
E = -526.704722321201
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:59:44 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6689887        1
[INPUT] 0    0    [1    /1   ]  7617.49187178        1
[INPUT] 0    0    [1    /1   ]  3617.36323501        1
[INPUT] 0    0    [1    /1   ]  1597.1689372         1
[INPUT] 0    0    [1    /1   ]  384.382774544        1
[INPUT] 0    0    [1    /1   ]  111.848045528        1
[INPUT] 0    0    [1    /1   ]  36.8208205962        1
[INPUT] 0    0    [1    /1   ]  7.9366576917         1
[INPUT] 0    0    [1    /1   ]  3.09724496223        1
[INPUT] 0    0    [1    /1   ]  0.399061446159       1
[INPUT] 1    0    [1    /1   ]  1362.78756982        1
[INPUT] 1    0    [1    /1   ]  664.703182774        1
[INPUT] 1    0    [1    /1   ]  300.761845098        1
[INPUT] 1    0    [1    /1   ]  313.86973983         1
[INPUT] 1    0    [1    /1   ]  61.6821430698        1
[INPUT] 1    0    [1    /1   ]  7.46897568393        1
[INPUT] 1    0    [1    /1   ]  20.3364764295        1
[INPUT] 1    0    [1    /1   ]  0.781193279412       1
[INPUT] 1    0    [1    /1   ]  2.90988132636        1
[INPUT] 1    0    [1    /1   ]  0.223746896969       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.668988670433, 1.0]], [0, [7617.491871779371, 1.0]], [0, [3617.363235009841, 1.0]], [0, [1597.1689371994594, 1.0]], [0, [384.38277454363055, 1.0]], [0, [111.84804552793622, 1.0]], [0, [36.8208205961702, 1.0]], [0, [7.9366576917035525, 1.0]], [0, [3.097244962227707, 1.0]], [0, [0.3990614461594422, 1.0]], [1, [1362.7875698159935, 1.0]], [1, [664.7031827739518, 1.0]], [1, [300.76184509788976, 1.0]], [1, [313.8697398304583, 1.0]], [1, [61.68214306978166, 1.0]], [1, [7.468975683927777, 1.0]], [1, [20.336476429478452, 1.0]], [1, [0.7811932794121906, 1.0]], [1, [2.9098813263556362, 1.0]], [1, [0.2237468969691389, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66898867]
bas 1, expnt(s) = [7617.49187178]
bas 2, expnt(s) = [3617.36323501]
bas 3, expnt(s) = [1597.1689372]
bas 4, expnt(s) = [384.38277454]
bas 5, expnt(s) = [111.84804553]
bas 6, expnt(s) = [36.8208206]
bas 7, expnt(s) = [7.93665769]
bas 8, expnt(s) = [3.09724496]
bas 9, expnt(s) = [0.39906145]
bas 10, expnt(s) = [1362.78756982]
bas 11, expnt(s) = [664.70318277]
bas 12, expnt(s) = [300.7618451]
bas 13, expnt(s) = [313.86973983]
bas 14, expnt(s) = [61.68214307]
bas 15, expnt(s) = [7.46897568]
bas 16, expnt(s) = [20.33647643]
bas 17, expnt(s) = [0.78119328]
bas 18, expnt(s) = [2.90988133]
bas 19, expnt(s) = [0.2237469]
CPU time:      1360.59
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826690e+04 5.20026482e+03 7.61749187e+03 2.06003227e+03
 3.61736324e+03 1.17844445e+03 1.59716894e+03 6.38304881e+02
 3.84382775e+02 2.19324911e+02 1.11848046e+02 8.68933066e+01
 3.68208206e+01 3.77646202e+01 7.93665769e+00 1.19465708e+01
 3.09724496e+00 5.89856936e+00 3.99061446e-01 1.26851280e+00
 1.36278757e+03 2.41556983e+04 6.64703183e+02 9.84620991e+03
 3.00761845e+02 3.65395183e+03 3.13869740e+02 3.85408423e+03
 6.16821431e+01 5.04293895e+02 7.46897568e+00 3.60214092e+01
 2.03364764e+01 1.25987955e+02 7.81193279e-01 2.14255765e+00
 2.90988133e+00 1.10873687e+01 2.23746897e-01 4.48932109e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982738403854224
cond(S) = 102307.74587220143
E1 = -729.3865919423431  E_coul = 203.12713749231148
init E= -526.259454450032
    CPU time for initialize scf      0.62 sec, wall time      0.05 sec
  HOMO = -0.556772326339116  LUMO = 1.04091503443191
  mo_energy =
[-1.18332346e+02 -1.22076446e+01 -9.45116032e+00 -9.45116032e+00
 -9.45116032e+00 -1.22567475e+00 -5.56772326e-01 -5.56772326e-01
 -5.56772326e-01  1.04091503e+00  1.04091503e+00  1.04091503e+00
  7.57685109e+00  7.57685109e+00  7.57685109e+00  9.67050499e+00
  3.42827084e+01  3.42827084e+01  3.42827084e+01  1.07611605e+02
  1.30286653e+02  1.30286653e+02  1.30286653e+02  4.84591277e+02
  4.84591277e+02  4.84591277e+02  6.00675635e+02  1.33602041e+03
  1.33602041e+03  1.33602041e+03  2.67595226e+03  3.02974424e+03
  3.02974424e+03  3.02974424e+03  6.64986818e+03  6.64986818e+03
  6.64986818e+03  9.08170344e+03  2.54362185e+04  7.61771645e+04]
E1 = -727.9658186082385  E_coul = 201.26173427465798
cycle= 1 E= -526.70408433358  delta_E= -0.445  |g|= 0.184  |ddm|= 0.415
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.542393
diis-c [-0.2941898  1.       ]
  HOMO = -0.581753902920707  LUMO = 1.02425648539536
  mo_energy =
[-1.18627225e+02 -1.23324615e+01 -9.58631718e+00 -9.58631718e+00
 -9.58631718e+00 -1.25766638e+00 -5.81753903e-01 -5.81753903e-01
 -5.81753903e-01  1.02425649e+00  1.02425649e+00  1.02425649e+00
  7.49841548e+00  7.49841548e+00  7.49841548e+00  9.57999258e+00
  3.41412896e+01  3.41412896e+01  3.41412896e+01  1.07401871e+02
  1.30071737e+02  1.30071737e+02  1.30071737e+02  4.84297887e+02
  4.84297887e+02  4.84297887e+02  6.00343203e+02  1.33567088e+03
  1.33567088e+03  1.33567088e+03  2.67546888e+03  3.02932889e+03
  3.02932889e+03  3.02932889e+03  6.64933981e+03  6.64933981e+03
  6.64933981e+03  9.08110005e+03  2.54355211e+04  7.61763770e+04]
E1 = -728.4342169813265  E_coul = 201.72953100420105
cycle= 2 E= -526.704685977125  delta_E= -0.000602  |g|= 0.0337  |ddm|= 0.0394
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0675582
diis-c [-0.00272337  0.07361912  0.92638088]
  HOMO = -0.57494708576135  LUMO = 1.02946201590058
  mo_energy =
[-1.18568086e+02 -1.23013128e+01 -9.55385303e+00 -9.55385303e+00
 -9.55385303e+00 -1.24902366e+00 -5.74947086e-01 -5.74947086e-01
 -5.74947086e-01  1.02946202e+00  1.02946202e+00  1.02946202e+00
  7.51744267e+00  7.51744267e+00  7.51744267e+00  9.60442994e+00
  3.41745066e+01  3.41745066e+01  3.41745066e+01  1.07450248e+02
  1.30119642e+02  1.30119642e+02  1.30119642e+02  4.84356256e+02
  4.84356256e+02  4.84356256e+02  6.00403928e+02  1.33573309e+03
  1.33573309e+03  1.33573309e+03  2.67553413e+03  3.02939318e+03
  3.02939318e+03  3.02939318e+03  6.64940566e+03  6.64940566e+03
  6.64940566e+03  9.08116661e+03  2.54355882e+04  7.61764443e+04]
E1 = -728.3279256899825  E_coul = 201.6232042329307
cycle= 3 E= -526.704721457052  delta_E= -3.55e-05  |g|= 0.00487  |ddm|= 0.0104
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106054
diis-c [-4.61001102e-07 -1.12976646e-03  1.31045774e-01  8.70083993e-01]
  HOMO = -0.575882091826476  LUMO = 1.02875813057995
  mo_energy =
[-1.18575727e+02 -1.23054012e+01 -9.55821898e+00 -9.55821898e+00
 -9.55821898e+00 -1.25015702e+00 -5.75882092e-01 -5.75882092e-01
 -5.75882092e-01  1.02875813e+00  1.02875813e+00  1.02875813e+00
  7.51485874e+00  7.51485874e+00  7.51485874e+00  9.60130847e+00
  3.41700716e+01  3.41700716e+01  3.41700716e+01  1.07444002e+02
  1.30113400e+02  1.30113400e+02  1.30113400e+02  4.84348714e+02
  4.84348714e+02  4.84348714e+02  6.00396051e+02  1.33572502e+03
  1.33572502e+03  1.33572502e+03  2.67552549e+03  3.02938477e+03
  3.02938477e+03  3.02938477e+03  6.64939689e+03  6.64939689e+03
  6.64939689e+03  9.08115764e+03  2.54355790e+04  7.61764350e+04]
E1 = -728.3423413411782  E_coul = 201.63761902010089
cycle= 4 E= -526.704722321077  delta_E= -8.64e-07  |g|= 6.18e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000129065
diis-c [-1.31854798e-09  6.59948218e-05 -9.20108185e-03 -7.21978191e-02
  1.08133291e+00]
  HOMO = -0.575870347938851  LUMO = 1.02876694251507
  mo_energy =
[-1.18575734e+02 -1.23053734e+01 -9.55820330e+00 -9.55820330e+00
 -9.55820330e+00 -1.25013808e+00 -5.75870348e-01 -5.75870348e-01
 -5.75870348e-01  1.02876694e+00  1.02876694e+00  1.02876694e+00
  7.51487840e+00  7.51487840e+00  7.51487840e+00  9.60134332e+00
  3.41700860e+01  3.41700860e+01  3.41700860e+01  1.07444011e+02
  1.30113405e+02  1.30113405e+02  1.30113405e+02  4.84348708e+02
  4.84348708e+02  4.84348708e+02  6.00396037e+02  1.33572501e+03
  1.33572501e+03  1.33572501e+03  2.67552545e+03  3.02938474e+03
  3.02938474e+03  3.02938474e+03  6.64939685e+03  6.64939685e+03
  6.64939685e+03  9.08115760e+03  2.54355790e+04  7.61764350e+04]
E1 = -728.342344611706  E_coul = 201.63762229050872
cycle= 5 E= -526.704722321197  delta_E= -1.2e-10  |g|= 7.87e-06  |ddm|= 2.51e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.342344611706  E_coul = 201.63762229050872
  HOMO = -0.575873851078791  LUMO = 1.0287643487962
  mo_energy =
[-1.18575752e+02 -1.23053857e+01 -9.55821625e+00 -9.55821625e+00
 -9.55821625e+00 -1.25014238e+00 -5.75873851e-01 -5.75873851e-01
 -5.75873851e-01  1.02876435e+00  1.02876435e+00  1.02876435e+00
  7.51486976e+00  7.51486976e+00  7.51486976e+00  9.60133334e+00
  3.41700732e+01  3.41700732e+01  3.41700732e+01  1.07443996e+02
  1.30113390e+02  1.30113390e+02  1.30113390e+02  4.84348690e+02
  4.84348690e+02  4.84348690e+02  6.00396020e+02  1.33572499e+03
  1.33572499e+03  1.33572499e+03  2.67552544e+03  3.02938472e+03
  3.02938472e+03  3.02938472e+03  6.64939683e+03  6.64939683e+03
  6.64939683e+03  9.08115758e+03  2.54355789e+04  7.61764349e+04]
E1 = -728.342383591304  E_coul = 201.63766127010308
Extra cycle  E= -526.704722321201  delta_E= -3.64e-12  |g|= 2.33e-06  |ddm|= 4.05e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.22 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102307.74587220143
E1 = -728.342383591304  E_coul = 201.63766127010308
init E= -526.704722321201
    CPU time for initialize scf      3.74 sec, wall time      0.20 sec
  HOMO = -0.575873137149149  LUMO = 1.02876488365571
  mo_energy =
[-1.18575747e+02 -1.23053829e+01 -9.55821330e+00 -9.55821330e+00
 -9.55821330e+00 -1.25014149e+00 -5.75873137e-01 -5.75873137e-01
 -5.75873137e-01  1.02876488e+00  1.02876488e+00  1.02876488e+00
  7.51487161e+00  7.51487161e+00  7.51487161e+00  9.60133562e+00
  3.41700762e+01  3.41700762e+01  3.41700762e+01  1.07444000e+02
  1.30113394e+02  1.30113394e+02  1.30113394e+02  4.84348695e+02
  4.84348695e+02  4.84348695e+02  6.00396025e+02  1.33572499e+03
  1.33572499e+03  1.33572499e+03  2.67552544e+03  3.02938473e+03
  3.02938473e+03  3.02938473e+03  6.64939683e+03  6.64939683e+03
  6.64939683e+03  9.08115758e+03  2.54355790e+04  7.61764350e+04]
E1 = -728.3423743005727  E_coul = 201.63765197937178
cycle= 1 E= -526.704722321201  delta_E=    0  |g|= 6e-07  |ddm|= 9.32e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3423743005727  E_coul = 201.63765197937178
  HOMO = -0.575873295486864  LUMO = 1.028764764342
  mo_energy =
[-1.18575748e+02 -1.23053835e+01 -9.55821400e+00 -9.55821400e+00
 -9.55821400e+00 -1.25014169e+00 -5.75873295e-01 -5.75873295e-01
 -5.75873295e-01  1.02876476e+00  1.02876476e+00  1.02876476e+00
  7.51487119e+00  7.51487119e+00  7.51487119e+00  9.60133510e+00
  3.41700755e+01  3.41700755e+01  3.41700755e+01  1.07443999e+02
  1.30113393e+02  1.30113393e+02  1.30113393e+02  4.84348694e+02
  4.84348694e+02  4.84348694e+02  6.00396023e+02  1.33572499e+03
  1.33572499e+03  1.33572499e+03  2.67552544e+03  3.02938473e+03
  3.02938473e+03  3.02938473e+03  6.64939683e+03  6.64939683e+03
  6.64939683e+03  9.08115758e+03  2.54355790e+04  7.61764350e+04]
E1 = -728.342376570918  E_coul = 201.63765424971749
Extra cycle  E= -526.704722321201  delta_E= 4.55e-13  |g|= 1.51e-07  |ddm|= 2.19e-07
    CPU time for scf_cycle      3.85 sec, wall time      0.31 sec
exp = [2.61826690e+04 7.61749187e+03 3.61736324e+03 1.59716894e+03
 3.84382775e+02 1.11848046e+02 3.68208206e+01 7.93665769e+00
 3.09724496e+00 3.99061446e-01 1.36278757e+03 6.64703183e+02
 3.00761845e+02 3.13869740e+02 6.16821431e+01 7.46897568e+00
 2.03364764e+01 7.81193279e-01 2.90988133e+00 2.23746897e-01]
grad_E = [-1.53500915e-06  3.50287572e-06 -1.48360110e-06  7.70286841e-05
 -2.32801353e-04 -2.19114950e-04 -9.79704632e-06  4.44375528e-04
 -1.25899968e-03  5.19953717e-03 -5.12085580e-07  4.94698995e-06
  2.32735115e-05  2.00570427e-05  2.05797012e-05 -5.51522450e-04
 -4.12220764e-04  6.83022746e-03  4.98856861e-03 -2.94711642e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:59:49 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6802045        1
[INPUT] 0    0    [1    /1   ]  7617.46542041        1
[INPUT] 0    0    [1    /1   ]  3617.37310458        1
[INPUT] 0    0    [1    /1   ]  1596.5752327         1
[INPUT] 0    0    [1    /1   ]  386.568350183        1
[INPUT] 0    0    [1    /1   ]  112.286505628        1
[INPUT] 0    0    [1    /1   ]  36.8824300849        1
[INPUT] 0    0    [1    /1   ]  7.94815281674        1
[INPUT] 0    0    [1    /1   ]  3.09891565999        1
[INPUT] 0    0    [1    /1   ]  0.399219770103       1
[INPUT] 1    0    [1    /1   ]  1362.79127851        1
[INPUT] 1    0    [1    /1   ]  664.667319326        1
[INPUT] 1    0    [1    /1   ]  300.593071219        1
[INPUT] 1    0    [1    /1   ]  313.724262253        1
[INPUT] 1    0    [1    /1   ]  61.6944764654        1
[INPUT] 1    0    [1    /1   ]  7.59662110774        1
[INPUT] 1    0    [1    /1   ]  20.5104433478        1
[INPUT] 1    0    [1    /1   ]  0.787384560812       1
[INPUT] 1    0    [1    /1   ]  2.97245211755        1
[INPUT] 1    0    [1    /1   ]  0.224780083506       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.680204455573, 1.0]], [0, [7617.465420405259, 1.0]], [0, [3617.3731045818513, 1.0]], [0, [1596.575232701824, 1.0]], [0, [386.5683501831784, 1.0]], [0, [112.28650562844108, 1.0]], [0, [36.88243008485437, 1.0]], [0, [7.948152816737959, 1.0]], [0, [3.0989156599899648, 1.0]], [0, [0.3992197701027398, 1.0]], [1, [1362.7912785102965, 1.0]], [1, [664.6673193260774, 1.0]], [1, [300.5930712188878, 1.0]], [1, [313.72426225267947, 1.0]], [1, [61.69447646541918, 1.0]], [1, [7.596621107735375, 1.0]], [1, [20.510443347762223, 1.0]], [1, [0.7873845608121899, 1.0]], [1, [2.9724521175499152, 1.0]], [1, [0.2247800835063467, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.68020446]
bas 1, expnt(s) = [7617.46542041]
bas 2, expnt(s) = [3617.37310458]
bas 3, expnt(s) = [1596.5752327]
bas 4, expnt(s) = [386.56835018]
bas 5, expnt(s) = [112.28650563]
bas 6, expnt(s) = [36.88243008]
bas 7, expnt(s) = [7.94815282]
bas 8, expnt(s) = [3.09891566]
bas 9, expnt(s) = [0.39921977]
bas 10, expnt(s) = [1362.79127851]
bas 11, expnt(s) = [664.66731933]
bas 12, expnt(s) = [300.59307122]
bas 13, expnt(s) = [313.72426225]
bas 14, expnt(s) = [61.69447647]
bas 15, expnt(s) = [7.59662111]
bas 16, expnt(s) = [20.51044335]
bas 17, expnt(s) = [0.78738456]
bas 18, expnt(s) = [2.97245212]
bas 19, expnt(s) = [0.22478008]
CPU time:      1370.24
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826802e+04 5.20026649e+03 7.61746542e+03 2.06002691e+03
 3.61737310e+03 1.17844686e+03 1.59657523e+03 6.38126919e+02
 3.86568350e+02 2.20259548e+02 1.12286506e+02 8.71486571e+01
 3.68824301e+01 3.78120018e+01 7.94815282e+00 1.19595456e+01
 3.09891566e+00 5.90095553e+00 3.99219770e-01 1.26889023e+00
 1.36279128e+03 2.41557805e+04 6.64667319e+02 9.84554587e+03
 3.00593071e+02 3.65138897e+03 3.13724262e+02 3.85185142e+03
 6.16944765e+01 5.04419940e+02 7.59662111e+00 3.67925573e+01
 2.05104433e+01 1.27336586e+02 7.87384561e-01 2.16380446e+00
 2.97245212e+00 1.13861782e+01 2.24780084e-01 4.51524872e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982503587340844
cond(S) = 102099.94780277963
E1 = -729.38752760792  E_coul = 203.12830172153932
init E= -526.259225886381
    CPU time for initialize scf      0.64 sec, wall time      0.05 sec
  HOMO = -0.556699430081206  LUMO = 1.05067682200631
  mo_energy =
[-1.18332524e+02 -1.22075616e+01 -9.45107567e+00 -9.45107567e+00
 -9.45107567e+00 -1.22564849e+00 -5.56699430e-01 -5.56699430e-01
 -5.56699430e-01  1.05067682e+00  1.05067682e+00  1.05067682e+00
  7.74816731e+00  7.74816731e+00  7.74816731e+00  9.69010753e+00
  3.49455219e+01  3.49455219e+01  3.49455219e+01  1.07967255e+02
  1.31443012e+02  1.31443012e+02  1.31443012e+02  4.85660204e+02
  4.85660204e+02  4.85660204e+02  6.03560361e+02  1.33666271e+03
  1.33666271e+03  1.33666271e+03  2.68323687e+03  3.02987198e+03
  3.02987198e+03  3.02987198e+03  6.64961669e+03  6.64961669e+03
  6.64961669e+03  9.08995058e+03  2.54440093e+04  7.61842983e+04]
E1 = -727.9705757567662  E_coul = 201.2661221318944
cycle= 1 E= -526.704453624872  delta_E= -0.445  |g|= 0.184  |ddm|= 0.421
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.542165
diis-c [-0.29394341  1.        ]
  HOMO = -0.581640339822767  LUMO = 1.03382345095218
  mo_energy =
[-1.18626840e+02 -1.23321485e+01 -9.58601044e+00 -9.58601044e+00
 -9.58601044e+00 -1.25761436e+00 -5.81640340e-01 -5.81640340e-01
 -5.81640340e-01  1.03382345e+00  1.03382345e+00  1.03382345e+00
  7.66870856e+00  7.66870856e+00  7.66870856e+00  9.59967243e+00
  3.48036784e+01  3.48036784e+01  3.48036784e+01  1.07757676e+02
  1.31228536e+02  1.31228536e+02  1.31228536e+02  4.85367488e+02
  4.85367488e+02  4.85367488e+02  6.03228019e+02  1.33631387e+03
  1.33631387e+03  1.33631387e+03  2.68275400e+03  3.02945727e+03
  3.02945727e+03  3.02945727e+03  6.64908901e+03  6.64908901e+03
  6.64908901e+03  9.08934794e+03  2.54433126e+04  7.61835116e+04]
E1 = -728.437409558425  E_coul = 201.73235697529532
cycle= 2 E= -526.70505258313  delta_E= -0.000599  |g|= 0.0336  |ddm|= 0.0393
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0675066
diis-c [-0.0027161   0.07365284  0.92634716]
  HOMO = -0.574861427251667  LUMO = 1.03906828847355
  mo_energy =
[-1.18567882e+02 -1.23011047e+01 -9.55365595e+00 -9.55365595e+00
 -9.55365595e+00 -1.24900493e+00 -5.74861427e-01 -5.74861427e-01
 -5.74861427e-01  1.03906829e+00  1.03906829e+00  1.03906829e+00
  7.68791650e+00  7.68791650e+00  7.68791650e+00  9.62404726e+00
  3.48369396e+01  3.48369396e+01  3.48369396e+01  1.07805944e+02
  1.31276293e+02  1.31276293e+02  1.31276293e+02  4.85425661e+02
  4.85425661e+02  4.85425661e+02  6.03288586e+02  1.33637587e+03
  1.33637587e+03  1.33637587e+03  2.68281906e+03  3.02952136e+03
  3.02952136e+03  3.02952136e+03  6.64915465e+03  6.64915465e+03
  6.64915465e+03  9.08941430e+03  2.54433795e+04  7.61835787e+04]
E1 = -728.3316025733179  E_coul = 201.62651475760086
cycle= 3 E= -526.705087815717  delta_E= -3.52e-05  |g|= 0.00485  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0105801
diis-c [-4.61464078e-07 -1.12858753e-03  1.30851048e-01  8.70277539e-01]
  HOMO = -0.575790984309891  LUMO = 1.03836027615325
  mo_energy =
[-1.18575486e+02 -1.23051710e+01 -9.55799915e+00 -9.55799915e+00
 -9.55799915e+00 -1.25013190e+00 -5.75790984e-01 -5.75790984e-01
 -5.75790984e-01  1.03836028e+00  1.03836028e+00  1.03836028e+00
  7.68531290e+00  7.68531290e+00  7.68531290e+00  9.62094024e+00
  3.48325082e+01  3.48325082e+01  3.48325082e+01  1.07799723e+02
  1.31270081e+02  1.31270081e+02  1.31270081e+02  4.85418158e+02
  4.85418158e+02  4.85418158e+02  6.03280743e+02  1.33636785e+03
  1.33636785e+03  1.33636785e+03  2.68281046e+03  3.02951298e+03
  3.02951298e+03  3.02951298e+03  6.64914592e+03  6.64914592e+03
  6.64914592e+03  9.08940537e+03  2.54433704e+04  7.61835694e+04]
E1 = -728.3459268349674  E_coul = 201.64083816467988
cycle= 4 E= -526.705088670288  delta_E= -8.55e-07  |g|= 6.17e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000129487
diis-c [-1.29166739e-09  6.60085835e-05 -9.20517246e-03 -7.24109857e-02
  1.08155015e+00]
  HOMO = -0.575779407395979  LUMO = 1.03836904254547
  mo_energy =
[-1.18575493e+02 -1.23051437e+01 -9.55798391e+00 -9.55798391e+00
 -9.55798391e+00 -1.25011317e+00 -5.75779407e-01 -5.75779407e-01
 -5.75779407e-01  1.03836904e+00  1.03836904e+00  1.03836904e+00
  7.68533221e+00  7.68533221e+00  7.68533221e+00  9.62097469e+00
  3.48325221e+01  3.48325221e+01  3.48325221e+01  1.07799732e+02
  1.31270086e+02  1.31270086e+02  1.31270086e+02  4.85418151e+02
  4.85418151e+02  4.85418151e+02  6.03280728e+02  1.33636783e+03
  1.33636783e+03  1.33636783e+03  2.68281042e+03  3.02951296e+03
  3.02951296e+03  3.02951296e+03  6.64914588e+03  6.64914588e+03
  6.64914588e+03  9.08940533e+03  2.54433703e+04  7.61835694e+04]
E1 = -728.3459310423876  E_coul = 201.64084237198125
cycle= 5 E= -526.705088670406  delta_E= -1.19e-10  |g|= 7.81e-06  |ddm|= 2.49e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3459310423876  E_coul = 201.64084237198125
  HOMO = -0.575782885759956  LUMO = 1.03836643811859
  mo_energy =
[-1.18575511e+02 -1.23051559e+01 -9.55799677e+00 -9.55799677e+00
 -9.55799677e+00 -1.25011745e+00 -5.75782886e-01 -5.75782886e-01
 -5.75782886e-01  1.03836644e+00  1.03836644e+00  1.03836644e+00
  7.68532354e+00  7.68532354e+00  7.68532354e+00  9.62096477e+00
  3.48325094e+01  3.48325094e+01  3.48325094e+01  1.07799716e+02
  1.31270070e+02  1.31270070e+02  1.31270070e+02  4.85418134e+02
  4.85418134e+02  4.85418134e+02  6.03280711e+02  1.33636781e+03
  1.33636781e+03  1.33636781e+03  2.68281040e+03  3.02951294e+03
  3.02951294e+03  3.02951294e+03  6.64914587e+03  6.64914587e+03
  6.64914587e+03  9.08940531e+03  2.54433703e+04  7.61835694e+04]
E1 = -728.3459696841546  E_coul = 201.64088101374549
Extra cycle  E= -526.705088670409  delta_E= -2.73e-12  |g|= 2.31e-06  |ddm|= 4.02e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.23 sec
exp = [2.61826802e+04 7.61746542e+03 3.61737310e+03 1.59657523e+03
 3.86568350e+02 1.12286506e+02 3.68824301e+01 7.94815282e+00
 3.09891566e+00 3.99219770e-01 1.36279128e+03 6.64667319e+02
 3.00593071e+02 3.13724262e+02 6.16944765e+01 7.59662111e+00
 2.05104433e+01 7.87384561e-01 2.97245212e+00 2.24780084e-01]
E = -526.7050886704092
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:59:49 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6802045        1
[INPUT] 0    0    [1    /1   ]  7617.46542041        1
[INPUT] 0    0    [1    /1   ]  3617.37310458        1
[INPUT] 0    0    [1    /1   ]  1596.5752327         1
[INPUT] 0    0    [1    /1   ]  386.568350183        1
[INPUT] 0    0    [1    /1   ]  112.286505628        1
[INPUT] 0    0    [1    /1   ]  36.8824300849        1
[INPUT] 0    0    [1    /1   ]  7.94815281674        1
[INPUT] 0    0    [1    /1   ]  3.09891565999        1
[INPUT] 0    0    [1    /1   ]  0.399219770103       1
[INPUT] 1    0    [1    /1   ]  1362.79127851        1
[INPUT] 1    0    [1    /1   ]  664.667319326        1
[INPUT] 1    0    [1    /1   ]  300.593071219        1
[INPUT] 1    0    [1    /1   ]  313.724262253        1
[INPUT] 1    0    [1    /1   ]  61.6944764654        1
[INPUT] 1    0    [1    /1   ]  7.59662110774        1
[INPUT] 1    0    [1    /1   ]  20.5104433478        1
[INPUT] 1    0    [1    /1   ]  0.787384560812       1
[INPUT] 1    0    [1    /1   ]  2.97245211755        1
[INPUT] 1    0    [1    /1   ]  0.224780083506       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.680204455573, 1.0]], [0, [7617.465420405259, 1.0]], [0, [3617.3731045818513, 1.0]], [0, [1596.575232701824, 1.0]], [0, [386.5683501831784, 1.0]], [0, [112.28650562844108, 1.0]], [0, [36.88243008485437, 1.0]], [0, [7.948152816737959, 1.0]], [0, [3.0989156599899648, 1.0]], [0, [0.3992197701027398, 1.0]], [1, [1362.7912785102965, 1.0]], [1, [664.6673193260774, 1.0]], [1, [300.5930712188878, 1.0]], [1, [313.72426225267947, 1.0]], [1, [61.69447646541918, 1.0]], [1, [7.596621107735375, 1.0]], [1, [20.510443347762223, 1.0]], [1, [0.7873845608121899, 1.0]], [1, [2.9724521175499152, 1.0]], [1, [0.2247800835063467, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.68020446]
bas 1, expnt(s) = [7617.46542041]
bas 2, expnt(s) = [3617.37310458]
bas 3, expnt(s) = [1596.5752327]
bas 4, expnt(s) = [386.56835018]
bas 5, expnt(s) = [112.28650563]
bas 6, expnt(s) = [36.88243008]
bas 7, expnt(s) = [7.94815282]
bas 8, expnt(s) = [3.09891566]
bas 9, expnt(s) = [0.39921977]
bas 10, expnt(s) = [1362.79127851]
bas 11, expnt(s) = [664.66731933]
bas 12, expnt(s) = [300.59307122]
bas 13, expnt(s) = [313.72426225]
bas 14, expnt(s) = [61.69447647]
bas 15, expnt(s) = [7.59662111]
bas 16, expnt(s) = [20.51044335]
bas 17, expnt(s) = [0.78738456]
bas 18, expnt(s) = [2.97245212]
bas 19, expnt(s) = [0.22478008]
CPU time:      1371.26
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826802e+04 5.20026649e+03 7.61746542e+03 2.06002691e+03
 3.61737310e+03 1.17844686e+03 1.59657523e+03 6.38126919e+02
 3.86568350e+02 2.20259548e+02 1.12286506e+02 8.71486571e+01
 3.68824301e+01 3.78120018e+01 7.94815282e+00 1.19595456e+01
 3.09891566e+00 5.90095553e+00 3.99219770e-01 1.26889023e+00
 1.36279128e+03 2.41557805e+04 6.64667319e+02 9.84554587e+03
 3.00593071e+02 3.65138897e+03 3.13724262e+02 3.85185142e+03
 6.16944765e+01 5.04419940e+02 7.59662111e+00 3.67925573e+01
 2.05104433e+01 1.27336586e+02 7.87384561e-01 2.16380446e+00
 2.97245212e+00 1.13861782e+01 2.24780084e-01 4.51524872e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982503587340844
cond(S) = 102099.94780277963
E1 = -729.38752760792  E_coul = 203.12830172153932
init E= -526.259225886381
    CPU time for initialize scf      0.63 sec, wall time      0.05 sec
  HOMO = -0.556699430081206  LUMO = 1.05067682200631
  mo_energy =
[-1.18332524e+02 -1.22075616e+01 -9.45107567e+00 -9.45107567e+00
 -9.45107567e+00 -1.22564849e+00 -5.56699430e-01 -5.56699430e-01
 -5.56699430e-01  1.05067682e+00  1.05067682e+00  1.05067682e+00
  7.74816731e+00  7.74816731e+00  7.74816731e+00  9.69010753e+00
  3.49455219e+01  3.49455219e+01  3.49455219e+01  1.07967255e+02
  1.31443012e+02  1.31443012e+02  1.31443012e+02  4.85660204e+02
  4.85660204e+02  4.85660204e+02  6.03560361e+02  1.33666271e+03
  1.33666271e+03  1.33666271e+03  2.68323687e+03  3.02987198e+03
  3.02987198e+03  3.02987198e+03  6.64961669e+03  6.64961669e+03
  6.64961669e+03  9.08995058e+03  2.54440093e+04  7.61842983e+04]
E1 = -727.9705757567662  E_coul = 201.2661221318944
cycle= 1 E= -526.704453624872  delta_E= -0.445  |g|= 0.184  |ddm|= 0.421
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.542165
diis-c [-0.29394341  1.        ]
  HOMO = -0.581640339822767  LUMO = 1.03382345095218
  mo_energy =
[-1.18626840e+02 -1.23321485e+01 -9.58601044e+00 -9.58601044e+00
 -9.58601044e+00 -1.25761436e+00 -5.81640340e-01 -5.81640340e-01
 -5.81640340e-01  1.03382345e+00  1.03382345e+00  1.03382345e+00
  7.66870856e+00  7.66870856e+00  7.66870856e+00  9.59967243e+00
  3.48036784e+01  3.48036784e+01  3.48036784e+01  1.07757676e+02
  1.31228536e+02  1.31228536e+02  1.31228536e+02  4.85367488e+02
  4.85367488e+02  4.85367488e+02  6.03228019e+02  1.33631387e+03
  1.33631387e+03  1.33631387e+03  2.68275400e+03  3.02945727e+03
  3.02945727e+03  3.02945727e+03  6.64908901e+03  6.64908901e+03
  6.64908901e+03  9.08934794e+03  2.54433126e+04  7.61835116e+04]
E1 = -728.437409558425  E_coul = 201.73235697529532
cycle= 2 E= -526.70505258313  delta_E= -0.000599  |g|= 0.0336  |ddm|= 0.0393
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0675066
diis-c [-0.0027161   0.07365284  0.92634716]
  HOMO = -0.574861427251667  LUMO = 1.03906828847355
  mo_energy =
[-1.18567882e+02 -1.23011047e+01 -9.55365595e+00 -9.55365595e+00
 -9.55365595e+00 -1.24900493e+00 -5.74861427e-01 -5.74861427e-01
 -5.74861427e-01  1.03906829e+00  1.03906829e+00  1.03906829e+00
  7.68791650e+00  7.68791650e+00  7.68791650e+00  9.62404726e+00
  3.48369396e+01  3.48369396e+01  3.48369396e+01  1.07805944e+02
  1.31276293e+02  1.31276293e+02  1.31276293e+02  4.85425661e+02
  4.85425661e+02  4.85425661e+02  6.03288586e+02  1.33637587e+03
  1.33637587e+03  1.33637587e+03  2.68281906e+03  3.02952136e+03
  3.02952136e+03  3.02952136e+03  6.64915465e+03  6.64915465e+03
  6.64915465e+03  9.08941430e+03  2.54433795e+04  7.61835787e+04]
E1 = -728.3316025733179  E_coul = 201.62651475760086
cycle= 3 E= -526.705087815717  delta_E= -3.52e-05  |g|= 0.00485  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0105801
diis-c [-4.61464078e-07 -1.12858753e-03  1.30851048e-01  8.70277539e-01]
  HOMO = -0.575790984309891  LUMO = 1.03836027615325
  mo_energy =
[-1.18575486e+02 -1.23051710e+01 -9.55799915e+00 -9.55799915e+00
 -9.55799915e+00 -1.25013190e+00 -5.75790984e-01 -5.75790984e-01
 -5.75790984e-01  1.03836028e+00  1.03836028e+00  1.03836028e+00
  7.68531290e+00  7.68531290e+00  7.68531290e+00  9.62094024e+00
  3.48325082e+01  3.48325082e+01  3.48325082e+01  1.07799723e+02
  1.31270081e+02  1.31270081e+02  1.31270081e+02  4.85418158e+02
  4.85418158e+02  4.85418158e+02  6.03280743e+02  1.33636785e+03
  1.33636785e+03  1.33636785e+03  2.68281046e+03  3.02951298e+03
  3.02951298e+03  3.02951298e+03  6.64914592e+03  6.64914592e+03
  6.64914592e+03  9.08940537e+03  2.54433704e+04  7.61835694e+04]
E1 = -728.3459268349674  E_coul = 201.64083816467988
cycle= 4 E= -526.705088670288  delta_E= -8.55e-07  |g|= 6.17e-05  |ddm|= 0.00133
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000129487
diis-c [-1.29166739e-09  6.60085835e-05 -9.20517246e-03 -7.24109857e-02
  1.08155015e+00]
  HOMO = -0.575779407395979  LUMO = 1.03836904254547
  mo_energy =
[-1.18575493e+02 -1.23051437e+01 -9.55798391e+00 -9.55798391e+00
 -9.55798391e+00 -1.25011317e+00 -5.75779407e-01 -5.75779407e-01
 -5.75779407e-01  1.03836904e+00  1.03836904e+00  1.03836904e+00
  7.68533221e+00  7.68533221e+00  7.68533221e+00  9.62097469e+00
  3.48325221e+01  3.48325221e+01  3.48325221e+01  1.07799732e+02
  1.31270086e+02  1.31270086e+02  1.31270086e+02  4.85418151e+02
  4.85418151e+02  4.85418151e+02  6.03280728e+02  1.33636783e+03
  1.33636783e+03  1.33636783e+03  2.68281042e+03  3.02951296e+03
  3.02951296e+03  3.02951296e+03  6.64914588e+03  6.64914588e+03
  6.64914588e+03  9.08940533e+03  2.54433703e+04  7.61835694e+04]
E1 = -728.3459310423876  E_coul = 201.64084237198125
cycle= 5 E= -526.705088670406  delta_E= -1.19e-10  |g|= 7.81e-06  |ddm|= 2.49e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3459310423876  E_coul = 201.64084237198125
  HOMO = -0.575782885759956  LUMO = 1.03836643811859
  mo_energy =
[-1.18575511e+02 -1.23051559e+01 -9.55799677e+00 -9.55799677e+00
 -9.55799677e+00 -1.25011745e+00 -5.75782886e-01 -5.75782886e-01
 -5.75782886e-01  1.03836644e+00  1.03836644e+00  1.03836644e+00
  7.68532354e+00  7.68532354e+00  7.68532354e+00  9.62096477e+00
  3.48325094e+01  3.48325094e+01  3.48325094e+01  1.07799716e+02
  1.31270070e+02  1.31270070e+02  1.31270070e+02  4.85418134e+02
  4.85418134e+02  4.85418134e+02  6.03280711e+02  1.33636781e+03
  1.33636781e+03  1.33636781e+03  2.68281040e+03  3.02951294e+03
  3.02951294e+03  3.02951294e+03  6.64914587e+03  6.64914587e+03
  6.64914587e+03  9.08940531e+03  2.54433703e+04  7.61835694e+04]
E1 = -728.3459696841546  E_coul = 201.64088101374549
Extra cycle  E= -526.705088670409  delta_E= -2.73e-12  |g|= 2.31e-06  |ddm|= 4.02e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102099.94780277963
E1 = -728.3459696841546  E_coul = 201.64088101374549
init E= -526.705088670409
    CPU time for initialize scf      3.78 sec, wall time      0.20 sec
  HOMO = -0.57578217852262  LUMO = 1.03836697399597
  mo_energy =
[-1.18575506e+02 -1.23051531e+01 -9.55799383e+00 -9.55799383e+00
 -9.55799383e+00 -1.25011656e+00 -5.75782179e-01 -5.75782179e-01
 -5.75782179e-01  1.03836697e+00  1.03836697e+00  1.03836697e+00
  7.68532540e+00  7.68532540e+00  7.68532540e+00  9.62096703e+00
  3.48325124e+01  3.48325124e+01  3.48325124e+01  1.07799720e+02
  1.31270074e+02  1.31270074e+02  1.31270074e+02  4.85418138e+02
  4.85418138e+02  4.85418138e+02  6.03280716e+02  1.33636782e+03
  1.33636782e+03  1.33636782e+03  2.68281041e+03  3.02951294e+03
  3.02951294e+03  3.02951294e+03  6.64914587e+03  6.64914587e+03
  6.64914587e+03  9.08940531e+03  2.54433703e+04  7.61835694e+04]
E1 = -728.3459604832108  E_coul = 201.6408718128012
cycle= 1 E= -526.70508867041  delta_E= -4.55e-13  |g|= 5.95e-07  |ddm|= 9.25e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3459604832108  E_coul = 201.6408718128012
  HOMO = -0.575782335246655  LUMO = 1.038366854528
  mo_energy =
[-1.18575507e+02 -1.23051538e+01 -9.55799453e+00 -9.55799453e+00
 -9.55799453e+00 -1.25011676e+00 -5.75782335e-01 -5.75782335e-01
 -5.75782335e-01  1.03836685e+00  1.03836685e+00  1.03836685e+00
  7.68532497e+00  7.68532497e+00  7.68532497e+00  9.62096651e+00
  3.48325116e+01  3.48325116e+01  3.48325116e+01  1.07799719e+02
  1.31270073e+02  1.31270073e+02  1.31270073e+02  4.85418137e+02
  4.85418137e+02  4.85418137e+02  6.03280714e+02  1.33636782e+03
  1.33636782e+03  1.33636782e+03  2.68281041e+03  3.02951294e+03
  3.02951294e+03  3.02951294e+03  6.64914587e+03  6.64914587e+03
  6.64914587e+03  9.08940531e+03  2.54433703e+04  7.61835694e+04]
E1 = -728.3459627288319  E_coul = 201.6408740584212
Extra cycle  E= -526.705088670411  delta_E= -1.02e-12  |g|= 1.5e-07  |ddm|= 2.17e-07
    CPU time for scf_cycle      3.89 sec, wall time      0.32 sec
exp = [2.61826802e+04 7.61746542e+03 3.61737310e+03 1.59657523e+03
 3.86568350e+02 1.12286506e+02 3.68824301e+01 7.94815282e+00
 3.09891566e+00 3.99219770e-01 1.36279128e+03 6.64667319e+02
 3.00593071e+02 3.13724262e+02 6.16944765e+01 7.59662111e+00
 2.05104433e+01 7.87384561e-01 2.97245212e+00 2.24780084e-01]
grad_E = [-1.52312163e-06  3.36810064e-06 -1.59066046e-06  7.27286380e-05
 -1.87097840e-04 -2.81738285e-04 -1.84392553e-05  5.88278480e-04
 -1.66933567e-03  6.95359473e-03 -4.98471741e-07  5.13895026e-06
  2.44246725e-05  2.10402122e-05 -7.04547729e-05 -6.85584693e-04
 -2.60134527e-04  9.23345954e-03  6.96439457e-03 -3.93649801e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:59:53 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6992775        1
[INPUT] 0    0    [1    /1   ]  7617.42051499        1
[INPUT] 0    0    [1    /1   ]  3617.38995541        1
[INPUT] 0    0    [1    /1   ]  1595.56877081        1
[INPUT] 0    0    [1    /1   ]  390.200308635        1
[INPUT] 0    0    [1    /1   ]  113.310403532        1
[INPUT] 0    0    [1    /1   ]  37.1032055394        1
[INPUT] 0    0    [1    /1   ]  7.96271699528        1
[INPUT] 0    0    [1    /1   ]  3.10511281451        1
[INPUT] 0    0    [1    /1   ]  0.399203928305       1
[INPUT] 1    0    [1    /1   ]  1362.79758745        1
[INPUT] 1    0    [1    /1   ]  664.606296521        1
[INPUT] 1    0    [1    /1   ]  300.305892782        1
[INPUT] 1    0    [1    /1   ]  313.4767225          1
[INPUT] 1    0    [1    /1   ]  61.7150822127        1
[INPUT] 1    0    [1    /1   ]  7.78121675982        1
[INPUT] 1    0    [1    /1   ]  20.8242779076        1
[INPUT] 1    0    [1    /1   ]  0.795151675699       1
[INPUT] 1    0    [1    /1   ]  3.04060367282        1
[INPUT] 1    0    [1    /1   ]  0.226509837248       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.699277478474, 1.0]], [0, [7617.420514988128, 1.0]], [0, [3617.389955410321, 1.0]], [0, [1595.568770807467, 1.0]], [0, [390.20030863530445, 1.0]], [0, [113.31040353197028, 1.0]], [0, [37.10320553939828, 1.0]], [0, [7.962716995283152, 1.0]], [0, [3.1051128145109654, 1.0]], [0, [0.39920392830484064, 1.0]], [1, [1362.7975874468236, 1.0]], [1, [664.6062965209175, 1.0]], [1, [300.3058927821487, 1.0]], [1, [313.4767224996942, 1.0]], [1, [61.715082212698896, 1.0]], [1, [7.781216759823345, 1.0]], [1, [20.824277907624925, 1.0]], [1, [0.7951516756985433, 1.0]], [1, [3.0406036728151618, 1.0]], [1, [0.2265098372480474, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.69927748]
bas 1, expnt(s) = [7617.42051499]
bas 2, expnt(s) = [3617.38995541]
bas 3, expnt(s) = [1595.56877081]
bas 4, expnt(s) = [390.20030864]
bas 5, expnt(s) = [113.31040353]
bas 6, expnt(s) = [37.10320554]
bas 7, expnt(s) = [7.962717]
bas 8, expnt(s) = [3.10511281]
bas 9, expnt(s) = [0.39920393]
bas 10, expnt(s) = [1362.79758745]
bas 11, expnt(s) = [664.60629652]
bas 12, expnt(s) = [300.30589278]
bas 13, expnt(s) = [313.4767225]
bas 14, expnt(s) = [61.71508221]
bas 15, expnt(s) = [7.78121676]
bas 16, expnt(s) = [20.82427791]
bas 17, expnt(s) = [0.79515168]
bas 18, expnt(s) = [3.04060367]
bas 19, expnt(s) = [0.22650984]
CPU time:      1380.76
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826993e+04 5.20026934e+03 7.61742051e+03 2.06001780e+03
 3.61738996e+03 1.17845098e+03 1.59556877e+03 6.37825194e+02
 3.90200309e+02 2.21809800e+02 1.13310404e+02 8.77439869e+01
 3.71032055e+01 3.79816300e+01 7.96271700e+00 1.19759779e+01
 3.10511281e+00 5.90980379e+00 3.99203928e-01 1.26885247e+00
 1.36279759e+03 2.41559203e+04 6.64606297e+02 9.84441598e+03
 3.00305893e+02 3.64702895e+03 3.13476722e+02 3.84805273e+03
 6.17150822e+01 5.04630542e+02 7.78121676e+00 3.79134918e+01
 2.08242779e+01 1.29776731e+02 7.95151676e-01 2.19051820e+00
 3.04060367e+00 1.17134320e+01 2.26509837e-01 4.55872325e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982188056503546
cond(S) = 101733.22822723418
E1 = -729.3867805015724  E_coul = 203.12833073251304
init E= -526.258449769059
    CPU time for initialize scf      0.63 sec, wall time      0.05 sec
  HOMO = -0.556634132882408  LUMO = 1.06458907756532
  mo_energy =
[-1.18332965e+02 -1.22075440e+01 -9.45107830e+00 -9.45107830e+00
 -9.45107830e+00 -1.22568338e+00 -5.56634133e-01 -5.56634133e-01
 -5.56634133e-01  1.06458908e+00  1.06458908e+00  1.06458908e+00
  7.95568863e+00  7.95568863e+00  7.95568863e+00  9.72977808e+00
  3.58628615e+01  3.58628615e+01  3.58628615e+01  1.08907377e+02
  1.33205750e+02  1.33205750e+02  1.33205750e+02  4.87335230e+02
  4.87335230e+02  4.87335230e+02  6.09521359e+02  1.33763491e+03
  1.33763491e+03  1.33763491e+03  2.69679070e+03  3.02997909e+03
  3.02997909e+03  3.02997909e+03  6.64908904e+03  6.64908904e+03
  6.64908904e+03  9.10507222e+03  2.54583062e+04  7.61974110e+04]
E1 = -727.9822719285509  E_coul = 201.2772185543664
cycle= 1 E= -526.705053374184  delta_E= -0.447  |g|= 0.184  |ddm|= 0.431
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.541501
diis-c [-0.29322296  1.        ]
  HOMO = -0.581260378543149  LUMO = 1.04768439578938
  mo_energy =
[-1.18626020e+02 -1.23314093e+01 -9.58526915e+00 -9.58526915e+00
 -9.58526915e+00 -1.25728459e+00 -5.81260379e-01 -5.81260379e-01
 -5.81260379e-01  1.04768440e+00  1.04768440e+00  1.04768440e+00
  7.87545348e+00  7.87545348e+00  7.87545348e+00  9.63981332e+00
  3.57207278e+01  3.57207278e+01  3.57207278e+01  1.08698158e+02
  1.32992257e+02  1.32992257e+02  1.32992257e+02  4.87043954e+02
  4.87043954e+02  4.87043954e+02  6.09189441e+02  1.33728754e+03
  1.33728754e+03  1.33728754e+03  2.69630913e+03  3.02956584e+03
  3.02956584e+03  3.02956584e+03  6.64856293e+03  6.64856293e+03
  6.64856293e+03  9.10447132e+03  2.54576113e+04  7.61966262e+04]
E1 = -728.4454056130922  E_coul = 201.73975964672135
cycle= 2 E= -526.705645966371  delta_E= -0.000593  |g|= 0.0334  |ddm|= 0.0392
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.067248
diis-c [-0.00269662  0.07344921  0.92655079]
  HOMO = -0.57454763739583  LUMO = 1.05295546032941
  mo_energy =
[-1.18567441e+02 -1.23006098e+01 -9.55316790e+00 -9.55316790e+00
 -9.55316790e+00 -1.24875771e+00 -5.74547637e-01 -5.74547637e-01
 -5.74547637e-01  1.05295546e+00  1.05295546e+00  1.05295546e+00
  7.89479578e+00  7.89479578e+00  7.89479578e+00  9.66403855e+00
  3.57539774e+01  3.57539774e+01  3.57539774e+01  1.08746206e+02
  1.33039705e+02  1.33039705e+02  1.33039705e+02  4.87101728e+02
  4.87101728e+02  4.87101728e+02  6.09249672e+02  1.33734914e+03
  1.33734914e+03  1.33734914e+03  2.69637378e+03  3.02962952e+03
  3.02962952e+03  3.02962952e+03  6.64862816e+03  6.64862816e+03
  6.64862816e+03  9.10453725e+03  2.54576777e+04  7.61966928e+04]
E1 = -728.3406750562241  E_coul = 201.6349944303979
cycle= 3 E= -526.705680625826  delta_E= -3.47e-05  |g|= 0.00481  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0105229
diis-c [-4.59223877e-07 -1.12472568e-03  1.30666521e-01  8.70458205e-01]
  HOMO = -0.575465955561389  LUMO = 1.05224556428428
  mo_energy =
[-1.18574983e+02 -1.23046365e+01 -9.55746987e+00 -9.55746987e+00
 -9.55746987e+00 -1.24987106e+00 -5.75465956e-01 -5.75465956e-01
 -5.75465956e-01  1.05224556e+00  1.05224556e+00  1.05224556e+00
  7.89217925e+00  7.89217925e+00  7.89217925e+00  9.66095763e+00
  3.57495572e+01  3.57495572e+01  3.57495572e+01  1.08740026e+02
  1.33033545e+02  1.33033545e+02  1.33033545e+02  4.87094289e+02
  4.87094289e+02  4.87094289e+02  6.09241885e+02  1.33734118e+03
  1.33734118e+03  1.33734118e+03  2.69636525e+03  3.02962121e+03
  3.02962121e+03  3.02962121e+03  6.64861950e+03  6.64861950e+03
  6.64861950e+03  9.10452840e+03  2.54576687e+04  7.61966837e+04]
E1 = -728.354830971409  E_coul = 201.64914950819497
cycle= 4 E= -526.705681463214  delta_E= -8.37e-07  |g|= 6.15e-05  |ddm|= 0.00132
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000129394
diis-c [-1.25744714e-09  6.59496396e-05 -9.21089640e-03 -7.26184295e-02
  1.08176338e+00]
  HOMO = -0.575454522389607  LUMO = 1.05225432341342
  mo_energy =
[-1.18574991e+02 -1.23046095e+01 -9.55745500e+00 -9.55745500e+00
 -9.55745500e+00 -1.24985254e+00 -5.75454522e-01 -5.75454522e-01
 -5.75454522e-01  1.05225432e+00  1.05225432e+00  1.05225432e+00
  7.89219824e+00  7.89219824e+00  7.89219824e+00  9.66099169e+00
  3.57495707e+01  3.57495707e+01  3.57495707e+01  1.08740034e+02
  1.33033549e+02  1.33033549e+02  1.33033549e+02  4.87094282e+02
  4.87094282e+02  4.87094282e+02  6.09241870e+02  1.33734116e+03
  1.33734116e+03  1.33734116e+03  2.69636521e+03  3.02962118e+03
  3.02962118e+03  3.02962118e+03  6.64861946e+03  6.64861946e+03
  6.64861946e+03  9.10452835e+03  2.54576687e+04  7.61966836e+04]
E1 = -728.3548360491391  E_coul = 201.64915458580748
cycle= 5 E= -526.705681463332  delta_E= -1.18e-10  |g|= 7.72e-06  |ddm|= 2.47e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3548360491391  E_coul = 201.64915458580748
  HOMO = -0.575457955156344  LUMO = 1.0522517166494
  mo_energy =
[-1.18575008e+02 -1.23046216e+01 -9.55746770e+00 -9.55746770e+00
 -9.55746770e+00 -1.24985676e+00 -5.75457955e-01 -5.75457955e-01
 -5.75457955e-01  1.05225172e+00  1.05225172e+00  1.05225172e+00
  7.89218957e+00  7.89218957e+00  7.89218957e+00  9.66098188e+00
  3.57495581e+01  3.57495581e+01  3.57495581e+01  1.08740018e+02
  1.33033534e+02  1.33033534e+02  1.33033534e+02  4.87094265e+02
  4.87094265e+02  4.87094265e+02  6.09241852e+02  1.33734115e+03
  1.33734115e+03  1.33734115e+03  2.69636520e+03  3.02962117e+03
  3.02962117e+03  3.02962117e+03  6.64861944e+03  6.64861944e+03
  6.64861944e+03  9.10452833e+03  2.54576686e+04  7.61966836e+04]
E1 = -728.354874069786  E_coul = 201.64919260645024
Extra cycle  E= -526.705681463336  delta_E= -4.21e-12  |g|= 2.28e-06  |ddm|= 3.97e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.23 sec
exp = [2.61826993e+04 7.61742051e+03 3.61738996e+03 1.59556877e+03
 3.90200309e+02 1.13310404e+02 3.71032055e+01 7.96271700e+00
 3.10511281e+00 3.99203928e-01 1.36279759e+03 6.64606297e+02
 3.00305893e+02 3.13476722e+02 6.17150822e+01 7.78121676e+00
 2.08242779e+01 7.95151676e-01 3.04060367e+00 2.26509837e-01]
E = -526.7056814633357
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:59:54 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6992775        1
[INPUT] 0    0    [1    /1   ]  7617.42051499        1
[INPUT] 0    0    [1    /1   ]  3617.38995541        1
[INPUT] 0    0    [1    /1   ]  1595.56877081        1
[INPUT] 0    0    [1    /1   ]  390.200308635        1
[INPUT] 0    0    [1    /1   ]  113.310403532        1
[INPUT] 0    0    [1    /1   ]  37.1032055394        1
[INPUT] 0    0    [1    /1   ]  7.96271699528        1
[INPUT] 0    0    [1    /1   ]  3.10511281451        1
[INPUT] 0    0    [1    /1   ]  0.399203928305       1
[INPUT] 1    0    [1    /1   ]  1362.79758745        1
[INPUT] 1    0    [1    /1   ]  664.606296521        1
[INPUT] 1    0    [1    /1   ]  300.305892782        1
[INPUT] 1    0    [1    /1   ]  313.4767225          1
[INPUT] 1    0    [1    /1   ]  61.7150822127        1
[INPUT] 1    0    [1    /1   ]  7.78121675982        1
[INPUT] 1    0    [1    /1   ]  20.8242779076        1
[INPUT] 1    0    [1    /1   ]  0.795151675699       1
[INPUT] 1    0    [1    /1   ]  3.04060367282        1
[INPUT] 1    0    [1    /1   ]  0.226509837248       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.699277478474, 1.0]], [0, [7617.420514988128, 1.0]], [0, [3617.389955410321, 1.0]], [0, [1595.568770807467, 1.0]], [0, [390.20030863530445, 1.0]], [0, [113.31040353197028, 1.0]], [0, [37.10320553939828, 1.0]], [0, [7.962716995283152, 1.0]], [0, [3.1051128145109654, 1.0]], [0, [0.39920392830484064, 1.0]], [1, [1362.7975874468236, 1.0]], [1, [664.6062965209175, 1.0]], [1, [300.3058927821487, 1.0]], [1, [313.4767224996942, 1.0]], [1, [61.715082212698896, 1.0]], [1, [7.781216759823345, 1.0]], [1, [20.824277907624925, 1.0]], [1, [0.7951516756985433, 1.0]], [1, [3.0406036728151618, 1.0]], [1, [0.2265098372480474, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.69927748]
bas 1, expnt(s) = [7617.42051499]
bas 2, expnt(s) = [3617.38995541]
bas 3, expnt(s) = [1595.56877081]
bas 4, expnt(s) = [390.20030864]
bas 5, expnt(s) = [113.31040353]
bas 6, expnt(s) = [37.10320554]
bas 7, expnt(s) = [7.962717]
bas 8, expnt(s) = [3.10511281]
bas 9, expnt(s) = [0.39920393]
bas 10, expnt(s) = [1362.79758745]
bas 11, expnt(s) = [664.60629652]
bas 12, expnt(s) = [300.30589278]
bas 13, expnt(s) = [313.4767225]
bas 14, expnt(s) = [61.71508221]
bas 15, expnt(s) = [7.78121676]
bas 16, expnt(s) = [20.82427791]
bas 17, expnt(s) = [0.79515168]
bas 18, expnt(s) = [3.04060367]
bas 19, expnt(s) = [0.22650984]
CPU time:      1381.78
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826993e+04 5.20026934e+03 7.61742051e+03 2.06001780e+03
 3.61738996e+03 1.17845098e+03 1.59556877e+03 6.37825194e+02
 3.90200309e+02 2.21809800e+02 1.13310404e+02 8.77439869e+01
 3.71032055e+01 3.79816300e+01 7.96271700e+00 1.19759779e+01
 3.10511281e+00 5.90980379e+00 3.99203928e-01 1.26885247e+00
 1.36279759e+03 2.41559203e+04 6.64606297e+02 9.84441598e+03
 3.00305893e+02 3.64702895e+03 3.13476722e+02 3.84805273e+03
 6.17150822e+01 5.04630542e+02 7.78121676e+00 3.79134918e+01
 2.08242779e+01 1.29776731e+02 7.95151676e-01 2.19051820e+00
 3.04060367e+00 1.17134320e+01 2.26509837e-01 4.55872325e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982188056503546
cond(S) = 101733.22822723418
E1 = -729.3867805015724  E_coul = 203.12833073251304
init E= -526.258449769059
    CPU time for initialize scf      0.63 sec, wall time      0.05 sec
  HOMO = -0.556634132882408  LUMO = 1.06458907756532
  mo_energy =
[-1.18332965e+02 -1.22075440e+01 -9.45107830e+00 -9.45107830e+00
 -9.45107830e+00 -1.22568338e+00 -5.56634133e-01 -5.56634133e-01
 -5.56634133e-01  1.06458908e+00  1.06458908e+00  1.06458908e+00
  7.95568863e+00  7.95568863e+00  7.95568863e+00  9.72977808e+00
  3.58628615e+01  3.58628615e+01  3.58628615e+01  1.08907377e+02
  1.33205750e+02  1.33205750e+02  1.33205750e+02  4.87335230e+02
  4.87335230e+02  4.87335230e+02  6.09521359e+02  1.33763491e+03
  1.33763491e+03  1.33763491e+03  2.69679070e+03  3.02997909e+03
  3.02997909e+03  3.02997909e+03  6.64908904e+03  6.64908904e+03
  6.64908904e+03  9.10507222e+03  2.54583062e+04  7.61974110e+04]
E1 = -727.9822719285509  E_coul = 201.2772185543664
cycle= 1 E= -526.705053374184  delta_E= -0.447  |g|= 0.184  |ddm|= 0.431
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.541501
diis-c [-0.29322296  1.        ]
  HOMO = -0.581260378543149  LUMO = 1.04768439578938
  mo_energy =
[-1.18626020e+02 -1.23314093e+01 -9.58526915e+00 -9.58526915e+00
 -9.58526915e+00 -1.25728459e+00 -5.81260379e-01 -5.81260379e-01
 -5.81260379e-01  1.04768440e+00  1.04768440e+00  1.04768440e+00
  7.87545348e+00  7.87545348e+00  7.87545348e+00  9.63981332e+00
  3.57207278e+01  3.57207278e+01  3.57207278e+01  1.08698158e+02
  1.32992257e+02  1.32992257e+02  1.32992257e+02  4.87043954e+02
  4.87043954e+02  4.87043954e+02  6.09189441e+02  1.33728754e+03
  1.33728754e+03  1.33728754e+03  2.69630913e+03  3.02956584e+03
  3.02956584e+03  3.02956584e+03  6.64856293e+03  6.64856293e+03
  6.64856293e+03  9.10447132e+03  2.54576113e+04  7.61966262e+04]
E1 = -728.4454056130922  E_coul = 201.73975964672135
cycle= 2 E= -526.705645966371  delta_E= -0.000593  |g|= 0.0334  |ddm|= 0.0392
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.067248
diis-c [-0.00269662  0.07344921  0.92655079]
  HOMO = -0.57454763739583  LUMO = 1.05295546032941
  mo_energy =
[-1.18567441e+02 -1.23006098e+01 -9.55316790e+00 -9.55316790e+00
 -9.55316790e+00 -1.24875771e+00 -5.74547637e-01 -5.74547637e-01
 -5.74547637e-01  1.05295546e+00  1.05295546e+00  1.05295546e+00
  7.89479578e+00  7.89479578e+00  7.89479578e+00  9.66403855e+00
  3.57539774e+01  3.57539774e+01  3.57539774e+01  1.08746206e+02
  1.33039705e+02  1.33039705e+02  1.33039705e+02  4.87101728e+02
  4.87101728e+02  4.87101728e+02  6.09249672e+02  1.33734914e+03
  1.33734914e+03  1.33734914e+03  2.69637378e+03  3.02962952e+03
  3.02962952e+03  3.02962952e+03  6.64862816e+03  6.64862816e+03
  6.64862816e+03  9.10453725e+03  2.54576777e+04  7.61966928e+04]
E1 = -728.3406750562241  E_coul = 201.6349944303979
cycle= 3 E= -526.705680625826  delta_E= -3.47e-05  |g|= 0.00481  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0105229
diis-c [-4.59223877e-07 -1.12472568e-03  1.30666521e-01  8.70458205e-01]
  HOMO = -0.575465955561389  LUMO = 1.05224556428428
  mo_energy =
[-1.18574983e+02 -1.23046365e+01 -9.55746987e+00 -9.55746987e+00
 -9.55746987e+00 -1.24987106e+00 -5.75465956e-01 -5.75465956e-01
 -5.75465956e-01  1.05224556e+00  1.05224556e+00  1.05224556e+00
  7.89217925e+00  7.89217925e+00  7.89217925e+00  9.66095763e+00
  3.57495572e+01  3.57495572e+01  3.57495572e+01  1.08740026e+02
  1.33033545e+02  1.33033545e+02  1.33033545e+02  4.87094289e+02
  4.87094289e+02  4.87094289e+02  6.09241885e+02  1.33734118e+03
  1.33734118e+03  1.33734118e+03  2.69636525e+03  3.02962121e+03
  3.02962121e+03  3.02962121e+03  6.64861950e+03  6.64861950e+03
  6.64861950e+03  9.10452840e+03  2.54576687e+04  7.61966837e+04]
E1 = -728.354830971409  E_coul = 201.64914950819497
cycle= 4 E= -526.705681463214  delta_E= -8.37e-07  |g|= 6.15e-05  |ddm|= 0.00132
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000129394
diis-c [-1.25744714e-09  6.59496396e-05 -9.21089640e-03 -7.26184295e-02
  1.08176338e+00]
  HOMO = -0.575454522389607  LUMO = 1.05225432341342
  mo_energy =
[-1.18574991e+02 -1.23046095e+01 -9.55745500e+00 -9.55745500e+00
 -9.55745500e+00 -1.24985254e+00 -5.75454522e-01 -5.75454522e-01
 -5.75454522e-01  1.05225432e+00  1.05225432e+00  1.05225432e+00
  7.89219824e+00  7.89219824e+00  7.89219824e+00  9.66099169e+00
  3.57495707e+01  3.57495707e+01  3.57495707e+01  1.08740034e+02
  1.33033549e+02  1.33033549e+02  1.33033549e+02  4.87094282e+02
  4.87094282e+02  4.87094282e+02  6.09241870e+02  1.33734116e+03
  1.33734116e+03  1.33734116e+03  2.69636521e+03  3.02962118e+03
  3.02962118e+03  3.02962118e+03  6.64861946e+03  6.64861946e+03
  6.64861946e+03  9.10452835e+03  2.54576687e+04  7.61966836e+04]
E1 = -728.3548360491391  E_coul = 201.64915458580748
cycle= 5 E= -526.705681463332  delta_E= -1.18e-10  |g|= 7.72e-06  |ddm|= 2.47e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3548360491391  E_coul = 201.64915458580748
  HOMO = -0.575457955156344  LUMO = 1.0522517166494
  mo_energy =
[-1.18575008e+02 -1.23046216e+01 -9.55746770e+00 -9.55746770e+00
 -9.55746770e+00 -1.24985676e+00 -5.75457955e-01 -5.75457955e-01
 -5.75457955e-01  1.05225172e+00  1.05225172e+00  1.05225172e+00
  7.89218957e+00  7.89218957e+00  7.89218957e+00  9.66098188e+00
  3.57495581e+01  3.57495581e+01  3.57495581e+01  1.08740018e+02
  1.33033534e+02  1.33033534e+02  1.33033534e+02  4.87094265e+02
  4.87094265e+02  4.87094265e+02  6.09241852e+02  1.33734115e+03
  1.33734115e+03  1.33734115e+03  2.69636520e+03  3.02962117e+03
  3.02962117e+03  3.02962117e+03  6.64861944e+03  6.64861944e+03
  6.64861944e+03  9.10452833e+03  2.54576686e+04  7.61966836e+04]
E1 = -728.354874069786  E_coul = 201.64919260645024
Extra cycle  E= -526.705681463336  delta_E= -4.21e-12  |g|= 2.28e-06  |ddm|= 3.97e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 101733.22822723418
E1 = -728.354874069786  E_coul = 201.64919260645024
init E= -526.705681463336
    CPU time for initialize scf      3.76 sec, wall time      0.20 sec
  HOMO = -0.575457260657174  LUMO = 1.05225225046905
  mo_energy =
[-1.18575003e+02 -1.23046188e+01 -9.55746481e+00 -9.55746481e+00
 -9.55746481e+00 -1.24985590e+00 -5.75457261e-01 -5.75457261e-01
 -5.75457261e-01  1.05225225e+00  1.05225225e+00  1.05225225e+00
  7.89219142e+00  7.89219142e+00  7.89219142e+00  9.66098411e+00
  3.57495610e+01  3.57495610e+01  3.57495610e+01  1.08740022e+02
  1.33033538e+02  1.33033538e+02  1.33033538e+02  4.87094270e+02
  4.87094270e+02  4.87094270e+02  6.09241857e+02  1.33734115e+03
  1.33734115e+03  1.33734115e+03  2.69636520e+03  3.02962117e+03
  3.02962117e+03  3.02962117e+03  6.64861945e+03  6.64861945e+03
  6.64861945e+03  9.10452834e+03  2.54576686e+04  7.61966836e+04]
E1 = -728.3548650388608  E_coul = 201.6491835755252
cycle= 1 E= -526.705681463336  delta_E= 1.14e-13  |g|= 5.85e-07  |ddm|= 9.1e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3548650388608  E_coul = 201.6491835755252
  HOMO = -0.575457414186018  LUMO = 1.05225213171445
  mo_energy =
[-1.18575005e+02 -1.23046195e+01 -9.55746550e+00 -9.55746550e+00
 -9.55746550e+00 -1.24985609e+00 -5.75457414e-01 -5.75457414e-01
 -5.75457414e-01  1.05225213e+00  1.05225213e+00  1.05225213e+00
  7.89219100e+00  7.89219100e+00  7.89219100e+00  9.66098360e+00
  3.57495603e+01  3.57495603e+01  3.57495603e+01  1.08740021e+02
  1.33033537e+02  1.33033537e+02  1.33033537e+02  4.87094268e+02
  4.87094268e+02  4.87094268e+02  6.09241856e+02  1.33734115e+03
  1.33734115e+03  1.33734115e+03  2.69636520e+03  3.02962117e+03
  3.02962117e+03  3.02962117e+03  6.64861944e+03  6.64861944e+03
  6.64861944e+03  9.10452834e+03  2.54576686e+04  7.61966836e+04]
E1 = -728.3548672373568  E_coul = 201.64918577402125
Extra cycle  E= -526.705681463336  delta_E= 1.14e-13  |g|= 1.47e-07  |ddm|= 2.13e-07
    CPU time for scf_cycle      3.87 sec, wall time      0.31 sec
exp = [2.61826993e+04 7.61742051e+03 3.61738996e+03 1.59556877e+03
 3.90200309e+02 1.13310404e+02 3.71032055e+01 7.96271700e+00
 3.10511281e+00 3.99203928e-01 1.36279759e+03 6.64606297e+02
 3.00305893e+02 3.13476722e+02 6.17150822e+01 7.78121676e+00
 2.08242779e+01 7.95151676e-01 3.04060367e+00 2.26509837e-01]
grad_E = [-1.50640656e-06  3.18514770e-06 -1.72698226e-06  6.70890540e-05
 -1.43136686e-04 -2.86649050e-04 -1.28545946e-05  6.07799964e-04
 -1.72404792e-03  7.17624119e-03 -4.68473828e-07  5.54041204e-06
  2.68345205e-05  2.31020057e-05 -2.57541252e-04 -3.64737372e-04
  1.71733301e-04  9.61932784e-03  7.50877011e-03 -3.99106197e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:59:58 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.7205044        1
[INPUT] 0    0    [1    /1   ]  7617.37061795        1
[INPUT] 0    0    [1    /1   ]  3617.40877901        1
[INPUT] 0    0    [1    /1   ]  1594.45193609        1
[INPUT] 0    0    [1    /1   ]  394.154507277        1
[INPUT] 0    0    [1    /1   ]  114.738801674        1
[INPUT] 0    0    [1    /1   ]  37.4678057827        1
[INPUT] 0    0    [1    /1   ]  7.97410170834        1
[INPUT] 0    0    [1    /1   ]  3.11577349067        1
[INPUT] 0    0    [1    /1   ]  0.398886634983       1
[INPUT] 1    0    [1    /1   ]  1362.80461107        1
[INPUT] 1    0    [1    /1   ]  664.538346287        1
[INPUT] 1    0    [1    /1   ]  299.986109403        1
[INPUT] 1    0    [1    /1   ]  313.20107684         1
[INPUT] 1    0    [1    /1   ]  61.7372359968        1
[INPUT] 1    0    [1    /1   ]  7.94702195091        1
[INPUT] 1    0    [1    /1   ]  21.1958340375        1
[INPUT] 1    0    [1    /1   ]  0.800120522978       1
[INPUT] 1    0    [1    /1   ]  3.07197467395        1
[INPUT] 1    0    [1    /1   ]  0.22817082551        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.720504414796, 1.0]], [0, [7617.370617947788, 1.0]], [0, [3617.4087790100994, 1.0]], [0, [1594.4519360944132, 1.0]], [0, [394.1545072771564, 1.0]], [0, [114.73880167383486, 1.0]], [0, [37.4678057826654, 1.0]], [0, [7.97410170834208, 1.0]], [0, [3.1157734906672223, 1.0]], [0, [0.3988866349827757, 1.0]], [1, [1362.8046110683517, 1.0]], [1, [664.5383462873159, 1.0]], [1, [299.98610940329456, 1.0]], [1, [313.20107683995127, 1.0]], [1, [61.737235996788506, 1.0]], [1, [7.947021950909687, 1.0]], [1, [21.19583403747585, 1.0]], [1, [0.8001205229783755, 1.0]], [1, [3.0719746739454354, 1.0]], [1, [0.22817082550996762, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.72050441]
bas 1, expnt(s) = [7617.37061795]
bas 2, expnt(s) = [3617.40877901]
bas 3, expnt(s) = [1594.45193609]
bas 4, expnt(s) = [394.15450728]
bas 5, expnt(s) = [114.73880167]
bas 6, expnt(s) = [37.46780578]
bas 7, expnt(s) = [7.97410171]
bas 8, expnt(s) = [3.11577349]
bas 9, expnt(s) = [0.39888663]
bas 10, expnt(s) = [1362.80461107]
bas 11, expnt(s) = [664.53834629]
bas 12, expnt(s) = [299.9861094]
bas 13, expnt(s) = [313.20107684]
bas 14, expnt(s) = [61.737236]
bas 15, expnt(s) = [7.94702195]
bas 16, expnt(s) = [21.19583404]
bas 17, expnt(s) = [0.80012052]
bas 18, expnt(s) = [3.07197467]
bas 19, expnt(s) = [0.22817083]
CPU time:      1391.22
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61827205e+04 5.20027250e+03 7.61737062e+03 2.06000768e+03
 3.61740878e+03 1.17845558e+03 1.59445194e+03 6.37490326e+02
 3.94154507e+02 2.23493500e+02 1.14738802e+02 8.85722662e+01
 3.74678058e+01 3.82612117e+01 7.97410171e+00 1.19888176e+01
 3.11577349e+00 5.92501471e+00 3.98886635e-01 1.26809602e+00
 1.36280461e+03 2.41560759e+04 6.64538346e+02 9.84315787e+03
 2.99986109e+02 3.64217513e+03 3.13201077e+02 3.84382362e+03
 6.17372360e+01 5.04856986e+02 7.94702195e+00 3.89260117e+01
 2.11958340e+01 1.32677577e+02 8.00120523e-01 2.20764204e+00
 3.07197467e+00 1.18646910e+01 2.28170826e-01 4.60054766e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.981964819644933
cond(S) = 101307.62781107932
E1 = -729.3834344321103  E_coul = 203.12607425884588
init E= -526.257360173264
    CPU time for initialize scf      0.63 sec, wall time      0.05 sec
  HOMO = -0.556617877539127  LUMO = 1.07554365060184
  mo_energy =
[-1.18333608e+02 -1.22076741e+01 -9.45126686e+00 -9.45126686e+00
 -9.45126686e+00 -1.22580866e+00 -5.56617878e-01 -5.56617878e-01
 -5.56617878e-01  1.07554365e+00  1.07554365e+00  1.07554365e+00
  8.08405028e+00  8.08405028e+00  8.08405028e+00  9.78159505e+00
  3.66349763e+01  3.66349763e+01  3.66349763e+01  1.10305400e+02
  1.34922792e+02  1.34922792e+02  1.34922792e+02  4.89027420e+02
  4.89027420e+02  4.89027420e+02  6.17246122e+02  1.33857255e+03
  1.33857255e+03  1.33857255e+03  2.71307086e+03  3.02996606e+03
  3.02996606e+03  3.02996606e+03  6.64838186e+03  6.64838186e+03
  6.64838186e+03  9.12303702e+03  2.54753081e+04  7.62130275e+04]
E1 = -727.9956311889856  E_coul = 201.28997335186557
cycle= 1 E= -526.70565783712  delta_E= -0.448  |g|= 0.183  |ddm|= 0.441
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.54068
diis-c [-0.29233452  1.        ]
  HOMO = -0.580688641849018  LUMO = 1.05886863081486
  mo_energy =
[-1.18625332e+02 -1.23306339e+01 -9.58448490e+00 -9.58448490e+00
 -9.58448490e+00 -1.25673519e+00 -5.80688642e-01 -5.80688642e-01
 -5.80688642e-01  1.05886863e+00  1.05886863e+00  1.05886863e+00
  8.00385123e+00  8.00385123e+00  8.00385123e+00  9.69230537e+00
  3.64927281e+01  3.64927281e+01  3.64927281e+01  1.10096365e+02
  1.34710299e+02  1.34710299e+02  1.34710299e+02  4.88737669e+02
  4.88737669e+02  4.88737669e+02  6.16914576e+02  1.33822677e+03
  1.33822677e+03  1.33822677e+03  2.71259078e+03  3.02955444e+03
  3.02955444e+03  3.02955444e+03  6.64785754e+03  6.64785754e+03
  6.64785754e+03  9.12243810e+03  2.54746153e+04  7.62122447e+04]
E1 = -728.4543541534422  E_coul = 201.74811112396443
cycle= 2 E= -526.706243029478  delta_E= -0.000585  |g|= 0.0332  |ddm|= 0.0389
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0668897
diis-c [-0.00267312  0.07309087  0.92690913]
  HOMO = -0.574056000087055  LUMO = 1.06412848742054
  mo_energy =
[-1.18567170e+02 -1.23001278e+01 -9.55268560e+00 -9.55268560e+00
 -9.55268560e+00 -1.24831116e+00 -5.74056000e-01 -5.74056000e-01
 -5.74056000e-01  1.06412849e+00  1.06412849e+00  1.06412849e+00
  8.02318502e+00  8.02318502e+00  8.02318502e+00  9.71635638e+00
  3.65259227e+01  3.65259227e+01  3.65259227e+01  1.10144200e+02
  1.34757412e+02  1.34757412e+02  1.34757412e+02  4.88795009e+02
  4.88795009e+02  4.88795009e+02  6.16974446e+02  1.33828793e+03
  1.33828793e+03  1.33828793e+03  2.71265500e+03  3.02961768e+03
  3.02961768e+03  3.02961768e+03  6.64792232e+03  6.64792232e+03
  6.64792232e+03  9.12250360e+03  2.54746813e+04  7.62123109e+04]
E1 = -728.3509029767814  E_coul = 201.6446259647539
cycle= 3 E= -526.706277012027  delta_E= -3.4e-05  |g|= 0.00477  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104507
diis-c [-4.52086692e-07 -1.11807866e-03  1.30500485e-01  8.70617594e-01]
  HOMO = -0.574960713803826  LUMO = 1.06342219735208
  mo_energy =
[-1.18574647e+02 -1.23041116e+01 -9.55694229e+00 -9.55694229e+00
 -9.55694229e+00 -1.24940774e+00 -5.74960714e-01 -5.74960714e-01
 -5.74960714e-01  1.06342220e+00  1.06342220e+00  1.06342220e+00
  8.02057444e+00  8.02057444e+00  8.02057444e+00  9.71330338e+00
  3.65215173e+01  3.65215173e+01  3.65215173e+01  1.10138057e+02
  1.34751304e+02  1.34751304e+02  1.34751304e+02  4.88787636e+02
  4.88787636e+02  4.88787636e+02  6.16966716e+02  1.33828004e+03
  1.33828004e+03  1.33828004e+03  2.71264653e+03  3.02960944e+03
  3.02960944e+03  3.02960944e+03  6.64791373e+03  6.64791373e+03
  6.64791373e+03  9.12249481e+03  2.54746723e+04  7.62123018e+04]
E1 = -728.3648706170885  E_coul = 201.6585927866781
cycle= 4 E= -526.70627783041  delta_E= -8.18e-07  |g|= 6.1e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000128243
diis-c [-1.22942870e-09  6.57855279e-05 -9.20543519e-03 -7.26532119e-02
  1.08179286e+00]
  HOMO = -0.574949298866434  LUMO = 1.06343101165567
  mo_energy =
[-1.18574655e+02 -1.23040848e+01 -9.55692746e+00 -9.55692746e+00
 -9.55692746e+00 -1.24938930e+00 -5.74949299e-01 -5.74949299e-01
 -5.74949299e-01  1.06343101e+00  1.06343101e+00  1.06343101e+00
  8.02059337e+00  8.02059337e+00  8.02059337e+00  9.71333729e+00
  3.65215306e+01  3.65215306e+01  3.65215306e+01  1.10138065e+02
  1.34751309e+02  1.34751309e+02  1.34751309e+02  4.88787630e+02
  4.88787630e+02  4.88787630e+02  6.16966701e+02  1.33828002e+03
  1.33828002e+03  1.33828002e+03  2.71264650e+03  3.02960941e+03
  3.02960941e+03  3.02960941e+03  6.64791370e+03  6.64791370e+03
  6.64791370e+03  9.12249477e+03  2.54746722e+04  7.62123018e+04]
E1 = -728.364875854453  E_coul = 201.658598023925
cycle= 5 E= -526.706277830528  delta_E= -1.18e-10  |g|= 7.61e-06  |ddm|= 2.45e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.364875854453  E_coul = 201.658598023925
  HOMO = -0.574952675767026  LUMO = 1.06342842369347
  mo_energy =
[-1.18574672e+02 -1.23040967e+01 -9.55693996e+00 -9.55693996e+00
 -9.55693996e+00 -1.24939345e+00 -5.74952676e-01 -5.74952676e-01
 -5.74952676e-01  1.06342842e+00  1.06342842e+00  1.06342842e+00
  8.02058477e+00  8.02058477e+00  8.02058477e+00  9.71332762e+00
  3.65215181e+01  3.65215181e+01  3.65215181e+01  1.10138050e+02
  1.34751294e+02  1.34751294e+02  1.34751294e+02  4.88787613e+02
  4.88787613e+02  4.88787613e+02  6.16966684e+02  1.33828001e+03
  1.33828001e+03  1.33828001e+03  2.71264648e+03  3.02960939e+03
  3.02960939e+03  3.02960939e+03  6.64791368e+03  6.64791368e+03
  6.64791368e+03  9.12249475e+03  2.54746722e+04  7.62123018e+04]
E1 = -728.3649131139152  E_coul = 201.65863528338417
Extra cycle  E= -526.706277830531  delta_E= -3.07e-12  |g|= 2.24e-06  |ddm|= 3.9e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.22 sec
exp = [2.61827205e+04 7.61737062e+03 3.61740878e+03 1.59445194e+03
 3.94154507e+02 1.14738802e+02 3.74678058e+01 7.97410171e+00
 3.11577349e+00 3.98886635e-01 1.36280461e+03 6.64538346e+02
 2.99986109e+02 3.13201077e+02 6.17372360e+01 7.94702195e+00
 2.11958340e+01 8.00120523e-01 3.07197467e+00 2.28170826e-01]
E = -526.706277830531
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:59:58 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.7205044        1
[INPUT] 0    0    [1    /1   ]  7617.37061795        1
[INPUT] 0    0    [1    /1   ]  3617.40877901        1
[INPUT] 0    0    [1    /1   ]  1594.45193609        1
[INPUT] 0    0    [1    /1   ]  394.154507277        1
[INPUT] 0    0    [1    /1   ]  114.738801674        1
[INPUT] 0    0    [1    /1   ]  37.4678057827        1
[INPUT] 0    0    [1    /1   ]  7.97410170834        1
[INPUT] 0    0    [1    /1   ]  3.11577349067        1
[INPUT] 0    0    [1    /1   ]  0.398886634983       1
[INPUT] 1    0    [1    /1   ]  1362.80461107        1
[INPUT] 1    0    [1    /1   ]  664.538346287        1
[INPUT] 1    0    [1    /1   ]  299.986109403        1
[INPUT] 1    0    [1    /1   ]  313.20107684         1
[INPUT] 1    0    [1    /1   ]  61.7372359968        1
[INPUT] 1    0    [1    /1   ]  7.94702195091        1
[INPUT] 1    0    [1    /1   ]  21.1958340375        1
[INPUT] 1    0    [1    /1   ]  0.800120522978       1
[INPUT] 1    0    [1    /1   ]  3.07197467395        1
[INPUT] 1    0    [1    /1   ]  0.22817082551        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.720504414796, 1.0]], [0, [7617.370617947788, 1.0]], [0, [3617.4087790100994, 1.0]], [0, [1594.4519360944132, 1.0]], [0, [394.1545072771564, 1.0]], [0, [114.73880167383486, 1.0]], [0, [37.4678057826654, 1.0]], [0, [7.97410170834208, 1.0]], [0, [3.1157734906672223, 1.0]], [0, [0.3988866349827757, 1.0]], [1, [1362.8046110683517, 1.0]], [1, [664.5383462873159, 1.0]], [1, [299.98610940329456, 1.0]], [1, [313.20107683995127, 1.0]], [1, [61.737235996788506, 1.0]], [1, [7.947021950909687, 1.0]], [1, [21.19583403747585, 1.0]], [1, [0.8001205229783755, 1.0]], [1, [3.0719746739454354, 1.0]], [1, [0.22817082550996762, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.72050441]
bas 1, expnt(s) = [7617.37061795]
bas 2, expnt(s) = [3617.40877901]
bas 3, expnt(s) = [1594.45193609]
bas 4, expnt(s) = [394.15450728]
bas 5, expnt(s) = [114.73880167]
bas 6, expnt(s) = [37.46780578]
bas 7, expnt(s) = [7.97410171]
bas 8, expnt(s) = [3.11577349]
bas 9, expnt(s) = [0.39888663]
bas 10, expnt(s) = [1362.80461107]
bas 11, expnt(s) = [664.53834629]
bas 12, expnt(s) = [299.9861094]
bas 13, expnt(s) = [313.20107684]
bas 14, expnt(s) = [61.737236]
bas 15, expnt(s) = [7.94702195]
bas 16, expnt(s) = [21.19583404]
bas 17, expnt(s) = [0.80012052]
bas 18, expnt(s) = [3.07197467]
bas 19, expnt(s) = [0.22817083]
CPU time:      1392.24
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61827205e+04 5.20027250e+03 7.61737062e+03 2.06000768e+03
 3.61740878e+03 1.17845558e+03 1.59445194e+03 6.37490326e+02
 3.94154507e+02 2.23493500e+02 1.14738802e+02 8.85722662e+01
 3.74678058e+01 3.82612117e+01 7.97410171e+00 1.19888176e+01
 3.11577349e+00 5.92501471e+00 3.98886635e-01 1.26809602e+00
 1.36280461e+03 2.41560759e+04 6.64538346e+02 9.84315787e+03
 2.99986109e+02 3.64217513e+03 3.13201077e+02 3.84382362e+03
 6.17372360e+01 5.04856986e+02 7.94702195e+00 3.89260117e+01
 2.11958340e+01 1.32677577e+02 8.00120523e-01 2.20764204e+00
 3.07197467e+00 1.18646910e+01 2.28170826e-01 4.60054766e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.981964819644933
cond(S) = 101307.62781107932
E1 = -729.3834344321103  E_coul = 203.12607425884588
init E= -526.257360173264
    CPU time for initialize scf      0.62 sec, wall time      0.05 sec
  HOMO = -0.556617877539127  LUMO = 1.07554365060184
  mo_energy =
[-1.18333608e+02 -1.22076741e+01 -9.45126686e+00 -9.45126686e+00
 -9.45126686e+00 -1.22580866e+00 -5.56617878e-01 -5.56617878e-01
 -5.56617878e-01  1.07554365e+00  1.07554365e+00  1.07554365e+00
  8.08405028e+00  8.08405028e+00  8.08405028e+00  9.78159505e+00
  3.66349763e+01  3.66349763e+01  3.66349763e+01  1.10305400e+02
  1.34922792e+02  1.34922792e+02  1.34922792e+02  4.89027420e+02
  4.89027420e+02  4.89027420e+02  6.17246122e+02  1.33857255e+03
  1.33857255e+03  1.33857255e+03  2.71307086e+03  3.02996606e+03
  3.02996606e+03  3.02996606e+03  6.64838186e+03  6.64838186e+03
  6.64838186e+03  9.12303702e+03  2.54753081e+04  7.62130275e+04]
E1 = -727.9956311889856  E_coul = 201.28997335186557
cycle= 1 E= -526.70565783712  delta_E= -0.448  |g|= 0.183  |ddm|= 0.441
    CPU time for cycle= 1      0.05 sec, wall time      0.02 sec
diis-norm(errvec)=0.54068
diis-c [-0.29233452  1.        ]
  HOMO = -0.580688641849018  LUMO = 1.05886863081486
  mo_energy =
[-1.18625332e+02 -1.23306339e+01 -9.58448490e+00 -9.58448490e+00
 -9.58448490e+00 -1.25673519e+00 -5.80688642e-01 -5.80688642e-01
 -5.80688642e-01  1.05886863e+00  1.05886863e+00  1.05886863e+00
  8.00385123e+00  8.00385123e+00  8.00385123e+00  9.69230537e+00
  3.64927281e+01  3.64927281e+01  3.64927281e+01  1.10096365e+02
  1.34710299e+02  1.34710299e+02  1.34710299e+02  4.88737669e+02
  4.88737669e+02  4.88737669e+02  6.16914576e+02  1.33822677e+03
  1.33822677e+03  1.33822677e+03  2.71259078e+03  3.02955444e+03
  3.02955444e+03  3.02955444e+03  6.64785754e+03  6.64785754e+03
  6.64785754e+03  9.12243810e+03  2.54746153e+04  7.62122447e+04]
E1 = -728.4543541534422  E_coul = 201.74811112396443
cycle= 2 E= -526.706243029478  delta_E= -0.000585  |g|= 0.0332  |ddm|= 0.0389
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0668897
diis-c [-0.00267312  0.07309087  0.92690913]
  HOMO = -0.574056000087055  LUMO = 1.06412848742054
  mo_energy =
[-1.18567170e+02 -1.23001278e+01 -9.55268560e+00 -9.55268560e+00
 -9.55268560e+00 -1.24831116e+00 -5.74056000e-01 -5.74056000e-01
 -5.74056000e-01  1.06412849e+00  1.06412849e+00  1.06412849e+00
  8.02318502e+00  8.02318502e+00  8.02318502e+00  9.71635638e+00
  3.65259227e+01  3.65259227e+01  3.65259227e+01  1.10144200e+02
  1.34757412e+02  1.34757412e+02  1.34757412e+02  4.88795009e+02
  4.88795009e+02  4.88795009e+02  6.16974446e+02  1.33828793e+03
  1.33828793e+03  1.33828793e+03  2.71265500e+03  3.02961768e+03
  3.02961768e+03  3.02961768e+03  6.64792232e+03  6.64792232e+03
  6.64792232e+03  9.12250360e+03  2.54746813e+04  7.62123109e+04]
E1 = -728.3509029767814  E_coul = 201.6446259647539
cycle= 3 E= -526.706277012027  delta_E= -3.4e-05  |g|= 0.00477  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104507
diis-c [-4.52086692e-07 -1.11807866e-03  1.30500485e-01  8.70617594e-01]
  HOMO = -0.574960713803826  LUMO = 1.06342219735208
  mo_energy =
[-1.18574647e+02 -1.23041116e+01 -9.55694229e+00 -9.55694229e+00
 -9.55694229e+00 -1.24940774e+00 -5.74960714e-01 -5.74960714e-01
 -5.74960714e-01  1.06342220e+00  1.06342220e+00  1.06342220e+00
  8.02057444e+00  8.02057444e+00  8.02057444e+00  9.71330338e+00
  3.65215173e+01  3.65215173e+01  3.65215173e+01  1.10138057e+02
  1.34751304e+02  1.34751304e+02  1.34751304e+02  4.88787636e+02
  4.88787636e+02  4.88787636e+02  6.16966716e+02  1.33828004e+03
  1.33828004e+03  1.33828004e+03  2.71264653e+03  3.02960944e+03
  3.02960944e+03  3.02960944e+03  6.64791373e+03  6.64791373e+03
  6.64791373e+03  9.12249481e+03  2.54746723e+04  7.62123018e+04]
E1 = -728.3648706170885  E_coul = 201.6585927866781
cycle= 4 E= -526.70627783041  delta_E= -8.18e-07  |g|= 6.1e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000128243
diis-c [-1.22942870e-09  6.57855279e-05 -9.20543519e-03 -7.26532119e-02
  1.08179286e+00]
  HOMO = -0.574949298866434  LUMO = 1.06343101165567
  mo_energy =
[-1.18574655e+02 -1.23040848e+01 -9.55692746e+00 -9.55692746e+00
 -9.55692746e+00 -1.24938930e+00 -5.74949299e-01 -5.74949299e-01
 -5.74949299e-01  1.06343101e+00  1.06343101e+00  1.06343101e+00
  8.02059337e+00  8.02059337e+00  8.02059337e+00  9.71333729e+00
  3.65215306e+01  3.65215306e+01  3.65215306e+01  1.10138065e+02
  1.34751309e+02  1.34751309e+02  1.34751309e+02  4.88787630e+02
  4.88787630e+02  4.88787630e+02  6.16966701e+02  1.33828002e+03
  1.33828002e+03  1.33828002e+03  2.71264650e+03  3.02960941e+03
  3.02960941e+03  3.02960941e+03  6.64791370e+03  6.64791370e+03
  6.64791370e+03  9.12249477e+03  2.54746722e+04  7.62123018e+04]
E1 = -728.364875854453  E_coul = 201.658598023925
cycle= 5 E= -526.706277830528  delta_E= -1.18e-10  |g|= 7.61e-06  |ddm|= 2.45e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.364875854453  E_coul = 201.658598023925
  HOMO = -0.574952675767026  LUMO = 1.06342842369347
  mo_energy =
[-1.18574672e+02 -1.23040967e+01 -9.55693996e+00 -9.55693996e+00
 -9.55693996e+00 -1.24939345e+00 -5.74952676e-01 -5.74952676e-01
 -5.74952676e-01  1.06342842e+00  1.06342842e+00  1.06342842e+00
  8.02058477e+00  8.02058477e+00  8.02058477e+00  9.71332762e+00
  3.65215181e+01  3.65215181e+01  3.65215181e+01  1.10138050e+02
  1.34751294e+02  1.34751294e+02  1.34751294e+02  4.88787613e+02
  4.88787613e+02  4.88787613e+02  6.16966684e+02  1.33828001e+03
  1.33828001e+03  1.33828001e+03  2.71264648e+03  3.02960939e+03
  3.02960939e+03  3.02960939e+03  6.64791368e+03  6.64791368e+03
  6.64791368e+03  9.12249475e+03  2.54746722e+04  7.62123018e+04]
E1 = -728.3649131139152  E_coul = 201.65863528338417
Extra cycle  E= -526.706277830531  delta_E= -3.07e-12  |g|= 2.24e-06  |ddm|= 3.9e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.22 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 101307.62781107932
E1 = -728.3649131139152  E_coul = 201.65863528338417
init E= -526.706277830531
    CPU time for initialize scf      3.77 sec, wall time      0.20 sec
  HOMO = -0.574951997049545  LUMO = 1.06342895034205
  mo_energy =
[-1.18574667e+02 -1.23040940e+01 -9.55693714e+00 -9.55693714e+00
 -9.55693714e+00 -1.24939260e+00 -5.74951997e-01 -5.74951997e-01
 -5.74951997e-01  1.06342895e+00  1.06342895e+00  1.06342895e+00
  8.02058660e+00  8.02058660e+00  8.02058660e+00  9.71332980e+00
  3.65215210e+01  3.65215210e+01  3.65215210e+01  1.10138053e+02
  1.34751298e+02  1.34751298e+02  1.34751298e+02  4.88787617e+02
  4.88787617e+02  4.88787617e+02  6.16966689e+02  1.33828001e+03
  1.33828001e+03  1.33828001e+03  2.71264649e+03  3.02960940e+03
  3.02960940e+03  3.02960940e+03  6.64791368e+03  6.64791368e+03
  6.64791368e+03  9.12249475e+03  2.54746722e+04  7.62123018e+04]
E1 = -728.3649042937485  E_coul = 201.65862646321708
cycle= 1 E= -526.706277830531  delta_E= -4.55e-13  |g|= 5.73e-07  |ddm|= 8.89e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3649042937485  E_coul = 201.65862646321708
  HOMO = -0.574952146540437  LUMO = 1.06342883358721
  mo_energy =
[-1.18574668e+02 -1.23040946e+01 -9.55693780e+00 -9.55693780e+00
 -9.55693780e+00 -1.24939278e+00 -5.74952147e-01 -5.74952147e-01
 -5.74952147e-01  1.06342883e+00  1.06342883e+00  1.06342883e+00
  8.02058618e+00  8.02058618e+00  8.02058618e+00  9.71332930e+00
  3.65215203e+01  3.65215203e+01  3.65215203e+01  1.10138052e+02
  1.34751297e+02  1.34751297e+02  1.34751297e+02  4.88787616e+02
  4.88787616e+02  4.88787616e+02  6.16966688e+02  1.33828001e+03
  1.33828001e+03  1.33828001e+03  2.71264649e+03  3.02960940e+03
  3.02960940e+03  3.02960940e+03  6.64791368e+03  6.64791368e+03
  6.64791368e+03  9.12249475e+03  2.54746722e+04  7.62123018e+04]
E1 = -728.3649064340804  E_coul = 201.65862860354804
Extra cycle  E= -526.706277830532  delta_E= -9.09e-13  |g|= 1.43e-07  |ddm|= 2.07e-07
    CPU time for scf_cycle      3.88 sec, wall time      0.31 sec
exp = [2.61827205e+04 7.61737062e+03 3.61740878e+03 1.59445194e+03
 3.94154507e+02 1.14738802e+02 3.74678058e+01 7.97410171e+00
 3.11577349e+00 3.98886635e-01 1.36280461e+03 6.64538346e+02
 2.99986109e+02 3.13201077e+02 6.17372360e+01 7.94702195e+00
 2.11958340e+01 8.00120523e-01 3.07197467e+00 2.28170826e-01]
grad_E = [-1.49158534e-06  3.02905452e-06 -1.83656970e-06  6.25238907e-05
 -1.27105277e-04 -1.97772895e-04  3.58134840e-05  3.84023131e-04
 -1.09054305e-03  4.36591805e-03 -4.26963979e-07  6.05971837e-06
  2.99510992e-05  2.57735237e-05 -4.79770925e-04  1.04709093e-03
  6.84669100e-04  5.69971926e-03  4.04622532e-03 -2.27520224e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:00:03 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.7299512        1
[INPUT] 0    0    [1    /1   ]  7617.34847709        1
[INPUT] 0    0    [1    /1   ]  3617.41721345        1
[INPUT] 0    0    [1    /1   ]  1593.95759533        1
[INPUT] 0    0    [1    /1   ]  395.842313245        1
[INPUT] 0    0    [1    /1   ]  115.61257355         1
[INPUT] 0    0    [1    /1   ]  37.7192243077        1
[INPUT] 0    0    [1    /1   ]  7.97660782497        1
[INPUT] 0    0    [1    /1   ]  3.12352890366        1
[INPUT] 0    0    [1    /1   ]  0.398557222093       1
[INPUT] 1    0    [1    /1   ]  1362.80773859        1
[INPUT] 1    0    [1    /1   ]  664.508075291        1
[INPUT] 1    0    [1    /1   ]  299.84364535         1
[INPUT] 1    0    [1    /1   ]  313.078275142        1
[INPUT] 1    0    [1    /1   ]  61.746937514         1
[INPUT] 1    0    [1    /1   ]  7.98632477347        1
[INPUT] 1    0    [1    /1   ]  21.3779707309        1
[INPUT] 1    0    [1    /1   ]  0.799451813207       1
[INPUT] 1    0    [1    /1   ]  3.05660232151        1
[INPUT] 1    0    [1    /1   ]  0.228559783251       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.729951197296, 1.0]], [0, [7617.348477091716, 1.0]], [0, [3617.4172134518194, 1.0]], [0, [1593.9575953304823, 1.0]], [0, [395.84231324478856, 1.0]], [0, [115.61257354994629, 1.0]], [0, [37.7192243076792, 1.0]], [0, [7.9766078249676236, 1.0]], [0, [3.1235289036613363, 1.0]], [0, [0.39855722209348277, 1.0]], [1, [1362.8077385880274, 1.0]], [1, [664.5080752913123, 1.0]], [1, [299.8436453504613, 1.0]], [1, [313.07827514213835, 1.0]], [1, [61.74693751404234, 1.0]], [1, [7.986324773468152, 1.0]], [1, [21.377970730904572, 1.0]], [1, [0.7994518132069567, 1.0]], [1, [3.0566023215127838, 1.0]], [1, [0.22855978325105678, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.7299512]
bas 1, expnt(s) = [7617.34847709]
bas 2, expnt(s) = [3617.41721345]
bas 3, expnt(s) = [1593.95759533]
bas 4, expnt(s) = [395.84231324]
bas 5, expnt(s) = [115.61257355]
bas 6, expnt(s) = [37.71922431]
bas 7, expnt(s) = [7.97660782]
bas 8, expnt(s) = [3.1235289]
bas 9, expnt(s) = [0.39855722]
bas 10, expnt(s) = [1362.80773859]
bas 11, expnt(s) = [664.50807529]
bas 12, expnt(s) = [299.84364535]
bas 13, expnt(s) = [313.07827514]
bas 14, expnt(s) = [61.74693751]
bas 15, expnt(s) = [7.98632477]
bas 16, expnt(s) = [21.37797073]
bas 17, expnt(s) = [0.79945181]
bas 18, expnt(s) = [3.05660232]
bas 19, expnt(s) = [0.22855978]
CPU time:      1401.75
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61827300e+04 5.20027390e+03 7.61734848e+03 2.06000319e+03
 3.61741721e+03 1.17845764e+03 1.59395760e+03 6.37342085e+02
 3.95842313e+02 2.24210882e+02 1.15612574e+02 8.90776653e+01
 3.77192243e+01 3.84536075e+01 7.97660782e+00 1.19916434e+01
 3.12352890e+00 5.93607215e+00 3.98557222e-01 1.26731051e+00
 1.36280774e+03 2.41561452e+04 6.64508075e+02 9.84259740e+03
 2.99843645e+02 3.64001316e+03 3.13078275e+02 3.84193982e+03
 6.17469375e+01 5.04956156e+02 7.98632477e+00 3.91668010e+01
 2.13779707e+01 1.34104234e+02 7.99451813e-01 2.20533595e+00
 3.05660232e+00 1.17905229e+01 2.28559783e-01 4.61035282e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98197293243924
cond(S) = 101101.58617378943
E1 = -729.3801805740046  E_coul = 203.12349433921338
init E= -526.256686234791
    CPU time for initialize scf      0.64 sec, wall time      0.05 sec
  HOMO = -0.55665575392551  LUMO = 1.07628447897623
  mo_energy =
[-1.18334009e+02 -1.22078271e+01 -9.45146655e+00 -9.45146655e+00
 -9.45146655e+00 -1.22592918e+00 -5.56655754e-01 -5.56655754e-01
 -5.56655754e-01  1.07628448e+00  1.07628448e+00  1.07628448e+00
  8.06678302e+00  8.06678302e+00  8.06678302e+00  9.81211705e+00
  3.67938103e+01  3.67938103e+01  3.67938103e+01  1.11205374e+02
  1.35501750e+02  1.35501750e+02  1.35501750e+02  4.89644594e+02
  4.89644594e+02  4.89644594e+02  6.21557451e+02  1.33887431e+03
  1.33887431e+03  1.33887431e+03  2.72129615e+03  3.02985418e+03
  3.02985418e+03  3.02985418e+03  6.64797072e+03  6.64797072e+03
  6.64797072e+03  9.13194971e+03  2.54837477e+04  7.62207934e+04]
E1 = -728.0000889764406  E_coul = 201.29422525624042
cycle= 1 E= -526.7058637202  delta_E= -0.449  |g|= 0.183  |ddm|= 0.447
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.540342
diis-c [-0.29196986  1.        ]
  HOMO = -0.580402313797207  LUMO = 1.05986979823396
  mo_energy =
[-1.18625299e+02 -1.23304302e+01 -9.58426953e+00 -9.58426953e+00
 -9.58426953e+00 -1.25645223e+00 -5.80402314e-01 -5.80402314e-01
 -5.80402314e-01  1.05986980e+00  1.05986980e+00  1.05986980e+00
  7.98710764e+00  7.98710764e+00  7.98710764e+00  9.72311590e+00
  3.66515290e+01  3.66515290e+01  3.66515290e+01  1.10996124e+02
  1.35289524e+02  1.35289524e+02  1.35289524e+02  4.89355359e+02
  4.89355359e+02  4.89355359e+02  6.21225882e+02  1.33852909e+03
  1.33852909e+03  1.33852909e+03  2.72081668e+03  3.02944319e+03
  3.02944319e+03  3.02944319e+03  6.64744712e+03  6.64744712e+03
  6.64744712e+03  9.13135163e+03  2.54830558e+04  7.62200115e+04]
E1 = -728.4570691531908  E_coul = 201.7506230251086
cycle= 2 E= -526.706446128082  delta_E= -0.000582  |g|= 0.0331  |ddm|= 0.0388
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0667298
diis-c [-0.00266404  0.07290076  0.92709924]
  HOMO = -0.573801440559526  LUMO = 1.0651010087513
  mo_energy =
[-1.18567282e+02 -1.23000426e+01 -9.55259074e+00 -9.55259074e+00
 -9.55259074e+00 -1.24807091e+00 -5.73801441e-01 -5.73801441e-01
 -5.73801441e-01  1.06510101e+00  1.06510101e+00  1.06510101e+00
  8.00635219e+00  8.00635219e+00  8.00635219e+00  9.74710890e+00
  3.66846999e+01  3.66846999e+01  3.66846999e+01  1.11043923e+02
  1.35336528e+02  1.35336528e+02  1.35336528e+02  4.89412547e+02
  4.89412547e+02  4.89412547e+02  6.21285637e+02  1.33859010e+03
  1.33859010e+03  1.33859010e+03  2.72088076e+03  3.02950628e+03
  3.02950628e+03  3.02950628e+03  6.64751176e+03  6.64751176e+03
  6.64751176e+03  9.13141698e+03  2.54831216e+04  7.62200776e+04]
E1 = -728.3541396570855  E_coul = 201.64765981862936
cycle= 3 E= -526.706479838456  delta_E= -3.37e-05  |g|= 0.00476  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104183
diis-c [-4.46230675e-07 -1.11351966e-03  1.30433102e-01  8.70680418e-01]
  HOMO = -0.574700259463812  LUMO = 1.06439983495736
  mo_energy =
[-1.18574737e+02 -1.23040105e+01 -9.55683021e+00 -9.55683021e+00
 -9.55683021e+00 -1.24916009e+00 -5.74700259e-01 -5.74700259e-01
 -5.74700259e-01  1.06439983e+00  1.06439983e+00  1.06439983e+00
  8.00375578e+00  8.00375578e+00  8.00375578e+00  9.74406511e+00
  3.66802997e+01  3.66802997e+01  3.66802997e+01  1.11037787e+02
  1.35330437e+02  1.35330437e+02  1.35330437e+02  4.89405198e+02
  4.89405198e+02  4.89405198e+02  6.21277926e+02  1.33858223e+03
  1.33858223e+03  1.33858223e+03  2.72087231e+03  3.02949806e+03
  3.02949806e+03  3.02949806e+03  6.64750319e+03  6.64750319e+03
  6.64750319e+03  9.13140822e+03  2.54831127e+04  7.62200685e+04]
E1 = -728.3680336508901  E_coul = 201.66155300148256
cycle= 4 E= -526.706480649407  delta_E= -8.11e-07  |g|= 6.06e-05  |ddm|= 0.00129
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00012709
diis-c [-1.22190571e-09  6.56756348e-05 -9.19591260e-03 -7.25535329e-02
  1.08168377e+00]
  HOMO = -0.574688769040111  LUMO = 1.06440870476011
  mo_energy =
[-1.18574744e+02 -1.23039836e+01 -9.55681519e+00 -9.55681519e+00
 -9.55681519e+00 -1.24914159e+00 -5.74688769e-01 -5.74688769e-01
 -5.74688769e-01  1.06440870e+00  1.06440870e+00  1.06440870e+00
  8.00377485e+00  8.00377485e+00  8.00377485e+00  9.74409911e+00
  3.66803132e+01  3.66803132e+01  3.66803132e+01  1.11037795e+02
  1.35330442e+02  1.35330442e+02  1.35330442e+02  4.89405191e+02
  4.89405191e+02  4.89405191e+02  6.21277912e+02  1.33858222e+03
  1.33858222e+03  1.33858222e+03  2.72087228e+03  3.02949804e+03
  3.02949804e+03  3.02949804e+03  6.64750316e+03  6.64750316e+03
  6.64750316e+03  9.13140818e+03  2.54831127e+04  7.62200685e+04]
E1 = -728.3680385508166  E_coul = 201.66155790129324
cycle= 5 E= -526.706480649523  delta_E= -1.16e-10  |g|= 7.55e-06  |ddm|= 2.44e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3680385508166  E_coul = 201.66155790129324
  HOMO = -0.574692117735554  LUMO = 1.06440614059616
  mo_energy =
[-1.18574761e+02 -1.23039955e+01 -9.55682759e+00 -9.55682759e+00
 -9.55682759e+00 -1.24914571e+00 -5.74692118e-01 -5.74692118e-01
 -5.74692118e-01  1.06440614e+00  1.06440614e+00  1.06440614e+00
  8.00376633e+00  8.00376633e+00  8.00376633e+00  9.74408950e+00
  3.66803008e+01  3.66803008e+01  3.66803008e+01  1.11037780e+02
  1.35330427e+02  1.35330427e+02  1.35330427e+02  4.89405175e+02
  4.89405175e+02  4.89405175e+02  6.21277895e+02  1.33858220e+03
  1.33858220e+03  1.33858220e+03  2.72087226e+03  3.02949802e+03
  3.02949802e+03  3.02949802e+03  6.64750314e+03  6.64750314e+03
  6.64750314e+03  9.13140816e+03  2.54831126e+04  7.62200685e+04]
E1 = -728.368075425795  E_coul = 201.66159477626883
Extra cycle  E= -526.706480649526  delta_E= -2.84e-12  |g|= 2.22e-06  |ddm|= 3.86e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.22 sec
exp = [2.61827300e+04 7.61734848e+03 3.61741721e+03 1.59395760e+03
 3.95842313e+02 1.15612574e+02 3.77192243e+01 7.97660782e+00
 3.12352890e+00 3.98557222e-01 1.36280774e+03 6.64508075e+02
 2.99843645e+02 3.13078275e+02 6.17469375e+01 7.98632477e+00
 2.13779707e+01 7.99451813e-01 3.05660232e+00 2.28559783e-01]
E = -526.7064806495262
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:00:03 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.7299512        1
[INPUT] 0    0    [1    /1   ]  7617.34847709        1
[INPUT] 0    0    [1    /1   ]  3617.41721345        1
[INPUT] 0    0    [1    /1   ]  1593.95759533        1
[INPUT] 0    0    [1    /1   ]  395.842313245        1
[INPUT] 0    0    [1    /1   ]  115.61257355         1
[INPUT] 0    0    [1    /1   ]  37.7192243077        1
[INPUT] 0    0    [1    /1   ]  7.97660782497        1
[INPUT] 0    0    [1    /1   ]  3.12352890366        1
[INPUT] 0    0    [1    /1   ]  0.398557222093       1
[INPUT] 1    0    [1    /1   ]  1362.80773859        1
[INPUT] 1    0    [1    /1   ]  664.508075291        1
[INPUT] 1    0    [1    /1   ]  299.84364535         1
[INPUT] 1    0    [1    /1   ]  313.078275142        1
[INPUT] 1    0    [1    /1   ]  61.746937514         1
[INPUT] 1    0    [1    /1   ]  7.98632477347        1
[INPUT] 1    0    [1    /1   ]  21.3779707309        1
[INPUT] 1    0    [1    /1   ]  0.799451813207       1
[INPUT] 1    0    [1    /1   ]  3.05660232151        1
[INPUT] 1    0    [1    /1   ]  0.228559783251       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.729951197296, 1.0]], [0, [7617.348477091716, 1.0]], [0, [3617.4172134518194, 1.0]], [0, [1593.9575953304823, 1.0]], [0, [395.84231324478856, 1.0]], [0, [115.61257354994629, 1.0]], [0, [37.7192243076792, 1.0]], [0, [7.9766078249676236, 1.0]], [0, [3.1235289036613363, 1.0]], [0, [0.39855722209348277, 1.0]], [1, [1362.8077385880274, 1.0]], [1, [664.5080752913123, 1.0]], [1, [299.8436453504613, 1.0]], [1, [313.07827514213835, 1.0]], [1, [61.74693751404234, 1.0]], [1, [7.986324773468152, 1.0]], [1, [21.377970730904572, 1.0]], [1, [0.7994518132069567, 1.0]], [1, [3.0566023215127838, 1.0]], [1, [0.22855978325105678, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.7299512]
bas 1, expnt(s) = [7617.34847709]
bas 2, expnt(s) = [3617.41721345]
bas 3, expnt(s) = [1593.95759533]
bas 4, expnt(s) = [395.84231324]
bas 5, expnt(s) = [115.61257355]
bas 6, expnt(s) = [37.71922431]
bas 7, expnt(s) = [7.97660782]
bas 8, expnt(s) = [3.1235289]
bas 9, expnt(s) = [0.39855722]
bas 10, expnt(s) = [1362.80773859]
bas 11, expnt(s) = [664.50807529]
bas 12, expnt(s) = [299.84364535]
bas 13, expnt(s) = [313.07827514]
bas 14, expnt(s) = [61.74693751]
bas 15, expnt(s) = [7.98632477]
bas 16, expnt(s) = [21.37797073]
bas 17, expnt(s) = [0.79945181]
bas 18, expnt(s) = [3.05660232]
bas 19, expnt(s) = [0.22855978]
CPU time:      1402.78
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61827300e+04 5.20027390e+03 7.61734848e+03 2.06000319e+03
 3.61741721e+03 1.17845764e+03 1.59395760e+03 6.37342085e+02
 3.95842313e+02 2.24210882e+02 1.15612574e+02 8.90776653e+01
 3.77192243e+01 3.84536075e+01 7.97660782e+00 1.19916434e+01
 3.12352890e+00 5.93607215e+00 3.98557222e-01 1.26731051e+00
 1.36280774e+03 2.41561452e+04 6.64508075e+02 9.84259740e+03
 2.99843645e+02 3.64001316e+03 3.13078275e+02 3.84193982e+03
 6.17469375e+01 5.04956156e+02 7.98632477e+00 3.91668010e+01
 2.13779707e+01 1.34104234e+02 7.99451813e-01 2.20533595e+00
 3.05660232e+00 1.17905229e+01 2.28559783e-01 4.61035282e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98197293243924
cond(S) = 101101.58617378943
E1 = -729.3801805740046  E_coul = 203.12349433921338
init E= -526.256686234791
    CPU time for initialize scf      0.62 sec, wall time      0.05 sec
  HOMO = -0.55665575392551  LUMO = 1.07628447897623
  mo_energy =
[-1.18334009e+02 -1.22078271e+01 -9.45146655e+00 -9.45146655e+00
 -9.45146655e+00 -1.22592918e+00 -5.56655754e-01 -5.56655754e-01
 -5.56655754e-01  1.07628448e+00  1.07628448e+00  1.07628448e+00
  8.06678302e+00  8.06678302e+00  8.06678302e+00  9.81211705e+00
  3.67938103e+01  3.67938103e+01  3.67938103e+01  1.11205374e+02
  1.35501750e+02  1.35501750e+02  1.35501750e+02  4.89644594e+02
  4.89644594e+02  4.89644594e+02  6.21557451e+02  1.33887431e+03
  1.33887431e+03  1.33887431e+03  2.72129615e+03  3.02985418e+03
  3.02985418e+03  3.02985418e+03  6.64797072e+03  6.64797072e+03
  6.64797072e+03  9.13194971e+03  2.54837477e+04  7.62207934e+04]
E1 = -728.0000889764406  E_coul = 201.29422525624042
cycle= 1 E= -526.7058637202  delta_E= -0.449  |g|= 0.183  |ddm|= 0.447
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.540342
diis-c [-0.29196986  1.        ]
  HOMO = -0.580402313797207  LUMO = 1.05986979823396
  mo_energy =
[-1.18625299e+02 -1.23304302e+01 -9.58426953e+00 -9.58426953e+00
 -9.58426953e+00 -1.25645223e+00 -5.80402314e-01 -5.80402314e-01
 -5.80402314e-01  1.05986980e+00  1.05986980e+00  1.05986980e+00
  7.98710764e+00  7.98710764e+00  7.98710764e+00  9.72311590e+00
  3.66515290e+01  3.66515290e+01  3.66515290e+01  1.10996124e+02
  1.35289524e+02  1.35289524e+02  1.35289524e+02  4.89355359e+02
  4.89355359e+02  4.89355359e+02  6.21225882e+02  1.33852909e+03
  1.33852909e+03  1.33852909e+03  2.72081668e+03  3.02944319e+03
  3.02944319e+03  3.02944319e+03  6.64744712e+03  6.64744712e+03
  6.64744712e+03  9.13135163e+03  2.54830558e+04  7.62200115e+04]
E1 = -728.4570691531908  E_coul = 201.7506230251086
cycle= 2 E= -526.706446128082  delta_E= -0.000582  |g|= 0.0331  |ddm|= 0.0388
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0667298
diis-c [-0.00266404  0.07290076  0.92709924]
  HOMO = -0.573801440559526  LUMO = 1.0651010087513
  mo_energy =
[-1.18567282e+02 -1.23000426e+01 -9.55259074e+00 -9.55259074e+00
 -9.55259074e+00 -1.24807091e+00 -5.73801441e-01 -5.73801441e-01
 -5.73801441e-01  1.06510101e+00  1.06510101e+00  1.06510101e+00
  8.00635219e+00  8.00635219e+00  8.00635219e+00  9.74710890e+00
  3.66846999e+01  3.66846999e+01  3.66846999e+01  1.11043923e+02
  1.35336528e+02  1.35336528e+02  1.35336528e+02  4.89412547e+02
  4.89412547e+02  4.89412547e+02  6.21285637e+02  1.33859010e+03
  1.33859010e+03  1.33859010e+03  2.72088076e+03  3.02950628e+03
  3.02950628e+03  3.02950628e+03  6.64751176e+03  6.64751176e+03
  6.64751176e+03  9.13141698e+03  2.54831216e+04  7.62200776e+04]
E1 = -728.3541396570855  E_coul = 201.64765981862936
cycle= 3 E= -526.706479838456  delta_E= -3.37e-05  |g|= 0.00476  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104183
diis-c [-4.46230675e-07 -1.11351966e-03  1.30433102e-01  8.70680418e-01]
  HOMO = -0.574700259463812  LUMO = 1.06439983495736
  mo_energy =
[-1.18574737e+02 -1.23040105e+01 -9.55683021e+00 -9.55683021e+00
 -9.55683021e+00 -1.24916009e+00 -5.74700259e-01 -5.74700259e-01
 -5.74700259e-01  1.06439983e+00  1.06439983e+00  1.06439983e+00
  8.00375578e+00  8.00375578e+00  8.00375578e+00  9.74406511e+00
  3.66802997e+01  3.66802997e+01  3.66802997e+01  1.11037787e+02
  1.35330437e+02  1.35330437e+02  1.35330437e+02  4.89405198e+02
  4.89405198e+02  4.89405198e+02  6.21277926e+02  1.33858223e+03
  1.33858223e+03  1.33858223e+03  2.72087231e+03  3.02949806e+03
  3.02949806e+03  3.02949806e+03  6.64750319e+03  6.64750319e+03
  6.64750319e+03  9.13140822e+03  2.54831127e+04  7.62200685e+04]
E1 = -728.3680336508901  E_coul = 201.66155300148256
cycle= 4 E= -526.706480649407  delta_E= -8.11e-07  |g|= 6.06e-05  |ddm|= 0.00129
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00012709
diis-c [-1.22190571e-09  6.56756348e-05 -9.19591260e-03 -7.25535329e-02
  1.08168377e+00]
  HOMO = -0.574688769040111  LUMO = 1.06440870476011
  mo_energy =
[-1.18574744e+02 -1.23039836e+01 -9.55681519e+00 -9.55681519e+00
 -9.55681519e+00 -1.24914159e+00 -5.74688769e-01 -5.74688769e-01
 -5.74688769e-01  1.06440870e+00  1.06440870e+00  1.06440870e+00
  8.00377485e+00  8.00377485e+00  8.00377485e+00  9.74409911e+00
  3.66803132e+01  3.66803132e+01  3.66803132e+01  1.11037795e+02
  1.35330442e+02  1.35330442e+02  1.35330442e+02  4.89405191e+02
  4.89405191e+02  4.89405191e+02  6.21277912e+02  1.33858222e+03
  1.33858222e+03  1.33858222e+03  2.72087228e+03  3.02949804e+03
  3.02949804e+03  3.02949804e+03  6.64750316e+03  6.64750316e+03
  6.64750316e+03  9.13140818e+03  2.54831127e+04  7.62200685e+04]
E1 = -728.3680385508166  E_coul = 201.66155790129324
cycle= 5 E= -526.706480649523  delta_E= -1.16e-10  |g|= 7.55e-06  |ddm|= 2.44e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3680385508166  E_coul = 201.66155790129324
  HOMO = -0.574692117735554  LUMO = 1.06440614059616
  mo_energy =
[-1.18574761e+02 -1.23039955e+01 -9.55682759e+00 -9.55682759e+00
 -9.55682759e+00 -1.24914571e+00 -5.74692118e-01 -5.74692118e-01
 -5.74692118e-01  1.06440614e+00  1.06440614e+00  1.06440614e+00
  8.00376633e+00  8.00376633e+00  8.00376633e+00  9.74408950e+00
  3.66803008e+01  3.66803008e+01  3.66803008e+01  1.11037780e+02
  1.35330427e+02  1.35330427e+02  1.35330427e+02  4.89405175e+02
  4.89405175e+02  4.89405175e+02  6.21277895e+02  1.33858220e+03
  1.33858220e+03  1.33858220e+03  2.72087226e+03  3.02949802e+03
  3.02949802e+03  3.02949802e+03  6.64750314e+03  6.64750314e+03
  6.64750314e+03  9.13140816e+03  2.54831126e+04  7.62200685e+04]
E1 = -728.368075425795  E_coul = 201.66159477626883
Extra cycle  E= -526.706480649526  delta_E= -2.84e-12  |g|= 2.22e-06  |ddm|= 3.86e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.22 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 101101.58617378943
E1 = -728.368075425795  E_coul = 201.66159477626883
init E= -526.706480649526
    CPU time for initialize scf      3.78 sec, wall time      0.20 sec
  HOMO = -0.574691446893917  LUMO = 1.06440666074635
  mo_energy =
[-1.18574757e+02 -1.23039928e+01 -9.55682479e+00 -9.55682479e+00
 -9.55682479e+00 -1.24914487e+00 -5.74691447e-01 -5.74691447e-01
 -5.74691447e-01  1.06440666e+00  1.06440666e+00  1.06440666e+00
  8.00376814e+00  8.00376814e+00  8.00376814e+00  9.74409167e+00
  3.66803036e+01  3.66803036e+01  3.66803036e+01  1.11037784e+02
  1.35330431e+02  1.35330431e+02  1.35330431e+02  4.89405179e+02
  4.89405179e+02  4.89405179e+02  6.21277899e+02  1.33858220e+03
  1.33858220e+03  1.33858220e+03  2.72087227e+03  3.02949803e+03
  3.02949803e+03  3.02949803e+03  6.64750314e+03  6.64750314e+03
  6.64750314e+03  9.13140816e+03  2.54831126e+04  7.62200685e+04]
E1 = -728.3680667118354  E_coul = 201.66158606230874
cycle= 1 E= -526.706480649527  delta_E= -4.55e-13  |g|= 5.67e-07  |ddm|= 8.79e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3680667118354  E_coul = 201.66158606230874
  HOMO = -0.574691594346899  LUMO = 1.064406545666
  mo_energy =
[-1.18574758e+02 -1.23039934e+01 -9.55682545e+00 -9.55682545e+00
 -9.55682545e+00 -1.24914505e+00 -5.74691594e-01 -5.74691594e-01
 -5.74691594e-01  1.06440655e+00  1.06440655e+00  1.06440655e+00
  8.00376772e+00  8.00376772e+00  8.00376772e+00  9.74409117e+00
  3.66803030e+01  3.66803030e+01  3.66803030e+01  1.11037783e+02
  1.35330430e+02  1.35330430e+02  1.35330430e+02  4.89405178e+02
  4.89405178e+02  4.89405178e+02  6.21277898e+02  1.33858220e+03
  1.33858220e+03  1.33858220e+03  2.72087227e+03  3.02949802e+03
  3.02949802e+03  3.02949802e+03  6.64750314e+03  6.64750314e+03
  6.64750314e+03  9.13140816e+03  2.54831126e+04  7.62200685e+04]
E1 = -728.3680688232703  E_coul = 201.66158817374347
Extra cycle  E= -526.706480649527  delta_E= -2.27e-13  |g|= 1.41e-07  |ddm|= 2.04e-07
    CPU time for scf_cycle      3.89 sec, wall time      0.31 sec
exp = [2.61827300e+04 7.61734848e+03 3.61741721e+03 1.59395760e+03
 3.95842313e+02 1.15612574e+02 3.77192243e+01 7.97660782e+00
 3.12352890e+00 3.98557222e-01 1.36280774e+03 6.64508075e+02
 2.99843645e+02 3.13078275e+02 6.17469375e+01 7.98632477e+00
 2.13779707e+01 7.99451813e-01 3.05660232e+00 2.28559783e-01]
grad_E = [-1.48812570e-06  2.99328303e-06 -1.86800168e-06  6.17196483e-05
 -1.44920937e-04 -7.34852905e-05  5.50854148e-05  1.06872181e-04
 -2.93356539e-04  1.11887489e-03 -3.98972848e-07  6.39028613e-06
  3.19373521e-05  2.74804245e-05 -6.19968910e-04  1.91097595e-03
  1.14039674e-03  1.04840390e-03  2.75051721e-04 -5.19275151e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:00:08 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.7300245        1
[INPUT] 0    0    [1    /1   ]  7617.34834688        1
[INPUT] 0    0    [1    /1   ]  3617.41731553        1
[INPUT] 0    0    [1    /1   ]  1593.95547578        1
[INPUT] 0    0    [1    /1   ]  395.809661382        1
[INPUT] 0    0    [1    /1   ]  115.771275399        1
[INPUT] 0    0    [1    /1   ]  37.7742046992        1
[INPUT] 0    0    [1    /1   ]  7.97397802338        1
[INPUT] 0    0    [1    /1   ]  3.12477180748        1
[INPUT] 0    0    [1    /1   ]  0.398458487423       1
[INPUT] 1    0    [1    /1   ]  1362.80776389        1
[INPUT] 1    0    [1    /1   ]  664.507819573        1
[INPUT] 1    0    [1    /1   ]  299.842437398        1
[INPUT] 1    0    [1    /1   ]  313.077233265        1
[INPUT] 1    0    [1    /1   ]  61.7475191022        1
[INPUT] 1    0    [1    /1   ]  7.96403680133        1
[INPUT] 1    0    [1    /1   ]  21.3880171633        1
[INPUT] 1    0    [1    /1   ]  0.798265619325       1
[INPUT] 1    0    [1    /1   ]  3.04241197063        1
[INPUT] 1    0    [1    /1   ]  0.22847611709        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.73002452278, 1.0]], [0, [7617.34834688121, 1.0]], [0, [3617.4173155306494, 1.0]], [0, [1593.9554757784374, 1.0]], [0, [395.8096613820411, 1.0]], [0, [115.77127539866973, 1.0]], [0, [37.77420469921436, 1.0]], [0, [7.973978023382221, 1.0]], [0, [3.1247718074820385, 1.0]], [0, [0.39845848742325, 1.0]], [1, [1362.8077638864197, 1.0]], [1, [664.507819572544, 1.0]], [1, [299.84243739821807, 1.0]], [1, [313.077233265314, 1.0]], [1, [61.74751910220931, 1.0]], [1, [7.964036801325222, 1.0]], [1, [21.38801716328264, 1.0]], [1, [0.7982656193249752, 1.0]], [1, [3.042411970630475, 1.0]], [1, [0.22847611708993903, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.73002452]
bas 1, expnt(s) = [7617.34834688]
bas 2, expnt(s) = [3617.41731553]
bas 3, expnt(s) = [1593.95547578]
bas 4, expnt(s) = [395.80966138]
bas 5, expnt(s) = [115.7712754]
bas 6, expnt(s) = [37.7742047]
bas 7, expnt(s) = [7.97397802]
bas 8, expnt(s) = [3.12477181]
bas 9, expnt(s) = [0.39845849]
bas 10, expnt(s) = [1362.80776389]
bas 11, expnt(s) = [664.50781957]
bas 12, expnt(s) = [299.8424374]
bas 13, expnt(s) = [313.07723327]
bas 14, expnt(s) = [61.7475191]
bas 15, expnt(s) = [7.9640368]
bas 16, expnt(s) = [21.38801716]
bas 17, expnt(s) = [0.79826562]
bas 18, expnt(s) = [3.04241197]
bas 19, expnt(s) = [0.22847612]
CPU time:      1412.63
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61827300e+04 5.20027392e+03 7.61734835e+03 2.06000316e+03
 3.61741732e+03 1.17845766e+03 1.59395548e+03 6.37341450e+02
 3.95809661e+02 2.24197011e+02 1.15771275e+02 8.91693575e+01
 3.77742047e+01 3.84956380e+01 7.97397802e+00 1.19886781e+01
 3.12477181e+00 5.93784361e+00 3.98458487e-01 1.26707504e+00
 1.36280776e+03 2.41561458e+04 6.64507820e+02 9.84259267e+03
 2.99842437e+02 3.63999483e+03 3.13077233e+02 3.84192384e+03
 6.17475191e+01 5.04962101e+02 7.96403680e+00 3.90302169e+01
 2.13880172e+01 1.34183015e+02 7.98265619e-01 2.20124648e+00
 3.04241197e+00 1.17221404e+01 2.28476117e-01 4.60824334e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98201492741884
cond(S) = 101088.49638080552
E1 = -729.3793420559905  E_coul = 203.12276072191582
init E= -526.256581334075
    CPU time for initialize scf      0.70 sec, wall time      0.05 sec
  HOMO = -0.556681378611104  LUMO = 1.0748174894267
  mo_energy =
[-1.18334073e+02 -1.22078742e+01 -9.45152044e+00 -9.45152044e+00
 -9.45152044e+00 -1.22595773e+00 -5.56681379e-01 -5.56681379e-01
 -5.56681379e-01  1.07481749e+00  1.07481749e+00  1.07481749e+00
  8.03003705e+00  8.03003705e+00  8.03003705e+00  9.81398814e+00
  3.66932700e+01  3.66932700e+01  3.66932700e+01  1.11373620e+02
  1.35400138e+02  1.35400138e+02  1.35400138e+02  4.89568897e+02
  4.89568897e+02  4.89568897e+02  6.22128715e+02  1.33880765e+03
  1.33880765e+03  1.33880765e+03  2.72197469e+03  3.02978986e+03
  3.02978986e+03  3.02978986e+03  6.64790975e+03  6.64790975e+03
  6.64790975e+03  9.13258817e+03  2.54843512e+04  7.62213551e+04]
E1 = -728.0008641033118  E_coul = 201.29497352372934
cycle= 1 E= -526.705890579582  delta_E= -0.449  |g|= 0.183  |ddm|= 0.451
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.540349
diis-c [-0.29197746  1.        ]
  HOMO = -0.580364937589763  LUMO = 1.05849056752093
  mo_energy =
[-1.18625294e+02 -1.23303854e+01 -9.58422210e+00 -9.58422210e+00
 -9.58422210e+00 -1.25639547e+00 -5.80364938e-01 -5.80364938e-01
 -5.80364938e-01  1.05849057e+00  1.05849057e+00  1.05849057e+00
  7.95070438e+00  7.95070438e+00  7.95070438e+00  9.72509185e+00
  3.65511135e+01  3.65511135e+01  3.65511135e+01  1.11164314e+02
  1.35187957e+02  1.35187957e+02  1.35187957e+02  4.89279725e+02
  4.89279725e+02  4.89279725e+02  6.21797189e+02  1.33846251e+03
  1.33846251e+03  1.33846251e+03  2.72149537e+03  3.02937897e+03
  3.02937897e+03  3.02937897e+03  6.64738628e+03  6.64738628e+03
  6.64738628e+03  9.13199024e+03  2.54836595e+04  7.62205734e+04]
E1 = -728.4576526796485  E_coul = 201.7511799234478
cycle= 2 E= -526.706472756201  delta_E= -0.000582  |g|= 0.0331  |ddm|= 0.0387
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0667036
diis-c [-0.00266316  0.07285034  0.92714966]
  HOMO = -0.573768231358725  LUMO = 1.06370797180707
  mo_energy =
[-1.18567285e+02 -1.23000105e+01 -9.55255599e+00 -9.55255599e+00
 -9.55255599e+00 -1.24802015e+00 -5.73768231e-01 -5.73768231e-01
 -5.73768231e-01  1.06370797e+00  1.06370797e+00  1.06370797e+00
  7.96989061e+00  7.96989061e+00  7.96989061e+00  9.74907833e+00
  3.65842638e+01  3.65842638e+01  3.65842638e+01  1.11212123e+02
  1.35234957e+02  1.35234957e+02  1.35234957e+02  4.89336906e+02
  4.89336906e+02  4.89336906e+02  6.21856940e+02  1.33852351e+03
  1.33852351e+03  1.33852351e+03  2.72155943e+03  3.02944206e+03
  3.02944206e+03  3.02944206e+03  6.64745091e+03  6.64745091e+03
  6.64745091e+03  9.13205558e+03  2.54837253e+04  7.62206395e+04]
E1 = -728.3547664143515  E_coul = 201.64825997428068
cycle= 3 E= -526.706506440071  delta_E= -3.37e-05  |g|= 0.00476  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104158
diis-c [-4.45960443e-07 -1.11288363e-03  1.30453483e-01  8.70659401e-01]
  HOMO = -0.574666734634077  LUMO = 1.06300849830595
  mo_energy =
[-1.18574741e+02 -1.23039784e+01 -9.55679533e+00 -9.55679533e+00
 -9.55679533e+00 -1.24910884e+00 -5.74666735e-01 -5.74666735e-01
 -5.74666735e-01  1.06300850e+00  1.06300850e+00  1.06300850e+00
  7.96730120e+00  7.96730120e+00  7.96730120e+00  9.74603443e+00
  3.65798647e+01  3.65798647e+01  3.65798647e+01  1.11205984e+02
  1.35228865e+02  1.35228865e+02  1.35228865e+02  4.89329556e+02
  4.89329556e+02  4.89329556e+02  6.21849227e+02  1.33851564e+03
  1.33851564e+03  1.33851564e+03  2.72155099e+03  3.02943384e+03
  3.02943384e+03  3.02943384e+03  6.64744235e+03  6.64744235e+03
  6.64744235e+03  9.13204682e+03  2.54837163e+04  7.62206304e+04]
E1 = -728.3686600779566  E_coul = 201.66215282703376
cycle= 4 E= -526.706507250923  delta_E= -8.11e-07  |g|= 6.06e-05  |ddm|= 0.00129
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000126767
diis-c [-1.22926043e-09  6.56612399e-05 -9.19324262e-03 -7.24895684e-02
  1.08161715e+00]
  HOMO = -0.574655158302795  LUMO = 1.06301742115088
  mo_energy =
[-1.18574748e+02 -1.23039513e+01 -9.55678006e+00 -9.55678006e+00
 -9.55678006e+00 -1.24909023e+00 -5.74655158e-01 -5.74655158e-01
 -5.74655158e-01  1.06301742e+00  1.06301742e+00  1.06301742e+00
  7.96732046e+00  7.96732046e+00  7.96732046e+00  9.74606865e+00
  3.65798785e+01  3.65798785e+01  3.65798785e+01  1.11205992e+02
  1.35228870e+02  1.35228870e+02  1.35228870e+02  4.89329550e+02
  4.89329550e+02  4.89329550e+02  6.21849213e+02  1.33851563e+03
  1.33851563e+03  1.33851563e+03  2.72155096e+03  3.02943382e+03
  3.02943382e+03  3.02943382e+03  6.64744231e+03  6.64744231e+03
  6.64744231e+03  9.13204678e+03  2.54837163e+04  7.62206304e+04]
E1 = -728.3686644183796  E_coul = 201.66215716734058
cycle= 5 E= -526.706507251039  delta_E= -1.16e-10  |g|= 7.56e-06  |ddm|= 2.44e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3686644183796  E_coul = 201.66215716734058
  HOMO = -0.574658512811645  LUMO = 1.06301485767605
  mo_energy =
[-1.18574765e+02 -1.23039632e+01 -9.55679249e+00 -9.55679249e+00
 -9.55679249e+00 -1.24909436e+00 -5.74658513e-01 -5.74658513e-01
 -5.74658513e-01  1.06301486e+00  1.06301486e+00  1.06301486e+00
  7.96731194e+00  7.96731194e+00  7.96731194e+00  9.74605903e+00
  3.65798661e+01  3.65798661e+01  3.65798661e+01  1.11205977e+02
  1.35228855e+02  1.35228855e+02  1.35228855e+02  4.89329533e+02
  4.89329533e+02  4.89329533e+02  6.21849196e+02  1.33851561e+03
  1.33851561e+03  1.33851561e+03  2.72155094e+03  3.02943380e+03
  3.02943380e+03  3.02943380e+03  6.64744229e+03  6.64744229e+03
  6.64744229e+03  9.13204676e+03  2.54837163e+04  7.62206303e+04]
E1 = -728.3687013573833  E_coul = 201.6621941063412
Extra cycle  E= -526.706507251042  delta_E= -3.07e-12  |g|= 2.22e-06  |ddm|= 3.86e-06
    CPU time for scf_cycle      0.88 sec, wall time      0.23 sec
exp = [2.61827300e+04 7.61734835e+03 3.61741732e+03 1.59395548e+03
 3.95809661e+02 1.15771275e+02 3.77742047e+01 7.97397802e+00
 3.12477181e+00 3.98458487e-01 1.36280776e+03 6.64507820e+02
 2.99842437e+02 3.13077233e+02 6.17475191e+01 7.96403680e+00
 2.13880172e+01 7.98265619e-01 3.04241197e+00 2.28476117e-01]
E = -526.7065072510421
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:00:08 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.7300245        1
[INPUT] 0    0    [1    /1   ]  7617.34834688        1
[INPUT] 0    0    [1    /1   ]  3617.41731553        1
[INPUT] 0    0    [1    /1   ]  1593.95547578        1
[INPUT] 0    0    [1    /1   ]  395.809661382        1
[INPUT] 0    0    [1    /1   ]  115.771275399        1
[INPUT] 0    0    [1    /1   ]  37.7742046992        1
[INPUT] 0    0    [1    /1   ]  7.97397802338        1
[INPUT] 0    0    [1    /1   ]  3.12477180748        1
[INPUT] 0    0    [1    /1   ]  0.398458487423       1
[INPUT] 1    0    [1    /1   ]  1362.80776389        1
[INPUT] 1    0    [1    /1   ]  664.507819573        1
[INPUT] 1    0    [1    /1   ]  299.842437398        1
[INPUT] 1    0    [1    /1   ]  313.077233265        1
[INPUT] 1    0    [1    /1   ]  61.7475191022        1
[INPUT] 1    0    [1    /1   ]  7.96403680133        1
[INPUT] 1    0    [1    /1   ]  21.3880171633        1
[INPUT] 1    0    [1    /1   ]  0.798265619325       1
[INPUT] 1    0    [1    /1   ]  3.04241197063        1
[INPUT] 1    0    [1    /1   ]  0.22847611709        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.73002452278, 1.0]], [0, [7617.34834688121, 1.0]], [0, [3617.4173155306494, 1.0]], [0, [1593.9554757784374, 1.0]], [0, [395.8096613820411, 1.0]], [0, [115.77127539866973, 1.0]], [0, [37.77420469921436, 1.0]], [0, [7.973978023382221, 1.0]], [0, [3.1247718074820385, 1.0]], [0, [0.39845848742325, 1.0]], [1, [1362.8077638864197, 1.0]], [1, [664.507819572544, 1.0]], [1, [299.84243739821807, 1.0]], [1, [313.077233265314, 1.0]], [1, [61.74751910220931, 1.0]], [1, [7.964036801325222, 1.0]], [1, [21.38801716328264, 1.0]], [1, [0.7982656193249752, 1.0]], [1, [3.042411970630475, 1.0]], [1, [0.22847611708993903, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.73002452]
bas 1, expnt(s) = [7617.34834688]
bas 2, expnt(s) = [3617.41731553]
bas 3, expnt(s) = [1593.95547578]
bas 4, expnt(s) = [395.80966138]
bas 5, expnt(s) = [115.7712754]
bas 6, expnt(s) = [37.7742047]
bas 7, expnt(s) = [7.97397802]
bas 8, expnt(s) = [3.12477181]
bas 9, expnt(s) = [0.39845849]
bas 10, expnt(s) = [1362.80776389]
bas 11, expnt(s) = [664.50781957]
bas 12, expnt(s) = [299.8424374]
bas 13, expnt(s) = [313.07723327]
bas 14, expnt(s) = [61.7475191]
bas 15, expnt(s) = [7.9640368]
bas 16, expnt(s) = [21.38801716]
bas 17, expnt(s) = [0.79826562]
bas 18, expnt(s) = [3.04241197]
bas 19, expnt(s) = [0.22847612]
CPU time:      1413.75
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61827300e+04 5.20027392e+03 7.61734835e+03 2.06000316e+03
 3.61741732e+03 1.17845766e+03 1.59395548e+03 6.37341450e+02
 3.95809661e+02 2.24197011e+02 1.15771275e+02 8.91693575e+01
 3.77742047e+01 3.84956380e+01 7.97397802e+00 1.19886781e+01
 3.12477181e+00 5.93784361e+00 3.98458487e-01 1.26707504e+00
 1.36280776e+03 2.41561458e+04 6.64507820e+02 9.84259267e+03
 2.99842437e+02 3.63999483e+03 3.13077233e+02 3.84192384e+03
 6.17475191e+01 5.04962101e+02 7.96403680e+00 3.90302169e+01
 2.13880172e+01 1.34183015e+02 7.98265619e-01 2.20124648e+00
 3.04241197e+00 1.17221404e+01 2.28476117e-01 4.60824334e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98201492741884
cond(S) = 101088.49638080552
E1 = -729.3793420559905  E_coul = 203.12276072191582
init E= -526.256581334075
    CPU time for initialize scf      0.63 sec, wall time      0.05 sec
  HOMO = -0.556681378611104  LUMO = 1.0748174894267
  mo_energy =
[-1.18334073e+02 -1.22078742e+01 -9.45152044e+00 -9.45152044e+00
 -9.45152044e+00 -1.22595773e+00 -5.56681379e-01 -5.56681379e-01
 -5.56681379e-01  1.07481749e+00  1.07481749e+00  1.07481749e+00
  8.03003705e+00  8.03003705e+00  8.03003705e+00  9.81398814e+00
  3.66932700e+01  3.66932700e+01  3.66932700e+01  1.11373620e+02
  1.35400138e+02  1.35400138e+02  1.35400138e+02  4.89568897e+02
  4.89568897e+02  4.89568897e+02  6.22128715e+02  1.33880765e+03
  1.33880765e+03  1.33880765e+03  2.72197469e+03  3.02978986e+03
  3.02978986e+03  3.02978986e+03  6.64790975e+03  6.64790975e+03
  6.64790975e+03  9.13258817e+03  2.54843512e+04  7.62213551e+04]
E1 = -728.0008641033118  E_coul = 201.29497352372934
cycle= 1 E= -526.705890579582  delta_E= -0.449  |g|= 0.183  |ddm|= 0.451
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.540349
diis-c [-0.29197746  1.        ]
  HOMO = -0.580364937589763  LUMO = 1.05849056752093
  mo_energy =
[-1.18625294e+02 -1.23303854e+01 -9.58422210e+00 -9.58422210e+00
 -9.58422210e+00 -1.25639547e+00 -5.80364938e-01 -5.80364938e-01
 -5.80364938e-01  1.05849057e+00  1.05849057e+00  1.05849057e+00
  7.95070438e+00  7.95070438e+00  7.95070438e+00  9.72509185e+00
  3.65511135e+01  3.65511135e+01  3.65511135e+01  1.11164314e+02
  1.35187957e+02  1.35187957e+02  1.35187957e+02  4.89279725e+02
  4.89279725e+02  4.89279725e+02  6.21797189e+02  1.33846251e+03
  1.33846251e+03  1.33846251e+03  2.72149537e+03  3.02937897e+03
  3.02937897e+03  3.02937897e+03  6.64738628e+03  6.64738628e+03
  6.64738628e+03  9.13199024e+03  2.54836595e+04  7.62205734e+04]
E1 = -728.4576526796485  E_coul = 201.7511799234478
cycle= 2 E= -526.706472756201  delta_E= -0.000582  |g|= 0.0331  |ddm|= 0.0387
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0667036
diis-c [-0.00266316  0.07285034  0.92714966]
  HOMO = -0.573768231358725  LUMO = 1.06370797180707
  mo_energy =
[-1.18567285e+02 -1.23000105e+01 -9.55255599e+00 -9.55255599e+00
 -9.55255599e+00 -1.24802015e+00 -5.73768231e-01 -5.73768231e-01
 -5.73768231e-01  1.06370797e+00  1.06370797e+00  1.06370797e+00
  7.96989061e+00  7.96989061e+00  7.96989061e+00  9.74907833e+00
  3.65842638e+01  3.65842638e+01  3.65842638e+01  1.11212123e+02
  1.35234957e+02  1.35234957e+02  1.35234957e+02  4.89336906e+02
  4.89336906e+02  4.89336906e+02  6.21856940e+02  1.33852351e+03
  1.33852351e+03  1.33852351e+03  2.72155943e+03  3.02944206e+03
  3.02944206e+03  3.02944206e+03  6.64745091e+03  6.64745091e+03
  6.64745091e+03  9.13205558e+03  2.54837253e+04  7.62206395e+04]
E1 = -728.3547664143515  E_coul = 201.64825997428068
cycle= 3 E= -526.706506440071  delta_E= -3.37e-05  |g|= 0.00476  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104158
diis-c [-4.45960443e-07 -1.11288363e-03  1.30453483e-01  8.70659401e-01]
  HOMO = -0.574666734634077  LUMO = 1.06300849830595
  mo_energy =
[-1.18574741e+02 -1.23039784e+01 -9.55679533e+00 -9.55679533e+00
 -9.55679533e+00 -1.24910884e+00 -5.74666735e-01 -5.74666735e-01
 -5.74666735e-01  1.06300850e+00  1.06300850e+00  1.06300850e+00
  7.96730120e+00  7.96730120e+00  7.96730120e+00  9.74603443e+00
  3.65798647e+01  3.65798647e+01  3.65798647e+01  1.11205984e+02
  1.35228865e+02  1.35228865e+02  1.35228865e+02  4.89329556e+02
  4.89329556e+02  4.89329556e+02  6.21849227e+02  1.33851564e+03
  1.33851564e+03  1.33851564e+03  2.72155099e+03  3.02943384e+03
  3.02943384e+03  3.02943384e+03  6.64744235e+03  6.64744235e+03
  6.64744235e+03  9.13204682e+03  2.54837163e+04  7.62206304e+04]
E1 = -728.3686600779566  E_coul = 201.66215282703376
cycle= 4 E= -526.706507250923  delta_E= -8.11e-07  |g|= 6.06e-05  |ddm|= 0.00129
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000126767
diis-c [-1.22926043e-09  6.56612399e-05 -9.19324262e-03 -7.24895684e-02
  1.08161715e+00]
  HOMO = -0.574655158302795  LUMO = 1.06301742115088
  mo_energy =
[-1.18574748e+02 -1.23039513e+01 -9.55678006e+00 -9.55678006e+00
 -9.55678006e+00 -1.24909023e+00 -5.74655158e-01 -5.74655158e-01
 -5.74655158e-01  1.06301742e+00  1.06301742e+00  1.06301742e+00
  7.96732046e+00  7.96732046e+00  7.96732046e+00  9.74606865e+00
  3.65798785e+01  3.65798785e+01  3.65798785e+01  1.11205992e+02
  1.35228870e+02  1.35228870e+02  1.35228870e+02  4.89329550e+02
  4.89329550e+02  4.89329550e+02  6.21849213e+02  1.33851563e+03
  1.33851563e+03  1.33851563e+03  2.72155096e+03  3.02943382e+03
  3.02943382e+03  3.02943382e+03  6.64744231e+03  6.64744231e+03
  6.64744231e+03  9.13204678e+03  2.54837163e+04  7.62206304e+04]
E1 = -728.3686644183796  E_coul = 201.66215716734058
cycle= 5 E= -526.706507251039  delta_E= -1.16e-10  |g|= 7.56e-06  |ddm|= 2.44e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3686644183796  E_coul = 201.66215716734058
  HOMO = -0.574658512811645  LUMO = 1.06301485767605
  mo_energy =
[-1.18574765e+02 -1.23039632e+01 -9.55679249e+00 -9.55679249e+00
 -9.55679249e+00 -1.24909436e+00 -5.74658513e-01 -5.74658513e-01
 -5.74658513e-01  1.06301486e+00  1.06301486e+00  1.06301486e+00
  7.96731194e+00  7.96731194e+00  7.96731194e+00  9.74605903e+00
  3.65798661e+01  3.65798661e+01  3.65798661e+01  1.11205977e+02
  1.35228855e+02  1.35228855e+02  1.35228855e+02  4.89329533e+02
  4.89329533e+02  4.89329533e+02  6.21849196e+02  1.33851561e+03
  1.33851561e+03  1.33851561e+03  2.72155094e+03  3.02943380e+03
  3.02943380e+03  3.02943380e+03  6.64744229e+03  6.64744229e+03
  6.64744229e+03  9.13204676e+03  2.54837163e+04  7.62206303e+04]
E1 = -728.3687013573833  E_coul = 201.6621941063412
Extra cycle  E= -526.706507251042  delta_E= -3.07e-12  |g|= 2.22e-06  |ddm|= 3.86e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 101088.49638080552
E1 = -728.3687013573833  E_coul = 201.6621941063412
init E= -526.706507251042
    CPU time for initialize scf      3.82 sec, wall time      0.22 sec
  HOMO = -0.574657840880117  LUMO = 1.06301537763078
  mo_energy =
[-1.18574760e+02 -1.23039605e+01 -9.55678969e+00 -9.55678969e+00
 -9.55678969e+00 -1.24909352e+00 -5.74657841e-01 -5.74657841e-01
 -5.74657841e-01  1.06301538e+00  1.06301538e+00  1.06301538e+00
  7.96731375e+00  7.96731375e+00  7.96731375e+00  9.74606119e+00
  3.65798689e+01  3.65798689e+01  3.65798689e+01  1.11205981e+02
  1.35228859e+02  1.35228859e+02  1.35228859e+02  4.89329538e+02
  4.89329538e+02  4.89329538e+02  6.21849201e+02  1.33851562e+03
  1.33851562e+03  1.33851562e+03  2.72155094e+03  3.02943380e+03
  3.02943380e+03  3.02943380e+03  6.64744229e+03  6.64744229e+03
  6.64744229e+03  9.13204676e+03  2.54837163e+04  7.62206304e+04]
E1 = -728.3686926294497  E_coul = 201.662185378407
cycle= 1 E= -526.706507251043  delta_E= -5.68e-13  |g|= 5.68e-07  |ddm|= 8.8e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3686926294497  E_coul = 201.662185378407
  HOMO = -0.574657988540572  LUMO = 1.06301526262281
  mo_energy =
[-1.18574761e+02 -1.23039611e+01 -9.55679035e+00 -9.55679035e+00
 -9.55679035e+00 -1.24909370e+00 -5.74657989e-01 -5.74657989e-01
 -5.74657989e-01  1.06301526e+00  1.06301526e+00  1.06301526e+00
  7.96731334e+00  7.96731334e+00  7.96731334e+00  9.74606070e+00
  3.65798683e+01  3.65798683e+01  3.65798683e+01  1.11205980e+02
  1.35228858e+02  1.35228858e+02  1.35228858e+02  4.89329537e+02
  4.89329537e+02  4.89329537e+02  6.21849200e+02  1.33851561e+03
  1.33851561e+03  1.33851561e+03  2.72155094e+03  3.02943380e+03
  3.02943380e+03  3.02943380e+03  6.64744229e+03  6.64744229e+03
  6.64744229e+03  9.13204676e+03  2.54837163e+04  7.62206304e+04]
E1 = -728.368694744154  E_coul = 201.66218749311133
Extra cycle  E= -526.706507251043  delta_E=    0  |g|= 1.42e-07  |ddm|= 2.05e-07
    CPU time for scf_cycle      3.94 sec, wall time      0.33 sec
exp = [2.61827300e+04 7.61734835e+03 3.61741732e+03 1.59395548e+03
 3.95809661e+02 1.15771275e+02 3.77742047e+01 7.97397802e+00
 3.12477181e+00 3.98458487e-01 1.36280776e+03 6.64507820e+02
 2.99842437e+02 3.13077233e+02 6.17475191e+01 7.96403680e+00
 2.13880172e+01 7.98265619e-01 3.04241197e+00 2.28476117e-01]
grad_E = [-1.49011054e-06  3.01357226e-06 -1.86045078e-06  6.24706437e-05
 -1.61484548e-04 -9.59677335e-06  2.84262452e-05  1.16941542e-05
 -3.61447416e-05  1.49755112e-04 -3.90915857e-07  6.48209048e-06
  3.24928778e-05  2.79595245e-05 -6.68621717e-04  1.39881330e-03
  1.45511414e-03 -1.32941280e-04  2.30298089e-05 -2.28632344e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:00:12 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.72876          1
[INPUT] 0    0    [1    /1   ]  7617.35133769        1
[INPUT] 0    0    [1    /1   ]  3617.41621039        1
[INPUT] 0    0    [1    /1   ]  1594.02275886        1
[INPUT] 0    0    [1    /1   ]  395.554457858        1
[INPUT] 0    0    [1    /1   ]  115.750977483        1
[INPUT] 0    0    [1    /1   ]  37.7745276846        1
[INPUT] 0    0    [1    /1   ]  7.97155223798        1
[INPUT] 0    0    [1    /1   ]  3.12461297075        1
[INPUT] 0    0    [1    /1   ]  0.398421729183       1
[INPUT] 1    0    [1    /1   ]  1362.80734582        1
[INPUT] 1    0    [1    /1   ]  664.511857113        1
[INPUT] 1    0    [1    /1   ]  299.861434955        1
[INPUT] 1    0    [1    /1   ]  313.093608478        1
[INPUT] 1    0    [1    /1   ]  61.7469269308        1
[INPUT] 1    0    [1    /1   ]  7.94088268402        1
[INPUT] 1    0    [1    /1   ]  21.3694549428        1
[INPUT] 1    0    [1    /1   ]  0.797515237329       1
[INPUT] 1    0    [1    /1   ]  3.03287521704        1
[INPUT] 1    0    [1    /1   ]  0.228380548846       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.728759979593, 1.0]], [0, [7617.351337687337, 1.0]], [0, [3617.4162103900294, 1.0]], [0, [1594.0227588563323, 1.0]], [0, [395.5544578575917, 1.0]], [0, [115.75097748320873, 1.0]], [0, [37.774527684561335, 1.0]], [0, [7.9715522379830155, 1.0]], [0, [3.12461297074548, 1.0]], [0, [0.3984217291834342, 1.0]], [1, [1362.807345815738, 1.0]], [1, [664.5118571131562, 1.0]], [1, [299.86143495528296, 1.0]], [1, [313.09360847828043, 1.0]], [1, [61.74692693079148, 1.0]], [1, [7.940882684019225, 1.0]], [1, [21.369454942797013, 1.0]], [1, [0.7975152373294577, 1.0]], [1, [3.0328752170422946, 1.0]], [1, [0.2283805488457879, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.72875998]
bas 1, expnt(s) = [7617.35133769]
bas 2, expnt(s) = [3617.41621039]
bas 3, expnt(s) = [1594.02275886]
bas 4, expnt(s) = [395.55445786]
bas 5, expnt(s) = [115.75097748]
bas 6, expnt(s) = [37.77452768]
bas 7, expnt(s) = [7.97155224]
bas 8, expnt(s) = [3.12461297]
bas 9, expnt(s) = [0.39842173]
bas 10, expnt(s) = [1362.80734582]
bas 11, expnt(s) = [664.51185711]
bas 12, expnt(s) = [299.86143496]
bas 13, expnt(s) = [313.09360848]
bas 14, expnt(s) = [61.74692693]
bas 15, expnt(s) = [7.94088268]
bas 16, expnt(s) = [21.36945494]
bas 17, expnt(s) = [0.79751524]
bas 18, expnt(s) = [3.03287522]
bas 19, expnt(s) = [0.22838055]
CPU time:      1423.30
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61827288e+04 5.20027373e+03 7.61735134e+03 2.06000377e+03
 3.61741621e+03 1.17845739e+03 1.59402276e+03 6.37361627e+02
 3.95554458e+02 2.24088586e+02 1.15750977e+02 8.91576319e+01
 3.77745277e+01 3.84958848e+01 7.97155224e+00 1.19859427e+01
 3.12461297e+00 5.93761724e+00 3.98421729e-01 1.26698737e+00
 1.36280735e+03 2.41561365e+04 6.64511857e+02 9.84266742e+03
 2.99861435e+02 3.64028311e+03 3.13093608e+02 3.84217503e+03
 6.17469269e+01 5.04956047e+02 7.94088268e+00 3.88884262e+01
 2.13694549e+01 1.34037463e+02 7.97515237e-01 2.19866027e+00
 3.03287522e+00 1.16762281e+01 2.28380549e-01 4.60583402e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982044292892127
cond(S) = 101104.82086531424
E1 = -729.3791327699819  E_coul = 203.12252513671663
init E= -526.256607633265
    CPU time for initialize scf      0.63 sec, wall time      0.05 sec
  HOMO = -0.556696678018984  LUMO = 1.07372869198499
  mo_energy =
[-1.18334073e+02 -1.22078910e+01 -9.45153816e+00 -9.45153816e+00
 -9.45153816e+00 -1.22596378e+00 -5.56696678e-01 -5.56696678e-01
 -5.56696678e-01  1.07372869e+00  1.07372869e+00  1.07372869e+00
  8.00309628e+00  8.00309628e+00  8.00309628e+00  9.81075548e+00
  3.65895065e+01  3.65895065e+01  3.65895065e+01  1.11354853e+02
  1.35235055e+02  1.35235055e+02  1.35235055e+02  4.89419064e+02
  4.89419064e+02  4.89419064e+02  6.21893540e+02  1.33870956e+03
  1.33870956e+03  1.33870956e+03  2.72126469e+03  3.02975181e+03
  3.02975181e+03  3.02975181e+03  6.64791653e+03  6.64791653e+03
  6.64791653e+03  9.13175664e+03  2.54835629e+04  7.62206337e+04]
E1 = -728.0009852170136  E_coul = 201.29508606527878
cycle= 1 E= -526.705899151735  delta_E= -0.449  |g|= 0.183  |ddm|= 0.453
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.540387
diis-c [-0.29201831  1.        ]
  HOMO = -0.580371313093605  LUMO = 1.0574356025838
  mo_energy =
[-1.18625294e+02 -1.23303698e+01 -9.58420756e+00 -9.58420756e+00
 -9.58420756e+00 -1.25638404e+00 -5.80371313e-01 -5.80371313e-01
 -5.80371313e-01  1.05743560e+00  1.05743560e+00  1.05743560e+00
  7.92397399e+00  7.92397399e+00  7.92397399e+00  9.72191279e+00
  3.64474650e+01  3.64474650e+01  3.64474650e+01  1.11145561e+02
  1.35022878e+02  1.35022878e+02  1.35022878e+02  4.89129876e+02
  4.89129876e+02  4.89129876e+02  6.21562059e+02  1.33836441e+03
  1.33836441e+03  1.33836441e+03  2.72078538e+03  3.02934092e+03
  3.02934092e+03  3.02934092e+03  6.64739305e+03  6.64739305e+03
  6.64739305e+03  9.13115870e+03  2.54828711e+04  7.62198520e+04]
E1 = -728.4578326631699  E_coul = 201.75135118524673
cycle= 2 E= -526.706481477923  delta_E= -0.000582  |g|= 0.0331  |ddm|= 0.0387
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.066702
diis-c [-0.00266346  0.07283598  0.92716402]
  HOMO = -0.573774300502801  LUMO = 1.06264609305205
  mo_energy =
[-1.18567274e+02 -1.22999905e+01 -9.55253684e+00 -9.55253684e+00
 -9.55253684e+00 -1.24800854e+00 -5.73774301e-01 -5.73774301e-01
 -5.73774301e-01  1.06264609e+00  1.06264609e+00  1.06264609e+00
  7.94312371e+00  7.94312371e+00  7.94312371e+00  9.74589971e+00
  3.64805996e+01  3.64805996e+01  3.64805996e+01  1.11193377e+02
  1.35069888e+02  1.35069888e+02  1.35069888e+02  4.89187071e+02
  4.89187071e+02  4.89187071e+02  6.21621819e+02  1.33842543e+03
  1.33842543e+03  1.33842543e+03  2.72084946e+03  3.02940402e+03
  3.02940402e+03  3.02940402e+03  6.64745770e+03  6.64745770e+03
  6.64745770e+03  9.13122405e+03  2.54829369e+04  7.62199180e+04]
E1 = -728.354914396091  E_coul = 201.6483992207137
cycle= 3 E= -526.706515175377  delta_E= -3.37e-05  |g|= 0.00476  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104179
diis-c [-4.46557825e-07 -1.11313993e-03  1.30478929e-01  8.70634211e-01]
  HOMO = -0.574673302984266  LUMO = 1.06194721917418
  mo_energy =
[-1.18574733e+02 -1.23039604e+01 -9.55677828e+00 -9.55677828e+00
 -9.55677828e+00 -1.24909777e+00 -5.74673303e-01 -5.74673303e-01
 -5.74673303e-01  1.06194722e+00  1.06194722e+00  1.06194722e+00
  7.94053818e+00  7.94053818e+00  7.94053818e+00  9.74285469e+00
  3.64762010e+01  3.64762010e+01  3.64762010e+01  1.11187235e+02
  1.35063793e+02  1.35063793e+02  1.35063793e+02  4.89179717e+02
  4.89179717e+02  4.89179717e+02  6.21614103e+02  1.33841755e+03
  1.33841755e+03  1.33841755e+03  2.72084102e+03  3.02939580e+03
  3.02939580e+03  3.02939580e+03  6.64744913e+03  6.64744913e+03
  6.64744913e+03  9.13121529e+03  2.54829280e+04  7.62199090e+04]
E1 = -728.3688173152794  E_coul = 201.66230132816256
cycle= 4 E= -526.706515987117  delta_E= -8.12e-07  |g|= 6.07e-05  |ddm|= 0.00129
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000126664
diis-c [-1.23657487e-09  6.56551377e-05 -9.19095447e-03 -7.24422471e-02
  1.08156755e+00]
  HOMO = -0.574661668258677  LUMO = 1.06195617771231
  mo_energy =
[-1.18574739e+02 -1.23039331e+01 -9.55676283e+00 -9.55676283e+00
 -9.55676283e+00 -1.24907909e+00 -5.74661668e-01 -5.74661668e-01
 -5.74661668e-01  1.06195618e+00  1.06195618e+00  1.06195618e+00
  7.94055758e+00  7.94055758e+00  7.94055758e+00  9.74288907e+00
  3.64762149e+01  3.64762149e+01  3.64762149e+01  1.11187244e+02
  1.35063798e+02  1.35063798e+02  1.35063798e+02  4.89179711e+02
  4.89179711e+02  4.89179711e+02  6.21614089e+02  1.33841754e+03
  1.33841754e+03  1.33841754e+03  2.72084098e+03  3.02939577e+03
  3.02939577e+03  3.02939577e+03  6.64744909e+03  6.64744909e+03
  6.64744909e+03  9.13121525e+03  2.54829279e+04  7.62199089e+04]
E1 = -728.3688212321484  E_coul = 201.66230524491414
cycle= 5 E= -526.706515987234  delta_E= -1.17e-10  |g|= 7.59e-06  |ddm|= 2.45e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3688212321484  E_coul = 201.66230524491414
  HOMO = -0.574665031512155  LUMO = 1.06195361101179
  mo_energy =
[-1.18574756e+02 -1.23039450e+01 -9.55677529e+00 -9.55677529e+00
 -9.55677529e+00 -1.24908322e+00 -5.74665032e-01 -5.74665032e-01
 -5.74665032e-01  1.06195361e+00  1.06195361e+00  1.06195361e+00
  7.94054905e+00  7.94054905e+00  7.94054905e+00  9.74287943e+00
  3.64762025e+01  3.64762025e+01  3.64762025e+01  1.11187229e+02
  1.35063783e+02  1.35063783e+02  1.35063783e+02  4.89179694e+02
  4.89179694e+02  4.89179694e+02  6.21614072e+02  1.33841752e+03
  1.33841752e+03  1.33841752e+03  2.72084096e+03  3.02939576e+03
  3.02939576e+03  3.02939576e+03  6.64744907e+03  6.64744907e+03
  6.64744907e+03  9.13121523e+03  2.54829279e+04  7.62199089e+04]
E1 = -728.3688582797065  E_coul = 201.6623422924693
Extra cycle  E= -526.706515987237  delta_E= -2.96e-12  |g|= 2.23e-06  |ddm|= 3.87e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.23 sec
exp = [2.61827288e+04 7.61735134e+03 3.61741621e+03 1.59402276e+03
 3.95554458e+02 1.15750977e+02 3.77745277e+01 7.97155224e+00
 3.12461297e+00 3.98421729e-01 1.36280735e+03 6.64511857e+02
 2.99861435e+02 3.13093608e+02 6.17469269e+01 7.94088268e+00
 2.13694549e+01 7.97515237e-01 3.03287522e+00 2.28380549e-01]
E = -526.7065159872373
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:00:13 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.72876          1
[INPUT] 0    0    [1    /1   ]  7617.35133769        1
[INPUT] 0    0    [1    /1   ]  3617.41621039        1
[INPUT] 0    0    [1    /1   ]  1594.02275886        1
[INPUT] 0    0    [1    /1   ]  395.554457858        1
[INPUT] 0    0    [1    /1   ]  115.750977483        1
[INPUT] 0    0    [1    /1   ]  37.7745276846        1
[INPUT] 0    0    [1    /1   ]  7.97155223798        1
[INPUT] 0    0    [1    /1   ]  3.12461297075        1
[INPUT] 0    0    [1    /1   ]  0.398421729183       1
[INPUT] 1    0    [1    /1   ]  1362.80734582        1
[INPUT] 1    0    [1    /1   ]  664.511857113        1
[INPUT] 1    0    [1    /1   ]  299.861434955        1
[INPUT] 1    0    [1    /1   ]  313.093608478        1
[INPUT] 1    0    [1    /1   ]  61.7469269308        1
[INPUT] 1    0    [1    /1   ]  7.94088268402        1
[INPUT] 1    0    [1    /1   ]  21.3694549428        1
[INPUT] 1    0    [1    /1   ]  0.797515237329       1
[INPUT] 1    0    [1    /1   ]  3.03287521704        1
[INPUT] 1    0    [1    /1   ]  0.228380548846       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.728759979593, 1.0]], [0, [7617.351337687337, 1.0]], [0, [3617.4162103900294, 1.0]], [0, [1594.0227588563323, 1.0]], [0, [395.5544578575917, 1.0]], [0, [115.75097748320873, 1.0]], [0, [37.774527684561335, 1.0]], [0, [7.9715522379830155, 1.0]], [0, [3.12461297074548, 1.0]], [0, [0.3984217291834342, 1.0]], [1, [1362.807345815738, 1.0]], [1, [664.5118571131562, 1.0]], [1, [299.86143495528296, 1.0]], [1, [313.09360847828043, 1.0]], [1, [61.74692693079148, 1.0]], [1, [7.940882684019225, 1.0]], [1, [21.369454942797013, 1.0]], [1, [0.7975152373294577, 1.0]], [1, [3.0328752170422946, 1.0]], [1, [0.2283805488457879, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.72875998]
bas 1, expnt(s) = [7617.35133769]
bas 2, expnt(s) = [3617.41621039]
bas 3, expnt(s) = [1594.02275886]
bas 4, expnt(s) = [395.55445786]
bas 5, expnt(s) = [115.75097748]
bas 6, expnt(s) = [37.77452768]
bas 7, expnt(s) = [7.97155224]
bas 8, expnt(s) = [3.12461297]
bas 9, expnt(s) = [0.39842173]
bas 10, expnt(s) = [1362.80734582]
bas 11, expnt(s) = [664.51185711]
bas 12, expnt(s) = [299.86143496]
bas 13, expnt(s) = [313.09360848]
bas 14, expnt(s) = [61.74692693]
bas 15, expnt(s) = [7.94088268]
bas 16, expnt(s) = [21.36945494]
bas 17, expnt(s) = [0.79751524]
bas 18, expnt(s) = [3.03287522]
bas 19, expnt(s) = [0.22838055]
CPU time:      1424.33
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61827288e+04 5.20027373e+03 7.61735134e+03 2.06000377e+03
 3.61741621e+03 1.17845739e+03 1.59402276e+03 6.37361627e+02
 3.95554458e+02 2.24088586e+02 1.15750977e+02 8.91576319e+01
 3.77745277e+01 3.84958848e+01 7.97155224e+00 1.19859427e+01
 3.12461297e+00 5.93761724e+00 3.98421729e-01 1.26698737e+00
 1.36280735e+03 2.41561365e+04 6.64511857e+02 9.84266742e+03
 2.99861435e+02 3.64028311e+03 3.13093608e+02 3.84217503e+03
 6.17469269e+01 5.04956047e+02 7.94088268e+00 3.88884262e+01
 2.13694549e+01 1.34037463e+02 7.97515237e-01 2.19866027e+00
 3.03287522e+00 1.16762281e+01 2.28380549e-01 4.60583402e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982044292892127
cond(S) = 101104.82086531424
E1 = -729.3791327699819  E_coul = 203.12252513671663
init E= -526.256607633265
    CPU time for initialize scf      0.63 sec, wall time      0.05 sec
  HOMO = -0.556696678018984  LUMO = 1.07372869198499
  mo_energy =
[-1.18334073e+02 -1.22078910e+01 -9.45153816e+00 -9.45153816e+00
 -9.45153816e+00 -1.22596378e+00 -5.56696678e-01 -5.56696678e-01
 -5.56696678e-01  1.07372869e+00  1.07372869e+00  1.07372869e+00
  8.00309628e+00  8.00309628e+00  8.00309628e+00  9.81075548e+00
  3.65895065e+01  3.65895065e+01  3.65895065e+01  1.11354853e+02
  1.35235055e+02  1.35235055e+02  1.35235055e+02  4.89419064e+02
  4.89419064e+02  4.89419064e+02  6.21893540e+02  1.33870956e+03
  1.33870956e+03  1.33870956e+03  2.72126469e+03  3.02975181e+03
  3.02975181e+03  3.02975181e+03  6.64791653e+03  6.64791653e+03
  6.64791653e+03  9.13175664e+03  2.54835629e+04  7.62206337e+04]
E1 = -728.0009852170136  E_coul = 201.29508606527878
cycle= 1 E= -526.705899151735  delta_E= -0.449  |g|= 0.183  |ddm|= 0.453
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.540387
diis-c [-0.29201831  1.        ]
  HOMO = -0.580371313093605  LUMO = 1.0574356025838
  mo_energy =
[-1.18625294e+02 -1.23303698e+01 -9.58420756e+00 -9.58420756e+00
 -9.58420756e+00 -1.25638404e+00 -5.80371313e-01 -5.80371313e-01
 -5.80371313e-01  1.05743560e+00  1.05743560e+00  1.05743560e+00
  7.92397399e+00  7.92397399e+00  7.92397399e+00  9.72191279e+00
  3.64474650e+01  3.64474650e+01  3.64474650e+01  1.11145561e+02
  1.35022878e+02  1.35022878e+02  1.35022878e+02  4.89129876e+02
  4.89129876e+02  4.89129876e+02  6.21562059e+02  1.33836441e+03
  1.33836441e+03  1.33836441e+03  2.72078538e+03  3.02934092e+03
  3.02934092e+03  3.02934092e+03  6.64739305e+03  6.64739305e+03
  6.64739305e+03  9.13115870e+03  2.54828711e+04  7.62198520e+04]
E1 = -728.4578326631699  E_coul = 201.75135118524673
cycle= 2 E= -526.706481477923  delta_E= -0.000582  |g|= 0.0331  |ddm|= 0.0387
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.066702
diis-c [-0.00266346  0.07283598  0.92716402]
  HOMO = -0.573774300502801  LUMO = 1.06264609305205
  mo_energy =
[-1.18567274e+02 -1.22999905e+01 -9.55253684e+00 -9.55253684e+00
 -9.55253684e+00 -1.24800854e+00 -5.73774301e-01 -5.73774301e-01
 -5.73774301e-01  1.06264609e+00  1.06264609e+00  1.06264609e+00
  7.94312371e+00  7.94312371e+00  7.94312371e+00  9.74589971e+00
  3.64805996e+01  3.64805996e+01  3.64805996e+01  1.11193377e+02
  1.35069888e+02  1.35069888e+02  1.35069888e+02  4.89187071e+02
  4.89187071e+02  4.89187071e+02  6.21621819e+02  1.33842543e+03
  1.33842543e+03  1.33842543e+03  2.72084946e+03  3.02940402e+03
  3.02940402e+03  3.02940402e+03  6.64745770e+03  6.64745770e+03
  6.64745770e+03  9.13122405e+03  2.54829369e+04  7.62199180e+04]
E1 = -728.354914396091  E_coul = 201.6483992207137
cycle= 3 E= -526.706515175377  delta_E= -3.37e-05  |g|= 0.00476  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104179
diis-c [-4.46557825e-07 -1.11313993e-03  1.30478929e-01  8.70634211e-01]
  HOMO = -0.574673302984266  LUMO = 1.06194721917418
  mo_energy =
[-1.18574733e+02 -1.23039604e+01 -9.55677828e+00 -9.55677828e+00
 -9.55677828e+00 -1.24909777e+00 -5.74673303e-01 -5.74673303e-01
 -5.74673303e-01  1.06194722e+00  1.06194722e+00  1.06194722e+00
  7.94053818e+00  7.94053818e+00  7.94053818e+00  9.74285469e+00
  3.64762010e+01  3.64762010e+01  3.64762010e+01  1.11187235e+02
  1.35063793e+02  1.35063793e+02  1.35063793e+02  4.89179717e+02
  4.89179717e+02  4.89179717e+02  6.21614103e+02  1.33841755e+03
  1.33841755e+03  1.33841755e+03  2.72084102e+03  3.02939580e+03
  3.02939580e+03  3.02939580e+03  6.64744913e+03  6.64744913e+03
  6.64744913e+03  9.13121529e+03  2.54829280e+04  7.62199090e+04]
E1 = -728.3688173152794  E_coul = 201.66230132816256
cycle= 4 E= -526.706515987117  delta_E= -8.12e-07  |g|= 6.07e-05  |ddm|= 0.00129
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000126664
diis-c [-1.23657487e-09  6.56551377e-05 -9.19095447e-03 -7.24422471e-02
  1.08156755e+00]
  HOMO = -0.574661668258677  LUMO = 1.06195617771231
  mo_energy =
[-1.18574739e+02 -1.23039331e+01 -9.55676283e+00 -9.55676283e+00
 -9.55676283e+00 -1.24907909e+00 -5.74661668e-01 -5.74661668e-01
 -5.74661668e-01  1.06195618e+00  1.06195618e+00  1.06195618e+00
  7.94055758e+00  7.94055758e+00  7.94055758e+00  9.74288907e+00
  3.64762149e+01  3.64762149e+01  3.64762149e+01  1.11187244e+02
  1.35063798e+02  1.35063798e+02  1.35063798e+02  4.89179711e+02
  4.89179711e+02  4.89179711e+02  6.21614089e+02  1.33841754e+03
  1.33841754e+03  1.33841754e+03  2.72084098e+03  3.02939577e+03
  3.02939577e+03  3.02939577e+03  6.64744909e+03  6.64744909e+03
  6.64744909e+03  9.13121525e+03  2.54829279e+04  7.62199089e+04]
E1 = -728.3688212321484  E_coul = 201.66230524491414
cycle= 5 E= -526.706515987234  delta_E= -1.17e-10  |g|= 7.59e-06  |ddm|= 2.45e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3688212321484  E_coul = 201.66230524491414
  HOMO = -0.574665031512155  LUMO = 1.06195361101179
  mo_energy =
[-1.18574756e+02 -1.23039450e+01 -9.55677529e+00 -9.55677529e+00
 -9.55677529e+00 -1.24908322e+00 -5.74665032e-01 -5.74665032e-01
 -5.74665032e-01  1.06195361e+00  1.06195361e+00  1.06195361e+00
  7.94054905e+00  7.94054905e+00  7.94054905e+00  9.74287943e+00
  3.64762025e+01  3.64762025e+01  3.64762025e+01  1.11187229e+02
  1.35063783e+02  1.35063783e+02  1.35063783e+02  4.89179694e+02
  4.89179694e+02  4.89179694e+02  6.21614072e+02  1.33841752e+03
  1.33841752e+03  1.33841752e+03  2.72084096e+03  3.02939576e+03
  3.02939576e+03  3.02939576e+03  6.64744907e+03  6.64744907e+03
  6.64744907e+03  9.13121523e+03  2.54829279e+04  7.62199089e+04]
E1 = -728.3688582797065  E_coul = 201.6623422924693
Extra cycle  E= -526.706515987237  delta_E= -2.96e-12  |g|= 2.23e-06  |ddm|= 3.87e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 101104.82086531424
E1 = -728.3688582797065  E_coul = 201.6623422924693
init E= -526.706515987237
    CPU time for initialize scf      3.77 sec, wall time      0.20 sec
  HOMO = -0.574664357568473  LUMO = 1.06195413181754
  mo_energy =
[-1.18574752e+02 -1.23039423e+01 -9.55677248e+00 -9.55677248e+00
 -9.55677248e+00 -1.24908238e+00 -5.74664358e-01 -5.74664358e-01
 -5.74664358e-01  1.06195413e+00  1.06195413e+00  1.06195413e+00
  7.94055086e+00  7.94055086e+00  7.94055086e+00  9.74288160e+00
  3.64762054e+01  3.64762054e+01  3.64762054e+01  1.11187233e+02
  1.35063787e+02  1.35063787e+02  1.35063787e+02  4.89179699e+02
  4.89179699e+02  4.89179699e+02  6.21614077e+02  1.33841752e+03
  1.33841752e+03  1.33841752e+03  2.72084097e+03  3.02939576e+03
  3.02939576e+03  3.02939576e+03  6.64744908e+03  6.64744908e+03
  6.64744908e+03  9.13121523e+03  2.54829279e+04  7.62199089e+04]
E1 = -728.3688495249221  E_coul = 201.66233353768354
cycle= 1 E= -526.706515987239  delta_E= -1.36e-12  |g|= 5.7e-07  |ddm|= 8.82e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3688495249221  E_coul = 201.66233353768354
  HOMO = -0.574664505686805  LUMO = 1.06195401661229
  mo_energy =
[-1.18574753e+02 -1.23039429e+01 -9.55677315e+00 -9.55677315e+00
 -9.55677315e+00 -1.24908256e+00 -5.74664506e-01 -5.74664506e-01
 -5.74664506e-01  1.06195402e+00  1.06195402e+00  1.06195402e+00
  7.94055044e+00  7.94055044e+00  7.94055044e+00  9.74288110e+00
  3.64762047e+01  3.64762047e+01  3.64762047e+01  1.11187232e+02
  1.35063786e+02  1.35063786e+02  1.35063786e+02  4.89179697e+02
  4.89179697e+02  4.89179697e+02  6.21614076e+02  1.33841752e+03
  1.33841752e+03  1.33841752e+03  2.72084097e+03  3.02939576e+03
  3.02939576e+03  3.02939576e+03  6.64744907e+03  6.64744907e+03
  6.64744907e+03  9.13121523e+03  2.54829279e+04  7.62199089e+04]
E1 = -728.368851646497  E_coul = 201.6623356592585
Extra cycle  E= -526.706515987239  delta_E= 1.14e-13  |g|= 1.42e-07  |ddm|= 2.05e-07
    CPU time for scf_cycle      3.88 sec, wall time      0.31 sec
exp = [2.61827288e+04 7.61735134e+03 3.61741621e+03 1.59402276e+03
 3.95554458e+02 1.15750977e+02 3.77745277e+01 7.97155224e+00
 3.12461297e+00 3.98421729e-01 1.36280735e+03 6.64511857e+02
 2.99861435e+02 3.13093608e+02 6.17469269e+01 7.94088268e+00
 2.13694549e+01 7.97515237e-01 3.03287522e+00 2.28380549e-01]
grad_E = [-1.49185023e-06  3.03148862e-06 -1.85107775e-06  6.30621324e-05
 -1.69686012e-04  1.45108954e-05  7.07042969e-06 -2.59598347e-05
  7.11089394e-05 -2.04536832e-04 -3.88993120e-07  6.50334447e-06
  3.26236401e-05  2.80730140e-05 -6.85753028e-04  9.22696842e-04
  1.62808092e-03 -2.86914048e-04  2.51181847e-04  1.26612477e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:00:17 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.7275691        1
[INPUT] 0    0    [1    /1   ]  7617.35414759        1
[INPUT] 0    0    [1    /1   ]  3617.41516404        1
[INPUT] 0    0    [1    /1   ]  1594.08584212        1
[INPUT] 0    0    [1    /1   ]  395.322020777        1
[INPUT] 0    0    [1    /1   ]  115.704726653        1
[INPUT] 0    0    [1    /1   ]  37.7662872135        1
[INPUT] 0    0    [1    /1   ]  7.96956550514        1
[INPUT] 0    0    [1    /1   ]  3.1241947733         1
[INPUT] 0    0    [1    /1   ]  0.398398470194       1
[INPUT] 1    0    [1    /1   ]  1362.80695178        1
[INPUT] 1    0    [1    /1   ]  664.515660408        1
[INPUT] 1    0    [1    /1   ]  299.879328131        1
[INPUT] 1    0    [1    /1   ]  313.109031939        1
[INPUT] 1    0    [1    /1   ]  61.747275594         1
[INPUT] 1    0    [1    /1   ]  7.92111911965        1
[INPUT] 1    0    [1    /1   ]  21.3482953912        1
[INPUT] 1    0    [1    /1   ]  0.796931255964       1
[INPUT] 1    0    [1    /1   ]  3.0254132133         1
[INPUT] 1    0    [1    /1   ]  0.228292533667       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.727569139206, 1.0]], [0, [7617.354147587132, 1.0]], [0, [3617.415164042181, 1.0]], [0, [1594.0858421201733, 1.0]], [0, [395.322020777286, 1.0]], [0, [115.70472665303552, 1.0]], [0, [37.76628721348548, 1.0]], [0, [7.969565505138967, 1.0]], [0, [3.124194773296149, 1.0]], [0, [0.3983984701935527, 1.0]], [1, [1362.806951777661, 1.0]], [1, [664.515660407651, 1.0]], [1, [299.8793281312976, 1.0]], [1, [313.10903193908393, 1.0]], [1, [61.74727559402436, 1.0]], [1, [7.921119119649752, 1.0]], [1, [21.348295391233577, 1.0]], [1, [0.7969312559638541, 1.0]], [1, [3.02541321329943, 1.0]], [1, [0.2282925336666309, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.72756914]
bas 1, expnt(s) = [7617.35414759]
bas 2, expnt(s) = [3617.41516404]
bas 3, expnt(s) = [1594.08584212]
bas 4, expnt(s) = [395.32202078]
bas 5, expnt(s) = [115.70472665]
bas 6, expnt(s) = [37.76628721]
bas 7, expnt(s) = [7.96956551]
bas 8, expnt(s) = [3.12419477]
bas 9, expnt(s) = [0.39839847]
bas 10, expnt(s) = [1362.80695178]
bas 11, expnt(s) = [664.51566041]
bas 12, expnt(s) = [299.87932813]
bas 13, expnt(s) = [313.10903194]
bas 14, expnt(s) = [61.74727559]
bas 15, expnt(s) = [7.92111912]
bas 16, expnt(s) = [21.34829539]
bas 17, expnt(s) = [0.79693126]
bas 18, expnt(s) = [3.02541321]
bas 19, expnt(s) = [0.22829253]
CPU time:      1433.84
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61827276e+04 5.20027355e+03 7.61735415e+03 2.06000434e+03
 3.61741516e+03 1.17845714e+03 1.59408584e+03 6.37380544e+02
 3.95322021e+02 2.23989819e+02 1.15704727e+02 8.91309119e+01
 3.77662872e+01 3.84895863e+01 7.96956551e+00 1.19837022e+01
 3.12419477e+00 5.93702121e+00 3.98398470e-01 1.26693190e+00
 1.36280695e+03 2.41561278e+04 6.64515660e+02 9.84273784e+03
 2.99879328e+02 3.64055464e+03 3.13109032e+02 3.84241162e+03
 6.17472756e+01 5.04959612e+02 7.92111912e+00 3.87674801e+01
 2.13482954e+01 1.33871582e+02 7.96931256e-01 2.19664799e+00
 3.02541321e+00 1.16403293e+01 2.28292534e-01 4.60361533e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982068204990917
cond(S) = 101119.10701126339
E1 = -729.3790342568175  E_coul = 203.1223884992372
init E= -526.25664575758
    CPU time for initialize scf      0.62 sec, wall time      0.05 sec
  HOMO = -0.556708766536883  LUMO = 1.07282887175928
  mo_energy =
[-1.18334064e+02 -1.22079032e+01 -9.45154871e+00 -9.45154871e+00
 -9.45154871e+00 -1.22596523e+00 -5.56708767e-01 -5.56708767e-01
 -5.56708767e-01  1.07282887e+00  1.07282887e+00  1.07282887e+00
  7.98155869e+00  7.98155869e+00  7.98155869e+00  9.80708279e+00
  3.64999541e+01  3.64999541e+01  3.64999541e+01  1.11309206e+02
  1.35083166e+02  1.35083166e+02  1.35083166e+02  4.89278979e+02
  4.89278979e+02  4.89278979e+02  6.21578302e+02  1.33861806e+03
  1.33861806e+03  1.33861806e+03  2.72048801e+03  3.02971685e+03
  3.02971685e+03  3.02971685e+03  6.64792373e+03  6.64792373e+03
  6.64792373e+03  9.13087338e+03  2.54827258e+04  7.62198661e+04]
E1 = -728.0008540103809  E_coul = 201.29494606240962
cycle= 1 E= -526.705907947971  delta_E= -0.449  |g|= 0.183  |ddm|= 0.453
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.540422
diis-c [-0.2920559  1.       ]
  HOMO = -0.58038643487458  LUMO = 1.05655499144983
  mo_energy =
[-1.18625307e+02 -1.23303733e+01 -9.58421177e+00 -9.58421177e+00
 -9.58421177e+00 -1.25638344e+00 -5.80386435e-01 -5.80386435e-01
 -5.80386435e-01  1.05655499e+00  1.05655499e+00  1.05655499e+00
  7.90258858e+00  7.90258858e+00  7.90258858e+00  9.71827021e+00
  3.63580009e+01  3.63580009e+01  3.63580009e+01  1.11099927e+02
  1.34870975e+02  1.34870975e+02  1.34870975e+02  4.88989753e+02
  4.88989753e+02  4.88989753e+02  6.21246846e+02  1.33827287e+03
  1.33827287e+03  1.33827287e+03  2.72000868e+03  3.02930593e+03
  3.02930593e+03  3.02930593e+03  6.64740022e+03  6.64740022e+03
  6.64740022e+03  9.13027540e+03  2.54820340e+04  7.62190843e+04]
E1 = -728.4578233718086  E_coul = 201.75133284689747
cycle= 2 E= -526.706490524911  delta_E= -0.000583  |g|= 0.0331  |ddm|= 0.0387
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.066707
diis-c [-0.00266404  0.07283324  0.92716676]
  HOMO = -0.573787833215513  LUMO = 1.0617610028261
  mo_energy =
[-1.18567272e+02 -1.22999855e+01 -9.55253228e+00 -9.55253228e+00
 -9.55253228e+00 -1.24800604e+00 -5.73787833e-01 -5.73787833e-01
 -5.73787833e-01  1.06176100e+00  1.06176100e+00  1.06176100e+00
  7.92171196e+00  7.92171196e+00  7.92171196e+00  9.74226028e+00
  3.63911248e+01  3.63911248e+01  3.63911248e+01  1.11147751e+02
  1.34917998e+02  1.34917998e+02  1.34917998e+02  4.89046965e+02
  4.89046965e+02  4.89046965e+02  6.21306619e+02  1.33833391e+03
  1.33833391e+03  1.33833391e+03  2.72007278e+03  3.02936904e+03
  3.02936904e+03  3.02936904e+03  6.64746489e+03  6.64746489e+03
  6.64746489e+03  9.13034077e+03  2.54820998e+04  7.62191504e+04]
E1 = -728.3548589509198  E_coul = 201.64833470622642
cycle= 3 E= -526.706524244693  delta_E= -3.37e-05  |g|= 0.00476  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104208
diis-c [-4.47226289e-07 -1.11353866e-03  1.30500992e-01  8.70612547e-01]
  HOMO = -0.574687423941794  LUMO = 1.06106246057949
  mo_energy =
[-1.18574734e+02 -1.23039576e+01 -9.55677602e+00 -9.55677602e+00
 -9.55677602e+00 -1.24909593e+00 -5.74687424e-01 -5.74687424e-01
 -5.74687424e-01  1.06106246e+00  1.06106246e+00  1.06106246e+00
  7.91912915e+00  7.91912915e+00  7.91912915e+00  9.73921405e+00
  3.63867263e+01  3.63867263e+01  3.63867263e+01  1.11141607e+02
  1.34911900e+02  1.34911900e+02  1.34911900e+02  4.89039608e+02
  4.89039608e+02  4.89039608e+02  6.21298901e+02  1.33832603e+03
  1.33832603e+03  1.33832603e+03  2.72006433e+03  3.02936082e+03
  3.02936082e+03  3.02936082e+03  6.64745631e+03  6.64745631e+03
  6.64745631e+03  9.13033201e+03  2.54820909e+04  7.62191413e+04]
E1 = -728.3687718742842  E_coul = 201.66224681686498
cycle= 4 E= -526.706525057419  delta_E= -8.13e-07  |g|= 6.07e-05  |ddm|= 0.00129
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000126646
diis-c [-1.24248580e-09  6.56596579e-05 -9.18995648e-03 -7.24143795e-02
  1.08153868e+00]
  HOMO = -0.574675749178182  LUMO = 1.06107144242451
  mo_energy =
[-1.18574741e+02 -1.23039302e+01 -9.55676045e+00 -9.55676045e+00
 -9.55676045e+00 -1.24907719e+00 -5.74675749e-01 -5.74675749e-01
 -5.74675749e-01  1.06107144e+00  1.06107144e+00  1.06107144e+00
  7.91914865e+00  7.91914865e+00  7.91914865e+00  9.73924855e+00
  3.63867404e+01  3.63867404e+01  3.63867404e+01  1.11141616e+02
  1.34911905e+02  1.34911905e+02  1.34911905e+02  4.89039602e+02
  4.89039602e+02  4.89039602e+02  6.21298887e+02  1.33832601e+03
  1.33832601e+03  1.33832601e+03  2.72006429e+03  3.02936080e+03
  3.02936080e+03  3.02936080e+03  6.64745627e+03  6.64745627e+03
  6.64745627e+03  9.13033196e+03  2.54820909e+04  7.62191413e+04]
E1 = -728.3687755183556  E_coul = 201.66225046081996
cycle= 5 E= -526.706525057536  delta_E= -1.16e-10  |g|= 7.6e-06  |ddm|= 2.46e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3687755183556  E_coul = 201.66225046081996
  HOMO = -0.574679119755363  LUMO = 1.06106887288668
  mo_energy =
[-1.18574758e+02 -1.23039421e+01 -9.55677294e+00 -9.55677294e+00
 -9.55677294e+00 -1.24908134e+00 -5.74679120e-01 -5.74679120e-01
 -5.74679120e-01  1.06106887e+00  1.06106887e+00  1.06106887e+00
  7.91914011e+00  7.91914011e+00  7.91914011e+00  9.73923888e+00
  3.63867279e+01  3.63867279e+01  3.63867279e+01  1.11141601e+02
  1.34911890e+02  1.34911890e+02  1.34911890e+02  4.89039585e+02
  4.89039585e+02  4.89039585e+02  6.21298870e+02  1.33832600e+03
  1.33832600e+03  1.33832600e+03  2.72006428e+03  3.02936078e+03
  3.02936078e+03  3.02936078e+03  6.64745626e+03  6.64745626e+03
  6.64745626e+03  9.13033194e+03  2.54820908e+04  7.62191413e+04]
E1 = -728.3688126586718  E_coul = 201.6622876011321
Extra cycle  E= -526.70652505754  delta_E= -4.09e-12  |g|= 2.23e-06  |ddm|= 3.88e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.22 sec
exp = [2.61827276e+04 7.61735415e+03 3.61741516e+03 1.59408584e+03
 3.95322021e+02 1.15704727e+02 3.77662872e+01 7.96956551e+00
 3.12419477e+00 3.98398470e-01 1.36280695e+03 6.64515660e+02
 2.99879328e+02 3.13109032e+02 6.17472756e+01 7.92111912e+00
 2.13482954e+01 7.96931256e-01 3.02541321e+00 2.28292534e-01]
E = -526.7065250575397
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:00:17 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.7275691        1
[INPUT] 0    0    [1    /1   ]  7617.35414759        1
[INPUT] 0    0    [1    /1   ]  3617.41516404        1
[INPUT] 0    0    [1    /1   ]  1594.08584212        1
[INPUT] 0    0    [1    /1   ]  395.322020777        1
[INPUT] 0    0    [1    /1   ]  115.704726653        1
[INPUT] 0    0    [1    /1   ]  37.7662872135        1
[INPUT] 0    0    [1    /1   ]  7.96956550514        1
[INPUT] 0    0    [1    /1   ]  3.1241947733         1
[INPUT] 0    0    [1    /1   ]  0.398398470194       1
[INPUT] 1    0    [1    /1   ]  1362.80695178        1
[INPUT] 1    0    [1    /1   ]  664.515660408        1
[INPUT] 1    0    [1    /1   ]  299.879328131        1
[INPUT] 1    0    [1    /1   ]  313.109031939        1
[INPUT] 1    0    [1    /1   ]  61.747275594         1
[INPUT] 1    0    [1    /1   ]  7.92111911965        1
[INPUT] 1    0    [1    /1   ]  21.3482953912        1
[INPUT] 1    0    [1    /1   ]  0.796931255964       1
[INPUT] 1    0    [1    /1   ]  3.0254132133         1
[INPUT] 1    0    [1    /1   ]  0.228292533667       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.727569139206, 1.0]], [0, [7617.354147587132, 1.0]], [0, [3617.415164042181, 1.0]], [0, [1594.0858421201733, 1.0]], [0, [395.322020777286, 1.0]], [0, [115.70472665303552, 1.0]], [0, [37.76628721348548, 1.0]], [0, [7.969565505138967, 1.0]], [0, [3.124194773296149, 1.0]], [0, [0.3983984701935527, 1.0]], [1, [1362.806951777661, 1.0]], [1, [664.515660407651, 1.0]], [1, [299.8793281312976, 1.0]], [1, [313.10903193908393, 1.0]], [1, [61.74727559402436, 1.0]], [1, [7.921119119649752, 1.0]], [1, [21.348295391233577, 1.0]], [1, [0.7969312559638541, 1.0]], [1, [3.02541321329943, 1.0]], [1, [0.2282925336666309, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.72756914]
bas 1, expnt(s) = [7617.35414759]
bas 2, expnt(s) = [3617.41516404]
bas 3, expnt(s) = [1594.08584212]
bas 4, expnt(s) = [395.32202078]
bas 5, expnt(s) = [115.70472665]
bas 6, expnt(s) = [37.76628721]
bas 7, expnt(s) = [7.96956551]
bas 8, expnt(s) = [3.12419477]
bas 9, expnt(s) = [0.39839847]
bas 10, expnt(s) = [1362.80695178]
bas 11, expnt(s) = [664.51566041]
bas 12, expnt(s) = [299.87932813]
bas 13, expnt(s) = [313.10903194]
bas 14, expnt(s) = [61.74727559]
bas 15, expnt(s) = [7.92111912]
bas 16, expnt(s) = [21.34829539]
bas 17, expnt(s) = [0.79693126]
bas 18, expnt(s) = [3.02541321]
bas 19, expnt(s) = [0.22829253]
CPU time:      1434.87
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61827276e+04 5.20027355e+03 7.61735415e+03 2.06000434e+03
 3.61741516e+03 1.17845714e+03 1.59408584e+03 6.37380544e+02
 3.95322021e+02 2.23989819e+02 1.15704727e+02 8.91309119e+01
 3.77662872e+01 3.84895863e+01 7.96956551e+00 1.19837022e+01
 3.12419477e+00 5.93702121e+00 3.98398470e-01 1.26693190e+00
 1.36280695e+03 2.41561278e+04 6.64515660e+02 9.84273784e+03
 2.99879328e+02 3.64055464e+03 3.13109032e+02 3.84241162e+03
 6.17472756e+01 5.04959612e+02 7.92111912e+00 3.87674801e+01
 2.13482954e+01 1.33871582e+02 7.96931256e-01 2.19664799e+00
 3.02541321e+00 1.16403293e+01 2.28292534e-01 4.60361533e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982068204990917
cond(S) = 101119.10701126339
E1 = -729.3790342568175  E_coul = 203.1223884992372
init E= -526.25664575758
    CPU time for initialize scf      0.62 sec, wall time      0.05 sec
  HOMO = -0.556708766536883  LUMO = 1.07282887175928
  mo_energy =
[-1.18334064e+02 -1.22079032e+01 -9.45154871e+00 -9.45154871e+00
 -9.45154871e+00 -1.22596523e+00 -5.56708767e-01 -5.56708767e-01
 -5.56708767e-01  1.07282887e+00  1.07282887e+00  1.07282887e+00
  7.98155869e+00  7.98155869e+00  7.98155869e+00  9.80708279e+00
  3.64999541e+01  3.64999541e+01  3.64999541e+01  1.11309206e+02
  1.35083166e+02  1.35083166e+02  1.35083166e+02  4.89278979e+02
  4.89278979e+02  4.89278979e+02  6.21578302e+02  1.33861806e+03
  1.33861806e+03  1.33861806e+03  2.72048801e+03  3.02971685e+03
  3.02971685e+03  3.02971685e+03  6.64792373e+03  6.64792373e+03
  6.64792373e+03  9.13087338e+03  2.54827258e+04  7.62198661e+04]
E1 = -728.0008540103809  E_coul = 201.29494606240962
cycle= 1 E= -526.705907947971  delta_E= -0.449  |g|= 0.183  |ddm|= 0.453
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.540422
diis-c [-0.2920559  1.       ]
  HOMO = -0.58038643487458  LUMO = 1.05655499144983
  mo_energy =
[-1.18625307e+02 -1.23303733e+01 -9.58421177e+00 -9.58421177e+00
 -9.58421177e+00 -1.25638344e+00 -5.80386435e-01 -5.80386435e-01
 -5.80386435e-01  1.05655499e+00  1.05655499e+00  1.05655499e+00
  7.90258858e+00  7.90258858e+00  7.90258858e+00  9.71827021e+00
  3.63580009e+01  3.63580009e+01  3.63580009e+01  1.11099927e+02
  1.34870975e+02  1.34870975e+02  1.34870975e+02  4.88989753e+02
  4.88989753e+02  4.88989753e+02  6.21246846e+02  1.33827287e+03
  1.33827287e+03  1.33827287e+03  2.72000868e+03  3.02930593e+03
  3.02930593e+03  3.02930593e+03  6.64740022e+03  6.64740022e+03
  6.64740022e+03  9.13027540e+03  2.54820340e+04  7.62190843e+04]
E1 = -728.4578233718086  E_coul = 201.75133284689747
cycle= 2 E= -526.706490524911  delta_E= -0.000583  |g|= 0.0331  |ddm|= 0.0387
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.066707
diis-c [-0.00266404  0.07283324  0.92716676]
  HOMO = -0.573787833215513  LUMO = 1.0617610028261
  mo_energy =
[-1.18567272e+02 -1.22999855e+01 -9.55253228e+00 -9.55253228e+00
 -9.55253228e+00 -1.24800604e+00 -5.73787833e-01 -5.73787833e-01
 -5.73787833e-01  1.06176100e+00  1.06176100e+00  1.06176100e+00
  7.92171196e+00  7.92171196e+00  7.92171196e+00  9.74226028e+00
  3.63911248e+01  3.63911248e+01  3.63911248e+01  1.11147751e+02
  1.34917998e+02  1.34917998e+02  1.34917998e+02  4.89046965e+02
  4.89046965e+02  4.89046965e+02  6.21306619e+02  1.33833391e+03
  1.33833391e+03  1.33833391e+03  2.72007278e+03  3.02936904e+03
  3.02936904e+03  3.02936904e+03  6.64746489e+03  6.64746489e+03
  6.64746489e+03  9.13034077e+03  2.54820998e+04  7.62191504e+04]
E1 = -728.3548589509198  E_coul = 201.64833470622642
cycle= 3 E= -526.706524244693  delta_E= -3.37e-05  |g|= 0.00476  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104208
diis-c [-4.47226289e-07 -1.11353866e-03  1.30500992e-01  8.70612547e-01]
  HOMO = -0.574687423941794  LUMO = 1.06106246057949
  mo_energy =
[-1.18574734e+02 -1.23039576e+01 -9.55677602e+00 -9.55677602e+00
 -9.55677602e+00 -1.24909593e+00 -5.74687424e-01 -5.74687424e-01
 -5.74687424e-01  1.06106246e+00  1.06106246e+00  1.06106246e+00
  7.91912915e+00  7.91912915e+00  7.91912915e+00  9.73921405e+00
  3.63867263e+01  3.63867263e+01  3.63867263e+01  1.11141607e+02
  1.34911900e+02  1.34911900e+02  1.34911900e+02  4.89039608e+02
  4.89039608e+02  4.89039608e+02  6.21298901e+02  1.33832603e+03
  1.33832603e+03  1.33832603e+03  2.72006433e+03  3.02936082e+03
  3.02936082e+03  3.02936082e+03  6.64745631e+03  6.64745631e+03
  6.64745631e+03  9.13033201e+03  2.54820909e+04  7.62191413e+04]
E1 = -728.3687718742842  E_coul = 201.66224681686498
cycle= 4 E= -526.706525057419  delta_E= -8.13e-07  |g|= 6.07e-05  |ddm|= 0.00129
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000126646
diis-c [-1.24248580e-09  6.56596579e-05 -9.18995648e-03 -7.24143795e-02
  1.08153868e+00]
  HOMO = -0.574675749178182  LUMO = 1.06107144242451
  mo_energy =
[-1.18574741e+02 -1.23039302e+01 -9.55676045e+00 -9.55676045e+00
 -9.55676045e+00 -1.24907719e+00 -5.74675749e-01 -5.74675749e-01
 -5.74675749e-01  1.06107144e+00  1.06107144e+00  1.06107144e+00
  7.91914865e+00  7.91914865e+00  7.91914865e+00  9.73924855e+00
  3.63867404e+01  3.63867404e+01  3.63867404e+01  1.11141616e+02
  1.34911905e+02  1.34911905e+02  1.34911905e+02  4.89039602e+02
  4.89039602e+02  4.89039602e+02  6.21298887e+02  1.33832601e+03
  1.33832601e+03  1.33832601e+03  2.72006429e+03  3.02936080e+03
  3.02936080e+03  3.02936080e+03  6.64745627e+03  6.64745627e+03
  6.64745627e+03  9.13033196e+03  2.54820909e+04  7.62191413e+04]
E1 = -728.3687755183556  E_coul = 201.66225046081996
cycle= 5 E= -526.706525057536  delta_E= -1.16e-10  |g|= 7.6e-06  |ddm|= 2.46e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3687755183556  E_coul = 201.66225046081996
  HOMO = -0.574679119755363  LUMO = 1.06106887288668
  mo_energy =
[-1.18574758e+02 -1.23039421e+01 -9.55677294e+00 -9.55677294e+00
 -9.55677294e+00 -1.24908134e+00 -5.74679120e-01 -5.74679120e-01
 -5.74679120e-01  1.06106887e+00  1.06106887e+00  1.06106887e+00
  7.91914011e+00  7.91914011e+00  7.91914011e+00  9.73923888e+00
  3.63867279e+01  3.63867279e+01  3.63867279e+01  1.11141601e+02
  1.34911890e+02  1.34911890e+02  1.34911890e+02  4.89039585e+02
  4.89039585e+02  4.89039585e+02  6.21298870e+02  1.33832600e+03
  1.33832600e+03  1.33832600e+03  2.72006428e+03  3.02936078e+03
  3.02936078e+03  3.02936078e+03  6.64745626e+03  6.64745626e+03
  6.64745626e+03  9.13033194e+03  2.54820908e+04  7.62191413e+04]
E1 = -728.3688126586718  E_coul = 201.6622876011321
Extra cycle  E= -526.70652505754  delta_E= -4.09e-12  |g|= 2.23e-06  |ddm|= 3.88e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.22 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 101119.10701126339
E1 = -728.3688126586718  E_coul = 201.6622876011321
init E= -526.70652505754
    CPU time for initialize scf      3.76 sec, wall time      0.20 sec
  HOMO = -0.574678444072004  LUMO = 1.06106939447322
  mo_energy =
[-1.18574753e+02 -1.23039394e+01 -9.55677012e+00 -9.55677012e+00
 -9.55677012e+00 -1.24908049e+00 -5.74678444e-01 -5.74678444e-01
 -5.74678444e-01  1.06106939e+00  1.06106939e+00  1.06106939e+00
  7.91914192e+00  7.91914192e+00  7.91914192e+00  9.73924106e+00
  3.63867308e+01  3.63867308e+01  3.63867308e+01  1.11141604e+02
  1.34911894e+02  1.34911894e+02  1.34911894e+02  4.89039590e+02
  4.89039590e+02  4.89039590e+02  6.21298875e+02  1.33832600e+03
  1.33832600e+03  1.33832600e+03  2.72006428e+03  3.02936078e+03
  3.02936078e+03  3.02936078e+03  6.64745626e+03  6.64745626e+03
  6.64745626e+03  9.13033195e+03  2.54820908e+04  7.62191413e+04]
E1 = -728.3688038805184  E_coul = 201.6622788229788
cycle= 1 E= -526.70652505754  delta_E= 1.14e-13  |g|= 5.71e-07  |ddm|= 8.84e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3688038805184  E_coul = 201.6622788229788
  HOMO = -0.574678592595934  LUMO = 1.06106927908059
  mo_energy =
[-1.18574754e+02 -1.23039400e+01 -9.55677079e+00 -9.55677079e+00
 -9.55677079e+00 -1.24908067e+00 -5.74678593e-01 -5.74678593e-01
 -5.74678593e-01  1.06106928e+00  1.06106928e+00  1.06106928e+00
  7.91914151e+00  7.91914151e+00  7.91914151e+00  9.73924056e+00
  3.63867301e+01  3.63867301e+01  3.63867301e+01  1.11141604e+02
  1.34911893e+02  1.34911893e+02  1.34911893e+02  4.89039589e+02
  4.89039589e+02  4.89039589e+02  6.21298873e+02  1.33832600e+03
  1.33832600e+03  1.33832600e+03  2.72006428e+03  3.02936078e+03
  3.02936078e+03  3.02936078e+03  6.64745626e+03  6.64745626e+03
  6.64745626e+03  9.13033195e+03  2.54820908e+04  7.62191413e+04]
E1 = -728.3688060081313  E_coul = 201.66228095059228
Extra cycle  E= -526.706525057539  delta_E= 5.68e-13  |g|= 1.43e-07  |ddm|= 2.06e-07
    CPU time for scf_cycle      3.87 sec, wall time      0.31 sec
exp = [2.61827276e+04 7.61735415e+03 3.61741516e+03 1.59408584e+03
 3.95322021e+02 1.15704727e+02 3.77662872e+01 7.96956551e+00
 3.12419477e+00 3.98398470e-01 1.36280695e+03 6.64515660e+02
 2.99879328e+02 3.13109032e+02 6.17472756e+01 7.92111912e+00
 2.13482954e+01 7.96931256e-01 3.02541321e+00 2.28292534e-01]
grad_E = [-1.49311251e-06  3.04454563e-06 -1.84360059e-06  6.34780340e-05
 -1.74275473e-04  2.40147320e-05 -2.26263892e-06 -4.38051951e-05
  1.16749818e-04 -4.46144389e-04 -3.88840358e-07  6.50472310e-06
  3.26348387e-05  2.80831970e-05 -6.93016368e-04  5.60047285e-04
  1.73978296e-03 -2.61600961e-04  4.73582786e-04  1.97572490e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:00:22 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.7254417        1
[INPUT] 0    0    [1    /1   ]  7617.35916813        1
[INPUT] 0    0    [1    /1   ]  3617.41329589        1
[INPUT] 0    0    [1    /1   ]  1594.1985446         1
[INPUT] 0    0    [1    /1   ]  394.908310225        1
[INPUT] 0    0    [1    /1   ]  115.614300365        1
[INPUT] 0    0    [1    /1   ]  37.7494564251        1
[INPUT] 0    0    [1    /1   ]  7.96643764909        1
[INPUT] 0    0    [1    /1   ]  3.12357341606        1
[INPUT] 0    0    [1    /1   ]  0.398357628619       1
[INPUT] 1    0    [1    /1   ]  1362.80624723        1
[INPUT] 1    0    [1    /1   ]  664.522446856        1
[INPUT] 1    0    [1    /1   ]  299.91124558         1
[INPUT] 1    0    [1    /1   ]  313.13654425         1
[INPUT] 1    0    [1    /1   ]  61.7514554211        1
[INPUT] 1    0    [1    /1   ]  7.88093946379        1
[INPUT] 1    0    [1    /1   ]  21.3018451337        1
[INPUT] 1    0    [1    /1   ]  0.795740224555       1
[INPUT] 1    0    [1    /1   ]  3.01052110341        1
[INPUT] 1    0    [1    /1   ]  0.228100353988       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.725441694733, 1.0]], [0, [7617.359168130813, 1.0]], [0, [3617.413295889542, 1.0]], [0, [1594.1985446016213, 1.0]], [0, [394.9083102250167, 1.0]], [0, [115.61430036460361, 1.0]], [0, [37.74945642510719, 1.0]], [0, [7.9664376490871485, 1.0]], [0, [3.1235734160649864, 1.0]], [0, [0.39835762861859114, 1.0]], [1, [1362.8062472302765, 1.0]], [1, [664.5224468562966, 1.0]], [1, [299.9112455798273, 1.0]], [1, [313.13654425046894, 1.0]], [1, [61.75145542114408, 1.0]], [1, [7.880939463785324, 1.0]], [1, [21.301845133721837, 1.0]], [1, [0.7957402245553153, 1.0]], [1, [3.0105211034135304, 1.0]], [1, [0.2281003539883799, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.72544169]
bas 1, expnt(s) = [7617.35916813]
bas 2, expnt(s) = [3617.41329589]
bas 3, expnt(s) = [1594.1985446]
bas 4, expnt(s) = [394.90831023]
bas 5, expnt(s) = [115.61430036]
bas 6, expnt(s) = [37.74945643]
bas 7, expnt(s) = [7.96643765]
bas 8, expnt(s) = [3.12357342]
bas 9, expnt(s) = [0.39835763]
bas 10, expnt(s) = [1362.80624723]
bas 11, expnt(s) = [664.52244686]
bas 12, expnt(s) = [299.91124558]
bas 13, expnt(s) = [313.13654425]
bas 14, expnt(s) = [61.75145542]
bas 15, expnt(s) = [7.88093946]
bas 16, expnt(s) = [21.30184513]
bas 17, expnt(s) = [0.79574022]
bas 18, expnt(s) = [3.0105211]
bas 19, expnt(s) = [0.22810035]
CPU time:      1444.35
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61827254e+04 5.20027323e+03 7.61735917e+03 2.06000536e+03
 3.61741330e+03 1.17845668e+03 1.59419854e+03 6.37414341e+02
 3.94908310e+02 2.23813990e+02 1.15614300e+02 8.90786632e+01
 3.77494564e+01 3.84767207e+01 7.96643765e+00 1.19801745e+01
 3.12357342e+00 5.93613560e+00 3.98357629e-01 1.26683449e+00
 1.36280625e+03 2.41561121e+04 6.64522447e+02 9.84286349e+03
 2.99911246e+02 3.64103900e+03 3.13136544e+02 3.84283366e+03
 6.17514554e+01 5.05002339e+02 7.88093946e+00 3.85218275e+01
 2.13018451e+01 1.33507579e+02 7.95740225e-01 2.19254509e+00
 3.01052110e+00 1.15687514e+01 2.28100354e-01 4.59877161e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982117012852864
cond(S) = 101135.4831099387
E1 = -729.3788777762708  E_coul = 203.12214546198712
init E= -526.256732314284
    CPU time for initialize scf      0.67 sec, wall time      0.05 sec
  HOMO = -0.556732526968038  LUMO = 1.0709479638932
  mo_energy =
[-1.18334048e+02 -1.22079243e+01 -9.45156738e+00 -9.45156738e+00
 -9.45156738e+00 -1.22596789e+00 -5.56732527e-01 -5.56732527e-01
 -5.56732527e-01  1.07094796e+00  1.07094796e+00  1.07094796e+00
  7.93831465e+00  7.93831465e+00  7.93831465e+00  9.80124911e+00
  3.63165005e+01  3.63165005e+01  3.63165005e+01  1.11222545e+02
  1.34769234e+02  1.34769234e+02  1.34769234e+02  4.88990347e+02
  4.88990347e+02  4.88990347e+02  6.20990953e+02  1.33842173e+03
  1.33842173e+03  1.33842173e+03  2.71907028e+03  3.02962441e+03
  3.02962441e+03  3.02962441e+03  6.64790942e+03  6.64790942e+03
  6.64790942e+03  9.12926701e+03  2.54812036e+04  7.62184698e+04]
E1 = -728.0004804119619  E_coul = 201.29454573579744
cycle= 1 E= -526.705934676164  delta_E= -0.449  |g|= 0.183  |ddm|= 0.455
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.540478
diis-c [-0.29211627  1.        ]
  HOMO = -0.580422963543341  LUMO = 1.05470841832251
  mo_energy =
[-1.18625343e+02 -1.23303878e+01 -9.58422724e+00 -9.58422724e+00
 -9.58422724e+00 -1.25639110e+00 -5.80422964e-01 -5.80422964e-01
 -5.80422964e-01  1.05470842e+00  1.05470842e+00  1.05470842e+00
  7.85964036e+00  7.85964036e+00  7.85964036e+00  9.71247811e+00
  3.61747250e+01  3.61747250e+01  3.61747250e+01  1.11013282e+02
  1.34557008e+02  1.34557008e+02  1.34557008e+02  4.88701038e+02
  4.88701038e+02  4.88701038e+02  6.20659533e+02  1.33807646e+03
  1.33807646e+03  1.33807646e+03  2.71859091e+03  3.02921342e+03
  3.02921342e+03  3.02921342e+03  6.64738583e+03  6.64738583e+03
  6.64738583e+03  9.12866894e+03  2.54805116e+04  7.62176879e+04]
E1 = -728.4577169941667  E_coul = 201.751199226194
cycle= 2 E= -526.706517767973  delta_E= -0.000583  |g|= 0.0332  |ddm|= 0.0387
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.066717
diis-c [-0.00266522  0.0728292   0.9271708 ]
  HOMO = -0.573820618403982  LUMO = 1.05990561583174
  mo_energy =
[-1.18567275e+02 -1.22999814e+01 -9.55252854e+00 -9.55252854e+00
 -9.55252854e+00 -1.24800916e+00 -5.73820618e-01 -5.73820618e-01
 -5.73820618e-01  1.05990562e+00  1.05990562e+00  1.05990562e+00
  7.87871166e+00  7.87871166e+00  7.87871166e+00  9.73647723e+00
  3.62078269e+01  3.62078269e+01  3.62078269e+01  1.11061125e+02
  1.34604058e+02  1.34604058e+02  1.34604058e+02  4.88758286e+02
  4.88758286e+02  4.88758286e+02  6.20719334e+02  1.33813753e+03
  1.33813753e+03  1.33813753e+03  2.71865504e+03  3.02927657e+03
  3.02927657e+03  3.02927657e+03  6.64745053e+03  6.64745053e+03
  6.64745053e+03  9.12873435e+03  2.54805775e+04  7.62177540e+04]
E1 = -728.3546534009209  E_coul = 201.64810186558816
cycle= 3 E= -526.706551535333  delta_E= -3.38e-05  |g|= 0.00477  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104266
diis-c [-4.48378440e-07 -1.11430247e-03  1.30546179e-01  8.70568123e-01]
  HOMO = -0.574721486119492  LUMO = 1.05920769710527
  mo_energy =
[-1.18574745e+02 -1.23039581e+01 -9.55677711e+00 -9.55677711e+00
 -9.55677711e+00 -1.24910050e+00 -5.74721486e-01 -5.74721486e-01
 -5.74721486e-01  1.05920770e+00  1.05920770e+00  1.05920770e+00
  7.87613420e+00  7.87613420e+00  7.87613420e+00  9.73342813e+00
  3.62034288e+01  3.62034288e+01  3.62034288e+01  1.11054976e+02
  1.34597953e+02  1.34597953e+02  1.34597953e+02  4.88750921e+02
  4.88750921e+02  4.88750921e+02  6.20711608e+02  1.33812964e+03
  1.33812964e+03  1.33812964e+03  2.71864658e+03  3.02926834e+03
  3.02926834e+03  3.02926834e+03  6.64744194e+03  6.64744194e+03
  6.64744194e+03  9.12872558e+03  2.54805686e+04  7.62177450e+04]
E1 = -728.3685872470875  E_coul = 201.66203489697168
cycle= 4 E= -526.706552350116  delta_E= -8.15e-07  |g|= 6.08e-05  |ddm|= 0.00129
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000126587
diis-c [-1.25393185e-09  6.56588643e-05 -9.18699378e-03 -7.23497137e-02
  1.08147105e+00]
  HOMO = -0.574709736528039  LUMO = 1.05921672084685
  mo_energy =
[-1.18574751e+02 -1.23039305e+01 -9.55676132e+00 -9.55676132e+00
 -9.55676132e+00 -1.24908166e+00 -5.74709737e-01 -5.74709737e-01
 -5.74709737e-01  1.05921672e+00  1.05921672e+00  1.05921672e+00
  7.87615387e+00  7.87615387e+00  7.87615387e+00  9.73346285e+00
  3.62034431e+01  3.62034431e+01  3.62034431e+01  1.11054985e+02
  1.34597959e+02  1.34597959e+02  1.34597959e+02  4.88750915e+02
  4.88750915e+02  4.88750915e+02  6.20711595e+02  1.33812963e+03
  1.33812963e+03  1.33812963e+03  2.71864655e+03  3.02926832e+03
  3.02926832e+03  3.02926832e+03  6.64744191e+03  6.64744191e+03
  6.64744191e+03  9.12872553e+03  2.54805685e+04  7.62177449e+04]
E1 = -728.3685903461648  E_coul = 201.6620379959303
cycle= 5 E= -526.706552350234  delta_E= -1.19e-10  |g|= 7.64e-06  |ddm|= 2.46e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3685903461648  E_coul = 201.6620379959303
  HOMO = -0.5747131212505  LUMO = 1.05921414617159
  mo_energy =
[-1.18574768e+02 -1.23039424e+01 -9.55677386e+00 -9.55677386e+00
 -9.55677386e+00 -1.24908582e+00 -5.74713121e-01 -5.74713121e-01
 -5.74713121e-01  1.05921415e+00  1.05921415e+00  1.05921415e+00
  7.87614532e+00  7.87614532e+00  7.87614532e+00  9.73345315e+00
  3.62034306e+01  3.62034306e+01  3.62034306e+01  1.11054970e+02
  1.34597944e+02  1.34597944e+02  1.34597944e+02  4.88750898e+02
  4.88750898e+02  4.88750898e+02  6.20711578e+02  1.33812961e+03
  1.33812961e+03  1.33812961e+03  2.71864653e+03  3.02926830e+03
  3.02926830e+03  3.02926830e+03  6.64744189e+03  6.64744189e+03
  6.64744189e+03  9.12872551e+03  2.54805685e+04  7.62177449e+04]
E1 = -728.3686276669591  E_coul = 201.6620753167223
Extra cycle  E= -526.706552350237  delta_E= -2.39e-12  |g|= 2.24e-06  |ddm|= 3.9e-06
    CPU time for scf_cycle      0.86 sec, wall time      0.23 sec
exp = [2.61827254e+04 7.61735917e+03 3.61741330e+03 1.59419854e+03
 3.94908310e+02 1.15614300e+02 3.77494564e+01 7.96643765e+00
 3.12357342e+00 3.98357629e-01 1.36280625e+03 6.64522447e+02
 2.99911246e+02 3.13136544e+02 6.17514554e+01 7.88093946e+00
 2.13018451e+01 7.95740225e-01 3.01052110e+00 2.28100354e-01]
E = -526.7065523502368
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:00:22 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.7254417        1
[INPUT] 0    0    [1    /1   ]  7617.35916813        1
[INPUT] 0    0    [1    /1   ]  3617.41329589        1
[INPUT] 0    0    [1    /1   ]  1594.1985446         1
[INPUT] 0    0    [1    /1   ]  394.908310225        1
[INPUT] 0    0    [1    /1   ]  115.614300365        1
[INPUT] 0    0    [1    /1   ]  37.7494564251        1
[INPUT] 0    0    [1    /1   ]  7.96643764909        1
[INPUT] 0    0    [1    /1   ]  3.12357341606        1
[INPUT] 0    0    [1    /1   ]  0.398357628619       1
[INPUT] 1    0    [1    /1   ]  1362.80624723        1
[INPUT] 1    0    [1    /1   ]  664.522446856        1
[INPUT] 1    0    [1    /1   ]  299.91124558         1
[INPUT] 1    0    [1    /1   ]  313.13654425         1
[INPUT] 1    0    [1    /1   ]  61.7514554211        1
[INPUT] 1    0    [1    /1   ]  7.88093946379        1
[INPUT] 1    0    [1    /1   ]  21.3018451337        1
[INPUT] 1    0    [1    /1   ]  0.795740224555       1
[INPUT] 1    0    [1    /1   ]  3.01052110341        1
[INPUT] 1    0    [1    /1   ]  0.228100353988       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.725441694733, 1.0]], [0, [7617.359168130813, 1.0]], [0, [3617.413295889542, 1.0]], [0, [1594.1985446016213, 1.0]], [0, [394.9083102250167, 1.0]], [0, [115.61430036460361, 1.0]], [0, [37.74945642510719, 1.0]], [0, [7.9664376490871485, 1.0]], [0, [3.1235734160649864, 1.0]], [0, [0.39835762861859114, 1.0]], [1, [1362.8062472302765, 1.0]], [1, [664.5224468562966, 1.0]], [1, [299.9112455798273, 1.0]], [1, [313.13654425046894, 1.0]], [1, [61.75145542114408, 1.0]], [1, [7.880939463785324, 1.0]], [1, [21.301845133721837, 1.0]], [1, [0.7957402245553153, 1.0]], [1, [3.0105211034135304, 1.0]], [1, [0.2281003539883799, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.72544169]
bas 1, expnt(s) = [7617.35916813]
bas 2, expnt(s) = [3617.41329589]
bas 3, expnt(s) = [1594.1985446]
bas 4, expnt(s) = [394.90831023]
bas 5, expnt(s) = [115.61430036]
bas 6, expnt(s) = [37.74945643]
bas 7, expnt(s) = [7.96643765]
bas 8, expnt(s) = [3.12357342]
bas 9, expnt(s) = [0.39835763]
bas 10, expnt(s) = [1362.80624723]
bas 11, expnt(s) = [664.52244686]
bas 12, expnt(s) = [299.91124558]
bas 13, expnt(s) = [313.13654425]
bas 14, expnt(s) = [61.75145542]
bas 15, expnt(s) = [7.88093946]
bas 16, expnt(s) = [21.30184513]
bas 17, expnt(s) = [0.79574022]
bas 18, expnt(s) = [3.0105211]
bas 19, expnt(s) = [0.22810035]
CPU time:      1445.42
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61827254e+04 5.20027323e+03 7.61735917e+03 2.06000536e+03
 3.61741330e+03 1.17845668e+03 1.59419854e+03 6.37414341e+02
 3.94908310e+02 2.23813990e+02 1.15614300e+02 8.90786632e+01
 3.77494564e+01 3.84767207e+01 7.96643765e+00 1.19801745e+01
 3.12357342e+00 5.93613560e+00 3.98357629e-01 1.26683449e+00
 1.36280625e+03 2.41561121e+04 6.64522447e+02 9.84286349e+03
 2.99911246e+02 3.64103900e+03 3.13136544e+02 3.84283366e+03
 6.17514554e+01 5.05002339e+02 7.88093946e+00 3.85218275e+01
 2.13018451e+01 1.33507579e+02 7.95740225e-01 2.19254509e+00
 3.01052110e+00 1.15687514e+01 2.28100354e-01 4.59877161e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982117012852864
cond(S) = 101135.4831099387
E1 = -729.3788777762708  E_coul = 203.12214546198712
init E= -526.256732314284
    CPU time for initialize scf      0.62 sec, wall time      0.05 sec
  HOMO = -0.556732526968038  LUMO = 1.0709479638932
  mo_energy =
[-1.18334048e+02 -1.22079243e+01 -9.45156738e+00 -9.45156738e+00
 -9.45156738e+00 -1.22596789e+00 -5.56732527e-01 -5.56732527e-01
 -5.56732527e-01  1.07094796e+00  1.07094796e+00  1.07094796e+00
  7.93831465e+00  7.93831465e+00  7.93831465e+00  9.80124911e+00
  3.63165005e+01  3.63165005e+01  3.63165005e+01  1.11222545e+02
  1.34769234e+02  1.34769234e+02  1.34769234e+02  4.88990347e+02
  4.88990347e+02  4.88990347e+02  6.20990953e+02  1.33842173e+03
  1.33842173e+03  1.33842173e+03  2.71907028e+03  3.02962441e+03
  3.02962441e+03  3.02962441e+03  6.64790942e+03  6.64790942e+03
  6.64790942e+03  9.12926701e+03  2.54812036e+04  7.62184698e+04]
E1 = -728.0004804119619  E_coul = 201.29454573579744
cycle= 1 E= -526.705934676164  delta_E= -0.449  |g|= 0.183  |ddm|= 0.455
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.540478
diis-c [-0.29211627  1.        ]
  HOMO = -0.580422963543341  LUMO = 1.05470841832251
  mo_energy =
[-1.18625343e+02 -1.23303878e+01 -9.58422724e+00 -9.58422724e+00
 -9.58422724e+00 -1.25639110e+00 -5.80422964e-01 -5.80422964e-01
 -5.80422964e-01  1.05470842e+00  1.05470842e+00  1.05470842e+00
  7.85964036e+00  7.85964036e+00  7.85964036e+00  9.71247811e+00
  3.61747250e+01  3.61747250e+01  3.61747250e+01  1.11013282e+02
  1.34557008e+02  1.34557008e+02  1.34557008e+02  4.88701038e+02
  4.88701038e+02  4.88701038e+02  6.20659533e+02  1.33807646e+03
  1.33807646e+03  1.33807646e+03  2.71859091e+03  3.02921342e+03
  3.02921342e+03  3.02921342e+03  6.64738583e+03  6.64738583e+03
  6.64738583e+03  9.12866894e+03  2.54805116e+04  7.62176879e+04]
E1 = -728.4577169941667  E_coul = 201.751199226194
cycle= 2 E= -526.706517767973  delta_E= -0.000583  |g|= 0.0332  |ddm|= 0.0387
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.066717
diis-c [-0.00266522  0.0728292   0.9271708 ]
  HOMO = -0.573820618403982  LUMO = 1.05990561583174
  mo_energy =
[-1.18567275e+02 -1.22999814e+01 -9.55252854e+00 -9.55252854e+00
 -9.55252854e+00 -1.24800916e+00 -5.73820618e-01 -5.73820618e-01
 -5.73820618e-01  1.05990562e+00  1.05990562e+00  1.05990562e+00
  7.87871166e+00  7.87871166e+00  7.87871166e+00  9.73647723e+00
  3.62078269e+01  3.62078269e+01  3.62078269e+01  1.11061125e+02
  1.34604058e+02  1.34604058e+02  1.34604058e+02  4.88758286e+02
  4.88758286e+02  4.88758286e+02  6.20719334e+02  1.33813753e+03
  1.33813753e+03  1.33813753e+03  2.71865504e+03  3.02927657e+03
  3.02927657e+03  3.02927657e+03  6.64745053e+03  6.64745053e+03
  6.64745053e+03  9.12873435e+03  2.54805775e+04  7.62177540e+04]
E1 = -728.3546534009209  E_coul = 201.64810186558816
cycle= 3 E= -526.706551535333  delta_E= -3.38e-05  |g|= 0.00477  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104266
diis-c [-4.48378440e-07 -1.11430247e-03  1.30546179e-01  8.70568123e-01]
  HOMO = -0.574721486119492  LUMO = 1.05920769710527
  mo_energy =
[-1.18574745e+02 -1.23039581e+01 -9.55677711e+00 -9.55677711e+00
 -9.55677711e+00 -1.24910050e+00 -5.74721486e-01 -5.74721486e-01
 -5.74721486e-01  1.05920770e+00  1.05920770e+00  1.05920770e+00
  7.87613420e+00  7.87613420e+00  7.87613420e+00  9.73342813e+00
  3.62034288e+01  3.62034288e+01  3.62034288e+01  1.11054976e+02
  1.34597953e+02  1.34597953e+02  1.34597953e+02  4.88750921e+02
  4.88750921e+02  4.88750921e+02  6.20711608e+02  1.33812964e+03
  1.33812964e+03  1.33812964e+03  2.71864658e+03  3.02926834e+03
  3.02926834e+03  3.02926834e+03  6.64744194e+03  6.64744194e+03
  6.64744194e+03  9.12872558e+03  2.54805686e+04  7.62177450e+04]
E1 = -728.3685872470875  E_coul = 201.66203489697168
cycle= 4 E= -526.706552350116  delta_E= -8.15e-07  |g|= 6.08e-05  |ddm|= 0.00129
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000126587
diis-c [-1.25393185e-09  6.56588643e-05 -9.18699378e-03 -7.23497137e-02
  1.08147105e+00]
  HOMO = -0.574709736528039  LUMO = 1.05921672084685
  mo_energy =
[-1.18574751e+02 -1.23039305e+01 -9.55676132e+00 -9.55676132e+00
 -9.55676132e+00 -1.24908166e+00 -5.74709737e-01 -5.74709737e-01
 -5.74709737e-01  1.05921672e+00  1.05921672e+00  1.05921672e+00
  7.87615387e+00  7.87615387e+00  7.87615387e+00  9.73346285e+00
  3.62034431e+01  3.62034431e+01  3.62034431e+01  1.11054985e+02
  1.34597959e+02  1.34597959e+02  1.34597959e+02  4.88750915e+02
  4.88750915e+02  4.88750915e+02  6.20711595e+02  1.33812963e+03
  1.33812963e+03  1.33812963e+03  2.71864655e+03  3.02926832e+03
  3.02926832e+03  3.02926832e+03  6.64744191e+03  6.64744191e+03
  6.64744191e+03  9.12872553e+03  2.54805685e+04  7.62177449e+04]
E1 = -728.3685903461648  E_coul = 201.6620379959303
cycle= 5 E= -526.706552350234  delta_E= -1.19e-10  |g|= 7.64e-06  |ddm|= 2.46e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3685903461648  E_coul = 201.6620379959303
  HOMO = -0.5747131212505  LUMO = 1.05921414617159
  mo_energy =
[-1.18574768e+02 -1.23039424e+01 -9.55677386e+00 -9.55677386e+00
 -9.55677386e+00 -1.24908582e+00 -5.74713121e-01 -5.74713121e-01
 -5.74713121e-01  1.05921415e+00  1.05921415e+00  1.05921415e+00
  7.87614532e+00  7.87614532e+00  7.87614532e+00  9.73345315e+00
  3.62034306e+01  3.62034306e+01  3.62034306e+01  1.11054970e+02
  1.34597944e+02  1.34597944e+02  1.34597944e+02  4.88750898e+02
  4.88750898e+02  4.88750898e+02  6.20711578e+02  1.33812961e+03
  1.33812961e+03  1.33812961e+03  2.71864653e+03  3.02926830e+03
  3.02926830e+03  3.02926830e+03  6.64744189e+03  6.64744189e+03
  6.64744189e+03  9.12872551e+03  2.54805685e+04  7.62177449e+04]
E1 = -728.3686276669591  E_coul = 201.6620753167223
Extra cycle  E= -526.706552350237  delta_E= -2.39e-12  |g|= 2.24e-06  |ddm|= 3.9e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.22 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 101135.4831099387
E1 = -728.3686276669591  E_coul = 201.6620753167223
init E= -526.706552350237
    CPU time for initialize scf      3.88 sec, wall time      0.21 sec
  HOMO = -0.57471244215868  LUMO = 1.0592146692301
  mo_energy =
[-1.18574763e+02 -1.23039397e+01 -9.55677103e+00 -9.55677103e+00
 -9.55677103e+00 -1.24908497e+00 -5.74712442e-01 -5.74712442e-01
 -5.74712442e-01  1.05921467e+00  1.05921467e+00  1.05921467e+00
  7.87614714e+00  7.87614714e+00  7.87614714e+00  9.73345533e+00
  3.62034335e+01  3.62034335e+01  3.62034335e+01  1.11054974e+02
  1.34597948e+02  1.34597948e+02  1.34597948e+02  4.88750903e+02
  4.88750903e+02  4.88750903e+02  6.20711583e+02  1.33812962e+03
  1.33812962e+03  1.33812962e+03  2.71864653e+03  3.02926830e+03
  3.02926830e+03  3.02926830e+03  6.64744189e+03  6.64744189e+03
  6.64744189e+03  9.12872552e+03  2.54805685e+04  7.62177449e+04]
E1 = -728.3686188430551  E_coul = 201.66206649281767
cycle= 1 E= -526.706552350237  delta_E= -5.68e-13  |g|= 5.74e-07  |ddm|= 8.89e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3686188430551  E_coul = 201.66206649281767
  HOMO = -0.574712591481273  LUMO = 1.05921455347912
  mo_energy =
[-1.18574765e+02 -1.23039403e+01 -9.55677169e+00 -9.55677169e+00
 -9.55677169e+00 -1.24908516e+00 -5.74712591e-01 -5.74712591e-01
 -5.74712591e-01  1.05921455e+00  1.05921455e+00  1.05921455e+00
  7.87614672e+00  7.87614672e+00  7.87614672e+00  9.73345483e+00
  3.62034328e+01  3.62034328e+01  3.62034328e+01  1.11054973e+02
  1.34597947e+02  1.34597947e+02  1.34597947e+02  4.88750902e+02
  4.88750902e+02  4.88750902e+02  6.20711581e+02  1.33812962e+03
  1.33812962e+03  1.33812962e+03  2.71864653e+03  3.02926830e+03
  3.02926830e+03  3.02926830e+03  6.64744189e+03  6.64744189e+03
  6.64744189e+03  9.12872552e+03  2.54805685e+04  7.62177449e+04]
E1 = -728.3686209825859  E_coul = 201.66206863234808
Extra cycle  E= -526.706552350238  delta_E= -3.41e-13  |g|= 1.43e-07  |ddm|= 2.07e-07
    CPU time for scf_cycle      3.99 sec, wall time      0.32 sec
exp = [2.61827254e+04 7.61735917e+03 3.61741330e+03 1.59419854e+03
 3.94908310e+02 1.15614300e+02 3.77494564e+01 7.96643765e+00
 3.12357342e+00 3.98357629e-01 1.36280625e+03 6.64522447e+02
 2.99911246e+02 3.13136544e+02 6.17514554e+01 7.88093946e+00
 2.13018451e+01 7.95740225e-01 3.01052110e+00 2.28100354e-01]
grad_E = [-1.49526121e-06  3.06686840e-06 -1.83038228e-06  6.41833797e-05
 -1.81583856e-04  3.68870944e-05 -1.51375653e-05 -7.56504297e-05
  2.06726399e-04 -8.73843769e-04 -3.90037058e-07  6.49107260e-06
  3.25605908e-05  2.80196042e-05 -7.01365220e-04 -1.38985302e-04
  1.93953035e-03 -1.39722696e-04  9.17606387e-04  3.07874802e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:00:26 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.7230605        1
[INPUT] 0    0    [1    /1   ]  7617.36479639        1
[INPUT] 0    0    [1    /1   ]  3617.41121464        1
[INPUT] 0    0    [1    /1   ]  1594.32499148        1
[INPUT] 0    0    [1    /1   ]  394.442020758        1
[INPUT] 0    0    [1    /1   ]  115.516227684        1
[INPUT] 0    0    [1    /1   ]  37.7319118242        1
[INPUT] 0    0    [1    /1   ]  7.96275016715        1
[INPUT] 0    0    [1    /1   ]  3.12289631016        1
[INPUT] 0    0    [1    /1   ]  0.398296873751       1
[INPUT] 1    0    [1    /1   ]  1362.80545706        1
[INPUT] 1    0    [1    /1   ]  664.530014715        1
[INPUT] 1    0    [1    /1   ]  299.946806169        1
[INPUT] 1    0    [1    /1   ]  313.167197636        1
[INPUT] 1    0    [1    /1   ]  61.7668500034        1
[INPUT] 1    0    [1    /1   ]  7.81802546443        1
[INPUT] 1    0    [1    /1   ]  21.2252608575        1
[INPUT] 1    0    [1    /1   ]  0.793849359245       1
[INPUT] 1    0    [1    /1   ]  2.98735435017        1
[INPUT] 1    0    [1    /1   ]  0.227790926366       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.72306054999, 1.0]], [0, [7617.3647963878, 1.0]], [0, [3617.4112146368734, 1.0]], [0, [1594.3249914832952, 1.0]], [0, [394.442020758048, 1.0]], [0, [115.5162276839512, 1.0]], [0, [37.731911824239845, 1.0]], [0, [7.962750167152189, 1.0]], [0, [3.1228963101628415, 1.0]], [0, [0.3982968737510683, 1.0]], [1, [1362.8054570640923, 1.0]], [1, [664.5300147148125, 1.0]], [1, [299.9468061691582, 1.0]], [1, [313.1671976355594, 1.0]], [1, [61.76685000338588, 1.0]], [1, [7.8180254644311376, 1.0]], [1, [21.22526085750368, 1.0]], [1, [0.7938493592445619, 1.0]], [1, [2.9873543501742015, 1.0]], [1, [0.22779092636604997, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.72306055]
bas 1, expnt(s) = [7617.36479639]
bas 2, expnt(s) = [3617.41121464]
bas 3, expnt(s) = [1594.32499148]
bas 4, expnt(s) = [394.44202076]
bas 5, expnt(s) = [115.51622768]
bas 6, expnt(s) = [37.73191182]
bas 7, expnt(s) = [7.96275017]
bas 8, expnt(s) = [3.12289631]
bas 9, expnt(s) = [0.39829687]
bas 10, expnt(s) = [1362.80545706]
bas 11, expnt(s) = [664.53001471]
bas 12, expnt(s) = [299.94680617]
bas 13, expnt(s) = [313.16719764]
bas 14, expnt(s) = [61.76685]
bas 15, expnt(s) = [7.81802546]
bas 16, expnt(s) = [21.22526086]
bas 17, expnt(s) = [0.79384936]
bas 18, expnt(s) = [2.98735435]
bas 19, expnt(s) = [0.22779093]
CPU time:      1455.13
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61827231e+04 5.20027288e+03 7.61736480e+03 2.06000650e+03
 3.61741121e+03 1.17845617e+03 1.59432499e+03 6.37452259e+02
 3.94442021e+02 2.23615758e+02 1.15516228e+02 8.90219848e+01
 3.77319118e+01 3.84633080e+01 7.96275017e+00 1.19760153e+01
 3.12289631e+00 5.93517048e+00 3.98296874e-01 1.26668958e+00
 1.36280546e+03 2.41560946e+04 6.64530015e+02 9.84300361e+03
 2.99946806e+02 3.64157866e+03 3.13167198e+02 3.84330389e+03
 6.17668500e+01 5.05159715e+02 7.81802546e+00 3.81378093e+01
 2.12252609e+01 1.32907867e+02 7.93849359e-01 2.18603452e+00
 2.98735435e+00 1.14575779e+01 2.27790926e-01 4.59097490e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98219301121998
cond(S) = 101124.43160806548
E1 = -729.3786300421335  E_coul = 203.12176717739666
init E= -526.256862864737
    CPU time for initialize scf      0.67 sec, wall time      0.05 sec
  HOMO = -0.556769968999229  LUMO = 1.06795226382502
  mo_energy =
[-1.18334036e+02 -1.22079577e+01 -9.45159514e+00 -9.45159514e+00
 -9.45159514e+00 -1.22597194e+00 -5.56769969e-01 -5.56769969e-01
 -5.56769969e-01  1.06795226e+00  1.06795226e+00  1.06795226e+00
  7.87100597e+00  7.87100597e+00  7.87100597e+00  9.79453169e+00
  3.60270111e+01  3.60270111e+01  3.60270111e+01  1.11128676e+02
  1.34275737e+02  1.34275737e+02  1.34275737e+02  4.88541430e+02
  4.88541430e+02  4.88541430e+02  6.20343133e+02  1.33809418e+03
  1.33809418e+03  1.33809418e+03  2.71748997e+03  3.02942254e+03
  3.02942254e+03  3.02942254e+03  6.64780411e+03  6.64780411e+03
  6.64780411e+03  9.12747344e+03  2.54795037e+04  7.62169106e+04]
E1 = -727.9998484114512  E_coul = 201.2938493487903
cycle= 1 E= -526.705999062661  delta_E= -0.449  |g|= 0.183  |ddm|= 0.456
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.540545
diis-c [-0.29218937  1.        ]
  HOMO = -0.580482559519915  LUMO = 1.0517656205698
  mo_energy =
[-1.18625414e+02 -1.23304172e+01 -9.58425599e+00 -9.58425599e+00
 -9.58425599e+00 -1.25640628e+00 -5.80482560e-01 -5.80482560e-01
 -5.80482560e-01  1.05176562e+00  1.05176562e+00  1.05176562e+00
  7.79278984e+00  7.79278984e+00  7.79278984e+00  9.70580828e+00
  3.58855185e+01  3.58855185e+01  3.58855185e+01  1.10919408e+02
  1.34063446e+02  1.34063446e+02  1.34063446e+02  4.88251989e+02
  4.88251989e+02  4.88251989e+02  6.20011730e+02  1.33774879e+03
  1.33774879e+03  1.33774879e+03  2.71701053e+03  3.02901146e+03
  3.02901146e+03  3.02901146e+03  6.64728041e+03  6.64728041e+03
  6.64728041e+03  9.12687525e+03  2.54788116e+04  7.62161286e+04]
E1 = -728.4575073015743  E_coul = 201.7509243418307
cycle= 2 E= -526.706582959744  delta_E= -0.000584  |g|= 0.0332  |ddm|= 0.0387
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.06673
diis-c [-0.00266684  0.07282289  0.92717711]
  HOMO = -0.573874151799043  LUMO = 1.05694892206997
  mo_energy =
[-1.18567295e+02 -1.22999812e+01 -9.55252696e+00 -9.55252696e+00
 -9.55252696e+00 -1.24801694e+00 -5.73874152e-01 -5.73874152e-01
 -5.73874152e-01  1.05694892e+00  1.05694892e+00  1.05694892e+00
  7.81177959e+00  7.81177959e+00  7.81177959e+00  9.72982453e+00
  3.59185842e+01  3.59185842e+01  3.59185842e+01  1.10967284e+02
  1.34110539e+02  1.34110539e+02  1.34110539e+02  4.88309295e+02
  4.88309295e+02  4.88309295e+02  6.20071578e+02  1.33780992e+03
  1.33780992e+03  1.33780992e+03  2.71707471e+03  3.02907466e+03
  3.02907466e+03  3.02907466e+03  6.64734517e+03  6.64734517e+03
  6.64734517e+03  9.12694071e+03  2.54788776e+04  7.62161948e+04]
E1 = -728.3542888027076  E_coul = 201.64767200143888
cycle= 3 E= -526.706616801269  delta_E= -3.38e-05  |g|= 0.00478  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104351
diis-c [-4.50041014e-07 -1.11543969e-03  1.30616168e-01  8.70499272e-01]
  HOMO = -0.5747770291695  LUMO = 1.05625200701832
  mo_energy =
[-1.18574777e+02 -1.23039651e+01 -9.55678304e+00 -9.55678304e+00
 -9.55678304e+00 -1.24911058e+00 -5.74777029e-01 -5.74777029e-01
 -5.74777029e-01  1.05625201e+00  1.05625201e+00  1.05625201e+00
  7.80921058e+00  7.80921058e+00  7.80921058e+00  9.72677062e+00
  3.59141869e+01  3.59141869e+01  3.59141869e+01  1.10961126e+02
  1.34104424e+02  1.34104424e+02  1.34104424e+02  4.88301917e+02
  4.88301917e+02  4.88301917e+02  6.20063841e+02  1.33780202e+03
  1.33780202e+03  1.33780202e+03  2.71706624e+03  3.02906642e+03
  3.02906642e+03  3.02906642e+03  6.64733657e+03  6.64733657e+03
  6.64733657e+03  9.12693192e+03  2.54788686e+04  7.62161857e+04]
E1 = -728.3682550407797  E_coul = 201.66163742153637
cycle= 4 E= -526.706617619243  delta_E= -8.18e-07  |g|= 6.09e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000126499
diis-c [-1.27153073e-09  6.56516160e-05 -9.18194862e-03 -7.22478762e-02
  1.08136417e+00]
  HOMO = -0.57476516915573  LUMO = 1.05626109024412
  mo_energy =
[-1.18574783e+02 -1.23039372e+01 -9.55676690e+00 -9.55676690e+00
 -9.55676690e+00 -1.24909160e+00 -5.74765169e-01 -5.74765169e-01
 -5.74765169e-01  1.05626109e+00  1.05626109e+00  1.05626109e+00
  7.80923051e+00  7.80923051e+00  7.80923051e+00  9.72680567e+00
  3.59142016e+01  3.59142016e+01  3.59142016e+01  1.10961136e+02
  1.34104431e+02  1.34104431e+02  1.34104431e+02  4.88301912e+02
  4.88301912e+02  4.88301912e+02  6.20063828e+02  1.33780201e+03
  1.33780201e+03  1.33780201e+03  2.71706621e+03  3.02906640e+03
  3.02906640e+03  3.02906640e+03  6.64733653e+03  6.64733653e+03
  6.64733653e+03  9.12693188e+03  2.54788686e+04  7.62161856e+04]
E1 = -728.3682573227516  E_coul = 201.66163970339173
cycle= 5 E= -526.70661761936  delta_E= -1.17e-10  |g|= 7.69e-06  |ddm|= 2.48e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3682573227516  E_coul = 201.66163970339173
  HOMO = -0.574768575307164  LUMO = 1.05625850826472
  mo_energy =
[-1.18574800e+02 -1.23039492e+01 -9.55677953e+00 -9.55677953e+00
 -9.55677953e+00 -1.24909578e+00 -5.74768575e-01 -5.74768575e-01
 -5.74768575e-01  1.05625851e+00  1.05625851e+00  1.05625851e+00
  7.80922194e+00  7.80922194e+00  7.80922194e+00  9.72679590e+00
  3.59141890e+01  3.59141890e+01  3.59141890e+01  1.10961121e+02
  1.34104415e+02  1.34104415e+02  1.34104415e+02  4.88301895e+02
  4.88301895e+02  4.88301895e+02  6.20063811e+02  1.33780199e+03
  1.33780199e+03  1.33780199e+03  2.71706619e+03  3.02906638e+03
  3.02906638e+03  3.02906638e+03  6.64733652e+03  6.64733652e+03
  6.64733652e+03  9.12693186e+03  2.54788685e+04  7.62161856e+04]
E1 = -728.3682949169641  E_coul = 201.66167729760073
Extra cycle  E= -526.706617619363  delta_E= -3.64e-12  |g|= 2.26e-06  |ddm|= 3.92e-06
    CPU time for scf_cycle      0.86 sec, wall time      0.23 sec
exp = [2.61827231e+04 7.61736480e+03 3.61741121e+03 1.59432499e+03
 3.94442021e+02 1.15516228e+02 3.77319118e+01 7.96275017e+00
 3.12289631e+00 3.98296874e-01 1.36280546e+03 6.64530015e+02
 2.99946806e+02 3.13167198e+02 6.17668500e+01 7.81802546e+00
 2.12252609e+01 7.93849359e-01 2.98735435e+00 2.27790926e-01]
E = -526.7066176193634
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:00:27 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.7230605        1
[INPUT] 0    0    [1    /1   ]  7617.36479639        1
[INPUT] 0    0    [1    /1   ]  3617.41121464        1
[INPUT] 0    0    [1    /1   ]  1594.32499148        1
[INPUT] 0    0    [1    /1   ]  394.442020758        1
[INPUT] 0    0    [1    /1   ]  115.516227684        1
[INPUT] 0    0    [1    /1   ]  37.7319118242        1
[INPUT] 0    0    [1    /1   ]  7.96275016715        1
[INPUT] 0    0    [1    /1   ]  3.12289631016        1
[INPUT] 0    0    [1    /1   ]  0.398296873751       1
[INPUT] 1    0    [1    /1   ]  1362.80545706        1
[INPUT] 1    0    [1    /1   ]  664.530014715        1
[INPUT] 1    0    [1    /1   ]  299.946806169        1
[INPUT] 1    0    [1    /1   ]  313.167197636        1
[INPUT] 1    0    [1    /1   ]  61.7668500034        1
[INPUT] 1    0    [1    /1   ]  7.81802546443        1
[INPUT] 1    0    [1    /1   ]  21.2252608575        1
[INPUT] 1    0    [1    /1   ]  0.793849359245       1
[INPUT] 1    0    [1    /1   ]  2.98735435017        1
[INPUT] 1    0    [1    /1   ]  0.227790926366       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.72306054999, 1.0]], [0, [7617.3647963878, 1.0]], [0, [3617.4112146368734, 1.0]], [0, [1594.3249914832952, 1.0]], [0, [394.442020758048, 1.0]], [0, [115.5162276839512, 1.0]], [0, [37.731911824239845, 1.0]], [0, [7.962750167152189, 1.0]], [0, [3.1228963101628415, 1.0]], [0, [0.3982968737510683, 1.0]], [1, [1362.8054570640923, 1.0]], [1, [664.5300147148125, 1.0]], [1, [299.9468061691582, 1.0]], [1, [313.1671976355594, 1.0]], [1, [61.76685000338588, 1.0]], [1, [7.8180254644311376, 1.0]], [1, [21.22526085750368, 1.0]], [1, [0.7938493592445619, 1.0]], [1, [2.9873543501742015, 1.0]], [1, [0.22779092636604997, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.72306055]
bas 1, expnt(s) = [7617.36479639]
bas 2, expnt(s) = [3617.41121464]
bas 3, expnt(s) = [1594.32499148]
bas 4, expnt(s) = [394.44202076]
bas 5, expnt(s) = [115.51622768]
bas 6, expnt(s) = [37.73191182]
bas 7, expnt(s) = [7.96275017]
bas 8, expnt(s) = [3.12289631]
bas 9, expnt(s) = [0.39829687]
bas 10, expnt(s) = [1362.80545706]
bas 11, expnt(s) = [664.53001471]
bas 12, expnt(s) = [299.94680617]
bas 13, expnt(s) = [313.16719764]
bas 14, expnt(s) = [61.76685]
bas 15, expnt(s) = [7.81802546]
bas 16, expnt(s) = [21.22526086]
bas 17, expnt(s) = [0.79384936]
bas 18, expnt(s) = [2.98735435]
bas 19, expnt(s) = [0.22779093]
CPU time:      1456.20
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61827231e+04 5.20027288e+03 7.61736480e+03 2.06000650e+03
 3.61741121e+03 1.17845617e+03 1.59432499e+03 6.37452259e+02
 3.94442021e+02 2.23615758e+02 1.15516228e+02 8.90219848e+01
 3.77319118e+01 3.84633080e+01 7.96275017e+00 1.19760153e+01
 3.12289631e+00 5.93517048e+00 3.98296874e-01 1.26668958e+00
 1.36280546e+03 2.41560946e+04 6.64530015e+02 9.84300361e+03
 2.99946806e+02 3.64157866e+03 3.13167198e+02 3.84330389e+03
 6.17668500e+01 5.05159715e+02 7.81802546e+00 3.81378093e+01
 2.12252609e+01 1.32907867e+02 7.93849359e-01 2.18603452e+00
 2.98735435e+00 1.14575779e+01 2.27790926e-01 4.59097490e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98219301121998
cond(S) = 101124.43160806548
E1 = -729.3786300421335  E_coul = 203.12176717739666
init E= -526.256862864737
    CPU time for initialize scf      0.63 sec, wall time      0.05 sec
  HOMO = -0.556769968999229  LUMO = 1.06795226382502
  mo_energy =
[-1.18334036e+02 -1.22079577e+01 -9.45159514e+00 -9.45159514e+00
 -9.45159514e+00 -1.22597194e+00 -5.56769969e-01 -5.56769969e-01
 -5.56769969e-01  1.06795226e+00  1.06795226e+00  1.06795226e+00
  7.87100597e+00  7.87100597e+00  7.87100597e+00  9.79453169e+00
  3.60270111e+01  3.60270111e+01  3.60270111e+01  1.11128676e+02
  1.34275737e+02  1.34275737e+02  1.34275737e+02  4.88541430e+02
  4.88541430e+02  4.88541430e+02  6.20343133e+02  1.33809418e+03
  1.33809418e+03  1.33809418e+03  2.71748997e+03  3.02942254e+03
  3.02942254e+03  3.02942254e+03  6.64780411e+03  6.64780411e+03
  6.64780411e+03  9.12747344e+03  2.54795037e+04  7.62169106e+04]
E1 = -727.9998484114512  E_coul = 201.2938493487903
cycle= 1 E= -526.705999062661  delta_E= -0.449  |g|= 0.183  |ddm|= 0.456
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.540545
diis-c [-0.29218937  1.        ]
  HOMO = -0.580482559519915  LUMO = 1.0517656205698
  mo_energy =
[-1.18625414e+02 -1.23304172e+01 -9.58425599e+00 -9.58425599e+00
 -9.58425599e+00 -1.25640628e+00 -5.80482560e-01 -5.80482560e-01
 -5.80482560e-01  1.05176562e+00  1.05176562e+00  1.05176562e+00
  7.79278984e+00  7.79278984e+00  7.79278984e+00  9.70580828e+00
  3.58855185e+01  3.58855185e+01  3.58855185e+01  1.10919408e+02
  1.34063446e+02  1.34063446e+02  1.34063446e+02  4.88251989e+02
  4.88251989e+02  4.88251989e+02  6.20011730e+02  1.33774879e+03
  1.33774879e+03  1.33774879e+03  2.71701053e+03  3.02901146e+03
  3.02901146e+03  3.02901146e+03  6.64728041e+03  6.64728041e+03
  6.64728041e+03  9.12687525e+03  2.54788116e+04  7.62161286e+04]
E1 = -728.4575073015743  E_coul = 201.7509243418307
cycle= 2 E= -526.706582959744  delta_E= -0.000584  |g|= 0.0332  |ddm|= 0.0387
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.06673
diis-c [-0.00266684  0.07282289  0.92717711]
  HOMO = -0.573874151799043  LUMO = 1.05694892206997
  mo_energy =
[-1.18567295e+02 -1.22999812e+01 -9.55252696e+00 -9.55252696e+00
 -9.55252696e+00 -1.24801694e+00 -5.73874152e-01 -5.73874152e-01
 -5.73874152e-01  1.05694892e+00  1.05694892e+00  1.05694892e+00
  7.81177959e+00  7.81177959e+00  7.81177959e+00  9.72982453e+00
  3.59185842e+01  3.59185842e+01  3.59185842e+01  1.10967284e+02
  1.34110539e+02  1.34110539e+02  1.34110539e+02  4.88309295e+02
  4.88309295e+02  4.88309295e+02  6.20071578e+02  1.33780992e+03
  1.33780992e+03  1.33780992e+03  2.71707471e+03  3.02907466e+03
  3.02907466e+03  3.02907466e+03  6.64734517e+03  6.64734517e+03
  6.64734517e+03  9.12694071e+03  2.54788776e+04  7.62161948e+04]
E1 = -728.3542888027076  E_coul = 201.64767200143888
cycle= 3 E= -526.706616801269  delta_E= -3.38e-05  |g|= 0.00478  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104351
diis-c [-4.50041014e-07 -1.11543969e-03  1.30616168e-01  8.70499272e-01]
  HOMO = -0.5747770291695  LUMO = 1.05625200701832
  mo_energy =
[-1.18574777e+02 -1.23039651e+01 -9.55678304e+00 -9.55678304e+00
 -9.55678304e+00 -1.24911058e+00 -5.74777029e-01 -5.74777029e-01
 -5.74777029e-01  1.05625201e+00  1.05625201e+00  1.05625201e+00
  7.80921058e+00  7.80921058e+00  7.80921058e+00  9.72677062e+00
  3.59141869e+01  3.59141869e+01  3.59141869e+01  1.10961126e+02
  1.34104424e+02  1.34104424e+02  1.34104424e+02  4.88301917e+02
  4.88301917e+02  4.88301917e+02  6.20063841e+02  1.33780202e+03
  1.33780202e+03  1.33780202e+03  2.71706624e+03  3.02906642e+03
  3.02906642e+03  3.02906642e+03  6.64733657e+03  6.64733657e+03
  6.64733657e+03  9.12693192e+03  2.54788686e+04  7.62161857e+04]
E1 = -728.3682550407797  E_coul = 201.66163742153637
cycle= 4 E= -526.706617619243  delta_E= -8.18e-07  |g|= 6.09e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000126499
diis-c [-1.27153073e-09  6.56516160e-05 -9.18194862e-03 -7.22478762e-02
  1.08136417e+00]
  HOMO = -0.57476516915573  LUMO = 1.05626109024412
  mo_energy =
[-1.18574783e+02 -1.23039372e+01 -9.55676690e+00 -9.55676690e+00
 -9.55676690e+00 -1.24909160e+00 -5.74765169e-01 -5.74765169e-01
 -5.74765169e-01  1.05626109e+00  1.05626109e+00  1.05626109e+00
  7.80923051e+00  7.80923051e+00  7.80923051e+00  9.72680567e+00
  3.59142016e+01  3.59142016e+01  3.59142016e+01  1.10961136e+02
  1.34104431e+02  1.34104431e+02  1.34104431e+02  4.88301912e+02
  4.88301912e+02  4.88301912e+02  6.20063828e+02  1.33780201e+03
  1.33780201e+03  1.33780201e+03  2.71706621e+03  3.02906640e+03
  3.02906640e+03  3.02906640e+03  6.64733653e+03  6.64733653e+03
  6.64733653e+03  9.12693188e+03  2.54788686e+04  7.62161856e+04]
E1 = -728.3682573227516  E_coul = 201.66163970339173
cycle= 5 E= -526.70661761936  delta_E= -1.17e-10  |g|= 7.69e-06  |ddm|= 2.48e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3682573227516  E_coul = 201.66163970339173
  HOMO = -0.574768575307164  LUMO = 1.05625850826472
  mo_energy =
[-1.18574800e+02 -1.23039492e+01 -9.55677953e+00 -9.55677953e+00
 -9.55677953e+00 -1.24909578e+00 -5.74768575e-01 -5.74768575e-01
 -5.74768575e-01  1.05625851e+00  1.05625851e+00  1.05625851e+00
  7.80922194e+00  7.80922194e+00  7.80922194e+00  9.72679590e+00
  3.59141890e+01  3.59141890e+01  3.59141890e+01  1.10961121e+02
  1.34104415e+02  1.34104415e+02  1.34104415e+02  4.88301895e+02
  4.88301895e+02  4.88301895e+02  6.20063811e+02  1.33780199e+03
  1.33780199e+03  1.33780199e+03  2.71706619e+03  3.02906638e+03
  3.02906638e+03  3.02906638e+03  6.64733652e+03  6.64733652e+03
  6.64733652e+03  9.12693186e+03  2.54788685e+04  7.62161856e+04]
E1 = -728.3682949169641  E_coul = 201.66167729760073
Extra cycle  E= -526.706617619363  delta_E= -3.64e-12  |g|= 2.26e-06  |ddm|= 3.92e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.22 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 101124.43160806548
E1 = -728.3682949169641  E_coul = 201.66167729760073
init E= -526.706617619363
    CPU time for initialize scf      3.83 sec, wall time      0.20 sec
  HOMO = -0.57476789103622  LUMO = 1.05625903346205
  mo_energy =
[-1.18574795e+02 -1.23039464e+01 -9.55677667e+00 -9.55677667e+00
 -9.55677667e+00 -1.24909493e+00 -5.74767891e-01 -5.74767891e-01
 -5.74767891e-01  1.05625903e+00  1.05625903e+00  1.05625903e+00
  7.80922376e+00  7.80922376e+00  7.80922376e+00  9.72679810e+00
  3.59141919e+01  3.59141919e+01  3.59141919e+01  1.10961125e+02
  1.34104419e+02  1.34104419e+02  1.34104419e+02  4.88301900e+02
  4.88301900e+02  4.88301900e+02  6.20063816e+02  1.33780199e+03
  1.33780199e+03  1.33780199e+03  2.71706619e+03  3.02906638e+03
  3.02906638e+03  3.02906638e+03  6.64733652e+03  6.64733652e+03
  6.64733652e+03  9.12693186e+03  2.54788685e+04  7.62161856e+04]
E1 = -728.3682860236305  E_coul = 201.66166840426635
cycle= 1 E= -526.706617619364  delta_E= -6.82e-13  |g|= 5.78e-07  |ddm|= 8.95e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3682860236305  E_coul = 201.66166840426635
  HOMO = -0.574768041573019  LUMO = 1.05625891718766
  mo_energy =
[-1.18574796e+02 -1.23039471e+01 -9.55677735e+00 -9.55677735e+00
 -9.55677735e+00 -1.24909511e+00 -5.74768042e-01 -5.74768042e-01
 -5.74768042e-01  1.05625892e+00  1.05625892e+00  1.05625892e+00
  7.80922334e+00  7.80922334e+00  7.80922334e+00  9.72679760e+00
  3.59141912e+01  3.59141912e+01  3.59141912e+01  1.10961124e+02
  1.34104418e+02  1.34104418e+02  1.34104418e+02  4.88301898e+02
  4.88301898e+02  4.88301898e+02  6.20063814e+02  1.33780199e+03
  1.33780199e+03  1.33780199e+03  2.71706619e+03  3.02906638e+03
  3.02906638e+03  3.02906638e+03  6.64733652e+03  6.64733652e+03
  6.64733652e+03  9.12693186e+03  2.54788685e+04  7.62161856e+04]
E1 = -728.3682881812441  E_coul = 201.66167056188053
Extra cycle  E= -526.706617619364  delta_E= 5.68e-13  |g|= 1.45e-07  |ddm|= 2.09e-07
    CPU time for scf_cycle      3.95 sec, wall time      0.32 sec
exp = [2.61827231e+04 7.61736480e+03 3.61741121e+03 1.59432499e+03
 3.94442021e+02 1.15516228e+02 3.77319118e+01 7.96275017e+00
 3.12289631e+00 3.98296874e-01 1.36280546e+03 6.64530015e+02
 2.99946806e+02 3.13167198e+02 6.17668500e+01 7.81802546e+00
 2.12252609e+01 7.93849359e-01 2.98735435e+00 2.27790926e-01]
grad_E = [-1.49772331e-06  3.09259409e-06 -1.81487248e-06  6.49990777e-05
 -1.90235917e-04  5.27137977e-05 -2.96765856e-05 -1.14918439e-04
  3.15580412e-04 -1.52890936e-03 -3.94485999e-07  6.44202579e-06
  3.22829975e-05  2.77792302e-05 -7.04565688e-04 -1.19382705e-03
  2.21820228e-03  6.28177503e-05  1.58902795e-03  4.68026452e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:00:31 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.7214729        1
[INPUT] 0    0    [1    /1   ]  7617.36858457        1
[INPUT] 0    0    [1    /1   ]  3617.40986455        1
[INPUT] 0    0    [1    /1   ]  1594.41052418        1
[INPUT] 0    0    [1    /1   ]  394.11605455         1
[INPUT] 0    0    [1    /1   ]  115.473611891        1
[INPUT] 0    0    [1    /1   ]  37.7276077514        1
[INPUT] 0    0    [1    /1   ]  7.95935895291        1
[INPUT] 0    0    [1    /1   ]  3.12281290452        1
[INPUT] 0    0    [1    /1   ]  0.398200184038       1
[INPUT] 1    0    [1    /1   ]  1362.80492453        1
[INPUT] 1    0    [1    /1   ]  664.53495857         1
[INPUT] 1    0    [1    /1   ]  299.96992103         1
[INPUT] 1    0    [1    /1   ]  313.187125411        1
[INPUT] 1    0    [1    /1   ]  61.8157848805        1
[INPUT] 1    0    [1    /1   ]  7.70988989438        1
[INPUT] 1    0    [1    /1   ]  21.086080831         1
[INPUT] 1    0    [1    /1   ]  0.790504547442       1
[INPUT] 1    0    [1    /1   ]  2.94764658578        1
[INPUT] 1    0    [1    /1   ]  0.227232774146       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.72147292255, 1.0]], [0, [7617.3685845690225, 1.0]], [0, [3617.40986455213, 1.0]], [0, [1594.4105241810382, 1.0]], [0, [394.11605454985033, 1.0]], [0, [115.47361189074655, 1.0]], [0, [37.72760775142782, 1.0]], [0, [7.9593589529095885, 1.0]], [0, [3.1228129045190496, 1.0]], [0, [0.39820018403823926, 1.0]], [1, [1362.8049245300267, 1.0]], [1, [664.5349585702102, 1.0]], [1, [299.96992102950395, 1.0]], [1, [313.1871254106256, 1.0]], [1, [61.8157848805393, 1.0]], [1, [7.709889894375189, 1.0]], [1, [21.086080830971316, 1.0]], [1, [0.7905045474421489, 1.0]], [1, [2.947646585777211, 1.0]], [1, [0.22723277414645823, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.72147292]
bas 1, expnt(s) = [7617.36858457]
bas 2, expnt(s) = [3617.40986455]
bas 3, expnt(s) = [1594.41052418]
bas 4, expnt(s) = [394.11605455]
bas 5, expnt(s) = [115.47361189]
bas 6, expnt(s) = [37.72760775]
bas 7, expnt(s) = [7.95935895]
bas 8, expnt(s) = [3.1228129]
bas 9, expnt(s) = [0.39820018]
bas 10, expnt(s) = [1362.80492453]
bas 11, expnt(s) = [664.53495857]
bas 12, expnt(s) = [299.96992103]
bas 13, expnt(s) = [313.18712541]
bas 14, expnt(s) = [61.81578488]
bas 15, expnt(s) = [7.70988989]
bas 16, expnt(s) = [21.08608083]
bas 17, expnt(s) = [0.79050455]
bas 18, expnt(s) = [2.94764659]
bas 19, expnt(s) = [0.22723277]
CPU time:      1465.90
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61827215e+04 5.20027264e+03 7.61736858e+03 2.06000727e+03
 3.61740986e+03 1.17845584e+03 1.59441052e+03 6.37477908e+02
 3.94116055e+02 2.23477147e+02 1.15473612e+02 8.89973524e+01
 3.77276078e+01 3.84600173e+01 7.95935895e+00 1.19721898e+01
 3.12281290e+00 5.93505159e+00 3.98200184e-01 1.26645895e+00
 1.36280492e+03 2.41560828e+04 6.64534959e+02 9.84309514e+03
 2.99969921e+02 3.64192945e+03 3.13187125e+02 3.84360959e+03
 6.18157849e+01 5.05660032e+02 7.70988989e+00 3.74795711e+01
 2.10860808e+01 1.31819368e+02 7.90504547e-01 2.17452727e+00
 2.94764659e+00 1.12675283e+01 2.27232774e-01 4.57691773e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982323308069013
cond(S) = 101010.52408711234
E1 = -729.3782083934931  E_coul = 203.12111915485912
init E= -526.257089238634
    CPU time for initialize scf      0.65 sec, wall time      0.05 sec
  HOMO = -0.556834284582124  LUMO = 1.06263285348592
  mo_energy =
[-1.18334058e+02 -1.22080116e+01 -9.45163811e+00 -9.45163811e+00
 -9.45163811e+00 -1.22598205e+00 -5.56834285e-01 -5.56834285e-01
 -5.56834285e-01  1.06263285e+00  1.06263285e+00  1.06263285e+00
  7.75578674e+00  7.75578674e+00  7.75578674e+00  9.78998659e+00
  3.55241836e+01  3.55241836e+01  3.55241836e+01  1.11087652e+02
  1.33427361e+02  1.33427361e+02  1.33427361e+02  4.87783407e+02
  4.87783407e+02  4.87783407e+02  6.19982489e+02  1.33748297e+03
  1.33748297e+03  1.33748297e+03  2.71650371e+03  3.02892942e+03
  3.02892942e+03  3.02892942e+03  6.64740859e+03  6.64740859e+03
  6.64740859e+03  9.12633300e+03  2.54784213e+04  7.62159184e+04]
E1 = -727.9987881194517  E_coul = 201.29262136345963
cycle= 1 E= -526.706166755992  delta_E= -0.449  |g|= 0.184  |ddm|= 0.456
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.540599
diis-c [-0.29224704  1.        ]
  HOMO = -0.58058865469022  LUMO = 1.04653736257618
  mo_energy =
[-1.18625568e+02 -1.23304699e+01 -9.58430170e+00 -9.58430170e+00
 -9.58430170e+00 -1.25644300e+00 -5.80588655e-01 -5.80588655e-01
 -5.80588655e-01  1.04653736e+00  1.04653736e+00  1.04653736e+00
  7.67835692e+00  7.67835692e+00  7.67835692e+00  9.70130410e+00
  3.53831986e+01  3.53831986e+01  3.53831986e+01  1.10878306e+02
  1.33214950e+02  1.33214950e+02  1.33214950e+02  4.87493755e+02
  4.87493755e+02  4.87493755e+02  6.19651020e+02  1.33713742e+03
  1.33713742e+03  1.33713742e+03  2.71602416e+03  3.02851819e+03
  3.02851819e+03  3.02851819e+03  6.64688474e+03  6.64688474e+03
  6.64688474e+03  9.12573466e+03  2.54777291e+04  7.62151362e+04]
E1 = -728.4571323463882  E_coul = 201.75038043523222
cycle= 2 E= -526.706751911156  delta_E= -0.000585  |g|= 0.0332  |ddm|= 0.0386
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0667396
diis-c [-0.00266873  0.07280497  0.92719503]
  HOMO = -0.573970192192656  LUMO = 1.05169560781947
  mo_energy =
[-1.18567367e+02 -1.22999857e+01 -9.55252313e+00 -9.55252313e+00
 -9.55252313e+00 -1.24804129e+00 -5.73970192e-01 -5.73970192e-01
 -5.73970192e-01  1.05169561e+00  1.05169561e+00  1.05169561e+00
  7.69720353e+00  7.69720353e+00  7.69720353e+00  9.72535541e+00
  3.54161949e+01  3.54161949e+01  3.54161949e+01  1.10926248e+02
  1.33262115e+02  1.33262115e+02  1.33262115e+02  4.87551153e+02
  4.87551153e+02  4.87551153e+02  6.19710948e+02  1.33719864e+03
  1.33719864e+03  1.33719864e+03  2.71608843e+03  3.02858149e+03
  3.02858149e+03  3.02858149e+03  6.64694959e+03  6.64694959e+03
  6.64694959e+03  9.12580021e+03  2.54777951e+04  7.62152025e+04]
E1 = -728.353658789009  E_coul = 201.64687291697393
cycle= 3 E= -526.706785872035  delta_E= -3.4e-05  |g|= 0.00479  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104476
diis-c [-4.52177054e-07 -1.11704082e-03  1.30734868e-01  8.70382173e-01]
  HOMO = -0.57487652824359  LUMO = 1.05100053985362
  mo_energy =
[-1.18574868e+02 -1.23039818e+01 -9.55679180e+00 -9.55679180e+00
 -9.55679180e+00 -1.24913897e+00 -5.74876528e-01 -5.74876528e-01
 -5.74876528e-01  1.05100054e+00  1.05100054e+00  1.05100054e+00
  7.69464942e+00  7.69464942e+00  7.69464942e+00  9.72229231e+00
  3.54117999e+01  3.54117999e+01  3.54117999e+01  1.10920074e+02
  1.33255984e+02  1.33255984e+02  1.33255984e+02  4.87543755e+02
  4.87543755e+02  4.87543755e+02  6.19703193e+02  1.33719072e+03
  1.33719072e+03  1.33719072e+03  2.71607994e+03  3.02857322e+03
  3.02857322e+03  3.02857322e+03  6.64694097e+03  6.64694097e+03
  6.64694097e+03  9.12579140e+03  2.54777861e+04  7.62151934e+04]
E1 = -728.3676790556012  E_coul = 201.66089236030265
cycle= 4 E= -526.706786695299  delta_E= -8.23e-07  |g|= 6.1e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000126231
diis-c [-1.30118529e-09  6.55924259e-05 -9.16896663e-03 -7.20371309e-02
  1.08114051e+00]
  HOMO = -0.574864486195795  LUMO = 1.05100971646565
  mo_energy =
[-1.18574873e+02 -1.23039532e+01 -9.55677508e+00 -9.55677508e+00
 -9.55677508e+00 -1.24911975e+00 -5.74864486e-01 -5.74864486e-01
 -5.74864486e-01  1.05100972e+00  1.05100972e+00  1.05100972e+00
  7.69466978e+00  7.69466978e+00  7.69466978e+00  9.72232789e+00
  3.54118152e+01  3.54118152e+01  3.54118152e+01  1.10920084e+02
  1.33255991e+02  1.33255991e+02  1.33255991e+02  4.87543750e+02
  4.87543750e+02  4.87543750e+02  6.19703180e+02  1.33719070e+03
  1.33719070e+03  1.33719070e+03  2.71607991e+03  3.02857320e+03
  3.02857320e+03  3.02857320e+03  6.64694093e+03  6.64694093e+03
  6.64694093e+03  9.12579136e+03  2.54777861e+04  7.62151933e+04]
E1 = -728.3676798673207  E_coul = 201.6608931719028
cycle= 5 E= -526.706786695418  delta_E= -1.19e-10  |g|= 7.77e-06  |ddm|= 2.49e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3676798673207  E_coul = 201.6608931719028
  HOMO = -0.574867927738736  LUMO = 1.05100712365851
  mo_energy =
[-1.18574890e+02 -1.23039653e+01 -9.55678784e+00 -9.55678784e+00
 -9.55678784e+00 -1.24912398e+00 -5.74867928e-01 -5.74867928e-01
 -5.74867928e-01  1.05100712e+00  1.05100712e+00  1.05100712e+00
  7.69466118e+00  7.69466118e+00  7.69466118e+00  9.72231803e+00
  3.54118025e+01  3.54118025e+01  3.54118025e+01  1.10920069e+02
  1.33255975e+02  1.33255975e+02  1.33255975e+02  4.87543733e+02
  4.87543733e+02  4.87543733e+02  6.19703163e+02  1.33719069e+03
  1.33719069e+03  1.33719069e+03  2.71607989e+03  3.02857318e+03
  3.02857318e+03  3.02857318e+03  6.64694091e+03  6.64694091e+03
  6.64694091e+03  9.12579134e+03  2.54777861e+04  7.62151933e+04]
E1 = -728.3677179135577  E_coul = 201.6609312181362
Extra cycle  E= -526.706786695422  delta_E= -3.64e-12  |g|= 2.29e-06  |ddm|= 3.97e-06
    CPU time for scf_cycle      0.84 sec, wall time      0.23 sec
exp = [2.61827215e+04 7.61736858e+03 3.61740986e+03 1.59441052e+03
 3.94116055e+02 1.15473612e+02 3.77276078e+01 7.95935895e+00
 3.12281290e+00 3.98200184e-01 1.36280492e+03 6.64534959e+02
 2.99969921e+02 3.13187125e+02 6.18157849e+01 7.70988989e+00
 2.10860808e+01 7.90504547e-01 2.94764659e+00 2.27232774e-01]
E = -526.7067866954216
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:00:32 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.7214729        1
[INPUT] 0    0    [1    /1   ]  7617.36858457        1
[INPUT] 0    0    [1    /1   ]  3617.40986455        1
[INPUT] 0    0    [1    /1   ]  1594.41052418        1
[INPUT] 0    0    [1    /1   ]  394.11605455         1
[INPUT] 0    0    [1    /1   ]  115.473611891        1
[INPUT] 0    0    [1    /1   ]  37.7276077514        1
[INPUT] 0    0    [1    /1   ]  7.95935895291        1
[INPUT] 0    0    [1    /1   ]  3.12281290452        1
[INPUT] 0    0    [1    /1   ]  0.398200184038       1
[INPUT] 1    0    [1    /1   ]  1362.80492453        1
[INPUT] 1    0    [1    /1   ]  664.53495857         1
[INPUT] 1    0    [1    /1   ]  299.96992103         1
[INPUT] 1    0    [1    /1   ]  313.187125411        1
[INPUT] 1    0    [1    /1   ]  61.8157848805        1
[INPUT] 1    0    [1    /1   ]  7.70988989438        1
[INPUT] 1    0    [1    /1   ]  21.086080831         1
[INPUT] 1    0    [1    /1   ]  0.790504547442       1
[INPUT] 1    0    [1    /1   ]  2.94764658578        1
[INPUT] 1    0    [1    /1   ]  0.227232774146       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.72147292255, 1.0]], [0, [7617.3685845690225, 1.0]], [0, [3617.40986455213, 1.0]], [0, [1594.4105241810382, 1.0]], [0, [394.11605454985033, 1.0]], [0, [115.47361189074655, 1.0]], [0, [37.72760775142782, 1.0]], [0, [7.9593589529095885, 1.0]], [0, [3.1228129045190496, 1.0]], [0, [0.39820018403823926, 1.0]], [1, [1362.8049245300267, 1.0]], [1, [664.5349585702102, 1.0]], [1, [299.96992102950395, 1.0]], [1, [313.1871254106256, 1.0]], [1, [61.8157848805393, 1.0]], [1, [7.709889894375189, 1.0]], [1, [21.086080830971316, 1.0]], [1, [0.7905045474421489, 1.0]], [1, [2.947646585777211, 1.0]], [1, [0.22723277414645823, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.72147292]
bas 1, expnt(s) = [7617.36858457]
bas 2, expnt(s) = [3617.40986455]
bas 3, expnt(s) = [1594.41052418]
bas 4, expnt(s) = [394.11605455]
bas 5, expnt(s) = [115.47361189]
bas 6, expnt(s) = [37.72760775]
bas 7, expnt(s) = [7.95935895]
bas 8, expnt(s) = [3.1228129]
bas 9, expnt(s) = [0.39820018]
bas 10, expnt(s) = [1362.80492453]
bas 11, expnt(s) = [664.53495857]
bas 12, expnt(s) = [299.96992103]
bas 13, expnt(s) = [313.18712541]
bas 14, expnt(s) = [61.81578488]
bas 15, expnt(s) = [7.70988989]
bas 16, expnt(s) = [21.08608083]
bas 17, expnt(s) = [0.79050455]
bas 18, expnt(s) = [2.94764659]
bas 19, expnt(s) = [0.22723277]
CPU time:      1466.96
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61827215e+04 5.20027264e+03 7.61736858e+03 2.06000727e+03
 3.61740986e+03 1.17845584e+03 1.59441052e+03 6.37477908e+02
 3.94116055e+02 2.23477147e+02 1.15473612e+02 8.89973524e+01
 3.77276078e+01 3.84600173e+01 7.95935895e+00 1.19721898e+01
 3.12281290e+00 5.93505159e+00 3.98200184e-01 1.26645895e+00
 1.36280492e+03 2.41560828e+04 6.64534959e+02 9.84309514e+03
 2.99969921e+02 3.64192945e+03 3.13187125e+02 3.84360959e+03
 6.18157849e+01 5.05660032e+02 7.70988989e+00 3.74795711e+01
 2.10860808e+01 1.31819368e+02 7.90504547e-01 2.17452727e+00
 2.94764659e+00 1.12675283e+01 2.27232774e-01 4.57691773e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982323308069013
cond(S) = 101010.52408711234
E1 = -729.3782083934931  E_coul = 203.12111915485912
init E= -526.257089238634
    CPU time for initialize scf      0.74 sec, wall time      0.05 sec
  HOMO = -0.556834284582124  LUMO = 1.06263285348592
  mo_energy =
[-1.18334058e+02 -1.22080116e+01 -9.45163811e+00 -9.45163811e+00
 -9.45163811e+00 -1.22598205e+00 -5.56834285e-01 -5.56834285e-01
 -5.56834285e-01  1.06263285e+00  1.06263285e+00  1.06263285e+00
  7.75578674e+00  7.75578674e+00  7.75578674e+00  9.78998659e+00
  3.55241836e+01  3.55241836e+01  3.55241836e+01  1.11087652e+02
  1.33427361e+02  1.33427361e+02  1.33427361e+02  4.87783407e+02
  4.87783407e+02  4.87783407e+02  6.19982489e+02  1.33748297e+03
  1.33748297e+03  1.33748297e+03  2.71650371e+03  3.02892942e+03
  3.02892942e+03  3.02892942e+03  6.64740859e+03  6.64740859e+03
  6.64740859e+03  9.12633300e+03  2.54784213e+04  7.62159184e+04]
E1 = -727.9987881194517  E_coul = 201.29262136345963
cycle= 1 E= -526.706166755992  delta_E= -0.449  |g|= 0.184  |ddm|= 0.456
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.540599
diis-c [-0.29224704  1.        ]
  HOMO = -0.58058865469022  LUMO = 1.04653736257618
  mo_energy =
[-1.18625568e+02 -1.23304699e+01 -9.58430170e+00 -9.58430170e+00
 -9.58430170e+00 -1.25644300e+00 -5.80588655e-01 -5.80588655e-01
 -5.80588655e-01  1.04653736e+00  1.04653736e+00  1.04653736e+00
  7.67835692e+00  7.67835692e+00  7.67835692e+00  9.70130410e+00
  3.53831986e+01  3.53831986e+01  3.53831986e+01  1.10878306e+02
  1.33214950e+02  1.33214950e+02  1.33214950e+02  4.87493755e+02
  4.87493755e+02  4.87493755e+02  6.19651020e+02  1.33713742e+03
  1.33713742e+03  1.33713742e+03  2.71602416e+03  3.02851819e+03
  3.02851819e+03  3.02851819e+03  6.64688474e+03  6.64688474e+03
  6.64688474e+03  9.12573466e+03  2.54777291e+04  7.62151362e+04]
E1 = -728.4571323463882  E_coul = 201.75038043523222
cycle= 2 E= -526.706751911156  delta_E= -0.000585  |g|= 0.0332  |ddm|= 0.0386
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0667396
diis-c [-0.00266873  0.07280497  0.92719503]
  HOMO = -0.573970192192656  LUMO = 1.05169560781947
  mo_energy =
[-1.18567367e+02 -1.22999857e+01 -9.55252313e+00 -9.55252313e+00
 -9.55252313e+00 -1.24804129e+00 -5.73970192e-01 -5.73970192e-01
 -5.73970192e-01  1.05169561e+00  1.05169561e+00  1.05169561e+00
  7.69720353e+00  7.69720353e+00  7.69720353e+00  9.72535541e+00
  3.54161949e+01  3.54161949e+01  3.54161949e+01  1.10926248e+02
  1.33262115e+02  1.33262115e+02  1.33262115e+02  4.87551153e+02
  4.87551153e+02  4.87551153e+02  6.19710948e+02  1.33719864e+03
  1.33719864e+03  1.33719864e+03  2.71608843e+03  3.02858149e+03
  3.02858149e+03  3.02858149e+03  6.64694959e+03  6.64694959e+03
  6.64694959e+03  9.12580021e+03  2.54777951e+04  7.62152025e+04]
E1 = -728.353658789009  E_coul = 201.64687291697393
cycle= 3 E= -526.706785872035  delta_E= -3.4e-05  |g|= 0.00479  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104476
diis-c [-4.52177054e-07 -1.11704082e-03  1.30734868e-01  8.70382173e-01]
  HOMO = -0.57487652824359  LUMO = 1.05100053985362
  mo_energy =
[-1.18574868e+02 -1.23039818e+01 -9.55679180e+00 -9.55679180e+00
 -9.55679180e+00 -1.24913897e+00 -5.74876528e-01 -5.74876528e-01
 -5.74876528e-01  1.05100054e+00  1.05100054e+00  1.05100054e+00
  7.69464942e+00  7.69464942e+00  7.69464942e+00  9.72229231e+00
  3.54117999e+01  3.54117999e+01  3.54117999e+01  1.10920074e+02
  1.33255984e+02  1.33255984e+02  1.33255984e+02  4.87543755e+02
  4.87543755e+02  4.87543755e+02  6.19703193e+02  1.33719072e+03
  1.33719072e+03  1.33719072e+03  2.71607994e+03  3.02857322e+03
  3.02857322e+03  3.02857322e+03  6.64694097e+03  6.64694097e+03
  6.64694097e+03  9.12579140e+03  2.54777861e+04  7.62151934e+04]
E1 = -728.3676790556012  E_coul = 201.66089236030265
cycle= 4 E= -526.706786695299  delta_E= -8.23e-07  |g|= 6.1e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000126231
diis-c [-1.30118529e-09  6.55924259e-05 -9.16896663e-03 -7.20371309e-02
  1.08114051e+00]
  HOMO = -0.574864486195795  LUMO = 1.05100971646565
  mo_energy =
[-1.18574873e+02 -1.23039532e+01 -9.55677508e+00 -9.55677508e+00
 -9.55677508e+00 -1.24911975e+00 -5.74864486e-01 -5.74864486e-01
 -5.74864486e-01  1.05100972e+00  1.05100972e+00  1.05100972e+00
  7.69466978e+00  7.69466978e+00  7.69466978e+00  9.72232789e+00
  3.54118152e+01  3.54118152e+01  3.54118152e+01  1.10920084e+02
  1.33255991e+02  1.33255991e+02  1.33255991e+02  4.87543750e+02
  4.87543750e+02  4.87543750e+02  6.19703180e+02  1.33719070e+03
  1.33719070e+03  1.33719070e+03  2.71607991e+03  3.02857320e+03
  3.02857320e+03  3.02857320e+03  6.64694093e+03  6.64694093e+03
  6.64694093e+03  9.12579136e+03  2.54777861e+04  7.62151933e+04]
E1 = -728.3676798673207  E_coul = 201.6608931719028
cycle= 5 E= -526.706786695418  delta_E= -1.19e-10  |g|= 7.77e-06  |ddm|= 2.49e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3676798673207  E_coul = 201.6608931719028
  HOMO = -0.574867927738736  LUMO = 1.05100712365851
  mo_energy =
[-1.18574890e+02 -1.23039653e+01 -9.55678784e+00 -9.55678784e+00
 -9.55678784e+00 -1.24912398e+00 -5.74867928e-01 -5.74867928e-01
 -5.74867928e-01  1.05100712e+00  1.05100712e+00  1.05100712e+00
  7.69466118e+00  7.69466118e+00  7.69466118e+00  9.72231803e+00
  3.54118025e+01  3.54118025e+01  3.54118025e+01  1.10920069e+02
  1.33255975e+02  1.33255975e+02  1.33255975e+02  4.87543733e+02
  4.87543733e+02  4.87543733e+02  6.19703163e+02  1.33719069e+03
  1.33719069e+03  1.33719069e+03  2.71607989e+03  3.02857318e+03
  3.02857318e+03  3.02857318e+03  6.64694091e+03  6.64694091e+03
  6.64694091e+03  9.12579134e+03  2.54777861e+04  7.62151933e+04]
E1 = -728.3677179135577  E_coul = 201.6609312181362
Extra cycle  E= -526.706786695422  delta_E= -3.64e-12  |g|= 2.29e-06  |ddm|= 3.97e-06
    CPU time for scf_cycle      0.92 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 101010.52408711234
E1 = -728.3677179135577  E_coul = 201.6609312181362
init E= -526.706786695422
    CPU time for initialize scf      3.85 sec, wall time      0.21 sec
  HOMO = -0.574867234863121  LUMO = 1.05100765216236
  mo_energy =
[-1.18574886e+02 -1.23039626e+01 -9.55678495e+00 -9.55678495e+00
 -9.55678495e+00 -1.24912311e+00 -5.74867235e-01 -5.74867235e-01
 -5.74867235e-01  1.05100765e+00  1.05100765e+00  1.05100765e+00
  7.69466301e+00  7.69466301e+00  7.69466301e+00  9.72232025e+00
  3.54118055e+01  3.54118055e+01  3.54118055e+01  1.10920073e+02
  1.33255979e+02  1.33255979e+02  1.33255979e+02  4.87543738e+02
  4.87543738e+02  4.87543738e+02  6.19703168e+02  1.33719069e+03
  1.33719069e+03  1.33719069e+03  2.71607990e+03  3.02857319e+03
  3.02857319e+03  3.02857319e+03  6.64694092e+03  6.64694092e+03
  6.64694092e+03  9.12579134e+03  2.54777861e+04  7.62151933e+04]
E1 = -728.3677089052987  E_coul = 201.6609222098773
cycle= 1 E= -526.706786695421  delta_E= 1.14e-13  |g|= 5.86e-07  |ddm|= 9.05e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3677089052987  E_coul = 201.6609222098773
  HOMO = -0.574867387423785  LUMO = 1.05100753507285
  mo_energy =
[-1.18574887e+02 -1.23039632e+01 -9.55678563e+00 -9.55678563e+00
 -9.55678563e+00 -1.24912330e+00 -5.74867387e-01 -5.74867387e-01
 -5.74867387e-01  1.05100754e+00  1.05100754e+00  1.05100754e+00
  7.69466259e+00  7.69466259e+00  7.69466259e+00  9.72231974e+00
  3.54118048e+01  3.54118048e+01  3.54118048e+01  1.10920072e+02
  1.33255978e+02  1.33255978e+02  1.33255978e+02  4.87543737e+02
  4.87543737e+02  4.87543737e+02  6.19703166e+02  1.33719069e+03
  1.33719069e+03  1.33719069e+03  2.71607989e+03  3.02857319e+03
  3.02857319e+03  3.02857319e+03  6.64694092e+03  6.64694092e+03
  6.64694092e+03  9.12579134e+03  2.54777861e+04  7.62151933e+04]
E1 = -728.3677110928824  E_coul = 201.6609243974613
Extra cycle  E= -526.706786695421  delta_E= 3.41e-13  |g|= 1.46e-07  |ddm|= 2.11e-07
    CPU time for scf_cycle      3.97 sec, wall time      0.32 sec
exp = [2.61827215e+04 7.61736858e+03 3.61740986e+03 1.59441052e+03
 3.94116055e+02 1.15473612e+02 3.77276078e+01 7.95935895e+00
 3.12281290e+00 3.98200184e-01 1.36280492e+03 6.64534959e+02
 2.99969921e+02 3.13187125e+02 6.18157849e+01 7.70988989e+00
 2.10860808e+01 7.90504547e-01 2.94764659e+00 2.27232774e-01]
grad_E = [-1.49974326e-06  3.11381666e-06 -1.80242237e-06  6.56909847e-05
 -1.99087500e-04  7.58939980e-05 -5.13630858e-05 -1.77041623e-04
  5.01201629e-04 -2.57999689e-03 -4.08059286e-07  6.29308522e-06
  3.14299809e-05  2.70378907e-05 -6.86844919e-04 -2.94066783e-03
  2.62430105e-03  4.33700334e-04  2.69141424e-03  7.15310588e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:00:36 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.7251082        1
[INPUT] 0    0    [1    /1   ]  7617.36013213        1
[INPUT] 0    0    [1    /1   ]  3617.41318984        1
[INPUT] 0    0    [1    /1   ]  1594.22232217        1
[INPUT] 0    0    [1    /1   ]  394.767025858        1
[INPUT] 0    0    [1    /1   ]  115.719922539        1
[INPUT] 0    0    [1    /1   ]  37.7852421246        1
[INPUT] 0    0    [1    /1   ]  7.9598054798         1
[INPUT] 0    0    [1    /1   ]  3.12470225453        1
[INPUT] 0    0    [1    /1   ]  0.398067768153       1
[INPUT] 1    0    [1    /1   ]  1362.80610885        1
[INPUT] 1    0    [1    /1   ]  664.523007919        1
[INPUT] 1    0    [1    /1   ]  299.913316622        1
[INPUT] 1    0    [1    /1   ]  313.138342475        1
[INPUT] 1    0    [1    /1   ]  61.9423345369        1
[INPUT] 1    0    [1    /1   ]  7.54780088499        1
[INPUT] 1    0    [1    /1   ]  20.861635765         1
[INPUT] 1    0    [1    /1   ]  0.785255422759       1
[INPUT] 1    0    [1    /1   ]  2.88809186419        1
[INPUT] 1    0    [1    /1   ]  0.226345134328       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.725108196522, 1.0]], [0, [7617.360132134729, 1.0]], [0, [3617.4131898392584, 1.0]], [0, [1594.2223221704326, 1.0]], [0, [394.76702585756686, 1.0]], [0, [115.71992253872591, 1.0]], [0, [37.785242124621405, 1.0]], [0, [7.959805479802728, 1.0]], [0, [3.124702254530725, 1.0]], [0, [0.39806776815267175, 1.0]], [1, [1362.8061088527463, 1.0]], [1, [664.5230079192228, 1.0]], [1, [299.9133166223397, 1.0]], [1, [313.1383424745907, 1.0]], [1, [61.94233453691094, 1.0]], [1, [7.547800884989105, 1.0]], [1, [20.861635765016338, 1.0]], [1, [0.785255422758702, 1.0]], [1, [2.8880918641872677, 1.0]], [1, [0.22634513432835085, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.7251082]
bas 1, expnt(s) = [7617.36013213]
bas 2, expnt(s) = [3617.41318984]
bas 3, expnt(s) = [1594.22232217]
bas 4, expnt(s) = [394.76702586]
bas 5, expnt(s) = [115.71992254]
bas 6, expnt(s) = [37.78524212]
bas 7, expnt(s) = [7.95980548]
bas 8, expnt(s) = [3.12470225]
bas 9, expnt(s) = [0.39806777]
bas 10, expnt(s) = [1362.80610885]
bas 11, expnt(s) = [664.52300792]
bas 12, expnt(s) = [299.91331662]
bas 13, expnt(s) = [313.13834247]
bas 14, expnt(s) = [61.94233454]
bas 15, expnt(s) = [7.54780088]
bas 16, expnt(s) = [20.86163577]
bas 17, expnt(s) = [0.78525542]
bas 18, expnt(s) = [2.88809186]
bas 19, expnt(s) = [0.22634513]
CPU time:      1476.74
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61827251e+04 5.20027318e+03 7.61736013e+03 2.06000555e+03
 3.61741319e+03 1.17845665e+03 1.59422232e+03 6.37421472e+02
 3.94767026e+02 2.23753932e+02 1.15719923e+02 8.91396911e+01
 3.77852421e+01 3.85040738e+01 7.95980548e+00 1.19726935e+01
 3.12470225e+00 5.93774448e+00 3.98067768e-01 1.26614308e+00
 1.36280611e+03 2.41561091e+04 6.64523008e+02 9.84287388e+03
 2.99913317e+02 3.64107043e+03 3.13138342e+02 3.84286124e+03
 6.19423345e+01 5.06954350e+02 7.54780088e+00 3.64972326e+01
 2.08616358e+01 1.30067814e+02 7.85255423e-01 2.15649310e+00
 2.88809186e+00 1.09836870e+01 2.26345134e-01 4.55458012e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98251767138453
cond(S) = 100613.44418173641
E1 = -729.3775776310727  E_coul = 203.12012522236765
init E= -526.257452408705
    CPU time for initialize scf      0.64 sec, wall time      0.05 sec
  HOMO = -0.556931297103272  LUMO = 1.05429072877503
  mo_energy =
[-1.18334194e+02 -1.22080922e+01 -9.45169205e+00 -9.45169205e+00
 -9.45169205e+00 -1.22600267e+00 -5.56931297e-01 -5.56931297e-01
 -5.56931297e-01  1.05429073e+00  1.05429073e+00  1.05429073e+00
  7.58368615e+00  7.58368615e+00  7.58368615e+00  9.79679198e+00
  3.47584376e+01  3.47584376e+01  3.47584376e+01  1.11313421e+02
  1.32159217e+02  1.32159217e+02  1.32159217e+02  4.86684437e+02
  4.86684437e+02  4.86684437e+02  6.21266986e+02  1.33645519e+03
  1.33645519e+03  1.33645519e+03  2.71920352e+03  3.02784318e+03
  3.02784318e+03  3.02784318e+03  6.64630417e+03  6.64630417e+03
  6.64630417e+03  9.12930900e+03  2.54812352e+04  7.62185016e+04]
E1 = -727.9972339862701  E_coul = 201.29068093680937
cycle= 1 E= -526.706553049461  delta_E= -0.449  |g|= 0.184  |ddm|= 0.451
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.540546
diis-c [-0.29219  1.     ]
  HOMO = -0.580751914102061  LUMO = 1.03833644252788
  mo_energy =
[-1.18625892e+02 -1.23305611e+01 -9.58436473e+00 -9.58436473e+00
 -9.58436473e+00 -1.25651314e+00 -5.80751914e-01 -5.80751914e-01
 -5.80751914e-01  1.03833644e+00  1.03833644e+00  1.03833644e+00
  7.50743917e+00  7.50743917e+00  7.50743917e+00  9.70809007e+00
  3.46182589e+01  3.46182589e+01  3.46182589e+01  1.11103771e+02
  1.31946591e+02  1.31946591e+02  1.31946591e+02  4.86394487e+02
  4.86394487e+02  4.86394487e+02  6.20935176e+02  1.33610942e+03
  1.33610942e+03  1.33610942e+03  2.71872380e+03  3.02743178e+03
  3.02743178e+03  3.02743178e+03  6.64578020e+03  6.64578020e+03
  6.64578020e+03  9.12871058e+03  2.54805429e+04  7.62177194e+04]
E1 = -728.4565402887589  E_coul = 201.74940039189488
cycle= 2 E= -526.707139896864  delta_E= -0.000587  |g|= 0.0333  |ddm|= 0.0385
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0667289
diis-c [-0.0026696   0.07276828  0.92723172]
  HOMO = -0.574118959359213  LUMO = 1.04345454646976
  mo_energy =
[-1.18567577e+02 -1.23000089e+01 -9.55251623e+00 -9.55251623e+00
 -9.55251623e+00 -1.24809348e+00 -5.74118959e-01 -5.74118959e-01
 -5.74118959e-01  1.04345455e+00  1.04345455e+00  1.04345455e+00
  7.52606453e+00  7.52606453e+00  7.52606453e+00  9.73220606e+00
  3.46511367e+01  3.46511367e+01  3.46511367e+01  1.11151837e+02
  1.31993863e+02  1.31993863e+02  1.31993863e+02  4.86452016e+02
  4.86452016e+02  4.86452016e+02  6.20995231e+02  1.33617076e+03
  1.33617076e+03  1.33617076e+03  2.71878820e+03  3.02749520e+03
  3.02749520e+03  3.02749520e+03  6.64584517e+03  6.64584517e+03
  6.64584517e+03  9.12877626e+03  2.54806090e+04  7.62177858e+04]
E1 = -728.3527049632685  E_coul = 201.64553094047264
cycle= 3 E= -526.707174022796  delta_E= -3.41e-05  |g|= 0.0048  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104615
diis-c [-4.53964852e-07 -1.11870660e-03  1.30905185e-01  8.70213522e-01]
  HOMO = -0.575030453391585  LUMO = 1.04276257480676
  mo_energy =
[-1.18575105e+02 -1.23040226e+01 -9.55680308e+00 -9.55680308e+00
 -9.55680308e+00 -1.24919731e+00 -5.75030453e-01 -5.75030453e-01
 -5.75030453e-01  1.04276257e+00  1.04276257e+00  1.04276257e+00
  7.52353375e+00  7.52353375e+00  7.52353375e+00  9.72912745e+00
  3.46467472e+01  3.46467472e+01  3.46467472e+01  1.11145636e+02
  1.31987707e+02  1.31987707e+02  1.31987707e+02  4.86444589e+02
  4.86444589e+02  4.86444589e+02  6.20987446e+02  1.33616282e+03
  1.33616282e+03  1.33616282e+03  2.71877968e+03  3.02748690e+03
  3.02748690e+03  3.02748690e+03  6.64583653e+03  6.64583653e+03
  6.64583653e+03  9.12876742e+03  2.54806000e+04  7.62177766e+04]
E1 = -728.3668026081848  E_coul = 201.6596277545978
cycle= 4 E= -526.707174853587  delta_E= -8.31e-07  |g|= 6.11e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000125632
diis-c [-1.34480713e-09  6.54111814e-05 -9.14114778e-03 -7.16583702e-02
  1.08073411e+00]
  HOMO = -0.575018153720294  LUMO = 1.04277187285255
  mo_energy =
[-1.18575109e+02 -1.23039931e+01 -9.55678549e+00 -9.55678549e+00
 -9.55678549e+00 -1.24917776e+00 -5.75018154e-01 -5.75018154e-01
 -5.75018154e-01  1.04277187e+00  1.04277187e+00  1.04277187e+00
  7.52355472e+00  7.52355472e+00  7.52355472e+00  9.72916378e+00
  3.46467634e+01  3.46467634e+01  3.46467634e+01  1.11145648e+02
  1.31987715e+02  1.31987715e+02  1.31987715e+02  4.86444585e+02
  4.86444585e+02  4.86444585e+02  6.20987434e+02  1.33616280e+03
  1.33616280e+03  1.33616280e+03  2.71877965e+03  3.02748688e+03
  3.02748688e+03  3.02748688e+03  6.64583649e+03  6.64583649e+03
  6.64583649e+03  9.12876737e+03  2.54806000e+04  7.62177766e+04]
E1 = -728.3668011153563  E_coul = 201.65962626165108
cycle= 5 E= -526.707174853705  delta_E= -1.18e-10  |g|= 7.89e-06  |ddm|= 2.51e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3668011153563  E_coul = 201.65962626165108
  HOMO = -0.575021645705759  LUMO = 1.04276926732127
  mo_energy =
[-1.18575127e+02 -1.23040055e+01 -9.55679843e+00 -9.55679843e+00
 -9.55679843e+00 -1.24918205e+00 -5.75021646e-01 -5.75021646e-01
 -5.75021646e-01  1.04276927e+00  1.04276927e+00  1.04276927e+00
  7.52354610e+00  7.52354610e+00  7.52354610e+00  9.72915377e+00
  3.46467506e+01  3.46467506e+01  3.46467506e+01  1.11145632e+02
  1.31987699e+02  1.31987699e+02  1.31987699e+02  4.86444568e+02
  4.86444568e+02  4.86444568e+02  6.20987417e+02  1.33616279e+03
  1.33616279e+03  1.33616279e+03  2.71877963e+03  3.02748686e+03
  3.02748686e+03  3.02748686e+03  6.64583647e+03  6.64583647e+03
  6.64583647e+03  9.12876736e+03  2.54805999e+04  7.62177766e+04]
E1 = -728.3668398055379  E_coul = 201.6596649518277
Extra cycle  E= -526.70717485371  delta_E= -4.89e-12  |g|= 2.32e-06  |ddm|= 4.02e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.23 sec
exp = [2.61827251e+04 7.61736013e+03 3.61741319e+03 1.59422232e+03
 3.94767026e+02 1.15719923e+02 3.77852421e+01 7.95980548e+00
 3.12470225e+00 3.98067768e-01 1.36280611e+03 6.64523008e+02
 2.99913317e+02 3.13138342e+02 6.19423345e+01 7.54780088e+00
 2.08616358e+01 7.85255423e-01 2.88809186e+00 2.26345134e-01]
E = -526.7071748537102
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:00:36 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.7251082        1
[INPUT] 0    0    [1    /1   ]  7617.36013213        1
[INPUT] 0    0    [1    /1   ]  3617.41318984        1
[INPUT] 0    0    [1    /1   ]  1594.22232217        1
[INPUT] 0    0    [1    /1   ]  394.767025858        1
[INPUT] 0    0    [1    /1   ]  115.719922539        1
[INPUT] 0    0    [1    /1   ]  37.7852421246        1
[INPUT] 0    0    [1    /1   ]  7.9598054798         1
[INPUT] 0    0    [1    /1   ]  3.12470225453        1
[INPUT] 0    0    [1    /1   ]  0.398067768153       1
[INPUT] 1    0    [1    /1   ]  1362.80610885        1
[INPUT] 1    0    [1    /1   ]  664.523007919        1
[INPUT] 1    0    [1    /1   ]  299.913316622        1
[INPUT] 1    0    [1    /1   ]  313.138342475        1
[INPUT] 1    0    [1    /1   ]  61.9423345369        1
[INPUT] 1    0    [1    /1   ]  7.54780088499        1
[INPUT] 1    0    [1    /1   ]  20.861635765         1
[INPUT] 1    0    [1    /1   ]  0.785255422759       1
[INPUT] 1    0    [1    /1   ]  2.88809186419        1
[INPUT] 1    0    [1    /1   ]  0.226345134328       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.725108196522, 1.0]], [0, [7617.360132134729, 1.0]], [0, [3617.4131898392584, 1.0]], [0, [1594.2223221704326, 1.0]], [0, [394.76702585756686, 1.0]], [0, [115.71992253872591, 1.0]], [0, [37.785242124621405, 1.0]], [0, [7.959805479802728, 1.0]], [0, [3.124702254530725, 1.0]], [0, [0.39806776815267175, 1.0]], [1, [1362.8061088527463, 1.0]], [1, [664.5230079192228, 1.0]], [1, [299.9133166223397, 1.0]], [1, [313.1383424745907, 1.0]], [1, [61.94233453691094, 1.0]], [1, [7.547800884989105, 1.0]], [1, [20.861635765016338, 1.0]], [1, [0.785255422758702, 1.0]], [1, [2.8880918641872677, 1.0]], [1, [0.22634513432835085, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.7251082]
bas 1, expnt(s) = [7617.36013213]
bas 2, expnt(s) = [3617.41318984]
bas 3, expnt(s) = [1594.22232217]
bas 4, expnt(s) = [394.76702586]
bas 5, expnt(s) = [115.71992254]
bas 6, expnt(s) = [37.78524212]
bas 7, expnt(s) = [7.95980548]
bas 8, expnt(s) = [3.12470225]
bas 9, expnt(s) = [0.39806777]
bas 10, expnt(s) = [1362.80610885]
bas 11, expnt(s) = [664.52300792]
bas 12, expnt(s) = [299.91331662]
bas 13, expnt(s) = [313.13834247]
bas 14, expnt(s) = [61.94233454]
bas 15, expnt(s) = [7.54780088]
bas 16, expnt(s) = [20.86163577]
bas 17, expnt(s) = [0.78525542]
bas 18, expnt(s) = [2.88809186]
bas 19, expnt(s) = [0.22634513]
CPU time:      1477.79
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61827251e+04 5.20027318e+03 7.61736013e+03 2.06000555e+03
 3.61741319e+03 1.17845665e+03 1.59422232e+03 6.37421472e+02
 3.94767026e+02 2.23753932e+02 1.15719923e+02 8.91396911e+01
 3.77852421e+01 3.85040738e+01 7.95980548e+00 1.19726935e+01
 3.12470225e+00 5.93774448e+00 3.98067768e-01 1.26614308e+00
 1.36280611e+03 2.41561091e+04 6.64523008e+02 9.84287388e+03
 2.99913317e+02 3.64107043e+03 3.13138342e+02 3.84286124e+03
 6.19423345e+01 5.06954350e+02 7.54780088e+00 3.64972326e+01
 2.08616358e+01 1.30067814e+02 7.85255423e-01 2.15649310e+00
 2.88809186e+00 1.09836870e+01 2.26345134e-01 4.55458012e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98251767138453
cond(S) = 100613.44418173641
E1 = -729.3775776310727  E_coul = 203.12012522236765
init E= -526.257452408705
    CPU time for initialize scf      0.63 sec, wall time      0.05 sec
  HOMO = -0.556931297103272  LUMO = 1.05429072877503
  mo_energy =
[-1.18334194e+02 -1.22080922e+01 -9.45169205e+00 -9.45169205e+00
 -9.45169205e+00 -1.22600267e+00 -5.56931297e-01 -5.56931297e-01
 -5.56931297e-01  1.05429073e+00  1.05429073e+00  1.05429073e+00
  7.58368615e+00  7.58368615e+00  7.58368615e+00  9.79679198e+00
  3.47584376e+01  3.47584376e+01  3.47584376e+01  1.11313421e+02
  1.32159217e+02  1.32159217e+02  1.32159217e+02  4.86684437e+02
  4.86684437e+02  4.86684437e+02  6.21266986e+02  1.33645519e+03
  1.33645519e+03  1.33645519e+03  2.71920352e+03  3.02784318e+03
  3.02784318e+03  3.02784318e+03  6.64630417e+03  6.64630417e+03
  6.64630417e+03  9.12930900e+03  2.54812352e+04  7.62185016e+04]
E1 = -727.9972339862701  E_coul = 201.29068093680937
cycle= 1 E= -526.706553049461  delta_E= -0.449  |g|= 0.184  |ddm|= 0.451
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.540546
diis-c [-0.29219  1.     ]
  HOMO = -0.580751914102061  LUMO = 1.03833644252788
  mo_energy =
[-1.18625892e+02 -1.23305611e+01 -9.58436473e+00 -9.58436473e+00
 -9.58436473e+00 -1.25651314e+00 -5.80751914e-01 -5.80751914e-01
 -5.80751914e-01  1.03833644e+00  1.03833644e+00  1.03833644e+00
  7.50743917e+00  7.50743917e+00  7.50743917e+00  9.70809007e+00
  3.46182589e+01  3.46182589e+01  3.46182589e+01  1.11103771e+02
  1.31946591e+02  1.31946591e+02  1.31946591e+02  4.86394487e+02
  4.86394487e+02  4.86394487e+02  6.20935176e+02  1.33610942e+03
  1.33610942e+03  1.33610942e+03  2.71872380e+03  3.02743178e+03
  3.02743178e+03  3.02743178e+03  6.64578020e+03  6.64578020e+03
  6.64578020e+03  9.12871058e+03  2.54805429e+04  7.62177194e+04]
E1 = -728.4565402887589  E_coul = 201.74940039189488
cycle= 2 E= -526.707139896864  delta_E= -0.000587  |g|= 0.0333  |ddm|= 0.0385
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0667289
diis-c [-0.0026696   0.07276828  0.92723172]
  HOMO = -0.574118959359213  LUMO = 1.04345454646976
  mo_energy =
[-1.18567577e+02 -1.23000089e+01 -9.55251623e+00 -9.55251623e+00
 -9.55251623e+00 -1.24809348e+00 -5.74118959e-01 -5.74118959e-01
 -5.74118959e-01  1.04345455e+00  1.04345455e+00  1.04345455e+00
  7.52606453e+00  7.52606453e+00  7.52606453e+00  9.73220606e+00
  3.46511367e+01  3.46511367e+01  3.46511367e+01  1.11151837e+02
  1.31993863e+02  1.31993863e+02  1.31993863e+02  4.86452016e+02
  4.86452016e+02  4.86452016e+02  6.20995231e+02  1.33617076e+03
  1.33617076e+03  1.33617076e+03  2.71878820e+03  3.02749520e+03
  3.02749520e+03  3.02749520e+03  6.64584517e+03  6.64584517e+03
  6.64584517e+03  9.12877626e+03  2.54806090e+04  7.62177858e+04]
E1 = -728.3527049632685  E_coul = 201.64553094047264
cycle= 3 E= -526.707174022796  delta_E= -3.41e-05  |g|= 0.0048  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104615
diis-c [-4.53964852e-07 -1.11870660e-03  1.30905185e-01  8.70213522e-01]
  HOMO = -0.575030453391585  LUMO = 1.04276257480676
  mo_energy =
[-1.18575105e+02 -1.23040226e+01 -9.55680308e+00 -9.55680308e+00
 -9.55680308e+00 -1.24919731e+00 -5.75030453e-01 -5.75030453e-01
 -5.75030453e-01  1.04276257e+00  1.04276257e+00  1.04276257e+00
  7.52353375e+00  7.52353375e+00  7.52353375e+00  9.72912745e+00
  3.46467472e+01  3.46467472e+01  3.46467472e+01  1.11145636e+02
  1.31987707e+02  1.31987707e+02  1.31987707e+02  4.86444589e+02
  4.86444589e+02  4.86444589e+02  6.20987446e+02  1.33616282e+03
  1.33616282e+03  1.33616282e+03  2.71877968e+03  3.02748690e+03
  3.02748690e+03  3.02748690e+03  6.64583653e+03  6.64583653e+03
  6.64583653e+03  9.12876742e+03  2.54806000e+04  7.62177766e+04]
E1 = -728.3668026081848  E_coul = 201.6596277545978
cycle= 4 E= -526.707174853587  delta_E= -8.31e-07  |g|= 6.11e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000125632
diis-c [-1.34480713e-09  6.54111814e-05 -9.14114778e-03 -7.16583702e-02
  1.08073411e+00]
  HOMO = -0.575018153720294  LUMO = 1.04277187285255
  mo_energy =
[-1.18575109e+02 -1.23039931e+01 -9.55678549e+00 -9.55678549e+00
 -9.55678549e+00 -1.24917776e+00 -5.75018154e-01 -5.75018154e-01
 -5.75018154e-01  1.04277187e+00  1.04277187e+00  1.04277187e+00
  7.52355472e+00  7.52355472e+00  7.52355472e+00  9.72916378e+00
  3.46467634e+01  3.46467634e+01  3.46467634e+01  1.11145648e+02
  1.31987715e+02  1.31987715e+02  1.31987715e+02  4.86444585e+02
  4.86444585e+02  4.86444585e+02  6.20987434e+02  1.33616280e+03
  1.33616280e+03  1.33616280e+03  2.71877965e+03  3.02748688e+03
  3.02748688e+03  3.02748688e+03  6.64583649e+03  6.64583649e+03
  6.64583649e+03  9.12876737e+03  2.54806000e+04  7.62177766e+04]
E1 = -728.3668011153563  E_coul = 201.65962626165108
cycle= 5 E= -526.707174853705  delta_E= -1.18e-10  |g|= 7.89e-06  |ddm|= 2.51e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3668011153563  E_coul = 201.65962626165108
  HOMO = -0.575021645705759  LUMO = 1.04276926732127
  mo_energy =
[-1.18575127e+02 -1.23040055e+01 -9.55679843e+00 -9.55679843e+00
 -9.55679843e+00 -1.24918205e+00 -5.75021646e-01 -5.75021646e-01
 -5.75021646e-01  1.04276927e+00  1.04276927e+00  1.04276927e+00
  7.52354610e+00  7.52354610e+00  7.52354610e+00  9.72915377e+00
  3.46467506e+01  3.46467506e+01  3.46467506e+01  1.11145632e+02
  1.31987699e+02  1.31987699e+02  1.31987699e+02  4.86444568e+02
  4.86444568e+02  4.86444568e+02  6.20987417e+02  1.33616279e+03
  1.33616279e+03  1.33616279e+03  2.71877963e+03  3.02748686e+03
  3.02748686e+03  3.02748686e+03  6.64583647e+03  6.64583647e+03
  6.64583647e+03  9.12876736e+03  2.54805999e+04  7.62177766e+04]
E1 = -728.3668398055379  E_coul = 201.6596649518277
Extra cycle  E= -526.70717485371  delta_E= -4.89e-12  |g|= 2.32e-06  |ddm|= 4.02e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 100613.44418173641
E1 = -728.3668398055379  E_coul = 201.6596649518277
init E= -526.70717485371
    CPU time for initialize scf      3.78 sec, wall time      0.20 sec
  HOMO = -0.575020940491013  LUMO = 1.04276980001181
  mo_energy =
[-1.18575122e+02 -1.23040026e+01 -9.55679550e+00 -9.55679550e+00
 -9.55679550e+00 -1.24918117e+00 -5.75020940e-01 -5.75020940e-01
 -5.75020940e-01  1.04276980e+00  1.04276980e+00  1.04276980e+00
  7.52354794e+00  7.52354794e+00  7.52354794e+00  9.72915604e+00
  3.46467536e+01  3.46467536e+01  3.46467536e+01  1.11145636e+02
  1.31987703e+02  1.31987703e+02  1.31987703e+02  4.86444573e+02
  4.86444573e+02  4.86444573e+02  6.20987421e+02  1.33616279e+03
  1.33616279e+03  1.33616279e+03  2.71877964e+03  3.02748687e+03
  3.02748687e+03  3.02748687e+03  6.64583648e+03  6.64583648e+03
  6.64583648e+03  9.12876736e+03  2.54805999e+04  7.62177766e+04]
E1 = -728.3668306334118  E_coul = 201.6596557797025
cycle= 1 E= -526.707174853709  delta_E= 7.96e-13  |g|= 5.96e-07  |ddm|= 9.19e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3668306334118  E_coul = 201.6596557797025
  HOMO = -0.575021095956064  LUMO = 1.04276968187631
  mo_energy =
[-1.18575123e+02 -1.23040033e+01 -9.55679620e+00 -9.55679620e+00
 -9.55679620e+00 -1.24918136e+00 -5.75021096e-01 -5.75021096e-01
 -5.75021096e-01  1.04276968e+00  1.04276968e+00  1.04276968e+00
  7.52354752e+00  7.52354752e+00  7.52354752e+00  9.72915552e+00
  3.46467528e+01  3.46467528e+01  3.46467528e+01  1.11145635e+02
  1.31987702e+02  1.31987702e+02  1.31987702e+02  4.86444571e+02
  4.86444571e+02  4.86444571e+02  6.20987420e+02  1.33616279e+03
  1.33616279e+03  1.33616279e+03  2.71877963e+03  3.02748687e+03
  3.02748687e+03  3.02748687e+03  6.64583648e+03  6.64583648e+03
  6.64583648e+03  9.12876736e+03  2.54805999e+04  7.62177766e+04]
E1 = -728.3668328637442  E_coul = 201.65965801003546
Extra cycle  E= -526.707174853709  delta_E= 6.82e-13  |g|= 1.49e-07  |ddm|= 2.15e-07
    CPU time for scf_cycle      3.89 sec, wall time      0.31 sec
exp = [2.61827251e+04 7.61736013e+03 3.61741319e+03 1.59422232e+03
 3.94767026e+02 1.15719923e+02 3.77852421e+01 7.95980548e+00
 3.12470225e+00 3.98067768e-01 1.36280611e+03 6.64523008e+02
 2.99913317e+02 3.13138342e+02 6.19423345e+01 7.54780088e+00
 2.08616358e+01 7.85255423e-01 2.88809186e+00 2.26345134e-01]
grad_E = [-1.49756537e-06  3.09093519e-06 -1.81918248e-06  6.50437159e-05
 -1.98490458e-04  1.04096765e-04 -7.69699023e-05 -2.52670608e-04
  7.28764268e-04 -4.06310266e-03 -4.41239512e-07  5.92174343e-06
  2.92892237e-05  2.51756268e-05 -6.02845051e-04 -5.36982243e-03
  3.04004754e-03  9.66621542e-04  4.18351299e-03  1.05631432e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:00:41 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.7434963        1
[INPUT] 0    0    [1    /1   ]  7617.31703586        1
[INPUT] 0    0    [1    /1   ]  3617.42964875        1
[INPUT] 0    0    [1    /1   ]  1593.25857336        1
[INPUT] 0    0    [1    /1   ]  398.205157365        1
[INPUT] 0    0    [1    /1   ]  116.744618096        1
[INPUT] 0    0    [1    /1   ]  38.0050723051        1
[INPUT] 0    0    [1    /1   ]  7.9731614732         1
[INPUT] 0    0    [1    /1   ]  3.1319197222         1
[INPUT] 0    0    [1    /1   ]  0.397946343626       1
[INPUT] 1    0    [1    /1   ]  1362.81215408        1
[INPUT] 1    0    [1    /1   ]  664.463538001        1
[INPUT] 1    0    [1    /1   ]  299.632711537        1
[INPUT] 1    0    [1    /1   ]  312.896486267        1
[INPUT] 1    0    [1    /1   ]  62.21113989          1
[INPUT] 1    0    [1    /1   ]  7.36095235229        1
[INPUT] 1    0    [1    /1   ]  20.5733778887        1
[INPUT] 1    0    [1    /1   ]  0.778571031503       1
[INPUT] 1    0    [1    /1   ]  2.81862433618        1
[INPUT] 1    0    [1    /1   ]  0.225179382504       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.743496342027, 1.0]], [0, [7617.317035860299, 1.0]], [0, [3617.4296487451943, 1.0]], [0, [1593.2585733636752, 1.0]], [0, [398.2051573647754, 1.0]], [0, [116.7446180962595, 1.0]], [0, [38.00507230505879, 1.0]], [0, [7.973161473195814, 1.0]], [0, [3.1319197222011463, 1.0]], [0, [0.39794634362630166, 1.0]], [1, [1362.8121540760908, 1.0]], [1, [664.4635380009025, 1.0]], [1, [299.63271153728533, 1.0]], [1, [312.89648626687256, 1.0]], [1, [62.21113988999393, 1.0]], [1, [7.360952352294644, 1.0]], [1, [20.573377888700502, 1.0]], [1, [0.7785710315031807, 1.0]], [1, [2.8186243361766574, 1.0]], [1, [0.22517938250421987, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.74349634]
bas 1, expnt(s) = [7617.31703586]
bas 2, expnt(s) = [3617.42964875]
bas 3, expnt(s) = [1593.25857336]
bas 4, expnt(s) = [398.20515736]
bas 5, expnt(s) = [116.7446181]
bas 6, expnt(s) = [38.00507231]
bas 7, expnt(s) = [7.97316147]
bas 8, expnt(s) = [3.13191972]
bas 9, expnt(s) = [0.39794634]
bas 10, expnt(s) = [1362.81215408]
bas 11, expnt(s) = [664.463538]
bas 12, expnt(s) = [299.63271154]
bas 13, expnt(s) = [312.89648627]
bas 14, expnt(s) = [62.21113989]
bas 15, expnt(s) = [7.36095235]
bas 16, expnt(s) = [20.57337789]
bas 17, expnt(s) = [0.77857103]
bas 18, expnt(s) = [2.81862434]
bas 19, expnt(s) = [0.22517938]
CPU time:      1487.34
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61827435e+04 5.20027592e+03 7.61731704e+03 2.05999681e+03
 3.61742965e+03 1.17846067e+03 1.59325857e+03 6.37132446e+02
 3.98205157e+02 2.25213897e+02 1.16744618e+02 8.97310347e+01
 3.80050723e+01 3.86719611e+01 7.97316147e+00 1.19877574e+01
 3.13191972e+00 5.94802781e+00 3.97946344e-01 1.26585340e+00
 1.36281215e+03 2.41562430e+04 6.64463538e+02 9.84177281e+03
 2.99632712e+02 3.63681260e+03 3.12896486e+02 3.83915150e+03
 6.22111399e+01 5.09705818e+02 7.36095235e+00 3.53713716e+01
 2.05733779e+01 1.27825175e+02 7.78571032e-01 2.13357146e+00
 2.81862434e+00 1.06544464e+01 2.25179383e-01 4.52527704e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982747463337027
cond(S) = 99631.53388558616
E1 = -729.3769155023883  E_coul = 203.1189453680035
init E= -526.257970134385
    CPU time for initialize scf      0.70 sec, wall time      0.05 sec
  HOMO = -0.557041229786938  LUMO = 1.04361836092726
  mo_energy =
[-1.18334568e+02 -1.22081729e+01 -9.45174192e+00 -9.45174192e+00
 -9.45174192e+00 -1.22604256e+00 -5.57041230e-01 -5.57041230e-01
 -5.57041230e-01  1.04361836e+00  1.04361836e+00  1.04361836e+00
  7.38384177e+00  7.38384177e+00  7.38384177e+00  9.83748172e+00
  3.38500543e+01  3.38500543e+01  3.38500543e+01  1.12261828e+02
  1.30721047e+02  1.30721047e+02  1.30721047e+02  4.85518469e+02
  4.85518469e+02  4.85518469e+02  6.27080948e+02  1.33501737e+03
  1.33501737e+03  1.33501737e+03  2.73219129e+03  3.02578131e+03
  3.02578131e+03  3.02578131e+03  6.64383257e+03  6.64383257e+03
  6.64383257e+03  9.14382576e+03  2.54949837e+04  7.62311218e+04]
E1 = -727.9955571861351  E_coul = 201.28824086890475
cycle= 1 E= -526.70731631723  delta_E= -0.449  |g|= 0.184  |ddm|= 0.434
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.540153
diis-c [-0.2917649  1.       ]
  HOMO = -0.580943864095504  LUMO = 1.02784244775929
  mo_energy =
[-1.18626464e+02 -1.23306889e+01 -9.58443412e+00 -9.58443412e+00
 -9.58443412e+00 -1.25663221e+00 -5.80943864e-01 -5.80943864e-01
 -5.80943864e-01  1.02784245e+00  1.02784245e+00  1.02784245e+00
  7.30896341e+00  7.30896341e+00  7.30896341e+00  9.74855286e+00
  3.37108856e+01  3.37108856e+01  3.37108856e+01  1.12051391e+02
  1.30508094e+02  1.30508094e+02  1.30508094e+02  4.85228219e+02
  4.85228219e+02  4.85228219e+02  6.26748162e+02  1.33467146e+03
  1.33467146e+03  1.33467146e+03  2.73171141e+03  3.02536984e+03
  3.02536984e+03  3.02536984e+03  6.64330865e+03  6.64330865e+03
  6.64330865e+03  9.14322757e+03  2.54942917e+04  7.62303398e+04]
E1 = -728.4558179928043  E_coul = 201.74791345482546
cycle= 2 E= -526.707904537979  delta_E= -0.000588  |g|= 0.0334  |ddm|= 0.0384
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0666618
diis-c [-0.00266629  0.0727107   0.9272893 ]
  HOMO = -0.57429510226361  LUMO = 1.03290792089558
  mo_energy =
[-1.18568039e+02 -1.23000684e+01 -9.55251565e+00 -9.55251565e+00
 -9.55251565e+00 -1.24819278e+00 -5.74295102e-01 -5.74295102e-01
 -5.74295102e-01  1.03290792e+00  1.03290792e+00  1.03290792e+00
  7.32732001e+00  7.32732001e+00  7.32732001e+00  9.77277207e+00
  3.37435984e+01  3.37435984e+01  3.37435984e+01  1.12099657e+02
  1.30555483e+02  1.30555483e+02  1.30555483e+02  4.85285876e+02
  4.85285876e+02  4.85285876e+02  6.26808377e+02  1.33473292e+03
  1.33473292e+03  1.33473292e+03  2.73177593e+03  3.02543337e+03
  3.02543337e+03  3.02543337e+03  6.64337374e+03  6.64337374e+03
  6.64337374e+03  9.14329337e+03  2.54943580e+04  7.62304063e+04]
E1 = -728.3516189556398  E_coul = 201.6436801376294
cycle= 3 E= -526.70793881801  delta_E= -3.43e-05  |g|= 0.00482  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104659
diis-c [-4.51762561e-07 -1.11841995e-03  1.31077960e-01  8.70040460e-01]
  HOMO = -0.575212262146577  LUMO = 1.03222050649013
  mo_energy =
[-1.18575595e+02 -1.23041009e+01 -9.55682131e+00 -9.55682131e+00
 -9.55682131e+00 -1.24930367e+00 -5.75212262e-01 -5.75212262e-01
 -5.75212262e-01  1.03222051e+00  1.03222051e+00  1.03222051e+00
  7.32481857e+00  7.32481857e+00  7.32481857e+00  9.76967168e+00
  3.37392195e+01  3.37392195e+01  3.37392195e+01  1.12093418e+02
  1.30549300e+02  1.30549300e+02  1.30549300e+02  4.85278419e+02
  4.85278419e+02  4.85278419e+02  6.26800556e+02  1.33472495e+03
  1.33472495e+03  1.33472495e+03  2.73176738e+03  3.02542505e+03
  3.02542505e+03  3.02542505e+03  6.64336507e+03  6.64336507e+03
  6.64336507e+03  9.14328450e+03  2.54943489e+04  7.62303972e+04]
E1 = -728.3657951299789  E_coul = 201.65785547373002
cycle= 4 E= -526.707939656249  delta_E= -8.38e-07  |g|= 6.09e-05  |ddm|= 0.00131
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000124413
diis-c [-1.38820619e-09  6.49792056e-05 -9.09016355e-03 -7.10782439e-02
  1.08010343e+00]
  HOMO = -0.575199718249693  LUMO = 1.03222988991268
  mo_energy =
[-1.18575598e+02 -1.23040706e+01 -9.55680277e+00 -9.55680277e+00
 -9.55680277e+00 -1.24928384e+00 -5.75199718e-01 -5.75199718e-01
 -5.75199718e-01  1.03222989e+00  1.03222989e+00  1.03222989e+00
  7.32484014e+00  7.32484014e+00  7.32484014e+00  9.76970871e+00
  3.37392367e+01  3.37392367e+01  3.37392367e+01  1.12093430e+02
  1.30549309e+02  1.30549309e+02  1.30549309e+02  4.85278417e+02
  4.85278417e+02  4.85278417e+02  6.26800546e+02  1.33472493e+03
  1.33472493e+03  1.33472493e+03  2.73176735e+03  3.02542503e+03
  3.02542503e+03  3.02542503e+03  6.64336503e+03  6.64336503e+03
  6.64336503e+03  9.14328445e+03  2.54943489e+04  7.62303971e+04]
E1 = -728.3657908980083  E_coul = 201.65785124164134
cycle= 5 E= -526.707939656367  delta_E= -1.18e-10  |g|= 7.99e-06  |ddm|= 2.5e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3657908980083  E_coul = 201.65785124164134
  HOMO = -0.575203256846397  LUMO = 1.03222728174074
  mo_energy =
[-1.18575615e+02 -1.23040831e+01 -9.55681589e+00 -9.55681589e+00
 -9.55681589e+00 -1.24928819e+00 -5.75203257e-01 -5.75203257e-01
 -5.75203257e-01  1.03222728e+00  1.03222728e+00  1.03222728e+00
  7.32483152e+00  7.32483152e+00  7.32483152e+00  9.76969855e+00
  3.37392238e+01  3.37392238e+01  3.37392238e+01  1.12093415e+02
  1.30549293e+02  1.30549293e+02  1.30549293e+02  4.85278399e+02
  4.85278399e+02  4.85278399e+02  6.26800528e+02  1.33472492e+03
  1.33472492e+03  1.33472492e+03  2.73176733e+03  3.02542501e+03
  3.02542501e+03  3.02542501e+03  6.64336501e+03  6.64336501e+03
  6.64336501e+03  9.14328444e+03  2.54943489e+04  7.62303971e+04]
E1 = -728.3658301842968  E_coul = 201.65789052792533
Extra cycle  E= -526.707939656371  delta_E= -4.43e-12  |g|= 2.36e-06  |ddm|= 4.07e-06
    CPU time for scf_cycle      0.88 sec, wall time      0.24 sec
exp = [2.61827435e+04 7.61731704e+03 3.61742965e+03 1.59325857e+03
 3.98205157e+02 1.16744618e+02 3.80050723e+01 7.97316147e+00
 3.13191972e+00 3.97946344e-01 1.36281215e+03 6.64463538e+02
 2.99632712e+02 3.12896486e+02 6.22111399e+01 7.36095235e+00
 2.05733779e+01 7.78571032e-01 2.81862434e+00 2.25179383e-01]
E = -526.7079396563714
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:00:41 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.7434963        1
[INPUT] 0    0    [1    /1   ]  7617.31703586        1
[INPUT] 0    0    [1    /1   ]  3617.42964875        1
[INPUT] 0    0    [1    /1   ]  1593.25857336        1
[INPUT] 0    0    [1    /1   ]  398.205157365        1
[INPUT] 0    0    [1    /1   ]  116.744618096        1
[INPUT] 0    0    [1    /1   ]  38.0050723051        1
[INPUT] 0    0    [1    /1   ]  7.9731614732         1
[INPUT] 0    0    [1    /1   ]  3.1319197222         1
[INPUT] 0    0    [1    /1   ]  0.397946343626       1
[INPUT] 1    0    [1    /1   ]  1362.81215408        1
[INPUT] 1    0    [1    /1   ]  664.463538001        1
[INPUT] 1    0    [1    /1   ]  299.632711537        1
[INPUT] 1    0    [1    /1   ]  312.896486267        1
[INPUT] 1    0    [1    /1   ]  62.21113989          1
[INPUT] 1    0    [1    /1   ]  7.36095235229        1
[INPUT] 1    0    [1    /1   ]  20.5733778887        1
[INPUT] 1    0    [1    /1   ]  0.778571031503       1
[INPUT] 1    0    [1    /1   ]  2.81862433618        1
[INPUT] 1    0    [1    /1   ]  0.225179382504       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.743496342027, 1.0]], [0, [7617.317035860299, 1.0]], [0, [3617.4296487451943, 1.0]], [0, [1593.2585733636752, 1.0]], [0, [398.2051573647754, 1.0]], [0, [116.7446180962595, 1.0]], [0, [38.00507230505879, 1.0]], [0, [7.973161473195814, 1.0]], [0, [3.1319197222011463, 1.0]], [0, [0.39794634362630166, 1.0]], [1, [1362.8121540760908, 1.0]], [1, [664.4635380009025, 1.0]], [1, [299.63271153728533, 1.0]], [1, [312.89648626687256, 1.0]], [1, [62.21113988999393, 1.0]], [1, [7.360952352294644, 1.0]], [1, [20.573377888700502, 1.0]], [1, [0.7785710315031807, 1.0]], [1, [2.8186243361766574, 1.0]], [1, [0.22517938250421987, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.74349634]
bas 1, expnt(s) = [7617.31703586]
bas 2, expnt(s) = [3617.42964875]
bas 3, expnt(s) = [1593.25857336]
bas 4, expnt(s) = [398.20515736]
bas 5, expnt(s) = [116.7446181]
bas 6, expnt(s) = [38.00507231]
bas 7, expnt(s) = [7.97316147]
bas 8, expnt(s) = [3.13191972]
bas 9, expnt(s) = [0.39794634]
bas 10, expnt(s) = [1362.81215408]
bas 11, expnt(s) = [664.463538]
bas 12, expnt(s) = [299.63271154]
bas 13, expnt(s) = [312.89648627]
bas 14, expnt(s) = [62.21113989]
bas 15, expnt(s) = [7.36095235]
bas 16, expnt(s) = [20.57337789]
bas 17, expnt(s) = [0.77857103]
bas 18, expnt(s) = [2.81862434]
bas 19, expnt(s) = [0.22517938]
CPU time:      1488.45
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61827435e+04 5.20027592e+03 7.61731704e+03 2.05999681e+03
 3.61742965e+03 1.17846067e+03 1.59325857e+03 6.37132446e+02
 3.98205157e+02 2.25213897e+02 1.16744618e+02 8.97310347e+01
 3.80050723e+01 3.86719611e+01 7.97316147e+00 1.19877574e+01
 3.13191972e+00 5.94802781e+00 3.97946344e-01 1.26585340e+00
 1.36281215e+03 2.41562430e+04 6.64463538e+02 9.84177281e+03
 2.99632712e+02 3.63681260e+03 3.12896486e+02 3.83915150e+03
 6.22111399e+01 5.09705818e+02 7.36095235e+00 3.53713716e+01
 2.05733779e+01 1.27825175e+02 7.78571032e-01 2.13357146e+00
 2.81862434e+00 1.06544464e+01 2.25179383e-01 4.52527704e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982747463337027
cond(S) = 99631.53388558616
E1 = -729.3769155023883  E_coul = 203.1189453680035
init E= -526.257970134385
    CPU time for initialize scf      0.64 sec, wall time      0.05 sec
  HOMO = -0.557041229786938  LUMO = 1.04361836092726
  mo_energy =
[-1.18334568e+02 -1.22081729e+01 -9.45174192e+00 -9.45174192e+00
 -9.45174192e+00 -1.22604256e+00 -5.57041230e-01 -5.57041230e-01
 -5.57041230e-01  1.04361836e+00  1.04361836e+00  1.04361836e+00
  7.38384177e+00  7.38384177e+00  7.38384177e+00  9.83748172e+00
  3.38500543e+01  3.38500543e+01  3.38500543e+01  1.12261828e+02
  1.30721047e+02  1.30721047e+02  1.30721047e+02  4.85518469e+02
  4.85518469e+02  4.85518469e+02  6.27080948e+02  1.33501737e+03
  1.33501737e+03  1.33501737e+03  2.73219129e+03  3.02578131e+03
  3.02578131e+03  3.02578131e+03  6.64383257e+03  6.64383257e+03
  6.64383257e+03  9.14382576e+03  2.54949837e+04  7.62311218e+04]
E1 = -727.9955571861351  E_coul = 201.28824086890475
cycle= 1 E= -526.70731631723  delta_E= -0.449  |g|= 0.184  |ddm|= 0.434
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.540153
diis-c [-0.2917649  1.       ]
  HOMO = -0.580943864095504  LUMO = 1.02784244775929
  mo_energy =
[-1.18626464e+02 -1.23306889e+01 -9.58443412e+00 -9.58443412e+00
 -9.58443412e+00 -1.25663221e+00 -5.80943864e-01 -5.80943864e-01
 -5.80943864e-01  1.02784245e+00  1.02784245e+00  1.02784245e+00
  7.30896341e+00  7.30896341e+00  7.30896341e+00  9.74855286e+00
  3.37108856e+01  3.37108856e+01  3.37108856e+01  1.12051391e+02
  1.30508094e+02  1.30508094e+02  1.30508094e+02  4.85228219e+02
  4.85228219e+02  4.85228219e+02  6.26748162e+02  1.33467146e+03
  1.33467146e+03  1.33467146e+03  2.73171141e+03  3.02536984e+03
  3.02536984e+03  3.02536984e+03  6.64330865e+03  6.64330865e+03
  6.64330865e+03  9.14322757e+03  2.54942917e+04  7.62303398e+04]
E1 = -728.4558179928043  E_coul = 201.74791345482546
cycle= 2 E= -526.707904537979  delta_E= -0.000588  |g|= 0.0334  |ddm|= 0.0384
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0666618
diis-c [-0.00266629  0.0727107   0.9272893 ]
  HOMO = -0.57429510226361  LUMO = 1.03290792089558
  mo_energy =
[-1.18568039e+02 -1.23000684e+01 -9.55251565e+00 -9.55251565e+00
 -9.55251565e+00 -1.24819278e+00 -5.74295102e-01 -5.74295102e-01
 -5.74295102e-01  1.03290792e+00  1.03290792e+00  1.03290792e+00
  7.32732001e+00  7.32732001e+00  7.32732001e+00  9.77277207e+00
  3.37435984e+01  3.37435984e+01  3.37435984e+01  1.12099657e+02
  1.30555483e+02  1.30555483e+02  1.30555483e+02  4.85285876e+02
  4.85285876e+02  4.85285876e+02  6.26808377e+02  1.33473292e+03
  1.33473292e+03  1.33473292e+03  2.73177593e+03  3.02543337e+03
  3.02543337e+03  3.02543337e+03  6.64337374e+03  6.64337374e+03
  6.64337374e+03  9.14329337e+03  2.54943580e+04  7.62304063e+04]
E1 = -728.3516189556398  E_coul = 201.6436801376294
cycle= 3 E= -526.70793881801  delta_E= -3.43e-05  |g|= 0.00482  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104659
diis-c [-4.51762561e-07 -1.11841995e-03  1.31077960e-01  8.70040460e-01]
  HOMO = -0.575212262146577  LUMO = 1.03222050649013
  mo_energy =
[-1.18575595e+02 -1.23041009e+01 -9.55682131e+00 -9.55682131e+00
 -9.55682131e+00 -1.24930367e+00 -5.75212262e-01 -5.75212262e-01
 -5.75212262e-01  1.03222051e+00  1.03222051e+00  1.03222051e+00
  7.32481857e+00  7.32481857e+00  7.32481857e+00  9.76967168e+00
  3.37392195e+01  3.37392195e+01  3.37392195e+01  1.12093418e+02
  1.30549300e+02  1.30549300e+02  1.30549300e+02  4.85278419e+02
  4.85278419e+02  4.85278419e+02  6.26800556e+02  1.33472495e+03
  1.33472495e+03  1.33472495e+03  2.73176738e+03  3.02542505e+03
  3.02542505e+03  3.02542505e+03  6.64336507e+03  6.64336507e+03
  6.64336507e+03  9.14328450e+03  2.54943489e+04  7.62303972e+04]
E1 = -728.3657951299789  E_coul = 201.65785547373002
cycle= 4 E= -526.707939656249  delta_E= -8.38e-07  |g|= 6.09e-05  |ddm|= 0.00131
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000124413
diis-c [-1.38820619e-09  6.49792056e-05 -9.09016355e-03 -7.10782439e-02
  1.08010343e+00]
  HOMO = -0.575199718249693  LUMO = 1.03222988991268
  mo_energy =
[-1.18575598e+02 -1.23040706e+01 -9.55680277e+00 -9.55680277e+00
 -9.55680277e+00 -1.24928384e+00 -5.75199718e-01 -5.75199718e-01
 -5.75199718e-01  1.03222989e+00  1.03222989e+00  1.03222989e+00
  7.32484014e+00  7.32484014e+00  7.32484014e+00  9.76970871e+00
  3.37392367e+01  3.37392367e+01  3.37392367e+01  1.12093430e+02
  1.30549309e+02  1.30549309e+02  1.30549309e+02  4.85278417e+02
  4.85278417e+02  4.85278417e+02  6.26800546e+02  1.33472493e+03
  1.33472493e+03  1.33472493e+03  2.73176735e+03  3.02542503e+03
  3.02542503e+03  3.02542503e+03  6.64336503e+03  6.64336503e+03
  6.64336503e+03  9.14328445e+03  2.54943489e+04  7.62303971e+04]
E1 = -728.3657908980083  E_coul = 201.65785124164134
cycle= 5 E= -526.707939656367  delta_E= -1.18e-10  |g|= 7.99e-06  |ddm|= 2.5e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3657908980083  E_coul = 201.65785124164134
  HOMO = -0.575203256846397  LUMO = 1.03222728174074
  mo_energy =
[-1.18575615e+02 -1.23040831e+01 -9.55681589e+00 -9.55681589e+00
 -9.55681589e+00 -1.24928819e+00 -5.75203257e-01 -5.75203257e-01
 -5.75203257e-01  1.03222728e+00  1.03222728e+00  1.03222728e+00
  7.32483152e+00  7.32483152e+00  7.32483152e+00  9.76969855e+00
  3.37392238e+01  3.37392238e+01  3.37392238e+01  1.12093415e+02
  1.30549293e+02  1.30549293e+02  1.30549293e+02  4.85278399e+02
  4.85278399e+02  4.85278399e+02  6.26800528e+02  1.33472492e+03
  1.33472492e+03  1.33472492e+03  2.73176733e+03  3.02542501e+03
  3.02542501e+03  3.02542501e+03  6.64336501e+03  6.64336501e+03
  6.64336501e+03  9.14328444e+03  2.54943489e+04  7.62303971e+04]
E1 = -728.3658301842968  E_coul = 201.65789052792533
Extra cycle  E= -526.707939656371  delta_E= -4.43e-12  |g|= 2.36e-06  |ddm|= 4.07e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 99631.53388558616
E1 = -728.3658301842968  E_coul = 201.65789052792533
init E= -526.707939656371
    CPU time for initialize scf      3.88 sec, wall time      0.21 sec
  HOMO = -0.57520253999822  LUMO = 1.03222781655504
  mo_energy =
[-1.18575611e+02 -1.23040802e+01 -9.55681291e+00 -9.55681291e+00
 -9.55681291e+00 -1.24928729e+00 -5.75202540e-01 -5.75202540e-01
 -5.75202540e-01  1.03222782e+00  1.03222782e+00  1.03222782e+00
  7.32483336e+00  7.32483336e+00  7.32483336e+00  9.76970086e+00
  3.37392268e+01  3.37392268e+01  3.37392268e+01  1.12093419e+02
  1.30549297e+02  1.30549297e+02  1.30549297e+02  4.85278404e+02
  4.85278404e+02  4.85278404e+02  6.26800533e+02  1.33472492e+03
  1.33472492e+03  1.33472492e+03  2.73176734e+03  3.02542501e+03
  3.02542501e+03  3.02542501e+03  6.64336502e+03  6.64336502e+03
  6.64336502e+03  9.14328444e+03  2.54943489e+04  7.62303971e+04]
E1 = -728.3658208596456  E_coul = 201.65788120327403
cycle= 1 E= -526.707939656372  delta_E= -1.14e-13  |g|= 6.05e-07  |ddm|= 9.31e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3658208596456  E_coul = 201.65788120327403
  HOMO = -0.575202698215363  LUMO = 1.03222769783939
  mo_energy =
[-1.18575612e+02 -1.23040809e+01 -9.55681361e+00 -9.55681361e+00
 -9.55681361e+00 -1.24928749e+00 -5.75202698e-01 -5.75202698e-01
 -5.75202698e-01  1.03222770e+00  1.03222770e+00  1.03222770e+00
  7.32483294e+00  7.32483294e+00  7.32483294e+00  9.76970033e+00
  3.37392261e+01  3.37392261e+01  3.37392261e+01  1.12093418e+02
  1.30549296e+02  1.30549296e+02  1.30549296e+02  4.85278402e+02
  4.85278402e+02  4.85278402e+02  6.26800532e+02  1.33472492e+03
  1.33472492e+03  1.33472492e+03  2.73176734e+03  3.02542501e+03
  3.02542501e+03  3.02542501e+03  6.64336502e+03  6.64336502e+03
  6.64336502e+03  9.14328444e+03  2.54943489e+04  7.62303971e+04]
E1 = -728.3658231299561  E_coul = 201.6578834735859
Extra cycle  E= -526.70793965637  delta_E= 1.36e-12  |g|= 1.52e-07  |ddm|= 2.18e-07
    CPU time for scf_cycle      3.99 sec, wall time      0.32 sec
exp = [2.61827435e+04 7.61731704e+03 3.61742965e+03 1.59325857e+03
 3.98205157e+02 1.16744618e+02 3.80050723e+01 7.97316147e+00
 3.13191972e+00 3.97946344e-01 1.36281215e+03 6.64463538e+02
 2.99632712e+02 3.12896486e+02 6.22111399e+01 7.36095235e+00
 2.05733779e+01 7.78571032e-01 2.81862434e+00 2.25179383e-01]
grad_E = [-1.48302453e-06  2.94132548e-06 -1.91116150e-06  6.05237694e-05
 -1.67777699e-04  1.27192561e-04 -9.50836019e-05 -3.19730763e-04
  9.44551943e-04 -5.51534548e-03 -5.03067980e-07  5.18522195e-06
  2.50218451e-05  2.14688920e-05 -3.70872244e-04 -7.27437093e-03
  2.93483721e-03  1.16870950e-03  5.18726395e-03  1.45278135e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:00:45 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.7842569        1
[INPUT] 0    0    [1    /1   ]  7617.22131611        1
[INPUT] 0    0    [1    /1   ]  3617.46593249        1
[INPUT] 0    0    [1    /1   ]  1591.11573577        1
[INPUT] 0    0    [1    /1   ]  405.906485669        1
[INPUT] 0    0    [1    /1   ]  118.895599544        1
[INPUT] 0    0    [1    /1   ]  38.4523202498        1
[INPUT] 0    0    [1    /1   ]  8.00832888877        1
[INPUT] 0    0    [1    /1   ]  3.14638307227        1
[INPUT] 0    0    [1    /1   ]  0.397987586372       1
[INPUT] 1    0    [1    /1   ]  1362.82558497        1
[INPUT] 1    0    [1    /1   ]  664.332259952        1
[INPUT] 1    0    [1    /1   ]  299.013895676        1
[INPUT] 1    0    [1    /1   ]  312.363108986        1
[INPUT] 1    0    [1    /1   ]  62.5987292243        1
[INPUT] 1    0    [1    /1   ]  7.2857633441         1
[INPUT] 1    0    [1    /1   ]  20.4156374018        1
[INPUT] 1    0    [1    /1   ]  0.774262095524       1
[INPUT] 1    0    [1    /1   ]  2.78700160646        1
[INPUT] 1    0    [1    /1   ]  0.224294106249       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.784256873376, 1.0]], [0, [7617.221316110506, 1.0]], [0, [3617.465932491702, 1.0]], [0, [1591.1157357690427, 1.0]], [0, [405.90648566911057, 1.0]], [0, [118.89559954434631, 1.0]], [0, [38.45232024980254, 1.0]], [0, [8.008328888768729, 1.0]], [0, [3.146383072273525, 1.0]], [0, [0.3979875863715871, 1.0]], [1, [1362.8255849725545, 1.0]], [1, [664.3322599516995, 1.0]], [1, [299.0138956758988, 1.0]], [1, [312.36310898641835, 1.0]], [1, [62.59872922432756, 1.0]], [1, [7.285763344098721, 1.0]], [1, [20.415637401794378, 1.0]], [1, [0.7742620955235942, 1.0]], [1, [2.787001606458228, 1.0]], [1, [0.22429410624886598, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.78425687]
bas 1, expnt(s) = [7617.22131611]
bas 2, expnt(s) = [3617.46593249]
bas 3, expnt(s) = [1591.11573577]
bas 4, expnt(s) = [405.90648567]
bas 5, expnt(s) = [118.89559954]
bas 6, expnt(s) = [38.45232025]
bas 7, expnt(s) = [8.00832889]
bas 8, expnt(s) = [3.14638307]
bas 9, expnt(s) = [0.39798759]
bas 10, expnt(s) = [1362.82558497]
bas 11, expnt(s) = [664.33225995]
bas 12, expnt(s) = [299.01389568]
bas 13, expnt(s) = [312.36310899]
bas 14, expnt(s) = [62.59872922]
bas 15, expnt(s) = [7.28576334]
bas 16, expnt(s) = [20.4156374]
bas 17, expnt(s) = [0.7742621]
bas 18, expnt(s) = [2.78700161]
bas 19, expnt(s) = [0.22429411]
CPU time:      1498.12
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61827843e+04 5.20028199e+03 7.61722132e+03 2.05997740e+03
 3.61746593e+03 1.17846954e+03 1.59111574e+03 6.36489659e+02
 4.05906486e+02 2.28472807e+02 1.18895600e+02 9.09681495e+01
 3.84523202e+01 3.90127835e+01 8.00832889e+00 1.20273916e+01
 3.14638307e+00 5.96861714e+00 3.97987586e-01 1.26595179e+00
 1.36282558e+03 2.41565406e+04 6.64332260e+02 9.83934232e+03
 2.99013896e+02 3.62742638e+03 3.12363109e+02 3.83097276e+03
 6.25987292e+01 5.13678382e+02 7.28576334e+00 3.49203203e+01
 2.04156374e+01 1.26601273e+02 7.74262096e-01 2.11882160e+00
 2.78700161e+00 1.05052385e+01 2.24294106e-01 4.50304949e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982877839460286
cond(S) = 98034.32811161099
E1 = -729.3765959037906  E_coul = 203.1185364164663
init E= -526.258059487324
    CPU time for initialize scf      0.65 sec, wall time      0.05 sec
  HOMO = -0.557076521352441  LUMO = 1.03628312415078
  mo_energy =
[-1.18335054e+02 -1.22081422e+01 -9.45177850e+00 -9.45177850e+00
 -9.45177850e+00 -1.22609386e+00 -5.57076521e-01 -5.57076521e-01
 -5.57076521e-01  1.03628312e+00  1.03628312e+00  1.03628312e+00
  7.29147225e+00  7.29147225e+00  7.29147225e+00  9.93031393e+00
  3.34360300e+01  3.34360300e+01  3.34360300e+01  1.14262486e+02
  1.30260951e+02  1.30260951e+02  1.30260951e+02  4.85333747e+02
  4.85333747e+02  4.85333747e+02  6.39574821e+02  1.33388137e+03
  1.33388137e+03  1.33388137e+03  2.76050728e+03  3.02308183e+03
  3.02308183e+03  3.02308183e+03  6.64005200e+03  6.64005200e+03
  6.64005200e+03  9.17568316e+03  2.55252125e+04  7.62588851e+04]
E1 = -727.9947440714909  E_coul = 201.28640335428042
cycle= 1 E= -526.70834071721  delta_E= -0.45  |g|= 0.184  |ddm|= 0.411
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.539205
diis-c [-0.29074173  1.        ]
  HOMO = -0.581035074446329  LUMO = 1.02061378027458
  mo_energy =
[-1.18626997e+02 -1.23308140e+01 -9.58455003e+00 -9.58455003e+00
 -9.58455003e+00 -1.25678338e+00 -5.81035074e-01 -5.81035074e-01
 -5.81035074e-01  1.02061378e+00  1.02061378e+00  1.02061378e+00
  7.21709661e+00  7.21709661e+00  7.21709661e+00  9.84075571e+00
  3.32972889e+01  3.32972889e+01  3.32972889e+01  1.14050691e+02
  1.30047659e+02  1.30047659e+02  1.30047659e+02  4.85043470e+02
  4.85043470e+02  4.85043470e+02  6.39240298e+02  1.33353562e+03
  1.33353562e+03  1.33353562e+03  2.76002733e+03  3.02267058e+03
  3.02267058e+03  3.02267058e+03  6.63952854e+03  6.63952854e+03
  6.63952854e+03  9.17508576e+03  2.55245214e+04  7.62581041e+04]
E1 = -728.4551958982403  E_coul = 201.74626772785942
cycle= 2 E= -526.708928170381  delta_E= -0.000587  |g|= 0.0333  |ddm|= 0.0383
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0665383
diis-c [-0.00265703  0.07269235  0.92730765]
  HOMO = -0.574377247498831  LUMO = 1.0256455406441
  mo_energy =
[-1.18568570e+02 -1.23001803e+01 -9.55261832e+00 -9.55261832e+00
 -9.55261832e+00 -1.24833232e+00 -5.74377247e-01 -5.74377247e-01
 -5.74377247e-01  1.02564554e+00  1.02564554e+00  1.02564554e+00
  7.23532989e+00  7.23532989e+00  7.23532989e+00  9.86509088e+00
  3.33299039e+01  3.33299039e+01  3.33299039e+01  1.14099178e+02
  1.30095094e+02  1.30095094e+02  1.30095094e+02  4.85101136e+02
  4.85101136e+02  4.85101136e+02  6.39300613e+02  1.33359708e+03
  1.33359708e+03  1.33359708e+03  2.76009187e+03  3.02273412e+03
  3.02273412e+03  3.02273412e+03  6.63959363e+03  6.63959363e+03
  6.63959363e+03  9.17515156e+03  2.55245877e+04  7.62581706e+04]
E1 = -728.3509461457674  E_coul = 201.6419837022136
cycle= 3 E= -526.708962443554  delta_E= -3.43e-05  |g|= 0.00482  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.010446
diis-c [-4.40534785e-07 -1.11297455e-03  1.31099317e-01  8.70013657e-01]
  HOMO = -0.57529566897765  LUMO = 1.02496258732016
  mo_energy =
[-1.18576129e+02 -1.23042162e+01 -9.55692616e+00 -9.55692616e+00
 -9.55692616e+00 -1.24944559e+00 -5.75295669e-01 -5.75295669e-01
 -5.75295669e-01  1.02496259e+00  1.02496259e+00  1.02496259e+00
  7.23284494e+00  7.23284494e+00  7.23284494e+00  9.86197319e+00
  3.33255365e+01  3.33255365e+01  3.33255365e+01  1.14092909e+02
  1.30088903e+02  1.30088903e+02  1.30088903e+02  4.85093675e+02
  4.85093675e+02  4.85093675e+02  6.39292776e+02  1.33358910e+03
  1.33358910e+03  1.33358910e+03  2.76008331e+03  3.02272579e+03
  3.02272579e+03  3.02272579e+03  6.63958496e+03  6.63958496e+03
  6.63958496e+03  9.17514269e+03  2.55245786e+04  7.62581615e+04]
E1 = -728.365128248097  E_coul = 201.65616496630628
cycle= 4 E= -526.708963281791  delta_E= -8.38e-07  |g|= 6.01e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000123055
diis-c [-1.37512270e-09  6.44274413e-05 -9.04334707e-03 -7.06659177e-02
  1.07964484e+00]
  HOMO = -0.575283238804167  LUMO = 1.02497182042507
  mo_energy =
[-1.18576132e+02 -1.23041862e+01 -9.55690775e+00 -9.55690775e+00
 -9.55690775e+00 -1.24942599e+00 -5.75283239e-01 -5.75283239e-01
 -5.75283239e-01  1.02497182e+00  1.02497182e+00  1.02497182e+00
  7.23286631e+00  7.23286631e+00  7.23286631e+00  9.86200979e+00
  3.33255536e+01  3.33255536e+01  3.33255536e+01  1.14092921e+02
  1.30088911e+02  1.30088911e+02  1.30088911e+02  4.85093672e+02
  4.85093672e+02  4.85093672e+02  6.39292766e+02  1.33358909e+03
  1.33358909e+03  1.33358909e+03  2.76008328e+03  3.02272577e+03
  3.02272577e+03  3.02272577e+03  6.63958492e+03  6.63958492e+03
  6.63958492e+03  9.17514265e+03  2.55245786e+04  7.62581614e+04]
E1 = -728.3651238755325  E_coul = 201.6561605936288
cycle= 5 E= -526.708963281904  delta_E= -1.13e-10  |g|= 7.93e-06  |ddm|= 2.44e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3651238755325  E_coul = 201.6561605936288
  HOMO = -0.575286752721614  LUMO = 1.0249692500656
  mo_energy =
[-1.18576150e+02 -1.23041986e+01 -9.55692077e+00 -9.55692077e+00
 -9.55692077e+00 -1.24943031e+00 -5.75286753e-01 -5.75286753e-01
 -5.75286753e-01  1.02496925e+00  1.02496925e+00  1.02496925e+00
  7.23285781e+00  7.23285781e+00  7.23285781e+00  9.86199967e+00
  3.33255408e+01  3.33255408e+01  3.33255408e+01  1.14092905e+02
  1.30088896e+02  1.30088896e+02  1.30088896e+02  4.85093655e+02
  4.85093655e+02  4.85093655e+02  6.39292748e+02  1.33358907e+03
  1.33358907e+03  1.33358907e+03  2.76008326e+03  3.02272575e+03
  3.02272575e+03  3.02272575e+03  6.63958490e+03  6.63958490e+03
  6.63958490e+03  9.17514263e+03  2.55245785e+04  7.62581614e+04]
E1 = -728.3651628578173  E_coul = 201.6561995759087
Extra cycle  E= -526.708963281909  delta_E= -4.89e-12  |g|= 2.34e-06  |ddm|= 4.03e-06
    CPU time for scf_cycle      0.84 sec, wall time      0.22 sec
exp = [2.61827843e+04 7.61722132e+03 3.61746593e+03 1.59111574e+03
 4.05906486e+02 1.18895600e+02 3.84523202e+01 8.00832889e+00
 3.14638307e+00 3.97987586e-01 1.36282558e+03 6.64332260e+02
 2.99013896e+02 3.12363109e+02 6.25987292e+01 7.28576334e+00
 2.04156374e+01 7.74262096e-01 2.78700161e+00 2.24294106e-01]
E = -526.7089632819086
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:00:46 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.7842569        1
[INPUT] 0    0    [1    /1   ]  7617.22131611        1
[INPUT] 0    0    [1    /1   ]  3617.46593249        1
[INPUT] 0    0    [1    /1   ]  1591.11573577        1
[INPUT] 0    0    [1    /1   ]  405.906485669        1
[INPUT] 0    0    [1    /1   ]  118.895599544        1
[INPUT] 0    0    [1    /1   ]  38.4523202498        1
[INPUT] 0    0    [1    /1   ]  8.00832888877        1
[INPUT] 0    0    [1    /1   ]  3.14638307227        1
[INPUT] 0    0    [1    /1   ]  0.397987586372       1
[INPUT] 1    0    [1    /1   ]  1362.82558497        1
[INPUT] 1    0    [1    /1   ]  664.332259952        1
[INPUT] 1    0    [1    /1   ]  299.013895676        1
[INPUT] 1    0    [1    /1   ]  312.363108986        1
[INPUT] 1    0    [1    /1   ]  62.5987292243        1
[INPUT] 1    0    [1    /1   ]  7.2857633441         1
[INPUT] 1    0    [1    /1   ]  20.4156374018        1
[INPUT] 1    0    [1    /1   ]  0.774262095524       1
[INPUT] 1    0    [1    /1   ]  2.78700160646        1
[INPUT] 1    0    [1    /1   ]  0.224294106249       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.784256873376, 1.0]], [0, [7617.221316110506, 1.0]], [0, [3617.465932491702, 1.0]], [0, [1591.1157357690427, 1.0]], [0, [405.90648566911057, 1.0]], [0, [118.89559954434631, 1.0]], [0, [38.45232024980254, 1.0]], [0, [8.008328888768729, 1.0]], [0, [3.146383072273525, 1.0]], [0, [0.3979875863715871, 1.0]], [1, [1362.8255849725545, 1.0]], [1, [664.3322599516995, 1.0]], [1, [299.0138956758988, 1.0]], [1, [312.36310898641835, 1.0]], [1, [62.59872922432756, 1.0]], [1, [7.285763344098721, 1.0]], [1, [20.415637401794378, 1.0]], [1, [0.7742620955235942, 1.0]], [1, [2.787001606458228, 1.0]], [1, [0.22429410624886598, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.78425687]
bas 1, expnt(s) = [7617.22131611]
bas 2, expnt(s) = [3617.46593249]
bas 3, expnt(s) = [1591.11573577]
bas 4, expnt(s) = [405.90648567]
bas 5, expnt(s) = [118.89559954]
bas 6, expnt(s) = [38.45232025]
bas 7, expnt(s) = [8.00832889]
bas 8, expnt(s) = [3.14638307]
bas 9, expnt(s) = [0.39798759]
bas 10, expnt(s) = [1362.82558497]
bas 11, expnt(s) = [664.33225995]
bas 12, expnt(s) = [299.01389568]
bas 13, expnt(s) = [312.36310899]
bas 14, expnt(s) = [62.59872922]
bas 15, expnt(s) = [7.28576334]
bas 16, expnt(s) = [20.4156374]
bas 17, expnt(s) = [0.7742621]
bas 18, expnt(s) = [2.78700161]
bas 19, expnt(s) = [0.22429411]
CPU time:      1499.18
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61827843e+04 5.20028199e+03 7.61722132e+03 2.05997740e+03
 3.61746593e+03 1.17846954e+03 1.59111574e+03 6.36489659e+02
 4.05906486e+02 2.28472807e+02 1.18895600e+02 9.09681495e+01
 3.84523202e+01 3.90127835e+01 8.00832889e+00 1.20273916e+01
 3.14638307e+00 5.96861714e+00 3.97987586e-01 1.26595179e+00
 1.36282558e+03 2.41565406e+04 6.64332260e+02 9.83934232e+03
 2.99013896e+02 3.62742638e+03 3.12363109e+02 3.83097276e+03
 6.25987292e+01 5.13678382e+02 7.28576334e+00 3.49203203e+01
 2.04156374e+01 1.26601273e+02 7.74262096e-01 2.11882160e+00
 2.78700161e+00 1.05052385e+01 2.24294106e-01 4.50304949e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982877839460286
cond(S) = 98034.32811161099
E1 = -729.3765959037906  E_coul = 203.1185364164663
init E= -526.258059487324
    CPU time for initialize scf      0.62 sec, wall time      0.05 sec
  HOMO = -0.557076521352441  LUMO = 1.03628312415078
  mo_energy =
[-1.18335054e+02 -1.22081422e+01 -9.45177850e+00 -9.45177850e+00
 -9.45177850e+00 -1.22609386e+00 -5.57076521e-01 -5.57076521e-01
 -5.57076521e-01  1.03628312e+00  1.03628312e+00  1.03628312e+00
  7.29147225e+00  7.29147225e+00  7.29147225e+00  9.93031393e+00
  3.34360300e+01  3.34360300e+01  3.34360300e+01  1.14262486e+02
  1.30260951e+02  1.30260951e+02  1.30260951e+02  4.85333747e+02
  4.85333747e+02  4.85333747e+02  6.39574821e+02  1.33388137e+03
  1.33388137e+03  1.33388137e+03  2.76050728e+03  3.02308183e+03
  3.02308183e+03  3.02308183e+03  6.64005200e+03  6.64005200e+03
  6.64005200e+03  9.17568316e+03  2.55252125e+04  7.62588851e+04]
E1 = -727.9947440714909  E_coul = 201.28640335428042
cycle= 1 E= -526.70834071721  delta_E= -0.45  |g|= 0.184  |ddm|= 0.411
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.539205
diis-c [-0.29074173  1.        ]
  HOMO = -0.581035074446329  LUMO = 1.02061378027458
  mo_energy =
[-1.18626997e+02 -1.23308140e+01 -9.58455003e+00 -9.58455003e+00
 -9.58455003e+00 -1.25678338e+00 -5.81035074e-01 -5.81035074e-01
 -5.81035074e-01  1.02061378e+00  1.02061378e+00  1.02061378e+00
  7.21709661e+00  7.21709661e+00  7.21709661e+00  9.84075571e+00
  3.32972889e+01  3.32972889e+01  3.32972889e+01  1.14050691e+02
  1.30047659e+02  1.30047659e+02  1.30047659e+02  4.85043470e+02
  4.85043470e+02  4.85043470e+02  6.39240298e+02  1.33353562e+03
  1.33353562e+03  1.33353562e+03  2.76002733e+03  3.02267058e+03
  3.02267058e+03  3.02267058e+03  6.63952854e+03  6.63952854e+03
  6.63952854e+03  9.17508576e+03  2.55245214e+04  7.62581041e+04]
E1 = -728.4551958982403  E_coul = 201.74626772785942
cycle= 2 E= -526.708928170381  delta_E= -0.000587  |g|= 0.0333  |ddm|= 0.0383
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0665383
diis-c [-0.00265703  0.07269235  0.92730765]
  HOMO = -0.574377247498831  LUMO = 1.0256455406441
  mo_energy =
[-1.18568570e+02 -1.23001803e+01 -9.55261832e+00 -9.55261832e+00
 -9.55261832e+00 -1.24833232e+00 -5.74377247e-01 -5.74377247e-01
 -5.74377247e-01  1.02564554e+00  1.02564554e+00  1.02564554e+00
  7.23532989e+00  7.23532989e+00  7.23532989e+00  9.86509088e+00
  3.33299039e+01  3.33299039e+01  3.33299039e+01  1.14099178e+02
  1.30095094e+02  1.30095094e+02  1.30095094e+02  4.85101136e+02
  4.85101136e+02  4.85101136e+02  6.39300613e+02  1.33359708e+03
  1.33359708e+03  1.33359708e+03  2.76009187e+03  3.02273412e+03
  3.02273412e+03  3.02273412e+03  6.63959363e+03  6.63959363e+03
  6.63959363e+03  9.17515156e+03  2.55245877e+04  7.62581706e+04]
E1 = -728.3509461457674  E_coul = 201.6419837022136
cycle= 3 E= -526.708962443554  delta_E= -3.43e-05  |g|= 0.00482  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.010446
diis-c [-4.40534785e-07 -1.11297455e-03  1.31099317e-01  8.70013657e-01]
  HOMO = -0.57529566897765  LUMO = 1.02496258732016
  mo_energy =
[-1.18576129e+02 -1.23042162e+01 -9.55692616e+00 -9.55692616e+00
 -9.55692616e+00 -1.24944559e+00 -5.75295669e-01 -5.75295669e-01
 -5.75295669e-01  1.02496259e+00  1.02496259e+00  1.02496259e+00
  7.23284494e+00  7.23284494e+00  7.23284494e+00  9.86197319e+00
  3.33255365e+01  3.33255365e+01  3.33255365e+01  1.14092909e+02
  1.30088903e+02  1.30088903e+02  1.30088903e+02  4.85093675e+02
  4.85093675e+02  4.85093675e+02  6.39292776e+02  1.33358910e+03
  1.33358910e+03  1.33358910e+03  2.76008331e+03  3.02272579e+03
  3.02272579e+03  3.02272579e+03  6.63958496e+03  6.63958496e+03
  6.63958496e+03  9.17514269e+03  2.55245786e+04  7.62581615e+04]
E1 = -728.365128248097  E_coul = 201.65616496630628
cycle= 4 E= -526.708963281791  delta_E= -8.38e-07  |g|= 6.01e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000123055
diis-c [-1.37512270e-09  6.44274413e-05 -9.04334707e-03 -7.06659177e-02
  1.07964484e+00]
  HOMO = -0.575283238804167  LUMO = 1.02497182042507
  mo_energy =
[-1.18576132e+02 -1.23041862e+01 -9.55690775e+00 -9.55690775e+00
 -9.55690775e+00 -1.24942599e+00 -5.75283239e-01 -5.75283239e-01
 -5.75283239e-01  1.02497182e+00  1.02497182e+00  1.02497182e+00
  7.23286631e+00  7.23286631e+00  7.23286631e+00  9.86200979e+00
  3.33255536e+01  3.33255536e+01  3.33255536e+01  1.14092921e+02
  1.30088911e+02  1.30088911e+02  1.30088911e+02  4.85093672e+02
  4.85093672e+02  4.85093672e+02  6.39292766e+02  1.33358909e+03
  1.33358909e+03  1.33358909e+03  2.76008328e+03  3.02272577e+03
  3.02272577e+03  3.02272577e+03  6.63958492e+03  6.63958492e+03
  6.63958492e+03  9.17514265e+03  2.55245786e+04  7.62581614e+04]
E1 = -728.3651238755325  E_coul = 201.6561605936288
cycle= 5 E= -526.708963281904  delta_E= -1.13e-10  |g|= 7.93e-06  |ddm|= 2.44e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3651238755325  E_coul = 201.6561605936288
  HOMO = -0.575286752721614  LUMO = 1.0249692500656
  mo_energy =
[-1.18576150e+02 -1.23041986e+01 -9.55692077e+00 -9.55692077e+00
 -9.55692077e+00 -1.24943031e+00 -5.75286753e-01 -5.75286753e-01
 -5.75286753e-01  1.02496925e+00  1.02496925e+00  1.02496925e+00
  7.23285781e+00  7.23285781e+00  7.23285781e+00  9.86199967e+00
  3.33255408e+01  3.33255408e+01  3.33255408e+01  1.14092905e+02
  1.30088896e+02  1.30088896e+02  1.30088896e+02  4.85093655e+02
  4.85093655e+02  4.85093655e+02  6.39292748e+02  1.33358907e+03
  1.33358907e+03  1.33358907e+03  2.76008326e+03  3.02272575e+03
  3.02272575e+03  3.02272575e+03  6.63958490e+03  6.63958490e+03
  6.63958490e+03  9.17514263e+03  2.55245785e+04  7.62581614e+04]
E1 = -728.3651628578173  E_coul = 201.6561995759087
Extra cycle  E= -526.708963281909  delta_E= -4.89e-12  |g|= 2.34e-06  |ddm|= 4.03e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.22 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 98034.32811161099
E1 = -728.3651628578173  E_coul = 201.6561995759087
init E= -526.708963281909
    CPU time for initialize scf      3.78 sec, wall time      0.20 sec
  HOMO = -0.575286041050557  LUMO = 1.02496977692059
  mo_energy =
[-1.18576145e+02 -1.23041957e+01 -9.55691782e+00 -9.55691782e+00
 -9.55691782e+00 -1.24942942e+00 -5.75286041e-01 -5.75286041e-01
 -5.75286041e-01  1.02496978e+00  1.02496978e+00  1.02496978e+00
  7.23285962e+00  7.23285962e+00  7.23285962e+00  9.86200197e+00
  3.33255438e+01  3.33255438e+01  3.33255438e+01  1.14092909e+02
  1.30088900e+02  1.30088900e+02  1.30088900e+02  4.85093660e+02
  4.85093660e+02  4.85093660e+02  6.39292753e+02  1.33358908e+03
  1.33358908e+03  1.33358908e+03  2.76008327e+03  3.02272576e+03
  3.02272576e+03  3.02272576e+03  6.63958491e+03  6.63958491e+03
  6.63958491e+03  9.17514264e+03  2.55245786e+04  7.62581614e+04]
E1 = -728.3651536055635  E_coul = 201.65619032365382
cycle= 1 E= -526.70896328191  delta_E= -1.02e-12  |g|= 6e-07  |ddm|= 9.21e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3651536055635  E_coul = 201.65619032365382
  HOMO = -0.575286198130786  LUMO = 1.024969659981
  mo_energy =
[-1.18576146e+02 -1.23041964e+01 -9.55691852e+00 -9.55691852e+00
 -9.55691852e+00 -1.24942961e+00 -5.75286198e-01 -5.75286198e-01
 -5.75286198e-01  1.02496966e+00  1.02496966e+00  1.02496966e+00
  7.23285921e+00  7.23285921e+00  7.23285921e+00  9.86200144e+00
  3.33255431e+01  3.33255431e+01  3.33255431e+01  1.14092908e+02
  1.30088899e+02  1.30088899e+02  1.30088899e+02  4.85093658e+02
  4.85093658e+02  4.85093658e+02  6.39292751e+02  1.33358908e+03
  1.33358908e+03  1.33358908e+03  2.76008327e+03  3.02272576e+03
  3.02272576e+03  3.02272576e+03  6.63958491e+03  6.63958491e+03
  6.63958491e+03  9.17514264e+03  2.55245786e+04  7.62581614e+04]
E1 = -728.3651558581131  E_coul = 201.65619257620477
Extra cycle  E= -526.708963281908  delta_E= 1.25e-12  |g|= 1.5e-07  |ddm|= 2.15e-07
    CPU time for scf_cycle      3.89 sec, wall time      0.32 sec
exp = [2.61827843e+04 7.61722132e+03 3.61746593e+03 1.59111574e+03
 4.05906486e+02 1.18895600e+02 3.84523202e+01 8.00832889e+00
 3.14638307e+00 3.97987586e-01 1.36282558e+03 6.64332260e+02
 2.99013896e+02 3.12363109e+02 6.25987292e+01 7.28576334e+00
 2.04156374e+01 7.74262096e-01 2.78700161e+00 2.24294106e-01]
grad_E = [-1.44953228e-06  2.61651995e-06 -2.05945279e-06  5.06845494e-05
 -9.46247224e-05  1.25205932e-04 -7.45872730e-05 -2.95123558e-04
  8.71790401e-04 -5.36404413e-03 -5.67804109e-07  4.31764500e-06
  1.99811955e-05  1.71039455e-05 -2.23800851e-05 -5.02722973e-03
  1.48452711e-03 -6.77340858e-04  3.15993310e-03  1.75668210e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:00:50 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8217513        1
[INPUT] 0    0    [1    /1   ]  7617.1331417         1
[INPUT] 0    0    [1    /1   ]  3617.49918038        1
[INPUT] 0    0    [1    /1   ]  1589.14018125        1
[INPUT] 0    0    [1    /1   ]  413.05632542         1
[INPUT] 0    0    [1    /1   ]  120.737896926        1
[INPUT] 0    0    [1    /1   ]  38.8150988214        1
[INPUT] 0    0    [1    /1   ]  8.04639582264        1
[INPUT] 0    0    [1    /1   ]  3.15898588077        1
[INPUT] 0    0    [1    /1   ]  0.398285835064       1
[INPUT] 1    0    [1    /1   ]  1362.83795669        1
[INPUT] 1    0    [1    /1   ]  664.211821782        1
[INPUT] 1    0    [1    /1   ]  298.446528532        1
[INPUT] 1    0    [1    /1   ]  311.874069374        1
[INPUT] 1    0    [1    /1   ]  62.8354526025        1
[INPUT] 1    0    [1    /1   ]  7.39170000545        1
[INPUT] 1    0    [1    /1   ]  20.554188378         1
[INPUT] 1    0    [1    /1   ]  0.775721012666       1
[INPUT] 1    0    [1    /1   ]  2.82081849912        1
[INPUT] 1    0    [1    /1   ]  0.224111294745       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.821751297015, 1.0]], [0, [7617.133141702332, 1.0]], [0, [3617.4991803802027, 1.0]], [0, [1589.1401812494184, 1.0]], [0, [413.056325419686, 1.0]], [0, [120.73789692589244, 1.0]], [0, [38.81509882138961, 1.0]], [0, [8.046395822635413, 1.0]], [0, [3.158985880765362, 1.0]], [0, [0.39828583506403387, 1.0]], [1, [1362.8379566896986, 1.0]], [1, [664.2118217820129, 1.0]], [1, [298.44652853200785, 1.0]], [1, [311.8740693742783, 1.0]], [1, [62.835452602474746, 1.0]], [1, [7.391700005452621, 1.0]], [1, [20.554188378043328, 1.0]], [1, [0.775721012665633, 1.0]], [1, [2.8208184991162293, 1.0]], [1, [0.22411129474506988, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.8217513]
bas 1, expnt(s) = [7617.1331417]
bas 2, expnt(s) = [3617.49918038]
bas 3, expnt(s) = [1589.14018125]
bas 4, expnt(s) = [413.05632542]
bas 5, expnt(s) = [120.73789693]
bas 6, expnt(s) = [38.81509882]
bas 7, expnt(s) = [8.04639582]
bas 8, expnt(s) = [3.15898588]
bas 9, expnt(s) = [0.39828584]
bas 10, expnt(s) = [1362.83795669]
bas 11, expnt(s) = [664.21182178]
bas 12, expnt(s) = [298.44652853]
bas 13, expnt(s) = [311.87406937]
bas 14, expnt(s) = [62.8354526]
bas 15, expnt(s) = [7.39170001]
bas 16, expnt(s) = [20.55418838]
bas 17, expnt(s) = [0.77572101]
bas 18, expnt(s) = [2.8208185]
bas 19, expnt(s) = [0.22411129]
CPU time:      1508.87
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828218e+04 5.20028758e+03 7.61713314e+03 2.05995951e+03
 3.61749918e+03 1.17847766e+03 1.58914018e+03 6.35896861e+02
 4.13056325e+02 2.31484535e+02 1.20737897e+02 9.20232843e+01
 3.88150988e+01 3.92885089e+01 8.04639582e+00 1.20702445e+01
 3.15898588e+00 5.98653861e+00 3.98285835e-01 1.26666325e+00
 1.36283796e+03 2.41568147e+04 6.64211822e+02 9.83711263e+03
 2.98446529e+02 3.61882479e+03 3.11874069e+02 3.82347695e+03
 6.28354526e+01 5.16107686e+02 7.39170001e+00 3.55561564e+01
 2.05541884e+01 1.27676159e+02 7.75721013e-01 2.12381331e+00
 2.82081850e+00 1.06648149e+01 2.24111295e-01 4.49846218e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982822461484464
cond(S) = 96885.3341491162
E1 = -729.3771790699591  E_coul = 203.11990367771645
init E= -526.257275392243
    CPU time for initialize scf      0.68 sec, wall time      0.05 sec
  HOMO = -0.556990293099411  LUMO = 1.03694935059607
  mo_energy =
[-1.18335166e+02 -1.22079430e+01 -9.45174788e+00 -9.45174788e+00
 -9.45174788e+00 -1.22610532e+00 -5.56990293e-01 -5.56990293e-01
 -5.56990293e-01  1.03694935e+00  1.03694935e+00  1.03694935e+00
  7.38377954e+00  7.38377954e+00  7.38377954e+00  1.00203142e+01
  3.39027315e+01  3.39027315e+01  3.39027315e+01  1.15981713e+02
  1.31333732e+02  1.31333732e+02  1.31333732e+02  4.86479740e+02
  4.86479740e+02  4.86479740e+02  6.50590393e+02  1.33395892e+03
  1.33395892e+03  1.33395892e+03  2.78593154e+03  3.02162118e+03
  3.02162118e+03  3.02162118e+03  6.63750230e+03  6.63750230e+03
  6.63750230e+03  9.20452555e+03  2.55526461e+04  7.62840989e+04]
E1 = -727.9924722606235  E_coul = 201.28363199200945
cycle= 1 E= -526.708840268614  delta_E= -0.452  |g|= 0.183  |ddm|= 0.407
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538391
diis-c [-0.28986456  1.        ]
  HOMO = -0.581063554628784  LUMO = 1.02113998960425
  mo_energy =
[-1.18627166e+02 -1.23310305e+01 -9.58486150e+00 -9.58486150e+00
 -9.58486150e+00 -1.25701264e+00 -5.81063555e-01 -5.81063555e-01
 -5.81063555e-01  1.02113999e+00  1.02113999e+00  1.02113999e+00
  7.30833005e+00  7.30833005e+00  7.30833005e+00  9.92987012e+00
  3.37630974e+01  3.37630974e+01  3.37630974e+01  1.15768667e+02
  1.31120086e+02  1.31120086e+02  1.31120086e+02  4.86189553e+02
  4.86189553e+02  4.86189553e+02  6.50254311e+02  1.33361336e+03
  1.33361336e+03  1.33361336e+03  2.78545145e+03  3.02121010e+03
  3.02121010e+03  3.02121010e+03  6.63697919e+03  6.63697919e+03
  6.63697919e+03  9.20392875e+03  2.55519556e+04  7.62833187e+04]
E1 = -728.452857883959  E_coul = 201.74343160058527
cycle= 2 E= -526.709426283374  delta_E= -0.000586  |g|= 0.0333  |ddm|= 0.0385
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0665303
diis-c [-0.00265324  0.07284671  0.92715329]
  HOMO = -0.574397994075064  LUMO = 1.02619145125994
  mo_energy =
[-1.18568795e+02 -1.23004074e+01 -9.55294100e+00 -9.55294100e+00
 -9.55294100e+00 -1.24855037e+00 -5.74397994e-01 -5.74397994e-01
 -5.74397994e-01  1.02619145e+00  1.02619145e+00  1.02619145e+00
  7.32673125e+00  7.32673125e+00  7.32673125e+00  9.95429338e+00
  3.37958327e+01  3.37958327e+01  3.37958327e+01  1.15817290e+02
  1.31167514e+02  1.31167514e+02  1.31167514e+02  4.86247150e+02
  4.86247150e+02  4.86247150e+02  6.50314653e+02  1.33367474e+03
  1.33367474e+03  1.33367474e+03  2.78551594e+03  3.02127357e+03
  3.02127357e+03  3.02127357e+03  6.63704422e+03  6.63704422e+03
  6.63704422e+03  9.20399450e+03  2.55520218e+04  7.62833851e+04]
E1 = -728.3487368679921  E_coul = 201.63927638056427
cycle= 3 E= -526.709460487428  delta_E= -3.42e-05  |g|= 0.00481  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104244
diis-c [-4.27761162e-07 -1.10635364e-03  1.30904987e-01  8.70201367e-01]
  HOMO = -0.575313831287332  LUMO = 1.02550830771391
  mo_energy =
[-1.18576334e+02 -1.23044324e+01 -9.55723636e+00 -9.55723636e+00
 -9.55723636e+00 -1.24966174e+00 -5.75313831e-01 -5.75313831e-01
 -5.75313831e-01  1.02550831e+00  1.02550831e+00  1.02550831e+00
  7.32423122e+00  7.32423122e+00  7.32423122e+00  9.95117051e+00
  3.37914605e+01  3.37914605e+01  3.37914605e+01  1.15811016e+02
  1.31161335e+02  1.31161335e+02  1.31161335e+02  4.86239710e+02
  4.86239710e+02  4.86239710e+02  6.50306825e+02  1.33366679e+03
  1.33366679e+03  1.33366679e+03  2.78550740e+03  3.02126527e+03
  3.02126527e+03  3.02126527e+03  6.63703557e+03  6.63703557e+03
  6.63703557e+03  9.20398565e+03  2.55520128e+04  7.62833760e+04]
E1 = -728.3628628836882  E_coul = 201.6534015640439
cycle= 4 E= -526.709461319644  delta_E= -8.32e-07  |g|= 5.91e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122511
diis-c [-1.30805788e-09  6.40936118e-05 -9.02044397e-03 -7.06462955e-02
  1.07960265e+00]
  HOMO = -0.575301881476196  LUMO = 1.02551719963724
  mo_energy =
[-1.18576339e+02 -1.23044038e+01 -9.55721928e+00 -9.55721928e+00
 -9.55721928e+00 -1.24964284e+00 -5.75301881e-01 -5.75301881e-01
 -5.75301881e-01  1.02551720e+00  1.02551720e+00  1.02551720e+00
  7.32425158e+00  7.32425158e+00  7.32425158e+00  9.95120562e+00
  3.37914762e+01  3.37914762e+01  3.37914762e+01  1.15811026e+02
  1.31161343e+02  1.31161343e+02  1.31161343e+02  4.86239707e+02
  4.86239707e+02  4.86239707e+02  6.50306813e+02  1.33366677e+03
  1.33366677e+03  1.33366677e+03  2.78550737e+03  3.02126525e+03
  3.02126525e+03  3.02126525e+03  6.63703553e+03  6.63703553e+03
  6.63703553e+03  9.20398561e+03  2.55520128e+04  7.62833759e+04]
E1 = -728.3628613842877  E_coul = 201.65340006453437
cycle= 5 E= -526.709461319753  delta_E= -1.09e-10  |g|= 7.72e-06  |ddm|= 2.35e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3628613842877  E_coul = 201.65340006453437
  HOMO = -0.57530530984339  LUMO = 1.02551468445678
  mo_energy =
[-1.18576356e+02 -1.23044159e+01 -9.55723197e+00 -9.55723197e+00
 -9.55723197e+00 -1.24964705e+00 -5.75305310e-01 -5.75305310e-01
 -5.75305310e-01  1.02551468e+00  1.02551468e+00  1.02551468e+00
  7.32424323e+00  7.32424323e+00  7.32424323e+00  9.95119573e+00
  3.37914637e+01  3.37914637e+01  3.37914637e+01  1.15811010e+02
  1.31161327e+02  1.31161327e+02  1.31161327e+02  4.86239690e+02
  4.86239690e+02  4.86239690e+02  6.50306795e+02  1.33366676e+03
  1.33366676e+03  1.33366676e+03  2.78550735e+03  3.02126523e+03
  3.02126523e+03  3.02126523e+03  6.63703552e+03  6.63703552e+03
  6.63703552e+03  9.20398559e+03  2.55520128e+04  7.62833759e+04]
E1 = -728.3628993096722  E_coul = 201.65343798991523
Extra cycle  E= -526.709461319757  delta_E= -3.64e-12  |g|= 2.27e-06  |ddm|= 3.92e-06
    CPU time for scf_cycle      0.86 sec, wall time      0.23 sec
exp = [2.61828218e+04 7.61713314e+03 3.61749918e+03 1.58914018e+03
 4.13056325e+02 1.20737897e+02 3.88150988e+01 8.04639582e+00
 3.15898588e+00 3.98285835e-01 1.36283796e+03 6.64211822e+02
 2.98446529e+02 3.11874069e+02 6.28354526e+01 7.39170001e+00
 2.05541884e+01 7.75721013e-01 2.82081850e+00 2.24111295e-01]
E = -526.709461319757
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:00:51 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8217513        1
[INPUT] 0    0    [1    /1   ]  7617.1331417         1
[INPUT] 0    0    [1    /1   ]  3617.49918038        1
[INPUT] 0    0    [1    /1   ]  1589.14018125        1
[INPUT] 0    0    [1    /1   ]  413.05632542         1
[INPUT] 0    0    [1    /1   ]  120.737896926        1
[INPUT] 0    0    [1    /1   ]  38.8150988214        1
[INPUT] 0    0    [1    /1   ]  8.04639582264        1
[INPUT] 0    0    [1    /1   ]  3.15898588077        1
[INPUT] 0    0    [1    /1   ]  0.398285835064       1
[INPUT] 1    0    [1    /1   ]  1362.83795669        1
[INPUT] 1    0    [1    /1   ]  664.211821782        1
[INPUT] 1    0    [1    /1   ]  298.446528532        1
[INPUT] 1    0    [1    /1   ]  311.874069374        1
[INPUT] 1    0    [1    /1   ]  62.8354526025        1
[INPUT] 1    0    [1    /1   ]  7.39170000545        1
[INPUT] 1    0    [1    /1   ]  20.554188378         1
[INPUT] 1    0    [1    /1   ]  0.775721012666       1
[INPUT] 1    0    [1    /1   ]  2.82081849912        1
[INPUT] 1    0    [1    /1   ]  0.224111294745       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.821751297015, 1.0]], [0, [7617.133141702332, 1.0]], [0, [3617.4991803802027, 1.0]], [0, [1589.1401812494184, 1.0]], [0, [413.056325419686, 1.0]], [0, [120.73789692589244, 1.0]], [0, [38.81509882138961, 1.0]], [0, [8.046395822635413, 1.0]], [0, [3.158985880765362, 1.0]], [0, [0.39828583506403387, 1.0]], [1, [1362.8379566896986, 1.0]], [1, [664.2118217820129, 1.0]], [1, [298.44652853200785, 1.0]], [1, [311.8740693742783, 1.0]], [1, [62.835452602474746, 1.0]], [1, [7.391700005452621, 1.0]], [1, [20.554188378043328, 1.0]], [1, [0.775721012665633, 1.0]], [1, [2.8208184991162293, 1.0]], [1, [0.22411129474506988, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.8217513]
bas 1, expnt(s) = [7617.1331417]
bas 2, expnt(s) = [3617.49918038]
bas 3, expnt(s) = [1589.14018125]
bas 4, expnt(s) = [413.05632542]
bas 5, expnt(s) = [120.73789693]
bas 6, expnt(s) = [38.81509882]
bas 7, expnt(s) = [8.04639582]
bas 8, expnt(s) = [3.15898588]
bas 9, expnt(s) = [0.39828584]
bas 10, expnt(s) = [1362.83795669]
bas 11, expnt(s) = [664.21182178]
bas 12, expnt(s) = [298.44652853]
bas 13, expnt(s) = [311.87406937]
bas 14, expnt(s) = [62.8354526]
bas 15, expnt(s) = [7.39170001]
bas 16, expnt(s) = [20.55418838]
bas 17, expnt(s) = [0.77572101]
bas 18, expnt(s) = [2.8208185]
bas 19, expnt(s) = [0.22411129]
CPU time:      1509.97
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828218e+04 5.20028758e+03 7.61713314e+03 2.05995951e+03
 3.61749918e+03 1.17847766e+03 1.58914018e+03 6.35896861e+02
 4.13056325e+02 2.31484535e+02 1.20737897e+02 9.20232843e+01
 3.88150988e+01 3.92885089e+01 8.04639582e+00 1.20702445e+01
 3.15898588e+00 5.98653861e+00 3.98285835e-01 1.26666325e+00
 1.36283796e+03 2.41568147e+04 6.64211822e+02 9.83711263e+03
 2.98446529e+02 3.61882479e+03 3.11874069e+02 3.82347695e+03
 6.28354526e+01 5.16107686e+02 7.39170001e+00 3.55561564e+01
 2.05541884e+01 1.27676159e+02 7.75721013e-01 2.12381331e+00
 2.82081850e+00 1.06648149e+01 2.24111295e-01 4.49846218e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982822461484464
cond(S) = 96885.3341491162
E1 = -729.3771790699591  E_coul = 203.11990367771645
init E= -526.257275392243
    CPU time for initialize scf      0.63 sec, wall time      0.05 sec
  HOMO = -0.556990293099411  LUMO = 1.03694935059607
  mo_energy =
[-1.18335166e+02 -1.22079430e+01 -9.45174788e+00 -9.45174788e+00
 -9.45174788e+00 -1.22610532e+00 -5.56990293e-01 -5.56990293e-01
 -5.56990293e-01  1.03694935e+00  1.03694935e+00  1.03694935e+00
  7.38377954e+00  7.38377954e+00  7.38377954e+00  1.00203142e+01
  3.39027315e+01  3.39027315e+01  3.39027315e+01  1.15981713e+02
  1.31333732e+02  1.31333732e+02  1.31333732e+02  4.86479740e+02
  4.86479740e+02  4.86479740e+02  6.50590393e+02  1.33395892e+03
  1.33395892e+03  1.33395892e+03  2.78593154e+03  3.02162118e+03
  3.02162118e+03  3.02162118e+03  6.63750230e+03  6.63750230e+03
  6.63750230e+03  9.20452555e+03  2.55526461e+04  7.62840989e+04]
E1 = -727.9924722606235  E_coul = 201.28363199200945
cycle= 1 E= -526.708840268614  delta_E= -0.452  |g|= 0.183  |ddm|= 0.407
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.538391
diis-c [-0.28986456  1.        ]
  HOMO = -0.581063554628784  LUMO = 1.02113998960425
  mo_energy =
[-1.18627166e+02 -1.23310305e+01 -9.58486150e+00 -9.58486150e+00
 -9.58486150e+00 -1.25701264e+00 -5.81063555e-01 -5.81063555e-01
 -5.81063555e-01  1.02113999e+00  1.02113999e+00  1.02113999e+00
  7.30833005e+00  7.30833005e+00  7.30833005e+00  9.92987012e+00
  3.37630974e+01  3.37630974e+01  3.37630974e+01  1.15768667e+02
  1.31120086e+02  1.31120086e+02  1.31120086e+02  4.86189553e+02
  4.86189553e+02  4.86189553e+02  6.50254311e+02  1.33361336e+03
  1.33361336e+03  1.33361336e+03  2.78545145e+03  3.02121010e+03
  3.02121010e+03  3.02121010e+03  6.63697919e+03  6.63697919e+03
  6.63697919e+03  9.20392875e+03  2.55519556e+04  7.62833187e+04]
E1 = -728.452857883959  E_coul = 201.74343160058527
cycle= 2 E= -526.709426283374  delta_E= -0.000586  |g|= 0.0333  |ddm|= 0.0385
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0665303
diis-c [-0.00265324  0.07284671  0.92715329]
  HOMO = -0.574397994075064  LUMO = 1.02619145125994
  mo_energy =
[-1.18568795e+02 -1.23004074e+01 -9.55294100e+00 -9.55294100e+00
 -9.55294100e+00 -1.24855037e+00 -5.74397994e-01 -5.74397994e-01
 -5.74397994e-01  1.02619145e+00  1.02619145e+00  1.02619145e+00
  7.32673125e+00  7.32673125e+00  7.32673125e+00  9.95429338e+00
  3.37958327e+01  3.37958327e+01  3.37958327e+01  1.15817290e+02
  1.31167514e+02  1.31167514e+02  1.31167514e+02  4.86247150e+02
  4.86247150e+02  4.86247150e+02  6.50314653e+02  1.33367474e+03
  1.33367474e+03  1.33367474e+03  2.78551594e+03  3.02127357e+03
  3.02127357e+03  3.02127357e+03  6.63704422e+03  6.63704422e+03
  6.63704422e+03  9.20399450e+03  2.55520218e+04  7.62833851e+04]
E1 = -728.3487368679921  E_coul = 201.63927638056427
cycle= 3 E= -526.709460487428  delta_E= -3.42e-05  |g|= 0.00481  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104244
diis-c [-4.27761162e-07 -1.10635364e-03  1.30904987e-01  8.70201367e-01]
  HOMO = -0.575313831287332  LUMO = 1.02550830771391
  mo_energy =
[-1.18576334e+02 -1.23044324e+01 -9.55723636e+00 -9.55723636e+00
 -9.55723636e+00 -1.24966174e+00 -5.75313831e-01 -5.75313831e-01
 -5.75313831e-01  1.02550831e+00  1.02550831e+00  1.02550831e+00
  7.32423122e+00  7.32423122e+00  7.32423122e+00  9.95117051e+00
  3.37914605e+01  3.37914605e+01  3.37914605e+01  1.15811016e+02
  1.31161335e+02  1.31161335e+02  1.31161335e+02  4.86239710e+02
  4.86239710e+02  4.86239710e+02  6.50306825e+02  1.33366679e+03
  1.33366679e+03  1.33366679e+03  2.78550740e+03  3.02126527e+03
  3.02126527e+03  3.02126527e+03  6.63703557e+03  6.63703557e+03
  6.63703557e+03  9.20398565e+03  2.55520128e+04  7.62833760e+04]
E1 = -728.3628628836882  E_coul = 201.6534015640439
cycle= 4 E= -526.709461319644  delta_E= -8.32e-07  |g|= 5.91e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122511
diis-c [-1.30805788e-09  6.40936118e-05 -9.02044397e-03 -7.06462955e-02
  1.07960265e+00]
  HOMO = -0.575301881476196  LUMO = 1.02551719963724
  mo_energy =
[-1.18576339e+02 -1.23044038e+01 -9.55721928e+00 -9.55721928e+00
 -9.55721928e+00 -1.24964284e+00 -5.75301881e-01 -5.75301881e-01
 -5.75301881e-01  1.02551720e+00  1.02551720e+00  1.02551720e+00
  7.32425158e+00  7.32425158e+00  7.32425158e+00  9.95120562e+00
  3.37914762e+01  3.37914762e+01  3.37914762e+01  1.15811026e+02
  1.31161343e+02  1.31161343e+02  1.31161343e+02  4.86239707e+02
  4.86239707e+02  4.86239707e+02  6.50306813e+02  1.33366677e+03
  1.33366677e+03  1.33366677e+03  2.78550737e+03  3.02126525e+03
  3.02126525e+03  3.02126525e+03  6.63703553e+03  6.63703553e+03
  6.63703553e+03  9.20398561e+03  2.55520128e+04  7.62833759e+04]
E1 = -728.3628613842877  E_coul = 201.65340006453437
cycle= 5 E= -526.709461319753  delta_E= -1.09e-10  |g|= 7.72e-06  |ddm|= 2.35e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3628613842877  E_coul = 201.65340006453437
  HOMO = -0.57530530984339  LUMO = 1.02551468445678
  mo_energy =
[-1.18576356e+02 -1.23044159e+01 -9.55723197e+00 -9.55723197e+00
 -9.55723197e+00 -1.24964705e+00 -5.75305310e-01 -5.75305310e-01
 -5.75305310e-01  1.02551468e+00  1.02551468e+00  1.02551468e+00
  7.32424323e+00  7.32424323e+00  7.32424323e+00  9.95119573e+00
  3.37914637e+01  3.37914637e+01  3.37914637e+01  1.15811010e+02
  1.31161327e+02  1.31161327e+02  1.31161327e+02  4.86239690e+02
  4.86239690e+02  4.86239690e+02  6.50306795e+02  1.33366676e+03
  1.33366676e+03  1.33366676e+03  2.78550735e+03  3.02126523e+03
  3.02126523e+03  3.02126523e+03  6.63703552e+03  6.63703552e+03
  6.63703552e+03  9.20398559e+03  2.55520128e+04  7.62833759e+04]
E1 = -728.3628993096722  E_coul = 201.65343798991523
Extra cycle  E= -526.709461319757  delta_E= -3.64e-12  |g|= 2.27e-06  |ddm|= 3.92e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 96885.3341491162
E1 = -728.3628993096722  E_coul = 201.65343798991523
init E= -526.709461319757
    CPU time for initialize scf      4.66 sec, wall time      0.24 sec
  HOMO = -0.575304617476248  LUMO = 1.0255151984798
  mo_energy =
[-1.18576351e+02 -1.23044131e+01 -9.55722909e+00 -9.55722909e+00
 -9.55722909e+00 -1.24964619e+00 -5.75304617e-01 -5.75304617e-01
 -5.75304617e-01  1.02551520e+00  1.02551520e+00  1.02551520e+00
  7.32424500e+00  7.32424500e+00  7.32424500e+00  9.95119797e+00
  3.37914666e+01  3.37914666e+01  3.37914666e+01  1.15811014e+02
  1.31161331e+02  1.31161331e+02  1.31161331e+02  4.86239694e+02
  4.86239694e+02  4.86239694e+02  6.50306800e+02  1.33366676e+03
  1.33366676e+03  1.33366676e+03  2.78550736e+03  3.02126524e+03
  3.02126524e+03  3.02126524e+03  6.63703552e+03  6.63703552e+03
  6.63703552e+03  9.20398559e+03  2.55520128e+04  7.62833759e+04]
E1 = -728.36289031599  E_coul = 201.65342899623224
cycle= 1 E= -526.709461319758  delta_E= -6.82e-13  |g|= 5.83e-07  |ddm|= 8.95e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.36289031599  E_coul = 201.65342899623224
  HOMO = -0.57530477019192  LUMO = 1.0255150844514
  mo_energy =
[-1.18576352e+02 -1.23044138e+01 -9.55722977e+00 -9.55722977e+00
 -9.55722977e+00 -1.24964638e+00 -5.75304770e-01 -5.75304770e-01
 -5.75304770e-01  1.02551508e+00  1.02551508e+00  1.02551508e+00
  7.32424460e+00  7.32424460e+00  7.32424460e+00  9.95119746e+00
  3.37914659e+01  3.37914659e+01  3.37914659e+01  1.15811013e+02
  1.31161330e+02  1.31161330e+02  1.31161330e+02  4.86239693e+02
  4.86239693e+02  4.86239693e+02  6.50306799e+02  1.33366676e+03
  1.33366676e+03  1.33366676e+03  2.78550736e+03  3.02126524e+03
  3.02126524e+03  3.02126524e+03  6.63703552e+03  6.63703552e+03
  6.63703552e+03  9.20398559e+03  2.55520128e+04  7.62833759e+04]
E1 = -728.3628925033096  E_coul = 201.65343118355432
Extra cycle  E= -526.709461319755  delta_E= 2.39e-12  |g|= 1.46e-07  |ddm|= 2.09e-07
    CPU time for scf_cycle      4.77 sec, wall time      0.36 sec
exp = [2.61828218e+04 7.61713314e+03 3.61749918e+03 1.58914018e+03
 4.13056325e+02 1.20737897e+02 3.88150988e+01 8.04639582e+00
 3.15898588e+00 3.98285835e-01 1.36283796e+03 6.64211822e+02
 2.98446529e+02 3.11874069e+02 6.28354526e+01 7.39170001e+00
 2.05541884e+01 7.75721013e-01 2.82081850e+00 2.24111295e-01]
grad_E = [-1.41766189e-06  2.33119715e-06 -2.12551385e-06  4.20467162e-05
 -2.60183284e-05  8.76566595e-05 -4.46181804e-05 -1.54430631e-04
  4.83221384e-04 -2.45766075e-03 -5.86957882e-07  4.05022173e-06
  1.84511307e-05  1.57690101e-05  9.84791592e-05 -6.44765299e-04
  1.78526932e-04 -2.19058105e-03 -4.67441763e-04  1.18336240e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:00:55 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.831068         1
[INPUT] 0    0    [1    /1   ]  7617.11118475        1
[INPUT] 0    0    [1    /1   ]  3617.50739706        1
[INPUT] 0    0    [1    /1   ]  1588.64746011        1
[INPUT] 0    0    [1    /1   ]  414.873329034        1
[INPUT] 0    0    [1    /1   ]  121.074578825        1
[INPUT] 0    0    [1    /1   ]  38.8634905202        1
[INPUT] 0    0    [1    /1   ]  8.05642154203        1
[INPUT] 0    0    [1    /1   ]  3.16045448533        1
[INPUT] 0    0    [1    /1   ]  0.398487165722       1
[INPUT] 1    0    [1    /1   ]  1362.84103331        1
[INPUT] 1    0    [1    /1   ]  664.181965397        1
[INPUT] 1    0    [1    /1   ]  298.305945222        1
[INPUT] 1    0    [1    /1   ]  311.752893393        1
[INPUT] 1    0    [1    /1   ]  62.8723583153        1
[INPUT] 1    0    [1    /1   ]  7.45386238331        1
[INPUT] 1    0    [1    /1   ]  20.6374802695        1
[INPUT] 1    0    [1    /1   ]  0.777786275951       1
[INPUT] 1    0    [1    /1   ]  2.84826494967        1
[INPUT] 1    0    [1    /1   ]  0.224149763867       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.831067973042, 1.0]], [0, [7617.111184748157, 1.0]], [0, [3617.5073970564204, 1.0]], [0, [1588.6474601133023, 1.0]], [0, [414.87332903437573, 1.0]], [0, [121.07457882465721, 1.0]], [0, [38.86349052016264, 1.0]], [0, [8.056421542025678, 1.0]], [0, [3.1604544853307357, 1.0]], [0, [0.3984871657216506, 1.0]], [1, [1362.8410333126585, 1.0]], [1, [664.1819653973229, 1.0]], [1, [298.3059452218854, 1.0]], [1, [311.7528933931652, 1.0]], [1, [62.87235831526663, 1.0]], [1, [7.453862383310331, 1.0]], [1, [20.63748026945176, 1.0]], [1, [0.7777862759506212, 1.0]], [1, [2.848264949665144, 1.0]], [1, [0.22414976386719432, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.83106797]
bas 1, expnt(s) = [7617.11118475]
bas 2, expnt(s) = [3617.50739706]
bas 3, expnt(s) = [1588.64746011]
bas 4, expnt(s) = [414.87332903]
bas 5, expnt(s) = [121.07457882]
bas 6, expnt(s) = [38.86349052]
bas 7, expnt(s) = [8.05642154]
bas 8, expnt(s) = [3.16045449]
bas 9, expnt(s) = [0.39848717]
bas 10, expnt(s) = [1362.84103331]
bas 11, expnt(s) = [664.1819654]
bas 12, expnt(s) = [298.30594522]
bas 13, expnt(s) = [311.75289339]
bas 14, expnt(s) = [62.87235832]
bas 15, expnt(s) = [7.45386238]
bas 16, expnt(s) = [20.63748027]
bas 17, expnt(s) = [0.77778628]
bas 18, expnt(s) = [2.84826495]
bas 19, expnt(s) = [0.22414976]
CPU time:      1520.40
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828311e+04 5.20028897e+03 7.61711118e+03 2.05995506e+03
 3.61750740e+03 1.17847967e+03 1.58864746e+03 6.35748983e+02
 4.14873329e+02 2.32247828e+02 1.21074579e+02 9.22156750e+01
 3.88634905e+01 3.93252396e+01 8.05642154e+00 1.20815223e+01
 3.16045449e+00 5.98862583e+00 3.98487166e-01 1.26714344e+00
 1.36284103e+03 2.41568829e+04 6.64181965e+02 9.83655991e+03
 2.98305945e+02 3.61669411e+03 3.11752893e+02 3.82162007e+03
 6.28723583e+01 5.16486627e+02 7.45386238e+00 3.59303217e+01
 2.06374803e+01 1.28323215e+02 7.77786276e-01 2.13088365e+00
 2.84826495e+00 1.07946825e+01 2.24149764e-01 4.49942741e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982760506075046
cond(S) = 96656.2296548992
E1 = -729.3781842942697  E_coul = 203.12116973843018
init E= -526.25701455584
    CPU time for initialize scf      0.63 sec, wall time      0.05 sec
  HOMO = -0.556933212086096  LUMO = 1.03902644260592
  mo_energy =
[-1.18335083e+02 -1.22078343e+01 -9.45167854e+00 -9.45167854e+00
 -9.45167854e+00 -1.22607330e+00 -5.56933212e-01 -5.56933212e-01
 -5.56933212e-01  1.03902644e+00  1.03902644e+00  1.03902644e+00
  7.45610487e+00  7.45610487e+00  7.45610487e+00  1.00381108e+01
  3.42102210e+01  3.42102210e+01  3.42102210e+01  1.16271773e+02
  1.31906166e+02  1.31906166e+02  1.31906166e+02  4.87029414e+02
  4.87029414e+02  4.87029414e+02  6.52891370e+02  1.33420441e+03
  1.33420441e+03  1.33420441e+03  2.79174127e+03  3.02146446e+03
  3.02146446e+03  3.02146446e+03  6.63705590e+03  6.63705590e+03
  6.63705590e+03  9.21123808e+03  2.55590432e+04  7.62899763e+04]
E1 = -727.9899272494083  E_coul = 201.28103643668314
cycle= 1 E= -526.708890812725  delta_E= -0.452  |g|= 0.183  |ddm|= 0.407
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.538325
diis-c [-0.28979414  1.        ]
  HOMO = -0.581141028400978  LUMO = 1.02304722334171
  mo_energy =
[-1.18627270e+02 -1.23312097e+01 -9.58507695e+00 -9.58507695e+00
 -9.58507695e+00 -1.25717454e+00 -5.81141028e-01 -5.81141028e-01
 -5.81141028e-01  1.02304722e+00  1.02304722e+00  1.02304722e+00
  7.37986104e+00  7.37986104e+00  7.37986104e+00  9.94727764e+00
  3.40699849e+01  3.40699849e+01  3.40699849e+01  1.16058314e+02
  1.31692276e+02  1.31692276e+02  1.31692276e+02  4.86739101e+02
  4.86739101e+02  4.86739101e+02  6.52554750e+02  1.33385873e+03
  1.33385873e+03  1.33385873e+03  2.79126091e+03  3.02105323e+03
  3.02105323e+03  3.02105323e+03  6.63653265e+03  6.63653265e+03
  6.63653265e+03  9.21064119e+03  2.55583526e+04  7.62891960e+04]
E1 = -728.4507659760321  E_coul = 201.74128863607524
cycle= 2 E= -526.709477339957  delta_E= -0.000587  |g|= 0.0333  |ddm|= 0.0386
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0666188
diis-c [-0.00265661  0.07301534  0.92698466]
  HOMO = -0.574465958797426  LUMO = 1.0281243274132
  mo_energy =
[-1.18568877e+02 -1.23005603e+01 -9.55312956e+00 -9.55312956e+00
 -9.55312956e+00 -1.24869883e+00 -5.74465959e-01 -5.74465959e-01
 -5.74465959e-01  1.02812433e+00  1.02812433e+00  1.02812433e+00
  7.39839825e+00  7.39839825e+00  7.39839825e+00  9.97173973e+00
  3.41028219e+01  3.41028219e+01  3.41028219e+01  1.16106991e+02
  1.31739733e+02  1.31739733e+02  1.31739733e+02  4.86796712e+02
  4.86796712e+02  4.86796712e+02  6.52615133e+02  1.33392013e+03
  1.33392013e+03  1.33392013e+03  2.79132542e+03  3.02111672e+03
  3.02111672e+03  3.02111672e+03  6.63659770e+03  6.63659770e+03
  6.63659770e+03  9.21070695e+03  2.55584189e+04  7.62892625e+04]
E1 = -728.3465664586332  E_coul = 201.63705485959687
cycle= 3 E= -526.709511599036  delta_E= -3.43e-05  |g|= 0.0048  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104256
diis-c [-4.25419878e-07 -1.10525700e-03  1.30769809e-01  8.70335448e-01]
  HOMO = -0.575381838762563  LUMO = 1.02743856760303
  mo_energy =
[-1.18576410e+02 -1.23045831e+01 -9.55742250e+00 -9.55742250e+00
 -9.55742250e+00 -1.24981071e+00 -5.75381839e-01 -5.75381839e-01
 -5.75381839e-01  1.02743857e+00  1.02743857e+00  1.02743857e+00
  7.39588331e+00  7.39588331e+00  7.39588331e+00  9.96861552e+00
  3.40984425e+01  3.40984425e+01  3.40984425e+01  1.16100716e+02
  1.31733558e+02  1.31733558e+02  1.31733558e+02  4.86789278e+02
  4.86789278e+02  4.86789278e+02  6.52607307e+02  1.33391218e+03
  1.33391218e+03  1.33391218e+03  2.79131689e+03  3.02110842e+03
  3.02110842e+03  3.02110842e+03  6.63658906e+03  6.63658906e+03
  6.63658906e+03  9.21069811e+03  2.55584098e+04  7.62892534e+04]
E1 = -728.3606818524498  E_coul = 201.65116942233266
cycle= 4 E= -526.709512430117  delta_E= -8.31e-07  |g|= 5.89e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122651
diis-c [-1.28534629e-09  6.40242675e-05 -9.01052960e-03 -7.06837343e-02
  1.07963024e+00]
  HOMO = -0.575370082715168  LUMO = 1.02744733930869
  mo_energy =
[-1.18576415e+02 -1.23045550e+01 -9.55740593e+00 -9.55740593e+00
 -9.55740593e+00 -1.24979206e+00 -5.75370083e-01 -5.75370083e-01
 -5.75370083e-01  1.02744734e+00  1.02744734e+00  1.02744734e+00
  7.39590327e+00  7.39590327e+00  7.39590327e+00  9.96865009e+00
  3.40984577e+01  3.40984577e+01  3.40984577e+01  1.16100726e+02
  1.31733564e+02  1.31733564e+02  1.31733564e+02  4.86789274e+02
  4.86789274e+02  4.86789274e+02  6.52607295e+02  1.33391217e+03
  1.33391217e+03  1.33391217e+03  2.79131686e+03  3.02110840e+03
  3.02110840e+03  3.02110840e+03  6.63658902e+03  6.63658902e+03
  6.63658902e+03  9.21069807e+03  2.55584098e+04  7.62892533e+04]
E1 = -728.3606813778399  E_coul = 201.65116894761618
cycle= 5 E= -526.709512430224  delta_E= -1.07e-10  |g|= 7.66e-06  |ddm|= 2.33e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3606813778399  E_coul = 201.65116894761618
  HOMO = -0.575373488318743  LUMO = 1.02744483166664
  mo_energy =
[-1.18576432e+02 -1.23045670e+01 -9.55741852e+00 -9.55741852e+00
 -9.55741852e+00 -1.24979625e+00 -5.75373488e-01 -5.75373488e-01
 -5.75373488e-01  1.02744483e+00  1.02744483e+00  1.02744483e+00
  7.39589493e+00  7.39589493e+00  7.39589493e+00  9.96864026e+00
  3.40984453e+01  3.40984453e+01  3.40984453e+01  1.16100710e+02
  1.31733549e+02  1.31733549e+02  1.31733549e+02  4.86789257e+02
  4.86789257e+02  4.86789257e+02  6.52607277e+02  1.33391215e+03
  1.33391215e+03  1.33391215e+03  2.79131684e+03  3.02110838e+03
  3.02110838e+03  3.02110838e+03  6.63658900e+03  6.63658900e+03
  6.63658900e+03  9.21069805e+03  2.55584098e+04  7.62892533e+04]
E1 = -728.3607190294761  E_coul = 201.65120659924906
Extra cycle  E= -526.709512430227  delta_E= -3.3e-12  |g|= 2.26e-06  |ddm|= 3.9e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.22 sec
exp = [2.61828311e+04 7.61711118e+03 3.61750740e+03 1.58864746e+03
 4.14873329e+02 1.21074579e+02 3.88634905e+01 8.05642154e+00
 3.16045449e+00 3.98487166e-01 1.36284103e+03 6.64181965e+02
 2.98305945e+02 3.11752893e+02 6.28723583e+01 7.45386238e+00
 2.06374803e+01 7.77786276e-01 2.84826495e+00 2.24149764e-01]
E = -526.709512430227
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:00:55 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.831068         1
[INPUT] 0    0    [1    /1   ]  7617.11118475        1
[INPUT] 0    0    [1    /1   ]  3617.50739706        1
[INPUT] 0    0    [1    /1   ]  1588.64746011        1
[INPUT] 0    0    [1    /1   ]  414.873329034        1
[INPUT] 0    0    [1    /1   ]  121.074578825        1
[INPUT] 0    0    [1    /1   ]  38.8634905202        1
[INPUT] 0    0    [1    /1   ]  8.05642154203        1
[INPUT] 0    0    [1    /1   ]  3.16045448533        1
[INPUT] 0    0    [1    /1   ]  0.398487165722       1
[INPUT] 1    0    [1    /1   ]  1362.84103331        1
[INPUT] 1    0    [1    /1   ]  664.181965397        1
[INPUT] 1    0    [1    /1   ]  298.305945222        1
[INPUT] 1    0    [1    /1   ]  311.752893393        1
[INPUT] 1    0    [1    /1   ]  62.8723583153        1
[INPUT] 1    0    [1    /1   ]  7.45386238331        1
[INPUT] 1    0    [1    /1   ]  20.6374802695        1
[INPUT] 1    0    [1    /1   ]  0.777786275951       1
[INPUT] 1    0    [1    /1   ]  2.84826494967        1
[INPUT] 1    0    [1    /1   ]  0.224149763867       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.831067973042, 1.0]], [0, [7617.111184748157, 1.0]], [0, [3617.5073970564204, 1.0]], [0, [1588.6474601133023, 1.0]], [0, [414.87332903437573, 1.0]], [0, [121.07457882465721, 1.0]], [0, [38.86349052016264, 1.0]], [0, [8.056421542025678, 1.0]], [0, [3.1604544853307357, 1.0]], [0, [0.3984871657216506, 1.0]], [1, [1362.8410333126585, 1.0]], [1, [664.1819653973229, 1.0]], [1, [298.3059452218854, 1.0]], [1, [311.7528933931652, 1.0]], [1, [62.87235831526663, 1.0]], [1, [7.453862383310331, 1.0]], [1, [20.63748026945176, 1.0]], [1, [0.7777862759506212, 1.0]], [1, [2.848264949665144, 1.0]], [1, [0.22414976386719432, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.83106797]
bas 1, expnt(s) = [7617.11118475]
bas 2, expnt(s) = [3617.50739706]
bas 3, expnt(s) = [1588.64746011]
bas 4, expnt(s) = [414.87332903]
bas 5, expnt(s) = [121.07457882]
bas 6, expnt(s) = [38.86349052]
bas 7, expnt(s) = [8.05642154]
bas 8, expnt(s) = [3.16045449]
bas 9, expnt(s) = [0.39848717]
bas 10, expnt(s) = [1362.84103331]
bas 11, expnt(s) = [664.1819654]
bas 12, expnt(s) = [298.30594522]
bas 13, expnt(s) = [311.75289339]
bas 14, expnt(s) = [62.87235832]
bas 15, expnt(s) = [7.45386238]
bas 16, expnt(s) = [20.63748027]
bas 17, expnt(s) = [0.77778628]
bas 18, expnt(s) = [2.84826495]
bas 19, expnt(s) = [0.22414976]
CPU time:      1521.46
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828311e+04 5.20028897e+03 7.61711118e+03 2.05995506e+03
 3.61750740e+03 1.17847967e+03 1.58864746e+03 6.35748983e+02
 4.14873329e+02 2.32247828e+02 1.21074579e+02 9.22156750e+01
 3.88634905e+01 3.93252396e+01 8.05642154e+00 1.20815223e+01
 3.16045449e+00 5.98862583e+00 3.98487166e-01 1.26714344e+00
 1.36284103e+03 2.41568829e+04 6.64181965e+02 9.83655991e+03
 2.98305945e+02 3.61669411e+03 3.11752893e+02 3.82162007e+03
 6.28723583e+01 5.16486627e+02 7.45386238e+00 3.59303217e+01
 2.06374803e+01 1.28323215e+02 7.77786276e-01 2.13088365e+00
 2.84826495e+00 1.07946825e+01 2.24149764e-01 4.49942741e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982760506075046
cond(S) = 96656.2296548992
E1 = -729.3781842942697  E_coul = 203.12116973843018
init E= -526.25701455584
    CPU time for initialize scf      0.62 sec, wall time      0.05 sec
  HOMO = -0.556933212086096  LUMO = 1.03902644260592
  mo_energy =
[-1.18335083e+02 -1.22078343e+01 -9.45167854e+00 -9.45167854e+00
 -9.45167854e+00 -1.22607330e+00 -5.56933212e-01 -5.56933212e-01
 -5.56933212e-01  1.03902644e+00  1.03902644e+00  1.03902644e+00
  7.45610487e+00  7.45610487e+00  7.45610487e+00  1.00381108e+01
  3.42102210e+01  3.42102210e+01  3.42102210e+01  1.16271773e+02
  1.31906166e+02  1.31906166e+02  1.31906166e+02  4.87029414e+02
  4.87029414e+02  4.87029414e+02  6.52891370e+02  1.33420441e+03
  1.33420441e+03  1.33420441e+03  2.79174127e+03  3.02146446e+03
  3.02146446e+03  3.02146446e+03  6.63705590e+03  6.63705590e+03
  6.63705590e+03  9.21123808e+03  2.55590432e+04  7.62899763e+04]
E1 = -727.9899272494083  E_coul = 201.28103643668314
cycle= 1 E= -526.708890812725  delta_E= -0.452  |g|= 0.183  |ddm|= 0.407
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.538325
diis-c [-0.28979414  1.        ]
  HOMO = -0.581141028400978  LUMO = 1.02304722334171
  mo_energy =
[-1.18627270e+02 -1.23312097e+01 -9.58507695e+00 -9.58507695e+00
 -9.58507695e+00 -1.25717454e+00 -5.81141028e-01 -5.81141028e-01
 -5.81141028e-01  1.02304722e+00  1.02304722e+00  1.02304722e+00
  7.37986104e+00  7.37986104e+00  7.37986104e+00  9.94727764e+00
  3.40699849e+01  3.40699849e+01  3.40699849e+01  1.16058314e+02
  1.31692276e+02  1.31692276e+02  1.31692276e+02  4.86739101e+02
  4.86739101e+02  4.86739101e+02  6.52554750e+02  1.33385873e+03
  1.33385873e+03  1.33385873e+03  2.79126091e+03  3.02105323e+03
  3.02105323e+03  3.02105323e+03  6.63653265e+03  6.63653265e+03
  6.63653265e+03  9.21064119e+03  2.55583526e+04  7.62891960e+04]
E1 = -728.4507659760321  E_coul = 201.74128863607524
cycle= 2 E= -526.709477339957  delta_E= -0.000587  |g|= 0.0333  |ddm|= 0.0386
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0666188
diis-c [-0.00265661  0.07301534  0.92698466]
  HOMO = -0.574465958797426  LUMO = 1.0281243274132
  mo_energy =
[-1.18568877e+02 -1.23005603e+01 -9.55312956e+00 -9.55312956e+00
 -9.55312956e+00 -1.24869883e+00 -5.74465959e-01 -5.74465959e-01
 -5.74465959e-01  1.02812433e+00  1.02812433e+00  1.02812433e+00
  7.39839825e+00  7.39839825e+00  7.39839825e+00  9.97173973e+00
  3.41028219e+01  3.41028219e+01  3.41028219e+01  1.16106991e+02
  1.31739733e+02  1.31739733e+02  1.31739733e+02  4.86796712e+02
  4.86796712e+02  4.86796712e+02  6.52615133e+02  1.33392013e+03
  1.33392013e+03  1.33392013e+03  2.79132542e+03  3.02111672e+03
  3.02111672e+03  3.02111672e+03  6.63659770e+03  6.63659770e+03
  6.63659770e+03  9.21070695e+03  2.55584189e+04  7.62892625e+04]
E1 = -728.3465664586332  E_coul = 201.63705485959687
cycle= 3 E= -526.709511599036  delta_E= -3.43e-05  |g|= 0.0048  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104256
diis-c [-4.25419878e-07 -1.10525700e-03  1.30769809e-01  8.70335448e-01]
  HOMO = -0.575381838762563  LUMO = 1.02743856760303
  mo_energy =
[-1.18576410e+02 -1.23045831e+01 -9.55742250e+00 -9.55742250e+00
 -9.55742250e+00 -1.24981071e+00 -5.75381839e-01 -5.75381839e-01
 -5.75381839e-01  1.02743857e+00  1.02743857e+00  1.02743857e+00
  7.39588331e+00  7.39588331e+00  7.39588331e+00  9.96861552e+00
  3.40984425e+01  3.40984425e+01  3.40984425e+01  1.16100716e+02
  1.31733558e+02  1.31733558e+02  1.31733558e+02  4.86789278e+02
  4.86789278e+02  4.86789278e+02  6.52607307e+02  1.33391218e+03
  1.33391218e+03  1.33391218e+03  2.79131689e+03  3.02110842e+03
  3.02110842e+03  3.02110842e+03  6.63658906e+03  6.63658906e+03
  6.63658906e+03  9.21069811e+03  2.55584098e+04  7.62892534e+04]
E1 = -728.3606818524498  E_coul = 201.65116942233266
cycle= 4 E= -526.709512430117  delta_E= -8.31e-07  |g|= 5.89e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122651
diis-c [-1.28534629e-09  6.40242675e-05 -9.01052960e-03 -7.06837343e-02
  1.07963024e+00]
  HOMO = -0.575370082715168  LUMO = 1.02744733930869
  mo_energy =
[-1.18576415e+02 -1.23045550e+01 -9.55740593e+00 -9.55740593e+00
 -9.55740593e+00 -1.24979206e+00 -5.75370083e-01 -5.75370083e-01
 -5.75370083e-01  1.02744734e+00  1.02744734e+00  1.02744734e+00
  7.39590327e+00  7.39590327e+00  7.39590327e+00  9.96865009e+00
  3.40984577e+01  3.40984577e+01  3.40984577e+01  1.16100726e+02
  1.31733564e+02  1.31733564e+02  1.31733564e+02  4.86789274e+02
  4.86789274e+02  4.86789274e+02  6.52607295e+02  1.33391217e+03
  1.33391217e+03  1.33391217e+03  2.79131686e+03  3.02110840e+03
  3.02110840e+03  3.02110840e+03  6.63658902e+03  6.63658902e+03
  6.63658902e+03  9.21069807e+03  2.55584098e+04  7.62892533e+04]
E1 = -728.3606813778399  E_coul = 201.65116894761618
cycle= 5 E= -526.709512430224  delta_E= -1.07e-10  |g|= 7.66e-06  |ddm|= 2.33e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3606813778399  E_coul = 201.65116894761618
  HOMO = -0.575373488318743  LUMO = 1.02744483166664
  mo_energy =
[-1.18576432e+02 -1.23045670e+01 -9.55741852e+00 -9.55741852e+00
 -9.55741852e+00 -1.24979625e+00 -5.75373488e-01 -5.75373488e-01
 -5.75373488e-01  1.02744483e+00  1.02744483e+00  1.02744483e+00
  7.39589493e+00  7.39589493e+00  7.39589493e+00  9.96864026e+00
  3.40984453e+01  3.40984453e+01  3.40984453e+01  1.16100710e+02
  1.31733549e+02  1.31733549e+02  1.31733549e+02  4.86789257e+02
  4.86789257e+02  4.86789257e+02  6.52607277e+02  1.33391215e+03
  1.33391215e+03  1.33391215e+03  2.79131684e+03  3.02110838e+03
  3.02110838e+03  3.02110838e+03  6.63658900e+03  6.63658900e+03
  6.63658900e+03  9.21069805e+03  2.55584098e+04  7.62892533e+04]
E1 = -728.3607190294761  E_coul = 201.65120659924906
Extra cycle  E= -526.709512430227  delta_E= -3.3e-12  |g|= 2.26e-06  |ddm|= 3.9e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 96656.2296548992
E1 = -728.3607190294761  E_coul = 201.65120659924906
init E= -526.709512430227
    CPU time for initialize scf      3.85 sec, wall time      0.21 sec
  HOMO = -0.575372800801914  LUMO = 1.02744534394163
  mo_energy =
[-1.18576428e+02 -1.23045643e+01 -9.55741567e+00 -9.55741567e+00
 -9.55741567e+00 -1.24979539e+00 -5.75372801e-01 -5.75372801e-01
 -5.75372801e-01  1.02744534e+00  1.02744534e+00  1.02744534e+00
  7.39589671e+00  7.39589671e+00  7.39589671e+00  9.96864249e+00
  3.40984481e+01  3.40984481e+01  3.40984481e+01  1.16100714e+02
  1.31733553e+02  1.31733553e+02  1.31733553e+02  4.86789262e+02
  4.86789262e+02  4.86789262e+02  6.52607282e+02  1.33391215e+03
  1.33391215e+03  1.33391215e+03  2.79131685e+03  3.02110838e+03
  3.02110838e+03  3.02110838e+03  6.63658901e+03  6.63658901e+03
  6.63658901e+03  9.21069805e+03  2.55584098e+04  7.62892533e+04]
E1 = -728.3607101003381  E_coul = 201.65119767011106
cycle= 1 E= -526.709512430227  delta_E=    0  |g|= 5.79e-07  |ddm|= 8.89e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3607101003381  E_coul = 201.65119767011106
  HOMO = -0.57537295247878  LUMO = 1.02744523026932
  mo_energy =
[-1.18576429e+02 -1.23045649e+01 -9.55741635e+00 -9.55741635e+00
 -9.55741635e+00 -1.24979558e+00 -5.75372952e-01 -5.75372952e-01
 -5.75372952e-01  1.02744523e+00  1.02744523e+00  1.02744523e+00
  7.39589630e+00  7.39589630e+00  7.39589630e+00  9.96864198e+00
  3.40984475e+01  3.40984475e+01  3.40984475e+01  1.16100713e+02
  1.31733552e+02  1.31733552e+02  1.31733552e+02  4.86789260e+02
  4.86789260e+02  4.86789260e+02  6.52607281e+02  1.33391215e+03
  1.33391215e+03  1.33391215e+03  2.79131685e+03  3.02110838e+03
  3.02110838e+03  3.02110838e+03  6.63658901e+03  6.63658901e+03
  6.63658901e+03  9.21069805e+03  2.55584098e+04  7.62892533e+04]
E1 = -728.3607122717433  E_coul = 201.65119984151622
Extra cycle  E= -526.709512430227  delta_E=    0  |g|= 1.45e-07  |ddm|= 2.08e-07
    CPU time for scf_cycle      3.97 sec, wall time      0.32 sec
exp = [2.61828311e+04 7.61711118e+03 3.61750740e+03 1.58864746e+03
 4.14873329e+02 1.21074579e+02 3.88634905e+01 8.05642154e+00
 3.16045449e+00 3.98487166e-01 1.36284103e+03 6.64181965e+02
 2.98305945e+02 3.11752893e+02 6.28723583e+01 7.45386238e+00
 2.06374803e+01 7.77786276e-01 2.84826495e+00 2.24149764e-01]
grad_E = [-1.40820215e-06  2.25066703e-06 -2.12928517e-06  3.95348075e-05
  1.38892726e-07  3.89271447e-05 -2.85893993e-05 -3.50784522e-05
  1.22801557e-04 -4.56963510e-04 -5.86409146e-07  4.06931726e-06
  1.85739738e-05  1.58676437e-05  9.10091405e-05  2.20871126e-04
 -4.46684277e-05 -7.40208870e-04 -6.19976896e-04  3.08491802e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:01:00 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8323261        1
[INPUT] 0    0    [1    /1   ]  7617.10820284        1
[INPUT] 0    0    [1    /1   ]  3617.50849084        1
[INPUT] 0    0    [1    /1   ]  1588.58025918        1
[INPUT] 0    0    [1    /1   ]  415.134234948        1
[INPUT] 0    0    [1    /1   ]  121.071250683        1
[INPUT] 0    0    [1    /1   ]  38.8558065811        1
[INPUT] 0    0    [1    /1   ]  8.05664543837        1
[INPUT] 0    0    [1    /1   ]  3.15986307845        1
[INPUT] 0    0    [1    /1   ]  0.398537779282       1
[INPUT] 1    0    [1    /1   ]  1362.84144963        1
[INPUT] 1    0    [1    /1   ]  664.177957682        1
[INPUT] 1    0    [1    /1   ]  298.287096298        1
[INPUT] 1    0    [1    /1   ]  311.736646431        1
[INPUT] 1    0    [1    /1   ]  62.870144667         1
[INPUT] 1    0    [1    /1   ]  7.47374380324        1
[INPUT] 1    0    [1    /1   ]  20.6645090928        1
[INPUT] 1    0    [1    /1   ]  0.778695476408       1
[INPUT] 1    0    [1    /1   ]  2.85900464524        1
[INPUT] 1    0    [1    /1   ]  0.224227576037       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.832326132917, 1.0]], [0, [7617.108202837912, 1.0]], [0, [3617.5084908440963, 1.0]], [0, [1588.580259179052, 1.0]], [0, [415.1342349477255, 1.0]], [0, [121.0712506825846, 1.0]], [0, [38.855806581121485, 1.0]], [0, [8.056645438365262, 1.0]], [0, [3.1598630784503543, 1.0]], [0, [0.39853777928208345, 1.0]], [1, [1362.8414496295443, 1.0]], [1, [664.17795768212, 1.0]], [1, [298.28709629845986, 1.0]], [1, [311.7366464314015, 1.0]], [1, [62.87014466697881, 1.0]], [1, [7.473743803241105, 1.0]], [1, [20.66450909280993, 1.0]], [1, [0.7786954764075941, 1.0]], [1, [2.859004645236122, 1.0]], [1, [0.22422757603699003, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.83232613]
bas 1, expnt(s) = [7617.10820284]
bas 2, expnt(s) = [3617.50849084]
bas 3, expnt(s) = [1588.58025918]
bas 4, expnt(s) = [415.13423495]
bas 5, expnt(s) = [121.07125068]
bas 6, expnt(s) = [38.85580658]
bas 7, expnt(s) = [8.05664544]
bas 8, expnt(s) = [3.15986308]
bas 9, expnt(s) = [0.39853778]
bas 10, expnt(s) = [1362.84144963]
bas 11, expnt(s) = [664.17795768]
bas 12, expnt(s) = [298.2870963]
bas 13, expnt(s) = [311.73664643]
bas 14, expnt(s) = [62.87014467]
bas 15, expnt(s) = [7.4737438]
bas 16, expnt(s) = [20.66450909]
bas 17, expnt(s) = [0.77869548]
bas 18, expnt(s) = [2.85900465]
bas 19, expnt(s) = [0.22422758]
CPU time:      1531.09
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828323e+04 5.20028915e+03 7.61710820e+03 2.05995445e+03
 3.61750849e+03 1.17847994e+03 1.58858026e+03 6.35728813e+02
 4.15134235e+02 2.32357362e+02 1.21071251e+02 9.22137738e+01
 3.88558066e+01 3.93194080e+01 8.05664544e+00 1.20817741e+01
 3.15986308e+00 5.98778534e+00 3.98537779e-01 1.26726414e+00
 1.36284145e+03 2.41568921e+04 6.64177958e+02 9.83648571e+03
 2.98287096e+02 3.61640845e+03 3.11736646e+02 3.82137111e+03
 6.28701447e+01 5.16463896e+02 7.47374380e+00 3.60501562e+01
 2.06645091e+01 1.28533330e+02 7.78695476e-01 2.13399775e+00
 2.85900465e+00 1.08455847e+01 2.24227576e-01 4.50137993e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982732945169595
cond(S) = 96642.1445859227
E1 = -729.3784522065513  E_coul = 203.12154323657114
init E= -526.25690896998
    CPU time for initialize scf      0.64 sec, wall time      0.05 sec
  HOMO = -0.556916839669553  LUMO = 1.04018124301656
  mo_energy =
[-1.18335048e+02 -1.22078127e+01 -9.45165699e+00 -9.45165699e+00
 -9.45165699e+00 -1.22605966e+00 -5.56916840e-01 -5.56916840e-01
 -5.56916840e-01  1.04018124e+00  1.04018124e+00  1.04018124e+00
  7.48380349e+00  7.48380349e+00  7.48380349e+00  1.00367987e+01
  3.43169285e+01  3.43169285e+01  3.43169285e+01  1.16254142e+02
  1.32085116e+02  1.32085116e+02  1.32085116e+02  4.87191290e+02
  4.87191290e+02  4.87191290e+02  6.53030869e+02  1.33431231e+03
  1.33431231e+03  1.33431231e+03  2.79233168e+03  3.02151143e+03
  3.02151143e+03  3.02151143e+03  6.63705741e+03  6.63705741e+03
  6.63705741e+03  9.21196559e+03  2.55597384e+04  7.62906130e+04]
E1 = -727.9894128913287  E_coul = 201.2805181825783
cycle= 1 E= -526.70889470875  delta_E= -0.452  |g|= 0.183  |ddm|= 0.407
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.53835
diis-c [-0.28982065  1.        ]
  HOMO = -0.58116162352985  LUMO = 1.02414294549694
  mo_energy =
[-1.18627269e+02 -1.23312464e+01 -9.58511927e+00 -9.58511927e+00
 -9.58511927e+00 -1.25721084e+00 -5.81161624e-01 -5.81161624e-01
 -5.81161624e-01  1.02414295e+00  1.02414295e+00  1.02414295e+00
  7.40730540e+00  7.40730540e+00  7.40730540e+00  9.94590857e+00
  3.41765297e+01  3.41765297e+01  3.41765297e+01  1.16040643e+02
  1.31871188e+02  1.31871188e+02  1.31871188e+02  4.86900959e+02
  4.86900959e+02  4.86900959e+02  6.52694178e+02  1.33396661e+03
  1.33396661e+03  1.33396661e+03  2.79185126e+03  3.02110016e+03
  3.02110016e+03  3.02110016e+03  6.63653412e+03  6.63653412e+03
  6.63653412e+03  9.21136865e+03  2.55590478e+04  7.62898326e+04]
E1 = -728.4503531107218  E_coul = 201.74087167967411
cycle= 2 E= -526.709481431048  delta_E= -0.000587  |g|= 0.0333  |ddm|= 0.0386
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0666509
diis-c [-0.00265783  0.07307065  0.92692935]
  HOMO = -0.574484824615033  LUMO = 1.02922981268019
  mo_energy =
[-1.18568872e+02 -1.23005915e+01 -9.55316621e+00 -9.55316621e+00
 -9.55316621e+00 -1.24873253e+00 -5.74484825e-01 -5.74484825e-01
 -5.74484825e-01  1.02922981e+00  1.02922981e+00  1.02922981e+00
  7.42588866e+00  7.42588866e+00  7.42588866e+00  9.97037368e+00
  3.42093960e+01  3.42093960e+01  3.42093960e+01  1.16089323e+02
  1.31918649e+02  1.31918649e+02  1.31918649e+02  4.86958571e+02
  4.86958571e+02  4.86958571e+02  6.52754566e+02  1.33402801e+03
  1.33402801e+03  1.33402801e+03  2.79191577e+03  3.02116365e+03
  3.02116365e+03  3.02116365e+03  6.63659917e+03  6.63659917e+03
  6.63659917e+03  9.21143442e+03  2.55591141e+04  7.62898991e+04]
E1 = -728.3461387601386  E_coul = 201.63662305595085
cycle= 3 E= -526.709515704188  delta_E= -3.43e-05  |g|= 0.0048  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104264
diis-c [-4.25658460e-07 -1.10536642e-03  1.30722186e-01  8.70383181e-01]
  HOMO = -0.575400607285825  LUMO = 1.02854297187369
  mo_energy =
[-1.18576403e+02 -1.23046130e+01 -9.55745796e+00 -9.55745796e+00
 -9.55745796e+00 -1.24984435e+00 -5.75400607e-01 -5.75400607e-01
 -5.75400607e-01  1.02854297e+00  1.02854297e+00  1.02854297e+00
  7.42336857e+00  7.42336857e+00  7.42336857e+00  9.96725049e+00
  3.42050149e+01  3.42050149e+01  3.42050149e+01  1.16083051e+02
  1.31912476e+02  1.31912476e+02  1.31912476e+02  4.86951140e+02
  4.86951140e+02  4.86951140e+02  6.52746743e+02  1.33402007e+03
  1.33402007e+03  1.33402007e+03  2.79190725e+03  3.02115536e+03
  3.02115536e+03  3.02115536e+03  6.63659053e+03  6.63659053e+03
  6.63659053e+03  9.21142558e+03  2.55591050e+04  7.62898900e+04]
E1 = -728.3602497832442  E_coul = 201.65073324842862
cycle= 4 E= -526.709516534816  delta_E= -8.31e-07  |g|= 5.89e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122789
diis-c [-1.28090258e-09  6.40493780e-05 -9.01120672e-03 -7.07290247e-02
  1.07967618e+00]
  HOMO = -0.575388889833396  LUMO = 1.02855172638674
  mo_energy =
[-1.18576409e+02 -1.23045851e+01 -9.55744150e+00 -9.55744150e+00
 -9.55744150e+00 -1.24982575e+00 -5.75388890e-01 -5.75388890e-01
 -5.75388890e-01  1.02855173e+00  1.02855173e+00  1.02855173e+00
  7.42338845e+00  7.42338845e+00  7.42338845e+00  9.96728497e+00
  3.42050299e+01  3.42050299e+01  3.42050299e+01  1.16083060e+02
  1.31912483e+02  1.31912483e+02  1.31912483e+02  4.86951136e+02
  4.86951136e+02  4.86951136e+02  6.52746730e+02  1.33402005e+03
  1.33402005e+03  1.33402005e+03  2.79190722e+03  3.02115534e+03
  3.02115534e+03  3.02115534e+03  6.63659049e+03  6.63659049e+03
  6.63659049e+03  9.21142554e+03  2.55591050e+04  7.62898899e+04]
E1 = -728.360249533255  E_coul = 201.6507329983327
cycle= 5 E= -526.709516534922  delta_E= -1.07e-10  |g|= 7.66e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.360249533255  E_coul = 201.6507329983327
  HOMO = -0.575392292648481  LUMO = 1.02854921670589
  mo_energy =
[-1.18576426e+02 -1.23045971e+01 -9.55745408e+00 -9.55745408e+00
 -9.55745408e+00 -1.24982993e+00 -5.75392293e-01 -5.75392293e-01
 -5.75392293e-01  1.02854922e+00  1.02854922e+00  1.02854922e+00
  7.42338011e+00  7.42338011e+00  7.42338011e+00  9.96727515e+00
  3.42050175e+01  3.42050175e+01  3.42050175e+01  1.16083045e+02
  1.31912467e+02  1.31912467e+02  1.31912467e+02  4.86951119e+02
  4.86951119e+02  4.86951119e+02  6.52746713e+02  1.33402004e+03
  1.33402004e+03  1.33402004e+03  2.79190720e+03  3.02115532e+03
  3.02115532e+03  3.02115532e+03  6.63659048e+03  6.63659048e+03
  6.63659048e+03  9.21142552e+03  2.55591050e+04  7.62898899e+04]
E1 = -728.3602871511526  E_coul = 201.6507706162272
Extra cycle  E= -526.709516534925  delta_E= -3.18e-12  |g|= 2.25e-06  |ddm|= 3.89e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.22 sec
exp = [2.61828323e+04 7.61710820e+03 3.61750849e+03 1.58858026e+03
 4.15134235e+02 1.21071251e+02 3.88558066e+01 8.05664544e+00
 3.15986308e+00 3.98537779e-01 1.36284145e+03 6.64177958e+02
 2.98287096e+02 3.11736646e+02 6.28701447e+01 7.47374380e+00
 2.06645091e+01 7.78695476e-01 2.85900465e+00 2.24227576e-01]
E = -526.7095165349255
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:01:00 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8323261        1
[INPUT] 0    0    [1    /1   ]  7617.10820284        1
[INPUT] 0    0    [1    /1   ]  3617.50849084        1
[INPUT] 0    0    [1    /1   ]  1588.58025918        1
[INPUT] 0    0    [1    /1   ]  415.134234948        1
[INPUT] 0    0    [1    /1   ]  121.071250683        1
[INPUT] 0    0    [1    /1   ]  38.8558065811        1
[INPUT] 0    0    [1    /1   ]  8.05664543837        1
[INPUT] 0    0    [1    /1   ]  3.15986307845        1
[INPUT] 0    0    [1    /1   ]  0.398537779282       1
[INPUT] 1    0    [1    /1   ]  1362.84144963        1
[INPUT] 1    0    [1    /1   ]  664.177957682        1
[INPUT] 1    0    [1    /1   ]  298.287096298        1
[INPUT] 1    0    [1    /1   ]  311.736646431        1
[INPUT] 1    0    [1    /1   ]  62.870144667         1
[INPUT] 1    0    [1    /1   ]  7.47374380324        1
[INPUT] 1    0    [1    /1   ]  20.6645090928        1
[INPUT] 1    0    [1    /1   ]  0.778695476408       1
[INPUT] 1    0    [1    /1   ]  2.85900464524        1
[INPUT] 1    0    [1    /1   ]  0.224227576037       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.832326132917, 1.0]], [0, [7617.108202837912, 1.0]], [0, [3617.5084908440963, 1.0]], [0, [1588.580259179052, 1.0]], [0, [415.1342349477255, 1.0]], [0, [121.0712506825846, 1.0]], [0, [38.855806581121485, 1.0]], [0, [8.056645438365262, 1.0]], [0, [3.1598630784503543, 1.0]], [0, [0.39853777928208345, 1.0]], [1, [1362.8414496295443, 1.0]], [1, [664.17795768212, 1.0]], [1, [298.28709629845986, 1.0]], [1, [311.7366464314015, 1.0]], [1, [62.87014466697881, 1.0]], [1, [7.473743803241105, 1.0]], [1, [20.66450909280993, 1.0]], [1, [0.7786954764075941, 1.0]], [1, [2.859004645236122, 1.0]], [1, [0.22422757603699003, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.83232613]
bas 1, expnt(s) = [7617.10820284]
bas 2, expnt(s) = [3617.50849084]
bas 3, expnt(s) = [1588.58025918]
bas 4, expnt(s) = [415.13423495]
bas 5, expnt(s) = [121.07125068]
bas 6, expnt(s) = [38.85580658]
bas 7, expnt(s) = [8.05664544]
bas 8, expnt(s) = [3.15986308]
bas 9, expnt(s) = [0.39853778]
bas 10, expnt(s) = [1362.84144963]
bas 11, expnt(s) = [664.17795768]
bas 12, expnt(s) = [298.2870963]
bas 13, expnt(s) = [311.73664643]
bas 14, expnt(s) = [62.87014467]
bas 15, expnt(s) = [7.4737438]
bas 16, expnt(s) = [20.66450909]
bas 17, expnt(s) = [0.77869548]
bas 18, expnt(s) = [2.85900465]
bas 19, expnt(s) = [0.22422758]
CPU time:      1532.14
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828323e+04 5.20028915e+03 7.61710820e+03 2.05995445e+03
 3.61750849e+03 1.17847994e+03 1.58858026e+03 6.35728813e+02
 4.15134235e+02 2.32357362e+02 1.21071251e+02 9.22137738e+01
 3.88558066e+01 3.93194080e+01 8.05664544e+00 1.20817741e+01
 3.15986308e+00 5.98778534e+00 3.98537779e-01 1.26726414e+00
 1.36284145e+03 2.41568921e+04 6.64177958e+02 9.83648571e+03
 2.98287096e+02 3.61640845e+03 3.11736646e+02 3.82137111e+03
 6.28701447e+01 5.16463896e+02 7.47374380e+00 3.60501562e+01
 2.06645091e+01 1.28533330e+02 7.78695476e-01 2.13399775e+00
 2.85900465e+00 1.08455847e+01 2.24227576e-01 4.50137993e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982732945169595
cond(S) = 96642.1445859227
E1 = -729.3784522065513  E_coul = 203.12154323657114
init E= -526.25690896998
    CPU time for initialize scf      0.62 sec, wall time      0.05 sec
  HOMO = -0.556916839669553  LUMO = 1.04018124301656
  mo_energy =
[-1.18335048e+02 -1.22078127e+01 -9.45165699e+00 -9.45165699e+00
 -9.45165699e+00 -1.22605966e+00 -5.56916840e-01 -5.56916840e-01
 -5.56916840e-01  1.04018124e+00  1.04018124e+00  1.04018124e+00
  7.48380349e+00  7.48380349e+00  7.48380349e+00  1.00367987e+01
  3.43169285e+01  3.43169285e+01  3.43169285e+01  1.16254142e+02
  1.32085116e+02  1.32085116e+02  1.32085116e+02  4.87191290e+02
  4.87191290e+02  4.87191290e+02  6.53030869e+02  1.33431231e+03
  1.33431231e+03  1.33431231e+03  2.79233168e+03  3.02151143e+03
  3.02151143e+03  3.02151143e+03  6.63705741e+03  6.63705741e+03
  6.63705741e+03  9.21196559e+03  2.55597384e+04  7.62906130e+04]
E1 = -727.9894128913287  E_coul = 201.2805181825783
cycle= 1 E= -526.70889470875  delta_E= -0.452  |g|= 0.183  |ddm|= 0.407
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.53835
diis-c [-0.28982065  1.        ]
  HOMO = -0.58116162352985  LUMO = 1.02414294549694
  mo_energy =
[-1.18627269e+02 -1.23312464e+01 -9.58511927e+00 -9.58511927e+00
 -9.58511927e+00 -1.25721084e+00 -5.81161624e-01 -5.81161624e-01
 -5.81161624e-01  1.02414295e+00  1.02414295e+00  1.02414295e+00
  7.40730540e+00  7.40730540e+00  7.40730540e+00  9.94590857e+00
  3.41765297e+01  3.41765297e+01  3.41765297e+01  1.16040643e+02
  1.31871188e+02  1.31871188e+02  1.31871188e+02  4.86900959e+02
  4.86900959e+02  4.86900959e+02  6.52694178e+02  1.33396661e+03
  1.33396661e+03  1.33396661e+03  2.79185126e+03  3.02110016e+03
  3.02110016e+03  3.02110016e+03  6.63653412e+03  6.63653412e+03
  6.63653412e+03  9.21136865e+03  2.55590478e+04  7.62898326e+04]
E1 = -728.4503531107218  E_coul = 201.74087167967411
cycle= 2 E= -526.709481431048  delta_E= -0.000587  |g|= 0.0333  |ddm|= 0.0386
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0666509
diis-c [-0.00265783  0.07307065  0.92692935]
  HOMO = -0.574484824615033  LUMO = 1.02922981268019
  mo_energy =
[-1.18568872e+02 -1.23005915e+01 -9.55316621e+00 -9.55316621e+00
 -9.55316621e+00 -1.24873253e+00 -5.74484825e-01 -5.74484825e-01
 -5.74484825e-01  1.02922981e+00  1.02922981e+00  1.02922981e+00
  7.42588866e+00  7.42588866e+00  7.42588866e+00  9.97037368e+00
  3.42093960e+01  3.42093960e+01  3.42093960e+01  1.16089323e+02
  1.31918649e+02  1.31918649e+02  1.31918649e+02  4.86958571e+02
  4.86958571e+02  4.86958571e+02  6.52754566e+02  1.33402801e+03
  1.33402801e+03  1.33402801e+03  2.79191577e+03  3.02116365e+03
  3.02116365e+03  3.02116365e+03  6.63659917e+03  6.63659917e+03
  6.63659917e+03  9.21143442e+03  2.55591141e+04  7.62898991e+04]
E1 = -728.3461387601386  E_coul = 201.63662305595085
cycle= 3 E= -526.709515704188  delta_E= -3.43e-05  |g|= 0.0048  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104264
diis-c [-4.25658460e-07 -1.10536642e-03  1.30722186e-01  8.70383181e-01]
  HOMO = -0.575400607285825  LUMO = 1.02854297187369
  mo_energy =
[-1.18576403e+02 -1.23046130e+01 -9.55745796e+00 -9.55745796e+00
 -9.55745796e+00 -1.24984435e+00 -5.75400607e-01 -5.75400607e-01
 -5.75400607e-01  1.02854297e+00  1.02854297e+00  1.02854297e+00
  7.42336857e+00  7.42336857e+00  7.42336857e+00  9.96725049e+00
  3.42050149e+01  3.42050149e+01  3.42050149e+01  1.16083051e+02
  1.31912476e+02  1.31912476e+02  1.31912476e+02  4.86951140e+02
  4.86951140e+02  4.86951140e+02  6.52746743e+02  1.33402007e+03
  1.33402007e+03  1.33402007e+03  2.79190725e+03  3.02115536e+03
  3.02115536e+03  3.02115536e+03  6.63659053e+03  6.63659053e+03
  6.63659053e+03  9.21142558e+03  2.55591050e+04  7.62898900e+04]
E1 = -728.3602497832442  E_coul = 201.65073324842862
cycle= 4 E= -526.709516534816  delta_E= -8.31e-07  |g|= 5.89e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122789
diis-c [-1.28090258e-09  6.40493780e-05 -9.01120672e-03 -7.07290247e-02
  1.07967618e+00]
  HOMO = -0.575388889833396  LUMO = 1.02855172638674
  mo_energy =
[-1.18576409e+02 -1.23045851e+01 -9.55744150e+00 -9.55744150e+00
 -9.55744150e+00 -1.24982575e+00 -5.75388890e-01 -5.75388890e-01
 -5.75388890e-01  1.02855173e+00  1.02855173e+00  1.02855173e+00
  7.42338845e+00  7.42338845e+00  7.42338845e+00  9.96728497e+00
  3.42050299e+01  3.42050299e+01  3.42050299e+01  1.16083060e+02
  1.31912483e+02  1.31912483e+02  1.31912483e+02  4.86951136e+02
  4.86951136e+02  4.86951136e+02  6.52746730e+02  1.33402005e+03
  1.33402005e+03  1.33402005e+03  2.79190722e+03  3.02115534e+03
  3.02115534e+03  3.02115534e+03  6.63659049e+03  6.63659049e+03
  6.63659049e+03  9.21142554e+03  2.55591050e+04  7.62898899e+04]
E1 = -728.360249533255  E_coul = 201.6507329983327
cycle= 5 E= -526.709516534922  delta_E= -1.07e-10  |g|= 7.66e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.360249533255  E_coul = 201.6507329983327
  HOMO = -0.575392292648481  LUMO = 1.02854921670589
  mo_energy =
[-1.18576426e+02 -1.23045971e+01 -9.55745408e+00 -9.55745408e+00
 -9.55745408e+00 -1.24982993e+00 -5.75392293e-01 -5.75392293e-01
 -5.75392293e-01  1.02854922e+00  1.02854922e+00  1.02854922e+00
  7.42338011e+00  7.42338011e+00  7.42338011e+00  9.96727515e+00
  3.42050175e+01  3.42050175e+01  3.42050175e+01  1.16083045e+02
  1.31912467e+02  1.31912467e+02  1.31912467e+02  4.86951119e+02
  4.86951119e+02  4.86951119e+02  6.52746713e+02  1.33402004e+03
  1.33402004e+03  1.33402004e+03  2.79190720e+03  3.02115532e+03
  3.02115532e+03  3.02115532e+03  6.63659048e+03  6.63659048e+03
  6.63659048e+03  9.21142552e+03  2.55591050e+04  7.62898899e+04]
E1 = -728.3602871511526  E_coul = 201.6507706162272
Extra cycle  E= -526.709516534925  delta_E= -3.18e-12  |g|= 2.25e-06  |ddm|= 3.89e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.22 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 96642.1445859227
E1 = -728.3602871511526  E_coul = 201.6507706162272
init E= -526.709516534925
    CPU time for initialize scf      3.76 sec, wall time      0.20 sec
  HOMO = -0.575391605714795  LUMO = 1.02854972938192
  mo_energy =
[-1.18576421e+02 -1.23045943e+01 -9.55745123e+00 -9.55745123e+00
 -9.55745123e+00 -1.24982907e+00 -5.75391606e-01 -5.75391606e-01
 -5.75391606e-01  1.02854973e+00  1.02854973e+00  1.02854973e+00
  7.42338188e+00  7.42338188e+00  7.42338188e+00  9.96727738e+00
  3.42050204e+01  3.42050204e+01  3.42050204e+01  1.16083049e+02
  1.31912471e+02  1.31912471e+02  1.31912471e+02  4.86951124e+02
  4.86951124e+02  4.86951124e+02  6.52746718e+02  1.33402004e+03
  1.33402004e+03  1.33402004e+03  2.79190720e+03  3.02115532e+03
  3.02115532e+03  3.02115532e+03  6.63659048e+03  6.63659048e+03
  6.63659048e+03  9.21142553e+03  2.55591050e+04  7.62898899e+04]
E1 = -728.3602782297814  E_coul = 201.6507616948564
cycle= 1 E= -526.709516534925  delta_E= 4.55e-13  |g|= 5.78e-07  |ddm|= 8.89e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3602782297814  E_coul = 201.6507616948564
  HOMO = -0.575391757273501  LUMO = 1.02854961560903
  mo_energy =
[-1.18576422e+02 -1.23045950e+01 -9.55745190e+00 -9.55745190e+00
 -9.55745190e+00 -1.24982926e+00 -5.75391757e-01 -5.75391757e-01
 -5.75391757e-01  1.02854962e+00  1.02854962e+00  1.02854962e+00
  7.42338148e+00  7.42338148e+00  7.42338148e+00  9.96727687e+00
  3.42050197e+01  3.42050197e+01  3.42050197e+01  1.16083048e+02
  1.31912470e+02  1.31912470e+02  1.31912470e+02  4.86951122e+02
  4.86951122e+02  4.86951122e+02  6.52746717e+02  1.33402004e+03
  1.33402004e+03  1.33402004e+03  2.79190720e+03  3.02115532e+03
  3.02115532e+03  3.02115532e+03  6.63659048e+03  6.63659048e+03
  6.63659048e+03  9.21142553e+03  2.55591050e+04  7.62898899e+04]
E1 = -728.3602803992493  E_coul = 201.65076386432307
Extra cycle  E= -526.709516534926  delta_E= -1.25e-12  |g|= 1.45e-07  |ddm|= 2.08e-07
    CPU time for scf_cycle      3.87 sec, wall time      0.32 sec
exp = [2.61828323e+04 7.61710820e+03 3.61750849e+03 1.58858026e+03
 4.15134235e+02 1.21071251e+02 3.88558066e+01 8.05664544e+00
 3.15986308e+00 3.98537779e-01 1.36284145e+03 6.64177958e+02
 2.98287096e+02 3.11736646e+02 6.28701447e+01 7.47374380e+00
 2.06645091e+01 7.78695476e-01 2.85900465e+00 2.24227576e-01]
grad_E = [-1.40618586e-06  2.23373569e-06 -2.12807731e-06  3.89708952e-05
  8.62606785e-06  9.66743364e-06 -5.14361711e-06 -1.97765621e-06
 -2.11372013e-06  5.08079461e-05 -5.84492644e-07  4.10247456e-06
  1.87715643e-05  1.60354313e-05  7.55218958e-05  1.39918492e-04
 -1.56034080e-05 -6.08603836e-05 -1.83329523e-04  4.63489707e-05]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:01:04 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8321406        1
[INPUT] 0    0    [1    /1   ]  7617.10863558        1
[INPUT] 0    0    [1    /1   ]  3617.50832292        1
[INPUT] 0    0    [1    /1   ]  1588.58988386        1
[INPUT] 0    0    [1    /1   ]  415.103131782        1
[INPUT] 0    0    [1    /1   ]  121.04744828         1
[INPUT] 0    0    [1    /1   ]  38.8495430756        1
[INPUT] 0    0    [1    /1   ]  8.05653830445        1
[INPUT] 0    0    [1    /1   ]  3.15978003914        1
[INPUT] 0    0    [1    /1   ]  0.398536721929       1
[INPUT] 1    0    [1    /1   ]  1362.84138865        1
[INPUT] 1    0    [1    /1   ]  664.178559361        1
[INPUT] 1    0    [1    /1   ]  298.289935585        1
[INPUT] 1    0    [1    /1   ]  311.739093882        1
[INPUT] 1    0    [1    /1   ]  62.8674734205        1
[INPUT] 1    0    [1    /1   ]  7.47516605413        1
[INPUT] 1    0    [1    /1   ]  20.6669917872        1
[INPUT] 1    0    [1    /1   ]  0.778819527435       1
[INPUT] 1    0    [1    /1   ]  2.86022362427        1
[INPUT] 1    0    [1    /1   ]  0.224252348052       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.83214059649, 1.0]], [0, [7617.1086355780735, 1.0]], [0, [3617.5083229190996, 1.0]], [0, [1588.5898838593591, 1.0]], [0, [415.103131782024, 1.0]], [0, [121.04744828005316, 1.0]], [0, [38.849543075648455, 1.0]], [0, [8.0565383044513, 1.0]], [0, [3.1597800391357094, 1.0]], [0, [0.3985367219292568, 1.0]], [1, [1362.841388647979, 1.0]], [1, [664.1785593610365, 1.0]], [1, [298.289935585001, 1.0]], [1, [311.7390938820005, 1.0]], [1, [62.867473420503636, 1.0]], [1, [7.475166054126584, 1.0]], [1, [20.66699178721347, 1.0]], [1, [0.7788195274353985, 1.0]], [1, [2.8602236242706187, 1.0]], [1, [0.22425234805182717, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.8321406]
bas 1, expnt(s) = [7617.10863558]
bas 2, expnt(s) = [3617.50832292]
bas 3, expnt(s) = [1588.58988386]
bas 4, expnt(s) = [415.10313178]
bas 5, expnt(s) = [121.04744828]
bas 6, expnt(s) = [38.84954308]
bas 7, expnt(s) = [8.0565383]
bas 8, expnt(s) = [3.15978004]
bas 9, expnt(s) = [0.39853672]
bas 10, expnt(s) = [1362.84138865]
bas 11, expnt(s) = [664.17855936]
bas 12, expnt(s) = [298.28993559]
bas 13, expnt(s) = [311.73909388]
bas 14, expnt(s) = [62.86747342]
bas 15, expnt(s) = [7.47516605]
bas 16, expnt(s) = [20.66699179]
bas 17, expnt(s) = [0.77881953]
bas 18, expnt(s) = [2.86022362]
bas 19, expnt(s) = [0.22425235]
CPU time:      1541.77
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828321e+04 5.20028913e+03 7.61710864e+03 2.05995454e+03
 3.61750832e+03 1.17847990e+03 1.58858988e+03 6.35731702e+02
 4.15103132e+02 2.32344305e+02 1.21047448e+02 9.22001767e+01
 3.88495431e+01 3.93146543e+01 8.05653830e+00 1.20816536e+01
 3.15978004e+00 5.98766732e+00 3.98536722e-01 1.26726162e+00
 1.36284139e+03 2.41568908e+04 6.64178559e+02 9.83649685e+03
 2.98289936e+02 3.61645148e+03 3.11739094e+02 3.82140862e+03
 6.28674734e+01 5.16436467e+02 7.47516605e+00 3.60587318e+01
 2.06669918e+01 1.28552633e+02 7.78819527e-01 2.13442271e+00
 2.86022362e+00 1.08513652e+01 2.24252348e-01 4.50200156e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982728926773362
cond(S) = 96650.66580914432
E1 = -729.3784343881383  E_coul = 203.12154416840858
init E= -526.25689021973
    CPU time for initialize scf      7.06 sec, wall time      0.35 sec
  HOMO = -0.556916274947915  LUMO = 1.04039449207776
  mo_energy =
[-1.18335048e+02 -1.22078134e+01 -9.45165744e+00 -9.45165744e+00
 -9.45165744e+00 -1.22605908e+00 -5.56916275e-01 -5.56916275e-01
 -5.56916275e-01  1.04039449e+00  1.04039449e+00  1.04039449e+00
  7.48683900e+00  7.48683900e+00  7.48683900e+00  1.00362360e+01
  3.43268000e+01  3.43268000e+01  3.43268000e+01  1.16230747e+02
  1.32098863e+02  1.32098863e+02  1.32098863e+02  4.87201906e+02
  4.87201906e+02  4.87201906e+02  6.52926391e+02  1.33432571e+03
  1.33432571e+03  1.33432571e+03  2.79214857e+03  3.02153120e+03
  3.02153120e+03  3.02153120e+03  6.63708140e+03  6.63708140e+03
  6.63708140e+03  9.21176921e+03  2.55595517e+04  7.62904407e+04]
E1 = -727.9895463558453  E_coul = 201.28065144091943
cycle= 1 E= -526.708894914926  delta_E= -0.452  |g|= 0.183  |ddm|= 0.407
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.538355
diis-c [-0.28982601  1.        ]
  HOMO = -0.581159291568906  LUMO = 1.02435293972319
  mo_energy =
[-1.18627255e+02 -1.23312357e+01 -9.58510891e+00 -9.58510891e+00
 -9.58510891e+00 -1.25720763e+00 -5.81159292e-01 -5.81159292e-01
 -5.81159292e-01  1.02435294e+00  1.02435294e+00  1.02435294e+00
  7.41032932e+00  7.41032932e+00  7.41032932e+00  9.94536014e+00
  3.41864040e+01  3.41864040e+01  3.41864040e+01  1.16017277e+02
  1.31884951e+02  1.31884951e+02  1.31884951e+02  4.86911590e+02
  4.86911590e+02  4.86911590e+02  6.52589724e+02  1.33398003e+03
  1.33398003e+03  1.33398003e+03  2.79166817e+03  3.02111994e+03
  3.02111994e+03  3.02111994e+03  6.63655811e+03  6.63655811e+03
  6.63655811e+03  9.21117228e+03  2.55588611e+04  7.62896603e+04]
E1 = -728.4504490073845  E_coul = 201.740967415332
cycle= 2 E= -526.709481592052  delta_E= -0.000587  |g|= 0.0333  |ddm|= 0.0386
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0666509
diis-c [-0.00265773  0.07307172  0.92692828]
  HOMO = -0.574483280913443  LUMO = 1.02944045958551
  mo_energy =
[-1.18568861e+02 -1.23005833e+01 -9.55315848e+00 -9.55315848e+00
 -9.55315848e+00 -1.24873030e+00 -5.74483281e-01 -5.74483281e-01
 -5.74483281e-01  1.02944046e+00  1.02944046e+00  1.02944046e+00
  7.42891497e+00  7.42891497e+00  7.42891497e+00  9.96982250e+00
  3.42192696e+01  3.42192696e+01  3.42192696e+01  1.16065951e+02
  1.31932408e+02  1.31932408e+02  1.31932408e+02  4.86969199e+02
  4.86969199e+02  4.86969199e+02  6.52650107e+02  1.33404143e+03
  1.33404143e+03  1.33404143e+03  2.79173267e+03  3.02118343e+03
  3.02118343e+03  3.02118343e+03  6.63662316e+03  6.63662316e+03
  6.63662316e+03  9.21123805e+03  2.55589274e+04  7.62897268e+04]
E1 = -728.3462453921301  E_coul = 201.6367295322317
cycle= 3 E= -526.709515859898  delta_E= -3.43e-05  |g|= 0.0048  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.010426
diis-c [-4.25829466e-07 -1.10544830e-03  1.30716364e-01  8.70389085e-01]
  HOMO = -0.57539895208185  LUMO = 1.02875353676689
  mo_energy =
[-1.18576392e+02 -1.23046044e+01 -9.55744974e+00 -9.55744974e+00
 -9.55744974e+00 -1.24984196e+00 -5.75398952e-01 -5.75398952e-01
 -5.75398952e-01  1.02875354e+00  1.02875354e+00  1.02875354e+00
  7.42639462e+00  7.42639462e+00  7.42639462e+00  9.96669980e+00
  3.42148887e+01  3.42148887e+01  3.42148887e+01  1.16059680e+02
  1.31926236e+02  1.31926236e+02  1.31926236e+02  4.86961769e+02
  4.86961769e+02  4.86961769e+02  6.52642285e+02  1.33403348e+03
  1.33403348e+03  1.33403348e+03  2.79172415e+03  3.02117514e+03
  3.02117514e+03  3.02117514e+03  6.63661452e+03  6.63661452e+03
  6.63661452e+03  9.21122921e+03  2.55589184e+04  7.62897176e+04]
E1 = -728.3603546070914  E_coul = 201.6508379167569
cycle= 4 E= -526.709516690334  delta_E= -8.3e-07  |g|= 5.89e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122791
diis-c [-1.28116124e-09  6.40560390e-05 -9.01140390e-03 -7.07334058e-02
  1.07968075e+00]
  HOMO = -0.57538723034302  LUMO = 1.02876229627678
  mo_energy =
[-1.18576397e+02 -1.23045764e+01 -9.55743326e+00 -9.55743326e+00
 -9.55743326e+00 -1.24982336e+00 -5.75387230e-01 -5.75387230e-01
 -5.75387230e-01  1.02876230e+00  1.02876230e+00  1.02876230e+00
  7.42641451e+00  7.42641451e+00  7.42641451e+00  9.96673430e+00
  3.42149038e+01  3.42149038e+01  3.42149038e+01  1.16059689e+02
  1.31926242e+02  1.31926242e+02  1.31926242e+02  4.86961764e+02
  4.86961764e+02  4.86961764e+02  6.52642272e+02  1.33403347e+03
  1.33403347e+03  1.33403347e+03  2.79172412e+03  3.02117512e+03
  3.02117512e+03  3.02117512e+03  6.63661449e+03  6.63661449e+03
  6.63661449e+03  9.21122917e+03  2.55589183e+04  7.62897176e+04]
E1 = -728.3603543192729  E_coul = 201.65083762883089
cycle= 5 E= -526.709516690442  delta_E= -1.08e-10  |g|= 7.66e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3603543192729  E_coul = 201.65083762883089
  HOMO = -0.575390633820842  LUMO = 1.02875978552344
  mo_energy =
[-1.18576414e+02 -1.23045884e+01 -9.55744585e+00 -9.55744585e+00
 -9.55744585e+00 -1.24982755e+00 -5.75390634e-01 -5.75390634e-01
 -5.75390634e-01  1.02875979e+00  1.02875979e+00  1.02875979e+00
  7.42640616e+00  7.42640616e+00  7.42640616e+00  9.96672447e+00
  3.42148914e+01  3.42148914e+01  3.42148914e+01  1.16059674e+02
  1.31926227e+02  1.31926227e+02  1.31926227e+02  4.86961748e+02
  4.86961748e+02  4.86961748e+02  6.52642255e+02  1.33403345e+03
  1.33403345e+03  1.33403345e+03  2.79172410e+03  3.02117510e+03
  3.02117510e+03  3.02117510e+03  6.63661447e+03  6.63661447e+03
  6.63661447e+03  9.21122915e+03  2.55589183e+04  7.62897176e+04]
E1 = -728.3603919441985  E_coul = 201.65087525375324
Extra cycle  E= -526.709516690445  delta_E= -3.18e-12  |g|= 2.26e-06  |ddm|= 3.9e-06
    CPU time for scf_cycle      7.25 sec, wall time      0.53 sec
exp = [2.61828321e+04 7.61710864e+03 3.61750832e+03 1.58858988e+03
 4.15103132e+02 1.21047448e+02 3.88495431e+01 8.05653830e+00
 3.15978004e+00 3.98536722e-01 1.36284139e+03 6.64178559e+02
 2.98289936e+02 3.11739094e+02 6.28674734e+01 7.47516605e+00
 2.06669918e+01 7.78819527e-01 2.86022362e+00 2.24252348e-01]
E = -526.7095166904452
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:01:05 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8321406        1
[INPUT] 0    0    [1    /1   ]  7617.10863558        1
[INPUT] 0    0    [1    /1   ]  3617.50832292        1
[INPUT] 0    0    [1    /1   ]  1588.58988386        1
[INPUT] 0    0    [1    /1   ]  415.103131782        1
[INPUT] 0    0    [1    /1   ]  121.04744828         1
[INPUT] 0    0    [1    /1   ]  38.8495430756        1
[INPUT] 0    0    [1    /1   ]  8.05653830445        1
[INPUT] 0    0    [1    /1   ]  3.15978003914        1
[INPUT] 0    0    [1    /1   ]  0.398536721929       1
[INPUT] 1    0    [1    /1   ]  1362.84138865        1
[INPUT] 1    0    [1    /1   ]  664.178559361        1
[INPUT] 1    0    [1    /1   ]  298.289935585        1
[INPUT] 1    0    [1    /1   ]  311.739093882        1
[INPUT] 1    0    [1    /1   ]  62.8674734205        1
[INPUT] 1    0    [1    /1   ]  7.47516605413        1
[INPUT] 1    0    [1    /1   ]  20.6669917872        1
[INPUT] 1    0    [1    /1   ]  0.778819527435       1
[INPUT] 1    0    [1    /1   ]  2.86022362427        1
[INPUT] 1    0    [1    /1   ]  0.224252348052       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.83214059649, 1.0]], [0, [7617.1086355780735, 1.0]], [0, [3617.5083229190996, 1.0]], [0, [1588.5898838593591, 1.0]], [0, [415.103131782024, 1.0]], [0, [121.04744828005316, 1.0]], [0, [38.849543075648455, 1.0]], [0, [8.0565383044513, 1.0]], [0, [3.1597800391357094, 1.0]], [0, [0.3985367219292568, 1.0]], [1, [1362.841388647979, 1.0]], [1, [664.1785593610365, 1.0]], [1, [298.289935585001, 1.0]], [1, [311.7390938820005, 1.0]], [1, [62.867473420503636, 1.0]], [1, [7.475166054126584, 1.0]], [1, [20.66699178721347, 1.0]], [1, [0.7788195274353985, 1.0]], [1, [2.8602236242706187, 1.0]], [1, [0.22425234805182717, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.8321406]
bas 1, expnt(s) = [7617.10863558]
bas 2, expnt(s) = [3617.50832292]
bas 3, expnt(s) = [1588.58988386]
bas 4, expnt(s) = [415.10313178]
bas 5, expnt(s) = [121.04744828]
bas 6, expnt(s) = [38.84954308]
bas 7, expnt(s) = [8.0565383]
bas 8, expnt(s) = [3.15978004]
bas 9, expnt(s) = [0.39853672]
bas 10, expnt(s) = [1362.84138865]
bas 11, expnt(s) = [664.17855936]
bas 12, expnt(s) = [298.28993559]
bas 13, expnt(s) = [311.73909388]
bas 14, expnt(s) = [62.86747342]
bas 15, expnt(s) = [7.47516605]
bas 16, expnt(s) = [20.66699179]
bas 17, expnt(s) = [0.77881953]
bas 18, expnt(s) = [2.86022362]
bas 19, expnt(s) = [0.22425235]
CPU time:      1549.28
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828321e+04 5.20028913e+03 7.61710864e+03 2.05995454e+03
 3.61750832e+03 1.17847990e+03 1.58858988e+03 6.35731702e+02
 4.15103132e+02 2.32344305e+02 1.21047448e+02 9.22001767e+01
 3.88495431e+01 3.93146543e+01 8.05653830e+00 1.20816536e+01
 3.15978004e+00 5.98766732e+00 3.98536722e-01 1.26726162e+00
 1.36284139e+03 2.41568908e+04 6.64178559e+02 9.83649685e+03
 2.98289936e+02 3.61645148e+03 3.11739094e+02 3.82140862e+03
 6.28674734e+01 5.16436467e+02 7.47516605e+00 3.60587318e+01
 2.06669918e+01 1.28552633e+02 7.78819527e-01 2.13442271e+00
 2.86022362e+00 1.08513652e+01 2.24252348e-01 4.50200156e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982728926773362
cond(S) = 96650.66580914432
E1 = -729.3784343881383  E_coul = 203.12154416840858
init E= -526.25689021973
    CPU time for initialize scf      7.15 sec, wall time      0.35 sec
  HOMO = -0.556916274947915  LUMO = 1.04039449207776
  mo_energy =
[-1.18335048e+02 -1.22078134e+01 -9.45165744e+00 -9.45165744e+00
 -9.45165744e+00 -1.22605908e+00 -5.56916275e-01 -5.56916275e-01
 -5.56916275e-01  1.04039449e+00  1.04039449e+00  1.04039449e+00
  7.48683900e+00  7.48683900e+00  7.48683900e+00  1.00362360e+01
  3.43268000e+01  3.43268000e+01  3.43268000e+01  1.16230747e+02
  1.32098863e+02  1.32098863e+02  1.32098863e+02  4.87201906e+02
  4.87201906e+02  4.87201906e+02  6.52926391e+02  1.33432571e+03
  1.33432571e+03  1.33432571e+03  2.79214857e+03  3.02153120e+03
  3.02153120e+03  3.02153120e+03  6.63708140e+03  6.63708140e+03
  6.63708140e+03  9.21176921e+03  2.55595517e+04  7.62904407e+04]
E1 = -727.9895463558453  E_coul = 201.28065144091943
cycle= 1 E= -526.708894914926  delta_E= -0.452  |g|= 0.183  |ddm|= 0.407
    CPU time for cycle= 1      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.538355
diis-c [-0.28982601  1.        ]
  HOMO = -0.581159291568906  LUMO = 1.02435293972319
  mo_energy =
[-1.18627255e+02 -1.23312357e+01 -9.58510891e+00 -9.58510891e+00
 -9.58510891e+00 -1.25720763e+00 -5.81159292e-01 -5.81159292e-01
 -5.81159292e-01  1.02435294e+00  1.02435294e+00  1.02435294e+00
  7.41032932e+00  7.41032932e+00  7.41032932e+00  9.94536014e+00
  3.41864040e+01  3.41864040e+01  3.41864040e+01  1.16017277e+02
  1.31884951e+02  1.31884951e+02  1.31884951e+02  4.86911590e+02
  4.86911590e+02  4.86911590e+02  6.52589724e+02  1.33398003e+03
  1.33398003e+03  1.33398003e+03  2.79166817e+03  3.02111994e+03
  3.02111994e+03  3.02111994e+03  6.63655811e+03  6.63655811e+03
  6.63655811e+03  9.21117228e+03  2.55588611e+04  7.62896603e+04]
E1 = -728.4504490073845  E_coul = 201.740967415332
cycle= 2 E= -526.709481592052  delta_E= -0.000587  |g|= 0.0333  |ddm|= 0.0386
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0666509
diis-c [-0.00265773  0.07307172  0.92692828]
  HOMO = -0.574483280913443  LUMO = 1.02944045958551
  mo_energy =
[-1.18568861e+02 -1.23005833e+01 -9.55315848e+00 -9.55315848e+00
 -9.55315848e+00 -1.24873030e+00 -5.74483281e-01 -5.74483281e-01
 -5.74483281e-01  1.02944046e+00  1.02944046e+00  1.02944046e+00
  7.42891497e+00  7.42891497e+00  7.42891497e+00  9.96982250e+00
  3.42192696e+01  3.42192696e+01  3.42192696e+01  1.16065951e+02
  1.31932408e+02  1.31932408e+02  1.31932408e+02  4.86969199e+02
  4.86969199e+02  4.86969199e+02  6.52650107e+02  1.33404143e+03
  1.33404143e+03  1.33404143e+03  2.79173267e+03  3.02118343e+03
  3.02118343e+03  3.02118343e+03  6.63662316e+03  6.63662316e+03
  6.63662316e+03  9.21123805e+03  2.55589274e+04  7.62897268e+04]
E1 = -728.3462453921301  E_coul = 201.6367295322317
cycle= 3 E= -526.709515859898  delta_E= -3.43e-05  |g|= 0.0048  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.010426
diis-c [-4.25829466e-07 -1.10544830e-03  1.30716364e-01  8.70389085e-01]
  HOMO = -0.57539895208185  LUMO = 1.02875353676689
  mo_energy =
[-1.18576392e+02 -1.23046044e+01 -9.55744974e+00 -9.55744974e+00
 -9.55744974e+00 -1.24984196e+00 -5.75398952e-01 -5.75398952e-01
 -5.75398952e-01  1.02875354e+00  1.02875354e+00  1.02875354e+00
  7.42639462e+00  7.42639462e+00  7.42639462e+00  9.96669980e+00
  3.42148887e+01  3.42148887e+01  3.42148887e+01  1.16059680e+02
  1.31926236e+02  1.31926236e+02  1.31926236e+02  4.86961769e+02
  4.86961769e+02  4.86961769e+02  6.52642285e+02  1.33403348e+03
  1.33403348e+03  1.33403348e+03  2.79172415e+03  3.02117514e+03
  3.02117514e+03  3.02117514e+03  6.63661452e+03  6.63661452e+03
  6.63661452e+03  9.21122921e+03  2.55589184e+04  7.62897176e+04]
E1 = -728.3603546070914  E_coul = 201.6508379167569
cycle= 4 E= -526.709516690334  delta_E= -8.3e-07  |g|= 5.89e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122791
diis-c [-1.28116124e-09  6.40560390e-05 -9.01140390e-03 -7.07334058e-02
  1.07968075e+00]
  HOMO = -0.57538723034302  LUMO = 1.02876229627678
  mo_energy =
[-1.18576397e+02 -1.23045764e+01 -9.55743326e+00 -9.55743326e+00
 -9.55743326e+00 -1.24982336e+00 -5.75387230e-01 -5.75387230e-01
 -5.75387230e-01  1.02876230e+00  1.02876230e+00  1.02876230e+00
  7.42641451e+00  7.42641451e+00  7.42641451e+00  9.96673430e+00
  3.42149038e+01  3.42149038e+01  3.42149038e+01  1.16059689e+02
  1.31926242e+02  1.31926242e+02  1.31926242e+02  4.86961764e+02
  4.86961764e+02  4.86961764e+02  6.52642272e+02  1.33403347e+03
  1.33403347e+03  1.33403347e+03  2.79172412e+03  3.02117512e+03
  3.02117512e+03  3.02117512e+03  6.63661449e+03  6.63661449e+03
  6.63661449e+03  9.21122917e+03  2.55589183e+04  7.62897176e+04]
E1 = -728.3603543192729  E_coul = 201.65083762883089
cycle= 5 E= -526.709516690442  delta_E= -1.08e-10  |g|= 7.66e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3603543192729  E_coul = 201.65083762883089
  HOMO = -0.575390633820842  LUMO = 1.02875978552344
  mo_energy =
[-1.18576414e+02 -1.23045884e+01 -9.55744585e+00 -9.55744585e+00
 -9.55744585e+00 -1.24982755e+00 -5.75390634e-01 -5.75390634e-01
 -5.75390634e-01  1.02875979e+00  1.02875979e+00  1.02875979e+00
  7.42640616e+00  7.42640616e+00  7.42640616e+00  9.96672447e+00
  3.42148914e+01  3.42148914e+01  3.42148914e+01  1.16059674e+02
  1.31926227e+02  1.31926227e+02  1.31926227e+02  4.86961748e+02
  4.86961748e+02  4.86961748e+02  6.52642255e+02  1.33403345e+03
  1.33403345e+03  1.33403345e+03  2.79172410e+03  3.02117510e+03
  3.02117510e+03  3.02117510e+03  6.63661447e+03  6.63661447e+03
  6.63661447e+03  9.21122915e+03  2.55589183e+04  7.62897176e+04]
E1 = -728.3603919441985  E_coul = 201.65087525375324
Extra cycle  E= -526.709516690445  delta_E= -3.18e-12  |g|= 2.26e-06  |ddm|= 3.9e-06
    CPU time for scf_cycle      7.38 sec, wall time      0.53 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 96650.66580914432
E1 = -728.3603919441985  E_coul = 201.65087525375324
init E= -526.709516690445
    CPU time for initialize scf     16.34 sec, wall time      0.80 sec
  HOMO = -0.575389946765953  LUMO = 1.02876029841186
  mo_energy =
[-1.18576410e+02 -1.23045857e+01 -9.55744299e+00 -9.55744299e+00
 -9.55744299e+00 -1.24982669e+00 -5.75389947e-01 -5.75389947e-01
 -5.75389947e-01  1.02876030e+00  1.02876030e+00  1.02876030e+00
  7.42640793e+00  7.42640793e+00  7.42640793e+00  9.96672670e+00
  3.42148943e+01  3.42148943e+01  3.42148943e+01  1.16059678e+02
  1.31926231e+02  1.31926231e+02  1.31926231e+02  4.86961752e+02
  4.86961752e+02  4.86961752e+02  6.52642259e+02  1.33403346e+03
  1.33403346e+03  1.33403346e+03  2.79172411e+03  3.02117511e+03
  3.02117511e+03  3.02117511e+03  6.63661447e+03  6.63661447e+03
  6.63661447e+03  9.21122916e+03  2.55589183e+04  7.62897176e+04]
E1 = -728.3603830213036  E_coul = 201.65086633085718
cycle= 1 E= -526.709516690446  delta_E= -1.25e-12  |g|= 5.78e-07  |ddm|= 8.89e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3603830213036  E_coul = 201.65086633085718
  HOMO = -0.57539009835034  LUMO = 1.02876018459301
  mo_energy =
[-1.18576411e+02 -1.23045863e+01 -9.55744367e+00 -9.55744367e+00
 -9.55744367e+00 -1.24982688e+00 -5.75390098e-01 -5.75390098e-01
 -5.75390098e-01  1.02876018e+00  1.02876018e+00  1.02876018e+00
  7.42640753e+00  7.42640753e+00  7.42640753e+00  9.96672619e+00
  3.42148936e+01  3.42148936e+01  3.42148936e+01  1.16059677e+02
  1.31926230e+02  1.31926230e+02  1.31926230e+02  4.86961751e+02
  4.86961751e+02  4.86961751e+02  6.52642258e+02  1.33403346e+03
  1.33403346e+03  1.33403346e+03  2.79172410e+03  3.02117510e+03
  3.02117510e+03  3.02117510e+03  6.63661447e+03  6.63661447e+03
  6.63661447e+03  9.21122915e+03  2.55589183e+04  7.62897176e+04]
E1 = -728.3603851911025  E_coul = 201.6508685006561
Extra cycle  E= -526.709516690446  delta_E=    0  |g|= 1.45e-07  |ddm|= 2.08e-07
    CPU time for scf_cycle     16.45 sec, wall time      0.92 sec
exp = [2.61828321e+04 7.61710864e+03 3.61750832e+03 1.58858988e+03
 4.15103132e+02 1.21047448e+02 3.88495431e+01 8.05653830e+00
 3.15978004e+00 3.98536722e-01 1.36284139e+03 6.64178559e+02
 2.98289936e+02 3.11739094e+02 6.28674734e+01 7.47516605e+00
 2.06669918e+01 7.78819527e-01 2.86022362e+00 2.24252348e-01]
grad_E = [-1.40612691e-06  2.23324251e-06 -2.12764696e-06  3.89434863e-05
  9.76790689e-06  3.64040401e-06 -1.56205976e-06 -2.14921397e-06
  4.84542239e-06  4.97479689e-05 -5.83935232e-07  4.11154884e-06
  1.88253840e-05  1.60814509e-05  7.08238041e-05  4.43870936e-05
  1.32931168e-05  1.09648075e-05 -3.41001848e-05 -1.24059271e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:01:11 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8320768        1
[INPUT] 0    0    [1    /1   ]  7617.1087863         1
[INPUT] 0    0    [1    /1   ]  3617.50826692        1
[INPUT] 0    0    [1    /1   ]  1588.59326191        1
[INPUT] 0    0    [1    /1   ]  415.091399512        1
[INPUT] 0    0    [1    /1   ]  121.041472027        1
[INPUT] 0    0    [1    /1   ]  38.8482697986        1
[INPUT] 0    0    [1    /1   ]  8.05651104432        1
[INPUT] 0    0    [1    /1   ]  3.15972669177        1
[INPUT] 0    0    [1    /1   ]  0.398532955314       1
[INPUT] 1    0    [1    /1   ]  1362.84136773        1
[INPUT] 1    0    [1    /1   ]  664.178764976        1
[INPUT] 1    0    [1    /1   ]  298.290904807        1
[INPUT] 1    0    [1    /1   ]  311.7399295          1
[INPUT] 1    0    [1    /1   ]  62.8670025619        1
[INPUT] 1    0    [1    /1   ]  7.47473090837        1
[INPUT] 1    0    [1    /1   ]  20.6666804074        1
[INPUT] 1    0    [1    /1   ]  0.778827126656       1
[INPUT] 1    0    [1    /1   ]  2.86018180354        1
[INPUT] 1    0    [1    /1   ]  0.224259806264       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.83207680988, 1.0]], [0, [7617.108786297598, 1.0]], [0, [3617.5082669217263, 1.0]], [0, [1588.593261913502, 1.0]], [0, [415.09139951188956, 1.0]], [0, [121.04147202666518, 1.0]], [0, [38.84826979864134, 1.0]], [0, [8.05651104431995, 1.0]], [0, [3.1597266917655067, 1.0]], [0, [0.39853295531443195, 1.0]], [1, [1362.8413677278268, 1.0]], [1, [664.1787649756869, 1.0]], [1, [298.290904806917, 1.0]], [1, [311.7399295001337, 1.0]], [1, [62.867002561884355, 1.0]], [1, [7.474730908374656, 1.0]], [1, [20.666680407425094, 1.0]], [1, [0.7788271266562934, 1.0]], [1, [2.860181803540574, 1.0]], [1, [0.2242598062636587, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.83207681]
bas 1, expnt(s) = [7617.1087863]
bas 2, expnt(s) = [3617.50826692]
bas 3, expnt(s) = [1588.59326191]
bas 4, expnt(s) = [415.09139951]
bas 5, expnt(s) = [121.04147203]
bas 6, expnt(s) = [38.8482698]
bas 7, expnt(s) = [8.05651104]
bas 8, expnt(s) = [3.15972669]
bas 9, expnt(s) = [0.39853296]
bas 10, expnt(s) = [1362.84136773]
bas 11, expnt(s) = [664.17876498]
bas 12, expnt(s) = [298.29090481]
bas 13, expnt(s) = [311.7399295]
bas 14, expnt(s) = [62.86700256]
bas 15, expnt(s) = [7.47473091]
bas 16, expnt(s) = [20.66668041]
bas 17, expnt(s) = [0.77882713]
bas 18, expnt(s) = [2.8601818]
bas 19, expnt(s) = [0.22425981]
CPU time:      1578.26
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828321e+04 5.20028912e+03 7.61710879e+03 2.05995457e+03
 3.61750827e+03 1.17847988e+03 1.58859326e+03 6.35732716e+02
 4.15091400e+02 2.32339380e+02 1.21041472e+02 9.21967626e+01
 3.88482698e+01 3.93136879e+01 8.05651104e+00 1.20816230e+01
 3.15972669e+00 5.98759150e+00 3.98532955e-01 1.26725264e+00
 1.36284137e+03 2.41568903e+04 6.64178765e+02 9.83650066e+03
 2.98290905e+02 3.61646617e+03 3.11739930e+02 3.82142142e+03
 6.28670026e+01 5.16431632e+02 7.47473091e+00 3.60561080e+01
 2.06666804e+01 1.28550212e+02 7.78827127e-01 2.13444874e+00
 2.86018180e+00 1.08511669e+01 2.24259806e-01 4.50218872e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982728587817945
cond(S) = 96652.15150313696
E1 = -729.3783986714775  E_coul = 203.1215194284932
init E= -526.256879242984
    CPU time for initialize scf      7.34 sec, wall time      0.35 sec
  HOMO = -0.556917250363025  LUMO = 1.0404304404709
  mo_energy =
[-1.18335049e+02 -1.22078163e+01 -9.45165915e+00 -9.45165915e+00
 -9.45165915e+00 -1.22605905e+00 -5.56917250e-01 -5.56917250e-01
 -5.56917250e-01  1.04043044e+00  1.04043044e+00  1.04043044e+00
  7.48669595e+00  7.48669595e+00  7.48669595e+00  1.00359954e+01
  3.43254617e+01  3.43254617e+01  3.43254617e+01  1.16225303e+02
  1.32095977e+02  1.32095977e+02  1.32095977e+02  4.87198810e+02
  4.87198810e+02  4.87198810e+02  6.52898458e+02  1.33432449e+03
  1.33432449e+03  1.33432449e+03  2.79209406e+03  3.02153266e+03
  3.02153266e+03  3.02153266e+03  6.63708479e+03  6.63708479e+03
  6.63708479e+03  9.21170920e+03  2.55594946e+04  7.62903880e+04]
E1 = -727.9895976404068  E_coul = 201.28070270549233
cycle= 1 E= -526.708894934914  delta_E= -0.452  |g|= 0.183  |ddm|= 0.407
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.538358
diis-c [-0.28982943  1.        ]
  HOMO = -0.58115764656194  LUMO = 1.02439044710175
  mo_energy =
[-1.18627252e+02 -1.23312326e+01 -9.58510546e+00 -9.58510546e+00
 -9.58510546e+00 -1.25720360e+00 -5.81157647e-01 -5.81157647e-01
 -5.81157647e-01  1.02439045e+00  1.02439045e+00  1.02439045e+00
  7.41019348e+00  7.41019348e+00  7.41019348e+00  9.94512766e+00
  3.41850730e+01  3.41850730e+01  3.41850730e+01  1.16011840e+02
  1.31882070e+02  1.31882070e+02  1.31882070e+02  4.86908498e+02
  4.86908498e+02  4.86908498e+02  6.52561799e+02  1.33397881e+03
  1.33397881e+03  1.33397881e+03  2.79161366e+03  3.02112140e+03
  3.02112140e+03  3.02112140e+03  6.63656151e+03  6.63656151e+03
  6.63656151e+03  9.21111228e+03  2.55588040e+04  7.62896076e+04]
E1 = -728.4504894566052  E_coul = 201.7410078450526
cycle= 2 E= -526.709481611553  delta_E= -0.000587  |g|= 0.0333  |ddm|= 0.0386
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0666504
diis-c [-0.00265768  0.07307097  0.92692903]
  HOMO = -0.574481903199079  LUMO = 1.02947787312034
  mo_energy =
[-1.18568859e+02 -1.23005809e+01 -9.55315578e+00 -9.55315578e+00
 -9.55315578e+00 -1.24872662e+00 -5.74481903e-01 -5.74481903e-01
 -5.74481903e-01  1.02947787e+00  1.02947787e+00  1.02947787e+00
  7.42877816e+00  7.42877816e+00  7.42877816e+00  9.96958927e+00
  3.42179374e+01  3.42179374e+01  3.42179374e+01  1.16060513e+02
  1.31929527e+02  1.31929527e+02  1.31929527e+02  4.86966106e+02
  4.86966106e+02  4.86966106e+02  6.52622182e+02  1.33404021e+03
  1.33404021e+03  1.33404021e+03  2.79167816e+03  3.02118489e+03
  3.02118489e+03  3.02118489e+03  6.63662656e+03  6.63662656e+03
  6.63662656e+03  9.21117804e+03  2.55588702e+04  7.62896741e+04]
E1 = -728.3462891837413  E_coul = 201.6367733057857
cycle= 3 E= -526.709515877956  delta_E= -3.43e-05  |g|= 0.0048  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104259
diis-c [-4.25961673e-07 -1.10550639e-03  1.30715818e-01  8.70389688e-01]
  HOMO = -0.575397533366032  LUMO = 1.02879096847718
  mo_energy =
[-1.18576389e+02 -1.23046018e+01 -9.55744693e+00 -9.55744693e+00
 -9.55744693e+00 -1.24983822e+00 -5.75397533e-01 -5.75397533e-01
 -5.75397533e-01  1.02879097e+00  1.02879097e+00  1.02879097e+00
  7.42625795e+00  7.42625795e+00  7.42625795e+00  9.96646673e+00
  3.42135567e+01  3.42135567e+01  3.42135567e+01  1.16054242e+02
  1.31923354e+02  1.31923354e+02  1.31923354e+02  4.86958676e+02
  4.86958676e+02  4.86958676e+02  6.52614360e+02  1.33403226e+03
  1.33403226e+03  1.33403226e+03  2.79166964e+03  3.02117660e+03
  3.02117660e+03  3.02117660e+03  6.63661792e+03  6.63661792e+03
  6.63661792e+03  9.21116920e+03  2.55588612e+04  7.62896649e+04]
E1 = -728.3603979563485  E_coul = 201.65088124799905
cycle= 4 E= -526.709516708349  delta_E= -8.3e-07  |g|= 5.89e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00012281
diis-c [-1.28153385e-09  6.40638593e-05 -9.01209916e-03 -7.07399573e-02
  1.07968799e+00]
  HOMO = -0.575385809251788  LUMO = 1.02879972996181
  mo_energy =
[-1.18576394e+02 -1.23045739e+01 -9.55743044e+00 -9.55743044e+00
 -9.55743044e+00 -1.24981961e+00 -5.75385809e-01 -5.75385809e-01
 -5.75385809e-01  1.02879973e+00  1.02879973e+00  1.02879973e+00
  7.42627785e+00  7.42627785e+00  7.42627785e+00  9.96650123e+00
  3.42135718e+01  3.42135718e+01  3.42135718e+01  1.16054251e+02
  1.31923361e+02  1.31923361e+02  1.31923361e+02  4.86958672e+02
  4.86958672e+02  4.86958672e+02  6.52614347e+02  1.33403225e+03
  1.33403225e+03  1.33403225e+03  2.79166961e+03  3.02117658e+03
  3.02117658e+03  3.02117658e+03  6.63661788e+03  6.63661788e+03
  6.63661788e+03  9.21116916e+03  2.55588611e+04  7.62896649e+04]
E1 = -728.3603976692866  E_coul = 201.65088096083107
cycle= 5 E= -526.709516708456  delta_E= -1.06e-10  |g|= 7.66e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3603976692866  E_coul = 201.65088096083107
  HOMO = -0.575389213158656  LUMO = 1.02879721884632
  mo_energy =
[-1.18576411e+02 -1.23045859e+01 -9.55744303e+00 -9.55744303e+00
 -9.55744303e+00 -1.24982380e+00 -5.75389213e-01 -5.75389213e-01
 -5.75389213e-01  1.02879722e+00  1.02879722e+00  1.02879722e+00
  7.42626950e+00  7.42626950e+00  7.42626950e+00  9.96649141e+00
  3.42135594e+01  3.42135594e+01  3.42135594e+01  1.16054236e+02
  1.31923346e+02  1.31923346e+02  1.31923346e+02  4.86958655e+02
  4.86958655e+02  4.86958655e+02  6.52614330e+02  1.33403223e+03
  1.33403223e+03  1.33403223e+03  2.79166959e+03  3.02117656e+03
  3.02117656e+03  3.02117656e+03  6.63661787e+03  6.63661787e+03
  6.63661787e+03  9.21116914e+03  2.55588611e+04  7.62896649e+04]
E1 = -728.360435298706  E_coul = 201.65091859024594
Extra cycle  E= -526.70951670846  delta_E= -4.43e-12  |g|= 2.26e-06  |ddm|= 3.9e-06
    CPU time for scf_cycle      7.58 sec, wall time      0.57 sec
exp = [2.61828321e+04 7.61710879e+03 3.61750827e+03 1.58859326e+03
 4.15091400e+02 1.21041472e+02 3.88482698e+01 8.05651104e+00
 3.15972669e+00 3.98532955e-01 1.36284137e+03 6.64178765e+02
 2.98290905e+02 3.11739930e+02 6.28670026e+01 7.47473091e+00
 2.06666804e+01 7.78827127e-01 2.86018180e+00 2.24259806e-01]
E = -526.70951670846
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:01:12 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8320768        1
[INPUT] 0    0    [1    /1   ]  7617.1087863         1
[INPUT] 0    0    [1    /1   ]  3617.50826692        1
[INPUT] 0    0    [1    /1   ]  1588.59326191        1
[INPUT] 0    0    [1    /1   ]  415.091399512        1
[INPUT] 0    0    [1    /1   ]  121.041472027        1
[INPUT] 0    0    [1    /1   ]  38.8482697986        1
[INPUT] 0    0    [1    /1   ]  8.05651104432        1
[INPUT] 0    0    [1    /1   ]  3.15972669177        1
[INPUT] 0    0    [1    /1   ]  0.398532955314       1
[INPUT] 1    0    [1    /1   ]  1362.84136773        1
[INPUT] 1    0    [1    /1   ]  664.178764976        1
[INPUT] 1    0    [1    /1   ]  298.290904807        1
[INPUT] 1    0    [1    /1   ]  311.7399295          1
[INPUT] 1    0    [1    /1   ]  62.8670025619        1
[INPUT] 1    0    [1    /1   ]  7.47473090837        1
[INPUT] 1    0    [1    /1   ]  20.6666804074        1
[INPUT] 1    0    [1    /1   ]  0.778827126656       1
[INPUT] 1    0    [1    /1   ]  2.86018180354        1
[INPUT] 1    0    [1    /1   ]  0.224259806264       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.83207680988, 1.0]], [0, [7617.108786297598, 1.0]], [0, [3617.5082669217263, 1.0]], [0, [1588.593261913502, 1.0]], [0, [415.09139951188956, 1.0]], [0, [121.04147202666518, 1.0]], [0, [38.84826979864134, 1.0]], [0, [8.05651104431995, 1.0]], [0, [3.1597266917655067, 1.0]], [0, [0.39853295531443195, 1.0]], [1, [1362.8413677278268, 1.0]], [1, [664.1787649756869, 1.0]], [1, [298.290904806917, 1.0]], [1, [311.7399295001337, 1.0]], [1, [62.867002561884355, 1.0]], [1, [7.474730908374656, 1.0]], [1, [20.666680407425094, 1.0]], [1, [0.7788271266562934, 1.0]], [1, [2.860181803540574, 1.0]], [1, [0.2242598062636587, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.83207681]
bas 1, expnt(s) = [7617.1087863]
bas 2, expnt(s) = [3617.50826692]
bas 3, expnt(s) = [1588.59326191]
bas 4, expnt(s) = [415.09139951]
bas 5, expnt(s) = [121.04147203]
bas 6, expnt(s) = [38.8482698]
bas 7, expnt(s) = [8.05651104]
bas 8, expnt(s) = [3.15972669]
bas 9, expnt(s) = [0.39853296]
bas 10, expnt(s) = [1362.84136773]
bas 11, expnt(s) = [664.17876498]
bas 12, expnt(s) = [298.29090481]
bas 13, expnt(s) = [311.7399295]
bas 14, expnt(s) = [62.86700256]
bas 15, expnt(s) = [7.47473091]
bas 16, expnt(s) = [20.66668041]
bas 17, expnt(s) = [0.77882713]
bas 18, expnt(s) = [2.8601818]
bas 19, expnt(s) = [0.22425981]
CPU time:      1586.26
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828321e+04 5.20028912e+03 7.61710879e+03 2.05995457e+03
 3.61750827e+03 1.17847988e+03 1.58859326e+03 6.35732716e+02
 4.15091400e+02 2.32339380e+02 1.21041472e+02 9.21967626e+01
 3.88482698e+01 3.93136879e+01 8.05651104e+00 1.20816230e+01
 3.15972669e+00 5.98759150e+00 3.98532955e-01 1.26725264e+00
 1.36284137e+03 2.41568903e+04 6.64178765e+02 9.83650066e+03
 2.98290905e+02 3.61646617e+03 3.11739930e+02 3.82142142e+03
 6.28670026e+01 5.16431632e+02 7.47473091e+00 3.60561080e+01
 2.06666804e+01 1.28550212e+02 7.78827127e-01 2.13444874e+00
 2.86018180e+00 1.08511669e+01 2.24259806e-01 4.50218872e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982728587817945
cond(S) = 96652.15150313696
E1 = -729.3783986714775  E_coul = 203.1215194284932
init E= -526.256879242984
    CPU time for initialize scf      5.83 sec, wall time      0.28 sec
  HOMO = -0.556917250363025  LUMO = 1.0404304404709
  mo_energy =
[-1.18335049e+02 -1.22078163e+01 -9.45165915e+00 -9.45165915e+00
 -9.45165915e+00 -1.22605905e+00 -5.56917250e-01 -5.56917250e-01
 -5.56917250e-01  1.04043044e+00  1.04043044e+00  1.04043044e+00
  7.48669595e+00  7.48669595e+00  7.48669595e+00  1.00359954e+01
  3.43254617e+01  3.43254617e+01  3.43254617e+01  1.16225303e+02
  1.32095977e+02  1.32095977e+02  1.32095977e+02  4.87198810e+02
  4.87198810e+02  4.87198810e+02  6.52898458e+02  1.33432449e+03
  1.33432449e+03  1.33432449e+03  2.79209406e+03  3.02153266e+03
  3.02153266e+03  3.02153266e+03  6.63708479e+03  6.63708479e+03
  6.63708479e+03  9.21170920e+03  2.55594946e+04  7.62903880e+04]
E1 = -727.9895976404068  E_coul = 201.28070270549233
cycle= 1 E= -526.708894934914  delta_E= -0.452  |g|= 0.183  |ddm|= 0.407
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538358
diis-c [-0.28982943  1.        ]
  HOMO = -0.58115764656194  LUMO = 1.02439044710175
  mo_energy =
[-1.18627252e+02 -1.23312326e+01 -9.58510546e+00 -9.58510546e+00
 -9.58510546e+00 -1.25720360e+00 -5.81157647e-01 -5.81157647e-01
 -5.81157647e-01  1.02439045e+00  1.02439045e+00  1.02439045e+00
  7.41019348e+00  7.41019348e+00  7.41019348e+00  9.94512766e+00
  3.41850730e+01  3.41850730e+01  3.41850730e+01  1.16011840e+02
  1.31882070e+02  1.31882070e+02  1.31882070e+02  4.86908498e+02
  4.86908498e+02  4.86908498e+02  6.52561799e+02  1.33397881e+03
  1.33397881e+03  1.33397881e+03  2.79161366e+03  3.02112140e+03
  3.02112140e+03  3.02112140e+03  6.63656151e+03  6.63656151e+03
  6.63656151e+03  9.21111228e+03  2.55588040e+04  7.62896076e+04]
E1 = -728.4504894566052  E_coul = 201.7410078450526
cycle= 2 E= -526.709481611553  delta_E= -0.000587  |g|= 0.0333  |ddm|= 0.0386
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0666504
diis-c [-0.00265768  0.07307097  0.92692903]
  HOMO = -0.574481903199079  LUMO = 1.02947787312034
  mo_energy =
[-1.18568859e+02 -1.23005809e+01 -9.55315578e+00 -9.55315578e+00
 -9.55315578e+00 -1.24872662e+00 -5.74481903e-01 -5.74481903e-01
 -5.74481903e-01  1.02947787e+00  1.02947787e+00  1.02947787e+00
  7.42877816e+00  7.42877816e+00  7.42877816e+00  9.96958927e+00
  3.42179374e+01  3.42179374e+01  3.42179374e+01  1.16060513e+02
  1.31929527e+02  1.31929527e+02  1.31929527e+02  4.86966106e+02
  4.86966106e+02  4.86966106e+02  6.52622182e+02  1.33404021e+03
  1.33404021e+03  1.33404021e+03  2.79167816e+03  3.02118489e+03
  3.02118489e+03  3.02118489e+03  6.63662656e+03  6.63662656e+03
  6.63662656e+03  9.21117804e+03  2.55588702e+04  7.62896741e+04]
E1 = -728.3462891837413  E_coul = 201.6367733057857
cycle= 3 E= -526.709515877956  delta_E= -3.43e-05  |g|= 0.0048  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104259
diis-c [-4.25961673e-07 -1.10550639e-03  1.30715818e-01  8.70389688e-01]
  HOMO = -0.575397533366032  LUMO = 1.02879096847718
  mo_energy =
[-1.18576389e+02 -1.23046018e+01 -9.55744693e+00 -9.55744693e+00
 -9.55744693e+00 -1.24983822e+00 -5.75397533e-01 -5.75397533e-01
 -5.75397533e-01  1.02879097e+00  1.02879097e+00  1.02879097e+00
  7.42625795e+00  7.42625795e+00  7.42625795e+00  9.96646673e+00
  3.42135567e+01  3.42135567e+01  3.42135567e+01  1.16054242e+02
  1.31923354e+02  1.31923354e+02  1.31923354e+02  4.86958676e+02
  4.86958676e+02  4.86958676e+02  6.52614360e+02  1.33403226e+03
  1.33403226e+03  1.33403226e+03  2.79166964e+03  3.02117660e+03
  3.02117660e+03  3.02117660e+03  6.63661792e+03  6.63661792e+03
  6.63661792e+03  9.21116920e+03  2.55588612e+04  7.62896649e+04]
E1 = -728.3603979563485  E_coul = 201.65088124799905
cycle= 4 E= -526.709516708349  delta_E= -8.3e-07  |g|= 5.89e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00012281
diis-c [-1.28153385e-09  6.40638593e-05 -9.01209916e-03 -7.07399573e-02
  1.07968799e+00]
  HOMO = -0.575385809251788  LUMO = 1.02879972996181
  mo_energy =
[-1.18576394e+02 -1.23045739e+01 -9.55743044e+00 -9.55743044e+00
 -9.55743044e+00 -1.24981961e+00 -5.75385809e-01 -5.75385809e-01
 -5.75385809e-01  1.02879973e+00  1.02879973e+00  1.02879973e+00
  7.42627785e+00  7.42627785e+00  7.42627785e+00  9.96650123e+00
  3.42135718e+01  3.42135718e+01  3.42135718e+01  1.16054251e+02
  1.31923361e+02  1.31923361e+02  1.31923361e+02  4.86958672e+02
  4.86958672e+02  4.86958672e+02  6.52614347e+02  1.33403225e+03
  1.33403225e+03  1.33403225e+03  2.79166961e+03  3.02117658e+03
  3.02117658e+03  3.02117658e+03  6.63661788e+03  6.63661788e+03
  6.63661788e+03  9.21116916e+03  2.55588611e+04  7.62896649e+04]
E1 = -728.3603976692866  E_coul = 201.65088096083107
cycle= 5 E= -526.709516708456  delta_E= -1.06e-10  |g|= 7.66e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3603976692866  E_coul = 201.65088096083107
  HOMO = -0.575389213158656  LUMO = 1.02879721884632
  mo_energy =
[-1.18576411e+02 -1.23045859e+01 -9.55744303e+00 -9.55744303e+00
 -9.55744303e+00 -1.24982380e+00 -5.75389213e-01 -5.75389213e-01
 -5.75389213e-01  1.02879722e+00  1.02879722e+00  1.02879722e+00
  7.42626950e+00  7.42626950e+00  7.42626950e+00  9.96649141e+00
  3.42135594e+01  3.42135594e+01  3.42135594e+01  1.16054236e+02
  1.31923346e+02  1.31923346e+02  1.31923346e+02  4.86958655e+02
  4.86958655e+02  4.86958655e+02  6.52614330e+02  1.33403223e+03
  1.33403223e+03  1.33403223e+03  2.79166959e+03  3.02117656e+03
  3.02117656e+03  3.02117656e+03  6.63661787e+03  6.63661787e+03
  6.63661787e+03  9.21116914e+03  2.55588611e+04  7.62896649e+04]
E1 = -728.360435298706  E_coul = 201.65091859024594
Extra cycle  E= -526.70951670846  delta_E= -4.43e-12  |g|= 2.26e-06  |ddm|= 3.9e-06
    CPU time for scf_cycle      6.05 sec, wall time      0.50 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 96652.15150313696
E1 = -728.360435298706  E_coul = 201.65091859024594
init E= -526.70951670846
    CPU time for initialize scf      4.40 sec, wall time      0.28 sec
  HOMO = -0.575388526027732  LUMO = 1.02879773180141
  mo_energy =
[-1.18576407e+02 -1.23045831e+01 -9.55744018e+00 -9.55744018e+00
 -9.55744018e+00 -1.24982294e+00 -5.75388526e-01 -5.75388526e-01
 -5.75388526e-01  1.02879773e+00  1.02879773e+00  1.02879773e+00
  7.42627127e+00  7.42627127e+00  7.42627127e+00  9.96649364e+00
  3.42135623e+01  3.42135623e+01  3.42135623e+01  1.16054240e+02
  1.31923350e+02  1.31923350e+02  1.31923350e+02  4.86958659e+02
  4.86958659e+02  4.86958659e+02  6.52614334e+02  1.33403224e+03
  1.33403224e+03  1.33403224e+03  2.79166959e+03  3.02117656e+03
  3.02117656e+03  3.02117656e+03  6.63661787e+03  6.63661787e+03
  6.63661787e+03  9.21116915e+03  2.55588611e+04  7.62896649e+04]
E1 = -728.3604263748059  E_coul = 201.65090966634537
cycle= 1 E= -526.709516708461  delta_E= -5.68e-13  |g|= 5.79e-07  |ddm|= 8.89e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3604263748059  E_coul = 201.65090966634537
  HOMO = -0.575388677626729  LUMO = 1.02879761796894
  mo_energy =
[-1.18576408e+02 -1.23045838e+01 -9.55744085e+00 -9.55744085e+00
 -9.55744085e+00 -1.24982313e+00 -5.75388678e-01 -5.75388678e-01
 -5.75388678e-01  1.02879762e+00  1.02879762e+00  1.02879762e+00
  7.42627087e+00  7.42627087e+00  7.42627087e+00  9.96649313e+00
  3.42135616e+01  3.42135616e+01  3.42135616e+01  1.16054239e+02
  1.31923349e+02  1.31923349e+02  1.31923349e+02  4.86958658e+02
  4.86958658e+02  4.86958658e+02  6.52614333e+02  1.33403224e+03
  1.33403224e+03  1.33403224e+03  2.79166959e+03  3.02117656e+03
  3.02117656e+03  3.02117656e+03  6.63661787e+03  6.63661787e+03
  6.63661787e+03  9.21116914e+03  2.55588611e+04  7.62896649e+04]
E1 = -728.360428544826  E_coul = 201.65091183636733
Extra cycle  E= -526.709516708459  delta_E= 1.82e-12  |g|= 1.45e-07  |ddm|= 2.08e-07
    CPU time for scf_cycle      4.53 sec, wall time      0.42 sec
exp = [2.61828321e+04 7.61710879e+03 3.61750827e+03 1.58859326e+03
 4.15091400e+02 1.21041472e+02 3.88482698e+01 8.05651104e+00
 3.15972669e+00 3.98532955e-01 1.36284137e+03 6.64178765e+02
 2.98290905e+02 3.11739930e+02 6.28670026e+01 7.47473091e+00
 2.06666804e+01 7.78827127e-01 2.86018180e+00 2.24259806e-01]
grad_E = [-1.40613632e-06  2.23332082e-06 -2.12754670e-06  3.89430281e-05
  9.98450091e-06  2.04101242e-06  7.05328289e-07  1.54474548e-07
 -3.74618534e-06  5.83471049e-06 -5.83842534e-07  4.11306183e-06
  1.88344995e-05  1.60892426e-05  6.98018753e-05  8.40910132e-06
  2.35344116e-05  5.71829673e-06  6.21280635e-06 -2.92135780e-05]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:01:16 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.832062         1
[INPUT] 0    0    [1    /1   ]  7617.10882338        1
[INPUT] 0    0    [1    /1   ]  3617.50825557        1
[INPUT] 0    0    [1    /1   ]  1588.5941119         1
[INPUT] 0    0    [1    /1   ]  415.08834515         1
[INPUT] 0    0    [1    /1   ]  121.0390453          1
[INPUT] 0    0    [1    /1   ]  38.8477373658        1
[INPUT] 0    0    [1    /1   ]  8.05674791945        1
[INPUT] 0    0    [1    /1   ]  3.15980452313        1
[INPUT] 0    0    [1    /1   ]  0.398530675538       1
[INPUT] 1    0    [1    /1   ]  1362.84136306        1
[INPUT] 1    0    [1    /1   ]  664.178813286        1
[INPUT] 1    0    [1    /1   ]  298.291133116        1
[INPUT] 1    0    [1    /1   ]  311.740126639        1
[INPUT] 1    0    [1    /1   ]  62.8668993271        1
[INPUT] 1    0    [1    /1   ]  7.47423845863        1
[INPUT] 1    0    [1    /1   ]  20.6662083266        1
[INPUT] 1    0    [1    /1   ]  0.778820759148       1
[INPUT] 1    0    [1    /1   ]  2.8600449625         1
[INPUT] 1    0    [1    /1   ]  0.224261904625       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.83206196866, 1.0]], [0, [7617.108823381342, 1.0]], [0, [3617.508255572073, 1.0]], [0, [1588.5941118975898, 1.0]], [0, [415.0883451496082, 1.0]], [0, [121.03904529960704, 1.0]], [0, [38.84773736584511, 1.0]], [0, [8.056747919447544, 1.0]], [0, [3.1598045231325886, 1.0]], [0, [0.39853067553775423, 1.0]], [1, [1362.8413630645916, 1.0]], [1, [664.1788132860496, 1.0]], [1, [298.291133116422, 1.0]], [1, [311.7401266387803, 1.0]], [1, [62.866899327109785, 1.0]], [1, [7.474238458626081, 1.0]], [1, [20.666208326563396, 1.0]], [1, [0.7788207591479344, 1.0]], [1, [2.860044962498247, 1.0]], [1, [0.22426190462485177, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.83206197]
bas 1, expnt(s) = [7617.10882338]
bas 2, expnt(s) = [3617.50825557]
bas 3, expnt(s) = [1588.5941119]
bas 4, expnt(s) = [415.08834515]
bas 5, expnt(s) = [121.0390453]
bas 6, expnt(s) = [38.84773737]
bas 7, expnt(s) = [8.05674792]
bas 8, expnt(s) = [3.15980452]
bas 9, expnt(s) = [0.39853068]
bas 10, expnt(s) = [1362.84136306]
bas 11, expnt(s) = [664.17881329]
bas 12, expnt(s) = [298.29113312]
bas 13, expnt(s) = [311.74012664]
bas 14, expnt(s) = [62.86689933]
bas 15, expnt(s) = [7.47423846]
bas 16, expnt(s) = [20.66620833]
bas 17, expnt(s) = [0.77882076]
bas 18, expnt(s) = [2.86004496]
bas 19, expnt(s) = [0.2242619]
CPU time:      1601.62
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828321e+04 5.20028912e+03 7.61710882e+03 2.05995458e+03
 3.61750826e+03 1.17847988e+03 1.58859411e+03 6.35732971e+02
 4.15088345e+02 2.32338097e+02 1.21039045e+02 9.21953763e+01
 3.88477374e+01 3.93132837e+01 8.05674792e+00 1.20818894e+01
 3.15980452e+00 5.98770212e+00 3.98530676e-01 1.26724720e+00
 1.36284136e+03 2.41568902e+04 6.64178813e+02 9.83650155e+03
 2.98291133e+02 3.61646963e+03 3.11740127e+02 3.82142444e+03
 6.28668993e+01 5.16430572e+02 7.47423846e+00 3.60531387e+01
 2.06662083e+01 1.28546541e+02 7.78820759e-01 2.13442693e+00
 2.86004496e+00 1.08505179e+01 2.24261905e-01 4.50224138e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.9827287296997
cond(S) = 96651.8273421798
E1 = -729.3783752009713  E_coul = 203.12150138993346
init E= -526.256873811038
    CPU time for initialize scf      7.59 sec, wall time      0.35 sec
  HOMO = -0.556917905790991  LUMO = 1.04043276500022
  mo_energy =
[-1.18335051e+02 -1.22078171e+01 -9.45166038e+00 -9.45166038e+00
 -9.45166038e+00 -1.22605964e+00 -5.56917906e-01 -5.56917906e-01
 -5.56917906e-01  1.04043277e+00  1.04043277e+00  1.04043277e+00
  7.48630349e+00  7.48630349e+00  7.48630349e+00  1.00364335e+01
  3.43234771e+01  3.43234771e+01  3.43234771e+01  1.16224499e+02
  1.32092415e+02  1.32092415e+02  1.32092415e+02  4.87195233e+02
  4.87195233e+02  4.87195233e+02  6.52889541e+02  1.33432160e+03
  1.33432160e+03  1.33432160e+03  2.79207711e+03  3.02153057e+03
  3.02153057e+03  3.02153057e+03  6.63708337e+03  6.63708337e+03
  6.63708337e+03  9.21169070e+03  2.55594768e+04  7.62903715e+04]
E1 = -727.9896455595458  E_coul = 201.28075058489216
cycle= 1 E= -526.708894974654  delta_E= -0.452  |g|= 0.183  |ddm|= 0.407
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.538356
diis-c [-0.28982761  1.        ]
  HOMO = -0.58115666496005  LUMO = 1.02439416231581
  mo_energy =
[-1.18627248e+02 -1.23312286e+01 -9.58510157e+00 -9.58510157e+00
 -9.58510157e+00 -1.25720195e+00 -5.81156665e-01 -5.81156665e-01
 -5.81156665e-01  1.02439416e+00  1.02439416e+00  1.02439416e+00
  7.40980830e+00  7.40980830e+00  7.40980830e+00  9.94556916e+00
  3.41830956e+01  3.41830956e+01  3.41830956e+01  1.16011043e+02
  1.31878513e+02  1.31878513e+02  1.31878513e+02  4.86904925e+02
  4.86904925e+02  4.86904925e+02  6.52552889e+02  1.33397592e+03
  1.33397592e+03  1.33397592e+03  2.79159672e+03  3.02111932e+03
  3.02111932e+03  3.02111932e+03  6.63656009e+03  6.63656009e+03
  6.63656009e+03  9.21109378e+03  2.55587862e+04  7.62895912e+04]
E1 = -728.4505225403965  E_coul = 201.74104091149013
cycle= 2 E= -526.709481628906  delta_E= -0.000587  |g|= 0.0333  |ddm|= 0.0386
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0666488
diis-c [-0.0026576   0.07306897  0.92693103]
  HOMO = -0.574481208260125  LUMO = 1.02948132954493
  mo_energy =
[-1.18568857e+02 -1.23005778e+01 -9.55315287e+00 -9.55315287e+00
 -9.55315287e+00 -1.24872533e+00 -5.74481208e-01 -5.74481208e-01
 -5.74481208e-01  1.02948133e+00  1.02948133e+00  1.02948133e+00
  7.42839161e+00  7.42839161e+00  7.42839161e+00  9.97003043e+00
  3.42159585e+01  3.42159585e+01  3.42159585e+01  1.16059714e+02
  1.31925969e+02  1.31925969e+02  1.31925969e+02  4.86962532e+02
  4.86962532e+02  4.86962532e+02  6.52613270e+02  1.33403732e+03
  1.33403732e+03  1.33403732e+03  2.79166122e+03  3.02118281e+03
  3.02118281e+03  3.02118281e+03  6.63662514e+03  6.63662514e+03
  6.63662514e+03  9.21115954e+03  2.55588525e+04  7.62896576e+04]
E1 = -728.3463260763746  E_coul = 201.6368101832823
cycle= 3 E= -526.709515893092  delta_E= -3.43e-05  |g|= 0.0048  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104256
diis-c [-4.25970977e-07 -1.10550848e-03  1.30715865e-01  8.70389644e-01]
  HOMO = -0.575396812197642  LUMO = 1.02879445110337
  mo_energy =
[-1.18576387e+02 -1.23045987e+01 -9.55744391e+00 -9.55744391e+00
 -9.55744391e+00 -1.24983690e+00 -5.75396812e-01 -5.75396812e-01
 -5.75396812e-01  1.02879445e+00  1.02879445e+00  1.02879445e+00
  7.42587156e+00  7.42587156e+00  7.42587156e+00  9.96690791e+00
  3.42115781e+01  3.42115781e+01  3.42115781e+01  1.16053444e+02
  1.31919796e+02  1.31919796e+02  1.31919796e+02  4.86955102e+02
  4.86955102e+02  4.86955102e+02  6.52605448e+02  1.33402937e+03
  1.33402937e+03  1.33402937e+03  2.79165269e+03  3.02117451e+03
  3.02117451e+03  3.02117451e+03  6.63661650e+03  6.63661650e+03
  6.63661650e+03  9.21115070e+03  2.55588435e+04  7.62896485e+04]
E1 = -728.3604344511574  E_coul = 201.65091772771416
cycle= 4 E= -526.709516723443  delta_E= -8.3e-07  |g|= 5.89e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122801
diis-c [-1.28173157e-09  6.40633317e-05 -9.01196901e-03 -7.07381595e-02
  1.07968607e+00]
  HOMO = -0.575385086049315  LUMO = 1.02880321405199
  mo_energy =
[-1.18576392e+02 -1.23045707e+01 -9.55742742e+00 -9.55742742e+00
 -9.55742742e+00 -1.24981829e+00 -5.75385086e-01 -5.75385086e-01
 -5.75385086e-01  1.02880321e+00  1.02880321e+00  1.02880321e+00
  7.42589146e+00  7.42589146e+00  7.42589146e+00  9.96694242e+00
  3.42115932e+01  3.42115932e+01  3.42115932e+01  1.16053453e+02
  1.31919803e+02  1.31919803e+02  1.31919803e+02  4.86955098e+02
  4.86955098e+02  4.86955098e+02  6.52605436e+02  1.33402936e+03
  1.33402936e+03  1.33402936e+03  2.79165266e+03  3.02117449e+03
  3.02117449e+03  3.02117449e+03  6.63661646e+03  6.63661646e+03
  6.63661646e+03  9.21115066e+03  2.55588434e+04  7.62896485e+04]
E1 = -728.3604341440737  E_coul = 201.65091742052348
cycle= 5 E= -526.70951672355  delta_E= -1.07e-10  |g|= 7.66e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3604341440737  E_coul = 201.65091742052348
  HOMO = -0.575388490152779  LUMO = 1.02880070281583
  mo_energy =
[-1.18576409e+02 -1.23045827e+01 -9.55744001e+00 -9.55744001e+00
 -9.55744001e+00 -1.24982248e+00 -5.75388490e-01 -5.75388490e-01
 -5.75388490e-01  1.02880070e+00  1.02880070e+00  1.02880070e+00
  7.42588312e+00  7.42588312e+00  7.42588312e+00  9.96693260e+00
  3.42115807e+01  3.42115807e+01  3.42115807e+01  1.16053438e+02
  1.31919788e+02  1.31919788e+02  1.31919788e+02  4.86955081e+02
  4.86955081e+02  4.86955081e+02  6.52605418e+02  1.33402934e+03
  1.33402934e+03  1.33402934e+03  2.79165265e+03  3.02117447e+03
  3.02117447e+03  3.02117447e+03  6.63661645e+03  6.63661645e+03
  6.63661645e+03  9.21115064e+03  2.55588434e+04  7.62896485e+04]
E1 = -728.3604717754259  E_coul = 201.65095505187256
Extra cycle  E= -526.709516723553  delta_E= -3.18e-12  |g|= 2.26e-06  |ddm|= 3.9e-06
    CPU time for scf_cycle      7.79 sec, wall time      0.53 sec
exp = [2.61828321e+04 7.61710882e+03 3.61750826e+03 1.58859411e+03
 4.15088345e+02 1.21039045e+02 3.88477374e+01 8.05674792e+00
 3.15980452e+00 3.98530676e-01 1.36284136e+03 6.64178813e+02
 2.98291133e+02 3.11740127e+02 6.28668993e+01 7.47423846e+00
 2.06662083e+01 7.78820759e-01 2.86004496e+00 2.24261905e-01]
E = -526.7095167235534
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:01:17 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.832062         1
[INPUT] 0    0    [1    /1   ]  7617.10882338        1
[INPUT] 0    0    [1    /1   ]  3617.50825557        1
[INPUT] 0    0    [1    /1   ]  1588.5941119         1
[INPUT] 0    0    [1    /1   ]  415.08834515         1
[INPUT] 0    0    [1    /1   ]  121.0390453          1
[INPUT] 0    0    [1    /1   ]  38.8477373658        1
[INPUT] 0    0    [1    /1   ]  8.05674791945        1
[INPUT] 0    0    [1    /1   ]  3.15980452313        1
[INPUT] 0    0    [1    /1   ]  0.398530675538       1
[INPUT] 1    0    [1    /1   ]  1362.84136306        1
[INPUT] 1    0    [1    /1   ]  664.178813286        1
[INPUT] 1    0    [1    /1   ]  298.291133116        1
[INPUT] 1    0    [1    /1   ]  311.740126639        1
[INPUT] 1    0    [1    /1   ]  62.8668993271        1
[INPUT] 1    0    [1    /1   ]  7.47423845863        1
[INPUT] 1    0    [1    /1   ]  20.6662083266        1
[INPUT] 1    0    [1    /1   ]  0.778820759148       1
[INPUT] 1    0    [1    /1   ]  2.8600449625         1
[INPUT] 1    0    [1    /1   ]  0.224261904625       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.83206196866, 1.0]], [0, [7617.108823381342, 1.0]], [0, [3617.508255572073, 1.0]], [0, [1588.5941118975898, 1.0]], [0, [415.0883451496082, 1.0]], [0, [121.03904529960704, 1.0]], [0, [38.84773736584511, 1.0]], [0, [8.056747919447544, 1.0]], [0, [3.1598045231325886, 1.0]], [0, [0.39853067553775423, 1.0]], [1, [1362.8413630645916, 1.0]], [1, [664.1788132860496, 1.0]], [1, [298.291133116422, 1.0]], [1, [311.7401266387803, 1.0]], [1, [62.866899327109785, 1.0]], [1, [7.474238458626081, 1.0]], [1, [20.666208326563396, 1.0]], [1, [0.7788207591479344, 1.0]], [1, [2.860044962498247, 1.0]], [1, [0.22426190462485177, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.83206197]
bas 1, expnt(s) = [7617.10882338]
bas 2, expnt(s) = [3617.50825557]
bas 3, expnt(s) = [1588.5941119]
bas 4, expnt(s) = [415.08834515]
bas 5, expnt(s) = [121.0390453]
bas 6, expnt(s) = [38.84773737]
bas 7, expnt(s) = [8.05674792]
bas 8, expnt(s) = [3.15980452]
bas 9, expnt(s) = [0.39853068]
bas 10, expnt(s) = [1362.84136306]
bas 11, expnt(s) = [664.17881329]
bas 12, expnt(s) = [298.29113312]
bas 13, expnt(s) = [311.74012664]
bas 14, expnt(s) = [62.86689933]
bas 15, expnt(s) = [7.47423846]
bas 16, expnt(s) = [20.66620833]
bas 17, expnt(s) = [0.77882076]
bas 18, expnt(s) = [2.86004496]
bas 19, expnt(s) = [0.2242619]
CPU time:      1609.66
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828321e+04 5.20028912e+03 7.61710882e+03 2.05995458e+03
 3.61750826e+03 1.17847988e+03 1.58859411e+03 6.35732971e+02
 4.15088345e+02 2.32338097e+02 1.21039045e+02 9.21953763e+01
 3.88477374e+01 3.93132837e+01 8.05674792e+00 1.20818894e+01
 3.15980452e+00 5.98770212e+00 3.98530676e-01 1.26724720e+00
 1.36284136e+03 2.41568902e+04 6.64178813e+02 9.83650155e+03
 2.98291133e+02 3.61646963e+03 3.11740127e+02 3.82142444e+03
 6.28668993e+01 5.16430572e+02 7.47423846e+00 3.60531387e+01
 2.06662083e+01 1.28546541e+02 7.78820759e-01 2.13442693e+00
 2.86004496e+00 1.08505179e+01 2.24261905e-01 4.50224138e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.9827287296997
cond(S) = 96651.8273421798
E1 = -729.3783752009713  E_coul = 203.12150138993346
init E= -526.256873811038
    CPU time for initialize scf      7.30 sec, wall time      0.34 sec
  HOMO = -0.556917905790991  LUMO = 1.04043276500022
  mo_energy =
[-1.18335051e+02 -1.22078171e+01 -9.45166038e+00 -9.45166038e+00
 -9.45166038e+00 -1.22605964e+00 -5.56917906e-01 -5.56917906e-01
 -5.56917906e-01  1.04043277e+00  1.04043277e+00  1.04043277e+00
  7.48630349e+00  7.48630349e+00  7.48630349e+00  1.00364335e+01
  3.43234771e+01  3.43234771e+01  3.43234771e+01  1.16224499e+02
  1.32092415e+02  1.32092415e+02  1.32092415e+02  4.87195233e+02
  4.87195233e+02  4.87195233e+02  6.52889541e+02  1.33432160e+03
  1.33432160e+03  1.33432160e+03  2.79207711e+03  3.02153057e+03
  3.02153057e+03  3.02153057e+03  6.63708337e+03  6.63708337e+03
  6.63708337e+03  9.21169070e+03  2.55594768e+04  7.62903715e+04]
E1 = -727.9896455595458  E_coul = 201.28075058489216
cycle= 1 E= -526.708894974654  delta_E= -0.452  |g|= 0.183  |ddm|= 0.407
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.538356
diis-c [-0.28982761  1.        ]
  HOMO = -0.58115666496005  LUMO = 1.02439416231581
  mo_energy =
[-1.18627248e+02 -1.23312286e+01 -9.58510157e+00 -9.58510157e+00
 -9.58510157e+00 -1.25720195e+00 -5.81156665e-01 -5.81156665e-01
 -5.81156665e-01  1.02439416e+00  1.02439416e+00  1.02439416e+00
  7.40980830e+00  7.40980830e+00  7.40980830e+00  9.94556916e+00
  3.41830956e+01  3.41830956e+01  3.41830956e+01  1.16011043e+02
  1.31878513e+02  1.31878513e+02  1.31878513e+02  4.86904925e+02
  4.86904925e+02  4.86904925e+02  6.52552889e+02  1.33397592e+03
  1.33397592e+03  1.33397592e+03  2.79159672e+03  3.02111932e+03
  3.02111932e+03  3.02111932e+03  6.63656009e+03  6.63656009e+03
  6.63656009e+03  9.21109378e+03  2.55587862e+04  7.62895912e+04]
E1 = -728.4505225403965  E_coul = 201.74104091149013
cycle= 2 E= -526.709481628906  delta_E= -0.000587  |g|= 0.0333  |ddm|= 0.0386
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0666488
diis-c [-0.0026576   0.07306897  0.92693103]
  HOMO = -0.574481208260125  LUMO = 1.02948132954493
  mo_energy =
[-1.18568857e+02 -1.23005778e+01 -9.55315287e+00 -9.55315287e+00
 -9.55315287e+00 -1.24872533e+00 -5.74481208e-01 -5.74481208e-01
 -5.74481208e-01  1.02948133e+00  1.02948133e+00  1.02948133e+00
  7.42839161e+00  7.42839161e+00  7.42839161e+00  9.97003043e+00
  3.42159585e+01  3.42159585e+01  3.42159585e+01  1.16059714e+02
  1.31925969e+02  1.31925969e+02  1.31925969e+02  4.86962532e+02
  4.86962532e+02  4.86962532e+02  6.52613270e+02  1.33403732e+03
  1.33403732e+03  1.33403732e+03  2.79166122e+03  3.02118281e+03
  3.02118281e+03  3.02118281e+03  6.63662514e+03  6.63662514e+03
  6.63662514e+03  9.21115954e+03  2.55588525e+04  7.62896576e+04]
E1 = -728.3463260763746  E_coul = 201.6368101832823
cycle= 3 E= -526.709515893092  delta_E= -3.43e-05  |g|= 0.0048  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104256
diis-c [-4.25970977e-07 -1.10550848e-03  1.30715865e-01  8.70389644e-01]
  HOMO = -0.575396812197642  LUMO = 1.02879445110337
  mo_energy =
[-1.18576387e+02 -1.23045987e+01 -9.55744391e+00 -9.55744391e+00
 -9.55744391e+00 -1.24983690e+00 -5.75396812e-01 -5.75396812e-01
 -5.75396812e-01  1.02879445e+00  1.02879445e+00  1.02879445e+00
  7.42587156e+00  7.42587156e+00  7.42587156e+00  9.96690791e+00
  3.42115781e+01  3.42115781e+01  3.42115781e+01  1.16053444e+02
  1.31919796e+02  1.31919796e+02  1.31919796e+02  4.86955102e+02
  4.86955102e+02  4.86955102e+02  6.52605448e+02  1.33402937e+03
  1.33402937e+03  1.33402937e+03  2.79165269e+03  3.02117451e+03
  3.02117451e+03  3.02117451e+03  6.63661650e+03  6.63661650e+03
  6.63661650e+03  9.21115070e+03  2.55588435e+04  7.62896485e+04]
E1 = -728.3604344511574  E_coul = 201.65091772771416
cycle= 4 E= -526.709516723443  delta_E= -8.3e-07  |g|= 5.89e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122801
diis-c [-1.28173157e-09  6.40633317e-05 -9.01196901e-03 -7.07381595e-02
  1.07968607e+00]
  HOMO = -0.575385086049315  LUMO = 1.02880321405199
  mo_energy =
[-1.18576392e+02 -1.23045707e+01 -9.55742742e+00 -9.55742742e+00
 -9.55742742e+00 -1.24981829e+00 -5.75385086e-01 -5.75385086e-01
 -5.75385086e-01  1.02880321e+00  1.02880321e+00  1.02880321e+00
  7.42589146e+00  7.42589146e+00  7.42589146e+00  9.96694242e+00
  3.42115932e+01  3.42115932e+01  3.42115932e+01  1.16053453e+02
  1.31919803e+02  1.31919803e+02  1.31919803e+02  4.86955098e+02
  4.86955098e+02  4.86955098e+02  6.52605436e+02  1.33402936e+03
  1.33402936e+03  1.33402936e+03  2.79165266e+03  3.02117449e+03
  3.02117449e+03  3.02117449e+03  6.63661646e+03  6.63661646e+03
  6.63661646e+03  9.21115066e+03  2.55588434e+04  7.62896485e+04]
E1 = -728.3604341440737  E_coul = 201.65091742052348
cycle= 5 E= -526.70951672355  delta_E= -1.07e-10  |g|= 7.66e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3604341440737  E_coul = 201.65091742052348
  HOMO = -0.575388490152779  LUMO = 1.02880070281583
  mo_energy =
[-1.18576409e+02 -1.23045827e+01 -9.55744001e+00 -9.55744001e+00
 -9.55744001e+00 -1.24982248e+00 -5.75388490e-01 -5.75388490e-01
 -5.75388490e-01  1.02880070e+00  1.02880070e+00  1.02880070e+00
  7.42588312e+00  7.42588312e+00  7.42588312e+00  9.96693260e+00
  3.42115807e+01  3.42115807e+01  3.42115807e+01  1.16053438e+02
  1.31919788e+02  1.31919788e+02  1.31919788e+02  4.86955081e+02
  4.86955081e+02  4.86955081e+02  6.52605418e+02  1.33402934e+03
  1.33402934e+03  1.33402934e+03  2.79165265e+03  3.02117447e+03
  3.02117447e+03  3.02117447e+03  6.63661645e+03  6.63661645e+03
  6.63661645e+03  9.21115064e+03  2.55588434e+04  7.62896485e+04]
E1 = -728.3604717754259  E_coul = 201.65095505187256
Extra cycle  E= -526.709516723553  delta_E= -3.18e-12  |g|= 2.26e-06  |ddm|= 3.9e-06
    CPU time for scf_cycle      7.51 sec, wall time      0.52 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 96651.8273421798
E1 = -728.3604717754259  E_coul = 201.65095505187256
init E= -526.709516723553
    CPU time for initialize scf     16.36 sec, wall time      0.77 sec
  HOMO = -0.57538780298899  LUMO = 1.02880121579024
  mo_energy =
[-1.18576404e+02 -1.23045799e+01 -9.55743715e+00 -9.55743715e+00
 -9.55743715e+00 -1.24982162e+00 -5.75387803e-01 -5.75387803e-01
 -5.75387803e-01  1.02880122e+00  1.02880122e+00  1.02880122e+00
  7.42588489e+00  7.42588489e+00  7.42588489e+00  9.96693483e+00
  3.42115836e+01  3.42115836e+01  3.42115836e+01  1.16053442e+02
  1.31919792e+02  1.31919792e+02  1.31919792e+02  4.86955086e+02
  4.86955086e+02  4.86955086e+02  6.52605423e+02  1.33402935e+03
  1.33402935e+03  1.33402935e+03  2.79165265e+03  3.02117448e+03
  3.02117448e+03  3.02117448e+03  6.63661645e+03  6.63661645e+03
  6.63661645e+03  9.21115065e+03  2.55588434e+04  7.62896485e+04]
E1 = -728.3604628511381  E_coul = 201.6509461275844
cycle= 1 E= -526.709516723554  delta_E= -2.27e-13  |g|= 5.79e-07  |ddm|= 8.89e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3604628511381  E_coul = 201.6509461275844
  HOMO = -0.575387954594513  LUMO = 1.02880110195413
  mo_energy =
[-1.18576406e+02 -1.23045806e+01 -9.55743783e+00 -9.55743783e+00
 -9.55743783e+00 -1.24982181e+00 -5.75387955e-01 -5.75387955e-01
 -5.75387955e-01  1.02880110e+00  1.02880110e+00  1.02880110e+00
  7.42588448e+00  7.42588448e+00  7.42588448e+00  9.96693431e+00
  3.42115829e+01  3.42115829e+01  3.42115829e+01  1.16053441e+02
  1.31919791e+02  1.31919791e+02  1.31919791e+02  4.86955084e+02
  4.86955084e+02  4.86955084e+02  6.52605422e+02  1.33402935e+03
  1.33402935e+03  1.33402935e+03  2.79165265e+03  3.02117448e+03
  3.02117448e+03  3.02117448e+03  6.63661645e+03  6.63661645e+03
  6.63661645e+03  9.21115065e+03  2.55588434e+04  7.62896485e+04]
E1 = -728.3604650212437  E_coul = 201.6509482976896
Extra cycle  E= -526.709516723554  delta_E= -4.55e-13  |g|= 1.45e-07  |ddm|= 2.08e-07
    CPU time for scf_cycle     16.48 sec, wall time      0.90 sec
exp = [2.61828321e+04 7.61710882e+03 3.61750826e+03 1.58859411e+03
 4.15088345e+02 1.21039045e+02 3.88477374e+01 8.05674792e+00
 3.15980452e+00 3.98530676e-01 1.36284136e+03 6.64178813e+02
 2.98291133e+02 3.11740127e+02 6.28668993e+01 7.47423846e+00
 2.06662083e+01 7.78820759e-01 2.86004496e+00 2.24261905e-01]
grad_E = [-1.40612756e-06  2.23324702e-06 -2.12750024e-06  3.89393725e-05
  1.01212010e-05  1.27249136e-06  1.31348357e-06  7.25009590e-08
  1.61874056e-06 -1.62593797e-05 -5.83817865e-07  4.11349260e-06
  1.88372148e-05  1.60915449e-05  6.93492360e-05 -1.44747526e-05
  2.98079121e-05  3.05856648e-06  2.85529328e-05  2.85883237e-05]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:01:22 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8320713        1
[INPUT] 0    0    [1    /1   ]  7617.10880952        1
[INPUT] 0    0    [1    /1   ]  3617.50827053        1
[INPUT] 0    0    [1    /1   ]  1588.59388003        1
[INPUT] 0    0    [1    /1   ]  415.08852286         1
[INPUT] 0    0    [1    /1   ]  121.036693101        1
[INPUT] 0    0    [1    /1   ]  38.8473280084        1
[INPUT] 0    0    [1    /1   ]  8.05713301906        1
[INPUT] 0    0    [1    /1   ]  3.15988270369        1
[INPUT] 0    0    [1    /1   ]  0.398525712648       1
[INPUT] 1    0    [1    /1   ]  1362.841367          1
[INPUT] 1    0    [1    /1   ]  664.178785749        1
[INPUT] 1    0    [1    /1   ]  298.291006524        1
[INPUT] 1    0    [1    /1   ]  311.740018688        1
[INPUT] 1    0    [1    /1   ]  62.8667087096        1
[INPUT] 1    0    [1    /1   ]  7.47330342451        1
[INPUT] 1    0    [1    /1   ]  20.6652574822        1
[INPUT] 1    0    [1    /1   ]  0.778808457806       1
[INPUT] 1    0    [1    /1   ]  2.85976097593        1
[INPUT] 1    0    [1    /1   ]  0.224267143863       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.83207129806, 1.0]], [0, [7617.108809524608, 1.0]], [0, [3617.508270532335, 1.0]], [0, [1588.5938800287963, 1.0]], [0, [415.0885228598883, 1.0]], [0, [121.0366931012131, 1.0]], [0, [38.84732800843832, 1.0]], [0, [8.057133019063787, 1.0]], [0, [3.159882703685869, 1.0]], [0, [0.398525712647788, 1.0]], [1, [1362.841367002449, 1.0]], [1, [664.178785748562, 1.0]], [1, [298.29100652430503, 1.0]], [1, [311.7400186884315, 1.0]], [1, [62.86670870956451, 1.0]], [1, [7.473303424509103, 1.0]], [1, [20.665257482237042, 1.0]], [1, [0.7788084578058324, 1.0]], [1, [2.8597609759259663, 1.0]], [1, [0.2242671438632633, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.8320713]
bas 1, expnt(s) = [7617.10880952]
bas 2, expnt(s) = [3617.50827053]
bas 3, expnt(s) = [1588.59388003]
bas 4, expnt(s) = [415.08852286]
bas 5, expnt(s) = [121.0366931]
bas 6, expnt(s) = [38.84732801]
bas 7, expnt(s) = [8.05713302]
bas 8, expnt(s) = [3.1598827]
bas 9, expnt(s) = [0.39852571]
bas 10, expnt(s) = [1362.841367]
bas 11, expnt(s) = [664.17878575]
bas 12, expnt(s) = [298.29100652]
bas 13, expnt(s) = [311.74001869]
bas 14, expnt(s) = [62.86670871]
bas 15, expnt(s) = [7.47330342]
bas 16, expnt(s) = [20.66525748]
bas 17, expnt(s) = [0.77880846]
bas 18, expnt(s) = [2.85976098]
bas 19, expnt(s) = [0.22426714]
CPU time:      1638.62
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828321e+04 5.20028912e+03 7.61710881e+03 2.05995458e+03
 3.61750827e+03 1.17847988e+03 1.58859388e+03 6.35732901e+02
 4.15088523e+02 2.32338172e+02 1.21036693e+02 9.21940326e+01
 3.88473280e+01 3.93129731e+01 8.05713302e+00 1.20823225e+01
 3.15988270e+00 5.98781323e+00 3.98525713e-01 1.26723537e+00
 1.36284137e+03 2.41568903e+04 6.64178786e+02 9.83650104e+03
 2.98291007e+02 3.61646771e+03 3.11740019e+02 3.82142279e+03
 6.28667087e+01 5.16428614e+02 7.47330342e+00 3.60475009e+01
 2.06652575e+01 1.28539148e+02 7.78808458e-01 2.13438479e+00
 2.85976098e+00 1.08491712e+01 2.24267144e-01 4.50237286e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982728955310137
cond(S) = 96649.50073991923
E1 = -729.3783220027386  E_coul = 203.1214628241401
init E= -526.256859178598
    CPU time for initialize scf      7.48 sec, wall time      0.35 sec
  HOMO = -0.556919413821124  LUMO = 1.04044140009473
  mo_energy =
[-1.18335054e+02 -1.22078201e+01 -9.45166301e+00 -9.45166301e+00
 -9.45166301e+00 -1.22606028e+00 -5.56919414e-01 -5.56919414e-01
 -5.56919414e-01  1.04044140e+00  1.04044140e+00  1.04044140e+00
  7.48552123e+00  7.48552123e+00  7.48552123e+00  1.00370221e+01
  3.43195887e+01  3.43195887e+01  3.43195887e+01  1.16224568e+02
  1.32085416e+02  1.32085416e+02  1.32085416e+02  4.87187827e+02
  4.87187827e+02  4.87187827e+02  6.52884017e+02  1.33431439e+03
  1.33431439e+03  1.33431439e+03  2.79206905e+03  3.02152342e+03
  3.02152342e+03  3.02152342e+03  6.63707653e+03  6.63707653e+03
  6.63707653e+03  9.21168233e+03  2.55594685e+04  7.62903636e+04]
E1 = -727.989714389226  E_coul = 201.28081935343184
cycle= 1 E= -526.708895035794  delta_E= -0.452  |g|= 0.183  |ddm|= 0.407
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.538356
diis-c [-0.28982724  1.        ]
  HOMO = -0.581154730977193  LUMO = 1.02440566609469
  mo_energy =
[-1.18627244e+02 -1.23312236e+01 -9.58509661e+00 -9.58509661e+00
 -9.58509661e+00 -1.25719758e+00 -5.81154731e-01 -5.81154731e-01
 -5.81154731e-01  1.02440567e+00  1.02440567e+00  1.02440567e+00
  7.40903961e+00  7.40903961e+00  7.40903961e+00  9.94616444e+00
  3.41792194e+01  3.41792194e+01  3.41792194e+01  1.16011119e+02
  1.31871523e+02  1.31871523e+02  1.31871523e+02  4.86897526e+02
  4.86897526e+02  4.86897526e+02  6.52547374e+02  1.33396872e+03
  1.33396872e+03  1.33396872e+03  2.79158866e+03  3.02111217e+03
  3.02111217e+03  3.02111217e+03  6.63655326e+03  6.63655326e+03
  6.63655326e+03  9.21108542e+03  2.55587779e+04  7.62895832e+04]
E1 = -728.4505719591573  E_coul = 201.741090286729
cycle= 2 E= -526.709481672428  delta_E= -0.000587  |g|= 0.0333  |ddm|= 0.0386
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0666469
diis-c [-0.00265748  0.07306641  0.92693359]
  HOMO = -0.574479686110207  LUMO = 1.02949244178097
  mo_energy =
[-1.18568854e+02 -1.23005740e+01 -9.55314921e+00 -9.55314921e+00
 -9.55314921e+00 -1.24872150e+00 -5.74479686e-01 -5.74479686e-01
 -5.74479686e-01  1.02949244e+00  1.02949244e+00  1.02949244e+00
  7.42762060e+00  7.42762060e+00  7.42762060e+00  9.97062535e+00
  3.42120800e+01  3.42120800e+01  3.42120800e+01  1.16059789e+02
  1.31918976e+02  1.31918976e+02  1.31918976e+02  4.86955131e+02
  4.86955131e+02  4.86955131e+02  6.52607753e+02  1.33403012e+03
  1.33403012e+03  1.33403012e+03  2.79165316e+03  3.02117566e+03
  3.02117566e+03  3.02117566e+03  6.63661831e+03  6.63661831e+03
  6.63661831e+03  9.21115117e+03  2.55588442e+04  7.62896497e+04]
E1 = -728.346381045539  E_coul = 201.63686511180416
cycle= 3 E= -526.709515933735  delta_E= -3.43e-05  |g|= 0.0048  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104254
diis-c [-4.26060394e-07 -1.10554272e-03  1.30715779e-01  8.70389764e-01]
  HOMO = -0.575395239193037  LUMO = 1.0288056141613
  mo_energy =
[-1.18576384e+02 -1.23045947e+01 -9.55744009e+00 -9.55744009e+00
 -9.55744009e+00 -1.24983300e+00 -5.75395239e-01 -5.75395239e-01
 -5.75395239e-01  1.02880561e+00  1.02880561e+00  1.02880561e+00
  7.42510086e+00  7.42510086e+00  7.42510086e+00  9.96750291e+00
  3.42076999e+01  3.42076999e+01  3.42076999e+01  1.16053519e+02
  1.31912805e+02  1.31912805e+02  1.31912805e+02  4.86947702e+02
  4.86947702e+02  4.86947702e+02  6.52599931e+02  1.33402217e+03
  1.33402217e+03  1.33402217e+03  2.79164464e+03  3.02116737e+03
  3.02116737e+03  3.02116737e+03  6.63660966e+03  6.63660966e+03
  6.63660966e+03  9.21114234e+03  2.55588351e+04  7.62896406e+04]
E1 = -728.3604887707412  E_coul = 201.65097200672216
cycle= 4 E= -526.709516764019  delta_E= -8.3e-07  |g|= 5.89e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122808
diis-c [-1.28214356e-09  6.40683632e-05 -9.01237278e-03 -7.07415157e-02
  1.07968982e+00]
  HOMO = -0.575383510307181  LUMO = 1.02881437906701
  mo_energy =
[-1.18576389e+02 -1.23045667e+01 -9.55742359e+00 -9.55742359e+00
 -9.55742359e+00 -1.24981438e+00 -5.75383510e-01 -5.75383510e-01
 -5.75383510e-01  1.02881438e+00  1.02881438e+00  1.02881438e+00
  7.42512077e+00  7.42512077e+00  7.42512077e+00  9.96753743e+00
  3.42077150e+01  3.42077150e+01  3.42077150e+01  1.16053528e+02
  1.31912811e+02  1.31912811e+02  1.31912811e+02  4.86947698e+02
  4.86947698e+02  4.86947698e+02  6.52599919e+02  1.33402216e+03
  1.33402216e+03  1.33402216e+03  2.79164460e+03  3.02116734e+03
  3.02116734e+03  3.02116734e+03  6.63660963e+03  6.63660963e+03
  6.63660963e+03  9.21114230e+03  2.55588351e+04  7.62896405e+04]
E1 = -728.3604884531628  E_coul = 201.65097168903608
cycle= 5 E= -526.709516764127  delta_E= -1.08e-10  |g|= 7.66e-06  |ddm|= 2.33e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3604884531628  E_coul = 201.65097168903608
  HOMO = -0.575386914787802  LUMO = 1.02881186759776
  mo_energy =
[-1.18576406e+02 -1.23045787e+01 -9.55743618e+00 -9.55743618e+00
 -9.55743618e+00 -1.24981857e+00 -5.75386915e-01 -5.75386915e-01
 -5.75386915e-01  1.02881187e+00  1.02881187e+00  1.02881187e+00
  7.42511242e+00  7.42511242e+00  7.42511242e+00  9.96752760e+00
  3.42077025e+01  3.42077025e+01  3.42077025e+01  1.16053513e+02
  1.31912796e+02  1.31912796e+02  1.31912796e+02  4.86947681e+02
  4.86947681e+02  4.86947681e+02  6.52599901e+02  1.33402214e+03
  1.33402214e+03  1.33402214e+03  2.79164459e+03  3.02116733e+03
  3.02116733e+03  3.02116733e+03  6.63660961e+03  6.63660961e+03
  6.63660961e+03  9.21114228e+03  2.55588351e+04  7.62896405e+04]
E1 = -728.3605260879887  E_coul = 201.65100932385786
Extra cycle  E= -526.709516764131  delta_E= -3.98e-12  |g|= 2.26e-06  |ddm|= 3.9e-06
    CPU time for scf_cycle      7.68 sec, wall time      0.53 sec
exp = [2.61828321e+04 7.61710881e+03 3.61750827e+03 1.58859388e+03
 4.15088523e+02 1.21036693e+02 3.88473280e+01 8.05713302e+00
 3.15988270e+00 3.98525713e-01 1.36284137e+03 6.64178786e+02
 2.98291007e+02 3.11740019e+02 6.28667087e+01 7.47330342e+00
 2.06652575e+01 7.78808458e-01 2.85976098e+00 2.24267144e-01]
E = -526.7095167641307
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:01:23 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8320713        1
[INPUT] 0    0    [1    /1   ]  7617.10880952        1
[INPUT] 0    0    [1    /1   ]  3617.50827053        1
[INPUT] 0    0    [1    /1   ]  1588.59388003        1
[INPUT] 0    0    [1    /1   ]  415.08852286         1
[INPUT] 0    0    [1    /1   ]  121.036693101        1
[INPUT] 0    0    [1    /1   ]  38.8473280084        1
[INPUT] 0    0    [1    /1   ]  8.05713301906        1
[INPUT] 0    0    [1    /1   ]  3.15988270369        1
[INPUT] 0    0    [1    /1   ]  0.398525712648       1
[INPUT] 1    0    [1    /1   ]  1362.841367          1
[INPUT] 1    0    [1    /1   ]  664.178785749        1
[INPUT] 1    0    [1    /1   ]  298.291006524        1
[INPUT] 1    0    [1    /1   ]  311.740018688        1
[INPUT] 1    0    [1    /1   ]  62.8667087096        1
[INPUT] 1    0    [1    /1   ]  7.47330342451        1
[INPUT] 1    0    [1    /1   ]  20.6652574822        1
[INPUT] 1    0    [1    /1   ]  0.778808457806       1
[INPUT] 1    0    [1    /1   ]  2.85976097593        1
[INPUT] 1    0    [1    /1   ]  0.224267143863       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.83207129806, 1.0]], [0, [7617.108809524608, 1.0]], [0, [3617.508270532335, 1.0]], [0, [1588.5938800287963, 1.0]], [0, [415.0885228598883, 1.0]], [0, [121.0366931012131, 1.0]], [0, [38.84732800843832, 1.0]], [0, [8.057133019063787, 1.0]], [0, [3.159882703685869, 1.0]], [0, [0.398525712647788, 1.0]], [1, [1362.841367002449, 1.0]], [1, [664.178785748562, 1.0]], [1, [298.29100652430503, 1.0]], [1, [311.7400186884315, 1.0]], [1, [62.86670870956451, 1.0]], [1, [7.473303424509103, 1.0]], [1, [20.665257482237042, 1.0]], [1, [0.7788084578058324, 1.0]], [1, [2.8597609759259663, 1.0]], [1, [0.2242671438632633, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.8320713]
bas 1, expnt(s) = [7617.10880952]
bas 2, expnt(s) = [3617.50827053]
bas 3, expnt(s) = [1588.59388003]
bas 4, expnt(s) = [415.08852286]
bas 5, expnt(s) = [121.0366931]
bas 6, expnt(s) = [38.84732801]
bas 7, expnt(s) = [8.05713302]
bas 8, expnt(s) = [3.1598827]
bas 9, expnt(s) = [0.39852571]
bas 10, expnt(s) = [1362.841367]
bas 11, expnt(s) = [664.17878575]
bas 12, expnt(s) = [298.29100652]
bas 13, expnt(s) = [311.74001869]
bas 14, expnt(s) = [62.86670871]
bas 15, expnt(s) = [7.47330342]
bas 16, expnt(s) = [20.66525748]
bas 17, expnt(s) = [0.77880846]
bas 18, expnt(s) = [2.85976098]
bas 19, expnt(s) = [0.22426714]
CPU time:      1646.56
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828321e+04 5.20028912e+03 7.61710881e+03 2.05995458e+03
 3.61750827e+03 1.17847988e+03 1.58859388e+03 6.35732901e+02
 4.15088523e+02 2.32338172e+02 1.21036693e+02 9.21940326e+01
 3.88473280e+01 3.93129731e+01 8.05713302e+00 1.20823225e+01
 3.15988270e+00 5.98781323e+00 3.98525713e-01 1.26723537e+00
 1.36284137e+03 2.41568903e+04 6.64178786e+02 9.83650104e+03
 2.98291007e+02 3.61646771e+03 3.11740019e+02 3.82142279e+03
 6.28667087e+01 5.16428614e+02 7.47330342e+00 3.60475009e+01
 2.06652575e+01 1.28539148e+02 7.78808458e-01 2.13438479e+00
 2.85976098e+00 1.08491712e+01 2.24267144e-01 4.50237286e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982728955310137
cond(S) = 96649.50073991923
E1 = -729.3783220027386  E_coul = 203.1214628241401
init E= -526.256859178598
    CPU time for initialize scf      7.33 sec, wall time      0.34 sec
  HOMO = -0.556919413821124  LUMO = 1.04044140009473
  mo_energy =
[-1.18335054e+02 -1.22078201e+01 -9.45166301e+00 -9.45166301e+00
 -9.45166301e+00 -1.22606028e+00 -5.56919414e-01 -5.56919414e-01
 -5.56919414e-01  1.04044140e+00  1.04044140e+00  1.04044140e+00
  7.48552123e+00  7.48552123e+00  7.48552123e+00  1.00370221e+01
  3.43195887e+01  3.43195887e+01  3.43195887e+01  1.16224568e+02
  1.32085416e+02  1.32085416e+02  1.32085416e+02  4.87187827e+02
  4.87187827e+02  4.87187827e+02  6.52884017e+02  1.33431439e+03
  1.33431439e+03  1.33431439e+03  2.79206905e+03  3.02152342e+03
  3.02152342e+03  3.02152342e+03  6.63707653e+03  6.63707653e+03
  6.63707653e+03  9.21168233e+03  2.55594685e+04  7.62903636e+04]
E1 = -727.989714389226  E_coul = 201.28081935343184
cycle= 1 E= -526.708895035794  delta_E= -0.452  |g|= 0.183  |ddm|= 0.407
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.538356
diis-c [-0.28982724  1.        ]
  HOMO = -0.581154730977193  LUMO = 1.02440566609469
  mo_energy =
[-1.18627244e+02 -1.23312236e+01 -9.58509661e+00 -9.58509661e+00
 -9.58509661e+00 -1.25719758e+00 -5.81154731e-01 -5.81154731e-01
 -5.81154731e-01  1.02440567e+00  1.02440567e+00  1.02440567e+00
  7.40903961e+00  7.40903961e+00  7.40903961e+00  9.94616444e+00
  3.41792194e+01  3.41792194e+01  3.41792194e+01  1.16011119e+02
  1.31871523e+02  1.31871523e+02  1.31871523e+02  4.86897526e+02
  4.86897526e+02  4.86897526e+02  6.52547374e+02  1.33396872e+03
  1.33396872e+03  1.33396872e+03  2.79158866e+03  3.02111217e+03
  3.02111217e+03  3.02111217e+03  6.63655326e+03  6.63655326e+03
  6.63655326e+03  9.21108542e+03  2.55587779e+04  7.62895832e+04]
E1 = -728.4505719591573  E_coul = 201.741090286729
cycle= 2 E= -526.709481672428  delta_E= -0.000587  |g|= 0.0333  |ddm|= 0.0386
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0666469
diis-c [-0.00265748  0.07306641  0.92693359]
  HOMO = -0.574479686110207  LUMO = 1.02949244178097
  mo_energy =
[-1.18568854e+02 -1.23005740e+01 -9.55314921e+00 -9.55314921e+00
 -9.55314921e+00 -1.24872150e+00 -5.74479686e-01 -5.74479686e-01
 -5.74479686e-01  1.02949244e+00  1.02949244e+00  1.02949244e+00
  7.42762060e+00  7.42762060e+00  7.42762060e+00  9.97062535e+00
  3.42120800e+01  3.42120800e+01  3.42120800e+01  1.16059789e+02
  1.31918976e+02  1.31918976e+02  1.31918976e+02  4.86955131e+02
  4.86955131e+02  4.86955131e+02  6.52607753e+02  1.33403012e+03
  1.33403012e+03  1.33403012e+03  2.79165316e+03  3.02117566e+03
  3.02117566e+03  3.02117566e+03  6.63661831e+03  6.63661831e+03
  6.63661831e+03  9.21115117e+03  2.55588442e+04  7.62896497e+04]
E1 = -728.346381045539  E_coul = 201.63686511180416
cycle= 3 E= -526.709515933735  delta_E= -3.43e-05  |g|= 0.0048  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104254
diis-c [-4.26060394e-07 -1.10554272e-03  1.30715779e-01  8.70389764e-01]
  HOMO = -0.575395239193037  LUMO = 1.0288056141613
  mo_energy =
[-1.18576384e+02 -1.23045947e+01 -9.55744009e+00 -9.55744009e+00
 -9.55744009e+00 -1.24983300e+00 -5.75395239e-01 -5.75395239e-01
 -5.75395239e-01  1.02880561e+00  1.02880561e+00  1.02880561e+00
  7.42510086e+00  7.42510086e+00  7.42510086e+00  9.96750291e+00
  3.42076999e+01  3.42076999e+01  3.42076999e+01  1.16053519e+02
  1.31912805e+02  1.31912805e+02  1.31912805e+02  4.86947702e+02
  4.86947702e+02  4.86947702e+02  6.52599931e+02  1.33402217e+03
  1.33402217e+03  1.33402217e+03  2.79164464e+03  3.02116737e+03
  3.02116737e+03  3.02116737e+03  6.63660966e+03  6.63660966e+03
  6.63660966e+03  9.21114234e+03  2.55588351e+04  7.62896406e+04]
E1 = -728.3604887707412  E_coul = 201.65097200672216
cycle= 4 E= -526.709516764019  delta_E= -8.3e-07  |g|= 5.89e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122808
diis-c [-1.28214356e-09  6.40683632e-05 -9.01237278e-03 -7.07415157e-02
  1.07968982e+00]
  HOMO = -0.575383510307181  LUMO = 1.02881437906701
  mo_energy =
[-1.18576389e+02 -1.23045667e+01 -9.55742359e+00 -9.55742359e+00
 -9.55742359e+00 -1.24981438e+00 -5.75383510e-01 -5.75383510e-01
 -5.75383510e-01  1.02881438e+00  1.02881438e+00  1.02881438e+00
  7.42512077e+00  7.42512077e+00  7.42512077e+00  9.96753743e+00
  3.42077150e+01  3.42077150e+01  3.42077150e+01  1.16053528e+02
  1.31912811e+02  1.31912811e+02  1.31912811e+02  4.86947698e+02
  4.86947698e+02  4.86947698e+02  6.52599919e+02  1.33402216e+03
  1.33402216e+03  1.33402216e+03  2.79164460e+03  3.02116734e+03
  3.02116734e+03  3.02116734e+03  6.63660963e+03  6.63660963e+03
  6.63660963e+03  9.21114230e+03  2.55588351e+04  7.62896405e+04]
E1 = -728.3604884531628  E_coul = 201.65097168903608
cycle= 5 E= -526.709516764127  delta_E= -1.08e-10  |g|= 7.66e-06  |ddm|= 2.33e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3604884531628  E_coul = 201.65097168903608
  HOMO = -0.575386914787802  LUMO = 1.02881186759776
  mo_energy =
[-1.18576406e+02 -1.23045787e+01 -9.55743618e+00 -9.55743618e+00
 -9.55743618e+00 -1.24981857e+00 -5.75386915e-01 -5.75386915e-01
 -5.75386915e-01  1.02881187e+00  1.02881187e+00  1.02881187e+00
  7.42511242e+00  7.42511242e+00  7.42511242e+00  9.96752760e+00
  3.42077025e+01  3.42077025e+01  3.42077025e+01  1.16053513e+02
  1.31912796e+02  1.31912796e+02  1.31912796e+02  4.86947681e+02
  4.86947681e+02  4.86947681e+02  6.52599901e+02  1.33402214e+03
  1.33402214e+03  1.33402214e+03  2.79164459e+03  3.02116733e+03
  3.02116733e+03  3.02116733e+03  6.63660961e+03  6.63660961e+03
  6.63660961e+03  9.21114228e+03  2.55588351e+04  7.62896405e+04]
E1 = -728.3605260879887  E_coul = 201.65100932385786
Extra cycle  E= -526.709516764131  delta_E= -3.98e-12  |g|= 2.26e-06  |ddm|= 3.9e-06
    CPU time for scf_cycle      7.53 sec, wall time      0.52 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 96649.50073991923
E1 = -728.3605260879887  E_coul = 201.65100932385786
init E= -526.709516764131
    CPU time for initialize scf      8.00 sec, wall time      0.39 sec
  HOMO = -0.57538622756744  LUMO = 1.02881238060498
  mo_energy =
[-1.18576401e+02 -1.23045760e+01 -9.55743333e+00 -9.55743333e+00
 -9.55743333e+00 -1.24981771e+00 -5.75386228e-01 -5.75386228e-01
 -5.75386228e-01  1.02881238e+00  1.02881238e+00  1.02881238e+00
  7.42511419e+00  7.42511419e+00  7.42511419e+00  9.96752983e+00
  3.42077054e+01  3.42077054e+01  3.42077054e+01  1.16053517e+02
  1.31912800e+02  1.31912800e+02  1.31912800e+02  4.86947685e+02
  4.86947685e+02  4.86947685e+02  6.52599906e+02  1.33402215e+03
  1.33402215e+03  1.33402215e+03  2.79164459e+03  3.02116733e+03
  3.02116733e+03  3.02116733e+03  6.63660962e+03  6.63660962e+03
  6.63660962e+03  9.21114228e+03  2.55588351e+04  7.62896405e+04]
E1 = -728.3605171629979  E_coul = 201.65100039886758
cycle= 1 E= -526.70951676413  delta_E= 4.55e-13  |g|= 5.79e-07  |ddm|= 8.89e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3605171629979  E_coul = 201.65100039886758
  HOMO = -0.57538637918288  LUMO = 1.02881226676353
  mo_energy =
[-1.18576403e+02 -1.23045766e+01 -9.55743400e+00 -9.55743400e+00
 -9.55743400e+00 -1.24981790e+00 -5.75386379e-01 -5.75386379e-01
 -5.75386379e-01  1.02881227e+00  1.02881227e+00  1.02881227e+00
  7.42511379e+00  7.42511379e+00  7.42511379e+00  9.96752932e+00
  3.42077047e+01  3.42077047e+01  3.42077047e+01  1.16053516e+02
  1.31912799e+02  1.31912799e+02  1.31912799e+02  4.86947684e+02
  4.86947684e+02  4.86947684e+02  6.52599905e+02  1.33402214e+03
  1.33402214e+03  1.33402214e+03  2.79164459e+03  3.02116733e+03
  3.02116733e+03  3.02116733e+03  6.63660962e+03  6.63660962e+03
  6.63660962e+03  9.21114228e+03  2.55588351e+04  7.62896405e+04]
E1 = -728.3605193332392  E_coul = 201.65100256910853
Extra cycle  E= -526.709516764131  delta_E= -3.41e-13  |g|= 1.45e-07  |ddm|= 2.08e-07
    CPU time for scf_cycle      8.11 sec, wall time      0.50 sec
exp = [2.61828321e+04 7.61710881e+03 3.61750827e+03 1.58859388e+03
 4.15088523e+02 1.21036693e+02 3.88473280e+01 8.05713302e+00
 3.15988270e+00 3.98525713e-01 1.36284137e+03 6.64178786e+02
 2.98291007e+02 3.11740019e+02 6.28667087e+01 7.47330342e+00
 2.06652575e+01 7.78808458e-01 2.85976098e+00 2.24267144e-01]
grad_E = [-1.40609044e-06  2.23293488e-06 -2.12743292e-06  3.89276205e-05
  1.03967623e-05 -2.29479224e-07  3.50440045e-06  3.18292480e-06
 -3.66459307e-06 -7.29214994e-05 -5.83791044e-07  4.11401052e-06
  1.88405808e-05  1.60943714e-05  6.86794855e-05 -5.27010139e-05
  4.01906673e-05 -1.03634832e-05  6.40935091e-05  1.72249138e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:01:28 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8321154        1
[INPUT] 0    0    [1    /1   ]  7617.10872844        1
[INPUT] 0    0    [1    /1   ]  3617.50832816        1
[INPUT] 0    0    [1    /1   ]  1588.59228849        1
[INPUT] 0    0    [1    /1   ]  415.091837343        1
[INPUT] 0    0    [1    /1   ]  121.033920986        1
[INPUT] 0    0    [1    /1   ]  38.8468224985        1
[INPUT] 0    0    [1    /1   ]  8.0579765268         1
[INPUT] 0    0    [1    /1   ]  3.16012542174        1
[INPUT] 0    0    [1    /1   ]  0.398518956815       1
[INPUT] 1    0    [1    /1   ]  1362.84138398        1
[INPUT] 1    0    [1    /1   ]  664.178651699        1
[INPUT] 1    0    [1    /1   ]  298.290384866        1
[INPUT] 1    0    [1    /1   ]  311.739486005        1
[INPUT] 1    0    [1    /1   ]  62.8658865117        1
[INPUT] 1    0    [1    /1   ]  7.47181238931        1
[INPUT] 1    0    [1    /1   ]  20.6635824155        1
[INPUT] 1    0    [1    /1   ]  0.778782998155       1
[INPUT] 1    0    [1    /1   ]  2.85929256884        1
[INPUT] 1    0    [1    /1   ]  0.224272216236       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.832115353027, 1.0]], [0, [7617.108728438067, 1.0]], [0, [3617.508328161076, 1.0]], [0, [1588.5922884888862, 1.0]], [0, [415.091837342751, 1.0]], [0, [121.03392098644467, 1.0]], [0, [38.84682249853707, 1.0]], [0, [8.057976526801907, 1.0]], [0, [3.160125421741219, 1.0]], [0, [0.3985189568152286, 1.0]], [1, [1362.841383981104, 1.0]], [1, [664.1786516986948, 1.0]], [1, [298.2903848658118, 1.0]], [1, [311.7394860049835, 1.0]], [1, [62.86588651174951, 1.0]], [1, [7.471812389308958, 1.0]], [1, [20.663582415535416, 1.0]], [1, [0.7787829981553657, 1.0]], [1, [2.859292568839563, 1.0]], [1, [0.22427221623644247, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.83211535]
bas 1, expnt(s) = [7617.10872844]
bas 2, expnt(s) = [3617.50832816]
bas 3, expnt(s) = [1588.59228849]
bas 4, expnt(s) = [415.09183734]
bas 5, expnt(s) = [121.03392099]
bas 6, expnt(s) = [38.8468225]
bas 7, expnt(s) = [8.05797653]
bas 8, expnt(s) = [3.16012542]
bas 9, expnt(s) = [0.39851896]
bas 10, expnt(s) = [1362.84138398]
bas 11, expnt(s) = [664.1786517]
bas 12, expnt(s) = [298.29038487]
bas 13, expnt(s) = [311.739486]
bas 14, expnt(s) = [62.86588651]
bas 15, expnt(s) = [7.47181239]
bas 16, expnt(s) = [20.66358242]
bas 17, expnt(s) = [0.778783]
bas 18, expnt(s) = [2.85929257]
bas 19, expnt(s) = [0.22427222]
CPU time:      1667.04
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828321e+04 5.20028912e+03 7.61710873e+03 2.05995456e+03
 3.61750833e+03 1.17847990e+03 1.58859229e+03 6.35732423e+02
 4.15091837e+02 2.32339564e+02 1.21033921e+02 9.21924489e+01
 3.88468225e+01 3.93125894e+01 8.05797653e+00 1.20832712e+01
 3.16012542e+00 5.98815818e+00 3.98518957e-01 1.26721925e+00
 1.36284138e+03 2.41568907e+04 6.64178652e+02 9.83649856e+03
 2.98290385e+02 3.61645829e+03 3.11739486e+02 3.82141462e+03
 6.28658865e+01 5.16420172e+02 7.47181239e+00 3.60385112e+01
 2.06635824e+01 1.28526125e+02 7.78782998e-01 2.13429757e+00
 2.85929257e+00 1.08469500e+01 2.24272216e-01 4.50250015e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982729530302834
cond(S) = 96643.88386987781
E1 = -729.3782470024436  E_coul = 203.12140680765066
init E= -526.256840194793
    CPU time for initialize scf      0.67 sec, wall time      0.05 sec
  HOMO = -0.556921502749665  LUMO = 1.04043732183774
  mo_energy =
[-1.18335060e+02 -1.22078229e+01 -9.45166684e+00 -9.45166684e+00
 -9.45166684e+00 -1.22606188e+00 -5.56921503e-01 -5.56921503e-01
 -5.56921503e-01  1.04043732e+00  1.04043732e+00  1.04043732e+00
  7.48421337e+00  7.48421337e+00  7.48421337e+00  1.00385438e+01
  3.43131981e+01  3.43131981e+01  3.43131981e+01  1.16226839e+02
  1.32073255e+02  1.32073255e+02  1.32073255e+02  4.87173695e+02
  4.87173695e+02  4.87173695e+02  6.52881580e+02  1.33429946e+03
  1.33429946e+03  1.33429946e+03  2.79206846e+03  3.02150745e+03
  3.02150745e+03  3.02150745e+03  6.63706048e+03  6.63706048e+03
  6.63706048e+03  9.21168209e+03  2.55594672e+04  7.62903618e+04]
E1 = -727.9898344054194  E_coul = 201.28093921090323
cycle= 1 E= -526.708895194516  delta_E= -0.452  |g|= 0.183  |ddm|= 0.407
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.538351
diis-c [-0.28982194  1.        ]
  HOMO = -0.581152003262987  LUMO = 1.02440591464776
  mo_energy =
[-1.18627235e+02 -1.23312137e+01 -9.58508722e+00 -9.58508722e+00
 -9.58508722e+00 -1.25719251e+00 -5.81152003e-01 -5.81152003e-01
 -5.81152003e-01  1.02440591e+00  1.02440591e+00  1.02440591e+00
  7.40775320e+00  7.40775320e+00  7.40775320e+00  9.94769374e+00
  3.41728494e+01  3.41728494e+01  3.41728494e+01  1.16013404e+02
  1.31859376e+02  1.31859376e+02  1.31859376e+02  4.86883408e+02
  4.86883408e+02  4.86883408e+02  6.52544951e+02  1.33395381e+03
  1.33395381e+03  1.33395381e+03  2.79158808e+03  3.02109623e+03
  3.02109623e+03  3.02109623e+03  6.63653722e+03  6.63653722e+03
  6.63653722e+03  9.21108519e+03  2.55587767e+04  7.62895814e+04]
E1 = -728.4506535665598  E_coul = 201.741171789496
cycle= 2 E= -526.709481777064  delta_E= -0.000587  |g|= 0.0333  |ddm|= 0.0386
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0666429
diis-c [-0.00265725  0.07306104  0.92693896]
  HOMO = -0.574477704661529  LUMO = 1.02949193354763
  mo_energy =
[-1.18568848e+02 -1.23005665e+01 -9.55314237e+00 -9.55314237e+00
 -9.55314237e+00 -1.24871739e+00 -5.74477705e-01 -5.74477705e-01
 -5.74477705e-01  1.02949193e+00  1.02949193e+00  1.02949193e+00
  7.42633020e+00  7.42633020e+00  7.42633020e+00  9.97215420e+00
  3.42057059e+01  3.42057059e+01  3.42057059e+01  1.16062071e+02
  1.31906827e+02  1.31906827e+02  1.31906827e+02  4.86941010e+02
  4.86941010e+02  4.86941010e+02  6.52605327e+02  1.33401520e+03
  1.33401520e+03  1.33401520e+03  2.79165258e+03  3.02115971e+03
  3.02115971e+03  3.02115971e+03  6.63660226e+03  6.63660226e+03
  6.63660226e+03  9.21115095e+03  2.55588429e+04  7.62896479e+04]
E1 = -728.3464729413159  E_coul = 201.6369569087976
cycle= 3 E= -526.709516032518  delta_E= -3.43e-05  |g|= 0.0048  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104248
diis-c [-4.26097227e-07 -1.10554876e-03  1.30715883e-01  8.70389666e-01]
  HOMO = -0.575393181182308  LUMO = 1.02880519145247
  mo_energy =
[-1.18576378e+02 -1.23045870e+01 -9.55743297e+00 -9.55743297e+00
 -9.55743297e+00 -1.24982879e+00 -5.75393181e-01 -5.75393181e-01
 -5.75393181e-01  1.02880519e+00  1.02880519e+00  1.02880519e+00
  7.42381096e+00  7.42381096e+00  7.42381096e+00  9.96903179e+00
  3.42013262e+01  3.42013262e+01  3.42013262e+01  1.16055801e+02
  1.31900655e+02  1.31900655e+02  1.31900655e+02  4.86933581e+02
  4.86933581e+02  4.86933581e+02  6.52597506e+02  1.33400726e+03
  1.33400726e+03  1.33400726e+03  2.79164406e+03  3.02115142e+03
  3.02115142e+03  3.02115142e+03  6.63659362e+03  6.63659362e+03
  6.63659362e+03  9.21114211e+03  2.55588339e+04  7.62896388e+04]
E1 = -728.3605795294438  E_coul = 201.65106266676253
cycle= 4 E= -526.709516862681  delta_E= -8.3e-07  |g|= 5.89e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122793
diis-c [-1.28265972e-09  6.40689909e-05 -9.01225702e-03 -7.07391915e-02
  1.07968738e+00]
  HOMO = -0.575381447801733  LUMO = 1.0288139594486
  mo_energy =
[-1.18576383e+02 -1.23045590e+01 -9.55741646e+00 -9.55741646e+00
 -9.55741646e+00 -1.24981017e+00 -5.75381448e-01 -5.75381448e-01
 -5.75381448e-01  1.02881396e+00  1.02881396e+00  1.02881396e+00
  7.42383087e+00  7.42383087e+00  7.42383087e+00  9.96906633e+00
  3.42013413e+01  3.42013413e+01  3.42013413e+01  1.16055810e+02
  1.31900662e+02  1.31900662e+02  1.31900662e+02  4.86933577e+02
  4.86933577e+02  4.86933577e+02  6.52597493e+02  1.33400724e+03
  1.33400724e+03  1.33400724e+03  2.79164403e+03  3.02115139e+03
  3.02115139e+03  3.02115139e+03  6.63659359e+03  6.63659359e+03
  6.63659359e+03  9.21114207e+03  2.55588338e+04  7.62896387e+04]
E1 = -728.3605791716368  E_coul = 201.65106230884805
cycle= 5 E= -526.709516862789  delta_E= -1.07e-10  |g|= 7.66e-06  |ddm|= 2.33e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3605791716368  E_coul = 201.65106230884805
  HOMO = -0.575384852714149  LUMO = 1.02881144776155
  mo_energy =
[-1.18576400e+02 -1.23045710e+01 -9.55742905e+00 -9.55742905e+00
 -9.55742905e+00 -1.24981436e+00 -5.75384853e-01 -5.75384853e-01
 -5.75384853e-01  1.02881145e+00  1.02881145e+00  1.02881145e+00
  7.42382253e+00  7.42382253e+00  7.42382253e+00  9.96905650e+00
  3.42013289e+01  3.42013289e+01  3.42013289e+01  1.16055795e+02
  1.31900647e+02  1.31900647e+02  1.31900647e+02  4.86933560e+02
  4.86933560e+02  4.86933560e+02  6.52597476e+02  1.33400723e+03
  1.33400723e+03  1.33400723e+03  2.79164401e+03  3.02115138e+03
  3.02115138e+03  3.02115138e+03  6.63659357e+03  6.63659357e+03
  6.63659357e+03  9.21114205e+03  2.55588338e+04  7.62896387e+04]
E1 = -728.3606168101563  E_coul = 201.65109994736517
Extra cycle  E= -526.709516862791  delta_E= -2.39e-12  |g|= 2.26e-06  |ddm|= 3.9e-06
    CPU time for scf_cycle      0.86 sec, wall time      0.23 sec
exp = [2.61828321e+04 7.61710873e+03 3.61750833e+03 1.58859229e+03
 4.15091837e+02 1.21033921e+02 3.88468225e+01 8.05797653e+00
 3.16012542e+00 3.98518957e-01 1.36284138e+03 6.64178652e+02
 2.98290385e+02 3.11739486e+02 6.28658865e+01 7.47181239e+00
 2.06635824e+01 7.78782998e-01 2.85929257e+00 2.24272216e-01]
E = -526.7095168627911
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:01:29 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8321154        1
[INPUT] 0    0    [1    /1   ]  7617.10872844        1
[INPUT] 0    0    [1    /1   ]  3617.50832816        1
[INPUT] 0    0    [1    /1   ]  1588.59228849        1
[INPUT] 0    0    [1    /1   ]  415.091837343        1
[INPUT] 0    0    [1    /1   ]  121.033920986        1
[INPUT] 0    0    [1    /1   ]  38.8468224985        1
[INPUT] 0    0    [1    /1   ]  8.0579765268         1
[INPUT] 0    0    [1    /1   ]  3.16012542174        1
[INPUT] 0    0    [1    /1   ]  0.398518956815       1
[INPUT] 1    0    [1    /1   ]  1362.84138398        1
[INPUT] 1    0    [1    /1   ]  664.178651699        1
[INPUT] 1    0    [1    /1   ]  298.290384866        1
[INPUT] 1    0    [1    /1   ]  311.739486005        1
[INPUT] 1    0    [1    /1   ]  62.8658865117        1
[INPUT] 1    0    [1    /1   ]  7.47181238931        1
[INPUT] 1    0    [1    /1   ]  20.6635824155        1
[INPUT] 1    0    [1    /1   ]  0.778782998155       1
[INPUT] 1    0    [1    /1   ]  2.85929256884        1
[INPUT] 1    0    [1    /1   ]  0.224272216236       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.832115353027, 1.0]], [0, [7617.108728438067, 1.0]], [0, [3617.508328161076, 1.0]], [0, [1588.5922884888862, 1.0]], [0, [415.091837342751, 1.0]], [0, [121.03392098644467, 1.0]], [0, [38.84682249853707, 1.0]], [0, [8.057976526801907, 1.0]], [0, [3.160125421741219, 1.0]], [0, [0.3985189568152286, 1.0]], [1, [1362.841383981104, 1.0]], [1, [664.1786516986948, 1.0]], [1, [298.2903848658118, 1.0]], [1, [311.7394860049835, 1.0]], [1, [62.86588651174951, 1.0]], [1, [7.471812389308958, 1.0]], [1, [20.663582415535416, 1.0]], [1, [0.7787829981553657, 1.0]], [1, [2.859292568839563, 1.0]], [1, [0.22427221623644247, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.83211535]
bas 1, expnt(s) = [7617.10872844]
bas 2, expnt(s) = [3617.50832816]
bas 3, expnt(s) = [1588.59228849]
bas 4, expnt(s) = [415.09183734]
bas 5, expnt(s) = [121.03392099]
bas 6, expnt(s) = [38.8468225]
bas 7, expnt(s) = [8.05797653]
bas 8, expnt(s) = [3.16012542]
bas 9, expnt(s) = [0.39851896]
bas 10, expnt(s) = [1362.84138398]
bas 11, expnt(s) = [664.1786517]
bas 12, expnt(s) = [298.29038487]
bas 13, expnt(s) = [311.739486]
bas 14, expnt(s) = [62.86588651]
bas 15, expnt(s) = [7.47181239]
bas 16, expnt(s) = [20.66358242]
bas 17, expnt(s) = [0.778783]
bas 18, expnt(s) = [2.85929257]
bas 19, expnt(s) = [0.22427222]
CPU time:      1668.15
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828321e+04 5.20028912e+03 7.61710873e+03 2.05995456e+03
 3.61750833e+03 1.17847990e+03 1.58859229e+03 6.35732423e+02
 4.15091837e+02 2.32339564e+02 1.21033921e+02 9.21924489e+01
 3.88468225e+01 3.93125894e+01 8.05797653e+00 1.20832712e+01
 3.16012542e+00 5.98815818e+00 3.98518957e-01 1.26721925e+00
 1.36284138e+03 2.41568907e+04 6.64178652e+02 9.83649856e+03
 2.98290385e+02 3.61645829e+03 3.11739486e+02 3.82141462e+03
 6.28658865e+01 5.16420172e+02 7.47181239e+00 3.60385112e+01
 2.06635824e+01 1.28526125e+02 7.78782998e-01 2.13429757e+00
 2.85929257e+00 1.08469500e+01 2.24272216e-01 4.50250015e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982729530302834
cond(S) = 96643.88386987781
E1 = -729.3782470024436  E_coul = 203.12140680765066
init E= -526.256840194793
    CPU time for initialize scf      0.63 sec, wall time      0.05 sec
  HOMO = -0.556921502749665  LUMO = 1.04043732183774
  mo_energy =
[-1.18335060e+02 -1.22078229e+01 -9.45166684e+00 -9.45166684e+00
 -9.45166684e+00 -1.22606188e+00 -5.56921503e-01 -5.56921503e-01
 -5.56921503e-01  1.04043732e+00  1.04043732e+00  1.04043732e+00
  7.48421337e+00  7.48421337e+00  7.48421337e+00  1.00385438e+01
  3.43131981e+01  3.43131981e+01  3.43131981e+01  1.16226839e+02
  1.32073255e+02  1.32073255e+02  1.32073255e+02  4.87173695e+02
  4.87173695e+02  4.87173695e+02  6.52881580e+02  1.33429946e+03
  1.33429946e+03  1.33429946e+03  2.79206846e+03  3.02150745e+03
  3.02150745e+03  3.02150745e+03  6.63706048e+03  6.63706048e+03
  6.63706048e+03  9.21168209e+03  2.55594672e+04  7.62903618e+04]
E1 = -727.9898344054194  E_coul = 201.28093921090323
cycle= 1 E= -526.708895194516  delta_E= -0.452  |g|= 0.183  |ddm|= 0.407
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.538351
diis-c [-0.28982194  1.        ]
  HOMO = -0.581152003262987  LUMO = 1.02440591464776
  mo_energy =
[-1.18627235e+02 -1.23312137e+01 -9.58508722e+00 -9.58508722e+00
 -9.58508722e+00 -1.25719251e+00 -5.81152003e-01 -5.81152003e-01
 -5.81152003e-01  1.02440591e+00  1.02440591e+00  1.02440591e+00
  7.40775320e+00  7.40775320e+00  7.40775320e+00  9.94769374e+00
  3.41728494e+01  3.41728494e+01  3.41728494e+01  1.16013404e+02
  1.31859376e+02  1.31859376e+02  1.31859376e+02  4.86883408e+02
  4.86883408e+02  4.86883408e+02  6.52544951e+02  1.33395381e+03
  1.33395381e+03  1.33395381e+03  2.79158808e+03  3.02109623e+03
  3.02109623e+03  3.02109623e+03  6.63653722e+03  6.63653722e+03
  6.63653722e+03  9.21108519e+03  2.55587767e+04  7.62895814e+04]
E1 = -728.4506535665598  E_coul = 201.741171789496
cycle= 2 E= -526.709481777064  delta_E= -0.000587  |g|= 0.0333  |ddm|= 0.0386
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0666429
diis-c [-0.00265725  0.07306104  0.92693896]
  HOMO = -0.574477704661529  LUMO = 1.02949193354763
  mo_energy =
[-1.18568848e+02 -1.23005665e+01 -9.55314237e+00 -9.55314237e+00
 -9.55314237e+00 -1.24871739e+00 -5.74477705e-01 -5.74477705e-01
 -5.74477705e-01  1.02949193e+00  1.02949193e+00  1.02949193e+00
  7.42633020e+00  7.42633020e+00  7.42633020e+00  9.97215420e+00
  3.42057059e+01  3.42057059e+01  3.42057059e+01  1.16062071e+02
  1.31906827e+02  1.31906827e+02  1.31906827e+02  4.86941010e+02
  4.86941010e+02  4.86941010e+02  6.52605327e+02  1.33401520e+03
  1.33401520e+03  1.33401520e+03  2.79165258e+03  3.02115971e+03
  3.02115971e+03  3.02115971e+03  6.63660226e+03  6.63660226e+03
  6.63660226e+03  9.21115095e+03  2.55588429e+04  7.62896479e+04]
E1 = -728.3464729413159  E_coul = 201.6369569087976
cycle= 3 E= -526.709516032518  delta_E= -3.43e-05  |g|= 0.0048  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104248
diis-c [-4.26097227e-07 -1.10554876e-03  1.30715883e-01  8.70389666e-01]
  HOMO = -0.575393181182308  LUMO = 1.02880519145247
  mo_energy =
[-1.18576378e+02 -1.23045870e+01 -9.55743297e+00 -9.55743297e+00
 -9.55743297e+00 -1.24982879e+00 -5.75393181e-01 -5.75393181e-01
 -5.75393181e-01  1.02880519e+00  1.02880519e+00  1.02880519e+00
  7.42381096e+00  7.42381096e+00  7.42381096e+00  9.96903179e+00
  3.42013262e+01  3.42013262e+01  3.42013262e+01  1.16055801e+02
  1.31900655e+02  1.31900655e+02  1.31900655e+02  4.86933581e+02
  4.86933581e+02  4.86933581e+02  6.52597506e+02  1.33400726e+03
  1.33400726e+03  1.33400726e+03  2.79164406e+03  3.02115142e+03
  3.02115142e+03  3.02115142e+03  6.63659362e+03  6.63659362e+03
  6.63659362e+03  9.21114211e+03  2.55588339e+04  7.62896388e+04]
E1 = -728.3605795294438  E_coul = 201.65106266676253
cycle= 4 E= -526.709516862681  delta_E= -8.3e-07  |g|= 5.89e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122793
diis-c [-1.28265972e-09  6.40689909e-05 -9.01225702e-03 -7.07391915e-02
  1.07968738e+00]
  HOMO = -0.575381447801733  LUMO = 1.0288139594486
  mo_energy =
[-1.18576383e+02 -1.23045590e+01 -9.55741646e+00 -9.55741646e+00
 -9.55741646e+00 -1.24981017e+00 -5.75381448e-01 -5.75381448e-01
 -5.75381448e-01  1.02881396e+00  1.02881396e+00  1.02881396e+00
  7.42383087e+00  7.42383087e+00  7.42383087e+00  9.96906633e+00
  3.42013413e+01  3.42013413e+01  3.42013413e+01  1.16055810e+02
  1.31900662e+02  1.31900662e+02  1.31900662e+02  4.86933577e+02
  4.86933577e+02  4.86933577e+02  6.52597493e+02  1.33400724e+03
  1.33400724e+03  1.33400724e+03  2.79164403e+03  3.02115139e+03
  3.02115139e+03  3.02115139e+03  6.63659359e+03  6.63659359e+03
  6.63659359e+03  9.21114207e+03  2.55588338e+04  7.62896387e+04]
E1 = -728.3605791716368  E_coul = 201.65106230884805
cycle= 5 E= -526.709516862789  delta_E= -1.07e-10  |g|= 7.66e-06  |ddm|= 2.33e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3605791716368  E_coul = 201.65106230884805
  HOMO = -0.575384852714149  LUMO = 1.02881144776155
  mo_energy =
[-1.18576400e+02 -1.23045710e+01 -9.55742905e+00 -9.55742905e+00
 -9.55742905e+00 -1.24981436e+00 -5.75384853e-01 -5.75384853e-01
 -5.75384853e-01  1.02881145e+00  1.02881145e+00  1.02881145e+00
  7.42382253e+00  7.42382253e+00  7.42382253e+00  9.96905650e+00
  3.42013289e+01  3.42013289e+01  3.42013289e+01  1.16055795e+02
  1.31900647e+02  1.31900647e+02  1.31900647e+02  4.86933560e+02
  4.86933560e+02  4.86933560e+02  6.52597476e+02  1.33400723e+03
  1.33400723e+03  1.33400723e+03  2.79164401e+03  3.02115138e+03
  3.02115138e+03  3.02115138e+03  6.63659357e+03  6.63659357e+03
  6.63659357e+03  9.21114205e+03  2.55588338e+04  7.62896387e+04]
E1 = -728.3606168101563  E_coul = 201.65109994736517
Extra cycle  E= -526.709516862791  delta_E= -2.39e-12  |g|= 2.26e-06  |ddm|= 3.9e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 96643.88386987781
E1 = -728.3606168101563  E_coul = 201.65109994736517
init E= -526.709516862791
    CPU time for initialize scf      3.85 sec, wall time      0.22 sec
  HOMO = -0.575384165434652  LUMO = 1.02881196079307
  mo_energy =
[-1.18576396e+02 -1.23045682e+01 -9.55742619e+00 -9.55742619e+00
 -9.55742619e+00 -1.24981350e+00 -5.75384165e-01 -5.75384165e-01
 -5.75384165e-01  1.02881196e+00  1.02881196e+00  1.02881196e+00
  7.42382430e+00  7.42382430e+00  7.42382430e+00  9.96905873e+00
  3.42013317e+01  3.42013317e+01  3.42013317e+01  1.16055799e+02
  1.31900651e+02  1.31900651e+02  1.31900651e+02  4.86933564e+02
  4.86933564e+02  4.86933564e+02  6.52597481e+02  1.33400723e+03
  1.33400723e+03  1.33400723e+03  2.79164401e+03  3.02115138e+03
  3.02115138e+03  3.02115138e+03  6.63659357e+03  6.63659357e+03
  6.63659357e+03  9.21114206e+03  2.55588338e+04  7.62896387e+04]
E1 = -728.3606078844888  E_coul = 201.65109102169595
cycle= 1 E= -526.709516862793  delta_E= -1.71e-12  |g|= 5.79e-07  |ddm|= 8.89e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3606078844888  E_coul = 201.65109102169595
  HOMO = -0.575384317059966  LUMO = 1.02881184694815
  mo_energy =
[-1.18576397e+02 -1.23045689e+01 -9.55742687e+00 -9.55742687e+00
 -9.55742687e+00 -1.24981369e+00 -5.75384317e-01 -5.75384317e-01
 -5.75384317e-01  1.02881185e+00  1.02881185e+00  1.02881185e+00
  7.42382390e+00  7.42382390e+00  7.42382390e+00  9.96905821e+00
  3.42013311e+01  3.42013311e+01  3.42013311e+01  1.16055798e+02
  1.31900650e+02  1.31900650e+02  1.31900650e+02  4.86933563e+02
  4.86933563e+02  4.86933563e+02  6.52597480e+02  1.33400723e+03
  1.33400723e+03  1.33400723e+03  2.79164401e+03  3.02115138e+03
  3.02115138e+03  3.02115138e+03  6.63659357e+03  6.63659357e+03
  6.63659357e+03  9.21114205e+03  2.55588338e+04  7.62896387e+04]
E1 = -728.3606100548483  E_coul = 201.65109319205638
Extra cycle  E= -526.709516862792  delta_E= 9.09e-13  |g|= 1.45e-07  |ddm|= 2.08e-07
    CPU time for scf_cycle      3.96 sec, wall time      0.33 sec
exp = [2.61828321e+04 7.61710873e+03 3.61750833e+03 1.58859229e+03
 4.15091837e+02 1.21033921e+02 3.88468225e+01 8.05797653e+00
 3.16012542e+00 3.98518957e-01 1.36284138e+03 6.64178652e+02
 2.98290385e+02 3.11739486e+02 6.28658865e+01 7.47181239e+00
 2.06635824e+01 7.78782998e-01 2.85929257e+00 2.24272216e-01]
grad_E = [-1.40602298e-06  2.23236801e-06 -2.12734419e-06  3.89072478e-05
  1.08155588e-05 -2.26759827e-06  5.75483553e-06  5.58891274e-06
  2.60983072e-06 -1.44066245e-04 -5.83744575e-07  4.11488651e-06
  1.88460956e-05  1.60990113e-05  6.77559682e-05 -1.07994481e-04
  5.50879922e-05 -2.62301799e-05  1.14452262e-04  3.62175308e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:01:33 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8322435        1
[INPUT] 0    0    [1    /1   ]  7617.1084924         1
[INPUT] 0    0    [1    /1   ]  3617.50849544        1
[INPUT] 0    0    [1    /1   ]  1588.58766261        1
[INPUT] 0    0    [1    /1   ]  415.100528945        1
[INPUT] 0    0    [1    /1   ]  121.030493723        1
[INPUT] 0    0    [1    /1   ]  38.8463633672        1
[INPUT] 0    0    [1    /1   ]  8.05931001395        1
[INPUT] 0    0    [1    /1   ]  3.16045134441        1
[INPUT] 0    0    [1    /1   ]  0.398506577391       1
[INPUT] 1    0    [1    /1   ]  1362.84143341        1
[INPUT] 1    0    [1    /1   ]  664.178262957        1
[INPUT] 1    0    [1    /1   ]  298.28858386         1
[INPUT] 1    0    [1    /1   ]  311.737942619        1
[INPUT] 1    0    [1    /1   ]  62.8628413814        1
[INPUT] 1    0    [1    /1   ]  7.46916483273        1
[INPUT] 1    0    [1    /1   ]  20.6602391183        1
[INPUT] 1    0    [1    /1   ]  0.778737479411       1
[INPUT] 1    0    [1    /1   ]  2.85845558834        1
[INPUT] 1    0    [1    /1   ]  0.224282152706       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.83224346228, 1.0]], [0, [7617.108492401299, 1.0]], [0, [3617.508495436828, 1.0]], [0, [1588.5876626142365, 1.0]], [0, [415.10052894468475, 1.0]], [0, [121.03049372282656, 1.0]], [0, [38.84636336724688, 1.0]], [0, [8.059310013952828, 1.0]], [0, [3.160451344412285, 1.0]], [0, [0.39850657739103273, 1.0]], [1, [1362.8414334075799, 1.0]], [1, [664.1782629572658, 1.0]], [1, [298.2885838595789, 1.0]], [1, [311.7379426185936, 1.0]], [1, [62.862841381437875, 1.0]], [1, [7.469164832726023, 1.0]], [1, [20.660239118346585, 1.0]], [1, [0.7787374794113677, 1.0]], [1, [2.858455588337984, 1.0]], [1, [0.22428215270607743, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.83224346]
bas 1, expnt(s) = [7617.1084924]
bas 2, expnt(s) = [3617.50849544]
bas 3, expnt(s) = [1588.58766261]
bas 4, expnt(s) = [415.10052894]
bas 5, expnt(s) = [121.03049372]
bas 6, expnt(s) = [38.84636337]
bas 7, expnt(s) = [8.05931001]
bas 8, expnt(s) = [3.16045134]
bas 9, expnt(s) = [0.39850658]
bas 10, expnt(s) = [1362.84143341]
bas 11, expnt(s) = [664.17826296]
bas 12, expnt(s) = [298.28858386]
bas 13, expnt(s) = [311.73794262]
bas 14, expnt(s) = [62.86284138]
bas 15, expnt(s) = [7.46916483]
bas 16, expnt(s) = [20.66023912]
bas 17, expnt(s) = [0.77873748]
bas 18, expnt(s) = [2.85845559]
bas 19, expnt(s) = [0.22428215]
CPU time:      1677.78
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828322e+04 5.20028914e+03 7.61710849e+03 2.05995451e+03
 3.61750850e+03 1.17847994e+03 1.58858766e+03 6.35731035e+02
 4.15100529e+02 2.32343212e+02 1.21030494e+02 9.21904910e+01
 3.88463634e+01 3.93122409e+01 8.05931001e+00 1.20847709e+01
 3.16045134e+00 5.98862137e+00 3.98506577e-01 1.26718973e+00
 1.36284143e+03 2.41568918e+04 6.64178263e+02 9.83649137e+03
 2.98288584e+02 3.61643100e+03 3.11737943e+02 3.82139098e+03
 6.28628414e+01 5.16388904e+02 7.46916483e+00 3.60225495e+01
 2.06602391e+01 1.28500132e+02 7.78737479e-01 2.13414164e+00
 2.85845559e+00 1.08429812e+01 2.24282153e-01 4.50274951e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982730534284986
cond(S) = 96629.54877812183
E1 = -729.3781092783502  E_coul = 203.12130603613718
init E= -526.256803242213
    CPU time for initialize scf      0.64 sec, wall time      0.05 sec
  HOMO = -0.556925401651247  LUMO = 1.04043305943295
  mo_energy =
[-1.18335069e+02 -1.22078295e+01 -9.45167371e+00 -9.45167371e+00
 -9.45167371e+00 -1.22606403e+00 -5.56925402e-01 -5.56925402e-01
 -5.56925402e-01  1.04043306e+00  1.04043306e+00  1.04043306e+00
  7.48188382e+00  7.48188382e+00  7.48188382e+00  1.00407934e+01
  3.43015912e+01  3.43015912e+01  3.43015912e+01  1.16231256e+02
  1.32049142e+02  1.32049142e+02  1.32049142e+02  4.87142461e+02
  4.87142461e+02  4.87142461e+02  6.52883472e+02  1.33426455e+03
  1.33426455e+03  1.33426455e+03  2.79207961e+03  3.02146880e+03
  3.02146880e+03  3.02146880e+03  6.63702083e+03  6.63702083e+03
  6.63702083e+03  9.21169378e+03  2.55594753e+04  7.62903675e+04]
E1 = -727.9900160886392  E_coul = 201.28112055704548
cycle= 1 E= -526.708895531594  delta_E= -0.452  |g|= 0.183  |ddm|= 0.408
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.538346
diis-c [-0.28981645  1.        ]
  HOMO = -0.581147295814915  LUMO = 1.02440935948554
  mo_energy =
[-1.18627223e+02 -1.23311997e+01 -9.58507372e+00 -9.58507372e+00
 -9.58507372e+00 -1.25718241e+00 -5.81147296e-01 -5.81147296e-01
 -5.81147296e-01  1.02440936e+00  1.02440936e+00  1.02440936e+00
  7.40546065e+00  7.40546065e+00  7.40546065e+00  9.94995723e+00
  3.41612772e+01  3.41612772e+01  3.41612772e+01  1.16017840e+02
  1.31835286e+02  1.31835286e+02  1.31835286e+02  4.86852193e+02
  4.86852193e+02  4.86852193e+02  6.52546864e+02  1.33391892e+03
  1.33391892e+03  1.33391892e+03  2.79159925e+03  3.02105759e+03
  3.02105759e+03  3.02105759e+03  6.63649759e+03  6.63649759e+03
  6.63649759e+03  9.21109690e+03  2.55587847e+04  7.62895871e+04]
E1 = -728.4507796873347  E_coul = 201.7412976369716
cycle= 2 E= -526.709482050363  delta_E= -0.000587  |g|= 0.0333  |ddm|= 0.0386
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0666371
diis-c [-0.00265691  0.0730534   0.9269466 ]
  HOMO = -0.574474120696775  LUMO = 1.02949418539695
  mo_energy =
[-1.18568841e+02 -1.23005560e+01 -9.55313260e+00 -9.55313260e+00
 -9.55313260e+00 -1.24870875e+00 -5.74474121e-01 -5.74474121e-01
 -5.74474121e-01  1.02949419e+00  1.02949419e+00  1.02949419e+00
  7.42403103e+00  7.42403103e+00  7.42403103e+00  9.97441719e+00
  3.41941269e+01  3.41941269e+01  3.41941269e+01  1.16066503e+02
  1.31882732e+02  1.31882732e+02  1.31882732e+02  4.86909790e+02
  4.86909790e+02  4.86909790e+02  6.52607236e+02  1.33398031e+03
  1.33398031e+03  1.33398031e+03  2.79166374e+03  3.02112107e+03
  3.02112107e+03  3.02112107e+03  6.63656263e+03  6.63656263e+03
  6.63656263e+03  9.21116265e+03  2.55588510e+04  7.62896536e+04]
E1 = -728.3466146476586  E_coul = 201.63709835029616
cycle= 3 E= -526.709516297362  delta_E= -3.42e-05  |g|= 0.0048  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104239
diis-c [-4.26247748e-07 -1.10559636e-03  1.30715815e-01  8.70389781e-01]
  HOMO = -0.575389466032523  LUMO = 1.02880759210357
  mo_energy =
[-1.18576370e+02 -1.23045760e+01 -9.55742275e+00 -9.55742275e+00
 -9.55742275e+00 -1.24981997e+00 -5.75389466e-01 -5.75389466e-01
 -5.75389466e-01  1.02880759e+00  1.02880759e+00  1.02880759e+00
  7.42151264e+00  7.42151264e+00  7.42151264e+00  9.97129488e+00
  3.41897480e+01  3.41897480e+01  3.41897480e+01  1.16060233e+02
  1.31876561e+02  1.31876561e+02  1.31876561e+02  4.86902362e+02
  4.86902362e+02  4.86902362e+02  6.52599415e+02  1.33397236e+03
  1.33397236e+03  1.33397236e+03  2.79165522e+03  3.02111278e+03
  3.02111278e+03  3.02111278e+03  6.63655399e+03  6.63655399e+03
  6.63655399e+03  9.21115382e+03  2.55588420e+04  7.62896445e+04]
E1 = -728.3607194303902  E_coul = 201.65120230305112
cycle= 4 E= -526.709517127339  delta_E= -8.3e-07  |g|= 5.89e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122793
diis-c [-1.28361241e-09  6.40770259e-05 -9.01281685e-03 -7.07430081e-02
  1.07969175e+00]
  HOMO = -0.57537772597242  LUMO = 1.02881636463726
  mo_energy =
[-1.18576375e+02 -1.23045480e+01 -9.55740621e+00 -9.55740621e+00
 -9.55740621e+00 -1.24980134e+00 -5.75377726e-01 -5.75377726e-01
 -5.75377726e-01  1.02881636e+00  1.02881636e+00  1.02881636e+00
  7.42153257e+00  7.42153257e+00  7.42153257e+00  9.97132944e+00
  3.41897632e+01  3.41897632e+01  3.41897632e+01  1.16060242e+02
  1.31876568e+02  1.31876568e+02  1.31876568e+02  4.86902358e+02
  4.86902358e+02  4.86902358e+02  6.52599403e+02  1.33397235e+03
  1.33397235e+03  1.33397235e+03  2.79165519e+03  3.02111276e+03
  3.02111276e+03  3.02111276e+03  6.63655396e+03  6.63655396e+03
  6.63655396e+03  9.21115377e+03  2.55588419e+04  7.62896444e+04]
E1 = -728.3607190333367  E_coul = 201.65120190589232
cycle= 5 E= -526.709517127444  delta_E= -1.05e-10  |g|= 7.66e-06  |ddm|= 2.33e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3607190333367  E_coul = 201.65120190589232
  HOMO = -0.575381131672156  LUMO = 1.02881385254932
  mo_energy =
[-1.18576392e+02 -1.23045600e+01 -9.55741881e+00 -9.55741881e+00
 -9.55741881e+00 -1.24980553e+00 -5.75381132e-01 -5.75381132e-01
 -5.75381132e-01  1.02881385e+00  1.02881385e+00  1.02881385e+00
  7.42152422e+00  7.42152422e+00  7.42152422e+00  9.97131961e+00
  3.41897507e+01  3.41897507e+01  3.41897507e+01  1.16060227e+02
  1.31876553e+02  1.31876553e+02  1.31876553e+02  4.86902341e+02
  4.86902341e+02  4.86902341e+02  6.52599385e+02  1.33397233e+03
  1.33397233e+03  1.33397233e+03  2.79165517e+03  3.02111274e+03
  3.02111274e+03  3.02111274e+03  6.63655394e+03  6.63655394e+03
  6.63655394e+03  9.21115375e+03  2.55588419e+04  7.62896444e+04]
E1 = -728.3607566785021  E_coul = 201.65123955105335
Extra cycle  E= -526.709517127449  delta_E= -4.32e-12  |g|= 2.26e-06  |ddm|= 3.9e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.23 sec
exp = [2.61828322e+04 7.61710849e+03 3.61750850e+03 1.58858766e+03
 4.15100529e+02 1.21030494e+02 3.88463634e+01 8.05931001e+00
 3.16045134e+00 3.98506577e-01 1.36284143e+03 6.64178263e+02
 2.98288584e+02 3.11737943e+02 6.28628414e+01 7.46916483e+00
 2.06602391e+01 7.78737479e-01 2.85845559e+00 2.24282153e-01]
E = -526.7095171274487
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:01:33 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8322435        1
[INPUT] 0    0    [1    /1   ]  7617.1084924         1
[INPUT] 0    0    [1    /1   ]  3617.50849544        1
[INPUT] 0    0    [1    /1   ]  1588.58766261        1
[INPUT] 0    0    [1    /1   ]  415.100528945        1
[INPUT] 0    0    [1    /1   ]  121.030493723        1
[INPUT] 0    0    [1    /1   ]  38.8463633672        1
[INPUT] 0    0    [1    /1   ]  8.05931001395        1
[INPUT] 0    0    [1    /1   ]  3.16045134441        1
[INPUT] 0    0    [1    /1   ]  0.398506577391       1
[INPUT] 1    0    [1    /1   ]  1362.84143341        1
[INPUT] 1    0    [1    /1   ]  664.178262957        1
[INPUT] 1    0    [1    /1   ]  298.28858386         1
[INPUT] 1    0    [1    /1   ]  311.737942619        1
[INPUT] 1    0    [1    /1   ]  62.8628413814        1
[INPUT] 1    0    [1    /1   ]  7.46916483273        1
[INPUT] 1    0    [1    /1   ]  20.6602391183        1
[INPUT] 1    0    [1    /1   ]  0.778737479411       1
[INPUT] 1    0    [1    /1   ]  2.85845558834        1
[INPUT] 1    0    [1    /1   ]  0.224282152706       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.83224346228, 1.0]], [0, [7617.108492401299, 1.0]], [0, [3617.508495436828, 1.0]], [0, [1588.5876626142365, 1.0]], [0, [415.10052894468475, 1.0]], [0, [121.03049372282656, 1.0]], [0, [38.84636336724688, 1.0]], [0, [8.059310013952828, 1.0]], [0, [3.160451344412285, 1.0]], [0, [0.39850657739103273, 1.0]], [1, [1362.8414334075799, 1.0]], [1, [664.1782629572658, 1.0]], [1, [298.2885838595789, 1.0]], [1, [311.7379426185936, 1.0]], [1, [62.862841381437875, 1.0]], [1, [7.469164832726023, 1.0]], [1, [20.660239118346585, 1.0]], [1, [0.7787374794113677, 1.0]], [1, [2.858455588337984, 1.0]], [1, [0.22428215270607743, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.83224346]
bas 1, expnt(s) = [7617.1084924]
bas 2, expnt(s) = [3617.50849544]
bas 3, expnt(s) = [1588.58766261]
bas 4, expnt(s) = [415.10052894]
bas 5, expnt(s) = [121.03049372]
bas 6, expnt(s) = [38.84636337]
bas 7, expnt(s) = [8.05931001]
bas 8, expnt(s) = [3.16045134]
bas 9, expnt(s) = [0.39850658]
bas 10, expnt(s) = [1362.84143341]
bas 11, expnt(s) = [664.17826296]
bas 12, expnt(s) = [298.28858386]
bas 13, expnt(s) = [311.73794262]
bas 14, expnt(s) = [62.86284138]
bas 15, expnt(s) = [7.46916483]
bas 16, expnt(s) = [20.66023912]
bas 17, expnt(s) = [0.77873748]
bas 18, expnt(s) = [2.85845559]
bas 19, expnt(s) = [0.22428215]
CPU time:      1678.87
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828322e+04 5.20028914e+03 7.61710849e+03 2.05995451e+03
 3.61750850e+03 1.17847994e+03 1.58858766e+03 6.35731035e+02
 4.15100529e+02 2.32343212e+02 1.21030494e+02 9.21904910e+01
 3.88463634e+01 3.93122409e+01 8.05931001e+00 1.20847709e+01
 3.16045134e+00 5.98862137e+00 3.98506577e-01 1.26718973e+00
 1.36284143e+03 2.41568918e+04 6.64178263e+02 9.83649137e+03
 2.98288584e+02 3.61643100e+03 3.11737943e+02 3.82139098e+03
 6.28628414e+01 5.16388904e+02 7.46916483e+00 3.60225495e+01
 2.06602391e+01 1.28500132e+02 7.78737479e-01 2.13414164e+00
 2.85845559e+00 1.08429812e+01 2.24282153e-01 4.50274951e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982730534284986
cond(S) = 96629.54877812183
E1 = -729.3781092783502  E_coul = 203.12130603613718
init E= -526.256803242213
    CPU time for initialize scf      0.64 sec, wall time      0.05 sec
  HOMO = -0.556925401651247  LUMO = 1.04043305943295
  mo_energy =
[-1.18335069e+02 -1.22078295e+01 -9.45167371e+00 -9.45167371e+00
 -9.45167371e+00 -1.22606403e+00 -5.56925402e-01 -5.56925402e-01
 -5.56925402e-01  1.04043306e+00  1.04043306e+00  1.04043306e+00
  7.48188382e+00  7.48188382e+00  7.48188382e+00  1.00407934e+01
  3.43015912e+01  3.43015912e+01  3.43015912e+01  1.16231256e+02
  1.32049142e+02  1.32049142e+02  1.32049142e+02  4.87142461e+02
  4.87142461e+02  4.87142461e+02  6.52883472e+02  1.33426455e+03
  1.33426455e+03  1.33426455e+03  2.79207961e+03  3.02146880e+03
  3.02146880e+03  3.02146880e+03  6.63702083e+03  6.63702083e+03
  6.63702083e+03  9.21169378e+03  2.55594753e+04  7.62903675e+04]
E1 = -727.9900160886392  E_coul = 201.28112055704548
cycle= 1 E= -526.708895531594  delta_E= -0.452  |g|= 0.183  |ddm|= 0.408
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.538346
diis-c [-0.28981645  1.        ]
  HOMO = -0.581147295814915  LUMO = 1.02440935948554
  mo_energy =
[-1.18627223e+02 -1.23311997e+01 -9.58507372e+00 -9.58507372e+00
 -9.58507372e+00 -1.25718241e+00 -5.81147296e-01 -5.81147296e-01
 -5.81147296e-01  1.02440936e+00  1.02440936e+00  1.02440936e+00
  7.40546065e+00  7.40546065e+00  7.40546065e+00  9.94995723e+00
  3.41612772e+01  3.41612772e+01  3.41612772e+01  1.16017840e+02
  1.31835286e+02  1.31835286e+02  1.31835286e+02  4.86852193e+02
  4.86852193e+02  4.86852193e+02  6.52546864e+02  1.33391892e+03
  1.33391892e+03  1.33391892e+03  2.79159925e+03  3.02105759e+03
  3.02105759e+03  3.02105759e+03  6.63649759e+03  6.63649759e+03
  6.63649759e+03  9.21109690e+03  2.55587847e+04  7.62895871e+04]
E1 = -728.4507796873347  E_coul = 201.7412976369716
cycle= 2 E= -526.709482050363  delta_E= -0.000587  |g|= 0.0333  |ddm|= 0.0386
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0666371
diis-c [-0.00265691  0.0730534   0.9269466 ]
  HOMO = -0.574474120696775  LUMO = 1.02949418539695
  mo_energy =
[-1.18568841e+02 -1.23005560e+01 -9.55313260e+00 -9.55313260e+00
 -9.55313260e+00 -1.24870875e+00 -5.74474121e-01 -5.74474121e-01
 -5.74474121e-01  1.02949419e+00  1.02949419e+00  1.02949419e+00
  7.42403103e+00  7.42403103e+00  7.42403103e+00  9.97441719e+00
  3.41941269e+01  3.41941269e+01  3.41941269e+01  1.16066503e+02
  1.31882732e+02  1.31882732e+02  1.31882732e+02  4.86909790e+02
  4.86909790e+02  4.86909790e+02  6.52607236e+02  1.33398031e+03
  1.33398031e+03  1.33398031e+03  2.79166374e+03  3.02112107e+03
  3.02112107e+03  3.02112107e+03  6.63656263e+03  6.63656263e+03
  6.63656263e+03  9.21116265e+03  2.55588510e+04  7.62896536e+04]
E1 = -728.3466146476586  E_coul = 201.63709835029616
cycle= 3 E= -526.709516297362  delta_E= -3.42e-05  |g|= 0.0048  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104239
diis-c [-4.26247748e-07 -1.10559636e-03  1.30715815e-01  8.70389781e-01]
  HOMO = -0.575389466032523  LUMO = 1.02880759210357
  mo_energy =
[-1.18576370e+02 -1.23045760e+01 -9.55742275e+00 -9.55742275e+00
 -9.55742275e+00 -1.24981997e+00 -5.75389466e-01 -5.75389466e-01
 -5.75389466e-01  1.02880759e+00  1.02880759e+00  1.02880759e+00
  7.42151264e+00  7.42151264e+00  7.42151264e+00  9.97129488e+00
  3.41897480e+01  3.41897480e+01  3.41897480e+01  1.16060233e+02
  1.31876561e+02  1.31876561e+02  1.31876561e+02  4.86902362e+02
  4.86902362e+02  4.86902362e+02  6.52599415e+02  1.33397236e+03
  1.33397236e+03  1.33397236e+03  2.79165522e+03  3.02111278e+03
  3.02111278e+03  3.02111278e+03  6.63655399e+03  6.63655399e+03
  6.63655399e+03  9.21115382e+03  2.55588420e+04  7.62896445e+04]
E1 = -728.3607194303902  E_coul = 201.65120230305112
cycle= 4 E= -526.709517127339  delta_E= -8.3e-07  |g|= 5.89e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122793
diis-c [-1.28361241e-09  6.40770259e-05 -9.01281685e-03 -7.07430081e-02
  1.07969175e+00]
  HOMO = -0.57537772597242  LUMO = 1.02881636463726
  mo_energy =
[-1.18576375e+02 -1.23045480e+01 -9.55740621e+00 -9.55740621e+00
 -9.55740621e+00 -1.24980134e+00 -5.75377726e-01 -5.75377726e-01
 -5.75377726e-01  1.02881636e+00  1.02881636e+00  1.02881636e+00
  7.42153257e+00  7.42153257e+00  7.42153257e+00  9.97132944e+00
  3.41897632e+01  3.41897632e+01  3.41897632e+01  1.16060242e+02
  1.31876568e+02  1.31876568e+02  1.31876568e+02  4.86902358e+02
  4.86902358e+02  4.86902358e+02  6.52599403e+02  1.33397235e+03
  1.33397235e+03  1.33397235e+03  2.79165519e+03  3.02111276e+03
  3.02111276e+03  3.02111276e+03  6.63655396e+03  6.63655396e+03
  6.63655396e+03  9.21115377e+03  2.55588419e+04  7.62896444e+04]
E1 = -728.3607190333367  E_coul = 201.65120190589232
cycle= 5 E= -526.709517127444  delta_E= -1.05e-10  |g|= 7.66e-06  |ddm|= 2.33e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3607190333367  E_coul = 201.65120190589232
  HOMO = -0.575381131672156  LUMO = 1.02881385254932
  mo_energy =
[-1.18576392e+02 -1.23045600e+01 -9.55741881e+00 -9.55741881e+00
 -9.55741881e+00 -1.24980553e+00 -5.75381132e-01 -5.75381132e-01
 -5.75381132e-01  1.02881385e+00  1.02881385e+00  1.02881385e+00
  7.42152422e+00  7.42152422e+00  7.42152422e+00  9.97131961e+00
  3.41897507e+01  3.41897507e+01  3.41897507e+01  1.16060227e+02
  1.31876553e+02  1.31876553e+02  1.31876553e+02  4.86902341e+02
  4.86902341e+02  4.86902341e+02  6.52599385e+02  1.33397233e+03
  1.33397233e+03  1.33397233e+03  2.79165517e+03  3.02111274e+03
  3.02111274e+03  3.02111274e+03  6.63655394e+03  6.63655394e+03
  6.63655394e+03  9.21115375e+03  2.55588419e+04  7.62896444e+04]
E1 = -728.3607566785021  E_coul = 201.65123955105335
Extra cycle  E= -526.709517127449  delta_E= -4.32e-12  |g|= 2.26e-06  |ddm|= 3.9e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 96629.54877812183
E1 = -728.3607566785021  E_coul = 201.65123955105335
init E= -526.709517127449
    CPU time for initialize scf      4.18 sec, wall time      0.22 sec
  HOMO = -0.57538044428613  LUMO = 1.0288143656234
  mo_energy =
[-1.18576388e+02 -1.23045572e+01 -9.55741595e+00 -9.55741595e+00
 -9.55741595e+00 -1.24980467e+00 -5.75380444e-01 -5.75380444e-01
 -5.75380444e-01  1.02881437e+00  1.02881437e+00  1.02881437e+00
  7.42152600e+00  7.42152600e+00  7.42152600e+00  9.97132184e+00
  3.41897536e+01  3.41897536e+01  3.41897536e+01  1.16060231e+02
  1.31876557e+02  1.31876557e+02  1.31876557e+02  4.86902345e+02
  4.86902345e+02  4.86902345e+02  6.52599390e+02  1.33397234e+03
  1.33397234e+03  1.33397234e+03  2.79165518e+03  3.02111274e+03
  3.02111274e+03  3.02111274e+03  6.63655394e+03  6.63655394e+03
  6.63655394e+03  9.21115376e+03  2.55588419e+04  7.62896444e+04]
E1 = -728.3607477515732  E_coul = 201.65123062412405
cycle= 1 E= -526.709517127449  delta_E= -3.41e-13  |g|= 5.79e-07  |ddm|= 8.89e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3607477515732  E_coul = 201.65123062412405
  HOMO = -0.575380595928686  LUMO = 1.02881425177411
  mo_energy =
[-1.18576389e+02 -1.23045579e+01 -9.55741663e+00 -9.55741663e+00
 -9.55741663e+00 -1.24980486e+00 -5.75380596e-01 -5.75380596e-01
 -5.75380596e-01  1.02881425e+00  1.02881425e+00  1.02881425e+00
  7.42152559e+00  7.42152559e+00  7.42152559e+00  9.97132133e+00
  3.41897529e+01  3.41897529e+01  3.41897529e+01  1.16060230e+02
  1.31876556e+02  1.31876556e+02  1.31876556e+02  4.86902344e+02
  4.86902344e+02  4.86902344e+02  6.52599389e+02  1.33397234e+03
  1.33397234e+03  1.33397234e+03  2.79165518e+03  3.02111274e+03
  3.02111274e+03  3.02111274e+03  6.63655394e+03  6.63655394e+03
  6.63655394e+03  9.21115376e+03  2.55588419e+04  7.62896444e+04]
E1 = -728.3607499221536  E_coul = 201.65123279470538
Extra cycle  E= -526.709517127448  delta_E= 9.09e-13  |g|= 1.45e-07  |ddm|= 2.08e-07
    CPU time for scf_cycle      4.30 sec, wall time      0.34 sec
exp = [2.61828322e+04 7.61710849e+03 3.61750850e+03 1.58858766e+03
 4.15100529e+02 1.21030494e+02 3.88463634e+01 8.05931001e+00
 3.16045134e+00 3.98506577e-01 1.36284143e+03 6.64178263e+02
 2.98288584e+02 3.11737943e+02 6.28628414e+01 7.46916483e+00
 2.06602391e+01 7.78737479e-01 2.85845559e+00 2.24282153e-01]
grad_E = [-1.40589647e-06  2.23130504e-06 -2.12720874e-06  3.88698494e-05
  1.15450541e-05 -5.89798592e-06  1.08244710e-05  1.31742555e-05
 -3.57022649e-06 -2.83179848e-04 -5.83615842e-07  4.11715871e-06
  1.88597315e-05  1.61105643e-05  6.61879880e-05 -1.98533840e-04
  7.94235963e-05 -6.27110719e-05  1.96224255e-04  7.27082978e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:01:38 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8325573        1
[INPUT] 0    0    [1    /1   ]  7617.10793092        1
[INPUT] 0    0    [1    /1   ]  3617.50891877        1
[INPUT] 0    0    [1    /1   ]  1588.57688818        1
[INPUT] 0    0    [1    /1   ]  415.116512735        1
[INPUT] 0    0    [1    /1   ]  121.025525082        1
[INPUT] 0    0    [1    /1   ]  38.8456831622        1
[INPUT] 0    0    [1    /1   ]  8.06172606455        1
[INPUT] 0    0    [1    /1   ]  3.16110974638        1
[INPUT] 0    0    [1    /1   ]  0.398487591162       1
[INPUT] 1    0    [1    /1   ]  1362.84155646        1
[INPUT] 1    0    [1    /1   ]  664.177318551        1
[INPUT] 1    0    [1    /1   ]  298.284219836        1
[INPUT] 1    0    [1    /1   ]  311.734205191        1
[INPUT] 1    0    [1    /1   ]  62.8533461039        1
[INPUT] 1    0    [1    /1   ]  7.46447525831        1
[INPUT] 1    0    [1    /1   ]  20.653378008         1
[INPUT] 1    0    [1    /1   ]  0.77864394709        1
[INPUT] 1    0    [1    /1   ]  2.85696839455        1
[INPUT] 1    0    [1    /1   ]  0.224292257666       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.832557276837, 1.0]], [0, [7617.107930923903, 1.0]], [0, [3617.5089187677268, 1.0]], [0, [1588.5768881825927, 1.0]], [0, [415.1165127350163, 1.0]], [0, [121.02552508193243, 1.0]], [0, [38.8456831622047, 1.0]], [0, [8.061726064551566, 1.0]], [0, [3.1611097463820417, 1.0]], [0, [0.3984875911622329, 1.0]], [1, [1362.841556463225, 1.0]], [1, [664.1773185506917, 1.0]], [1, [298.2842198363975, 1.0]], [1, [311.73420519087307, 1.0]], [1, [62.853346103907285, 1.0]], [1, [7.464475258308465, 1.0]], [1, [20.653378008018922, 1.0]], [1, [0.7786439470903544, 1.0]], [1, [2.8569683945533737, 1.0]], [1, [0.22429225766552083, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.83255728]
bas 1, expnt(s) = [7617.10793092]
bas 2, expnt(s) = [3617.50891877]
bas 3, expnt(s) = [1588.57688818]
bas 4, expnt(s) = [415.11651274]
bas 5, expnt(s) = [121.02552508]
bas 6, expnt(s) = [38.84568316]
bas 7, expnt(s) = [8.06172606]
bas 8, expnt(s) = [3.16110975]
bas 9, expnt(s) = [0.39848759]
bas 10, expnt(s) = [1362.84155646]
bas 11, expnt(s) = [664.17731855]
bas 12, expnt(s) = [298.28421984]
bas 13, expnt(s) = [311.73420519]
bas 14, expnt(s) = [62.8533461]
bas 15, expnt(s) = [7.46447526]
bas 16, expnt(s) = [20.65337801]
bas 17, expnt(s) = [0.77864395]
bas 18, expnt(s) = [2.85696839]
bas 19, expnt(s) = [0.22429226]
CPU time:      1689.12
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828326e+04 5.20028919e+03 7.61710793e+03 2.05995440e+03
 3.61750892e+03 1.17848004e+03 1.58857689e+03 6.35727801e+02
 4.15116513e+02 2.32349922e+02 1.21025525e+02 9.21876525e+01
 3.88456832e+01 3.93117246e+01 8.06172606e+00 1.20874879e+01
 3.16110975e+00 5.98955703e+00 3.98487591e-01 1.26714445e+00
 1.36284156e+03 2.41568945e+04 6.64177319e+02 9.83647388e+03
 2.98284220e+02 3.61636486e+03 3.11734205e+02 3.82133371e+03
 6.28533461e+01 5.16291406e+02 7.46447526e+00 3.59942804e+01
 2.06533780e+01 1.28446791e+02 7.78643947e-01 2.13382123e+00
 2.85696839e+00 1.08359299e+01 2.24292258e-01 4.50300310e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982732867225543
cond(S) = 96594.94482535165
E1 = -729.3778956325348  E_coul = 203.12114747353343
init E= -526.256748159001
    CPU time for initialize scf      0.64 sec, wall time      0.05 sec
  HOMO = -0.556931551450202  LUMO = 1.04038521220557
  mo_energy =
[-1.18335084e+02 -1.22078380e+01 -9.45168443e+00 -9.45168443e+00
 -9.45168443e+00 -1.22606818e+00 -5.56931551e-01 -5.56931551e-01
 -5.56931551e-01  1.04038521e+00  1.04038521e+00  1.04038521e+00
  7.47767248e+00  7.47767248e+00  7.47767248e+00  1.00450804e+01
  3.42803340e+01  3.42803340e+01  3.42803340e+01  1.16240394e+02
  1.31999944e+02  1.31999944e+02  1.31999944e+02  4.87071708e+02
  4.87071708e+02  4.87071708e+02  6.52890950e+02  1.33418269e+03
  1.33418269e+03  1.33418269e+03  2.79210417e+03  3.02137705e+03
  3.02137705e+03  3.02137705e+03  6.63692627e+03  6.63692627e+03
  6.63692627e+03  9.21171603e+03  2.55594881e+04  7.62903748e+04]
E1 = -727.9903154126754  E_coul = 201.28141905311278
cycle= 1 E= -526.708896359563  delta_E= -0.452  |g|= 0.183  |ddm|= 0.408
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538332
diis-c [-0.28980162  1.        ]
  HOMO = -0.581140484781327  LUMO = 1.02437402042123
  mo_energy =
[-1.18627203e+02 -1.23311752e+01 -9.58505047e+00 -9.58505047e+00
 -9.58505047e+00 -1.25716838e+00 -5.81140485e-01 -5.81140485e-01
 -5.81140485e-01  1.02437402e+00  1.02437402e+00  1.02437402e+00
  7.40131158e+00  7.40131158e+00  7.40131158e+00  9.95426310e+00
  3.41400810e+01  3.41400810e+01  3.41400810e+01  1.16027011e+02
  1.31786132e+02  1.31786132e+02  1.31786132e+02  4.86781474e+02
  4.86781474e+02  4.86781474e+02  6.52554378e+02  1.33383709e+03
  1.33383709e+03  1.33383709e+03  2.79162386e+03  3.02096588e+03
  3.02096588e+03  3.02096588e+03  6.63640306e+03  6.63640306e+03
  6.63640306e+03  9.21111918e+03  2.55587976e+04  7.62895945e+04]
E1 = -728.4509835072247  E_coul = 201.74150075670806
cycle= 2 E= -526.709482750517  delta_E= -0.000586  |g|= 0.0333  |ddm|= 0.0385
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0666267
diis-c [-0.00265633  0.07303995  0.92696005]
  HOMO = -0.574469178126735  LUMO = 1.02945667930605
  mo_energy =
[-1.18568829e+02 -1.23005376e+01 -9.55311570e+00 -9.55311570e+00
 -9.55311570e+00 -1.24869712e+00 -5.74469178e-01 -5.74469178e-01
 -5.74469178e-01  1.02945668e+00  1.02945668e+00  1.02945668e+00
  7.41987040e+00  7.41987040e+00  7.41987040e+00  9.97872251e+00
  3.41729184e+01  3.41729184e+01  3.41729184e+01  1.16075666e+02
  1.31833569e+02  1.31833569e+02  1.31833569e+02  4.86839064e+02
  4.86839064e+02  4.86839064e+02  6.52614741e+02  1.33389848e+03
  1.33389848e+03  1.33389848e+03  2.79168834e+03  3.02102935e+03
  3.02102935e+03  3.02102935e+03  6.63646810e+03  6.63646810e+03
  6.63646810e+03  9.21118492e+03  2.55588638e+04  7.62896610e+04]
E1 = -728.3468444249868  E_coul = 201.63732744212726
cycle= 3 E= -526.70951698286  delta_E= -3.42e-05  |g|= 0.0048  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104223
diis-c [-4.26378193e-07 -1.10562078e-03  1.30716026e-01  8.70389595e-01]
  HOMO = -0.575384325651669  LUMO = 1.02877034199672
  mo_energy =
[-1.18576357e+02 -1.23045569e+01 -9.55740513e+00 -9.55740513e+00
 -9.55740513e+00 -1.24980808e+00 -5.75384326e-01 -5.75384326e-01
 -5.75384326e-01  1.02877034e+00  1.02877034e+00  1.02877034e+00
  7.41735347e+00  7.41735347e+00  7.41735347e+00  9.97560025e+00
  3.41685410e+01  3.41685410e+01  3.41685410e+01  1.16069397e+02
  1.31827399e+02  1.31827399e+02  1.31827399e+02  4.86831636e+02
  4.86831636e+02  4.86831636e+02  6.52606922e+02  1.33389053e+03
  1.33389053e+03  1.33389053e+03  2.79167982e+03  3.02102106e+03
  3.02102106e+03  3.02102106e+03  6.63645945e+03  6.63645945e+03
  6.63645945e+03  9.21117609e+03  2.55588548e+04  7.62896519e+04]
E1 = -728.3609463098652  E_coul = 201.65142849734048
cycle= 4 E= -526.709517812525  delta_E= -8.3e-07  |g|= 5.89e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122763
diis-c [-1.28507493e-09  6.40816648e-05 -9.01285803e-03 -7.07403465e-02
  1.07968912e+00]
  HOMO = -0.575372574259709  LUMO = 1.02877912194596
  mo_energy =
[-1.18576362e+02 -1.23045288e+01 -9.55738856e+00 -9.55738856e+00
 -9.55738856e+00 -1.24978944e+00 -5.75372574e-01 -5.75372574e-01
 -5.75372574e-01  1.02877912e+00  1.02877912e+00  1.02877912e+00
  7.41737343e+00  7.41737343e+00  7.41737343e+00  9.97563484e+00
  3.41685562e+01  3.41685562e+01  3.41685562e+01  1.16069406e+02
  1.31827406e+02  1.31827406e+02  1.31827406e+02  4.86831632e+02
  4.86831632e+02  4.86831632e+02  6.52606909e+02  1.33389052e+03
  1.33389052e+03  1.33389052e+03  2.79167979e+03  3.02102104e+03
  3.02102104e+03  3.02102104e+03  6.63645942e+03  6.63645942e+03
  6.63645942e+03  9.21117605e+03  2.55588548e+04  7.62896518e+04]
E1 = -728.3609458201432  E_coul = 201.65142800751264
cycle= 5 E= -526.709517812631  delta_E= -1.06e-10  |g|= 7.67e-06  |ddm|= 2.33e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3609458201432  E_coul = 201.65142800751264
  HOMO = -0.575375981119563  LUMO = 1.02877660938522
  mo_energy =
[-1.18576379e+02 -1.23045408e+01 -9.55740116e+00 -9.55740116e+00
 -9.55740116e+00 -1.24979363e+00 -5.75375981e-01 -5.75375981e-01
 -5.75375981e-01  1.02877661e+00  1.02877661e+00  1.02877661e+00
  7.41736508e+00  7.41736508e+00  7.41736508e+00  9.97562500e+00
  3.41685438e+01  3.41685438e+01  3.41685438e+01  1.16069391e+02
  1.31827391e+02  1.31827391e+02  1.31827391e+02  4.86831615e+02
  4.86831615e+02  4.86831615e+02  6.52606892e+02  1.33389050e+03
  1.33389050e+03  1.33389050e+03  2.79167977e+03  3.02102102e+03
  3.02102102e+03  3.02102102e+03  6.63645940e+03  6.63645940e+03
  6.63645940e+03  9.21117603e+03  2.55588548e+04  7.62896518e+04]
E1 = -728.360983474975  E_coul = 201.65146566234156
Extra cycle  E= -526.709517812633  delta_E= -2.84e-12  |g|= 2.26e-06  |ddm|= 3.9e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.23 sec
exp = [2.61828326e+04 7.61710793e+03 3.61750892e+03 1.58857689e+03
 4.15116513e+02 1.21025525e+02 3.88456832e+01 8.06172606e+00
 3.16110975e+00 3.98487591e-01 1.36284156e+03 6.64177319e+02
 2.98284220e+02 3.11734205e+02 6.28533461e+01 7.46447526e+00
 2.06533780e+01 7.78643947e-01 2.85696839e+00 2.24292258e-01]
E = -526.7095178126334
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:01:38 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8325573        1
[INPUT] 0    0    [1    /1   ]  7617.10793092        1
[INPUT] 0    0    [1    /1   ]  3617.50891877        1
[INPUT] 0    0    [1    /1   ]  1588.57688818        1
[INPUT] 0    0    [1    /1   ]  415.116512735        1
[INPUT] 0    0    [1    /1   ]  121.025525082        1
[INPUT] 0    0    [1    /1   ]  38.8456831622        1
[INPUT] 0    0    [1    /1   ]  8.06172606455        1
[INPUT] 0    0    [1    /1   ]  3.16110974638        1
[INPUT] 0    0    [1    /1   ]  0.398487591162       1
[INPUT] 1    0    [1    /1   ]  1362.84155646        1
[INPUT] 1    0    [1    /1   ]  664.177318551        1
[INPUT] 1    0    [1    /1   ]  298.284219836        1
[INPUT] 1    0    [1    /1   ]  311.734205191        1
[INPUT] 1    0    [1    /1   ]  62.8533461039        1
[INPUT] 1    0    [1    /1   ]  7.46447525831        1
[INPUT] 1    0    [1    /1   ]  20.653378008         1
[INPUT] 1    0    [1    /1   ]  0.77864394709        1
[INPUT] 1    0    [1    /1   ]  2.85696839455        1
[INPUT] 1    0    [1    /1   ]  0.224292257666       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.832557276837, 1.0]], [0, [7617.107930923903, 1.0]], [0, [3617.5089187677268, 1.0]], [0, [1588.5768881825927, 1.0]], [0, [415.1165127350163, 1.0]], [0, [121.02552508193243, 1.0]], [0, [38.8456831622047, 1.0]], [0, [8.061726064551566, 1.0]], [0, [3.1611097463820417, 1.0]], [0, [0.3984875911622329, 1.0]], [1, [1362.841556463225, 1.0]], [1, [664.1773185506917, 1.0]], [1, [298.2842198363975, 1.0]], [1, [311.73420519087307, 1.0]], [1, [62.853346103907285, 1.0]], [1, [7.464475258308465, 1.0]], [1, [20.653378008018922, 1.0]], [1, [0.7786439470903544, 1.0]], [1, [2.8569683945533737, 1.0]], [1, [0.22429225766552083, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.83255728]
bas 1, expnt(s) = [7617.10793092]
bas 2, expnt(s) = [3617.50891877]
bas 3, expnt(s) = [1588.57688818]
bas 4, expnt(s) = [415.11651274]
bas 5, expnt(s) = [121.02552508]
bas 6, expnt(s) = [38.84568316]
bas 7, expnt(s) = [8.06172606]
bas 8, expnt(s) = [3.16110975]
bas 9, expnt(s) = [0.39848759]
bas 10, expnt(s) = [1362.84155646]
bas 11, expnt(s) = [664.17731855]
bas 12, expnt(s) = [298.28421984]
bas 13, expnt(s) = [311.73420519]
bas 14, expnt(s) = [62.8533461]
bas 15, expnt(s) = [7.46447526]
bas 16, expnt(s) = [20.65337801]
bas 17, expnt(s) = [0.77864395]
bas 18, expnt(s) = [2.85696839]
bas 19, expnt(s) = [0.22429226]
CPU time:      1690.22
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828326e+04 5.20028919e+03 7.61710793e+03 2.05995440e+03
 3.61750892e+03 1.17848004e+03 1.58857689e+03 6.35727801e+02
 4.15116513e+02 2.32349922e+02 1.21025525e+02 9.21876525e+01
 3.88456832e+01 3.93117246e+01 8.06172606e+00 1.20874879e+01
 3.16110975e+00 5.98955703e+00 3.98487591e-01 1.26714445e+00
 1.36284156e+03 2.41568945e+04 6.64177319e+02 9.83647388e+03
 2.98284220e+02 3.61636486e+03 3.11734205e+02 3.82133371e+03
 6.28533461e+01 5.16291406e+02 7.46447526e+00 3.59942804e+01
 2.06533780e+01 1.28446791e+02 7.78643947e-01 2.13382123e+00
 2.85696839e+00 1.08359299e+01 2.24292258e-01 4.50300310e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982732867225543
cond(S) = 96594.94482535165
E1 = -729.3778956325348  E_coul = 203.12114747353343
init E= -526.256748159001
    CPU time for initialize scf      0.64 sec, wall time      0.05 sec
  HOMO = -0.556931551450202  LUMO = 1.04038521220557
  mo_energy =
[-1.18335084e+02 -1.22078380e+01 -9.45168443e+00 -9.45168443e+00
 -9.45168443e+00 -1.22606818e+00 -5.56931551e-01 -5.56931551e-01
 -5.56931551e-01  1.04038521e+00  1.04038521e+00  1.04038521e+00
  7.47767248e+00  7.47767248e+00  7.47767248e+00  1.00450804e+01
  3.42803340e+01  3.42803340e+01  3.42803340e+01  1.16240394e+02
  1.31999944e+02  1.31999944e+02  1.31999944e+02  4.87071708e+02
  4.87071708e+02  4.87071708e+02  6.52890950e+02  1.33418269e+03
  1.33418269e+03  1.33418269e+03  2.79210417e+03  3.02137705e+03
  3.02137705e+03  3.02137705e+03  6.63692627e+03  6.63692627e+03
  6.63692627e+03  9.21171603e+03  2.55594881e+04  7.62903748e+04]
E1 = -727.9903154126754  E_coul = 201.28141905311278
cycle= 1 E= -526.708896359563  delta_E= -0.452  |g|= 0.183  |ddm|= 0.408
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538332
diis-c [-0.28980162  1.        ]
  HOMO = -0.581140484781327  LUMO = 1.02437402042123
  mo_energy =
[-1.18627203e+02 -1.23311752e+01 -9.58505047e+00 -9.58505047e+00
 -9.58505047e+00 -1.25716838e+00 -5.81140485e-01 -5.81140485e-01
 -5.81140485e-01  1.02437402e+00  1.02437402e+00  1.02437402e+00
  7.40131158e+00  7.40131158e+00  7.40131158e+00  9.95426310e+00
  3.41400810e+01  3.41400810e+01  3.41400810e+01  1.16027011e+02
  1.31786132e+02  1.31786132e+02  1.31786132e+02  4.86781474e+02
  4.86781474e+02  4.86781474e+02  6.52554378e+02  1.33383709e+03
  1.33383709e+03  1.33383709e+03  2.79162386e+03  3.02096588e+03
  3.02096588e+03  3.02096588e+03  6.63640306e+03  6.63640306e+03
  6.63640306e+03  9.21111918e+03  2.55587976e+04  7.62895945e+04]
E1 = -728.4509835072247  E_coul = 201.74150075670806
cycle= 2 E= -526.709482750517  delta_E= -0.000586  |g|= 0.0333  |ddm|= 0.0385
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0666267
diis-c [-0.00265633  0.07303995  0.92696005]
  HOMO = -0.574469178126735  LUMO = 1.02945667930605
  mo_energy =
[-1.18568829e+02 -1.23005376e+01 -9.55311570e+00 -9.55311570e+00
 -9.55311570e+00 -1.24869712e+00 -5.74469178e-01 -5.74469178e-01
 -5.74469178e-01  1.02945668e+00  1.02945668e+00  1.02945668e+00
  7.41987040e+00  7.41987040e+00  7.41987040e+00  9.97872251e+00
  3.41729184e+01  3.41729184e+01  3.41729184e+01  1.16075666e+02
  1.31833569e+02  1.31833569e+02  1.31833569e+02  4.86839064e+02
  4.86839064e+02  4.86839064e+02  6.52614741e+02  1.33389848e+03
  1.33389848e+03  1.33389848e+03  2.79168834e+03  3.02102935e+03
  3.02102935e+03  3.02102935e+03  6.63646810e+03  6.63646810e+03
  6.63646810e+03  9.21118492e+03  2.55588638e+04  7.62896610e+04]
E1 = -728.3468444249868  E_coul = 201.63732744212726
cycle= 3 E= -526.70951698286  delta_E= -3.42e-05  |g|= 0.0048  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104223
diis-c [-4.26378193e-07 -1.10562078e-03  1.30716026e-01  8.70389595e-01]
  HOMO = -0.575384325651669  LUMO = 1.02877034199672
  mo_energy =
[-1.18576357e+02 -1.23045569e+01 -9.55740513e+00 -9.55740513e+00
 -9.55740513e+00 -1.24980808e+00 -5.75384326e-01 -5.75384326e-01
 -5.75384326e-01  1.02877034e+00  1.02877034e+00  1.02877034e+00
  7.41735347e+00  7.41735347e+00  7.41735347e+00  9.97560025e+00
  3.41685410e+01  3.41685410e+01  3.41685410e+01  1.16069397e+02
  1.31827399e+02  1.31827399e+02  1.31827399e+02  4.86831636e+02
  4.86831636e+02  4.86831636e+02  6.52606922e+02  1.33389053e+03
  1.33389053e+03  1.33389053e+03  2.79167982e+03  3.02102106e+03
  3.02102106e+03  3.02102106e+03  6.63645945e+03  6.63645945e+03
  6.63645945e+03  9.21117609e+03  2.55588548e+04  7.62896519e+04]
E1 = -728.3609463098652  E_coul = 201.65142849734048
cycle= 4 E= -526.709517812525  delta_E= -8.3e-07  |g|= 5.89e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122763
diis-c [-1.28507493e-09  6.40816648e-05 -9.01285803e-03 -7.07403465e-02
  1.07968912e+00]
  HOMO = -0.575372574259709  LUMO = 1.02877912194596
  mo_energy =
[-1.18576362e+02 -1.23045288e+01 -9.55738856e+00 -9.55738856e+00
 -9.55738856e+00 -1.24978944e+00 -5.75372574e-01 -5.75372574e-01
 -5.75372574e-01  1.02877912e+00  1.02877912e+00  1.02877912e+00
  7.41737343e+00  7.41737343e+00  7.41737343e+00  9.97563484e+00
  3.41685562e+01  3.41685562e+01  3.41685562e+01  1.16069406e+02
  1.31827406e+02  1.31827406e+02  1.31827406e+02  4.86831632e+02
  4.86831632e+02  4.86831632e+02  6.52606909e+02  1.33389052e+03
  1.33389052e+03  1.33389052e+03  2.79167979e+03  3.02102104e+03
  3.02102104e+03  3.02102104e+03  6.63645942e+03  6.63645942e+03
  6.63645942e+03  9.21117605e+03  2.55588548e+04  7.62896518e+04]
E1 = -728.3609458201432  E_coul = 201.65142800751264
cycle= 5 E= -526.709517812631  delta_E= -1.06e-10  |g|= 7.67e-06  |ddm|= 2.33e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3609458201432  E_coul = 201.65142800751264
  HOMO = -0.575375981119563  LUMO = 1.02877660938522
  mo_energy =
[-1.18576379e+02 -1.23045408e+01 -9.55740116e+00 -9.55740116e+00
 -9.55740116e+00 -1.24979363e+00 -5.75375981e-01 -5.75375981e-01
 -5.75375981e-01  1.02877661e+00  1.02877661e+00  1.02877661e+00
  7.41736508e+00  7.41736508e+00  7.41736508e+00  9.97562500e+00
  3.41685438e+01  3.41685438e+01  3.41685438e+01  1.16069391e+02
  1.31827391e+02  1.31827391e+02  1.31827391e+02  4.86831615e+02
  4.86831615e+02  4.86831615e+02  6.52606892e+02  1.33389050e+03
  1.33389050e+03  1.33389050e+03  2.79167977e+03  3.02102102e+03
  3.02102102e+03  3.02102102e+03  6.63645940e+03  6.63645940e+03
  6.63645940e+03  9.21117603e+03  2.55588548e+04  7.62896518e+04]
E1 = -728.360983474975  E_coul = 201.65146566234156
Extra cycle  E= -526.709517812633  delta_E= -2.84e-12  |g|= 2.26e-06  |ddm|= 3.9e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 96594.94482535165
E1 = -728.360983474975  E_coul = 201.65146566234156
init E= -526.709517812633
    CPU time for initialize scf      3.82 sec, wall time      0.21 sec
  HOMO = -0.57537529357598  LUMO = 1.02877712249848
  mo_energy =
[-1.18576374e+02 -1.23045381e+01 -9.55739830e+00 -9.55739830e+00
 -9.55739830e+00 -1.24979277e+00 -5.75375294e-01 -5.75375294e-01
 -5.75375294e-01  1.02877712e+00  1.02877712e+00  1.02877712e+00
  7.41736686e+00  7.41736686e+00  7.41736686e+00  9.97562723e+00
  3.41685466e+01  3.41685466e+01  3.41685466e+01  1.16069395e+02
  1.31827395e+02  1.31827395e+02  1.31827395e+02  4.86831619e+02
  4.86831619e+02  4.86831619e+02  6.52606896e+02  1.33389051e+03
  1.33389051e+03  1.33389051e+03  2.79167977e+03  3.02102102e+03
  3.02102102e+03  3.02102102e+03  6.63645941e+03  6.63645941e+03
  6.63645941e+03  9.21117603e+03  2.55588548e+04  7.62896518e+04]
E1 = -728.3609745462744  E_coul = 201.65145673364125
cycle= 1 E= -526.709517812633  delta_E= 2.27e-13  |g|= 5.79e-07  |ddm|= 8.89e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3609745462744  E_coul = 201.65145673364125
  HOMO = -0.575375445243114  LUMO = 1.02877700864835
  mo_energy =
[-1.18576376e+02 -1.23045387e+01 -9.55739898e+00 -9.55739898e+00
 -9.55739898e+00 -1.24979296e+00 -5.75375445e-01 -5.75375445e-01
 -5.75375445e-01  1.02877701e+00  1.02877701e+00  1.02877701e+00
  7.41736645e+00  7.41736645e+00  7.41736645e+00  9.97562672e+00
  3.41685459e+01  3.41685459e+01  3.41685459e+01  1.16069394e+02
  1.31827394e+02  1.31827394e+02  1.31827394e+02  4.86831618e+02
  4.86831618e+02  4.86831618e+02  6.52606895e+02  1.33389050e+03
  1.33389050e+03  1.33389050e+03  2.79167977e+03  3.02102102e+03
  3.02102102e+03  3.02102102e+03  6.63645940e+03  6.63645940e+03
  6.63645940e+03  9.21117603e+03  2.55588548e+04  7.62896518e+04]
E1 = -728.3609767171649  E_coul = 201.65145890453167
Extra cycle  E= -526.709517812633  delta_E= -1.14e-13  |g|= 1.45e-07  |ddm|= 2.08e-07
    CPU time for scf_cycle      3.93 sec, wall time      0.32 sec
exp = [2.61828326e+04 7.61710793e+03 3.61750892e+03 1.58857689e+03
 4.15116513e+02 1.21025525e+02 3.88456832e+01 8.06172606e+00
 3.16110975e+00 3.98487591e-01 1.36284156e+03 6.64177319e+02
 2.98284220e+02 3.11734205e+02 6.28533461e+01 7.46447526e+00
 2.06533780e+01 7.78643947e-01 2.85696839e+00 2.24292258e-01]
grad_E = [-1.40568435e-06  2.22952350e-06 -2.12701762e-06  3.88080543e-05
  1.27111066e-05 -1.14672183e-05  1.77690003e-05  2.26176661e-05
  2.84589653e-06 -4.89973018e-04 -5.83257702e-07  4.12315832e-06
  1.88945235e-05  1.61402205e-05  6.35315469e-05 -3.41081640e-04
  1.17569871e-04 -1.16455480e-04  3.24456593e-04  1.28222665e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:01:43 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8333406        1
[INPUT] 0    0    [1    /1   ]  7617.10656046        1
[INPUT] 0    0    [1    /1   ]  3617.51000081        1
[INPUT] 0    0    [1    /1   ]  1588.55102928        1
[INPUT] 0    0    [1    /1   ]  415.146571502        1
[INPUT] 0    0    [1    /1   ]  121.019254946        1
[INPUT] 0    0    [1    /1   ]  38.8450971059        1
[INPUT] 0    0    [1    /1   ]  8.06552202794        1
[INPUT] 0    0    [1    /1   ]  3.16208025097        1
[INPUT] 0    0    [1    /1   ]  0.398456093708       1
[INPUT] 1    0    [1    /1   ]  1362.8418673         1
[INPUT] 1    0    [1    /1   ]  664.174975348        1
[INPUT] 1    0    [1    /1   ]  298.273412921        1
[INPUT] 1    0    [1    /1   ]  311.724954379        1
[INPUT] 1    0    [1    /1   ]  62.8259841771        1
[INPUT] 1    0    [1    /1   ]  7.45577642866        1
[INPUT] 1    0    [1    /1   ]  20.6384780868        1
[INPUT] 1    0    [1    /1   ]  0.778453023514       1
[INPUT] 1    0    [1    /1   ]  2.85421671143        1
[INPUT] 1    0    [1    /1   ]  0.224302189997       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.83334063504, 1.0]], [0, [7617.106560457919, 1.0]], [0, [3617.5100008075424, 1.0]], [0, [1588.5510292772567, 1.0]], [0, [415.1465715016322, 1.0]], [0, [121.01925494641435, 1.0]], [0, [38.84509710590147, 1.0]], [0, [8.065522027939313, 1.0]], [0, [3.1620802509658352, 1.0]], [0, [0.398456093707836, 1.0]], [1, [1362.8418673009112, 1.0]], [1, [664.1749753479132, 1.0]], [1, [298.27341292080297, 1.0]], [1, [311.7249543793843, 1.0]], [1, [62.82598417706878, 1.0]], [1, [7.455776428656456, 1.0]], [1, [20.638478086792265, 1.0]], [1, [0.7784530235136222, 1.0]], [1, [2.8542167114278856, 1.0]], [1, [0.22430218999734283, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.83334064]
bas 1, expnt(s) = [7617.10656046]
bas 2, expnt(s) = [3617.51000081]
bas 3, expnt(s) = [1588.55102928]
bas 4, expnt(s) = [415.1465715]
bas 5, expnt(s) = [121.01925495]
bas 6, expnt(s) = [38.84509711]
bas 7, expnt(s) = [8.06552203]
bas 8, expnt(s) = [3.16208025]
bas 9, expnt(s) = [0.39845609]
bas 10, expnt(s) = [1362.8418673]
bas 11, expnt(s) = [664.17497535]
bas 12, expnt(s) = [298.27341292]
bas 13, expnt(s) = [311.72495438]
bas 14, expnt(s) = [62.82598418]
bas 15, expnt(s) = [7.45577643]
bas 16, expnt(s) = [20.63847809]
bas 17, expnt(s) = [0.77845302]
bas 18, expnt(s) = [2.85421671]
bas 19, expnt(s) = [0.22430219]
CPU time:      1699.81
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828333e+04 5.20028931e+03 7.61710656e+03 2.05995412e+03
 3.61751000e+03 1.17848031e+03 1.58855103e+03 6.35720040e+02
 4.15146572e+02 2.32362540e+02 1.21019255e+02 9.21840704e+01
 3.88450971e+01 3.93112798e+01 8.06552203e+00 1.20917563e+01
 3.16208025e+00 5.99093614e+00 3.98456094e-01 1.26706933e+00
 1.36284187e+03 2.41569014e+04 6.64174975e+02 9.83643050e+03
 2.98273413e+02 3.61620108e+03 3.11724954e+02 3.82119196e+03
 6.28259842e+01 5.16010475e+02 7.45577643e+00 3.59418550e+01
 2.06384781e+01 1.28330970e+02 7.78453024e-01 2.13316724e+00
 2.85421671e+00 1.08228857e+01 2.24302190e-01 4.50325236e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98273799240721
cond(S) = 96508.84944889441
E1 = -729.3775412799823  E_coul = 203.1208862814886
init E= -526.256654998494
    CPU time for initialize scf      0.63 sec, wall time      0.05 sec
  HOMO = -0.556942204070587  LUMO = 1.04024665743358
  mo_energy =
[-1.18335109e+02 -1.22078537e+01 -9.45170174e+00 -9.45170174e+00
 -9.45170174e+00 -1.22607418e+00 -5.56942204e-01 -5.56942204e-01
 -5.56942204e-01  1.04024666e+00  1.04024666e+00  1.04024666e+00
  7.46977300e+00  7.46977300e+00  7.46977300e+00  1.00516492e+01
  3.42394224e+01  3.42394224e+01  3.42394224e+01  1.16256074e+02
  1.31893545e+02  1.31893545e+02  1.31893545e+02  4.86904138e+02
  4.86904138e+02  4.86904138e+02  6.52911299e+02  1.33398374e+03
  1.33398374e+03  1.33398374e+03  2.79215711e+03  3.02115221e+03
  3.02115221e+03  3.02115221e+03  6.63669379e+03  6.63669379e+03
  6.63669379e+03  9.21175665e+03  2.55595044e+04  7.62903782e+04]
E1 = -727.9907429751688  E_coul = 201.28184465502872
cycle= 1 E= -526.70889832014  delta_E= -0.452  |g|= 0.183  |ddm|= 0.408
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.538311
diis-c [-0.28977917  1.        ]
  HOMO = -0.581130959746486  LUMO = 1.02425650390097
  mo_energy =
[-1.18627177e+02 -1.23311408e+01 -9.58501725e+00 -9.58501725e+00
 -9.58501725e+00 -1.25714546e+00 -5.81130960e-01 -5.81130960e-01
 -5.81130960e-01  1.02425650e+00  1.02425650e+00  1.02425650e+00
  7.39351853e+00  7.39351853e+00  7.39351853e+00  9.96086133e+00
  3.40992753e+01  3.40992753e+01  3.40992753e+01  1.16042737e+02
  1.31679808e+02  1.31679808e+02  1.31679808e+02  4.86613952e+02
  4.86613952e+02  4.86613952e+02  6.52574778e+02  1.33363819e+03
  1.33363819e+03  1.33363819e+03  2.79167684e+03  3.02074108e+03
  3.02074108e+03  3.02074108e+03  6.63617064e+03  6.63617064e+03
  6.63617064e+03  9.21115985e+03  2.55588140e+04  7.62895980e+04]
E1 = -728.4512785412791  E_coul = 201.7417939902961
cycle= 2 E= -526.709484550983  delta_E= -0.000586  |g|= 0.0333  |ddm|= 0.0385
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0666121
diis-c [-0.00265551  0.07302113  0.92697887]
  HOMO = -0.574462301772626  LUMO = 1.02933556172696
  mo_energy =
[-1.18568813e+02 -1.23005115e+01 -9.55309136e+00 -9.55309136e+00
 -9.55309136e+00 -1.24867764e+00 -5.74462302e-01 -5.74462302e-01
 -5.74462302e-01  1.02933556e+00  1.02933556e+00  1.02933556e+00
  7.41205778e+00  7.41205778e+00  7.41205778e+00  9.98532076e+00
  3.41320917e+01  3.41320917e+01  3.41320917e+01  1.16091381e+02
  1.31727231e+02  1.31727231e+02  1.31727231e+02  4.86671532e+02
  4.86671532e+02  4.86671532e+02  6.52635131e+02  1.33369956e+03
  1.33369956e+03  1.33369956e+03  2.79174131e+03  3.02080454e+03
  3.02080454e+03  3.02080454e+03  6.63623566e+03  6.63623566e+03
  6.63623566e+03  9.21122558e+03  2.55588802e+04  7.62896644e+04]
E1 = -728.3471759081189  E_coul = 201.63765714515006
cycle= 3 E= -526.709518762969  delta_E= -3.42e-05  |g|= 0.0048  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104202
diis-c [-4.26678695e-07 -1.10569717e-03  1.30716292e-01  8.70389405e-01]
  HOMO = -0.575377164759231  LUMO = 1.02864966365714
  mo_energy =
[-1.18576340e+02 -1.23045298e+01 -9.55737977e+00 -9.55737977e+00
 -9.55737977e+00 -1.24978822e+00 -5.75377165e-01 -5.75377165e-01
 -5.75377165e-01  1.02864966e+00  1.02864966e+00  1.02864966e+00
  7.40954336e+00  7.40954336e+00  7.40954336e+00  9.98219851e+00
  3.41277169e+01  3.41277169e+01  3.41277169e+01  1.16085114e+02
  1.31721063e+02  1.31721063e+02  1.31721063e+02  4.86664105e+02
  4.86664105e+02  4.86664105e+02  6.52627313e+02  1.33369162e+03
  1.33369162e+03  1.33369162e+03  2.79173279e+03  3.02079625e+03
  3.02079625e+03  3.02079625e+03  6.63622702e+03  6.63622702e+03
  6.63622702e+03  9.21121675e+03  2.55588712e+04  7.62896553e+04]
E1 = -728.3612737484792  E_coul = 201.65175415627894
cycle= 4 E= -526.7095195922  delta_E= -8.29e-07  |g|= 5.89e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122742
diis-c [-1.28766528e-09  6.40956069e-05 -9.01360565e-03 -7.07429741e-02
  1.07969248e+00]
  HOMO = -0.575365395637218  LUMO = 1.02865845463857
  mo_energy =
[-1.18576345e+02 -1.23045017e+01 -9.55736314e+00 -9.55736314e+00
 -9.55736314e+00 -1.24976955e+00 -5.75365396e-01 -5.75365396e-01
 -5.75365396e-01  1.02865845e+00  1.02865845e+00  1.02865845e+00
  7.40956336e+00  7.40956336e+00  7.40956336e+00  9.98223316e+00
  3.41277322e+01  3.41277322e+01  3.41277322e+01  1.16085123e+02
  1.31721070e+02  1.31721070e+02  1.31721070e+02  4.86664101e+02
  4.86664101e+02  4.86664101e+02  6.52627300e+02  1.33369161e+03
  1.33369161e+03  1.33369161e+03  2.79173276e+03  3.02079623e+03
  3.02079623e+03  3.02079623e+03  6.63622698e+03  6.63622698e+03
  6.63622698e+03  9.21121671e+03  2.55588711e+04  7.62896553e+04]
E1 = -728.3612731343832  E_coul = 201.6517535420764
cycle= 5 E= -526.709519592307  delta_E= -1.07e-10  |g|= 7.67e-06  |ddm|= 2.33e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3612731343832  E_coul = 201.6517535420764
  HOMO = -0.575368804576766  LUMO = 1.02865594134456
  mo_energy =
[-1.18576362e+02 -1.23045137e+01 -9.55737575e+00 -9.55737575e+00
 -9.55737575e+00 -1.24977375e+00 -5.75368805e-01 -5.75368805e-01
 -5.75368805e-01  1.02865594e+00  1.02865594e+00  1.02865594e+00
  7.40955501e+00  7.40955501e+00  7.40955501e+00  9.98222332e+00
  3.41277197e+01  3.41277197e+01  3.41277197e+01  1.16085108e+02
  1.31721055e+02  1.31721055e+02  1.31721055e+02  4.86664084e+02
  4.86664084e+02  4.86664084e+02  6.52627283e+02  1.33369159e+03
  1.33369159e+03  1.33369159e+03  2.79173274e+03  3.02079621e+03
  3.02079621e+03  3.02079621e+03  6.63622696e+03  6.63622696e+03
  6.63622696e+03  9.21121669e+03  2.55588711e+04  7.62896552e+04]
E1 = -728.3613108073143  E_coul = 201.65179121500512
Extra cycle  E= -526.709519592309  delta_E= -2.39e-12  |g|= 2.26e-06  |ddm|= 3.9e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.23 sec
exp = [2.61828333e+04 7.61710656e+03 3.61751000e+03 1.58855103e+03
 4.15146572e+02 1.21019255e+02 3.88450971e+01 8.06552203e+00
 3.16208025e+00 3.98456094e-01 1.36284187e+03 6.64174975e+02
 2.98273413e+02 3.11724954e+02 6.28259842e+01 7.45577643e+00
 2.06384781e+01 7.78453024e-01 2.85421671e+00 2.24302190e-01]
E = -526.7095195923092
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:01:43 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8333406        1
[INPUT] 0    0    [1    /1   ]  7617.10656046        1
[INPUT] 0    0    [1    /1   ]  3617.51000081        1
[INPUT] 0    0    [1    /1   ]  1588.55102928        1
[INPUT] 0    0    [1    /1   ]  415.146571502        1
[INPUT] 0    0    [1    /1   ]  121.019254946        1
[INPUT] 0    0    [1    /1   ]  38.8450971059        1
[INPUT] 0    0    [1    /1   ]  8.06552202794        1
[INPUT] 0    0    [1    /1   ]  3.16208025097        1
[INPUT] 0    0    [1    /1   ]  0.398456093708       1
[INPUT] 1    0    [1    /1   ]  1362.8418673         1
[INPUT] 1    0    [1    /1   ]  664.174975348        1
[INPUT] 1    0    [1    /1   ]  298.273412921        1
[INPUT] 1    0    [1    /1   ]  311.724954379        1
[INPUT] 1    0    [1    /1   ]  62.8259841771        1
[INPUT] 1    0    [1    /1   ]  7.45577642866        1
[INPUT] 1    0    [1    /1   ]  20.6384780868        1
[INPUT] 1    0    [1    /1   ]  0.778453023514       1
[INPUT] 1    0    [1    /1   ]  2.85421671143        1
[INPUT] 1    0    [1    /1   ]  0.224302189997       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.83334063504, 1.0]], [0, [7617.106560457919, 1.0]], [0, [3617.5100008075424, 1.0]], [0, [1588.5510292772567, 1.0]], [0, [415.1465715016322, 1.0]], [0, [121.01925494641435, 1.0]], [0, [38.84509710590147, 1.0]], [0, [8.065522027939313, 1.0]], [0, [3.1620802509658352, 1.0]], [0, [0.398456093707836, 1.0]], [1, [1362.8418673009112, 1.0]], [1, [664.1749753479132, 1.0]], [1, [298.27341292080297, 1.0]], [1, [311.7249543793843, 1.0]], [1, [62.82598417706878, 1.0]], [1, [7.455776428656456, 1.0]], [1, [20.638478086792265, 1.0]], [1, [0.7784530235136222, 1.0]], [1, [2.8542167114278856, 1.0]], [1, [0.22430218999734283, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.83334064]
bas 1, expnt(s) = [7617.10656046]
bas 2, expnt(s) = [3617.51000081]
bas 3, expnt(s) = [1588.55102928]
bas 4, expnt(s) = [415.1465715]
bas 5, expnt(s) = [121.01925495]
bas 6, expnt(s) = [38.84509711]
bas 7, expnt(s) = [8.06552203]
bas 8, expnt(s) = [3.16208025]
bas 9, expnt(s) = [0.39845609]
bas 10, expnt(s) = [1362.8418673]
bas 11, expnt(s) = [664.17497535]
bas 12, expnt(s) = [298.27341292]
bas 13, expnt(s) = [311.72495438]
bas 14, expnt(s) = [62.82598418]
bas 15, expnt(s) = [7.45577643]
bas 16, expnt(s) = [20.63847809]
bas 17, expnt(s) = [0.77845302]
bas 18, expnt(s) = [2.85421671]
bas 19, expnt(s) = [0.22430219]
CPU time:      1700.90
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828333e+04 5.20028931e+03 7.61710656e+03 2.05995412e+03
 3.61751000e+03 1.17848031e+03 1.58855103e+03 6.35720040e+02
 4.15146572e+02 2.32362540e+02 1.21019255e+02 9.21840704e+01
 3.88450971e+01 3.93112798e+01 8.06552203e+00 1.20917563e+01
 3.16208025e+00 5.99093614e+00 3.98456094e-01 1.26706933e+00
 1.36284187e+03 2.41569014e+04 6.64174975e+02 9.83643050e+03
 2.98273413e+02 3.61620108e+03 3.11724954e+02 3.82119196e+03
 6.28259842e+01 5.16010475e+02 7.45577643e+00 3.59418550e+01
 2.06384781e+01 1.28330970e+02 7.78453024e-01 2.13316724e+00
 2.85421671e+00 1.08228857e+01 2.24302190e-01 4.50325236e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98273799240721
cond(S) = 96508.84944889441
E1 = -729.3775412799823  E_coul = 203.1208862814886
init E= -526.256654998494
    CPU time for initialize scf      0.63 sec, wall time      0.05 sec
  HOMO = -0.556942204070587  LUMO = 1.04024665743358
  mo_energy =
[-1.18335109e+02 -1.22078537e+01 -9.45170174e+00 -9.45170174e+00
 -9.45170174e+00 -1.22607418e+00 -5.56942204e-01 -5.56942204e-01
 -5.56942204e-01  1.04024666e+00  1.04024666e+00  1.04024666e+00
  7.46977300e+00  7.46977300e+00  7.46977300e+00  1.00516492e+01
  3.42394224e+01  3.42394224e+01  3.42394224e+01  1.16256074e+02
  1.31893545e+02  1.31893545e+02  1.31893545e+02  4.86904138e+02
  4.86904138e+02  4.86904138e+02  6.52911299e+02  1.33398374e+03
  1.33398374e+03  1.33398374e+03  2.79215711e+03  3.02115221e+03
  3.02115221e+03  3.02115221e+03  6.63669379e+03  6.63669379e+03
  6.63669379e+03  9.21175665e+03  2.55595044e+04  7.62903782e+04]
E1 = -727.9907429751688  E_coul = 201.28184465502872
cycle= 1 E= -526.70889832014  delta_E= -0.452  |g|= 0.183  |ddm|= 0.408
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.538311
diis-c [-0.28977917  1.        ]
  HOMO = -0.581130959746486  LUMO = 1.02425650390097
  mo_energy =
[-1.18627177e+02 -1.23311408e+01 -9.58501725e+00 -9.58501725e+00
 -9.58501725e+00 -1.25714546e+00 -5.81130960e-01 -5.81130960e-01
 -5.81130960e-01  1.02425650e+00  1.02425650e+00  1.02425650e+00
  7.39351853e+00  7.39351853e+00  7.39351853e+00  9.96086133e+00
  3.40992753e+01  3.40992753e+01  3.40992753e+01  1.16042737e+02
  1.31679808e+02  1.31679808e+02  1.31679808e+02  4.86613952e+02
  4.86613952e+02  4.86613952e+02  6.52574778e+02  1.33363819e+03
  1.33363819e+03  1.33363819e+03  2.79167684e+03  3.02074108e+03
  3.02074108e+03  3.02074108e+03  6.63617064e+03  6.63617064e+03
  6.63617064e+03  9.21115985e+03  2.55588140e+04  7.62895980e+04]
E1 = -728.4512785412791  E_coul = 201.7417939902961
cycle= 2 E= -526.709484550983  delta_E= -0.000586  |g|= 0.0333  |ddm|= 0.0385
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0666121
diis-c [-0.00265551  0.07302113  0.92697887]
  HOMO = -0.574462301772626  LUMO = 1.02933556172696
  mo_energy =
[-1.18568813e+02 -1.23005115e+01 -9.55309136e+00 -9.55309136e+00
 -9.55309136e+00 -1.24867764e+00 -5.74462302e-01 -5.74462302e-01
 -5.74462302e-01  1.02933556e+00  1.02933556e+00  1.02933556e+00
  7.41205778e+00  7.41205778e+00  7.41205778e+00  9.98532076e+00
  3.41320917e+01  3.41320917e+01  3.41320917e+01  1.16091381e+02
  1.31727231e+02  1.31727231e+02  1.31727231e+02  4.86671532e+02
  4.86671532e+02  4.86671532e+02  6.52635131e+02  1.33369956e+03
  1.33369956e+03  1.33369956e+03  2.79174131e+03  3.02080454e+03
  3.02080454e+03  3.02080454e+03  6.63623566e+03  6.63623566e+03
  6.63623566e+03  9.21122558e+03  2.55588802e+04  7.62896644e+04]
E1 = -728.3471759081189  E_coul = 201.63765714515006
cycle= 3 E= -526.709518762969  delta_E= -3.42e-05  |g|= 0.0048  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104202
diis-c [-4.26678695e-07 -1.10569717e-03  1.30716292e-01  8.70389405e-01]
  HOMO = -0.575377164759231  LUMO = 1.02864966365714
  mo_energy =
[-1.18576340e+02 -1.23045298e+01 -9.55737977e+00 -9.55737977e+00
 -9.55737977e+00 -1.24978822e+00 -5.75377165e-01 -5.75377165e-01
 -5.75377165e-01  1.02864966e+00  1.02864966e+00  1.02864966e+00
  7.40954336e+00  7.40954336e+00  7.40954336e+00  9.98219851e+00
  3.41277169e+01  3.41277169e+01  3.41277169e+01  1.16085114e+02
  1.31721063e+02  1.31721063e+02  1.31721063e+02  4.86664105e+02
  4.86664105e+02  4.86664105e+02  6.52627313e+02  1.33369162e+03
  1.33369162e+03  1.33369162e+03  2.79173279e+03  3.02079625e+03
  3.02079625e+03  3.02079625e+03  6.63622702e+03  6.63622702e+03
  6.63622702e+03  9.21121675e+03  2.55588712e+04  7.62896553e+04]
E1 = -728.3612737484792  E_coul = 201.65175415627894
cycle= 4 E= -526.7095195922  delta_E= -8.29e-07  |g|= 5.89e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122742
diis-c [-1.28766528e-09  6.40956069e-05 -9.01360565e-03 -7.07429741e-02
  1.07969248e+00]
  HOMO = -0.575365395637218  LUMO = 1.02865845463857
  mo_energy =
[-1.18576345e+02 -1.23045017e+01 -9.55736314e+00 -9.55736314e+00
 -9.55736314e+00 -1.24976955e+00 -5.75365396e-01 -5.75365396e-01
 -5.75365396e-01  1.02865845e+00  1.02865845e+00  1.02865845e+00
  7.40956336e+00  7.40956336e+00  7.40956336e+00  9.98223316e+00
  3.41277322e+01  3.41277322e+01  3.41277322e+01  1.16085123e+02
  1.31721070e+02  1.31721070e+02  1.31721070e+02  4.86664101e+02
  4.86664101e+02  4.86664101e+02  6.52627300e+02  1.33369161e+03
  1.33369161e+03  1.33369161e+03  2.79173276e+03  3.02079623e+03
  3.02079623e+03  3.02079623e+03  6.63622698e+03  6.63622698e+03
  6.63622698e+03  9.21121671e+03  2.55588711e+04  7.62896553e+04]
E1 = -728.3612731343832  E_coul = 201.6517535420764
cycle= 5 E= -526.709519592307  delta_E= -1.07e-10  |g|= 7.67e-06  |ddm|= 2.33e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3612731343832  E_coul = 201.6517535420764
  HOMO = -0.575368804576766  LUMO = 1.02865594134456
  mo_energy =
[-1.18576362e+02 -1.23045137e+01 -9.55737575e+00 -9.55737575e+00
 -9.55737575e+00 -1.24977375e+00 -5.75368805e-01 -5.75368805e-01
 -5.75368805e-01  1.02865594e+00  1.02865594e+00  1.02865594e+00
  7.40955501e+00  7.40955501e+00  7.40955501e+00  9.98222332e+00
  3.41277197e+01  3.41277197e+01  3.41277197e+01  1.16085108e+02
  1.31721055e+02  1.31721055e+02  1.31721055e+02  4.86664084e+02
  4.86664084e+02  4.86664084e+02  6.52627283e+02  1.33369159e+03
  1.33369159e+03  1.33369159e+03  2.79173274e+03  3.02079621e+03
  3.02079621e+03  3.02079621e+03  6.63622696e+03  6.63622696e+03
  6.63622696e+03  9.21121669e+03  2.55588711e+04  7.62896552e+04]
E1 = -728.3613108073143  E_coul = 201.65179121500512
Extra cycle  E= -526.709519592309  delta_E= -2.39e-12  |g|= 2.26e-06  |ddm|= 3.9e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 96508.84944889441
E1 = -728.3613108073143  E_coul = 201.65179121500512
init E= -526.709519592309
    CPU time for initialize scf      3.79 sec, wall time      0.20 sec
  HOMO = -0.575368116730329  LUMO = 1.02865645452035
  mo_energy =
[-1.18576357e+02 -1.23045110e+01 -9.55737289e+00 -9.55737289e+00
 -9.55737289e+00 -1.24977289e+00 -5.75368117e-01 -5.75368117e-01
 -5.75368117e-01  1.02865645e+00  1.02865645e+00  1.02865645e+00
  7.40955679e+00  7.40955679e+00  7.40955679e+00  9.98222555e+00
  3.41277226e+01  3.41277226e+01  3.41277226e+01  1.16085112e+02
  1.31721059e+02  1.31721059e+02  1.31721059e+02  4.86664089e+02
  4.86664089e+02  4.86664089e+02  6.52627287e+02  1.33369159e+03
  1.33369159e+03  1.33369159e+03  2.79173275e+03  3.02079621e+03
  3.02079621e+03  3.02079621e+03  6.63622697e+03  6.63622697e+03
  6.63622697e+03  9.21121669e+03  2.55588711e+04  7.62896553e+04]
E1 = -728.3613018750507  E_coul = 201.6517822827403
cycle= 1 E= -526.70951959231  delta_E= -1.14e-12  |g|= 5.79e-07  |ddm|= 8.89e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3613018750507  E_coul = 201.6517822827403
  HOMO = -0.575368268450698  LUMO = 1.02865634066691
  mo_energy =
[-1.18576358e+02 -1.23045116e+01 -9.55737357e+00 -9.55737357e+00
 -9.55737357e+00 -1.24977308e+00 -5.75368268e-01 -5.75368268e-01
 -5.75368268e-01  1.02865634e+00  1.02865634e+00  1.02865634e+00
  7.40955638e+00  7.40955638e+00  7.40955638e+00  9.98222503e+00
  3.41277219e+01  3.41277219e+01  3.41277219e+01  1.16085111e+02
  1.31721058e+02  1.31721058e+02  1.31721058e+02  4.86664088e+02
  4.86664088e+02  4.86664088e+02  6.52627286e+02  1.33369159e+03
  1.33369159e+03  1.33369159e+03  2.79173275e+03  3.02079621e+03
  3.02079621e+03  3.02079621e+03  6.63622697e+03  6.63622697e+03
  6.63622697e+03  9.21121669e+03  2.55588711e+04  7.62896553e+04]
E1 = -728.3613040466088  E_coul = 201.65178445429876
Extra cycle  E= -526.70951959231  delta_E= 3.41e-13  |g|= 1.45e-07  |ddm|= 2.08e-07
    CPU time for scf_cycle      3.91 sec, wall time      0.32 sec
exp = [2.61828333e+04 7.61710656e+03 3.61751000e+03 1.58855103e+03
 4.15146572e+02 1.21019255e+02 3.88450971e+01 8.06552203e+00
 3.16208025e+00 3.98456094e-01 1.36284187e+03 6.64174975e+02
 2.98273413e+02 3.11724954e+02 6.28259842e+01 7.45577643e+00
 2.06384781e+01 7.78453024e-01 2.85421671e+00 2.24302190e-01]
grad_E = [-1.40531980e-06  2.22646384e-06 -2.12676466e-06  3.87036780e-05
  1.46229205e-05 -2.06266308e-05  3.03211950e-05  4.15796104e-05
 -4.99503355e-06 -8.43609624e-04 -5.82265120e-07  4.13926874e-06
  1.89860963e-05  1.62185725e-05  5.87089538e-05 -5.67604697e-04
  1.77960777e-04 -2.13475371e-04  5.27855216e-04  2.22408403e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:01:47 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8352564        1
[INPUT] 0    0    [1    /1   ]  7617.10327326        1
[INPUT] 0    0    [1    /1   ]  3617.51269937        1
[INPUT] 0    0    [1    /1   ]  1588.48992325        1
[INPUT] 0    0    [1    /1   ]  415.200746834        1
[INPUT] 0    0    [1    /1   ]  121.012047084        1
[INPUT] 0    0    [1    /1   ]  38.8446599336        1
[INPUT] 0    0    [1    /1   ]  8.07170999152        1
[INPUT] 0    0    [1    /1   ]  3.16373487424        1
[INPUT] 0    0    [1    /1   ]  0.398408984887       1
[INPUT] 1    0    [1    /1   ]  1362.84263497        1
[INPUT] 1    0    [1    /1   ]  664.169273485        1
[INPUT] 1    0    [1    /1   ]  298.247157396        1
[INPUT] 1    0    [1    /1   ]  311.702488766        1
[INPUT] 1    0    [1    /1   ]  62.7521027065        1
[INPUT] 1    0    [1    /1   ]  7.439232429          1
[INPUT] 1    0    [1    /1   ]  20.6052571315        1
[INPUT] 1    0    [1    /1   ]  0.778035732733       1
[INPUT] 1    0    [1    /1   ]  2.84899536101        1
[INPUT] 1    0    [1    /1   ]  0.224289948011       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.835256369337, 1.0]], [0, [7617.10327325861, 1.0]], [0, [3617.5126993734248, 1.0]], [0, [1588.4899232467603, 1.0]], [0, [415.2007468337656, 1.0]], [0, [121.01204708371743, 1.0]], [0, [38.844659933641296, 1.0]], [0, [8.07170999152082, 1.0]], [0, [3.163734874238507, 1.0]], [0, [0.3984089848871996, 1.0]], [1, [1362.842634970636, 1.0]], [1, [664.1692734850828, 1.0]], [1, [298.2471573961107, 1.0]], [1, [311.70248876597583, 1.0]], [1, [62.75210270645551, 1.0]], [1, [7.4392324290032965, 1.0]], [1, [20.605257131492397, 1.0]], [1, [0.7780357327329367, 1.0]], [1, [2.8489953610056387, 1.0]], [1, [0.22428994801078808, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.83525637]
bas 1, expnt(s) = [7617.10327326]
bas 2, expnt(s) = [3617.51269937]
bas 3, expnt(s) = [1588.48992325]
bas 4, expnt(s) = [415.20074683]
bas 5, expnt(s) = [121.01204708]
bas 6, expnt(s) = [38.84465993]
bas 7, expnt(s) = [8.07170999]
bas 8, expnt(s) = [3.16373487]
bas 9, expnt(s) = [0.39840898]
bas 10, expnt(s) = [1362.84263497]
bas 11, expnt(s) = [664.16927349]
bas 12, expnt(s) = [298.2471574]
bas 13, expnt(s) = [311.70248877]
bas 14, expnt(s) = [62.75210271]
bas 15, expnt(s) = [7.43923243]
bas 16, expnt(s) = [20.60525713]
bas 17, expnt(s) = [0.77803573]
bas 18, expnt(s) = [2.84899536]
bas 19, expnt(s) = [0.22428995]
CPU time:      1710.41
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828353e+04 5.20028959e+03 7.61710327e+03 2.05995345e+03
 3.61751270e+03 1.17848097e+03 1.58848992e+03 6.35701699e+02
 4.15200747e+02 2.32385282e+02 1.21012047e+02 9.21799525e+01
 3.88446599e+01 3.93109480e+01 8.07170999e+00 1.20987133e+01
 3.16373487e+00 5.99328714e+00 3.98408985e-01 1.26695698e+00
 1.36284263e+03 2.41569184e+04 6.64169273e+02 9.83632495e+03
 2.98247157e+02 3.61580319e+03 3.11702489e+02 3.82084773e+03
 6.27521027e+01 5.15252071e+02 7.43923243e+00 3.58421912e+01
 2.06052571e+01 1.28072811e+02 7.78035733e-01 2.13173797e+00
 2.84899536e+00 1.07981429e+01 2.24289948e-01 4.50294513e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982750252788197
cond(S) = 96297.57993825267
E1 = -729.3770081349933  E_coul = 203.12049015927659
init E= -526.256517975717
    CPU time for initialize scf      0.62 sec, wall time      0.05 sec
  HOMO = -0.55695941484851  LUMO = 1.03981518735236
  mo_energy =
[-1.18335150e+02 -1.22078754e+01 -9.45172698e+00 -9.45172698e+00
 -9.45172698e+00 -1.22608400e+00 -5.56959415e-01 -5.56959415e-01
 -5.56959415e-01  1.03981519e+00  1.03981519e+00  1.03981519e+00
  7.45445396e+00  7.45445396e+00  7.45445396e+00  1.00626018e+01
  3.41582025e+01  3.41582025e+01  3.41582025e+01  1.16284263e+02
  1.31657145e+02  1.31657145e+02  1.31657145e+02  4.86504167e+02
  4.86504167e+02  4.86504167e+02  6.52957411e+02  1.33350073e+03
  1.33350073e+03  1.33350073e+03  2.79225805e+03  3.02060406e+03
  3.02060406e+03  3.02060406e+03  6.63612642e+03  6.63612642e+03
  6.63612642e+03  9.21181439e+03  2.55595016e+04  7.62903461e+04]
E1 = -727.9913234730326  E_coul = 201.28242039066464
cycle= 1 E= -526.708903082368  delta_E= -0.452  |g|= 0.183  |ddm|= 0.408
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.538267
diis-c [-0.28973124  1.        ]
  HOMO = -0.581121315082749  LUMO = 1.02385878285097
  mo_energy =
[-1.18627143e+02 -1.23310914e+01 -9.58496900e+00 -9.58496900e+00
 -9.58496900e+00 -1.25711629e+00 -5.81121315e-01 -5.81121315e-01
 -5.81121315e-01  1.02385878e+00  1.02385878e+00  1.02385878e+00
  7.37838062e+00  7.37838062e+00  7.37838062e+00  9.97184913e+00
  3.40182446e+01  3.40182446e+01  3.40182446e+01  1.16070990e+02
  1.31443550e+02  1.31443550e+02  1.31443550e+02  4.86214054e+02
  4.86214054e+02  4.86214054e+02  6.52620959e+02  1.33315526e+03
  1.33315526e+03  1.33315526e+03  2.79177785e+03  3.02019300e+03
  3.02019300e+03  3.02019300e+03  6.63560333e+03  6.63560333e+03
  6.63560333e+03  9.21121766e+03  2.55588112e+04  7.62895660e+04]
E1 = -728.4516779849336  E_coul = 201.74218890415878
cycle= 2 E= -526.709489080775  delta_E= -0.000586  |g|= 0.0333  |ddm|= 0.0385
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0665907
diis-c [-0.00265436  0.07299429  0.92700571]
  HOMO = -0.574456238139327  LUMO = 1.0289314719826
  mo_energy =
[-1.18568795e+02 -1.23004733e+01 -9.55305518e+00 -9.55305518e+00
 -9.55305518e+00 -1.24865311e+00 -5.74456238e-01 -5.74456238e-01
 -5.74456238e-01  1.02893147e+00  1.02893147e+00  1.02893147e+00
  7.39688581e+00  7.39688581e+00  7.39688581e+00  9.99631056e+00
  3.40510234e+01  3.40510234e+01  3.40510234e+01  1.16119620e+02
  1.31490947e+02  1.31490947e+02  1.31490947e+02  4.86271618e+02
  4.86271618e+02  4.86271618e+02  6.52681297e+02  1.33321662e+03
  1.33321662e+03  1.33321662e+03  2.79184230e+03  3.02025644e+03
  3.02025644e+03  3.02025644e+03  6.63566834e+03  6.63566834e+03
  6.63566834e+03  9.21128338e+03  2.55588774e+04  7.62896324e+04]
E1 = -728.3476233760179  E_coul = 201.63810011126483
cycle= 3 E= -526.709523264753  delta_E= -3.42e-05  |g|= 0.0048  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.010417
diis-c [-4.26999929e-07 -1.10574662e-03  1.30717626e-01  8.70388120e-01]
  HOMO = -0.575370774304586  LUMO = 1.02824632851663
  mo_energy =
[-1.18576320e+02 -1.23044905e+01 -9.55734234e+00 -9.55734234e+00
 -9.55734234e+00 -1.24976325e+00 -5.75370774e-01 -5.75370774e-01
 -5.75370774e-01  1.02824633e+00  1.02824633e+00  1.02824633e+00
  7.39437571e+00  7.39437571e+00  7.39437571e+00  9.99318796e+00
  3.40466531e+01  3.40466531e+01  3.40466531e+01  1.16113354e+02
  1.31484782e+02  1.31484782e+02  1.31484782e+02  4.86264194e+02
  4.86264194e+02  4.86264194e+02  6.52673481e+02  1.33320868e+03
  1.33320868e+03  1.33320868e+03  2.79183379e+03  3.02024815e+03
  3.02024815e+03  3.02024815e+03  6.63565970e+03  6.63565970e+03
  6.63565970e+03  9.21127455e+03  2.55588684e+04  7.62896233e+04]
E1 = -728.3617163226448  E_coul = 201.65219222921147
cycle= 4 E= -526.709524093433  delta_E= -8.29e-07  |g|= 5.89e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122669
diis-c [-1.29196400e-09  6.41046915e-05 -9.01342776e-03 -7.07332248e-02
  1.07968255e+00]
  HOMO = -0.575358976103533  LUMO = 1.02825513604846
  mo_energy =
[-1.18576324e+02 -1.23044623e+01 -9.55732561e+00 -9.55732561e+00
 -9.55732561e+00 -1.24974455e+00 -5.75358976e-01 -5.75358976e-01
 -5.75358976e-01  1.02825514e+00  1.02825514e+00  1.02825514e+00
  7.39439578e+00  7.39439578e+00  7.39439578e+00  9.99322270e+00
  3.40466685e+01  3.40466685e+01  3.40466685e+01  1.16113364e+02
  1.31484789e+02  1.31484789e+02  1.31484789e+02  4.86264190e+02
  4.86264190e+02  4.86264190e+02  6.52673468e+02  1.33320866e+03
  1.33320866e+03  1.33320866e+03  2.79183375e+03  3.02024813e+03
  3.02024813e+03  3.02024813e+03  6.63565967e+03  6.63565967e+03
  6.63565967e+03  9.21127450e+03  2.55588683e+04  7.62896232e+04]
E1 = -728.3617154681907  E_coul = 201.65219137464973
cycle= 5 E= -526.709524093541  delta_E= -1.08e-10  |g|= 7.68e-06  |ddm|= 2.33e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3617154681907  E_coul = 201.65219137464973
  HOMO = -0.575362388509744  LUMO = 1.02825262200266
  mo_energy =
[-1.18576341e+02 -1.23044743e+01 -9.55733823e+00 -9.55733823e+00
 -9.55733823e+00 -1.24974875e+00 -5.75362389e-01 -5.75362389e-01
 -5.75362389e-01  1.02825262e+00  1.02825262e+00  1.02825262e+00
  7.39438743e+00  7.39438743e+00  7.39438743e+00  9.99321284e+00
  3.40466560e+01  3.40466560e+01  3.40466560e+01  1.16113349e+02
  1.31484774e+02  1.31484774e+02  1.31484774e+02  4.86264173e+02
  4.86264173e+02  4.86264173e+02  6.52673451e+02  1.33320864e+03
  1.33320864e+03  1.33320864e+03  2.79183374e+03  3.02024811e+03
  3.02024811e+03  3.02024811e+03  6.63565965e+03  6.63565965e+03
  6.63565965e+03  9.21127449e+03  2.55588683e+04  7.62896232e+04]
E1 = -728.3617531731686  E_coul = 201.65222907962456
Extra cycle  E= -526.709524093544  delta_E= -3.07e-12  |g|= 2.26e-06  |ddm|= 3.9e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.22 sec
exp = [2.61828353e+04 7.61710327e+03 3.61751270e+03 1.58848992e+03
 4.15200747e+02 1.21012047e+02 3.88446599e+01 8.07170999e+00
 3.16373487e+00 3.98408985e-01 1.36284263e+03 6.64169273e+02
 2.98247157e+02 3.11702489e+02 6.27521027e+01 7.43923243e+00
 2.06052571e+01 7.78035733e-01 2.84899536e+00 2.24289948e-01]
E = -526.709524093544
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:01:48 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8352564        1
[INPUT] 0    0    [1    /1   ]  7617.10327326        1
[INPUT] 0    0    [1    /1   ]  3617.51269937        1
[INPUT] 0    0    [1    /1   ]  1588.48992325        1
[INPUT] 0    0    [1    /1   ]  415.200746834        1
[INPUT] 0    0    [1    /1   ]  121.012047084        1
[INPUT] 0    0    [1    /1   ]  38.8446599336        1
[INPUT] 0    0    [1    /1   ]  8.07170999152        1
[INPUT] 0    0    [1    /1   ]  3.16373487424        1
[INPUT] 0    0    [1    /1   ]  0.398408984887       1
[INPUT] 1    0    [1    /1   ]  1362.84263497        1
[INPUT] 1    0    [1    /1   ]  664.169273485        1
[INPUT] 1    0    [1    /1   ]  298.247157396        1
[INPUT] 1    0    [1    /1   ]  311.702488766        1
[INPUT] 1    0    [1    /1   ]  62.7521027065        1
[INPUT] 1    0    [1    /1   ]  7.439232429          1
[INPUT] 1    0    [1    /1   ]  20.6052571315        1
[INPUT] 1    0    [1    /1   ]  0.778035732733       1
[INPUT] 1    0    [1    /1   ]  2.84899536101        1
[INPUT] 1    0    [1    /1   ]  0.224289948011       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.835256369337, 1.0]], [0, [7617.10327325861, 1.0]], [0, [3617.5126993734248, 1.0]], [0, [1588.4899232467603, 1.0]], [0, [415.2007468337656, 1.0]], [0, [121.01204708371743, 1.0]], [0, [38.844659933641296, 1.0]], [0, [8.07170999152082, 1.0]], [0, [3.163734874238507, 1.0]], [0, [0.3984089848871996, 1.0]], [1, [1362.842634970636, 1.0]], [1, [664.1692734850828, 1.0]], [1, [298.2471573961107, 1.0]], [1, [311.70248876597583, 1.0]], [1, [62.75210270645551, 1.0]], [1, [7.4392324290032965, 1.0]], [1, [20.605257131492397, 1.0]], [1, [0.7780357327329367, 1.0]], [1, [2.8489953610056387, 1.0]], [1, [0.22428994801078808, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.83525637]
bas 1, expnt(s) = [7617.10327326]
bas 2, expnt(s) = [3617.51269937]
bas 3, expnt(s) = [1588.48992325]
bas 4, expnt(s) = [415.20074683]
bas 5, expnt(s) = [121.01204708]
bas 6, expnt(s) = [38.84465993]
bas 7, expnt(s) = [8.07170999]
bas 8, expnt(s) = [3.16373487]
bas 9, expnt(s) = [0.39840898]
bas 10, expnt(s) = [1362.84263497]
bas 11, expnt(s) = [664.16927349]
bas 12, expnt(s) = [298.2471574]
bas 13, expnt(s) = [311.70248877]
bas 14, expnt(s) = [62.75210271]
bas 15, expnt(s) = [7.43923243]
bas 16, expnt(s) = [20.60525713]
bas 17, expnt(s) = [0.77803573]
bas 18, expnt(s) = [2.84899536]
bas 19, expnt(s) = [0.22428995]
CPU time:      1711.48
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828353e+04 5.20028959e+03 7.61710327e+03 2.05995345e+03
 3.61751270e+03 1.17848097e+03 1.58848992e+03 6.35701699e+02
 4.15200747e+02 2.32385282e+02 1.21012047e+02 9.21799525e+01
 3.88446599e+01 3.93109480e+01 8.07170999e+00 1.20987133e+01
 3.16373487e+00 5.99328714e+00 3.98408985e-01 1.26695698e+00
 1.36284263e+03 2.41569184e+04 6.64169273e+02 9.83632495e+03
 2.98247157e+02 3.61580319e+03 3.11702489e+02 3.82084773e+03
 6.27521027e+01 5.15252071e+02 7.43923243e+00 3.58421912e+01
 2.06052571e+01 1.28072811e+02 7.78035733e-01 2.13173797e+00
 2.84899536e+00 1.07981429e+01 2.24289948e-01 4.50294513e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982750252788197
cond(S) = 96297.57993825267
E1 = -729.3770081349933  E_coul = 203.12049015927659
init E= -526.256517975717
    CPU time for initialize scf      0.63 sec, wall time      0.05 sec
  HOMO = -0.55695941484851  LUMO = 1.03981518735236
  mo_energy =
[-1.18335150e+02 -1.22078754e+01 -9.45172698e+00 -9.45172698e+00
 -9.45172698e+00 -1.22608400e+00 -5.56959415e-01 -5.56959415e-01
 -5.56959415e-01  1.03981519e+00  1.03981519e+00  1.03981519e+00
  7.45445396e+00  7.45445396e+00  7.45445396e+00  1.00626018e+01
  3.41582025e+01  3.41582025e+01  3.41582025e+01  1.16284263e+02
  1.31657145e+02  1.31657145e+02  1.31657145e+02  4.86504167e+02
  4.86504167e+02  4.86504167e+02  6.52957411e+02  1.33350073e+03
  1.33350073e+03  1.33350073e+03  2.79225805e+03  3.02060406e+03
  3.02060406e+03  3.02060406e+03  6.63612642e+03  6.63612642e+03
  6.63612642e+03  9.21181439e+03  2.55595016e+04  7.62903461e+04]
E1 = -727.9913234730326  E_coul = 201.28242039066464
cycle= 1 E= -526.708903082368  delta_E= -0.452  |g|= 0.183  |ddm|= 0.408
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.538267
diis-c [-0.28973124  1.        ]
  HOMO = -0.581121315082749  LUMO = 1.02385878285097
  mo_energy =
[-1.18627143e+02 -1.23310914e+01 -9.58496900e+00 -9.58496900e+00
 -9.58496900e+00 -1.25711629e+00 -5.81121315e-01 -5.81121315e-01
 -5.81121315e-01  1.02385878e+00  1.02385878e+00  1.02385878e+00
  7.37838062e+00  7.37838062e+00  7.37838062e+00  9.97184913e+00
  3.40182446e+01  3.40182446e+01  3.40182446e+01  1.16070990e+02
  1.31443550e+02  1.31443550e+02  1.31443550e+02  4.86214054e+02
  4.86214054e+02  4.86214054e+02  6.52620959e+02  1.33315526e+03
  1.33315526e+03  1.33315526e+03  2.79177785e+03  3.02019300e+03
  3.02019300e+03  3.02019300e+03  6.63560333e+03  6.63560333e+03
  6.63560333e+03  9.21121766e+03  2.55588112e+04  7.62895660e+04]
E1 = -728.4516779849336  E_coul = 201.74218890415878
cycle= 2 E= -526.709489080775  delta_E= -0.000586  |g|= 0.0333  |ddm|= 0.0385
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0665907
diis-c [-0.00265436  0.07299429  0.92700571]
  HOMO = -0.574456238139327  LUMO = 1.0289314719826
  mo_energy =
[-1.18568795e+02 -1.23004733e+01 -9.55305518e+00 -9.55305518e+00
 -9.55305518e+00 -1.24865311e+00 -5.74456238e-01 -5.74456238e-01
 -5.74456238e-01  1.02893147e+00  1.02893147e+00  1.02893147e+00
  7.39688581e+00  7.39688581e+00  7.39688581e+00  9.99631056e+00
  3.40510234e+01  3.40510234e+01  3.40510234e+01  1.16119620e+02
  1.31490947e+02  1.31490947e+02  1.31490947e+02  4.86271618e+02
  4.86271618e+02  4.86271618e+02  6.52681297e+02  1.33321662e+03
  1.33321662e+03  1.33321662e+03  2.79184230e+03  3.02025644e+03
  3.02025644e+03  3.02025644e+03  6.63566834e+03  6.63566834e+03
  6.63566834e+03  9.21128338e+03  2.55588774e+04  7.62896324e+04]
E1 = -728.3476233760179  E_coul = 201.63810011126483
cycle= 3 E= -526.709523264753  delta_E= -3.42e-05  |g|= 0.0048  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.010417
diis-c [-4.26999929e-07 -1.10574662e-03  1.30717626e-01  8.70388120e-01]
  HOMO = -0.575370774304586  LUMO = 1.02824632851663
  mo_energy =
[-1.18576320e+02 -1.23044905e+01 -9.55734234e+00 -9.55734234e+00
 -9.55734234e+00 -1.24976325e+00 -5.75370774e-01 -5.75370774e-01
 -5.75370774e-01  1.02824633e+00  1.02824633e+00  1.02824633e+00
  7.39437571e+00  7.39437571e+00  7.39437571e+00  9.99318796e+00
  3.40466531e+01  3.40466531e+01  3.40466531e+01  1.16113354e+02
  1.31484782e+02  1.31484782e+02  1.31484782e+02  4.86264194e+02
  4.86264194e+02  4.86264194e+02  6.52673481e+02  1.33320868e+03
  1.33320868e+03  1.33320868e+03  2.79183379e+03  3.02024815e+03
  3.02024815e+03  3.02024815e+03  6.63565970e+03  6.63565970e+03
  6.63565970e+03  9.21127455e+03  2.55588684e+04  7.62896233e+04]
E1 = -728.3617163226448  E_coul = 201.65219222921147
cycle= 4 E= -526.709524093433  delta_E= -8.29e-07  |g|= 5.89e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122669
diis-c [-1.29196400e-09  6.41046915e-05 -9.01342776e-03 -7.07332248e-02
  1.07968255e+00]
  HOMO = -0.575358976103533  LUMO = 1.02825513604846
  mo_energy =
[-1.18576324e+02 -1.23044623e+01 -9.55732561e+00 -9.55732561e+00
 -9.55732561e+00 -1.24974455e+00 -5.75358976e-01 -5.75358976e-01
 -5.75358976e-01  1.02825514e+00  1.02825514e+00  1.02825514e+00
  7.39439578e+00  7.39439578e+00  7.39439578e+00  9.99322270e+00
  3.40466685e+01  3.40466685e+01  3.40466685e+01  1.16113364e+02
  1.31484789e+02  1.31484789e+02  1.31484789e+02  4.86264190e+02
  4.86264190e+02  4.86264190e+02  6.52673468e+02  1.33320866e+03
  1.33320866e+03  1.33320866e+03  2.79183375e+03  3.02024813e+03
  3.02024813e+03  3.02024813e+03  6.63565967e+03  6.63565967e+03
  6.63565967e+03  9.21127450e+03  2.55588683e+04  7.62896232e+04]
E1 = -728.3617154681907  E_coul = 201.65219137464973
cycle= 5 E= -526.709524093541  delta_E= -1.08e-10  |g|= 7.68e-06  |ddm|= 2.33e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3617154681907  E_coul = 201.65219137464973
  HOMO = -0.575362388509744  LUMO = 1.02825262200266
  mo_energy =
[-1.18576341e+02 -1.23044743e+01 -9.55733823e+00 -9.55733823e+00
 -9.55733823e+00 -1.24974875e+00 -5.75362389e-01 -5.75362389e-01
 -5.75362389e-01  1.02825262e+00  1.02825262e+00  1.02825262e+00
  7.39438743e+00  7.39438743e+00  7.39438743e+00  9.99321284e+00
  3.40466560e+01  3.40466560e+01  3.40466560e+01  1.16113349e+02
  1.31484774e+02  1.31484774e+02  1.31484774e+02  4.86264173e+02
  4.86264173e+02  4.86264173e+02  6.52673451e+02  1.33320864e+03
  1.33320864e+03  1.33320864e+03  2.79183374e+03  3.02024811e+03
  3.02024811e+03  3.02024811e+03  6.63565965e+03  6.63565965e+03
  6.63565965e+03  9.21127449e+03  2.55588683e+04  7.62896232e+04]
E1 = -728.3617531731686  E_coul = 201.65222907962456
Extra cycle  E= -526.709524093544  delta_E= -3.07e-12  |g|= 2.26e-06  |ddm|= 3.9e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.22 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 96297.57993825267
E1 = -728.3617531731686  E_coul = 201.65222907962456
init E= -526.709524093544
    CPU time for initialize scf      3.75 sec, wall time      0.20 sec
  HOMO = -0.575361700098587  LUMO = 1.02825313522823
  mo_energy =
[-1.18576337e+02 -1.23044715e+01 -9.55733537e+00 -9.55733537e+00
 -9.55733537e+00 -1.24974789e+00 -5.75361700e-01 -5.75361700e-01
 -5.75361700e-01  1.02825314e+00  1.02825314e+00  1.02825314e+00
  7.39438921e+00  7.39438921e+00  7.39438921e+00  9.99321507e+00
  3.40466589e+01  3.40466589e+01  3.40466589e+01  1.16113353e+02
  1.31484778e+02  1.31484778e+02  1.31484778e+02  4.86264177e+02
  4.86264177e+02  4.86264177e+02  6.52673455e+02  1.33320865e+03
  1.33320865e+03  1.33320865e+03  2.79183374e+03  3.02024812e+03
  3.02024812e+03  3.02024812e+03  6.63565965e+03  6.63565965e+03
  6.63565965e+03  9.21127449e+03  2.55588683e+04  7.62896232e+04]
E1 = -728.3617442341798  E_coul = 201.65222014063556
cycle= 1 E= -526.709524093544  delta_E= -2.27e-13  |g|= 5.8e-07  |ddm|= 8.9e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3617442341798  E_coul = 201.65222014063556
  HOMO = -0.575361851925971  LUMO = 1.02825302137894
  mo_energy =
[-1.18576338e+02 -1.23044722e+01 -9.55733605e+00 -9.55733605e+00
 -9.55733605e+00 -1.24974808e+00 -5.75361852e-01 -5.75361852e-01
 -5.75361852e-01  1.02825302e+00  1.02825302e+00  1.02825302e+00
  7.39438880e+00  7.39438880e+00  7.39438880e+00  9.99321456e+00
  3.40466582e+01  3.40466582e+01  3.40466582e+01  1.16113352e+02
  1.31484777e+02  1.31484777e+02  1.31484777e+02  4.86264176e+02
  4.86264176e+02  4.86264176e+02  6.52673454e+02  1.33320865e+03
  1.33320865e+03  1.33320865e+03  2.79183374e+03  3.02024811e+03
  3.02024811e+03  3.02024811e+03  6.63565965e+03  6.63565965e+03
  6.63565965e+03  9.21127449e+03  2.55588683e+04  7.62896232e+04]
E1 = -728.3617464071717  E_coul = 201.65222231362782
Extra cycle  E= -526.709524093544  delta_E= 3.41e-13  |g|= 1.45e-07  |ddm|= 2.08e-07
    CPU time for scf_cycle      3.86 sec, wall time      0.31 sec
exp = [2.61828353e+04 7.61710327e+03 3.61751270e+03 1.58848992e+03
 4.15200747e+02 1.21012047e+02 3.88446599e+01 8.07170999e+00
 3.16373487e+00 3.98408985e-01 1.36284263e+03 6.64169273e+02
 2.98247157e+02 3.11702489e+02 6.27521027e+01 7.43923243e+00
 2.06052571e+01 7.78035733e-01 2.84899536e+00 2.24289948e-01]
grad_E = [-1.40471145e-06  2.22136426e-06 -2.12651094e-06  3.85336571e-05
  1.76062270e-05 -3.43967432e-05  4.83352946e-05  6.77851916e-05
  5.60203761e-07 -1.36963604e-03 -5.79615149e-07  4.18121936e-06
  1.92217379e-05  1.64206956e-05  4.97726418e-05 -9.12850308e-04
  2.69348579e-04 -3.56728872e-04  8.37491928e-04  3.63811238e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:01:52 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8397888        1
[INPUT] 0    0    [1    /1   ]  7617.09559727        1
[INPUT] 0    0    [1    /1   ]  3617.51916632        1
[INPUT] 0    0    [1    /1   ]  1588.34871098        1
[INPUT] 0    0    [1    /1   ]  415.29819331         1
[INPUT] 0    0    [1    /1   ]  121.009161466        1
[INPUT] 0    0    [1    /1   ]  38.8457356579        1
[INPUT] 0    0    [1    /1   ]  8.08043942039        1
[INPUT] 0    0    [1    /1   ]  3.16600962998        1
[INPUT] 0    0    [1    /1   ]  0.398343112862       1
[INPUT] 1    0    [1    /1   ]  1362.844463          1
[INPUT] 1    0    [1    /1   ]  664.155828353        1
[INPUT] 1    0    [1    /1   ]  298.185312215        1
[INPUT] 1    0    [1    /1   ]  311.649585501        1
[INPUT] 1    0    [1    /1   ]  62.5662509648        1
[INPUT] 1    0    [1    /1   ]  7.40779945304        1
[INPUT] 1    0    [1    /1   ]  20.5319923368        1
[INPUT] 1    0    [1    /1   ]  0.777140093122       1
[INPUT] 1    0    [1    /1   ]  2.83910525586        1
[INPUT] 1    0    [1    /1   ]  0.224209925894       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.83978880362, 1.0]], [0, [7617.095597272631, 1.0]], [0, [3617.519166317827, 1.0]], [0, [1588.3487109849457, 1.0]], [0, [415.2981933099698, 1.0]], [0, [121.00916146635004, 1.0]], [0, [38.84573565790432, 1.0]], [0, [8.080439420390851, 1.0]], [0, [3.166009629978605, 1.0]], [0, [0.39834311286230334, 1.0]], [1, [1362.8444630002973, 1.0]], [1, [664.1558283531075, 1.0]], [1, [298.185312214777, 1.0]], [1, [311.6495855008788, 1.0]], [1, [62.56625096484534, 1.0]], [1, [7.407799453036621, 1.0]], [1, [20.531992336757874, 1.0]], [1, [0.777140093122106, 1.0]], [1, [2.839105255862878, 1.0]], [1, [0.22420992589428104, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.8397888]
bas 1, expnt(s) = [7617.09559727]
bas 2, expnt(s) = [3617.51916632]
bas 3, expnt(s) = [1588.34871098]
bas 4, expnt(s) = [415.29819331]
bas 5, expnt(s) = [121.00916147]
bas 6, expnt(s) = [38.84573566]
bas 7, expnt(s) = [8.08043942]
bas 8, expnt(s) = [3.16600963]
bas 9, expnt(s) = [0.39834311]
bas 10, expnt(s) = [1362.844463]
bas 11, expnt(s) = [664.15582835]
bas 12, expnt(s) = [298.18531221]
bas 13, expnt(s) = [311.6495855]
bas 14, expnt(s) = [62.56625096]
bas 15, expnt(s) = [7.40779945]
bas 16, expnt(s) = [20.53199234]
bas 17, expnt(s) = [0.77714009]
bas 18, expnt(s) = [2.83910526]
bas 19, expnt(s) = [0.22420993]
CPU time:      1720.97
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828398e+04 5.20029027e+03 7.61709560e+03 2.05995190e+03
 3.61751917e+03 1.17848255e+03 1.58834871e+03 6.35659315e+02
 4.15298193e+02 2.32426186e+02 1.21009161e+02 9.21783039e+01
 3.88457357e+01 3.93117645e+01 8.08043942e+00 1.21085254e+01
 3.16600963e+00 5.99651878e+00 3.98343113e-01 1.26679987e+00
 1.36284446e+03 2.41569589e+04 6.64155828e+02 9.83607605e+03
 2.98185312e+02 3.61486599e+03 3.11649586e+02 3.82003713e+03
 6.25662510e+01 5.13345262e+02 7.40779945e+00 3.56529864e+01
 2.05319923e+01 1.27503839e+02 7.77140093e-01 2.12867096e+00
 2.83910526e+00 1.07513069e+01 2.24209926e-01 4.50093702e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982778382400685
cond(S) = 95798.07014596857
E1 = -729.3762614472771  E_coul = 203.11993583623823
init E= -526.256325611039
    CPU time for initialize scf      0.64 sec, wall time      0.05 sec
  HOMO = -0.556986785194701  LUMO = 1.03868560382289
  mo_energy =
[-1.18335207e+02 -1.22079071e+01 -9.45175946e+00 -9.45175946e+00
 -9.45175946e+00 -1.22609659e+00 -5.56986785e-01 -5.56986785e-01
 -5.56986785e-01  1.03868560e+00  1.03868560e+00  1.03868560e+00
  7.42483336e+00  7.42483336e+00  7.42483336e+00  1.00779601e+01
  3.39969413e+01  3.39969413e+01  3.39969413e+01  1.16330200e+02
  1.31137175e+02  1.31137175e+02  1.31137175e+02  4.85574891e+02
  4.85574891e+02  4.85574891e+02  6.53060094e+02  1.33236519e+03
  1.33236519e+03  1.33236519e+03  2.79245297e+03  3.01931153e+03
  3.01931153e+03  3.01931153e+03  6.63478748e+03  6.63478748e+03
  6.63478748e+03  9.21188662e+03  2.55594286e+04  7.62902075e+04]
E1 = -727.9918529524653  E_coul = 201.28293889121355
cycle= 1 E= -526.708914061252  delta_E= -0.453  |g|= 0.183  |ddm|= 0.408
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.538188
diis-c [-0.28964633  1.        ]
  HOMO = -0.58112048023254  LUMO = 1.0227806430614
  mo_energy =
[-1.18627126e+02 -1.23310421e+01 -9.58491780e+00 -9.58491780e+00
 -9.58491780e+00 -1.25708502e+00 -5.81120480e-01 -5.81120480e-01
 -5.81120480e-01  1.02278064e+00  1.02278064e+00  1.02278064e+00
  7.34905788e+00  7.34905788e+00  7.34905788e+00  9.98723890e+00
  3.38573103e+01  3.38573103e+01  3.38573103e+01  1.16116985e+02
  1.30923832e+02  1.30923832e+02  1.30923832e+02  4.85284858e+02
  4.85284858e+02  4.85284858e+02  6.52723706e+02  1.33201978e+03
  1.33201978e+03  1.33201978e+03  2.79197283e+03  3.01890053e+03
  3.01890053e+03  3.01890053e+03  6.63426444e+03  6.63426444e+03
  6.63426444e+03  9.21128996e+03  2.55587382e+04  7.62894274e+04]
E1 = -728.4520541464373  E_coul = 201.74255425641445
cycle= 2 E= -526.709499890023  delta_E= -0.000586  |g|= 0.0333  |ddm|= 0.0385
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0665682
diis-c [-0.00265324  0.07296842  0.92703158]
  HOMO = -0.574458553927185  LUMO = 1.02784281492894
  mo_energy =
[-1.18568789e+02 -1.23004333e+01 -9.55301425e+00 -9.55301425e+00
 -9.55301425e+00 -1.24862601e+00 -5.74458554e-01 -5.74458554e-01
 -5.74458554e-01  1.02784281e+00  1.02784281e+00  1.02784281e+00
  7.36750650e+00  7.36750650e+00  7.36750650e+00  1.00117087e+01
  3.38900251e+01  3.38900251e+01  3.38900251e+01  1.16165605e+02
  1.30971188e+02  1.30971188e+02  1.30971188e+02  4.85342410e+02
  4.85342410e+02  4.85342410e+02  6.52784033e+02  1.33208113e+03
  1.33208113e+03  1.33208113e+03  2.79203727e+03  3.01896396e+03
  3.01896396e+03  3.01896396e+03  6.63432944e+03  6.63432944e+03
  6.63432944e+03  9.21135566e+03  2.55588044e+04  7.62894938e+04]
E1 = -728.3480373351932  E_coul = 201.6385032852599
cycle= 3 E= -526.709534049933  delta_E= -3.42e-05  |g|= 0.0048  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104139
diis-c [-4.27483589e-07 -1.10581852e-03  1.30721152e-01  8.70384666e-01]
  HOMO = -0.575372925948764  LUMO = 1.02715891630791
  mo_energy =
[-1.18576313e+02 -1.23044497e+01 -9.55730061e+00 -9.55730061e+00
 -9.55730061e+00 -1.24973588e+00 -5.75372926e-01 -5.75372926e-01
 -5.75372926e-01  1.02715892e+00  1.02715892e+00  1.02715892e+00
  7.36500359e+00  7.36500359e+00  7.36500359e+00  1.00085848e+01
  3.38856625e+01  3.38856625e+01  3.38856625e+01  1.16159340e+02
  1.30965028e+02  1.30965028e+02  1.30965028e+02  4.85334987e+02
  4.85334987e+02  4.85334987e+02  6.52776217e+02  1.33207319e+03
  1.33207319e+03  1.33207319e+03  2.79202876e+03  3.01895567e+03
  3.01895567e+03  3.01895567e+03  6.63432080e+03  6.63432080e+03
  6.63432080e+03  9.21134683e+03  2.55587954e+04  7.62894847e+04]
E1 = -728.3621275932666  E_coul = 201.65259271503044
cycle= 4 E= -526.709534878236  delta_E= -8.28e-07  |g|= 5.9e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122574
diis-c [-1.29924821e-09  6.41144027e-05 -9.01281471e-03 -7.07152032e-02
  1.07966390e+00]
  HOMO = -0.575361084676339  LUMO = 1.02716774443445
  mo_energy =
[-1.18576317e+02 -1.23044213e+01 -9.55728373e+00 -9.55728373e+00
 -9.55728373e+00 -1.24971713e+00 -5.75361085e-01 -5.75361085e-01
 -5.75361085e-01  1.02716774e+00  1.02716774e+00  1.02716774e+00
  7.36502376e+00  7.36502376e+00  7.36502376e+00  1.00086196e+01
  3.38856780e+01  3.38856780e+01  3.38856780e+01  1.16159350e+02
  1.30965035e+02  1.30965035e+02  1.30965035e+02  4.85334983e+02
  4.85334983e+02  4.85334983e+02  6.52776205e+02  1.33207318e+03
  1.33207318e+03  1.33207318e+03  2.79202873e+03  3.01895565e+03
  3.01895565e+03  3.01895565e+03  6.63432077e+03  6.63432077e+03
  6.63432077e+03  9.21134679e+03  2.55587954e+04  7.62894846e+04]
E1 = -728.362126383203  E_coul = 201.65259150485852
cycle= 5 E= -526.709534878344  delta_E= -1.08e-10  |g|= 7.69e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.362126383203  E_coul = 201.65259150485852
  HOMO = -0.575364503144267  LUMO = 1.02716522988812
  mo_energy =
[-1.18576334e+02 -1.23044334e+01 -9.55729637e+00 -9.55729637e+00
 -9.55729637e+00 -1.24972134e+00 -5.75364503e-01 -5.75364503e-01
 -5.75364503e-01  1.02716523e+00  1.02716523e+00  1.02716523e+00
  7.36501542e+00  7.36501542e+00  7.36501542e+00  1.00086098e+01
  3.38856655e+01  3.38856655e+01  3.38856655e+01  1.16159335e+02
  1.30965020e+02  1.30965020e+02  1.30965020e+02  4.85334966e+02
  4.85334966e+02  4.85334966e+02  6.52776188e+02  1.33207316e+03
  1.33207316e+03  1.33207316e+03  2.79202871e+03  3.01895563e+03
  3.01895563e+03  3.01895563e+03  6.63432075e+03  6.63432075e+03
  6.63432075e+03  9.21134677e+03  2.55587954e+04  7.62894846e+04]
E1 = -728.3621641495513  E_coul = 201.65262927120418
Extra cycle  E= -526.709534878347  delta_E= -2.61e-12  |g|= 2.26e-06  |ddm|= 3.91e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.23 sec
exp = [2.61828398e+04 7.61709560e+03 3.61751917e+03 1.58834871e+03
 4.15298193e+02 1.21009161e+02 3.88457357e+01 8.08043942e+00
 3.16600963e+00 3.98343113e-01 1.36284446e+03 6.64155828e+02
 2.98185312e+02 3.11649586e+02 6.25662510e+01 7.40779945e+00
 2.05319923e+01 7.77140093e-01 2.83910526e+00 2.24209926e-01]
E = -526.7095348783471
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:01:52 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8397888        1
[INPUT] 0    0    [1    /1   ]  7617.09559727        1
[INPUT] 0    0    [1    /1   ]  3617.51916632        1
[INPUT] 0    0    [1    /1   ]  1588.34871098        1
[INPUT] 0    0    [1    /1   ]  415.29819331         1
[INPUT] 0    0    [1    /1   ]  121.009161466        1
[INPUT] 0    0    [1    /1   ]  38.8457356579        1
[INPUT] 0    0    [1    /1   ]  8.08043942039        1
[INPUT] 0    0    [1    /1   ]  3.16600962998        1
[INPUT] 0    0    [1    /1   ]  0.398343112862       1
[INPUT] 1    0    [1    /1   ]  1362.844463          1
[INPUT] 1    0    [1    /1   ]  664.155828353        1
[INPUT] 1    0    [1    /1   ]  298.185312215        1
[INPUT] 1    0    [1    /1   ]  311.649585501        1
[INPUT] 1    0    [1    /1   ]  62.5662509648        1
[INPUT] 1    0    [1    /1   ]  7.40779945304        1
[INPUT] 1    0    [1    /1   ]  20.5319923368        1
[INPUT] 1    0    [1    /1   ]  0.777140093122       1
[INPUT] 1    0    [1    /1   ]  2.83910525586        1
[INPUT] 1    0    [1    /1   ]  0.224209925894       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.83978880362, 1.0]], [0, [7617.095597272631, 1.0]], [0, [3617.519166317827, 1.0]], [0, [1588.3487109849457, 1.0]], [0, [415.2981933099698, 1.0]], [0, [121.00916146635004, 1.0]], [0, [38.84573565790432, 1.0]], [0, [8.080439420390851, 1.0]], [0, [3.166009629978605, 1.0]], [0, [0.39834311286230334, 1.0]], [1, [1362.8444630002973, 1.0]], [1, [664.1558283531075, 1.0]], [1, [298.185312214777, 1.0]], [1, [311.6495855008788, 1.0]], [1, [62.56625096484534, 1.0]], [1, [7.407799453036621, 1.0]], [1, [20.531992336757874, 1.0]], [1, [0.777140093122106, 1.0]], [1, [2.839105255862878, 1.0]], [1, [0.22420992589428104, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.8397888]
bas 1, expnt(s) = [7617.09559727]
bas 2, expnt(s) = [3617.51916632]
bas 3, expnt(s) = [1588.34871098]
bas 4, expnt(s) = [415.29819331]
bas 5, expnt(s) = [121.00916147]
bas 6, expnt(s) = [38.84573566]
bas 7, expnt(s) = [8.08043942]
bas 8, expnt(s) = [3.16600963]
bas 9, expnt(s) = [0.39834311]
bas 10, expnt(s) = [1362.844463]
bas 11, expnt(s) = [664.15582835]
bas 12, expnt(s) = [298.18531221]
bas 13, expnt(s) = [311.6495855]
bas 14, expnt(s) = [62.56625096]
bas 15, expnt(s) = [7.40779945]
bas 16, expnt(s) = [20.53199234]
bas 17, expnt(s) = [0.77714009]
bas 18, expnt(s) = [2.83910526]
bas 19, expnt(s) = [0.22420993]
CPU time:      1722.07
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828398e+04 5.20029027e+03 7.61709560e+03 2.05995190e+03
 3.61751917e+03 1.17848255e+03 1.58834871e+03 6.35659315e+02
 4.15298193e+02 2.32426186e+02 1.21009161e+02 9.21783039e+01
 3.88457357e+01 3.93117645e+01 8.08043942e+00 1.21085254e+01
 3.16600963e+00 5.99651878e+00 3.98343113e-01 1.26679987e+00
 1.36284446e+03 2.41569589e+04 6.64155828e+02 9.83607605e+03
 2.98185312e+02 3.61486599e+03 3.11649586e+02 3.82003713e+03
 6.25662510e+01 5.13345262e+02 7.40779945e+00 3.56529864e+01
 2.05319923e+01 1.27503839e+02 7.77140093e-01 2.12867096e+00
 2.83910526e+00 1.07513069e+01 2.24209926e-01 4.50093702e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982778382400685
cond(S) = 95798.07014596857
E1 = -729.3762614472771  E_coul = 203.11993583623823
init E= -526.256325611039
    CPU time for initialize scf      0.64 sec, wall time      0.05 sec
  HOMO = -0.556986785194701  LUMO = 1.03868560382289
  mo_energy =
[-1.18335207e+02 -1.22079071e+01 -9.45175946e+00 -9.45175946e+00
 -9.45175946e+00 -1.22609659e+00 -5.56986785e-01 -5.56986785e-01
 -5.56986785e-01  1.03868560e+00  1.03868560e+00  1.03868560e+00
  7.42483336e+00  7.42483336e+00  7.42483336e+00  1.00779601e+01
  3.39969413e+01  3.39969413e+01  3.39969413e+01  1.16330200e+02
  1.31137175e+02  1.31137175e+02  1.31137175e+02  4.85574891e+02
  4.85574891e+02  4.85574891e+02  6.53060094e+02  1.33236519e+03
  1.33236519e+03  1.33236519e+03  2.79245297e+03  3.01931153e+03
  3.01931153e+03  3.01931153e+03  6.63478748e+03  6.63478748e+03
  6.63478748e+03  9.21188662e+03  2.55594286e+04  7.62902075e+04]
E1 = -727.9918529524653  E_coul = 201.28293889121355
cycle= 1 E= -526.708914061252  delta_E= -0.453  |g|= 0.183  |ddm|= 0.408
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.538188
diis-c [-0.28964633  1.        ]
  HOMO = -0.58112048023254  LUMO = 1.0227806430614
  mo_energy =
[-1.18627126e+02 -1.23310421e+01 -9.58491780e+00 -9.58491780e+00
 -9.58491780e+00 -1.25708502e+00 -5.81120480e-01 -5.81120480e-01
 -5.81120480e-01  1.02278064e+00  1.02278064e+00  1.02278064e+00
  7.34905788e+00  7.34905788e+00  7.34905788e+00  9.98723890e+00
  3.38573103e+01  3.38573103e+01  3.38573103e+01  1.16116985e+02
  1.30923832e+02  1.30923832e+02  1.30923832e+02  4.85284858e+02
  4.85284858e+02  4.85284858e+02  6.52723706e+02  1.33201978e+03
  1.33201978e+03  1.33201978e+03  2.79197283e+03  3.01890053e+03
  3.01890053e+03  3.01890053e+03  6.63426444e+03  6.63426444e+03
  6.63426444e+03  9.21128996e+03  2.55587382e+04  7.62894274e+04]
E1 = -728.4520541464373  E_coul = 201.74255425641445
cycle= 2 E= -526.709499890023  delta_E= -0.000586  |g|= 0.0333  |ddm|= 0.0385
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0665682
diis-c [-0.00265324  0.07296842  0.92703158]
  HOMO = -0.574458553927185  LUMO = 1.02784281492894
  mo_energy =
[-1.18568789e+02 -1.23004333e+01 -9.55301425e+00 -9.55301425e+00
 -9.55301425e+00 -1.24862601e+00 -5.74458554e-01 -5.74458554e-01
 -5.74458554e-01  1.02784281e+00  1.02784281e+00  1.02784281e+00
  7.36750650e+00  7.36750650e+00  7.36750650e+00  1.00117087e+01
  3.38900251e+01  3.38900251e+01  3.38900251e+01  1.16165605e+02
  1.30971188e+02  1.30971188e+02  1.30971188e+02  4.85342410e+02
  4.85342410e+02  4.85342410e+02  6.52784033e+02  1.33208113e+03
  1.33208113e+03  1.33208113e+03  2.79203727e+03  3.01896396e+03
  3.01896396e+03  3.01896396e+03  6.63432944e+03  6.63432944e+03
  6.63432944e+03  9.21135566e+03  2.55588044e+04  7.62894938e+04]
E1 = -728.3480373351932  E_coul = 201.6385032852599
cycle= 3 E= -526.709534049933  delta_E= -3.42e-05  |g|= 0.0048  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104139
diis-c [-4.27483589e-07 -1.10581852e-03  1.30721152e-01  8.70384666e-01]
  HOMO = -0.575372925948764  LUMO = 1.02715891630791
  mo_energy =
[-1.18576313e+02 -1.23044497e+01 -9.55730061e+00 -9.55730061e+00
 -9.55730061e+00 -1.24973588e+00 -5.75372926e-01 -5.75372926e-01
 -5.75372926e-01  1.02715892e+00  1.02715892e+00  1.02715892e+00
  7.36500359e+00  7.36500359e+00  7.36500359e+00  1.00085848e+01
  3.38856625e+01  3.38856625e+01  3.38856625e+01  1.16159340e+02
  1.30965028e+02  1.30965028e+02  1.30965028e+02  4.85334987e+02
  4.85334987e+02  4.85334987e+02  6.52776217e+02  1.33207319e+03
  1.33207319e+03  1.33207319e+03  2.79202876e+03  3.01895567e+03
  3.01895567e+03  3.01895567e+03  6.63432080e+03  6.63432080e+03
  6.63432080e+03  9.21134683e+03  2.55587954e+04  7.62894847e+04]
E1 = -728.3621275932666  E_coul = 201.65259271503044
cycle= 4 E= -526.709534878236  delta_E= -8.28e-07  |g|= 5.9e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122574
diis-c [-1.29924821e-09  6.41144027e-05 -9.01281471e-03 -7.07152032e-02
  1.07966390e+00]
  HOMO = -0.575361084676339  LUMO = 1.02716774443445
  mo_energy =
[-1.18576317e+02 -1.23044213e+01 -9.55728373e+00 -9.55728373e+00
 -9.55728373e+00 -1.24971713e+00 -5.75361085e-01 -5.75361085e-01
 -5.75361085e-01  1.02716774e+00  1.02716774e+00  1.02716774e+00
  7.36502376e+00  7.36502376e+00  7.36502376e+00  1.00086196e+01
  3.38856780e+01  3.38856780e+01  3.38856780e+01  1.16159350e+02
  1.30965035e+02  1.30965035e+02  1.30965035e+02  4.85334983e+02
  4.85334983e+02  4.85334983e+02  6.52776205e+02  1.33207318e+03
  1.33207318e+03  1.33207318e+03  2.79202873e+03  3.01895565e+03
  3.01895565e+03  3.01895565e+03  6.63432077e+03  6.63432077e+03
  6.63432077e+03  9.21134679e+03  2.55587954e+04  7.62894846e+04]
E1 = -728.362126383203  E_coul = 201.65259150485852
cycle= 5 E= -526.709534878344  delta_E= -1.08e-10  |g|= 7.69e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.362126383203  E_coul = 201.65259150485852
  HOMO = -0.575364503144267  LUMO = 1.02716522988812
  mo_energy =
[-1.18576334e+02 -1.23044334e+01 -9.55729637e+00 -9.55729637e+00
 -9.55729637e+00 -1.24972134e+00 -5.75364503e-01 -5.75364503e-01
 -5.75364503e-01  1.02716523e+00  1.02716523e+00  1.02716523e+00
  7.36501542e+00  7.36501542e+00  7.36501542e+00  1.00086098e+01
  3.38856655e+01  3.38856655e+01  3.38856655e+01  1.16159335e+02
  1.30965020e+02  1.30965020e+02  1.30965020e+02  4.85334966e+02
  4.85334966e+02  4.85334966e+02  6.52776188e+02  1.33207316e+03
  1.33207316e+03  1.33207316e+03  2.79202871e+03  3.01895563e+03
  3.01895563e+03  3.01895563e+03  6.63432075e+03  6.63432075e+03
  6.63432075e+03  9.21134677e+03  2.55587954e+04  7.62894846e+04]
E1 = -728.3621641495513  E_coul = 201.65262927120418
Extra cycle  E= -526.709534878347  delta_E= -2.61e-12  |g|= 2.26e-06  |ddm|= 3.91e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 95798.07014596857
E1 = -728.3621641495513  E_coul = 201.65262927120418
init E= -526.709534878347
    CPU time for initialize scf      3.94 sec, wall time      0.23 sec
  HOMO = -0.575363813590599  LUMO = 1.0271657431497
  mo_energy =
[-1.18576330e+02 -1.23044306e+01 -9.55729351e+00 -9.55729351e+00
 -9.55729351e+00 -1.24972048e+00 -5.75363814e-01 -5.75363814e-01
 -5.75363814e-01  1.02716574e+00  1.02716574e+00  1.02716574e+00
  7.36501719e+00  7.36501719e+00  7.36501719e+00  1.00086120e+01
  3.38856684e+01  3.38856684e+01  3.38856684e+01  1.16159339e+02
  1.30965023e+02  1.30965023e+02  1.30965023e+02  4.85334971e+02
  4.85334971e+02  4.85334971e+02  6.52776193e+02  1.33207316e+03
  1.33207316e+03  1.33207316e+03  2.79202871e+03  3.01895564e+03
  3.01895564e+03  3.01895564e+03  6.63432075e+03  6.63432075e+03
  6.63432075e+03  9.21134678e+03  2.55587954e+04  7.62894846e+04]
E1 = -728.3621551965834  E_coul = 201.65262031823636
cycle= 1 E= -526.709534878347  delta_E=    0  |g|= 5.81e-07  |ddm|= 8.9e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3621551965834  E_coul = 201.65262031823636
  HOMO = -0.575363965656406  LUMO = 1.02716562930456
  mo_energy =
[-1.18576331e+02 -1.23044313e+01 -9.55729419e+00 -9.55729419e+00
 -9.55729419e+00 -1.24972067e+00 -5.75363966e-01 -5.75363966e-01
 -5.75363966e-01  1.02716563e+00  1.02716563e+00  1.02716563e+00
  7.36501678e+00  7.36501678e+00  7.36501678e+00  1.00086115e+01
  3.38856677e+01  3.38856677e+01  3.38856677e+01  1.16159338e+02
  1.30965022e+02  1.30965022e+02  1.30965022e+02  4.85334969e+02
  4.85334969e+02  4.85334969e+02  6.52776191e+02  1.33207316e+03
  1.33207316e+03  1.33207316e+03  2.79202871e+03  3.01895564e+03
  3.01895564e+03  3.01895564e+03  6.63432075e+03  6.63432075e+03
  6.63432075e+03  9.21134678e+03  2.55587954e+04  7.62894846e+04]
E1 = -728.3621573728142  E_coul = 201.65262249446602
Extra cycle  E= -526.709534878348  delta_E= -1.14e-12  |g|= 1.45e-07  |ddm|= 2.08e-07
    CPU time for scf_cycle      4.06 sec, wall time      0.35 sec
exp = [2.61828398e+04 7.61709560e+03 3.61751917e+03 1.58834871e+03
 4.15298193e+02 1.21009161e+02 3.88457357e+01 8.08043942e+00
 3.16600963e+00 3.98343113e-01 1.36284446e+03 6.64155828e+02
 2.98185312e+02 3.11649586e+02 6.25662510e+01 7.40779945e+00
 2.05319923e+01 7.77140093e-01 2.83910526e+00 2.24209926e-01]
grad_E = [-1.40372813e-06  2.21313846e-06 -2.12648997e-06  3.82685987e-05
  2.19570575e-05 -5.37546879e-05  7.49236026e-05  1.08530025e-04
 -1.07944669e-05 -2.12697003e-03 -5.72821483e-07  4.28577577e-06
  1.98054840e-05  1.69222560e-05  3.30156429e-05 -1.39185599e-03
  3.94672803e-04 -5.64624178e-04  1.26742214e-03  5.65988174e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:01:57 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.849289         1
[INPUT] 0    0    [1    /1   ]  7617.07966934        1
[INPUT] 0    0    [1    /1   ]  3617.53285263        1
[INPUT] 0    0    [1    /1   ]  1588.05807041        1
[INPUT] 0    0    [1    /1   ]  415.453982266        1
[INPUT] 0    0    [1    /1   ]  121.023505925        1
[INPUT] 0    0    [1    /1   ]  38.8505167622        1
[INPUT] 0    0    [1    /1   ]  8.09022891878        1
[INPUT] 0    0    [1    /1   ]  3.1686514277         1
[INPUT] 0    0    [1    /1   ]  0.398279020813       1
[INPUT] 1    0    [1    /1   ]  1362.84831336        1
[INPUT] 1    0    [1    /1   ]  664.127717567        1
[INPUT] 1    0    [1    /1   ]  298.056111908        1
[INPUT] 1    0    [1    /1   ]  311.539089309        1
[INPUT] 1    0    [1    /1   ]  62.1594805348        1
[INPUT] 1    0    [1    /1   ]  7.35337302061        1
[INPUT] 1    0    [1    /1   ]  20.3860281602        1
[INPUT] 1    0    [1    /1   ]  0.775368341459       1
[INPUT] 1    0    [1    /1   ]  2.82199034743        1
[INPUT] 1    0    [1    /1   ]  0.223949264048       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.849288957692, 1.0]], [0, [7617.079669340106, 1.0]], [0, [3617.5328526327025, 1.0]], [0, [1588.0580704098986, 1.0]], [0, [415.45398226590004, 1.0]], [0, [121.02350592453455, 1.0]], [0, [38.85051676219352, 1.0]], [0, [8.090228918775441, 1.0]], [0, [3.1686514277041846, 1.0]], [0, [0.3982790208126096, 1.0]], [1, [1362.848313361937, 1.0]], [1, [664.127717567137, 1.0]], [1, [298.05611190797873, 1.0]], [1, [311.53908930935125, 1.0]], [1, [62.15948053482102, 1.0]], [1, [7.353373020608571, 1.0]], [1, [20.386028160208042, 1.0]], [1, [0.7753683414588186, 1.0]], [1, [2.821990347426027, 1.0]], [1, [0.22394926404784737, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.84928896]
bas 1, expnt(s) = [7617.07966934]
bas 2, expnt(s) = [3617.53285263]
bas 3, expnt(s) = [1588.05807041]
bas 4, expnt(s) = [415.45398227]
bas 5, expnt(s) = [121.02350592]
bas 6, expnt(s) = [38.85051676]
bas 7, expnt(s) = [8.09022892]
bas 8, expnt(s) = [3.16865143]
bas 9, expnt(s) = [0.39827902]
bas 10, expnt(s) = [1362.84831336]
bas 11, expnt(s) = [664.12771757]
bas 12, expnt(s) = [298.05611191]
bas 13, expnt(s) = [311.53908931]
bas 14, expnt(s) = [62.15948053]
bas 15, expnt(s) = [7.35337302]
bas 16, expnt(s) = [20.38602816]
bas 17, expnt(s) = [0.77536834]
bas 18, expnt(s) = [2.82199035]
bas 19, expnt(s) = [0.22394926]
CPU time:      1731.93
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828493e+04 5.20029168e+03 7.61707967e+03 2.05994867e+03
 3.61753285e+03 1.17848589e+03 1.58805807e+03 6.35572077e+02
 4.15453982e+02 2.32491575e+02 1.21023506e+02 9.21864989e+01
 3.88505168e+01 3.93153933e+01 8.09022892e+00 1.21195259e+01
 3.16865143e+00 6.00027112e+00 3.98279021e-01 1.26664700e+00
 1.36284831e+03 2.41570442e+04 6.64127718e+02 9.83555565e+03
 2.98056112e+02 3.61290825e+03 3.11539089e+02 3.81834420e+03
 6.21594805e+01 5.09176807e+02 7.35337302e+00 3.53258515e+01
 2.03860282e+01 1.26371799e+02 7.75368341e-01 2.12260642e+00
 2.82199035e+00 1.06703533e+01 2.23949264e-01 4.49439710e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98283741099085
cond(S) = 94756.7965524858
E1 = -729.3755331934667  E_coul = 203.1193877594296
init E= -526.256145434037
    CPU time for initialize scf      0.65 sec, wall time      0.05 sec
  HOMO = -0.55702253319865  LUMO = 1.03606653986192
  mo_energy =
[-1.18335271e+02 -1.22079357e+01 -9.45178345e+00 -9.45178345e+00
 -9.45178345e+00 -1.22610886e+00 -5.57022533e-01 -5.57022533e-01
 -5.57022533e-01  1.03606654e+00  1.03606654e+00  1.03606654e+00
  7.37240702e+00  7.37240702e+00  7.37240702e+00  1.00956268e+01
  3.37045730e+01  3.37045730e+01  3.37045730e+01  1.16396653e+02
  1.30103622e+02  1.30103622e+02  1.30103622e+02  4.83647997e+02
  4.83647997e+02  4.83647997e+02  6.53262229e+02  1.32999228e+03
  1.32999228e+03  1.32999228e+03  2.79278659e+03  3.01660610e+03
  3.01660610e+03  3.01660610e+03  6.63198392e+03  6.63198392e+03
  6.63198392e+03  9.21193060e+03  2.55591654e+04  7.62898128e+04]
E1 = -727.9917218432647  E_coul = 201.2827855723215
cycle= 1 E= -526.708936270943  delta_E= -0.453  |g|= 0.183  |ddm|= 0.407
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.538043
diis-c [-0.28949056  1.        ]
  HOMO = -0.581154269112795  LUMO = 1.02022505400376
  mo_energy =
[-1.18627177e+02 -1.23310338e+01 -9.58489910e+00 -9.58489910e+00
 -9.58489910e+00 -1.25708480e+00 -5.81154269e-01 -5.81154269e-01
 -5.81154269e-01  1.02022505e+00  1.02022505e+00  1.02022505e+00
  7.29705812e+00  7.29705812e+00  7.29705812e+00  1.00048831e+01
  3.35654500e+01  3.35654500e+01  3.35654500e+01  1.16183431e+02
  1.29890689e+02  1.29890689e+02  1.29890689e+02  4.83358001e+02
  4.83358001e+02  4.83358001e+02  6.52925828e+02  1.32964687e+03
  1.32964687e+03  1.32964687e+03  2.79230645e+03  3.01619508e+03
  3.01619508e+03  3.01619508e+03  6.63146086e+03  6.63146086e+03
  6.63146086e+03  9.21133395e+03  2.55584751e+04  7.62890327e+04]
E1 = -728.4519954106405  E_coul = 201.74247318416667
cycle= 2 E= -526.709522226474  delta_E= -0.000586  |g|= 0.0333  |ddm|= 0.0384
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0665597
diis-c [-0.00265317  0.07296659  0.92703341]
  HOMO = -0.574491134672984  LUMO = 1.02527152524721
  mo_energy =
[-1.18568831e+02 -1.23004196e+01 -9.55299066e+00 -9.55299066e+00
 -9.55299066e+00 -1.24862445e+00 -5.74491135e-01 -5.74491135e-01
 -5.74491135e-01  1.02527153e+00  1.02527153e+00  1.02527153e+00
  7.31542326e+00  7.31542326e+00  7.31542326e+00  1.00293758e+01
  3.35980662e+01  3.35980662e+01  3.35980662e+01  1.16232061e+02
  1.29937985e+02  1.29937985e+02  1.29937985e+02  4.83415558e+02
  4.83415558e+02  4.83415558e+02  6.52986165e+02  1.32970823e+03
  1.32970823e+03  1.32970823e+03  2.79237091e+03  3.01625852e+03
  3.01625852e+03  3.01625852e+03  6.63152587e+03  6.63152587e+03
  6.63152587e+03  9.21139966e+03  2.55585413e+04  7.62890991e+04]
E1 = -728.3479459912841  E_coul = 201.63838959517747
cycle= 3 E= -526.709556396107  delta_E= -3.42e-05  |g|= 0.0048  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104132
diis-c [-4.27678612e-07 -1.10571775e-03  1.30730964e-01  8.70374753e-01]
  HOMO = -0.575406138378367  LUMO = 1.02458942418567
  mo_energy =
[-1.18576357e+02 -1.23044377e+01 -9.55727867e+00 -9.55727867e+00
 -9.55727867e+00 -1.24973506e+00 -5.75406138e-01 -5.75406138e-01
 -5.75406138e-01  1.02458942e+00  1.02458942e+00  1.02458942e+00
  7.31293080e+00  7.31293080e+00  7.31293080e+00  1.00262482e+01
  3.35937149e+01  3.35937149e+01  3.35937149e+01  1.16225794e+02
  1.29931831e+02  1.29931831e+02  1.29931831e+02  4.83408133e+02
  4.83408133e+02  4.83408133e+02  6.52978347e+02  1.32970029e+03
  1.32970029e+03  1.32970029e+03  2.79236239e+03  3.01625023e+03
  3.01625023e+03  3.01625023e+03  6.63151723e+03  6.63151723e+03
  6.63151723e+03  9.21139083e+03  2.55585323e+04  7.62890900e+04]
E1 = -728.3620442183675  E_coul = 201.65248699334913
cycle= 4 E= -526.709557225018  delta_E= -8.29e-07  |g|= 5.89e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122381
diis-c [-1.30982227e-09  6.40867529e-05 -9.00815893e-03 -7.06530409e-02
  1.07959711e+00]
  HOMO = -0.575394243229717  LUMO = 1.02459826859481
  mo_energy =
[-1.18576361e+02 -1.23044091e+01 -9.55726159e+00 -9.55726159e+00
 -9.55726159e+00 -1.24971625e+00 -5.75394243e-01 -5.75394243e-01
 -5.75394243e-01  1.02459827e+00  1.02459827e+00  1.02459827e+00
  7.31295111e+00  7.31295111e+00  7.31295111e+00  1.00262832e+01
  3.35937307e+01  3.35937307e+01  3.35937307e+01  1.16225804e+02
  1.29931838e+02  1.29931838e+02  1.29931838e+02  4.83408130e+02
  4.83408130e+02  4.83408130e+02  6.52978335e+02  1.32970028e+03
  1.32970028e+03  1.32970028e+03  2.79236236e+03  3.01625021e+03
  3.01625021e+03  3.01625021e+03  6.63151719e+03  6.63151719e+03
  6.63151719e+03  9.21139079e+03  2.55585322e+04  7.62890900e+04]
E1 = -728.3620424746011  E_coul = 201.65248524947765
cycle= 5 E= -526.709557225123  delta_E= -1.05e-10  |g|= 7.71e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3620424746011  E_coul = 201.65248524947765
  HOMO = -0.575397670878706  LUMO = 1.02459575531743
  mo_energy =
[-1.18576379e+02 -1.23044212e+01 -9.55727427e+00 -9.55727427e+00
 -9.55727427e+00 -1.24972047e+00 -5.75397671e-01 -5.75397671e-01
 -5.75397671e-01  1.02459576e+00  1.02459576e+00  1.02459576e+00
  7.31294277e+00  7.31294277e+00  7.31294277e+00  1.00262733e+01
  3.35937183e+01  3.35937183e+01  3.35937183e+01  1.16225788e+02
  1.29931823e+02  1.29931823e+02  1.29931823e+02  4.83408113e+02
  4.83408113e+02  4.83408113e+02  6.52978318e+02  1.32970026e+03
  1.32970026e+03  1.32970026e+03  2.79236234e+03  3.01625019e+03
  3.01625019e+03  3.01625019e+03  6.63151718e+03  6.63151718e+03
  6.63151718e+03  9.21139077e+03  2.55585322e+04  7.62890899e+04]
E1 = -728.3620803458036  E_coul = 201.65252312067466
Extra cycle  E= -526.709557225129  delta_E= -5.46e-12  |g|= 2.27e-06  |ddm|= 3.92e-06
    CPU time for scf_cycle      0.84 sec, wall time      0.23 sec
exp = [2.61828493e+04 7.61707967e+03 3.61753285e+03 1.58805807e+03
 4.15453982e+02 1.21023506e+02 3.88505168e+01 8.09022892e+00
 3.16865143e+00 3.98279021e-01 1.36284831e+03 6.64127718e+02
 2.98056112e+02 3.11539089e+02 6.21594805e+01 7.35337302e+00
 2.03860282e+01 7.75368341e-01 2.82199035e+00 2.23949264e-01]
E = -526.709557225129
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:01:57 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.849289         1
[INPUT] 0    0    [1    /1   ]  7617.07966934        1
[INPUT] 0    0    [1    /1   ]  3617.53285263        1
[INPUT] 0    0    [1    /1   ]  1588.05807041        1
[INPUT] 0    0    [1    /1   ]  415.453982266        1
[INPUT] 0    0    [1    /1   ]  121.023505925        1
[INPUT] 0    0    [1    /1   ]  38.8505167622        1
[INPUT] 0    0    [1    /1   ]  8.09022891878        1
[INPUT] 0    0    [1    /1   ]  3.1686514277         1
[INPUT] 0    0    [1    /1   ]  0.398279020813       1
[INPUT] 1    0    [1    /1   ]  1362.84831336        1
[INPUT] 1    0    [1    /1   ]  664.127717567        1
[INPUT] 1    0    [1    /1   ]  298.056111908        1
[INPUT] 1    0    [1    /1   ]  311.539089309        1
[INPUT] 1    0    [1    /1   ]  62.1594805348        1
[INPUT] 1    0    [1    /1   ]  7.35337302061        1
[INPUT] 1    0    [1    /1   ]  20.3860281602        1
[INPUT] 1    0    [1    /1   ]  0.775368341459       1
[INPUT] 1    0    [1    /1   ]  2.82199034743        1
[INPUT] 1    0    [1    /1   ]  0.223949264048       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.849288957692, 1.0]], [0, [7617.079669340106, 1.0]], [0, [3617.5328526327025, 1.0]], [0, [1588.0580704098986, 1.0]], [0, [415.45398226590004, 1.0]], [0, [121.02350592453455, 1.0]], [0, [38.85051676219352, 1.0]], [0, [8.090228918775441, 1.0]], [0, [3.1686514277041846, 1.0]], [0, [0.3982790208126096, 1.0]], [1, [1362.848313361937, 1.0]], [1, [664.127717567137, 1.0]], [1, [298.05611190797873, 1.0]], [1, [311.53908930935125, 1.0]], [1, [62.15948053482102, 1.0]], [1, [7.353373020608571, 1.0]], [1, [20.386028160208042, 1.0]], [1, [0.7753683414588186, 1.0]], [1, [2.821990347426027, 1.0]], [1, [0.22394926404784737, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.84928896]
bas 1, expnt(s) = [7617.07966934]
bas 2, expnt(s) = [3617.53285263]
bas 3, expnt(s) = [1588.05807041]
bas 4, expnt(s) = [415.45398227]
bas 5, expnt(s) = [121.02350592]
bas 6, expnt(s) = [38.85051676]
bas 7, expnt(s) = [8.09022892]
bas 8, expnt(s) = [3.16865143]
bas 9, expnt(s) = [0.39827902]
bas 10, expnt(s) = [1362.84831336]
bas 11, expnt(s) = [664.12771757]
bas 12, expnt(s) = [298.05611191]
bas 13, expnt(s) = [311.53908931]
bas 14, expnt(s) = [62.15948053]
bas 15, expnt(s) = [7.35337302]
bas 16, expnt(s) = [20.38602816]
bas 17, expnt(s) = [0.77536834]
bas 18, expnt(s) = [2.82199035]
bas 19, expnt(s) = [0.22394926]
CPU time:      1733.05
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828493e+04 5.20029168e+03 7.61707967e+03 2.05994867e+03
 3.61753285e+03 1.17848589e+03 1.58805807e+03 6.35572077e+02
 4.15453982e+02 2.32491575e+02 1.21023506e+02 9.21864989e+01
 3.88505168e+01 3.93153933e+01 8.09022892e+00 1.21195259e+01
 3.16865143e+00 6.00027112e+00 3.98279021e-01 1.26664700e+00
 1.36284831e+03 2.41570442e+04 6.64127718e+02 9.83555565e+03
 2.98056112e+02 3.61290825e+03 3.11539089e+02 3.81834420e+03
 6.21594805e+01 5.09176807e+02 7.35337302e+00 3.53258515e+01
 2.03860282e+01 1.26371799e+02 7.75368341e-01 2.12260642e+00
 2.82199035e+00 1.06703533e+01 2.23949264e-01 4.49439710e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98283741099085
cond(S) = 94756.7965524858
E1 = -729.3755331934667  E_coul = 203.1193877594296
init E= -526.256145434037
    CPU time for initialize scf      0.63 sec, wall time      0.05 sec
  HOMO = -0.55702253319865  LUMO = 1.03606653986192
  mo_energy =
[-1.18335271e+02 -1.22079357e+01 -9.45178345e+00 -9.45178345e+00
 -9.45178345e+00 -1.22610886e+00 -5.57022533e-01 -5.57022533e-01
 -5.57022533e-01  1.03606654e+00  1.03606654e+00  1.03606654e+00
  7.37240702e+00  7.37240702e+00  7.37240702e+00  1.00956268e+01
  3.37045730e+01  3.37045730e+01  3.37045730e+01  1.16396653e+02
  1.30103622e+02  1.30103622e+02  1.30103622e+02  4.83647997e+02
  4.83647997e+02  4.83647997e+02  6.53262229e+02  1.32999228e+03
  1.32999228e+03  1.32999228e+03  2.79278659e+03  3.01660610e+03
  3.01660610e+03  3.01660610e+03  6.63198392e+03  6.63198392e+03
  6.63198392e+03  9.21193060e+03  2.55591654e+04  7.62898128e+04]
E1 = -727.9917218432647  E_coul = 201.2827855723215
cycle= 1 E= -526.708936270943  delta_E= -0.453  |g|= 0.183  |ddm|= 0.407
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.538043
diis-c [-0.28949056  1.        ]
  HOMO = -0.581154269112795  LUMO = 1.02022505400376
  mo_energy =
[-1.18627177e+02 -1.23310338e+01 -9.58489910e+00 -9.58489910e+00
 -9.58489910e+00 -1.25708480e+00 -5.81154269e-01 -5.81154269e-01
 -5.81154269e-01  1.02022505e+00  1.02022505e+00  1.02022505e+00
  7.29705812e+00  7.29705812e+00  7.29705812e+00  1.00048831e+01
  3.35654500e+01  3.35654500e+01  3.35654500e+01  1.16183431e+02
  1.29890689e+02  1.29890689e+02  1.29890689e+02  4.83358001e+02
  4.83358001e+02  4.83358001e+02  6.52925828e+02  1.32964687e+03
  1.32964687e+03  1.32964687e+03  2.79230645e+03  3.01619508e+03
  3.01619508e+03  3.01619508e+03  6.63146086e+03  6.63146086e+03
  6.63146086e+03  9.21133395e+03  2.55584751e+04  7.62890327e+04]
E1 = -728.4519954106405  E_coul = 201.74247318416667
cycle= 2 E= -526.709522226474  delta_E= -0.000586  |g|= 0.0333  |ddm|= 0.0384
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0665597
diis-c [-0.00265317  0.07296659  0.92703341]
  HOMO = -0.574491134672984  LUMO = 1.02527152524721
  mo_energy =
[-1.18568831e+02 -1.23004196e+01 -9.55299066e+00 -9.55299066e+00
 -9.55299066e+00 -1.24862445e+00 -5.74491135e-01 -5.74491135e-01
 -5.74491135e-01  1.02527153e+00  1.02527153e+00  1.02527153e+00
  7.31542326e+00  7.31542326e+00  7.31542326e+00  1.00293758e+01
  3.35980662e+01  3.35980662e+01  3.35980662e+01  1.16232061e+02
  1.29937985e+02  1.29937985e+02  1.29937985e+02  4.83415558e+02
  4.83415558e+02  4.83415558e+02  6.52986165e+02  1.32970823e+03
  1.32970823e+03  1.32970823e+03  2.79237091e+03  3.01625852e+03
  3.01625852e+03  3.01625852e+03  6.63152587e+03  6.63152587e+03
  6.63152587e+03  9.21139966e+03  2.55585413e+04  7.62890991e+04]
E1 = -728.3479459912841  E_coul = 201.63838959517747
cycle= 3 E= -526.709556396107  delta_E= -3.42e-05  |g|= 0.0048  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104132
diis-c [-4.27678612e-07 -1.10571775e-03  1.30730964e-01  8.70374753e-01]
  HOMO = -0.575406138378367  LUMO = 1.02458942418567
  mo_energy =
[-1.18576357e+02 -1.23044377e+01 -9.55727867e+00 -9.55727867e+00
 -9.55727867e+00 -1.24973506e+00 -5.75406138e-01 -5.75406138e-01
 -5.75406138e-01  1.02458942e+00  1.02458942e+00  1.02458942e+00
  7.31293080e+00  7.31293080e+00  7.31293080e+00  1.00262482e+01
  3.35937149e+01  3.35937149e+01  3.35937149e+01  1.16225794e+02
  1.29931831e+02  1.29931831e+02  1.29931831e+02  4.83408133e+02
  4.83408133e+02  4.83408133e+02  6.52978347e+02  1.32970029e+03
  1.32970029e+03  1.32970029e+03  2.79236239e+03  3.01625023e+03
  3.01625023e+03  3.01625023e+03  6.63151723e+03  6.63151723e+03
  6.63151723e+03  9.21139083e+03  2.55585323e+04  7.62890900e+04]
E1 = -728.3620442183675  E_coul = 201.65248699334913
cycle= 4 E= -526.709557225018  delta_E= -8.29e-07  |g|= 5.89e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122381
diis-c [-1.30982227e-09  6.40867529e-05 -9.00815893e-03 -7.06530409e-02
  1.07959711e+00]
  HOMO = -0.575394243229717  LUMO = 1.02459826859481
  mo_energy =
[-1.18576361e+02 -1.23044091e+01 -9.55726159e+00 -9.55726159e+00
 -9.55726159e+00 -1.24971625e+00 -5.75394243e-01 -5.75394243e-01
 -5.75394243e-01  1.02459827e+00  1.02459827e+00  1.02459827e+00
  7.31295111e+00  7.31295111e+00  7.31295111e+00  1.00262832e+01
  3.35937307e+01  3.35937307e+01  3.35937307e+01  1.16225804e+02
  1.29931838e+02  1.29931838e+02  1.29931838e+02  4.83408130e+02
  4.83408130e+02  4.83408130e+02  6.52978335e+02  1.32970028e+03
  1.32970028e+03  1.32970028e+03  2.79236236e+03  3.01625021e+03
  3.01625021e+03  3.01625021e+03  6.63151719e+03  6.63151719e+03
  6.63151719e+03  9.21139079e+03  2.55585322e+04  7.62890900e+04]
E1 = -728.3620424746011  E_coul = 201.65248524947765
cycle= 5 E= -526.709557225123  delta_E= -1.05e-10  |g|= 7.71e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3620424746011  E_coul = 201.65248524947765
  HOMO = -0.575397670878706  LUMO = 1.02459575531743
  mo_energy =
[-1.18576379e+02 -1.23044212e+01 -9.55727427e+00 -9.55727427e+00
 -9.55727427e+00 -1.24972047e+00 -5.75397671e-01 -5.75397671e-01
 -5.75397671e-01  1.02459576e+00  1.02459576e+00  1.02459576e+00
  7.31294277e+00  7.31294277e+00  7.31294277e+00  1.00262733e+01
  3.35937183e+01  3.35937183e+01  3.35937183e+01  1.16225788e+02
  1.29931823e+02  1.29931823e+02  1.29931823e+02  4.83408113e+02
  4.83408113e+02  4.83408113e+02  6.52978318e+02  1.32970026e+03
  1.32970026e+03  1.32970026e+03  2.79236234e+03  3.01625019e+03
  3.01625019e+03  3.01625019e+03  6.63151718e+03  6.63151718e+03
  6.63151718e+03  9.21139077e+03  2.55585322e+04  7.62890899e+04]
E1 = -728.3620803458036  E_coul = 201.65252312067466
Extra cycle  E= -526.709557225129  delta_E= -5.46e-12  |g|= 2.27e-06  |ddm|= 3.92e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 94756.7965524858
E1 = -728.3620803458036  E_coul = 201.65252312067466
init E= -526.709557225129
    CPU time for initialize scf      3.89 sec, wall time      0.21 sec
  HOMO = -0.575396979244146  LUMO = 1.02459626847063
  mo_energy =
[-1.18576374e+02 -1.23044184e+01 -9.55727139e+00 -9.55727139e+00
 -9.55727139e+00 -1.24971960e+00 -5.75396979e-01 -5.75396979e-01
 -5.75396979e-01  1.02459627e+00  1.02459627e+00  1.02459627e+00
  7.31294454e+00  7.31294454e+00  7.31294454e+00  1.00262756e+01
  3.35937211e+01  3.35937211e+01  3.35937211e+01  1.16225792e+02
  1.29931827e+02  1.29931827e+02  1.29931827e+02  4.83408117e+02
  4.83408117e+02  4.83408117e+02  6.52978323e+02  1.32970026e+03
  1.32970026e+03  1.32970026e+03  2.79236234e+03  3.01625020e+03
  3.01625020e+03  3.01625020e+03  6.63151718e+03  6.63151718e+03
  6.63151718e+03  9.21139077e+03  2.55585322e+04  7.62890899e+04]
E1 = -728.3620713666791  E_coul = 201.65251414155026
cycle= 1 E= -526.709557225129  delta_E= 1.14e-13  |g|= 5.82e-07  |ddm|= 8.92e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3620713666791  E_coul = 201.65251414155026
  HOMO = -0.575397131786788  LUMO = 1.0245961546428
  mo_energy =
[-1.18576375e+02 -1.23044191e+01 -9.55727207e+00 -9.55727207e+00
 -9.55727207e+00 -1.24971979e+00 -5.75397132e-01 -5.75397132e-01
 -5.75397132e-01  1.02459615e+00  1.02459615e+00  1.02459615e+00
  7.31294414e+00  7.31294414e+00  7.31294414e+00  1.00262751e+01
  3.35937204e+01  3.35937204e+01  3.35937204e+01  1.16225791e+02
  1.29931826e+02  1.29931826e+02  1.29931826e+02  4.83408116e+02
  4.83408116e+02  4.83408116e+02  6.52978322e+02  1.32970026e+03
  1.32970026e+03  1.32970026e+03  2.79236234e+03  3.01625020e+03
  3.01625020e+03  3.01625020e+03  6.63151718e+03  6.63151718e+03
  6.63151718e+03  9.21139077e+03  2.55585322e+04  7.62890899e+04]
E1 = -728.3620735495714  E_coul = 201.65251632444273
Extra cycle  E= -526.709557225129  delta_E= 1.14e-13  |g|= 1.46e-07  |ddm|= 2.09e-07
    CPU time for scf_cycle      4.01 sec, wall time      0.33 sec
exp = [2.61828493e+04 7.61707967e+03 3.61753285e+03 1.58805807e+03
 4.15453982e+02 1.21023506e+02 3.88505168e+01 8.09022892e+00
 3.16865143e+00 3.98279021e-01 1.36284831e+03 6.64127718e+02
 2.98056112e+02 3.11539089e+02 6.21594805e+01 7.35337302e+00
 2.03860282e+01 7.75368341e-01 2.82199035e+00 2.23949264e-01]
grad_E = [-1.40237355e-06  2.20184246e-06 -2.12734696e-06  3.79253990e-05
  2.68681272e-05 -7.31170558e-05  1.01160716e-04  1.48986891e-04
 -8.34713580e-06 -2.89245023e-03 -5.57008891e-07  4.51852509e-06
  2.11028885e-05  1.80386063e-05  3.92005060e-06 -1.87561271e-03
  5.17224089e-04 -7.67258269e-04  1.70675085e-03  7.70752941e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:02:02 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.863849         1
[INPUT] 0    0    [1    /1   ]  7617.05545853        1
[INPUT] 0    0    [1    /1   ]  3617.55399187        1
[INPUT] 0    0    [1    /1   ]  1587.61929068        1
[INPUT] 0    0    [1    /1   ]  415.631436034        1
[INPUT] 0    0    [1    /1   ]  121.075563873        1
[INPUT] 0    0    [1    /1   ]  38.8619847375        1
[INPUT] 0    0    [1    /1   ]  8.09277005304        1
[INPUT] 0    0    [1    /1   ]  3.16938581465        1
[INPUT] 0    0    [1    /1   ]  0.398279256663       1
[INPUT] 1    0    [1    /1   ]  1362.85423769        1
[INPUT] 1    0    [1    /1   ]  664.084721554        1
[INPUT] 1    0    [1    /1   ]  297.858626655        1
[INPUT] 1    0    [1    /1   ]  311.370222942        1
[INPUT] 1    0    [1    /1   ]  61.5147010813        1
[INPUT] 1    0    [1    /1   ]  7.28471023323        1
[INPUT] 1    0    [1    /1   ]  20.1718313084        1
[INPUT] 1    0    [1    /1   ]  0.772746006368       1
[INPUT] 1    0    [1    /1   ]  2.80023395392        1
[INPUT] 1    0    [1    /1   ]  0.223417213933       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.863849011806, 1.0]], [0, [7617.0554585341515, 1.0]], [0, [3617.553991871207, 1.0]], [0, [1587.6192906771673, 1.0]], [0, [415.63143603408156, 1.0]], [0, [121.07556387281923, 1.0]], [0, [38.86198473748839, 1.0]], [0, [8.092770053037317, 1.0]], [0, [3.169385814654158, 1.0]], [0, [0.39827925666297426, 1.0]], [1, [1362.8542376878806, 1.0]], [1, [664.0847215541432, 1.0]], [1, [297.8586266545859, 1.0]], [1, [311.37022294170674, 1.0]], [1, [61.514701081298334, 1.0]], [1, [7.28471023322963, 1.0]], [1, [20.17183130844486, 1.0]], [1, [0.7727460063683208, 1.0]], [1, [2.800233953921857, 1.0]], [1, [0.2234172139327753, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.86384901]
bas 1, expnt(s) = [7617.05545853]
bas 2, expnt(s) = [3617.55399187]
bas 3, expnt(s) = [1587.61929068]
bas 4, expnt(s) = [415.63143603]
bas 5, expnt(s) = [121.07556387]
bas 6, expnt(s) = [38.86198474]
bas 7, expnt(s) = [8.09277005]
bas 8, expnt(s) = [3.16938581]
bas 9, expnt(s) = [0.39827926]
bas 10, expnt(s) = [1362.85423769]
bas 11, expnt(s) = [664.08472155]
bas 12, expnt(s) = [297.85862665]
bas 13, expnt(s) = [311.37022294]
bas 14, expnt(s) = [61.51470108]
bas 15, expnt(s) = [7.28471023]
bas 16, expnt(s) = [20.17183131]
bas 17, expnt(s) = [0.77274601]
bas 18, expnt(s) = [2.80023395]
bas 19, expnt(s) = [0.22341721]
CPU time:      1742.71
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828638e+04 5.20029385e+03 7.61705546e+03 2.05994375e+03
 3.61755399e+03 1.17849106e+03 1.58761929e+03 6.35440366e+02
 4.15631436e+02 2.32566049e+02 1.21075564e+02 9.22162377e+01
 3.88619847e+01 3.93240968e+01 8.09277005e+00 1.21223809e+01
 3.16938581e+00 6.00131408e+00 3.98279257e-01 1.26664756e+00
 1.36285424e+03 2.41571755e+04 6.64084722e+02 9.83475971e+03
 2.97858627e+02 3.60991621e+03 3.11370223e+02 3.81575726e+03
 6.15147011e+01 5.02583284e+02 7.28471023e+00 3.49140110e+01
 2.01718313e+01 1.24714242e+02 7.72746006e-01 2.11363676e+00
 2.80023395e+00 1.05676225e+01 2.23417214e-01 4.48105405e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982929695525208
cond(S) = 93180.64289695813
E1 = -729.3755476950364  E_coul = 203.11937787767013
init E= -526.256169817366
    CPU time for initialize scf      0.71 sec, wall time      0.05 sec
  HOMO = -0.557048917999528  LUMO = 1.03164485884376
  mo_energy =
[-1.18335291e+02 -1.22079348e+01 -9.45175943e+00 -9.45175943e+00
 -9.45175943e+00 -1.22610589e+00 -5.57048918e-01 -5.57048918e-01
 -5.57048918e-01  1.03164486e+00  1.03164486e+00  1.03164486e+00
  7.30402982e+00  7.30402982e+00  7.30402982e+00  1.01008119e+01
  3.33146275e+01  3.33146275e+01  3.33146275e+01  1.16454891e+02
  1.28590887e+02  1.28590887e+02  1.28590887e+02  4.80720275e+02
  4.80720275e+02  4.80720275e+02  6.53560791e+02  1.32636666e+03
  1.32636666e+03  1.32636666e+03  2.79321402e+03  3.01246791e+03
  3.01246791e+03  3.01246791e+03  6.62769482e+03  6.62769482e+03
  6.62769482e+03  9.21187345e+03  2.55586337e+04  7.62890865e+04]
E1 = -727.9897190908702  E_coul = 201.28075123908658
cycle= 1 E= -526.708967851784  delta_E= -0.453  |g|= 0.183  |ddm|= 0.406
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.537856
diis-c [-0.28928911  1.        ]
  HOMO = -0.581255623180693  LUMO = 1.01584218628498
  mo_energy =
[-1.18627389e+02 -1.23311634e+01 -9.58500021e+00 -9.58500021e+00
 -9.58500021e+00 -1.25716945e+00 -5.81255623e-01 -5.81255623e-01
 -5.81255623e-01  1.01584219e+00  1.01584219e+00  1.01584219e+00
  7.22907092e+00  7.22907092e+00  7.22907092e+00  1.00099180e+01
  3.31760378e+01  3.31760378e+01  3.31760378e+01  1.16241464e+02
  1.28378412e+02  1.28378412e+02  1.28378412e+02  4.80430138e+02
  4.80430138e+02  4.80430138e+02  6.53224151e+02  1.32602102e+03
  1.32602102e+03  1.32602102e+03  2.79273367e+03  3.01205663e+03
  3.01205663e+03  3.01205663e+03  6.62717152e+03  6.62717152e+03
  6.62717152e+03  9.21127659e+03  2.55579432e+04  7.62883062e+04]
E1 = -728.4506924731442  E_coul = 201.74113768841914
cycle= 2 E= -526.709554784725  delta_E= -0.000587  |g|= 0.0333  |ddm|= 0.0384
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0666038
diis-c [-0.00265638  0.07304149  0.92695851]
  HOMO = -0.574579161777761  LUMO = 1.02087332555522
  mo_energy =
[-1.18568979e+02 -1.23005034e+01 -9.55304494e+00 -9.55304494e+00
 -9.55304494e+00 -1.24869233e+00 -5.74579162e-01 -5.74579162e-01
 -5.74579162e-01  1.02087333e+00  1.02087333e+00  1.02087333e+00
  7.24735583e+00  7.24735583e+00  7.24735583e+00  1.00344541e+01
  3.32085533e+01  3.32085533e+01  3.32085533e+01  1.16290156e+02
  1.28425657e+02  1.28425657e+02  1.28425657e+02  4.80487751e+02
  4.80487751e+02  4.80487751e+02  6.53284555e+02  1.32608245e+03
  1.32608245e+03  1.32608245e+03  2.79279820e+03  3.01212015e+03
  3.01212015e+03  3.01212015e+03  6.62723660e+03  6.62723660e+03
  6.62723660e+03  9.21134237e+03  2.55580094e+04  7.62883727e+04]
E1 = -728.3464280600026  E_coul = 201.6368390004572
cycle= 3 E= -526.709589059545  delta_E= -3.43e-05  |g|= 0.0048  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104212
diis-c [-4.27156898e-07 -1.10533377e-03  1.30749799e-01  8.70355534e-01]
  HOMO = -0.575496524664753  LUMO = 1.02019290301115
  mo_energy =
[-1.18576515e+02 -1.23045288e+01 -9.55734035e+00 -9.55734035e+00
 -9.55734035e+00 -1.24980585e+00 -5.75496525e-01 -5.75496525e-01
 -5.75496525e-01  1.02019290e+00  1.02019290e+00  1.02019290e+00
  7.24487326e+00  7.24487326e+00  7.24487326e+00  1.00313197e+01
  3.32042132e+01  3.32042132e+01  3.32042132e+01  1.16283879e+02
  1.28419507e+02  1.28419507e+02  1.28419507e+02  4.80480317e+02
  4.80480317e+02  4.80480317e+02  6.53276727e+02  1.32607450e+03
  1.32607450e+03  1.32607450e+03  2.79278967e+03  3.01211185e+03
  3.01211185e+03  3.01211185e+03  6.62722795e+03  6.62722795e+03
  6.62722795e+03  9.21133353e+03  2.55580004e+04  7.62883635e+04]
E1 = -728.3605585135498  E_coul = 201.650968622089
cycle= 4 E= -526.709589891461  delta_E= -8.32e-07  |g|= 5.89e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122182
diis-c [-1.32011027e-09  6.40010087e-05 -8.99897215e-03 -7.05493437e-02
  1.07948431e+00]
  HOMO = -0.575484597686374  LUMO = 1.02020173441056
  mo_energy =
[-1.18576519e+02 -1.23045001e+01 -9.55732313e+00 -9.55732313e+00
 -9.55732313e+00 -1.24978700e+00 -5.75484598e-01 -5.75484598e-01
 -5.75484598e-01  1.02020173e+00  1.02020173e+00  1.02020173e+00
  7.24489365e+00  7.24489365e+00  7.24489365e+00  1.00313548e+01
  3.32042292e+01  3.32042292e+01  3.32042292e+01  1.16283889e+02
  1.28419515e+02  1.28419515e+02  1.28419515e+02  4.80480314e+02
  4.80480314e+02  4.80480314e+02  6.53276715e+02  1.32607449e+03
  1.32607449e+03  1.32607449e+03  2.79278964e+03  3.01211183e+03
  3.01211183e+03  3.01211183e+03  6.62722791e+03  6.62722791e+03
  6.62722791e+03  9.21133349e+03  2.55580004e+04  7.62883635e+04]
E1 = -728.3605563223784  E_coul = 201.65096643081102
cycle= 5 E= -526.709589891567  delta_E= -1.07e-10  |g|= 7.73e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3605563223784  E_coul = 201.65096643081102
  HOMO = -0.575488035241703  LUMO = 1.02019922599717
  mo_energy =
[-1.18576537e+02 -1.23045122e+01 -9.55733584e+00 -9.55733584e+00
 -9.55733584e+00 -1.24979124e+00 -5.75488035e-01 -5.75488035e-01
 -5.75488035e-01  1.02019923e+00  1.02019923e+00  1.02019923e+00
  7.24488533e+00  7.24488533e+00  7.24488533e+00  1.00313449e+01
  3.32042167e+01  3.32042167e+01  3.32042167e+01  1.16283873e+02
  1.28419499e+02  1.28419499e+02  1.28419499e+02  4.80480297e+02
  4.80480297e+02  4.80480297e+02  6.53276697e+02  1.32607447e+03
  1.32607447e+03  1.32607447e+03  2.79278962e+03  3.01211181e+03
  3.01211181e+03  3.01211181e+03  6.62722789e+03  6.62722789e+03
  6.62722789e+03  9.21133347e+03  2.55580003e+04  7.62883635e+04]
E1 = -728.360594329352  E_coul = 201.6510044377808
Extra cycle  E= -526.709589891571  delta_E= -3.75e-12  |g|= 2.28e-06  |ddm|= 3.93e-06
    CPU time for scf_cycle      0.91 sec, wall time      0.23 sec
exp = [2.61828638e+04 7.61705546e+03 3.61755399e+03 1.58761929e+03
 4.15631436e+02 1.21075564e+02 3.88619847e+01 8.09277005e+00
 3.16938581e+00 3.98279257e-01 1.36285424e+03 6.64084722e+02
 2.97858627e+02 3.11370223e+02 6.15147011e+01 7.28471023e+00
 2.01718313e+01 7.72746006e-01 2.80023395e+00 2.23417214e-01]
E = -526.7095898915712
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:02:02 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.863849         1
[INPUT] 0    0    [1    /1   ]  7617.05545853        1
[INPUT] 0    0    [1    /1   ]  3617.55399187        1
[INPUT] 0    0    [1    /1   ]  1587.61929068        1
[INPUT] 0    0    [1    /1   ]  415.631436034        1
[INPUT] 0    0    [1    /1   ]  121.075563873        1
[INPUT] 0    0    [1    /1   ]  38.8619847375        1
[INPUT] 0    0    [1    /1   ]  8.09277005304        1
[INPUT] 0    0    [1    /1   ]  3.16938581465        1
[INPUT] 0    0    [1    /1   ]  0.398279256663       1
[INPUT] 1    0    [1    /1   ]  1362.85423769        1
[INPUT] 1    0    [1    /1   ]  664.084721554        1
[INPUT] 1    0    [1    /1   ]  297.858626655        1
[INPUT] 1    0    [1    /1   ]  311.370222942        1
[INPUT] 1    0    [1    /1   ]  61.5147010813        1
[INPUT] 1    0    [1    /1   ]  7.28471023323        1
[INPUT] 1    0    [1    /1   ]  20.1718313084        1
[INPUT] 1    0    [1    /1   ]  0.772746006368       1
[INPUT] 1    0    [1    /1   ]  2.80023395392        1
[INPUT] 1    0    [1    /1   ]  0.223417213933       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.863849011806, 1.0]], [0, [7617.0554585341515, 1.0]], [0, [3617.553991871207, 1.0]], [0, [1587.6192906771673, 1.0]], [0, [415.63143603408156, 1.0]], [0, [121.07556387281923, 1.0]], [0, [38.86198473748839, 1.0]], [0, [8.092770053037317, 1.0]], [0, [3.169385814654158, 1.0]], [0, [0.39827925666297426, 1.0]], [1, [1362.8542376878806, 1.0]], [1, [664.0847215541432, 1.0]], [1, [297.8586266545859, 1.0]], [1, [311.37022294170674, 1.0]], [1, [61.514701081298334, 1.0]], [1, [7.28471023322963, 1.0]], [1, [20.17183130844486, 1.0]], [1, [0.7727460063683208, 1.0]], [1, [2.800233953921857, 1.0]], [1, [0.2234172139327753, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.86384901]
bas 1, expnt(s) = [7617.05545853]
bas 2, expnt(s) = [3617.55399187]
bas 3, expnt(s) = [1587.61929068]
bas 4, expnt(s) = [415.63143603]
bas 5, expnt(s) = [121.07556387]
bas 6, expnt(s) = [38.86198474]
bas 7, expnt(s) = [8.09277005]
bas 8, expnt(s) = [3.16938581]
bas 9, expnt(s) = [0.39827926]
bas 10, expnt(s) = [1362.85423769]
bas 11, expnt(s) = [664.08472155]
bas 12, expnt(s) = [297.85862665]
bas 13, expnt(s) = [311.37022294]
bas 14, expnt(s) = [61.51470108]
bas 15, expnt(s) = [7.28471023]
bas 16, expnt(s) = [20.17183131]
bas 17, expnt(s) = [0.77274601]
bas 18, expnt(s) = [2.80023395]
bas 19, expnt(s) = [0.22341721]
CPU time:      1743.89
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828638e+04 5.20029385e+03 7.61705546e+03 2.05994375e+03
 3.61755399e+03 1.17849106e+03 1.58761929e+03 6.35440366e+02
 4.15631436e+02 2.32566049e+02 1.21075564e+02 9.22162377e+01
 3.88619847e+01 3.93240968e+01 8.09277005e+00 1.21223809e+01
 3.16938581e+00 6.00131408e+00 3.98279257e-01 1.26664756e+00
 1.36285424e+03 2.41571755e+04 6.64084722e+02 9.83475971e+03
 2.97858627e+02 3.60991621e+03 3.11370223e+02 3.81575726e+03
 6.15147011e+01 5.02583284e+02 7.28471023e+00 3.49140110e+01
 2.01718313e+01 1.24714242e+02 7.72746006e-01 2.11363676e+00
 2.80023395e+00 1.05676225e+01 2.23417214e-01 4.48105405e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982929695525208
cond(S) = 93180.64289695813
E1 = -729.3755476950364  E_coul = 203.11937787767013
init E= -526.256169817366
    CPU time for initialize scf      0.64 sec, wall time      0.05 sec
  HOMO = -0.557048917999528  LUMO = 1.03164485884376
  mo_energy =
[-1.18335291e+02 -1.22079348e+01 -9.45175943e+00 -9.45175943e+00
 -9.45175943e+00 -1.22610589e+00 -5.57048918e-01 -5.57048918e-01
 -5.57048918e-01  1.03164486e+00  1.03164486e+00  1.03164486e+00
  7.30402982e+00  7.30402982e+00  7.30402982e+00  1.01008119e+01
  3.33146275e+01  3.33146275e+01  3.33146275e+01  1.16454891e+02
  1.28590887e+02  1.28590887e+02  1.28590887e+02  4.80720275e+02
  4.80720275e+02  4.80720275e+02  6.53560791e+02  1.32636666e+03
  1.32636666e+03  1.32636666e+03  2.79321402e+03  3.01246791e+03
  3.01246791e+03  3.01246791e+03  6.62769482e+03  6.62769482e+03
  6.62769482e+03  9.21187345e+03  2.55586337e+04  7.62890865e+04]
E1 = -727.9897190908702  E_coul = 201.28075123908658
cycle= 1 E= -526.708967851784  delta_E= -0.453  |g|= 0.183  |ddm|= 0.406
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.537856
diis-c [-0.28928911  1.        ]
  HOMO = -0.581255623180693  LUMO = 1.01584218628498
  mo_energy =
[-1.18627389e+02 -1.23311634e+01 -9.58500021e+00 -9.58500021e+00
 -9.58500021e+00 -1.25716945e+00 -5.81255623e-01 -5.81255623e-01
 -5.81255623e-01  1.01584219e+00  1.01584219e+00  1.01584219e+00
  7.22907092e+00  7.22907092e+00  7.22907092e+00  1.00099180e+01
  3.31760378e+01  3.31760378e+01  3.31760378e+01  1.16241464e+02
  1.28378412e+02  1.28378412e+02  1.28378412e+02  4.80430138e+02
  4.80430138e+02  4.80430138e+02  6.53224151e+02  1.32602102e+03
  1.32602102e+03  1.32602102e+03  2.79273367e+03  3.01205663e+03
  3.01205663e+03  3.01205663e+03  6.62717152e+03  6.62717152e+03
  6.62717152e+03  9.21127659e+03  2.55579432e+04  7.62883062e+04]
E1 = -728.4506924731442  E_coul = 201.74113768841914
cycle= 2 E= -526.709554784725  delta_E= -0.000587  |g|= 0.0333  |ddm|= 0.0384
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0666038
diis-c [-0.00265638  0.07304149  0.92695851]
  HOMO = -0.574579161777761  LUMO = 1.02087332555522
  mo_energy =
[-1.18568979e+02 -1.23005034e+01 -9.55304494e+00 -9.55304494e+00
 -9.55304494e+00 -1.24869233e+00 -5.74579162e-01 -5.74579162e-01
 -5.74579162e-01  1.02087333e+00  1.02087333e+00  1.02087333e+00
  7.24735583e+00  7.24735583e+00  7.24735583e+00  1.00344541e+01
  3.32085533e+01  3.32085533e+01  3.32085533e+01  1.16290156e+02
  1.28425657e+02  1.28425657e+02  1.28425657e+02  4.80487751e+02
  4.80487751e+02  4.80487751e+02  6.53284555e+02  1.32608245e+03
  1.32608245e+03  1.32608245e+03  2.79279820e+03  3.01212015e+03
  3.01212015e+03  3.01212015e+03  6.62723660e+03  6.62723660e+03
  6.62723660e+03  9.21134237e+03  2.55580094e+04  7.62883727e+04]
E1 = -728.3464280600026  E_coul = 201.6368390004572
cycle= 3 E= -526.709589059545  delta_E= -3.43e-05  |g|= 0.0048  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104212
diis-c [-4.27156898e-07 -1.10533377e-03  1.30749799e-01  8.70355534e-01]
  HOMO = -0.575496524664753  LUMO = 1.02019290301115
  mo_energy =
[-1.18576515e+02 -1.23045288e+01 -9.55734035e+00 -9.55734035e+00
 -9.55734035e+00 -1.24980585e+00 -5.75496525e-01 -5.75496525e-01
 -5.75496525e-01  1.02019290e+00  1.02019290e+00  1.02019290e+00
  7.24487326e+00  7.24487326e+00  7.24487326e+00  1.00313197e+01
  3.32042132e+01  3.32042132e+01  3.32042132e+01  1.16283879e+02
  1.28419507e+02  1.28419507e+02  1.28419507e+02  4.80480317e+02
  4.80480317e+02  4.80480317e+02  6.53276727e+02  1.32607450e+03
  1.32607450e+03  1.32607450e+03  2.79278967e+03  3.01211185e+03
  3.01211185e+03  3.01211185e+03  6.62722795e+03  6.62722795e+03
  6.62722795e+03  9.21133353e+03  2.55580004e+04  7.62883635e+04]
E1 = -728.3605585135498  E_coul = 201.650968622089
cycle= 4 E= -526.709589891461  delta_E= -8.32e-07  |g|= 5.89e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122182
diis-c [-1.32011027e-09  6.40010087e-05 -8.99897215e-03 -7.05493437e-02
  1.07948431e+00]
  HOMO = -0.575484597686374  LUMO = 1.02020173441056
  mo_energy =
[-1.18576519e+02 -1.23045001e+01 -9.55732313e+00 -9.55732313e+00
 -9.55732313e+00 -1.24978700e+00 -5.75484598e-01 -5.75484598e-01
 -5.75484598e-01  1.02020173e+00  1.02020173e+00  1.02020173e+00
  7.24489365e+00  7.24489365e+00  7.24489365e+00  1.00313548e+01
  3.32042292e+01  3.32042292e+01  3.32042292e+01  1.16283889e+02
  1.28419515e+02  1.28419515e+02  1.28419515e+02  4.80480314e+02
  4.80480314e+02  4.80480314e+02  6.53276715e+02  1.32607449e+03
  1.32607449e+03  1.32607449e+03  2.79278964e+03  3.01211183e+03
  3.01211183e+03  3.01211183e+03  6.62722791e+03  6.62722791e+03
  6.62722791e+03  9.21133349e+03  2.55580004e+04  7.62883635e+04]
E1 = -728.3605563223784  E_coul = 201.65096643081102
cycle= 5 E= -526.709589891567  delta_E= -1.07e-10  |g|= 7.73e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3605563223784  E_coul = 201.65096643081102
  HOMO = -0.575488035241703  LUMO = 1.02019922599717
  mo_energy =
[-1.18576537e+02 -1.23045122e+01 -9.55733584e+00 -9.55733584e+00
 -9.55733584e+00 -1.24979124e+00 -5.75488035e-01 -5.75488035e-01
 -5.75488035e-01  1.02019923e+00  1.02019923e+00  1.02019923e+00
  7.24488533e+00  7.24488533e+00  7.24488533e+00  1.00313449e+01
  3.32042167e+01  3.32042167e+01  3.32042167e+01  1.16283873e+02
  1.28419499e+02  1.28419499e+02  1.28419499e+02  4.80480297e+02
  4.80480297e+02  4.80480297e+02  6.53276697e+02  1.32607447e+03
  1.32607447e+03  1.32607447e+03  2.79278962e+03  3.01211181e+03
  3.01211181e+03  3.01211181e+03  6.62722789e+03  6.62722789e+03
  6.62722789e+03  9.21133347e+03  2.55580003e+04  7.62883635e+04]
E1 = -728.360594329352  E_coul = 201.6510044377808
Extra cycle  E= -526.709589891571  delta_E= -3.75e-12  |g|= 2.28e-06  |ddm|= 3.93e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 93180.64289695813
E1 = -728.360594329352  E_coul = 201.6510044377808
init E= -526.709589891571
    CPU time for initialize scf      3.94 sec, wall time      0.22 sec
  HOMO = -0.575487340709289  LUMO = 1.02019973878737
  mo_energy =
[-1.18576532e+02 -1.23045095e+01 -9.55733296e+00 -9.55733296e+00
 -9.55733296e+00 -1.24979037e+00 -5.75487341e-01 -5.75487341e-01
 -5.75487341e-01  1.02019974e+00  1.02019974e+00  1.02019974e+00
  7.24488710e+00  7.24488710e+00  7.24488710e+00  1.00313471e+01
  3.32042196e+01  3.32042196e+01  3.32042196e+01  1.16283877e+02
  1.28419503e+02  1.28419503e+02  1.28419503e+02  4.80480301e+02
  4.80480301e+02  4.80480301e+02  6.53276702e+02  1.32607447e+03
  1.32607447e+03  1.32607447e+03  2.79278963e+03  3.01211181e+03
  3.01211181e+03  3.01211181e+03  6.62722790e+03  6.62722790e+03
  6.62722790e+03  9.21133348e+03  2.55580003e+04  7.62883635e+04]
E1 = -728.3605853125255  E_coul = 201.65099542095382
cycle= 1 E= -526.709589891572  delta_E= -4.55e-13  |g|= 5.84e-07  |ddm|= 8.95e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3605853125255  E_coul = 201.65099542095382
  HOMO = -0.575487493983967  LUMO = 1.02019962498004
  mo_energy =
[-1.18576533e+02 -1.23045101e+01 -9.55733364e+00 -9.55733364e+00
 -9.55733364e+00 -1.24979056e+00 -5.75487494e-01 -5.75487494e-01
 -5.75487494e-01  1.02019962e+00  1.02019962e+00  1.02019962e+00
  7.24488669e+00  7.24488669e+00  7.24488669e+00  1.00313466e+01
  3.32042189e+01  3.32042189e+01  3.32042189e+01  1.16283876e+02
  1.28419502e+02  1.28419502e+02  1.28419502e+02  4.80480300e+02
  4.80480300e+02  4.80480300e+02  6.53276701e+02  1.32607447e+03
  1.32607447e+03  1.32607447e+03  2.79278962e+03  3.01211181e+03
  3.01211181e+03  3.01211181e+03  6.62722790e+03  6.62722790e+03
  6.62722790e+03  9.21133348e+03  2.55580003e+04  7.62883635e+04]
E1 = -728.3605875059615  E_coul = 201.6509976143895
Extra cycle  E= -526.709589891572  delta_E= -3.41e-13  |g|= 1.46e-07  |ddm|= 2.09e-07
    CPU time for scf_cycle      4.06 sec, wall time      0.34 sec
exp = [2.61828638e+04 7.61705546e+03 3.61755399e+03 1.58761929e+03
 4.15631436e+02 1.21075564e+02 3.88619847e+01 8.09277005e+00
 3.16938581e+00 3.98279257e-01 1.36285424e+03 6.64084722e+02
 2.97858627e+02 3.11370223e+02 6.15147011e+01 7.28471023e+00
 2.01718313e+01 7.72746006e-01 2.80023395e+00 2.23417214e-01]
grad_E = [-1.40124675e-06  2.19248273e-06 -2.13001236e-06  3.76844300e-05
  2.86929040e-05 -7.43716641e-05  1.05015641e-04  1.60307738e-04
 -2.63893000e-05 -2.99946003e-03 -5.29022270e-07  4.90437522e-06
  2.32582460e-05  1.98959518e-05 -3.34793120e-05 -1.89349783e-03
  5.08974584e-04 -8.10661215e-04  1.74441419e-03  8.03027231e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:02:07 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8746693        1
[INPUT] 0    0    [1    /1   ]  7617.03766406        1
[INPUT] 0    0    [1    /1   ]  3617.56986278        1
[INPUT] 0    0    [1    /1   ]  1587.29979395        1
[INPUT] 0    0    [1    /1   ]  415.701401922        1
[INPUT] 0    0    [1    /1   ]  121.150622826        1
[INPUT] 0    0    [1    /1   ]  38.8753640427        1
[INPUT] 0    0    [1    /1   ]  8.08062150805        1
[INPUT] 0    0    [1    /1   ]  3.16640241099        1
[INPUT] 0    0    [1    /1   ]  0.398394555349       1
[INPUT] 1    0    [1    /1   ]  1362.85866302        1
[INPUT] 1    0    [1    /1   ]  664.05285229         1
[INPUT] 1    0    [1    /1   ]  297.712373022        1
[INPUT] 1    0    [1    /1   ]  311.245192479        1
[INPUT] 1    0    [1    /1   ]  61.0149028841        1
[INPUT] 1    0    [1    /1   ]  7.24831855727        1
[INPUT] 1    0    [1    /1   ]  20.0214322153        1
[INPUT] 1    0    [1    /1   ]  0.770773748393       1
[INPUT] 1    0    [1    /1   ]  2.7880418067         1
[INPUT] 1    0    [1    /1   ]  0.222835633601       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.87466931289, 1.0]], [0, [7617.037664057213, 1.0]], [0, [3617.5698627792704, 1.0]], [0, [1587.2997939505567, 1.0]], [0, [415.7014019220404, 1.0]], [0, [121.15062282581711, 1.0]], [0, [38.87536404271686, 1.0]], [0, [8.080621508047214, 1.0]], [0, [3.1664024109866693, 1.0]], [0, [0.398394555348718, 1.0]], [1, [1362.858663017502, 1.0]], [1, [664.0528522902227, 1.0]], [1, [297.7123730218228, 1.0]], [1, [311.2451924785822, 1.0]], [1, [61.014902884075795, 1.0]], [1, [7.248318557269668, 1.0]], [1, [20.021432215334087, 1.0]], [1, [0.7707737483926157, 1.0]], [1, [2.7880418066951798, 1.0]], [1, [0.22283563360126937, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87466931]
bas 1, expnt(s) = [7617.03766406]
bas 2, expnt(s) = [3617.56986278]
bas 3, expnt(s) = [1587.29979395]
bas 4, expnt(s) = [415.70140192]
bas 5, expnt(s) = [121.15062283]
bas 6, expnt(s) = [38.87536404]
bas 7, expnt(s) = [8.08062151]
bas 8, expnt(s) = [3.16640241]
bas 9, expnt(s) = [0.39839456]
bas 10, expnt(s) = [1362.85866302]
bas 11, expnt(s) = [664.05285229]
bas 12, expnt(s) = [297.71237302]
bas 13, expnt(s) = [311.24519248]
bas 14, expnt(s) = [61.01490288]
bas 15, expnt(s) = [7.24831856]
bas 16, expnt(s) = [20.02143222]
bas 17, expnt(s) = [0.77077375]
bas 18, expnt(s) = [2.78804181]
bas 19, expnt(s) = [0.22283563]
CPU time:      1753.73
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828747e+04 5.20029546e+03 7.61703766e+03 2.05994015e+03
 3.61756986e+03 1.17849493e+03 1.58729979e+03 6.35344455e+02
 4.15701402e+02 2.32595410e+02 1.21150623e+02 9.22591104e+01
 3.88753640e+01 3.93342502e+01 8.08062151e+00 1.21087301e+01
 3.16640241e+00 5.99707672e+00 3.98394555e-01 1.26692256e+00
 1.36285866e+03 2.41572735e+04 6.64052852e+02 9.83416975e+03
 2.97712373e+02 3.60770068e+03 3.11245192e+02 3.81384209e+03
 6.10149029e+01 4.97484207e+02 7.24831856e+00 3.46961257e+01
 2.00214322e+01 1.23553007e+02 7.70773748e-01 2.10689570e+00
 2.78804181e+00 1.05101398e+01 2.22835634e-01 4.46647793e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.9830050671397
cond(S) = 92023.14867391082
E1 = -729.3768800709788  E_coul = 203.12032077334229
init E= -526.256559297636
    CPU time for initialize scf      0.62 sec, wall time      0.05 sec
  HOMO = -0.557036266236874  LUMO = 1.02763906774536
  mo_energy =
[-1.18335219e+02 -1.22078793e+01 -9.45167182e+00 -9.45167182e+00
 -9.45167182e+00 -1.22608089e+00 -5.57036266e-01 -5.57036266e-01
 -5.57036266e-01  1.02763907e+00  1.02763907e+00  1.02763907e+00
  7.26344620e+00  7.26344620e+00  7.26344620e+00  1.00805888e+01
  3.30794953e+01  3.30794953e+01  3.30794953e+01  1.16451415e+02
  1.27534417e+02  1.27534417e+02  1.27534417e+02  4.78567692e+02
  4.78567692e+02  4.78567692e+02  6.53782651e+02  1.32368106e+03
  1.32368106e+03  1.32368106e+03  2.79346550e+03  3.00939834e+03
  3.00939834e+03  3.00939834e+03  6.62451259e+03  6.62451259e+03
  6.62451259e+03  9.21172400e+03  2.55581270e+04  7.62884410e+04]
E1 = -727.9861152332176  E_coul = 201.27712418212226
cycle= 1 E= -526.708991051095  delta_E= -0.452  |g|= 0.183  |ddm|= 0.404
    CPU time for cycle= 1      0.05 sec, wall time      0.02 sec
diis-norm(errvec)=0.537747
diis-c [-0.28917185  1.        ]
  HOMO = -0.581392056120626  LUMO = 1.01180075889029
  mo_energy =
[-1.18627705e+02 -1.23314230e+01 -9.58522441e+00 -9.58522441e+00
 -9.58522441e+00 -1.25733795e+00 -5.81392056e-01 -5.81392056e-01
 -5.81392056e-01  1.01180076e+00  1.01180076e+00  1.01180076e+00
  7.18849136e+00  7.18849136e+00  7.18849136e+00  9.98944090e+00
  3.29410254e+01  3.29410254e+01  3.29410254e+01  1.16237612e+02
  1.27322077e+02  1.27322077e+02  1.27322077e+02  4.78277221e+02
  4.78277221e+02  4.78277221e+02  6.53445578e+02  1.32333500e+03
  1.32333500e+03  1.32333500e+03  2.79298476e+03  3.00898664e+03
  3.00898664e+03  3.00898664e+03  6.62398887e+03  6.62398887e+03
  6.62398887e+03  9.21112675e+03  2.55574361e+04  7.62876603e+04]
E1 = -728.4482972775531  E_coul = 201.73871768668695
cycle= 2 E= -526.709579590866  delta_E= -0.000589  |g|= 0.0334  |ddm|= 0.0385
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0667013
diis-c [-0.00266259  0.073185    0.926815  ]
  HOMO = -0.574692192752969  LUMO = 1.0168293883142
  mo_energy =
[-1.18569189e+02 -1.23006854e+01 -9.55318821e+00 -9.55318821e+00
 -9.55318821e+00 -1.24883102e+00 -5.74692193e-01 -5.74692193e-01
 -5.74692193e-01  1.01682939e+00  1.01682939e+00  1.01682939e+00
  7.20676764e+00  7.20676764e+00  7.20676764e+00  1.00140204e+01
  3.29735236e+01  3.29735236e+01  3.29735236e+01  1.16286406e+02
  1.27369331e+02  1.27369331e+02  1.27369331e+02  4.78334932e+02
  4.78334932e+02  4.78334932e+02  6.53506093e+02  1.32339654e+03
  1.32339654e+03  1.32339654e+03  2.79304940e+03  3.00905026e+03
  3.00905026e+03  3.00905026e+03  6.62405406e+03  6.62405406e+03
  6.62405406e+03  9.21119265e+03  2.55575024e+04  7.62877269e+04]
E1 = -728.3436766754402  E_coul = 201.6340626256757
cycle= 3 E= -526.709614049764  delta_E= -3.45e-05  |g|= 0.00481  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104373
diis-c [-4.25521688e-07 -1.10467969e-03  1.30770444e-01  8.70334236e-01]
  HOMO = -0.57561303515964  LUMO = 1.01614906512298
  mo_energy =
[-1.18576741e+02 -1.23047219e+01 -9.55749508e+00 -9.55749508e+00
 -9.55749508e+00 -1.24994895e+00 -5.75613035e-01 -5.75613035e-01
 -5.75613035e-01  1.01614907e+00  1.01614907e+00  1.01614907e+00
  7.20428567e+00  7.20428567e+00  7.20428567e+00  1.00108789e+01
  3.29691842e+01  3.29691842e+01  3.29691842e+01  1.16280114e+02
  1.27363178e+02  1.27363178e+02  1.27363178e+02  4.78327484e+02
  4.78327484e+02  4.78327484e+02  6.53498248e+02  1.32338857e+03
  1.32338857e+03  1.32338857e+03  2.79304085e+03  3.00904195e+03
  3.00904195e+03  3.00904195e+03  6.62404540e+03  6.62404540e+03
  6.62404540e+03  9.21118379e+03  2.55574934e+04  7.62877177e+04]
E1 = -728.3578556539538  E_coul = 201.64824076751944
cycle= 4 E= -526.709614886434  delta_E= -8.37e-07  |g|= 5.88e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122048
diis-c [-1.32103242e-09  6.38617895e-05 -8.98684320e-03 -7.04317260e-02
  1.07935471e+00]
  HOMO = -0.575601137252958  LUMO = 1.01615784595157
  mo_energy =
[-1.18576746e+02 -1.23046933e+01 -9.55747791e+00 -9.55747791e+00
 -9.55747791e+00 -1.24993014e+00 -5.75601137e-01 -5.75601137e-01
 -5.75601137e-01  1.01615785e+00  1.01615785e+00  1.01615785e+00
  7.20430600e+00  7.20430600e+00  7.20430600e+00  1.00109139e+01
  3.29692002e+01  3.29692002e+01  3.29692002e+01  1.16280124e+02
  1.27363186e+02  1.27363186e+02  1.27363186e+02  4.78327480e+02
  4.78327480e+02  4.78327480e+02  6.53498236e+02  1.32338856e+03
  1.32338856e+03  1.32338856e+03  2.79304082e+03  3.00904193e+03
  3.00904193e+03  3.00904193e+03  6.62404536e+03  6.62404536e+03
  6.62404536e+03  9.21118375e+03  2.55574934e+04  7.62877177e+04]
E1 = -728.3578534447113  E_coul = 201.6482385581695
cycle= 5 E= -526.709614886542  delta_E= -1.07e-10  |g|= 7.73e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3578534447113  E_coul = 201.6482385581695
  HOMO = -0.575604577655482  LUMO = 1.01615534486209
  mo_energy =
[-1.18576763e+02 -1.23047054e+01 -9.55749063e+00 -9.55749063e+00
 -9.55749063e+00 -1.24993438e+00 -5.75604578e-01 -5.75604578e-01
 -5.75604578e-01  1.01615534e+00  1.01615534e+00  1.01615534e+00
  7.20429770e+00  7.20429770e+00  7.20429770e+00  1.00109040e+01
  3.29691877e+01  3.29691877e+01  3.29691877e+01  1.16280108e+02
  1.27363170e+02  1.27363170e+02  1.27363170e+02  4.78327463e+02
  4.78327463e+02  4.78327463e+02  6.53498219e+02  1.32338854e+03
  1.32338854e+03  1.32338854e+03  2.79304080e+03  3.00904191e+03
  3.00904191e+03  3.00904191e+03  6.62404534e+03  6.62404534e+03
  6.62404534e+03  9.21118373e+03  2.55574933e+04  7.62877177e+04]
E1 = -728.3578915288984  E_coul = 201.64827664235236
Extra cycle  E= -526.709614886546  delta_E= -4.32e-12  |g|= 2.28e-06  |ddm|= 3.93e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.22 sec
exp = [2.61828747e+04 7.61703766e+03 3.61756986e+03 1.58729979e+03
 4.15701402e+02 1.21150623e+02 3.88753640e+01 8.08062151e+00
 3.16640241e+00 3.98394555e-01 1.36285866e+03 6.64052852e+02
 2.97712373e+02 3.11245192e+02 6.10149029e+01 7.24831856e+00
 2.00214322e+01 7.70773748e-01 2.78804181e+00 2.22835634e-01]
E = -526.7096148865461
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:02:07 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8746693        1
[INPUT] 0    0    [1    /1   ]  7617.03766406        1
[INPUT] 0    0    [1    /1   ]  3617.56986278        1
[INPUT] 0    0    [1    /1   ]  1587.29979395        1
[INPUT] 0    0    [1    /1   ]  415.701401922        1
[INPUT] 0    0    [1    /1   ]  121.150622826        1
[INPUT] 0    0    [1    /1   ]  38.8753640427        1
[INPUT] 0    0    [1    /1   ]  8.08062150805        1
[INPUT] 0    0    [1    /1   ]  3.16640241099        1
[INPUT] 0    0    [1    /1   ]  0.398394555349       1
[INPUT] 1    0    [1    /1   ]  1362.85866302        1
[INPUT] 1    0    [1    /1   ]  664.05285229         1
[INPUT] 1    0    [1    /1   ]  297.712373022        1
[INPUT] 1    0    [1    /1   ]  311.245192479        1
[INPUT] 1    0    [1    /1   ]  61.0149028841        1
[INPUT] 1    0    [1    /1   ]  7.24831855727        1
[INPUT] 1    0    [1    /1   ]  20.0214322153        1
[INPUT] 1    0    [1    /1   ]  0.770773748393       1
[INPUT] 1    0    [1    /1   ]  2.7880418067         1
[INPUT] 1    0    [1    /1   ]  0.222835633601       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.87466931289, 1.0]], [0, [7617.037664057213, 1.0]], [0, [3617.5698627792704, 1.0]], [0, [1587.2997939505567, 1.0]], [0, [415.7014019220404, 1.0]], [0, [121.15062282581711, 1.0]], [0, [38.87536404271686, 1.0]], [0, [8.080621508047214, 1.0]], [0, [3.1664024109866693, 1.0]], [0, [0.398394555348718, 1.0]], [1, [1362.858663017502, 1.0]], [1, [664.0528522902227, 1.0]], [1, [297.7123730218228, 1.0]], [1, [311.2451924785822, 1.0]], [1, [61.014902884075795, 1.0]], [1, [7.248318557269668, 1.0]], [1, [20.021432215334087, 1.0]], [1, [0.7707737483926157, 1.0]], [1, [2.7880418066951798, 1.0]], [1, [0.22283563360126937, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87466931]
bas 1, expnt(s) = [7617.03766406]
bas 2, expnt(s) = [3617.56986278]
bas 3, expnt(s) = [1587.29979395]
bas 4, expnt(s) = [415.70140192]
bas 5, expnt(s) = [121.15062283]
bas 6, expnt(s) = [38.87536404]
bas 7, expnt(s) = [8.08062151]
bas 8, expnt(s) = [3.16640241]
bas 9, expnt(s) = [0.39839456]
bas 10, expnt(s) = [1362.85866302]
bas 11, expnt(s) = [664.05285229]
bas 12, expnt(s) = [297.71237302]
bas 13, expnt(s) = [311.24519248]
bas 14, expnt(s) = [61.01490288]
bas 15, expnt(s) = [7.24831856]
bas 16, expnt(s) = [20.02143222]
bas 17, expnt(s) = [0.77077375]
bas 18, expnt(s) = [2.78804181]
bas 19, expnt(s) = [0.22283563]
CPU time:      1754.82
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828747e+04 5.20029546e+03 7.61703766e+03 2.05994015e+03
 3.61756986e+03 1.17849493e+03 1.58729979e+03 6.35344455e+02
 4.15701402e+02 2.32595410e+02 1.21150623e+02 9.22591104e+01
 3.88753640e+01 3.93342502e+01 8.08062151e+00 1.21087301e+01
 3.16640241e+00 5.99707672e+00 3.98394555e-01 1.26692256e+00
 1.36285866e+03 2.41572735e+04 6.64052852e+02 9.83416975e+03
 2.97712373e+02 3.60770068e+03 3.11245192e+02 3.81384209e+03
 6.10149029e+01 4.97484207e+02 7.24831856e+00 3.46961257e+01
 2.00214322e+01 1.23553007e+02 7.70773748e-01 2.10689570e+00
 2.78804181e+00 1.05101398e+01 2.22835634e-01 4.46647793e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.9830050671397
cond(S) = 92023.14867391082
E1 = -729.3768800709788  E_coul = 203.12032077334229
init E= -526.256559297636
    CPU time for initialize scf      0.75 sec, wall time      0.05 sec
  HOMO = -0.557036266236874  LUMO = 1.02763906774536
  mo_energy =
[-1.18335219e+02 -1.22078793e+01 -9.45167182e+00 -9.45167182e+00
 -9.45167182e+00 -1.22608089e+00 -5.57036266e-01 -5.57036266e-01
 -5.57036266e-01  1.02763907e+00  1.02763907e+00  1.02763907e+00
  7.26344620e+00  7.26344620e+00  7.26344620e+00  1.00805888e+01
  3.30794953e+01  3.30794953e+01  3.30794953e+01  1.16451415e+02
  1.27534417e+02  1.27534417e+02  1.27534417e+02  4.78567692e+02
  4.78567692e+02  4.78567692e+02  6.53782651e+02  1.32368106e+03
  1.32368106e+03  1.32368106e+03  2.79346550e+03  3.00939834e+03
  3.00939834e+03  3.00939834e+03  6.62451259e+03  6.62451259e+03
  6.62451259e+03  9.21172400e+03  2.55581270e+04  7.62884410e+04]
E1 = -727.9861152332176  E_coul = 201.27712418212226
cycle= 1 E= -526.708991051095  delta_E= -0.452  |g|= 0.183  |ddm|= 0.404
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.537747
diis-c [-0.28917185  1.        ]
  HOMO = -0.581392056120626  LUMO = 1.01180075889029
  mo_energy =
[-1.18627705e+02 -1.23314230e+01 -9.58522441e+00 -9.58522441e+00
 -9.58522441e+00 -1.25733795e+00 -5.81392056e-01 -5.81392056e-01
 -5.81392056e-01  1.01180076e+00  1.01180076e+00  1.01180076e+00
  7.18849136e+00  7.18849136e+00  7.18849136e+00  9.98944090e+00
  3.29410254e+01  3.29410254e+01  3.29410254e+01  1.16237612e+02
  1.27322077e+02  1.27322077e+02  1.27322077e+02  4.78277221e+02
  4.78277221e+02  4.78277221e+02  6.53445578e+02  1.32333500e+03
  1.32333500e+03  1.32333500e+03  2.79298476e+03  3.00898664e+03
  3.00898664e+03  3.00898664e+03  6.62398887e+03  6.62398887e+03
  6.62398887e+03  9.21112675e+03  2.55574361e+04  7.62876603e+04]
E1 = -728.4482972775531  E_coul = 201.73871768668695
cycle= 2 E= -526.709579590866  delta_E= -0.000589  |g|= 0.0334  |ddm|= 0.0385
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0667013
diis-c [-0.00266259  0.073185    0.926815  ]
  HOMO = -0.574692192752969  LUMO = 1.0168293883142
  mo_energy =
[-1.18569189e+02 -1.23006854e+01 -9.55318821e+00 -9.55318821e+00
 -9.55318821e+00 -1.24883102e+00 -5.74692193e-01 -5.74692193e-01
 -5.74692193e-01  1.01682939e+00  1.01682939e+00  1.01682939e+00
  7.20676764e+00  7.20676764e+00  7.20676764e+00  1.00140204e+01
  3.29735236e+01  3.29735236e+01  3.29735236e+01  1.16286406e+02
  1.27369331e+02  1.27369331e+02  1.27369331e+02  4.78334932e+02
  4.78334932e+02  4.78334932e+02  6.53506093e+02  1.32339654e+03
  1.32339654e+03  1.32339654e+03  2.79304940e+03  3.00905026e+03
  3.00905026e+03  3.00905026e+03  6.62405406e+03  6.62405406e+03
  6.62405406e+03  9.21119265e+03  2.55575024e+04  7.62877269e+04]
E1 = -728.3436766754402  E_coul = 201.6340626256757
cycle= 3 E= -526.709614049764  delta_E= -3.45e-05  |g|= 0.00481  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104373
diis-c [-4.25521688e-07 -1.10467969e-03  1.30770444e-01  8.70334236e-01]
  HOMO = -0.57561303515964  LUMO = 1.01614906512298
  mo_energy =
[-1.18576741e+02 -1.23047219e+01 -9.55749508e+00 -9.55749508e+00
 -9.55749508e+00 -1.24994895e+00 -5.75613035e-01 -5.75613035e-01
 -5.75613035e-01  1.01614907e+00  1.01614907e+00  1.01614907e+00
  7.20428567e+00  7.20428567e+00  7.20428567e+00  1.00108789e+01
  3.29691842e+01  3.29691842e+01  3.29691842e+01  1.16280114e+02
  1.27363178e+02  1.27363178e+02  1.27363178e+02  4.78327484e+02
  4.78327484e+02  4.78327484e+02  6.53498248e+02  1.32338857e+03
  1.32338857e+03  1.32338857e+03  2.79304085e+03  3.00904195e+03
  3.00904195e+03  3.00904195e+03  6.62404540e+03  6.62404540e+03
  6.62404540e+03  9.21118379e+03  2.55574934e+04  7.62877177e+04]
E1 = -728.3578556539538  E_coul = 201.64824076751944
cycle= 4 E= -526.709614886434  delta_E= -8.37e-07  |g|= 5.88e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122048
diis-c [-1.32103242e-09  6.38617895e-05 -8.98684320e-03 -7.04317260e-02
  1.07935471e+00]
  HOMO = -0.575601137252958  LUMO = 1.01615784595157
  mo_energy =
[-1.18576746e+02 -1.23046933e+01 -9.55747791e+00 -9.55747791e+00
 -9.55747791e+00 -1.24993014e+00 -5.75601137e-01 -5.75601137e-01
 -5.75601137e-01  1.01615785e+00  1.01615785e+00  1.01615785e+00
  7.20430600e+00  7.20430600e+00  7.20430600e+00  1.00109139e+01
  3.29692002e+01  3.29692002e+01  3.29692002e+01  1.16280124e+02
  1.27363186e+02  1.27363186e+02  1.27363186e+02  4.78327480e+02
  4.78327480e+02  4.78327480e+02  6.53498236e+02  1.32338856e+03
  1.32338856e+03  1.32338856e+03  2.79304082e+03  3.00904193e+03
  3.00904193e+03  3.00904193e+03  6.62404536e+03  6.62404536e+03
  6.62404536e+03  9.21118375e+03  2.55574934e+04  7.62877177e+04]
E1 = -728.3578534447113  E_coul = 201.6482385581695
cycle= 5 E= -526.709614886542  delta_E= -1.07e-10  |g|= 7.73e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3578534447113  E_coul = 201.6482385581695
  HOMO = -0.575604577655482  LUMO = 1.01615534486209
  mo_energy =
[-1.18576763e+02 -1.23047054e+01 -9.55749063e+00 -9.55749063e+00
 -9.55749063e+00 -1.24993438e+00 -5.75604578e-01 -5.75604578e-01
 -5.75604578e-01  1.01615534e+00  1.01615534e+00  1.01615534e+00
  7.20429770e+00  7.20429770e+00  7.20429770e+00  1.00109040e+01
  3.29691877e+01  3.29691877e+01  3.29691877e+01  1.16280108e+02
  1.27363170e+02  1.27363170e+02  1.27363170e+02  4.78327463e+02
  4.78327463e+02  4.78327463e+02  6.53498219e+02  1.32338854e+03
  1.32338854e+03  1.32338854e+03  2.79304080e+03  3.00904191e+03
  3.00904191e+03  3.00904191e+03  6.62404534e+03  6.62404534e+03
  6.62404534e+03  9.21118373e+03  2.55574933e+04  7.62877177e+04]
E1 = -728.3578915288984  E_coul = 201.64827664235236
Extra cycle  E= -526.709614886546  delta_E= -4.32e-12  |g|= 2.28e-06  |ddm|= 3.93e-06
    CPU time for scf_cycle      0.93 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 92023.14867391082
E1 = -728.3578915288984  E_coul = 201.64827664235236
init E= -526.709614886546
    CPU time for initialize scf      3.81 sec, wall time      0.21 sec
  HOMO = -0.575603881197386  LUMO = 1.01615585711648
  mo_energy =
[-1.18576758e+02 -1.23047026e+01 -9.55748774e+00 -9.55748774e+00
 -9.55748774e+00 -1.24993350e+00 -5.75603881e-01 -5.75603881e-01
 -5.75603881e-01  1.01615586e+00  1.01615586e+00  1.01615586e+00
  7.20429947e+00  7.20429947e+00  7.20429947e+00  1.00109063e+01
  3.29691906e+01  3.29691906e+01  3.29691906e+01  1.16280112e+02
  1.27363174e+02  1.27363174e+02  1.27363174e+02  4.78327468e+02
  4.78327468e+02  4.78327468e+02  6.53498223e+02  1.32338854e+03
  1.32338854e+03  1.32338854e+03  2.79304081e+03  3.00904191e+03
  3.00904191e+03  3.00904191e+03  6.62404535e+03  6.62404535e+03
  6.62404535e+03  9.21118374e+03  2.55574933e+04  7.62877177e+04]
E1 = -728.3578824853292  E_coul = 201.6482675987826
cycle= 1 E= -526.709614886547  delta_E= -5.68e-13  |g|= 5.86e-07  |ddm|= 8.97e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3578824853292  E_coul = 201.6482675987826
  HOMO = -0.575604035046446  LUMO = 1.01615574332731
  mo_energy =
[-1.18576759e+02 -1.23047033e+01 -9.55748842e+00 -9.55748842e+00
 -9.55748842e+00 -1.24993370e+00 -5.75604035e-01 -5.75604035e-01
 -5.75604035e-01  1.01615574e+00  1.01615574e+00  1.01615574e+00
  7.20429906e+00  7.20429906e+00  7.20429906e+00  1.00109057e+01
  3.29691899e+01  3.29691899e+01  3.29691899e+01  1.16280111e+02
  1.27363173e+02  1.27363173e+02  1.27363173e+02  4.78327467e+02
  4.78327467e+02  4.78327467e+02  6.53498222e+02  1.32338854e+03
  1.32338854e+03  1.32338854e+03  2.79304080e+03  3.00904191e+03
  3.00904191e+03  3.00904191e+03  6.62404535e+03  6.62404535e+03
  6.62404535e+03  9.21118374e+03  2.55574933e+04  7.62877177e+04]
E1 = -728.3578846873778  E_coul = 201.64826980083146
Extra cycle  E= -526.709614886546  delta_E= 3.41e-13  |g|= 1.47e-07  |ddm|= 2.1e-07
    CPU time for scf_cycle      3.93 sec, wall time      0.32 sec
exp = [2.61828747e+04 7.61703766e+03 3.61756986e+03 1.58729979e+03
 4.15701402e+02 1.21150623e+02 3.88753640e+01 8.08062151e+00
 3.16640241e+00 3.98394555e-01 1.36285866e+03 6.64052852e+02
 2.97712373e+02 3.11245192e+02 6.10149029e+01 7.24831856e+00
 2.00214322e+01 7.70773748e-01 2.78804181e+00 2.22835634e-01]
grad_E = [-1.40146835e-06  2.19434101e-06 -2.13376401e-06  3.78238254e-05
  2.35516627e-05 -4.21009120e-05  6.29400400e-05  9.95311841e-05
 -1.39683606e-05 -1.81555630e-03 -5.05070078e-07  5.21410379e-06
  2.49889669e-05  2.13900703e-05 -5.03808573e-05 -1.08508859e-03
  2.76698698e-04 -5.77021934e-04  1.02663011e-03  5.05178135e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:02:11 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8756005        1
[INPUT] 0    0    [1    /1   ]  7617.03630874        1
[INPUT] 0    0    [1    /1   ]  3617.57137213        1
[INPUT] 0    0    [1    /1   ]  1587.27816907        1
[INPUT] 0    0    [1    /1   ]  415.651176079        1
[INPUT] 0    0    [1    /1   ]  121.194743057        1
[INPUT] 0    0    [1    /1   ]  38.8816466458        1
[INPUT] 0    0    [1    /1   ]  8.06494327692        1
[INPUT] 0    0    [1    /1   ]  3.16237694621        1
[INPUT] 0    0    [1    /1   ]  0.39851947728        1
[INPUT] 1    0    [1    /1   ]  1362.85906399        1
[INPUT] 1    0    [1    /1   ]  664.050183385        1
[INPUT] 1    0    [1    /1   ]  297.700237082        1
[INPUT] 1    0    [1    /1   ]  311.234842959        1
[INPUT] 1    0    [1    /1   ]  60.9531470217        1
[INPUT] 1    0    [1    /1   ]  7.25912809481        1
[INPUT] 1    0    [1    /1   ]  20.0176091208        1
[INPUT] 1    0    [1    /1   ]  0.770576237096       1
[INPUT] 1    0    [1    /1   ]  2.79053761489        1
[INPUT] 1    0    [1    /1   ]  0.222593931018       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.875600494903, 1.0]], [0, [7617.036308737855, 1.0]], [0, [3617.5713721290253, 1.0]], [0, [1587.2781690727059, 1.0]], [0, [415.65117607898577, 1.0]], [0, [121.19474305670191, 1.0]], [0, [38.881646645819124, 1.0]], [0, [8.06494327691636, 1.0]], [0, [3.162376946205099, 1.0]], [0, [0.3985194772802405, 1.0]], [1, [1362.8590639942238, 1.0]], [1, [664.0501833848135, 1.0]], [1, [297.70023708168867, 1.0]], [1, [311.23484295948896, 1.0]], [1, [60.95314702170972, 1.0]], [1, [7.259128094813528, 1.0]], [1, [20.01760912084219, 1.0]], [1, [0.7705762370963224, 1.0]], [1, [2.7905376148923287, 1.0]], [1, [0.2225939310178274, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87560049]
bas 1, expnt(s) = [7617.03630874]
bas 2, expnt(s) = [3617.57137213]
bas 3, expnt(s) = [1587.27816907]
bas 4, expnt(s) = [415.65117608]
bas 5, expnt(s) = [121.19474306]
bas 6, expnt(s) = [38.88164665]
bas 7, expnt(s) = [8.06494328]
bas 8, expnt(s) = [3.16237695]
bas 9, expnt(s) = [0.39851948]
bas 10, expnt(s) = [1362.85906399]
bas 11, expnt(s) = [664.05018338]
bas 12, expnt(s) = [297.70023708]
bas 13, expnt(s) = [311.23484296]
bas 14, expnt(s) = [60.95314702]
bas 15, expnt(s) = [7.25912809]
bas 16, expnt(s) = [20.01760912]
bas 17, expnt(s) = [0.77057624]
bas 18, expnt(s) = [2.79053761]
bas 19, expnt(s) = [0.22259393]
CPU time:      1764.59
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828756e+04 5.20029560e+03 7.61703631e+03 2.05993987e+03
 3.61757137e+03 1.17849530e+03 1.58727817e+03 6.35337963e+02
 4.15651176e+02 2.32574333e+02 1.21194743e+02 9.22843082e+01
 3.88816466e+01 3.93390177e+01 8.06494328e+00 1.20911055e+01
 3.16237695e+00 5.99135773e+00 3.98519477e-01 1.26722050e+00
 1.36285906e+03 2.41572824e+04 6.64050183e+02 9.83412035e+03
 2.97700237e+02 3.60751685e+03 3.11234843e+02 3.81368357e+03
 6.09531470e+01 4.96854879e+02 7.25912809e+00 3.47608164e+01
 2.00176091e+01 1.23523517e+02 7.70576237e-01 2.10622085e+00
 2.79053761e+00 1.05219018e+01 2.22593931e-01 4.46042295e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.983019078201124
cond(S) = 91920.66885585194
E1 = -729.3783100610899  E_coul = 203.1213484184734
init E= -526.256961642616
    CPU time for initialize scf      0.66 sec, wall time      0.06 sec
  HOMO = -0.557003870703772  LUMO = 1.02653947184517
  mo_energy =
[-1.18335123e+02 -1.22078219e+01 -9.45159559e+00 -9.45159559e+00
 -9.45159559e+00 -1.22605519e+00 -5.57003871e-01 -5.57003871e-01
 -5.57003871e-01  1.02653947e+00  1.02653947e+00  1.02653947e+00
  7.26900762e+00  7.26900762e+00  7.26900762e+00  1.00535002e+01
  3.31102090e+01  3.31102090e+01  3.31102090e+01  1.16401979e+02
  1.27510704e+02  1.27510704e+02  1.27510704e+02  4.78411404e+02
  4.78411404e+02  4.78411404e+02  6.53806644e+02  1.32346199e+03
  1.32346199e+03  1.32346199e+03  2.79343808e+03  3.00914132e+03
  3.00914132e+03  3.00914132e+03  6.62424420e+03  6.62424420e+03
  6.62424420e+03  9.21162552e+03  2.55579932e+04  7.62882997e+04]
E1 = -727.9835494143477  E_coul = 201.2745512125552
cycle= 1 E= -526.708998201793  delta_E= -0.452  |g|= 0.183  |ddm|= 0.402
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.537784
diis-c [-0.2892111  1.       ]
  HOMO = -0.581469461384461  LUMO = 1.01063150770521
  mo_energy =
[-1.18627902e+02 -1.23316202e+01 -9.58540495e+00 -9.58540495e+00
 -9.58540495e+00 -1.25746099e+00 -5.81469461e-01 -5.81469461e-01
 -5.81469461e-01  1.01063151e+00  1.01063151e+00  1.01063151e+00
  7.19376545e+00  7.19376545e+00  7.19376545e+00  9.96218562e+00
  3.29714590e+01  3.29714590e+01  3.29714590e+01  1.16187905e+02
  1.27298148e+02  1.27298148e+02  1.27298148e+02  4.78120662e+02
  4.78120662e+02  4.78120662e+02  6.53469264e+02  1.32311562e+03
  1.32311562e+03  1.32311562e+03  2.79295705e+03  3.00872932e+03
  3.00872932e+03  3.00872932e+03  6.62372018e+03  6.62372018e+03
  6.62372018e+03  9.21102798e+03  2.55573019e+04  7.62875187e+04]
E1 = -728.4465721226211  E_coul = 201.73698426145125
cycle= 2 E= -526.70958786117  delta_E= -0.00059  |g|= 0.0334  |ddm|= 0.0386
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.06678
diis-c [-0.00266728  0.07329117  0.92670883]
  HOMO = -0.574753353451353  LUMO = 1.01566922066769
  mo_energy =
[-1.18569314e+02 -1.23008291e+01 -9.55331244e+00 -9.55331244e+00
 -9.55331244e+00 -1.24893324e+00 -5.74753353e-01 -5.74753353e-01
 -5.74753353e-01  1.01566922e+00  1.01566922e+00  1.01566922e+00
  7.21209286e+00  7.21209286e+00  7.21209286e+00  9.98678123e+00
  3.30040171e+01  3.30040171e+01  3.30040171e+01  1.16236768e+02
  1.27345457e+02  1.27345457e+02  1.27345457e+02  4.78178443e+02
  4.78178443e+02  4.78178443e+02  6.53529853e+02  1.32317723e+03
  1.32317723e+03  1.32317723e+03  2.79302177e+03  3.00879302e+03
  3.00879302e+03  3.00879302e+03  6.62378545e+03  6.62378545e+03
  6.62378545e+03  9.21109396e+03  2.55573684e+04  7.62875854e+04]
E1 = -728.3417107184115  E_coul = 201.63208826837874
cycle= 3 E= -526.709622450033  delta_E= -3.46e-05  |g|= 0.00482  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104499
diis-c [-4.24318987e-07 -1.10440296e-03  1.30779340e-01  8.70325063e-01]
  HOMO = -0.57567633118181  LUMO = 1.01498769350643
  mo_energy =
[-1.18576876e+02 -1.23048727e+01 -9.55762668e+00 -9.55762668e+00
 -9.55762668e+00 -1.25005392e+00 -5.75676331e-01 -5.75676331e-01
 -5.75676331e-01  1.01498769e+00  1.01498769e+00  1.01498769e+00
  7.20960408e+00  7.20960408e+00  7.20960408e+00  9.98363703e+00
  3.29996697e+01  3.29996697e+01  3.29996697e+01  1.16230467e+02
  1.27339296e+02  1.27339296e+02  1.27339296e+02  4.78170985e+02
  4.78170985e+02  4.78170985e+02  6.53521998e+02  1.32316925e+03
  1.32316925e+03  1.32316925e+03  2.79301321e+03  3.00878470e+03
  3.00878470e+03  3.00878470e+03  6.62377677e+03  6.62377677e+03
  6.62377677e+03  9.21108509e+03  2.55573594e+04  7.62875763e+04]
E1 = -728.355920278339  E_coul = 201.64629698850518
cycle= 4 E= -526.709623289834  delta_E= -8.4e-07  |g|= 5.88e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122088
diis-c [-1.31483131e-09  6.37805828e-05 -8.98060873e-03 -7.03841216e-02
  1.07930095e+00]
  HOMO = -0.575664488605778  LUMO = 1.01499642904655
  mo_energy =
[-1.18576880e+02 -1.23048443e+01 -9.55760969e+00 -9.55760969e+00
 -9.55760969e+00 -1.25003517e+00 -5.75664489e-01 -5.75664489e-01
 -5.75664489e-01  1.01499643e+00  1.01499643e+00  1.01499643e+00
  7.20962428e+00  7.20962428e+00  7.20962428e+00  9.98367190e+00
  3.29996855e+01  3.29996855e+01  3.29996855e+01  1.16230477e+02
  1.27339303e+02  1.27339303e+02  1.27339303e+02  4.78170981e+02
  4.78170981e+02  4.78170981e+02  6.53521986e+02  1.32316924e+03
  1.32316924e+03  1.32316924e+03  2.79301318e+03  3.00878467e+03
  3.00878467e+03  3.00878467e+03  6.62377674e+03  6.62377674e+03
  6.62377674e+03  9.21108505e+03  2.55573593e+04  7.62875762e+04]
E1 = -728.3559184042243  E_coul = 201.64629511428444
cycle= 5 E= -526.70962328994  delta_E= -1.06e-10  |g|= 7.72e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3559184042243  E_coul = 201.64629511428444
  HOMO = -0.575667925348483  LUMO = 1.01499393188337
  mo_energy =
[-1.18576897e+02 -1.23048564e+01 -9.55762239e+00 -9.55762239e+00
 -9.55762239e+00 -1.25003940e+00 -5.75667925e-01 -5.75667925e-01
 -5.75667925e-01  1.01499393e+00  1.01499393e+00  1.01499393e+00
  7.20961598e+00  7.20961598e+00  7.20961598e+00  9.98366199e+00
  3.29996730e+01  3.29996730e+01  3.29996730e+01  1.16230461e+02
  1.27339288e+02  1.27339288e+02  1.27339288e+02  4.78170964e+02
  4.78170964e+02  4.78170964e+02  6.53521969e+02  1.32316922e+03
  1.32316922e+03  1.32316922e+03  2.79301316e+03  3.00878466e+03
  3.00878466e+03  3.00878466e+03  6.62377672e+03  6.62377672e+03
  6.62377672e+03  9.21108503e+03  2.55573593e+04  7.62875762e+04]
E1 = -728.3559564800668  E_coul = 201.64633319012316
Extra cycle  E= -526.709623289944  delta_E= -3.75e-12  |g|= 2.28e-06  |ddm|= 3.93e-06
    CPU time for scf_cycle      0.84 sec, wall time      0.24 sec
exp = [2.61828756e+04 7.61703631e+03 3.61757137e+03 1.58727817e+03
 4.15651176e+02 1.21194743e+02 3.88816466e+01 8.06494328e+00
 3.16237695e+00 3.98519477e-01 1.36285906e+03 6.64050183e+02
 2.97700237e+02 3.11234843e+02 6.09531470e+01 7.25912809e+00
 2.00176091e+01 7.70576237e-01 2.79053761e+00 2.22593931e-01]
E = -526.7096232899436
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:02:12 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8756005        1
[INPUT] 0    0    [1    /1   ]  7617.03630874        1
[INPUT] 0    0    [1    /1   ]  3617.57137213        1
[INPUT] 0    0    [1    /1   ]  1587.27816907        1
[INPUT] 0    0    [1    /1   ]  415.651176079        1
[INPUT] 0    0    [1    /1   ]  121.194743057        1
[INPUT] 0    0    [1    /1   ]  38.8816466458        1
[INPUT] 0    0    [1    /1   ]  8.06494327692        1
[INPUT] 0    0    [1    /1   ]  3.16237694621        1
[INPUT] 0    0    [1    /1   ]  0.39851947728        1
[INPUT] 1    0    [1    /1   ]  1362.85906399        1
[INPUT] 1    0    [1    /1   ]  664.050183385        1
[INPUT] 1    0    [1    /1   ]  297.700237082        1
[INPUT] 1    0    [1    /1   ]  311.234842959        1
[INPUT] 1    0    [1    /1   ]  60.9531470217        1
[INPUT] 1    0    [1    /1   ]  7.25912809481        1
[INPUT] 1    0    [1    /1   ]  20.0176091208        1
[INPUT] 1    0    [1    /1   ]  0.770576237096       1
[INPUT] 1    0    [1    /1   ]  2.79053761489        1
[INPUT] 1    0    [1    /1   ]  0.222593931018       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.875600494903, 1.0]], [0, [7617.036308737855, 1.0]], [0, [3617.5713721290253, 1.0]], [0, [1587.2781690727059, 1.0]], [0, [415.65117607898577, 1.0]], [0, [121.19474305670191, 1.0]], [0, [38.881646645819124, 1.0]], [0, [8.06494327691636, 1.0]], [0, [3.162376946205099, 1.0]], [0, [0.3985194772802405, 1.0]], [1, [1362.8590639942238, 1.0]], [1, [664.0501833848135, 1.0]], [1, [297.70023708168867, 1.0]], [1, [311.23484295948896, 1.0]], [1, [60.95314702170972, 1.0]], [1, [7.259128094813528, 1.0]], [1, [20.01760912084219, 1.0]], [1, [0.7705762370963224, 1.0]], [1, [2.7905376148923287, 1.0]], [1, [0.2225939310178274, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87560049]
bas 1, expnt(s) = [7617.03630874]
bas 2, expnt(s) = [3617.57137213]
bas 3, expnt(s) = [1587.27816907]
bas 4, expnt(s) = [415.65117608]
bas 5, expnt(s) = [121.19474306]
bas 6, expnt(s) = [38.88164665]
bas 7, expnt(s) = [8.06494328]
bas 8, expnt(s) = [3.16237695]
bas 9, expnt(s) = [0.39851948]
bas 10, expnt(s) = [1362.85906399]
bas 11, expnt(s) = [664.05018338]
bas 12, expnt(s) = [297.70023708]
bas 13, expnt(s) = [311.23484296]
bas 14, expnt(s) = [60.95314702]
bas 15, expnt(s) = [7.25912809]
bas 16, expnt(s) = [20.01760912]
bas 17, expnt(s) = [0.77057624]
bas 18, expnt(s) = [2.79053761]
bas 19, expnt(s) = [0.22259393]
CPU time:      1765.72
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828756e+04 5.20029560e+03 7.61703631e+03 2.05993987e+03
 3.61757137e+03 1.17849530e+03 1.58727817e+03 6.35337963e+02
 4.15651176e+02 2.32574333e+02 1.21194743e+02 9.22843082e+01
 3.88816466e+01 3.93390177e+01 8.06494328e+00 1.20911055e+01
 3.16237695e+00 5.99135773e+00 3.98519477e-01 1.26722050e+00
 1.36285906e+03 2.41572824e+04 6.64050183e+02 9.83412035e+03
 2.97700237e+02 3.60751685e+03 3.11234843e+02 3.81368357e+03
 6.09531470e+01 4.96854879e+02 7.25912809e+00 3.47608164e+01
 2.00176091e+01 1.23523517e+02 7.70576237e-01 2.10622085e+00
 2.79053761e+00 1.05219018e+01 2.22593931e-01 4.46042295e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.983019078201124
cond(S) = 91920.66885585194
E1 = -729.3783100610899  E_coul = 203.1213484184734
init E= -526.256961642616
    CPU time for initialize scf      0.64 sec, wall time      0.05 sec
  HOMO = -0.557003870703772  LUMO = 1.02653947184517
  mo_energy =
[-1.18335123e+02 -1.22078219e+01 -9.45159559e+00 -9.45159559e+00
 -9.45159559e+00 -1.22605519e+00 -5.57003871e-01 -5.57003871e-01
 -5.57003871e-01  1.02653947e+00  1.02653947e+00  1.02653947e+00
  7.26900762e+00  7.26900762e+00  7.26900762e+00  1.00535002e+01
  3.31102090e+01  3.31102090e+01  3.31102090e+01  1.16401979e+02
  1.27510704e+02  1.27510704e+02  1.27510704e+02  4.78411404e+02
  4.78411404e+02  4.78411404e+02  6.53806644e+02  1.32346199e+03
  1.32346199e+03  1.32346199e+03  2.79343808e+03  3.00914132e+03
  3.00914132e+03  3.00914132e+03  6.62424420e+03  6.62424420e+03
  6.62424420e+03  9.21162552e+03  2.55579932e+04  7.62882997e+04]
E1 = -727.9835494143477  E_coul = 201.2745512125552
cycle= 1 E= -526.708998201793  delta_E= -0.452  |g|= 0.183  |ddm|= 0.402
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.537784
diis-c [-0.2892111  1.       ]
  HOMO = -0.581469461384461  LUMO = 1.01063150770521
  mo_energy =
[-1.18627902e+02 -1.23316202e+01 -9.58540495e+00 -9.58540495e+00
 -9.58540495e+00 -1.25746099e+00 -5.81469461e-01 -5.81469461e-01
 -5.81469461e-01  1.01063151e+00  1.01063151e+00  1.01063151e+00
  7.19376545e+00  7.19376545e+00  7.19376545e+00  9.96218562e+00
  3.29714590e+01  3.29714590e+01  3.29714590e+01  1.16187905e+02
  1.27298148e+02  1.27298148e+02  1.27298148e+02  4.78120662e+02
  4.78120662e+02  4.78120662e+02  6.53469264e+02  1.32311562e+03
  1.32311562e+03  1.32311562e+03  2.79295705e+03  3.00872932e+03
  3.00872932e+03  3.00872932e+03  6.62372018e+03  6.62372018e+03
  6.62372018e+03  9.21102798e+03  2.55573019e+04  7.62875187e+04]
E1 = -728.4465721226211  E_coul = 201.73698426145125
cycle= 2 E= -526.70958786117  delta_E= -0.00059  |g|= 0.0334  |ddm|= 0.0386
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.06678
diis-c [-0.00266728  0.07329117  0.92670883]
  HOMO = -0.574753353451353  LUMO = 1.01566922066769
  mo_energy =
[-1.18569314e+02 -1.23008291e+01 -9.55331244e+00 -9.55331244e+00
 -9.55331244e+00 -1.24893324e+00 -5.74753353e-01 -5.74753353e-01
 -5.74753353e-01  1.01566922e+00  1.01566922e+00  1.01566922e+00
  7.21209286e+00  7.21209286e+00  7.21209286e+00  9.98678123e+00
  3.30040171e+01  3.30040171e+01  3.30040171e+01  1.16236768e+02
  1.27345457e+02  1.27345457e+02  1.27345457e+02  4.78178443e+02
  4.78178443e+02  4.78178443e+02  6.53529853e+02  1.32317723e+03
  1.32317723e+03  1.32317723e+03  2.79302177e+03  3.00879302e+03
  3.00879302e+03  3.00879302e+03  6.62378545e+03  6.62378545e+03
  6.62378545e+03  9.21109396e+03  2.55573684e+04  7.62875854e+04]
E1 = -728.3417107184115  E_coul = 201.63208826837874
cycle= 3 E= -526.709622450033  delta_E= -3.46e-05  |g|= 0.00482  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104499
diis-c [-4.24318987e-07 -1.10440296e-03  1.30779340e-01  8.70325063e-01]
  HOMO = -0.57567633118181  LUMO = 1.01498769350643
  mo_energy =
[-1.18576876e+02 -1.23048727e+01 -9.55762668e+00 -9.55762668e+00
 -9.55762668e+00 -1.25005392e+00 -5.75676331e-01 -5.75676331e-01
 -5.75676331e-01  1.01498769e+00  1.01498769e+00  1.01498769e+00
  7.20960408e+00  7.20960408e+00  7.20960408e+00  9.98363703e+00
  3.29996697e+01  3.29996697e+01  3.29996697e+01  1.16230467e+02
  1.27339296e+02  1.27339296e+02  1.27339296e+02  4.78170985e+02
  4.78170985e+02  4.78170985e+02  6.53521998e+02  1.32316925e+03
  1.32316925e+03  1.32316925e+03  2.79301321e+03  3.00878470e+03
  3.00878470e+03  3.00878470e+03  6.62377677e+03  6.62377677e+03
  6.62377677e+03  9.21108509e+03  2.55573594e+04  7.62875763e+04]
E1 = -728.355920278339  E_coul = 201.64629698850518
cycle= 4 E= -526.709623289834  delta_E= -8.4e-07  |g|= 5.88e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122088
diis-c [-1.31483131e-09  6.37805828e-05 -8.98060873e-03 -7.03841216e-02
  1.07930095e+00]
  HOMO = -0.575664488605778  LUMO = 1.01499642904655
  mo_energy =
[-1.18576880e+02 -1.23048443e+01 -9.55760969e+00 -9.55760969e+00
 -9.55760969e+00 -1.25003517e+00 -5.75664489e-01 -5.75664489e-01
 -5.75664489e-01  1.01499643e+00  1.01499643e+00  1.01499643e+00
  7.20962428e+00  7.20962428e+00  7.20962428e+00  9.98367190e+00
  3.29996855e+01  3.29996855e+01  3.29996855e+01  1.16230477e+02
  1.27339303e+02  1.27339303e+02  1.27339303e+02  4.78170981e+02
  4.78170981e+02  4.78170981e+02  6.53521986e+02  1.32316924e+03
  1.32316924e+03  1.32316924e+03  2.79301318e+03  3.00878467e+03
  3.00878467e+03  3.00878467e+03  6.62377674e+03  6.62377674e+03
  6.62377674e+03  9.21108505e+03  2.55573593e+04  7.62875762e+04]
E1 = -728.3559184042243  E_coul = 201.64629511428444
cycle= 5 E= -526.70962328994  delta_E= -1.06e-10  |g|= 7.72e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3559184042243  E_coul = 201.64629511428444
  HOMO = -0.575667925348483  LUMO = 1.01499393188337
  mo_energy =
[-1.18576897e+02 -1.23048564e+01 -9.55762239e+00 -9.55762239e+00
 -9.55762239e+00 -1.25003940e+00 -5.75667925e-01 -5.75667925e-01
 -5.75667925e-01  1.01499393e+00  1.01499393e+00  1.01499393e+00
  7.20961598e+00  7.20961598e+00  7.20961598e+00  9.98366199e+00
  3.29996730e+01  3.29996730e+01  3.29996730e+01  1.16230461e+02
  1.27339288e+02  1.27339288e+02  1.27339288e+02  4.78170964e+02
  4.78170964e+02  4.78170964e+02  6.53521969e+02  1.32316922e+03
  1.32316922e+03  1.32316922e+03  2.79301316e+03  3.00878466e+03
  3.00878466e+03  3.00878466e+03  6.62377672e+03  6.62377672e+03
  6.62377672e+03  9.21108503e+03  2.55573593e+04  7.62875762e+04]
E1 = -728.3559564800668  E_coul = 201.64633319012316
Extra cycle  E= -526.709623289944  delta_E= -3.75e-12  |g|= 2.28e-06  |ddm|= 3.93e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 91920.66885585194
E1 = -728.3559564800668  E_coul = 201.64633319012316
init E= -526.709623289944
    CPU time for initialize scf      3.86 sec, wall time      0.21 sec
  HOMO = -0.575667228785789  LUMO = 1.01499444394248
  mo_energy =
[-1.18576893e+02 -1.23048536e+01 -9.55761950e+00 -9.55761950e+00
 -9.55761950e+00 -1.25003853e+00 -5.75667229e-01 -5.75667229e-01
 -5.75667229e-01  1.01499444e+00  1.01499444e+00  1.01499444e+00
  7.20961775e+00  7.20961775e+00  7.20961775e+00  9.98366424e+00
  3.29996759e+01  3.29996759e+01  3.29996759e+01  1.16230465e+02
  1.27339292e+02  1.27339292e+02  1.27339292e+02  4.78170969e+02
  4.78170969e+02  4.78170969e+02  6.53521974e+02  1.32316923e+03
  1.32316923e+03  1.32316923e+03  2.79301317e+03  3.00878466e+03
  3.00878466e+03  3.00878466e+03  6.62377672e+03  6.62377672e+03
  6.62377672e+03  9.21108504e+03  2.55573593e+04  7.62875762e+04]
E1 = -728.3559474331198  E_coul = 201.646324143176
cycle= 1 E= -526.709623289944  delta_E= -2.27e-13  |g|= 5.86e-07  |ddm|= 8.98e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3559474331198  E_coul = 201.646324143176
  HOMO = -0.575667382756928  LUMO = 1.01499433012612
  mo_energy =
[-1.18576894e+02 -1.23048542e+01 -9.55762019e+00 -9.55762019e+00
 -9.55762019e+00 -1.25003872e+00 -5.75667383e-01 -5.75667383e-01
 -5.75667383e-01  1.01499433e+00  1.01499433e+00  1.01499433e+00
  7.20961734e+00  7.20961734e+00  7.20961734e+00  9.98366372e+00
  3.29996752e+01  3.29996752e+01  3.29996752e+01  1.16230464e+02
  1.27339291e+02  1.27339291e+02  1.27339291e+02  4.78170968e+02
  4.78170968e+02  4.78170968e+02  6.53521972e+02  1.32316922e+03
  1.32316922e+03  1.32316922e+03  2.79301317e+03  3.00878466e+03
  3.00878466e+03  3.00878466e+03  6.62377672e+03  6.62377672e+03
  6.62377672e+03  9.21108504e+03  2.55573593e+04  7.62875762e+04]
E1 = -728.3559496373587  E_coul = 201.6463263474142
Extra cycle  E= -526.709623289944  delta_E= -6.82e-13  |g|= 1.47e-07  |ddm|= 2.11e-07
    CPU time for scf_cycle      3.98 sec, wall time      0.33 sec
exp = [2.61828756e+04 7.61703631e+03 3.61757137e+03 1.58727817e+03
 4.15651176e+02 1.21194743e+02 3.88816466e+01 8.06494328e+00
 3.16237695e+00 3.98519477e-01 1.36285906e+03 6.64050183e+02
 2.97700237e+02 3.11234843e+02 6.09531470e+01 7.25912809e+00
 2.00176091e+01 7.70576237e-01 2.79053761e+00 2.22593931e-01]
grad_E = [-1.40251505e-06  2.20306096e-06 -2.13582794e-06  3.81463466e-05
  1.67224726e-05 -6.64041837e-06  1.61016252e-05  2.56993124e-05
 -5.50455249e-06 -4.65911527e-04 -5.02487524e-07  5.24493599e-06
  2.51514711e-05  2.15320128e-05 -3.90937192e-05 -2.30216253e-04
  4.41098186e-05 -2.35335317e-04  2.11876968e-04  1.44964108e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:02:16 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8738271        1
[INPUT] 0    0    [1    /1   ]  7617.03932753        1
[INPUT] 0    0    [1    /1   ]  3617.5688544         1
[INPUT] 0    0    [1    /1   ]  1587.33393234        1
[INPUT] 0    0    [1    /1   ]  415.608442192        1
[INPUT] 0    0    [1    /1   ]  121.197745787        1
[INPUT] 0    0    [1    /1   ]  38.8810528168        1
[INPUT] 0    0    [1    /1   ]  8.05982166002        1
[INPUT] 0    0    [1    /1   ]  3.16104162719        1
[INPUT] 0    0    [1    /1   ]  0.39855865811        1
[INPUT] 1    0    [1    /1   ]  1362.85835049        1
[INPUT] 1    0    [1    /1   ]  664.055449866        1
[INPUT] 1    0    [1    /1   ]  297.72447121         1
[INPUT] 1    0    [1    /1   ]  311.255575426        1
[INPUT] 1    0    [1    /1   ]  61.0241471188        1
[INPUT] 1    0    [1    /1   ]  7.27248459275        1
[INPUT] 1    0    [1    /1   ]  20.0476248114        1
[INPUT] 1    0    [1    /1   ]  0.77094859219        1
[INPUT] 1    0    [1    /1   ]  2.79463177221        1
[INPUT] 1    0    [1    /1   ]  0.222604256674       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.873827115603, 1.0]], [0, [7617.039327534297, 1.0]], [0, [3617.5688544003083, 1.0]], [0, [1587.3339323409002, 1.0]], [0, [415.6084421915369, 1.0]], [0, [121.19774578656755, 1.0]], [0, [38.88105281677159, 1.0]], [0, [8.059821660023882, 1.0]], [0, [3.161041627193208, 1.0]], [0, [0.3985586581101553, 1.0]], [1, [1362.8583504893481, 1.0]], [1, [664.055449866073, 1.0]], [1, [297.7244712095009, 1.0]], [1, [311.2555754263277, 1.0]], [1, [61.02414711881433, 1.0]], [1, [7.272484592747829, 1.0]], [1, [20.0476248114124, 1.0]], [1, [0.7709485921896939, 1.0]], [1, [2.7946317722137826, 1.0]], [1, [0.22260425667354275, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87382712]
bas 1, expnt(s) = [7617.03932753]
bas 2, expnt(s) = [3617.5688544]
bas 3, expnt(s) = [1587.33393234]
bas 4, expnt(s) = [415.60844219]
bas 5, expnt(s) = [121.19774579]
bas 6, expnt(s) = [38.88105282]
bas 7, expnt(s) = [8.05982166]
bas 8, expnt(s) = [3.16104163]
bas 9, expnt(s) = [0.39855866]
bas 10, expnt(s) = [1362.85835049]
bas 11, expnt(s) = [664.05544987]
bas 12, expnt(s) = [297.72447121]
bas 13, expnt(s) = [311.25557543]
bas 14, expnt(s) = [61.02414712]
bas 15, expnt(s) = [7.27248459]
bas 16, expnt(s) = [20.04762481]
bas 17, expnt(s) = [0.77094859]
bas 18, expnt(s) = [2.79463177]
bas 19, expnt(s) = [0.22260426]
CPU time:      1775.43
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828738e+04 5.20029534e+03 7.61703933e+03 2.05994048e+03
 3.61756885e+03 1.17849469e+03 1.58733393e+03 6.35354704e+02
 4.15608442e+02 2.32556399e+02 1.21197746e+02 9.22860230e+01
 3.88810528e+01 3.93385671e+01 8.05982166e+00 1.20853463e+01
 3.16104163e+00 5.98946023e+00 3.98558658e-01 1.26731393e+00
 1.36285835e+03 2.41572666e+04 6.64055450e+02 9.83421784e+03
 2.97724471e+02 3.60788394e+03 3.11255575e+02 3.81400113e+03
 6.10241471e+01 4.97578424e+02 7.27248459e+00 3.48407829e+01
 2.00476248e+01 1.23755084e+02 7.70948592e-01 2.10749313e+00
 2.79463177e+00 1.05412019e+01 2.22604257e-01 4.46068159e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.983008621014193
cond(S) = 92106.75615035532
E1 = -729.3787566180747  E_coul = 203.12167479627772
init E= -526.257081821797
    CPU time for initialize scf      0.64 sec, wall time      0.05 sec
  HOMO = -0.556989984701737  LUMO = 1.02691533341724
  mo_energy =
[-1.18335090e+02 -1.22078034e+01 -9.45157540e+00 -9.45157540e+00
 -9.45157540e+00 -1.22604750e+00 -5.56989985e-01 -5.56989985e-01
 -5.56989985e-01  1.02691533e+00  1.02691533e+00  1.02691533e+00
  7.28112370e+00  7.28112370e+00  7.28112370e+00  1.00444991e+01
  3.31771164e+01  3.31771164e+01  3.31771164e+01  1.16375645e+02
  1.27721018e+02  1.27721018e+02  1.27721018e+02  4.78779668e+02
  4.78779668e+02  4.78779668e+02  6.53759217e+02  1.32390755e+03
  1.32390755e+03  1.32390755e+03  2.79334924e+03  3.00964686e+03
  3.00964686e+03  3.00964686e+03  6.62476725e+03  6.62476725e+03
  6.62476725e+03  9.21158197e+03  2.55580064e+04  7.62883395e+04]
E1 = -727.9830670516469  E_coul = 201.27406832150174
cycle= 1 E= -526.708998730145  delta_E= -0.452  |g|= 0.183  |ddm|= 0.402
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.537824
diis-c [-0.28925489  1.        ]
  HOMO = -0.581479625162073  LUMO = 1.0109777580665
  mo_energy =
[-1.18627928e+02 -1.23316600e+01 -9.58544459e+00 -9.58544459e+00
 -9.58544459e+00 -1.25748764e+00 -5.81479625e-01 -5.81479625e-01
 -5.81479625e-01  1.01097776e+00  1.01097776e+00  1.01097776e+00
  7.20573330e+00  7.20573330e+00  7.20573330e+00  9.95315563e+00
  3.30382029e+01  3.30382029e+01  3.30382029e+01  1.16161522e+02
  1.27508332e+02  1.27508332e+02  1.27508332e+02  4.78488867e+02
  4.78488867e+02  4.78488867e+02  6.53421782e+02  1.32356112e+03
  1.32356112e+03  1.32356112e+03  2.79286816e+03  3.00923480e+03
  3.00923480e+03  3.00923480e+03  6.62424318e+03  6.62424318e+03
  6.62424318e+03  9.21098438e+03  2.55573151e+04  7.62875585e+04]
E1 = -728.4462414848489  E_coul = 201.73665289969236
cycle= 2 E= -526.709588585157  delta_E= -0.00059  |g|= 0.0334  |ddm|= 0.0386
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0667986
diis-c [-0.00266829  0.07331399  0.92668601]
  HOMO = -0.57476064694485  LUMO = 1.01602079600509
  mo_energy =
[-1.18569327e+02 -1.23008595e+01 -9.55334191e+00 -9.55334191e+00
 -9.55334191e+00 -1.24895613e+00 -5.74760647e-01 -5.74760647e-01
 -5.74760647e-01  1.01602080e+00  1.01602080e+00  1.01602080e+00
  7.22408847e+00  7.22408847e+00  7.22408847e+00  9.97774960e+00
  3.30707939e+01  3.30707939e+01  3.30707939e+01  1.16210396e+02
  1.27555665e+02  1.27555665e+02  1.27555665e+02  4.78546661e+02
  4.78546661e+02  4.78546661e+02  6.53482384e+02  1.32362275e+03
  1.32362275e+03  1.32362275e+03  2.79293289e+03  3.00929852e+03
  3.00929852e+03  3.00929852e+03  6.62430846e+03  6.62430846e+03
  6.62430846e+03  9.21105037e+03  2.55573816e+04  7.62876252e+04]
E1 = -728.3413376843814  E_coul = 201.63171448593326
cycle= 3 E= -526.709623198448  delta_E= -3.46e-05  |g|= 0.00482  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104527
diis-c [-4.24056484e-07 -1.10440178e-03  1.30778289e-01  8.70326113e-01]
  HOMO = -0.575683944523583  LUMO = 1.01533858965147
  mo_energy =
[-1.18576891e+02 -1.23049042e+01 -9.55765731e+00 -9.55765731e+00
 -9.55765731e+00 -1.25007724e+00 -5.75683945e-01 -5.75683945e-01
 -5.75683945e-01  1.01533859e+00  1.01533859e+00  1.01533859e+00
  7.22159606e+00  7.22159606e+00  7.22159606e+00  9.97460558e+00
  3.30664424e+01  3.30664424e+01  3.30664424e+01  1.16204093e+02
  1.27549501e+02  1.27549501e+02  1.27549501e+02  4.78539201e+02
  4.78539201e+02  4.78539201e+02  6.53474527e+02  1.32361477e+03
  1.32361477e+03  1.32361477e+03  2.79292433e+03  3.00929019e+03
  3.00929019e+03  3.00929019e+03  6.62429978e+03  6.62429978e+03
  6.62429978e+03  9.21104150e+03  2.55573726e+04  7.62876160e+04]
E1 = -728.3555519040041  E_coul = 201.64592786523883
cycle= 4 E= -526.709624038765  delta_E= -8.4e-07  |g|= 5.88e-05  |ddm|= 0.00131
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122122
diis-c [-1.31167790e-09  6.37644733e-05 -8.97932520e-03 -7.03794397e-02
  1.07929500e+00]
  HOMO = -0.575672122483398  LUMO = 1.01534731452723
  mo_energy =
[-1.18576895e+02 -1.23048758e+01 -9.55764038e+00 -9.55764038e+00
 -9.55764038e+00 -1.25005851e+00 -5.75672122e-01 -5.75672122e-01
 -5.75672122e-01  1.01534731e+00  1.01534731e+00  1.01534731e+00
  7.22161622e+00  7.22161622e+00  7.22161622e+00  9.97464039e+00
  3.30664582e+01  3.30664582e+01  3.30664582e+01  1.16204103e+02
  1.27549508e+02  1.27549508e+02  1.27549508e+02  4.78539197e+02
  4.78539197e+02  4.78539197e+02  6.53474515e+02  1.32361475e+03
  1.32361475e+03  1.32361475e+03  2.79292430e+03  3.00929017e+03
  3.00929017e+03  3.00929017e+03  6.62429975e+03  6.62429975e+03
  6.62429975e+03  9.21104146e+03  2.55573725e+04  7.62876160e+04]
E1 = -728.3555501697214  E_coul = 201.64592613084926
cycle= 5 E= -526.709624038872  delta_E= -1.07e-10  |g|= 7.72e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3555501697214  E_coul = 201.64592613084926
  HOMO = -0.575675557060955  LUMO = 1.01534481736736
  mo_energy =
[-1.18576912e+02 -1.23048879e+01 -9.55765307e+00 -9.55765307e+00
 -9.55765307e+00 -1.25006274e+00 -5.75675557e-01 -5.75675557e-01
 -5.75675557e-01  1.01534482e+00  1.01534482e+00  1.01534482e+00
  7.22160792e+00  7.22160792e+00  7.22160792e+00  9.97463049e+00
  3.30664457e+01  3.30664457e+01  3.30664457e+01  1.16204087e+02
  1.27549493e+02  1.27549493e+02  1.27549493e+02  4.78539180e+02
  4.78539180e+02  4.78539180e+02  6.53474497e+02  1.32361474e+03
  1.32361474e+03  1.32361474e+03  2.79292428e+03  3.00929015e+03
  3.00929015e+03  3.00929015e+03  6.62429973e+03  6.62429973e+03
  6.62429973e+03  9.21104144e+03  2.55573725e+04  7.62876160e+04]
E1 = -728.3555882284819  E_coul = 201.64596418960707
Extra cycle  E= -526.709624038875  delta_E= -2.73e-12  |g|= 2.28e-06  |ddm|= 3.93e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.23 sec
exp = [2.61828738e+04 7.61703933e+03 3.61756885e+03 1.58733393e+03
 4.15608442e+02 1.21197746e+02 3.88810528e+01 8.05982166e+00
 3.16104163e+00 3.98558658e-01 1.36285835e+03 6.64055450e+02
 2.97724471e+02 3.11255575e+02 6.10241471e+01 7.27248459e+00
 2.00476248e+01 7.70948592e-01 2.79463177e+00 2.22604257e-01]
E = -526.7096240388748
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:02:17 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8738271        1
[INPUT] 0    0    [1    /1   ]  7617.03932753        1
[INPUT] 0    0    [1    /1   ]  3617.5688544         1
[INPUT] 0    0    [1    /1   ]  1587.33393234        1
[INPUT] 0    0    [1    /1   ]  415.608442192        1
[INPUT] 0    0    [1    /1   ]  121.197745787        1
[INPUT] 0    0    [1    /1   ]  38.8810528168        1
[INPUT] 0    0    [1    /1   ]  8.05982166002        1
[INPUT] 0    0    [1    /1   ]  3.16104162719        1
[INPUT] 0    0    [1    /1   ]  0.39855865811        1
[INPUT] 1    0    [1    /1   ]  1362.85835049        1
[INPUT] 1    0    [1    /1   ]  664.055449866        1
[INPUT] 1    0    [1    /1   ]  297.72447121         1
[INPUT] 1    0    [1    /1   ]  311.255575426        1
[INPUT] 1    0    [1    /1   ]  61.0241471188        1
[INPUT] 1    0    [1    /1   ]  7.27248459275        1
[INPUT] 1    0    [1    /1   ]  20.0476248114        1
[INPUT] 1    0    [1    /1   ]  0.77094859219        1
[INPUT] 1    0    [1    /1   ]  2.79463177221        1
[INPUT] 1    0    [1    /1   ]  0.222604256674       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.873827115603, 1.0]], [0, [7617.039327534297, 1.0]], [0, [3617.5688544003083, 1.0]], [0, [1587.3339323409002, 1.0]], [0, [415.6084421915369, 1.0]], [0, [121.19774578656755, 1.0]], [0, [38.88105281677159, 1.0]], [0, [8.059821660023882, 1.0]], [0, [3.161041627193208, 1.0]], [0, [0.3985586581101553, 1.0]], [1, [1362.8583504893481, 1.0]], [1, [664.055449866073, 1.0]], [1, [297.7244712095009, 1.0]], [1, [311.2555754263277, 1.0]], [1, [61.02414711881433, 1.0]], [1, [7.272484592747829, 1.0]], [1, [20.0476248114124, 1.0]], [1, [0.7709485921896939, 1.0]], [1, [2.7946317722137826, 1.0]], [1, [0.22260425667354275, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87382712]
bas 1, expnt(s) = [7617.03932753]
bas 2, expnt(s) = [3617.5688544]
bas 3, expnt(s) = [1587.33393234]
bas 4, expnt(s) = [415.60844219]
bas 5, expnt(s) = [121.19774579]
bas 6, expnt(s) = [38.88105282]
bas 7, expnt(s) = [8.05982166]
bas 8, expnt(s) = [3.16104163]
bas 9, expnt(s) = [0.39855866]
bas 10, expnt(s) = [1362.85835049]
bas 11, expnt(s) = [664.05544987]
bas 12, expnt(s) = [297.72447121]
bas 13, expnt(s) = [311.25557543]
bas 14, expnt(s) = [61.02414712]
bas 15, expnt(s) = [7.27248459]
bas 16, expnt(s) = [20.04762481]
bas 17, expnt(s) = [0.77094859]
bas 18, expnt(s) = [2.79463177]
bas 19, expnt(s) = [0.22260426]
CPU time:      1776.54
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828738e+04 5.20029534e+03 7.61703933e+03 2.05994048e+03
 3.61756885e+03 1.17849469e+03 1.58733393e+03 6.35354704e+02
 4.15608442e+02 2.32556399e+02 1.21197746e+02 9.22860230e+01
 3.88810528e+01 3.93385671e+01 8.05982166e+00 1.20853463e+01
 3.16104163e+00 5.98946023e+00 3.98558658e-01 1.26731393e+00
 1.36285835e+03 2.41572666e+04 6.64055450e+02 9.83421784e+03
 2.97724471e+02 3.60788394e+03 3.11255575e+02 3.81400113e+03
 6.10241471e+01 4.97578424e+02 7.27248459e+00 3.48407829e+01
 2.00476248e+01 1.23755084e+02 7.70948592e-01 2.10749313e+00
 2.79463177e+00 1.05412019e+01 2.22604257e-01 4.46068159e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.983008621014193
cond(S) = 92106.75615035532
E1 = -729.3787566180747  E_coul = 203.12167479627772
init E= -526.257081821797
    CPU time for initialize scf      0.64 sec, wall time      0.05 sec
  HOMO = -0.556989984701737  LUMO = 1.02691533341724
  mo_energy =
[-1.18335090e+02 -1.22078034e+01 -9.45157540e+00 -9.45157540e+00
 -9.45157540e+00 -1.22604750e+00 -5.56989985e-01 -5.56989985e-01
 -5.56989985e-01  1.02691533e+00  1.02691533e+00  1.02691533e+00
  7.28112370e+00  7.28112370e+00  7.28112370e+00  1.00444991e+01
  3.31771164e+01  3.31771164e+01  3.31771164e+01  1.16375645e+02
  1.27721018e+02  1.27721018e+02  1.27721018e+02  4.78779668e+02
  4.78779668e+02  4.78779668e+02  6.53759217e+02  1.32390755e+03
  1.32390755e+03  1.32390755e+03  2.79334924e+03  3.00964686e+03
  3.00964686e+03  3.00964686e+03  6.62476725e+03  6.62476725e+03
  6.62476725e+03  9.21158197e+03  2.55580064e+04  7.62883395e+04]
E1 = -727.9830670516469  E_coul = 201.27406832150174
cycle= 1 E= -526.708998730145  delta_E= -0.452  |g|= 0.183  |ddm|= 0.402
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.537824
diis-c [-0.28925489  1.        ]
  HOMO = -0.581479625162073  LUMO = 1.0109777580665
  mo_energy =
[-1.18627928e+02 -1.23316600e+01 -9.58544459e+00 -9.58544459e+00
 -9.58544459e+00 -1.25748764e+00 -5.81479625e-01 -5.81479625e-01
 -5.81479625e-01  1.01097776e+00  1.01097776e+00  1.01097776e+00
  7.20573330e+00  7.20573330e+00  7.20573330e+00  9.95315563e+00
  3.30382029e+01  3.30382029e+01  3.30382029e+01  1.16161522e+02
  1.27508332e+02  1.27508332e+02  1.27508332e+02  4.78488867e+02
  4.78488867e+02  4.78488867e+02  6.53421782e+02  1.32356112e+03
  1.32356112e+03  1.32356112e+03  2.79286816e+03  3.00923480e+03
  3.00923480e+03  3.00923480e+03  6.62424318e+03  6.62424318e+03
  6.62424318e+03  9.21098438e+03  2.55573151e+04  7.62875585e+04]
E1 = -728.4462414848489  E_coul = 201.73665289969236
cycle= 2 E= -526.709588585157  delta_E= -0.00059  |g|= 0.0334  |ddm|= 0.0386
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0667986
diis-c [-0.00266829  0.07331399  0.92668601]
  HOMO = -0.57476064694485  LUMO = 1.01602079600509
  mo_energy =
[-1.18569327e+02 -1.23008595e+01 -9.55334191e+00 -9.55334191e+00
 -9.55334191e+00 -1.24895613e+00 -5.74760647e-01 -5.74760647e-01
 -5.74760647e-01  1.01602080e+00  1.01602080e+00  1.01602080e+00
  7.22408847e+00  7.22408847e+00  7.22408847e+00  9.97774960e+00
  3.30707939e+01  3.30707939e+01  3.30707939e+01  1.16210396e+02
  1.27555665e+02  1.27555665e+02  1.27555665e+02  4.78546661e+02
  4.78546661e+02  4.78546661e+02  6.53482384e+02  1.32362275e+03
  1.32362275e+03  1.32362275e+03  2.79293289e+03  3.00929852e+03
  3.00929852e+03  3.00929852e+03  6.62430846e+03  6.62430846e+03
  6.62430846e+03  9.21105037e+03  2.55573816e+04  7.62876252e+04]
E1 = -728.3413376843814  E_coul = 201.63171448593326
cycle= 3 E= -526.709623198448  delta_E= -3.46e-05  |g|= 0.00482  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104527
diis-c [-4.24056484e-07 -1.10440178e-03  1.30778289e-01  8.70326113e-01]
  HOMO = -0.575683944523583  LUMO = 1.01533858965147
  mo_energy =
[-1.18576891e+02 -1.23049042e+01 -9.55765731e+00 -9.55765731e+00
 -9.55765731e+00 -1.25007724e+00 -5.75683945e-01 -5.75683945e-01
 -5.75683945e-01  1.01533859e+00  1.01533859e+00  1.01533859e+00
  7.22159606e+00  7.22159606e+00  7.22159606e+00  9.97460558e+00
  3.30664424e+01  3.30664424e+01  3.30664424e+01  1.16204093e+02
  1.27549501e+02  1.27549501e+02  1.27549501e+02  4.78539201e+02
  4.78539201e+02  4.78539201e+02  6.53474527e+02  1.32361477e+03
  1.32361477e+03  1.32361477e+03  2.79292433e+03  3.00929019e+03
  3.00929019e+03  3.00929019e+03  6.62429978e+03  6.62429978e+03
  6.62429978e+03  9.21104150e+03  2.55573726e+04  7.62876160e+04]
E1 = -728.3555519040041  E_coul = 201.64592786523883
cycle= 4 E= -526.709624038765  delta_E= -8.4e-07  |g|= 5.88e-05  |ddm|= 0.00131
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122122
diis-c [-1.31167790e-09  6.37644733e-05 -8.97932520e-03 -7.03794397e-02
  1.07929500e+00]
  HOMO = -0.575672122483398  LUMO = 1.01534731452723
  mo_energy =
[-1.18576895e+02 -1.23048758e+01 -9.55764038e+00 -9.55764038e+00
 -9.55764038e+00 -1.25005851e+00 -5.75672122e-01 -5.75672122e-01
 -5.75672122e-01  1.01534731e+00  1.01534731e+00  1.01534731e+00
  7.22161622e+00  7.22161622e+00  7.22161622e+00  9.97464039e+00
  3.30664582e+01  3.30664582e+01  3.30664582e+01  1.16204103e+02
  1.27549508e+02  1.27549508e+02  1.27549508e+02  4.78539197e+02
  4.78539197e+02  4.78539197e+02  6.53474515e+02  1.32361475e+03
  1.32361475e+03  1.32361475e+03  2.79292430e+03  3.00929017e+03
  3.00929017e+03  3.00929017e+03  6.62429975e+03  6.62429975e+03
  6.62429975e+03  9.21104146e+03  2.55573725e+04  7.62876160e+04]
E1 = -728.3555501697214  E_coul = 201.64592613084926
cycle= 5 E= -526.709624038872  delta_E= -1.07e-10  |g|= 7.72e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3555501697214  E_coul = 201.64592613084926
  HOMO = -0.575675557060955  LUMO = 1.01534481736736
  mo_energy =
[-1.18576912e+02 -1.23048879e+01 -9.55765307e+00 -9.55765307e+00
 -9.55765307e+00 -1.25006274e+00 -5.75675557e-01 -5.75675557e-01
 -5.75675557e-01  1.01534482e+00  1.01534482e+00  1.01534482e+00
  7.22160792e+00  7.22160792e+00  7.22160792e+00  9.97463049e+00
  3.30664457e+01  3.30664457e+01  3.30664457e+01  1.16204087e+02
  1.27549493e+02  1.27549493e+02  1.27549493e+02  4.78539180e+02
  4.78539180e+02  4.78539180e+02  6.53474497e+02  1.32361474e+03
  1.32361474e+03  1.32361474e+03  2.79292428e+03  3.00929015e+03
  3.00929015e+03  3.00929015e+03  6.62429973e+03  6.62429973e+03
  6.62429973e+03  9.21104144e+03  2.55573725e+04  7.62876160e+04]
E1 = -728.3555882284819  E_coul = 201.64596418960707
Extra cycle  E= -526.709624038875  delta_E= -2.73e-12  |g|= 2.28e-06  |ddm|= 3.93e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 92106.75615035532
E1 = -728.3555882284819  E_coul = 201.64596418960707
init E= -526.709624038875
    CPU time for initialize scf      3.78 sec, wall time      0.21 sec
  HOMO = -0.575674860793602  LUMO = 1.01534532953292
  mo_energy =
[-1.18576908e+02 -1.23048851e+01 -9.55765019e+00 -9.55765019e+00
 -9.55765019e+00 -1.25006186e+00 -5.75674861e-01 -5.75674861e-01
 -5.75674861e-01  1.01534533e+00  1.01534533e+00  1.01534533e+00
  7.22160969e+00  7.22160969e+00  7.22160969e+00  9.97463274e+00
  3.30664486e+01  3.30664486e+01  3.30664486e+01  1.16204091e+02
  1.27549497e+02  1.27549497e+02  1.27549497e+02  4.78539185e+02
  4.78539185e+02  4.78539185e+02  6.53474502e+02  1.32361474e+03
  1.32361474e+03  1.32361474e+03  2.79292428e+03  3.00929016e+03
  3.00929016e+03  3.00929016e+03  6.62429974e+03  6.62429974e+03
  6.62429974e+03  9.21104145e+03  2.55573725e+04  7.62876160e+04]
E1 = -728.3555791847084  E_coul = 201.64595514583223
cycle= 1 E= -526.709624038876  delta_E= -1.36e-12  |g|= 5.85e-07  |ddm|= 8.98e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3555791847084  E_coul = 201.64595514583223
  HOMO = -0.575675014716719  LUMO = 1.01534521567947
  mo_energy =
[-1.18576909e+02 -1.23048858e+01 -9.55765087e+00 -9.55765087e+00
 -9.55765087e+00 -1.25006206e+00 -5.75675015e-01 -5.75675015e-01
 -5.75675015e-01  1.01534522e+00  1.01534522e+00  1.01534522e+00
  7.22160928e+00  7.22160928e+00  7.22160928e+00  9.97463222e+00
  3.30664479e+01  3.30664479e+01  3.30664479e+01  1.16204090e+02
  1.27549496e+02  1.27549496e+02  1.27549496e+02  4.78539184e+02
  4.78539184e+02  4.78539184e+02  6.53474501e+02  1.32361474e+03
  1.32361474e+03  1.32361474e+03  2.79292428e+03  3.00929015e+03
  3.00929015e+03  3.00929015e+03  6.62429973e+03  6.62429973e+03
  6.62429973e+03  9.21104145e+03  2.55573725e+04  7.62876160e+04]
E1 = -728.3555813883908  E_coul = 201.6459573495151
Extra cycle  E= -526.709624038876  delta_E= 5.68e-13  |g|= 1.47e-07  |ddm|= 2.11e-07
    CPU time for scf_cycle      3.90 sec, wall time      0.33 sec
exp = [2.61828738e+04 7.61703933e+03 3.61756885e+03 1.58733393e+03
 4.15608442e+02 1.21197746e+02 3.88810528e+01 8.05982166e+00
 3.16104163e+00 3.98558658e-01 1.36285835e+03 6.64055450e+02
 2.97724471e+02 3.11255575e+02 6.10241471e+01 7.27248459e+00
 2.00476248e+01 7.70948592e-01 2.79463177e+00 2.22604257e-01]
grad_E = [-1.40297278e-06  2.20687857e-06 -2.13599292e-06  3.82719528e-05
  1.45740352e-05  3.47697055e-06  1.52949676e-06  1.11858378e-06
  2.10399929e-06 -2.41806010e-05 -5.06127740e-07  5.19825863e-06
  2.48861826e-05  2.13035914e-05 -3.16894325e-05 -8.25721017e-07
 -1.25937619e-05 -3.55664976e-05 -1.31408520e-05  1.17877002e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:02:21 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8734811        1
[INPUT] 0    0    [1    /1   ]  7617.03992302        1
[INPUT] 0    0    [1    /1   ]  3617.56836856        1
[INPUT] 0    0    [1    /1   ]  1587.34501904        1
[INPUT] 0    0    [1    /1   ]  415.599027421        1
[INPUT] 0    0    [1    /1   ]  121.195086747        1
[INPUT] 0    0    [1    /1   ]  38.8803385689        1
[INPUT] 0    0    [1    /1   ]  8.05942710905        1
[INPUT] 0    0    [1    /1   ]  3.16091379962        1
[INPUT] 0    0    [1    /1   ]  0.398560784189       1
[INPUT] 1    0    [1    /1   ]  1362.85821195        1
[INPUT] 1    0    [1    /1   ]  664.056478786        1
[INPUT] 1    0    [1    /1   ]  297.729208102        1
[INPUT] 1    0    [1    /1   ]  311.259628907        1
[INPUT] 1    0    [1    /1   ]  61.0378029372        1
[INPUT] 1    0    [1    /1   ]  7.27445556717        1
[INPUT] 1    0    [1    /1   ]  20.0528075951        1
[INPUT] 1    0    [1    /1   ]  0.771034129544       1
[INPUT] 1    0    [1    /1   ]  2.7953624467         1
[INPUT] 1    0    [1    /1   ]  0.222617934348       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.873481129456, 1.0]], [0, [7617.039923023223, 1.0]], [0, [3617.568368559392, 1.0]], [0, [1587.3450190354745, 1.0]], [0, [415.5990274209098, 1.0]], [0, [121.19508674744067, 1.0]], [0, [38.880338568867806, 1.0]], [0, [8.059427109045888, 1.0]], [0, [3.160913799615972, 1.0]], [0, [0.398560784189241, 1.0]], [1, [1362.858211948072, 1.0]], [1, [664.0564787855242, 1.0]], [1, [297.72920810226987, 1.0]], [1, [311.25962890713123, 1.0]], [1, [61.037802937215204, 1.0]], [1, [7.274455567174901, 1.0]], [1, [20.052807595060543, 1.0]], [1, [0.771034129543633, 1.0]], [1, [2.7953624466977463, 1.0]], [1, [0.2226179343482728, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87348113]
bas 1, expnt(s) = [7617.03992302]
bas 2, expnt(s) = [3617.56836856]
bas 3, expnt(s) = [1587.34501904]
bas 4, expnt(s) = [415.59902742]
bas 5, expnt(s) = [121.19508675]
bas 6, expnt(s) = [38.88033857]
bas 7, expnt(s) = [8.05942711]
bas 8, expnt(s) = [3.1609138]
bas 9, expnt(s) = [0.39856078]
bas 10, expnt(s) = [1362.85821195]
bas 11, expnt(s) = [664.05647879]
bas 12, expnt(s) = [297.7292081]
bas 13, expnt(s) = [311.25962891]
bas 14, expnt(s) = [61.03780294]
bas 15, expnt(s) = [7.27445557]
bas 16, expnt(s) = [20.0528076]
bas 17, expnt(s) = [0.77103413]
bas 18, expnt(s) = [2.79536245]
bas 19, expnt(s) = [0.22261793]
CPU time:      1786.13
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828735e+04 5.20029529e+03 7.61703992e+03 2.05994060e+03
 3.61756837e+03 1.17849457e+03 1.58734502e+03 6.35358032e+02
 4.15599027e+02 2.32552448e+02 1.21195087e+02 9.22845045e+01
 3.88803386e+01 3.93380251e+01 8.05942711e+00 1.20849026e+01
 3.16091380e+00 5.98927858e+00 3.98560784e-01 1.26731901e+00
 1.36285821e+03 2.41572635e+04 6.64056479e+02 9.83423689e+03
 2.97729208e+02 3.60795569e+03 3.11259629e+02 3.81406321e+03
 6.10378029e+01 4.97717612e+02 7.27445557e+00 3.48525864e+01
 2.00528076e+01 1.23795078e+02 7.71034130e-01 2.10778542e+00
 2.79536245e+00 1.05446471e+01 2.22617934e-01 4.46102419e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98300587133189
cond(S) = 92141.92115708011
E1 = -729.3787828433991  E_coul = 203.12169527206248
init E= -526.257087571337
    CPU time for initialize scf      1.26 sec, wall time      0.07 sec
  HOMO = -0.556988726473732  LUMO = 1.02704513455823
  mo_energy =
[-1.18335087e+02 -1.22078027e+01 -9.45157461e+00 -9.45157461e+00
 -9.45157461e+00 -1.22604677e+00 -5.56988726e-01 -5.56988726e-01
 -5.56988726e-01  1.02704513e+00  1.02704513e+00  1.02704513e+00
  7.28328849e+00  7.28328849e+00  7.28328849e+00  1.00437089e+01
  3.31880699e+01  3.31880699e+01  3.31880699e+01  1.16370943e+02
  1.27757649e+02  1.27757649e+02  1.27757649e+02  4.78846668e+02
  4.78846668e+02  4.78846668e+02  6.53741706e+02  1.32398990e+03
  1.32398990e+03  1.32398990e+03  2.79331791e+03  3.00974117e+03
  3.00974117e+03  3.00974117e+03  6.62486535e+03  6.62486535e+03
  6.62486535e+03  9.21155862e+03  2.55579945e+04  7.62883338e+04]
E1 = -727.983084056488  E_coul = 201.27408531008314
cycle= 1 E= -526.708998746405  delta_E= -0.452  |g|= 0.183  |ddm|= 0.402
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.537832
diis-c [-0.28926351  1.        ]
  HOMO = -0.581478363620304  LUMO = 1.0111045869603
  mo_energy =
[-1.18627925e+02 -1.23316594e+01 -9.58544448e+00 -9.58544448e+00
 -9.58544448e+00 -1.25748707e+00 -5.81478364e-01 -5.81478364e-01
 -5.81478364e-01  1.01110459e+00  1.01110459e+00  1.01110459e+00
  7.20788180e+00  7.20788180e+00  7.20788180e+00  9.95236829e+00
  3.30491389e+01  3.30491389e+01  3.30491389e+01  1.16156823e+02
  1.27544950e+02  1.27544950e+02  1.27544950e+02  4.78555866e+02
  4.78555866e+02  4.78555866e+02  6.53404274e+02  1.32364347e+03
  1.32364347e+03  1.32364347e+03  2.79283683e+03  3.00932912e+03
  3.00932912e+03  3.00932912e+03  6.62434129e+03  6.62434129e+03
  6.62434129e+03  9.21096103e+03  2.55573033e+04  7.62875527e+04]
E1 = -728.446254020592  E_coul = 201.73666542124553
cycle= 2 E= -526.709588599346  delta_E= -0.00059  |g|= 0.0334  |ddm|= 0.0386
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0667994
diis-c [-0.00266831  0.07331469  0.92668531]
  HOMO = -0.574759509786219  LUMO = 1.01614832921277
  mo_energy =
[-1.18569324e+02 -1.23008592e+01 -9.55334211e+00 -9.55334211e+00
 -9.55334211e+00 -1.24895570e+00 -5.74759510e-01 -5.74759510e-01
 -5.74759510e-01  1.01614833e+00  1.01614833e+00  1.01614833e+00
  7.22624020e+00  7.22624020e+00  7.22624020e+00  9.97696117e+00
  3.30817335e+01  3.30817335e+01  3.30817335e+01  1.16205696e+02
  1.27592285e+02  1.27592285e+02  1.27592285e+02  4.78613660e+02
  4.78613660e+02  4.78613660e+02  6.53464875e+02  1.32370510e+03
  1.32370510e+03  1.32370510e+03  2.79290156e+03  3.00939284e+03
  3.00939284e+03  3.00939284e+03  6.62440657e+03  6.62440657e+03
  6.62440657e+03  9.21102702e+03  2.55573697e+04  7.62876194e+04]
E1 = -728.3413518521115  E_coul = 201.63172863990857
cycle= 3 E= -526.709623212203  delta_E= -3.46e-05  |g|= 0.00482  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104527
diis-c [-4.24097238e-07 -1.10442859e-03  1.30777213e-01  8.70327216e-01]
  HOMO = -0.575682777300027  LUMO = 1.01546603688506
  mo_energy =
[-1.18576888e+02 -1.23049038e+01 -9.55765742e+00 -9.55765742e+00
 -9.55765742e+00 -1.25007677e+00 -5.75682777e-01 -5.75682777e-01
 -5.75682777e-01  1.01546604e+00  1.01546604e+00  1.01546604e+00
  7.22374738e+00  7.22374738e+00  7.22374738e+00  9.97381733e+00
  3.30773816e+01  3.30773816e+01  3.30773816e+01  1.16199393e+02
  1.27586120e+02  1.27586120e+02  1.27586120e+02  4.78606200e+02
  4.78606200e+02  4.78606200e+02  6.53457019e+02  1.32369712e+03
  1.32369712e+03  1.32369712e+03  2.79289300e+03  3.00938451e+03
  3.00938451e+03  3.00938451e+03  6.62439789e+03  6.62439789e+03
  6.62439789e+03  9.21101815e+03  2.55573607e+04  7.62876103e+04]
E1 = -728.3555656756361  E_coul = 201.64594162314634
cycle= 4 E= -526.70962405249  delta_E= -8.4e-07  |g|= 5.88e-05  |ddm|= 0.00131
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122135
diis-c [-1.31142895e-09  6.37670362e-05 -8.97954945e-03 -7.03828615e-02
  1.07929864e+00]
  HOMO = -0.575670956538525  LUMO = 1.01547476195317
  mo_energy =
[-1.18576892e+02 -1.23048755e+01 -9.55764050e+00 -9.55764050e+00
 -9.55764050e+00 -1.25005804e+00 -5.75670957e-01 -5.75670957e-01
 -5.75670957e-01  1.01547476e+00  1.01547476e+00  1.01547476e+00
  7.22376753e+00  7.22376753e+00  7.22376753e+00  9.97385214e+00
  3.30773973e+01  3.30773973e+01  3.30773973e+01  1.16199403e+02
  1.27586128e+02  1.27586128e+02  1.27586128e+02  4.78606197e+02
  4.78606197e+02  4.78606197e+02  6.53457007e+02  1.32369710e+03
  1.32369710e+03  1.32369710e+03  2.79289297e+03  3.00938449e+03
  3.00938449e+03  3.00938449e+03  6.62439785e+03  6.62439785e+03
  6.62439785e+03  9.21101811e+03  2.55573607e+04  7.62876102e+04]
E1 = -728.3555639563789  E_coul = 201.64593990378256
cycle= 5 E= -526.709624052596  delta_E= -1.07e-10  |g|= 7.72e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3555639563789  E_coul = 201.64593990378256
  HOMO = -0.575674391005534  LUMO = 1.01547226449246
  mo_energy =
[-1.18576910e+02 -1.23048876e+01 -9.55765319e+00 -9.55765319e+00
 -9.55765319e+00 -1.25006227e+00 -5.75674391e-01 -5.75674391e-01
 -5.75674391e-01  1.01547226e+00  1.01547226e+00  1.01547226e+00
  7.22375923e+00  7.22375923e+00  7.22375923e+00  9.97384224e+00
  3.30773849e+01  3.30773849e+01  3.30773849e+01  1.16199388e+02
  1.27586112e+02  1.27586112e+02  1.27586112e+02  4.78606180e+02
  4.78606180e+02  4.78606180e+02  6.53456989e+02  1.32369709e+03
  1.32369709e+03  1.32369709e+03  2.79289295e+03  3.00938447e+03
  3.00938447e+03  3.00938447e+03  6.62439784e+03  6.62439784e+03
  6.62439784e+03  9.21101809e+03  2.55573606e+04  7.62876102e+04]
E1 = -728.355602013962  E_coul = 201.64597796136343
Extra cycle  E= -526.709624052599  delta_E= -2.16e-12  |g|= 2.28e-06  |ddm|= 3.93e-06
    CPU time for scf_cycle      1.45 sec, wall time      0.25 sec
exp = [2.61828735e+04 7.61703992e+03 3.61756837e+03 1.58734502e+03
 4.15599027e+02 1.21195087e+02 3.88803386e+01 8.05942711e+00
 3.16091380e+00 3.98560784e-01 1.36285821e+03 6.64056479e+02
 2.97729208e+02 3.11259629e+02 6.10378029e+01 7.27445557e+00
 2.00528076e+01 7.71034130e-01 2.79536245e+00 2.22617934e-01]
E = -526.7096240525985
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:02:22 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8734811        1
[INPUT] 0    0    [1    /1   ]  7617.03992302        1
[INPUT] 0    0    [1    /1   ]  3617.56836856        1
[INPUT] 0    0    [1    /1   ]  1587.34501904        1
[INPUT] 0    0    [1    /1   ]  415.599027421        1
[INPUT] 0    0    [1    /1   ]  121.195086747        1
[INPUT] 0    0    [1    /1   ]  38.8803385689        1
[INPUT] 0    0    [1    /1   ]  8.05942710905        1
[INPUT] 0    0    [1    /1   ]  3.16091379962        1
[INPUT] 0    0    [1    /1   ]  0.398560784189       1
[INPUT] 1    0    [1    /1   ]  1362.85821195        1
[INPUT] 1    0    [1    /1   ]  664.056478786        1
[INPUT] 1    0    [1    /1   ]  297.729208102        1
[INPUT] 1    0    [1    /1   ]  311.259628907        1
[INPUT] 1    0    [1    /1   ]  61.0378029372        1
[INPUT] 1    0    [1    /1   ]  7.27445556717        1
[INPUT] 1    0    [1    /1   ]  20.0528075951        1
[INPUT] 1    0    [1    /1   ]  0.771034129544       1
[INPUT] 1    0    [1    /1   ]  2.7953624467         1
[INPUT] 1    0    [1    /1   ]  0.222617934348       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.873481129456, 1.0]], [0, [7617.039923023223, 1.0]], [0, [3617.568368559392, 1.0]], [0, [1587.3450190354745, 1.0]], [0, [415.5990274209098, 1.0]], [0, [121.19508674744067, 1.0]], [0, [38.880338568867806, 1.0]], [0, [8.059427109045888, 1.0]], [0, [3.160913799615972, 1.0]], [0, [0.398560784189241, 1.0]], [1, [1362.858211948072, 1.0]], [1, [664.0564787855242, 1.0]], [1, [297.72920810226987, 1.0]], [1, [311.25962890713123, 1.0]], [1, [61.037802937215204, 1.0]], [1, [7.274455567174901, 1.0]], [1, [20.052807595060543, 1.0]], [1, [0.771034129543633, 1.0]], [1, [2.7953624466977463, 1.0]], [1, [0.2226179343482728, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87348113]
bas 1, expnt(s) = [7617.03992302]
bas 2, expnt(s) = [3617.56836856]
bas 3, expnt(s) = [1587.34501904]
bas 4, expnt(s) = [415.59902742]
bas 5, expnt(s) = [121.19508675]
bas 6, expnt(s) = [38.88033857]
bas 7, expnt(s) = [8.05942711]
bas 8, expnt(s) = [3.1609138]
bas 9, expnt(s) = [0.39856078]
bas 10, expnt(s) = [1362.85821195]
bas 11, expnt(s) = [664.05647879]
bas 12, expnt(s) = [297.7292081]
bas 13, expnt(s) = [311.25962891]
bas 14, expnt(s) = [61.03780294]
bas 15, expnt(s) = [7.27445557]
bas 16, expnt(s) = [20.0528076]
bas 17, expnt(s) = [0.77103413]
bas 18, expnt(s) = [2.79536245]
bas 19, expnt(s) = [0.22261793]
CPU time:      1787.86
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828735e+04 5.20029529e+03 7.61703992e+03 2.05994060e+03
 3.61756837e+03 1.17849457e+03 1.58734502e+03 6.35358032e+02
 4.15599027e+02 2.32552448e+02 1.21195087e+02 9.22845045e+01
 3.88803386e+01 3.93380251e+01 8.05942711e+00 1.20849026e+01
 3.16091380e+00 5.98927858e+00 3.98560784e-01 1.26731901e+00
 1.36285821e+03 2.41572635e+04 6.64056479e+02 9.83423689e+03
 2.97729208e+02 3.60795569e+03 3.11259629e+02 3.81406321e+03
 6.10378029e+01 4.97717612e+02 7.27445557e+00 3.48525864e+01
 2.00528076e+01 1.23795078e+02 7.71034130e-01 2.10778542e+00
 2.79536245e+00 1.05446471e+01 2.22617934e-01 4.46102419e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98300587133189
cond(S) = 92141.92115708011
E1 = -729.3787828433991  E_coul = 203.12169527206248
init E= -526.257087571337
    CPU time for initialize scf      0.63 sec, wall time      0.05 sec
  HOMO = -0.556988726473732  LUMO = 1.02704513455823
  mo_energy =
[-1.18335087e+02 -1.22078027e+01 -9.45157461e+00 -9.45157461e+00
 -9.45157461e+00 -1.22604677e+00 -5.56988726e-01 -5.56988726e-01
 -5.56988726e-01  1.02704513e+00  1.02704513e+00  1.02704513e+00
  7.28328849e+00  7.28328849e+00  7.28328849e+00  1.00437089e+01
  3.31880699e+01  3.31880699e+01  3.31880699e+01  1.16370943e+02
  1.27757649e+02  1.27757649e+02  1.27757649e+02  4.78846668e+02
  4.78846668e+02  4.78846668e+02  6.53741706e+02  1.32398990e+03
  1.32398990e+03  1.32398990e+03  2.79331791e+03  3.00974117e+03
  3.00974117e+03  3.00974117e+03  6.62486535e+03  6.62486535e+03
  6.62486535e+03  9.21155862e+03  2.55579945e+04  7.62883338e+04]
E1 = -727.983084056488  E_coul = 201.27408531008314
cycle= 1 E= -526.708998746405  delta_E= -0.452  |g|= 0.183  |ddm|= 0.402
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.537832
diis-c [-0.28926351  1.        ]
  HOMO = -0.581478363620304  LUMO = 1.0111045869603
  mo_energy =
[-1.18627925e+02 -1.23316594e+01 -9.58544448e+00 -9.58544448e+00
 -9.58544448e+00 -1.25748707e+00 -5.81478364e-01 -5.81478364e-01
 -5.81478364e-01  1.01110459e+00  1.01110459e+00  1.01110459e+00
  7.20788180e+00  7.20788180e+00  7.20788180e+00  9.95236829e+00
  3.30491389e+01  3.30491389e+01  3.30491389e+01  1.16156823e+02
  1.27544950e+02  1.27544950e+02  1.27544950e+02  4.78555866e+02
  4.78555866e+02  4.78555866e+02  6.53404274e+02  1.32364347e+03
  1.32364347e+03  1.32364347e+03  2.79283683e+03  3.00932912e+03
  3.00932912e+03  3.00932912e+03  6.62434129e+03  6.62434129e+03
  6.62434129e+03  9.21096103e+03  2.55573033e+04  7.62875527e+04]
E1 = -728.446254020592  E_coul = 201.73666542124553
cycle= 2 E= -526.709588599346  delta_E= -0.00059  |g|= 0.0334  |ddm|= 0.0386
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0667994
diis-c [-0.00266831  0.07331469  0.92668531]
  HOMO = -0.574759509786219  LUMO = 1.01614832921277
  mo_energy =
[-1.18569324e+02 -1.23008592e+01 -9.55334211e+00 -9.55334211e+00
 -9.55334211e+00 -1.24895570e+00 -5.74759510e-01 -5.74759510e-01
 -5.74759510e-01  1.01614833e+00  1.01614833e+00  1.01614833e+00
  7.22624020e+00  7.22624020e+00  7.22624020e+00  9.97696117e+00
  3.30817335e+01  3.30817335e+01  3.30817335e+01  1.16205696e+02
  1.27592285e+02  1.27592285e+02  1.27592285e+02  4.78613660e+02
  4.78613660e+02  4.78613660e+02  6.53464875e+02  1.32370510e+03
  1.32370510e+03  1.32370510e+03  2.79290156e+03  3.00939284e+03
  3.00939284e+03  3.00939284e+03  6.62440657e+03  6.62440657e+03
  6.62440657e+03  9.21102702e+03  2.55573697e+04  7.62876194e+04]
E1 = -728.3413518521115  E_coul = 201.63172863990857
cycle= 3 E= -526.709623212203  delta_E= -3.46e-05  |g|= 0.00482  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104527
diis-c [-4.24097238e-07 -1.10442859e-03  1.30777213e-01  8.70327216e-01]
  HOMO = -0.575682777300027  LUMO = 1.01546603688506
  mo_energy =
[-1.18576888e+02 -1.23049038e+01 -9.55765742e+00 -9.55765742e+00
 -9.55765742e+00 -1.25007677e+00 -5.75682777e-01 -5.75682777e-01
 -5.75682777e-01  1.01546604e+00  1.01546604e+00  1.01546604e+00
  7.22374738e+00  7.22374738e+00  7.22374738e+00  9.97381733e+00
  3.30773816e+01  3.30773816e+01  3.30773816e+01  1.16199393e+02
  1.27586120e+02  1.27586120e+02  1.27586120e+02  4.78606200e+02
  4.78606200e+02  4.78606200e+02  6.53457019e+02  1.32369712e+03
  1.32369712e+03  1.32369712e+03  2.79289300e+03  3.00938451e+03
  3.00938451e+03  3.00938451e+03  6.62439789e+03  6.62439789e+03
  6.62439789e+03  9.21101815e+03  2.55573607e+04  7.62876103e+04]
E1 = -728.3555656756361  E_coul = 201.64594162314634
cycle= 4 E= -526.70962405249  delta_E= -8.4e-07  |g|= 5.88e-05  |ddm|= 0.00131
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122135
diis-c [-1.31142895e-09  6.37670362e-05 -8.97954945e-03 -7.03828615e-02
  1.07929864e+00]
  HOMO = -0.575670956538525  LUMO = 1.01547476195317
  mo_energy =
[-1.18576892e+02 -1.23048755e+01 -9.55764050e+00 -9.55764050e+00
 -9.55764050e+00 -1.25005804e+00 -5.75670957e-01 -5.75670957e-01
 -5.75670957e-01  1.01547476e+00  1.01547476e+00  1.01547476e+00
  7.22376753e+00  7.22376753e+00  7.22376753e+00  9.97385214e+00
  3.30773973e+01  3.30773973e+01  3.30773973e+01  1.16199403e+02
  1.27586128e+02  1.27586128e+02  1.27586128e+02  4.78606197e+02
  4.78606197e+02  4.78606197e+02  6.53457007e+02  1.32369710e+03
  1.32369710e+03  1.32369710e+03  2.79289297e+03  3.00938449e+03
  3.00938449e+03  3.00938449e+03  6.62439785e+03  6.62439785e+03
  6.62439785e+03  9.21101811e+03  2.55573607e+04  7.62876102e+04]
E1 = -728.3555639563789  E_coul = 201.64593990378256
cycle= 5 E= -526.709624052596  delta_E= -1.07e-10  |g|= 7.72e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3555639563789  E_coul = 201.64593990378256
  HOMO = -0.575674391005534  LUMO = 1.01547226449246
  mo_energy =
[-1.18576910e+02 -1.23048876e+01 -9.55765319e+00 -9.55765319e+00
 -9.55765319e+00 -1.25006227e+00 -5.75674391e-01 -5.75674391e-01
 -5.75674391e-01  1.01547226e+00  1.01547226e+00  1.01547226e+00
  7.22375923e+00  7.22375923e+00  7.22375923e+00  9.97384224e+00
  3.30773849e+01  3.30773849e+01  3.30773849e+01  1.16199388e+02
  1.27586112e+02  1.27586112e+02  1.27586112e+02  4.78606180e+02
  4.78606180e+02  4.78606180e+02  6.53456989e+02  1.32369709e+03
  1.32369709e+03  1.32369709e+03  2.79289295e+03  3.00938447e+03
  3.00938447e+03  3.00938447e+03  6.62439784e+03  6.62439784e+03
  6.62439784e+03  9.21101809e+03  2.55573606e+04  7.62876102e+04]
E1 = -728.355602013962  E_coul = 201.64597796136343
Extra cycle  E= -526.709624052599  delta_E= -2.16e-12  |g|= 2.28e-06  |ddm|= 3.93e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.22 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 92141.92115708011
E1 = -728.355602013962  E_coul = 201.64597796136343
init E= -526.709624052599
    CPU time for initialize scf      4.47 sec, wall time      0.23 sec
  HOMO = -0.575673694766906  LUMO = 1.01547277671596
  mo_energy =
[-1.18576905e+02 -1.23048848e+01 -9.55765030e+00 -9.55765030e+00
 -9.55765030e+00 -1.25006140e+00 -5.75673695e-01 -5.75673695e-01
 -5.75673695e-01  1.01547278e+00  1.01547278e+00  1.01547278e+00
  7.22376100e+00  7.22376100e+00  7.22376100e+00  9.97384449e+00
  3.30773878e+01  3.30773878e+01  3.30773878e+01  1.16199392e+02
  1.27586116e+02  1.27586116e+02  1.27586116e+02  4.78606184e+02
  4.78606184e+02  4.78606184e+02  6.53456994e+02  1.32369709e+03
  1.32369709e+03  1.32369709e+03  2.79289295e+03  3.00938448e+03
  3.00938448e+03  3.00938448e+03  6.62439784e+03  6.62439784e+03
  6.62439784e+03  9.21101810e+03  2.55573606e+04  7.62876102e+04]
E1 = -728.3555929704961  E_coul = 201.64596891789728
cycle= 1 E= -526.709624052599  delta_E= -3.41e-13  |g|= 5.85e-07  |ddm|= 8.98e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3555929704961  E_coul = 201.64596891789728
  HOMO = -0.575673848683625  LUMO = 1.01547266284932
  mo_energy =
[-1.18576906e+02 -1.23048854e+01 -9.55765099e+00 -9.55765099e+00
 -9.55765099e+00 -1.25006159e+00 -5.75673849e-01 -5.75673849e-01
 -5.75673849e-01  1.01547266e+00  1.01547266e+00  1.01547266e+00
  7.22376060e+00  7.22376060e+00  7.22376060e+00  9.97384397e+00
  3.30773871e+01  3.30773871e+01  3.30773871e+01  1.16199391e+02
  1.27586115e+02  1.27586115e+02  1.27586115e+02  4.78606183e+02
  4.78606183e+02  4.78606183e+02  6.53456993e+02  1.32369709e+03
  1.32369709e+03  1.32369709e+03  2.79289295e+03  3.00938447e+03
  3.00938447e+03  3.00938447e+03  6.62439784e+03  6.62439784e+03
  6.62439784e+03  9.21101810e+03  2.55573606e+04  7.62876102e+04]
E1 = -728.3555951740957  E_coul = 201.64597112149713
Extra cycle  E= -526.709624052599  delta_E= 3.41e-13  |g|= 1.47e-07  |ddm|= 2.11e-07
    CPU time for scf_cycle      4.59 sec, wall time      0.35 sec
exp = [2.61828735e+04 7.61703992e+03 3.61756837e+03 1.58734502e+03
 4.15599027e+02 1.21195087e+02 3.88803386e+01 8.05942711e+00
 3.16091380e+00 3.98560784e-01 1.36285821e+03 6.64056479e+02
 2.97729208e+02 3.11259629e+02 6.10378029e+01 7.27445557e+00
 2.00528076e+01 7.71034130e-01 2.79536245e+00 2.22617934e-01]
grad_E = [-1.40302298e-06  2.20729707e-06 -2.13593231e-06  3.82837710e-05
  1.44721677e-05  3.70919154e-06  9.85318251e-07  4.63158832e-07
 -1.40181034e-06  8.25175718e-07 -5.06775223e-07  5.18998799e-06
  2.48397290e-05  2.12635357e-05 -3.10540049e-05  1.10484924e-06
 -1.27993079e-05 -3.76932105e-06 -8.89356973e-06  4.31985345e-06]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:02:26 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8733704        1
[INPUT] 0    0    [1    /1   ]  7617.04012057        1
[INPUT] 0    0    [1    /1   ]  3617.56821875        1
[INPUT] 0    0    [1    /1   ]  1587.34879467        1
[INPUT] 0    0    [1    /1   ]  415.59424427         1
[INPUT] 0    0    [1    /1   ]  121.193642439        1
[INPUT] 0    0    [1    /1   ]  38.8799665372        1
[INPUT] 0    0    [1    /1   ]  8.05930450526        1
[INPUT] 0    0    [1    /1   ]  3.16088154072        1
[INPUT] 0    0    [1    /1   ]  0.398561289702       1
[INPUT] 1    0    [1    /1   ]  1362.85816829        1
[INPUT] 1    0    [1    /1   ]  664.05680947         1
[INPUT] 1    0    [1    /1   ]  297.730733079        1
[INPUT] 1    0    [1    /1   ]  311.260934868        1
[INPUT] 1    0    [1    /1   ]  61.0417681209        1
[INPUT] 1    0    [1    /1   ]  7.27505171061        1
[INPUT] 1    0    [1    /1   ]  20.0543549672        1
[INPUT] 1    0    [1    /1   ]  0.771063173216       1
[INPUT] 1    0    [1    /1   ]  2.79561335377        1
[INPUT] 1    0    [1    /1   ]  0.222622823158       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.873370390906, 1.0]], [0, [7617.040120570959, 1.0]], [0, [3617.568218750922, 1.0]], [0, [1587.3487946691378, 1.0]], [0, [415.5942442698272, 1.0]], [0, [121.19364243945506, 1.0]], [0, [38.879966537190036, 1.0]], [0, [8.05930450526013, 1.0]], [0, [3.160881540715812, 1.0]], [0, [0.39856128970193316, 1.0]], [1, [1362.858168293889, 1.0]], [1, [664.0568094702941, 1.0]], [1, [297.730733078614, 1.0]], [1, [311.2609348680911, 1.0]], [1, [61.041768120896535, 1.0]], [1, [7.275051710608957, 1.0]], [1, [20.054354967177833, 1.0]], [1, [0.7710631732160846, 1.0]], [1, [2.795613353769179, 1.0]], [1, [0.2226228231582408, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87337039]
bas 1, expnt(s) = [7617.04012057]
bas 2, expnt(s) = [3617.56821875]
bas 3, expnt(s) = [1587.34879467]
bas 4, expnt(s) = [415.59424427]
bas 5, expnt(s) = [121.19364244]
bas 6, expnt(s) = [38.87996654]
bas 7, expnt(s) = [8.05930451]
bas 8, expnt(s) = [3.16088154]
bas 9, expnt(s) = [0.39856129]
bas 10, expnt(s) = [1362.85816829]
bas 11, expnt(s) = [664.05680947]
bas 12, expnt(s) = [297.73073308]
bas 13, expnt(s) = [311.26093487]
bas 14, expnt(s) = [61.04176812]
bas 15, expnt(s) = [7.27505171]
bas 16, expnt(s) = [20.05435497]
bas 17, expnt(s) = [0.77106317]
bas 18, expnt(s) = [2.79561335]
bas 19, expnt(s) = [0.22262282]
CPU time:      1798.23
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828734e+04 5.20029527e+03 7.61704012e+03 2.05994064e+03
 3.61756822e+03 1.17849453e+03 1.58734879e+03 6.35359165e+02
 4.15594244e+02 2.32550441e+02 1.21193642e+02 9.22836797e+01
 3.88799665e+01 3.93377428e+01 8.05930451e+00 1.20847647e+01
 3.16088154e+00 5.98923273e+00 3.98561290e-01 1.26732021e+00
 1.36285817e+03 2.41572625e+04 6.64056809e+02 9.83424301e+03
 2.97730733e+02 3.60797879e+03 3.11260935e+02 3.81408322e+03
 6.10417681e+01 4.97758028e+02 7.27505171e+00 3.48561566e+01
 2.00543550e+01 1.23807018e+02 7.71063173e-01 2.10788466e+00
 2.79561335e+00 1.05458302e+01 2.22622823e-01 4.46114665e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.983004945491846
cond(S) = 92152.6134468331
E1 = -729.3787904324691  E_coul = 203.1217009251753
init E= -526.257089507294
    CPU time for initialize scf      0.64 sec, wall time      0.05 sec
  HOMO = -0.556988336934703  LUMO = 1.02709032839374
  mo_energy =
[-1.18335086e+02 -1.22078025e+01 -9.45157442e+00 -9.45157442e+00
 -9.45157442e+00 -1.22604663e+00 -5.56988337e-01 -5.56988337e-01
 -5.56988337e-01  1.02709033e+00  1.02709033e+00  1.02709033e+00
  7.28400836e+00  7.28400836e+00  7.28400836e+00  1.00434777e+01
  3.31914903e+01  3.31914903e+01  3.31914903e+01  1.16368950e+02
  1.27768630e+02  1.27768630e+02  1.27768630e+02  4.78866550e+02
  4.78866550e+02  4.78866550e+02  6.53732928e+02  1.32401451e+03
  1.32401451e+03  1.32401451e+03  2.79330085e+03  3.00976964e+03
  3.00976964e+03  3.00976964e+03  6.62489515e+03  6.62489515e+03
  6.62489515e+03  9.21154287e+03  2.55579825e+04  7.62883242e+04]
E1 = -727.9830982660052  E_coul = 201.27409950760395
cycle= 1 E= -526.708998758401  delta_E= -0.452  |g|= 0.183  |ddm|= 0.402
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.537835
diis-c [-0.28926615  1.        ]
  HOMO = -0.581477846157217  LUMO = 1.01114885487773
  mo_energy =
[-1.18627923e+02 -1.23316584e+01 -9.58544366e+00 -9.58544366e+00
 -9.58544366e+00 -1.25748682e+00 -5.81477846e-01 -5.81477846e-01
 -5.81477846e-01  1.01114885e+00  1.01114885e+00  1.01114885e+00
  7.20859689e+00  7.20859689e+00  7.20859689e+00  9.95213857e+00
  3.30525549e+01  3.30525549e+01  3.30525549e+01  1.16154831e+02
  1.27555928e+02  1.27555928e+02  1.27555928e+02  4.78575749e+02
  4.78575749e+02  4.78575749e+02  6.53395498e+02  1.32366808e+03
  1.32366808e+03  1.32366808e+03  2.79281977e+03  3.00935759e+03
  3.00935759e+03  3.00935759e+03  6.62437109e+03  6.62437109e+03
  6.62437109e+03  9.21094528e+03  2.55572913e+04  7.62875431e+04]
E1 = -728.4462641128152  E_coul = 201.73667550714026
cycle= 2 E= -526.709588605675  delta_E= -0.00059  |g|= 0.0334  |ddm|= 0.0386
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0667995
diis-c [-0.0026683   0.07331468  0.92668532]
  HOMO = -0.574759081858756  LUMO = 1.01619280501454
  mo_energy =
[-1.18569323e+02 -1.23008585e+01 -9.55334157e+00 -9.55334157e+00
 -9.55334157e+00 -1.24895556e+00 -5.74759082e-01 -5.74759082e-01
 -5.74759082e-01  1.01619281e+00  1.01619281e+00  1.01619281e+00
  7.22695622e+00  7.22695622e+00  7.22695622e+00  9.97673097e+00
  3.30851503e+01  3.30851503e+01  3.30851503e+01  1.16203705e+02
  1.27603263e+02  1.27603263e+02  1.27603263e+02  4.78633543e+02
  4.78633543e+02  4.78633543e+02  6.53456099e+02  1.32372971e+03
  1.32372971e+03  1.32372971e+03  2.79288450e+03  3.00942130e+03
  3.00942130e+03  3.00942130e+03  6.62443637e+03  6.62443637e+03
  6.62443637e+03  9.21101127e+03  2.55573577e+04  7.62876098e+04]
E1 = -728.3413631130392  E_coul = 201.63173989504025
cycle= 3 E= -526.709623217999  delta_E= -3.46e-05  |g|= 0.00482  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104527
diis-c [-4.24107354e-07 -1.10443458e-03  1.30776773e-01  8.70327662e-01]
  HOMO = -0.57568233586158  LUMO = 1.01551048553723
  mo_energy =
[-1.18576886e+02 -1.23049031e+01 -9.55765683e+00 -9.55765683e+00
 -9.55765683e+00 -1.25007661e+00 -5.75682336e-01 -5.75682336e-01
 -5.75682336e-01  1.01551049e+00  1.01551049e+00  1.01551049e+00
  7.22446329e+00  7.22446329e+00  7.22446329e+00  9.97358721e+00
  3.30807983e+01  3.30807983e+01  3.30807983e+01  1.16197402e+02
  1.27597099e+02  1.27597099e+02  1.27597099e+02  4.78626083e+02
  4.78626083e+02  4.78626083e+02  6.53448243e+02  1.32372173e+03
  1.32372173e+03  1.32372173e+03  2.79287594e+03  3.00941297e+03
  3.00941297e+03  3.00941297e+03  6.62442769e+03  6.62442769e+03
  6.62442769e+03  9.21100240e+03  2.55573487e+04  7.62876007e+04]
E1 = -728.3555767379628  E_coul = 201.64595267969716
cycle= 4 E= -526.709624058266  delta_E= -8.4e-07  |g|= 5.88e-05  |ddm|= 0.00131
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122136
diis-c [-1.31136992e-09  6.37672236e-05 -8.97955363e-03 -7.03832446e-02
  1.07929903e+00]
  HOMO = -0.575670515087987  LUMO = 1.0155192110057
  mo_energy =
[-1.18576891e+02 -1.23048747e+01 -9.55763991e+00 -9.55763991e+00
 -9.55763991e+00 -1.25005789e+00 -5.75670515e-01 -5.75670515e-01
 -5.75670515e-01  1.01551921e+00  1.01551921e+00  1.01551921e+00
  7.22448344e+00  7.22448344e+00  7.22448344e+00  9.97362202e+00
  3.30808140e+01  3.30808140e+01  3.30808140e+01  1.16197412e+02
  1.27597106e+02  1.27597106e+02  1.27597106e+02  4.78626079e+02
  4.78626079e+02  4.78626079e+02  6.53448231e+02  1.32372171e+03
  1.32372171e+03  1.32372171e+03  2.79287591e+03  3.00941295e+03
  3.00941295e+03  3.00941295e+03  6.62442765e+03  6.62442765e+03
  6.62442765e+03  9.21100235e+03  2.55573486e+04  7.62876006e+04]
E1 = -728.3555750181182  E_coul = 201.64595095974602
cycle= 5 E= -526.709624058372  delta_E= -1.07e-10  |g|= 7.72e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3555750181182  E_coul = 201.64595095974602
  HOMO = -0.575673949555315  LUMO = 1.01551671341347
  mo_energy =
[-1.18576908e+02 -1.23048868e+01 -9.55765260e+00 -9.55765260e+00
 -9.55765260e+00 -1.25006211e+00 -5.75673950e-01 -5.75673950e-01
 -5.75673950e-01  1.01551671e+00  1.01551671e+00  1.01551671e+00
  7.22447514e+00  7.22447514e+00  7.22447514e+00  9.97361211e+00
  3.30808016e+01  3.30808016e+01  3.30808016e+01  1.16197396e+02
  1.27597091e+02  1.27597091e+02  1.27597091e+02  4.78626062e+02
  4.78626062e+02  4.78626062e+02  6.53448213e+02  1.32372170e+03
  1.32372170e+03  1.32372170e+03  2.79287589e+03  3.00941293e+03
  3.00941293e+03  3.00941293e+03  6.62442763e+03  6.62442763e+03
  6.62442763e+03  9.21100234e+03  2.55573486e+04  7.62876006e+04]
E1 = -728.3556130757495  E_coul = 201.6459890173736
Extra cycle  E= -526.709624058376  delta_E= -3.75e-12  |g|= 2.28e-06  |ddm|= 3.93e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.22 sec
exp = [2.61828734e+04 7.61704012e+03 3.61756822e+03 1.58734879e+03
 4.15594244e+02 1.21193642e+02 3.88799665e+01 8.05930451e+00
 3.16088154e+00 3.98561290e-01 1.36285817e+03 6.64056809e+02
 2.97730733e+02 3.11260935e+02 6.10417681e+01 7.27505171e+00
 2.00543550e+01 7.71063173e-01 2.79561335e+00 2.22622823e-01]
E = -526.7096240583759
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:02:26 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8733704        1
[INPUT] 0    0    [1    /1   ]  7617.04012057        1
[INPUT] 0    0    [1    /1   ]  3617.56821875        1
[INPUT] 0    0    [1    /1   ]  1587.34879467        1
[INPUT] 0    0    [1    /1   ]  415.59424427         1
[INPUT] 0    0    [1    /1   ]  121.193642439        1
[INPUT] 0    0    [1    /1   ]  38.8799665372        1
[INPUT] 0    0    [1    /1   ]  8.05930450526        1
[INPUT] 0    0    [1    /1   ]  3.16088154072        1
[INPUT] 0    0    [1    /1   ]  0.398561289702       1
[INPUT] 1    0    [1    /1   ]  1362.85816829        1
[INPUT] 1    0    [1    /1   ]  664.05680947         1
[INPUT] 1    0    [1    /1   ]  297.730733079        1
[INPUT] 1    0    [1    /1   ]  311.260934868        1
[INPUT] 1    0    [1    /1   ]  61.0417681209        1
[INPUT] 1    0    [1    /1   ]  7.27505171061        1
[INPUT] 1    0    [1    /1   ]  20.0543549672        1
[INPUT] 1    0    [1    /1   ]  0.771063173216       1
[INPUT] 1    0    [1    /1   ]  2.79561335377        1
[INPUT] 1    0    [1    /1   ]  0.222622823158       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.873370390906, 1.0]], [0, [7617.040120570959, 1.0]], [0, [3617.568218750922, 1.0]], [0, [1587.3487946691378, 1.0]], [0, [415.5942442698272, 1.0]], [0, [121.19364243945506, 1.0]], [0, [38.879966537190036, 1.0]], [0, [8.05930450526013, 1.0]], [0, [3.160881540715812, 1.0]], [0, [0.39856128970193316, 1.0]], [1, [1362.858168293889, 1.0]], [1, [664.0568094702941, 1.0]], [1, [297.730733078614, 1.0]], [1, [311.2609348680911, 1.0]], [1, [61.041768120896535, 1.0]], [1, [7.275051710608957, 1.0]], [1, [20.054354967177833, 1.0]], [1, [0.7710631732160846, 1.0]], [1, [2.795613353769179, 1.0]], [1, [0.2226228231582408, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87337039]
bas 1, expnt(s) = [7617.04012057]
bas 2, expnt(s) = [3617.56821875]
bas 3, expnt(s) = [1587.34879467]
bas 4, expnt(s) = [415.59424427]
bas 5, expnt(s) = [121.19364244]
bas 6, expnt(s) = [38.87996654]
bas 7, expnt(s) = [8.05930451]
bas 8, expnt(s) = [3.16088154]
bas 9, expnt(s) = [0.39856129]
bas 10, expnt(s) = [1362.85816829]
bas 11, expnt(s) = [664.05680947]
bas 12, expnt(s) = [297.73073308]
bas 13, expnt(s) = [311.26093487]
bas 14, expnt(s) = [61.04176812]
bas 15, expnt(s) = [7.27505171]
bas 16, expnt(s) = [20.05435497]
bas 17, expnt(s) = [0.77106317]
bas 18, expnt(s) = [2.79561335]
bas 19, expnt(s) = [0.22262282]
CPU time:      1799.34
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828734e+04 5.20029527e+03 7.61704012e+03 2.05994064e+03
 3.61756822e+03 1.17849453e+03 1.58734879e+03 6.35359165e+02
 4.15594244e+02 2.32550441e+02 1.21193642e+02 9.22836797e+01
 3.88799665e+01 3.93377428e+01 8.05930451e+00 1.20847647e+01
 3.16088154e+00 5.98923273e+00 3.98561290e-01 1.26732021e+00
 1.36285817e+03 2.41572625e+04 6.64056809e+02 9.83424301e+03
 2.97730733e+02 3.60797879e+03 3.11260935e+02 3.81408322e+03
 6.10417681e+01 4.97758028e+02 7.27505171e+00 3.48561566e+01
 2.00543550e+01 1.23807018e+02 7.71063173e-01 2.10788466e+00
 2.79561335e+00 1.05458302e+01 2.22622823e-01 4.46114665e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.983004945491846
cond(S) = 92152.6134468331
E1 = -729.3787904324691  E_coul = 203.1217009251753
init E= -526.257089507294
    CPU time for initialize scf      1.53 sec, wall time      0.09 sec
  HOMO = -0.556988336934703  LUMO = 1.02709032839374
  mo_energy =
[-1.18335086e+02 -1.22078025e+01 -9.45157442e+00 -9.45157442e+00
 -9.45157442e+00 -1.22604663e+00 -5.56988337e-01 -5.56988337e-01
 -5.56988337e-01  1.02709033e+00  1.02709033e+00  1.02709033e+00
  7.28400836e+00  7.28400836e+00  7.28400836e+00  1.00434777e+01
  3.31914903e+01  3.31914903e+01  3.31914903e+01  1.16368950e+02
  1.27768630e+02  1.27768630e+02  1.27768630e+02  4.78866550e+02
  4.78866550e+02  4.78866550e+02  6.53732928e+02  1.32401451e+03
  1.32401451e+03  1.32401451e+03  2.79330085e+03  3.00976964e+03
  3.00976964e+03  3.00976964e+03  6.62489515e+03  6.62489515e+03
  6.62489515e+03  9.21154287e+03  2.55579825e+04  7.62883242e+04]
E1 = -727.9830982660052  E_coul = 201.27409950760395
cycle= 1 E= -526.708998758401  delta_E= -0.452  |g|= 0.183  |ddm|= 0.402
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.537835
diis-c [-0.28926615  1.        ]
  HOMO = -0.581477846157217  LUMO = 1.01114885487773
  mo_energy =
[-1.18627923e+02 -1.23316584e+01 -9.58544366e+00 -9.58544366e+00
 -9.58544366e+00 -1.25748682e+00 -5.81477846e-01 -5.81477846e-01
 -5.81477846e-01  1.01114885e+00  1.01114885e+00  1.01114885e+00
  7.20859689e+00  7.20859689e+00  7.20859689e+00  9.95213857e+00
  3.30525549e+01  3.30525549e+01  3.30525549e+01  1.16154831e+02
  1.27555928e+02  1.27555928e+02  1.27555928e+02  4.78575749e+02
  4.78575749e+02  4.78575749e+02  6.53395498e+02  1.32366808e+03
  1.32366808e+03  1.32366808e+03  2.79281977e+03  3.00935759e+03
  3.00935759e+03  3.00935759e+03  6.62437109e+03  6.62437109e+03
  6.62437109e+03  9.21094528e+03  2.55572913e+04  7.62875431e+04]
E1 = -728.4462641128152  E_coul = 201.73667550714026
cycle= 2 E= -526.709588605675  delta_E= -0.00059  |g|= 0.0334  |ddm|= 0.0386
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0667995
diis-c [-0.0026683   0.07331468  0.92668532]
  HOMO = -0.574759081858756  LUMO = 1.01619280501454
  mo_energy =
[-1.18569323e+02 -1.23008585e+01 -9.55334157e+00 -9.55334157e+00
 -9.55334157e+00 -1.24895556e+00 -5.74759082e-01 -5.74759082e-01
 -5.74759082e-01  1.01619281e+00  1.01619281e+00  1.01619281e+00
  7.22695622e+00  7.22695622e+00  7.22695622e+00  9.97673097e+00
  3.30851503e+01  3.30851503e+01  3.30851503e+01  1.16203705e+02
  1.27603263e+02  1.27603263e+02  1.27603263e+02  4.78633543e+02
  4.78633543e+02  4.78633543e+02  6.53456099e+02  1.32372971e+03
  1.32372971e+03  1.32372971e+03  2.79288450e+03  3.00942130e+03
  3.00942130e+03  3.00942130e+03  6.62443637e+03  6.62443637e+03
  6.62443637e+03  9.21101127e+03  2.55573577e+04  7.62876098e+04]
E1 = -728.3413631130392  E_coul = 201.63173989504025
cycle= 3 E= -526.709623217999  delta_E= -3.46e-05  |g|= 0.00482  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104527
diis-c [-4.24107354e-07 -1.10443458e-03  1.30776773e-01  8.70327662e-01]
  HOMO = -0.57568233586158  LUMO = 1.01551048553723
  mo_energy =
[-1.18576886e+02 -1.23049031e+01 -9.55765683e+00 -9.55765683e+00
 -9.55765683e+00 -1.25007661e+00 -5.75682336e-01 -5.75682336e-01
 -5.75682336e-01  1.01551049e+00  1.01551049e+00  1.01551049e+00
  7.22446329e+00  7.22446329e+00  7.22446329e+00  9.97358721e+00
  3.30807983e+01  3.30807983e+01  3.30807983e+01  1.16197402e+02
  1.27597099e+02  1.27597099e+02  1.27597099e+02  4.78626083e+02
  4.78626083e+02  4.78626083e+02  6.53448243e+02  1.32372173e+03
  1.32372173e+03  1.32372173e+03  2.79287594e+03  3.00941297e+03
  3.00941297e+03  3.00941297e+03  6.62442769e+03  6.62442769e+03
  6.62442769e+03  9.21100240e+03  2.55573487e+04  7.62876007e+04]
E1 = -728.3555767379628  E_coul = 201.64595267969716
cycle= 4 E= -526.709624058266  delta_E= -8.4e-07  |g|= 5.88e-05  |ddm|= 0.00131
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122136
diis-c [-1.31136992e-09  6.37672236e-05 -8.97955363e-03 -7.03832446e-02
  1.07929903e+00]
  HOMO = -0.575670515087987  LUMO = 1.0155192110057
  mo_energy =
[-1.18576891e+02 -1.23048747e+01 -9.55763991e+00 -9.55763991e+00
 -9.55763991e+00 -1.25005789e+00 -5.75670515e-01 -5.75670515e-01
 -5.75670515e-01  1.01551921e+00  1.01551921e+00  1.01551921e+00
  7.22448344e+00  7.22448344e+00  7.22448344e+00  9.97362202e+00
  3.30808140e+01  3.30808140e+01  3.30808140e+01  1.16197412e+02
  1.27597106e+02  1.27597106e+02  1.27597106e+02  4.78626079e+02
  4.78626079e+02  4.78626079e+02  6.53448231e+02  1.32372171e+03
  1.32372171e+03  1.32372171e+03  2.79287591e+03  3.00941295e+03
  3.00941295e+03  3.00941295e+03  6.62442765e+03  6.62442765e+03
  6.62442765e+03  9.21100235e+03  2.55573486e+04  7.62876006e+04]
E1 = -728.3555750181182  E_coul = 201.64595095974602
cycle= 5 E= -526.709624058372  delta_E= -1.07e-10  |g|= 7.72e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3555750181182  E_coul = 201.64595095974602
  HOMO = -0.575673949555315  LUMO = 1.01551671341347
  mo_energy =
[-1.18576908e+02 -1.23048868e+01 -9.55765260e+00 -9.55765260e+00
 -9.55765260e+00 -1.25006211e+00 -5.75673950e-01 -5.75673950e-01
 -5.75673950e-01  1.01551671e+00  1.01551671e+00  1.01551671e+00
  7.22447514e+00  7.22447514e+00  7.22447514e+00  9.97361211e+00
  3.30808016e+01  3.30808016e+01  3.30808016e+01  1.16197396e+02
  1.27597091e+02  1.27597091e+02  1.27597091e+02  4.78626062e+02
  4.78626062e+02  4.78626062e+02  6.53448213e+02  1.32372170e+03
  1.32372170e+03  1.32372170e+03  2.79287589e+03  3.00941293e+03
  3.00941293e+03  3.00941293e+03  6.62442763e+03  6.62442763e+03
  6.62442763e+03  9.21100234e+03  2.55573486e+04  7.62876006e+04]
E1 = -728.3556130757495  E_coul = 201.6459890173736
Extra cycle  E= -526.709624058376  delta_E= -3.75e-12  |g|= 2.28e-06  |ddm|= 3.93e-06
    CPU time for scf_cycle      1.72 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 92152.6134468331
E1 = -728.3556130757495  E_coul = 201.6459890173736
init E= -526.709624058376
    CPU time for initialize scf      3.98 sec, wall time      0.22 sec
  HOMO = -0.575673253318329  LUMO = 1.01551722566349
  mo_energy =
[-1.18576903e+02 -1.23048840e+01 -9.55764971e+00 -9.55764971e+00
 -9.55764971e+00 -1.25006124e+00 -5.75673253e-01 -5.75673253e-01
 -5.75673253e-01  1.01551723e+00  1.01551723e+00  1.01551723e+00
  7.22447691e+00  7.22447691e+00  7.22447691e+00  9.97361436e+00
  3.30808044e+01  3.30808044e+01  3.30808044e+01  1.16197400e+02
  1.27597095e+02  1.27597095e+02  1.27597095e+02  4.78626067e+02
  4.78626067e+02  4.78626067e+02  6.53448218e+02  1.32372170e+03
  1.32372170e+03  1.32372170e+03  2.79287589e+03  3.00941294e+03
  3.00941294e+03  3.00941294e+03  6.62442764e+03  6.62442764e+03
  6.62442764e+03  9.21100234e+03  2.55573486e+04  7.62876006e+04]
E1 = -728.3556040322931  E_coul = 201.645979973917
cycle= 1 E= -526.709624058376  delta_E= -1.14e-13  |g|= 5.85e-07  |ddm|= 8.98e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3556040322931  E_coul = 201.645979973917
  HOMO = -0.575673407234336  LUMO = 1.01551711179087
  mo_energy =
[-1.18576905e+02 -1.23048846e+01 -9.55765040e+00 -9.55765040e+00
 -9.55765040e+00 -1.25006143e+00 -5.75673407e-01 -5.75673407e-01
 -5.75673407e-01  1.01551711e+00  1.01551711e+00  1.01551711e+00
  7.22447650e+00  7.22447650e+00  7.22447650e+00  9.97361384e+00
  3.30808037e+01  3.30808037e+01  3.30808037e+01  1.16197399e+02
  1.27597094e+02  1.27597094e+02  1.27597094e+02  4.78626066e+02
  4.78626066e+02  4.78626066e+02  6.53448217e+02  1.32372170e+03
  1.32372170e+03  1.32372170e+03  2.79287589e+03  3.00941294e+03
  3.00941294e+03  3.00941294e+03  6.62442764e+03  6.62442764e+03
  6.62442764e+03  9.21100234e+03  2.55573486e+04  7.62876006e+04]
E1 = -728.3556062358899  E_coul = 201.64598217751475
Extra cycle  E= -526.709624058375  delta_E= 7.96e-13  |g|= 1.47e-07  |ddm|= 2.11e-07
    CPU time for scf_cycle      4.10 sec, wall time      0.34 sec
exp = [2.61828734e+04 7.61704012e+03 3.61756822e+03 1.58734879e+03
 4.15594244e+02 1.21193642e+02 3.88799665e+01 8.05930451e+00
 3.16088154e+00 3.98561290e-01 1.36285817e+03 6.64056809e+02
 2.97730733e+02 3.11260935e+02 6.10417681e+01 7.27505171e+00
 2.00543550e+01 7.71063173e-01 2.79561335e+00 2.22622823e-01]
grad_E = [-1.40304522e-06  2.20748242e-06 -2.13591090e-06  3.82890442e-05
  1.44335119e-05  3.77870754e-06  6.62982021e-07 -2.64348187e-07
 -1.34209845e-07  8.30438933e-06 -5.06948637e-07  5.18777200e-06
  2.48273685e-05  2.12528757e-05 -3.09891657e-05 -2.21818659e-06
 -1.18863928e-05  8.29806768e-06 -1.80690123e-06 -3.35436889e-05]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:02:31 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8731022        1
[INPUT] 0    0    [1    /1   ]  7617.04060707        1
[INPUT] 0    0    [1    /1   ]  3617.56786266        1
[INPUT] 0    0    [1    /1   ]  1587.35820349        1
[INPUT] 0    0    [1    /1   ]  415.580548912        1
[INPUT] 0    0    [1    /1   ]  121.189636775        1
[INPUT] 0    0    [1    /1   ]  38.8789394946        1
[INPUT] 0    0    [1    /1   ]  8.05890307372        1
[INPUT] 0    0    [1    /1   ]  3.16076669358        1
[INPUT] 0    0    [1    /1   ]  0.398562315935       1
[INPUT] 1    0    [1    /1   ]  1362.85806315        1
[INPUT] 1    0    [1    /1   ]  664.057608408        1
[INPUT] 1    0    [1    /1   ]  297.734417217        1
[INPUT] 1    0    [1    /1   ]  311.264090946        1
[INPUT] 1    0    [1    /1   ]  61.0512067444        1
[INPUT] 1    0    [1    /1   ]  7.27651279928        1
[INPUT] 1    0    [1    /1   ]  20.0580932295        1
[INPUT] 1    0    [1    /1   ]  0.77113749478        1
[INPUT] 1    0    [1    /1   ]  2.79625676298        1
[INPUT] 1    0    [1    /1   ]  0.222635812297       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.873102245514, 1.0]], [0, [7617.040607069408, 1.0]], [0, [3617.567862663478, 1.0]], [0, [1587.358203486984, 1.0]], [0, [415.58054891193956, 1.0]], [0, [121.18963677454072, 1.0]], [0, [38.87893949456033, 1.0]], [0, [8.058903073717204, 1.0]], [0, [3.1607666935818064, 1.0]], [0, [0.3985623159349839, 1.0]], [1, [1362.8580631525397, 1.0]], [1, [664.0576084083428, 1.0]], [1, [297.73441721662147, 1.0]], [1, [311.26409094575695, 1.0]], [1, [61.05120674438974, 1.0]], [1, [7.2765127992842045, 1.0]], [1, [20.058093229467502, 1.0]], [1, [0.7711374947804956, 1.0]], [1, [2.7962567629824138, 1.0]], [1, [0.222635812297134, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87310225]
bas 1, expnt(s) = [7617.04060707]
bas 2, expnt(s) = [3617.56786266]
bas 3, expnt(s) = [1587.35820349]
bas 4, expnt(s) = [415.58054891]
bas 5, expnt(s) = [121.18963677]
bas 6, expnt(s) = [38.87893949]
bas 7, expnt(s) = [8.05890307]
bas 8, expnt(s) = [3.16076669]
bas 9, expnt(s) = [0.39856232]
bas 10, expnt(s) = [1362.85806315]
bas 11, expnt(s) = [664.05760841]
bas 12, expnt(s) = [297.73441722]
bas 13, expnt(s) = [311.26409095]
bas 14, expnt(s) = [61.05120674]
bas 15, expnt(s) = [7.2765128]
bas 16, expnt(s) = [20.05809323]
bas 17, expnt(s) = [0.77113749]
bas 18, expnt(s) = [2.79625676]
bas 19, expnt(s) = [0.22263581]
CPU time:      1810.03
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828731e+04 5.20029523e+03 7.61704061e+03 2.05994074e+03
 3.61756786e+03 1.17849444e+03 1.58735820e+03 6.35361990e+02
 4.15580549e+02 2.32544693e+02 1.21189637e+02 9.22813920e+01
 3.88789395e+01 3.93369634e+01 8.05890307e+00 1.20843132e+01
 3.16076669e+00 5.98906952e+00 3.98562316e-01 1.26732266e+00
 1.36285806e+03 2.41572602e+04 6.64057608e+02 9.83425780e+03
 2.97734417e+02 3.60803460e+03 3.11264091e+02 3.81413156e+03
 6.10512067e+01 4.97854238e+02 7.27651280e+00 3.48649073e+01
 2.00580932e+01 1.23835867e+02 7.71137495e-01 2.10813864e+00
 2.79625676e+00 1.05488642e+01 2.22635812e-01 4.46147201e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.983002587720698
cond(S) = 92178.24612457937
E1 = -729.3788087163643  E_coul = 203.12171469668144
init E= -526.257094019683
    CPU time for initialize scf      0.70 sec, wall time      0.05 sec
  HOMO = -0.556987407102735  LUMO = 1.02720793727203
  mo_energy =
[-1.18335084e+02 -1.22078021e+01 -9.45157396e+00 -9.45157396e+00
 -9.45157396e+00 -1.22604612e+00 -5.56987407e-01 -5.56987407e-01
 -5.56987407e-01  1.02720794e+00  1.02720794e+00  1.02720794e+00
  7.28583629e+00  7.28583629e+00  7.28583629e+00  1.00426983e+01
  3.31999541e+01  3.31999541e+01  3.31999541e+01  1.16363068e+02
  1.27795239e+02  1.27795239e+02  1.27795239e+02  4.78914358e+02
  4.78914358e+02  4.78914358e+02  6.53707957e+02  1.32407364e+03
  1.32407364e+03  1.32407364e+03  2.79325151e+03  3.00983806e+03
  3.00983806e+03  3.00983806e+03  6.62496681e+03  6.62496681e+03
  6.62496681e+03  9.21149522e+03  2.55579440e+04  7.62882921e+04]
E1 = -727.9831331155551  E_coul = 201.27413432447332
cycle= 1 E= -526.708998791082  delta_E= -0.452  |g|= 0.183  |ddm|= 0.402
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.537842
diis-c [-0.28927408  1.        ]
  HOMO = -0.581476502416247  LUMO = 1.01126414363075
  mo_energy =
[-1.18627919e+02 -1.23316562e+01 -9.58544173e+00 -9.58544173e+00
 -9.58544173e+00 -1.25748582e+00 -5.81476502e-01 -5.81476502e-01
 -5.81476502e-01  1.01126414e+00  1.01126414e+00  1.01126414e+00
  7.21041289e+00  7.21041289e+00  7.21041289e+00  9.95136407e+00
  3.30610080e+01  3.30610080e+01  3.30610080e+01  1.16148955e+02
  1.27582530e+02  1.27582530e+02  1.27582530e+02  4.78623559e+02
  4.78623559e+02  4.78623559e+02  6.53370532e+02  1.32372721e+03
  1.32372721e+03  1.32372721e+03  2.79277043e+03  3.00942601e+03
  3.00942601e+03  3.00942601e+03  6.62444275e+03  6.62444275e+03
  6.62444275e+03  9.21089763e+03  2.55572527e+04  7.62875111e+04]
E1 = -728.4462902941647  E_coul = 201.73670166444765
cycle= 2 E= -526.709588629717  delta_E= -0.00059  |g|= 0.0334  |ddm|= 0.0386
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0667999
diis-c [-0.0026683   0.07331505  0.92668495]
  HOMO = -0.574757944021108  LUMO = 1.01630864710018
  mo_energy =
[-1.18569319e+02 -1.23008568e+01 -9.55334024e+00 -9.55334024e+00
 -9.55334024e+00 -1.24895482e+00 -5.74757944e-01 -5.74757944e-01
 -5.74757944e-01  1.01630865e+00  1.01630865e+00  1.01630865e+00
  7.22877464e+00  7.22877464e+00  7.22877464e+00  9.97595517e+00
  3.30936055e+01  3.30936055e+01  3.30936055e+01  1.16197827e+02
  1.27629866e+02  1.27629866e+02  1.27629866e+02  4.78681352e+02
  4.78681352e+02  4.78681352e+02  6.53431132e+02  1.32378884e+03
  1.32378884e+03  1.32378884e+03  2.79283515e+03  3.00948973e+03
  3.00948973e+03  3.00948973e+03  6.62450803e+03  6.62450803e+03
  6.62450803e+03  9.21096362e+03  2.55573192e+04  7.62875778e+04]
E1 = -728.3413918486261  E_coul = 201.63176860762078
cycle= 3 E= -526.709623241005  delta_E= -3.46e-05  |g|= 0.00482  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104527
diis-c [-4.24157750e-07 -1.10446044e-03  1.30775540e-01  8.70328920e-01]
  HOMO = -0.575681163964249  LUMO = 1.01562625752041
  mo_energy =
[-1.18576883e+02 -1.23049013e+01 -9.55765538e+00 -9.55765538e+00
 -9.55765538e+00 -1.25007583e+00 -5.75681164e-01 -5.75681164e-01
 -5.75681164e-01  1.01562626e+00  1.01562626e+00  1.01562626e+00
  7.22628140e+00  7.22628140e+00  7.22628140e+00  9.97281161e+00
  3.30892533e+01  3.30892533e+01  3.30892533e+01  1.16191524e+02
  1.27623702e+02  1.27623702e+02  1.27623702e+02  4.78673892e+02
  4.78673892e+02  4.78673892e+02  6.53423276e+02  1.32378086e+03
  1.32378086e+03  1.32378086e+03  2.79282660e+03  3.00948140e+03
  3.00948140e+03  3.00948140e+03  6.62449935e+03  6.62449935e+03
  6.62449935e+03  9.21095475e+03  2.55573102e+04  7.62875686e+04]
E1 = -728.3556050087287  E_coul = 201.6459809275004
cycle= 4 E= -526.709624081228  delta_E= -8.4e-07  |g|= 5.88e-05  |ddm|= 0.00131
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122144
diis-c [-1.31127318e-09  6.37693356e-05 -8.97970917e-03 -7.03856991e-02
  1.07930164e+00]
  HOMO = -0.575669342936529  LUMO = 1.01563498419073
  mo_energy =
[-1.18576887e+02 -1.23048729e+01 -9.55763845e+00 -9.55763845e+00
 -9.55763845e+00 -1.25005710e+00 -5.75669343e-01 -5.75669343e-01
 -5.75669343e-01  1.01563498e+00  1.01563498e+00  1.01563498e+00
  7.22630155e+00  7.22630155e+00  7.22630155e+00  9.97284642e+00
  3.30892690e+01  3.30892690e+01  3.30892690e+01  1.16191534e+02
  1.27623709e+02  1.27623709e+02  1.27623709e+02  4.78673888e+02
  4.78673888e+02  4.78673888e+02  6.53423263e+02  1.32378085e+03
  1.32378085e+03  1.32378085e+03  2.79282657e+03  3.00948138e+03
  3.00948138e+03  3.00948138e+03  6.62449931e+03  6.62449931e+03
  6.62449931e+03  9.21095471e+03  2.55573101e+04  7.62875686e+04]
E1 = -728.3556032904071  E_coul = 201.64597920907187
cycle= 5 E= -526.709624081335  delta_E= -1.07e-10  |g|= 7.72e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3556032904071  E_coul = 201.64597920907187
  HOMO = -0.575672777480227  LUMO = 1.0156324862082
  mo_energy =
[-1.18576904e+02 -1.23048850e+01 -9.55765114e+00 -9.55765114e+00
 -9.55765114e+00 -1.25006133e+00 -5.75672777e-01 -5.75672777e-01
 -5.75672777e-01  1.01563249e+00  1.01563249e+00  1.01563249e+00
  7.22629325e+00  7.22629325e+00  7.22629325e+00  9.97283652e+00
  3.30892566e+01  3.30892566e+01  3.30892566e+01  1.16191519e+02
  1.27623694e+02  1.27623694e+02  1.27623694e+02  4.78673871e+02
  4.78673871e+02  4.78673871e+02  6.53423246e+02  1.32378083e+03
  1.32378083e+03  1.32378083e+03  2.79282655e+03  3.00948136e+03
  3.00948136e+03  3.00948136e+03  6.62449930e+03  6.62449930e+03
  6.62449930e+03  9.21095469e+03  2.55573101e+04  7.62875685e+04]
E1 = -728.3556413490155  E_coul = 201.64601726767782
Extra cycle  E= -526.709624081338  delta_E= -2.39e-12  |g|= 2.28e-06  |ddm|= 3.93e-06
    CPU time for scf_cycle      0.89 sec, wall time      0.23 sec
exp = [2.61828731e+04 7.61704061e+03 3.61756786e+03 1.58735820e+03
 4.15580549e+02 1.21189637e+02 3.88789395e+01 8.05890307e+00
 3.16076669e+00 3.98562316e-01 1.36285806e+03 6.64057608e+02
 2.97734417e+02 3.11264091e+02 6.10512067e+01 7.27651280e+00
 2.00580932e+01 7.71137495e-01 2.79625676e+00 2.22635812e-01]
E = -526.7096240813377
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:02:31 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8731022        1
[INPUT] 0    0    [1    /1   ]  7617.04060707        1
[INPUT] 0    0    [1    /1   ]  3617.56786266        1
[INPUT] 0    0    [1    /1   ]  1587.35820349        1
[INPUT] 0    0    [1    /1   ]  415.580548912        1
[INPUT] 0    0    [1    /1   ]  121.189636775        1
[INPUT] 0    0    [1    /1   ]  38.8789394946        1
[INPUT] 0    0    [1    /1   ]  8.05890307372        1
[INPUT] 0    0    [1    /1   ]  3.16076669358        1
[INPUT] 0    0    [1    /1   ]  0.398562315935       1
[INPUT] 1    0    [1    /1   ]  1362.85806315        1
[INPUT] 1    0    [1    /1   ]  664.057608408        1
[INPUT] 1    0    [1    /1   ]  297.734417217        1
[INPUT] 1    0    [1    /1   ]  311.264090946        1
[INPUT] 1    0    [1    /1   ]  61.0512067444        1
[INPUT] 1    0    [1    /1   ]  7.27651279928        1
[INPUT] 1    0    [1    /1   ]  20.0580932295        1
[INPUT] 1    0    [1    /1   ]  0.77113749478        1
[INPUT] 1    0    [1    /1   ]  2.79625676298        1
[INPUT] 1    0    [1    /1   ]  0.222635812297       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.873102245514, 1.0]], [0, [7617.040607069408, 1.0]], [0, [3617.567862663478, 1.0]], [0, [1587.358203486984, 1.0]], [0, [415.58054891193956, 1.0]], [0, [121.18963677454072, 1.0]], [0, [38.87893949456033, 1.0]], [0, [8.058903073717204, 1.0]], [0, [3.1607666935818064, 1.0]], [0, [0.3985623159349839, 1.0]], [1, [1362.8580631525397, 1.0]], [1, [664.0576084083428, 1.0]], [1, [297.73441721662147, 1.0]], [1, [311.26409094575695, 1.0]], [1, [61.05120674438974, 1.0]], [1, [7.2765127992842045, 1.0]], [1, [20.058093229467502, 1.0]], [1, [0.7711374947804956, 1.0]], [1, [2.7962567629824138, 1.0]], [1, [0.222635812297134, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87310225]
bas 1, expnt(s) = [7617.04060707]
bas 2, expnt(s) = [3617.56786266]
bas 3, expnt(s) = [1587.35820349]
bas 4, expnt(s) = [415.58054891]
bas 5, expnt(s) = [121.18963677]
bas 6, expnt(s) = [38.87893949]
bas 7, expnt(s) = [8.05890307]
bas 8, expnt(s) = [3.16076669]
bas 9, expnt(s) = [0.39856232]
bas 10, expnt(s) = [1362.85806315]
bas 11, expnt(s) = [664.05760841]
bas 12, expnt(s) = [297.73441722]
bas 13, expnt(s) = [311.26409095]
bas 14, expnt(s) = [61.05120674]
bas 15, expnt(s) = [7.2765128]
bas 16, expnt(s) = [20.05809323]
bas 17, expnt(s) = [0.77113749]
bas 18, expnt(s) = [2.79625676]
bas 19, expnt(s) = [0.22263581]
CPU time:      1811.21
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828731e+04 5.20029523e+03 7.61704061e+03 2.05994074e+03
 3.61756786e+03 1.17849444e+03 1.58735820e+03 6.35361990e+02
 4.15580549e+02 2.32544693e+02 1.21189637e+02 9.22813920e+01
 3.88789395e+01 3.93369634e+01 8.05890307e+00 1.20843132e+01
 3.16076669e+00 5.98906952e+00 3.98562316e-01 1.26732266e+00
 1.36285806e+03 2.41572602e+04 6.64057608e+02 9.83425780e+03
 2.97734417e+02 3.60803460e+03 3.11264091e+02 3.81413156e+03
 6.10512067e+01 4.97854238e+02 7.27651280e+00 3.48649073e+01
 2.00580932e+01 1.23835867e+02 7.71137495e-01 2.10813864e+00
 2.79625676e+00 1.05488642e+01 2.22635812e-01 4.46147201e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.983002587720698
cond(S) = 92178.24612457937
E1 = -729.3788087163643  E_coul = 203.12171469668144
init E= -526.257094019683
    CPU time for initialize scf      0.62 sec, wall time      0.05 sec
  HOMO = -0.556987407102735  LUMO = 1.02720793727203
  mo_energy =
[-1.18335084e+02 -1.22078021e+01 -9.45157396e+00 -9.45157396e+00
 -9.45157396e+00 -1.22604612e+00 -5.56987407e-01 -5.56987407e-01
 -5.56987407e-01  1.02720794e+00  1.02720794e+00  1.02720794e+00
  7.28583629e+00  7.28583629e+00  7.28583629e+00  1.00426983e+01
  3.31999541e+01  3.31999541e+01  3.31999541e+01  1.16363068e+02
  1.27795239e+02  1.27795239e+02  1.27795239e+02  4.78914358e+02
  4.78914358e+02  4.78914358e+02  6.53707957e+02  1.32407364e+03
  1.32407364e+03  1.32407364e+03  2.79325151e+03  3.00983806e+03
  3.00983806e+03  3.00983806e+03  6.62496681e+03  6.62496681e+03
  6.62496681e+03  9.21149522e+03  2.55579440e+04  7.62882921e+04]
E1 = -727.9831331155551  E_coul = 201.27413432447332
cycle= 1 E= -526.708998791082  delta_E= -0.452  |g|= 0.183  |ddm|= 0.402
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.537842
diis-c [-0.28927408  1.        ]
  HOMO = -0.581476502416247  LUMO = 1.01126414363075
  mo_energy =
[-1.18627919e+02 -1.23316562e+01 -9.58544173e+00 -9.58544173e+00
 -9.58544173e+00 -1.25748582e+00 -5.81476502e-01 -5.81476502e-01
 -5.81476502e-01  1.01126414e+00  1.01126414e+00  1.01126414e+00
  7.21041289e+00  7.21041289e+00  7.21041289e+00  9.95136407e+00
  3.30610080e+01  3.30610080e+01  3.30610080e+01  1.16148955e+02
  1.27582530e+02  1.27582530e+02  1.27582530e+02  4.78623559e+02
  4.78623559e+02  4.78623559e+02  6.53370532e+02  1.32372721e+03
  1.32372721e+03  1.32372721e+03  2.79277043e+03  3.00942601e+03
  3.00942601e+03  3.00942601e+03  6.62444275e+03  6.62444275e+03
  6.62444275e+03  9.21089763e+03  2.55572527e+04  7.62875111e+04]
E1 = -728.4462902941647  E_coul = 201.73670166444765
cycle= 2 E= -526.709588629717  delta_E= -0.00059  |g|= 0.0334  |ddm|= 0.0386
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0667999
diis-c [-0.0026683   0.07331505  0.92668495]
  HOMO = -0.574757944021108  LUMO = 1.01630864710018
  mo_energy =
[-1.18569319e+02 -1.23008568e+01 -9.55334024e+00 -9.55334024e+00
 -9.55334024e+00 -1.24895482e+00 -5.74757944e-01 -5.74757944e-01
 -5.74757944e-01  1.01630865e+00  1.01630865e+00  1.01630865e+00
  7.22877464e+00  7.22877464e+00  7.22877464e+00  9.97595517e+00
  3.30936055e+01  3.30936055e+01  3.30936055e+01  1.16197827e+02
  1.27629866e+02  1.27629866e+02  1.27629866e+02  4.78681352e+02
  4.78681352e+02  4.78681352e+02  6.53431132e+02  1.32378884e+03
  1.32378884e+03  1.32378884e+03  2.79283515e+03  3.00948973e+03
  3.00948973e+03  3.00948973e+03  6.62450803e+03  6.62450803e+03
  6.62450803e+03  9.21096362e+03  2.55573192e+04  7.62875778e+04]
E1 = -728.3413918486261  E_coul = 201.63176860762078
cycle= 3 E= -526.709623241005  delta_E= -3.46e-05  |g|= 0.00482  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104527
diis-c [-4.24157750e-07 -1.10446044e-03  1.30775540e-01  8.70328920e-01]
  HOMO = -0.575681163964249  LUMO = 1.01562625752041
  mo_energy =
[-1.18576883e+02 -1.23049013e+01 -9.55765538e+00 -9.55765538e+00
 -9.55765538e+00 -1.25007583e+00 -5.75681164e-01 -5.75681164e-01
 -5.75681164e-01  1.01562626e+00  1.01562626e+00  1.01562626e+00
  7.22628140e+00  7.22628140e+00  7.22628140e+00  9.97281161e+00
  3.30892533e+01  3.30892533e+01  3.30892533e+01  1.16191524e+02
  1.27623702e+02  1.27623702e+02  1.27623702e+02  4.78673892e+02
  4.78673892e+02  4.78673892e+02  6.53423276e+02  1.32378086e+03
  1.32378086e+03  1.32378086e+03  2.79282660e+03  3.00948140e+03
  3.00948140e+03  3.00948140e+03  6.62449935e+03  6.62449935e+03
  6.62449935e+03  9.21095475e+03  2.55573102e+04  7.62875686e+04]
E1 = -728.3556050087287  E_coul = 201.6459809275004
cycle= 4 E= -526.709624081228  delta_E= -8.4e-07  |g|= 5.88e-05  |ddm|= 0.00131
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122144
diis-c [-1.31127318e-09  6.37693356e-05 -8.97970917e-03 -7.03856991e-02
  1.07930164e+00]
  HOMO = -0.575669342936529  LUMO = 1.01563498419073
  mo_energy =
[-1.18576887e+02 -1.23048729e+01 -9.55763845e+00 -9.55763845e+00
 -9.55763845e+00 -1.25005710e+00 -5.75669343e-01 -5.75669343e-01
 -5.75669343e-01  1.01563498e+00  1.01563498e+00  1.01563498e+00
  7.22630155e+00  7.22630155e+00  7.22630155e+00  9.97284642e+00
  3.30892690e+01  3.30892690e+01  3.30892690e+01  1.16191534e+02
  1.27623709e+02  1.27623709e+02  1.27623709e+02  4.78673888e+02
  4.78673888e+02  4.78673888e+02  6.53423263e+02  1.32378085e+03
  1.32378085e+03  1.32378085e+03  2.79282657e+03  3.00948138e+03
  3.00948138e+03  3.00948138e+03  6.62449931e+03  6.62449931e+03
  6.62449931e+03  9.21095471e+03  2.55573101e+04  7.62875686e+04]
E1 = -728.3556032904071  E_coul = 201.64597920907187
cycle= 5 E= -526.709624081335  delta_E= -1.07e-10  |g|= 7.72e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3556032904071  E_coul = 201.64597920907187
  HOMO = -0.575672777480227  LUMO = 1.0156324862082
  mo_energy =
[-1.18576904e+02 -1.23048850e+01 -9.55765114e+00 -9.55765114e+00
 -9.55765114e+00 -1.25006133e+00 -5.75672777e-01 -5.75672777e-01
 -5.75672777e-01  1.01563249e+00  1.01563249e+00  1.01563249e+00
  7.22629325e+00  7.22629325e+00  7.22629325e+00  9.97283652e+00
  3.30892566e+01  3.30892566e+01  3.30892566e+01  1.16191519e+02
  1.27623694e+02  1.27623694e+02  1.27623694e+02  4.78673871e+02
  4.78673871e+02  4.78673871e+02  6.53423246e+02  1.32378083e+03
  1.32378083e+03  1.32378083e+03  2.79282655e+03  3.00948136e+03
  3.00948136e+03  3.00948136e+03  6.62449930e+03  6.62449930e+03
  6.62449930e+03  9.21095469e+03  2.55573101e+04  7.62875685e+04]
E1 = -728.3556413490155  E_coul = 201.64601726767782
Extra cycle  E= -526.709624081338  delta_E= -2.39e-12  |g|= 2.28e-06  |ddm|= 3.93e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.22 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 92178.24612457937
E1 = -728.3556413490155  E_coul = 201.64601726767782
init E= -526.709624081338
    CPU time for initialize scf      3.78 sec, wall time      0.21 sec
  HOMO = -0.575672081232108  LUMO = 1.01563299853654
  mo_energy =
[-1.18576900e+02 -1.23048822e+01 -9.55764826e+00 -9.55764826e+00
 -9.55764826e+00 -1.25006046e+00 -5.75672081e-01 -5.75672081e-01
 -5.75672081e-01  1.01563300e+00  1.01563300e+00  1.01563300e+00
  7.22629502e+00  7.22629502e+00  7.22629502e+00  9.97283877e+00
  3.30892595e+01  3.30892595e+01  3.30892595e+01  1.16191523e+02
  1.27623698e+02  1.27623698e+02  1.27623698e+02  4.78673876e+02
  4.78673876e+02  4.78673876e+02  6.53423251e+02  1.32378083e+03
  1.32378083e+03  1.32378083e+03  2.79282655e+03  3.00948136e+03
  3.00948136e+03  3.00948136e+03  6.62449930e+03  6.62449930e+03
  6.62449930e+03  9.21095469e+03  2.55573101e+04  7.62875686e+04]
E1 = -728.3556323053683  E_coul = 201.64600822403028
cycle= 1 E= -526.709624081338  delta_E= -3.41e-13  |g|= 5.85e-07  |ddm|= 8.98e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3556323053683  E_coul = 201.64600822403028
  HOMO = -0.575672235149644  LUMO = 1.01563288464672
  mo_energy =
[-1.18576901e+02 -1.23048829e+01 -9.55764894e+00 -9.55764894e+00
 -9.55764894e+00 -1.25006065e+00 -5.75672235e-01 -5.75672235e-01
 -5.75672235e-01  1.01563288e+00  1.01563288e+00  1.01563288e+00
  7.22629461e+00  7.22629461e+00  7.22629461e+00  9.97283825e+00
  3.30892588e+01  3.30892588e+01  3.30892588e+01  1.16191522e+02
  1.27623697e+02  1.27623697e+02  1.27623697e+02  4.78673875e+02
  4.78673875e+02  4.78673875e+02  6.53423250e+02  1.32378083e+03
  1.32378083e+03  1.32378083e+03  2.79282655e+03  3.00948136e+03
  3.00948136e+03  3.00948136e+03  6.62449930e+03  6.62449930e+03
  6.62449930e+03  9.21095469e+03  2.55573101e+04  7.62875685e+04]
E1 = -728.3556345089888  E_coul = 201.64601042765
Extra cycle  E= -526.709624081339  delta_E= -7.96e-13  |g|= 1.47e-07  |ddm|= 2.11e-07
    CPU time for scf_cycle      3.89 sec, wall time      0.32 sec
exp = [2.61828731e+04 7.61704061e+03 3.61756786e+03 1.58735820e+03
 4.15580549e+02 1.21189637e+02 3.88789395e+01 8.05890307e+00
 3.16076669e+00 3.98562316e-01 1.36285806e+03 6.64057608e+02
 2.97734417e+02 3.11264091e+02 6.10512067e+01 7.27651280e+00
 2.00580932e+01 7.71137495e-01 2.79625676e+00 2.22635812e-01]
grad_E = [-1.40310873e-06  2.20801181e-06 -2.13586102e-06  3.83043114e-05
  1.43171258e-05  3.99056643e-06 -1.30127082e-07 -1.96519290e-06
  9.14945273e-07  2.36891504e-05 -5.07349165e-07  5.18265619e-06
  2.47989160e-05  2.12283324e-05 -3.09322300e-05 -1.32856060e-05
 -8.98473514e-06  3.84389378e-05  2.04197862e-05 -1.23262231e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:02:36 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8727798        1
[INPUT] 0    0    [1    /1   ]  7617.04120065        1
[INPUT] 0    0    [1    /1   ]  3617.56744132        1
[INPUT] 0    0    [1    /1   ]  1587.36979578        1
[INPUT] 0    0    [1    /1   ]  415.561897768        1
[INPUT] 0    0    [1    /1   ]  121.184224774        1
[INPUT] 0    0    [1    /1   ]  38.8775246024        1
[INPUT] 0    0    [1    /1   ]  8.05835646368        1
[INPUT] 0    0    [1    /1   ]  3.16062214259        1
[INPUT] 0    0    [1    /1   ]  0.398563798292       1
[INPUT] 1    0    [1    /1   ]  1362.85793683        1
[INPUT] 1    0    [1    /1   ]  664.058560916        1
[INPUT] 1    0    [1    /1   ]  297.73880305         1
[INPUT] 1    0    [1    /1   ]  311.267849048        1
[INPUT] 1    0    [1    /1   ]  61.0629945828        1
[INPUT] 1    0    [1    /1   ]  7.27836237608        1
[INPUT] 1    0    [1    /1   ]  20.0627962029        1
[INPUT] 1    0    [1    /1   ]  0.771232430086       1
[INPUT] 1    0    [1    /1   ]  2.79708770484        1
[INPUT] 1    0    [1    /1   ]  0.222652098305       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.87277975595, 1.0]], [0, [7617.041200654945, 1.0]], [0, [3617.567441323057, 1.0]], [0, [1587.369795784315, 1.0]], [0, [415.56189776812545, 1.0]], [0, [121.1842247739278, 1.0]], [0, [38.877524602442435, 1.0]], [0, [8.058356463677857, 1.0]], [0, [3.1606221425884162, 1.0]], [0, [0.3985637982918881, 1.0]], [1, [1362.8579368275987, 1.0]], [1, [664.0585609158668, 1.0]], [1, [297.73880304984175, 1.0]], [1, [311.26784904841185, 1.0]], [1, [61.06299458277818, 1.0]], [1, [7.278362376078477, 1.0]], [1, [20.06279620294282, 1.0]], [1, [0.7712324300860414, 1.0]], [1, [2.7970877048350036, 1.0]], [1, [0.22265209830463042, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87277976]
bas 1, expnt(s) = [7617.04120065]
bas 2, expnt(s) = [3617.56744132]
bas 3, expnt(s) = [1587.36979578]
bas 4, expnt(s) = [415.56189777]
bas 5, expnt(s) = [121.18422477]
bas 6, expnt(s) = [38.8775246]
bas 7, expnt(s) = [8.05835646]
bas 8, expnt(s) = [3.16062214]
bas 9, expnt(s) = [0.3985638]
bas 10, expnt(s) = [1362.85793683]
bas 11, expnt(s) = [664.05856092]
bas 12, expnt(s) = [297.73880305]
bas 13, expnt(s) = [311.26784905]
bas 14, expnt(s) = [61.06299458]
bas 15, expnt(s) = [7.27836238]
bas 16, expnt(s) = [20.0627962]
bas 17, expnt(s) = [0.77123243]
bas 18, expnt(s) = [2.7970877]
bas 19, expnt(s) = [0.2226521]
CPU time:      1820.75
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828728e+04 5.20029518e+03 7.61704120e+03 2.05994086e+03
 3.61756744e+03 1.17849434e+03 1.58736980e+03 6.35365470e+02
 4.15561898e+02 2.32536866e+02 1.21184225e+02 9.22783012e+01
 3.88775246e+01 3.93358897e+01 8.05835646e+00 1.20836985e+01
 3.16062214e+00 5.98886410e+00 3.98563798e-01 1.26732619e+00
 1.36285794e+03 2.41572574e+04 6.64058561e+02 9.83427543e+03
 2.97738803e+02 3.60810103e+03 3.11267849e+02 3.81418912e+03
 6.10629946e+01 4.97974399e+02 7.27836238e+00 3.48759853e+01
 2.00627962e+01 1.23872163e+02 7.71232430e-01 2.10846306e+00
 2.79708770e+00 1.05527828e+01 2.22652098e-01 4.46187997e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982999593584193
cond(S) = 92209.62602774918
E1 = -729.3788350324306  E_coul = 203.12173407876193
init E= -526.257100953669
    CPU time for initialize scf      0.91 sec, wall time      0.06 sec
  HOMO = -0.556986146394265  LUMO = 1.02735716040019
  mo_energy =
[-1.18335082e+02 -1.22078015e+01 -9.45157323e+00 -9.45157323e+00
 -9.45157323e+00 -1.22604553e+00 -5.56986146e-01 -5.56986146e-01
 -5.56986146e-01  1.02735716e+00  1.02735716e+00  1.02735716e+00
  7.28818090e+00  7.28818090e+00  7.28818090e+00  1.00416695e+01
  3.32107111e+01  3.32107111e+01  3.32107111e+01  1.16355095e+02
  1.27828744e+02  1.27828744e+02  1.27828744e+02  4.78974182e+02
  4.78974182e+02  4.78974182e+02  6.53674020e+02  1.32414715e+03
  1.32414715e+03  1.32414715e+03  2.79318369e+03  3.00992259e+03
  3.00992259e+03  3.00992259e+03  6.62505500e+03  6.62505500e+03
  6.62505500e+03  9.21142793e+03  2.55578877e+04  7.62882442e+04]
E1 = -727.9831813107334  E_coul = 201.2741824544424
cycle= 1 E= -526.708998856291  delta_E= -0.452  |g|= 0.183  |ddm|= 0.402
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.537851
diis-c [-0.28928392  1.        ]
  HOMO = -0.581474843144791  LUMO = 1.01141031211192
  mo_energy =
[-1.18627913e+02 -1.23316529e+01 -9.58543880e+00 -9.58543880e+00
 -9.58543880e+00 -1.25748483e+00 -5.81474843e-01 -5.81474843e-01
 -5.81474843e-01  1.01141031e+00  1.01141031e+00  1.01141031e+00
  7.21274223e+00  7.21274223e+00  7.21274223e+00  9.95034160e+00
  3.30717517e+01  3.30717517e+01  3.30717517e+01  1.16140989e+02
  1.27616027e+02  1.27616027e+02  1.27616027e+02  4.78683387e+02
  4.78683387e+02  4.78683387e+02  6.53336602e+02  1.32380073e+03
  1.32380073e+03  1.32380073e+03  2.79270261e+03  3.00951055e+03
  3.00951055e+03  3.00951055e+03  6.62453094e+03  6.62453094e+03
  6.62453094e+03  9.21083034e+03  2.55571965e+04  7.62874632e+04]
E1 = -728.4463264152046  E_coul = 201.7367377348509
cycle= 2 E= -526.709588680354  delta_E= -0.00059  |g|= 0.0334  |ddm|= 0.0386
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0668005
diis-c [-0.00266829  0.07331544  0.92668456]
  HOMO = -0.574756563169016  LUMO = 1.01645551106695
  mo_energy =
[-1.18569315e+02 -1.23008543e+01 -9.55333813e+00 -9.55333813e+00
 -9.55333813e+00 -1.24895416e+00 -5.74756563e-01 -5.74756563e-01
 -5.74756563e-01  1.01645551e+00  1.01645551e+00  1.01645551e+00
  7.23110703e+00  7.23110703e+00  7.23110703e+00  9.97493094e+00
  3.31043518e+01  3.31043518e+01  3.31043518e+01  1.16189860e+02
  1.27663364e+02  1.27663364e+02  1.27663364e+02  4.78741179e+02
  4.78741179e+02  4.78741179e+02  6.53397201e+02  1.32386236e+03
  1.32386236e+03  1.32386236e+03  2.79276734e+03  3.00957426e+03
  3.00957426e+03  3.00957426e+03  6.62459622e+03  6.62459622e+03
  6.62459622e+03  9.21089633e+03  2.55572629e+04  7.62875299e+04]
E1 = -728.3414313319304  E_coul = 201.63180804174215
cycle= 3 E= -526.709623290188  delta_E= -3.46e-05  |g|= 0.00482  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104527
diis-c [-4.24211806e-07 -1.10448892e-03  1.30773963e-01  8.70330526e-01]
  HOMO = -0.575679741577826  LUMO = 1.01577303048783
  mo_energy =
[-1.18576878e+02 -1.23048987e+01 -9.55765312e+00 -9.55765312e+00
 -9.55765312e+00 -1.25007512e+00 -5.75679742e-01 -5.75679742e-01
 -5.75679742e-01  1.01577303e+00  1.01577303e+00  1.01577303e+00
  7.22861339e+00  7.22861339e+00  7.22861339e+00  9.97178765e+00
  3.30999994e+01  3.30999994e+01  3.30999994e+01  1.16183557e+02
  1.27657199e+02  1.27657199e+02  1.27657199e+02  4.78733719e+02
  4.78733719e+02  4.78733719e+02  6.53389345e+02  1.32385437e+03
  1.32385437e+03  1.32385437e+03  2.79275878e+03  3.00956593e+03
  3.00956593e+03  3.00956593e+03  6.62458754e+03  6.62458754e+03
  6.62458754e+03  9.21088746e+03  2.55572539e+04  7.62875207e+04]
E1 = -728.3556439084103  E_coul = 201.64601977805324
cycle= 4 E= -526.709624130357  delta_E= -8.4e-07  |g|= 5.88e-05  |ddm|= 0.00131
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00012215
diis-c [-1.31115736e-09  6.37708652e-05 -8.97977971e-03 -7.03875422e-02
  1.07930355e+00]
  HOMO = -0.575667919868749  LUMO = 1.01578175895634
  mo_energy =
[-1.18576882e+02 -1.23048703e+01 -9.55763619e+00 -9.55763619e+00
 -9.55763619e+00 -1.25005639e+00 -5.75667920e-01 -5.75667920e-01
 -5.75667920e-01  1.01578176e+00  1.01578176e+00  1.01578176e+00
  7.22863355e+00  7.22863355e+00  7.22863355e+00  9.97182246e+00
  3.31000151e+01  3.31000151e+01  3.31000151e+01  1.16183567e+02
  1.27657207e+02  1.27657207e+02  1.27657207e+02  4.78733715e+02
  4.78733715e+02  4.78733715e+02  6.53389333e+02  1.32385436e+03
  1.32385436e+03  1.32385436e+03  2.79275875e+03  3.00956591e+03
  3.00956591e+03  3.00956591e+03  6.62458751e+03  6.62458751e+03
  6.62458751e+03  9.21088742e+03  2.55572539e+04  7.62875207e+04]
E1 = -728.3556421859533  E_coul = 201.6460180554896
cycle= 5 E= -526.709624130464  delta_E= -1.07e-10  |g|= 7.72e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3556421859533  E_coul = 201.6460180554896
  HOMO = -0.575671354541633  LUMO = 1.01577926045054
  mo_energy =
[-1.18576899e+02 -1.23048824e+01 -9.55764888e+00 -9.55764888e+00
 -9.55764888e+00 -1.25006061e+00 -5.75671355e-01 -5.75671355e-01
 -5.75671355e-01  1.01577926e+00  1.01577926e+00  1.01577926e+00
  7.22862524e+00  7.22862524e+00  7.22862524e+00  9.97181256e+00
  3.31000026e+01  3.31000026e+01  3.31000026e+01  1.16183552e+02
  1.27657192e+02  1.27657192e+02  1.27657192e+02  4.78733698e+02
  4.78733698e+02  4.78733698e+02  6.53389315e+02  1.32385434e+03
  1.32385434e+03  1.32385434e+03  2.79275873e+03  3.00956589e+03
  3.00956589e+03  3.00956589e+03  6.62458749e+03  6.62458749e+03
  6.62458749e+03  9.21088740e+03  2.55572538e+04  7.62875207e+04]
E1 = -728.3556802462772  E_coul = 201.64605611581007
Extra cycle  E= -526.709624130467  delta_E= -3.41e-12  |g|= 2.28e-06  |ddm|= 3.93e-06
    CPU time for scf_cycle      1.10 sec, wall time      0.25 sec
exp = [2.61828728e+04 7.61704120e+03 3.61756744e+03 1.58736980e+03
 4.15561898e+02 1.21184225e+02 3.88775246e+01 8.05835646e+00
 3.16062214e+00 3.98563798e-01 1.36285794e+03 6.64058561e+02
 2.97738803e+02 3.11267849e+02 6.10629946e+01 7.27836238e+00
 2.00627962e+01 7.71232430e-01 2.79708770e+00 2.22652098e-01]
E = -526.7096241304671
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:02:36 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8727798        1
[INPUT] 0    0    [1    /1   ]  7617.04120065        1
[INPUT] 0    0    [1    /1   ]  3617.56744132        1
[INPUT] 0    0    [1    /1   ]  1587.36979578        1
[INPUT] 0    0    [1    /1   ]  415.561897768        1
[INPUT] 0    0    [1    /1   ]  121.184224774        1
[INPUT] 0    0    [1    /1   ]  38.8775246024        1
[INPUT] 0    0    [1    /1   ]  8.05835646368        1
[INPUT] 0    0    [1    /1   ]  3.16062214259        1
[INPUT] 0    0    [1    /1   ]  0.398563798292       1
[INPUT] 1    0    [1    /1   ]  1362.85793683        1
[INPUT] 1    0    [1    /1   ]  664.058560916        1
[INPUT] 1    0    [1    /1   ]  297.73880305         1
[INPUT] 1    0    [1    /1   ]  311.267849048        1
[INPUT] 1    0    [1    /1   ]  61.0629945828        1
[INPUT] 1    0    [1    /1   ]  7.27836237608        1
[INPUT] 1    0    [1    /1   ]  20.0627962029        1
[INPUT] 1    0    [1    /1   ]  0.771232430086       1
[INPUT] 1    0    [1    /1   ]  2.79708770484        1
[INPUT] 1    0    [1    /1   ]  0.222652098305       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.87277975595, 1.0]], [0, [7617.041200654945, 1.0]], [0, [3617.567441323057, 1.0]], [0, [1587.369795784315, 1.0]], [0, [415.56189776812545, 1.0]], [0, [121.1842247739278, 1.0]], [0, [38.877524602442435, 1.0]], [0, [8.058356463677857, 1.0]], [0, [3.1606221425884162, 1.0]], [0, [0.3985637982918881, 1.0]], [1, [1362.8579368275987, 1.0]], [1, [664.0585609158668, 1.0]], [1, [297.73880304984175, 1.0]], [1, [311.26784904841185, 1.0]], [1, [61.06299458277818, 1.0]], [1, [7.278362376078477, 1.0]], [1, [20.06279620294282, 1.0]], [1, [0.7712324300860414, 1.0]], [1, [2.7970877048350036, 1.0]], [1, [0.22265209830463042, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87277976]
bas 1, expnt(s) = [7617.04120065]
bas 2, expnt(s) = [3617.56744132]
bas 3, expnt(s) = [1587.36979578]
bas 4, expnt(s) = [415.56189777]
bas 5, expnt(s) = [121.18422477]
bas 6, expnt(s) = [38.8775246]
bas 7, expnt(s) = [8.05835646]
bas 8, expnt(s) = [3.16062214]
bas 9, expnt(s) = [0.3985638]
bas 10, expnt(s) = [1362.85793683]
bas 11, expnt(s) = [664.05856092]
bas 12, expnt(s) = [297.73880305]
bas 13, expnt(s) = [311.26784905]
bas 14, expnt(s) = [61.06299458]
bas 15, expnt(s) = [7.27836238]
bas 16, expnt(s) = [20.0627962]
bas 17, expnt(s) = [0.77123243]
bas 18, expnt(s) = [2.7970877]
bas 19, expnt(s) = [0.2226521]
CPU time:      1822.16
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828728e+04 5.20029518e+03 7.61704120e+03 2.05994086e+03
 3.61756744e+03 1.17849434e+03 1.58736980e+03 6.35365470e+02
 4.15561898e+02 2.32536866e+02 1.21184225e+02 9.22783012e+01
 3.88775246e+01 3.93358897e+01 8.05835646e+00 1.20836985e+01
 3.16062214e+00 5.98886410e+00 3.98563798e-01 1.26732619e+00
 1.36285794e+03 2.41572574e+04 6.64058561e+02 9.83427543e+03
 2.97738803e+02 3.60810103e+03 3.11267849e+02 3.81418912e+03
 6.10629946e+01 4.97974399e+02 7.27836238e+00 3.48759853e+01
 2.00627962e+01 1.23872163e+02 7.71232430e-01 2.10846306e+00
 2.79708770e+00 1.05527828e+01 2.22652098e-01 4.46187997e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982999593584193
cond(S) = 92209.62602774918
E1 = -729.3788350324306  E_coul = 203.12173407876193
init E= -526.257100953669
    CPU time for initialize scf      0.65 sec, wall time      0.05 sec
  HOMO = -0.556986146394265  LUMO = 1.02735716040019
  mo_energy =
[-1.18335082e+02 -1.22078015e+01 -9.45157323e+00 -9.45157323e+00
 -9.45157323e+00 -1.22604553e+00 -5.56986146e-01 -5.56986146e-01
 -5.56986146e-01  1.02735716e+00  1.02735716e+00  1.02735716e+00
  7.28818090e+00  7.28818090e+00  7.28818090e+00  1.00416695e+01
  3.32107111e+01  3.32107111e+01  3.32107111e+01  1.16355095e+02
  1.27828744e+02  1.27828744e+02  1.27828744e+02  4.78974182e+02
  4.78974182e+02  4.78974182e+02  6.53674020e+02  1.32414715e+03
  1.32414715e+03  1.32414715e+03  2.79318369e+03  3.00992259e+03
  3.00992259e+03  3.00992259e+03  6.62505500e+03  6.62505500e+03
  6.62505500e+03  9.21142793e+03  2.55578877e+04  7.62882442e+04]
E1 = -727.9831813107334  E_coul = 201.2741824544424
cycle= 1 E= -526.708998856291  delta_E= -0.452  |g|= 0.183  |ddm|= 0.402
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.537851
diis-c [-0.28928392  1.        ]
  HOMO = -0.581474843144791  LUMO = 1.01141031211192
  mo_energy =
[-1.18627913e+02 -1.23316529e+01 -9.58543880e+00 -9.58543880e+00
 -9.58543880e+00 -1.25748483e+00 -5.81474843e-01 -5.81474843e-01
 -5.81474843e-01  1.01141031e+00  1.01141031e+00  1.01141031e+00
  7.21274223e+00  7.21274223e+00  7.21274223e+00  9.95034160e+00
  3.30717517e+01  3.30717517e+01  3.30717517e+01  1.16140989e+02
  1.27616027e+02  1.27616027e+02  1.27616027e+02  4.78683387e+02
  4.78683387e+02  4.78683387e+02  6.53336602e+02  1.32380073e+03
  1.32380073e+03  1.32380073e+03  2.79270261e+03  3.00951055e+03
  3.00951055e+03  3.00951055e+03  6.62453094e+03  6.62453094e+03
  6.62453094e+03  9.21083034e+03  2.55571965e+04  7.62874632e+04]
E1 = -728.4463264152046  E_coul = 201.7367377348509
cycle= 2 E= -526.709588680354  delta_E= -0.00059  |g|= 0.0334  |ddm|= 0.0386
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0668005
diis-c [-0.00266829  0.07331544  0.92668456]
  HOMO = -0.574756563169016  LUMO = 1.01645551106695
  mo_energy =
[-1.18569315e+02 -1.23008543e+01 -9.55333813e+00 -9.55333813e+00
 -9.55333813e+00 -1.24895416e+00 -5.74756563e-01 -5.74756563e-01
 -5.74756563e-01  1.01645551e+00  1.01645551e+00  1.01645551e+00
  7.23110703e+00  7.23110703e+00  7.23110703e+00  9.97493094e+00
  3.31043518e+01  3.31043518e+01  3.31043518e+01  1.16189860e+02
  1.27663364e+02  1.27663364e+02  1.27663364e+02  4.78741179e+02
  4.78741179e+02  4.78741179e+02  6.53397201e+02  1.32386236e+03
  1.32386236e+03  1.32386236e+03  2.79276734e+03  3.00957426e+03
  3.00957426e+03  3.00957426e+03  6.62459622e+03  6.62459622e+03
  6.62459622e+03  9.21089633e+03  2.55572629e+04  7.62875299e+04]
E1 = -728.3414313319304  E_coul = 201.63180804174215
cycle= 3 E= -526.709623290188  delta_E= -3.46e-05  |g|= 0.00482  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104527
diis-c [-4.24211806e-07 -1.10448892e-03  1.30773963e-01  8.70330526e-01]
  HOMO = -0.575679741577826  LUMO = 1.01577303048783
  mo_energy =
[-1.18576878e+02 -1.23048987e+01 -9.55765312e+00 -9.55765312e+00
 -9.55765312e+00 -1.25007512e+00 -5.75679742e-01 -5.75679742e-01
 -5.75679742e-01  1.01577303e+00  1.01577303e+00  1.01577303e+00
  7.22861339e+00  7.22861339e+00  7.22861339e+00  9.97178765e+00
  3.30999994e+01  3.30999994e+01  3.30999994e+01  1.16183557e+02
  1.27657199e+02  1.27657199e+02  1.27657199e+02  4.78733719e+02
  4.78733719e+02  4.78733719e+02  6.53389345e+02  1.32385437e+03
  1.32385437e+03  1.32385437e+03  2.79275878e+03  3.00956593e+03
  3.00956593e+03  3.00956593e+03  6.62458754e+03  6.62458754e+03
  6.62458754e+03  9.21088746e+03  2.55572539e+04  7.62875207e+04]
E1 = -728.3556439084103  E_coul = 201.64601977805324
cycle= 4 E= -526.709624130357  delta_E= -8.4e-07  |g|= 5.88e-05  |ddm|= 0.00131
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00012215
diis-c [-1.31115736e-09  6.37708652e-05 -8.97977971e-03 -7.03875422e-02
  1.07930355e+00]
  HOMO = -0.575667919868749  LUMO = 1.01578175895634
  mo_energy =
[-1.18576882e+02 -1.23048703e+01 -9.55763619e+00 -9.55763619e+00
 -9.55763619e+00 -1.25005639e+00 -5.75667920e-01 -5.75667920e-01
 -5.75667920e-01  1.01578176e+00  1.01578176e+00  1.01578176e+00
  7.22863355e+00  7.22863355e+00  7.22863355e+00  9.97182246e+00
  3.31000151e+01  3.31000151e+01  3.31000151e+01  1.16183567e+02
  1.27657207e+02  1.27657207e+02  1.27657207e+02  4.78733715e+02
  4.78733715e+02  4.78733715e+02  6.53389333e+02  1.32385436e+03
  1.32385436e+03  1.32385436e+03  2.79275875e+03  3.00956591e+03
  3.00956591e+03  3.00956591e+03  6.62458751e+03  6.62458751e+03
  6.62458751e+03  9.21088742e+03  2.55572539e+04  7.62875207e+04]
E1 = -728.3556421859533  E_coul = 201.6460180554896
cycle= 5 E= -526.709624130464  delta_E= -1.07e-10  |g|= 7.72e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3556421859533  E_coul = 201.6460180554896
  HOMO = -0.575671354541633  LUMO = 1.01577926045054
  mo_energy =
[-1.18576899e+02 -1.23048824e+01 -9.55764888e+00 -9.55764888e+00
 -9.55764888e+00 -1.25006061e+00 -5.75671355e-01 -5.75671355e-01
 -5.75671355e-01  1.01577926e+00  1.01577926e+00  1.01577926e+00
  7.22862524e+00  7.22862524e+00  7.22862524e+00  9.97181256e+00
  3.31000026e+01  3.31000026e+01  3.31000026e+01  1.16183552e+02
  1.27657192e+02  1.27657192e+02  1.27657192e+02  4.78733698e+02
  4.78733698e+02  4.78733698e+02  6.53389315e+02  1.32385434e+03
  1.32385434e+03  1.32385434e+03  2.79275873e+03  3.00956589e+03
  3.00956589e+03  3.00956589e+03  6.62458749e+03  6.62458749e+03
  6.62458749e+03  9.21088740e+03  2.55572538e+04  7.62875207e+04]
E1 = -728.3556802462772  E_coul = 201.64605611581007
Extra cycle  E= -526.709624130467  delta_E= -3.41e-12  |g|= 2.28e-06  |ddm|= 3.93e-06
    CPU time for scf_cycle      0.83 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 92209.62602774918
E1 = -728.3556802462772  E_coul = 201.64605611581007
init E= -526.709624130467
    CPU time for initialize scf      4.02 sec, wall time      0.22 sec
  HOMO = -0.575670658267925  LUMO = 1.01577977288596
  mo_energy =
[-1.18576895e+02 -1.23048796e+01 -9.55764600e+00 -9.55764600e+00
 -9.55764600e+00 -1.25005974e+00 -5.75670658e-01 -5.75670658e-01
 -5.75670658e-01  1.01577977e+00  1.01577977e+00  1.01577977e+00
  7.22862701e+00  7.22862701e+00  7.22862701e+00  9.97181481e+00
  3.31000055e+01  3.31000055e+01  3.31000055e+01  1.16183556e+02
  1.27657195e+02  1.27657195e+02  1.27657195e+02  4.78733703e+02
  4.78733703e+02  4.78733703e+02  6.53389320e+02  1.32385435e+03
  1.32385435e+03  1.32385435e+03  2.79275874e+03  3.00956590e+03
  3.00956590e+03  3.00956590e+03  6.62458749e+03  6.62458749e+03
  6.62458749e+03  9.21088740e+03  2.55572538e+04  7.62875207e+04]
E1 = -728.3556712022646  E_coul = 201.6460470717973
cycle= 1 E= -526.709624130467  delta_E= -2.27e-13  |g|= 5.85e-07  |ddm|= 8.98e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3556712022646  E_coul = 201.6460470717973
  HOMO = -0.575670812191674  LUMO = 1.01577965897234
  mo_energy =
[-1.18576896e+02 -1.23048802e+01 -9.55764668e+00 -9.55764668e+00
 -9.55764668e+00 -1.25005993e+00 -5.75670812e-01 -5.75670812e-01
 -5.75670812e-01  1.01577966e+00  1.01577966e+00  1.01577966e+00
  7.22862661e+00  7.22862661e+00  7.22862661e+00  9.97181429e+00
  3.31000048e+01  3.31000048e+01  3.31000048e+01  1.16183555e+02
  1.27657194e+02  1.27657194e+02  1.27657194e+02  4.78733702e+02
  4.78733702e+02  4.78733702e+02  6.53389319e+02  1.32385435e+03
  1.32385435e+03  1.32385435e+03  2.79275874e+03  3.00956590e+03
  3.00956590e+03  3.00956590e+03  6.62458749e+03  6.62458749e+03
  6.62458749e+03  9.21088740e+03  2.55572538e+04  7.62875207e+04]
E1 = -728.3556734059719  E_coul = 201.6460492755043
Extra cycle  E= -526.709624130468  delta_E= -2.27e-13  |g|= 1.47e-07  |ddm|= 2.11e-07
    CPU time for scf_cycle      4.14 sec, wall time      0.34 sec
exp = [2.61828728e+04 7.61704120e+03 3.61756744e+03 1.58736980e+03
 4.15561898e+02 1.21184225e+02 3.88775246e+01 8.05835646e+00
 3.16062214e+00 3.98563798e-01 1.36285794e+03 6.64058561e+02
 2.97738803e+02 3.11267849e+02 6.10629946e+01 7.27836238e+00
 2.00627962e+01 7.71232430e-01 2.79708770e+00 2.22652098e-01]
grad_E = [-1.40319530e-06  2.20873363e-06 -2.13580353e-06  3.83253446e-05
  1.41492211e-05  4.36983258e-06 -1.50584634e-06 -5.02835360e-06
  5.43248458e-06  4.69525834e-05 -5.07843562e-07  5.17635430e-06
  2.47639393e-05  2.11981443e-05 -3.09200523e-05 -2.90684704e-05
 -4.90599091e-06  7.92202706e-05  5.15102606e-05 -2.46734570e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:02:41 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8722821        1
[INPUT] 0    0    [1    /1   ]  7617.04213287        1
[INPUT] 0    0    [1    /1   ]  3617.56680419        1
[INPUT] 0    0    [1    /1   ]  1587.38821088        1
[INPUT] 0    0    [1    /1   ]  415.528970188        1
[INPUT] 0    0    [1    /1   ]  121.174759698        1
[INPUT] 0    0    [1    /1   ]  38.8750455101        1
[INPUT] 0    0    [1    /1   ]  8.05732324644        1
[INPUT] 0    0    [1    /1   ]  3.16034018622        1
[INPUT] 0    0    [1    /1   ]  0.398566245393       1
[INPUT] 1    0    [1    /1   ]  1362.85774128        1
[INPUT] 1    0    [1    /1   ]  664.060003344        1
[INPUT] 1    0    [1    /1   ]  297.745421063        1
[INPUT] 1    0    [1    /1   ]  311.27352125         1
[INPUT] 1    0    [1    /1   ]  61.0831032713        1
[INPUT] 1    0    [1    /1   ]  7.28153193161        1
[INPUT] 1    0    [1    /1   ]  20.0708462883        1
[INPUT] 1    0    [1    /1   ]  0.771396644461       1
[INPUT] 1    0    [1    /1   ]  2.79852441603        1
[INPUT] 1    0    [1    /1   ]  0.222680502043       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.872282068343, 1.0]], [0, [7617.042132867839, 1.0]], [0, [3617.5668041905956, 1.0]], [0, [1587.388210877696, 1.0]], [0, [415.52897018767607, 1.0]], [0, [121.17475969809755, 1.0]], [0, [38.87504551010854, 1.0]], [0, [8.057323246435676, 1.0]], [0, [3.1603401862156693, 1.0]], [0, [0.39856624539288354, 1.0]], [1, [1362.8577412795662, 1.0]], [1, [664.0600033440404, 1.0]], [1, [297.7454210625038, 1.0]], [1, [311.2735212503509, 1.0]], [1, [61.083103271339475, 1.0]], [1, [7.281531931612482, 1.0]], [1, [20.070846288349593, 1.0]], [1, [0.7713966444608745, 1.0]], [1, [2.7985244160280454, 1.0]], [1, [0.22268050204312784, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87228207]
bas 1, expnt(s) = [7617.04213287]
bas 2, expnt(s) = [3617.56680419]
bas 3, expnt(s) = [1587.38821088]
bas 4, expnt(s) = [415.52897019]
bas 5, expnt(s) = [121.1747597]
bas 6, expnt(s) = [38.87504551]
bas 7, expnt(s) = [8.05732325]
bas 8, expnt(s) = [3.16034019]
bas 9, expnt(s) = [0.39856625]
bas 10, expnt(s) = [1362.85774128]
bas 11, expnt(s) = [664.06000334]
bas 12, expnt(s) = [297.74542106]
bas 13, expnt(s) = [311.27352125]
bas 14, expnt(s) = [61.08310327]
bas 15, expnt(s) = [7.28153193]
bas 16, expnt(s) = [20.07084629]
bas 17, expnt(s) = [0.77139664]
bas 18, expnt(s) = [2.79852442]
bas 19, expnt(s) = [0.2226805]
CPU time:      1832.09
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828723e+04 5.20029511e+03 7.61704213e+03 2.05994105e+03
 3.61756680e+03 1.17849419e+03 1.58738821e+03 6.35370998e+02
 4.15528970e+02 2.32523047e+02 1.21174760e+02 9.22728957e+01
 3.88750455e+01 3.93340085e+01 8.05732325e+00 1.20825365e+01
 3.16034019e+00 5.98846340e+00 3.98566245e-01 1.26733203e+00
 1.36285774e+03 2.41572531e+04 6.64060003e+02 9.83430213e+03
 2.97745421e+02 3.60820128e+03 3.11273521e+02 3.81427600e+03
 6.10831033e+01 4.98179392e+02 7.28153193e+00 3.48949709e+01
 2.00708463e+01 1.23934294e+02 7.71396644e-01 2.10902425e+00
 2.79852442e+00 1.05595587e+01 2.22680502e-01 4.46259148e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982994424166172
cond(S) = 92260.52874543626
E1 = -729.3788804612875  E_coul = 203.12176786053502
init E= -526.257112600753
    CPU time for initialize scf      0.67 sec, wall time      0.05 sec
  HOMO = -0.556984001299644  LUMO = 1.02761625251765
  mo_energy =
[-1.18335077e+02 -1.22078006e+01 -9.45157192e+00 -9.45157192e+00
 -9.45157192e+00 -1.22604436e+00 -5.56984001e-01 -5.56984001e-01
 -5.56984001e-01  1.02761625e+00  1.02761625e+00  1.02761625e+00
  7.29222856e+00  7.29222856e+00  7.29222856e+00  1.00397058e+01
  3.32291916e+01  3.32291916e+01  3.32291916e+01  1.16340699e+02
  1.27886079e+02  1.27886079e+02  1.27886079e+02  4.79075836e+02
  4.79075836e+02  4.79075836e+02  6.53614000e+02  1.32427041e+03
  1.32427041e+03  1.32427041e+03  2.79306277e+03  3.01006236e+03
  3.01006236e+03  3.01006236e+03  6.62519951e+03  6.62519951e+03
  6.62519951e+03  9.21130496e+03  2.55577820e+04  7.62881525e+04]
E1 = -727.9832607552034  E_coul = 201.27426173968865
cycle= 1 E= -526.708999015515  delta_E= -0.452  |g|= 0.183  |ddm|= 0.402
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.537868
diis-c [-0.28930198  1.        ]
  HOMO = -0.58147202497983  LUMO = 1.0116641033233
  mo_energy =
[-1.18627903e+02 -1.23316476e+01 -9.58543408e+00 -9.58543408e+00
 -9.58543408e+00 -1.25748289e+00 -5.81472025e-01 -5.81472025e-01
 -5.81472025e-01  1.01166410e+00  1.01166410e+00  1.01166410e+00
  7.21676346e+00  7.21676346e+00  7.21676346e+00  9.94838964e+00
  3.30902091e+01  3.30902091e+01  3.30902091e+01  1.16126605e+02
  1.27673348e+02  1.27673348e+02  1.27673348e+02  4.78785045e+02
  4.78785045e+02  4.78785045e+02  6.53276594e+02  1.32392400e+03
  1.32392400e+03  1.32392400e+03  2.79258170e+03  3.00965032e+03
  3.00965032e+03  3.00965032e+03  6.62467545e+03  6.62467545e+03
  6.62467545e+03  9.21070738e+03  2.55570907e+04  7.62873714e+04]
E1 = -728.4463874371041  E_coul = 201.73679861640372
cycle= 2 E= -526.7095888207  delta_E= -0.00059  |g|= 0.0334  |ddm|= 0.0386
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0668017
diis-c [-0.00266828  0.07331656  0.92668344]
  HOMO = -0.574754191062823  LUMO = 1.01671053304558
  mo_energy =
[-1.18569307e+02 -1.23008503e+01 -9.55333468e+00 -9.55333468e+00
 -9.55333468e+00 -1.24895277e+00 -5.74754191e-01 -5.74754191e-01
 -5.74754191e-01  1.01671053e+00  1.01671053e+00  1.01671053e+00
  7.23513361e+00  7.23513361e+00  7.23513361e+00  9.97297589e+00
  3.31228139e+01  3.31228139e+01  3.31228139e+01  1.16175473e+02
  1.27720687e+02  1.27720687e+02  1.27720687e+02  4.78842836e+02
  4.78842836e+02  4.78842836e+02  6.53337190e+02  1.32398562e+03
  1.32398562e+03  1.32398562e+03  2.79264643e+03  3.00971403e+03
  3.00971403e+03  3.00971403e+03  6.62474073e+03  6.62474073e+03
  6.62474073e+03  9.21077336e+03  2.55571572e+04  7.62874381e+04]
E1 = -728.3414975485933  E_coul = 201.63187412014906
cycle= 3 E= -526.709623428444  delta_E= -3.46e-05  |g|= 0.00482  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104527
diis-c [-4.24326127e-07 -1.10454797e-03  1.30771173e-01  8.70333375e-01]
  HOMO = -0.575677300108273  LUMO = 1.01602789327137
  mo_energy =
[-1.18576869e+02 -1.23048944e+01 -9.55764941e+00 -9.55764941e+00
 -9.55764941e+00 -1.25007363e+00 -5.75677300e-01 -5.75677300e-01
 -5.75677300e-01  1.01602789e+00  1.01602789e+00  1.01602789e+00
  7.23263929e+00  7.23263929e+00  7.23263929e+00  9.96983308e+00
  3.31184609e+01  3.31184609e+01  3.31184609e+01  1.16169171e+02
  1.27714522e+02  1.27714522e+02  1.27714522e+02  4.78835376e+02
  4.78835376e+02  4.78835376e+02  6.53329335e+02  1.32397764e+03
  1.32397764e+03  1.32397764e+03  2.79263787e+03  3.00970571e+03
  3.00970571e+03  3.00970571e+03  6.62473205e+03  6.62473205e+03
  6.62473205e+03  9.21076449e+03  2.55571481e+04  7.62874290e+04]
E1 = -728.355709184344  E_coul = 201.64608491581814
cycle= 4 E= -526.709624268526  delta_E= -8.4e-07  |g|= 5.88e-05  |ddm|= 0.00131
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122165
diis-c [-1.31099796e-09  6.37747674e-05 -8.98002310e-03 -7.03919964e-02
  1.07930824e+00]
  HOMO = -0.57566547712655  LUMO = 1.0160366249291
  mo_energy =
[-1.18576874e+02 -1.23048660e+01 -9.55763249e+00 -9.55763249e+00
 -9.55763249e+00 -1.25005490e+00 -5.75665477e-01 -5.75665477e-01
 -5.75665477e-01  1.01603662e+00  1.01603662e+00  1.01603662e+00
  7.23265945e+00  7.23265945e+00  7.23265945e+00  9.96986790e+00
  3.31184766e+01  3.31184766e+01  3.31184766e+01  1.16169181e+02
  1.27714529e+02  1.27714529e+02  1.27714529e+02  4.78835373e+02
  4.78835373e+02  4.78835373e+02  6.53329323e+02  1.32397763e+03
  1.32397763e+03  1.32397763e+03  2.79263784e+03  3.00970569e+03
  3.00970569e+03  3.00970569e+03  6.62473202e+03  6.62473202e+03
  6.62473202e+03  9.21076445e+03  2.55571481e+04  7.62874289e+04]
E1 = -728.3557074581712  E_coul = 201.646083189541
cycle= 5 E= -526.70962426863  delta_E= -1.04e-10  |g|= 7.72e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3557074581712  E_coul = 201.646083189541
  HOMO = -0.575668912077965  LUMO = 1.01603412547868
  mo_energy =
[-1.18576891e+02 -1.23048781e+01 -9.55764518e+00 -9.55764518e+00
 -9.55764518e+00 -1.25005913e+00 -5.75668912e-01 -5.75668912e-01
 -5.75668912e-01  1.01603413e+00  1.01603413e+00  1.01603413e+00
  7.23265114e+00  7.23265114e+00  7.23265114e+00  9.96985799e+00
  3.31184642e+01  3.31184642e+01  3.31184642e+01  1.16169165e+02
  1.27714514e+02  1.27714514e+02  1.27714514e+02  4.78835356e+02
  4.78835356e+02  4.78835356e+02  6.53329305e+02  1.32397761e+03
  1.32397761e+03  1.32397761e+03  2.79263782e+03  3.00970567e+03
  3.00970567e+03  3.00970567e+03  6.62473200e+03  6.62473200e+03
  6.62473200e+03  9.21076443e+03  2.55571481e+04  7.62874289e+04]
E1 = -728.3557455221935  E_coul = 201.64612125355833
Extra cycle  E= -526.709624268635  delta_E= -4.89e-12  |g|= 2.28e-06  |ddm|= 3.93e-06
    CPU time for scf_cycle      0.86 sec, wall time      0.23 sec
exp = [2.61828723e+04 7.61704213e+03 3.61756680e+03 1.58738821e+03
 4.15528970e+02 1.21174760e+02 3.88750455e+01 8.05732325e+00
 3.16034019e+00 3.98566245e-01 1.36285774e+03 6.64060003e+02
 2.97745421e+02 3.11273521e+02 6.10831033e+01 7.28153193e+00
 2.00708463e+01 7.71396644e-01 2.79852442e+00 2.22680502e-01]
E = -526.7096242686351
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:02:41 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8722821        1
[INPUT] 0    0    [1    /1   ]  7617.04213287        1
[INPUT] 0    0    [1    /1   ]  3617.56680419        1
[INPUT] 0    0    [1    /1   ]  1587.38821088        1
[INPUT] 0    0    [1    /1   ]  415.528970188        1
[INPUT] 0    0    [1    /1   ]  121.174759698        1
[INPUT] 0    0    [1    /1   ]  38.8750455101        1
[INPUT] 0    0    [1    /1   ]  8.05732324644        1
[INPUT] 0    0    [1    /1   ]  3.16034018622        1
[INPUT] 0    0    [1    /1   ]  0.398566245393       1
[INPUT] 1    0    [1    /1   ]  1362.85774128        1
[INPUT] 1    0    [1    /1   ]  664.060003344        1
[INPUT] 1    0    [1    /1   ]  297.745421063        1
[INPUT] 1    0    [1    /1   ]  311.27352125         1
[INPUT] 1    0    [1    /1   ]  61.0831032713        1
[INPUT] 1    0    [1    /1   ]  7.28153193161        1
[INPUT] 1    0    [1    /1   ]  20.0708462883        1
[INPUT] 1    0    [1    /1   ]  0.771396644461       1
[INPUT] 1    0    [1    /1   ]  2.79852441603        1
[INPUT] 1    0    [1    /1   ]  0.222680502043       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.872282068343, 1.0]], [0, [7617.042132867839, 1.0]], [0, [3617.5668041905956, 1.0]], [0, [1587.388210877696, 1.0]], [0, [415.52897018767607, 1.0]], [0, [121.17475969809755, 1.0]], [0, [38.87504551010854, 1.0]], [0, [8.057323246435676, 1.0]], [0, [3.1603401862156693, 1.0]], [0, [0.39856624539288354, 1.0]], [1, [1362.8577412795662, 1.0]], [1, [664.0600033440404, 1.0]], [1, [297.7454210625038, 1.0]], [1, [311.2735212503509, 1.0]], [1, [61.083103271339475, 1.0]], [1, [7.281531931612482, 1.0]], [1, [20.070846288349593, 1.0]], [1, [0.7713966444608745, 1.0]], [1, [2.7985244160280454, 1.0]], [1, [0.22268050204312784, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87228207]
bas 1, expnt(s) = [7617.04213287]
bas 2, expnt(s) = [3617.56680419]
bas 3, expnt(s) = [1587.38821088]
bas 4, expnt(s) = [415.52897019]
bas 5, expnt(s) = [121.1747597]
bas 6, expnt(s) = [38.87504551]
bas 7, expnt(s) = [8.05732325]
bas 8, expnt(s) = [3.16034019]
bas 9, expnt(s) = [0.39856625]
bas 10, expnt(s) = [1362.85774128]
bas 11, expnt(s) = [664.06000334]
bas 12, expnt(s) = [297.74542106]
bas 13, expnt(s) = [311.27352125]
bas 14, expnt(s) = [61.08310327]
bas 15, expnt(s) = [7.28153193]
bas 16, expnt(s) = [20.07084629]
bas 17, expnt(s) = [0.77139664]
bas 18, expnt(s) = [2.79852442]
bas 19, expnt(s) = [0.2226805]
CPU time:      1833.25
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828723e+04 5.20029511e+03 7.61704213e+03 2.05994105e+03
 3.61756680e+03 1.17849419e+03 1.58738821e+03 6.35370998e+02
 4.15528970e+02 2.32523047e+02 1.21174760e+02 9.22728957e+01
 3.88750455e+01 3.93340085e+01 8.05732325e+00 1.20825365e+01
 3.16034019e+00 5.98846340e+00 3.98566245e-01 1.26733203e+00
 1.36285774e+03 2.41572531e+04 6.64060003e+02 9.83430213e+03
 2.97745421e+02 3.60820128e+03 3.11273521e+02 3.81427600e+03
 6.10831033e+01 4.98179392e+02 7.28153193e+00 3.48949709e+01
 2.00708463e+01 1.23934294e+02 7.71396644e-01 2.10902425e+00
 2.79852442e+00 1.05595587e+01 2.22680502e-01 4.46259148e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982994424166172
cond(S) = 92260.52874543626
E1 = -729.3788804612875  E_coul = 203.12176786053502
init E= -526.257112600753
    CPU time for initialize scf      0.63 sec, wall time      0.05 sec
  HOMO = -0.556984001299644  LUMO = 1.02761625251765
  mo_energy =
[-1.18335077e+02 -1.22078006e+01 -9.45157192e+00 -9.45157192e+00
 -9.45157192e+00 -1.22604436e+00 -5.56984001e-01 -5.56984001e-01
 -5.56984001e-01  1.02761625e+00  1.02761625e+00  1.02761625e+00
  7.29222856e+00  7.29222856e+00  7.29222856e+00  1.00397058e+01
  3.32291916e+01  3.32291916e+01  3.32291916e+01  1.16340699e+02
  1.27886079e+02  1.27886079e+02  1.27886079e+02  4.79075836e+02
  4.79075836e+02  4.79075836e+02  6.53614000e+02  1.32427041e+03
  1.32427041e+03  1.32427041e+03  2.79306277e+03  3.01006236e+03
  3.01006236e+03  3.01006236e+03  6.62519951e+03  6.62519951e+03
  6.62519951e+03  9.21130496e+03  2.55577820e+04  7.62881525e+04]
E1 = -727.9832607552034  E_coul = 201.27426173968865
cycle= 1 E= -526.708999015515  delta_E= -0.452  |g|= 0.183  |ddm|= 0.402
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.537868
diis-c [-0.28930198  1.        ]
  HOMO = -0.58147202497983  LUMO = 1.0116641033233
  mo_energy =
[-1.18627903e+02 -1.23316476e+01 -9.58543408e+00 -9.58543408e+00
 -9.58543408e+00 -1.25748289e+00 -5.81472025e-01 -5.81472025e-01
 -5.81472025e-01  1.01166410e+00  1.01166410e+00  1.01166410e+00
  7.21676346e+00  7.21676346e+00  7.21676346e+00  9.94838964e+00
  3.30902091e+01  3.30902091e+01  3.30902091e+01  1.16126605e+02
  1.27673348e+02  1.27673348e+02  1.27673348e+02  4.78785045e+02
  4.78785045e+02  4.78785045e+02  6.53276594e+02  1.32392400e+03
  1.32392400e+03  1.32392400e+03  2.79258170e+03  3.00965032e+03
  3.00965032e+03  3.00965032e+03  6.62467545e+03  6.62467545e+03
  6.62467545e+03  9.21070738e+03  2.55570907e+04  7.62873714e+04]
E1 = -728.4463874371041  E_coul = 201.73679861640372
cycle= 2 E= -526.7095888207  delta_E= -0.00059  |g|= 0.0334  |ddm|= 0.0386
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0668017
diis-c [-0.00266828  0.07331656  0.92668344]
  HOMO = -0.574754191062823  LUMO = 1.01671053304558
  mo_energy =
[-1.18569307e+02 -1.23008503e+01 -9.55333468e+00 -9.55333468e+00
 -9.55333468e+00 -1.24895277e+00 -5.74754191e-01 -5.74754191e-01
 -5.74754191e-01  1.01671053e+00  1.01671053e+00  1.01671053e+00
  7.23513361e+00  7.23513361e+00  7.23513361e+00  9.97297589e+00
  3.31228139e+01  3.31228139e+01  3.31228139e+01  1.16175473e+02
  1.27720687e+02  1.27720687e+02  1.27720687e+02  4.78842836e+02
  4.78842836e+02  4.78842836e+02  6.53337190e+02  1.32398562e+03
  1.32398562e+03  1.32398562e+03  2.79264643e+03  3.00971403e+03
  3.00971403e+03  3.00971403e+03  6.62474073e+03  6.62474073e+03
  6.62474073e+03  9.21077336e+03  2.55571572e+04  7.62874381e+04]
E1 = -728.3414975485933  E_coul = 201.63187412014906
cycle= 3 E= -526.709623428444  delta_E= -3.46e-05  |g|= 0.00482  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104527
diis-c [-4.24326127e-07 -1.10454797e-03  1.30771173e-01  8.70333375e-01]
  HOMO = -0.575677300108273  LUMO = 1.01602789327137
  mo_energy =
[-1.18576869e+02 -1.23048944e+01 -9.55764941e+00 -9.55764941e+00
 -9.55764941e+00 -1.25007363e+00 -5.75677300e-01 -5.75677300e-01
 -5.75677300e-01  1.01602789e+00  1.01602789e+00  1.01602789e+00
  7.23263929e+00  7.23263929e+00  7.23263929e+00  9.96983308e+00
  3.31184609e+01  3.31184609e+01  3.31184609e+01  1.16169171e+02
  1.27714522e+02  1.27714522e+02  1.27714522e+02  4.78835376e+02
  4.78835376e+02  4.78835376e+02  6.53329335e+02  1.32397764e+03
  1.32397764e+03  1.32397764e+03  2.79263787e+03  3.00970571e+03
  3.00970571e+03  3.00970571e+03  6.62473205e+03  6.62473205e+03
  6.62473205e+03  9.21076449e+03  2.55571481e+04  7.62874290e+04]
E1 = -728.355709184344  E_coul = 201.64608491581814
cycle= 4 E= -526.709624268526  delta_E= -8.4e-07  |g|= 5.88e-05  |ddm|= 0.00131
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122165
diis-c [-1.31099796e-09  6.37747674e-05 -8.98002310e-03 -7.03919964e-02
  1.07930824e+00]
  HOMO = -0.57566547712655  LUMO = 1.0160366249291
  mo_energy =
[-1.18576874e+02 -1.23048660e+01 -9.55763249e+00 -9.55763249e+00
 -9.55763249e+00 -1.25005490e+00 -5.75665477e-01 -5.75665477e-01
 -5.75665477e-01  1.01603662e+00  1.01603662e+00  1.01603662e+00
  7.23265945e+00  7.23265945e+00  7.23265945e+00  9.96986790e+00
  3.31184766e+01  3.31184766e+01  3.31184766e+01  1.16169181e+02
  1.27714529e+02  1.27714529e+02  1.27714529e+02  4.78835373e+02
  4.78835373e+02  4.78835373e+02  6.53329323e+02  1.32397763e+03
  1.32397763e+03  1.32397763e+03  2.79263784e+03  3.00970569e+03
  3.00970569e+03  3.00970569e+03  6.62473202e+03  6.62473202e+03
  6.62473202e+03  9.21076445e+03  2.55571481e+04  7.62874289e+04]
E1 = -728.3557074581712  E_coul = 201.646083189541
cycle= 5 E= -526.70962426863  delta_E= -1.04e-10  |g|= 7.72e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3557074581712  E_coul = 201.646083189541
  HOMO = -0.575668912077965  LUMO = 1.01603412547868
  mo_energy =
[-1.18576891e+02 -1.23048781e+01 -9.55764518e+00 -9.55764518e+00
 -9.55764518e+00 -1.25005913e+00 -5.75668912e-01 -5.75668912e-01
 -5.75668912e-01  1.01603413e+00  1.01603413e+00  1.01603413e+00
  7.23265114e+00  7.23265114e+00  7.23265114e+00  9.96985799e+00
  3.31184642e+01  3.31184642e+01  3.31184642e+01  1.16169165e+02
  1.27714514e+02  1.27714514e+02  1.27714514e+02  4.78835356e+02
  4.78835356e+02  4.78835356e+02  6.53329305e+02  1.32397761e+03
  1.32397761e+03  1.32397761e+03  2.79263782e+03  3.00970567e+03
  3.00970567e+03  3.00970567e+03  6.62473200e+03  6.62473200e+03
  6.62473200e+03  9.21076443e+03  2.55571481e+04  7.62874289e+04]
E1 = -728.3557455221935  E_coul = 201.64612125355833
Extra cycle  E= -526.709624268635  delta_E= -4.89e-12  |g|= 2.28e-06  |ddm|= 3.93e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 92260.52874543626
E1 = -728.3557455221935  E_coul = 201.64612125355833
init E= -526.709624268635
    CPU time for initialize scf      3.86 sec, wall time      0.22 sec
  HOMO = -0.575668215748481  LUMO = 1.01603463810927
  mo_energy =
[-1.18576886e+02 -1.23048753e+01 -9.55764229e+00 -9.55764229e+00
 -9.55764229e+00 -1.25005826e+00 -5.75668216e-01 -5.75668216e-01
 -5.75668216e-01  1.01603464e+00  1.01603464e+00  1.01603464e+00
  7.23265291e+00  7.23265291e+00  7.23265291e+00  9.96986024e+00
  3.31184671e+01  3.31184671e+01  3.31184671e+01  1.16169169e+02
  1.27714518e+02  1.27714518e+02  1.27714518e+02  4.78835360e+02
  4.78835360e+02  4.78835360e+02  6.53329310e+02  1.32397762e+03
  1.32397762e+03  1.32397762e+03  2.79263782e+03  3.00970567e+03
  3.00970567e+03  3.00970567e+03  6.62473200e+03  6.62473200e+03
  6.62473200e+03  9.21076444e+03  2.55571481e+04  7.62874289e+04]
E1 = -728.3557364773674  E_coul = 201.6461122087333
cycle= 1 E= -526.709624268634  delta_E= 1.02e-12  |g|= 5.85e-07  |ddm|= 8.99e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3557364773674  E_coul = 201.6461122087333
  HOMO = -0.575668369684274  LUMO = 1.01603452415247
  mo_energy =
[-1.18576888e+02 -1.23048760e+01 -9.55764298e+00 -9.55764298e+00
 -9.55764298e+00 -1.25005845e+00 -5.75668370e-01 -5.75668370e-01
 -5.75668370e-01  1.01603452e+00  1.01603452e+00  1.01603452e+00
  7.23265250e+00  7.23265250e+00  7.23265250e+00  9.96985972e+00
  3.31184664e+01  3.31184664e+01  3.31184664e+01  1.16169168e+02
  1.27714517e+02  1.27714517e+02  1.27714517e+02  4.78835359e+02
  4.78835359e+02  4.78835359e+02  6.53329309e+02  1.32397761e+03
  1.32397761e+03  1.32397761e+03  2.79263782e+03  3.00970567e+03
  3.00970567e+03  3.00970567e+03  6.62473200e+03  6.62473200e+03
  6.62473200e+03  9.21076444e+03  2.55571481e+04  7.62874289e+04]
E1 = -728.3557386812447  E_coul = 201.64611441261144
Extra cycle  E= -526.709624268633  delta_E= 9.09e-13  |g|= 1.47e-07  |ddm|= 2.11e-07
    CPU time for scf_cycle      4.20 sec, wall time      0.56 sec
exp = [2.61828723e+04 7.61704213e+03 3.61756680e+03 1.58738821e+03
 4.15528970e+02 1.21174760e+02 3.88750455e+01 8.05732325e+00
 3.16034019e+00 3.98566245e-01 1.36285774e+03 6.64060003e+02
 2.97745421e+02 3.11273521e+02 6.10831033e+01 7.28153193e+00
 2.00708463e+01 7.71396644e-01 2.79852442e+00 2.22680502e-01]
grad_E = [-1.40334691e-06  2.20999824e-06 -2.13571577e-06  3.83624329e-05
  1.38506401e-05  5.04499577e-06 -3.82159939e-06 -1.01837330e-05
  1.10240025e-05  8.50111551e-05 -5.08686641e-07  5.16565288e-06
  2.47046620e-05  2.11469307e-05 -3.09510870e-05 -5.78449931e-05
  2.50857606e-06  1.49657715e-04  1.07430389e-04 -4.57393705e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:02:46 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8716551        1
[INPUT] 0    0    [1    /1   ]  7617.04334971        1
[INPUT] 0    0    [1    /1   ]  3617.5660361         1
[INPUT] 0    0    [1    /1   ]  1587.41279007        1
[INPUT] 0    0    [1    /1   ]  415.476618911        1
[INPUT] 0    0    [1    /1   ]  121.159746741        1
[INPUT] 0    0    [1    /1   ]  38.8710835772        1
[INPUT] 0    0    [1    /1   ]  8.05568405994        1
[INPUT] 0    0    [1    /1   ]  3.15990452082        1
[INPUT] 0    0    [1    /1   ]  0.398570333103       1
[INPUT] 1    0    [1    /1   ]  1362.85749286        1
[INPUT] 1    0    [1    /1   ]  664.061740475        1
[INPUT] 1    0    [1    /1   ]  297.753320456        1
[INPUT] 1    0    [1    /1   ]  311.280295293        1
[INPUT] 1    0    [1    /1   ]  61.1141708019        1
[INPUT] 1    0    [1    /1   ]  7.28643811608        1
[INPUT] 1    0    [1    /1   ]  20.0833088619        1
[INPUT] 1    0    [1    /1   ]  0.771650860844       1
[INPUT] 1    0    [1    /1   ]  2.80075678576        1
[INPUT] 1    0    [1    /1   ]  0.222723954612       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.871655134724, 1.0]], [0, [7617.043349711043, 1.0]], [0, [3617.566036095055, 1.0]], [0, [1587.4127900746969, 1.0]], [0, [415.47661891127876, 1.0]], [0, [121.15974674073475, 1.0]], [0, [38.871083577176904, 1.0]], [0, [8.055684059943648, 1.0]], [0, [3.159904520815956, 1.0]], [0, [0.39857033310302603, 1.0]], [1, [1362.8574928593798, 1.0]], [1, [664.0617404750043, 1.0]], [1, [297.7533204563066, 1.0]], [1, [311.2802952927909, 1.0]], [1, [61.114170801865406, 1.0]], [1, [7.286438116081985, 1.0]], [1, [20.08330886190565, 1.0]], [1, [0.7716508608439373, 1.0]], [1, [2.800756785760547, 1.0]], [1, [0.22272395461224462, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87165513]
bas 1, expnt(s) = [7617.04334971]
bas 2, expnt(s) = [3617.5660361]
bas 3, expnt(s) = [1587.41279007]
bas 4, expnt(s) = [415.47661891]
bas 5, expnt(s) = [121.15974674]
bas 6, expnt(s) = [38.87108358]
bas 7, expnt(s) = [8.05568406]
bas 8, expnt(s) = [3.15990452]
bas 9, expnt(s) = [0.39857033]
bas 10, expnt(s) = [1362.85749286]
bas 11, expnt(s) = [664.06174048]
bas 12, expnt(s) = [297.75332046]
bas 13, expnt(s) = [311.28029529]
bas 14, expnt(s) = [61.1141708]
bas 15, expnt(s) = [7.28643812]
bas 16, expnt(s) = [20.08330886]
bas 17, expnt(s) = [0.77165086]
bas 18, expnt(s) = [2.80075679]
bas 19, expnt(s) = [0.22272395]
CPU time:      1843.15
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828717e+04 5.20029501e+03 7.61704335e+03 2.05994130e+03
 3.61756604e+03 1.17849400e+03 1.58741279e+03 6.35378376e+02
 4.15476619e+02 2.32501075e+02 1.21159747e+02 9.22643214e+01
 3.88710836e+01 3.93310019e+01 8.05568406e+00 1.20806929e+01
 3.15990452e+00 5.98784424e+00 3.98570333e-01 1.26734178e+00
 1.36285749e+03 2.41572476e+04 6.64061740e+02 9.83433429e+03
 2.97753320e+02 3.60832094e+03 3.11280295e+02 3.81437976e+03
 6.11141708e+01 4.98496137e+02 7.28643812e+00 3.49243630e+01
 2.00833089e+01 1.24030495e+02 7.71650861e-01 2.10989309e+00
 2.80075679e+00 1.05700889e+01 2.22723955e-01 4.46368001e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98298643567312
cond(S) = 92332.11467675584
E1 = -729.3789549957736  E_coul = 203.1218229128368
init E= -526.257132082937
    CPU time for initialize scf      0.63 sec, wall time      0.05 sec
  HOMO = -0.55698058344432  LUMO = 1.02801556663786
  mo_energy =
[-1.18335070e+02 -1.22077989e+01 -9.45156968e+00 -9.45156968e+00
 -9.45156968e+00 -1.22604259e+00 -5.56980583e-01 -5.56980583e-01
 -5.56980583e-01  1.02801557e+00  1.02801557e+00  1.02801557e+00
  7.29850836e+00  7.29850836e+00  7.29850836e+00  1.00366229e+01
  3.32578278e+01  3.32578278e+01  3.32578278e+01  1.16317851e+02
  1.27974760e+02  1.27974760e+02  1.27974760e+02  4.79231443e+02
  4.79231443e+02  4.79231443e+02  6.53518564e+02  1.32445475e+03
  1.32445475e+03  1.32445475e+03  2.79286774e+03  3.01026605e+03
  3.01026605e+03  3.01026605e+03  6.62540651e+03  6.62540651e+03
  6.62540651e+03  9.21109980e+03  2.55575988e+04  7.62879900e+04]
E1 = -727.983386188884  E_coul = 201.27438678583437
cycle= 1 E= -526.70899940305  delta_E= -0.452  |g|= 0.183  |ddm|= 0.402
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.537894
diis-c [-0.28932979  1.        ]
  HOMO = -0.581467798859033  LUMO = 1.0120550522139
  mo_energy =
[-1.18627888e+02 -1.23316391e+01 -9.58542638e+00 -9.58542638e+00
 -9.58542638e+00 -1.25748029e+00 -5.81467799e-01 -5.81467799e-01
 -5.81467799e-01  1.01205505e+00  1.01205505e+00  1.01205505e+00
  7.22300211e+00  7.22300211e+00  7.22300211e+00  9.94532496e+00
  3.31188099e+01  3.31188099e+01  3.31188099e+01  1.16103776e+02
  1.27762006e+02  1.27762006e+02  1.27762006e+02  4.78940660e+02
  4.78940660e+02  4.78940660e+02  6.53181178e+02  1.32410834e+03
  1.32410834e+03  1.32410834e+03  2.79238668e+03  3.00985402e+03
  3.00985402e+03  3.00985402e+03  6.62488246e+03  6.62488246e+03
  6.62488246e+03  9.21050222e+03  2.55569076e+04  7.62872089e+04]
E1 = -728.4464837895808  E_coul = 201.73689461383026
cycle= 2 E= -526.709589175751  delta_E= -0.00059  |g|= 0.0334  |ddm|= 0.0386
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0668036
diis-c [-0.00266827  0.07331831  0.92668169]
  HOMO = -0.574750662435912  LUMO = 1.01710337992875
  mo_energy =
[-1.18569294e+02 -1.23008438e+01 -9.55332897e+00 -9.55332897e+00
 -9.55332897e+00 -1.24895102e+00 -5.74750662e-01 -5.74750662e-01
 -5.74750662e-01  1.01710338e+00  1.01710338e+00  1.01710338e+00
  7.24138054e+00  7.24138054e+00  7.24138054e+00  9.96990633e+00
  3.31514218e+01  3.31514218e+01  3.31514218e+01  1.16152639e+02
  1.27809348e+02  1.27809348e+02  1.27809348e+02  4.78998448e+02
  4.78998448e+02  4.78998448e+02  6.53241770e+02  1.32416996e+03
  1.32416996e+03  1.32416996e+03  2.79245140e+03  3.00991773e+03
  3.00991773e+03  3.00991773e+03  6.62494773e+03  6.62494773e+03
  6.62494773e+03  9.21056820e+03  2.55569740e+04  7.62872756e+04]
E1 = -728.3416018817165  E_coul = 201.6319781015095
cycle= 3 E= -526.709623780207  delta_E= -3.46e-05  |g|= 0.00482  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104526
diis-c [-4.24491153e-07 -1.10463547e-03  1.30766857e-01  8.70337779e-01]
  HOMO = -0.575673667913686  LUMO = 1.01642049116428
  mo_energy =
[-1.18576856e+02 -1.23048875e+01 -9.55764333e+00 -9.55764333e+00
 -9.55764333e+00 -1.25007175e+00 -5.75673668e-01 -5.75673668e-01
 -5.75673668e-01  1.01642049e+00  1.01642049e+00  1.01642049e+00
  7.23888514e+00  7.23888514e+00  7.23888514e+00  9.96676425e+00
  3.31470681e+01  3.31470681e+01  3.31470681e+01  1.16146338e+02
  1.27803183e+02  1.27803183e+02  1.27803183e+02  4.78990989e+02
  4.78990989e+02  4.78990989e+02  6.53233916e+02  1.32416198e+03
  1.32416198e+03  1.32416198e+03  2.79244284e+03  3.00990940e+03
  3.00990940e+03  3.00990940e+03  6.62493906e+03  6.62493906e+03
  6.62493906e+03  9.21055933e+03  2.55569650e+04  7.62872665e+04]
E1 = -728.3558120934698  E_coul = 201.64618747331727
cycle= 4 E= -526.709624620153  delta_E= -8.4e-07  |g|= 5.88e-05  |ddm|= 0.00131
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122184
diis-c [-1.31075665e-09  6.37793500e-05 -8.98024152e-03 -7.03973598e-02
  1.07931382e+00]
  HOMO = -0.575661842642754  LUMO = 1.01642922798901
  mo_energy =
[-1.18576861e+02 -1.23048591e+01 -9.55762640e+00 -9.55762640e+00
 -9.55762640e+00 -1.25005301e+00 -5.75661843e-01 -5.75661843e-01
 -5.75661843e-01  1.01642923e+00  1.01642923e+00  1.01642923e+00
  7.23890531e+00  7.23890531e+00  7.23890531e+00  9.96679908e+00
  3.31470838e+01  3.31470838e+01  3.31470838e+01  1.16146348e+02
  1.27803191e+02  1.27803191e+02  1.27803191e+02  4.78990986e+02
  4.78990986e+02  4.78990986e+02  6.53233903e+02  1.32416197e+03
  1.32416197e+03  1.32416197e+03  2.79244281e+03  3.00990938e+03
  3.00990938e+03  3.00990938e+03  6.62493902e+03  6.62493902e+03
  6.62493902e+03  9.21055929e+03  2.55569649e+04  7.62872664e+04]
E1 = -728.3558103551447  E_coul = 201.6461857348857
cycle= 5 E= -526.709624620259  delta_E= -1.07e-10  |g|= 7.72e-06  |ddm|= 2.33e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3558103551447  E_coul = 201.6461857348857
  HOMO = -0.575665278055848  LUMO = 1.0164267270544
  mo_energy =
[-1.18576878e+02 -1.23048712e+01 -9.55763909e+00 -9.55763909e+00
 -9.55763909e+00 -1.25005724e+00 -5.75665278e-01 -5.75665278e-01
 -5.75665278e-01  1.01642673e+00  1.01642673e+00  1.01642673e+00
  7.23889700e+00  7.23889700e+00  7.23889700e+00  9.96678917e+00
  3.31470713e+01  3.31470713e+01  3.31470713e+01  1.16146333e+02
  1.27803175e+02  1.27803175e+02  1.27803175e+02  4.78990969e+02
  4.78990969e+02  4.78990969e+02  6.53233886e+02  1.32416195e+03
  1.32416195e+03  1.32416195e+03  2.79244280e+03  3.00990936e+03
  3.00990936e+03  3.00990936e+03  6.62493900e+03  6.62493900e+03
  6.62493900e+03  9.21055927e+03  2.55569649e+04  7.62872664e+04]
E1 = -728.3558484253643  E_coul = 201.64622380510195
Extra cycle  E= -526.709624620262  delta_E= -3.3e-12  |g|= 2.28e-06  |ddm|= 3.93e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.22 sec
exp = [2.61828717e+04 7.61704335e+03 3.61756604e+03 1.58741279e+03
 4.15476619e+02 1.21159747e+02 3.88710836e+01 8.05568406e+00
 3.15990452e+00 3.98570333e-01 1.36285749e+03 6.64061740e+02
 2.97753320e+02 3.11280295e+02 6.11141708e+01 7.28643812e+00
 2.00833089e+01 7.71650861e-01 2.80075679e+00 2.22723955e-01]
E = -526.7096246202624
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:02:46 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8716551        1
[INPUT] 0    0    [1    /1   ]  7617.04334971        1
[INPUT] 0    0    [1    /1   ]  3617.5660361         1
[INPUT] 0    0    [1    /1   ]  1587.41279007        1
[INPUT] 0    0    [1    /1   ]  415.476618911        1
[INPUT] 0    0    [1    /1   ]  121.159746741        1
[INPUT] 0    0    [1    /1   ]  38.8710835772        1
[INPUT] 0    0    [1    /1   ]  8.05568405994        1
[INPUT] 0    0    [1    /1   ]  3.15990452082        1
[INPUT] 0    0    [1    /1   ]  0.398570333103       1
[INPUT] 1    0    [1    /1   ]  1362.85749286        1
[INPUT] 1    0    [1    /1   ]  664.061740475        1
[INPUT] 1    0    [1    /1   ]  297.753320456        1
[INPUT] 1    0    [1    /1   ]  311.280295293        1
[INPUT] 1    0    [1    /1   ]  61.1141708019        1
[INPUT] 1    0    [1    /1   ]  7.28643811608        1
[INPUT] 1    0    [1    /1   ]  20.0833088619        1
[INPUT] 1    0    [1    /1   ]  0.771650860844       1
[INPUT] 1    0    [1    /1   ]  2.80075678576        1
[INPUT] 1    0    [1    /1   ]  0.222723954612       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.871655134724, 1.0]], [0, [7617.043349711043, 1.0]], [0, [3617.566036095055, 1.0]], [0, [1587.4127900746969, 1.0]], [0, [415.47661891127876, 1.0]], [0, [121.15974674073475, 1.0]], [0, [38.871083577176904, 1.0]], [0, [8.055684059943648, 1.0]], [0, [3.159904520815956, 1.0]], [0, [0.39857033310302603, 1.0]], [1, [1362.8574928593798, 1.0]], [1, [664.0617404750043, 1.0]], [1, [297.7533204563066, 1.0]], [1, [311.2802952927909, 1.0]], [1, [61.114170801865406, 1.0]], [1, [7.286438116081985, 1.0]], [1, [20.08330886190565, 1.0]], [1, [0.7716508608439373, 1.0]], [1, [2.800756785760547, 1.0]], [1, [0.22272395461224462, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87165513]
bas 1, expnt(s) = [7617.04334971]
bas 2, expnt(s) = [3617.5660361]
bas 3, expnt(s) = [1587.41279007]
bas 4, expnt(s) = [415.47661891]
bas 5, expnt(s) = [121.15974674]
bas 6, expnt(s) = [38.87108358]
bas 7, expnt(s) = [8.05568406]
bas 8, expnt(s) = [3.15990452]
bas 9, expnt(s) = [0.39857033]
bas 10, expnt(s) = [1362.85749286]
bas 11, expnt(s) = [664.06174048]
bas 12, expnt(s) = [297.75332046]
bas 13, expnt(s) = [311.28029529]
bas 14, expnt(s) = [61.1141708]
bas 15, expnt(s) = [7.28643812]
bas 16, expnt(s) = [20.08330886]
bas 17, expnt(s) = [0.77165086]
bas 18, expnt(s) = [2.80075679]
bas 19, expnt(s) = [0.22272395]
CPU time:      1844.28
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828717e+04 5.20029501e+03 7.61704335e+03 2.05994130e+03
 3.61756604e+03 1.17849400e+03 1.58741279e+03 6.35378376e+02
 4.15476619e+02 2.32501075e+02 1.21159747e+02 9.22643214e+01
 3.88710836e+01 3.93310019e+01 8.05568406e+00 1.20806929e+01
 3.15990452e+00 5.98784424e+00 3.98570333e-01 1.26734178e+00
 1.36285749e+03 2.41572476e+04 6.64061740e+02 9.83433429e+03
 2.97753320e+02 3.60832094e+03 3.11280295e+02 3.81437976e+03
 6.11141708e+01 4.98496137e+02 7.28643812e+00 3.49243630e+01
 2.00833089e+01 1.24030495e+02 7.71650861e-01 2.10989309e+00
 2.80075679e+00 1.05700889e+01 2.22723955e-01 4.46368001e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98298643567312
cond(S) = 92332.11467675584
E1 = -729.3789549957736  E_coul = 203.1218229128368
init E= -526.257132082937
    CPU time for initialize scf      0.62 sec, wall time      0.05 sec
  HOMO = -0.55698058344432  LUMO = 1.02801556663786
  mo_energy =
[-1.18335070e+02 -1.22077989e+01 -9.45156968e+00 -9.45156968e+00
 -9.45156968e+00 -1.22604259e+00 -5.56980583e-01 -5.56980583e-01
 -5.56980583e-01  1.02801557e+00  1.02801557e+00  1.02801557e+00
  7.29850836e+00  7.29850836e+00  7.29850836e+00  1.00366229e+01
  3.32578278e+01  3.32578278e+01  3.32578278e+01  1.16317851e+02
  1.27974760e+02  1.27974760e+02  1.27974760e+02  4.79231443e+02
  4.79231443e+02  4.79231443e+02  6.53518564e+02  1.32445475e+03
  1.32445475e+03  1.32445475e+03  2.79286774e+03  3.01026605e+03
  3.01026605e+03  3.01026605e+03  6.62540651e+03  6.62540651e+03
  6.62540651e+03  9.21109980e+03  2.55575988e+04  7.62879900e+04]
E1 = -727.983386188884  E_coul = 201.27438678583437
cycle= 1 E= -526.70899940305  delta_E= -0.452  |g|= 0.183  |ddm|= 0.402
    CPU time for cycle= 1      0.04 sec, wall time      0.02 sec
diis-norm(errvec)=0.537894
diis-c [-0.28932979  1.        ]
  HOMO = -0.581467798859033  LUMO = 1.0120550522139
  mo_energy =
[-1.18627888e+02 -1.23316391e+01 -9.58542638e+00 -9.58542638e+00
 -9.58542638e+00 -1.25748029e+00 -5.81467799e-01 -5.81467799e-01
 -5.81467799e-01  1.01205505e+00  1.01205505e+00  1.01205505e+00
  7.22300211e+00  7.22300211e+00  7.22300211e+00  9.94532496e+00
  3.31188099e+01  3.31188099e+01  3.31188099e+01  1.16103776e+02
  1.27762006e+02  1.27762006e+02  1.27762006e+02  4.78940660e+02
  4.78940660e+02  4.78940660e+02  6.53181178e+02  1.32410834e+03
  1.32410834e+03  1.32410834e+03  2.79238668e+03  3.00985402e+03
  3.00985402e+03  3.00985402e+03  6.62488246e+03  6.62488246e+03
  6.62488246e+03  9.21050222e+03  2.55569076e+04  7.62872089e+04]
E1 = -728.4464837895808  E_coul = 201.73689461383026
cycle= 2 E= -526.709589175751  delta_E= -0.00059  |g|= 0.0334  |ddm|= 0.0386
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0668036
diis-c [-0.00266827  0.07331831  0.92668169]
  HOMO = -0.574750662435912  LUMO = 1.01710337992875
  mo_energy =
[-1.18569294e+02 -1.23008438e+01 -9.55332897e+00 -9.55332897e+00
 -9.55332897e+00 -1.24895102e+00 -5.74750662e-01 -5.74750662e-01
 -5.74750662e-01  1.01710338e+00  1.01710338e+00  1.01710338e+00
  7.24138054e+00  7.24138054e+00  7.24138054e+00  9.96990633e+00
  3.31514218e+01  3.31514218e+01  3.31514218e+01  1.16152639e+02
  1.27809348e+02  1.27809348e+02  1.27809348e+02  4.78998448e+02
  4.78998448e+02  4.78998448e+02  6.53241770e+02  1.32416996e+03
  1.32416996e+03  1.32416996e+03  2.79245140e+03  3.00991773e+03
  3.00991773e+03  3.00991773e+03  6.62494773e+03  6.62494773e+03
  6.62494773e+03  9.21056820e+03  2.55569740e+04  7.62872756e+04]
E1 = -728.3416018817165  E_coul = 201.6319781015095
cycle= 3 E= -526.709623780207  delta_E= -3.46e-05  |g|= 0.00482  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104526
diis-c [-4.24491153e-07 -1.10463547e-03  1.30766857e-01  8.70337779e-01]
  HOMO = -0.575673667913686  LUMO = 1.01642049116428
  mo_energy =
[-1.18576856e+02 -1.23048875e+01 -9.55764333e+00 -9.55764333e+00
 -9.55764333e+00 -1.25007175e+00 -5.75673668e-01 -5.75673668e-01
 -5.75673668e-01  1.01642049e+00  1.01642049e+00  1.01642049e+00
  7.23888514e+00  7.23888514e+00  7.23888514e+00  9.96676425e+00
  3.31470681e+01  3.31470681e+01  3.31470681e+01  1.16146338e+02
  1.27803183e+02  1.27803183e+02  1.27803183e+02  4.78990989e+02
  4.78990989e+02  4.78990989e+02  6.53233916e+02  1.32416198e+03
  1.32416198e+03  1.32416198e+03  2.79244284e+03  3.00990940e+03
  3.00990940e+03  3.00990940e+03  6.62493906e+03  6.62493906e+03
  6.62493906e+03  9.21055933e+03  2.55569650e+04  7.62872665e+04]
E1 = -728.3558120934698  E_coul = 201.64618747331727
cycle= 4 E= -526.709624620153  delta_E= -8.4e-07  |g|= 5.88e-05  |ddm|= 0.00131
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122184
diis-c [-1.31075665e-09  6.37793500e-05 -8.98024152e-03 -7.03973598e-02
  1.07931382e+00]
  HOMO = -0.575661842642754  LUMO = 1.01642922798901
  mo_energy =
[-1.18576861e+02 -1.23048591e+01 -9.55762640e+00 -9.55762640e+00
 -9.55762640e+00 -1.25005301e+00 -5.75661843e-01 -5.75661843e-01
 -5.75661843e-01  1.01642923e+00  1.01642923e+00  1.01642923e+00
  7.23890531e+00  7.23890531e+00  7.23890531e+00  9.96679908e+00
  3.31470838e+01  3.31470838e+01  3.31470838e+01  1.16146348e+02
  1.27803191e+02  1.27803191e+02  1.27803191e+02  4.78990986e+02
  4.78990986e+02  4.78990986e+02  6.53233903e+02  1.32416197e+03
  1.32416197e+03  1.32416197e+03  2.79244281e+03  3.00990938e+03
  3.00990938e+03  3.00990938e+03  6.62493902e+03  6.62493902e+03
  6.62493902e+03  9.21055929e+03  2.55569649e+04  7.62872664e+04]
E1 = -728.3558103551447  E_coul = 201.6461857348857
cycle= 5 E= -526.709624620259  delta_E= -1.07e-10  |g|= 7.72e-06  |ddm|= 2.33e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3558103551447  E_coul = 201.6461857348857
  HOMO = -0.575665278055848  LUMO = 1.0164267270544
  mo_energy =
[-1.18576878e+02 -1.23048712e+01 -9.55763909e+00 -9.55763909e+00
 -9.55763909e+00 -1.25005724e+00 -5.75665278e-01 -5.75665278e-01
 -5.75665278e-01  1.01642673e+00  1.01642673e+00  1.01642673e+00
  7.23889700e+00  7.23889700e+00  7.23889700e+00  9.96678917e+00
  3.31470713e+01  3.31470713e+01  3.31470713e+01  1.16146333e+02
  1.27803175e+02  1.27803175e+02  1.27803175e+02  4.78990969e+02
  4.78990969e+02  4.78990969e+02  6.53233886e+02  1.32416195e+03
  1.32416195e+03  1.32416195e+03  2.79244280e+03  3.00990936e+03
  3.00990936e+03  3.00990936e+03  6.62493900e+03  6.62493900e+03
  6.62493900e+03  9.21055927e+03  2.55569649e+04  7.62872664e+04]
E1 = -728.3558484253643  E_coul = 201.64622380510195
Extra cycle  E= -526.709624620262  delta_E= -3.3e-12  |g|= 2.28e-06  |ddm|= 3.93e-06
    CPU time for scf_cycle      0.82 sec, wall time      0.22 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 92332.11467675584
E1 = -728.3558484253643  E_coul = 201.64622380510195
init E= -526.709624620262
    CPU time for initialize scf      3.77 sec, wall time      0.20 sec
  HOMO = -0.575664581633658  LUMO = 1.01642723999412
  mo_energy =
[-1.18576873e+02 -1.23048684e+01 -9.55763621e+00 -9.55763621e+00
 -9.55763621e+00 -1.25005637e+00 -5.75664582e-01 -5.75664582e-01
 -5.75664582e-01  1.01642724e+00  1.01642724e+00  1.01642724e+00
  7.23889877e+00  7.23889877e+00  7.23889877e+00  9.96679142e+00
  3.31470742e+01  3.31470742e+01  3.31470742e+01  1.16146337e+02
  1.27803179e+02  1.27803179e+02  1.27803179e+02  4.78990973e+02
  4.78990973e+02  4.78990973e+02  6.53233891e+02  1.32416196e+03
  1.32416196e+03  1.32416196e+03  2.79244280e+03  3.00990936e+03
  3.00990936e+03  3.00990936e+03  6.62493901e+03  6.62493901e+03
  6.62493901e+03  9.21055928e+03  2.55569649e+04  7.62872664e+04]
E1 = -728.3558393791589  E_coul = 201.6462147588976
cycle= 1 E= -526.709624620261  delta_E= 1.14e-12  |g|= 5.85e-07  |ddm|= 8.99e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.3558393791589  E_coul = 201.6462147588976
  HOMO = -0.575664735587298  LUMO = 1.01642712596912
  mo_energy =
[-1.18576874e+02 -1.23048691e+01 -9.55763689e+00 -9.55763689e+00
 -9.55763689e+00 -1.25005656e+00 -5.75664736e-01 -5.75664736e-01
 -5.75664736e-01  1.01642713e+00  1.01642713e+00  1.01642713e+00
  7.23889836e+00  7.23889836e+00  7.23889836e+00  9.96679091e+00
  3.31470735e+01  3.31470735e+01  3.31470735e+01  1.16146336e+02
  1.27803178e+02  1.27803178e+02  1.27803178e+02  4.78990972e+02
  4.78990972e+02  4.78990972e+02  6.53233889e+02  1.32416196e+03
  1.32416196e+03  1.32416196e+03  2.79244280e+03  3.00990936e+03
  3.00990936e+03  3.00990936e+03  6.62493901e+03  6.62493901e+03
  6.62493901e+03  9.21055928e+03  2.55569649e+04  7.62872664e+04]
E1 = -728.3558415833522  E_coul = 201.6462169630901
Extra cycle  E= -526.709624620262  delta_E= -9.09e-13  |g|= 1.47e-07  |ddm|= 2.11e-07
    CPU time for scf_cycle      3.88 sec, wall time      0.32 sec
exp = [2.61828717e+04 7.61704335e+03 3.61756604e+03 1.58741279e+03
 4.15476619e+02 1.21159747e+02 3.88710836e+01 8.05568406e+00
 3.15990452e+00 3.98570333e-01 1.36285749e+03 6.64061740e+02
 2.97753320e+02 3.11280295e+02 6.11141708e+01 7.28643812e+00
 2.00833089e+01 7.71650861e-01 2.80075679e+00 2.22723955e-01]
grad_E = [-1.40358425e-06  2.21197904e-06 -2.13560649e-06  3.84210370e-05
  1.33740542e-05  6.19035069e-06 -7.78739382e-06 -1.91281306e-05
  2.30374799e-05  1.49034632e-04 -5.10000988e-07  5.14908087e-06
  2.46130793e-05  2.10676777e-05 -3.10279737e-05 -1.03826542e-04
  1.43249910e-05  2.62253599e-04  1.96245664e-04 -7.97682331e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:02:51 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8710253        1
[INPUT] 0    0    [1    /1   ]  7617.0447071         1
[INPUT] 0    0    [1    /1   ]  3617.56537374        1
[INPUT] 0    0    [1    /1   ]  1587.44186412        1
[INPUT] 0    0    [1    /1   ]  415.389536879        1
[INPUT] 0    0    [1    /1   ]  121.134959499        1
[INPUT] 0    0    [1    /1   ]  38.8645527617        1
[INPUT] 0    0    [1    /1   ]  8.05292098651        1
[INPUT] 0    0    [1    /1   ]  3.1591599797         1
[INPUT] 0    0    [1    /1   ]  0.398576966754       1
[INPUT] 1    0    [1    /1   ]  1362.85723607        1
[INPUT] 1    0    [1    /1   ]  664.063224303        1
[INPUT] 1    0    [1    /1   ]  297.759825056        1
[INPUT] 1    0    [1    /1   ]  311.285885038        1
[INPUT] 1    0    [1    /1   ]  61.1643233066        1
[INPUT] 1    0    [1    /1   ]  7.2943759195         1
[INPUT] 1    0    [1    /1   ]  20.1034887142        1
[INPUT] 1    0    [1    /1   ]  0.77206310311        1
[INPUT] 1    0    [1    /1   ]  2.80437519335        1
[INPUT] 1    0    [1    /1   ]  0.222794461603       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.87102527561, 1.0]], [0, [7617.044707099067, 1.0]], [0, [3617.5653737440057, 1.0]], [0, [1587.441864118626, 1.0]], [0, [415.389536879241, 1.0]], [0, [121.13495949940726, 1.0]], [0, [38.86455276167099, 1.0]], [0, [8.052920986505043, 1.0]], [0, [3.1591599797031344, 1.0]], [0, [0.39857696675383675, 1.0]], [1, [1362.8572360728704, 1.0]], [1, [664.0632243031203, 1.0]], [1, [297.7598250556961, 1.0]], [1, [311.28588503839137, 1.0]], [1, [61.164323306634714, 1.0]], [1, [7.294375919497167, 1.0]], [1, [20.103488714159525, 1.0]], [1, [0.7720631031101423, 1.0]], [1, [2.8043751933545518, 1.0]], [1, [0.22279446160299615, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87102528]
bas 1, expnt(s) = [7617.0447071]
bas 2, expnt(s) = [3617.56537374]
bas 3, expnt(s) = [1587.44186412]
bas 4, expnt(s) = [415.38953688]
bas 5, expnt(s) = [121.1349595]
bas 6, expnt(s) = [38.86455276]
bas 7, expnt(s) = [8.05292099]
bas 8, expnt(s) = [3.15915998]
bas 9, expnt(s) = [0.39857697]
bas 10, expnt(s) = [1362.85723607]
bas 11, expnt(s) = [664.0632243]
bas 12, expnt(s) = [297.75982506]
bas 13, expnt(s) = [311.28588504]
bas 14, expnt(s) = [61.16432331]
bas 15, expnt(s) = [7.29437592]
bas 16, expnt(s) = [20.10348871]
bas 17, expnt(s) = [0.7720631]
bas 18, expnt(s) = [2.80437519]
bas 19, expnt(s) = [0.22279446]
CPU time:      1854.21
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828710e+04 5.20029492e+03 7.61704471e+03 2.05994157e+03
 3.61756537e+03 1.17849384e+03 1.58744186e+03 6.35387104e+02
 4.15389537e+02 2.32464526e+02 1.21134959e+02 9.22501642e+01
 3.88645528e+01 3.93260457e+01 8.05292099e+00 1.20775850e+01
 3.15915998e+00 5.98678606e+00 3.98576967e-01 1.26735760e+00
 1.36285724e+03 2.41572419e+04 6.64063224e+02 9.83436176e+03
 2.97759825e+02 3.60841948e+03 3.11285885e+02 3.81446538e+03
 6.11643233e+01 4.99007544e+02 7.29437592e+00 3.49719275e+01
 2.01034887e+01 1.24186298e+02 7.72063103e-01 2.11130215e+00
 2.80437519e+00 1.05871615e+01 2.22794462e-01 4.46544640e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98297347645933
cond(S) = 92428.66736295786
E1 = -729.3790773905106  E_coul = 203.1219136099448
init E= -526.257163780566
    CPU time for initialize scf      1.80 sec, wall time      0.10 sec
  HOMO = -0.55697506149478  LUMO = 1.02866350560081
  mo_energy =
[-1.18335059e+02 -1.22077963e+01 -9.45156588e+00 -9.45156588e+00
 -9.45156588e+00 -1.22603954e+00 -5.56975061e-01 -5.56975061e-01
 -5.56975061e-01  1.02866351e+00  1.02866351e+00  1.02866351e+00
  7.30868868e+00  7.30868868e+00  7.30868868e+00  1.00314033e+01
  3.33041973e+01  3.33041973e+01  3.33041973e+01  1.16279794e+02
  1.28118078e+02  1.28118078e+02  1.28118078e+02  4.79478664e+02
  4.79478664e+02  4.79478664e+02  6.53360069e+02  1.32473583e+03
  1.32473583e+03  1.32473583e+03  2.79253676e+03  3.01056185e+03
  3.01056185e+03  3.01056185e+03  6.62569690e+03  6.62569690e+03
  6.62569690e+03  9.21073469e+03  2.55572570e+04  7.62876783e+04]
E1 = -727.9835851062063  E_coul = 201.27458472129769
cycle= 1 E= -526.709000384909  delta_E= -0.452  |g|= 0.183  |ddm|= 0.402
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.537937
diis-c [-0.28937653  1.        ]
  HOMO = -0.5814610968339  LUMO = 1.01268933380562
  mo_energy =
[-1.18627863e+02 -1.23316258e+01 -9.58541426e+00 -9.58541426e+00
 -9.58541426e+00 -1.25747598e+00 -5.81461097e-01 -5.81461097e-01
 -5.81461097e-01  1.01268933e+00  1.01268933e+00  1.01268933e+00
  7.23311555e+00  7.23311555e+00  7.23311555e+00  9.94013545e+00
  3.31651216e+01  3.31651216e+01  3.31651216e+01  1.16065751e+02
  1.27905288e+02  1.27905288e+02  1.27905288e+02  4.79187894e+02
  4.79187894e+02  4.79187894e+02  6.53022714e+02  1.32438945e+03
  1.32438945e+03  1.32438945e+03  2.79205571e+03  3.01014984e+03
  3.01014984e+03  3.01014984e+03  6.62517287e+03  6.62517287e+03
  6.62517287e+03  9.21013711e+03  2.55565658e+04  7.62868973e+04]
E1 = -728.4466385960606  E_coul = 201.73704848414587
cycle= 2 E= -526.709590111915  delta_E= -0.00059  |g|= 0.0334  |ddm|= 0.0386
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0668072
diis-c [-0.00266827  0.07332177  0.92667823]
  HOMO = -0.574745045901348  LUMO = 1.01774077199381
  mo_energy =
[-1.18569274e+02 -1.23008336e+01 -9.55331988e+00 -9.55331988e+00
 -9.55331988e+00 -1.24894803e+00 -5.74745046e-01 -5.74745046e-01
 -5.74745046e-01  1.01774077e+00  1.01774077e+00  1.01774077e+00
  7.25150749e+00  7.25150749e+00  7.25150749e+00  9.96470886e+00
  3.31977451e+01  3.31977451e+01  3.31977451e+01  1.16114607e+02
  1.27952634e+02  1.27952634e+02  1.27952634e+02  4.79245677e+02
  4.79245677e+02  4.79245677e+02  6.53083301e+02  1.32445106e+03
  1.32445106e+03  1.32445106e+03  2.79212042e+03  3.01021354e+03
  3.01021354e+03  3.01021354e+03  6.62523814e+03  6.62523814e+03
  6.62523814e+03  9.21020309e+03  2.55566322e+04  7.62869640e+04]
E1 = -728.3417687964471  E_coul = 201.63214408487693
cycle= 3 E= -526.70962471157  delta_E= -3.46e-05  |g|= 0.00482  |ddm|= 0.0101
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0104527
diis-c [-4.24781865e-07 -1.10478946e-03  1.30759767e-01  8.70345022e-01]
  HOMO = -0.575667887748472  LUMO = 1.01705747666521
  mo_energy =
[-1.18576835e+02 -1.23048767e+01 -9.55763365e+00 -9.55763365e+00
 -9.55763365e+00 -1.25006854e+00 -5.75667888e-01 -5.75667888e-01
 -5.75667888e-01  1.01705748e+00  1.01705748e+00  1.01705748e+00
  7.24901034e+00  7.24901034e+00  7.24901034e+00  9.96156798e+00
  3.31933901e+01  3.31933901e+01  3.31933901e+01  1.16108308e+02
  1.27946469e+02  1.27946469e+02  1.27946469e+02  4.79238220e+02
  4.79238220e+02  4.79238220e+02  6.53075448e+02  1.32444309e+03
  1.32444309e+03  1.32444309e+03  2.79211187e+03  3.01020522e+03
  3.01020522e+03  3.01020522e+03  6.62522946e+03  6.62522946e+03
  6.62522946e+03  9.21019422e+03  2.55566232e+04  7.62869548e+04]
E1 = -728.3559767920689  E_coul = 201.64635124076003
cycle= 4 E= -526.709625551309  delta_E= -8.4e-07  |g|= 5.88e-05  |ddm|= 0.00131
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00012222
diis-c [-1.31041216e-09  6.37878189e-05 -8.98069375e-03 -7.04072256e-02
  1.07932413e+00]
  HOMO = -0.575656058697236  LUMO = 1.01706622192724
  mo_energy =
[-1.18576840e+02 -1.23048483e+01 -9.55761671e+00 -9.55761671e+00
 -9.55761671e+00 -1.25004979e+00 -5.75656059e-01 -5.75656059e-01
 -5.75656059e-01  1.01706622e+00  1.01706622e+00  1.01706622e+00
  7.24903051e+00  7.24903051e+00  7.24903051e+00  9.96160282e+00
  3.31934059e+01  3.31934059e+01  3.31934059e+01  1.16108317e+02
  1.27946477e+02  1.27946477e+02  1.27946477e+02  4.79238216e+02
  4.79238216e+02  4.79238216e+02  6.53075436e+02  1.32444307e+03
  1.32444307e+03  1.32444307e+03  2.79211184e+03  3.01020519e+03
  3.01020519e+03  3.01020519e+03  6.62522943e+03  6.62522943e+03
  6.62522943e+03  9.21019418e+03  2.55566231e+04  7.62869548e+04]
E1 = -728.3559750375298  E_coul = 201.64634948611277
cycle= 5 E= -526.709625551417  delta_E= -1.08e-10  |g|= 7.73e-06  |ddm|= 2.33e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3559750375298  E_coul = 201.64634948611277
  HOMO = -0.575659494930567  LUMO = 1.01706371853555
  mo_energy =
[-1.18576857e+02 -1.23048604e+01 -9.55762941e+00 -9.55762941e+00
 -9.55762941e+00 -1.25005402e+00 -5.75659495e-01 -5.75659495e-01
 -5.75659495e-01  1.01706372e+00  1.01706372e+00  1.01706372e+00
  7.24902219e+00  7.24902219e+00  7.24902219e+00  9.96159291e+00
  3.31933934e+01  3.31933934e+01  3.31933934e+01  1.16108302e+02
  1.27946462e+02  1.27946462e+02  1.27946462e+02  4.79238199e+02
  4.79238199e+02  4.79238199e+02  6.53075418e+02  1.32444305e+03
  1.32444305e+03  1.32444305e+03  2.79211182e+03  3.01020517e+03
  3.01020517e+03  3.01020517e+03  6.62522941e+03  6.62522941e+03
  6.62522941e+03  9.21019416e+03  2.55566231e+04  7.62869547e+04]
E1 = -728.3560131187862  E_coul = 201.646387567368
Extra cycle  E= -526.709625551418  delta_E= -1.14e-12  |g|= 2.28e-06  |ddm|= 3.93e-06
    CPU time for scf_cycle      2.03 sec, wall time      0.33 sec
exp = [2.61828710e+04 7.61704471e+03 3.61756537e+03 1.58744186e+03
 4.15389537e+02 1.21134959e+02 3.88645528e+01 8.05292099e+00
 3.15915998e+00 3.98576967e-01 1.36285724e+03 6.64063224e+02
 2.97759825e+02 3.11285885e+02 6.11643233e+01 7.29437592e+00
 2.01034887e+01 7.72063103e-01 2.80437519e+00 2.22794462e-01]
E = -526.7096255514182
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:02:52 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8710253        1
[INPUT] 0    0    [1    /1   ]  7617.0447071         1
[INPUT] 0    0    [1    /1   ]  3617.56537374        1
[INPUT] 0    0    [1    /1   ]  1587.44186412        1
[INPUT] 0    0    [1    /1   ]  415.389536879        1
[INPUT] 0    0    [1    /1   ]  121.134959499        1
[INPUT] 0    0    [1    /1   ]  38.8645527617        1
[INPUT] 0    0    [1    /1   ]  8.05292098651        1
[INPUT] 0    0    [1    /1   ]  3.1591599797         1
[INPUT] 0    0    [1    /1   ]  0.398576966754       1
[INPUT] 1    0    [1    /1   ]  1362.85723607        1
[INPUT] 1    0    [1    /1   ]  664.063224303        1
[INPUT] 1    0    [1    /1   ]  297.759825056        1
[INPUT] 1    0    [1    /1   ]  311.285885038        1
[INPUT] 1    0    [1    /1   ]  61.1643233066        1
[INPUT] 1    0    [1    /1   ]  7.2943759195         1
[INPUT] 1    0    [1    /1   ]  20.1034887142        1
[INPUT] 1    0    [1    /1   ]  0.77206310311        1
[INPUT] 1    0    [1    /1   ]  2.80437519335        1
[INPUT] 1    0    [1    /1   ]  0.222794461603       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.87102527561, 1.0]], [0, [7617.044707099067, 1.0]], [0, [3617.5653737440057, 1.0]], [0, [1587.441864118626, 1.0]], [0, [415.389536879241, 1.0]], [0, [121.13495949940726, 1.0]], [0, [38.86455276167099, 1.0]], [0, [8.052920986505043, 1.0]], [0, [3.1591599797031344, 1.0]], [0, [0.39857696675383675, 1.0]], [1, [1362.8572360728704, 1.0]], [1, [664.0632243031203, 1.0]], [1, [297.7598250556961, 1.0]], [1, [311.28588503839137, 1.0]], [1, [61.164323306634714, 1.0]], [1, [7.294375919497167, 1.0]], [1, [20.103488714159525, 1.0]], [1, [0.7720631031101423, 1.0]], [1, [2.8043751933545518, 1.0]], [1, [0.22279446160299615, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87102528]
bas 1, expnt(s) = [7617.0447071]
bas 2, expnt(s) = [3617.56537374]
bas 3, expnt(s) = [1587.44186412]
bas 4, expnt(s) = [415.38953688]
bas 5, expnt(s) = [121.1349595]
bas 6, expnt(s) = [38.86455276]
bas 7, expnt(s) = [8.05292099]
bas 8, expnt(s) = [3.15915998]
bas 9, expnt(s) = [0.39857697]
bas 10, expnt(s) = [1362.85723607]
bas 11, expnt(s) = [664.0632243]
bas 12, expnt(s) = [297.75982506]
bas 13, expnt(s) = [311.28588504]
bas 14, expnt(s) = [61.16432331]
bas 15, expnt(s) = [7.29437592]
bas 16, expnt(s) = [20.10348871]
bas 17, expnt(s) = [0.7720631]
bas 18, expnt(s) = [2.80437519]
bas 19, expnt(s) = [0.22279446]
CPU time:      1856.75
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828710e+04 5.20029492e+03 7.61704471e+03 2.05994157e+03
 3.61756537e+03 1.17849384e+03 1.58744186e+03 6.35387104e+02
 4.15389537e+02 2.32464526e+02 1.21134959e+02 9.22501642e+01
 3.88645528e+01 3.93260457e+01 8.05292099e+00 1.20775850e+01
 3.15915998e+00 5.98678606e+00 3.98576967e-01 1.26735760e+00
 1.36285724e+03 2.41572419e+04 6.64063224e+02 9.83436176e+03
 2.97759825e+02 3.60841948e+03 3.11285885e+02 3.81446538e+03
 6.11643233e+01 4.99007544e+02 7.29437592e+00 3.49719275e+01
 2.01034887e+01 1.24186298e+02 7.72063103e-01 2.11130215e+00
 2.80437519e+00 1.05871615e+01 2.22794462e-01 4.46544640e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98297347645933
cond(S) = 92428.66736295786
E1 = -729.3790773905106  E_coul = 203.1219136099448
init E= -526.257163780566
    CPU time for initialize scf      0.67 sec, wall time      0.05 sec
  HOMO = -0.55697506149478  LUMO = 1.02866350560081
  mo_energy =
[-1.18335059e+02 -1.22077963e+01 -9.45156588e+00 -9.45156588e+00
 -9.45156588e+00 -1.22603954e+00 -5.56975061e-01 -5.56975061e-01
 -5.56975061e-01  1.02866351e+00  1.02866351e+00  1.02866351e+00
  7.30868868e+00  7.30868868e+00  7.30868868e+00  1.00314033e+01
  3.33041973e+01  3.33041973e+01  3.33041973e+01  1.16279794e+02
  1.28118078e+02  1.28118078e+02  1.28118078e+02  4.79478664e+02
  4.79478664e+02  4.79478664e+02  6.53360069e+02  1.32473583e+03
  1.32473583e+03  1.32473583e+03  2.79253676e+03  3.01056185e+03
  3.01056185e+03  3.01056185e+03  6.62569690e+03  6.62569690e+03
  6.62569690e+03  9.21073469e+03  2.55572570e+04  7.62876783e+04]
E1 = -727.9835851062063  E_coul = 201.27458472129769
cycle= 1 E= -526.709000384909  delta_E= -0.452  |g|= 0.183  |ddm|= 0.402
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.537937
diis-c [-0.28937653  1.        ]
  HOMO = -0.5814610968339  LUMO = 1.01268933380562
  mo_energy =
[-1.18627863e+02 -1.23316258e+01 -9.58541426e+00 -9.58541426e+00
 -9.58541426e+00 -1.25747598e+00 -5.81461097e-01 -5.81461097e-01
 -5.81461097e-01  1.01268933e+00  1.01268933e+00  1.01268933e+00
  7.23311555e+00  7.23311555e+00  7.23311555e+00  9.94013545e+00
  3.31651216e+01  3.31651216e+01  3.31651216e+01  1.16065751e+02
  1.27905288e+02  1.27905288e+02  1.27905288e+02  4.79187894e+02
  4.79187894e+02  4.79187894e+02  6.53022714e+02  1.32438945e+03
  1.32438945e+03  1.32438945e+03  2.79205571e+03  3.01014984e+03
  3.01014984e+03  3.01014984e+03  6.62517287e+03  6.62517287e+03
  6.62517287e+03  9.21013711e+03  2.55565658e+04  7.62868973e+04]
E1 = -728.4466385960606  E_coul = 201.73704848414587
cycle= 2 E= -526.709590111915  delta_E= -0.00059  |g|= 0.0334  |ddm|= 0.0386
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0668072
diis-c [-0.00266827  0.07332177  0.92667823]
  HOMO = -0.574745045901348  LUMO = 1.01774077199381
  mo_energy =
[-1.18569274e+02 -1.23008336e+01 -9.55331988e+00 -9.55331988e+00
 -9.55331988e+00 -1.24894803e+00 -5.74745046e-01 -5.74745046e-01
 -5.74745046e-01  1.01774077e+00  1.01774077e+00  1.01774077e+00
  7.25150749e+00  7.25150749e+00  7.25150749e+00  9.96470886e+00
  3.31977451e+01  3.31977451e+01  3.31977451e+01  1.16114607e+02
  1.27952634e+02  1.27952634e+02  1.27952634e+02  4.79245677e+02
  4.79245677e+02  4.79245677e+02  6.53083301e+02  1.32445106e+03
  1.32445106e+03  1.32445106e+03  2.79212042e+03  3.01021354e+03
  3.01021354e+03  3.01021354e+03  6.62523814e+03  6.62523814e+03
  6.62523814e+03  9.21020309e+03  2.55566322e+04  7.62869640e+04]
E1 = -728.3417687964471  E_coul = 201.63214408487693
cycle= 3 E= -526.70962471157  delta_E= -3.46e-05  |g|= 0.00482  |ddm|= 0.0101
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0104527
diis-c [-4.24781865e-07 -1.10478946e-03  1.30759767e-01  8.70345022e-01]
  HOMO = -0.575667887748472  LUMO = 1.01705747666521
  mo_energy =
[-1.18576835e+02 -1.23048767e+01 -9.55763365e+00 -9.55763365e+00
 -9.55763365e+00 -1.25006854e+00 -5.75667888e-01 -5.75667888e-01
 -5.75667888e-01  1.01705748e+00  1.01705748e+00  1.01705748e+00
  7.24901034e+00  7.24901034e+00  7.24901034e+00  9.96156798e+00
  3.31933901e+01  3.31933901e+01  3.31933901e+01  1.16108308e+02
  1.27946469e+02  1.27946469e+02  1.27946469e+02  4.79238220e+02
  4.79238220e+02  4.79238220e+02  6.53075448e+02  1.32444309e+03
  1.32444309e+03  1.32444309e+03  2.79211187e+03  3.01020522e+03
  3.01020522e+03  3.01020522e+03  6.62522946e+03  6.62522946e+03
  6.62522946e+03  9.21019422e+03  2.55566232e+04  7.62869548e+04]
E1 = -728.3559767920689  E_coul = 201.64635124076003
cycle= 4 E= -526.709625551309  delta_E= -8.4e-07  |g|= 5.88e-05  |ddm|= 0.00131
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00012222
diis-c [-1.31041216e-09  6.37878189e-05 -8.98069375e-03 -7.04072256e-02
  1.07932413e+00]
  HOMO = -0.575656058697236  LUMO = 1.01706622192724
  mo_energy =
[-1.18576840e+02 -1.23048483e+01 -9.55761671e+00 -9.55761671e+00
 -9.55761671e+00 -1.25004979e+00 -5.75656059e-01 -5.75656059e-01
 -5.75656059e-01  1.01706622e+00  1.01706622e+00  1.01706622e+00
  7.24903051e+00  7.24903051e+00  7.24903051e+00  9.96160282e+00
  3.31934059e+01  3.31934059e+01  3.31934059e+01  1.16108317e+02
  1.27946477e+02  1.27946477e+02  1.27946477e+02  4.79238216e+02
  4.79238216e+02  4.79238216e+02  6.53075436e+02  1.32444307e+03
  1.32444307e+03  1.32444307e+03  2.79211184e+03  3.01020519e+03
  3.01020519e+03  3.01020519e+03  6.62522943e+03  6.62522943e+03
  6.62522943e+03  9.21019418e+03  2.55566231e+04  7.62869548e+04]
E1 = -728.3559750375298  E_coul = 201.64634948611277
cycle= 5 E= -526.709625551417  delta_E= -1.08e-10  |g|= 7.73e-06  |ddm|= 2.33e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3559750375298  E_coul = 201.64634948611277
  HOMO = -0.575659494930567  LUMO = 1.01706371853555
  mo_energy =
[-1.18576857e+02 -1.23048604e+01 -9.55762941e+00 -9.55762941e+00
 -9.55762941e+00 -1.25005402e+00 -5.75659495e-01 -5.75659495e-01
 -5.75659495e-01  1.01706372e+00  1.01706372e+00  1.01706372e+00
  7.24902219e+00  7.24902219e+00  7.24902219e+00  9.96159291e+00
  3.31933934e+01  3.31933934e+01  3.31933934e+01  1.16108302e+02
  1.27946462e+02  1.27946462e+02  1.27946462e+02  4.79238199e+02
  4.79238199e+02  4.79238199e+02  6.53075418e+02  1.32444305e+03
  1.32444305e+03  1.32444305e+03  2.79211182e+03  3.01020517e+03
  3.01020517e+03  3.01020517e+03  6.62522941e+03  6.62522941e+03
  6.62522941e+03  9.21019416e+03  2.55566231e+04  7.62869547e+04]
E1 = -728.3560131187862  E_coul = 201.646387567368
Extra cycle  E= -526.709625551418  delta_E= -1.14e-12  |g|= 2.28e-06  |ddm|= 3.93e-06
    CPU time for scf_cycle      0.90 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 92428.66736295786
E1 = -728.3560131187862  E_coul = 201.646387567368
init E= -526.709625551418
    CPU time for initialize scf      4.16 sec, wall time      0.27 sec
  HOMO = -0.575658798336547  LUMO = 1.01706423198856
  mo_energy =
[-1.18576852e+02 -1.23048576e+01 -9.55762653e+00 -9.55762653e+00
 -9.55762653e+00 -1.25005315e+00 -5.75658798e-01 -5.75658798e-01
 -5.75658798e-01  1.01706423e+00  1.01706423e+00  1.01706423e+00
  7.24902397e+00  7.24902397e+00  7.24902397e+00  9.96159517e+00
  3.31933963e+01  3.31933963e+01  3.31933963e+01  1.16108306e+02
  1.27946465e+02  1.27946465e+02  1.27946465e+02  4.79238204e+02
  4.79238204e+02  4.79238204e+02  6.53075423e+02  1.32444306e+03
  1.32444306e+03  1.32444306e+03  2.79211182e+03  3.01020518e+03
  3.01020518e+03  3.01020518e+03  6.62522941e+03  6.62522941e+03
  6.62522941e+03  9.21019417e+03  2.55566231e+04  7.62869547e+04]
E1 = -728.3560040700726  E_coul = 201.6463785186536
cycle= 1 E= -526.709625551419  delta_E= -7.96e-13  |g|= 5.86e-07  |ddm|= 8.99e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3560040700726  E_coul = 201.6463785186536
  HOMO = -0.575658952327787  LUMO = 1.01706411784842
  mo_energy =
[-1.18576853e+02 -1.23048582e+01 -9.55762721e+00 -9.55762721e+00
 -9.55762721e+00 -1.25005334e+00 -5.75658952e-01 -5.75658952e-01
 -5.75658952e-01  1.01706412e+00  1.01706412e+00  1.01706412e+00
  7.24902356e+00  7.24902356e+00  7.24902356e+00  9.96159465e+00
  3.31933956e+01  3.31933956e+01  3.31933956e+01  1.16108305e+02
  1.27946464e+02  1.27946464e+02  1.27946464e+02  4.79238202e+02
  4.79238202e+02  4.79238202e+02  6.53075422e+02  1.32444306e+03
  1.32444306e+03  1.32444306e+03  2.79211182e+03  3.01020518e+03
  3.01020518e+03  3.01020518e+03  6.62522941e+03  6.62522941e+03
  6.62522941e+03  9.21019417e+03  2.55566231e+04  7.62869547e+04]
E1 = -728.3560062748529  E_coul = 201.64638072343314
Extra cycle  E= -526.70962555142  delta_E= -7.96e-13  |g|= 1.47e-07  |ddm|= 2.11e-07
    CPU time for scf_cycle      4.30 sec, wall time      0.41 sec
exp = [2.61828710e+04 7.61704471e+03 3.61756537e+03 1.58744186e+03
 4.15389537e+02 1.21134959e+02 3.88645528e+01 8.05292099e+00
 3.15915998e+00 3.98576967e-01 1.36285724e+03 6.64063224e+02
 2.97759825e+02 3.11285885e+02 6.11643233e+01 7.29437592e+00
 2.01034887e+01 7.72063103e-01 2.80437519e+00 2.22794462e-01]
grad_E = [-1.40396832e-06  2.21518671e-06 -2.13549730e-06  3.85171017e-05
  1.25937129e-05  8.05858724e-06 -1.41635948e-05 -3.35526212e-05
  4.02424736e-05  2.52073045e-04 -5.12158802e-07  5.12216688e-06
  2.44648645e-05  2.09390794e-05 -3.11871967e-05 -1.80116593e-04
  3.39396966e-05  4.46576089e-04  3.42818489e-04 -1.35318623e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:02:56 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8710353        1
[INPUT] 0    0    [1    /1   ]  7617.04525573        1
[INPUT] 0    0    [1    /1   ]  3617.56584646        1
[INPUT] 0    0    [1    /1   ]  1587.45992033        1
[INPUT] 0    0    [1    /1   ]  415.245145529        1
[INPUT] 0    0    [1    /1   ]  121.094217157        1
[INPUT] 0    0    [1    /1   ]  38.8538325395        1
[INPUT] 0    0    [1    /1   ]  8.04844540726        1
[INPUT] 0    0    [1    /1   ]  3.15796332118        1
[INPUT] 0    0    [1    /1   ]  0.398588009026       1
[INPUT] 1    0    [1    /1   ]  1362.8572096         1
[INPUT] 1    0    [1    /1   ]  664.062094481        1
[INPUT] 1    0    [1    /1   ]  297.753662996        1
[INPUT] 1    0    [1    /1   ]  311.280650482        1
[INPUT] 1    0    [1    /1   ]  61.2437054554        1
[INPUT] 1    0    [1    /1   ]  7.30698874611        1
[INPUT] 1    0    [1    /1   ]  20.1355796421        1
[INPUT] 1    0    [1    /1   ]  0.772717813488       1
[INPUT] 1    0    [1    /1   ]  2.81012919742        1
[INPUT] 1    0    [1    /1   ]  0.222905632717       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.871035271535, 1.0]], [0, [7617.045255733466, 1.0]], [0, [3617.5658464596268, 1.0]], [0, [1587.4599203328562, 1.0]], [0, [415.2451455293114, 1.0]], [0, [121.09421715660477, 1.0]], [0, [38.8538325395399, 1.0]], [0, [8.048445407259326, 1.0]], [0, [3.157963321176064, 1.0]], [0, [0.398588009025673, 1.0]], [1, [1362.8572095997467, 1.0]], [1, [664.0620944809901, 1.0]], [1, [297.75366299589496, 1.0]], [1, [311.2806504821727, 1.0]], [1, [61.2437054554359, 1.0]], [1, [7.3069887461095115, 1.0]], [1, [20.135579642084593, 1.0]], [1, [0.7727178134878973, 1.0]], [1, [2.8101291974236715, 1.0]], [1, [0.22290563271683017, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87103527]
bas 1, expnt(s) = [7617.04525573]
bas 2, expnt(s) = [3617.56584646]
bas 3, expnt(s) = [1587.45992033]
bas 4, expnt(s) = [415.24514553]
bas 5, expnt(s) = [121.09421716]
bas 6, expnt(s) = [38.85383254]
bas 7, expnt(s) = [8.04844541]
bas 8, expnt(s) = [3.15796332]
bas 9, expnt(s) = [0.39858801]
bas 10, expnt(s) = [1362.8572096]
bas 11, expnt(s) = [664.06209448]
bas 12, expnt(s) = [297.753663]
bas 13, expnt(s) = [311.28065048]
bas 14, expnt(s) = [61.24370546]
bas 15, expnt(s) = [7.30698875]
bas 16, expnt(s) = [20.13557964]
bas 17, expnt(s) = [0.77271781]
bas 18, expnt(s) = [2.8101292]
bas 19, expnt(s) = [0.22290563]
CPU time:      1866.64
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828710e+04 5.20029492e+03 7.61704526e+03 2.05994169e+03
 3.61756585e+03 1.17849395e+03 1.58745992e+03 6.35392525e+02
 4.15245146e+02 2.32403919e+02 1.21094217e+02 9.22268928e+01
 3.88538325e+01 3.93179098e+01 8.04844541e+00 1.20725504e+01
 3.15796332e+00 5.98508518e+00 3.98588009e-01 1.26738393e+00
 1.36285721e+03 2.41572413e+04 6.64062094e+02 9.83434084e+03
 2.97753663e+02 3.60832613e+03 3.11280650e+02 3.81438521e+03
 6.12437055e+01 4.99817222e+02 7.30698875e+00 3.50475320e+01
 2.01355796e+01 1.24434143e+02 7.72717813e-01 2.11354037e+00
 2.81012920e+00 1.06143218e+01 2.22905633e-01 4.46823181e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98295286853658
cond(S) = 92531.32843868308
E1 = -729.3792796374426  E_coul = 203.12206280058376
init E= -526.257216836859
    CPU time for initialize scf      7.56 sec, wall time      0.35 sec
  HOMO = -0.556966170819251  LUMO = 1.02969011322279
  mo_energy =
[-1.18335040e+02 -1.22077918e+01 -9.45155941e+00 -9.45155941e+00
 -9.45155941e+00 -1.22603470e+00 -5.56966171e-01 -5.56966171e-01
 -5.56966171e-01  1.02969011e+00  1.02969011e+00  1.02969011e+00
  7.32487993e+00  7.32487993e+00  7.32487993e+00  1.00229736e+01
  3.33779049e+01  3.33779049e+01  3.33779049e+01  1.16217624e+02
  1.28345267e+02  1.28345267e+02  1.28345267e+02  4.79859416e+02
  4.79859416e+02  4.79859416e+02  6.53098567e+02  1.32513727e+03
  1.32513727e+03  1.32513727e+03  2.79197156e+03  3.01094305e+03
  3.01094305e+03  3.01094305e+03  6.62604121e+03  6.62604121e+03
  6.62604121e+03  9.21006875e+03  2.55565957e+04  7.62870562e+04]
E1 = -727.9839053327805  E_coul = 201.27490243343914
cycle= 1 E= -526.709002899341  delta_E= -0.452  |g|= 0.183  |ddm|= 0.402
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.538008
diis-c [-0.28945222  1.        ]
  HOMO = -0.581450761953164  LUMO = 1.01369396375783
  mo_energy =
[-1.18627824e+02 -1.23316041e+01 -9.58539440e+00 -9.58539440e+00
 -9.58539440e+00 -1.25746971e+00 -5.81450762e-01 -5.81450762e-01
 -5.81450762e-01  1.01369396e+00  1.01369396e+00  1.01369396e+00
  7.24920021e+00  7.24920021e+00  7.24920021e+00  9.93175397e+00
  3.32387377e+01  3.32387377e+01  3.32387377e+01  1.16003631e+02
  1.28132421e+02  1.28132421e+02  1.28132421e+02  4.79568672e+02
  4.79568672e+02  4.79568672e+02  6.52761264e+02  1.32479091e+03
  1.32479091e+03  1.32479091e+03  2.79149054e+03  3.01053106e+03
  3.01053106e+03  3.01053106e+03  6.62551719e+03  6.62551719e+03
  6.62551719e+03  9.20947118e+03  2.55559044e+04  7.62862751e+04]
E1 = -728.4468888414239  E_coul = 201.73729629066258
cycle= 2 E= -526.709592550761  delta_E= -0.00059  |g|= 0.0334  |ddm|= 0.0387
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0668132
diis-c [-0.00266828  0.07332772  0.92667228]
  HOMO = -0.574736431995848  LUMO = 1.01875033760046
  mo_energy =
[-1.18569242e+02 -1.23008169e+01 -9.55330485e+00 -9.55330485e+00
 -9.55330485e+00 -1.24894386e+00 -5.74736432e-01 -5.74736432e-01
 -5.74736432e-01  1.01875034e+00  1.01875034e+00  1.01875034e+00
  7.26761361e+00  7.26761361e+00  7.26761361e+00  9.95631456e+00
  3.32713797e+01  3.32713797e+01  3.32713797e+01  1.16052477e+02
  1.28179774e+02  1.28179774e+02  1.28179774e+02  4.79626448e+02
  4.79626448e+02  4.79626448e+02  6.52821842e+02  1.32485252e+03
  1.32485252e+03  1.32485252e+03  2.79155524e+03  3.01059476e+03
  3.01059476e+03  3.01059476e+03  6.62558245e+03  6.62558245e+03
  6.62558245e+03  9.20953715e+03  2.55559709e+04  7.62863418e+04]
E1 = -728.3420378973918  E_coul = 201.63241075449594
cycle= 3 E= -526.709627142896  delta_E= -3.46e-05  |g|= 0.00482  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104528
diis-c [-4.25238341e-07 -1.10503592e-03  1.30748401e-01  8.70356635e-01]
  HOMO = -0.575659020358436  LUMO = 1.01806639277551
  mo_energy =
[-1.18576802e+02 -1.23048590e+01 -9.55761768e+00 -9.55761768e+00
 -9.55761768e+00 -1.25006403e+00 -5.75659020e-01 -5.75659020e-01
 -5.75659020e-01  1.01806639e+00  1.01806639e+00  1.01806639e+00
  7.26511368e+00  7.26511368e+00  7.26511368e+00  9.95317561e+00
  3.32670227e+01  3.32670227e+01  3.32670227e+01  1.16046180e+02
  1.28173609e+02  1.28173609e+02  1.28173609e+02  4.79618992e+02
  4.79618992e+02  4.79618992e+02  6.52813990e+02  1.32484454e+03
  1.32484454e+03  1.32484454e+03  2.79154669e+03  3.01058643e+03
  3.01058643e+03  3.01058643e+03  6.62557378e+03  6.62557378e+03
  6.62557378e+03  9.20952828e+03  2.55559618e+04  7.62863327e+04]
E1 = -728.3562424384675  E_coul = 201.64661445615624
cycle= 4 E= -526.709627982311  delta_E= -8.39e-07  |g|= 5.88e-05  |ddm|= 0.00131
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122275
diis-c [-1.30989694e-09  6.37995362e-05 -8.98119395e-03 -7.04211125e-02
  1.07933851e+00]
  HOMO = -0.575647184932798  LUMO = 1.01807515170435
  mo_energy =
[-1.18576806e+02 -1.23048305e+01 -9.55760073e+00 -9.55760073e+00
 -9.55760073e+00 -1.25004527e+00 -5.75647185e-01 -5.75647185e-01
 -5.75647185e-01  1.01807515e+00  1.01807515e+00  1.01807515e+00
  7.26513387e+00  7.26513387e+00  7.26513387e+00  9.95321048e+00
  3.32670385e+01  3.32670385e+01  3.32670385e+01  1.16046189e+02
  1.28173616e+02  1.28173616e+02  1.28173616e+02  4.79618988e+02
  4.79618988e+02  4.79618988e+02  6.52813978e+02  1.32484453e+03
  1.32484453e+03  1.32484453e+03  2.79154666e+03  3.01058641e+03
  3.01058641e+03  3.01058641e+03  6.62557374e+03  6.62557374e+03
  6.62557374e+03  9.20952824e+03  2.55559618e+04  7.62863326e+04]
E1 = -728.3562406510493  E_coul = 201.64661266863396
cycle= 5 E= -526.709627982415  delta_E= -1.04e-10  |g|= 7.73e-06  |ddm|= 2.33e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3562406510493  E_coul = 201.64661266863396
  HOMO = -0.575650622546478  LUMO = 1.01807264435298
  mo_energy =
[-1.18576823e+02 -1.23048426e+01 -9.55761343e+00 -9.55761343e+00
 -9.55761343e+00 -1.25004950e+00 -5.75650623e-01 -5.75650623e-01
 -5.75650623e-01  1.01807264e+00  1.01807264e+00  1.01807264e+00
  7.26512554e+00  7.26512554e+00  7.26512554e+00  9.95320057e+00
  3.32670260e+01  3.32670260e+01  3.32670260e+01  1.16046174e+02
  1.28173601e+02  1.28173601e+02  1.28173601e+02  4.79618971e+02
  4.79618971e+02  4.79618971e+02  6.52813960e+02  1.32484451e+03
  1.32484451e+03  1.32484451e+03  2.79154664e+03  3.01058639e+03
  3.01058639e+03  3.01058639e+03  6.62557372e+03  6.62557372e+03
  6.62557372e+03  9.20952822e+03  2.55559618e+04  7.62863326e+04]
E1 = -728.3562787510178  E_coul = 201.64665076859802
Extra cycle  E= -526.70962798242  delta_E= -4.32e-12  |g|= 2.28e-06  |ddm|= 3.94e-06
    CPU time for scf_cycle      7.76 sec, wall time      0.53 sec
exp = [2.61828710e+04 7.61704526e+03 3.61756585e+03 1.58745992e+03
 4.15245146e+02 1.21094217e+02 3.88538325e+01 8.04844541e+00
 3.15796332e+00 3.98588009e-01 1.36285721e+03 6.64062094e+02
 2.97753663e+02 3.11280650e+02 6.12437055e+01 7.30698875e+00
 2.01355796e+01 7.72717813e-01 2.81012920e+00 2.22905633e-01]
E = -526.7096279824198
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:02:57 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8710353        1
[INPUT] 0    0    [1    /1   ]  7617.04525573        1
[INPUT] 0    0    [1    /1   ]  3617.56584646        1
[INPUT] 0    0    [1    /1   ]  1587.45992033        1
[INPUT] 0    0    [1    /1   ]  415.245145529        1
[INPUT] 0    0    [1    /1   ]  121.094217157        1
[INPUT] 0    0    [1    /1   ]  38.8538325395        1
[INPUT] 0    0    [1    /1   ]  8.04844540726        1
[INPUT] 0    0    [1    /1   ]  3.15796332118        1
[INPUT] 0    0    [1    /1   ]  0.398588009026       1
[INPUT] 1    0    [1    /1   ]  1362.8572096         1
[INPUT] 1    0    [1    /1   ]  664.062094481        1
[INPUT] 1    0    [1    /1   ]  297.753662996        1
[INPUT] 1    0    [1    /1   ]  311.280650482        1
[INPUT] 1    0    [1    /1   ]  61.2437054554        1
[INPUT] 1    0    [1    /1   ]  7.30698874611        1
[INPUT] 1    0    [1    /1   ]  20.1355796421        1
[INPUT] 1    0    [1    /1   ]  0.772717813488       1
[INPUT] 1    0    [1    /1   ]  2.81012919742        1
[INPUT] 1    0    [1    /1   ]  0.222905632717       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.871035271535, 1.0]], [0, [7617.045255733466, 1.0]], [0, [3617.5658464596268, 1.0]], [0, [1587.4599203328562, 1.0]], [0, [415.2451455293114, 1.0]], [0, [121.09421715660477, 1.0]], [0, [38.8538325395399, 1.0]], [0, [8.048445407259326, 1.0]], [0, [3.157963321176064, 1.0]], [0, [0.398588009025673, 1.0]], [1, [1362.8572095997467, 1.0]], [1, [664.0620944809901, 1.0]], [1, [297.75366299589496, 1.0]], [1, [311.2806504821727, 1.0]], [1, [61.2437054554359, 1.0]], [1, [7.3069887461095115, 1.0]], [1, [20.135579642084593, 1.0]], [1, [0.7727178134878973, 1.0]], [1, [2.8101291974236715, 1.0]], [1, [0.22290563271683017, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87103527]
bas 1, expnt(s) = [7617.04525573]
bas 2, expnt(s) = [3617.56584646]
bas 3, expnt(s) = [1587.45992033]
bas 4, expnt(s) = [415.24514553]
bas 5, expnt(s) = [121.09421716]
bas 6, expnt(s) = [38.85383254]
bas 7, expnt(s) = [8.04844541]
bas 8, expnt(s) = [3.15796332]
bas 9, expnt(s) = [0.39858801]
bas 10, expnt(s) = [1362.8572096]
bas 11, expnt(s) = [664.06209448]
bas 12, expnt(s) = [297.753663]
bas 13, expnt(s) = [311.28065048]
bas 14, expnt(s) = [61.24370546]
bas 15, expnt(s) = [7.30698875]
bas 16, expnt(s) = [20.13557964]
bas 17, expnt(s) = [0.77271781]
bas 18, expnt(s) = [2.8101292]
bas 19, expnt(s) = [0.22290563]
CPU time:      1874.72
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828710e+04 5.20029492e+03 7.61704526e+03 2.05994169e+03
 3.61756585e+03 1.17849395e+03 1.58745992e+03 6.35392525e+02
 4.15245146e+02 2.32403919e+02 1.21094217e+02 9.22268928e+01
 3.88538325e+01 3.93179098e+01 8.04844541e+00 1.20725504e+01
 3.15796332e+00 5.98508518e+00 3.98588009e-01 1.26738393e+00
 1.36285721e+03 2.41572413e+04 6.64062094e+02 9.83434084e+03
 2.97753663e+02 3.60832613e+03 3.11280650e+02 3.81438521e+03
 6.12437055e+01 4.99817222e+02 7.30698875e+00 3.50475320e+01
 2.01355796e+01 1.24434143e+02 7.72717813e-01 2.11354037e+00
 2.81012920e+00 1.06143218e+01 2.22905633e-01 4.46823181e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98295286853658
cond(S) = 92531.32843868308
E1 = -729.3792796374426  E_coul = 203.12206280058376
init E= -526.257216836859
    CPU time for initialize scf      7.45 sec, wall time      0.35 sec
  HOMO = -0.556966170819251  LUMO = 1.02969011322279
  mo_energy =
[-1.18335040e+02 -1.22077918e+01 -9.45155941e+00 -9.45155941e+00
 -9.45155941e+00 -1.22603470e+00 -5.56966171e-01 -5.56966171e-01
 -5.56966171e-01  1.02969011e+00  1.02969011e+00  1.02969011e+00
  7.32487993e+00  7.32487993e+00  7.32487993e+00  1.00229736e+01
  3.33779049e+01  3.33779049e+01  3.33779049e+01  1.16217624e+02
  1.28345267e+02  1.28345267e+02  1.28345267e+02  4.79859416e+02
  4.79859416e+02  4.79859416e+02  6.53098567e+02  1.32513727e+03
  1.32513727e+03  1.32513727e+03  2.79197156e+03  3.01094305e+03
  3.01094305e+03  3.01094305e+03  6.62604121e+03  6.62604121e+03
  6.62604121e+03  9.21006875e+03  2.55565957e+04  7.62870562e+04]
E1 = -727.9839053327805  E_coul = 201.27490243343914
cycle= 1 E= -526.709002899341  delta_E= -0.452  |g|= 0.183  |ddm|= 0.402
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.538008
diis-c [-0.28945222  1.        ]
  HOMO = -0.581450761953164  LUMO = 1.01369396375783
  mo_energy =
[-1.18627824e+02 -1.23316041e+01 -9.58539440e+00 -9.58539440e+00
 -9.58539440e+00 -1.25746971e+00 -5.81450762e-01 -5.81450762e-01
 -5.81450762e-01  1.01369396e+00  1.01369396e+00  1.01369396e+00
  7.24920021e+00  7.24920021e+00  7.24920021e+00  9.93175397e+00
  3.32387377e+01  3.32387377e+01  3.32387377e+01  1.16003631e+02
  1.28132421e+02  1.28132421e+02  1.28132421e+02  4.79568672e+02
  4.79568672e+02  4.79568672e+02  6.52761264e+02  1.32479091e+03
  1.32479091e+03  1.32479091e+03  2.79149054e+03  3.01053106e+03
  3.01053106e+03  3.01053106e+03  6.62551719e+03  6.62551719e+03
  6.62551719e+03  9.20947118e+03  2.55559044e+04  7.62862751e+04]
E1 = -728.4468888414239  E_coul = 201.73729629066258
cycle= 2 E= -526.709592550761  delta_E= -0.00059  |g|= 0.0334  |ddm|= 0.0387
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0668132
diis-c [-0.00266828  0.07332772  0.92667228]
  HOMO = -0.574736431995848  LUMO = 1.01875033760046
  mo_energy =
[-1.18569242e+02 -1.23008169e+01 -9.55330485e+00 -9.55330485e+00
 -9.55330485e+00 -1.24894386e+00 -5.74736432e-01 -5.74736432e-01
 -5.74736432e-01  1.01875034e+00  1.01875034e+00  1.01875034e+00
  7.26761361e+00  7.26761361e+00  7.26761361e+00  9.95631456e+00
  3.32713797e+01  3.32713797e+01  3.32713797e+01  1.16052477e+02
  1.28179774e+02  1.28179774e+02  1.28179774e+02  4.79626448e+02
  4.79626448e+02  4.79626448e+02  6.52821842e+02  1.32485252e+03
  1.32485252e+03  1.32485252e+03  2.79155524e+03  3.01059476e+03
  3.01059476e+03  3.01059476e+03  6.62558245e+03  6.62558245e+03
  6.62558245e+03  9.20953715e+03  2.55559709e+04  7.62863418e+04]
E1 = -728.3420378973918  E_coul = 201.63241075449594
cycle= 3 E= -526.709627142896  delta_E= -3.46e-05  |g|= 0.00482  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104528
diis-c [-4.25238341e-07 -1.10503592e-03  1.30748401e-01  8.70356635e-01]
  HOMO = -0.575659020358436  LUMO = 1.01806639277551
  mo_energy =
[-1.18576802e+02 -1.23048590e+01 -9.55761768e+00 -9.55761768e+00
 -9.55761768e+00 -1.25006403e+00 -5.75659020e-01 -5.75659020e-01
 -5.75659020e-01  1.01806639e+00  1.01806639e+00  1.01806639e+00
  7.26511368e+00  7.26511368e+00  7.26511368e+00  9.95317561e+00
  3.32670227e+01  3.32670227e+01  3.32670227e+01  1.16046180e+02
  1.28173609e+02  1.28173609e+02  1.28173609e+02  4.79618992e+02
  4.79618992e+02  4.79618992e+02  6.52813990e+02  1.32484454e+03
  1.32484454e+03  1.32484454e+03  2.79154669e+03  3.01058643e+03
  3.01058643e+03  3.01058643e+03  6.62557378e+03  6.62557378e+03
  6.62557378e+03  9.20952828e+03  2.55559618e+04  7.62863327e+04]
E1 = -728.3562424384675  E_coul = 201.64661445615624
cycle= 4 E= -526.709627982311  delta_E= -8.39e-07  |g|= 5.88e-05  |ddm|= 0.00131
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122275
diis-c [-1.30989694e-09  6.37995362e-05 -8.98119395e-03 -7.04211125e-02
  1.07933851e+00]
  HOMO = -0.575647184932798  LUMO = 1.01807515170435
  mo_energy =
[-1.18576806e+02 -1.23048305e+01 -9.55760073e+00 -9.55760073e+00
 -9.55760073e+00 -1.25004527e+00 -5.75647185e-01 -5.75647185e-01
 -5.75647185e-01  1.01807515e+00  1.01807515e+00  1.01807515e+00
  7.26513387e+00  7.26513387e+00  7.26513387e+00  9.95321048e+00
  3.32670385e+01  3.32670385e+01  3.32670385e+01  1.16046189e+02
  1.28173616e+02  1.28173616e+02  1.28173616e+02  4.79618988e+02
  4.79618988e+02  4.79618988e+02  6.52813978e+02  1.32484453e+03
  1.32484453e+03  1.32484453e+03  2.79154666e+03  3.01058641e+03
  3.01058641e+03  3.01058641e+03  6.62557374e+03  6.62557374e+03
  6.62557374e+03  9.20952824e+03  2.55559618e+04  7.62863326e+04]
E1 = -728.3562406510493  E_coul = 201.64661266863396
cycle= 5 E= -526.709627982415  delta_E= -1.04e-10  |g|= 7.73e-06  |ddm|= 2.33e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3562406510493  E_coul = 201.64661266863396
  HOMO = -0.575650622546478  LUMO = 1.01807264435298
  mo_energy =
[-1.18576823e+02 -1.23048426e+01 -9.55761343e+00 -9.55761343e+00
 -9.55761343e+00 -1.25004950e+00 -5.75650623e-01 -5.75650623e-01
 -5.75650623e-01  1.01807264e+00  1.01807264e+00  1.01807264e+00
  7.26512554e+00  7.26512554e+00  7.26512554e+00  9.95320057e+00
  3.32670260e+01  3.32670260e+01  3.32670260e+01  1.16046174e+02
  1.28173601e+02  1.28173601e+02  1.28173601e+02  4.79618971e+02
  4.79618971e+02  4.79618971e+02  6.52813960e+02  1.32484451e+03
  1.32484451e+03  1.32484451e+03  2.79154664e+03  3.01058639e+03
  3.01058639e+03  3.01058639e+03  6.62557372e+03  6.62557372e+03
  6.62557372e+03  9.20952822e+03  2.55559618e+04  7.62863326e+04]
E1 = -728.3562787510178  E_coul = 201.64665076859802
Extra cycle  E= -526.70962798242  delta_E= -4.32e-12  |g|= 2.28e-06  |ddm|= 3.94e-06
    CPU time for scf_cycle      7.65 sec, wall time      0.53 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 92531.32843868308
E1 = -728.3562787510178  E_coul = 201.64665076859802
init E= -526.70962798242
    CPU time for initialize scf     15.92 sec, wall time      0.75 sec
  HOMO = -0.575649925656717  LUMO = 1.01807315863939
  mo_energy =
[-1.18576819e+02 -1.23048399e+01 -9.55761054e+00 -9.55761054e+00
 -9.55761054e+00 -1.25004863e+00 -5.75649926e-01 -5.75649926e-01
 -5.75649926e-01  1.01807316e+00  1.01807316e+00  1.01807316e+00
  7.26512731e+00  7.26512731e+00  7.26512731e+00  9.95320282e+00
  3.32670289e+01  3.32670289e+01  3.32670289e+01  1.16046178e+02
  1.28173605e+02  1.28173605e+02  1.28173605e+02  4.79618976e+02
  4.79618976e+02  4.79618976e+02  6.52813965e+02  1.32484452e+03
  1.32484452e+03  1.32484452e+03  2.79154664e+03  3.01058640e+03
  3.01058640e+03  3.01058640e+03  6.62557373e+03  6.62557373e+03
  6.62557373e+03  9.20952823e+03  2.55559618e+04  7.62863326e+04]
E1 = -728.35626969803  E_coul = 201.64664171561014
cycle= 1 E= -526.70962798242  delta_E= -1.14e-13  |g|= 5.86e-07  |ddm|= 9e-07
    CPU time for cycle= 1      0.04 sec, wall time      0.02 sec
E1 = -728.35626969803  E_coul = 201.64664171561014
  HOMO = -0.57565007971162  LUMO = 1.01807304431262
  mo_energy =
[-1.18576820e+02 -1.23048405e+01 -9.55761123e+00 -9.55761123e+00
 -9.55761123e+00 -1.25004882e+00 -5.75650080e-01 -5.75650080e-01
 -5.75650080e-01  1.01807304e+00  1.01807304e+00  1.01807304e+00
  7.26512691e+00  7.26512691e+00  7.26512691e+00  9.95320230e+00
  3.32670282e+01  3.32670282e+01  3.32670282e+01  1.16046177e+02
  1.28173604e+02  1.28173604e+02  1.28173604e+02  4.79618975e+02
  4.79618975e+02  4.79618975e+02  6.52813964e+02  1.32484451e+03
  1.32484451e+03  1.32484451e+03  2.79154664e+03  3.01058640e+03
  3.01058640e+03  3.01058640e+03  6.62557373e+03  6.62557373e+03
  6.62557373e+03  9.20952822e+03  2.55559618e+04  7.62863326e+04]
E1 = -728.3562719038005  E_coul = 201.64664392137925
Extra cycle  E= -526.709627982421  delta_E= -1.36e-12  |g|= 1.47e-07  |ddm|= 2.11e-07
    CPU time for scf_cycle     16.05 sec, wall time      0.87 sec
exp = [2.61828710e+04 7.61704526e+03 3.61756585e+03 1.58745992e+03
 4.15245146e+02 1.21094217e+02 3.88538325e+01 8.04844541e+00
 3.15796332e+00 3.98588009e-01 1.36285721e+03 6.64062094e+02
 2.97753663e+02 3.11280650e+02 6.12437055e+01 7.30698875e+00
 2.01355796e+01 7.72717813e-01 2.81012920e+00 2.22905633e-01]
grad_E = [-1.40457761e-06  2.22028092e-06 -2.13550376e-06  3.86727450e-05
  1.13291768e-05  1.11499746e-05 -2.47869795e-05 -5.77183158e-05
  7.13135559e-05  4.23605751e-04 -5.15675622e-07  5.07904113e-06
  2.42286313e-05  2.07332496e-05 -3.14598898e-05 -3.03977893e-04
  6.57722467e-05  7.46902820e-04  5.80210668e-04 -2.26296347e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:03:02 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8737347        1
[INPUT] 0    0    [1    /1   ]  7617.04185546        1
[INPUT] 0    0    [1    /1   ]  3617.57064457        1
[INPUT] 0    0    [1    /1   ]  1587.41381816        1
[INPUT] 0    0    [1    /1   ]  415.000341415        1
[INPUT] 0    0    [1    /1   ]  121.026212879        1
[INPUT] 0    0    [1    /1   ]  38.8360708565        1
[INPUT] 0    0    [1    /1   ]  8.04108746844        1
[INPUT] 0    0    [1    /1   ]  3.15597920483        1
[INPUT] 0    0    [1    /1   ]  0.398606000177       1
[INPUT] 1    0    [1    /1   ]  1362.85818029        1
[INPUT] 1    0    [1    /1   ]  664.05104063         1
[INPUT] 1    0    [1    /1   ]  297.700074529        1
[INPUT] 1    0    [1    /1   ]  311.234856877        1
[INPUT] 1    0    [1    /1   ]  61.369086064         1
[INPUT] 1    0    [1    /1   ]  7.32705572649        1
[INPUT] 1    0    [1    /1   ]  20.1866866079        1
[INPUT] 1    0    [1    /1   ]  0.77376050247        1
[INPUT] 1    0    [1    /1   ]  2.81928812499        1
[INPUT] 1    0    [1    /1   ]  0.22308224102        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.873734702913, 1.0]], [0, [7617.041855455067, 1.0]], [0, [3617.5706445684054, 1.0]], [0, [1587.413818160465, 1.0]], [0, [415.0003414148151, 1.0]], [0, [121.02621287895933, 1.0]], [0, [38.836070856454306, 1.0]], [0, [8.041087468444683, 1.0]], [0, [3.1559792048257074, 1.0]], [0, [0.3986060001768464, 1.0]], [1, [1362.8581802918266, 1.0]], [1, [664.0510406298063, 1.0]], [1, [297.7000745289396, 1.0]], [1, [311.2348568772051, 1.0]], [1, [61.369086064041106, 1.0]], [1, [7.327055726487456, 1.0]], [1, [20.186686607878308, 1.0]], [1, [0.7737605024702812, 1.0]], [1, [2.8192881249919104, 1.0]], [1, [0.22308224101970953, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.8737347]
bas 1, expnt(s) = [7617.04185546]
bas 2, expnt(s) = [3617.57064457]
bas 3, expnt(s) = [1587.41381816]
bas 4, expnt(s) = [415.00034141]
bas 5, expnt(s) = [121.02621288]
bas 6, expnt(s) = [38.83607086]
bas 7, expnt(s) = [8.04108747]
bas 8, expnt(s) = [3.1559792]
bas 9, expnt(s) = [0.398606]
bas 10, expnt(s) = [1362.85818029]
bas 11, expnt(s) = [664.05104063]
bas 12, expnt(s) = [297.70007453]
bas 13, expnt(s) = [311.23485688]
bas 14, expnt(s) = [61.36908606]
bas 15, expnt(s) = [7.32705573]
bas 16, expnt(s) = [20.18668661]
bas 17, expnt(s) = [0.7737605]
bas 18, expnt(s) = [2.81928812]
bas 19, expnt(s) = [0.22308224]
CPU time:      1903.33
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828737e+04 5.20029532e+03 7.61704186e+03 2.05994100e+03
 3.61757064e+03 1.17849512e+03 1.58741382e+03 6.35378685e+02
 4.15000341e+02 2.32301153e+02 1.21026213e+02 9.21880454e+01
 3.88360709e+01 3.93044287e+01 8.04108747e+00 1.20642718e+01
 3.15597920e+00 5.98226468e+00 3.98606000e-01 1.26742683e+00
 1.36285818e+03 2.41572628e+04 6.64051041e+02 9.83413622e+03
 2.97700075e+02 3.60751439e+03 3.11234857e+02 3.81368378e+03
 6.13690861e+01 5.01096607e+02 7.32705573e+00 3.51678858e+01
 2.01866866e+01 1.24829058e+02 7.73760502e-01 2.11710593e+00
 2.81928812e+00 1.06575829e+01 2.23082241e-01 4.47265748e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982919934190765
cond(S) = 92559.5177956081
E1 = -729.3796116768468  E_coul = 203.12230713015794
init E= -526.257304546689
    CPU time for initialize scf      7.61 sec, wall time      0.35 sec
  HOMO = -0.556951998325597  LUMO = 1.03132478507855
  mo_energy =
[-1.18335012e+02 -1.22077846e+01 -9.45154842e+00 -9.45154842e+00
 -9.45154842e+00 -1.22602667e+00 -5.56951998e-01 -5.56951998e-01
 -5.56951998e-01  1.03132479e+00  1.03132479e+00  1.03132479e+00
  7.35068014e+00  7.35068014e+00  7.35068014e+00  1.00090706e+01
  3.34952192e+01  3.34952192e+01  3.34952192e+01  1.16114544e+02
  1.28705127e+02  1.28705127e+02  1.28705127e+02  4.80432799e+02
  4.80432799e+02  4.80432799e+02  6.52659084e+02  1.32565556e+03
  1.32565556e+03  1.32565556e+03  2.79097240e+03  3.01131338e+03
  3.01131338e+03  3.01131338e+03  6.62627773e+03  6.62627773e+03
  6.62627773e+03  9.20878641e+03  2.55552344e+04  7.62857340e+04]
E1 = -727.9844179964485  E_coul = 201.27540858274338
cycle= 1 E= -526.709009413705  delta_E= -0.452  |g|= 0.183  |ddm|= 0.403
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.538125
diis-c [-0.2895788  1.       ]
  HOMO = -0.581434806974815  LUMO = 1.01529329067916
  mo_energy =
[-1.18627762e+02 -1.23315696e+01 -9.58536243e+00 -9.58536243e+00
 -9.58536243e+00 -1.25745994e+00 -5.81434807e-01 -5.81434807e-01
 -5.81434807e-01  1.01529329e+00  1.01529329e+00  1.01529329e+00
  7.27483056e+00  7.27483056e+00  7.27483056e+00  9.91792949e+00
  3.33559066e+01  3.33559066e+01  3.33559066e+01  1.15900634e+02
  1.28492193e+02  1.28492193e+02  1.28492193e+02  4.80142102e+02
  4.80142102e+02  4.80142102e+02  6.52321865e+02  1.32530927e+03
  1.32530927e+03  1.32530927e+03  2.79049142e+03  3.01090145e+03
  3.01090145e+03  3.01090145e+03  6.62575375e+03  6.62575375e+03
  6.62575375e+03  9.20818885e+03  2.55545432e+04  7.62849530e+04]
E1 = -728.4472942125904  E_coul = 201.73769526068497
cycle= 2 E= -526.709598951905  delta_E= -0.00059  |g|= 0.0334  |ddm|= 0.0387
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.066824
diis-c [-0.00266834  0.07333896  0.92666104]
  HOMO = -0.574723157458654  LUMO = 1.02035755964836
  mo_energy =
[-1.18569191e+02 -1.23007900e+01 -9.55328031e+00 -9.55328031e+00
 -9.55328031e+00 -1.24893735e+00 -5.74723157e-01 -5.74723157e-01
 -5.74723157e-01  1.02035756e+00  1.02035756e+00  1.02035756e+00
  7.29327819e+00  7.29327819e+00  7.29327819e+00  9.94246938e+00
  3.33885781e+01  3.33885781e+01  3.33885781e+01  1.15949463e+02
  1.28539558e+02  1.28539558e+02  1.28539558e+02  4.80199866e+02
  4.80199866e+02  4.80199866e+02  6.52382429e+02  1.32537086e+03
  1.32537086e+03  1.32537086e+03  2.79055611e+03  3.01096513e+03
  3.01096513e+03  3.01096513e+03  6.62581899e+03  6.62581899e+03
  6.62581899e+03  9.20825481e+03  2.55546096e+04  7.62850196e+04]
E1 = -728.3424718312356  E_coul = 201.63283829833003
cycle= 3 E= -526.709633532906  delta_E= -3.46e-05  |g|= 0.00482  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104532
diis-c [-4.26009239e-07 -1.10545684e-03  1.30729864e-01  8.70375593e-01]
  HOMO = -0.575645350602849  LUMO = 1.01967257599606
  mo_energy =
[-1.18576748e+02 -1.23048305e+01 -9.55759168e+00 -9.55759168e+00
 -9.55759168e+00 -1.25005698e+00 -5.75645351e-01 -5.75645351e-01
 -5.75645351e-01  1.01967258e+00  1.01967258e+00  1.01967258e+00
  7.29077383e+00  7.29077383e+00  7.29077383e+00  9.93933354e+00
  3.33842180e+01  3.33842180e+01  3.33842180e+01  1.15943169e+02
  1.28533392e+02  1.28533392e+02  1.28533392e+02  4.80192413e+02
  4.80192413e+02  4.80192413e+02  6.52374580e+02  1.32536288e+03
  1.32536288e+03  1.32536288e+03  2.79054756e+03  3.01095681e+03
  3.01095681e+03  3.01095681e+03  6.62581032e+03  6.62581032e+03
  6.62581032e+03  9.20824595e+03  2.55546006e+04  7.62850105e+04]
E1 = -728.35667101889  E_coul = 201.64703664707454
cycle= 4 E= -526.709634371815  delta_E= -8.39e-07  |g|= 5.89e-05  |ddm|= 0.00131
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122372
diis-c [-1.30919794e-09  6.38185931e-05 -8.98195786e-03 -7.04440050e-02
  1.07936214e+00]
  HOMO = -0.575633504773343  LUMO = 1.01968135688736
  mo_energy =
[-1.18576753e+02 -1.23048021e+01 -9.55757470e+00 -9.55757470e+00
 -9.55757470e+00 -1.25003820e+00 -5.75633505e-01 -5.75633505e-01
 -5.75633505e-01  1.01968136e+00  1.01968136e+00  1.01968136e+00
  7.29079404e+00  7.29079404e+00  7.29079404e+00  9.93936845e+00
  3.33842338e+01  3.33842338e+01  3.33842338e+01  1.15943179e+02
  1.28533400e+02  1.28533400e+02  1.28533400e+02  4.80192409e+02
  4.80192409e+02  4.80192409e+02  6.52374568e+02  1.32536287e+03
  1.32536287e+03  1.32536287e+03  2.79054753e+03  3.01095679e+03
  3.01095679e+03  3.01095679e+03  6.62581029e+03  6.62581029e+03
  6.62581029e+03  9.20824590e+03  2.55546006e+04  7.62850104e+04]
E1 = -728.3566691811036  E_coul = 201.64703480918095
cycle= 5 E= -526.709634371923  delta_E= -1.07e-10  |g|= 7.74e-06  |ddm|= 2.34e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3566691811036  E_coul = 201.64703480918095
  HOMO = -0.575636944783834  LUMO = 1.01967884308418
  mo_energy =
[-1.18576770e+02 -1.23048142e+01 -9.55758742e+00 -9.55758742e+00
 -9.55758742e+00 -1.25004243e+00 -5.75636945e-01 -5.75636945e-01
 -5.75636945e-01  1.01967884e+00  1.01967884e+00  1.01967884e+00
  7.29078568e+00  7.29078568e+00  7.29078568e+00  9.93935854e+00
  3.33842213e+01  3.33842213e+01  3.33842213e+01  1.15943163e+02
  1.28533384e+02  1.28533384e+02  1.28533384e+02  4.80192392e+02
  4.80192392e+02  4.80192392e+02  6.52374550e+02  1.32536285e+03
  1.32536285e+03  1.32536285e+03  2.79054751e+03  3.01095677e+03
  3.01095677e+03  3.01095677e+03  6.62581027e+03  6.62581027e+03
  6.62581027e+03  9.20824589e+03  2.55546005e+04  7.62850104e+04]
E1 = -728.3567073137431  E_coul = 201.647072941816
Extra cycle  E= -526.709634371927  delta_E= -4.43e-12  |g|= 2.28e-06  |ddm|= 3.94e-06
    CPU time for scf_cycle      7.81 sec, wall time      0.53 sec
exp = [2.61828737e+04 7.61704186e+03 3.61757064e+03 1.58741382e+03
 4.15000341e+02 1.21026213e+02 3.88360709e+01 8.04108747e+00
 3.15597920e+00 3.98606000e-01 1.36285818e+03 6.64051041e+02
 2.97700075e+02 3.11234857e+02 6.13690861e+01 7.32705573e+00
 2.01866866e+01 7.73760502e-01 2.81928812e+00 2.23082241e-01]
E = -526.7096343719271
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:03:03 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8737347        1
[INPUT] 0    0    [1    /1   ]  7617.04185546        1
[INPUT] 0    0    [1    /1   ]  3617.57064457        1
[INPUT] 0    0    [1    /1   ]  1587.41381816        1
[INPUT] 0    0    [1    /1   ]  415.000341415        1
[INPUT] 0    0    [1    /1   ]  121.026212879        1
[INPUT] 0    0    [1    /1   ]  38.8360708565        1
[INPUT] 0    0    [1    /1   ]  8.04108746844        1
[INPUT] 0    0    [1    /1   ]  3.15597920483        1
[INPUT] 0    0    [1    /1   ]  0.398606000177       1
[INPUT] 1    0    [1    /1   ]  1362.85818029        1
[INPUT] 1    0    [1    /1   ]  664.05104063         1
[INPUT] 1    0    [1    /1   ]  297.700074529        1
[INPUT] 1    0    [1    /1   ]  311.234856877        1
[INPUT] 1    0    [1    /1   ]  61.369086064         1
[INPUT] 1    0    [1    /1   ]  7.32705572649        1
[INPUT] 1    0    [1    /1   ]  20.1866866079        1
[INPUT] 1    0    [1    /1   ]  0.77376050247        1
[INPUT] 1    0    [1    /1   ]  2.81928812499        1
[INPUT] 1    0    [1    /1   ]  0.22308224102        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.873734702913, 1.0]], [0, [7617.041855455067, 1.0]], [0, [3617.5706445684054, 1.0]], [0, [1587.413818160465, 1.0]], [0, [415.0003414148151, 1.0]], [0, [121.02621287895933, 1.0]], [0, [38.836070856454306, 1.0]], [0, [8.041087468444683, 1.0]], [0, [3.1559792048257074, 1.0]], [0, [0.3986060001768464, 1.0]], [1, [1362.8581802918266, 1.0]], [1, [664.0510406298063, 1.0]], [1, [297.7000745289396, 1.0]], [1, [311.2348568772051, 1.0]], [1, [61.369086064041106, 1.0]], [1, [7.327055726487456, 1.0]], [1, [20.186686607878308, 1.0]], [1, [0.7737605024702812, 1.0]], [1, [2.8192881249919104, 1.0]], [1, [0.22308224101970953, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.8737347]
bas 1, expnt(s) = [7617.04185546]
bas 2, expnt(s) = [3617.57064457]
bas 3, expnt(s) = [1587.41381816]
bas 4, expnt(s) = [415.00034141]
bas 5, expnt(s) = [121.02621288]
bas 6, expnt(s) = [38.83607086]
bas 7, expnt(s) = [8.04108747]
bas 8, expnt(s) = [3.1559792]
bas 9, expnt(s) = [0.398606]
bas 10, expnt(s) = [1362.85818029]
bas 11, expnt(s) = [664.05104063]
bas 12, expnt(s) = [297.70007453]
bas 13, expnt(s) = [311.23485688]
bas 14, expnt(s) = [61.36908606]
bas 15, expnt(s) = [7.32705573]
bas 16, expnt(s) = [20.18668661]
bas 17, expnt(s) = [0.7737605]
bas 18, expnt(s) = [2.81928812]
bas 19, expnt(s) = [0.22308224]
CPU time:      1911.46
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828737e+04 5.20029532e+03 7.61704186e+03 2.05994100e+03
 3.61757064e+03 1.17849512e+03 1.58741382e+03 6.35378685e+02
 4.15000341e+02 2.32301153e+02 1.21026213e+02 9.21880454e+01
 3.88360709e+01 3.93044287e+01 8.04108747e+00 1.20642718e+01
 3.15597920e+00 5.98226468e+00 3.98606000e-01 1.26742683e+00
 1.36285818e+03 2.41572628e+04 6.64051041e+02 9.83413622e+03
 2.97700075e+02 3.60751439e+03 3.11234857e+02 3.81368378e+03
 6.13690861e+01 5.01096607e+02 7.32705573e+00 3.51678858e+01
 2.01866866e+01 1.24829058e+02 7.73760502e-01 2.11710593e+00
 2.81928812e+00 1.06575829e+01 2.23082241e-01 4.47265748e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982919934190765
cond(S) = 92559.5177956081
E1 = -729.3796116768468  E_coul = 203.12230713015794
init E= -526.257304546689
    CPU time for initialize scf      7.68 sec, wall time      0.36 sec
  HOMO = -0.556951998325597  LUMO = 1.03132478507855
  mo_energy =
[-1.18335012e+02 -1.22077846e+01 -9.45154842e+00 -9.45154842e+00
 -9.45154842e+00 -1.22602667e+00 -5.56951998e-01 -5.56951998e-01
 -5.56951998e-01  1.03132479e+00  1.03132479e+00  1.03132479e+00
  7.35068014e+00  7.35068014e+00  7.35068014e+00  1.00090706e+01
  3.34952192e+01  3.34952192e+01  3.34952192e+01  1.16114544e+02
  1.28705127e+02  1.28705127e+02  1.28705127e+02  4.80432799e+02
  4.80432799e+02  4.80432799e+02  6.52659084e+02  1.32565556e+03
  1.32565556e+03  1.32565556e+03  2.79097240e+03  3.01131338e+03
  3.01131338e+03  3.01131338e+03  6.62627773e+03  6.62627773e+03
  6.62627773e+03  9.20878641e+03  2.55552344e+04  7.62857340e+04]
E1 = -727.9844179964485  E_coul = 201.27540858274338
cycle= 1 E= -526.709009413705  delta_E= -0.452  |g|= 0.183  |ddm|= 0.403
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538125
diis-c [-0.2895788  1.       ]
  HOMO = -0.581434806974815  LUMO = 1.01529329067916
  mo_energy =
[-1.18627762e+02 -1.23315696e+01 -9.58536243e+00 -9.58536243e+00
 -9.58536243e+00 -1.25745994e+00 -5.81434807e-01 -5.81434807e-01
 -5.81434807e-01  1.01529329e+00  1.01529329e+00  1.01529329e+00
  7.27483056e+00  7.27483056e+00  7.27483056e+00  9.91792949e+00
  3.33559066e+01  3.33559066e+01  3.33559066e+01  1.15900634e+02
  1.28492193e+02  1.28492193e+02  1.28492193e+02  4.80142102e+02
  4.80142102e+02  4.80142102e+02  6.52321865e+02  1.32530927e+03
  1.32530927e+03  1.32530927e+03  2.79049142e+03  3.01090145e+03
  3.01090145e+03  3.01090145e+03  6.62575375e+03  6.62575375e+03
  6.62575375e+03  9.20818885e+03  2.55545432e+04  7.62849530e+04]
E1 = -728.4472942125904  E_coul = 201.73769526068497
cycle= 2 E= -526.709598951905  delta_E= -0.00059  |g|= 0.0334  |ddm|= 0.0387
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.066824
diis-c [-0.00266834  0.07333896  0.92666104]
  HOMO = -0.574723157458654  LUMO = 1.02035755964836
  mo_energy =
[-1.18569191e+02 -1.23007900e+01 -9.55328031e+00 -9.55328031e+00
 -9.55328031e+00 -1.24893735e+00 -5.74723157e-01 -5.74723157e-01
 -5.74723157e-01  1.02035756e+00  1.02035756e+00  1.02035756e+00
  7.29327819e+00  7.29327819e+00  7.29327819e+00  9.94246938e+00
  3.33885781e+01  3.33885781e+01  3.33885781e+01  1.15949463e+02
  1.28539558e+02  1.28539558e+02  1.28539558e+02  4.80199866e+02
  4.80199866e+02  4.80199866e+02  6.52382429e+02  1.32537086e+03
  1.32537086e+03  1.32537086e+03  2.79055611e+03  3.01096513e+03
  3.01096513e+03  3.01096513e+03  6.62581899e+03  6.62581899e+03
  6.62581899e+03  9.20825481e+03  2.55546096e+04  7.62850196e+04]
E1 = -728.3424718312356  E_coul = 201.63283829833003
cycle= 3 E= -526.709633532906  delta_E= -3.46e-05  |g|= 0.00482  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104532
diis-c [-4.26009239e-07 -1.10545684e-03  1.30729864e-01  8.70375593e-01]
  HOMO = -0.575645350602849  LUMO = 1.01967257599606
  mo_energy =
[-1.18576748e+02 -1.23048305e+01 -9.55759168e+00 -9.55759168e+00
 -9.55759168e+00 -1.25005698e+00 -5.75645351e-01 -5.75645351e-01
 -5.75645351e-01  1.01967258e+00  1.01967258e+00  1.01967258e+00
  7.29077383e+00  7.29077383e+00  7.29077383e+00  9.93933354e+00
  3.33842180e+01  3.33842180e+01  3.33842180e+01  1.15943169e+02
  1.28533392e+02  1.28533392e+02  1.28533392e+02  4.80192413e+02
  4.80192413e+02  4.80192413e+02  6.52374580e+02  1.32536288e+03
  1.32536288e+03  1.32536288e+03  2.79054756e+03  3.01095681e+03
  3.01095681e+03  3.01095681e+03  6.62581032e+03  6.62581032e+03
  6.62581032e+03  9.20824595e+03  2.55546006e+04  7.62850105e+04]
E1 = -728.35667101889  E_coul = 201.64703664707454
cycle= 4 E= -526.709634371815  delta_E= -8.39e-07  |g|= 5.89e-05  |ddm|= 0.00131
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122372
diis-c [-1.30919794e-09  6.38185931e-05 -8.98195786e-03 -7.04440050e-02
  1.07936214e+00]
  HOMO = -0.575633504773343  LUMO = 1.01968135688736
  mo_energy =
[-1.18576753e+02 -1.23048021e+01 -9.55757470e+00 -9.55757470e+00
 -9.55757470e+00 -1.25003820e+00 -5.75633505e-01 -5.75633505e-01
 -5.75633505e-01  1.01968136e+00  1.01968136e+00  1.01968136e+00
  7.29079404e+00  7.29079404e+00  7.29079404e+00  9.93936845e+00
  3.33842338e+01  3.33842338e+01  3.33842338e+01  1.15943179e+02
  1.28533400e+02  1.28533400e+02  1.28533400e+02  4.80192409e+02
  4.80192409e+02  4.80192409e+02  6.52374568e+02  1.32536287e+03
  1.32536287e+03  1.32536287e+03  2.79054753e+03  3.01095679e+03
  3.01095679e+03  3.01095679e+03  6.62581029e+03  6.62581029e+03
  6.62581029e+03  9.20824590e+03  2.55546006e+04  7.62850104e+04]
E1 = -728.3566691811036  E_coul = 201.64703480918095
cycle= 5 E= -526.709634371923  delta_E= -1.07e-10  |g|= 7.74e-06  |ddm|= 2.34e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3566691811036  E_coul = 201.64703480918095
  HOMO = -0.575636944783834  LUMO = 1.01967884308418
  mo_energy =
[-1.18576770e+02 -1.23048142e+01 -9.55758742e+00 -9.55758742e+00
 -9.55758742e+00 -1.25004243e+00 -5.75636945e-01 -5.75636945e-01
 -5.75636945e-01  1.01967884e+00  1.01967884e+00  1.01967884e+00
  7.29078568e+00  7.29078568e+00  7.29078568e+00  9.93935854e+00
  3.33842213e+01  3.33842213e+01  3.33842213e+01  1.15943163e+02
  1.28533384e+02  1.28533384e+02  1.28533384e+02  4.80192392e+02
  4.80192392e+02  4.80192392e+02  6.52374550e+02  1.32536285e+03
  1.32536285e+03  1.32536285e+03  2.79054751e+03  3.01095677e+03
  3.01095677e+03  3.01095677e+03  6.62581027e+03  6.62581027e+03
  6.62581027e+03  9.20824589e+03  2.55546005e+04  7.62850104e+04]
E1 = -728.3567073137431  E_coul = 201.647072941816
Extra cycle  E= -526.709634371927  delta_E= -4.43e-12  |g|= 2.28e-06  |ddm|= 3.94e-06
    CPU time for scf_cycle      7.86 sec, wall time      0.55 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 92559.5177956081
E1 = -728.3567073137431  E_coul = 201.647072941816
init E= -526.709634371927
    CPU time for initialize scf     16.48 sec, wall time      0.77 sec
  HOMO = -0.575636247369411  LUMO = 1.01967935873823
  mo_energy =
[-1.18576765e+02 -1.23048114e+01 -9.55758453e+00 -9.55758453e+00
 -9.55758453e+00 -1.25004156e+00 -5.75636247e-01 -5.75636247e-01
 -5.75636247e-01  1.01967936e+00  1.01967936e+00  1.01967936e+00
  7.29078746e+00  7.29078746e+00  7.29078746e+00  9.93936079e+00
  3.33842242e+01  3.33842242e+01  3.33842242e+01  1.15943167e+02
  1.28533388e+02  1.28533388e+02  1.28533388e+02  4.80192397e+02
  4.80192397e+02  4.80192397e+02  6.52374555e+02  1.32536286e+03
  1.32536286e+03  1.32536286e+03  2.79054752e+03  3.01095677e+03
  3.01095677e+03  3.01095677e+03  6.62581027e+03  6.62581027e+03
  6.62581027e+03  9.20824589e+03  2.55546005e+04  7.62850104e+04]
E1 = -728.3566982531507  E_coul = 201.64706388122497
cycle= 1 E= -526.709634371926  delta_E= 1.36e-12  |g|= 5.86e-07  |ddm|= 9.01e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3566982531507  E_coul = 201.64706388122497
  HOMO = -0.57563640153965  LUMO = 1.01967924410552
  mo_energy =
[-1.18576767e+02 -1.23048120e+01 -9.55758521e+00 -9.55758521e+00
 -9.55758521e+00 -1.25004175e+00 -5.75636402e-01 -5.75636402e-01
 -5.75636402e-01  1.01967924e+00  1.01967924e+00  1.01967924e+00
  7.29078706e+00  7.29078706e+00  7.29078706e+00  9.93936027e+00
  3.33842235e+01  3.33842235e+01  3.33842235e+01  1.15943166e+02
  1.28533387e+02  1.28533387e+02  1.28533387e+02  4.80192396e+02
  4.80192396e+02  4.80192396e+02  6.52374554e+02  1.32536286e+03
  1.32536286e+03  1.32536286e+03  2.79054752e+03  3.01095677e+03
  3.01095677e+03  3.01095677e+03  6.62581027e+03  6.62581027e+03
  6.62581027e+03  9.20824589e+03  2.55546005e+04  7.62850104e+04]
E1 = -728.3567004607355  E_coul = 201.6470660888093
Extra cycle  E= -526.709634371926  delta_E= -4.55e-13  |g|= 1.47e-07  |ddm|= 2.11e-07
    CPU time for scf_cycle     16.61 sec, wall time      0.90 sec
exp = [2.61828737e+04 7.61704186e+03 3.61757064e+03 1.58741382e+03
 4.15000341e+02 1.21026213e+02 3.88360709e+01 8.04108747e+00
 3.15597920e+00 3.98606000e-01 1.36285818e+03 6.64051041e+02
 2.97700075e+02 3.11234857e+02 6.13690861e+01 7.32705573e+00
 2.01866866e+01 7.73760502e-01 2.81928812e+00 2.23082241e-01]
grad_E = [-1.40553978e-06  2.22833914e-06 -2.13599619e-06  3.89271053e-05
  9.27272220e-06  1.61667645e-05 -4.19541544e-05 -9.68494094e-05
  1.19343256e-04  7.01689836e-04 -5.21497454e-07  5.00951653e-06
  2.38509344e-05  2.04019433e-05 -3.19291860e-05 -5.06508435e-04
  1.17852177e-04  1.23613025e-03  9.67546411e-04 -3.74448079e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:03:08 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8851425        1
[INPUT] 0    0    [1    /1   ]  7617.02510104        1
[INPUT] 0    0    [1    /1   ]  3617.58898808        1
[INPUT] 0    0    [1    /1   ]  1587.14153735        1
[INPUT] 0    0    [1    /1   ]  414.575541827        1
[INPUT] 0    0    [1    /1   ]  120.910807341        1
[INPUT] 0    0    [1    /1   ]  38.8062511998        1
[INPUT] 0    0    [1    /1   ]  8.02910518042        1
[INPUT] 0    0    [1    /1   ]  3.15274106479        1
[INPUT] 0    0    [1    /1   ]  0.398635770709       1
[INPUT] 1    0    [1    /1   ]  1362.86241022        1
[INPUT] 1    0    [1    /1   ]  664.008954514        1
[INPUT] 1    0    [1    /1   ]  297.498953247        1
[INPUT] 1    0    [1    /1   ]  311.062857767        1
[INPUT] 1    0    [1    /1   ]  61.5635637928        1
[INPUT] 1    0    [1    /1   ]  7.35859520652        1
[INPUT] 1    0    [1    /1   ]  20.2671013399        1
[INPUT] 1    0    [1    /1   ]  0.775400314162       1
[INPUT] 1    0    [1    /1   ]  2.83368939183        1
[INPUT] 1    0    [1    /1   ]  0.223358048325       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.885142475625, 1.0]], [0, [7617.025101044951, 1.0]], [0, [3617.5889880808822, 1.0]], [0, [1587.141537348723, 1.0]], [0, [414.57554182730865, 1.0]], [0, [120.91080734056233, 1.0]], [0, [38.80625119983315, 1.0]], [0, [8.02910518042465, 1.0]], [0, [3.1527410647875564, 1.0]], [0, [0.39863577070869344, 1.0]], [1, [1362.8624102151293, 1.0]], [1, [664.0089545135536, 1.0]], [1, [297.4989532471639, 1.0]], [1, [311.0628577674737, 1.0]], [1, [61.563563792756, 1.0]], [1, [7.35859520652228, 1.0]], [1, [20.267101339870358, 1.0]], [1, [0.7754003141616896, 1.0]], [1, [2.8336893918318586, 1.0]], [1, [0.22335804832469816, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.88514248]
bas 1, expnt(s) = [7617.02510104]
bas 2, expnt(s) = [3617.58898808]
bas 3, expnt(s) = [1587.14153735]
bas 4, expnt(s) = [414.57554183]
bas 5, expnt(s) = [120.91080734]
bas 6, expnt(s) = [38.8062512]
bas 7, expnt(s) = [8.02910518]
bas 8, expnt(s) = [3.15274106]
bas 9, expnt(s) = [0.39863577]
bas 10, expnt(s) = [1362.86241022]
bas 11, expnt(s) = [664.00895451]
bas 12, expnt(s) = [297.49895325]
bas 13, expnt(s) = [311.06285777]
bas 14, expnt(s) = [61.56356379]
bas 15, expnt(s) = [7.35859521]
bas 16, expnt(s) = [20.26710134]
bas 17, expnt(s) = [0.77540031]
bas 18, expnt(s) = [2.83368939]
bas 19, expnt(s) = [0.22335805]
CPU time:      1940.88
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828851e+04 5.20029702e+03 7.61702510e+03 2.05993760e+03
 3.61758899e+03 1.17849961e+03 1.58714154e+03 6.35296946e+02
 4.14575542e+02 2.32122790e+02 1.20910807e+02 9.21221075e+01
 3.88062512e+01 3.92817920e+01 8.02910518e+00 1.20507863e+01
 3.15274106e+00 5.97766058e+00 3.98635771e-01 1.26749783e+00
 1.36286241e+03 2.41573565e+04 6.64008955e+02 9.83335714e+03
 2.97498953e+02 3.60446817e+03 3.11062858e+02 3.81104950e+03
 6.15635638e+01 5.03082352e+02 7.35859521e+00 3.53572138e+01
 2.02671013e+01 1.25450946e+02 7.75400314e-01 2.12271583e+00
 2.83368939e+00 1.07256766e+01 2.23358048e-01 4.47957075e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98286783739179
cond(S) = 92243.89376416996
E1 = -729.380163013575  E_coul = 203.1227097058669
init E= -526.257453307708
    CPU time for initialize scf      7.34 sec, wall time      0.34 sec
  HOMO = -0.556929512227629  LUMO = 1.03389168796793
  mo_energy =
[-1.18334968e+02 -1.22077722e+01 -9.45152937e+00 -9.45152937e+00
 -9.45152937e+00 -1.22601369e+00 -5.56929512e-01 -5.56929512e-01
 -5.56929512e-01  1.03389169e+00  1.03389169e+00  1.03389169e+00
  7.39131097e+00  7.39131097e+00  7.39131097e+00  9.98640143e+00
  3.36796529e+01  3.36796529e+01  3.36796529e+01  1.15942651e+02
  1.29266124e+02  1.29266124e+02  1.29266124e+02  4.81246896e+02
  4.81246896e+02  4.81246896e+02  6.51906992e+02  1.32614811e+03
  1.32614811e+03  1.32614811e+03  2.78913663e+03  3.01126427e+03
  3.01126427e+03  3.01126427e+03  6.62581786e+03  6.62581786e+03
  6.62581786e+03  9.20617747e+03  2.55522714e+04  7.62827700e+04]
E1 = -727.9852487028287  E_coul = 201.27622230417361
cycle= 1 E= -526.709026398655  delta_E= -0.452  |g|= 0.183  |ddm|= 0.403
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.538323
diis-c [-0.28979131  1.        ]
  HOMO = -0.581410881681464  LUMO = 1.0178037138043
  mo_energy =
[-1.18627664e+02 -1.23315134e+01 -9.58530963e+00 -9.58530963e+00
 -9.58530963e+00 -1.25744590e+00 -5.81410882e-01 -5.81410882e-01
 -5.81410882e-01  1.01780371e+00  1.01780371e+00  1.01780371e+00
  7.31519422e+00  7.31519422e+00  7.31519422e+00  9.89538704e+00
  3.35401142e+01  3.35401142e+01  3.35401142e+01  1.15728881e+02
  1.29053062e+02  1.29053062e+02  1.29053062e+02  4.80956299e+02
  4.80956299e+02  4.80956299e+02  6.51569918e+02  1.32580193e+03
  1.32580193e+03  1.32580193e+03  2.78865572e+03  3.01085243e+03
  3.01085243e+03  3.01085243e+03  6.62529393e+03  6.62529393e+03
  6.62529393e+03  9.20557995e+03  2.55515802e+04  7.62819890e+04]
E1 = -728.4479587362587  E_coul = 201.73834298067325
cycle= 2 E= -526.709615755585  delta_E= -0.000589  |g|= 0.0334  |ddm|= 0.0387
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0668436
diis-c [-0.00266851  0.07336019  0.92663981]
  HOMO = -0.574703414895117  LUMO = 1.02288039499061
  mo_energy =
[-1.18569111e+02 -1.23007455e+01 -9.55323908e+00 -9.55323908e+00
 -9.55323908e+00 -1.24892837e+00 -5.74703415e-01 -5.74703415e-01
 -5.74703415e-01  1.02288039e+00  1.02288039e+00  1.02288039e+00
  7.33369554e+00  7.33369554e+00  7.33369554e+00  9.91989356e+00
  3.35728316e+01  3.35728316e+01  3.35728316e+01  1.15777682e+02
  1.29100443e+02  1.29100443e+02  1.29100443e+02  4.81014042e+02
  4.81014042e+02  4.81014042e+02  6.51630458e+02  1.32586349e+03
  1.32586349e+03  1.32586349e+03  2.78872039e+03  3.01091608e+03
  3.01091608e+03  3.01091608e+03  6.62535915e+03  6.62535915e+03
  6.62535915e+03  9.20564588e+03  2.55516466e+04  7.62820556e+04]
E1 = -728.3431793983217  E_coul = 201.63352907838652
cycle= 3 E= -526.709650319935  delta_E= -3.46e-05  |g|= 0.00481  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104541
diis-c [-4.27271104e-07 -1.10616313e-03  1.30699548e-01  8.70406615e-01]
  HOMO = -0.575625001016792  LUMO = 1.02219377132178
  mo_energy =
[-1.18576664e+02 -1.23047836e+01 -9.55754814e+00 -9.55754814e+00
 -9.55754814e+00 -1.25004717e+00 -5.75625001e-01 -5.75625001e-01
 -5.75625001e-01  1.02219377e+00  1.02219377e+00  1.02219377e+00
  7.33118422e+00  7.33118422e+00  7.33118422e+00  9.91676273e+00
  3.35684667e+01  3.35684667e+01  3.35684667e+01  1.15771392e+02
  1.29094277e+02  1.29094277e+02  1.29094277e+02  4.81006593e+02
  4.81006593e+02  4.81006593e+02  6.51622614e+02  1.32585552e+03
  1.32585552e+03  1.32585552e+03  2.78871185e+03  3.01090777e+03
  3.01090777e+03  3.01090777e+03  6.62535049e+03  6.62535049e+03
  6.62535049e+03  9.20563702e+03  2.55516376e+04  7.62820465e+04]
E1 = -728.3573703390896  E_coul = 201.64771918102576
cycle= 4 E= -526.709651158064  delta_E= -8.38e-07  |g|= 5.9e-05  |ddm|= 0.00131
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122533
diis-c [-1.30832405e-09  6.38451653e-05 -8.98259945e-03 -7.04773080e-02
  1.07939606e+00]
  HOMO = -0.575613137940391  LUMO = 1.02220258741974
  mo_energy =
[-1.18576669e+02 -1.23047551e+01 -9.55753112e+00 -9.55753112e+00
 -9.55753112e+00 -1.25002836e+00 -5.75613138e-01 -5.75613138e-01
 -5.75613138e-01  1.02220259e+00  1.02220259e+00  1.02220259e+00
  7.33120447e+00  7.33120447e+00  7.33120447e+00  9.91679770e+00
  3.35684825e+01  3.35684825e+01  3.35684825e+01  1.15771402e+02
  1.29094284e+02  1.29094284e+02  1.29094284e+02  4.81006589e+02
  4.81006589e+02  4.81006589e+02  6.51622602e+02  1.32585551e+03
  1.32585551e+03  1.32585551e+03  2.78871182e+03  3.01090775e+03
  3.01090775e+03  3.01090775e+03  6.62535045e+03  6.62535045e+03
  6.62535045e+03  9.20563698e+03  2.55516375e+04  7.62820464e+04]
E1 = -728.3573684114117  E_coul = 201.64771725324167
cycle= 5 E= -526.70965115817  delta_E= -1.06e-10  |g|= 7.75e-06  |ddm|= 2.35e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3573684114117  E_coul = 201.64771725324167
  HOMO = -0.575616582121062  LUMO = 1.02220006316559
  mo_energy =
[-1.18576686e+02 -1.23047672e+01 -9.55754385e+00 -9.55754385e+00
 -9.55754385e+00 -1.25003259e+00 -5.75616582e-01 -5.75616582e-01
 -5.75616582e-01  1.02220006e+00  1.02220006e+00  1.02220006e+00
  7.33119608e+00  7.33119608e+00  7.33119608e+00  9.91678778e+00
  3.35684699e+01  3.35684699e+01  3.35684699e+01  1.15771387e+02
  1.29094269e+02  1.29094269e+02  1.29094269e+02  4.81006572e+02
  4.81006572e+02  4.81006572e+02  6.51622585e+02  1.32585549e+03
  1.32585549e+03  1.32585549e+03  2.78871180e+03  3.01090773e+03
  3.01090773e+03  3.01090773e+03  6.62535043e+03  6.62535043e+03
  6.62535043e+03  9.20563696e+03  2.55516375e+04  7.62820464e+04]
E1 = -728.357406601349  E_coul = 201.64775544317482
Extra cycle  E= -526.709651158174  delta_E= -4.21e-12  |g|= 2.29e-06  |ddm|= 3.95e-06
    CPU time for scf_cycle      7.54 sec, wall time      0.52 sec
exp = [2.61828851e+04 7.61702510e+03 3.61758899e+03 1.58714154e+03
 4.14575542e+02 1.20910807e+02 3.88062512e+01 8.02910518e+00
 3.15274106e+00 3.98635771e-01 1.36286241e+03 6.64008955e+02
 2.97498953e+02 3.11062858e+02 6.15635638e+01 7.35859521e+00
 2.02671013e+01 7.75400314e-01 2.83368939e+00 2.23358048e-01]
E = -526.7096511581742
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:03:09 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8851425        1
[INPUT] 0    0    [1    /1   ]  7617.02510104        1
[INPUT] 0    0    [1    /1   ]  3617.58898808        1
[INPUT] 0    0    [1    /1   ]  1587.14153735        1
[INPUT] 0    0    [1    /1   ]  414.575541827        1
[INPUT] 0    0    [1    /1   ]  120.910807341        1
[INPUT] 0    0    [1    /1   ]  38.8062511998        1
[INPUT] 0    0    [1    /1   ]  8.02910518042        1
[INPUT] 0    0    [1    /1   ]  3.15274106479        1
[INPUT] 0    0    [1    /1   ]  0.398635770709       1
[INPUT] 1    0    [1    /1   ]  1362.86241022        1
[INPUT] 1    0    [1    /1   ]  664.008954514        1
[INPUT] 1    0    [1    /1   ]  297.498953247        1
[INPUT] 1    0    [1    /1   ]  311.062857767        1
[INPUT] 1    0    [1    /1   ]  61.5635637928        1
[INPUT] 1    0    [1    /1   ]  7.35859520652        1
[INPUT] 1    0    [1    /1   ]  20.2671013399        1
[INPUT] 1    0    [1    /1   ]  0.775400314162       1
[INPUT] 1    0    [1    /1   ]  2.83368939183        1
[INPUT] 1    0    [1    /1   ]  0.223358048325       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.885142475625, 1.0]], [0, [7617.025101044951, 1.0]], [0, [3617.5889880808822, 1.0]], [0, [1587.141537348723, 1.0]], [0, [414.57554182730865, 1.0]], [0, [120.91080734056233, 1.0]], [0, [38.80625119983315, 1.0]], [0, [8.02910518042465, 1.0]], [0, [3.1527410647875564, 1.0]], [0, [0.39863577070869344, 1.0]], [1, [1362.8624102151293, 1.0]], [1, [664.0089545135536, 1.0]], [1, [297.4989532471639, 1.0]], [1, [311.0628577674737, 1.0]], [1, [61.563563792756, 1.0]], [1, [7.35859520652228, 1.0]], [1, [20.267101339870358, 1.0]], [1, [0.7754003141616896, 1.0]], [1, [2.8336893918318586, 1.0]], [1, [0.22335804832469816, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.88514248]
bas 1, expnt(s) = [7617.02510104]
bas 2, expnt(s) = [3617.58898808]
bas 3, expnt(s) = [1587.14153735]
bas 4, expnt(s) = [414.57554183]
bas 5, expnt(s) = [120.91080734]
bas 6, expnt(s) = [38.8062512]
bas 7, expnt(s) = [8.02910518]
bas 8, expnt(s) = [3.15274106]
bas 9, expnt(s) = [0.39863577]
bas 10, expnt(s) = [1362.86241022]
bas 11, expnt(s) = [664.00895451]
bas 12, expnt(s) = [297.49895325]
bas 13, expnt(s) = [311.06285777]
bas 14, expnt(s) = [61.56356379]
bas 15, expnt(s) = [7.35859521]
bas 16, expnt(s) = [20.26710134]
bas 17, expnt(s) = [0.77540031]
bas 18, expnt(s) = [2.83368939]
bas 19, expnt(s) = [0.22335805]
CPU time:      1948.75
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828851e+04 5.20029702e+03 7.61702510e+03 2.05993760e+03
 3.61758899e+03 1.17849961e+03 1.58714154e+03 6.35296946e+02
 4.14575542e+02 2.32122790e+02 1.20910807e+02 9.21221075e+01
 3.88062512e+01 3.92817920e+01 8.02910518e+00 1.20507863e+01
 3.15274106e+00 5.97766058e+00 3.98635771e-01 1.26749783e+00
 1.36286241e+03 2.41573565e+04 6.64008955e+02 9.83335714e+03
 2.97498953e+02 3.60446817e+03 3.11062858e+02 3.81104950e+03
 6.15635638e+01 5.03082352e+02 7.35859521e+00 3.53572138e+01
 2.02671013e+01 1.25450946e+02 7.75400314e-01 2.12271583e+00
 2.83368939e+00 1.07256766e+01 2.23358048e-01 4.47957075e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98286783739179
cond(S) = 92243.89376416996
E1 = -729.380163013575  E_coul = 203.1227097058669
init E= -526.257453307708
    CPU time for initialize scf      7.63 sec, wall time      0.37 sec
  HOMO = -0.556929512227629  LUMO = 1.03389168796793
  mo_energy =
[-1.18334968e+02 -1.22077722e+01 -9.45152937e+00 -9.45152937e+00
 -9.45152937e+00 -1.22601369e+00 -5.56929512e-01 -5.56929512e-01
 -5.56929512e-01  1.03389169e+00  1.03389169e+00  1.03389169e+00
  7.39131097e+00  7.39131097e+00  7.39131097e+00  9.98640143e+00
  3.36796529e+01  3.36796529e+01  3.36796529e+01  1.15942651e+02
  1.29266124e+02  1.29266124e+02  1.29266124e+02  4.81246896e+02
  4.81246896e+02  4.81246896e+02  6.51906992e+02  1.32614811e+03
  1.32614811e+03  1.32614811e+03  2.78913663e+03  3.01126427e+03
  3.01126427e+03  3.01126427e+03  6.62581786e+03  6.62581786e+03
  6.62581786e+03  9.20617747e+03  2.55522714e+04  7.62827700e+04]
E1 = -727.9852487028287  E_coul = 201.27622230417361
cycle= 1 E= -526.709026398655  delta_E= -0.452  |g|= 0.183  |ddm|= 0.403
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538323
diis-c [-0.28979131  1.        ]
  HOMO = -0.581410881681464  LUMO = 1.0178037138043
  mo_energy =
[-1.18627664e+02 -1.23315134e+01 -9.58530963e+00 -9.58530963e+00
 -9.58530963e+00 -1.25744590e+00 -5.81410882e-01 -5.81410882e-01
 -5.81410882e-01  1.01780371e+00  1.01780371e+00  1.01780371e+00
  7.31519422e+00  7.31519422e+00  7.31519422e+00  9.89538704e+00
  3.35401142e+01  3.35401142e+01  3.35401142e+01  1.15728881e+02
  1.29053062e+02  1.29053062e+02  1.29053062e+02  4.80956299e+02
  4.80956299e+02  4.80956299e+02  6.51569918e+02  1.32580193e+03
  1.32580193e+03  1.32580193e+03  2.78865572e+03  3.01085243e+03
  3.01085243e+03  3.01085243e+03  6.62529393e+03  6.62529393e+03
  6.62529393e+03  9.20557995e+03  2.55515802e+04  7.62819890e+04]
E1 = -728.4479587362587  E_coul = 201.73834298067325
cycle= 2 E= -526.709615755585  delta_E= -0.000589  |g|= 0.0334  |ddm|= 0.0387
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0668436
diis-c [-0.00266851  0.07336019  0.92663981]
  HOMO = -0.574703414895117  LUMO = 1.02288039499061
  mo_energy =
[-1.18569111e+02 -1.23007455e+01 -9.55323908e+00 -9.55323908e+00
 -9.55323908e+00 -1.24892837e+00 -5.74703415e-01 -5.74703415e-01
 -5.74703415e-01  1.02288039e+00  1.02288039e+00  1.02288039e+00
  7.33369554e+00  7.33369554e+00  7.33369554e+00  9.91989356e+00
  3.35728316e+01  3.35728316e+01  3.35728316e+01  1.15777682e+02
  1.29100443e+02  1.29100443e+02  1.29100443e+02  4.81014042e+02
  4.81014042e+02  4.81014042e+02  6.51630458e+02  1.32586349e+03
  1.32586349e+03  1.32586349e+03  2.78872039e+03  3.01091608e+03
  3.01091608e+03  3.01091608e+03  6.62535915e+03  6.62535915e+03
  6.62535915e+03  9.20564588e+03  2.55516466e+04  7.62820556e+04]
E1 = -728.3431793983217  E_coul = 201.63352907838652
cycle= 3 E= -526.709650319935  delta_E= -3.46e-05  |g|= 0.00481  |ddm|= 0.0101
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104541
diis-c [-4.27271104e-07 -1.10616313e-03  1.30699548e-01  8.70406615e-01]
  HOMO = -0.575625001016792  LUMO = 1.02219377132178
  mo_energy =
[-1.18576664e+02 -1.23047836e+01 -9.55754814e+00 -9.55754814e+00
 -9.55754814e+00 -1.25004717e+00 -5.75625001e-01 -5.75625001e-01
 -5.75625001e-01  1.02219377e+00  1.02219377e+00  1.02219377e+00
  7.33118422e+00  7.33118422e+00  7.33118422e+00  9.91676273e+00
  3.35684667e+01  3.35684667e+01  3.35684667e+01  1.15771392e+02
  1.29094277e+02  1.29094277e+02  1.29094277e+02  4.81006593e+02
  4.81006593e+02  4.81006593e+02  6.51622614e+02  1.32585552e+03
  1.32585552e+03  1.32585552e+03  2.78871185e+03  3.01090777e+03
  3.01090777e+03  3.01090777e+03  6.62535049e+03  6.62535049e+03
  6.62535049e+03  9.20563702e+03  2.55516376e+04  7.62820465e+04]
E1 = -728.3573703390896  E_coul = 201.64771918102576
cycle= 4 E= -526.709651158064  delta_E= -8.38e-07  |g|= 5.9e-05  |ddm|= 0.00131
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122533
diis-c [-1.30832405e-09  6.38451653e-05 -8.98259945e-03 -7.04773080e-02
  1.07939606e+00]
  HOMO = -0.575613137940391  LUMO = 1.02220258741974
  mo_energy =
[-1.18576669e+02 -1.23047551e+01 -9.55753112e+00 -9.55753112e+00
 -9.55753112e+00 -1.25002836e+00 -5.75613138e-01 -5.75613138e-01
 -5.75613138e-01  1.02220259e+00  1.02220259e+00  1.02220259e+00
  7.33120447e+00  7.33120447e+00  7.33120447e+00  9.91679770e+00
  3.35684825e+01  3.35684825e+01  3.35684825e+01  1.15771402e+02
  1.29094284e+02  1.29094284e+02  1.29094284e+02  4.81006589e+02
  4.81006589e+02  4.81006589e+02  6.51622602e+02  1.32585551e+03
  1.32585551e+03  1.32585551e+03  2.78871182e+03  3.01090775e+03
  3.01090775e+03  3.01090775e+03  6.62535045e+03  6.62535045e+03
  6.62535045e+03  9.20563698e+03  2.55516375e+04  7.62820464e+04]
E1 = -728.3573684114117  E_coul = 201.64771725324167
cycle= 5 E= -526.70965115817  delta_E= -1.06e-10  |g|= 7.75e-06  |ddm|= 2.35e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3573684114117  E_coul = 201.64771725324167
  HOMO = -0.575616582121062  LUMO = 1.02220006316559
  mo_energy =
[-1.18576686e+02 -1.23047672e+01 -9.55754385e+00 -9.55754385e+00
 -9.55754385e+00 -1.25003259e+00 -5.75616582e-01 -5.75616582e-01
 -5.75616582e-01  1.02220006e+00  1.02220006e+00  1.02220006e+00
  7.33119608e+00  7.33119608e+00  7.33119608e+00  9.91678778e+00
  3.35684699e+01  3.35684699e+01  3.35684699e+01  1.15771387e+02
  1.29094269e+02  1.29094269e+02  1.29094269e+02  4.81006572e+02
  4.81006572e+02  4.81006572e+02  6.51622585e+02  1.32585549e+03
  1.32585549e+03  1.32585549e+03  2.78871180e+03  3.01090773e+03
  3.01090773e+03  3.01090773e+03  6.62535043e+03  6.62535043e+03
  6.62535043e+03  9.20563696e+03  2.55516375e+04  7.62820464e+04]
E1 = -728.357406601349  E_coul = 201.64775544317482
Extra cycle  E= -526.709651158174  delta_E= -4.21e-12  |g|= 2.29e-06  |ddm|= 3.95e-06
    CPU time for scf_cycle      7.82 sec, wall time      0.55 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 92243.89376416996
E1 = -728.357406601349  E_coul = 201.64775544317482
init E= -526.709651158174
    CPU time for initialize scf     16.40 sec, wall time      0.78 sec
  HOMO = -0.575615883769333  LUMO = 1.02220058105677
  mo_energy =
[-1.18576681e+02 -1.23047645e+01 -9.55754096e+00 -9.55754096e+00
 -9.55754096e+00 -1.25003172e+00 -5.75615884e-01 -5.75615884e-01
 -5.75615884e-01  1.02220058e+00  1.02220058e+00  1.02220058e+00
  7.33119787e+00  7.33119787e+00  7.33119787e+00  9.91679004e+00
  3.35684729e+01  3.35684729e+01  3.35684729e+01  1.15771391e+02
  1.29094273e+02  1.29094273e+02  1.29094273e+02  4.81006577e+02
  4.81006577e+02  4.81006577e+02  6.51622589e+02  1.32585550e+03
  1.32585550e+03  1.32585550e+03  2.78871180e+03  3.01090773e+03
  3.01090773e+03  3.01090773e+03  6.62535044e+03  6.62535044e+03
  6.62535044e+03  9.20563697e+03  2.55516375e+04  7.62820464e+04]
E1 = -728.3573975272775  E_coul = 201.6477463691031
cycle= 1 E= -526.709651158174  delta_E= -2.27e-13  |g|= 5.87e-07  |ddm|= 9.04e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3573975272775  E_coul = 201.6477463691031
  HOMO = -0.575616038148141  LUMO = 1.02220046592022
  mo_energy =
[-1.18576682e+02 -1.23047651e+01 -9.55754164e+00 -9.55754164e+00
 -9.55754164e+00 -1.25003191e+00 -5.75616038e-01 -5.75616038e-01
 -5.75616038e-01  1.02220047e+00  1.02220047e+00  1.02220047e+00
  7.33119746e+00  7.33119746e+00  7.33119746e+00  9.91678952e+00
  3.35684722e+01  3.35684722e+01  3.35684722e+01  1.15771390e+02
  1.29094272e+02  1.29094272e+02  1.29094272e+02  4.81006575e+02
  4.81006575e+02  4.81006575e+02  6.51622588e+02  1.32585550e+03
  1.32585550e+03  1.32585550e+03  2.78871180e+03  3.01090773e+03
  3.01090773e+03  3.01090773e+03  6.62535044e+03  6.62535044e+03
  6.62535044e+03  9.20563697e+03  2.55516375e+04  7.62820464e+04]
E1 = -728.3573997380984  E_coul = 201.64774857992455
Extra cycle  E= -526.709651158174  delta_E= 6.82e-13  |g|= 1.47e-07  |ddm|= 2.12e-07
    CPU time for scf_cycle     16.53 sec, wall time      0.90 sec
exp = [2.61828851e+04 7.61702510e+03 3.61758899e+03 1.58714154e+03
 4.14575542e+02 1.20910807e+02 3.88062512e+01 8.02910518e+00
 3.15274106e+00 3.98635771e-01 1.36286241e+03 6.64008955e+02
 2.97498953e+02 3.11062858e+02 6.15635638e+01 7.35859521e+00
 2.02671013e+01 7.75400314e-01 2.83368939e+00 2.23358048e-01]
grad_E = [-1.40703250e-06  2.24087220e-06 -2.13808635e-06  3.93450162e-05
  5.91613336e-06  2.44212875e-05 -7.02816467e-05 -1.61601868e-04
  2.01022005e-04  1.16108505e-03 -5.31235402e-07  4.89781460e-06
  2.32516640e-05  1.98706401e-05 -3.26981745e-05 -8.36947429e-04
  2.02842508e-04  2.03595422e-03  1.59885797e-03 -6.17339843e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:03:15 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.9221894        1
[INPUT] 0    0    [1    /1   ]  7616.96828334        1
[INPUT] 0    0    [1    /1   ]  3617.64660732        1
[INPUT] 0    0    [1    /1   ]  1586.17911235        1
[INPUT] 0    0    [1    /1   ]  413.811491284        1
[INPUT] 0    0    [1    /1   ]  120.709784126        1
[INPUT] 0    0    [1    /1   ]  38.7552151541        1
[INPUT] 0    0    [1    /1   ]  8.00944954051        1
[INPUT] 0    0    [1    /1   ]  3.14736933207        1
[INPUT] 0    0    [1    /1   ]  0.398684834555       1
[INPUT] 1    0    [1    /1   ]  1362.8762754         1
[INPUT] 1    0    [1    /1   ]  663.876942502        1
[INPUT] 1    0    [1    /1   ]  296.871348029        1
[INPUT] 1    0    [1    /1   ]  310.525978299        1
[INPUT] 1    0    [1    /1   ]  61.8572811051        1
[INPUT] 1    0    [1    /1   ]  7.40741286506        1
[INPUT] 1    0    [1    /1   ]  20.3917473225        1
[INPUT] 1    0    [1    /1   ]  0.777945370201       1
[INPUT] 1    0    [1    /1   ]  2.85600183485        1
[INPUT] 1    0    [1    /1   ]  0.223782822093       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.922189407764, 1.0]], [0, [7616.96828333694, 1.0]], [0, [3617.646607323072, 1.0]], [0, [1586.179112346036, 1.0]], [0, [413.81149128423175, 1.0]], [0, [120.70978412564277, 1.0]], [0, [38.75521515411688, 1.0]], [0, [8.009449540507319, 1.0]], [0, [3.147369332065595, 1.0]], [0, [0.39868483455537385, 1.0]], [1, [1362.8762753985254, 1.0]], [1, [663.8769425015067, 1.0]], [1, [296.8713480293988, 1.0]], [1, [310.52597829861094, 1.0]], [1, [61.85728110505462, 1.0]], [1, [7.407412865058914, 1.0]], [1, [20.391747322537455, 1.0]], [1, [0.7779453702013286, 1.0]], [1, [2.856001834851138, 1.0]], [1, [0.22378282209344408, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.92218941]
bas 1, expnt(s) = [7616.96828334]
bas 2, expnt(s) = [3617.64660732]
bas 3, expnt(s) = [1586.17911235]
bas 4, expnt(s) = [413.81149128]
bas 5, expnt(s) = [120.70978413]
bas 6, expnt(s) = [38.75521515]
bas 7, expnt(s) = [8.00944954]
bas 8, expnt(s) = [3.14736933]
bas 9, expnt(s) = [0.39868483]
bas 10, expnt(s) = [1362.8762754]
bas 11, expnt(s) = [663.8769425]
bas 12, expnt(s) = [296.87134803]
bas 13, expnt(s) = [310.5259783]
bas 14, expnt(s) = [61.85728111]
bas 15, expnt(s) = [7.40741287]
bas 16, expnt(s) = [20.39174732]
bas 17, expnt(s) = [0.77794537]
bas 18, expnt(s) = [2.85600183]
bas 19, expnt(s) = [0.22378282]
CPU time:      1978.10
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61829222e+04 5.20030254e+03 7.61696828e+03 2.05992607e+03
 3.61764661e+03 1.17851368e+03 1.58617911e+03 6.35007996e+02
 4.13811491e+02 2.31801869e+02 1.20709784e+02 9.20072137e+01
 3.87552152e+01 3.92430396e+01 8.00944954e+00 1.20286538e+01
 3.14736933e+00 5.97002027e+00 3.98684835e-01 1.26761483e+00
 1.36287628e+03 2.41576637e+04 6.63876943e+02 9.83091348e+03
 2.96871348e+02 3.59496568e+03 3.10525978e+02 3.80282916e+03
 6.18572811e+01 5.06084372e+02 7.40741287e+00 3.56506606e+01
 2.03917473e+01 1.26416116e+02 7.77945370e-01 2.13142850e+00
 2.85600183e+00 1.08313476e+01 2.23782822e-01 4.49022213e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98278619878092
cond(S) = 90801.21606004037
E1 = -729.3810832117339  E_coul = 203.12337447655477
init E= -526.257708735179
    CPU time for initialize scf      7.60 sec, wall time      0.35 sec
  HOMO = -0.556894404889513  LUMO = 1.03787125781186
  mo_energy =
[-1.18334904e+02 -1.22077513e+01 -9.45149579e+00 -9.45149579e+00
 -9.45149579e+00 -1.22599241e+00 -5.56894405e-01 -5.56894405e-01
 -5.56894405e-01  1.03787126e+00  1.03787126e+00  1.03787126e+00
  7.45442633e+00  7.45442633e+00  7.45442633e+00  9.94903213e+00
  3.39652015e+01  3.39652015e+01  3.39652015e+01  1.15650623e+02
  1.30121343e+02  1.30121343e+02  1.30121343e+02  4.82269961e+02
  4.82269961e+02  4.82269961e+02  6.50580771e+02  1.32603715e+03
  1.32603715e+03  1.32603715e+03  2.78558471e+03  3.00947817e+03
  3.00947817e+03  3.00947817e+03  6.62285431e+03  6.62285431e+03
  6.62285431e+03  9.20054196e+03  2.55454654e+04  7.62757932e+04]
E1 = -727.9865928651219  E_coul = 201.27752189216767
cycle= 1 E= -526.709070972954  delta_E= -0.451  |g|= 0.183  |ddm|= 0.403
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.538665
diis-c [-0.29016044  1.        ]
  HOMO = -0.581376401642582  LUMO = 1.02169375851711
  mo_energy =
[-1.18627512e+02 -1.23314221e+01 -9.58522246e+00 -9.58522246e+00
 -9.58522246e+00 -1.25742615e+00 -5.81376402e-01 -5.81376402e-01
 -5.81376402e-01  1.02169376e+00  1.02169376e+00  1.02169376e+00
  7.37789579e+00  7.37789579e+00  7.37789579e+00  9.85822370e+00
  3.38253187e+01  3.38253187e+01  3.38253187e+01  1.15437088e+02
  1.29908106e+02  1.29908106e+02  1.29908106e+02  4.81979580e+02
  4.81979580e+02  4.81979580e+02  6.50243952e+02  1.32569122e+03
  1.32569122e+03  1.32569122e+03  2.78510396e+03  3.00906649e+03
  3.00906649e+03  3.00906649e+03  6.62233045e+03  6.62233045e+03
  6.62233045e+03  9.19994449e+03  2.55447742e+04  7.62750122e+04]
E1 = -728.4490556042198  E_coul = 201.73939554888685
cycle= 2 E= -526.709660055333  delta_E= -0.000589  |g|= 0.0334  |ddm|= 0.0387
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0668816
diis-c [-0.00266898  0.07340361  0.92659639]
  HOMO = -0.574675294246929  LUMO = 1.02678973700746
  mo_energy =
[-1.18568987e+02 -1.23006720e+01 -9.55316937e+00 -9.55316937e+00
 -9.55316937e+00 -1.24891630e+00 -5.74675294e-01 -5.74675294e-01
 -5.74675294e-01  1.02678974e+00  1.02678974e+00  1.02678974e+00
  7.39648011e+00  7.39648011e+00  7.39648011e+00  9.88267646e+00
  3.38581064e+01  3.38581064e+01  3.38581064e+01  1.15485844e+02
  1.29955509e+02  1.29955509e+02  1.29955509e+02  4.82037286e+02
  4.82037286e+02  4.82037286e+02  6.50304454e+02  1.32575275e+03
  1.32575275e+03  1.32575275e+03  2.78516860e+03  3.00913012e+03
  3.00913012e+03  3.00913012e+03  6.62239564e+03  6.62239564e+03
  6.62239564e+03  9.20001039e+03  2.55448405e+04  7.62750789e+04]
E1 = -728.344337822622  E_coul = 201.63464322598142
cycle= 3 E= -526.709694596641  delta_E= -3.45e-05  |g|= 0.00481  |ddm|= 0.0102
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104564
diis-c [-4.29416313e-07 -1.10739942e-03  1.30648662e-01  8.70458738e-01]
  HOMO = -0.575595961298387  LUMO = 1.0261005617481
  mo_energy =
[-1.18576533e+02 -1.23047064e+01 -9.55747480e+00 -9.55747480e+00
 -9.55747480e+00 -1.25003384e+00 -5.75595961e-01 -5.75595961e-01
 -5.75595961e-01  1.02610056e+00  1.02610056e+00  1.02610056e+00
  7.39395808e+00  7.39395808e+00  7.39395808e+00  9.87955372e+00
  3.38537342e+01  3.38537342e+01  3.38537342e+01  1.15479563e+02
  1.29949343e+02  1.29949343e+02  1.29949343e+02  4.82029845e+02
  4.82029845e+02  4.82029845e+02  6.50296618e+02  1.32574478e+03
  1.32574478e+03  1.32574478e+03  2.78516006e+03  3.00912181e+03
  3.00912181e+03  3.00912181e+03  6.62238698e+03  6.62238698e+03
  6.62238698e+03  9.20000154e+03  2.55448315e+04  7.62750697e+04]
E1 = -728.3585163017615  E_coul = 201.648820868189
cycle= 4 E= -526.709695433573  delta_E= -8.37e-07  |g|= 5.91e-05  |ddm|= 0.00131
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122825
diis-c [-1.30758671e-09  6.38823544e-05 -8.98265048e-03 -7.05277015e-02
  1.07944647e+00]
  HOMO = -0.575584069896031  LUMO = 1.02610943368647
  mo_energy =
[-1.18576538e+02 -1.23046778e+01 -9.55745771e+00 -9.55745771e+00
 -9.55745771e+00 -1.25001496e+00 -5.75584070e-01 -5.75584070e-01
 -5.75584070e-01  1.02610943e+00  1.02610943e+00  1.02610943e+00
  7.39397840e+00  7.39397840e+00  7.39397840e+00  9.87958881e+00
  3.38537500e+01  3.38537500e+01  3.38537500e+01  1.15479573e+02
  1.29949350e+02  1.29949350e+02  1.29949350e+02  4.82029841e+02
  4.82029841e+02  4.82029841e+02  6.50296606e+02  1.32574477e+03
  1.32574477e+03  1.32574477e+03  2.78516003e+03  3.00912179e+03
  3.00912179e+03  3.00912179e+03  6.62238695e+03  6.62238695e+03
  6.62238695e+03  9.20000150e+03  2.55448315e+04  7.62750697e+04]
E1 = -728.3585142286204  E_coul = 201.64881879493848
cycle= 5 E= -526.709695433682  delta_E= -1.09e-10  |g|= 7.77e-06  |ddm|= 2.36e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3585142286204  E_coul = 201.64881879493848
  HOMO = -0.575587521580328  LUMO = 1.02610689243751
  mo_energy =
[-1.18576555e+02 -1.23046900e+01 -9.55747048e+00 -9.55747048e+00
 -9.55747048e+00 -1.25001921e+00 -5.75587522e-01 -5.75587522e-01
 -5.75587522e-01  1.02610689e+00  1.02610689e+00  1.02610689e+00
  7.39396995e+00  7.39396995e+00  7.39396995e+00  9.87957887e+00
  3.38537374e+01  3.38537374e+01  3.38537374e+01  1.15479557e+02
  1.29949335e+02  1.29949335e+02  1.29949335e+02  4.82029824e+02
  4.82029824e+02  4.82029824e+02  6.50296588e+02  1.32574475e+03
  1.32574475e+03  1.32574475e+03  2.78516001e+03  3.00912177e+03
  3.00912177e+03  3.00912177e+03  6.62238693e+03  6.62238693e+03
  6.62238693e+03  9.20000148e+03  2.55448314e+04  7.62750696e+04]
E1 = -728.3585525225199  E_coul = 201.64885708883503
Extra cycle  E= -526.709695433685  delta_E= -2.96e-12  |g|= 2.29e-06  |ddm|= 3.96e-06
    CPU time for scf_cycle      7.81 sec, wall time      0.53 sec
exp = [2.61829222e+04 7.61696828e+03 3.61764661e+03 1.58617911e+03
 4.13811491e+02 1.20709784e+02 3.87552152e+01 8.00944954e+00
 3.14736933e+00 3.98684835e-01 1.36287628e+03 6.63876943e+02
 2.96871348e+02 3.10525978e+02 6.18572811e+01 7.40741287e+00
 2.03917473e+01 7.77945370e-01 2.85600183e+00 2.23782822e-01]
E = -526.7096954336848
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:03:15 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.9221894        1
[INPUT] 0    0    [1    /1   ]  7616.96828334        1
[INPUT] 0    0    [1    /1   ]  3617.64660732        1
[INPUT] 0    0    [1    /1   ]  1586.17911235        1
[INPUT] 0    0    [1    /1   ]  413.811491284        1
[INPUT] 0    0    [1    /1   ]  120.709784126        1
[INPUT] 0    0    [1    /1   ]  38.7552151541        1
[INPUT] 0    0    [1    /1   ]  8.00944954051        1
[INPUT] 0    0    [1    /1   ]  3.14736933207        1
[INPUT] 0    0    [1    /1   ]  0.398684834555       1
[INPUT] 1    0    [1    /1   ]  1362.8762754         1
[INPUT] 1    0    [1    /1   ]  663.876942502        1
[INPUT] 1    0    [1    /1   ]  296.871348029        1
[INPUT] 1    0    [1    /1   ]  310.525978299        1
[INPUT] 1    0    [1    /1   ]  61.8572811051        1
[INPUT] 1    0    [1    /1   ]  7.40741286506        1
[INPUT] 1    0    [1    /1   ]  20.3917473225        1
[INPUT] 1    0    [1    /1   ]  0.777945370201       1
[INPUT] 1    0    [1    /1   ]  2.85600183485        1
[INPUT] 1    0    [1    /1   ]  0.223782822093       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26182.922189407764, 1.0]], [0, [7616.96828333694, 1.0]], [0, [3617.646607323072, 1.0]], [0, [1586.179112346036, 1.0]], [0, [413.81149128423175, 1.0]], [0, [120.70978412564277, 1.0]], [0, [38.75521515411688, 1.0]], [0, [8.009449540507319, 1.0]], [0, [3.147369332065595, 1.0]], [0, [0.39868483455537385, 1.0]], [1, [1362.8762753985254, 1.0]], [1, [663.8769425015067, 1.0]], [1, [296.8713480293988, 1.0]], [1, [310.52597829861094, 1.0]], [1, [61.85728110505462, 1.0]], [1, [7.407412865058914, 1.0]], [1, [20.391747322537455, 1.0]], [1, [0.7779453702013286, 1.0]], [1, [2.856001834851138, 1.0]], [1, [0.22378282209344408, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.92218941]
bas 1, expnt(s) = [7616.96828334]
bas 2, expnt(s) = [3617.64660732]
bas 3, expnt(s) = [1586.17911235]
bas 4, expnt(s) = [413.81149128]
bas 5, expnt(s) = [120.70978413]
bas 6, expnt(s) = [38.75521515]
bas 7, expnt(s) = [8.00944954]
bas 8, expnt(s) = [3.14736933]
bas 9, expnt(s) = [0.39868483]
bas 10, expnt(s) = [1362.8762754]
bas 11, expnt(s) = [663.8769425]
bas 12, expnt(s) = [296.87134803]
bas 13, expnt(s) = [310.5259783]
bas 14, expnt(s) = [61.85728111]
bas 15, expnt(s) = [7.40741287]
bas 16, expnt(s) = [20.39174732]
bas 17, expnt(s) = [0.77794537]
bas 18, expnt(s) = [2.85600183]
bas 19, expnt(s) = [0.22378282]
CPU time:      1986.22
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61829222e+04 5.20030254e+03 7.61696828e+03 2.05992607e+03
 3.61764661e+03 1.17851368e+03 1.58617911e+03 6.35007996e+02
 4.13811491e+02 2.31801869e+02 1.20709784e+02 9.20072137e+01
 3.87552152e+01 3.92430396e+01 8.00944954e+00 1.20286538e+01
 3.14736933e+00 5.97002027e+00 3.98684835e-01 1.26761483e+00
 1.36287628e+03 2.41576637e+04 6.63876943e+02 9.83091348e+03
 2.96871348e+02 3.59496568e+03 3.10525978e+02 3.80282916e+03
 6.18572811e+01 5.06084372e+02 7.40741287e+00 3.56506606e+01
 2.03917473e+01 1.26416116e+02 7.77945370e-01 2.13142850e+00
 2.85600183e+00 1.08313476e+01 2.23782822e-01 4.49022213e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98278619878092
cond(S) = 90801.21606004037
E1 = -729.3810832117339  E_coul = 203.12337447655477
init E= -526.257708735179
    CPU time for initialize scf      7.33 sec, wall time      0.34 sec
  HOMO = -0.556894404889513  LUMO = 1.03787125781186
  mo_energy =
[-1.18334904e+02 -1.22077513e+01 -9.45149579e+00 -9.45149579e+00
 -9.45149579e+00 -1.22599241e+00 -5.56894405e-01 -5.56894405e-01
 -5.56894405e-01  1.03787126e+00  1.03787126e+00  1.03787126e+00
  7.45442633e+00  7.45442633e+00  7.45442633e+00  9.94903213e+00
  3.39652015e+01  3.39652015e+01  3.39652015e+01  1.15650623e+02
  1.30121343e+02  1.30121343e+02  1.30121343e+02  4.82269961e+02
  4.82269961e+02  4.82269961e+02  6.50580771e+02  1.32603715e+03
  1.32603715e+03  1.32603715e+03  2.78558471e+03  3.00947817e+03
  3.00947817e+03  3.00947817e+03  6.62285431e+03  6.62285431e+03
  6.62285431e+03  9.20054196e+03  2.55454654e+04  7.62757932e+04]
E1 = -727.9865928651219  E_coul = 201.27752189216767
cycle= 1 E= -526.709070972954  delta_E= -0.451  |g|= 0.183  |ddm|= 0.403
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.538665
diis-c [-0.29016044  1.        ]
  HOMO = -0.581376401642582  LUMO = 1.02169375851711
  mo_energy =
[-1.18627512e+02 -1.23314221e+01 -9.58522246e+00 -9.58522246e+00
 -9.58522246e+00 -1.25742615e+00 -5.81376402e-01 -5.81376402e-01
 -5.81376402e-01  1.02169376e+00  1.02169376e+00  1.02169376e+00
  7.37789579e+00  7.37789579e+00  7.37789579e+00  9.85822370e+00
  3.38253187e+01  3.38253187e+01  3.38253187e+01  1.15437088e+02
  1.29908106e+02  1.29908106e+02  1.29908106e+02  4.81979580e+02
  4.81979580e+02  4.81979580e+02  6.50243952e+02  1.32569122e+03
  1.32569122e+03  1.32569122e+03  2.78510396e+03  3.00906649e+03
  3.00906649e+03  3.00906649e+03  6.62233045e+03  6.62233045e+03
  6.62233045e+03  9.19994449e+03  2.55447742e+04  7.62750122e+04]
E1 = -728.4490556042198  E_coul = 201.73939554888685
cycle= 2 E= -526.709660055333  delta_E= -0.000589  |g|= 0.0334  |ddm|= 0.0387
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0668816
diis-c [-0.00266898  0.07340361  0.92659639]
  HOMO = -0.574675294246929  LUMO = 1.02678973700746
  mo_energy =
[-1.18568987e+02 -1.23006720e+01 -9.55316937e+00 -9.55316937e+00
 -9.55316937e+00 -1.24891630e+00 -5.74675294e-01 -5.74675294e-01
 -5.74675294e-01  1.02678974e+00  1.02678974e+00  1.02678974e+00
  7.39648011e+00  7.39648011e+00  7.39648011e+00  9.88267646e+00
  3.38581064e+01  3.38581064e+01  3.38581064e+01  1.15485844e+02
  1.29955509e+02  1.29955509e+02  1.29955509e+02  4.82037286e+02
  4.82037286e+02  4.82037286e+02  6.50304454e+02  1.32575275e+03
  1.32575275e+03  1.32575275e+03  2.78516860e+03  3.00913012e+03
  3.00913012e+03  3.00913012e+03  6.62239564e+03  6.62239564e+03
  6.62239564e+03  9.20001039e+03  2.55448405e+04  7.62750789e+04]
E1 = -728.344337822622  E_coul = 201.63464322598142
cycle= 3 E= -526.709694596641  delta_E= -3.45e-05  |g|= 0.00481  |ddm|= 0.0102
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104564
diis-c [-4.29416313e-07 -1.10739942e-03  1.30648662e-01  8.70458738e-01]
  HOMO = -0.575595961298387  LUMO = 1.0261005617481
  mo_energy =
[-1.18576533e+02 -1.23047064e+01 -9.55747480e+00 -9.55747480e+00
 -9.55747480e+00 -1.25003384e+00 -5.75595961e-01 -5.75595961e-01
 -5.75595961e-01  1.02610056e+00  1.02610056e+00  1.02610056e+00
  7.39395808e+00  7.39395808e+00  7.39395808e+00  9.87955372e+00
  3.38537342e+01  3.38537342e+01  3.38537342e+01  1.15479563e+02
  1.29949343e+02  1.29949343e+02  1.29949343e+02  4.82029845e+02
  4.82029845e+02  4.82029845e+02  6.50296618e+02  1.32574478e+03
  1.32574478e+03  1.32574478e+03  2.78516006e+03  3.00912181e+03
  3.00912181e+03  3.00912181e+03  6.62238698e+03  6.62238698e+03
  6.62238698e+03  9.20000154e+03  2.55448315e+04  7.62750697e+04]
E1 = -728.3585163017615  E_coul = 201.648820868189
cycle= 4 E= -526.709695433573  delta_E= -8.37e-07  |g|= 5.91e-05  |ddm|= 0.00131
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122825
diis-c [-1.30758671e-09  6.38823544e-05 -8.98265048e-03 -7.05277015e-02
  1.07944647e+00]
  HOMO = -0.575584069896031  LUMO = 1.02610943368647
  mo_energy =
[-1.18576538e+02 -1.23046778e+01 -9.55745771e+00 -9.55745771e+00
 -9.55745771e+00 -1.25001496e+00 -5.75584070e-01 -5.75584070e-01
 -5.75584070e-01  1.02610943e+00  1.02610943e+00  1.02610943e+00
  7.39397840e+00  7.39397840e+00  7.39397840e+00  9.87958881e+00
  3.38537500e+01  3.38537500e+01  3.38537500e+01  1.15479573e+02
  1.29949350e+02  1.29949350e+02  1.29949350e+02  4.82029841e+02
  4.82029841e+02  4.82029841e+02  6.50296606e+02  1.32574477e+03
  1.32574477e+03  1.32574477e+03  2.78516003e+03  3.00912179e+03
  3.00912179e+03  3.00912179e+03  6.62238695e+03  6.62238695e+03
  6.62238695e+03  9.20000150e+03  2.55448315e+04  7.62750697e+04]
E1 = -728.3585142286204  E_coul = 201.64881879493848
cycle= 5 E= -526.709695433682  delta_E= -1.09e-10  |g|= 7.77e-06  |ddm|= 2.36e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3585142286204  E_coul = 201.64881879493848
  HOMO = -0.575587521580328  LUMO = 1.02610689243751
  mo_energy =
[-1.18576555e+02 -1.23046900e+01 -9.55747048e+00 -9.55747048e+00
 -9.55747048e+00 -1.25001921e+00 -5.75587522e-01 -5.75587522e-01
 -5.75587522e-01  1.02610689e+00  1.02610689e+00  1.02610689e+00
  7.39396995e+00  7.39396995e+00  7.39396995e+00  9.87957887e+00
  3.38537374e+01  3.38537374e+01  3.38537374e+01  1.15479557e+02
  1.29949335e+02  1.29949335e+02  1.29949335e+02  4.82029824e+02
  4.82029824e+02  4.82029824e+02  6.50296588e+02  1.32574475e+03
  1.32574475e+03  1.32574475e+03  2.78516001e+03  3.00912177e+03
  3.00912177e+03  3.00912177e+03  6.62238693e+03  6.62238693e+03
  6.62238693e+03  9.20000148e+03  2.55448314e+04  7.62750696e+04]
E1 = -728.3585525225199  E_coul = 201.64885708883503
Extra cycle  E= -526.709695433685  delta_E= -2.96e-12  |g|= 2.29e-06  |ddm|= 3.96e-06
    CPU time for scf_cycle      7.53 sec, wall time      0.52 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 90801.21606004037
E1 = -728.3585525225199  E_coul = 201.64885708883503
init E= -526.709695433685
    CPU time for initialize scf     16.13 sec, wall time      0.76 sec
  HOMO = -0.575586821491016  LUMO = 1.02610741401685
  mo_energy =
[-1.18576550e+02 -1.23046872e+01 -9.55746758e+00 -9.55746758e+00
 -9.55746758e+00 -1.25001833e+00 -5.75586821e-01 -5.75586821e-01
 -5.75586821e-01  1.02610741e+00  1.02610741e+00  1.02610741e+00
  7.39397175e+00  7.39397175e+00  7.39397175e+00  9.87958114e+00
  3.38537403e+01  3.38537403e+01  3.38537403e+01  1.15479561e+02
  1.29949339e+02  1.29949339e+02  1.29949339e+02  4.82029829e+02
  4.82029829e+02  4.82029829e+02  6.50296593e+02  1.32574476e+03
  1.32574476e+03  1.32574476e+03  2.78516001e+03  3.00912177e+03
  3.00912177e+03  3.00912177e+03  6.62238694e+03  6.62238694e+03
  6.62238694e+03  9.20000148e+03  2.55448314e+04  7.62750696e+04]
E1 = -728.3585434236147  E_coul = 201.64884798992946
cycle= 1 E= -526.709695433685  delta_E= -4.55e-13  |g|= 5.89e-07  |ddm|= 9.07e-07
    CPU time for cycle= 1      0.04 sec, wall time      0.02 sec
E1 = -728.3585434236147  E_coul = 201.64884798992946
  HOMO = -0.575586976263348  LUMO = 1.02610729804648
  mo_energy =
[-1.18576552e+02 -1.23046878e+01 -9.55746827e+00 -9.55746827e+00
 -9.55746827e+00 -1.25001853e+00 -5.75586976e-01 -5.75586976e-01
 -5.75586976e-01  1.02610730e+00  1.02610730e+00  1.02610730e+00
  7.39397134e+00  7.39397134e+00  7.39397134e+00  9.87958062e+00
  3.38537397e+01  3.38537397e+01  3.38537397e+01  1.15479560e+02
  1.29949338e+02  1.29949338e+02  1.29949338e+02  4.82029828e+02
  4.82029828e+02  4.82029828e+02  6.50296592e+02  1.32574476e+03
  1.32574476e+03  1.32574476e+03  2.78516001e+03  3.00912177e+03
  3.00912177e+03  3.00912177e+03  6.62238693e+03  6.62238693e+03
  6.62238693e+03  9.20000148e+03  2.55448314e+04  7.62750696e+04]
E1 = -728.3585456404977  E_coul = 201.64885020681314
Extra cycle  E= -526.709695433685  delta_E= 6.82e-13  |g|= 1.48e-07  |ddm|= 2.13e-07
    CPU time for scf_cycle     16.25 sec, wall time      0.87 sec
exp = [2.61829222e+04 7.61696828e+03 3.61764661e+03 1.58617911e+03
 4.13811491e+02 1.20709784e+02 3.87552152e+01 8.00944954e+00
 3.14736933e+00 3.98684835e-01 1.36287628e+03 6.63876943e+02
 2.96871348e+02 3.10525978e+02 6.18572811e+01 7.40741287e+00
 2.03917473e+01 7.77945370e-01 2.85600183e+00 2.23782822e-01]
grad_E = [-1.40928243e-06  2.25982967e-06 -2.14499384e-06  4.00397795e-05
  4.07271523e-07  3.79661739e-05 -1.16666966e-04 -2.67881238e-04
  3.32771119e-04  1.91520648e-03 -5.47811265e-07  4.71855572e-06
  2.23071398e-05  1.90191145e-05 -3.39430769e-05 -1.37825032e-03
  3.42184511e-04  3.34486706e-03  2.63197523e-03 -1.01537912e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:03:21 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26183.0315492        1
[INPUT] 0    0    [1    /1   ]  7616.79737371        1
[INPUT] 0    0    [1    /1   ]  3617.81411075        1
[INPUT] 0    0    [1    /1   ]  1583.2345668         1
[INPUT] 0    0    [1    /1   ]  412.371150783        1
[INPUT] 0    0    [1    /1   ]  120.34625359         1
[INPUT] 0    0    [1    /1   ]  38.6651329224        1
[INPUT] 0    0    [1    /1   ]  7.97714031969        1
[INPUT] 0    0    [1    /1   ]  3.13841631321        1
[INPUT] 0    0    [1    /1   ]  0.398766960919       1
[INPUT] 1    0    [1    /1   ]  1362.91737323        1
[INPUT] 1    0    [1    /1   ]  663.493410187        1
[INPUT] 1    0    [1    /1   ]  295.052424033        1
[INPUT] 1    0    [1    /1   ]  308.969786915        1
[INPUT] 1    0    [1    /1   ]  62.2785125119        1
[INPUT] 1    0    [1    /1   ]  7.48091205833        1
[INPUT] 1    0    [1    /1   ]  20.5797185418        1
[INPUT] 1    0    [1    /1   ]  0.78180130627        1
[INPUT] 1    0    [1    /1   ]  2.88968809276        1
[INPUT] 1    0    [1    /1   ]  0.224417001357       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26183.031549238658, 1.0]], [0, [7616.797373709082, 1.0]], [0, [3617.814110745583, 1.0]], [0, [1583.2345667970505, 1.0]], [0, [412.37115078253527, 1.0]], [0, [120.34625358987539, 1.0]], [0, [38.66513292238362, 1.0]], [0, [7.977140319689705, 1.0]], [0, [3.1384163132098113, 1.0]], [0, [0.39876696091903163, 1.0]], [1, [1362.9173732274974, 1.0]], [1, [663.4934101868845, 1.0]], [1, [295.0524240334168, 1.0]], [1, [308.9697869154327, 1.0]], [1, [62.27851251193534, 1.0]], [1, [7.480912058334643, 1.0]], [1, [20.579718541757572, 1.0]], [1, [0.7818013062698683, 1.0]], [1, [2.8896880927630373, 1.0]], [1, [0.22441700135718212, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26183.03154924]
bas 1, expnt(s) = [7616.79737371]
bas 2, expnt(s) = [3617.81411075]
bas 3, expnt(s) = [1583.2345668]
bas 4, expnt(s) = [412.37115078]
bas 5, expnt(s) = [120.34625359]
bas 6, expnt(s) = [38.66513292]
bas 7, expnt(s) = [7.97714032]
bas 8, expnt(s) = [3.13841631]
bas 9, expnt(s) = [0.39876696]
bas 10, expnt(s) = [1362.91737323]
bas 11, expnt(s) = [663.49341019]
bas 12, expnt(s) = [295.05242403]
bas 13, expnt(s) = [308.96978692]
bas 14, expnt(s) = [62.27851251]
bas 15, expnt(s) = [7.48091206]
bas 16, expnt(s) = [20.57971854]
bas 17, expnt(s) = [0.78180131]
bas 18, expnt(s) = [2.88968809]
bas 19, expnt(s) = [0.224417]
CPU time:      2015.18
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61830315e+04 5.20031883e+03 7.61679737e+03 2.05989141e+03
 3.61781411e+03 1.17855461e+03 1.58323457e+03 6.34123681e+02
 4.12371151e+02 2.31196487e+02 1.20346254e+02 9.17993182e+01
 3.86651329e+01 3.91746076e+01 7.97714032e+00 1.19922438e+01
 3.13841631e+00 5.95727898e+00 3.98766961e-01 1.26781066e+00
 1.36291737e+03 2.41585743e+04 6.63493410e+02 9.82381465e+03
 2.95052424e+02 3.56745395e+03 3.08969787e+02 3.77902190e+03
 6.22785125e+01 5.10395905e+02 7.48091206e+00 3.60933821e+01
 2.05797185e+01 1.27874421e+02 7.81801306e-01 2.14464237e+00
 2.88968809e+00 1.09912757e+01 2.24417001e-01 4.50613383e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98266067602382
cond(S) = 86181.61611004449
E1 = -729.3826463767605  E_coul = 203.1244834821787
init E= -526.258162894582
    CPU time for initialize scf      7.59 sec, wall time      0.35 sec
  HOMO = -0.556840498480157  LUMO = 1.0438835286155
  mo_energy =
[-1.18334822e+02 -1.22077143e+01 -9.45143487e+00 -9.45143487e+00
 -9.45143487e+00 -1.22595769e+00 -5.56840498e-01 -5.56840498e-01
 -5.56840498e-01  1.04388353e+00  1.04388353e+00  1.04388353e+00
  7.55005333e+00  7.55005333e+00  7.55005333e+00  9.88721342e+00
  3.43951183e+01  3.43951183e+01  3.43951183e+01  1.15142185e+02
  1.31370523e+02  1.31370523e+02  1.31370523e+02  4.83150621e+02
  4.83150621e+02  4.83150621e+02  6.48144586e+02  1.32344777e+03
  1.32344777e+03  1.32344777e+03  2.77828945e+03  3.00205202e+03
  3.00205202e+03  3.00205202e+03  6.61216503e+03  6.61216503e+03
  6.61216503e+03  9.18765933e+03  2.55291018e+04  7.62587067e+04]
E1 = -727.9887794926835  E_coul = 201.27959066297507
cycle= 1 E= -526.709188829708  delta_E= -0.451  |g|= 0.183  |ddm|=  0.4
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.539286
diis-c [-0.29082921  1.        ]
  HOMO = -0.581330844857052  LUMO = 1.02756555689134
  mo_energy =
[-1.18627285e+02 -1.23312726e+01 -9.58507638e+00 -9.58507638e+00
 -9.58507638e+00 -1.25740238e+00 -5.81330845e-01 -5.81330845e-01
 -5.81330845e-01  1.02756556e+00  1.02756556e+00  1.02756556e+00
  7.47289856e+00  7.47289856e+00  7.47289856e+00  9.79673895e+00
  3.42547329e+01  3.42547329e+01  3.42547329e+01  1.14929059e+02
  1.31157086e+02  1.31157086e+02  1.31157086e+02  4.82860743e+02
  4.82860743e+02  4.82860743e+02  6.47808230e+02  1.32310238e+03
  1.32310238e+03  1.32310238e+03  2.77780900e+03  3.00164070e+03
  3.00164070e+03  3.00164070e+03  6.61164132e+03  6.61164132e+03
  6.61164132e+03  9.18706197e+03  2.55284106e+04  7.62579257e+04]
E1 = -728.4508897279329  E_coul = 201.7411122302177
cycle= 2 E= -526.709777497715  delta_E= -0.000589  |g|= 0.0334  |ddm|= 0.0387
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0669607
diis-c [-0.0026703   0.07349882  0.92650118]
  HOMO = -0.574639130673394  LUMO = 1.03269078372936
  mo_energy =
[-1.18568802e+02 -1.23005486e+01 -9.55304890e+00 -9.55304890e+00
 -9.55304890e+00 -1.24890380e+00 -5.74639131e-01 -5.74639131e-01
 -5.74639131e-01  1.03269078e+00  1.03269078e+00  1.03269078e+00
  7.49160748e+00  7.49160748e+00  7.49160748e+00  9.82110513e+00
  3.42876240e+01  3.42876240e+01  3.42876240e+01  1.14977739e+02
  1.31204513e+02  1.31204513e+02  1.31204513e+02  4.82918377e+02
  4.82918377e+02  4.82918377e+02  6.47868670e+02  1.32316384e+03
  1.32316384e+03  1.32316384e+03  2.77787359e+03  3.00170426e+03
  3.00170426e+03  3.00170426e+03  6.61170646e+03  6.61170646e+03
  6.61170646e+03  9.18712782e+03  2.55284770e+04  7.62579923e+04]
E1 = -728.3462533132964  E_coul = 201.63644130282117
cycle= 3 E= -526.709812010475  delta_E= -3.45e-05  |g|= 0.0048  |ddm|= 0.0102
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104624
diis-c [-4.33092319e-07 -1.10961374e-03  1.30558647e-01  8.70550967e-01]
  HOMO = -0.57555843537582  LUMO = 1.0319977482522
  mo_energy =
[-1.18576338e+02 -1.23045770e+01 -9.55734857e+00 -9.55734857e+00
 -9.55734857e+00 -1.25001943e+00 -5.75558435e-01 -5.75558435e-01
 -5.75558435e-01  1.03199775e+00  1.03199775e+00  1.03199775e+00
  7.48906953e+00  7.48906953e+00  7.48906953e+00  9.81799556e+00
  3.42832417e+01  3.42832417e+01  3.42832417e+01  1.14971472e+02
  1.31198349e+02  1.31198349e+02  1.31198349e+02  4.82910950e+02
  4.82910950e+02  4.82910950e+02  6.47860848e+02  1.32315589e+03
  1.32315589e+03  1.32315589e+03  2.77786506e+03  3.00169597e+03
  3.00169597e+03  3.00169597e+03  6.61169781e+03  6.61169781e+03
  6.61169781e+03  9.18711898e+03  2.55284680e+04  7.62579831e+04]
E1 = -728.3604132702969  E_coul = 201.65060042471907
cycle= 4 E= -526.709812845578  delta_E= -8.35e-07  |g|= 5.94e-05  |ddm|= 0.00131
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000123366
diis-c [-1.30797989e-09  6.39245455e-05 -8.97964752e-03 -7.05972111e-02
  1.07951293e+00]
  HOMO = -0.575546497112736  LUMO = 1.03200670782619
  mo_energy =
[-1.18576342e+02 -1.23045482e+01 -9.55733138e+00 -9.55733138e+00
 -9.55733138e+00 -1.25000046e+00 -5.75546497e-01 -5.75546497e-01
 -5.75546497e-01  1.03200671e+00  1.03200671e+00  1.03200671e+00
  7.48908994e+00  7.48908994e+00  7.48908994e+00  9.81803082e+00
  3.42832575e+01  3.42832575e+01  3.42832575e+01  1.14971482e+02
  1.31198356e+02  1.31198356e+02  1.31198356e+02  4.82910946e+02
  4.82910946e+02  4.82910946e+02  6.47860836e+02  1.32315588e+03
  1.32315588e+03  1.32315588e+03  2.77786503e+03  3.00169594e+03
  3.00169594e+03  3.00169594e+03  6.61169777e+03  6.61169777e+03
  6.61169777e+03  9.18711894e+03  2.55284679e+04  7.62579831e+04]
E1 = -728.360410952381  E_coul = 201.65059810669217
cycle= 5 E= -526.709812845689  delta_E= -1.11e-10  |g|= 7.81e-06  |ddm|= 2.39e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.360410952381  E_coul = 201.65059810669217
  HOMO = -0.575549962675675  LUMO = 1.03200413892035
  mo_energy =
[-1.18576360e+02 -1.23045605e+01 -9.55734421e+00 -9.55734421e+00
 -9.55734421e+00 -1.25000472e+00 -5.75549963e-01 -5.75549963e-01
 -5.75549963e-01  1.03200414e+00  1.03200414e+00  1.03200414e+00
  7.48908141e+00  7.48908141e+00  7.48908141e+00  9.81802087e+00
  3.42832449e+01  3.42832449e+01  3.42832449e+01  1.14971466e+02
  1.31198341e+02  1.31198341e+02  1.31198341e+02  4.82910929e+02
  4.82910929e+02  4.82910929e+02  6.47860818e+02  1.32315586e+03
  1.32315586e+03  1.32315586e+03  2.77786501e+03  3.00169593e+03
  3.00169593e+03  3.00169593e+03  6.61169775e+03  6.61169775e+03
  6.61169775e+03  9.18711892e+03  2.55284679e+04  7.62579831e+04]
E1 = -728.3604494409799  E_coul = 201.65063659528818
Extra cycle  E= -526.709812845692  delta_E= -2.84e-12  |g|= 2.31e-06  |ddm|= 3.99e-06
    CPU time for scf_cycle      7.79 sec, wall time      0.53 sec
exp = [2.61830315e+04 7.61679737e+03 3.61781411e+03 1.58323457e+03
 4.12371151e+02 1.20346254e+02 3.86651329e+01 7.97714032e+00
 3.13841631e+00 3.98766961e-01 1.36291737e+03 6.63493410e+02
 2.95052424e+02 3.08969787e+02 6.22785125e+01 7.48091206e+00
 2.05797185e+01 7.81801306e-01 2.88968809e+00 2.24417001e-01]
E = -526.7098128456917
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:03:22 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26183.0315492        1
[INPUT] 0    0    [1    /1   ]  7616.79737371        1
[INPUT] 0    0    [1    /1   ]  3617.81411075        1
[INPUT] 0    0    [1    /1   ]  1583.2345668         1
[INPUT] 0    0    [1    /1   ]  412.371150783        1
[INPUT] 0    0    [1    /1   ]  120.34625359         1
[INPUT] 0    0    [1    /1   ]  38.6651329224        1
[INPUT] 0    0    [1    /1   ]  7.97714031969        1
[INPUT] 0    0    [1    /1   ]  3.13841631321        1
[INPUT] 0    0    [1    /1   ]  0.398766960919       1
[INPUT] 1    0    [1    /1   ]  1362.91737323        1
[INPUT] 1    0    [1    /1   ]  663.493410187        1
[INPUT] 1    0    [1    /1   ]  295.052424033        1
[INPUT] 1    0    [1    /1   ]  308.969786915        1
[INPUT] 1    0    [1    /1   ]  62.2785125119        1
[INPUT] 1    0    [1    /1   ]  7.48091205833        1
[INPUT] 1    0    [1    /1   ]  20.5797185418        1
[INPUT] 1    0    [1    /1   ]  0.78180130627        1
[INPUT] 1    0    [1    /1   ]  2.88968809276        1
[INPUT] 1    0    [1    /1   ]  0.224417001357       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26183.031549238658, 1.0]], [0, [7616.797373709082, 1.0]], [0, [3617.814110745583, 1.0]], [0, [1583.2345667970505, 1.0]], [0, [412.37115078253527, 1.0]], [0, [120.34625358987539, 1.0]], [0, [38.66513292238362, 1.0]], [0, [7.977140319689705, 1.0]], [0, [3.1384163132098113, 1.0]], [0, [0.39876696091903163, 1.0]], [1, [1362.9173732274974, 1.0]], [1, [663.4934101868845, 1.0]], [1, [295.0524240334168, 1.0]], [1, [308.9697869154327, 1.0]], [1, [62.27851251193534, 1.0]], [1, [7.480912058334643, 1.0]], [1, [20.579718541757572, 1.0]], [1, [0.7818013062698683, 1.0]], [1, [2.8896880927630373, 1.0]], [1, [0.22441700135718212, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26183.03154924]
bas 1, expnt(s) = [7616.79737371]
bas 2, expnt(s) = [3617.81411075]
bas 3, expnt(s) = [1583.2345668]
bas 4, expnt(s) = [412.37115078]
bas 5, expnt(s) = [120.34625359]
bas 6, expnt(s) = [38.66513292]
bas 7, expnt(s) = [7.97714032]
bas 8, expnt(s) = [3.13841631]
bas 9, expnt(s) = [0.39876696]
bas 10, expnt(s) = [1362.91737323]
bas 11, expnt(s) = [663.49341019]
bas 12, expnt(s) = [295.05242403]
bas 13, expnt(s) = [308.96978692]
bas 14, expnt(s) = [62.27851251]
bas 15, expnt(s) = [7.48091206]
bas 16, expnt(s) = [20.57971854]
bas 17, expnt(s) = [0.78180131]
bas 18, expnt(s) = [2.88968809]
bas 19, expnt(s) = [0.224417]
CPU time:      2023.30
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61830315e+04 5.20031883e+03 7.61679737e+03 2.05989141e+03
 3.61781411e+03 1.17855461e+03 1.58323457e+03 6.34123681e+02
 4.12371151e+02 2.31196487e+02 1.20346254e+02 9.17993182e+01
 3.86651329e+01 3.91746076e+01 7.97714032e+00 1.19922438e+01
 3.13841631e+00 5.95727898e+00 3.98766961e-01 1.26781066e+00
 1.36291737e+03 2.41585743e+04 6.63493410e+02 9.82381465e+03
 2.95052424e+02 3.56745395e+03 3.08969787e+02 3.77902190e+03
 6.22785125e+01 5.10395905e+02 7.48091206e+00 3.60933821e+01
 2.05797185e+01 1.27874421e+02 7.81801306e-01 2.14464237e+00
 2.88968809e+00 1.09912757e+01 2.24417001e-01 4.50613383e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98266067602382
cond(S) = 86181.61611004449
E1 = -729.3826463767605  E_coul = 203.1244834821787
init E= -526.258162894582
    CPU time for initialize scf      7.35 sec, wall time      0.34 sec
  HOMO = -0.556840498480157  LUMO = 1.0438835286155
  mo_energy =
[-1.18334822e+02 -1.22077143e+01 -9.45143487e+00 -9.45143487e+00
 -9.45143487e+00 -1.22595769e+00 -5.56840498e-01 -5.56840498e-01
 -5.56840498e-01  1.04388353e+00  1.04388353e+00  1.04388353e+00
  7.55005333e+00  7.55005333e+00  7.55005333e+00  9.88721342e+00
  3.43951183e+01  3.43951183e+01  3.43951183e+01  1.15142185e+02
  1.31370523e+02  1.31370523e+02  1.31370523e+02  4.83150621e+02
  4.83150621e+02  4.83150621e+02  6.48144586e+02  1.32344777e+03
  1.32344777e+03  1.32344777e+03  2.77828945e+03  3.00205202e+03
  3.00205202e+03  3.00205202e+03  6.61216503e+03  6.61216503e+03
  6.61216503e+03  9.18765933e+03  2.55291018e+04  7.62587067e+04]
E1 = -727.9887794926835  E_coul = 201.27959066297507
cycle= 1 E= -526.709188829708  delta_E= -0.451  |g|= 0.183  |ddm|=  0.4
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.539286
diis-c [-0.29082921  1.        ]
  HOMO = -0.581330844857052  LUMO = 1.02756555689134
  mo_energy =
[-1.18627285e+02 -1.23312726e+01 -9.58507638e+00 -9.58507638e+00
 -9.58507638e+00 -1.25740238e+00 -5.81330845e-01 -5.81330845e-01
 -5.81330845e-01  1.02756556e+00  1.02756556e+00  1.02756556e+00
  7.47289856e+00  7.47289856e+00  7.47289856e+00  9.79673895e+00
  3.42547329e+01  3.42547329e+01  3.42547329e+01  1.14929059e+02
  1.31157086e+02  1.31157086e+02  1.31157086e+02  4.82860743e+02
  4.82860743e+02  4.82860743e+02  6.47808230e+02  1.32310238e+03
  1.32310238e+03  1.32310238e+03  2.77780900e+03  3.00164070e+03
  3.00164070e+03  3.00164070e+03  6.61164132e+03  6.61164132e+03
  6.61164132e+03  9.18706197e+03  2.55284106e+04  7.62579257e+04]
E1 = -728.4508897279329  E_coul = 201.7411122302177
cycle= 2 E= -526.709777497715  delta_E= -0.000589  |g|= 0.0334  |ddm|= 0.0387
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0669607
diis-c [-0.0026703   0.07349882  0.92650118]
  HOMO = -0.574639130673394  LUMO = 1.03269078372936
  mo_energy =
[-1.18568802e+02 -1.23005486e+01 -9.55304890e+00 -9.55304890e+00
 -9.55304890e+00 -1.24890380e+00 -5.74639131e-01 -5.74639131e-01
 -5.74639131e-01  1.03269078e+00  1.03269078e+00  1.03269078e+00
  7.49160748e+00  7.49160748e+00  7.49160748e+00  9.82110513e+00
  3.42876240e+01  3.42876240e+01  3.42876240e+01  1.14977739e+02
  1.31204513e+02  1.31204513e+02  1.31204513e+02  4.82918377e+02
  4.82918377e+02  4.82918377e+02  6.47868670e+02  1.32316384e+03
  1.32316384e+03  1.32316384e+03  2.77787359e+03  3.00170426e+03
  3.00170426e+03  3.00170426e+03  6.61170646e+03  6.61170646e+03
  6.61170646e+03  9.18712782e+03  2.55284770e+04  7.62579923e+04]
E1 = -728.3462533132964  E_coul = 201.63644130282117
cycle= 3 E= -526.709812010475  delta_E= -3.45e-05  |g|= 0.0048  |ddm|= 0.0102
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104624
diis-c [-4.33092319e-07 -1.10961374e-03  1.30558647e-01  8.70550967e-01]
  HOMO = -0.57555843537582  LUMO = 1.0319977482522
  mo_energy =
[-1.18576338e+02 -1.23045770e+01 -9.55734857e+00 -9.55734857e+00
 -9.55734857e+00 -1.25001943e+00 -5.75558435e-01 -5.75558435e-01
 -5.75558435e-01  1.03199775e+00  1.03199775e+00  1.03199775e+00
  7.48906953e+00  7.48906953e+00  7.48906953e+00  9.81799556e+00
  3.42832417e+01  3.42832417e+01  3.42832417e+01  1.14971472e+02
  1.31198349e+02  1.31198349e+02  1.31198349e+02  4.82910950e+02
  4.82910950e+02  4.82910950e+02  6.47860848e+02  1.32315589e+03
  1.32315589e+03  1.32315589e+03  2.77786506e+03  3.00169597e+03
  3.00169597e+03  3.00169597e+03  6.61169781e+03  6.61169781e+03
  6.61169781e+03  9.18711898e+03  2.55284680e+04  7.62579831e+04]
E1 = -728.3604132702969  E_coul = 201.65060042471907
cycle= 4 E= -526.709812845578  delta_E= -8.35e-07  |g|= 5.94e-05  |ddm|= 0.00131
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000123366
diis-c [-1.30797989e-09  6.39245455e-05 -8.97964752e-03 -7.05972111e-02
  1.07951293e+00]
  HOMO = -0.575546497112736  LUMO = 1.03200670782619
  mo_energy =
[-1.18576342e+02 -1.23045482e+01 -9.55733138e+00 -9.55733138e+00
 -9.55733138e+00 -1.25000046e+00 -5.75546497e-01 -5.75546497e-01
 -5.75546497e-01  1.03200671e+00  1.03200671e+00  1.03200671e+00
  7.48908994e+00  7.48908994e+00  7.48908994e+00  9.81803082e+00
  3.42832575e+01  3.42832575e+01  3.42832575e+01  1.14971482e+02
  1.31198356e+02  1.31198356e+02  1.31198356e+02  4.82910946e+02
  4.82910946e+02  4.82910946e+02  6.47860836e+02  1.32315588e+03
  1.32315588e+03  1.32315588e+03  2.77786503e+03  3.00169594e+03
  3.00169594e+03  3.00169594e+03  6.61169777e+03  6.61169777e+03
  6.61169777e+03  9.18711894e+03  2.55284679e+04  7.62579831e+04]
E1 = -728.360410952381  E_coul = 201.65059810669217
cycle= 5 E= -526.709812845689  delta_E= -1.11e-10  |g|= 7.81e-06  |ddm|= 2.39e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.360410952381  E_coul = 201.65059810669217
  HOMO = -0.575549962675675  LUMO = 1.03200413892035
  mo_energy =
[-1.18576360e+02 -1.23045605e+01 -9.55734421e+00 -9.55734421e+00
 -9.55734421e+00 -1.25000472e+00 -5.75549963e-01 -5.75549963e-01
 -5.75549963e-01  1.03200414e+00  1.03200414e+00  1.03200414e+00
  7.48908141e+00  7.48908141e+00  7.48908141e+00  9.81802087e+00
  3.42832449e+01  3.42832449e+01  3.42832449e+01  1.14971466e+02
  1.31198341e+02  1.31198341e+02  1.31198341e+02  4.82910929e+02
  4.82910929e+02  4.82910929e+02  6.47860818e+02  1.32315586e+03
  1.32315586e+03  1.32315586e+03  2.77786501e+03  3.00169593e+03
  3.00169593e+03  3.00169593e+03  6.61169775e+03  6.61169775e+03
  6.61169775e+03  9.18711892e+03  2.55284679e+04  7.62579831e+04]
E1 = -728.3604494409799  E_coul = 201.65063659528818
Extra cycle  E= -526.709812845692  delta_E= -2.84e-12  |g|= 2.31e-06  |ddm|= 3.99e-06
    CPU time for scf_cycle      7.55 sec, wall time      0.52 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 86181.61611004449
E1 = -728.3604494409799  E_coul = 201.65063659528818
init E= -526.709812845692
    CPU time for initialize scf     16.30 sec, wall time      0.76 sec
  HOMO = -0.575549259254401  LUMO = 1.03200466662601
  mo_energy =
[-1.18576355e+02 -1.23045576e+01 -9.55734129e+00 -9.55734129e+00
 -9.55734129e+00 -1.25000384e+00 -5.75549259e-01 -5.75549259e-01
 -5.75549259e-01  1.03200467e+00  1.03200467e+00  1.03200467e+00
  7.48908323e+00  7.48908323e+00  7.48908323e+00  9.81802314e+00
  3.42832478e+01  3.42832478e+01  3.42832478e+01  1.14971470e+02
  1.31198345e+02  1.31198345e+02  1.31198345e+02  4.82910934e+02
  4.82910934e+02  4.82910934e+02  6.47860823e+02  1.32315587e+03
  1.32315587e+03  1.32315587e+03  2.77786502e+03  3.00169593e+03
  3.00169593e+03  3.00169593e+03  6.61169776e+03  6.61169776e+03
  6.61169776e+03  9.18711892e+03  2.55284679e+04  7.62579831e+04]
E1 = -728.3604402946266  E_coul = 201.65062744893365
cycle= 1 E= -526.709812845693  delta_E= -1.36e-12  |g|= 5.92e-07  |ddm|= 9.14e-07
    CPU time for cycle= 1      0.04 sec, wall time      0.02 sec
E1 = -728.3604402946266  E_coul = 201.65062744893365
  HOMO = -0.575549414795708  LUMO = 1.03200454925856
  mo_energy =
[-1.18576356e+02 -1.23045583e+01 -9.55734198e+00 -9.55734198e+00
 -9.55734198e+00 -1.25000403e+00 -5.75549415e-01 -5.75549415e-01
 -5.75549415e-01  1.03200455e+00  1.03200455e+00  1.03200455e+00
  7.48908281e+00  7.48908281e+00  7.48908281e+00  9.81802261e+00
  3.42832471e+01  3.42832471e+01  3.42832471e+01  1.14971469e+02
  1.31198344e+02  1.31198344e+02  1.31198344e+02  4.82910933e+02
  4.82910933e+02  4.82910933e+02  6.47860822e+02  1.32315587e+03
  1.32315587e+03  1.32315587e+03  2.77786501e+03  3.00169593e+03
  3.00169593e+03  3.00169593e+03  6.61169776e+03  6.61169776e+03
  6.61169776e+03  9.18711892e+03  2.55284679e+04  7.62579831e+04]
E1 = -728.3604425233659  E_coul = 201.65062967767307
Extra cycle  E= -526.709812845693  delta_E= 2.27e-13  |g|= 1.49e-07  |ddm|= 2.14e-07
    CPU time for scf_cycle     16.42 sec, wall time      0.87 sec
exp = [2.61830315e+04 7.61679737e+03 3.61781411e+03 1.58323457e+03
 4.12371151e+02 1.20346254e+02 3.86651329e+01 7.97714032e+00
 3.13841631e+00 3.98766961e-01 1.36291737e+03 6.63493410e+02
 2.95052424e+02 3.08969787e+02 6.22785125e+01 7.48091206e+00
 2.05797185e+01 7.81801306e-01 2.88968809e+00 2.24417001e-01]
grad_E = [-1.41248216e-06  2.28690606e-06 -2.16599755e-06  4.12175100e-05
 -8.73081449e-06  6.05157621e-05 -1.93823940e-04 -4.45505062e-04
  5.54860431e-04  3.17304891e-03 -5.76555807e-07  4.43174647e-06
  2.08295914e-05  1.76526093e-05 -3.58272968e-05 -2.26724833e-03
  5.71330567e-04  5.49777511e-03  4.32665461e-03 -1.67267717e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:03:27 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26183.3419722        1
[INPUT] 0    0    [1    /1   ]  7616.30751696        1
[INPUT] 0    0    [1    /1   ]  3618.28574875        1
[INPUT] 0    0    [1    /1   ]  1574.72297113        1
[INPUT] 0    0    [1    /1   ]  409.49011786         1
[INPUT] 0    0    [1    /1   ]  119.654383368        1
[INPUT] 0    0    [1    /1   ]  38.4990679438        1
[INPUT] 0    0    [1    /1   ]  7.92350983693        1
[INPUT] 0    0    [1    /1   ]  3.12318232575        1
[INPUT] 0    0    [1    /1   ]  0.398906358057       1
[INPUT] 1    0    [1    /1   ]  1363.03427562        1
[INPUT] 1    0    [1    /1   ]  662.413775193        1
[INPUT] 1    0    [1    /1   ]  289.93881891         1
[INPUT] 1    0    [1    /1   ]  304.594493815        1
[INPUT] 1    0    [1    /1   ]  62.8211552125        1
[INPUT] 1    0    [1    /1   ]  7.58659310103        1
[INPUT] 1    0    [1    /1   ]  20.850249363         1
[INPUT] 1    0    [1    /1   ]  0.787440792459       1
[INPUT] 1    0    [1    /1   ]  2.93852763711        1
[INPUT] 1    0    [1    /1   ]  0.225321269254       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26183.341972203096, 1.0]], [0, [7616.307516955843, 1.0]], [0, [3618.285748745696, 1.0]], [0, [1574.7229711313146, 1.0]], [0, [409.49011785981895, 1.0]], [0, [119.65438336838274, 1.0]], [0, [38.499067943776666, 1.0]], [0, [7.923509836926592, 1.0]], [0, [3.123182325746793, 1.0]], [0, [0.3989063580570012, 1.0]], [1, [1363.03427562249, 1.0]], [1, [662.4137751928699, 1.0]], [1, [289.93881891011006, 1.0]], [1, [304.5944938150422, 1.0]], [1, [62.82115521250069, 1.0]], [1, [7.586593101030917, 1.0]], [1, [20.850249362952976, 1.0]], [1, [0.7874407924593443, 1.0]], [1, [2.9385276371146425, 1.0]], [1, [0.2253212692544636, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26183.3419722]
bas 1, expnt(s) = [7616.30751696]
bas 2, expnt(s) = [3618.28574875]
bas 3, expnt(s) = [1574.72297113]
bas 4, expnt(s) = [409.49011786]
bas 5, expnt(s) = [119.65438337]
bas 6, expnt(s) = [38.49906794]
bas 7, expnt(s) = [7.92350984]
bas 8, expnt(s) = [3.12318233]
bas 9, expnt(s) = [0.39890636]
bas 10, expnt(s) = [1363.03427562]
bas 11, expnt(s) = [662.41377519]
bas 12, expnt(s) = [289.93881891]
bas 13, expnt(s) = [304.59449382]
bas 14, expnt(s) = [62.82115521]
bas 15, expnt(s) = [7.5865931]
bas 16, expnt(s) = [20.85024936]
bas 17, expnt(s) = [0.78744079]
bas 18, expnt(s) = [2.93852764]
bas 19, expnt(s) = [0.22532127]
CPU time:      2052.21
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61833420e+04 5.20036507e+03 7.61630752e+03 2.05979205e+03
 3.61828575e+03 1.17866984e+03 1.57472297e+03 6.31565134e+02
 4.09490118e+02 2.29983984e+02 1.19654383e+02 9.14032176e+01
 3.84990679e+01 3.90483499e+01 7.92350984e+00 1.19317247e+01
 3.12318233e+00 5.93557816e+00 3.98906358e-01 1.26814304e+00
 1.36303428e+03 2.41611646e+04 6.62413775e+02 9.80383710e+03
 2.89938819e+02 3.49033691e+03 3.04594494e+02 3.71224775e+03
 6.28211552e+01 5.15960899e+02 7.58659310e+00 3.67318568e+01
 2.08502494e+01 1.29979080e+02 7.87440792e-01 2.16399762e+00
 2.93852764e+00 1.12239731e+01 2.25321269e-01 4.52884158e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982473073812677
cond(S) = 73938.82402467662
E1 = -729.3853554315286  E_coul = 203.12635295418139
init E= -526.259002477347
    CPU time for initialize scf      7.35 sec, wall time      0.35 sec
  HOMO = -0.556759926747824  LUMO = 1.05262735099814
  mo_energy =
[-1.18334747e+02 -1.22076472e+01 -9.45132134e+00 -9.45132134e+00
 -9.45132134e+00 -1.22590058e+00 -5.56759927e-01 -5.56759927e-01
 -5.56759927e-01  1.05262735e+00  1.05262735e+00  1.05262735e+00
  7.68926877e+00  7.68926877e+00  7.68926877e+00  9.78347146e+00
  3.50125381e+01  3.50125381e+01  3.50125381e+01  1.14222559e+02
  1.33047600e+02  1.33047600e+02  1.33047600e+02  4.82508012e+02
  4.82508012e+02  4.82508012e+02  6.43419362e+02  1.31274005e+03
  1.31274005e+03  1.31274005e+03  2.76229275e+03  2.97775505e+03
  2.97775505e+03  2.97775505e+03  6.57896868e+03  6.57896868e+03
  6.57896868e+03  9.15661818e+03  2.54881569e+04  7.62154027e+04]
E1 = -727.9923203539404  E_coul = 201.28281632456236
cycle= 1 E= -526.709504029378  delta_E= -0.451  |g|= 0.183  |ddm|= 0.393
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.540499
diis-c [-0.29213876  1.        ]
  HOMO = -0.581281018148741  LUMO = 1.03609174993666
  mo_energy =
[-1.18626975e+02 -1.23310290e+01 -9.58483214e+00 -9.58483214e+00
 -9.58483214e+00 -1.25738270e+00 -5.81281018e-01 -5.81281018e-01
 -5.81281018e-01  1.03609175e+00  1.03609175e+00  1.03609175e+00
  7.61120920e+00  7.61120920e+00  7.61120920e+00  9.69353929e+00
  3.48714693e+01  3.48714693e+01  3.48714693e+01  1.14010167e+02
  1.32834056e+02  1.32834056e+02  1.32834056e+02  4.82219357e+02
  4.82219357e+02  4.82219357e+02  6.43083892e+02  1.31239598e+03
  1.31239598e+03  1.31239598e+03  2.76181298e+03  2.97734451e+03
  2.97734451e+03  2.97734451e+03  6.57844521e+03  6.57844521e+03
  6.57844521e+03  9.15602107e+03  2.54874658e+04  7.62146217e+04]
E1 = -728.4539861469719  E_coul = 201.74389401740467
cycle= 2 E= -526.710092129567  delta_E= -0.000588  |g|= 0.0333  |ddm|= 0.0387
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0671434
diis-c [-0.00267417  0.07373049  0.92626951]
  HOMO = -0.57460232446099  LUMO = 1.04125987148533
  mo_energy =
[-1.18568556e+02 -1.23003409e+01 -9.55283953e+00 -9.55283953e+00
 -9.55283953e+00 -1.24889958e+00 -5.74602324e-01 -5.74602324e-01
 -5.74602324e-01  1.04125987e+00  1.04125987e+00  1.04125987e+00
  7.63009717e+00  7.63009717e+00  7.63009717e+00  9.71776585e+00
  3.49045025e+01  3.49045025e+01  3.49045025e+01  1.14058719e+02
  1.32881493e+02  1.32881493e+02  1.32881493e+02  4.82276844e+02
  4.82276844e+02  4.82276844e+02  6.43144230e+02  1.31245731e+03
  1.31245731e+03  1.31245731e+03  2.76187748e+03  2.97740798e+03
  2.97740798e+03  2.97740798e+03  6.57851027e+03  6.57851027e+03
  6.57851027e+03  9.15608683e+03  2.54875320e+04  7.62146882e+04]
E1 = -728.3494371421034  E_coul = 201.63931052295843
cycle= 3 E= -526.710126619145  delta_E= -3.45e-05  |g|= 0.00479  |ddm|= 0.0102
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104779
diis-c [-4.39630953e-07 -1.11377004e-03  1.30379162e-01  8.70734608e-01]
  HOMO = -0.575519602613627  LUMO = 1.040561289778
  mo_energy =
[-1.18576073e+02 -1.23043593e+01 -9.55712967e+00 -9.55712967e+00
 -9.55712967e+00 -1.25001232e+00 -5.75519603e-01 -5.75519603e-01
 -5.75519603e-01  1.04056129e+00  1.04056129e+00  1.04056129e+00
  7.62753709e+00  7.62753709e+00  7.62753709e+00  9.71467820e+00
  3.49001079e+01  3.49001079e+01  3.49001079e+01  1.14052478e+02
  1.32875336e+02  1.32875336e+02  1.32875336e+02  4.82269446e+02
  4.82269446e+02  4.82269446e+02  6.43136432e+02  1.31244939e+03
  1.31244939e+03  1.31244939e+03  2.76186897e+03  2.97739971e+03
  2.97739971e+03  2.97739971e+03  6.57850164e+03  6.57850164e+03
  6.57850164e+03  9.15607801e+03  2.54875230e+04  7.62146791e+04]
E1 = -728.3635693889951  E_coul = 201.65344193764238
cycle= 4 E= -526.710127451353  delta_E= -8.32e-07  |g|= 5.98e-05  |ddm|= 0.00131
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000124463
diis-c [-1.31251015e-09  6.39547856e-05 -8.96677156e-03 -7.06896129e-02
  1.07959243e+00]
  HOMO = -0.575507587265774  LUMO = 1.04057038414246
  mo_energy =
[-1.18576077e+02 -1.23043303e+01 -9.55711232e+00 -9.55711232e+00
 -9.55711232e+00 -1.24999318e+00 -5.75507587e-01 -5.75507587e-01
 -5.75507587e-01  1.04057038e+00  1.04057038e+00  1.04057038e+00
  7.62755766e+00  7.62755766e+00  7.62755766e+00  9.71471376e+00
  3.49001239e+01  3.49001239e+01  3.49001239e+01  1.14052488e+02
  1.32875343e+02  1.32875343e+02  1.32875343e+02  4.82269443e+02
  4.82269443e+02  4.82269443e+02  6.43136420e+02  1.31244938e+03
  1.31244938e+03  1.31244938e+03  2.76186894e+03  2.97739969e+03
  2.97739969e+03  2.97739969e+03  6.57850160e+03  6.57850160e+03
  6.57850160e+03  9.15607797e+03  2.54875230e+04  7.62146790e+04]
E1 = -728.3635666889229  E_coul = 201.6534392374591
cycle= 5 E= -526.710127451464  delta_E= -1.11e-10  |g|= 7.89e-06  |ddm|= 2.44e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3635666889229  E_coul = 201.6534392374591
  HOMO = -0.575511079520861  LUMO = 1.04056776988164
  mo_energy =
[-1.18576095e+02 -1.23043427e+01 -9.55712526e+00 -9.55712526e+00
 -9.55712526e+00 -1.24999748e+00 -5.75511080e-01 -5.75511080e-01
 -5.75511080e-01  1.04056777e+00  1.04056777e+00  1.04056777e+00
  7.62754898e+00  7.62754898e+00  7.62754898e+00  9.71470375e+00
  3.49001110e+01  3.49001110e+01  3.49001110e+01  1.14052473e+02
  1.32875328e+02  1.32875328e+02  1.32875328e+02  4.82269426e+02
  4.82269426e+02  4.82269426e+02  6.43136402e+02  1.31244936e+03
  1.31244936e+03  1.31244936e+03  2.76186892e+03  2.97739967e+03
  2.97739967e+03  2.97739967e+03  6.57850158e+03  6.57850158e+03
  6.57850158e+03  9.15607795e+03  2.54875230e+04  7.62146790e+04]
E1 = -728.3636055570959  E_coul = 201.65347810562787
Extra cycle  E= -526.710127451468  delta_E= -4.21e-12  |g|= 2.33e-06  |ddm|= 4.03e-06
    CPU time for scf_cycle      7.55 sec, wall time      0.53 sec
exp = [2.61833420e+04 7.61630752e+03 3.61828575e+03 1.57472297e+03
 4.09490118e+02 1.19654383e+02 3.84990679e+01 7.92350984e+00
 3.12318233e+00 3.98906358e-01 1.36303428e+03 6.62413775e+02
 2.89938819e+02 3.04594494e+02 6.28211552e+01 7.58659310e+00
 2.08502494e+01 7.87440792e-01 2.93852764e+00 2.25321269e-01]
E = -526.710127451468
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:03:28 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26183.3419722        1
[INPUT] 0    0    [1    /1   ]  7616.30751696        1
[INPUT] 0    0    [1    /1   ]  3618.28574875        1
[INPUT] 0    0    [1    /1   ]  1574.72297113        1
[INPUT] 0    0    [1    /1   ]  409.49011786         1
[INPUT] 0    0    [1    /1   ]  119.654383368        1
[INPUT] 0    0    [1    /1   ]  38.4990679438        1
[INPUT] 0    0    [1    /1   ]  7.92350983693        1
[INPUT] 0    0    [1    /1   ]  3.12318232575        1
[INPUT] 0    0    [1    /1   ]  0.398906358057       1
[INPUT] 1    0    [1    /1   ]  1363.03427562        1
[INPUT] 1    0    [1    /1   ]  662.413775193        1
[INPUT] 1    0    [1    /1   ]  289.93881891         1
[INPUT] 1    0    [1    /1   ]  304.594493815        1
[INPUT] 1    0    [1    /1   ]  62.8211552125        1
[INPUT] 1    0    [1    /1   ]  7.58659310103        1
[INPUT] 1    0    [1    /1   ]  20.850249363         1
[INPUT] 1    0    [1    /1   ]  0.787440792459       1
[INPUT] 1    0    [1    /1   ]  2.93852763711        1
[INPUT] 1    0    [1    /1   ]  0.225321269254       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26183.341972203096, 1.0]], [0, [7616.307516955843, 1.0]], [0, [3618.285748745696, 1.0]], [0, [1574.7229711313146, 1.0]], [0, [409.49011785981895, 1.0]], [0, [119.65438336838274, 1.0]], [0, [38.499067943776666, 1.0]], [0, [7.923509836926592, 1.0]], [0, [3.123182325746793, 1.0]], [0, [0.3989063580570012, 1.0]], [1, [1363.03427562249, 1.0]], [1, [662.4137751928699, 1.0]], [1, [289.93881891011006, 1.0]], [1, [304.5944938150422, 1.0]], [1, [62.82115521250069, 1.0]], [1, [7.586593101030917, 1.0]], [1, [20.850249362952976, 1.0]], [1, [0.7874407924593443, 1.0]], [1, [2.9385276371146425, 1.0]], [1, [0.2253212692544636, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26183.3419722]
bas 1, expnt(s) = [7616.30751696]
bas 2, expnt(s) = [3618.28574875]
bas 3, expnt(s) = [1574.72297113]
bas 4, expnt(s) = [409.49011786]
bas 5, expnt(s) = [119.65438337]
bas 6, expnt(s) = [38.49906794]
bas 7, expnt(s) = [7.92350984]
bas 8, expnt(s) = [3.12318233]
bas 9, expnt(s) = [0.39890636]
bas 10, expnt(s) = [1363.03427562]
bas 11, expnt(s) = [662.41377519]
bas 12, expnt(s) = [289.93881891]
bas 13, expnt(s) = [304.59449382]
bas 14, expnt(s) = [62.82115521]
bas 15, expnt(s) = [7.5865931]
bas 16, expnt(s) = [20.85024936]
bas 17, expnt(s) = [0.78744079]
bas 18, expnt(s) = [2.93852764]
bas 19, expnt(s) = [0.22532127]
CPU time:      2060.13
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61833420e+04 5.20036507e+03 7.61630752e+03 2.05979205e+03
 3.61828575e+03 1.17866984e+03 1.57472297e+03 6.31565134e+02
 4.09490118e+02 2.29983984e+02 1.19654383e+02 9.14032176e+01
 3.84990679e+01 3.90483499e+01 7.92350984e+00 1.19317247e+01
 3.12318233e+00 5.93557816e+00 3.98906358e-01 1.26814304e+00
 1.36303428e+03 2.41611646e+04 6.62413775e+02 9.80383710e+03
 2.89938819e+02 3.49033691e+03 3.04594494e+02 3.71224775e+03
 6.28211552e+01 5.15960899e+02 7.58659310e+00 3.67318568e+01
 2.08502494e+01 1.29979080e+02 7.87440792e-01 2.16399762e+00
 2.93852764e+00 1.12239731e+01 2.25321269e-01 4.52884158e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982473073812677
cond(S) = 73938.82402467662
E1 = -729.3853554315286  E_coul = 203.12635295418139
init E= -526.259002477347
    CPU time for initialize scf      7.22 sec, wall time      0.35 sec
  HOMO = -0.556759926747824  LUMO = 1.05262735099814
  mo_energy =
[-1.18334747e+02 -1.22076472e+01 -9.45132134e+00 -9.45132134e+00
 -9.45132134e+00 -1.22590058e+00 -5.56759927e-01 -5.56759927e-01
 -5.56759927e-01  1.05262735e+00  1.05262735e+00  1.05262735e+00
  7.68926877e+00  7.68926877e+00  7.68926877e+00  9.78347146e+00
  3.50125381e+01  3.50125381e+01  3.50125381e+01  1.14222559e+02
  1.33047600e+02  1.33047600e+02  1.33047600e+02  4.82508012e+02
  4.82508012e+02  4.82508012e+02  6.43419362e+02  1.31274005e+03
  1.31274005e+03  1.31274005e+03  2.76229275e+03  2.97775505e+03
  2.97775505e+03  2.97775505e+03  6.57896868e+03  6.57896868e+03
  6.57896868e+03  9.15661818e+03  2.54881569e+04  7.62154027e+04]
E1 = -727.9923203539404  E_coul = 201.28281632456236
cycle= 1 E= -526.709504029378  delta_E= -0.451  |g|= 0.183  |ddm|= 0.393
    CPU time for cycle= 1      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.540499
diis-c [-0.29213876  1.        ]
  HOMO = -0.581281018148741  LUMO = 1.03609174993666
  mo_energy =
[-1.18626975e+02 -1.23310290e+01 -9.58483214e+00 -9.58483214e+00
 -9.58483214e+00 -1.25738270e+00 -5.81281018e-01 -5.81281018e-01
 -5.81281018e-01  1.03609175e+00  1.03609175e+00  1.03609175e+00
  7.61120920e+00  7.61120920e+00  7.61120920e+00  9.69353929e+00
  3.48714693e+01  3.48714693e+01  3.48714693e+01  1.14010167e+02
  1.32834056e+02  1.32834056e+02  1.32834056e+02  4.82219357e+02
  4.82219357e+02  4.82219357e+02  6.43083892e+02  1.31239598e+03
  1.31239598e+03  1.31239598e+03  2.76181298e+03  2.97734451e+03
  2.97734451e+03  2.97734451e+03  6.57844521e+03  6.57844521e+03
  6.57844521e+03  9.15602107e+03  2.54874658e+04  7.62146217e+04]
E1 = -728.4539861469719  E_coul = 201.74389401740467
cycle= 2 E= -526.710092129567  delta_E= -0.000588  |g|= 0.0333  |ddm|= 0.0387
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0671434
diis-c [-0.00267417  0.07373049  0.92626951]
  HOMO = -0.57460232446099  LUMO = 1.04125987148533
  mo_energy =
[-1.18568556e+02 -1.23003409e+01 -9.55283953e+00 -9.55283953e+00
 -9.55283953e+00 -1.24889958e+00 -5.74602324e-01 -5.74602324e-01
 -5.74602324e-01  1.04125987e+00  1.04125987e+00  1.04125987e+00
  7.63009717e+00  7.63009717e+00  7.63009717e+00  9.71776585e+00
  3.49045025e+01  3.49045025e+01  3.49045025e+01  1.14058719e+02
  1.32881493e+02  1.32881493e+02  1.32881493e+02  4.82276844e+02
  4.82276844e+02  4.82276844e+02  6.43144230e+02  1.31245731e+03
  1.31245731e+03  1.31245731e+03  2.76187748e+03  2.97740798e+03
  2.97740798e+03  2.97740798e+03  6.57851027e+03  6.57851027e+03
  6.57851027e+03  9.15608683e+03  2.54875320e+04  7.62146882e+04]
E1 = -728.3494371421034  E_coul = 201.63931052295843
cycle= 3 E= -526.710126619145  delta_E= -3.45e-05  |g|= 0.00479  |ddm|= 0.0102
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0104779
diis-c [-4.39630953e-07 -1.11377004e-03  1.30379162e-01  8.70734608e-01]
  HOMO = -0.575519602613627  LUMO = 1.040561289778
  mo_energy =
[-1.18576073e+02 -1.23043593e+01 -9.55712967e+00 -9.55712967e+00
 -9.55712967e+00 -1.25001232e+00 -5.75519603e-01 -5.75519603e-01
 -5.75519603e-01  1.04056129e+00  1.04056129e+00  1.04056129e+00
  7.62753709e+00  7.62753709e+00  7.62753709e+00  9.71467820e+00
  3.49001079e+01  3.49001079e+01  3.49001079e+01  1.14052478e+02
  1.32875336e+02  1.32875336e+02  1.32875336e+02  4.82269446e+02
  4.82269446e+02  4.82269446e+02  6.43136432e+02  1.31244939e+03
  1.31244939e+03  1.31244939e+03  2.76186897e+03  2.97739971e+03
  2.97739971e+03  2.97739971e+03  6.57850164e+03  6.57850164e+03
  6.57850164e+03  9.15607801e+03  2.54875230e+04  7.62146791e+04]
E1 = -728.3635693889951  E_coul = 201.65344193764238
cycle= 4 E= -526.710127451353  delta_E= -8.32e-07  |g|= 5.98e-05  |ddm|= 0.00131
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000124463
diis-c [-1.31251015e-09  6.39547856e-05 -8.96677156e-03 -7.06896129e-02
  1.07959243e+00]
  HOMO = -0.575507587265774  LUMO = 1.04057038414246
  mo_energy =
[-1.18576077e+02 -1.23043303e+01 -9.55711232e+00 -9.55711232e+00
 -9.55711232e+00 -1.24999318e+00 -5.75507587e-01 -5.75507587e-01
 -5.75507587e-01  1.04057038e+00  1.04057038e+00  1.04057038e+00
  7.62755766e+00  7.62755766e+00  7.62755766e+00  9.71471376e+00
  3.49001239e+01  3.49001239e+01  3.49001239e+01  1.14052488e+02
  1.32875343e+02  1.32875343e+02  1.32875343e+02  4.82269443e+02
  4.82269443e+02  4.82269443e+02  6.43136420e+02  1.31244938e+03
  1.31244938e+03  1.31244938e+03  2.76186894e+03  2.97739969e+03
  2.97739969e+03  2.97739969e+03  6.57850160e+03  6.57850160e+03
  6.57850160e+03  9.15607797e+03  2.54875230e+04  7.62146790e+04]
E1 = -728.3635666889229  E_coul = 201.6534392374591
cycle= 5 E= -526.710127451464  delta_E= -1.11e-10  |g|= 7.89e-06  |ddm|= 2.44e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3635666889229  E_coul = 201.6534392374591
  HOMO = -0.575511079520861  LUMO = 1.04056776988164
  mo_energy =
[-1.18576095e+02 -1.23043427e+01 -9.55712526e+00 -9.55712526e+00
 -9.55712526e+00 -1.24999748e+00 -5.75511080e-01 -5.75511080e-01
 -5.75511080e-01  1.04056777e+00  1.04056777e+00  1.04056777e+00
  7.62754898e+00  7.62754898e+00  7.62754898e+00  9.71470375e+00
  3.49001110e+01  3.49001110e+01  3.49001110e+01  1.14052473e+02
  1.32875328e+02  1.32875328e+02  1.32875328e+02  4.82269426e+02
  4.82269426e+02  4.82269426e+02  6.43136402e+02  1.31244936e+03
  1.31244936e+03  1.31244936e+03  2.76186892e+03  2.97739967e+03
  2.97739967e+03  2.97739967e+03  6.57850158e+03  6.57850158e+03
  6.57850158e+03  9.15607795e+03  2.54875230e+04  7.62146790e+04]
E1 = -728.3636055570959  E_coul = 201.65347810562787
Extra cycle  E= -526.710127451468  delta_E= -4.21e-12  |g|= 2.33e-06  |ddm|= 4.03e-06
    CPU time for scf_cycle      7.44 sec, wall time      0.53 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 73938.82402467662
E1 = -728.3636055570959  E_coul = 201.65347810562787
init E= -526.710127451468
    CPU time for initialize scf     15.64 sec, wall time      0.77 sec
  HOMO = -0.57551036944581  LUMO = 1.04056830793954
  mo_energy =
[-1.18576090e+02 -1.23043398e+01 -9.55712231e+00 -9.55712231e+00
 -9.55712231e+00 -1.24999659e+00 -5.75510369e-01 -5.75510369e-01
 -5.75510369e-01  1.04056831e+00  1.04056831e+00  1.04056831e+00
  7.62755084e+00  7.62755084e+00  7.62755084e+00  9.71470603e+00
  3.49001140e+01  3.49001140e+01  3.49001140e+01  1.14052477e+02
  1.32875332e+02  1.32875332e+02  1.32875332e+02  4.82269430e+02
  4.82269430e+02  4.82269430e+02  6.43136407e+02  1.31244937e+03
  1.31244937e+03  1.31244937e+03  2.76186892e+03  2.97739967e+03
  2.97739967e+03  2.97739967e+03  6.57850159e+03  6.57850159e+03
  6.57850159e+03  9.15607796e+03  2.54875230e+04  7.62146790e+04]
E1 = -728.3635963164332  E_coul = 201.65346886496533
cycle= 1 E= -526.710127451468  delta_E= 1.14e-13  |g|= 5.98e-07  |ddm|= 9.27e-07
    CPU time for cycle= 1      0.05 sec, wall time      0.02 sec
E1 = -728.3635963164332  E_coul = 201.65346886496533
  HOMO = -0.575510526550274  LUMO = 1.04056818818627
  mo_energy =
[-1.18576091e+02 -1.23043405e+01 -9.55712301e+00 -9.55712301e+00
 -9.55712301e+00 -1.24999678e+00 -5.75510527e-01 -5.75510527e-01
 -5.75510527e-01  1.04056819e+00  1.04056819e+00  1.04056819e+00
  7.62755041e+00  7.62755041e+00  7.62755041e+00  9.71470551e+00
  3.49001133e+01  3.49001133e+01  3.49001133e+01  1.14052476e+02
  1.32875331e+02  1.32875331e+02  1.32875331e+02  4.82269429e+02
  4.82269429e+02  4.82269429e+02  6.43136406e+02  1.31244936e+03
  1.31244936e+03  1.31244936e+03  2.76186892e+03  2.97739967e+03
  2.97739967e+03  2.97739967e+03  6.57850159e+03  6.57850159e+03
  6.57850159e+03  9.15607795e+03  2.54875230e+04  7.62146790e+04]
E1 = -728.3635985691338  E_coul = 201.65347111766468
Extra cycle  E= -526.710127451469  delta_E= -1.25e-12  |g|= 1.5e-07  |ddm|= 2.17e-07
    CPU time for scf_cycle     15.78 sec, wall time      0.88 sec
exp = [2.61833420e+04 7.61630752e+03 3.61828575e+03 1.57472297e+03
 4.09490118e+02 1.19654383e+02 3.84990679e+01 7.92350984e+00
 3.12318233e+00 3.98906358e-01 1.36303428e+03 6.62413775e+02
 2.89938819e+02 3.04594494e+02 6.28211552e+01 7.58659310e+00
 2.08502494e+01 7.87440792e-01 2.93852764e+00 2.25321269e-01]
grad_E = [-1.41642629e-06  2.32036207e-06 -2.22830706e-06  4.32800576e-05
 -2.41096409e-05  9.84867571e-05 -3.23126561e-04 -7.46434499e-04
  9.28006995e-04  5.29691290e-03 -6.26968588e-07  3.97487803e-06
  1.85133454e-05  1.54307771e-05 -3.82298980e-05 -3.73202766e-03
  9.49695169e-04  9.05320814e-03  7.10961564e-03 -2.76446543e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:03:33 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26184.214461         1
[INPUT] 0    0    [1    /1   ]  7614.92320756        1
[INPUT] 0    0    [1    /1   ]  3619.60527692        1
[INPUT] 0    0    [1    /1   ]  1550.55638863        1
[INPUT] 0    0    [1    /1   ]  403.310182288        1
[INPUT] 0    0    [1    /1   ]  118.247167114        1
[INPUT] 0    0    [1    /1   ]  38.1737471863        1
[INPUT] 0    0    [1    /1   ]  7.83367611432        1
[INPUT] 0    0    [1    /1   ]  3.09665679723        1
[INPUT] 0    0    [1    /1   ]  0.399149577879       1
[INPUT] 1    0    [1    /1   ]  1363.36321402        1
[INPUT] 1    0    [1    /1   ]  659.39336541         1
[INPUT] 1    0    [1    /1   ]  275.643254956        1
[INPUT] 1    0    [1    /1   ]  292.36243172         1
[INPUT] 1    0    [1    /1   ]  63.3354608885        1
[INPUT] 1    0    [1    /1   ]  7.72620642431        1
[INPUT] 1    0    [1    /1   ]  21.2059919558        1
[INPUT] 1    0    [1    /1   ]  0.795246075661       1
[INPUT] 1    0    [1    /1   ]  3.00473229517        1
[INPUT] 1    0    [1    /1   ]  0.226509498007       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26184.214460962314, 1.0]], [0, [7614.923207561176, 1.0]], [0, [3619.6052769201256, 1.0]], [0, [1550.5563886286343, 1.0]], [0, [403.3101822883795, 1.0]], [0, [118.24716711435325, 1.0]], [0, [38.17374718629951, 1.0]], [0, [7.83367611431885, 1.0]], [0, [3.0966567972300787, 1.0]], [0, [0.39914957787887173, 1.0]], [1, [1363.3632140153757, 1.0]], [1, [659.3933654098039, 1.0]], [1, [275.64325495617595, 1.0]], [1, [292.3624317198977, 1.0]], [1, [63.33546088852801, 1.0]], [1, [7.726206424312204, 1.0]], [1, [21.205991955837987, 1.0]], [1, [0.7952460756614274, 1.0]], [1, [3.0047322951651143, 1.0]], [1, [0.22650949800709158, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26184.21446096]
bas 1, expnt(s) = [7614.92320756]
bas 2, expnt(s) = [3619.60527692]
bas 3, expnt(s) = [1550.55638863]
bas 4, expnt(s) = [403.31018229]
bas 5, expnt(s) = [118.24716711]
bas 6, expnt(s) = [38.17374719]
bas 7, expnt(s) = [7.83367611]
bas 8, expnt(s) = [3.0966568]
bas 9, expnt(s) = [0.39914958]
bas 10, expnt(s) = [1363.36321402]
bas 11, expnt(s) = [659.39336541]
bas 12, expnt(s) = [275.64325496]
bas 13, expnt(s) = [292.36243172]
bas 14, expnt(s) = [63.33546089]
bas 15, expnt(s) = [7.72620642]
bas 16, expnt(s) = [21.20599196]
bas 17, expnt(s) = [0.79524608]
bas 18, expnt(s) = [3.0047323]
bas 19, expnt(s) = [0.2265095]
CPU time:      2088.21
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61842145e+04 5.20049504e+03 7.61492321e+03 2.05951126e+03
 3.61960528e+03 1.17899221e+03 1.55055639e+03 6.24281834e+02
 4.03310182e+02 2.27375891e+02 1.18247167e+02 9.05958039e+01
 3.81737472e+01 3.88006159e+01 7.83367611e+00 1.18301223e+01
 3.09665680e+00 5.89772924e+00 3.99149578e-01 1.26872290e+00
 1.36336321e+03 2.41684533e+04 6.59393365e+02 9.74799076e+03
 2.75643255e+02 3.27656362e+03 2.92362432e+02 3.52684480e+03
 6.33354609e+01 5.21246392e+02 7.72620642e+00 3.75787454e+01
 2.12059920e+01 1.32757062e+02 7.95246076e-01 2.19084328e+00
 3.00473230e+00 1.15409517e+01 2.26509498e-01 4.55871471e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982205652514203
cond(S) = 48734.5553807576
E1 = -729.390179631104  E_coul = 203.12954490741103
init E= -526.260634723693
    CPU time for initialize scf      7.40 sec, wall time      0.36 sec
  HOMO = -0.556643047047382  LUMO = 1.06455951498222
  mo_energy =
[-1.18334796e+02 -1.22075188e+01 -9.45110442e+00 -9.45110442e+00
 -9.45110442e+00 -1.22580639e+00 -5.56643047e-01 -5.56643047e-01
 -5.56643047e-01  1.06455951e+00  1.06455951e+00  1.06455951e+00
  7.87823291e+00  7.87823291e+00  7.87823291e+00  9.60676465e+00
  3.58222943e+01  3.58222943e+01  3.58222943e+01  1.12470756e+02
  1.34857482e+02  1.34857482e+02  1.34857482e+02  4.75758867e+02
  4.75758867e+02  4.75758867e+02  6.33614954e+02  1.27706971e+03
  1.27706971e+03  1.27706971e+03  2.72470995e+03  2.90397190e+03
  2.90397190e+03  2.90397190e+03  6.48116495e+03  6.48116495e+03
  6.48116495e+03  9.07790013e+03  2.53816792e+04  7.61019461e+04]
E1 = -727.9979517411412  E_coul = 201.2875896462798
cycle= 1 E= -526.710362094861  delta_E= -0.45  |g|= 0.183  |ddm|= 0.377
    CPU time for cycle= 1      0.08 sec, wall time      0.03 sec
diis-norm(errvec)=0.543168
diis-c [-0.29503192  1.        ]
  HOMO = -0.581255320937019  LUMO = 1.04769041757011
  mo_energy =
[-1.18626668e+02 -1.23306406e+01 -9.58443199e+00 -9.58443199e+00
 -9.58443199e+00 -1.25739746e+00 -5.81255321e-01 -5.81255321e-01
 -5.81255321e-01  1.04769042e+00  1.04769042e+00  1.04769042e+00
  7.79894190e+00  7.79894190e+00  7.79894190e+00  9.51770586e+00
  3.56804239e+01  3.56804239e+01  3.56804239e+01  1.12259732e+02
  1.34644344e+02  1.34644344e+02  1.34644344e+02  4.75473369e+02
  4.75473369e+02  4.75473369e+02  6.33281276e+02  1.27672901e+03
  1.27672901e+03  1.27672901e+03  2.72423173e+03  2.90356318e+03
  2.90356318e+03  2.90356318e+03  6.48064185e+03  6.48064185e+03
  6.48064185e+03  9.07730355e+03  2.53809882e+04  7.61011651e+04]
E1 = -728.4592236104749  E_coul = 201.7482740268161
cycle= 2 E= -526.710949583659  delta_E= -0.000587  |g|= 0.0333  |ddm|= 0.0387
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0676271
diis-c [-0.00268632  0.07436831  0.92563169]
  HOMO = -0.574592808357609  LUMO = 1.0529182241096
  mo_energy =
[-1.18568342e+02 -1.22999959e+01 -9.55248119e+00 -9.55248119e+00
 -9.55248119e+00 -1.24893315e+00 -5.74592808e-01 -5.74592808e-01
 -5.74592808e-01  1.05291822e+00  1.05291822e+00  1.05291822e+00
  7.81806838e+00  7.81806838e+00  7.81806838e+00  9.54170575e+00
  3.57136244e+01  3.57136244e+01  3.57136244e+01  1.12308059e+02
  1.34691709e+02  1.34691709e+02  1.34691709e+02  4.75530519e+02
  4.75530519e+02  4.75530519e+02  6.33341439e+02  1.27679008e+03
  1.27679008e+03  1.27679008e+03  2.72429609e+03  2.90362648e+03
  2.90362648e+03  2.90362648e+03  6.48070678e+03  6.48070678e+03
  6.48070678e+03  9.07736919e+03  2.53810543e+04  7.61012315e+04]
E1 = -728.3547145122143  E_coul = 201.64373041674241
cycle= 3 E= -526.710984095472  delta_E= -3.45e-05  |g|= 0.00477  |ddm|= 0.0102
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0105193
diis-c [-4.51619058e-07 -1.12179703e-03  1.29934520e-01  8.71187277e-01]
  HOMO = -0.575506681866553  LUMO = 1.0522126294614
  mo_energy =
[-1.18575821e+02 -1.23039955e+01 -9.55675291e+00 -9.55675291e+00
 -9.55675291e+00 -1.25004095e+00 -5.75506682e-01 -5.75506682e-01
 -5.75506682e-01  1.05221263e+00  1.05221263e+00  1.05221263e+00
  7.81548220e+00  7.81548220e+00  7.81548220e+00  9.53865697e+00
  3.57092231e+01  3.57092231e+01  3.57092231e+01  1.12301869e+02
  1.34685582e+02  1.34685582e+02  1.34685582e+02  4.75523190e+02
  4.75523190e+02  4.75523190e+02  6.33333691e+02  1.27678222e+03
  1.27678222e+03  1.27678222e+03  2.72428763e+03  2.90361826e+03
  2.90361826e+03  2.90361826e+03  6.48069820e+03  6.48069820e+03
  6.48069820e+03  9.07736042e+03  2.53810453e+04  7.61012224e+04]
E1 = -728.368798869111  E_coul = 201.65781394693613
cycle= 4 E= -526.710984922175  delta_E= -8.27e-07  |g|= 6.06e-05  |ddm|= 0.00131
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000126885
diis-c [-1.32934814e-09  6.39067089e-05 -8.92088965e-03 -7.08010875e-02
  1.07965807e+00]
  HOMO = -0.575494540845739  LUMO = 1.0522219249276
  mo_energy =
[-1.18575825e+02 -1.23039661e+01 -9.55673530e+00 -9.55673530e+00
 -9.55673530e+00 -1.25002154e+00 -5.75494541e-01 -5.75494541e-01
 -5.75494541e-01  1.05222192e+00  1.05222192e+00  1.05222192e+00
  7.81550302e+00  7.81550302e+00  7.81550302e+00  9.53869300e+00
  3.57092392e+01  3.57092392e+01  3.57092392e+01  1.12301880e+02
  1.34685590e+02  1.34685590e+02  1.34685590e+02  4.75523188e+02
  4.75523188e+02  4.75523188e+02  6.33333679e+02  1.27678221e+03
  1.27678221e+03  1.27678221e+03  2.72428760e+03  2.90361824e+03
  2.90361824e+03  2.90361824e+03  6.48069816e+03  6.48069816e+03
  6.48069816e+03  9.07736037e+03  2.53810453e+04  7.61012223e+04]
E1 = -728.3687956206844  E_coul = 201.65781069839275
cycle= 5 E= -526.710984922292  delta_E= -1.17e-10  |g|= 8.04e-06  |ddm|= 2.52e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3687956206844  E_coul = 201.65781069839275
  HOMO = -0.575498086449059  LUMO = 1.0522192352053
  mo_energy =
[-1.18575843e+02 -1.23039786e+01 -9.55674847e+00 -9.55674847e+00
 -9.55674847e+00 -1.25002590e+00 -5.75498086e-01 -5.75498086e-01
 -5.75498086e-01  1.05221924e+00  1.05221924e+00  1.05221924e+00
  7.81549409e+00  7.81549409e+00  7.81549409e+00  9.53868289e+00
  3.57092260e+01  3.57092260e+01  3.57092260e+01  1.12301864e+02
  1.34685574e+02  1.34685574e+02  1.34685574e+02  4.75523170e+02
  4.75523170e+02  4.75523170e+02  6.33333661e+02  1.27678219e+03
  1.27678219e+03  1.27678219e+03  2.72428758e+03  2.90361822e+03
  2.90361822e+03  2.90361822e+03  6.48069814e+03  6.48069814e+03
  6.48069814e+03  9.07736035e+03  2.53810453e+04  7.61012223e+04]
E1 = -728.3688352594447  E_coul = 201.65785033715048
Extra cycle  E= -526.710984922294  delta_E= -2.61e-12  |g|= 2.38e-06  |ddm|= 4.12e-06
    CPU time for scf_cycle      7.63 sec, wall time      0.54 sec
exp = [2.61842145e+04 7.61492321e+03 3.61960528e+03 1.55055639e+03
 4.03310182e+02 1.18247167e+02 3.81737472e+01 7.83367611e+00
 3.09665680e+00 3.99149578e-01 1.36336321e+03 6.59393365e+02
 2.75643255e+02 2.92362432e+02 6.33354609e+01 7.72620642e+00
 2.12059920e+01 7.95246076e-01 3.00473230e+00 2.26509498e-01]
E = -526.7109849222943
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:03:34 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26184.214461         1
[INPUT] 0    0    [1    /1   ]  7614.92320756        1
[INPUT] 0    0    [1    /1   ]  3619.60527692        1
[INPUT] 0    0    [1    /1   ]  1550.55638863        1
[INPUT] 0    0    [1    /1   ]  403.310182288        1
[INPUT] 0    0    [1    /1   ]  118.247167114        1
[INPUT] 0    0    [1    /1   ]  38.1737471863        1
[INPUT] 0    0    [1    /1   ]  7.83367611432        1
[INPUT] 0    0    [1    /1   ]  3.09665679723        1
[INPUT] 0    0    [1    /1   ]  0.399149577879       1
[INPUT] 1    0    [1    /1   ]  1363.36321402        1
[INPUT] 1    0    [1    /1   ]  659.39336541         1
[INPUT] 1    0    [1    /1   ]  275.643254956        1
[INPUT] 1    0    [1    /1   ]  292.36243172         1
[INPUT] 1    0    [1    /1   ]  63.3354608885        1
[INPUT] 1    0    [1    /1   ]  7.72620642431        1
[INPUT] 1    0    [1    /1   ]  21.2059919558        1
[INPUT] 1    0    [1    /1   ]  0.795246075661       1
[INPUT] 1    0    [1    /1   ]  3.00473229517        1
[INPUT] 1    0    [1    /1   ]  0.226509498007       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26184.214460962314, 1.0]], [0, [7614.923207561176, 1.0]], [0, [3619.6052769201256, 1.0]], [0, [1550.5563886286343, 1.0]], [0, [403.3101822883795, 1.0]], [0, [118.24716711435325, 1.0]], [0, [38.17374718629951, 1.0]], [0, [7.83367611431885, 1.0]], [0, [3.0966567972300787, 1.0]], [0, [0.39914957787887173, 1.0]], [1, [1363.3632140153757, 1.0]], [1, [659.3933654098039, 1.0]], [1, [275.64325495617595, 1.0]], [1, [292.3624317198977, 1.0]], [1, [63.33546088852801, 1.0]], [1, [7.726206424312204, 1.0]], [1, [21.205991955837987, 1.0]], [1, [0.7952460756614274, 1.0]], [1, [3.0047322951651143, 1.0]], [1, [0.22650949800709158, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26184.21446096]
bas 1, expnt(s) = [7614.92320756]
bas 2, expnt(s) = [3619.60527692]
bas 3, expnt(s) = [1550.55638863]
bas 4, expnt(s) = [403.31018229]
bas 5, expnt(s) = [118.24716711]
bas 6, expnt(s) = [38.17374719]
bas 7, expnt(s) = [7.83367611]
bas 8, expnt(s) = [3.0966568]
bas 9, expnt(s) = [0.39914958]
bas 10, expnt(s) = [1363.36321402]
bas 11, expnt(s) = [659.39336541]
bas 12, expnt(s) = [275.64325496]
bas 13, expnt(s) = [292.36243172]
bas 14, expnt(s) = [63.33546089]
bas 15, expnt(s) = [7.72620642]
bas 16, expnt(s) = [21.20599196]
bas 17, expnt(s) = [0.79524608]
bas 18, expnt(s) = [3.0047323]
bas 19, expnt(s) = [0.2265095]
CPU time:      2096.17
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61842145e+04 5.20049504e+03 7.61492321e+03 2.05951126e+03
 3.61960528e+03 1.17899221e+03 1.55055639e+03 6.24281834e+02
 4.03310182e+02 2.27375891e+02 1.18247167e+02 9.05958039e+01
 3.81737472e+01 3.88006159e+01 7.83367611e+00 1.18301223e+01
 3.09665680e+00 5.89772924e+00 3.99149578e-01 1.26872290e+00
 1.36336321e+03 2.41684533e+04 6.59393365e+02 9.74799076e+03
 2.75643255e+02 3.27656362e+03 2.92362432e+02 3.52684480e+03
 6.33354609e+01 5.21246392e+02 7.72620642e+00 3.75787454e+01
 2.12059920e+01 1.32757062e+02 7.95246076e-01 2.19084328e+00
 3.00473230e+00 1.15409517e+01 2.26509498e-01 4.55871471e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982205652514203
cond(S) = 48734.5553807576
E1 = -729.390179631104  E_coul = 203.12954490741103
init E= -526.260634723693
    CPU time for initialize scf      7.59 sec, wall time      0.35 sec
  HOMO = -0.556643047047382  LUMO = 1.06455951498222
  mo_energy =
[-1.18334796e+02 -1.22075188e+01 -9.45110442e+00 -9.45110442e+00
 -9.45110442e+00 -1.22580639e+00 -5.56643047e-01 -5.56643047e-01
 -5.56643047e-01  1.06455951e+00  1.06455951e+00  1.06455951e+00
  7.87823291e+00  7.87823291e+00  7.87823291e+00  9.60676465e+00
  3.58222943e+01  3.58222943e+01  3.58222943e+01  1.12470756e+02
  1.34857482e+02  1.34857482e+02  1.34857482e+02  4.75758867e+02
  4.75758867e+02  4.75758867e+02  6.33614954e+02  1.27706971e+03
  1.27706971e+03  1.27706971e+03  2.72470995e+03  2.90397190e+03
  2.90397190e+03  2.90397190e+03  6.48116495e+03  6.48116495e+03
  6.48116495e+03  9.07790013e+03  2.53816792e+04  7.61019461e+04]
E1 = -727.9979517411412  E_coul = 201.2875896462798
cycle= 1 E= -526.710362094861  delta_E= -0.45  |g|= 0.183  |ddm|= 0.377
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.543168
diis-c [-0.29503192  1.        ]
  HOMO = -0.581255320937019  LUMO = 1.04769041757011
  mo_energy =
[-1.18626668e+02 -1.23306406e+01 -9.58443199e+00 -9.58443199e+00
 -9.58443199e+00 -1.25739746e+00 -5.81255321e-01 -5.81255321e-01
 -5.81255321e-01  1.04769042e+00  1.04769042e+00  1.04769042e+00
  7.79894190e+00  7.79894190e+00  7.79894190e+00  9.51770586e+00
  3.56804239e+01  3.56804239e+01  3.56804239e+01  1.12259732e+02
  1.34644344e+02  1.34644344e+02  1.34644344e+02  4.75473369e+02
  4.75473369e+02  4.75473369e+02  6.33281276e+02  1.27672901e+03
  1.27672901e+03  1.27672901e+03  2.72423173e+03  2.90356318e+03
  2.90356318e+03  2.90356318e+03  6.48064185e+03  6.48064185e+03
  6.48064185e+03  9.07730355e+03  2.53809882e+04  7.61011651e+04]
E1 = -728.4592236104749  E_coul = 201.7482740268161
cycle= 2 E= -526.710949583659  delta_E= -0.000587  |g|= 0.0333  |ddm|= 0.0387
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0676271
diis-c [-0.00268632  0.07436831  0.92563169]
  HOMO = -0.574592808357609  LUMO = 1.0529182241096
  mo_energy =
[-1.18568342e+02 -1.22999959e+01 -9.55248119e+00 -9.55248119e+00
 -9.55248119e+00 -1.24893315e+00 -5.74592808e-01 -5.74592808e-01
 -5.74592808e-01  1.05291822e+00  1.05291822e+00  1.05291822e+00
  7.81806838e+00  7.81806838e+00  7.81806838e+00  9.54170575e+00
  3.57136244e+01  3.57136244e+01  3.57136244e+01  1.12308059e+02
  1.34691709e+02  1.34691709e+02  1.34691709e+02  4.75530519e+02
  4.75530519e+02  4.75530519e+02  6.33341439e+02  1.27679008e+03
  1.27679008e+03  1.27679008e+03  2.72429609e+03  2.90362648e+03
  2.90362648e+03  2.90362648e+03  6.48070678e+03  6.48070678e+03
  6.48070678e+03  9.07736919e+03  2.53810543e+04  7.61012315e+04]
E1 = -728.3547145122143  E_coul = 201.64373041674241
cycle= 3 E= -526.710984095472  delta_E= -3.45e-05  |g|= 0.00477  |ddm|= 0.0102
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0105193
diis-c [-4.51619058e-07 -1.12179703e-03  1.29934520e-01  8.71187277e-01]
  HOMO = -0.575506681866553  LUMO = 1.0522126294614
  mo_energy =
[-1.18575821e+02 -1.23039955e+01 -9.55675291e+00 -9.55675291e+00
 -9.55675291e+00 -1.25004095e+00 -5.75506682e-01 -5.75506682e-01
 -5.75506682e-01  1.05221263e+00  1.05221263e+00  1.05221263e+00
  7.81548220e+00  7.81548220e+00  7.81548220e+00  9.53865697e+00
  3.57092231e+01  3.57092231e+01  3.57092231e+01  1.12301869e+02
  1.34685582e+02  1.34685582e+02  1.34685582e+02  4.75523190e+02
  4.75523190e+02  4.75523190e+02  6.33333691e+02  1.27678222e+03
  1.27678222e+03  1.27678222e+03  2.72428763e+03  2.90361826e+03
  2.90361826e+03  2.90361826e+03  6.48069820e+03  6.48069820e+03
  6.48069820e+03  9.07736042e+03  2.53810453e+04  7.61012224e+04]
E1 = -728.368798869111  E_coul = 201.65781394693613
cycle= 4 E= -526.710984922175  delta_E= -8.27e-07  |g|= 6.06e-05  |ddm|= 0.00131
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000126885
diis-c [-1.32934814e-09  6.39067089e-05 -8.92088965e-03 -7.08010875e-02
  1.07965807e+00]
  HOMO = -0.575494540845739  LUMO = 1.0522219249276
  mo_energy =
[-1.18575825e+02 -1.23039661e+01 -9.55673530e+00 -9.55673530e+00
 -9.55673530e+00 -1.25002154e+00 -5.75494541e-01 -5.75494541e-01
 -5.75494541e-01  1.05222192e+00  1.05222192e+00  1.05222192e+00
  7.81550302e+00  7.81550302e+00  7.81550302e+00  9.53869300e+00
  3.57092392e+01  3.57092392e+01  3.57092392e+01  1.12301880e+02
  1.34685590e+02  1.34685590e+02  1.34685590e+02  4.75523188e+02
  4.75523188e+02  4.75523188e+02  6.33333679e+02  1.27678221e+03
  1.27678221e+03  1.27678221e+03  2.72428760e+03  2.90361824e+03
  2.90361824e+03  2.90361824e+03  6.48069816e+03  6.48069816e+03
  6.48069816e+03  9.07736037e+03  2.53810453e+04  7.61012223e+04]
E1 = -728.3687956206844  E_coul = 201.65781069839275
cycle= 5 E= -526.710984922292  delta_E= -1.17e-10  |g|= 8.04e-06  |ddm|= 2.52e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3687956206844  E_coul = 201.65781069839275
  HOMO = -0.575498086449059  LUMO = 1.0522192352053
  mo_energy =
[-1.18575843e+02 -1.23039786e+01 -9.55674847e+00 -9.55674847e+00
 -9.55674847e+00 -1.25002590e+00 -5.75498086e-01 -5.75498086e-01
 -5.75498086e-01  1.05221924e+00  1.05221924e+00  1.05221924e+00
  7.81549409e+00  7.81549409e+00  7.81549409e+00  9.53868289e+00
  3.57092260e+01  3.57092260e+01  3.57092260e+01  1.12301864e+02
  1.34685574e+02  1.34685574e+02  1.34685574e+02  4.75523170e+02
  4.75523170e+02  4.75523170e+02  6.33333661e+02  1.27678219e+03
  1.27678219e+03  1.27678219e+03  2.72428758e+03  2.90361822e+03
  2.90361822e+03  2.90361822e+03  6.48069814e+03  6.48069814e+03
  6.48069814e+03  9.07736035e+03  2.53810453e+04  7.61012223e+04]
E1 = -728.3688352594447  E_coul = 201.65785033715048
Extra cycle  E= -526.710984922294  delta_E= -2.61e-12  |g|= 2.38e-06  |ddm|= 4.12e-06
    CPU time for scf_cycle      7.80 sec, wall time      0.53 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 48734.5553807576
E1 = -728.3688352594447  E_coul = 201.65785033715048
init E= -526.710984922294
    CPU time for initialize scf     16.19 sec, wall time      0.75 sec
  HOMO = -0.575497362569918  LUMO = 1.05221979121816
  mo_energy =
[-1.18575838e+02 -1.23039757e+01 -9.55674546e+00 -9.55674546e+00
 -9.55674546e+00 -1.25002499e+00 -5.75497363e-01 -5.75497363e-01
 -5.75497363e-01  1.05221979e+00  1.05221979e+00  1.05221979e+00
  7.81549601e+00  7.81549601e+00  7.81549601e+00  9.53868520e+00
  3.57092291e+01  3.57092291e+01  3.57092291e+01  1.12301868e+02
  1.34685578e+02  1.34685578e+02  1.34685578e+02  4.75523175e+02
  4.75523175e+02  4.75523175e+02  6.33333666e+02  1.27678219e+03
  1.27678219e+03  1.27678219e+03  2.72428759e+03  2.90361822e+03
  2.90361822e+03  2.90361822e+03  6.48069815e+03  6.48069815e+03
  6.48069815e+03  9.07736036e+03  2.53810453e+04  7.61012223e+04]
E1 = -728.3688258235634  E_coul = 201.65784090126735
cycle= 1 E= -526.710984922296  delta_E= -1.71e-12  |g|= 6.11e-07  |ddm|= 9.51e-07
    CPU time for cycle= 1      0.04 sec, wall time      0.02 sec
E1 = -728.3688258235634  E_coul = 201.65784090126735
  HOMO = -0.575497522973567  LUMO = 1.0522196672647
  mo_energy =
[-1.18575839e+02 -1.23039764e+01 -9.55674618e+00 -9.55674618e+00
 -9.55674618e+00 -1.25002519e+00 -5.75497523e-01 -5.75497523e-01
 -5.75497523e-01  1.05221967e+00  1.05221967e+00  1.05221967e+00
  7.81549557e+00  7.81549557e+00  7.81549557e+00  9.53868467e+00
  3.57092284e+01  3.57092284e+01  3.57092284e+01  1.12301867e+02
  1.34685577e+02  1.34685577e+02  1.34685577e+02  4.75523174e+02
  4.75523174e+02  4.75523174e+02  6.33333665e+02  1.27678219e+03
  1.27678219e+03  1.27678219e+03  2.72428758e+03  2.90361822e+03
  2.90361822e+03  2.90361822e+03  6.48069815e+03  6.48069815e+03
  6.48069815e+03  9.07736036e+03  2.53810453e+04  7.61012223e+04]
E1 = -728.3688281268269  E_coul = 201.6578432045305
Extra cycle  E= -526.710984922296  delta_E= -3.41e-13  |g|= 1.53e-07  |ddm|= 2.23e-07
    CPU time for scf_cycle     16.31 sec, wall time      0.86 sec
exp = [2.61842145e+04 7.61492321e+03 3.61960528e+03 1.55055639e+03
 4.03310182e+02 1.18247167e+02 3.81737472e+01 7.83367611e+00
 3.09665680e+00 3.99149578e-01 1.36336321e+03 6.59393365e+02
 2.75643255e+02 2.92362432e+02 6.33354609e+01 7.72620642e+00
 2.12059920e+01 7.95246076e-01 3.00473230e+00 2.26509498e-01]
grad_E = [-1.41894717e-06  2.34122373e-06 -2.41388585e-06  4.70722948e-05
 -5.03044694e-05  1.63275967e-04 -5.42246732e-04 -1.27204999e-03
  1.57415752e-03  8.98220062e-03 -7.12064974e-07  3.26136303e-06
  1.47470105e-05  1.16605677e-05 -3.95206743e-05 -6.14366212e-03
  1.57325590e-03  1.49678411e-02  1.16466381e-02 -4.59662946e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:03:39 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26186.6935088        1
[INPUT] 0    0    [1    /1   ]  7610.9773264         1
[INPUT] 0    0    [1    /1   ]  3623.34432237        1
[INPUT] 0    0    [1    /1   ]  1481.48213559        1
[INPUT] 0    0    [1    /1   ]  388.968982404        1
[INPUT] 0    0    [1    /1   ]  115.143201228        1
[INPUT] 0    0    [1    /1   ]  37.4842333036        1
[INPUT] 0    0    [1    /1   ]  7.68311196387        1
[INPUT] 0    0    [1    /1   ]  3.04918557401        1
[INPUT] 0    0    [1    /1   ]  0.399585608238       1
[INPUT] 1    0    [1    /1   ]  1364.29839352        1
[INPUT] 1    0    [1    /1   ]  650.833966709        1
[INPUT] 1    0    [1    /1   ]  235.148411625        1
[INPUT] 1    0    [1    /1   ]  257.711934073        1
[INPUT] 1    0    [1    /1   ]  63.18420444          1
[INPUT] 1    0    [1    /1   ]  7.87927181625        1
[INPUT] 1    0    [1    /1   ]  21.5817129987        1
[INPUT] 1    0    [1    /1   ]  0.805111262254       1
[INPUT] 1    0    [1    /1   ]  3.08412336573        1
[INPUT] 1    0    [1    /1   ]  0.227840961418       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26186.69350883394, 1.0]], [0, [7610.977326403301, 1.0]], [0, [3623.34432237147, 1.0]], [0, [1481.4821355866084, 1.0]], [0, [388.96898240405835, 1.0]], [0, [115.14320122756503, 1.0]], [0, [37.48423330360332, 1.0]], [0, [7.6831119638670415, 1.0]], [0, [3.049185574014364, 1.0]], [0, [0.3995856082375329, 1.0]], [1, [1364.2983935189247, 1.0]], [1, [650.8339667094725, 1.0]], [1, [235.14841162473746, 1.0]], [1, [257.7119340727635, 1.0]], [1, [63.18420444000388, 1.0]], [1, [7.879271816249604, 1.0]], [1, [21.581712998737764, 1.0]], [1, [0.8051112622544532, 1.0]], [1, [3.084123365727196, 1.0]], [1, [0.22784096141818025, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26186.69350883]
bas 1, expnt(s) = [7610.9773264]
bas 2, expnt(s) = [3623.34432237]
bas 3, expnt(s) = [1481.48213559]
bas 4, expnt(s) = [388.9689824]
bas 5, expnt(s) = [115.14320123]
bas 6, expnt(s) = [37.4842333]
bas 7, expnt(s) = [7.68311196]
bas 8, expnt(s) = [3.04918557]
bas 9, expnt(s) = [0.39958561]
bas 10, expnt(s) = [1364.29839352]
bas 11, expnt(s) = [650.83396671]
bas 12, expnt(s) = [235.14841162]
bas 13, expnt(s) = [257.71193407]
bas 14, expnt(s) = [63.18420444]
bas 15, expnt(s) = [7.87927182]
bas 16, expnt(s) = [21.581713]
bas 17, expnt(s) = [0.80511126]
bas 18, expnt(s) = [3.08412337]
bas 19, expnt(s) = [0.22784096]
CPU time:      2125.38
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61866935e+04 5.20086431e+03 7.61097733e+03 2.05871081e+03
 3.62334432e+03 1.17990551e+03 1.48148214e+03 6.03305575e+02
 3.88968982e+02 2.21284631e+02 1.15143201e+02 8.88062944e+01
 3.74842333e+01 3.82737925e+01 7.68311196e+00 1.16591770e+01
 3.04918557e+00 5.82979008e+00 3.99585608e-01 1.26976222e+00
 1.36429839e+03 2.41891775e+04 6.50833967e+02 9.59007836e+03
 2.35148412e+02 2.68634603e+03 2.57711934e+02 3.01233006e+03
 6.31842044e+01 5.19690819e+02 7.87927182e+00 3.85116385e+01
 2.15817130e+01 1.35703730e+02 8.05111262e-01 2.22486810e+00
 3.08412337e+00 1.19233713e+01 2.27840961e-01 4.59223546e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98185526515964
cond(S) = 17200.920712602172
E1 = -729.3989017712997  E_coul = 203.13500664339261
init E= -526.263895127907
    CPU time for initialize scf      7.76 sec, wall time      0.36 sec
  HOMO = -0.556478273024484  LUMO = 1.07908862443629
  mo_energy =
[-1.18335435e+02 -1.22072662e+01 -9.45067736e+00 -9.45067736e+00
 -9.45067736e+00 -1.22565056e+00 -5.56478273e-01 -5.56478273e-01
 -5.56478273e-01  1.07908862e+00  1.07908862e+00  1.07908862e+00
  8.10075669e+00  8.10075669e+00  8.10075669e+00  9.30219791e+00
  3.66675815e+01  3.66675815e+01  3.66675815e+01  1.08906272e+02
  1.35200324e+02  1.35200324e+02  1.35200324e+02  4.47929945e+02
  4.47929945e+02  4.47929945e+02  6.11610908e+02  1.16347606e+03
  1.16347606e+03  1.16347606e+03  2.62951467e+03  2.68121817e+03
  2.68121817e+03  2.68121817e+03  6.19570036e+03  6.19570036e+03
  6.19570036e+03  8.86657249e+03  2.50925349e+04  7.57934961e+04]
E1 = -728.0063004139492  E_coul = 201.2935429202637
cycle= 1 E= -526.712757493686  delta_E= -0.449  |g|= 0.183  |ddm|= 0.355
    CPU time for cycle= 1      0.05 sec, wall time      0.04 sec
diis-norm(errvec)=0.55025
diis-c [-0.3027749  1.       ]
  HOMO = -0.581335127745199  LUMO = 1.06171110902403
  mo_energy =
[-1.18626890e+02 -1.23300800e+01 -9.58382675e+00 -9.58382675e+00
 -9.58382675e+00 -1.25753319e+00 -5.81335128e-01 -5.81335128e-01
 -5.81335128e-01  1.06171111e+00  1.06171111e+00  1.06171111e+00
  8.01996144e+00  8.01996144e+00  8.01996144e+00  9.21450391e+00
  3.65251473e+01  3.65251473e+01  3.65251473e+01  1.08697919e+02
  1.34989634e+02  1.34989634e+02  1.34989634e+02  4.47653427e+02
  4.47653427e+02  4.47653427e+02  6.11281110e+02  1.16314490e+03
  1.16314490e+03  1.16314490e+03  2.62904035e+03  2.68081390e+03
  2.68081390e+03  2.68081390e+03  6.19517756e+03  6.19517756e+03
  6.19517756e+03  8.86597717e+03  2.50918438e+04  7.57927149e+04]
E1 = -728.4678072356407  E_coul = 201.75446220698072
cycle= 2 E= -526.71334502866  delta_E= -0.000588  |g|= 0.0333  |ddm|= 0.0388
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0691953
diis-c [-0.00273035  0.07647848  0.92352152]
  HOMO = -0.574689568663113  LUMO = 1.0670141909785
  mo_energy =
[-1.18568702e+02 -1.22994799e+01 -9.55191798e+00 -9.55191798e+00
 -9.55191798e+00 -1.24908781e+00 -5.74689569e-01 -5.74689569e-01
 -5.74689569e-01  1.06701419e+00  1.06701419e+00  1.06701419e+00
  8.03935658e+00  8.03935658e+00  8.03935658e+00  9.23812700e+00
  3.65584459e+01  3.65584459e+01  3.65584459e+01  1.08745803e+02
  1.35036584e+02  1.35036584e+02  1.35036584e+02  4.47709650e+02
  4.47709650e+02  4.47709650e+02  6.11340938e+02  1.16320529e+03
  1.16320529e+03  1.16320529e+03  2.62910447e+03  2.68087686e+03
  2.68087686e+03  2.68087686e+03  6.19524229e+03  6.19524229e+03
  6.19524229e+03  8.86604261e+03  2.50919097e+04  7.57927811e+04]
E1 = -728.363156751447  E_coul = 201.64977701134262
cycle= 3 E= -526.713379740104  delta_E= -3.47e-05  |g|= 0.0047  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106353
diis-c [-4.73465120e-07 -1.13583843e-03  1.28412969e-01  8.72722869e-01]
  HOMO = -0.575594390563871  LUMO = 1.06630405203955
  mo_energy =
[-1.18576072e+02 -1.23034276e+01 -9.55613755e+00 -9.55613755e+00
 -9.55613755e+00 -1.25018293e+00 -5.75594391e-01 -5.75594391e-01
 -5.75594391e-01  1.06630405e+00  1.06630405e+00  1.06630405e+00
  8.03675934e+00  8.03675934e+00  8.03675934e+00  9.23516020e+00
  3.65540818e+01  3.65540818e+01  3.65540818e+01  1.08739745e+02
  1.35030581e+02  1.35030581e+02  1.35030581e+02  4.47702527e+02
  4.47702527e+02  4.47702527e+02  6.11333329e+02  1.16319762e+03
  1.16319762e+03  1.16319762e+03  2.62909614e+03  2.68086878e+03
  2.68086878e+03  2.68086878e+03  6.19523383e+03  6.19523383e+03
  6.19523383e+03  8.86603396e+03  2.50919009e+04  7.57927721e+04]
E1 = -728.3771051734182  E_coul = 201.6637246233009
cycle= 4 E= -526.713380550117  delta_E= -8.1e-07  |g|= 6.19e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000132922
diis-c [-1.38209091e-09  6.35511124e-05 -8.75191511e-03 -7.09326211e-02
  1.07962099e+00]
  HOMO = -0.575582044642481  LUMO = 1.06631363587459
  mo_energy =
[-1.18576076e+02 -1.23033976e+01 -9.55611958e+00 -9.55611958e+00
 -9.55611958e+00 -1.25016306e+00 -5.75582045e-01 -5.75582045e-01
 -5.75582045e-01  1.06631364e+00  1.06631364e+00  1.06631364e+00
  8.03678054e+00  8.03678054e+00  8.03678054e+00  9.23519695e+00
  3.65540982e+01  3.65540982e+01  3.65540982e+01  1.08739756e+02
  1.35030589e+02  1.35030589e+02  1.35030589e+02  4.47702525e+02
  4.47702525e+02  4.47702525e+02  6.11333317e+02  1.16319761e+03
  1.16319761e+03  1.16319761e+03  2.62909611e+03  2.68086876e+03
  2.68086876e+03  2.68086876e+03  6.19523379e+03  6.19523379e+03
  6.19523379e+03  8.86603391e+03  2.50919008e+04  7.57927721e+04]
E1 = -728.3771011989589  E_coul = 201.66372064871854
cycle= 5 E= -526.71338055024  delta_E= -1.23e-10  |g|= 8.36e-06  |ddm|= 2.66e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3771011989589  E_coul = 201.66372064871854
  HOMO = -0.575585701861641  LUMO = 1.06631081641798
  mo_energy =
[-1.18576095e+02 -1.23034106e+01 -9.55613322e+00 -9.55613322e+00
 -9.55613322e+00 -1.25016754e+00 -5.75585702e-01 -5.75585702e-01
 -5.75585702e-01  1.06631082e+00  1.06631082e+00  1.06631082e+00
  8.03677119e+00  8.03677119e+00  8.03677119e+00  9.23518663e+00
  3.65540846e+01  3.65540846e+01  3.65540846e+01  1.08739740e+02
  1.35030573e+02  1.35030573e+02  1.35030573e+02  4.47702507e+02
  4.47702507e+02  4.47702507e+02  6.11333299e+02  1.16319759e+03
  1.16319759e+03  1.16319759e+03  2.62909609e+03  2.68086874e+03
  2.68086874e+03  2.68086874e+03  6.19523377e+03  6.19523377e+03
  6.19523377e+03  8.86603389e+03  2.50919008e+04  7.57927720e+04]
E1 = -728.3771424787609  E_coul = 201.6637619285157
Extra cycle  E= -526.713380550245  delta_E= -4.89e-12  |g|= 2.47e-06  |ddm|= 4.3e-06
    CPU time for scf_cycle      7.96 sec, wall time      0.55 sec
exp = [2.61866935e+04 7.61097733e+03 3.62334432e+03 1.48148214e+03
 3.88968982e+02 1.15143201e+02 3.74842333e+01 7.68311196e+00
 3.04918557e+00 3.99585608e-01 1.36429839e+03 6.50833967e+02
 2.35148412e+02 2.57711934e+02 6.31842044e+01 7.87927182e+00
 2.15817130e+01 8.05111262e-01 3.08412337e+00 2.27840961e-01]
E = -526.7133805502452
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:03:40 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26186.6935088        1
[INPUT] 0    0    [1    /1   ]  7610.9773264         1
[INPUT] 0    0    [1    /1   ]  3623.34432237        1
[INPUT] 0    0    [1    /1   ]  1481.48213559        1
[INPUT] 0    0    [1    /1   ]  388.968982404        1
[INPUT] 0    0    [1    /1   ]  115.143201228        1
[INPUT] 0    0    [1    /1   ]  37.4842333036        1
[INPUT] 0    0    [1    /1   ]  7.68311196387        1
[INPUT] 0    0    [1    /1   ]  3.04918557401        1
[INPUT] 0    0    [1    /1   ]  0.399585608238       1
[INPUT] 1    0    [1    /1   ]  1364.29839352        1
[INPUT] 1    0    [1    /1   ]  650.833966709        1
[INPUT] 1    0    [1    /1   ]  235.148411625        1
[INPUT] 1    0    [1    /1   ]  257.711934073        1
[INPUT] 1    0    [1    /1   ]  63.18420444          1
[INPUT] 1    0    [1    /1   ]  7.87927181625        1
[INPUT] 1    0    [1    /1   ]  21.5817129987        1
[INPUT] 1    0    [1    /1   ]  0.805111262254       1
[INPUT] 1    0    [1    /1   ]  3.08412336573        1
[INPUT] 1    0    [1    /1   ]  0.227840961418       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26186.69350883394, 1.0]], [0, [7610.977326403301, 1.0]], [0, [3623.34432237147, 1.0]], [0, [1481.4821355866084, 1.0]], [0, [388.96898240405835, 1.0]], [0, [115.14320122756503, 1.0]], [0, [37.48423330360332, 1.0]], [0, [7.6831119638670415, 1.0]], [0, [3.049185574014364, 1.0]], [0, [0.3995856082375329, 1.0]], [1, [1364.2983935189247, 1.0]], [1, [650.8339667094725, 1.0]], [1, [235.14841162473746, 1.0]], [1, [257.7119340727635, 1.0]], [1, [63.18420444000388, 1.0]], [1, [7.879271816249604, 1.0]], [1, [21.581712998737764, 1.0]], [1, [0.8051112622544532, 1.0]], [1, [3.084123365727196, 1.0]], [1, [0.22784096141818025, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26186.69350883]
bas 1, expnt(s) = [7610.9773264]
bas 2, expnt(s) = [3623.34432237]
bas 3, expnt(s) = [1481.48213559]
bas 4, expnt(s) = [388.9689824]
bas 5, expnt(s) = [115.14320123]
bas 6, expnt(s) = [37.4842333]
bas 7, expnt(s) = [7.68311196]
bas 8, expnt(s) = [3.04918557]
bas 9, expnt(s) = [0.39958561]
bas 10, expnt(s) = [1364.29839352]
bas 11, expnt(s) = [650.83396671]
bas 12, expnt(s) = [235.14841162]
bas 13, expnt(s) = [257.71193407]
bas 14, expnt(s) = [63.18420444]
bas 15, expnt(s) = [7.87927182]
bas 16, expnt(s) = [21.581713]
bas 17, expnt(s) = [0.80511126]
bas 18, expnt(s) = [3.08412337]
bas 19, expnt(s) = [0.22784096]
CPU time:      2133.67
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61866935e+04 5.20086431e+03 7.61097733e+03 2.05871081e+03
 3.62334432e+03 1.17990551e+03 1.48148214e+03 6.03305575e+02
 3.88968982e+02 2.21284631e+02 1.15143201e+02 8.88062944e+01
 3.74842333e+01 3.82737925e+01 7.68311196e+00 1.16591770e+01
 3.04918557e+00 5.82979008e+00 3.99585608e-01 1.26976222e+00
 1.36429839e+03 2.41891775e+04 6.50833967e+02 9.59007836e+03
 2.35148412e+02 2.68634603e+03 2.57711934e+02 3.01233006e+03
 6.31842044e+01 5.19690819e+02 7.87927182e+00 3.85116385e+01
 2.15817130e+01 1.35703730e+02 8.05111262e-01 2.22486810e+00
 3.08412337e+00 1.19233713e+01 2.27840961e-01 4.59223546e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98185526515964
cond(S) = 17200.920712602172
E1 = -729.3989017712997  E_coul = 203.13500664339261
init E= -526.263895127907
    CPU time for initialize scf      7.42 sec, wall time      0.34 sec
  HOMO = -0.556478273024484  LUMO = 1.07908862443629
  mo_energy =
[-1.18335435e+02 -1.22072662e+01 -9.45067736e+00 -9.45067736e+00
 -9.45067736e+00 -1.22565056e+00 -5.56478273e-01 -5.56478273e-01
 -5.56478273e-01  1.07908862e+00  1.07908862e+00  1.07908862e+00
  8.10075669e+00  8.10075669e+00  8.10075669e+00  9.30219791e+00
  3.66675815e+01  3.66675815e+01  3.66675815e+01  1.08906272e+02
  1.35200324e+02  1.35200324e+02  1.35200324e+02  4.47929945e+02
  4.47929945e+02  4.47929945e+02  6.11610908e+02  1.16347606e+03
  1.16347606e+03  1.16347606e+03  2.62951467e+03  2.68121817e+03
  2.68121817e+03  2.68121817e+03  6.19570036e+03  6.19570036e+03
  6.19570036e+03  8.86657249e+03  2.50925349e+04  7.57934961e+04]
E1 = -728.0063004139492  E_coul = 201.2935429202637
cycle= 1 E= -526.712757493686  delta_E= -0.449  |g|= 0.183  |ddm|= 0.355
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.55025
diis-c [-0.3027749  1.       ]
  HOMO = -0.581335127745199  LUMO = 1.06171110902403
  mo_energy =
[-1.18626890e+02 -1.23300800e+01 -9.58382675e+00 -9.58382675e+00
 -9.58382675e+00 -1.25753319e+00 -5.81335128e-01 -5.81335128e-01
 -5.81335128e-01  1.06171111e+00  1.06171111e+00  1.06171111e+00
  8.01996144e+00  8.01996144e+00  8.01996144e+00  9.21450391e+00
  3.65251473e+01  3.65251473e+01  3.65251473e+01  1.08697919e+02
  1.34989634e+02  1.34989634e+02  1.34989634e+02  4.47653427e+02
  4.47653427e+02  4.47653427e+02  6.11281110e+02  1.16314490e+03
  1.16314490e+03  1.16314490e+03  2.62904035e+03  2.68081390e+03
  2.68081390e+03  2.68081390e+03  6.19517756e+03  6.19517756e+03
  6.19517756e+03  8.86597717e+03  2.50918438e+04  7.57927149e+04]
E1 = -728.4678072356407  E_coul = 201.75446220698072
cycle= 2 E= -526.71334502866  delta_E= -0.000588  |g|= 0.0333  |ddm|= 0.0388
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0691953
diis-c [-0.00273035  0.07647848  0.92352152]
  HOMO = -0.574689568663113  LUMO = 1.0670141909785
  mo_energy =
[-1.18568702e+02 -1.22994799e+01 -9.55191798e+00 -9.55191798e+00
 -9.55191798e+00 -1.24908781e+00 -5.74689569e-01 -5.74689569e-01
 -5.74689569e-01  1.06701419e+00  1.06701419e+00  1.06701419e+00
  8.03935658e+00  8.03935658e+00  8.03935658e+00  9.23812700e+00
  3.65584459e+01  3.65584459e+01  3.65584459e+01  1.08745803e+02
  1.35036584e+02  1.35036584e+02  1.35036584e+02  4.47709650e+02
  4.47709650e+02  4.47709650e+02  6.11340938e+02  1.16320529e+03
  1.16320529e+03  1.16320529e+03  2.62910447e+03  2.68087686e+03
  2.68087686e+03  2.68087686e+03  6.19524229e+03  6.19524229e+03
  6.19524229e+03  8.86604261e+03  2.50919097e+04  7.57927811e+04]
E1 = -728.363156751447  E_coul = 201.64977701134262
cycle= 3 E= -526.713379740104  delta_E= -3.47e-05  |g|= 0.0047  |ddm|= 0.0103
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0106353
diis-c [-4.73465120e-07 -1.13583843e-03  1.28412969e-01  8.72722869e-01]
  HOMO = -0.575594390563871  LUMO = 1.06630405203955
  mo_energy =
[-1.18576072e+02 -1.23034276e+01 -9.55613755e+00 -9.55613755e+00
 -9.55613755e+00 -1.25018293e+00 -5.75594391e-01 -5.75594391e-01
 -5.75594391e-01  1.06630405e+00  1.06630405e+00  1.06630405e+00
  8.03675934e+00  8.03675934e+00  8.03675934e+00  9.23516020e+00
  3.65540818e+01  3.65540818e+01  3.65540818e+01  1.08739745e+02
  1.35030581e+02  1.35030581e+02  1.35030581e+02  4.47702527e+02
  4.47702527e+02  4.47702527e+02  6.11333329e+02  1.16319762e+03
  1.16319762e+03  1.16319762e+03  2.62909614e+03  2.68086878e+03
  2.68086878e+03  2.68086878e+03  6.19523383e+03  6.19523383e+03
  6.19523383e+03  8.86603396e+03  2.50919009e+04  7.57927721e+04]
E1 = -728.3771051734182  E_coul = 201.6637246233009
cycle= 4 E= -526.713380550117  delta_E= -8.1e-07  |g|= 6.19e-05  |ddm|= 0.0013
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000132922
diis-c [-1.38209091e-09  6.35511124e-05 -8.75191511e-03 -7.09326211e-02
  1.07962099e+00]
  HOMO = -0.575582044642481  LUMO = 1.06631363587459
  mo_energy =
[-1.18576076e+02 -1.23033976e+01 -9.55611958e+00 -9.55611958e+00
 -9.55611958e+00 -1.25016306e+00 -5.75582045e-01 -5.75582045e-01
 -5.75582045e-01  1.06631364e+00  1.06631364e+00  1.06631364e+00
  8.03678054e+00  8.03678054e+00  8.03678054e+00  9.23519695e+00
  3.65540982e+01  3.65540982e+01  3.65540982e+01  1.08739756e+02
  1.35030589e+02  1.35030589e+02  1.35030589e+02  4.47702525e+02
  4.47702525e+02  4.47702525e+02  6.11333317e+02  1.16319761e+03
  1.16319761e+03  1.16319761e+03  2.62909611e+03  2.68086876e+03
  2.68086876e+03  2.68086876e+03  6.19523379e+03  6.19523379e+03
  6.19523379e+03  8.86603391e+03  2.50919008e+04  7.57927721e+04]
E1 = -728.3771011989589  E_coul = 201.66372064871854
cycle= 5 E= -526.71338055024  delta_E= -1.23e-10  |g|= 8.36e-06  |ddm|= 2.66e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3771011989589  E_coul = 201.66372064871854
  HOMO = -0.575585701861641  LUMO = 1.06631081641798
  mo_energy =
[-1.18576095e+02 -1.23034106e+01 -9.55613322e+00 -9.55613322e+00
 -9.55613322e+00 -1.25016754e+00 -5.75585702e-01 -5.75585702e-01
 -5.75585702e-01  1.06631082e+00  1.06631082e+00  1.06631082e+00
  8.03677119e+00  8.03677119e+00  8.03677119e+00  9.23518663e+00
  3.65540846e+01  3.65540846e+01  3.65540846e+01  1.08739740e+02
  1.35030573e+02  1.35030573e+02  1.35030573e+02  4.47702507e+02
  4.47702507e+02  4.47702507e+02  6.11333299e+02  1.16319759e+03
  1.16319759e+03  1.16319759e+03  2.62909609e+03  2.68086874e+03
  2.68086874e+03  2.68086874e+03  6.19523377e+03  6.19523377e+03
  6.19523377e+03  8.86603389e+03  2.50919008e+04  7.57927720e+04]
E1 = -728.3771424787609  E_coul = 201.6637619285157
Extra cycle  E= -526.713380550245  delta_E= -4.89e-12  |g|= 2.47e-06  |ddm|= 4.3e-06
    CPU time for scf_cycle      7.63 sec, wall time      0.52 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 17200.920712602172
E1 = -728.3771424787609  E_coul = 201.6637619285157
init E= -526.713380550245
    CPU time for initialize scf     16.30 sec, wall time      0.76 sec
  HOMO = -0.575584948078186  LUMO = 1.06631140504572
  mo_energy =
[-1.18576090e+02 -1.23034076e+01 -9.55613009e+00 -9.55613009e+00
 -9.55613009e+00 -1.25016660e+00 -5.75584948e-01 -5.75584948e-01
 -5.75584948e-01  1.06631141e+00  1.06631141e+00  1.06631141e+00
  8.03677322e+00  8.03677322e+00  8.03677322e+00  9.23518900e+00
  3.65540878e+01  3.65540878e+01  3.65540878e+01  1.08739744e+02
  1.35030577e+02  1.35030577e+02  1.35030577e+02  4.47702512e+02
  4.47702512e+02  4.47702512e+02  6.11333304e+02  1.16319760e+03
  1.16319760e+03  1.16319760e+03  2.62909610e+03  2.68086875e+03
  2.68086875e+03  2.68086875e+03  6.19523378e+03  6.19523378e+03
  6.19523378e+03  8.86603390e+03  2.50919008e+04  7.57927721e+04]
E1 = -728.3771326197246  E_coul = 201.6637520694784
cycle= 1 E= -526.713380550246  delta_E= -1.02e-12  |g|= 6.37e-07  |ddm|= 1e-06
    CPU time for cycle= 1      0.04 sec, wall time      0.02 sec
E1 = -728.3771326197246  E_coul = 201.6637520694784
  HOMO = -0.575585115746661  LUMO = 1.06631127331274
  mo_energy =
[-1.18576091e+02 -1.23034083e+01 -9.55613084e+00 -9.55613084e+00
 -9.55613084e+00 -1.25016681e+00 -5.75585116e-01 -5.75585116e-01
 -5.75585116e-01  1.06631127e+00  1.06631127e+00  1.06631127e+00
  8.03677275e+00  8.03677275e+00  8.03677275e+00  9.23518846e+00
  3.65540870e+01  3.65540870e+01  3.65540870e+01  1.08739743e+02
  1.35030576e+02  1.35030576e+02  1.35030576e+02  4.47702510e+02
  4.47702510e+02  4.47702510e+02  6.11333302e+02  1.16319760e+03
  1.16319760e+03  1.16319760e+03  2.62909610e+03  2.68086875e+03
  2.68086875e+03  2.68086875e+03  6.19523378e+03  6.19523378e+03
  6.19523378e+03  8.86603390e+03  2.50919008e+04  7.57927721e+04]
E1 = -728.3771350343894  E_coul = 201.66375448414382
Extra cycle  E= -526.713380550246  delta_E= 6.82e-13  |g|= 1.61e-07  |ddm|= 2.35e-07
    CPU time for scf_cycle     16.43 sec, wall time      0.88 sec
exp = [2.61866935e+04 7.61097733e+03 3.62334432e+03 1.48148214e+03
 3.88968982e+02 1.15143201e+02 3.74842333e+01 7.68311196e+00
 3.04918557e+00 3.99585608e-01 1.36429839e+03 6.50833967e+02
 2.35148412e+02 2.57711934e+02 6.31842044e+01 7.87927182e+00
 2.15817130e+01 8.05111262e-01 3.08412337e+00 2.27840961e-01]
grad_E = [-1.40765418e-06  2.24476029e-06 -2.96079191e-06  5.42523705e-05
 -9.19446826e-05  2.67145899e-04 -8.97482106e-04 -2.21156162e-03
  2.67442288e-03  1.55564459e-02 -8.21037294e-07  2.31117540e-06
  8.02450111e-06  4.82776620e-06 -4.00984531e-05 -1.00704090e-02
  2.58653081e-03  2.49167262e-02  1.88224877e-02 -7.69573347e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:03:45 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26193.9419017        1
[INPUT] 0    0    [1    /1   ]  7599.41945442        1
[INPUT] 0    0    [1    /1   ]  3634.26000156        1
[INPUT] 0    0    [1    /1   ]  1278.84698898        1
[INPUT] 0    0    [1    /1   ]  352.327060756        1
[INPUT] 0    0    [1    /1   ]  107.543332596        1
[INPUT] 0    0    [1    /1   ]  35.8582540243        1
[INPUT] 0    0    [1    /1   ]  7.44323416906        1
[INPUT] 0    0    [1    /1   ]  2.96357902272        1
[INPUT] 0    0    [1    /1   ]  0.400359364459       1
[INPUT] 1    0    [1    /1   ]  1367.03350572        1
[INPUT] 1    0    [1    /1   ]  625.842919087        1
[INPUT] 1    0    [1    /1   ]  116.940833218        1
[INPUT] 1    0    [1    /1   ]  156.562894654        1
[INPUT] 1    0    [1    /1   ]  60.2489842531        1
[INPUT] 1    0    [1    /1   ]  7.96644844276        1
[INPUT] 1    0    [1    /1   ]  21.7206127134        1
[INPUT] 1    0    [1    /1   ]  0.815495485501       1
[INPUT] 1    0    [1    /1   ]  3.1559037281         1
[INPUT] 1    0    [1    /1   ]  0.228802165596       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26193.941901652634, 1.0]], [0, [7599.419454424924, 1.0]], [0, [3634.2600015620646, 1.0]], [0, [1278.8469889828198, 1.0]], [0, [352.32706075564073, 1.0]], [0, [107.54333259601978, 1.0]], [0, [35.858254024268156, 1.0]], [0, [7.443234169060342, 1.0]], [0, [2.9635790227236662, 1.0]], [0, [0.40035936445939574, 1.0]], [1, [1367.033505717311, 1.0]], [1, [625.8429190871261, 1.0]], [1, [116.94083321820588, 1.0]], [1, [156.56289465369272, 1.0]], [1, [60.248984253086874, 1.0]], [1, [7.966448442757899, 1.0]], [1, [21.720612713368272, 1.0]], [1, [0.8154954855010089, 1.0]], [1, [3.1559037281044153, 1.0]], [1, [0.2288021655963381, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26193.94190165]
bas 1, expnt(s) = [7599.41945442]
bas 2, expnt(s) = [3634.26000156]
bas 3, expnt(s) = [1278.84698898]
bas 4, expnt(s) = [352.32706076]
bas 5, expnt(s) = [107.5433326]
bas 6, expnt(s) = [35.85825402]
bas 7, expnt(s) = [7.44323417]
bas 8, expnt(s) = [2.96357902]
bas 9, expnt(s) = [0.40035936]
bas 10, expnt(s) = [1367.03350572]
bas 11, expnt(s) = [625.84291909]
bas 12, expnt(s) = [116.94083322]
bas 13, expnt(s) = [156.56289465]
bas 14, expnt(s) = [60.24898425]
bas 15, expnt(s) = [7.96644844]
bas 16, expnt(s) = [21.72061271]
bas 17, expnt(s) = [0.81549549]
bas 18, expnt(s) = [3.15590373]
bas 19, expnt(s) = [0.22880217]
CPU time:      2162.76
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61939419e+04 5.20194396e+03 7.59941945e+03 2.05636563e+03
 3.63426000e+03 1.18257044e+03 1.27884699e+03 5.40292530e+02
 3.52327061e+02 2.05458695e+02 1.07543333e+02 8.43728350e+01
 3.58582540e+01 3.70217445e+01 7.44323417e+00 1.13850852e+01
 2.96357902e+00 5.70659969e+00 4.00359364e-01 1.27160585e+00
 1.36703351e+03 2.42498101e+04 6.25842919e+02 9.13200354e+03
 1.16940833e+02 1.12186894e+03 1.56562895e+02 1.61564316e+03
 6.02489843e+01 4.89690360e+02 7.96644844e+00 3.90449912e+01
 2.17206127e+01 1.36796341e+02 8.15495486e-01 2.26079583e+00
 3.15590373e+00 1.22712577e+01 2.28802166e-01 4.61646509e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.981473734509635
cond(S) = 2574.1943991473136
E1 = -729.4092043864963  E_coul = 203.14399005285517
init E= -526.265214333641
    CPU time for initialize scf      7.21 sec, wall time      0.34 sec
  HOMO = -0.556254228148751  LUMO = 1.09274152427119
  mo_energy =
[-1.18338614e+02 -1.22068549e+01 -9.44962531e+00 -9.44962531e+00
 -9.44962531e+00 -1.22539710e+00 -5.56254228e-01 -5.56254228e-01
 -5.56254228e-01  1.09274152e+00  1.09274152e+00  1.09274152e+00
  8.26000813e+00  8.26000813e+00  8.26000813e+00  8.78806606e+00
  3.66445109e+01  3.66445109e+01  3.66445109e+01  1.01030286e+02
  1.24273078e+02  1.24273078e+02  1.24273078e+02  3.41187826e+02
  3.41187826e+02  3.41187826e+02  5.57323653e+02  7.76725229e+02
  7.76725229e+02  7.76725229e+02  1.96957036e+03  1.96957036e+03
  1.96957036e+03  2.36339639e+03  5.35910191e+03  5.35910191e+03
  5.35910191e+03  8.25130351e+03  2.42606666e+04  7.49158114e+04]
E1 = -728.0160828600542  E_coul = 201.29692065611232
cycle= 1 E= -526.719162203942  delta_E= -0.454  |g|= 0.183  |ddm|= 0.355
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.575395
diis-c [-0.33107975  1.        ]
  HOMO = -0.581726398653022  LUMO = 1.07458959506536
  mo_energy =
[-1.18629997e+02 -1.23295894e+01 -9.58291171e+00 -9.58291171e+00
 -9.58291171e+00 -1.25800522e+00 -5.81726399e-01 -5.81726399e-01
 -5.81726399e-01  1.07458960e+00  1.07458960e+00  1.07458960e+00
  8.17797546e+00  8.17797546e+00  8.17797546e+00  8.70240278e+00
  3.65040324e+01  3.65040324e+01  3.65040324e+01  1.00827690e+02
  1.24076382e+02  1.24076382e+02  1.24076382e+02  3.40945270e+02
  3.40945270e+02  3.40945270e+02  5.57003366e+02  7.76431055e+02
  7.76431055e+02  7.76431055e+02  1.96917673e+03  1.96917673e+03
  1.96917673e+03  2.36293375e+03  5.35857649e+03  5.35857649e+03
  5.35857649e+03  8.25071166e+03  2.42599749e+04  7.49150295e+04]
E1 = -728.47999987936  E_coul = 201.76024680172821
cycle= 2 E= -526.719753077632  delta_E= -0.000591  |g|= 0.0335  |ddm|= 0.0391
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0772854
diis-c [-0.00299587  0.08697448  0.91302552]
  HOMO = -0.575123917730769  LUMO = 1.07994327580721
  mo_energy =
[-1.18572267e+02 -1.22991578e+01 -9.55117363e+00 -9.55117363e+00
 -9.55117363e+00 -1.24961087e+00 -5.75123918e-01 -5.75123918e-01
 -5.75123918e-01  1.07994328e+00  1.07994328e+00  1.07994328e+00
  8.19742004e+00  8.19742004e+00  8.19742004e+00  8.72528755e+00
  3.65366248e+01  3.65366248e+01  3.65366248e+01  1.00874352e+02
  1.24120594e+02  1.24120594e+02  1.24120594e+02  3.40997221e+02
  3.40997221e+02  3.40997221e+02  5.57062178e+02  7.76488204e+02
  7.76488204e+02  7.76488204e+02  1.96923860e+03  1.96923860e+03
  1.96923860e+03  2.36299712e+03  5.35864068e+03  5.35864068e+03
  5.35864068e+03  8.25077650e+03  2.42600402e+04  7.49150951e+04]
E1 = -728.3751834097079  E_coul = 201.6553948431294
cycle= 3 E= -526.719788566578  delta_E= -3.55e-05  |g|= 0.00433  |ddm|= 0.0105
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0109722
diis-c [-4.94213561e-07 -1.11962820e-03  1.19454219e-01  8.81665409e-01]
  HOMO = -0.575972914225611  LUMO = 1.07926753121701
  mo_energy =
[-1.18579068e+02 -1.23028199e+01 -9.55509836e+00 -9.55509836e+00
 -9.55509836e+00 -1.25063267e+00 -5.75972914e-01 -5.75972914e-01
 -5.75972914e-01  1.07926753e+00  1.07926753e+00  1.07926753e+00
  8.19497610e+00  8.19497610e+00  8.19497610e+00  8.72260798e+00
  3.65326291e+01  3.65326291e+01  3.65326291e+01  1.00868857e+02
  1.24115308e+02  1.24115308e+02  1.24115308e+02  3.40991079e+02
  3.40991079e+02  3.40991079e+02  5.57055225e+02  7.76481460e+02
  7.76481460e+02  7.76481460e+02  1.96923121e+03  1.96923121e+03
  1.96923121e+03  2.36298946e+03  5.35863285e+03  5.35863285e+03
  5.35863285e+03  8.25076849e+03  2.42600320e+04  7.49150868e+04]
E1 = -728.3882450448382  E_coul = 201.66845577172586
cycle= 4 E= -526.719789273112  delta_E= -7.07e-07  |g|= 6.39e-05  |ddm|= 0.00122
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000146006
diis-c [-1.58144766e-09  6.13382332e-05 -7.81457020e-03 -7.01441315e-02
  1.07789736e+00]
  HOMO = -0.575959722922585  LUMO = 1.07927791143664
  mo_energy =
[-1.18579069e+02 -1.23027866e+01 -9.55507747e+00 -9.55507747e+00
 -9.55507747e+00 -1.25061139e+00 -5.75959723e-01 -5.75959723e-01
 -5.75959723e-01  1.07927791e+00  1.07927791e+00  1.07927791e+00
  8.19499941e+00  8.19499941e+00  8.19499941e+00  8.72264760e+00
  3.65326488e+01  3.65326488e+01  3.65326488e+01  1.00868873e+02
  1.24115321e+02  1.24115321e+02  1.24115321e+02  3.40991086e+02
  3.40991086e+02  3.40991086e+02  5.57055219e+02  7.76481458e+02
  7.76481458e+02  7.76481458e+02  1.96923120e+03  1.96923120e+03
  1.96923120e+03  2.36298943e+03  5.35863281e+03  5.35863281e+03
  5.35863281e+03  8.25076845e+03  2.42600320e+04  7.49150868e+04]
E1 = -728.388232093737  E_coul = 201.66844282048825
cycle= 5 E= -526.719789273249  delta_E= -1.36e-10  |g|= 9.09e-06  |ddm|= 2.95e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.388232093737  E_coul = 201.66844282048825
  HOMO = -0.575963624470649  LUMO = 1.0792748576337
  mo_energy =
[-1.18579089e+02 -1.23028006e+01 -9.55509216e+00 -9.55509216e+00
 -9.55509216e+00 -1.25061615e+00 -5.75963624e-01 -5.75963624e-01
 -5.75963624e-01  1.07927486e+00  1.07927486e+00  1.07927486e+00
  8.19498931e+00  8.19498931e+00  8.19498931e+00  8.72263677e+00
  3.65326342e+01  3.65326342e+01  3.65326342e+01  1.00868855e+02
  1.24115304e+02  1.24115304e+02  1.24115304e+02  3.40991067e+02
  3.40991067e+02  3.40991067e+02  5.57055198e+02  7.76481438e+02
  7.76481438e+02  7.76481438e+02  1.96923118e+03  1.96923118e+03
  1.96923118e+03  2.36298941e+03  5.35863279e+03  5.35863279e+03
  5.35863279e+03  8.25076843e+03  2.42600320e+04  7.49150867e+04]
E1 = -728.3882771972292  E_coul = 201.66848792397494
Extra cycle  E= -526.719789273254  delta_E= -5.57e-12  |g|= 2.71e-06  |ddm|= 4.69e-06
    CPU time for scf_cycle      7.40 sec, wall time      0.53 sec
exp = [2.61939419e+04 7.59941945e+03 3.63426000e+03 1.27884699e+03
 3.52327061e+02 1.07543333e+02 3.58582540e+01 7.44323417e+00
 2.96357902e+00 4.00359364e-01 1.36703351e+03 6.25842919e+02
 1.16940833e+02 1.56562895e+02 6.02489843e+01 7.96644844e+00
 2.17206127e+01 8.15495486e-01 3.15590373e+00 2.28802166e-01]
E = -526.7197892732543
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:03:46 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26193.9419017        1
[INPUT] 0    0    [1    /1   ]  7599.41945442        1
[INPUT] 0    0    [1    /1   ]  3634.26000156        1
[INPUT] 0    0    [1    /1   ]  1278.84698898        1
[INPUT] 0    0    [1    /1   ]  352.327060756        1
[INPUT] 0    0    [1    /1   ]  107.543332596        1
[INPUT] 0    0    [1    /1   ]  35.8582540243        1
[INPUT] 0    0    [1    /1   ]  7.44323416906        1
[INPUT] 0    0    [1    /1   ]  2.96357902272        1
[INPUT] 0    0    [1    /1   ]  0.400359364459       1
[INPUT] 1    0    [1    /1   ]  1367.03350572        1
[INPUT] 1    0    [1    /1   ]  625.842919087        1
[INPUT] 1    0    [1    /1   ]  116.940833218        1
[INPUT] 1    0    [1    /1   ]  156.562894654        1
[INPUT] 1    0    [1    /1   ]  60.2489842531        1
[INPUT] 1    0    [1    /1   ]  7.96644844276        1
[INPUT] 1    0    [1    /1   ]  21.7206127134        1
[INPUT] 1    0    [1    /1   ]  0.815495485501       1
[INPUT] 1    0    [1    /1   ]  3.1559037281         1
[INPUT] 1    0    [1    /1   ]  0.228802165596       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26193.941901652634, 1.0]], [0, [7599.419454424924, 1.0]], [0, [3634.2600015620646, 1.0]], [0, [1278.8469889828198, 1.0]], [0, [352.32706075564073, 1.0]], [0, [107.54333259601978, 1.0]], [0, [35.858254024268156, 1.0]], [0, [7.443234169060342, 1.0]], [0, [2.9635790227236662, 1.0]], [0, [0.40035936445939574, 1.0]], [1, [1367.033505717311, 1.0]], [1, [625.8429190871261, 1.0]], [1, [116.94083321820588, 1.0]], [1, [156.56289465369272, 1.0]], [1, [60.248984253086874, 1.0]], [1, [7.966448442757899, 1.0]], [1, [21.720612713368272, 1.0]], [1, [0.8154954855010089, 1.0]], [1, [3.1559037281044153, 1.0]], [1, [0.2288021655963381, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26193.94190165]
bas 1, expnt(s) = [7599.41945442]
bas 2, expnt(s) = [3634.26000156]
bas 3, expnt(s) = [1278.84698898]
bas 4, expnt(s) = [352.32706076]
bas 5, expnt(s) = [107.5433326]
bas 6, expnt(s) = [35.85825402]
bas 7, expnt(s) = [7.44323417]
bas 8, expnt(s) = [2.96357902]
bas 9, expnt(s) = [0.40035936]
bas 10, expnt(s) = [1367.03350572]
bas 11, expnt(s) = [625.84291909]
bas 12, expnt(s) = [116.94083322]
bas 13, expnt(s) = [156.56289465]
bas 14, expnt(s) = [60.24898425]
bas 15, expnt(s) = [7.96644844]
bas 16, expnt(s) = [21.72061271]
bas 17, expnt(s) = [0.81549549]
bas 18, expnt(s) = [3.15590373]
bas 19, expnt(s) = [0.22880217]
CPU time:      2170.53
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61939419e+04 5.20194396e+03 7.59941945e+03 2.05636563e+03
 3.63426000e+03 1.18257044e+03 1.27884699e+03 5.40292530e+02
 3.52327061e+02 2.05458695e+02 1.07543333e+02 8.43728350e+01
 3.58582540e+01 3.70217445e+01 7.44323417e+00 1.13850852e+01
 2.96357902e+00 5.70659969e+00 4.00359364e-01 1.27160585e+00
 1.36703351e+03 2.42498101e+04 6.25842919e+02 9.13200354e+03
 1.16940833e+02 1.12186894e+03 1.56562895e+02 1.61564316e+03
 6.02489843e+01 4.89690360e+02 7.96644844e+00 3.90449912e+01
 2.17206127e+01 1.36796341e+02 8.15495486e-01 2.26079583e+00
 3.15590373e+00 1.22712577e+01 2.28802166e-01 4.61646509e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.981473734509635
cond(S) = 2574.1943991473136
E1 = -729.4092043864963  E_coul = 203.14399005285517
init E= -526.265214333641
    CPU time for initialize scf      7.34 sec, wall time      0.34 sec
  HOMO = -0.556254228148751  LUMO = 1.09274152427119
  mo_energy =
[-1.18338614e+02 -1.22068549e+01 -9.44962531e+00 -9.44962531e+00
 -9.44962531e+00 -1.22539710e+00 -5.56254228e-01 -5.56254228e-01
 -5.56254228e-01  1.09274152e+00  1.09274152e+00  1.09274152e+00
  8.26000813e+00  8.26000813e+00  8.26000813e+00  8.78806606e+00
  3.66445109e+01  3.66445109e+01  3.66445109e+01  1.01030286e+02
  1.24273078e+02  1.24273078e+02  1.24273078e+02  3.41187826e+02
  3.41187826e+02  3.41187826e+02  5.57323653e+02  7.76725229e+02
  7.76725229e+02  7.76725229e+02  1.96957036e+03  1.96957036e+03
  1.96957036e+03  2.36339639e+03  5.35910191e+03  5.35910191e+03
  5.35910191e+03  8.25130351e+03  2.42606666e+04  7.49158114e+04]
E1 = -728.0160828600542  E_coul = 201.29692065611232
cycle= 1 E= -526.719162203942  delta_E= -0.454  |g|= 0.183  |ddm|= 0.355
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.575395
diis-c [-0.33107975  1.        ]
  HOMO = -0.581726398653022  LUMO = 1.07458959506536
  mo_energy =
[-1.18629997e+02 -1.23295894e+01 -9.58291171e+00 -9.58291171e+00
 -9.58291171e+00 -1.25800522e+00 -5.81726399e-01 -5.81726399e-01
 -5.81726399e-01  1.07458960e+00  1.07458960e+00  1.07458960e+00
  8.17797546e+00  8.17797546e+00  8.17797546e+00  8.70240278e+00
  3.65040324e+01  3.65040324e+01  3.65040324e+01  1.00827690e+02
  1.24076382e+02  1.24076382e+02  1.24076382e+02  3.40945270e+02
  3.40945270e+02  3.40945270e+02  5.57003366e+02  7.76431055e+02
  7.76431055e+02  7.76431055e+02  1.96917673e+03  1.96917673e+03
  1.96917673e+03  2.36293375e+03  5.35857649e+03  5.35857649e+03
  5.35857649e+03  8.25071166e+03  2.42599749e+04  7.49150295e+04]
E1 = -728.47999987936  E_coul = 201.76024680172821
cycle= 2 E= -526.719753077632  delta_E= -0.000591  |g|= 0.0335  |ddm|= 0.0391
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0772854
diis-c [-0.00299587  0.08697448  0.91302552]
  HOMO = -0.575123917730769  LUMO = 1.07994327580721
  mo_energy =
[-1.18572267e+02 -1.22991578e+01 -9.55117363e+00 -9.55117363e+00
 -9.55117363e+00 -1.24961087e+00 -5.75123918e-01 -5.75123918e-01
 -5.75123918e-01  1.07994328e+00  1.07994328e+00  1.07994328e+00
  8.19742004e+00  8.19742004e+00  8.19742004e+00  8.72528755e+00
  3.65366248e+01  3.65366248e+01  3.65366248e+01  1.00874352e+02
  1.24120594e+02  1.24120594e+02  1.24120594e+02  3.40997221e+02
  3.40997221e+02  3.40997221e+02  5.57062178e+02  7.76488204e+02
  7.76488204e+02  7.76488204e+02  1.96923860e+03  1.96923860e+03
  1.96923860e+03  2.36299712e+03  5.35864068e+03  5.35864068e+03
  5.35864068e+03  8.25077650e+03  2.42600402e+04  7.49150951e+04]
E1 = -728.3751834097079  E_coul = 201.6553948431294
cycle= 3 E= -526.719788566578  delta_E= -3.55e-05  |g|= 0.00433  |ddm|= 0.0105
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0109722
diis-c [-4.94213561e-07 -1.11962820e-03  1.19454219e-01  8.81665409e-01]
  HOMO = -0.575972914225611  LUMO = 1.07926753121701
  mo_energy =
[-1.18579068e+02 -1.23028199e+01 -9.55509836e+00 -9.55509836e+00
 -9.55509836e+00 -1.25063267e+00 -5.75972914e-01 -5.75972914e-01
 -5.75972914e-01  1.07926753e+00  1.07926753e+00  1.07926753e+00
  8.19497610e+00  8.19497610e+00  8.19497610e+00  8.72260798e+00
  3.65326291e+01  3.65326291e+01  3.65326291e+01  1.00868857e+02
  1.24115308e+02  1.24115308e+02  1.24115308e+02  3.40991079e+02
  3.40991079e+02  3.40991079e+02  5.57055225e+02  7.76481460e+02
  7.76481460e+02  7.76481460e+02  1.96923121e+03  1.96923121e+03
  1.96923121e+03  2.36298946e+03  5.35863285e+03  5.35863285e+03
  5.35863285e+03  8.25076849e+03  2.42600320e+04  7.49150868e+04]
E1 = -728.3882450448382  E_coul = 201.66845577172586
cycle= 4 E= -526.719789273112  delta_E= -7.07e-07  |g|= 6.39e-05  |ddm|= 0.00122
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000146006
diis-c [-1.58144766e-09  6.13382332e-05 -7.81457020e-03 -7.01441315e-02
  1.07789736e+00]
  HOMO = -0.575959722922585  LUMO = 1.07927791143664
  mo_energy =
[-1.18579069e+02 -1.23027866e+01 -9.55507747e+00 -9.55507747e+00
 -9.55507747e+00 -1.25061139e+00 -5.75959723e-01 -5.75959723e-01
 -5.75959723e-01  1.07927791e+00  1.07927791e+00  1.07927791e+00
  8.19499941e+00  8.19499941e+00  8.19499941e+00  8.72264760e+00
  3.65326488e+01  3.65326488e+01  3.65326488e+01  1.00868873e+02
  1.24115321e+02  1.24115321e+02  1.24115321e+02  3.40991086e+02
  3.40991086e+02  3.40991086e+02  5.57055219e+02  7.76481458e+02
  7.76481458e+02  7.76481458e+02  1.96923120e+03  1.96923120e+03
  1.96923120e+03  2.36298943e+03  5.35863281e+03  5.35863281e+03
  5.35863281e+03  8.25076845e+03  2.42600320e+04  7.49150868e+04]
E1 = -728.388232093737  E_coul = 201.66844282048825
cycle= 5 E= -526.719789273249  delta_E= -1.36e-10  |g|= 9.09e-06  |ddm|= 2.95e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.388232093737  E_coul = 201.66844282048825
  HOMO = -0.575963624470649  LUMO = 1.0792748576337
  mo_energy =
[-1.18579089e+02 -1.23028006e+01 -9.55509216e+00 -9.55509216e+00
 -9.55509216e+00 -1.25061615e+00 -5.75963624e-01 -5.75963624e-01
 -5.75963624e-01  1.07927486e+00  1.07927486e+00  1.07927486e+00
  8.19498931e+00  8.19498931e+00  8.19498931e+00  8.72263677e+00
  3.65326342e+01  3.65326342e+01  3.65326342e+01  1.00868855e+02
  1.24115304e+02  1.24115304e+02  1.24115304e+02  3.40991067e+02
  3.40991067e+02  3.40991067e+02  5.57055198e+02  7.76481438e+02
  7.76481438e+02  7.76481438e+02  1.96923118e+03  1.96923118e+03
  1.96923118e+03  2.36298941e+03  5.35863279e+03  5.35863279e+03
  5.35863279e+03  8.25076843e+03  2.42600320e+04  7.49150867e+04]
E1 = -728.3882771972292  E_coul = 201.66848792397494
Extra cycle  E= -526.719789273254  delta_E= -5.57e-12  |g|= 2.71e-06  |ddm|= 4.69e-06
    CPU time for scf_cycle      7.54 sec, wall time      0.52 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2574.1943991473136
E1 = -728.3882771972292  E_coul = 201.66848792397494
init E= -526.719789273254
    CPU time for initialize scf     16.18 sec, wall time      0.77 sec
  HOMO = -0.57596280048426  LUMO = 1.07927551144994
  mo_energy =
[-1.18579084e+02 -1.23027973e+01 -9.55508874e+00 -9.55508874e+00
 -9.55508874e+00 -1.25061511e+00 -5.75962800e-01 -5.75962800e-01
 -5.75962800e-01  1.07927551e+00  1.07927551e+00  1.07927551e+00
  8.19499154e+00  8.19499154e+00  8.19499154e+00  8.72263931e+00
  3.65326377e+01  3.65326377e+01  3.65326377e+01  1.00868860e+02
  1.24115308e+02  1.24115308e+02  1.24115308e+02  3.40991072e+02
  3.40991072e+02  3.40991072e+02  5.57055204e+02  7.76481444e+02
  7.76481444e+02  7.76481444e+02  1.96923118e+03  1.96923118e+03
  1.96923118e+03  2.36298942e+03  5.35863280e+03  5.35863280e+03
  5.35863280e+03  8.25076843e+03  2.42600320e+04  7.49150867e+04]
E1 = -728.3882663408594  E_coul = 201.6684770676045
cycle= 1 E= -526.719789273255  delta_E= -6.82e-13  |g|= 7e-07  |ddm|= 1.12e-06
    CPU time for cycle= 1      0.04 sec, wall time      0.02 sec
E1 = -728.3882663408594  E_coul = 201.6684770676045
  HOMO = -0.575962985411731  LUMO = 1.0792753638616
  mo_energy =
[-1.18579085e+02 -1.23027980e+01 -9.55508957e+00 -9.55508957e+00
 -9.55508957e+00 -1.25061534e+00 -5.75962985e-01 -5.75962985e-01
 -5.75962985e-01  1.07927536e+00  1.07927536e+00  1.07927536e+00
  8.19499102e+00  8.19499102e+00  8.19499102e+00  8.72263873e+00
  3.65326368e+01  3.65326368e+01  3.65326368e+01  1.00868859e+02
  1.24115307e+02  1.24115307e+02  1.24115307e+02  3.40991071e+02
  3.40991071e+02  3.40991071e+02  5.57055203e+02  7.76481442e+02
  7.76481442e+02  7.76481442e+02  1.96923118e+03  1.96923118e+03
  1.96923118e+03  2.36298942e+03  5.35863280e+03  5.35863280e+03
  5.35863280e+03  8.25076843e+03  2.42600320e+04  7.49150867e+04]
E1 = -728.3882690220361  E_coul = 201.66847974878124
Extra cycle  E= -526.719789273255  delta_E= 1.14e-13  |g|= 1.78e-07  |ddm|= 2.63e-07
    CPU time for scf_cycle     16.31 sec, wall time      0.89 sec
exp = [2.61939419e+04 7.59941945e+03 3.63426000e+03 1.27884699e+03
 3.52327061e+02 1.07543333e+02 3.58582540e+01 7.44323417e+00
 2.96357902e+00 4.00359364e-01 1.36703351e+03 6.25842919e+02
 1.16940833e+02 1.56562895e+02 6.02489843e+01 7.96644844e+00
 2.17206127e+01 8.15495486e-01 3.15590373e+00 2.28802166e-01]
grad_E = [-1.29083780e-06  1.42530065e-06 -3.81593024e-06  5.96432263e-05
 -9.05101952e-05  2.87369357e-04 -1.20195530e-03 -3.71371765e-03
  4.00811671e-03  2.71659160e-02 -1.05926210e-06  8.42375319e-06
 -1.15440485e-05 -3.42824782e-05 -3.00257757e-04 -1.84466612e-02
  5.30220111e-03  4.26266106e-02  3.09418734e-02 -1.30333904e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:03:51 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26196.911088         1
[INPUT] 0    0    [1    /1   ]  7594.68426247        1
[INPUT] 0    0    [1    /1   ]  3638.73096205        1
[INPUT] 0    0    [1    /1   ]  1195.8207478         1
[INPUT] 0    0    [1    /1   ]  337.417364501        1
[INPUT] 0    0    [1    /1   ]  104.749059877        1
[INPUT] 0    0    [1    /1   ]  35.3329351088        1
[INPUT] 0    0    [1    /1   ]  7.54300847915        1
[INPUT] 0    0    [1    /1   ]  2.97984308431        1
[INPUT] 0    0    [1    /1   ]  0.40008458327        1
[INPUT] 1    0    [1    /1   ]  1368.15525359        1
[INPUT] 1    0    [1    /1   ]  615.625582158        1
[INPUT] 1    0    [1    /1   ]  68.6294205602        1
[INPUT] 1    0    [1    /1   ]  115.223923783        1
[INPUT] 1    0    [1    /1   ]  57.2940558142        1
[INPUT] 1    0    [1    /1   ]  7.67249718882        1
[INPUT] 1    0    [1    /1   ]  20.8852609393        1
[INPUT] 1    0    [1    /1   ]  0.801160376919       1
[INPUT] 1    0    [1    /1   ]  3.03124280171        1
[INPUT] 1    0    [1    /1   ]  0.22636372171        1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26196.911087983328, 1.0]], [0, [7594.6842624669, 1.0]], [0, [3638.7309620504043, 1.0]], [0, [1195.8207478027825, 1.0]], [0, [337.4173645011969, 1.0]], [0, [104.74905987651653, 1.0]], [0, [35.33293510876522, 1.0]], [0, [7.543008479152986, 1.0]], [0, [2.9798430843109567, 1.0]], [0, [0.40008458326953933, 1.0]], [1, [1368.155253586766, 1.0]], [1, [615.6255821576163, 1.0]], [1, [68.62942056018329, 1.0]], [1, [115.223923782692, 1.0]], [1, [57.294055814207425, 1.0]], [1, [7.672497188823961, 1.0]], [1, [20.885260939325384, 1.0]], [1, [0.8011603769194319, 1.0]], [1, [3.0312428017129074, 1.0]], [1, [0.22636372170964292, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26196.91108798]
bas 1, expnt(s) = [7594.68426247]
bas 2, expnt(s) = [3638.73096205]
bas 3, expnt(s) = [1195.8207478]
bas 4, expnt(s) = [337.4173645]
bas 5, expnt(s) = [104.74905988]
bas 6, expnt(s) = [35.33293511]
bas 7, expnt(s) = [7.54300848]
bas 8, expnt(s) = [2.97984308]
bas 9, expnt(s) = [0.40008458]
bas 10, expnt(s) = [1368.15525359]
bas 11, expnt(s) = [615.62558216]
bas 12, expnt(s) = [68.62942056]
bas 13, expnt(s) = [115.22392378]
bas 14, expnt(s) = [57.29405581]
bas 15, expnt(s) = [7.67249719]
bas 16, expnt(s) = [20.88526094]
bas 17, expnt(s) = [0.80116038]
bas 18, expnt(s) = [3.0312428]
bas 19, expnt(s) = [0.22636372]
CPU time:      2199.37
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61969111e+04 5.20238620e+03 7.59468426e+03 2.05540457e+03
 3.63873096e+03 1.18366140e+03 1.19582075e+03 5.13765086e+02
 3.37417365e+02 1.98902662e+02 1.04749060e+02 8.27232569e+01
 3.53329351e+01 3.66142221e+01 7.54300848e+00 1.14993547e+01
 2.97984308e+00 5.73007189e+00 4.00084583e-01 1.27095123e+00
 1.36815525e+03 2.42746860e+04 6.15625582e+02 8.94602723e+03
 6.86294206e+01 5.76265086e+02 1.15223924e+02 1.10131795e+03
 5.72940558e+01 4.59855464e+02 7.67249719e+00 3.72524907e+01
 2.08852609e+01 1.30251962e+02 8.01160377e-01 2.21122899e+00
 3.03124280e+00 1.16683729e+01 2.26363722e-01 4.55504765e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98206921845263
cond(S) = 14746.775802192611
E1 = -729.3940862624162  E_coul = 203.14037867253612
init E= -526.25370758988
    CPU time for initialize scf      7.62 sec, wall time      0.35 sec
  HOMO = -0.556367115370546  LUMO = 1.06956049658039
  mo_energy =
[-1.18340874e+02 -1.22075202e+01 -9.44885233e+00 -9.44885233e+00
 -9.44885233e+00 -1.22534941e+00 -5.56367115e-01 -5.56367115e-01
 -5.56367115e-01  1.06956050e+00  1.06956050e+00  1.06956050e+00
  7.84778928e+00  7.84778928e+00  7.84778928e+00  8.91082764e+00
  3.42462121e+01  3.42462121e+01  3.42462121e+01  9.92536387e+01
  1.08938118e+02  1.08938118e+02  1.08938118e+02  2.75828344e+02
  2.75828344e+02  2.75828344e+02  5.37577051e+02  5.85380112e+02
  5.85380112e+02  5.85380112e+02  1.65056804e+03  1.65056804e+03
  1.65056804e+03  2.25328965e+03  5.02612916e+03  5.02612916e+03
  5.02612916e+03  7.99204552e+03  2.39181089e+04  7.45596228e+04]
E1 = -727.9876295775578  E_coul = 201.27033869399384
cycle= 1 E= -526.717290883564  delta_E= -0.464  |g|= 0.185  |ddm|= 0.512
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.586926
diis-c [-0.34448212  1.        ]
  HOMO = -0.582067113861056  LUMO = 1.05175235644635
  mo_energy =
[-1.18635847e+02 -1.23319590e+01 -9.58390094e+00 -9.58390094e+00
 -9.58390094e+00 -1.25816149e+00 -5.82067114e-01 -5.82067114e-01
 -5.82067114e-01  1.05175236e+00  1.05175236e+00  1.05175236e+00
  7.76780432e+00  7.76780432e+00  7.76780432e+00  8.82372446e+00
  3.41092297e+01  3.41092297e+01  3.41092297e+01  9.90500767e+01
  1.08752345e+02  1.08752345e+02  1.08752345e+02  2.75604490e+02
  2.75604490e+02  2.75604490e+02  5.37256989e+02  5.85106155e+02
  5.85106155e+02  5.85106155e+02  1.65017235e+03  1.65017235e+03
  1.65017235e+03  2.25282864e+03  5.02559727e+03  5.02559727e+03
  5.02559727e+03  7.99145132e+03  2.39174130e+04  7.45588369e+04]
E1 = -728.4580578221644  E_coul = 201.74016036711754
cycle= 2 E= -526.717897455047  delta_E= -0.000607  |g|= 0.0339  |ddm|= 0.0405
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0838828
diis-c [-0.00326767  0.0951      0.9049    ]
  HOMO = -0.575425105497197  LUMO = 1.05700013757748
  mo_energy =
[-1.18577819e+02 -1.23013807e+01 -9.55201374e+00 -9.55201374e+00
 -9.55201374e+00 -1.24972034e+00 -5.75425105e-01 -5.75425105e-01
 -5.75425105e-01  1.05700014e+00  1.05700014e+00  1.05700014e+00
  7.78672628e+00  7.78672628e+00  7.78672628e+00  8.84684643e+00
  3.41407976e+01  3.41407976e+01  3.41407976e+01  9.90966435e+01
  1.08794172e+02  1.08794172e+02  1.08794172e+02  2.75653520e+02
  2.75653520e+02  2.75653520e+02  5.37315860e+02  5.85161175e+02
  5.85161175e+02  5.85161175e+02  1.65023436e+03  1.65023436e+03
  1.65023436e+03  2.25289226e+03  5.02566187e+03  5.02566187e+03
  5.02566187e+03  7.99151651e+03  2.39174787e+04  7.45589029e+04]
E1 = -728.3525956396307  E_coul = 201.63466160428308
cycle= 3 E= -526.717934035348  delta_E= -3.66e-05  |g|= 0.00406  |ddm|= 0.0105
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0109921
diis-c [-4.85312417e-07 -1.07761679e-03  1.11245488e-01  8.89832129e-01]
  HOMO = -0.576230367396092  LUMO = 1.05637663730591
  mo_energy =
[-1.18584210e+02 -1.23048315e+01 -9.55571822e+00 -9.55571822e+00
 -9.55571822e+00 -1.25068540e+00 -5.76230367e-01 -5.76230367e-01
 -5.76230367e-01  1.05637664e+00  1.05637664e+00  1.05637664e+00
  7.78448827e+00  7.78448827e+00  7.78448827e+00  8.84431365e+00
  3.41371538e+01  3.41371538e+01  3.41371538e+01  9.90915104e+01
  1.08789465e+02  1.08789465e+02  1.08789465e+02  2.75648073e+02
  2.75648073e+02  2.75648073e+02  5.37309355e+02  5.85155097e+02
  5.85155097e+02  5.85155097e+02  1.65022744e+03  1.65022744e+03
  1.65022744e+03  2.25288507e+03  5.02565449e+03  5.02565449e+03
  5.02565449e+03  7.99150897e+03  2.39174710e+04  7.45588951e+04]
E1 = -728.3649408397499  E_coul = 201.64700617644553
cycle= 4 E= -526.717934663304  delta_E= -6.28e-07  |g|= 6.36e-05  |ddm|= 0.00115
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000139672
diis-c [-1.77384214e-09  5.96266474e-05 -7.00223346e-03 -6.78548750e-02
  1.07479748e+00]
  HOMO = -0.576215945825499  LUMO = 1.05638774866493
  mo_energy =
[-1.18584203e+02 -1.23047932e+01 -9.55569218e+00 -9.55569218e+00
 -9.55569218e+00 -1.25066263e+00 -5.76215946e-01 -5.76215946e-01
 -5.76215946e-01  1.05638775e+00  1.05638775e+00  1.05638775e+00
  7.78451483e+00  7.78451483e+00  7.78451483e+00  8.84435721e+00
  3.41371792e+01  3.41371792e+01  3.41371792e+01  9.90915335e+01
  1.08789486e+02  1.08789486e+02  1.08789486e+02  2.75648091e+02
  2.75648091e+02  2.75648091e+02  5.37309358e+02  5.85155107e+02
  5.85155107e+02  5.85155107e+02  1.65022743e+03  1.65022743e+03
  1.65022743e+03  2.25288505e+03  5.02565446e+03  5.02565446e+03
  5.02565446e+03  7.99150894e+03  2.39174710e+04  7.45588950e+04]
E1 = -728.3649119355335  E_coul = 201.64697727209187
cycle= 5 E= -526.717934663442  delta_E= -1.37e-10  |g|= 9.26e-06  |ddm|= 3.01e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3649119355335  E_coul = 201.64697727209187
  HOMO = -0.576219899563229  LUMO = 1.05638473181742
  mo_energy =
[-1.18584223e+02 -1.23048074e+01 -9.55570709e+00 -9.55570709e+00
 -9.55570709e+00 -1.25066744e+00 -5.76219900e-01 -5.76219900e-01
 -5.76219900e-01  1.05638473e+00  1.05638473e+00  1.05638473e+00
  7.78450485e+00  7.78450485e+00  7.78450485e+00  8.84434620e+00
  3.41371648e+01  3.41371648e+01  3.41371648e+01  9.90915157e+01
  1.08789469e+02  1.08789469e+02  1.08789469e+02  2.75648072e+02
  2.75648072e+02  2.75648072e+02  5.37309337e+02  5.85155087e+02
  5.85155087e+02  5.85155087e+02  1.65022741e+03  1.65022741e+03
  1.65022741e+03  2.25288503e+03  5.02565444e+03  5.02565444e+03
  5.02565444e+03  7.99150892e+03  2.39174710e+04  7.45588950e+04]
E1 = -728.3649578488422  E_coul = 201.6470231853946
Extra cycle  E= -526.717934663448  delta_E= -6.03e-12  |g|= 2.76e-06  |ddm|= 4.77e-06
    CPU time for scf_cycle      7.81 sec, wall time      0.53 sec
exp = [2.61969111e+04 7.59468426e+03 3.63873096e+03 1.19582075e+03
 3.37417365e+02 1.04749060e+02 3.53329351e+01 7.54300848e+00
 2.97984308e+00 4.00084583e-01 1.36815525e+03 6.15625582e+02
 6.86294206e+01 1.15223924e+02 5.72940558e+01 7.67249719e+00
 2.08852609e+01 8.01160377e-01 3.03124280e+00 2.26363722e-01]
E = -526.7179346634476
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:03:52 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26194.9929996        1
[INPUT] 0    0    [1    /1   ]  7597.74318696        1
[INPUT] 0    0    [1    /1   ]  3635.84273055        1
[INPUT] 0    0    [1    /1   ]  1249.4555329         1
[INPUT] 0    0    [1    /1   ]  347.048998344        1
[INPUT] 0    0    [1    /1   ]  106.554154443        1
[INPUT] 0    0    [1    /1   ]  35.6722900734        1
[INPUT] 0    0    [1    /1   ]  7.47855447517        1
[INPUT] 0    0    [1    /1   ]  2.96933653318        1
[INPUT] 0    0    [1    /1   ]  0.400262091366       1
[INPUT] 1    0    [1    /1   ]  1367.43060672        1
[INPUT] 1    0    [1    /1   ]  622.225961299        1
[INPUT] 1    0    [1    /1   ]  99.8384961329        1
[INPUT] 1    0    [1    /1   ]  141.928815961        1
[INPUT] 1    0    [1    /1   ]  59.2029336525        1
[INPUT] 1    0    [1    /1   ]  7.86238910864        1
[INPUT] 1    0    [1    /1   ]  21.4248965081        1
[INPUT] 1    0    [1    /1   ]  0.81042082828        1
[INPUT] 1    0    [1    /1   ]  3.11177350986        1
[INPUT] 1    0    [1    /1   ]  0.227938951564       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26194.992999575523, 1.0]], [0, [7597.7431869639995, 1.0]], [0, [3635.842730552171, 1.0]], [0, [1249.4555328968358, 1.0]], [0, [347.04899834441346, 1.0]], [0, [106.55415444270011, 1.0]], [0, [35.67229007339315, 1.0]], [0, [7.478554475169808, 1.0]], [0, [2.9693365331821493, 1.0]], [0, [0.40026209136645385, 1.0]], [1, [1367.430606715454, 1.0]], [1, [622.2259612987059, 1.0]], [1, [99.83849613286125, 1.0]], [1, [141.92881596090803, 1.0]], [1, [59.20293365252768, 1.0]], [1, [7.862389108641055, 1.0]], [1, [21.42489650805566, 1.0]], [1, [0.8104208282796901, 1.0]], [1, [3.111773509855356, 1.0]], [1, [0.2279389515643006, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26194.99299958]
bas 1, expnt(s) = [7597.74318696]
bas 2, expnt(s) = [3635.84273055]
bas 3, expnt(s) = [1249.4555329]
bas 4, expnt(s) = [347.04899834]
bas 5, expnt(s) = [106.55415444]
bas 6, expnt(s) = [35.67229007]
bas 7, expnt(s) = [7.47855448]
bas 8, expnt(s) = [2.96933653]
bas 9, expnt(s) = [0.40026209]
bas 10, expnt(s) = [1367.43060672]
bas 11, expnt(s) = [622.2259613]
bas 12, expnt(s) = [99.83849613]
bas 13, expnt(s) = [141.92881596]
bas 14, expnt(s) = [59.20293365]
bas 15, expnt(s) = [7.86238911]
bas 16, expnt(s) = [21.42489651]
bas 17, expnt(s) = [0.81042083]
bas 18, expnt(s) = [3.11177351]
bas 19, expnt(s) = [0.22793895]
CPU time:      2207.52
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61949930e+04 5.20210051e+03 7.59774319e+03 2.05602543e+03
 3.63584273e+03 1.18295668e+03 1.24945553e+03 5.30952448e+02
 3.47048998e+02 2.03145928e+02 1.06554154e+02 8.37901204e+01
 3.56722901e+01 3.68776525e+01 7.47855448e+00 1.14255804e+01
 2.96933653e+00 5.71491257e+00 4.00262091e-01 1.27137413e+00
 1.36743061e+03 2.42586156e+04 6.22225961e+02 9.06608010e+03
 9.98384961e+01 9.20676230e+02 1.41928816e+02 1.42913290e+03
 5.92029337e+01 4.79085942e+02 7.86238911e+00 3.84085188e+01
 2.14248965e+01 1.34472292e+02 8.10420828e-01 2.24322396e+00
 3.11177351e+00 1.20571418e+01 2.27938952e-01 4.59470439e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98169254513212
cond(S) = 2755.6884873802214
E1 = -729.4079024855845  E_coul = 203.14290139141943
init E= -526.265001094165
    CPU time for initialize scf      7.26 sec, wall time      0.34 sec
  HOMO = -0.556306460040354  LUMO = 1.08447848740511
  mo_energy =
[-1.18339366e+02 -1.22070871e+01 -9.44962853e+00 -9.44962853e+00
 -9.44962853e+00 -1.22537530e+00 -5.56306460e-01 -5.56306460e-01
 -5.56306460e-01  1.08447849e+00  1.08447849e+00  1.08447849e+00
  8.11714105e+00  8.11714105e+00  8.11714105e+00  8.83165669e+00
  3.58594230e+01  3.58594230e+01  3.58594230e+01  1.00400623e+02
  1.19552421e+02  1.19552421e+02  1.19552421e+02  3.19629767e+02
  3.19629767e+02  3.19629767e+02  5.50322246e+02  7.10861504e+02
  7.10861504e+02  7.10861504e+02  1.85733584e+03  1.85733584e+03
  1.85733584e+03  2.32467876e+03  5.23894920e+03  5.23894920e+03
  5.23894920e+03  8.16020990e+03  2.41396805e+04  7.47896428e+04]
E1 = -728.0098608665631  E_coul = 201.2895485122385
cycle= 1 E= -526.720312354325  delta_E= -0.455  |g|= 0.184  |ddm|= 0.362
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.579809
diis-c [-0.33617825  1.        ]
  HOMO = -0.581838792897292  LUMO = 1.06646351149195
  mo_energy =
[-1.18631620e+02 -1.23303138e+01 -9.58342962e+00 -9.58342962e+00
 -9.58342962e+00 -1.25803043e+00 -5.81838793e-01 -5.81838793e-01
 -5.81838793e-01  1.06646351e+00  1.06646351e+00  1.06646351e+00
  8.03581564e+00  8.03581564e+00  8.03581564e+00  8.74555507e+00
  3.57199933e+01  3.57199933e+01  3.57199933e+01  1.00197924e+02
  1.19358952e+02  1.19358952e+02  1.19358952e+02  3.19393244e+02
  3.19393244e+02  3.19393244e+02  5.50002467e+02  7.10573955e+02
  7.10573955e+02  7.10573955e+02  1.85694227e+03  1.85694227e+03
  1.85694227e+03  2.32421715e+03  5.23842213e+03  5.23842213e+03
  5.23842213e+03  8.15961776e+03  2.41389879e+04  7.47888601e+04]
E1 = -728.4756283472531  E_coul = 201.75472094612977
cycle= 2 E= -526.720907401123  delta_E= -0.000595  |g|= 0.0336  |ddm|= 0.0392
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0793497
diis-c [-0.00307796  0.08949828  0.91050172]
  HOMO = -0.575223616212495  LUMO = 1.07177865296128
  mo_energy =
[-1.18573828e+02 -1.22998460e+01 -9.55165668e+00 -9.55165668e+00
 -9.55165668e+00 -1.24962107e+00 -5.75223616e-01 -5.75223616e-01
 -5.75223616e-01  1.07177865e+00  1.07177865e+00  1.07177865e+00
  8.05507927e+00  8.05507927e+00  8.05507927e+00  8.76851408e+00
  3.57522702e+01  3.57522702e+01  3.57522702e+01  1.00244522e+02
  1.19402468e+02  1.19402468e+02  1.19402468e+02  3.19444312e+02
  3.19444312e+02  3.19444312e+02  5.50061257e+02  7.10630460e+02
  7.10630460e+02  7.10630460e+02  1.85700413e+03  1.85700413e+03
  1.85700413e+03  2.32428055e+03  5.23848640e+03  5.23848640e+03
  5.23848640e+03  8.15968267e+03  2.41390533e+04  7.47889257e+04]
E1 = -728.3706601011556  E_coul = 201.64971691151462
cycle= 3 E= -526.720943189641  delta_E= -3.58e-05  |g|= 0.00424  |ddm|= 0.0105
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0110056
diis-c [-4.91592271e-07 -1.10757431e-03  1.17003201e-01  8.84104373e-01]
  HOMO = -0.576058385398888  LUMO = 1.07112056376522
  mo_energy =
[-1.18580499e+02 -1.23034402e+01 -9.55551089e+00 -9.55551089e+00
 -9.55551089e+00 -1.25062438e+00 -5.76058385e-01 -5.76058385e-01
 -5.76058385e-01  1.07112056e+00  1.07112056e+00  1.07112056e+00
  8.05270355e+00  8.05270355e+00  8.05270355e+00  8.76588109e+00
  3.57483860e+01  3.57483860e+01  3.57483860e+01  1.00239144e+02
  1.19397362e+02  1.19397362e+02  1.19397362e+02  3.19438390e+02
  3.19438390e+02  3.19438390e+02  5.50054448e+02  7.10623925e+02
  7.10623925e+02  7.10623925e+02  1.85699689e+03  1.85699689e+03
  1.85699689e+03  2.32427304e+03  5.23847871e+03  5.23847871e+03
  5.23847871e+03  8.15967481e+03  2.41390453e+04  7.47889176e+04]
E1 = -728.3834929141888  E_coul = 201.66254904339553
cycle= 4 E= -526.720943870793  delta_E= -6.81e-07  |g|= 6.4e-05  |ddm|= 0.0012
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000146377
diis-c [-1.62578474e-09  6.10722549e-05 -7.59043409e-03 -6.98520398e-02
  1.07738140e+00]
  HOMO = -0.576045002050092  LUMO = 1.07113101755433
  mo_energy =
[-1.18580499e+02 -1.23034062e+01 -9.55548921e+00 -9.55548921e+00
 -9.55548921e+00 -1.25060287e+00 -5.76045002e-01 -5.76045002e-01
 -5.76045002e-01  1.07113102e+00  1.07113102e+00  1.07113102e+00
  8.05272736e+00  8.05272736e+00  8.05272736e+00  8.76592136e+00
  3.57484067e+01  3.57484067e+01  3.57484067e+01  1.00239161e+02
  1.19397377e+02  1.19397377e+02  1.19397377e+02  3.19438399e+02
  3.19438399e+02  3.19438399e+02  5.50054443e+02  7.10623926e+02
  7.10623926e+02  7.10623926e+02  1.85699688e+03  1.85699688e+03
  1.85699688e+03  2.32427302e+03  5.23847868e+03  5.23847868e+03
  5.23847868e+03  8.15967477e+03  2.41390452e+04  7.47889175e+04]
E1 = -728.3834776234064  E_coul = 201.66253375247697
cycle= 5 E= -526.720943870929  delta_E= -1.36e-10  |g|= 9.11e-06  |ddm|= 2.96e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3834776234064  E_coul = 201.66253375247697
  HOMO = -0.576048907374626  LUMO = 1.07112798779042
  mo_energy =
[-1.18580519e+02 -1.23034201e+01 -9.55550392e+00 -9.55550392e+00
 -9.55550392e+00 -1.25060763e+00 -5.76048907e-01 -5.76048907e-01
 -5.76048907e-01  1.07112799e+00  1.07112799e+00  1.07112799e+00
  8.05271734e+00  8.05271734e+00  8.05271734e+00  8.76591051e+00
  3.57483922e+01  3.57483922e+01  3.57483922e+01  1.00239143e+02
  1.19397360e+02  1.19397360e+02  1.19397360e+02  3.19438380e+02
  3.19438380e+02  3.19438380e+02  5.50054423e+02  7.10623906e+02
  7.10623906e+02  7.10623906e+02  1.85699686e+03  1.85699686e+03
  1.85699686e+03  2.32427300e+03  5.23847865e+03  5.23847865e+03
  5.23847865e+03  8.15967475e+03  2.41390452e+04  7.47889175e+04]
E1 = -728.3835228128579  E_coul = 201.6625789419233
Extra cycle  E= -526.720943870935  delta_E= -5.23e-12  |g|= 2.71e-06  |ddm|= 4.69e-06
    CPU time for scf_cycle      7.46 sec, wall time      0.51 sec
exp = [2.61949930e+04 7.59774319e+03 3.63584273e+03 1.24945553e+03
 3.47048998e+02 1.06554154e+02 3.56722901e+01 7.47855448e+00
 2.96933653e+00 4.00262091e-01 1.36743061e+03 6.22225961e+02
 9.98384961e+01 1.41928816e+02 5.92029337e+01 7.86238911e+00
 2.14248965e+01 8.10420828e-01 3.11177351e+00 2.27938952e-01]
E = -526.7209438709347
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:03:53 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26194.9929996        1
[INPUT] 0    0    [1    /1   ]  7597.74318696        1
[INPUT] 0    0    [1    /1   ]  3635.84273055        1
[INPUT] 0    0    [1    /1   ]  1249.4555329         1
[INPUT] 0    0    [1    /1   ]  347.048998344        1
[INPUT] 0    0    [1    /1   ]  106.554154443        1
[INPUT] 0    0    [1    /1   ]  35.6722900734        1
[INPUT] 0    0    [1    /1   ]  7.47855447517        1
[INPUT] 0    0    [1    /1   ]  2.96933653318        1
[INPUT] 0    0    [1    /1   ]  0.400262091366       1
[INPUT] 1    0    [1    /1   ]  1367.43060672        1
[INPUT] 1    0    [1    /1   ]  622.225961299        1
[INPUT] 1    0    [1    /1   ]  99.8384961329        1
[INPUT] 1    0    [1    /1   ]  141.928815961        1
[INPUT] 1    0    [1    /1   ]  59.2029336525        1
[INPUT] 1    0    [1    /1   ]  7.86238910864        1
[INPUT] 1    0    [1    /1   ]  21.4248965081        1
[INPUT] 1    0    [1    /1   ]  0.81042082828        1
[INPUT] 1    0    [1    /1   ]  3.11177350986        1
[INPUT] 1    0    [1    /1   ]  0.227938951564       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26194.992999575523, 1.0]], [0, [7597.7431869639995, 1.0]], [0, [3635.842730552171, 1.0]], [0, [1249.4555328968358, 1.0]], [0, [347.04899834441346, 1.0]], [0, [106.55415444270011, 1.0]], [0, [35.67229007339315, 1.0]], [0, [7.478554475169808, 1.0]], [0, [2.9693365331821493, 1.0]], [0, [0.40026209136645385, 1.0]], [1, [1367.430606715454, 1.0]], [1, [622.2259612987059, 1.0]], [1, [99.83849613286125, 1.0]], [1, [141.92881596090803, 1.0]], [1, [59.20293365252768, 1.0]], [1, [7.862389108641055, 1.0]], [1, [21.42489650805566, 1.0]], [1, [0.8104208282796901, 1.0]], [1, [3.111773509855356, 1.0]], [1, [0.2279389515643006, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26194.99299958]
bas 1, expnt(s) = [7597.74318696]
bas 2, expnt(s) = [3635.84273055]
bas 3, expnt(s) = [1249.4555329]
bas 4, expnt(s) = [347.04899834]
bas 5, expnt(s) = [106.55415444]
bas 6, expnt(s) = [35.67229007]
bas 7, expnt(s) = [7.47855448]
bas 8, expnt(s) = [2.96933653]
bas 9, expnt(s) = [0.40026209]
bas 10, expnt(s) = [1367.43060672]
bas 11, expnt(s) = [622.2259613]
bas 12, expnt(s) = [99.83849613]
bas 13, expnt(s) = [141.92881596]
bas 14, expnt(s) = [59.20293365]
bas 15, expnt(s) = [7.86238911]
bas 16, expnt(s) = [21.42489651]
bas 17, expnt(s) = [0.81042083]
bas 18, expnt(s) = [3.11177351]
bas 19, expnt(s) = [0.22793895]
CPU time:      2215.32
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61949930e+04 5.20210051e+03 7.59774319e+03 2.05602543e+03
 3.63584273e+03 1.18295668e+03 1.24945553e+03 5.30952448e+02
 3.47048998e+02 2.03145928e+02 1.06554154e+02 8.37901204e+01
 3.56722901e+01 3.68776525e+01 7.47855448e+00 1.14255804e+01
 2.96933653e+00 5.71491257e+00 4.00262091e-01 1.27137413e+00
 1.36743061e+03 2.42586156e+04 6.22225961e+02 9.06608010e+03
 9.98384961e+01 9.20676230e+02 1.41928816e+02 1.42913290e+03
 5.92029337e+01 4.79085942e+02 7.86238911e+00 3.84085188e+01
 2.14248965e+01 1.34472292e+02 8.10420828e-01 2.24322396e+00
 3.11177351e+00 1.20571418e+01 2.27938952e-01 4.59470439e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98169254513212
cond(S) = 2755.6884873802214
E1 = -729.4079024855845  E_coul = 203.14290139141943
init E= -526.265001094165
    CPU time for initialize scf      7.59 sec, wall time      0.35 sec
  HOMO = -0.556306460040354  LUMO = 1.08447848740511
  mo_energy =
[-1.18339366e+02 -1.22070871e+01 -9.44962853e+00 -9.44962853e+00
 -9.44962853e+00 -1.22537530e+00 -5.56306460e-01 -5.56306460e-01
 -5.56306460e-01  1.08447849e+00  1.08447849e+00  1.08447849e+00
  8.11714105e+00  8.11714105e+00  8.11714105e+00  8.83165669e+00
  3.58594230e+01  3.58594230e+01  3.58594230e+01  1.00400623e+02
  1.19552421e+02  1.19552421e+02  1.19552421e+02  3.19629767e+02
  3.19629767e+02  3.19629767e+02  5.50322246e+02  7.10861504e+02
  7.10861504e+02  7.10861504e+02  1.85733584e+03  1.85733584e+03
  1.85733584e+03  2.32467876e+03  5.23894920e+03  5.23894920e+03
  5.23894920e+03  8.16020990e+03  2.41396805e+04  7.47896428e+04]
E1 = -728.0098608665631  E_coul = 201.2895485122385
cycle= 1 E= -526.720312354325  delta_E= -0.455  |g|= 0.184  |ddm|= 0.362
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.579809
diis-c [-0.33617825  1.        ]
  HOMO = -0.581838792897292  LUMO = 1.06646351149195
  mo_energy =
[-1.18631620e+02 -1.23303138e+01 -9.58342962e+00 -9.58342962e+00
 -9.58342962e+00 -1.25803043e+00 -5.81838793e-01 -5.81838793e-01
 -5.81838793e-01  1.06646351e+00  1.06646351e+00  1.06646351e+00
  8.03581564e+00  8.03581564e+00  8.03581564e+00  8.74555507e+00
  3.57199933e+01  3.57199933e+01  3.57199933e+01  1.00197924e+02
  1.19358952e+02  1.19358952e+02  1.19358952e+02  3.19393244e+02
  3.19393244e+02  3.19393244e+02  5.50002467e+02  7.10573955e+02
  7.10573955e+02  7.10573955e+02  1.85694227e+03  1.85694227e+03
  1.85694227e+03  2.32421715e+03  5.23842213e+03  5.23842213e+03
  5.23842213e+03  8.15961776e+03  2.41389879e+04  7.47888601e+04]
E1 = -728.4756283472531  E_coul = 201.75472094612977
cycle= 2 E= -526.720907401123  delta_E= -0.000595  |g|= 0.0336  |ddm|= 0.0392
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0793497
diis-c [-0.00307796  0.08949828  0.91050172]
  HOMO = -0.575223616212495  LUMO = 1.07177865296128
  mo_energy =
[-1.18573828e+02 -1.22998460e+01 -9.55165668e+00 -9.55165668e+00
 -9.55165668e+00 -1.24962107e+00 -5.75223616e-01 -5.75223616e-01
 -5.75223616e-01  1.07177865e+00  1.07177865e+00  1.07177865e+00
  8.05507927e+00  8.05507927e+00  8.05507927e+00  8.76851408e+00
  3.57522702e+01  3.57522702e+01  3.57522702e+01  1.00244522e+02
  1.19402468e+02  1.19402468e+02  1.19402468e+02  3.19444312e+02
  3.19444312e+02  3.19444312e+02  5.50061257e+02  7.10630460e+02
  7.10630460e+02  7.10630460e+02  1.85700413e+03  1.85700413e+03
  1.85700413e+03  2.32428055e+03  5.23848640e+03  5.23848640e+03
  5.23848640e+03  8.15968267e+03  2.41390533e+04  7.47889257e+04]
E1 = -728.3706601011556  E_coul = 201.64971691151462
cycle= 3 E= -526.720943189641  delta_E= -3.58e-05  |g|= 0.00424  |ddm|= 0.0105
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0110056
diis-c [-4.91592271e-07 -1.10757431e-03  1.17003201e-01  8.84104373e-01]
  HOMO = -0.576058385398888  LUMO = 1.07112056376522
  mo_energy =
[-1.18580499e+02 -1.23034402e+01 -9.55551089e+00 -9.55551089e+00
 -9.55551089e+00 -1.25062438e+00 -5.76058385e-01 -5.76058385e-01
 -5.76058385e-01  1.07112056e+00  1.07112056e+00  1.07112056e+00
  8.05270355e+00  8.05270355e+00  8.05270355e+00  8.76588109e+00
  3.57483860e+01  3.57483860e+01  3.57483860e+01  1.00239144e+02
  1.19397362e+02  1.19397362e+02  1.19397362e+02  3.19438390e+02
  3.19438390e+02  3.19438390e+02  5.50054448e+02  7.10623925e+02
  7.10623925e+02  7.10623925e+02  1.85699689e+03  1.85699689e+03
  1.85699689e+03  2.32427304e+03  5.23847871e+03  5.23847871e+03
  5.23847871e+03  8.15967481e+03  2.41390453e+04  7.47889176e+04]
E1 = -728.3834929141888  E_coul = 201.66254904339553
cycle= 4 E= -526.720943870793  delta_E= -6.81e-07  |g|= 6.4e-05  |ddm|= 0.0012
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000146377
diis-c [-1.62578474e-09  6.10722549e-05 -7.59043409e-03 -6.98520398e-02
  1.07738140e+00]
  HOMO = -0.576045002050092  LUMO = 1.07113101755433
  mo_energy =
[-1.18580499e+02 -1.23034062e+01 -9.55548921e+00 -9.55548921e+00
 -9.55548921e+00 -1.25060287e+00 -5.76045002e-01 -5.76045002e-01
 -5.76045002e-01  1.07113102e+00  1.07113102e+00  1.07113102e+00
  8.05272736e+00  8.05272736e+00  8.05272736e+00  8.76592136e+00
  3.57484067e+01  3.57484067e+01  3.57484067e+01  1.00239161e+02
  1.19397377e+02  1.19397377e+02  1.19397377e+02  3.19438399e+02
  3.19438399e+02  3.19438399e+02  5.50054443e+02  7.10623926e+02
  7.10623926e+02  7.10623926e+02  1.85699688e+03  1.85699688e+03
  1.85699688e+03  2.32427302e+03  5.23847868e+03  5.23847868e+03
  5.23847868e+03  8.15967477e+03  2.41390452e+04  7.47889175e+04]
E1 = -728.3834776234064  E_coul = 201.66253375247697
cycle= 5 E= -526.720943870929  delta_E= -1.36e-10  |g|= 9.11e-06  |ddm|= 2.96e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3834776234064  E_coul = 201.66253375247697
  HOMO = -0.576048907374626  LUMO = 1.07112798779042
  mo_energy =
[-1.18580519e+02 -1.23034201e+01 -9.55550392e+00 -9.55550392e+00
 -9.55550392e+00 -1.25060763e+00 -5.76048907e-01 -5.76048907e-01
 -5.76048907e-01  1.07112799e+00  1.07112799e+00  1.07112799e+00
  8.05271734e+00  8.05271734e+00  8.05271734e+00  8.76591051e+00
  3.57483922e+01  3.57483922e+01  3.57483922e+01  1.00239143e+02
  1.19397360e+02  1.19397360e+02  1.19397360e+02  3.19438380e+02
  3.19438380e+02  3.19438380e+02  5.50054423e+02  7.10623906e+02
  7.10623906e+02  7.10623906e+02  1.85699686e+03  1.85699686e+03
  1.85699686e+03  2.32427300e+03  5.23847865e+03  5.23847865e+03
  5.23847865e+03  8.15967475e+03  2.41390452e+04  7.47889175e+04]
E1 = -728.3835228128579  E_coul = 201.6625789419233
Extra cycle  E= -526.720943870935  delta_E= -5.23e-12  |g|= 2.71e-06  |ddm|= 4.69e-06
    CPU time for scf_cycle      7.80 sec, wall time      0.53 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2755.6884873802214
E1 = -728.3835228128579  E_coul = 201.6625789419233
init E= -526.720943870935
    CPU time for initialize scf     16.29 sec, wall time      0.76 sec
  HOMO = -0.57604808147218  LUMO = 1.07112863733068
  mo_energy =
[-1.18580513e+02 -1.23034168e+01 -9.55550049e+00 -9.55550049e+00
 -9.55550049e+00 -1.25060660e+00 -5.76048081e-01 -5.76048081e-01
 -5.76048081e-01  1.07112864e+00  1.07112864e+00  1.07112864e+00
  8.05271955e+00  8.05271955e+00  8.05271955e+00  8.76591307e+00
  3.57483957e+01  3.57483957e+01  3.57483957e+01  1.00239148e+02
  1.19397364e+02  1.19397364e+02  1.19397364e+02  3.19438385e+02
  3.19438385e+02  3.19438385e+02  5.50054428e+02  7.10623911e+02
  7.10623911e+02  7.10623911e+02  1.85699686e+03  1.85699686e+03
  1.85699686e+03  2.32427300e+03  5.23847866e+03  5.23847866e+03
  5.23847866e+03  8.15967475e+03  2.41390452e+04  7.47889175e+04]
E1 = -728.3835119350532  E_coul = 201.66256806411818
cycle= 1 E= -526.720943870935  delta_E= -3.41e-13  |g|= 7.01e-07  |ddm|= 1.12e-06
    CPU time for cycle= 1      0.04 sec, wall time      0.02 sec
E1 = -728.3835119350532  E_coul = 201.66256806411818
  HOMO = -0.57604826682847  LUMO = 1.07112849073145
  mo_energy =
[-1.18580515e+02 -1.23034176e+01 -9.55550132e+00 -9.55550132e+00
 -9.55550132e+00 -1.25060683e+00 -5.76048267e-01 -5.76048267e-01
 -5.76048267e-01  1.07112849e+00  1.07112849e+00  1.07112849e+00
  8.05271904e+00  8.05271904e+00  8.05271904e+00  8.76591248e+00
  3.57483948e+01  3.57483948e+01  3.57483948e+01  1.00239147e+02
  1.19397363e+02  1.19397363e+02  1.19397363e+02  3.19438384e+02
  3.19438384e+02  3.19438384e+02  5.50054427e+02  7.10623910e+02
  7.10623910e+02  7.10623910e+02  1.85699686e+03  1.85699686e+03
  1.85699686e+03  2.32427300e+03  5.23847866e+03  5.23847866e+03
  5.23847866e+03  8.15967475e+03  2.41390452e+04  7.47889175e+04]
E1 = -728.3835146222794  E_coul = 201.6625707513441
Extra cycle  E= -526.720943870935  delta_E= -3.41e-13  |g|= 1.78e-07  |ddm|= 2.63e-07
    CPU time for scf_cycle     16.42 sec, wall time      0.87 sec
exp = [2.61949930e+04 7.59774319e+03 3.63584273e+03 1.24945553e+03
 3.47048998e+02 1.06554154e+02 3.56722901e+01 7.47855448e+00
 2.96933653e+00 4.00262091e-01 1.36743061e+03 6.22225961e+02
 9.98384961e+01 1.41928816e+02 5.92029337e+01 7.86238911e+00
 2.14248965e+01 8.10420828e-01 3.11177351e+00 2.27938952e-01]
grad_E = [-1.26444521e-06  1.27233670e-06 -3.73851535e-06  5.85843081e-05
 -8.54435266e-05  2.77792431e-04 -1.15286449e-03 -3.11412715e-03
  3.17375710e-03  2.51207935e-02 -9.77200131e-07  1.40834150e-05
 -3.36283238e-05 -7.41523300e-05 -3.43479755e-04 -1.89323843e-02
  5.75789906e-03  4.07574718e-02  2.91845632e-02 -1.21241948e-01]
 message: Iteration limit reached
 success: False
  status: 9
     fun: -526.7209438709347
       x: [ 2.619e+04  7.598e+03 ...  3.112e+00  2.279e-01]
     nit: 100
     jac: [-1.264e-06  1.272e-06 ...  2.918e-02 -1.212e-01]
    nfev: 105
    njev: 100
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 10
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
4.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1577.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:03:59 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62939681.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26194.9929996        1
[INPUT] 0    0    [1    /1   ]  7597.74318696        1
[INPUT] 0    0    [1    /1   ]  3635.84273055        1
[INPUT] 0    0    [1    /1   ]  1249.4555329         1
[INPUT] 0    0    [1    /1   ]  347.048998344        1
[INPUT] 0    0    [1    /1   ]  106.554154443        1
[INPUT] 0    0    [1    /1   ]  35.6722900734        1
[INPUT] 0    0    [1    /1   ]  7.47855447517        1
[INPUT] 0    0    [1    /1   ]  2.96933653318        1
[INPUT] 0    0    [1    /1   ]  0.400262091366       1
[INPUT] 1    0    [1    /1   ]  1367.43060672        1
[INPUT] 1    0    [1    /1   ]  622.225961299        1
[INPUT] 1    0    [1    /1   ]  99.8384961329        1
[INPUT] 1    0    [1    /1   ]  141.928815961        1
[INPUT] 1    0    [1    /1   ]  59.2029336525        1
[INPUT] 1    0    [1    /1   ]  7.86238910864        1
[INPUT] 1    0    [1    /1   ]  21.4248965081        1
[INPUT] 1    0    [1    /1   ]  0.81042082828        1
[INPUT] 1    0    [1    /1   ]  3.11177350986        1
[INPUT] 1    0    [1    /1   ]  0.227938951564       1

nuclear repulsion = 0
number of shells = 20
number of NR pGTOs = 40
number of NR cGTOs = 40
basis = {'Ar': [[0, [26194.992999575523, 1.0]], [0, [7597.7431869639995, 1.0]], [0, [3635.842730552171, 1.0]], [0, [1249.4555328968358, 1.0]], [0, [347.04899834441346, 1.0]], [0, [106.55415444270011, 1.0]], [0, [35.67229007339315, 1.0]], [0, [7.478554475169808, 1.0]], [0, [2.9693365331821493, 1.0]], [0, [0.40026209136645385, 1.0]], [1, [1367.430606715454, 1.0]], [1, [622.2259612987059, 1.0]], [1, [99.83849613286125, 1.0]], [1, [141.92881596090803, 1.0]], [1, [59.20293365252768, 1.0]], [1, [7.862389108641055, 1.0]], [1, [21.42489650805566, 1.0]], [1, [0.8104208282796901, 1.0]], [1, [3.111773509855356, 1.0]], [1, [0.2279389515643006, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26194.99299958]
bas 1, expnt(s) = [7597.74318696]
bas 2, expnt(s) = [3635.84273055]
bas 3, expnt(s) = [1249.4555329]
bas 4, expnt(s) = [347.04899834]
bas 5, expnt(s) = [106.55415444]
bas 6, expnt(s) = [35.67229007]
bas 7, expnt(s) = [7.47855448]
bas 8, expnt(s) = [2.96933653]
bas 9, expnt(s) = [0.40026209]
bas 10, expnt(s) = [1367.43060672]
bas 11, expnt(s) = [622.2259613]
bas 12, expnt(s) = [99.83849613]
bas 13, expnt(s) = [141.92881596]
bas 14, expnt(s) = [59.20293365]
bas 15, expnt(s) = [7.86238911]
bas 16, expnt(s) = [21.42489651]
bas 17, expnt(s) = [0.81042083]
bas 18, expnt(s) = [3.11177351]
bas 19, expnt(s) = [0.22793895]
CPU time:      2244.83
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61949930e+04 5.20210051e+03 7.59774319e+03 2.05602543e+03
 3.63584273e+03 1.18295668e+03 1.24945553e+03 5.30952448e+02
 3.47048998e+02 2.03145928e+02 1.06554154e+02 8.37901204e+01
 3.56722901e+01 3.68776525e+01 7.47855448e+00 1.14255804e+01
 2.96933653e+00 5.71491257e+00 4.00262091e-01 1.27137413e+00
 1.36743061e+03 2.42586156e+04 6.22225961e+02 9.06608010e+03
 9.98384961e+01 9.20676230e+02 1.41928816e+02 1.42913290e+03
 5.92029337e+01 4.79085942e+02 7.86238911e+00 3.84085188e+01
 2.14248965e+01 1.34472292e+02 8.10420828e-01 2.24322396e+00
 3.11177351e+00 1.20571418e+01 2.27938952e-01 4.59470439e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98169254513212
cond(S) = 2755.6884873802214
E1 = -729.4079024855845  E_coul = 203.14290139141943
init E= -526.265001094165
    CPU time for initialize scf      0.70 sec, wall time      0.05 sec
  HOMO = -0.556306460040354  LUMO = 1.08447848740511
  mo_energy =
[-1.18339366e+02 -1.22070871e+01 -9.44962853e+00 -9.44962853e+00
 -9.44962853e+00 -1.22537530e+00 -5.56306460e-01 -5.56306460e-01
 -5.56306460e-01  1.08447849e+00  1.08447849e+00  1.08447849e+00
  8.11714105e+00  8.11714105e+00  8.11714105e+00  8.83165669e+00
  3.58594230e+01  3.58594230e+01  3.58594230e+01  1.00400623e+02
  1.19552421e+02  1.19552421e+02  1.19552421e+02  3.19629767e+02
  3.19629767e+02  3.19629767e+02  5.50322246e+02  7.10861504e+02
  7.10861504e+02  7.10861504e+02  1.85733584e+03  1.85733584e+03
  1.85733584e+03  2.32467876e+03  5.23894920e+03  5.23894920e+03
  5.23894920e+03  8.16020990e+03  2.41396805e+04  7.47896428e+04]
E1 = -728.0098608665631  E_coul = 201.2895485122385
cycle= 1 E= -526.720312354325  delta_E= -0.455  |g|= 0.184  |ddm|= 0.362
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.579809
diis-c [-0.33617825  1.        ]
  HOMO = -0.581838792897292  LUMO = 1.06646351149195
  mo_energy =
[-1.18631620e+02 -1.23303138e+01 -9.58342962e+00 -9.58342962e+00
 -9.58342962e+00 -1.25803043e+00 -5.81838793e-01 -5.81838793e-01
 -5.81838793e-01  1.06646351e+00  1.06646351e+00  1.06646351e+00
  8.03581564e+00  8.03581564e+00  8.03581564e+00  8.74555507e+00
  3.57199933e+01  3.57199933e+01  3.57199933e+01  1.00197924e+02
  1.19358952e+02  1.19358952e+02  1.19358952e+02  3.19393244e+02
  3.19393244e+02  3.19393244e+02  5.50002467e+02  7.10573955e+02
  7.10573955e+02  7.10573955e+02  1.85694227e+03  1.85694227e+03
  1.85694227e+03  2.32421715e+03  5.23842213e+03  5.23842213e+03
  5.23842213e+03  8.15961776e+03  2.41389879e+04  7.47888601e+04]
E1 = -728.4756283472531  E_coul = 201.75472094612977
cycle= 2 E= -526.720907401123  delta_E= -0.000595  |g|= 0.0336  |ddm|= 0.0392
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0793497
diis-c [-0.00307796  0.08949828  0.91050172]
  HOMO = -0.575223616212495  LUMO = 1.07177865296128
  mo_energy =
[-1.18573828e+02 -1.22998460e+01 -9.55165668e+00 -9.55165668e+00
 -9.55165668e+00 -1.24962107e+00 -5.75223616e-01 -5.75223616e-01
 -5.75223616e-01  1.07177865e+00  1.07177865e+00  1.07177865e+00
  8.05507927e+00  8.05507927e+00  8.05507927e+00  8.76851408e+00
  3.57522702e+01  3.57522702e+01  3.57522702e+01  1.00244522e+02
  1.19402468e+02  1.19402468e+02  1.19402468e+02  3.19444312e+02
  3.19444312e+02  3.19444312e+02  5.50061257e+02  7.10630460e+02
  7.10630460e+02  7.10630460e+02  1.85700413e+03  1.85700413e+03
  1.85700413e+03  2.32428055e+03  5.23848640e+03  5.23848640e+03
  5.23848640e+03  8.15968267e+03  2.41390533e+04  7.47889257e+04]
E1 = -728.3706601011556  E_coul = 201.64971691151462
cycle= 3 E= -526.720943189641  delta_E= -3.58e-05  |g|= 0.00424  |ddm|= 0.0105
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0110056
diis-c [-4.91592271e-07 -1.10757431e-03  1.17003201e-01  8.84104373e-01]
  HOMO = -0.576058385398888  LUMO = 1.07112056376522
  mo_energy =
[-1.18580499e+02 -1.23034402e+01 -9.55551089e+00 -9.55551089e+00
 -9.55551089e+00 -1.25062438e+00 -5.76058385e-01 -5.76058385e-01
 -5.76058385e-01  1.07112056e+00  1.07112056e+00  1.07112056e+00
  8.05270355e+00  8.05270355e+00  8.05270355e+00  8.76588109e+00
  3.57483860e+01  3.57483860e+01  3.57483860e+01  1.00239144e+02
  1.19397362e+02  1.19397362e+02  1.19397362e+02  3.19438390e+02
  3.19438390e+02  3.19438390e+02  5.50054448e+02  7.10623925e+02
  7.10623925e+02  7.10623925e+02  1.85699689e+03  1.85699689e+03
  1.85699689e+03  2.32427304e+03  5.23847871e+03  5.23847871e+03
  5.23847871e+03  8.15967481e+03  2.41390453e+04  7.47889176e+04]
E1 = -728.3834929141888  E_coul = 201.66254904339553
cycle= 4 E= -526.720943870793  delta_E= -6.81e-07  |g|= 6.4e-05  |ddm|= 0.0012
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000146377
diis-c [-1.62578474e-09  6.10722549e-05 -7.59043409e-03 -6.98520398e-02
  1.07738140e+00]
  HOMO = -0.576045002050092  LUMO = 1.07113101755433
  mo_energy =
[-1.18580499e+02 -1.23034062e+01 -9.55548921e+00 -9.55548921e+00
 -9.55548921e+00 -1.25060287e+00 -5.76045002e-01 -5.76045002e-01
 -5.76045002e-01  1.07113102e+00  1.07113102e+00  1.07113102e+00
  8.05272736e+00  8.05272736e+00  8.05272736e+00  8.76592136e+00
  3.57484067e+01  3.57484067e+01  3.57484067e+01  1.00239161e+02
  1.19397377e+02  1.19397377e+02  1.19397377e+02  3.19438399e+02
  3.19438399e+02  3.19438399e+02  5.50054443e+02  7.10623926e+02
  7.10623926e+02  7.10623926e+02  1.85699688e+03  1.85699688e+03
  1.85699688e+03  2.32427302e+03  5.23847868e+03  5.23847868e+03
  5.23847868e+03  8.15967477e+03  2.41390452e+04  7.47889175e+04]
E1 = -728.3834776234064  E_coul = 201.66253375247697
cycle= 5 E= -526.720943870929  delta_E= -1.36e-10  |g|= 9.11e-06  |ddm|= 2.96e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3834776234064  E_coul = 201.66253375247697
  HOMO = -0.576048907374626  LUMO = 1.07112798779042
  mo_energy =
[-1.18580519e+02 -1.23034201e+01 -9.55550392e+00 -9.55550392e+00
 -9.55550392e+00 -1.25060763e+00 -5.76048907e-01 -5.76048907e-01
 -5.76048907e-01  1.07112799e+00  1.07112799e+00  1.07112799e+00
  8.05271734e+00  8.05271734e+00  8.05271734e+00  8.76591051e+00
  3.57483922e+01  3.57483922e+01  3.57483922e+01  1.00239143e+02
  1.19397360e+02  1.19397360e+02  1.19397360e+02  3.19438380e+02
  3.19438380e+02  3.19438380e+02  5.50054423e+02  7.10623906e+02
  7.10623906e+02  7.10623906e+02  1.85699686e+03  1.85699686e+03
  1.85699686e+03  2.32427300e+03  5.23847865e+03  5.23847865e+03
  5.23847865e+03  8.15967475e+03  2.41390452e+04  7.47889175e+04]
E1 = -728.3835228128579  E_coul = 201.6625789419233
Extra cycle  E= -526.720943870935  delta_E= -5.23e-12  |g|= 2.71e-06  |ddm|= 4.69e-06
    CPU time for scf_cycle      0.91 sec, wall time      0.27 sec
exp = [2.61949930e+04 7.59774319e+03 3.63584273e+03 1.24945553e+03
 3.47048998e+02 1.06554154e+02 3.56722901e+01 7.47855448e+00
 2.96933653e+00 4.00262091e-01 1.36743061e+03 6.22225961e+02
 9.98384961e+01 1.41928816e+02 5.92029337e+01 7.86238911e+00
 2.14248965e+01 8.10420828e-01 3.11177351e+00 2.27938952e-01]
E = -526.7209438709347
E = -526.7209438709347
exp = [2.6194992999575523e+04,7.5977431869639995e+03,3.6358427305521709e+03,1.2494555328968358e+03,3.4704899834441346e+02,1.0655415444270011e+02,3.5672290073393150e+01,7.4785544751698083e+00,2.9693365331821493e+00,4.0026209136645385e-01,1.3674306067154539e+03,6.2222596129870590e+02,9.9838496132861252e+01,1.4192881596090803e+02,5.9202933652527683e+01,7.8623891086410547e+00,2.1424896508055660e+01,8.1042082827969009e-01,3.1117735098553561e+00,2.2793895156430061e-01]

real	8m59.437s
user	35m29.242s
sys	1m59.850s
