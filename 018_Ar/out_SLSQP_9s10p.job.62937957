created virtual environment CPython3.10.2.final.0-64 in 1626ms
  creator CPython3Posix(dest=/localscratch/nike.62937957.0/ENV, clear=True, no_vcs_ignore=False, global=False)
  seeder FromAppData(download=False, pip=bundle, setuptools=bundle, wheel=bundle, via=copy, app_data_dir=/home/nike/.local/share/virtualenv)
    added seed packages: pip==23.0.1, setuptools==67.3.3, wheel==0.38.4+computecanada
  activators BashActivator,CShellActivator,FishActivator,NushellActivator,PowerShellActivator,PythonActivator
Looking in links: /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic
Requirement already satisfied: pip in /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages (23.0.1)
Looking in links: /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic
Processing /home/nike/pyscf_ad/dist/pyscf-2.1.1+ad-cp310-cp310-linux_x86_64.whl
Processing /home/nike/pyscf_properties_ad/dist/pyscf_properties-0.1.0+ad-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/absl_py-1.4.0+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic/contourpy-1.0.7+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/cycler-0.11.0+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/fonttools-4.39.0+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2/h5py-3.8.0+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/jax-0.4.2+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic/jaxlib-0.4.2+cuda11.cudnn82.computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/jaxopt-0.6+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2/kiwisolver-1.4.4+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2/matplotlib-3.7.0+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic/numpy-1.24.2+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/opt_einsum-3.3.0+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/packaging-23.0+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2/Pillow-9.4.0+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/pyparsing-3.0.9+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/pyscfad-0.1.2+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/python_dateutil-2.8.2+computecanada-py2.py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic/scipy-1.10.1+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/six-1.16.0+computecanada-py2.py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/typing_extensions-4.5.0+computecanada-py3-none-any.whl
Installing collected packages: typing_extensions, six, pyparsing, Pillow, packaging, numpy, kiwisolver, fonttools, cycler, absl_py, scipy, python-dateutil, opt-einsum, h5py, contourpy, pyscf, matplotlib, jaxlib, pyscf-properties, jax, jaxopt, pyscfad
Successfully installed Pillow-9.4.0+computecanada absl_py-1.4.0+computecanada contourpy-1.0.7+computecanada cycler-0.11.0+computecanada fonttools-4.39.0+computecanada h5py-3.8.0+computecanada jax-0.4.2+computecanada jaxlib-0.4.2+cuda11.cudnn82.computecanada jaxopt-0.6+computecanada kiwisolver-1.4.4+computecanada matplotlib-3.7.0+computecanada numpy-1.24.2+computecanada opt-einsum-3.3.0+computecanada packaging-23.0+computecanada pyparsing-3.0.9+computecanada pyscf-2.1.1+ad pyscf-properties-0.1.0+ad pyscfad-0.1.2+computecanada python-dateutil-2.8.2+computecanada scipy-1.10.1+computecanada six-1.16.0+computecanada typing_extensions-4.5.0+computecanada

real	1m2.032s
user	0m51.479s
sys	0m2.154s
/project/6004934/nike/basis-set-optimization/018_Ar/./input.py:89: OptimizeWarning: Unknown solver options: maxfev
  res = optimize.minimize(
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:38:46 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5078499        1
[INPUT] 0    0    [1    /1   ]  7618.25078499        1
[INPUT] 0    0    [1    /1   ]  3618.25078499        1
[INPUT] 0    0    [1    /1   ]  1618.25078499        1
[INPUT] 0    0    [1    /1   ]  239.783987351        1
[INPUT] 0    0    [1    /1   ]  51.8979142065        1
[INPUT] 0    0    [1    /1   ]  4.38708529427        1
[INPUT] 0    0    [1    /1   ]  0.438708529427       1
[INPUT] 0    0    [1    /1   ]  0.0938708529427      1
[INPUT] 1    0    [1    /1   ]  1362.79300324        1
[INPUT] 1    0    [1    /1   ]  665.180725752        1
[INPUT] 1    0    [1    /1   ]  303.320641863        1
[INPUT] 1    0    [1    /1   ]  316.146456063        1
[INPUT] 1    0    [1    /1   ]  49.3001440185        1
[INPUT] 1    0    [1    /1   ]  4.75377857326        1
[INPUT] 1    0    [1    /1   ]  14.7472935001        1
[INPUT] 1    0    [1    /1   ]  0.403281232738       1
[INPUT] 1    0    [1    /1   ]  1.23333836929        1
[INPUT] 1    0    [1    /1   ]  0.0387165584804      1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.507849929174, 1.0]], [0, [7618.250784992918, 1.0]], [0, [3618.2507849929175, 1.0]], [0, [1618.2507849929175, 1.0]], [0, [239.7839873511053, 1.0]], [0, [51.89791420649664, 1.0]], [0, [4.387085294269393, 1.0]], [0, [0.4387085294269393, 1.0]], [0, [0.09387085294269393, 1.0]], [1, [1362.7930032386791, 1.0]], [1, [665.1807257515178, 1.0]], [1, [303.32064186335555, 1.0]], [1, [316.1464560630523, 1.0]], [1, [49.300144018458525, 1.0]], [1, [4.75377857325692, 1.0]], [1, [14.74729350005786, 1.0]], [1, [0.40328123273769173, 1.0]], [1, [1.2333383692864934, 1.0]], [1, [0.03871655848043362, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50784993]
bas 1, expnt(s) = [7618.25078499]
bas 2, expnt(s) = [3618.25078499]
bas 3, expnt(s) = [1618.25078499]
bas 4, expnt(s) = [239.78398735]
bas 5, expnt(s) = [51.89791421]
bas 6, expnt(s) = [4.38708529]
bas 7, expnt(s) = [0.43870853]
bas 8, expnt(s) = [0.09387085]
bas 9, expnt(s) = [1362.79300324]
bas 10, expnt(s) = [665.18072575]
bas 11, expnt(s) = [303.32064186]
bas 12, expnt(s) = [316.14645606]
bas 13, expnt(s) = [49.30014402]
bas 14, expnt(s) = [4.75377857]
bas 15, expnt(s) = [14.7472935]
bas 16, expnt(s) = [0.40328123]
bas 17, expnt(s) = [1.23333837]
bas 18, expnt(s) = [0.03871656]
CPU time:         1.09
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825078e+04 5.20024082e+03 7.61825078e+03 2.06018620e+03
 3.61825078e+03 1.17866130e+03 1.61825078e+03 6.44613496e+02
 2.39783987e+02 1.53950165e+02 5.18979142e+01 4.88514492e+01
 4.38708529e+00 7.65855936e+00 4.38708529e-01 1.36190584e+00
 9.38708529e-02 4.28462776e-01 1.36279300e+03 2.41558187e+04
 6.65180726e+02 9.85505298e+03 3.03320642e+02 3.69285156e+03
 3.16146456e+02 3.88906131e+03 4.93001440e+01 3.81104983e+02
 4.75377857e+00 2.04777897e+01 1.47472935e+01 8.43091668e+01
 4.03281233e-01 9.37549934e-01 1.23333837e+00 3.79172818e+00
 3.87165585e-02 5.01020303e-02]
ecpbas  = []
2023-03-19 08:38:46.251771: W external/org_tensorflow/tensorflow/tsl/platform/default/dso_loader.cc:67] Could not load dynamic library 'libcuda.so.1'; dlerror: libcuda.so.1: cannot open shared object file: No such file or directory
2023-03-19 08:38:46.251865: W external/org_tensorflow/tensorflow/compiler/xla/stream_executor/cuda/cuda_driver.cc:264] failed call to cuInit: UNKNOWN ERROR (303)
No GPU/TPU found, falling back to CPU. (Set TF_CPP_MIN_LOG_LEVEL=0 and rerun for more info.)
Set gradient conv threshold to 3.16228e-05
/localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscfad/gto/moleintor.py:74: UserWarning: AO symmetry is not supported. Setting aosym = s1.
  warnings.warn(msg)
Nelec from initial guess = 17.922194332280583
cond(S) = 83440.78659432847
E1 = -726.4254001511144  E_coul = 202.49350190519988
init E= -523.931898245915
    CPU time for initialize scf      0.84 sec, wall time      0.20 sec
/localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/jax/_src/numpy/lax_numpy.py:3493: UserWarning: 'kind' argument to argsort is ignored; only 'stable' sorts are supported.
  warnings.warn("'kind' argument to argsort is ignored; only 'stable' sorts "
  HOMO = -0.553281322380215  LUMO = 0.110327933197715
  mo_energy =
[-1.17948453e+02 -1.21375722e+01 -9.49435494e+00 -9.49435494e+00
 -9.49435494e+00 -1.24323083e+00 -5.53281322e-01 -5.53281322e-01
 -5.53281322e-01  1.10327933e-01  1.10327933e-01  1.10327933e-01
  2.99290673e-01  2.33348566e+00  2.33348566e+00  2.33348566e+00
  1.66821308e+01  1.66821308e+01  1.66821308e+01  8.67822651e+01
  8.67822651e+01  8.67822651e+01  1.82274927e+02  4.19359356e+02
  4.19359356e+02  4.19359356e+02  1.27320864e+03  1.27320864e+03
  1.27320864e+03  1.91415294e+03  2.97536773e+03  2.97536773e+03
  2.97536773e+03  6.60464394e+03  6.60464394e+03  6.60464394e+03
  8.27266865e+03  2.46605443e+04  7.54569643e+04]
E1 = -727.8778615381125  E_coul = 202.43638368992265
cycle= 1 E= -525.44147784819  delta_E= -1.51  |g|= 0.198  |ddm|= 1.46
    CPU time for cycle= 1      0.32 sec, wall time      0.32 sec
diis-norm(errvec)=0.469142
diis-c [-0.22009441  1.        ]
  HOMO = -0.530354622097546  LUMO = 0.124481894273603
  mo_energy =
[-1.18112937e+02 -1.21228734e+01 -9.48785423e+00 -9.48785423e+00
 -9.48785423e+00 -1.21266365e+00 -5.30354622e-01 -5.30354622e-01
 -5.30354622e-01  1.24481894e-01  1.24481894e-01  1.24481894e-01
  3.18516921e-01  2.36008523e+00  2.36008523e+00  2.36008523e+00
  1.66931966e+01  1.66931966e+01  1.66931966e+01  8.67228142e+01
  8.67228142e+01  8.67228142e+01  1.82178910e+02  4.19208658e+02
  4.19208658e+02  4.19208658e+02  1.27299828e+03  1.27299828e+03
  1.27299828e+03  1.91379836e+03  2.97508283e+03  2.97508283e+03
  2.97508283e+03  6.60422842e+03  6.60422842e+03  6.60422842e+03
  8.27216101e+03  2.46599357e+04  7.54562593e+04]
E1 = -727.6372151491878  E_coul = 202.19455362834404
cycle= 2 E= -525.442661520844  delta_E= -0.00118  |g|= 0.0132  |ddm|= 0.083
    CPU time for cycle= 2      0.12 sec, wall time      0.12 sec
diis-norm(errvec)=0.0155915
diis-c [-2.32571572e-04  6.87030218e-03  9.93129698e-01]
  HOMO = -0.54134046479962  LUMO = 0.123100001131206
  mo_energy =
[-1.18119815e+02 -1.21398383e+01 -9.50511603e+00 -9.50511603e+00
 -9.50511603e+00 -1.22421094e+00 -5.41340465e-01 -5.41340465e-01
 -5.41340465e-01  1.23100001e-01  1.23100001e-01  1.23100001e-01
  3.13289509e-01  2.34677316e+00  2.34677316e+00  2.34677316e+00
  1.66762759e+01  1.66762759e+01  1.66762759e+01  8.67106891e+01
  8.67106891e+01  8.67106891e+01  1.82171642e+02  4.19201639e+02
  4.19201639e+02  4.19201639e+02  1.27299272e+03  1.27299272e+03
  1.27299272e+03  1.91379352e+03  2.97507786e+03  2.97507786e+03
  2.97507786e+03  6.60422360e+03  6.60422360e+03  6.60422360e+03
  8.27215616e+03  2.46599307e+04  7.54562541e+04]
E1 = -727.6549316769257  E_coul = 202.21224584010577
cycle= 3 E= -525.44268583682  delta_E= -2.43e-05  |g|= 0.00138  |ddm|= 0.0114
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00198256
diis-c [-2.80583969e-06  6.59971470e-04 -6.66881242e-02  1.06602815e+00]
  HOMO = -0.54133381501168  LUMO = 0.12302943220152
  mo_energy =
[-1.18117855e+02 -1.21382305e+01 -9.50347811e+00 -9.50347811e+00
 -9.50347811e+00 -1.22403545e+00 -5.41333815e-01 -5.41333815e-01
 -5.41333815e-01  1.23029432e-01  1.23029432e-01  1.23029432e-01
  3.13102256e-01  2.34686598e+00  2.34686598e+00  2.34686598e+00
  1.66776130e+01  1.66776130e+01  1.66776130e+01  8.67125108e+01
  8.67125108e+01  8.67125108e+01  1.82173603e+02  4.19203582e+02
  4.19203582e+02  4.19203582e+02  1.27299465e+03  1.27299465e+03
  1.27299465e+03  1.91379534e+03  2.97507973e+03  2.97507973e+03
  2.97507973e+03  6.60422539e+03  6.60422539e+03  6.60422539e+03
  8.27215789e+03  2.46599324e+04  7.54562557e+04]
E1 = -727.6450762786093  E_coul = 202.2023897415004
cycle= 4 E= -525.442686537109  delta_E= -7e-07  |g|= 0.000433  |ddm|= 0.00228
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000626223
diis-c [-1.67231626e-07 -2.76177900e-04 -1.11621971e-02  2.10676531e-01
  8.00761844e-01]
  HOMO = -0.541597709788127  LUMO = 0.122997932582196
  mo_energy =
[-1.18118687e+02 -1.21388758e+01 -9.50413947e+00 -9.50413947e+00
 -9.50413947e+00 -1.22432427e+00 -5.41597710e-01 -5.41597710e-01
 -5.41597710e-01  1.22997933e-01  1.22997933e-01  1.22997933e-01
  3.12982376e-01  2.34652798e+00  2.34652798e+00  2.34652798e+00
  1.66770090e+01  1.66770090e+01  1.66770090e+01  8.67117625e+01
  8.67117625e+01  8.67117625e+01  1.82172789e+02  4.19202756e+02
  4.19202756e+02  4.19202756e+02  1.27299380e+03  1.27299380e+03
  1.27299380e+03  1.91379448e+03  2.97507888e+03  2.97507888e+03
  2.97507888e+03  6.60422453e+03  6.60422453e+03  6.60422453e+03
  8.27215703e+03  2.46599315e+04  7.54562548e+04]
E1 = -727.6466901330099  E_coul = 202.20400357704693
cycle= 5 E= -525.442686555963  delta_E= -1.89e-08  |g|= 5.1e-05  |ddm|= 0.000249
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.49024e-05
diis-c [-1.08973630e-10  1.86204647e-05 -2.20758951e-03 -2.33723924e-02
 -3.59910174e-02  1.06155238e+00]
  HOMO = -0.541635697196963  LUMO = 0.122991196898508
  mo_energy =
[-1.18118701e+02 -1.21389090e+01 -9.50417268e+00 -9.50417268e+00
 -9.50417268e+00 -1.22436127e+00 -5.41635697e-01 -5.41635697e-01
 -5.41635697e-01  1.22991197e-01  1.22991197e-01  1.22991197e-01
  3.12959138e-01  2.34648256e+00  2.34648256e+00  2.34648256e+00
  1.66769719e+01  1.66769719e+01  1.66769719e+01  8.67117388e+01
  8.67117388e+01  8.67117388e+01  1.82172774e+02  4.19202742e+02
  4.19202742e+02  4.19202742e+02  1.27299379e+03  1.27299379e+03
  1.27299379e+03  1.91379447e+03  2.97507887e+03  2.97507887e+03
  2.97507887e+03  6.60422452e+03  6.60422452e+03  6.60422452e+03
  8.27215702e+03  2.46599315e+04  7.54562548e+04]
E1 = -727.6465803337102  E_coul = 202.20389377694156
cycle= 6 E= -525.442686556769  delta_E= -8.06e-10  |g|= 6.97e-07  |ddm|= 8.04e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -727.6465803337102  E_coul = 202.20389377694156
  HOMO = -0.541635624383975  LUMO = 0.122991201287252
  mo_energy =
[-1.18118701e+02 -1.21389091e+01 -9.50417274e+00 -9.50417274e+00
 -9.50417274e+00 -1.22436134e+00 -5.41635624e-01 -5.41635624e-01
 -5.41635624e-01  1.22991201e-01  1.22991201e-01  1.22991201e-01
  3.12959112e-01  2.34648261e+00  2.34648261e+00  2.34648261e+00
  1.66769719e+01  1.66769719e+01  1.66769719e+01  8.67117387e+01
  8.67117387e+01  8.67117387e+01  1.82172774e+02  4.19202742e+02
  4.19202742e+02  4.19202742e+02  1.27299379e+03  1.27299379e+03
  1.27299379e+03  1.91379447e+03  2.97507887e+03  2.97507887e+03
  2.97507887e+03  6.60422452e+03  6.60422452e+03  6.60422452e+03
  8.27215702e+03  2.46599315e+04  7.54562548e+04]
E1 = -727.6465811084499  E_coul = 202.20389455168035
Extra cycle  E= -525.44268655677  delta_E= -9.09e-13  |g|= 1.3e-07  |ddm|= 1.24e-06
    CPU time for scf_cycle      1.44 sec, wall time      0.80 sec
exp = [2.61825078e+04 7.61825078e+03 3.61825078e+03 1.61825078e+03
 2.39783987e+02 5.18979142e+01 4.38708529e+00 4.38708529e-01
 9.38708529e-02 1.36279300e+03 6.65180726e+02 3.03320642e+02
 3.16146456e+02 4.93001440e+01 4.75377857e+00 1.47472935e+01
 4.03281233e-01 1.23333837e+00 3.87165585e-02]
E = -525.4426865567696
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:38:47 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5078499        1
[INPUT] 0    0    [1    /1   ]  7618.25078499        1
[INPUT] 0    0    [1    /1   ]  3618.25078499        1
[INPUT] 0    0    [1    /1   ]  1618.25078499        1
[INPUT] 0    0    [1    /1   ]  239.783987351        1
[INPUT] 0    0    [1    /1   ]  51.8979142065        1
[INPUT] 0    0    [1    /1   ]  4.38708529427        1
[INPUT] 0    0    [1    /1   ]  0.438708529427       1
[INPUT] 0    0    [1    /1   ]  0.0938708529427      1
[INPUT] 1    0    [1    /1   ]  1362.79300324        1
[INPUT] 1    0    [1    /1   ]  665.180725752        1
[INPUT] 1    0    [1    /1   ]  303.320641863        1
[INPUT] 1    0    [1    /1   ]  316.146456063        1
[INPUT] 1    0    [1    /1   ]  49.3001440185        1
[INPUT] 1    0    [1    /1   ]  4.75377857326        1
[INPUT] 1    0    [1    /1   ]  14.7472935001        1
[INPUT] 1    0    [1    /1   ]  0.403281232738       1
[INPUT] 1    0    [1    /1   ]  1.23333836929        1
[INPUT] 1    0    [1    /1   ]  0.0387165584804      1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.507849929174, 1.0]], [0, [7618.250784992918, 1.0]], [0, [3618.2507849929175, 1.0]], [0, [1618.2507849929175, 1.0]], [0, [239.7839873511053, 1.0]], [0, [51.89791420649664, 1.0]], [0, [4.387085294269393, 1.0]], [0, [0.4387085294269393, 1.0]], [0, [0.09387085294269393, 1.0]], [1, [1362.7930032386791, 1.0]], [1, [665.1807257515178, 1.0]], [1, [303.32064186335555, 1.0]], [1, [316.1464560630523, 1.0]], [1, [49.300144018458525, 1.0]], [1, [4.75377857325692, 1.0]], [1, [14.74729350005786, 1.0]], [1, [0.40328123273769173, 1.0]], [1, [1.2333383692864934, 1.0]], [1, [0.03871655848043362, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50784993]
bas 1, expnt(s) = [7618.25078499]
bas 2, expnt(s) = [3618.25078499]
bas 3, expnt(s) = [1618.25078499]
bas 4, expnt(s) = [239.78398735]
bas 5, expnt(s) = [51.89791421]
bas 6, expnt(s) = [4.38708529]
bas 7, expnt(s) = [0.43870853]
bas 8, expnt(s) = [0.09387085]
bas 9, expnt(s) = [1362.79300324]
bas 10, expnt(s) = [665.18072575]
bas 11, expnt(s) = [303.32064186]
bas 12, expnt(s) = [316.14645606]
bas 13, expnt(s) = [49.30014402]
bas 14, expnt(s) = [4.75377857]
bas 15, expnt(s) = [14.7472935]
bas 16, expnt(s) = [0.40328123]
bas 17, expnt(s) = [1.23333837]
bas 18, expnt(s) = [0.03871656]
CPU time:         2.86
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825078e+04 5.20024082e+03 7.61825078e+03 2.06018620e+03
 3.61825078e+03 1.17866130e+03 1.61825078e+03 6.44613496e+02
 2.39783987e+02 1.53950165e+02 5.18979142e+01 4.88514492e+01
 4.38708529e+00 7.65855936e+00 4.38708529e-01 1.36190584e+00
 9.38708529e-02 4.28462776e-01 1.36279300e+03 2.41558187e+04
 6.65180726e+02 9.85505298e+03 3.03320642e+02 3.69285156e+03
 3.16146456e+02 3.88906131e+03 4.93001440e+01 3.81104983e+02
 4.75377857e+00 2.04777897e+01 1.47472935e+01 8.43091668e+01
 4.03281233e-01 9.37549934e-01 1.23333837e+00 3.79172818e+00
 3.87165585e-02 5.01020303e-02]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.922194332280583
cond(S) = 83440.78659432847
E1 = -726.4254001511144  E_coul = 202.49350190519988
init E= -523.931898245915
    CPU time for initialize scf      0.46 sec, wall time      0.05 sec
  HOMO = -0.553281322380215  LUMO = 0.110327933197715
  mo_energy =
[-1.17948453e+02 -1.21375722e+01 -9.49435494e+00 -9.49435494e+00
 -9.49435494e+00 -1.24323083e+00 -5.53281322e-01 -5.53281322e-01
 -5.53281322e-01  1.10327933e-01  1.10327933e-01  1.10327933e-01
  2.99290673e-01  2.33348566e+00  2.33348566e+00  2.33348566e+00
  1.66821308e+01  1.66821308e+01  1.66821308e+01  8.67822651e+01
  8.67822651e+01  8.67822651e+01  1.82274927e+02  4.19359356e+02
  4.19359356e+02  4.19359356e+02  1.27320864e+03  1.27320864e+03
  1.27320864e+03  1.91415294e+03  2.97536773e+03  2.97536773e+03
  2.97536773e+03  6.60464394e+03  6.60464394e+03  6.60464394e+03
  8.27266865e+03  2.46605443e+04  7.54569643e+04]
E1 = -727.8778615381125  E_coul = 202.43638368992265
cycle= 1 E= -525.44147784819  delta_E= -1.51  |g|= 0.198  |ddm|= 1.46
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.469142
diis-c [-0.22009441  1.        ]
  HOMO = -0.530354622097546  LUMO = 0.124481894273603
  mo_energy =
[-1.18112937e+02 -1.21228734e+01 -9.48785423e+00 -9.48785423e+00
 -9.48785423e+00 -1.21266365e+00 -5.30354622e-01 -5.30354622e-01
 -5.30354622e-01  1.24481894e-01  1.24481894e-01  1.24481894e-01
  3.18516921e-01  2.36008523e+00  2.36008523e+00  2.36008523e+00
  1.66931966e+01  1.66931966e+01  1.66931966e+01  8.67228142e+01
  8.67228142e+01  8.67228142e+01  1.82178910e+02  4.19208658e+02
  4.19208658e+02  4.19208658e+02  1.27299828e+03  1.27299828e+03
  1.27299828e+03  1.91379836e+03  2.97508283e+03  2.97508283e+03
  2.97508283e+03  6.60422842e+03  6.60422842e+03  6.60422842e+03
  8.27216101e+03  2.46599357e+04  7.54562593e+04]
E1 = -727.6372151491878  E_coul = 202.19455362834404
cycle= 2 E= -525.442661520844  delta_E= -0.00118  |g|= 0.0132  |ddm|= 0.083
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0155915
diis-c [-2.32571572e-04  6.87030218e-03  9.93129698e-01]
  HOMO = -0.54134046479962  LUMO = 0.123100001131206
  mo_energy =
[-1.18119815e+02 -1.21398383e+01 -9.50511603e+00 -9.50511603e+00
 -9.50511603e+00 -1.22421094e+00 -5.41340465e-01 -5.41340465e-01
 -5.41340465e-01  1.23100001e-01  1.23100001e-01  1.23100001e-01
  3.13289509e-01  2.34677316e+00  2.34677316e+00  2.34677316e+00
  1.66762759e+01  1.66762759e+01  1.66762759e+01  8.67106891e+01
  8.67106891e+01  8.67106891e+01  1.82171642e+02  4.19201639e+02
  4.19201639e+02  4.19201639e+02  1.27299272e+03  1.27299272e+03
  1.27299272e+03  1.91379352e+03  2.97507786e+03  2.97507786e+03
  2.97507786e+03  6.60422360e+03  6.60422360e+03  6.60422360e+03
  8.27215616e+03  2.46599307e+04  7.54562541e+04]
E1 = -727.6549316769257  E_coul = 202.21224584010577
cycle= 3 E= -525.44268583682  delta_E= -2.43e-05  |g|= 0.00138  |ddm|= 0.0114
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00198256
diis-c [-2.80583969e-06  6.59971470e-04 -6.66881242e-02  1.06602815e+00]
  HOMO = -0.54133381501168  LUMO = 0.12302943220152
  mo_energy =
[-1.18117855e+02 -1.21382305e+01 -9.50347811e+00 -9.50347811e+00
 -9.50347811e+00 -1.22403545e+00 -5.41333815e-01 -5.41333815e-01
 -5.41333815e-01  1.23029432e-01  1.23029432e-01  1.23029432e-01
  3.13102256e-01  2.34686598e+00  2.34686598e+00  2.34686598e+00
  1.66776130e+01  1.66776130e+01  1.66776130e+01  8.67125108e+01
  8.67125108e+01  8.67125108e+01  1.82173603e+02  4.19203582e+02
  4.19203582e+02  4.19203582e+02  1.27299465e+03  1.27299465e+03
  1.27299465e+03  1.91379534e+03  2.97507973e+03  2.97507973e+03
  2.97507973e+03  6.60422539e+03  6.60422539e+03  6.60422539e+03
  8.27215789e+03  2.46599324e+04  7.54562557e+04]
E1 = -727.6450762786093  E_coul = 202.2023897415004
cycle= 4 E= -525.442686537109  delta_E= -7e-07  |g|= 0.000433  |ddm|= 0.00228
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000626223
diis-c [-1.67231626e-07 -2.76177900e-04 -1.11621971e-02  2.10676531e-01
  8.00761844e-01]
  HOMO = -0.541597709788127  LUMO = 0.122997932582196
  mo_energy =
[-1.18118687e+02 -1.21388758e+01 -9.50413947e+00 -9.50413947e+00
 -9.50413947e+00 -1.22432427e+00 -5.41597710e-01 -5.41597710e-01
 -5.41597710e-01  1.22997933e-01  1.22997933e-01  1.22997933e-01
  3.12982376e-01  2.34652798e+00  2.34652798e+00  2.34652798e+00
  1.66770090e+01  1.66770090e+01  1.66770090e+01  8.67117625e+01
  8.67117625e+01  8.67117625e+01  1.82172789e+02  4.19202756e+02
  4.19202756e+02  4.19202756e+02  1.27299380e+03  1.27299380e+03
  1.27299380e+03  1.91379448e+03  2.97507888e+03  2.97507888e+03
  2.97507888e+03  6.60422453e+03  6.60422453e+03  6.60422453e+03
  8.27215703e+03  2.46599315e+04  7.54562548e+04]
E1 = -727.6466901330099  E_coul = 202.20400357704693
cycle= 5 E= -525.442686555963  delta_E= -1.89e-08  |g|= 5.1e-05  |ddm|= 0.000249
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.49024e-05
diis-c [-1.08973630e-10  1.86204647e-05 -2.20758951e-03 -2.33723924e-02
 -3.59910174e-02  1.06155238e+00]
  HOMO = -0.541635697196963  LUMO = 0.122991196898508
  mo_energy =
[-1.18118701e+02 -1.21389090e+01 -9.50417268e+00 -9.50417268e+00
 -9.50417268e+00 -1.22436127e+00 -5.41635697e-01 -5.41635697e-01
 -5.41635697e-01  1.22991197e-01  1.22991197e-01  1.22991197e-01
  3.12959138e-01  2.34648256e+00  2.34648256e+00  2.34648256e+00
  1.66769719e+01  1.66769719e+01  1.66769719e+01  8.67117388e+01
  8.67117388e+01  8.67117388e+01  1.82172774e+02  4.19202742e+02
  4.19202742e+02  4.19202742e+02  1.27299379e+03  1.27299379e+03
  1.27299379e+03  1.91379447e+03  2.97507887e+03  2.97507887e+03
  2.97507887e+03  6.60422452e+03  6.60422452e+03  6.60422452e+03
  8.27215702e+03  2.46599315e+04  7.54562548e+04]
E1 = -727.6465803337102  E_coul = 202.20389377694156
cycle= 6 E= -525.442686556769  delta_E= -8.06e-10  |g|= 6.97e-07  |ddm|= 8.04e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -727.6465803337102  E_coul = 202.20389377694156
  HOMO = -0.541635624383975  LUMO = 0.122991201287252
  mo_energy =
[-1.18118701e+02 -1.21389091e+01 -9.50417274e+00 -9.50417274e+00
 -9.50417274e+00 -1.22436134e+00 -5.41635624e-01 -5.41635624e-01
 -5.41635624e-01  1.22991201e-01  1.22991201e-01  1.22991201e-01
  3.12959112e-01  2.34648261e+00  2.34648261e+00  2.34648261e+00
  1.66769719e+01  1.66769719e+01  1.66769719e+01  8.67117387e+01
  8.67117387e+01  8.67117387e+01  1.82172774e+02  4.19202742e+02
  4.19202742e+02  4.19202742e+02  1.27299379e+03  1.27299379e+03
  1.27299379e+03  1.91379447e+03  2.97507887e+03  2.97507887e+03
  2.97507887e+03  6.60422452e+03  6.60422452e+03  6.60422452e+03
  8.27215702e+03  2.46599315e+04  7.54562548e+04]
E1 = -727.6465811084499  E_coul = 202.20389455168035
Extra cycle  E= -525.44268655677  delta_E= -9.09e-13  |g|= 1.3e-07  |ddm|= 1.24e-06
    CPU time for scf_cycle      0.66 sec, wall time      0.26 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 83440.78659432847
E1 = -727.6465811084499  E_coul = 202.20389455168035
init E= -525.44268655677
    CPU time for initialize scf      4.63 sec, wall time      0.50 sec
  HOMO = -0.541635591530683  LUMO = 0.122991203220317
  mo_energy =
[-1.18118701e+02 -1.21389091e+01 -9.50417268e+00 -9.50417268e+00
 -9.50417268e+00 -1.22436134e+00 -5.41635592e-01 -5.41635592e-01
 -5.41635592e-01  1.22991203e-01  1.22991203e-01  1.22991203e-01
  3.12959111e-01  2.34648264e+00  2.34648264e+00  2.34648264e+00
  1.66769719e+01  1.66769719e+01  1.66769719e+01  8.67117387e+01
  8.67117387e+01  8.67117387e+01  1.82172774e+02  4.19202742e+02
  4.19202742e+02  4.19202742e+02  1.27299379e+03  1.27299379e+03
  1.27299379e+03  1.91379447e+03  2.97507887e+03  2.97507887e+03
  2.97507887e+03  6.60422452e+03  6.60422452e+03  6.60422452e+03
  8.27215702e+03  2.46599315e+04  7.54562548e+04]
E1 = -727.6465809933292  E_coul = 202.20389443656077
cycle= 1 E= -525.442686556768  delta_E= 1.14e-12  |g|= 2.75e-08  |ddm|= 2.48e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.6465809933292  E_coul = 202.20389443656077
  HOMO = -0.541635592167903  LUMO = 0.122991202755568
  mo_energy =
[-1.18118701e+02 -1.21389091e+01 -9.50417269e+00 -9.50417269e+00
 -9.50417269e+00 -1.22436134e+00 -5.41635592e-01 -5.41635592e-01
 -5.41635592e-01  1.22991203e-01  1.22991203e-01  1.22991203e-01
  3.12959108e-01  2.34648264e+00  2.34648264e+00  2.34648264e+00
  1.66769719e+01  1.66769719e+01  1.66769719e+01  8.67117387e+01
  8.67117387e+01  8.67117387e+01  1.82172774e+02  4.19202742e+02
  4.19202742e+02  4.19202742e+02  1.27299379e+03  1.27299379e+03
  1.27299379e+03  1.91379447e+03  2.97507887e+03  2.97507887e+03
  2.97507887e+03  6.60422452e+03  6.60422452e+03  6.60422452e+03
  8.27215702e+03  2.46599315e+04  7.54562548e+04]
E1 = -727.6465810232695  E_coul = 202.20389446650046
Extra cycle  E= -525.442686556769  delta_E= -6.82e-13  |g|= 5.91e-09  |ddm|= 5.59e-08
    CPU time for scf_cycle      5.75 sec, wall time      1.62 sec
exp = [2.61825078e+04 7.61825078e+03 3.61825078e+03 1.61825078e+03
 2.39783987e+02 5.18979142e+01 4.38708529e+00 4.38708529e-01
 9.38708529e-02 1.36279300e+03 6.65180726e+02 3.03320642e+02
 3.16146456e+02 4.93001440e+01 4.75377857e+00 1.47472935e+01
 4.03281233e-01 1.23333837e+00 3.87165585e-02]
grad_E = [-1.97826570e-06  2.16499737e-05  4.31774588e-05  6.63898859e-04
  9.73184470e-04 -7.85667934e-03 -2.36408154e-01 -8.79543839e-02
 -2.77730641e-01  1.37785833e-06  2.03597393e-05  1.10383890e-04
  9.72281995e-05 -1.41367608e-03 -1.70235877e-02  9.97230168e-03
  1.25821644e+00 -1.17877517e-01 -2.46658771e+00]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:38:55 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5078519        1
[INPUT] 0    0    [1    /1   ]  7618.25076334        1
[INPUT] 0    0    [1    /1   ]  3618.25074182        1
[INPUT] 0    0    [1    /1   ]  1618.25012109        1
[INPUT] 0    0    [1    /1   ]  239.783014167        1
[INPUT] 0    0    [1    /1   ]  51.9057708858        1
[INPUT] 0    0    [1    /1   ]  4.62349344815        1
[INPUT] 0    0    [1    /1   ]  0.526662913295       1
[INPUT] 0    0    [1    /1   ]  0.371601493776       1
[INPUT] 1    0    [1    /1   ]  1362.79300186        1
[INPUT] 1    0    [1    /1   ]  665.180705392        1
[INPUT] 1    0    [1    /1   ]  303.320531479        1
[INPUT] 1    0    [1    /1   ]  316.146358835        1
[INPUT] 1    0    [1    /1   ]  49.3015576945        1
[INPUT] 1    0    [1    /1   ]  4.770802161          1
[INPUT] 1    0    [1    /1   ]  14.7373211984        1
[INPUT] 1    0    [1    /1   ]  1.00000002723e-09      1
[INPUT] 1    0    [1    /1   ]  1.3512158858         1
[INPUT] 1    0    [1    /1   ]  2.50530427225        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.50785190744, 1.0]], [0, [7618.250763342944, 1.0]], [0, [3618.2507418154587, 1.0]], [0, [1618.2501210940584, 1.0]], [0, [239.78301416663564, 1.0]], [0, [51.90577088583811, 1.0]], [0, [4.623493448149005, 1.0]], [0, [0.5266629132952043, 1.0]], [0, [0.3716014937760892, 1.0]], [1, [1362.7930018608208, 1.0]], [1, [665.1807053917785, 1.0]], [1, [303.3205314794651, 1.0]], [1, [316.1463588348528, 1.0]], [1, [49.301557694536776, 1.0]], [1, [4.770802161004806, 1.0]], [1, [14.737321198381967, 1.0]], [1, [1.0000000272292198e-09, 1.0]], [1, [1.351215885801161, 1.0]], [1, [2.5053042722463514, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50785191]
bas 1, expnt(s) = [7618.25076334]
bas 2, expnt(s) = [3618.25074182]
bas 3, expnt(s) = [1618.25012109]
bas 4, expnt(s) = [239.78301417]
bas 5, expnt(s) = [51.90577089]
bas 6, expnt(s) = [4.62349345]
bas 7, expnt(s) = [0.52666291]
bas 8, expnt(s) = [0.37160149]
bas 9, expnt(s) = [1362.79300186]
bas 10, expnt(s) = [665.18070539]
bas 11, expnt(s) = [303.32053148]
bas 12, expnt(s) = [316.14635883]
bas 13, expnt(s) = [49.30155769]
bas 14, expnt(s) = [4.77080216]
bas 15, expnt(s) = [14.7373212]
bas 16, expnt(s) = [1.00000003e-09]
bas 17, expnt(s) = [1.35121589]
bas 18, expnt(s) = [2.50530427]
CPU time:        16.51
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024082e+03 7.61825076e+03 2.06018619e+03
 3.61825074e+03 1.17866129e+03 1.61825012e+03 6.44613298e+02
 2.39783014e+02 1.53949696e+02 5.19057709e+01 4.88569957e+01
 4.62349345e+00 7.96604415e+00 5.26662913e-01 1.56194083e+00
 3.71601494e-01 1.20246685e+00 1.36279300e+03 2.41558187e+04
 6.65180705e+02 9.85505260e+03 3.03320531e+02 3.69284988e+03
 3.16146359e+02 3.88905982e+03 4.93015577e+01 3.81118643e+02
 4.77080216e+00 2.05694961e+01 1.47373212e+01 8.42379092e+01
 1.00000003e-09 1.64053087e-11 1.35121589e+00 4.25001361e+00
 2.50530427e+00 9.19517484e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 16.2151590816339
cond(S) = 85373.558439328
E1 = -706.8220946513477  E_coul = 192.88738860394318
init E= -513.934706047404
    CPU time for initialize scf      0.47 sec, wall time      0.05 sec
  HOMO = -0.359691123547777  LUMO = -0.000605549313528672
  mo_energy =
[-1.18523073e+02 -1.27620146e+01 -1.00796254e+01 -1.00796254e+01
 -1.00796254e+01 -1.80574382e+00 -3.59691124e-01 -3.59691124e-01
 -3.59691124e-01 -6.05549314e-04 -6.05549314e-04 -6.05549313e-04
  6.52155134e-01  6.75399436e+00  6.75399436e+00  6.75399436e+00
  2.43612985e+01  2.43612985e+01  2.43612985e+01  9.32942643e+01
  9.32942643e+01  9.32942643e+01  1.83885699e+02  4.23742840e+02
  4.23742840e+02  4.23742840e+02  1.27684610e+03  1.27684610e+03
  1.27684610e+03  1.91509485e+03  2.97866234e+03  2.97866234e+03
  2.97866234e+03  6.60758311e+03  6.60758311e+03  6.60758311e+03
  8.27342346e+03  2.46612187e+04  7.54575494e+04]
E1 = -746.1207606453754  E_coul = 225.63283043297477
cycle= 1 E= -520.487930212401  delta_E= -6.55  |g|= 0.94  |ddm|= 52.1
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.911046
diis-c [-0.83000435  1.        ]
  HOMO = -0.000605549313528849  LUMO = 0.943592378598905
  mo_energy =
[-1.15926614e+02 -1.04828869e+01 -7.77994729e+00 -7.77994729e+00
 -7.77994729e+00 -5.53864929e-01 -6.05549314e-04 -6.05549314e-04
 -6.05549314e-04  9.43592379e-01  9.43592379e-01  9.43592379e-01
  1.77815891e+00  8.54054777e+00  8.54054777e+00  8.54054777e+00
  2.65028363e+01  2.65028363e+01  2.65028363e+01  9.57477248e+01
  9.57477248e+01  9.57477248e+01  1.86491737e+02  4.26336336e+02
  4.26336336e+02  4.26336336e+02  1.27943732e+03  1.27943732e+03
  1.27943732e+03  1.91757222e+03  2.98120265e+03  2.98120265e+03
  2.98120265e+03  6.61000827e+03  6.61000827e+03  6.61000827e+03
  8.27576356e+03  2.46634622e+04  7.54596988e+04]
E1 = -653.4830084850361  E_coul = 139.53952305476108
cycle= 2 E= -513.943485430275  delta_E= 6.54  |g|= 2.22  |ddm|= 16.2
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.36455
diis-c [-0.39705682  0.86778936  0.13221064]
  HOMO = -0.000605549313350187  LUMO = 0.412414612098447
  mo_energy =
[-1.16915024e+02 -1.13233814e+01 -8.63054151e+00 -8.63054151e+00
 -8.63054151e+00 -1.05651165e+00 -6.05549314e-04 -6.05549314e-04
 -6.05549313e-04  4.12414612e-01  4.12414612e-01  4.12414612e-01
  1.29885963e+00  7.84837254e+00  7.84837254e+00  7.84837254e+00
  2.57000670e+01  2.57000670e+01  2.57000670e+01  9.48318119e+01
  9.48318119e+01  9.48318119e+01  1.85517508e+02  4.25352764e+02
  4.25352764e+02  4.25352764e+02  1.27843733e+03  1.27843733e+03
  1.27843733e+03  1.91656260e+03  2.98019551e+03  2.98019551e+03
  2.98019551e+03  6.60899626e+03  6.60899626e+03  6.60899626e+03
  8.27474917e+03  2.46624463e+04  7.54586822e+04]
E1 = -654.530459838331  E_coul = 140.44138938412468
cycle= 3 E= -514.089070454206  delta_E= -0.146  |g|= 1.88  |ddm|= 1.74
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.56922
diis-c [-0.08303813  0.23340959 -3.2489936   4.01558401]
  HOMO = -2.04571022202197  LUMO = -0.82513845443271
  mo_energy =
[-1.21122460e+02 -1.50722134e+01 -1.24025023e+01 -1.24025023e+01
 -1.24025023e+01 -3.54606738e+00 -2.04571022e+00 -2.04571022e+00
 -2.04571022e+00 -8.25138454e-01 -6.05549314e-04 -6.05549314e-04
 -6.05549314e-04  4.71195257e+00  4.71195257e+00  4.71195257e+00
  2.21266550e+01  2.21266550e+01  2.21266550e+01  9.08595471e+01
  9.08595471e+01  9.08595471e+01  1.81352520e+02  4.21161564e+02
  4.21161564e+02  4.21161564e+02  1.27419956e+03  1.27419956e+03
  1.27419956e+03  1.91231000e+03  2.97594306e+03  2.97594306e+03
  2.97594306e+03  6.60474009e+03  6.60474009e+03  6.60474009e+03
  8.27049323e+03  2.46581920e+04  7.54544298e+04]
E1 = -749.8805426385638  E_coul = 229.7199718212943
cycle= 4 E= -520.16057081727  delta_E= -6.07  |g|= 2.07  |ddm|= 14.1
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.79062
diis-c [-0.08298395  0.24843803 -3.22936803  3.99074863 -0.00981863]
  HOMO = -2.02619381953616  LUMO = -0.808672958705431
  mo_energy =
[-1.21091342e+02 -1.50436492e+01 -1.23738890e+01 -1.23738890e+01
 -1.23738890e+01 -3.52547595e+00 -2.02619382e+00 -2.02619382e+00
 -2.02619382e+00 -8.08672959e-01 -6.05549315e-04 -6.05549314e-04
 -6.05549314e-04  4.73643762e+00  4.73643762e+00  4.73643762e+00
  2.21539860e+01  2.21539860e+01  2.21539860e+01  9.08893190e+01
  9.08893190e+01  9.08893190e+01  1.81383418e+02  4.21192588e+02
  4.21192588e+02  4.21192588e+02  1.27423082e+03  1.27423082e+03
  1.27423082e+03  1.91234125e+03  2.97597435e+03  2.97597435e+03
  2.97597435e+03  6.60477133e+03  6.60477133e+03  6.60477133e+03
  8.27052443e+03  2.46582232e+04  7.54544609e+04]
E1 = -749.8396849967826  E_coul = 229.67400206185584
cycle= 5 E= -520.165682934927  delta_E= -0.00511  |g|= 2.05  |ddm|= 0.0468
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.77969
diis-c [-2.41791454e-02  3.14434586e-02  4.30492817e-02  4.23056210e-02
 -1.24782641e+02  1.25665842e+02]
  HOMO = -0.00060554931320334  LUMO = 0.550444523920221
  mo_energy =
[-1.16810274e+02 -1.11719308e+01 -8.48633331e+00 -8.48633331e+00
 -8.48633331e+00 -9.23179862e-01 -6.05549314e-04 -6.05549314e-04
 -6.05549313e-04  5.50444524e-01  5.50444524e-01  5.50444524e-01
  1.46414780e+00  8.01949415e+00  8.01949415e+00  8.01949415e+00
  2.58533599e+01  2.58533599e+01  2.58533599e+01  9.49587949e+01
  9.49587949e+01  9.49587949e+01  1.85628626e+02  4.25459023e+02
  4.25459023e+02  4.25459023e+02  1.27853626e+03  1.27853626e+03
  1.27853626e+03  1.91665278e+03  2.98028922e+03  2.98028922e+03
  2.98028922e+03  6.60908411e+03  6.60908411e+03  6.60908411e+03
  8.27483340e+03  2.46625277e+04  7.54587616e+04]
E1 = -654.3434531165877  E_coul = 140.2993863600695
cycle= 6 E= -514.044066756518  delta_E= 6.12  |g|= 1.89  |ddm|= 14.3
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.38726
diis-c [-2.38615740e-02  3.45630472e-02  1.37588545e-01 -5.61282204e-01
 -1.24169599e+02  1.25045470e+02  5.13258966e-01]
  HOMO = -0.000605549313525954  LUMO = 0.526682361088106
  mo_energy =
[-1.16858364e+02 -1.12123215e+01 -8.52833098e+00 -8.52833098e+00
 -8.52833098e+00 -9.42125081e-01 -6.05549314e-04 -6.05549314e-04
 -6.05549314e-04  5.26682361e-01  5.26682361e-01  5.26682361e-01
  1.44642917e+00  7.98712520e+00  7.98712520e+00  7.98712520e+00
  2.58145036e+01  2.58145036e+01  2.58145036e+01  9.49141438e+01
  9.49141438e+01  9.49141438e+01  1.85581593e+02  4.25411211e+02
  4.25411211e+02  4.25411211e+02  1.27848740e+03  1.27848740e+03
  1.27848740e+03  1.91660264e+03  2.98023961e+03  2.98023961e+03
  2.98023961e+03  6.60903363e+03  6.60903363e+03  6.60903363e+03
  8.27478238e+03  2.46624763e+04  7.54587099e+04]
E1 = -654.3583521738199  E_coul = 140.31448075849988
cycle= 7 E= -514.04387141532  delta_E= 0.000195  |g|= 1.89  |ddm|= 0.0181
    CPU time for cycle= 7      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.34209
diis-c [-5.39661391e-03  4.21561539e-02  1.90826357e+00  1.46017253e+00
 -1.27038601e+02  1.27951557e+02 -4.57966611e+01  4.24731126e+01]
  HOMO = -0.000605549313516015  LUMO = 0.690726498557004
  mo_energy =
[-1.16583627e+02 -1.09635659e+01 -8.27997750e+00 -8.27997750e+00
 -8.27997750e+00 -7.78699454e-01 -6.05549314e-04 -6.05549314e-04
 -6.05549314e-04  6.90726499e-01  6.90726499e-01  6.90726499e-01
  1.60229232e+00  8.19673885e+00  8.19673885e+00  8.19673885e+00
  2.60511898e+01  2.60511898e+01  2.60511898e+01  9.51753530e+01
  9.51753530e+01  9.51753530e+01  1.85854646e+02  4.25684951e+02
  4.25684951e+02  4.25684951e+02  1.27876277e+03  1.27876277e+03
  1.27876277e+03  1.91687600e+03  2.98051434e+03  2.98051434e+03
  2.98051434e+03  6.60930646e+03  6.60930646e+03  6.60930646e+03
  8.27505380e+03  2.46627465e+04  7.54589792e+04]
E1 = -653.9953289332204  E_coul = 140.00813803927372
cycle= 8 E= -513.987190893947  delta_E= 0.0567  |g|= 1.99  |ddm|= 0.745
    CPU time for cycle= 8      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.51631
diis-c [-5.12932373e-03  4.45060538e-02  9.61773682e-01  3.10296238e+00
 -1.28022142e+02  1.28939215e+02 -4.37692847e+01  3.67329436e+01
  3.01002611e+00]
  HOMO = -0.000605549313527897  LUMO = 0.715978781750228
  mo_energy =
[-1.16541855e+02 -1.09253950e+01 -8.24164517e+00 -8.24164517e+00
 -8.24164517e+00 -7.54408444e-01 -6.05549314e-04 -6.05549314e-04
 -6.05549314e-04  7.15978782e-01  7.15978782e-01  7.15978782e-01
  1.62520168e+00  8.22927047e+00  8.22927047e+00  8.22927047e+00
  2.60877639e+01  2.60877639e+01  2.60877639e+01  9.52152756e+01
  9.52152756e+01  9.52152756e+01  1.85896073e+02  4.25726593e+02
  4.25726593e+02  4.25726593e+02  1.27880477e+03  1.27880477e+03
  1.27880477e+03  1.91691813e+03  2.98055646e+03  2.98055646e+03
  2.98055646e+03  6.60934862e+03  6.60934862e+03  6.60934862e+03
  8.27509596e+03  2.46627886e+04  7.54590213e+04]
E1 = -653.9501445118481  E_coul = 139.9697904930543
cycle= 9 E= -513.980354018794  delta_E= 0.00684  |g|= 2.01  |ddm|= 0.0885
    CPU time for cycle= 9      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.54303
diis-c [-5.33575119e-03 -2.03398571e+01  6.57715941e-01  2.88410183e+00
 -1.34572642e+02  1.35557290e+02 -3.37544423e+01  2.40943654e+01
  2.64734679e+01]
  HOMO = -0.000605549313520359  LUMO = 0.803916318489589
  mo_energy =
[-1.16392852e+02 -1.07916561e+01 -8.10714799e+00 -8.10714799e+00
 -8.10714799e+00 -6.70684404e-01 -6.05549314e-04 -6.05549314e-04
 -6.05549314e-04  8.03916318e-01  8.03916318e-01  8.03916319e-01
  1.70869789e+00  8.34263173e+00  8.34263173e+00  8.34263173e+00
  2.62158175e+01  2.62158175e+01  2.62158175e+01  9.53566120e+01
  9.53566120e+01  9.53566120e+01  1.86043788e+02  4.25875076e+02
  4.25875076e+02  4.25875076e+02  1.27895472e+03  1.27895472e+03
  1.27895472e+03  1.91706841e+03  2.98070681e+03  2.98070681e+03
  2.98070681e+03  6.60949898e+03  6.60949898e+03  6.60949898e+03
  8.27524624e+03  2.46629388e+04  7.54591713e+04]
E1 = -653.7720770603229  E_coul = 139.81957482536484
cycle= 10 E= -513.952502234958  delta_E= 0.0279  |g|= 2.06  |ddm|= 0.366
    CPU time for cycle= 10      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.64379
diis-c [-5.36229697e-03 -2.60275462e+01 -4.87738961e+00  3.13689076e+00
 -1.38614468e+02  1.39627669e+02 -2.11214527e+01  6.54272629e+00
  4.23335709e+01]
  HOMO = -0.000605549313184658  LUMO = 0.912587103705644
  mo_energy =
[-1.16210613e+02 -1.06272238e+01 -7.94195163e+00 -7.94195163e+00
 -7.94195163e+00 -5.67617217e-01 -6.05549314e-04 -6.05549314e-04
 -6.05549313e-04  9.12587104e-01  9.12587104e-01  9.12587104e-01
  1.81230486e+00  8.48255865e+00  8.48255865e+00  8.48255865e+00
  2.63733449e+01  2.63733449e+01  2.63733449e+01  9.55298229e+01
  9.55298229e+01  9.55298229e+01  1.86224498e+02  4.26056703e+02
  4.26056703e+02  4.26056703e+02  1.27913806e+03  1.27913806e+03
  1.27913806e+03  1.91725216e+03  2.98089063e+03  2.98089063e+03
  2.98089063e+03  6.60968281e+03  6.60968281e+03  6.60968281e+03
  8.27542998e+03  2.46631224e+04  7.54593548e+04]
E1 = -653.5546718260572  E_coul = 139.63701464906302
cycle= 11 E= -513.917657176994  delta_E= 0.0348  |g|= 2.12  |ddm|= 0.464
    CPU time for cycle= 11      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.76434
diis-c [-1.45217511e-03  2.25591672e+01 -3.54286268e+02  1.68102412e+02
 -8.35140238e+01  8.41256309e+01  1.58448001e+01 -2.17533784e+01
  1.69921661e+02]
  HOMO = -0.604111970359408  LUMO = -0.000605549313531286
  mo_energy =
[-1.18743814e+02 -1.29125087e+01 -1.02361052e+01 -1.02361052e+01
 -1.02361052e+01 -2.05257025e+00 -6.04111970e-01 -6.04111970e-01
 -6.04111970e-01 -6.05549314e-04 -6.05549314e-04 -6.05549313e-04
  4.03621882e-01  6.54053065e+00  6.54053065e+00  6.54053065e+00
  2.41871454e+01  2.41871454e+01  2.41871454e+01  9.31235645e+01
  9.31235645e+01  9.31235645e+01  1.83711748e+02  4.23532163e+02
  4.23532163e+02  4.23532163e+02  1.27659072e+03  1.27659072e+03
  1.27659072e+03  1.91470310e+03  2.97833861e+03  2.97833861e+03
  2.97833861e+03  6.60713353e+03  6.60713353e+03  6.60713353e+03
  8.27288397e+03  2.46605799e+04  7.54568152e+04]
E1 = -746.6686946045519  E_coul = 226.2093162937036
cycle= 12 E= -520.459378310848  delta_E= -6.54  |g|= 1.07  |ddm|= 15.7
    CPU time for cycle= 12      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.920724
diis-c [-4.71898464e-04  5.61452864e+00 -1.86940099e+02  8.96254551e+01
  1.53521487e+00 -7.31871330e-01  6.46436339e+00 -1.00066188e+01
  9.54390268e+01]
  HOMO = -0.000605549313387498  LUMO = 0.11959993166006
  mo_energy =
[-1.17534673e+02 -1.18223622e+01 -9.14248718e+00 -9.14248718e+00
 -9.14248718e+00 -1.32570966e+00 -6.05549314e-04 -6.05549314e-04
 -6.05549313e-04  1.19599932e-01  1.19599932e-01  1.19599932e-01
  1.05688987e+00  7.46193132e+00  7.46193132e+00  7.46193132e+00
  2.52279305e+01  2.52279305e+01  2.52279305e+01  9.42711072e+01
  9.42711072e+01  9.42711072e+01  1.84910943e+02  4.24737108e+02
  4.24737108e+02  4.24737108e+02  1.27780670e+03  1.27780670e+03
  1.27780670e+03  1.91591984e+03  2.97955683e+03  2.97955683e+03
  2.97955683e+03  6.60835036e+03  6.60835036e+03  6.60835036e+03
  8.27409916e+03  2.46617933e+04  7.54580272e+04]
E1 = -655.1152526366507  E_coul = 140.96438619039165
cycle= 13 E= -514.150866446259  delta_E= 6.31  |g|= 1.65  |ddm|= 15.1
    CPU time for cycle= 13      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.91843
diis-c [-9.80193828e-04 -1.07849104e+02  2.46985438e+01  4.02243262e+01
  9.06703655e-03  1.93756206e+01 -2.45108835e+01  3.03240827e+01
  1.87283468e+01]
  HOMO = -2.89095184945222  LUMO = -1.53989030173261
  mo_energy =
[-1.22525425e+02 -1.63315258e+01 -1.36651222e+01 -1.36651222e+01
 -1.36651222e+01 -4.44051949e+00 -2.89095185e+00 -2.89095185e+00
 -2.89095185e+00 -1.53989030e+00 -6.05549314e-04 -6.05549314e-04
 -6.05549313e-04  3.65234327e+00  3.65234327e+00  3.65234327e+00
  2.09266458e+01  2.09266458e+01  2.09266458e+01  8.95314413e+01
  8.95314413e+01  8.95314413e+01  1.79960562e+02  4.19763500e+02
  4.19763500e+02  4.19763500e+02  1.27278838e+03  1.27278838e+03
  1.27278838e+03  1.91089895e+03  2.97452969e+03  2.97452969e+03
  2.97452969e+03  6.60332925e+03  6.60332925e+03  6.60332925e+03
  8.26908493e+03  2.46567862e+04  7.54530261e+04]
E1 = -751.6903204883529  E_coul = 231.7961705102006
cycle= 14 E= -519.894149978152  delta_E= -5.74  |g|= 2.66  |ddm|= 13.6
    CPU time for cycle= 14      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.32481
diis-c [-7.35844524e-04 -1.71224004e+01 -1.54346360e+02  8.58490121e+01
  9.53836949e-01  4.42271105e+00 -3.38137298e-01 -1.51992721e+00
  8.31012649e+01]
  HOMO = -0.587409361054302  LUMO = -0.00060554931353064
  mo_energy =
[-1.18711738e+02 -1.28850786e+01 -1.02085495e+01 -1.02085495e+01
 -1.02085495e+01 -2.03286101e+00 -5.87409361e-01 -5.87409361e-01
 -5.87409361e-01 -6.05549314e-04 -6.05549314e-04 -6.05549313e-04
  4.14637082e-01  6.56067392e+00  6.56067392e+00  6.56067392e+00
  2.42124599e+01  2.42124599e+01  2.42124599e+01  9.31531502e+01
  9.31531502e+01  9.31531502e+01  1.83743358e+02  4.23564065e+02
  4.23564065e+02  4.23564065e+02  1.27662312e+03  1.27662312e+03
  1.27662312e+03  1.91473568e+03  2.97837118e+03  2.97837118e+03
  2.97837118e+03  6.60716615e+03  6.60716615e+03  6.60716615e+03
  8.27291659e+03  2.46606125e+04  7.54568478e+04]
E1 = -746.6277276216722  E_coul = 226.16581325747484
cycle= 15 E= -520.461914364197  delta_E= -0.568  |g|= 1.06  |ddm|= 5.35
    CPU time for cycle= 15      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.906113
diis-c [-7.52688604e-04 -8.41884009e+00 -1.74015805e+02  9.37888500e+01
 -2.23599747e+00  3.41570848e+00 -3.22356301e-01  3.18737775e+00
  8.56010631e+01]
  HOMO = -0.537192517388827  LUMO = -0.000605549313531169
  mo_energy =
[-1.18627647e+02 -1.28092938e+01 -1.01326051e+01 -1.01326051e+01
 -1.01326051e+01 -1.98175560e+00 -5.37192517e-01 -5.37192517e-01
 -5.37192517e-01 -6.05549314e-04 -6.05549314e-04 -6.05549313e-04
  4.59460377e-01  6.62449870e+00  6.62449870e+00  6.62449870e+00
  2.42846806e+01  2.42846806e+01  2.42846806e+01  9.32328941e+01
  9.32328941e+01  9.32328941e+01  1.83826770e+02  4.23647861e+02
  4.23647861e+02  4.23647861e+02  1.27670767e+03  1.27670767e+03
  1.27670767e+03  1.91482021e+03  2.97845585e+03  2.97845585e+03
  2.97845585e+03  6.60725067e+03  6.60725067e+03  6.60725067e+03
  8.27300095e+03  2.46606967e+04  7.54569319e+04]
E1 = -746.5015657578318  E_coul = 226.03170555368337
cycle= 16 E= -520.469860204149  delta_E= -0.00795  |g|= 1.02  |ddm|= 0.131
    CPU time for cycle= 16      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.874352
diis-c [-3.37850416e-05 -1.94861192e+01  2.29426693e+01 -5.03297780e+00
  5.42353501e+00  1.48736521e+00  4.98670023e-01 -6.17872730e+01
  5.69541305e+01]
  HOMO = -0.000605549313329758  LUMO = 1.18521283019973
  mo_energy =
[-1.15760657e+02 -1.02198462e+01 -7.53632165e+00 -7.53632165e+00
 -7.53632165e+00 -2.86641959e-01 -6.05549314e-04 -6.05549314e-04
 -6.05549313e-04  1.18521283e+00  1.18521283e+00  1.18521283e+00
  2.06708643e+00  8.82208483e+00  8.82208483e+00  8.82208483e+00
  2.67595524e+01  2.67595524e+01  2.67595524e+01  9.59560677e+01
  9.59560677e+01  9.59560677e+01  1.86670999e+02  4.26505109e+02
  4.26505109e+02  4.26505109e+02  1.27959029e+03  1.27959029e+03
  1.27959029e+03  1.91770331e+03  2.98134305e+03  2.98134305e+03
  2.98134305e+03  6.61013360e+03  6.61013360e+03  6.61013360e+03
  8.27587939e+03  2.46635705e+04  7.54598019e+04]
E1 = -652.8610962977804  E_coul = 139.0647133851953
cycle= 17 E= -513.796382912585  delta_E= 6.67  |g|= 2.31  |ddm|= 16.3
    CPU time for cycle= 17      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.07935
diis-c [-7.32806280e-05 -8.32037364e-01 -5.30290018e+00  6.18825187e+00
  3.39844089e+00 -2.14240487e-01  4.76820374e-01 -5.98480906e+01
  5.71337555e+01]
  HOMO = -0.000605549313520496  LUMO = 1.45414421681747
  mo_energy =
[-1.15310948e+02 -9.81405848e+00 -7.12918897e+00 -7.12918897e+00
 -7.12918897e+00 -3.58190788e-02 -6.05549314e-04 -6.05549314e-04
 -6.05549314e-04  1.45414422e+00  1.45414422e+00  1.45414422e+00
  2.33342300e+00  9.16792673e+00  9.16792673e+00  9.16792673e+00
  2.71482614e+01  2.71482614e+01  2.71482614e+01  9.63833713e+01
  9.63833713e+01  9.63833713e+01  1.87117186e+02  4.26953305e+02
  4.26953305e+02  4.26953305e+02  1.28004245e+03  1.28004245e+03
  1.28004245e+03  1.91815557e+03  2.98179594e+03  2.98179594e+03
  2.98179594e+03  6.61058585e+03  6.61058585e+03  6.61058585e+03
  8.27633095e+03  2.46640214e+04  7.54602522e+04]
E1 = -652.2809355994775  E_coul = 138.58968295105691
cycle= 18 E= -513.691252648421  delta_E= 0.105  |g|= 2.47  |ddm|=  1.5
    CPU time for cycle= 18      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.38197
diis-c [-8.42674431e-06 -4.53370399e+00  3.00596568e+00  1.12248123e+00
  5.32116880e+00  3.63366343e-01  4.57742557e-01 -5.82730185e+01
  5.35359979e+01]
  HOMO = -0.000605549312996888  LUMO = 1.00887063383626
  mo_energy =
[-1.16054793e+02 -1.04855165e+01 -7.80271508e+00 -7.80271508e+00
 -7.80271508e+00 -4.53592409e-01 -6.05549314e-04 -6.05549314e-04
 -6.05549313e-04  1.00887063e+00  1.00887063e+00  1.00887063e+00
  1.89497058e+00  8.59592684e+00  8.59592684e+00  8.59592684e+00
  2.65052787e+01  2.65052787e+01  2.65052787e+01  9.56765736e+01
  9.56765736e+01  9.56765736e+01  1.86379155e+02  4.26211960e+02
  4.26211960e+02  4.26211960e+02  1.27929457e+03  1.27929457e+03
  1.27929457e+03  1.91740758e+03  2.98104688e+03  2.98104688e+03
  2.98104688e+03  6.60983790e+03  6.60983790e+03  6.60983790e+03
  8.27558417e+03  2.46632758e+04  7.54595076e+04]
E1 = -653.2412706897331  E_coul = 139.37882515362645
cycle= 19 E= -513.862445536107  delta_E= -0.171  |g|= 2.21  |ddm|= 2.42
    CPU time for cycle= 19      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.88366
diis-c [-2.70479555e-05 -3.12768105e+01  1.14138273e+01  2.03457181e+01
  5.16633778e+00 -5.03330742e-01  4.18706470e-01 -5.54990155e+01
  5.09345671e+01]
  HOMO = -0.000605549313324506  LUMO = 0.929368123691021
  mo_energy =
[-1.16187682e+02 -1.06053455e+01 -7.92288018e+00 -7.92288018e+00
 -7.92288018e+00 -5.30000791e-01 -6.05549314e-04 -6.05549314e-04
 -6.05549313e-04  9.29368124e-01  9.29368124e-01  9.29368124e-01
  1.81848643e+00  8.49415547e+00  8.49415547e+00  8.49415547e+00
  2.63906650e+01  2.63906650e+01  2.63906650e+01  9.55504063e+01
  9.55504063e+01  9.55504063e+01  1.86247338e+02  4.26079526e+02
  4.26079526e+02  4.26079526e+02  1.27916094e+03  1.27916094e+03
  1.27916094e+03  1.91727391e+03  2.98091303e+03  2.98091303e+03
  2.98091303e+03  6.60970423e+03  6.60970423e+03  6.60970423e+03
  8.27545070e+03  2.46631425e+04  7.54593745e+04]
E1 = -653.4135768060319  E_coul = 139.52200909953993
cycle= 20 E= -513.891567706492  delta_E= -0.0291  |g|= 2.16  |ddm|=  0.4
    CPU time for cycle= 20      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.79464
diis-c [-6.51106235e-05 -2.76273675e+01  6.15868804e+00  5.06486911e+01
 -2.92022816e+01 -6.90154695e-02  3.37906733e-01 -4.61521292e+01
  4.69055080e+01]
  HOMO = -0.000605549313526902  LUMO = 1.19595884204664
  mo_energy =
[-1.15739695e+02 -1.02017688e+01 -7.51775839e+00 -7.51775839e+00
 -7.51775839e+00 -2.79405987e-01 -6.05549314e-04 -6.05549314e-04
 -6.05549314e-04  1.19595884e+00  1.19595884e+00  1.19595884e+00
  2.07823364e+00  8.83725925e+00  8.83725925e+00  8.83725925e+00
  2.67770491e+01  2.67770491e+01  2.67770491e+01  9.59758000e+01
  9.59758000e+01  9.59758000e+01  1.86691700e+02  4.26525979e+02
  4.26525979e+02  4.26525979e+02  1.27961145e+03  1.27961145e+03
  1.27961145e+03  1.91772471e+03  2.98136437e+03  2.98136437e+03
  2.98136437e+03  6.61015507e+03  6.61015507e+03  6.61015507e+03
  8.27590094e+03  2.46635922e+04  7.54598236e+04]
E1 = -652.8491093630993  E_coul = 139.05407549605175
cycle= 21 E= -513.795033867048  delta_E= 0.0965  |g|= 2.32  |ddm|= 1.34
    CPU time for cycle= 21      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.09586
diis-c [-5.89497574e-05 -3.63923841e+01  9.13790090e+00  7.19729752e+01
 -4.08791455e+01 -3.90623041e+00  3.04794563e-01 -4.37806017e+01
  4.45426910e+01]
  HOMO = -0.00060554931330529  LUMO = 1.10412106602655
  mo_energy =
[-1.15893543e+02 -1.03405052e+01 -7.65699615e+00 -7.65699615e+00
 -7.65699615e+00 -3.66115301e-01 -6.05549314e-04 -6.05549314e-04
 -6.05549313e-04  1.10412107e+00  1.10412107e+00  1.10412107e+00
  1.98906003e+00  8.71934261e+00  8.71934261e+00  8.71934261e+00
  2.66442503e+01  2.66442503e+01  2.66442503e+01  9.58296884e+01
  9.58296884e+01  9.58296884e+01  1.86539113e+02  4.26372658e+02
  4.26372658e+02  4.26372658e+02  1.27945673e+03  1.27945673e+03
  1.27945673e+03  1.91756987e+03  2.98120935e+03  2.98120935e+03
  2.98120935e+03  6.61000021e+03  6.61000021e+03  6.61000021e+03
  8.27574629e+03  2.46634377e+04  7.54596693e+04]
E1 = -653.044668970356  E_coul = 139.2155777659518
cycle= 22 E= -513.829091204404  delta_E= -0.0341  |g|= 2.26  |ddm|= 0.476
    CPU time for cycle= 22      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.99193
diis-c [-3.67829256e-04 -8.16250458e+01  2.62985014e+01  1.66832941e+02
 -9.07913594e+01 -3.05532468e+01  9.90294191e+00 -2.46724880e+01
  2.56077552e+01]
  HOMO = -0.000605549313499116  LUMO = 0.611497647530623
  mo_energy =
[-1.16715612e+02 -1.10828749e+01 -8.40125370e+00 -8.40125370e+00
 -8.40125370e+00 -8.40315735e-01 -6.05549314e-04 -6.05549314e-04
 -6.05549313e-04  6.11497648e-01  6.11497648e-01  6.11497648e-01
  1.51729177e+00  8.08916401e+00  8.08916401e+00  8.08916401e+00
  2.59344771e+01  2.59344771e+01  2.59344771e+01  9.50488526e+01
  9.50488526e+01  9.50488526e+01  1.85723578e+02  4.25553385e+02
  4.25553385e+02  4.25553385e+02  1.27863020e+03  1.27863020e+03
  1.27863020e+03  1.91674328e+03  2.98038154e+03  2.98038154e+03
  2.98038154e+03  6.60917368e+03  6.60917368e+03  6.60917368e+03
  8.27492108e+03  2.46626138e+04  7.54588466e+04]
E1 = -654.096012359102  E_coul = 140.09389316351923
cycle= 23 E= -514.002119195583  delta_E= -0.173  |g|= 1.96  |ddm|= 2.34
    CPU time for cycle= 23      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.44758
diis-c [-2.22869020e-03  8.88008092e+00  1.33912220e+01  1.25735410e+02
 -4.46117429e+01  1.13542612e+02 -2.46938886e+02  3.09833937e+01
  1.79097828e-02]
  HOMO = -2.85401361149872  LUMO = -1.50871179862206
  mo_energy =
[-1.22460328e+02 -1.62748876e+01 -1.36074764e+01 -1.36074764e+01
 -1.36074764e+01 -4.40551052e+00 -2.85401361e+00 -2.85401361e+00
 -2.85401361e+00 -1.50871180e+00 -6.05549314e-04 -6.05549314e-04
 -6.05549313e-04  3.69923454e+00  3.69923454e+00  3.69923454e+00
  2.09808505e+01  2.09808505e+01  2.09808505e+01  8.95924806e+01
  8.95924806e+01  8.95924806e+01  1.80024840e+02  4.19828291e+02
  4.19828291e+02  4.19828291e+02  1.27285401e+03  1.27285401e+03
  1.27285401e+03  1.91096496e+03  2.97459563e+03  2.97459563e+03
  2.97459563e+03  6.60339536e+03  6.60339536e+03  6.60339536e+03
  8.26915111e+03  2.46568524e+04  7.54530924e+04]
E1 = -751.6118507562786  E_coul = 231.7055038850006
cycle= 24 E= -519.906346871278  delta_E= -5.9  |g|= 2.64  |ddm|= 14.1
    CPU time for cycle= 24      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.29595
diis-c [-2.25443757e-03  1.73587502e+01  1.12464370e+01  1.14686586e+02
 -3.97845054e+01  1.17345028e+02 -2.51937505e+02  3.20798688e+01
  5.34041544e-03]
  HOMO = -2.90200302628154  LUMO = -1.54755094103241
  mo_energy =
[-1.22539656e+02 -1.63464719e+01 -1.36792631e+01 -1.36792631e+01
 -1.36792631e+01 -4.45703628e+00 -2.90200303e+00 -2.90200303e+00
 -2.90200303e+00 -1.54755094e+00 -6.05549314e-04 -6.05549314e-04
 -6.05549313e-04  3.63918899e+00  3.63918899e+00  3.63918899e+00
  2.09127480e+01  2.09127480e+01  2.09127480e+01  8.95172320e+01
  8.95172320e+01  8.95172320e+01  1.79946170e+02  4.19749241e+02
  4.19749241e+02  4.19749241e+02  1.27277423e+03  1.27277423e+03
  1.27277423e+03  1.91088512e+03  2.97451570e+03  2.97451570e+03
  2.97451570e+03  6.60331552e+03  6.60331552e+03  6.60331552e+03
  8.26907137e+03  2.46567728e+04  7.54530128e+04]
E1 = -751.7052654661085  E_coul = 231.81415847432945
cycle= 25 E= -519.891106991779  delta_E= 0.0152  |g|= 2.67  |ddm|= 0.136
    CPU time for cycle= 25      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.32542
diis-c [-2.25585090e-03 -4.59115064e-01  1.53878615e+01  1.40483079e+02
 -4.92250454e+01  1.16771327e+02 -2.52814209e+02  3.03847909e+01
  4.71311633e-01]
  HOMO = -2.87573310995809  LUMO = -1.52617446442082
  mo_energy =
[-1.22496290e+02 -1.63073067e+01 -1.36399607e+01 -1.36399607e+01
 -1.36399607e+01 -4.42905233e+00 -2.87573311e+00 -2.87573311e+00
 -2.87573311e+00 -1.52617446e+00 -6.05549314e-04 -6.05549314e-04
 -6.05549314e-04  3.67211358e+00  3.67211358e+00  3.67211358e+00
  2.09500460e+01  2.09500460e+01  2.09500460e+01  8.95583991e+01
  8.95583991e+01  8.95583991e+01  1.79989176e+02  4.19792456e+02
  4.19792456e+02  4.19792456e+02  1.27281784e+03  1.27281784e+03
  1.27281785e+03  1.91092878e+03  2.97455940e+03  2.97455940e+03
  2.97455940e+03  6.60335918e+03  6.60335918e+03  6.60335918e+03
  8.26911498e+03  2.46568164e+04  7.54530563e+04]
E1 = -751.6539655109138  E_coul = 231.75447633378064
cycle= 26 E= -519.899489177133  delta_E= -0.00838  |g|= 2.65  |ddm|= 0.0742
    CPU time for cycle= 26      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.30926
diis-c [-2.51007514e-03  6.80467888e+01 -1.47256283e+02  2.78703974e+02
 -1.34859905e+02  2.18182635e+02 -4.03633197e+02  4.26338269e+01
  7.91821609e+01]
  HOMO = -3.02738796409818  LUMO = -1.64829780153642
  mo_energy =
[-1.22747147e+02 -1.65334058e+01 -1.38671642e+01 -1.38671642e+01
 -1.38671642e+01 -4.59139147e+00 -3.02738796e+00 -3.02738796e+00
 -3.02738796e+00 -1.64829780e+00 -6.05549314e-04 -6.05549314e-04
 -6.05549314e-04  3.48201909e+00  3.48201909e+00  3.48201909e+00
  2.07345488e+01  2.07345488e+01  2.07345488e+01  8.93203293e+01
  8.93203293e+01  8.93203293e+01  1.79740489e+02  4.19542481e+02
  4.19542481e+02  4.19542481e+02  1.27256547e+03  1.27256547e+03
  1.27256547e+03  1.91067587e+03  2.97430638e+03  2.97430638e+03
  2.97430638e+03  6.60310616e+03  6.60310616e+03  6.60310616e+03
  8.26886211e+03  2.46565637e+04  7.54528038e+04]
E1 = -751.946567701146  E_coul = 232.09526126902256
cycle= 27 E= -519.851306432123  delta_E= 0.0482  |g|= 2.76  |ddm|= 0.418
    CPU time for cycle= 27      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.40396
diis-c [-5.56876472e-03  7.02277654e+02 -8.95109033e+02 -8.55399460e+01
  1.59341008e+02  2.59785709e+02 -4.15814696e+02 -2.52454616e+00
  2.78583850e+02]
  HOMO = -2.08377148819928  LUMO = -0.880506180116046
  mo_energy =
[-1.21160626e+02 -1.51089084e+01 -1.24332570e+01 -1.24332570e+01
 -1.24332570e+01 -3.61143891e+00 -2.08377149e+00 -2.08377149e+00
 -2.08377149e+00 -8.80506180e-01 -6.05549314e-04 -6.05549314e-04
 -6.05549314e-04  4.67413079e+00  4.67413079e+00  4.67413079e+00
  2.20919290e+01  2.20919290e+01  2.20919290e+01  9.08238366e+01
  9.08238366e+01  9.08238366e+01  1.81311871e+02  4.21123190e+02
  4.21123190e+02  4.21123190e+02  1.27416254e+03  1.27416254e+03
  1.27416254e+03  1.91227853e+03  2.97590876e+03  2.97590876e+03
  2.97590876e+03  6.60471017e+03  6.60471017e+03  6.60471017e+03
  8.27046627e+03  2.46581675e+04  7.54544071e+04]
E1 = -750.0793873364154  E_coul = 229.95707463441994
cycle= 28 E= -520.122312701995  delta_E= -0.271  |g|=  2.1  |ddm|= 2.37
    CPU time for cycle= 28      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.79402
diis-c [-1.13750632e-02 -1.08017976e+01 -2.88710146e+02  5.17444692e+01
  6.16638798e+00  3.69520423e+01 -4.52931786e+01  8.57693036e+00
  2.42365292e+02]
  HOMO = -0.000605549313523092  LUMO = 0.0186472297757968
  mo_energy =
[-1.17655443e+02 -1.19481993e+01 -9.26035766e+00 -9.26035766e+00
 -9.26035766e+00 -1.45703550e+00 -6.05549314e-04 -6.05549314e-04
 -6.05549314e-04  1.86472298e-02  1.86472298e-02  1.86472298e-02
  9.44199563e-01  7.34399307e+00  7.34399307e+00  7.34399307e+00
  2.51088879e+01  2.51088879e+01  2.51088879e+01  9.41507075e+01
  9.41507075e+01  9.41507075e+01  1.84787520e+02  4.24616143e+02
  4.24616143e+02  4.24616143e+02  1.27768807e+03  1.27768807e+03
  1.27768807e+03  1.91580815e+03  2.97944171e+03  2.97944171e+03
  2.97944171e+03  6.60824056e+03  6.60824056e+03  6.60824056e+03
  8.27399290e+03  2.46616900e+04  7.54579259e+04]
E1 = -655.4894174768363  E_coul = 141.27842955945349
cycle= 29 E= -514.210987917383  delta_E= 5.91  |g|= 1.56  |ddm|= 13.9
    CPU time for cycle= 29      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.91903
diis-c [-3.78620278e-03  1.91148138e+02 -3.23831747e+02  9.68973626e+00
  8.72974163e+00 -3.48567469e+00 -3.39230955e+00  6.93194347e+00
  1.15210172e+02]
  HOMO = -0.000605549313521887  LUMO = 0.671823871443641
  mo_energy =
[-1.16589251e+02 -1.09785477e+01 -8.29261065e+00 -8.29261065e+00
 -8.29261065e+00 -7.99081623e-01 -6.05549314e-04 -6.05549314e-04
 -6.05549314e-04  6.71823871e-01  6.71823872e-01  6.71823872e-01
  1.57131706e+00  8.17386061e+00  8.17386061e+00  8.17386061e+00
  2.60357525e+01  2.60357525e+01  2.60357525e+01  9.51660701e+01
  9.51660701e+01  9.51660701e+01  1.85847510e+02  4.25679064e+02
  4.25679064e+02  4.25679064e+02  1.27875849e+03  1.27875849e+03
  1.27875849e+03  1.91687463e+03  2.98051164e+03  2.98051164e+03
  2.98051164e+03  6.60930585e+03  6.60930585e+03  6.60930585e+03
  8.27505453e+03  2.46627483e+04  7.54589817e+04]
E1 = -654.0448703330283  E_coul = 140.0451453655831
cycle= 30 E= -513.999724967445  delta_E= 0.211  |g|= 1.99  |ddm|= 2.65
    CPU time for cycle= 30      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.55994
diis-c [-2.90954051e-03  4.15520277e+02 -4.78296442e+02 -3.67227825e+01
  6.15133177e+00  6.51250197e-01 -9.85242925e+00  9.65060009e+00
  9.38981944e+01]
  HOMO = -0.820606441573055  LUMO = -0.000605549314111734
  mo_energy =
[-1.19078043e+02 -1.32249116e+01 -1.05466834e+01 -1.05466834e+01
 -1.05466834e+01 -2.27607075e+00 -8.20606442e-01 -8.20606442e-01
 -8.20606442e-01 -6.05549314e-04 -6.05549314e-04 -6.05549314e-04
  2.00595670e-01  6.26689213e+00  6.26689213e+00  6.26689213e+00
  2.38880774e+01  2.38880774e+01  2.38880774e+01  9.28020780e+01
  9.28020780e+01  9.28020780e+01  1.83378688e+02  4.23198751e+02
  4.23198751e+02  4.23198751e+02  1.27625586e+03  1.27625586e+03
  1.27625586e+03  1.91437061e+03  2.97800456e+03  2.97800456e+03
  2.97800456e+03  6.60680169e+03  6.60680169e+03  6.60680169e+03
  8.27255375e+03  2.46602510e+04  7.54564874e+04]
E1 = -747.2100179961927  E_coul = 226.7904434302883
cycle= 31 E= -520.419574565904  delta_E= -6.42  |g|= 1.22  |ddm|= 15.3
    CPU time for cycle= 31      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.02459
diis-c [-1.83608763e-04  1.47571112e+02 -1.43770218e+02 -5.47037384e+00
 -4.63261444e-01 -1.22390048e+00  9.98705300e-01  3.85154073e+00
 -4.93604048e-01]
  HOMO = 0.180195045928996  LUMO = 1.69648960983019
  mo_energy =
[-1.14903425e+02 -9.44779181e+00 -6.76118175e+00 -6.76118175e+00
 -6.76118175e+00 -6.05549314e-04 -6.05549314e-04 -6.05549314e-04
  1.80195046e-01  1.69648961e+00  1.69648961e+00  1.69648961e+00
  2.58222252e+00  9.48052039e+00  9.48052039e+00  9.48052039e+00
  2.74998227e+01  2.74998227e+01  2.74998227e+01  9.67703183e+01
  9.67703183e+01  9.67703183e+01  1.87521548e+02  4.27359461e+02
  4.27359461e+02  4.27359462e+02  1.28045230e+03  1.28045230e+03
  1.28045230e+03  1.91856569e+03  2.98220654e+03  2.98220654e+03
  2.98220654e+03  6.61099599e+03  6.61099599e+03  6.61099599e+03
  8.27674056e+03  2.46644304e+04  7.54606608e+04]
E1 = -651.7737012987151  E_coul = 138.17807255260783
cycle= 32 E= -513.595628746107  delta_E= 6.82  |g|= 2.61  |ddm|= 17.6
    CPU time for cycle= 32      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.65692
diis-c [-5.41840488e-05  1.50674403e+02 -1.43143575e+02 -8.49891662e+00
 -2.10588859e+00  9.06727853e-02 -7.61944461e-01  4.23306136e+00
  5.12187954e-01]
  HOMO = -0.000605549313529152  LUMO = 1.44739877538142
  mo_energy =
[-1.15323553e+02 -9.82538598e+00 -7.14059627e+00 -7.14059627e+00
 -7.14059627e+00 -4.73797646e-02 -6.05549314e-04 -6.05549314e-04
 -6.05549314e-04  1.44739878e+00  1.44739878e+00  1.44739878e+00
  2.33216486e+00  9.15848443e+00  9.15848443e+00  9.15848443e+00
  2.71375907e+01  2.71375907e+01  2.71375907e+01  9.63714682e+01
  9.63714682e+01  9.63714682e+01  1.87104860e+02  4.26940772e+02
  4.26940772e+02  4.26940772e+02  1.28002973e+03  1.28002973e+03
  1.28002973e+03  1.91814263e+03  2.98178308e+03  2.98178308e+03
  2.98178308e+03  6.61057284e+03  6.61057284e+03  6.61057284e+03
  8.27631786e+03  2.46640082e+04  7.54602390e+04]
E1 = -652.299661176851  E_coul = 138.60529931662475
cycle= 33 E= -513.694361860226  delta_E= -0.0987  |g|= 2.46  |ddm|= 1.44
    CPU time for cycle= 33      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.36866
diis-c [-7.08292163e-05 -6.26042854e+00 -2.25252896e+01  2.04758926e+01
 -8.78510618e-01 -2.06154432e+00  3.61779157e+00  4.24060932e+00
  4.39147953e+00]
  HOMO = 0.47689362366282  LUMO = 2.02299462725707
  mo_energy =
[-1.14359777e+02 -8.95618531e+00 -6.26814107e+00 -6.26814107e+00
 -6.26814107e+00 -6.05549314e-04 -6.05549314e-04 -6.05549314e-04
  4.76893624e-01  2.02299463e+00  2.02299463e+00  2.02299463e+00
  2.91472943e+00  9.90057639e+00  9.90057639e+00  9.90057639e+00
  2.79710309e+01  2.79710309e+01  2.79710309e+01  9.72872903e+01
  9.72872903e+01  9.72872903e+01  1.88061070e+02  4.27901308e+02
  4.27901308e+02  4.27901308e+02  1.28099879e+03  1.28099879e+03
  1.28099879e+03  1.91911202e+03  2.98275375e+03  2.98275375e+03
  2.98275375e+03  6.61154222e+03  6.61154222e+03  6.61154222e+03
  8.27728583e+03  2.46649748e+04  7.54612043e+04]
E1 = -651.0799397212379  E_coul = 137.6215911331515
cycle= 34 E= -513.458348588086  delta_E= 0.236  |g|= 2.79  |ddm|= 3.49
    CPU time for cycle= 34      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.02783
diis-c [-1.02432233e-03 -2.06852568e+01 -1.42919184e+01  2.61985523e+00
 -6.61901314e+00  1.54320283e+00 -3.54026923e+00  5.40685781e+00
  3.65665417e+01]
  HOMO = 0.791126263882486  LUMO = 2.36805072686761
  mo_energy =
[-1.13791986e+02 -8.44087422e+00 -5.75213801e+00 -5.75213801e+00
 -5.75213801e+00 -6.05549314e-04 -6.05549314e-04 -6.05549314e-04
  7.91126264e-01  2.36805073e+00  2.36805073e+00  2.36805073e+00
  3.27599455e+00  1.03442117e+01  1.03442117e+01  1.03442117e+01
  2.84655465e+01  2.84655465e+01  2.84655465e+01  9.78280576e+01
  9.78280576e+01  9.78280576e+01  1.88625044e+02  4.28467319e+02
  4.28467319e+02  4.28467319e+02  1.28156924e+03  1.28156924e+03
  1.28156924e+03  1.91968153e+03  2.98332454e+03  2.98332454e+03
  2.98332454e+03  6.61211142e+03  6.61211142e+03  6.61211142e+03
  8.27785365e+03  2.46655413e+04  7.54617698e+04]
E1 = -650.3183406786636  E_coul = 137.0215524923569
cycle= 35 E= -513.296788186307  delta_E= 0.162  |g|= 2.98  |ddm|=  2.5
    CPU time for cycle= 35      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.4115
diis-c [-1.67242605e-03 -1.74611485e+01 -8.80709943e+01  2.51399493e+01
 -4.78593852e-01  1.03767305e+01 -2.19091803e+01  8.90953164e-01
  9.25122840e+01]
  HOMO = -1.36802833128638  LUMO = -0.27759139887947
  mo_energy =
[-1.20009013e+02 -1.40601314e+01 -1.13872324e+01 -1.13872324e+01
 -1.13872324e+01 -2.81308481e+00 -1.36802833e+00 -1.36802833e+00
 -1.36802833e+00 -2.77591399e-01 -6.05549314e-04 -6.05549314e-04
 -6.05549314e-04  5.56675783e+00  5.56675783e+00  5.56675783e+00
  2.30912560e+01  2.30912560e+01  2.30912560e+01  9.19198128e+01
  9.19198128e+01  9.19198128e+01  1.82456491e+02  4.22271183e+02
  4.22271183e+02  4.22271183e+02  1.27531878e+03  1.27531878e+03
  1.27531878e+03  1.91343048e+03  2.97706449e+03  2.97706449e+03
  2.97706449e+03  6.60586083e+03  6.60586083e+03  6.60586083e+03
  8.27161291e+03  2.46593105e+04  7.54555473e+04]
E1 = -748.4751952478738  E_coul = 228.1612286298101
cycle= 36 E= -520.313966618064  delta_E= -7.02  |g|= 1.61  |ddm|= 20.2
    CPU time for cycle= 36      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.38811
diis-c [-1.18138870e-03 -1.01961613e+01 -5.07396830e+01  1.54724440e+01
 -1.89702806e+00  3.64073603e+00 -8.66109512e+00  2.65183935e+00
  5.07289481e+01]
  HOMO = -0.0668186593793537  LUMO = -0.000605549313515827
  mo_energy =
[-1.17841217e+02 -1.21028617e+01 -9.42330325e+00 -9.42330325e+00
 -9.42330325e+00 -1.50253966e+00 -6.68186597e-02 -6.68186595e-02
 -6.68186594e-02 -6.05549314e-04 -6.05549314e-04 -6.05549313e-04
  8.81484923e-01  7.22269304e+00  7.22269304e+00  7.22269304e+00
  2.49600041e+01  2.49600041e+01  2.49600041e+01  9.39785122e+01
  9.39785122e+01  9.39785122e+01  1.84606581e+02  4.24431538e+02
  4.24431538e+02  4.24431538e+02  1.27749880e+03  1.27749880e+03
  1.27749880e+03  1.91561226e+03  2.97924867e+03  2.97924867e+03
  2.97924867e+03  6.60804288e+03  6.60804288e+03  6.60804288e+03
  8.27379229e+03  2.46614870e+04  7.54577214e+04]
E1 = -745.2880366808793  E_coul = 224.7563562818147
cycle= 37 E= -520.531680399064  delta_E= -0.218  |g|= 0.674  |ddm|= 3.17
    CPU time for cycle= 37      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.570991
diis-c [-3.65956689e-04 -8.14782281e+00 -6.92404477e+00  1.18594125e+00
  5.98092768e-01  2.98145645e+00  7.40108955e-02 -2.45806724e+00
  1.36904335e+01]
  HOMO = -0.000605549313472865  LUMO = 1.30559603656049
  mo_energy =
[-1.15560329e+02 -1.00392445e+01 -7.35465552e+00 -7.35465552e+00
 -7.35465552e+00 -1.75681742e-01 -6.05549314e-04 -6.05549314e-04
 -6.05549313e-04  1.30559604e+00  1.30559604e+00  1.30559604e+00
  2.18844438e+00  8.97827171e+00  8.97827171e+00  8.97827171e+00
  2.69334415e+01  2.69334415e+01  2.69334415e+01  9.61466679e+01
  9.61466679e+01  9.61466679e+01  1.86869796e+02  4.26704790e+02
  4.26704790e+02  4.26704790e+02  1.27979177e+03  1.27979177e+03
  1.27979177e+03  1.91790506e+03  2.98154495e+03  2.98154495e+03
  2.98154495e+03  6.61033540e+03  6.61033540e+03  6.61033540e+03
  8.27608101e+03  2.46637720e+04  7.54600032e+04]
E1 = -652.6117407735479  E_coul = 138.86018864566674
cycle= 38 E= -513.751552127881  delta_E= 6.78  |g|= 2.38  |ddm|= 16.6
    CPU time for cycle= 38      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.20852
diis-c [-6.36438912e-05  2.15289657e+00 -1.45082507e+01  1.89480228e+00
 -2.20310661e-01  2.45071879e+00 -1.24644476e+01 -1.02419842e+00
  2.27187897e+01]
  HOMO = 0.119152733516749  LUMO = 1.62470290848982
  mo_energy =
[-1.15023769e+02 -9.55597782e+00 -6.86945894e+00 -6.86945894e+00
 -6.86945894e+00 -6.05549314e-04 -6.05549314e-04 -6.05549314e-04
  1.19152734e-01  1.62470291e+00  1.62470291e+00  1.62470291e+00
  2.50537162e+00  9.38979213e+00  9.38979213e+00  9.38979213e+00
  2.73965745e+01  2.73965745e+01  2.73965745e+01  9.66563101e+01
  9.66563101e+01  9.66563101e+01  1.87402039e+02  4.27239524e+02
  4.27239524e+02  4.27239524e+02  1.28033134e+03  1.28033134e+03
  1.28033134e+03  1.91844499e+03  2.98208551e+03  2.98208551e+03
  2.98208551e+03  6.61087538e+03  6.61087538e+03  6.61087538e+03
  8.27662029e+03  2.46643105e+04  7.54605411e+04]
E1 = -651.9318457472968  E_coul = 138.30577461237922
cycle= 39 E= -513.626071134918  delta_E= 0.125  |g|= 2.56  |ddm|= 1.81
    CPU time for cycle= 39      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.57477
diis-c [-9.14507713e-05  5.49580739e+00 -2.05770459e+01  4.16646494e+00
 -7.48400986e-01  1.92358261e+00 -1.62946030e+01  4.17080202e+00
  2.28633930e+01]
  HOMO = 0.0119752612674383  LUMO = 1.51027743469239
  mo_energy =
[-1.15212946e+02 -9.72752734e+00 -7.04121966e+00 -7.04121966e+00
 -7.04121966e+00 -6.05549314e-04 -6.05549314e-04 -6.05549314e-04
  1.19752613e-02  1.51027743e+00  1.51027743e+00  1.51027743e+00
  2.39076661e+00  9.24326489e+00  9.24326489e+00  9.24326489e+00
  2.72323749e+01  2.72323749e+01  2.72323749e+01  9.64763298e+01
  9.64763298e+01  9.64763298e+01  1.87214239e+02  4.27050966e+02
  4.27050966e+02  4.27050966e+02  1.28014124e+03  1.28014124e+03
  1.28014124e+03  1.91825512e+03  2.98189525e+03  2.98189525e+03
  2.98189525e+03  6.61068559e+03  6.61068559e+03  6.61068559e+03
  8.27643092e+03  2.46641215e+04  7.54603525e+04]
E1 = -652.1853899332724  E_coul = 138.5108772254577
cycle= 40 E= -513.674512707815  delta_E= -0.0484  |g|=  2.5  |ddm|= 0.712
    CPU time for cycle= 40      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.44838
diis-c [-1.96714340e-04  1.87251922e+01 -2.51840144e+01  8.25408990e+00
 -7.18495844e-01  1.84058849e+00 -2.94971948e+01  1.32831151e+01
  1.42967193e+01]
  HOMO = -0.000605549313484149  LUMO = 1.31159630402582
  mo_energy =
[-1.15546224e+02 -1.00277760e+01 -7.34250673e+00 -7.34250673e+00
 -7.34250673e+00 -1.73443170e-01 -6.05549314e-04 -6.05549314e-04
 -6.05549313e-04  1.31159630e+00  1.31159630e+00  1.31159630e+00
  2.19409941e+00  8.98767448e+00  8.98767449e+00  8.98767449e+00
  2.69448081e+01  2.69448081e+01  2.69448081e+01  9.61598479e+01
  9.61598479e+01  9.61598479e+01  1.86883616e+02  4.26718834e+02
  4.26718834e+02  4.26718834e+02  1.27980616e+03  1.27980616e+03
  1.27980616e+03  1.91792002e+03  2.98155966e+03  2.98155966e+03
  2.98155966e+03  6.61035052e+03  6.61035052e+03  6.61035052e+03
  8.27609639e+03  2.46637875e+04  7.54600189e+04]
E1 = -652.6155882296667  E_coul = 138.86221078602094
cycle= 41 E= -513.753377443646  delta_E= -0.0789  |g|= 2.38  |ddm|= 1.13
    CPU time for cycle= 41      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.22106
diis-c [-6.65621917e-04  2.78219171e+01 -1.79035835e+01  5.73687440e+00
 -6.32773775e-01  1.60985002e+00 -2.07464193e+01  4.87616481e+01
 -4.36475129e+01]
  HOMO = -0.000605549313522106  LUMO = 0.768500414207558
  mo_energy =
[-1.16454046e+02 -1.08470818e+01 -8.16434207e+00 -8.16434207e+00
 -8.16434207e+00 -6.88518110e-01 -6.05549314e-04 -6.05549314e-04
 -6.05549314e-04  7.68500414e-01  7.68500415e-01  7.68500415e-01
  1.66592865e+00  8.29042726e+00  8.29042726e+00  8.29042726e+00
  2.61605582e+01  2.61605582e+01  2.61605582e+01  9.52973263e+01
  9.52973263e+01  9.52973263e+01  1.85982913e+02  4.25814082e+02
  4.25814082e+02  4.25814082e+02  1.27889344e+03  1.27889344e+03
  1.27889344e+03  1.91700721e+03  2.98064553e+03  2.98064553e+03
  2.98064553e+03  6.60943777e+03  6.60943777e+03  6.60943777e+03
  8.27518508e+03  2.46628777e+04  7.54591102e+04]
E1 = -653.7748208683339  E_coul = 139.82336208648542
cycle= 42 E= -513.951458781848  delta_E= -0.198  |g|= 2.05  |ddm|= 2.74
    CPU time for cycle= 42      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.61792
diis-c [-1.01565833e-03  5.43399363e+01 -9.58234052e+00  3.07982154e+00
 -7.34122944e-01  1.85681664e+00 -1.00661693e+01 -2.91054158e+00
 -3.49834002e+01]
  HOMO = -0.00060554931352126  LUMO = 1.31986368602371
  mo_energy =
[-1.15529207e+02 -1.00131145e+01 -7.32689228e+00 -7.32689228e+00
 -7.32689228e+00 -1.70128688e-01 -6.05549314e-04 -6.05549314e-04
 -6.05549314e-04  1.31986369e+00  1.31986369e+00  1.31986369e+00
  2.19979136e+00  8.99982773e+00  8.99982773e+00  8.99982773e+00
  2.69591745e+01  2.69591745e+01  2.69591745e+01  9.61758572e+01
  9.61758572e+01  9.61758572e+01  1.86900140e+02  4.26735750e+02
  4.26735750e+02  4.26735750e+02  1.27982353e+03  1.27982353e+03
  1.27982353e+03  1.91793818e+03  2.98157746e+03  2.98157746e+03
  2.98157746e+03  6.61036889e+03  6.61036889e+03  6.61036889e+03
  8.27611513e+03  2.46638066e+04  7.54600381e+04]
E1 = -652.6341115238558  E_coul = 138.87535877586689
cycle= 43 E= -513.758752747989  delta_E= 0.193  |g|= 2.38  |ddm|= 2.64
    CPU time for cycle= 43      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.23685
diis-c [-8.81290342e-05  1.58473653e+01 -2.60057214e+00 -7.48209504e+00
 -7.17077495e-01  1.84211086e+00 -4.95130265e+00 -5.50670284e+00
  4.56827404e+00]
  HOMO = -0.000605549313512892  LUMO = 1.32316115980506
  mo_energy =
[-1.15526114e+02 -1.00098196e+01 -7.32446410e+00 -7.32446410e+00
 -7.32446410e+00 -1.63480234e-01 -6.05549314e-04 -6.05549314e-04
 -6.05549314e-04  1.32316116e+00  1.32316116e+00  1.32316116e+00
  2.20587041e+00  9.00273508e+00  9.00273508e+00  9.00273508e+00
  2.69619350e+01  2.69619350e+01  2.69619350e+01  9.61788687e+01
  9.61788687e+01  9.61788687e+01  1.86903553e+02  4.26738862e+02
  4.26738862e+02  4.26738862e+02  1.27982636e+03  1.27982636e+03
  1.27982636e+03  1.91794017e+03  2.98157986e+03  2.98157986e+03
  2.98157986e+03  6.61037065e+03  6.61037065e+03  6.61037065e+03
  8.27611647e+03  2.46638076e+04  7.54600389e+04]
E1 = -652.5930594041206  E_coul = 138.84356631036374
cycle= 44 E= -513.749493093757  delta_E= 0.00926  |g|= 2.39  |ddm|= 0.148
    CPU time for cycle= 44      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.23507
diis-c [-2.70718010e-03  2.21523247e+01  3.06495697e+01 -3.17048245e+00
 -1.53067548e+02  4.33180158e-02  1.97194739e+01 -1.82322210e+01
  1.02905565e+02]
  HOMO = -2.75507112603713  LUMO = -1.42926192315187
  mo_energy =
[-1.22292889e+02 -1.61258075e+01 -1.34571273e+01 -1.34571273e+01
 -1.34571273e+01 -4.30078476e+00 -2.75507113e+00 -2.75507113e+00
 -2.75507113e+00 -1.42926192e+00 -6.05549314e-04 -6.05549314e-04
 -6.05549314e-04  3.82354605e+00  3.82354605e+00  3.82354606e+00
  2.11229005e+01  2.11229005e+01  2.11229005e+01  8.97506252e+01
  8.97506252e+01  8.97506252e+01  1.80190613e+02  4.19995087e+02
  4.19995087e+02  4.19995087e+02  1.27302267e+03  1.27302267e+03
  1.27302267e+03  1.91113430e+03  2.97476491e+03  2.97476491e+03
  2.97476491e+03  6.60356486e+03  6.60356486e+03  6.60356486e+03
  8.26932065e+03  2.46570220e+04  7.54532618e+04]
E1 = -751.4168759483621  E_coul = 231.48011254670058
cycle= 45 E= -519.936763401661  delta_E= -6.19  |g|= 2.57  |ddm|= 15.3
    CPU time for cycle= 45      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.22932
diis-c [-2.83370104e-03  2.37686139e+01  3.17008630e+01 -2.53701655e+00
 -1.58245503e+02  7.12133408e-03  2.00702459e+01 -1.67519304e+01
  1.02987606e+02]
  HOMO = -2.89310419945152  LUMO = -1.540957043633
  mo_energy =
[-1.22521100e+02 -1.63317812e+01 -1.36636201e+01 -1.36636201e+01
 -1.36636201e+01 -4.44923177e+00 -2.89310421e+00 -2.89310420e+00
 -2.89310420e+00 -1.54095704e+00 -6.05549314e-04 -6.05549314e-04
 -6.05549314e-04  3.65082131e+00  3.65082132e+00  3.65082132e+00
  2.09269917e+01  2.09269917e+01  2.09269917e+01  8.95341572e+01
  8.95341572e+01  8.95341572e+01  1.79964288e+02  4.19767676e+02
  4.19767676e+02  4.19767676e+02  1.27279316e+03  1.27279316e+03
  1.27279316e+03  1.91090466e+03  2.97453499e+03  2.97453499e+03
  2.97453499e+03  6.60333521e+03  6.60333521e+03  6.60333521e+03
  8.26909132e+03  2.46567930e+04  7.54530331e+04]
E1 = -751.6862070786264  E_coul = 231.79278523234333
cycle= 46 E= -519.893421846283  delta_E= 0.0433  |g|= 2.66  |ddm|= 0.388
    CPU time for cycle= 46      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.31393
diis-c [-2.31465662e-03  9.50878836e+01  1.18933612e+01 -1.78166476e+01
 -1.40314677e+02  1.42090353e+01 -1.36086012e+01 -2.93835760e+01
  8.09332220e+01]
  HOMO = -0.640406651431022  LUMO = -0.000605549313539102
  mo_energy =
[-1.18790473e+02 -1.29605006e+01 -1.02819639e+01 -1.02819639e+01
 -1.02819639e+01 -2.09334154e+00 -6.40406658e-01 -6.40406653e-01
 -6.40406651e-01 -6.05549314e-04 -6.05549314e-04 -6.05549314e-04
  3.69821788e-01  6.49800814e+00  6.49800815e+00  6.49800815e+00
  2.41420939e+01  2.41420939e+01  2.41420939e+01  9.30774705e+01
  9.30774705e+01  9.30774705e+01  1.83664800e+02  4.23485545e+02
  4.23485545e+02  4.23485545e+02  1.27654454e+03  1.27654454e+03
  1.27654454e+03  1.91465851e+03  2.97829321e+03  2.97829321e+03
  2.97829321e+03  6.60708936e+03  6.60708936e+03  6.60708936e+03
  8.27284063e+03  2.46605372e+04  7.54567730e+04]
E1 = -746.7595024632634  E_coul = 226.30692251354614
cycle= 47 E= -520.452579949717  delta_E= -0.559  |g|= 1.09  |ddm|= 5.27
    CPU time for cycle= 47      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.925855
diis-c [-1.14830832e-04 -2.14340970e+01  2.78751302e+00 -5.55859033e+00
  1.74034773e+01 -2.00685377e+01  1.81779548e+01  2.89511799e+00
  6.79716190e+00]
  HOMO = -0.000605549313497769  LUMO = 0.868279850257568
  mo_energy =
[-1.16291608e+02 -1.06992336e+01 -8.01706268e+00 -8.01706268e+00
 -8.01706268e+00 -5.91442595e-01 -6.05549314e-04 -6.05549314e-04
 -6.05549313e-04  8.68279850e-01  8.68279850e-01  8.68279850e-01
  1.76362811e+00  8.41514591e+00  8.41514591e+00  8.41514591e+00
  2.63012169e+01  2.63012169e+01  2.63012169e+01  9.54517461e+01
  9.54517461e+01  9.54517461e+01  1.86144347e+02  4.25975983e+02
  4.25975983e+02  4.25975983e+02  1.27905646e+03  1.27905646e+03
  1.27905646e+03  1.91716938e+03  2.98080837e+03  2.98080837e+03
  2.98080837e+03  6.60959970e+03  6.60959970e+03  6.60959970e+03
  8.27534631e+03  2.46630383e+04  7.54592704e+04]
E1 = -653.5427900836418  E_coul = 139.6303382709791
cycle= 48 E= -513.912451812663  delta_E= 6.54  |g|= 2.12  |ddm|= 15.7
    CPU time for cycle= 48      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.72101
diis-c [-1.39963077e-04 -2.50062238e+01  1.39221727e+00 -7.47126103e+00
  3.27390790e+01 -1.99455501e+01  1.80173899e+01  3.01261152e+00
 -1.73826278e+00]
  HOMO = -0.000605549313509029  LUMO = 1.16725680067493
  mo_energy =
[-1.15792309e+02 -1.02486248e+01 -7.56499032e+00 -7.56499032e+00
 -7.56499031e+00 -3.08385031e-01 -6.05549314e-04 -6.05549314e-04
 -6.05549314e-04  1.16725680e+00  1.16725680e+00  1.16725680e+00
  2.05518569e+00  8.79910970e+00  8.79910970e+00  8.79910970e+00
  2.67327213e+01  2.67327213e+01  2.67327213e+01  9.59261689e+01
  9.59261689e+01  9.59261689e+01  1.86639740e+02  4.26473603e+02
  4.26473603e+02  4.26473603e+02  1.27955848e+03  1.27955848e+03
  1.27955848e+03  1.91767152e+03  2.98131119e+03  2.98131119e+03
  2.98131119e+03  6.61010182e+03  6.61010182e+03  6.61010182e+03
  8.27584767e+03  2.46635389e+04  7.54597703e+04]
E1 = -652.9056728473889  E_coul = 139.1020455204166
cycle= 49 E= -513.803627326972  delta_E= 0.109  |g|=  2.3  |ddm|= 1.51
    CPU time for cycle= 49      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.05103
diis-c [-1.38315546e-04 -1.12864544e+01 -3.19801739e+00 -8.84269495e+00
  1.60062259e+01 -1.81155967e+01  1.63177266e+01  2.86341696e+00
  7.25539397e+00]
  HOMO = -0.000605549313527113  LUMO = 1.09709481513295
  mo_energy =
[-1.15909296e+02 -1.03541447e+01 -7.67071424e+00 -7.67071423e+00
 -7.67071423e+00 -3.75283670e-01 -6.05549314e-04 -6.05549314e-04
 -6.05549314e-04  1.09709482e+00  1.09709482e+00  1.09709482e+00
  1.98666746e+00  8.70953719e+00  8.70953719e+00  8.70953719e+00
  2.66318394e+01  2.66318394e+01  2.66318394e+01  9.58151132e+01
  9.58151132e+01  9.58151132e+01  1.86523660e+02  4.26357019e+02
  4.26357019e+02  4.26357019e+02  1.27944089e+03  1.27944089e+03
  1.27944089e+03  1.91755402e+03  2.98119347e+03  2.98119347e+03
  2.98119347e+03  6.60998435e+03  6.60998435e+03  6.60998435e+03
  8.27573045e+03  2.46634219e+04  7.54596535e+04]
E1 = -653.0608931178597  E_coul = 139.23001174091567
cycle= 50 E= -513.830881376944  delta_E= -0.0273  |g|= 2.26  |ddm|= 0.383
    CPU time for cycle= 50      0.03 sec, wall time      0.03 sec
E1 = -653.0608931178597  E_coul = 139.23001174091567

WARN: 	An extra scf cycle is going to be run
	in order to restore the mo_energy derivatives
	missing in implicit differentiation.

  HOMO = -3.13022555944281  LUMO = -1.67333708292454
  mo_energy =
[-1.23422426e+02 -1.68796365e+01 -1.42566744e+01 -1.42566744e+01
 -1.42566744e+01 -4.53360769e+00 -3.13022556e+00 -3.13022556e+00
 -3.13022556e+00 -1.67333708e+00 -6.05549314e-04 -6.05549314e-04
 -6.05549314e-04  3.30763152e+00  3.30763152e+00  3.30763152e+00
  2.04165466e+01  2.04165466e+01  2.04165466e+01  8.87972619e+01
  8.87972619e+01  8.87972619e+01  1.79104027e+02  4.18877375e+02
  4.18877375e+02  4.18877375e+02  1.27185485e+03  1.27185485e+03
  1.27185485e+03  1.90991569e+03  2.97356563e+03  2.97356563e+03
  2.97356563e+03  6.60233321e+03  6.60233321e+03  6.60233321e+03
  8.26806963e+03  2.46557565e+04  7.54519866e+04]
E1 = -752.4369246341512  E_coul = 232.59839710753494
Extra cycle  E= -519.838527526616  delta_E= -6.01  |g|= 3.14  |ddm|= 14.1
    CPU time for scf_cycle      1.96 sec, wall time      1.55 sec
exp = [2.61825079e+04 7.61825076e+03 3.61825074e+03 1.61825012e+03
 2.39783014e+02 5.19057709e+01 4.62349345e+00 5.26662913e-01
 3.71601494e-01 1.36279300e+03 6.65180705e+02 3.03320531e+02
 3.16146359e+02 4.93015577e+01 4.77080216e+00 1.47373212e+01
 1.00000003e-09 1.35121589e+00 2.50530427e+00]
E = -519.8385275266162
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:38:57 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5078505        1
[INPUT] 0    0    [1    /1   ]  7618.25077908        1
[INPUT] 0    0    [1    /1   ]  3618.2507732         1
[INPUT] 0    0    [1    /1   ]  1618.25060367        1
[INPUT] 0    0    [1    /1   ]  239.783721551        1
[INPUT] 0    0    [1    /1   ]  51.9000600583        1
[INPUT] 0    0    [1    /1   ]  4.45165415816        1
[INPUT] 0    0    [1    /1   ]  0.462731028427       1
[INPUT] 0    0    [1    /1   ]  0.169725901302       1
[INPUT] 1    0    [1    /1   ]  1362.79300286        1
[INPUT] 1    0    [1    /1   ]  665.180720191        1
[INPUT] 1    0    [1    /1   ]  303.320611715        1
[INPUT] 1    0    [1    /1   ]  316.146429508        1
[INPUT] 1    0    [1    /1   ]  49.3005301281        1
[INPUT] 1    0    [1    /1   ]  4.75842813251        1
[INPUT] 1    0    [1    /1   ]  14.7445698199        1
[INPUT] 1    0    [1    /1   ]  0.293135239324       1
[INPUT] 1    0    [1    /1   ]  1.26553360957        1
[INPUT] 1    0    [1    /1   ]  0.712402147329       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.507850469487, 1.0]], [0, [7618.250779079779, 1.0]], [0, [3618.2507732000945, 1.0]], [0, [1618.2506036658592, 1.0]], [0, [239.78372155056277, 1.0]], [0, [51.90006005828168, 1.0]], [0, [4.451654158156154, 1.0]], [0, [0.46273102842723174, 1.0]], [0, [0.16972590130234805, 1.0]], [1, [1362.7930028623523, 1.0]], [1, [665.1807201907737, 1.0]], [1, [303.3206117148083, 1.0]], [1, [316.14642950764687, 1.0]], [1, [49.30053012806083, 1.0]], [1, [4.758428132513312, 1.0]], [1, [14.744569819935235, 1.0]], [1, [0.2931352393240434, 1.0]], [1, [1.2655336095700453, 1.0]], [1, [0.7124021473286644, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50785047]
bas 1, expnt(s) = [7618.25077908]
bas 2, expnt(s) = [3618.2507732]
bas 3, expnt(s) = [1618.25060367]
bas 4, expnt(s) = [239.78372155]
bas 5, expnt(s) = [51.90006006]
bas 6, expnt(s) = [4.45165416]
bas 7, expnt(s) = [0.46273103]
bas 8, expnt(s) = [0.1697259]
bas 9, expnt(s) = [1362.79300286]
bas 10, expnt(s) = [665.18072019]
bas 11, expnt(s) = [303.32061171]
bas 12, expnt(s) = [316.14642951]
bas 13, expnt(s) = [49.30053013]
bas 14, expnt(s) = [4.75842813]
bas 15, expnt(s) = [14.74456982]
bas 16, expnt(s) = [0.29313524]
bas 17, expnt(s) = [1.26553361]
bas 18, expnt(s) = [0.71240215]
CPU time:        18.51
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024082e+03 7.61825078e+03 2.06018620e+03
 3.61825077e+03 1.17866129e+03 1.61825060e+03 6.44613442e+02
 2.39783722e+02 1.53950037e+02 5.19000601e+01 4.88529641e+01
 4.45165416e+00 7.74294345e+00 4.62731028e-01 1.41746221e+00
 1.69725901e-01 6.68076379e-01 1.36279300e+03 2.41558187e+04
 6.65180720e+02 9.85505288e+03 3.03320612e+02 3.69285110e+03
 3.16146430e+02 3.88906090e+03 4.93005301e+01 3.81108714e+02
 4.75842813e+00 2.05028288e+01 1.47445698e+01 8.42897034e+01
 2.93135239e-01 6.29244503e-01 1.26553361e+00 3.91585405e+00
 7.12402147e-01 1.90937362e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.96195442152067
cond(S) = 83864.08071533826
E1 = -726.8560957538493  E_coul = 202.66364092999436
init E= -524.192454823855
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.560283341234372  LUMO = 0.570927922853359
  mo_energy =
[-1.17935437e+02 -1.21335044e+01 -9.48115883e+00 -9.48115883e+00
 -9.48115883e+00 -1.24172373e+00 -5.60283341e-01 -5.60283341e-01
 -5.60283341e-01  5.70927923e-01  1.16081130e+00  1.16081130e+00
  1.16081130e+00  4.41823698e+00  4.41823698e+00  4.41823698e+00
  1.87658647e+01  1.87658647e+01  1.87658647e+01  8.82511190e+01
  8.82511190e+01  8.82511190e+01  1.82866444e+02  4.20350733e+02
  4.20350733e+02  4.20350733e+02  1.27404837e+03  1.27404837e+03
  1.27404837e+03  1.91456629e+03  2.97613874e+03  2.97613874e+03
  2.97613874e+03  6.60534479e+03  6.60534479e+03  6.60534479e+03
  8.27303261e+03  2.46608870e+04  7.54572835e+04]
E1 = -727.3589524843424  E_coul = 201.82332626294095
cycle= 1 E= -525.535626221401  delta_E= -1.34  |g|= 0.198  |ddm|= 0.778
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.477983
diis-c [-0.22846732  1.        ]
  HOMO = -0.553946328331434  LUMO = 0.584100587956856
  mo_energy =
[-1.18172295e+02 -1.21801601e+01 -9.53677158e+00 -9.53677158e+00
 -9.53677158e+00 -1.23171768e+00 -5.53946328e-01 -5.53946328e-01
 -5.53946328e-01  5.84100588e-01  1.17206553e+00  1.17206553e+00
  1.17206553e+00  4.41864118e+00  4.41864118e+00  4.41864118e+00
  1.87211686e+01  1.87211686e+01  1.87211686e+01  8.81249259e+01
  8.81249259e+01  8.81249259e+01  1.82696000e+02  4.20127516e+02
  4.20127516e+02  4.20127516e+02  1.27376442e+03  1.27376442e+03
  1.27376442e+03  1.91413842e+03  2.97578032e+03  2.97578032e+03
  2.97578032e+03  6.60485612e+03  6.60485612e+03  6.60485612e+03
  8.27245213e+03  2.46602059e+04  7.54565062e+04]
E1 = -727.5336287487537  E_coul = 201.99766890399195
cycle= 2 E= -525.535959844762  delta_E= -0.000334  |g|= 0.0169  |ddm|= 0.0429
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0278989
diis-c [-5.87623288e-04  2.81167905e-02  9.71883209e-01]
  HOMO = -0.552248415186701  LUMO = 0.585624035730162
  mo_energy =
[-1.18143187e+02 -1.21684233e+01 -9.52474481e+00 -9.52474481e+00
 -9.52474481e+00 -1.22901159e+00 -5.52248415e-01 -5.52248415e-01
 -5.52248415e-01  5.85624036e-01  1.17333670e+00  1.17333670e+00
  1.17333670e+00  4.42199423e+00  4.42199423e+00  4.42199423e+00
  1.87309842e+01  1.87309842e+01  1.87309842e+01  8.81453038e+01
  8.81453038e+01  8.81453038e+01  1.82723948e+02  4.20156265e+02
  4.20156265e+02  4.20156265e+02  1.27379549e+03  1.27379549e+03
  1.27379549e+03  1.91417085e+03  2.97581242e+03  2.97581242e+03
  2.97581242e+03  6.60488874e+03  6.60488874e+03  6.60488874e+03
  8.27248491e+03  2.46602386e+04  7.54565388e+04]
E1 = -727.4913425089218  E_coul = 201.95537361390242
cycle= 3 E= -525.535968895019  delta_E= -9.05e-06  |g|= 0.00242  |ddm|= 0.0104
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00450487
diis-c [-1.23636956e-06 -1.11174969e-03  1.27199827e-01  8.73911923e-01]
  HOMO = -0.552807263093715  LUMO = 0.585422174843814
  mo_energy =
[-1.18147397e+02 -1.21707057e+01 -9.52717070e+00 -9.52717070e+00
 -9.52717070e+00 -1.22949807e+00 -5.52807263e-01 -5.52807263e-01
 -5.52807263e-01  5.85422175e-01  1.17300154e+00  1.17300154e+00
  1.17300154e+00  4.42112747e+00  4.42112747e+00  4.42112747e+00
  1.87289411e+01  1.87289411e+01  1.87289411e+01  8.81420186e+01
  8.81420186e+01  8.81420186e+01  1.82719960e+02  4.20152104e+02
  4.20152104e+02  4.20152104e+02  1.27379105e+03  1.27379105e+03
  1.27379105e+03  1.91416612e+03  2.97580780e+03  2.97580780e+03
  2.97580780e+03  6.60488393e+03  6.60488393e+03  6.60488393e+03
  8.27247999e+03  2.46602336e+04  7.54565337e+04]
E1 = -727.4983830770379  E_coul = 201.96241381545482
cycle= 4 E= -525.535969261583  delta_E= -3.67e-07  |g|= 0.000221  |ddm|= 0.00136
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000153874
diis-c [-1.00449166e-08  9.58875662e-05 -1.53331080e-02 -9.16392387e-02
  1.10687646e+00]
  HOMO = -0.552779762427467  LUMO = 0.585473234744705
  mo_energy =
[-1.18147246e+02 -1.21705773e+01 -9.52705333e+00 -9.52705333e+00
 -9.52705333e+00 -1.22940990e+00 -5.52779762e-01 -5.52779762e-01
 -5.52779762e-01  5.85473235e-01  1.17302422e+00  1.17302422e+00
  1.17302422e+00  4.42118658e+00  4.42118658e+00  4.42118658e+00
  1.87290457e+01  1.87290457e+01  1.87290457e+01  8.81421564e+01
  8.81421564e+01  8.81421564e+01  1.82720115e+02  4.20152254e+02
  4.20152254e+02  4.20152254e+02  1.27379120e+03  1.27379120e+03
  1.27379120e+03  1.91416625e+03  2.97580794e+03  2.97580794e+03
  2.97580794e+03  6.60488405e+03  6.60488405e+03  6.60488405e+03
  8.27248010e+03  2.46602337e+04  7.54565338e+04]
E1 = -727.4978748486312  E_coul = 201.96190557170115
cycle= 5 E= -525.53596927693  delta_E= -1.53e-08  |g|= 3.46e-05  |ddm|= 0.000578
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.04027e-05
diis-c [-1.50719214e-10  2.44457386e-05 -2.72825231e-03 -2.73519989e-02
  1.90930408e-02  1.01096276e+00]
  HOMO = -0.552793996879248  LUMO = 0.585470118894344
  mo_energy =
[-1.18147293e+02 -1.21706146e+01 -9.52709340e+00 -9.52709340e+00
 -9.52709340e+00 -1.22941829e+00 -5.52793997e-01 -5.52793997e-01
 -5.52793997e-01  5.85470119e-01  1.17301595e+00  1.17301595e+00
  1.17301595e+00  4.42116765e+00  4.42116765e+00  4.42116765e+00
  1.87290105e+01  1.87290105e+01  1.87290105e+01  8.81421129e+01
  8.81421129e+01  8.81421129e+01  1.82720070e+02  4.20152207e+02
  4.20152207e+02  4.20152207e+02  1.27379115e+03  1.27379115e+03
  1.27379115e+03  1.91416620e+03  2.97580789e+03  2.97580789e+03
  2.97580789e+03  6.60488400e+03  6.60488400e+03  6.60488400e+03
  8.27248005e+03  2.46602337e+04  7.54565338e+04]
E1 = -727.4979608294582  E_coul = 201.96199155227475
cycle= 6 E= -525.535969277183  delta_E= -2.53e-10  |g|= 9.4e-07  |ddm|= 6.58e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -727.4979608294582  E_coul = 201.96199155227475
  HOMO = -0.552794263924009  LUMO = 0.585469972571132
  mo_energy =
[-1.18147293e+02 -1.21706146e+01 -9.52709341e+00 -9.52709341e+00
 -9.52709341e+00 -1.22941848e+00 -5.52794264e-01 -5.52794264e-01
 -5.52794264e-01  5.85469973e-01  1.17301575e+00  1.17301575e+00
  1.17301575e+00  4.42116736e+00  4.42116736e+00  4.42116736e+00
  1.87290104e+01  1.87290104e+01  1.87290104e+01  8.81421131e+01
  8.81421131e+01  8.81421131e+01  1.82720070e+02  4.20152207e+02
  4.20152207e+02  4.20152207e+02  1.27379115e+03  1.27379115e+03
  1.27379115e+03  1.91416620e+03  2.97580789e+03  2.97580789e+03
  2.97580789e+03  6.60488400e+03  6.60488400e+03  6.60488400e+03
  8.27248005e+03  2.46602337e+04  7.54565338e+04]
E1 = -727.4979597804851  E_coul = 201.96199050330162
Extra cycle  E= -525.535969277183  delta_E=    0  |g|= 1.15e-07  |ddm|= 1.33e-06
    CPU time for scf_cycle      0.64 sec, wall time      0.26 sec
exp = [2.61825079e+04 7.61825078e+03 3.61825077e+03 1.61825060e+03
 2.39783722e+02 5.19000601e+01 4.45165416e+00 4.62731028e-01
 1.69725901e-01 1.36279300e+03 6.65180720e+02 3.03320612e+02
 3.16146430e+02 4.93005301e+01 4.75842813e+00 1.47445698e+01
 2.93135239e-01 1.26553361e+00 7.12402147e-01]
E = -525.5359692771834
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:38:57 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5078502        1
[INPUT] 0    0    [1    /1   ]  7618.25078188        1
[INPUT] 0    0    [1    /1   ]  3618.25077878        1
[INPUT] 0    0    [1    /1   ]  1618.25068949        1
[INPUT] 0    0    [1    /1   ]  239.783847364        1
[INPUT] 0    0    [1    /1   ]  51.8990443446        1
[INPUT] 0    0    [1    /1   ]  4.42109124533        1
[INPUT] 0    0    [1    /1   ]  0.451360260868       1
[INPUT] 0    0    [1    /1   ]  0.133820805704       1
[INPUT] 1    0    [1    /1   ]  1362.79300304        1
[INPUT] 1    0    [1    /1   ]  665.180722823        1
[INPUT] 1    0    [1    /1   ]  303.320625985        1
[INPUT] 1    0    [1    /1   ]  316.146442077        1
[INPUT] 1    0    [1    /1   ]  49.3003473676        1
[INPUT] 1    0    [1    /1   ]  4.75622731829        1
[INPUT] 1    0    [1    /1   ]  14.7458590419        1
[INPUT] 1    0    [1    /1   ]  0.345271550734       1
[INPUT] 1    0    [1    /1   ]  1.25029437098        1
[INPUT] 1    0    [1    /1   ]  0.393520991834       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.507850213737, 1.0]], [0, [7618.250781878694, 1.0]], [0, [3618.2507787820887, 1.0]], [0, [1618.250689494891, 1.0]], [0, [239.78384736412556, 1.0]], [0, [51.89904434455993, 1.0]], [0, [4.421091245328506, 1.0]], [0, [0.45136026086756376, 1.0]], [0, [0.13382080570365532, 1.0]], [1, [1362.793003040482, 1.0]], [1, [665.1807228228865, 1.0]], [1, [303.3206259852688, 1.0]], [1, [316.1464420773359, 1.0]], [1, [49.30034736761862, 1.0]], [1, [4.75622731828667, 1.0]], [1, [14.745859041909222, 1.0]], [1, [0.3452715507344453, 1.0]], [1, [1.2502943709801104, 1.0]], [1, [0.39352099183364175, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50785021]
bas 1, expnt(s) = [7618.25078188]
bas 2, expnt(s) = [3618.25077878]
bas 3, expnt(s) = [1618.25068949]
bas 4, expnt(s) = [239.78384736]
bas 5, expnt(s) = [51.89904434]
bas 6, expnt(s) = [4.42109125]
bas 7, expnt(s) = [0.45136026]
bas 8, expnt(s) = [0.13382081]
bas 9, expnt(s) = [1362.79300304]
bas 10, expnt(s) = [665.18072282]
bas 11, expnt(s) = [303.32062599]
bas 12, expnt(s) = [316.14644208]
bas 13, expnt(s) = [49.30034737]
bas 14, expnt(s) = [4.75622732]
bas 15, expnt(s) = [14.74585904]
bas 16, expnt(s) = [0.34527155]
bas 17, expnt(s) = [1.25029437]
bas 18, expnt(s) = [0.39352099]
CPU time:        19.20
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024082e+03 7.61825078e+03 2.06018620e+03
 3.61825078e+03 1.17866130e+03 1.61825069e+03 6.44613468e+02
 2.39783847e+02 1.53950097e+02 5.18990443e+01 4.88522471e+01
 4.42109125e+00 7.70303964e+00 4.51360261e-01 1.39125749e+00
 1.33820806e-01 5.58994783e-01 1.36279300e+03 2.41558187e+04
 6.65180723e+02 9.85505293e+03 3.03320626e+02 3.69285132e+03
 3.16146442e+02 3.88906110e+03 4.93003474e+01 3.81106948e+02
 4.75622732e+00 2.04909761e+01 1.47458590e+01 8.42989160e+01
 3.45271551e-01 7.72121040e-01 1.25029437e+00 3.85700088e+00
 3.93520992e-01 9.09272953e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.947668498219922
cond(S) = 83646.74057756658
E1 = -726.5941324174078  E_coul = 202.56155925596084
init E= -524.032573161447
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.561099189940196  LUMO = 0.440827892165678
  mo_energy =
[-1.17939407e+02 -1.21323519e+01 -9.48491892e+00 -9.48491892e+00
 -9.48491892e+00 -1.24868429e+00 -5.61099190e-01 -5.61099190e-01
 -5.61099190e-01  4.40827892e-01  9.48444151e-01  9.48444151e-01
  9.48444151e-01  3.56581779e+00  3.56581779e+00  3.56581779e+00
  1.76863276e+01  1.76863276e+01  1.76863276e+01  8.74627913e+01
  8.74627913e+01  8.74627913e+01  1.82585831e+02  4.19816716e+02
  4.19816716e+02  4.19816716e+02  1.27359640e+03  1.27359640e+03
  1.27359640e+03  1.91437120e+03  2.97572391e+03  2.97572391e+03
  2.97572391e+03  6.60496802e+03  6.60496802e+03  6.60496802e+03
  8.27286121e+03  2.46607258e+04  7.54571335e+04]
E1 = -727.4970754102487  E_coul = 202.01430867504868
cycle= 1 E= -525.4827667352  delta_E= -1.45  |g|= 0.199  |ddm|= 7.66
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.46678
diis-c [-0.21788375  1.        ]
  HOMO = -0.545277288872228  LUMO = 0.462794496984024
  mo_energy =
[-1.18148435e+02 -1.21603239e+01 -9.52083738e+00 -9.52083738e+00
 -9.52083738e+00 -1.22735786e+00 -5.45277289e-01 -5.45277289e-01
 -5.45277289e-01  4.62794497e-01  9.69236601e-01  9.69236601e-01
  9.69236601e-01  3.58068271e+00  3.58068271e+00  3.58068271e+00
  1.76578676e+01  1.76578676e+01  1.76578676e+01  8.73606776e+01
  8.73606776e+01  8.73606776e+01  1.82444194e+02  4.19621269e+02
  4.19621269e+02  4.19621269e+02  1.27334075e+03  1.27334075e+03
  1.27334075e+03  1.91397166e+03  2.97539388e+03  2.97539388e+03
  2.97539388e+03  6.60450758e+03  6.60450758e+03  6.60450758e+03
  8.27230881e+03  2.46600726e+04  7.54563840e+04]
E1 = -727.640067395764  E_coul = 202.1568229414601
cycle= 2 E= -525.483244454304  delta_E= -0.000478  |g|= 0.0145  |ddm|= 0.602
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.022953
diis-c [-4.31003753e-04  2.05618225e-02  9.79438177e-01]
  HOMO = -0.543571474853903  LUMO = 0.464284851970454
  mo_energy =
[-1.18124421e+02 -1.21509666e+01 -9.51132837e+00 -9.51132837e+00
 -9.51132837e+00 -1.22459390e+00 -5.43571475e-01 -5.43571475e-01
 -5.43571475e-01  4.64284852e-01  9.70321567e-01  9.70321567e-01
  9.70321567e-01  3.58345363e+00  3.58345363e+00  3.58345363e+00
  1.76657547e+01  1.76657547e+01  1.76657547e+01  8.73772990e+01
  8.73772990e+01  8.73772990e+01  1.82467324e+02  4.19645003e+02
  4.19645003e+02  4.19645003e+02  1.27336647e+03  1.27336647e+03
  1.27336647e+03  1.91399848e+03  2.97542045e+03  2.97542045e+03
  2.97542045e+03  6.60453452e+03  6.60453452e+03  6.60453452e+03
  8.27233584e+03  2.46600995e+04  7.54564108e+04]
E1 = -727.6100897100241  E_coul = 202.12683525737174
cycle= 3 E= -525.483254452652  delta_E= -1e-05  |g|= 0.00207  |ddm|= 0.0554
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.003793
diis-c [-1.03792220e-06 -1.17103918e-03  1.28145550e-01  8.73025489e-01]
  HOMO = -0.543900850148165  LUMO = 0.464256802276379
  mo_energy =
[-1.18127725e+02 -1.21526336e+01 -9.51311756e+00 -9.51311756e+00
 -9.51311756e+00 -1.22480914e+00 -5.43900850e-01 -5.43900850e-01
 -5.43900850e-01  4.64256802e-01  9.70191645e-01  9.70191645e-01
  9.70191645e-01  3.58299013e+00  3.58299013e+00  3.58299013e+00
  1.76642649e+01  1.76642649e+01  1.76642649e+01  8.73747751e+01
  8.73747751e+01  8.73747751e+01  1.82464209e+02  4.19641740e+02
  4.19641740e+02  4.19641740e+02  1.27336296e+03  1.27336296e+03
  1.27336296e+03  1.91399473e+03  2.97541680e+03  2.97541680e+03
  2.97541680e+03  6.60453070e+03  6.60453070e+03  6.60453070e+03
  8.27233192e+03  2.46600955e+04  7.54564067e+04]
E1 = -727.6158382392931  E_coul = 202.13258340600302
cycle= 4 E= -525.48325483329  delta_E= -3.81e-07  |g|= 0.00026  |ddm|= 0.0135
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000180421
diis-c [-1.33764360e-08  1.31074750e-04 -2.11980556e-02 -1.31433595e-01
  1.15250058e+00]
  HOMO = -0.543850732791609  LUMO = 0.464321126577955
  mo_energy =
[-1.18127560e+02 -1.21524834e+01 -9.51298045e+00 -9.51298045e+00
 -9.51298045e+00 -1.22468584e+00 -5.43850733e-01 -5.43850733e-01
 -5.43850733e-01  4.64321127e-01  9.70223265e-01  9.70223265e-01
  9.70223265e-01  3.58307136e+00  3.58307136e+00  3.58307136e+00
  1.76643930e+01  1.76643930e+01  1.76643930e+01  8.73749298e+01
  8.73749298e+01  8.73749298e+01  1.82464379e+02  4.19641904e+02
  4.19641904e+02  4.19641904e+02  1.27336312e+03  1.27336312e+03
  1.27336312e+03  1.91399487e+03  2.97541695e+03  2.97541695e+03
  2.97541695e+03  6.60453083e+03  6.60453083e+03  6.60453083e+03
  8.27233204e+03  2.46600956e+04  7.54564068e+04]
E1 = -727.6154144256823  E_coul = 202.13215956935707
cycle= 5 E= -525.483254856325  delta_E= -2.3e-08  |g|= 3.28e-05  |ddm|= 0.00268
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.18342e-05
diis-c [-2.73692075e-10  3.54690283e-05 -4.16501666e-03 -3.72059472e-02
  1.11526351e-01  9.29809144e-01]
  HOMO = -0.543864952299537  LUMO = 0.464317976275702
  mo_energy =
[-1.18127607e+02 -1.21525208e+01 -9.51302021e+00 -9.51302021e+00
 -9.51302021e+00 -1.22469551e+00 -5.43864952e-01 -5.43864952e-01
 -5.43864952e-01  4.64317976e-01  9.70216730e-01  9.70216730e-01
  9.70216730e-01  3.58305408e+00  3.58305408e+00  3.58305408e+00
  1.76643578e+01  1.76643578e+01  1.76643578e+01  8.73748868e+01
  8.73748868e+01  8.73748868e+01  1.82464334e+02  4.19641858e+02
  4.19641858e+02  4.19641858e+02  1.27336308e+03  1.27336308e+03
  1.27336308e+03  1.91399482e+03  2.97541690e+03  2.97541690e+03
  2.97541690e+03  6.60453079e+03  6.60453079e+03  6.60453079e+03
  8.27233199e+03  2.46600956e+04  7.54564068e+04]
E1 = -727.61550646435  E_coul = 202.13225160782224
cycle= 6 E= -525.483254856528  delta_E= -2.03e-10  |g|= 3.16e-06  |ddm|= 0.000202
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -727.61550646435  E_coul = 202.13225160782224
  HOMO = -0.54386672379641  LUMO = 0.464317045218349
  mo_energy =
[-1.18127610e+02 -1.21525240e+01 -9.51302342e+00 -9.51302342e+00
 -9.51302342e+00 -1.22469732e+00 -5.43866724e-01 -5.43866724e-01
 -5.43866724e-01  4.64317045e-01  9.70215752e-01  9.70215752e-01
  9.70215752e-01  3.58305191e+00  3.58305191e+00  3.58305191e+00
  1.76643547e+01  1.76643547e+01  1.76643547e+01  8.73748835e+01
  8.73748835e+01  8.73748835e+01  1.82464331e+02  4.19641854e+02
  4.19641854e+02  4.19641854e+02  1.27336307e+03  1.27336307e+03
  1.27336307e+03  1.91399481e+03  2.97541689e+03  2.97541689e+03
  2.97541689e+03  6.60453078e+03  6.60453078e+03  6.60453078e+03
  8.27233199e+03  2.46600956e+04  7.54564068e+04]
E1 = -727.6155107430232  E_coul = 202.1322558864941
Extra cycle  E= -525.483254856529  delta_E= -1.25e-12  |g|= 4.18e-07  |ddm|= 3.31e-05
    CPU time for scf_cycle      0.64 sec, wall time      0.26 sec
exp = [2.61825079e+04 7.61825078e+03 3.61825078e+03 1.61825069e+03
 2.39783847e+02 5.18990443e+01 4.42109125e+00 4.51360261e-01
 1.33820806e-01 1.36279300e+03 6.65180723e+02 3.03320626e+02
 3.16146442e+02 4.93003474e+01 4.75622732e+00 1.47458590e+01
 3.45271551e-01 1.25029437e+00 3.93520992e-01]
E = -525.483254856529
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:38:57 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5078501        1
[INPUT] 0    0    [1    /1   ]  7618.25078337        1
[INPUT] 0    0    [1    /1   ]  3618.25078175        1
[INPUT] 0    0    [1    /1   ]  1618.25073516        1
[INPUT] 0    0    [1    /1   ]  239.783914304        1
[INPUT] 0    0    [1    /1   ]  51.8985039278        1
[INPUT] 0    0    [1    /1   ]  4.40483005987        1
[INPUT] 0    0    [1    /1   ]  0.445310374158       1
[INPUT] 0    0    [1    /1   ]  0.114717279091       1
[INPUT] 1    0    [1    /1   ]  1362.79300314        1
[INPUT] 1    0    [1    /1   ]  665.180724223        1
[INPUT] 1    0    [1    /1   ]  303.320633578        1
[INPUT] 1    0    [1    /1   ]  316.146448765        1
[INPUT] 1    0    [1    /1   ]  49.3002501288        1
[INPUT] 1    0    [1    /1   ]  4.75505636156        1
[INPUT] 1    0    [1    /1   ]  14.7465449804        1
[INPUT] 1    0    [1    /1   ]  0.373010995398       1
[INPUT] 1    0    [1    /1   ]  1.2421862405         1
[INPUT] 1    0    [1    /1   ]  0.223858314748       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.50785007766, 1.0]], [0, [7618.250783367874, 1.0]], [0, [3618.250781752023, 1.0]], [0, [1618.2507351607546, 1.0]], [0, [239.7839143040043, 1.0]], [0, [51.89850392783661, 1.0]], [0, [4.4048300598664465, 1.0]], [0, [0.4453103741576014, 1.0]], [0, [0.11471727909099787, 1.0]], [1, [1362.7930031352573, 1.0]], [1, [665.1807242233184, 1.0]], [1, [303.32063357795494, 1.0]], [1, [316.1464487651162, 1.0]], [1, [49.30025012880297, 1.0]], [1, [4.755056361561806, 1.0]], [1, [14.746544980377816, 1.0]], [1, [0.37301099539841304, 1.0]], [1, [1.242186240501548, 1.0]], [1, [0.22385831474844498, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50785008]
bas 1, expnt(s) = [7618.25078337]
bas 2, expnt(s) = [3618.25078175]
bas 3, expnt(s) = [1618.25073516]
bas 4, expnt(s) = [239.7839143]
bas 5, expnt(s) = [51.89850393]
bas 6, expnt(s) = [4.40483006]
bas 7, expnt(s) = [0.44531037]
bas 8, expnt(s) = [0.11471728]
bas 9, expnt(s) = [1362.79300314]
bas 10, expnt(s) = [665.18072422]
bas 11, expnt(s) = [303.32063358]
bas 12, expnt(s) = [316.14644877]
bas 13, expnt(s) = [49.30025013]
bas 14, expnt(s) = [4.75505636]
bas 15, expnt(s) = [14.74654498]
bas 16, expnt(s) = [0.373011]
bas 17, expnt(s) = [1.24218624]
bas 18, expnt(s) = [0.22385831]
CPU time:        19.88
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024082e+03 7.61825078e+03 2.06018620e+03
 3.61825078e+03 1.17866130e+03 1.61825074e+03 6.44613481e+02
 2.39783914e+02 1.53950129e+02 5.18985039e+01 4.88518656e+01
 4.40483006e+00 7.68178049e+00 4.45310374e-01 1.37724795e+00
 1.14717279e-01 4.98008382e-01 1.36279300e+03 2.41558187e+04
 6.65180724e+02 9.85505295e+03 3.03320634e+02 3.69285143e+03
 3.16146449e+02 3.88906120e+03 4.93002501e+01 3.81106009e+02
 4.75505636e+00 2.04846703e+01 1.47465450e+01 8.43038178e+01
 3.73010995e-01 8.50425815e-01 1.24218624e+00 3.82576056e+00
 2.23858315e-01 4.49211566e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.970900966634954
cond(S) = 83526.27237000983
E1 = -726.6560655497832  E_coul = 202.58667920994566
init E= -524.069386339838
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.564644676578572  LUMO = 0.376859465147801
  mo_energy =
[-1.17938421e+02 -1.21288279e+01 -9.48375490e+00 -9.48375490e+00
 -9.48375490e+00 -1.24548163e+00 -5.64644677e-01 -5.64644677e-01
 -5.64644677e-01  3.76859465e-01  6.79759965e-01  6.79759965e-01
  6.79759965e-01  2.99398002e+00  2.99398002e+00  2.99398002e+00
  1.71516393e+01  1.71516393e+01  1.71516393e+01  8.70952869e+01
  8.70952869e+01  8.70952869e+01  1.82441523e+02  4.19571045e+02
  4.19571045e+02  4.19571045e+02  1.27338912e+03  1.27338912e+03
  1.27338912e+03  1.91427170e+03  2.97553397e+03  2.97553397e+03
  2.97553397e+03  6.60479578e+03  6.60479578e+03  6.60479578e+03
  8.27277412e+03  2.46606441e+04  7.54570577e+04]
E1 = -726.7289747648098  E_coul = 201.22384898180198
cycle= 1 E= -525.505125783008  delta_E= -1.44  |g|= 0.203  |ddm|= 0.823
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.481688
diis-c [-0.23202296  1.        ]
  HOMO = -0.575396535907214  LUMO = 0.381587193151409
  mo_energy =
[-1.18212727e+02 -1.22138998e+01 -9.57725432e+00 -9.57725432e+00
 -9.57725432e+00 -1.25634472e+00 -5.75396536e-01 -5.75396536e-01
 -5.75396536e-01  3.81587193e-01  6.83747817e-01  6.83747817e-01
  6.83747817e-01  2.97589105e+00  2.97589105e+00  2.97589105e+00
  1.70691946e+01  1.70691946e+01  1.70691946e+01  8.69318046e+01
  8.69318046e+01  8.69318046e+01  1.82236202e+02  4.19310682e+02
  4.19310682e+02  4.19310682e+02  1.27306762e+03  1.27306762e+03
  1.27306762e+03  1.91380562e+03  2.97513760e+03  2.97513760e+03
  2.97513760e+03  6.60426860e+03  6.60426860e+03  6.60426860e+03
  8.27215477e+03  2.46599237e+04  7.54562410e+04]
E1 = -727.0744095005143  E_coul = 201.56877798273538
cycle= 2 E= -525.505631517779  delta_E= -0.000506  |g|= 0.0221  |ddm|= 0.0743
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0381721
diis-c [-0.0010345   0.04101858  0.95898142]
  HOMO = -0.569454756607442  LUMO = 0.384590038165797
  mo_energy =
[-1.18168949e+02 -1.21902843e+01 -9.55302390e+00 -9.55302390e+00
 -9.55302390e+00 -1.24884440e+00 -5.69454757e-01 -5.69454757e-01
 -5.69454757e-01  3.84590038e-01  6.86124089e-01  6.86124089e-01
  6.86124089e-01  2.98417627e+00  2.98417627e+00  2.98417627e+00
  1.70900752e+01  1.70900752e+01  1.70900752e+01  8.69656641e+01
  8.69656641e+01  8.69656641e+01  1.82278555e+02  4.19354026e+02
  4.19354026e+02  4.19354026e+02  1.27311358e+03  1.27311358e+03
  1.27311358e+03  1.91385317e+03  2.97518474e+03  2.97518474e+03
  2.97518474e+03  6.60431639e+03  6.60431639e+03  6.60431639e+03
  8.27220280e+03  2.46599718e+04  7.54562889e+04]
E1 = -726.9987107957609  E_coul = 201.49305896484339
cycle= 3 E= -525.505651830917  delta_E= -2.03e-05  |g|= 0.00356  |ddm|= 0.0111
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00683223
diis-c [-8.40163028e-07 -1.26573292e-03  1.43795899e-01  8.57469834e-01]
  HOMO = -0.57032995445839  LUMO = 0.384331397479379
  mo_energy =
[-1.18175283e+02 -1.21939775e+01 -9.55689097e+00 -9.55689097e+00
 -9.55689097e+00 -1.24975887e+00 -5.70329954e-01 -5.70329954e-01
 -5.70329954e-01  3.84331397e-01  6.85836987e-01  6.85836987e-01
  6.85836987e-01  2.98298328e+00  2.98298328e+00  2.98298328e+00
  1.70867561e+01  1.70867561e+01  1.70867561e+01  8.69605802e+01
  8.69605802e+01  8.69605802e+01  1.82272508e+02  4.19347760e+02
  4.19347760e+02  4.19347760e+02  1.27310696e+03  1.27310696e+03
  1.27310696e+03  1.91384621e+03  2.97517791e+03  2.97517791e+03
  2.97517791e+03  6.60430935e+03  6.60430935e+03  6.60430935e+03
  8.27219563e+03  2.46599645e+04  7.54562816e+04]
E1 = -727.0119554680412  E_coul = 201.506302837994
cycle= 4 E= -525.505652630047  delta_E= -7.99e-07  |g|= 0.000213  |ddm|= 0.0023
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00015497
diis-c [-1.48569556e-08  1.00343418e-04 -1.70009207e-02 -9.69542253e-02
  1.11385480e+00]
  HOMO = -0.570260953047435  LUMO = 0.384394624741638
  mo_energy =
[-1.18175124e+02 -1.21938178e+01 -9.55674034e+00 -9.55674034e+00
 -9.55674034e+00 -1.24963284e+00 -5.70260953e-01 -5.70260953e-01
 -5.70260953e-01  3.84394625e-01  6.85870778e-01  6.85870778e-01
  6.85870778e-01  2.98308051e+00  2.98308051e+00  2.98308051e+00
  1.70868999e+01  1.70868999e+01  1.70868999e+01  8.69607380e+01
  8.69607380e+01  8.69607380e+01  1.82272673e+02  4.19347919e+02
  4.19347919e+02  4.19347919e+02  1.27310712e+03  1.27310712e+03
  1.27310712e+03  1.91384635e+03  2.97517805e+03  2.97517805e+03
  2.97517805e+03  6.60430948e+03  6.60430948e+03  6.60430948e+03
  8.27219576e+03  2.46599646e+04  7.54562817e+04]
E1 = -727.0116470535883  E_coul = 201.50599440834006
cycle= 5 E= -525.505652645248  delta_E= -1.52e-08  |g|= 2.9e-05  |ddm|= 0.00055
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.54452e-05
diis-c [-2.10875699e-10  2.96110547e-05 -3.28272162e-03 -2.49023857e-02
  3.94427174e-02  9.88712779e-01]
  HOMO = -0.570270719696137  LUMO = 0.38439423169501
  mo_energy =
[-1.18175159e+02 -1.21938465e+01 -9.55677108e+00 -9.55677108e+00
 -9.55677108e+00 -1.24963786e+00 -5.70270720e-01 -5.70270720e-01
 -5.70270720e-01  3.84394232e-01  6.85867865e-01  6.85867865e-01
  6.85867865e-01  2.98306921e+00  2.98306921e+00  2.98306921e+00
  1.70868729e+01  1.70868729e+01  1.70868729e+01  8.69607050e+01
  8.69607050e+01  8.69607050e+01  1.82272638e+02  4.19347884e+02
  4.19347884e+02  4.19347884e+02  1.27310708e+03  1.27310708e+03
  1.27310708e+03  1.91384631e+03  2.97517802e+03  2.97517802e+03
  2.97517802e+03  6.60430944e+03  6.60430944e+03  6.60430944e+03
  8.27219572e+03  2.46599646e+04  7.54562817e+04]
E1 = -727.0117402312354  E_coul = 201.50608758576914
cycle= 6 E= -525.505652645466  delta_E= -2.18e-10  |g|= 2.42e-06  |ddm|= 5.86e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -727.0117402312354  E_coul = 201.50608758576914
  HOMO = -0.570271913223764  LUMO = 0.384393734266233
  mo_energy =
[-1.18175161e+02 -1.21938482e+01 -9.55677288e+00 -9.55677288e+00
 -9.55677288e+00 -1.24963884e+00 -5.70271913e-01 -5.70271913e-01
 -5.70271913e-01  3.84393734e-01  6.85867348e-01  6.85867348e-01
  6.85867348e-01  2.98306785e+00  2.98306785e+00  2.98306785e+00
  1.70868712e+01  1.70868712e+01  1.70868712e+01  8.69607032e+01
  8.69607032e+01  8.69607032e+01  1.82272637e+02  4.19347882e+02
  4.19347882e+02  4.19347882e+02  1.27310708e+03  1.27310708e+03
  1.27310708e+03  1.91384631e+03  2.97517802e+03  2.97517802e+03
  2.97517802e+03  6.60430944e+03  6.60430944e+03  6.60430944e+03
  8.27219572e+03  2.46599646e+04  7.54562817e+04]
E1 = -727.0117411374987  E_coul = 201.50608849203235
Extra cycle  E= -525.505652645466  delta_E= -1.14e-13  |g|= 3.77e-07  |ddm|= 3.94e-06
    CPU time for scf_cycle      0.64 sec, wall time      0.26 sec
exp = [2.61825079e+04 7.61825078e+03 3.61825078e+03 1.61825074e+03
 2.39783914e+02 5.18985039e+01 4.40483006e+00 4.45310374e-01
 1.14717279e-01 1.36279300e+03 6.65180724e+02 3.03320634e+02
 3.16146449e+02 4.93002501e+01 4.75505636e+00 1.47465450e+01
 3.73010995e-01 1.24218624e+00 2.23858315e-01]
E = -525.5056526454664
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:38:57 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5078501        1
[INPUT] 0    0    [1    /1   ]  7618.25078337        1
[INPUT] 0    0    [1    /1   ]  3618.25078175        1
[INPUT] 0    0    [1    /1   ]  1618.25073516        1
[INPUT] 0    0    [1    /1   ]  239.783914304        1
[INPUT] 0    0    [1    /1   ]  51.8985039278        1
[INPUT] 0    0    [1    /1   ]  4.40483005987        1
[INPUT] 0    0    [1    /1   ]  0.445310374158       1
[INPUT] 0    0    [1    /1   ]  0.114717279091       1
[INPUT] 1    0    [1    /1   ]  1362.79300314        1
[INPUT] 1    0    [1    /1   ]  665.180724223        1
[INPUT] 1    0    [1    /1   ]  303.320633578        1
[INPUT] 1    0    [1    /1   ]  316.146448765        1
[INPUT] 1    0    [1    /1   ]  49.3002501288        1
[INPUT] 1    0    [1    /1   ]  4.75505636156        1
[INPUT] 1    0    [1    /1   ]  14.7465449804        1
[INPUT] 1    0    [1    /1   ]  0.373010995398       1
[INPUT] 1    0    [1    /1   ]  1.2421862405         1
[INPUT] 1    0    [1    /1   ]  0.223858314748       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.50785007766, 1.0]], [0, [7618.250783367874, 1.0]], [0, [3618.250781752023, 1.0]], [0, [1618.2507351607546, 1.0]], [0, [239.7839143040043, 1.0]], [0, [51.89850392783661, 1.0]], [0, [4.4048300598664465, 1.0]], [0, [0.4453103741576014, 1.0]], [0, [0.11471727909099787, 1.0]], [1, [1362.7930031352573, 1.0]], [1, [665.1807242233184, 1.0]], [1, [303.32063357795494, 1.0]], [1, [316.1464487651162, 1.0]], [1, [49.30025012880297, 1.0]], [1, [4.755056361561806, 1.0]], [1, [14.746544980377816, 1.0]], [1, [0.37301099539841304, 1.0]], [1, [1.242186240501548, 1.0]], [1, [0.22385831474844498, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50785008]
bas 1, expnt(s) = [7618.25078337]
bas 2, expnt(s) = [3618.25078175]
bas 3, expnt(s) = [1618.25073516]
bas 4, expnt(s) = [239.7839143]
bas 5, expnt(s) = [51.89850393]
bas 6, expnt(s) = [4.40483006]
bas 7, expnt(s) = [0.44531037]
bas 8, expnt(s) = [0.11471728]
bas 9, expnt(s) = [1362.79300314]
bas 10, expnt(s) = [665.18072422]
bas 11, expnt(s) = [303.32063358]
bas 12, expnt(s) = [316.14644877]
bas 13, expnt(s) = [49.30025013]
bas 14, expnt(s) = [4.75505636]
bas 15, expnt(s) = [14.74654498]
bas 16, expnt(s) = [0.373011]
bas 17, expnt(s) = [1.24218624]
bas 18, expnt(s) = [0.22385831]
CPU time:        20.57
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024082e+03 7.61825078e+03 2.06018620e+03
 3.61825078e+03 1.17866130e+03 1.61825074e+03 6.44613481e+02
 2.39783914e+02 1.53950129e+02 5.18985039e+01 4.88518656e+01
 4.40483006e+00 7.68178049e+00 4.45310374e-01 1.37724795e+00
 1.14717279e-01 4.98008382e-01 1.36279300e+03 2.41558187e+04
 6.65180724e+02 9.85505295e+03 3.03320634e+02 3.69285143e+03
 3.16146449e+02 3.88906120e+03 4.93002501e+01 3.81106009e+02
 4.75505636e+00 2.04846703e+01 1.47465450e+01 8.43038178e+01
 3.73010995e-01 8.50425815e-01 1.24218624e+00 3.82576056e+00
 2.23858315e-01 4.49211566e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.970900966634954
cond(S) = 83526.27237000983
E1 = -726.6560655497832  E_coul = 202.58667920994566
init E= -524.069386339838
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.564644676578572  LUMO = 0.376859465147801
  mo_energy =
[-1.17938421e+02 -1.21288279e+01 -9.48375490e+00 -9.48375490e+00
 -9.48375490e+00 -1.24548163e+00 -5.64644677e-01 -5.64644677e-01
 -5.64644677e-01  3.76859465e-01  6.79759965e-01  6.79759965e-01
  6.79759965e-01  2.99398002e+00  2.99398002e+00  2.99398002e+00
  1.71516393e+01  1.71516393e+01  1.71516393e+01  8.70952869e+01
  8.70952869e+01  8.70952869e+01  1.82441523e+02  4.19571045e+02
  4.19571045e+02  4.19571045e+02  1.27338912e+03  1.27338912e+03
  1.27338912e+03  1.91427170e+03  2.97553397e+03  2.97553397e+03
  2.97553397e+03  6.60479578e+03  6.60479578e+03  6.60479578e+03
  8.27277412e+03  2.46606441e+04  7.54570577e+04]
E1 = -726.7289747648098  E_coul = 201.22384898180198
cycle= 1 E= -525.505125783008  delta_E= -1.44  |g|= 0.203  |ddm|= 0.823
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.481688
diis-c [-0.23202296  1.        ]
  HOMO = -0.575396535907214  LUMO = 0.381587193151409
  mo_energy =
[-1.18212727e+02 -1.22138998e+01 -9.57725432e+00 -9.57725432e+00
 -9.57725432e+00 -1.25634472e+00 -5.75396536e-01 -5.75396536e-01
 -5.75396536e-01  3.81587193e-01  6.83747817e-01  6.83747817e-01
  6.83747817e-01  2.97589105e+00  2.97589105e+00  2.97589105e+00
  1.70691946e+01  1.70691946e+01  1.70691946e+01  8.69318046e+01
  8.69318046e+01  8.69318046e+01  1.82236202e+02  4.19310682e+02
  4.19310682e+02  4.19310682e+02  1.27306762e+03  1.27306762e+03
  1.27306762e+03  1.91380562e+03  2.97513760e+03  2.97513760e+03
  2.97513760e+03  6.60426860e+03  6.60426860e+03  6.60426860e+03
  8.27215477e+03  2.46599237e+04  7.54562410e+04]
E1 = -727.0744095005143  E_coul = 201.56877798273538
cycle= 2 E= -525.505631517779  delta_E= -0.000506  |g|= 0.0221  |ddm|= 0.0743
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0381721
diis-c [-0.0010345   0.04101858  0.95898142]
  HOMO = -0.569454756607442  LUMO = 0.384590038165797
  mo_energy =
[-1.18168949e+02 -1.21902843e+01 -9.55302390e+00 -9.55302390e+00
 -9.55302390e+00 -1.24884440e+00 -5.69454757e-01 -5.69454757e-01
 -5.69454757e-01  3.84590038e-01  6.86124089e-01  6.86124089e-01
  6.86124089e-01  2.98417627e+00  2.98417627e+00  2.98417627e+00
  1.70900752e+01  1.70900752e+01  1.70900752e+01  8.69656641e+01
  8.69656641e+01  8.69656641e+01  1.82278555e+02  4.19354026e+02
  4.19354026e+02  4.19354026e+02  1.27311358e+03  1.27311358e+03
  1.27311358e+03  1.91385317e+03  2.97518474e+03  2.97518474e+03
  2.97518474e+03  6.60431639e+03  6.60431639e+03  6.60431639e+03
  8.27220280e+03  2.46599718e+04  7.54562889e+04]
E1 = -726.9987107957609  E_coul = 201.49305896484339
cycle= 3 E= -525.505651830917  delta_E= -2.03e-05  |g|= 0.00356  |ddm|= 0.0111
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00683223
diis-c [-8.40163028e-07 -1.26573292e-03  1.43795899e-01  8.57469834e-01]
  HOMO = -0.57032995445839  LUMO = 0.384331397479379
  mo_energy =
[-1.18175283e+02 -1.21939775e+01 -9.55689097e+00 -9.55689097e+00
 -9.55689097e+00 -1.24975887e+00 -5.70329954e-01 -5.70329954e-01
 -5.70329954e-01  3.84331397e-01  6.85836987e-01  6.85836987e-01
  6.85836987e-01  2.98298328e+00  2.98298328e+00  2.98298328e+00
  1.70867561e+01  1.70867561e+01  1.70867561e+01  8.69605802e+01
  8.69605802e+01  8.69605802e+01  1.82272508e+02  4.19347760e+02
  4.19347760e+02  4.19347760e+02  1.27310696e+03  1.27310696e+03
  1.27310696e+03  1.91384621e+03  2.97517791e+03  2.97517791e+03
  2.97517791e+03  6.60430935e+03  6.60430935e+03  6.60430935e+03
  8.27219563e+03  2.46599645e+04  7.54562816e+04]
E1 = -727.0119554680412  E_coul = 201.506302837994
cycle= 4 E= -525.505652630047  delta_E= -7.99e-07  |g|= 0.000213  |ddm|= 0.0023
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00015497
diis-c [-1.48569556e-08  1.00343418e-04 -1.70009207e-02 -9.69542253e-02
  1.11385480e+00]
  HOMO = -0.570260953047435  LUMO = 0.384394624741638
  mo_energy =
[-1.18175124e+02 -1.21938178e+01 -9.55674034e+00 -9.55674034e+00
 -9.55674034e+00 -1.24963284e+00 -5.70260953e-01 -5.70260953e-01
 -5.70260953e-01  3.84394625e-01  6.85870778e-01  6.85870778e-01
  6.85870778e-01  2.98308051e+00  2.98308051e+00  2.98308051e+00
  1.70868999e+01  1.70868999e+01  1.70868999e+01  8.69607380e+01
  8.69607380e+01  8.69607380e+01  1.82272673e+02  4.19347919e+02
  4.19347919e+02  4.19347919e+02  1.27310712e+03  1.27310712e+03
  1.27310712e+03  1.91384635e+03  2.97517805e+03  2.97517805e+03
  2.97517805e+03  6.60430948e+03  6.60430948e+03  6.60430948e+03
  8.27219576e+03  2.46599646e+04  7.54562817e+04]
E1 = -727.0116470535883  E_coul = 201.50599440834006
cycle= 5 E= -525.505652645248  delta_E= -1.52e-08  |g|= 2.9e-05  |ddm|= 0.00055
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.54452e-05
diis-c [-2.10875699e-10  2.96110547e-05 -3.28272162e-03 -2.49023857e-02
  3.94427174e-02  9.88712779e-01]
  HOMO = -0.570270719696137  LUMO = 0.38439423169501
  mo_energy =
[-1.18175159e+02 -1.21938465e+01 -9.55677108e+00 -9.55677108e+00
 -9.55677108e+00 -1.24963786e+00 -5.70270720e-01 -5.70270720e-01
 -5.70270720e-01  3.84394232e-01  6.85867865e-01  6.85867865e-01
  6.85867865e-01  2.98306921e+00  2.98306921e+00  2.98306921e+00
  1.70868729e+01  1.70868729e+01  1.70868729e+01  8.69607050e+01
  8.69607050e+01  8.69607050e+01  1.82272638e+02  4.19347884e+02
  4.19347884e+02  4.19347884e+02  1.27310708e+03  1.27310708e+03
  1.27310708e+03  1.91384631e+03  2.97517802e+03  2.97517802e+03
  2.97517802e+03  6.60430944e+03  6.60430944e+03  6.60430944e+03
  8.27219572e+03  2.46599646e+04  7.54562817e+04]
E1 = -727.0117402312354  E_coul = 201.50608758576914
cycle= 6 E= -525.505652645466  delta_E= -2.18e-10  |g|= 2.42e-06  |ddm|= 5.86e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -727.0117402312354  E_coul = 201.50608758576914
  HOMO = -0.570271913223764  LUMO = 0.384393734266233
  mo_energy =
[-1.18175161e+02 -1.21938482e+01 -9.55677288e+00 -9.55677288e+00
 -9.55677288e+00 -1.24963884e+00 -5.70271913e-01 -5.70271913e-01
 -5.70271913e-01  3.84393734e-01  6.85867348e-01  6.85867348e-01
  6.85867348e-01  2.98306785e+00  2.98306785e+00  2.98306785e+00
  1.70868712e+01  1.70868712e+01  1.70868712e+01  8.69607032e+01
  8.69607032e+01  8.69607032e+01  1.82272637e+02  4.19347882e+02
  4.19347882e+02  4.19347882e+02  1.27310708e+03  1.27310708e+03
  1.27310708e+03  1.91384631e+03  2.97517802e+03  2.97517802e+03
  2.97517802e+03  6.60430944e+03  6.60430944e+03  6.60430944e+03
  8.27219572e+03  2.46599646e+04  7.54562817e+04]
E1 = -727.0117411374987  E_coul = 201.50608849203235
Extra cycle  E= -525.505652645466  delta_E= -1.14e-13  |g|= 3.77e-07  |ddm|= 3.94e-06
    CPU time for scf_cycle      0.64 sec, wall time      0.26 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 83526.27237000983
E1 = -727.0117411374987  E_coul = 201.50608849203235
init E= -525.505652645466
    CPU time for initialize scf      2.82 sec, wall time      0.25 sec
  HOMO = -0.570271973124725  LUMO = 0.384393720927084
  mo_energy =
[-1.18175161e+02 -1.21938481e+01 -9.55677278e+00 -9.55677278e+00
 -9.55677278e+00 -1.24963883e+00 -5.70271973e-01 -5.70271973e-01
 -5.70271973e-01  3.84393721e-01  6.85867317e-01  6.85867317e-01
  6.85867317e-01  2.98306781e+00  2.98306781e+00  2.98306781e+00
  1.70868712e+01  1.70868712e+01  1.70868712e+01  8.69607034e+01
  8.69607034e+01  8.69607034e+01  1.82272637e+02  4.19347882e+02
  4.19347882e+02  4.19347882e+02  1.27310708e+03  1.27310708e+03
  1.27310708e+03  1.91384631e+03  2.97517802e+03  2.97517802e+03
  2.97517802e+03  6.60430944e+03  6.60430944e+03  6.60430944e+03
  8.27219572e+03  2.46599646e+04  7.54562817e+04]
E1 = -727.0117401628123  E_coul = 201.5060875173445
cycle= 1 E= -525.505652645468  delta_E= -1.36e-12  |g|= 7.51e-08  |ddm|= 7.31e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.0117401628123  E_coul = 201.5060875173445
  HOMO = -0.57027200507145  LUMO = 0.384393711677958
  mo_energy =
[-1.18175161e+02 -1.21938482e+01 -9.55677285e+00 -9.55677285e+00
 -9.55677285e+00 -1.24963885e+00 -5.70272005e-01 -5.70272005e-01
 -5.70272005e-01  3.84393712e-01  6.85867304e-01  6.85867304e-01
  6.85867304e-01  2.98306777e+00  2.98306777e+00  2.98306777e+00
  1.70868712e+01  1.70868712e+01  1.70868712e+01  8.69607033e+01
  8.69607033e+01  8.69607033e+01  1.82272637e+02  4.19347882e+02
  4.19347882e+02  4.19347882e+02  1.27310708e+03  1.27310708e+03
  1.27310708e+03  1.91384631e+03  2.97517802e+03  2.97517802e+03
  2.97517802e+03  6.60430944e+03  6.60430944e+03  6.60430944e+03
  8.27219572e+03  2.46599646e+04  7.54562817e+04]
E1 = -727.0117402910356  E_coul = 201.50608764556807
Extra cycle  E= -525.505652645468  delta_E= 2.27e-13  |g|= 1.5e-08  |ddm|= 1.09e-07
    CPU time for scf_cycle      3.15 sec, wall time      0.58 sec
exp = [2.61825079e+04 7.61825078e+03 3.61825078e+03 1.61825074e+03
 2.39783914e+02 5.18985039e+01 4.40483006e+00 4.45310374e-01
 1.14717279e-01 1.36279300e+03 6.65180724e+02 3.03320634e+02
 3.16146449e+02 4.93002501e+01 4.75505636e+00 1.47465450e+01
 3.73010995e-01 1.24218624e+00 2.23858315e-01]
grad_E = [-1.97850182e-06  2.16456321e-05  4.31606232e-05  6.63720017e-04
  9.92620859e-04 -8.17472120e-03 -2.29439207e-01 -1.49573010e-01
 -2.26269857e-01  1.35577357e-06  2.01937258e-05  1.09365730e-04
  9.63315846e-05 -1.26033789e-03 -7.65785109e-03  7.88240971e-03
 -3.52629330e-01  9.44212116e-02  3.04516320e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:39:02 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5078521        1
[INPUT] 0    0    [1    /1   ]  7618.25076084        1
[INPUT] 0    0    [1    /1   ]  3618.25073683        1
[INPUT] 0    0    [1    /1   ]  1618.25004431        1
[INPUT] 0    0    [1    /1   ]  239.782883941        1
[INPUT] 0    0    [1    /1   ]  51.906966765         1
[INPUT] 0    0    [1    /1   ]  4.64464072094        1
[INPUT] 0    0    [1    /1   ]  0.592134007067       1
[INPUT] 0    0    [1    /1   ]  0.357624764183       1
[INPUT] 1    0    [1    /1   ]  1362.79300172        1
[INPUT] 1    0    [1    /1   ]  665.180703181        1
[INPUT] 1    0    [1    /1   ]  303.3205196          1
[INPUT] 1    0    [1    /1   ]  316.146348371        1
[INPUT] 1    0    [1    /1   ]  49.3015839775        1
[INPUT] 1    0    [1    /1   ]  4.7643732424         1
[INPUT] 1    0    [1    /1   ]  14.7380402569        1
[INPUT] 1    0    [1    /1   ]  0.54339857217        1
[INPUT] 1    0    [1    /1   ]  1.17442658415        1
[INPUT] 1    0    [1    /1   ]  0.305246339608       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.507852136925, 1.0]], [0, [7618.250760837668, 1.0]], [0, [3618.2507368264155, 1.0]], [0, [1618.2500443104793, 1.0]], [0, [239.78288394110143, 1.0]], [0, [51.90696676498002, 1.0]], [0, [4.644640720941082, 1.0]], [0, [0.5921340070665098, 1.0]], [0, [0.35762476418333666, 1.0]], [1, [1362.793001720943, 1.0]], [1, [665.1807031810708, 1.0]], [1, [303.32051959966253, 1.0]], [1, [316.14634837072094, 1.0]], [1, [49.30158397753766, 1.0]], [1, [4.764373242399864, 1.0]], [1, [14.738040256864695, 1.0]], [1, [0.5433985721700607, 1.0]], [1, [1.1744265841452959, 1.0]], [1, [0.30524633960797887, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50785214]
bas 1, expnt(s) = [7618.25076084]
bas 2, expnt(s) = [3618.25073683]
bas 3, expnt(s) = [1618.25004431]
bas 4, expnt(s) = [239.78288394]
bas 5, expnt(s) = [51.90696676]
bas 6, expnt(s) = [4.64464072]
bas 7, expnt(s) = [0.59213401]
bas 8, expnt(s) = [0.35762476]
bas 9, expnt(s) = [1362.79300172]
bas 10, expnt(s) = [665.18070318]
bas 11, expnt(s) = [303.3205196]
bas 12, expnt(s) = [316.14634837]
bas 13, expnt(s) = [49.30158398]
bas 14, expnt(s) = [4.76437324]
bas 15, expnt(s) = [14.73804026]
bas 16, expnt(s) = [0.54339857]
bas 17, expnt(s) = [1.17442658]
bas 18, expnt(s) = [0.30524634]
CPU time:        28.97
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024082e+03 7.61825076e+03 2.06018619e+03
 3.61825074e+03 1.17866128e+03 1.61825004e+03 6.44613275e+02
 2.39782884e+02 1.53949633e+02 5.19069668e+01 4.88578400e+01
 4.64464072e+00 7.99335531e+00 5.92134007e-01 1.70541480e+00
 3.57624764e-01 1.16838430e+00 1.36279300e+03 2.41558187e+04
 6.65180703e+02 9.85505256e+03 3.03320520e+02 3.69284970e+03
 3.16146348e+02 3.88905965e+03 4.93015840e+01 3.81118897e+02
 4.76437324e+00 2.05348537e+01 1.47380403e+01 8.42430468e+01
 5.43398572e-01 1.36107642e+00 1.17442658e+00 3.56670125e+00
 3.05246340e-01 6.61907761e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.953551775055033
cond(S) = 83683.16689492218
E1 = -727.2141724739802  E_coul = 202.77488896222272
init E= -524.439283511757
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559199155465759  LUMO = 1.04314832497521
  mo_energy =
[-1.17931168e+02 -1.21498919e+01 -9.46984303e+00 -9.46984303e+00
 -9.46984303e+00 -1.23755517e+00 -5.59199155e-01 -5.59199155e-01
 -5.59199155e-01  1.04314832e+00  1.04314832e+00  1.04314832e+00
  1.36106581e+00  3.81329985e+00  3.81329985e+00  3.81329985e+00
  1.78447432e+01  1.78447432e+01  1.78447432e+01  8.75559396e+01
  8.75559396e+01  8.75559396e+01  1.84750888e+02  4.19882758e+02
  4.19882758e+02  4.19882758e+02  1.27365560e+03  1.27365560e+03
  1.27365560e+03  1.91587856e+03  2.97577961e+03  2.97577961e+03
  2.97577961e+03  6.60502055e+03  6.60502055e+03  6.60502055e+03
  8.27418404e+03  2.46619691e+04  7.54582887e+04]
E1 = -727.8264961073681  E_coul = 202.2381886707335
cycle= 1 E= -525.588307436635  delta_E= -1.15  |g|= 0.187  |ddm|= 1.01
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.458942
diis-c [-0.21062751  1.        ]
  HOMO = -0.542798832154092  LUMO = 1.06239996498061
  mo_energy =
[-1.18135904e+02 -1.21759288e+01 -9.50498712e+00 -9.50498712e+00
 -9.50498712e+00 -1.22001824e+00 -5.42798832e-01 -5.42798832e-01
 -5.42798832e-01  1.06239996e+00  1.06239996e+00  1.06239996e+00
  1.38023654e+00  3.82761088e+00  3.82761088e+00  3.82761088e+00
  1.78181087e+01  1.78181087e+01  1.78181087e+01  8.74549310e+01
  8.74549310e+01  8.74549310e+01  1.84603831e+02  4.19689239e+02
  4.19689239e+02  4.19689239e+02  1.27340270e+03  1.27340270e+03
  1.27340270e+03  1.91548412e+03  2.97545374e+03  2.97545374e+03
  2.97545374e+03  6.60456610e+03  6.60456610e+03  6.60456610e+03
  8.27363883e+03  2.46613242e+04  7.54575483e+04]
E1 = -727.9679139298833  E_coul = 202.3793214845311
cycle= 2 E= -525.588592445352  delta_E= -0.000285  |g|= 0.0145  |ddm|= 0.0629
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0237707
diis-c [-4.55575109e-04  2.23131673e-02  9.77686833e-01]
  HOMO = -0.541222753069863  LUMO = 1.06345776212516
  mo_energy =
[-1.18111470e+02 -1.21667004e+01 -9.49547366e+00 -9.49547366e+00
 -9.49547366e+00 -1.21795355e+00 -5.41222753e-01 -5.41222753e-01
 -5.41222753e-01  1.06345776e+00  1.06345776e+00  1.06345776e+00
  1.38251160e+00  3.83015525e+00  3.83015525e+00  3.83015525e+00
  1.78259234e+01  1.78259234e+01  1.78259234e+01  8.74717547e+01
  8.74717547e+01  8.74717547e+01  1.84627183e+02  4.19713382e+02
  4.19713382e+02  4.19713382e+02  1.27342892e+03  1.27342892e+03
  1.27342892e+03  1.91551162e+03  2.97548092e+03  2.97548092e+03
  2.97548092e+03  6.60459378e+03  6.60459378e+03  6.60459378e+03
  8.27366668e+03  2.46613520e+04  7.54575760e+04]
E1 = -727.9346204328896  E_coul = 202.34602252312658
cycle= 3 E= -525.588597909763  delta_E= -5.46e-06  |g|= 0.00217  |ddm|= 0.0118
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00405519
diis-c [-4.19135340e-07 -1.06940004e-03  1.36238727e-01  8.64830673e-01]
  HOMO = -0.541566353943402  LUMO = 1.06329971418355
  mo_energy =
[-1.18115091e+02 -1.21685372e+01 -9.49744513e+00 -9.49744513e+00
 -9.49744513e+00 -1.21829960e+00 -5.41566354e-01 -5.41566354e-01
 -5.41566354e-01  1.06329971e+00  1.06329971e+00  1.06329971e+00
  1.38219901e+00  3.82962145e+00  3.82962145e+00  3.82962145e+00
  1.78242860e+01  1.78242860e+01  1.78242860e+01  8.74689811e+01
  8.74689811e+01  8.74689811e+01  1.84623761e+02  4.19709804e+02
  4.19709804e+02  4.19709804e+02  1.27342509e+03  1.27342509e+03
  1.27342509e+03  1.91550752e+03  2.97547692e+03  2.97547692e+03
  2.97547692e+03  6.60458961e+03  6.60458961e+03  6.60458961e+03
  8.27366241e+03  2.46613477e+04  7.54575716e+04]
E1 = -727.941340545833  E_coul = 202.35274242566646
cycle= 4 E= -525.588598120167  delta_E= -2.1e-07  |g|= 0.000149  |ddm|= 0.0015
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=8.19779e-05
diis-c [-4.94789362e-09 -1.56619603e-05 -1.38584761e-03  2.93496220e-03
  9.98466547e-01]
  HOMO = -0.541506829141312  LUMO = 1.06333725749572
  mo_energy =
[-1.18114927e+02 -1.21683886e+01 -9.49730232e+00 -9.49730232e+00
 -9.49730232e+00 -1.21821189e+00 -5.41506829e-01 -5.41506829e-01
 -5.41506829e-01  1.06333726e+00  1.06333726e+00  1.06333726e+00
  1.38228565e+00  3.82970370e+00  3.82970370e+00  3.82970370e+00
  1.78244183e+01  1.78244183e+01  1.78244183e+01  8.74691365e+01
  8.74691365e+01  8.74691365e+01  1.84623926e+02  4.19709966e+02
  4.19709966e+02  4.19709966e+02  1.27342525e+03  1.27342525e+03
  1.27342525e+03  1.91550767e+03  2.97547707e+03  2.97547707e+03
  2.97547707e+03  6.60458975e+03  6.60458975e+03  6.60458975e+03
  8.27366255e+03  2.46613478e+04  7.54575718e+04]
E1 = -727.9409466972724  E_coul = 202.3523485731227
cycle= 5 E= -525.58859812415  delta_E= -3.98e-09  |g|= 2.74e-05  |ddm|= 0.000465
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.85733e-05
diis-c [-5.77792303e-11  1.60067019e-05 -2.18523362e-03 -2.15905022e-02
  5.25067496e-02  9.71252980e-01]
  HOMO = -0.541510863276746  LUMO = 1.06333627806759
  mo_energy =
[-1.18114955e+02 -1.21684070e+01 -9.49732328e+00 -9.49732328e+00
 -9.49732328e+00 -1.21821217e+00 -5.41510863e-01 -5.41510863e-01
 -5.41510863e-01  1.06333628e+00  1.06333628e+00  1.06333628e+00
  1.38228648e+00  3.82969840e+00  3.82969840e+00  3.82969840e+00
  1.78244010e+01  1.78244010e+01  1.78244010e+01  8.74691126e+01
  8.74691126e+01  8.74691126e+01  1.84623900e+02  4.19709939e+02
  4.19709939e+02  4.19709939e+02  1.27342522e+03  1.27342522e+03
  1.27342522e+03  1.91550764e+03  2.97547704e+03  2.97547704e+03
  2.97547704e+03  6.60458972e+03  6.60458972e+03  6.60458972e+03
  8.27366252e+03  2.46613478e+04  7.54575717e+04]
E1 = -727.9410111953955  E_coul = 202.3524130711103
cycle= 6 E= -525.588598124285  delta_E= -1.36e-10  |g|= 3.1e-06  |ddm|= 7.45e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -727.9410111953955  E_coul = 202.3524130711103
  HOMO = -0.541511655309013  LUMO = 1.06333594836559
  mo_energy =
[-1.18114958e+02 -1.21684093e+01 -9.49732587e+00 -9.49732587e+00
 -9.49732587e+00 -1.21821248e+00 -5.41511655e-01 -5.41511655e-01
 -5.41511655e-01  1.06333595e+00  1.06333595e+00  1.06333595e+00
  1.38228628e+00  3.82969743e+00  3.82969743e+00  3.82969743e+00
  1.78243988e+01  1.78243988e+01  1.78243988e+01  8.74691098e+01
  8.74691098e+01  8.74691098e+01  1.84623897e+02  4.19709936e+02
  4.19709936e+02  4.19709936e+02  1.27342522e+03  1.27342522e+03
  1.27342522e+03  1.91550764e+03  2.97547704e+03  2.97547704e+03
  2.97547704e+03  6.60458972e+03  6.60458972e+03  6.60458972e+03
  8.27366251e+03  2.46613478e+04  7.54575717e+04]
E1 = -727.9410180103051  E_coul = 202.352419886018
Extra cycle  E= -525.588598124287  delta_E= -1.93e-12  |g|= 6.68e-07  |ddm|= 8.37e-06
    CPU time for scf_cycle      0.64 sec, wall time      0.26 sec
exp = [2.61825079e+04 7.61825076e+03 3.61825074e+03 1.61825004e+03
 2.39782884e+02 5.19069668e+01 4.64464072e+00 5.92134007e-01
 3.57624764e-01 1.36279300e+03 6.65180703e+02 3.03320520e+02
 3.16146348e+02 4.93015840e+01 4.76437324e+00 1.47380403e+01
 5.43398572e-01 1.17442658e+00 3.05246340e-01]
E = -525.5885981242872
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:39:02 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5078521        1
[INPUT] 0    0    [1    /1   ]  7618.25076084        1
[INPUT] 0    0    [1    /1   ]  3618.25073683        1
[INPUT] 0    0    [1    /1   ]  1618.25004431        1
[INPUT] 0    0    [1    /1   ]  239.782883941        1
[INPUT] 0    0    [1    /1   ]  51.906966765         1
[INPUT] 0    0    [1    /1   ]  4.64464072094        1
[INPUT] 0    0    [1    /1   ]  0.592134007067       1
[INPUT] 0    0    [1    /1   ]  0.357624764183       1
[INPUT] 1    0    [1    /1   ]  1362.79300172        1
[INPUT] 1    0    [1    /1   ]  665.180703181        1
[INPUT] 1    0    [1    /1   ]  303.3205196          1
[INPUT] 1    0    [1    /1   ]  316.146348371        1
[INPUT] 1    0    [1    /1   ]  49.3015839775        1
[INPUT] 1    0    [1    /1   ]  4.7643732424         1
[INPUT] 1    0    [1    /1   ]  14.7380402569        1
[INPUT] 1    0    [1    /1   ]  0.54339857217        1
[INPUT] 1    0    [1    /1   ]  1.17442658415        1
[INPUT] 1    0    [1    /1   ]  0.305246339608       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.507852136925, 1.0]], [0, [7618.250760837668, 1.0]], [0, [3618.2507368264155, 1.0]], [0, [1618.2500443104793, 1.0]], [0, [239.78288394110143, 1.0]], [0, [51.90696676498002, 1.0]], [0, [4.644640720941082, 1.0]], [0, [0.5921340070665098, 1.0]], [0, [0.35762476418333666, 1.0]], [1, [1362.793001720943, 1.0]], [1, [665.1807031810708, 1.0]], [1, [303.32051959966253, 1.0]], [1, [316.14634837072094, 1.0]], [1, [49.30158397753766, 1.0]], [1, [4.764373242399864, 1.0]], [1, [14.738040256864695, 1.0]], [1, [0.5433985721700607, 1.0]], [1, [1.1744265841452959, 1.0]], [1, [0.30524633960797887, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50785214]
bas 1, expnt(s) = [7618.25076084]
bas 2, expnt(s) = [3618.25073683]
bas 3, expnt(s) = [1618.25004431]
bas 4, expnt(s) = [239.78288394]
bas 5, expnt(s) = [51.90696676]
bas 6, expnt(s) = [4.64464072]
bas 7, expnt(s) = [0.59213401]
bas 8, expnt(s) = [0.35762476]
bas 9, expnt(s) = [1362.79300172]
bas 10, expnt(s) = [665.18070318]
bas 11, expnt(s) = [303.3205196]
bas 12, expnt(s) = [316.14634837]
bas 13, expnt(s) = [49.30158398]
bas 14, expnt(s) = [4.76437324]
bas 15, expnt(s) = [14.73804026]
bas 16, expnt(s) = [0.54339857]
bas 17, expnt(s) = [1.17442658]
bas 18, expnt(s) = [0.30524634]
CPU time:        29.66
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024082e+03 7.61825076e+03 2.06018619e+03
 3.61825074e+03 1.17866128e+03 1.61825004e+03 6.44613275e+02
 2.39782884e+02 1.53949633e+02 5.19069668e+01 4.88578400e+01
 4.64464072e+00 7.99335531e+00 5.92134007e-01 1.70541480e+00
 3.57624764e-01 1.16838430e+00 1.36279300e+03 2.41558187e+04
 6.65180703e+02 9.85505256e+03 3.03320520e+02 3.69284970e+03
 3.16146348e+02 3.88905965e+03 4.93015840e+01 3.81118897e+02
 4.76437324e+00 2.05348537e+01 1.47380403e+01 8.42430468e+01
 5.43398572e-01 1.36107642e+00 1.17442658e+00 3.56670125e+00
 3.05246340e-01 6.61907761e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.953551775055033
cond(S) = 83683.16689492218
E1 = -727.2141724739802  E_coul = 202.77488896222272
init E= -524.439283511757
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559199155465759  LUMO = 1.04314832497521
  mo_energy =
[-1.17931168e+02 -1.21498919e+01 -9.46984303e+00 -9.46984303e+00
 -9.46984303e+00 -1.23755517e+00 -5.59199155e-01 -5.59199155e-01
 -5.59199155e-01  1.04314832e+00  1.04314832e+00  1.04314832e+00
  1.36106581e+00  3.81329985e+00  3.81329985e+00  3.81329985e+00
  1.78447432e+01  1.78447432e+01  1.78447432e+01  8.75559396e+01
  8.75559396e+01  8.75559396e+01  1.84750888e+02  4.19882758e+02
  4.19882758e+02  4.19882758e+02  1.27365560e+03  1.27365560e+03
  1.27365560e+03  1.91587856e+03  2.97577961e+03  2.97577961e+03
  2.97577961e+03  6.60502055e+03  6.60502055e+03  6.60502055e+03
  8.27418404e+03  2.46619691e+04  7.54582887e+04]
E1 = -727.8264961073681  E_coul = 202.2381886707335
cycle= 1 E= -525.588307436635  delta_E= -1.15  |g|= 0.187  |ddm|= 1.01
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.458942
diis-c [-0.21062751  1.        ]
  HOMO = -0.542798832154092  LUMO = 1.06239996498061
  mo_energy =
[-1.18135904e+02 -1.21759288e+01 -9.50498712e+00 -9.50498712e+00
 -9.50498712e+00 -1.22001824e+00 -5.42798832e-01 -5.42798832e-01
 -5.42798832e-01  1.06239996e+00  1.06239996e+00  1.06239996e+00
  1.38023654e+00  3.82761088e+00  3.82761088e+00  3.82761088e+00
  1.78181087e+01  1.78181087e+01  1.78181087e+01  8.74549310e+01
  8.74549310e+01  8.74549310e+01  1.84603831e+02  4.19689239e+02
  4.19689239e+02  4.19689239e+02  1.27340270e+03  1.27340270e+03
  1.27340270e+03  1.91548412e+03  2.97545374e+03  2.97545374e+03
  2.97545374e+03  6.60456610e+03  6.60456610e+03  6.60456610e+03
  8.27363883e+03  2.46613242e+04  7.54575483e+04]
E1 = -727.9679139298833  E_coul = 202.3793214845311
cycle= 2 E= -525.588592445352  delta_E= -0.000285  |g|= 0.0145  |ddm|= 0.0629
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0237707
diis-c [-4.55575109e-04  2.23131673e-02  9.77686833e-01]
  HOMO = -0.541222753069863  LUMO = 1.06345776212516
  mo_energy =
[-1.18111470e+02 -1.21667004e+01 -9.49547366e+00 -9.49547366e+00
 -9.49547366e+00 -1.21795355e+00 -5.41222753e-01 -5.41222753e-01
 -5.41222753e-01  1.06345776e+00  1.06345776e+00  1.06345776e+00
  1.38251160e+00  3.83015525e+00  3.83015525e+00  3.83015525e+00
  1.78259234e+01  1.78259234e+01  1.78259234e+01  8.74717547e+01
  8.74717547e+01  8.74717547e+01  1.84627183e+02  4.19713382e+02
  4.19713382e+02  4.19713382e+02  1.27342892e+03  1.27342892e+03
  1.27342892e+03  1.91551162e+03  2.97548092e+03  2.97548092e+03
  2.97548092e+03  6.60459378e+03  6.60459378e+03  6.60459378e+03
  8.27366668e+03  2.46613520e+04  7.54575760e+04]
E1 = -727.9346204328896  E_coul = 202.34602252312658
cycle= 3 E= -525.588597909763  delta_E= -5.46e-06  |g|= 0.00217  |ddm|= 0.0118
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00405519
diis-c [-4.19135340e-07 -1.06940004e-03  1.36238727e-01  8.64830673e-01]
  HOMO = -0.541566353943402  LUMO = 1.06329971418355
  mo_energy =
[-1.18115091e+02 -1.21685372e+01 -9.49744513e+00 -9.49744513e+00
 -9.49744513e+00 -1.21829960e+00 -5.41566354e-01 -5.41566354e-01
 -5.41566354e-01  1.06329971e+00  1.06329971e+00  1.06329971e+00
  1.38219901e+00  3.82962145e+00  3.82962145e+00  3.82962145e+00
  1.78242860e+01  1.78242860e+01  1.78242860e+01  8.74689811e+01
  8.74689811e+01  8.74689811e+01  1.84623761e+02  4.19709804e+02
  4.19709804e+02  4.19709804e+02  1.27342509e+03  1.27342509e+03
  1.27342509e+03  1.91550752e+03  2.97547692e+03  2.97547692e+03
  2.97547692e+03  6.60458961e+03  6.60458961e+03  6.60458961e+03
  8.27366241e+03  2.46613477e+04  7.54575716e+04]
E1 = -727.941340545833  E_coul = 202.35274242566646
cycle= 4 E= -525.588598120167  delta_E= -2.1e-07  |g|= 0.000149  |ddm|= 0.0015
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=8.19779e-05
diis-c [-4.94789362e-09 -1.56619603e-05 -1.38584761e-03  2.93496220e-03
  9.98466547e-01]
  HOMO = -0.541506829141312  LUMO = 1.06333725749572
  mo_energy =
[-1.18114927e+02 -1.21683886e+01 -9.49730232e+00 -9.49730232e+00
 -9.49730232e+00 -1.21821189e+00 -5.41506829e-01 -5.41506829e-01
 -5.41506829e-01  1.06333726e+00  1.06333726e+00  1.06333726e+00
  1.38228565e+00  3.82970370e+00  3.82970370e+00  3.82970370e+00
  1.78244183e+01  1.78244183e+01  1.78244183e+01  8.74691365e+01
  8.74691365e+01  8.74691365e+01  1.84623926e+02  4.19709966e+02
  4.19709966e+02  4.19709966e+02  1.27342525e+03  1.27342525e+03
  1.27342525e+03  1.91550767e+03  2.97547707e+03  2.97547707e+03
  2.97547707e+03  6.60458975e+03  6.60458975e+03  6.60458975e+03
  8.27366255e+03  2.46613478e+04  7.54575718e+04]
E1 = -727.9409466972724  E_coul = 202.3523485731227
cycle= 5 E= -525.58859812415  delta_E= -3.98e-09  |g|= 2.74e-05  |ddm|= 0.000465
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.85733e-05
diis-c [-5.77792303e-11  1.60067019e-05 -2.18523362e-03 -2.15905022e-02
  5.25067496e-02  9.71252980e-01]
  HOMO = -0.541510863276746  LUMO = 1.06333627806759
  mo_energy =
[-1.18114955e+02 -1.21684070e+01 -9.49732328e+00 -9.49732328e+00
 -9.49732328e+00 -1.21821217e+00 -5.41510863e-01 -5.41510863e-01
 -5.41510863e-01  1.06333628e+00  1.06333628e+00  1.06333628e+00
  1.38228648e+00  3.82969840e+00  3.82969840e+00  3.82969840e+00
  1.78244010e+01  1.78244010e+01  1.78244010e+01  8.74691126e+01
  8.74691126e+01  8.74691126e+01  1.84623900e+02  4.19709939e+02
  4.19709939e+02  4.19709939e+02  1.27342522e+03  1.27342522e+03
  1.27342522e+03  1.91550764e+03  2.97547704e+03  2.97547704e+03
  2.97547704e+03  6.60458972e+03  6.60458972e+03  6.60458972e+03
  8.27366252e+03  2.46613478e+04  7.54575717e+04]
E1 = -727.9410111953955  E_coul = 202.3524130711103
cycle= 6 E= -525.588598124285  delta_E= -1.36e-10  |g|= 3.1e-06  |ddm|= 7.45e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -727.9410111953955  E_coul = 202.3524130711103
  HOMO = -0.541511655309013  LUMO = 1.06333594836559
  mo_energy =
[-1.18114958e+02 -1.21684093e+01 -9.49732587e+00 -9.49732587e+00
 -9.49732587e+00 -1.21821248e+00 -5.41511655e-01 -5.41511655e-01
 -5.41511655e-01  1.06333595e+00  1.06333595e+00  1.06333595e+00
  1.38228628e+00  3.82969743e+00  3.82969743e+00  3.82969743e+00
  1.78243988e+01  1.78243988e+01  1.78243988e+01  8.74691098e+01
  8.74691098e+01  8.74691098e+01  1.84623897e+02  4.19709936e+02
  4.19709936e+02  4.19709936e+02  1.27342522e+03  1.27342522e+03
  1.27342522e+03  1.91550764e+03  2.97547704e+03  2.97547704e+03
  2.97547704e+03  6.60458972e+03  6.60458972e+03  6.60458972e+03
  8.27366251e+03  2.46613478e+04  7.54575717e+04]
E1 = -727.9410180103051  E_coul = 202.352419886018
Extra cycle  E= -525.588598124287  delta_E= -1.93e-12  |g|= 6.68e-07  |ddm|= 8.37e-06
    CPU time for scf_cycle      0.64 sec, wall time      0.26 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 83683.16689492218
E1 = -727.9410180103051  E_coul = 202.352419886018
init E= -525.588598124287
    CPU time for initialize scf      2.75 sec, wall time      0.25 sec
  HOMO = -0.541511537517172  LUMO = 1.06333602725267
  mo_energy =
[-1.18114957e+02 -1.21684088e+01 -9.49732538e+00 -9.49732538e+00
 -9.49732538e+00 -1.21821223e+00 -5.41511538e-01 -5.41511538e-01
 -5.41511538e-01  1.06333603e+00  1.06333603e+00  1.06333603e+00
  1.38228653e+00  3.82969762e+00  3.82969762e+00  3.82969762e+00
  1.78243992e+01  1.78243992e+01  1.78243992e+01  8.74691104e+01
  8.74691104e+01  8.74691104e+01  1.84623898e+02  4.19709937e+02
  4.19709937e+02  4.19709937e+02  1.27342522e+03  1.27342522e+03
  1.27342522e+03  1.91550764e+03  2.97547704e+03  2.97547704e+03
  2.97547704e+03  6.60458972e+03  6.60458972e+03  6.60458972e+03
  8.27366251e+03  2.46613478e+04  7.54575717e+04]
E1 = -727.9410162642864  E_coul = 202.3524181399985
cycle= 1 E= -525.588598124288  delta_E= -7.96e-13  |g|= 1.41e-07  |ddm|= 2.08e-06
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.9410162642864  E_coul = 202.3524181399985
  HOMO = -0.541511571347979  LUMO = 1.06333601292002
  mo_energy =
[-1.18114958e+02 -1.21684089e+01 -9.49732551e+00 -9.49732551e+00
 -9.49732551e+00 -1.21821224e+00 -5.41511571e-01 -5.41511571e-01
 -5.41511571e-01  1.06333601e+00  1.06333601e+00  1.06333601e+00
  1.38228651e+00  3.82969758e+00  3.82969758e+00  3.82969758e+00
  1.78243991e+01  1.78243991e+01  1.78243991e+01  8.74691102e+01
  8.74691102e+01  8.74691102e+01  1.84623897e+02  4.19709936e+02
  4.19709936e+02  4.19709936e+02  1.27342522e+03  1.27342522e+03
  1.27342522e+03  1.91550764e+03  2.97547704e+03  2.97547704e+03
  2.97547704e+03  6.60458972e+03  6.60458972e+03  6.60458972e+03
  8.27366251e+03  2.46613478e+04  7.54575717e+04]
E1 = -727.9410166755114  E_coul = 202.3524185512248
Extra cycle  E= -525.588598124287  delta_E= 1.36e-12  |g|= 3.16e-08  |ddm|= 2.95e-07
    CPU time for scf_cycle      3.08 sec, wall time      0.58 sec
exp = [2.61825079e+04 7.61825076e+03 3.61825074e+03 1.61825004e+03
 2.39782884e+02 5.19069668e+01 4.64464072e+00 5.92134007e-01
 3.57624764e-01 1.36279300e+03 6.65180703e+02 3.03320520e+02
 3.16146348e+02 4.93015840e+01 4.76437324e+00 1.47380403e+01
 5.43398572e-01 1.17442658e+00 3.05246340e-01]
grad_E = [-1.98042830e-06  2.15742214e-05  4.29093410e-05  6.60913829e-04
  1.25636582e-03 -1.25274263e-02 -1.42216042e-01 -1.46492207e-01
  2.29697375e-02  1.35648348e-06  2.01890927e-05  1.09363490e-04
  9.63283240e-05 -1.31125619e-03 -2.19087590e-02  9.37321648e-03
 -4.60949294e-02  2.15099733e-02  5.53779142e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:39:07 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5078559        1
[INPUT] 0    0    [1    /1   ]  7618.2507199         1
[INPUT] 0    0    [1    /1   ]  3618.25065531        1
[INPUT] 0    0    [1    /1   ]  1618.24878955        1
[INPUT] 0    0    [1    /1   ]  239.780719999        1
[INPUT] 0    0    [1    /1   ]  51.9271275193        1
[INPUT] 0    0    [1    /1   ]  4.98602646659        1
[INPUT] 0    0    [1    /1   ]  0.855858908457       1
[INPUT] 0    0    [1    /1   ]  0.527869959171       1
[INPUT] 1    0    [1    /1   ]  1362.79299915        1
[INPUT] 1    0    [1    /1   ]  665.180664874        1
[INPUT] 1    0    [1    /1   ]  303.32031208         1
[INPUT] 1    0    [1    /1   ]  316.146165584        1
[INPUT] 1    0    [1    /1   ]  49.3040686797        1
[INPUT] 1    0    [1    /1   ]  4.79693535639        1
[INPUT] 1    0    [1    /1   ]  14.7209198492        1
[INPUT] 1    0    [1    /1   ]  0.437161033504       1
[INPUT] 1    0    [1    /1   ]  1.1314798653         1
[INPUT] 1    0    [1    /1   ]  0.191546754824       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.507855888303, 1.0]], [0, [7618.250719895217, 1.0]], [0, [3618.250655305374, 1.0]], [0, [1618.2487895533036, 1.0]], [0, [239.78071999949262, 1.0]], [0, [51.92712751928125, 1.0]], [0, [4.98602646659169, 1.0]], [0, [0.8558589084572419, 1.0]], [0, [0.5278699591707149, 1.0]], [1, [1362.7929991450633, 1.0]], [1, [665.18066487419, 1.0]], [1, [303.3203120796518, 1.0]], [1, [316.1461655842868, 1.0]], [1, [49.304068679659835, 1.0]], [1, [4.796935356387947, 1.0]], [1, [14.720919849239184, 1.0]], [1, [0.4371610335037231, 1.0]], [1, [1.1314798653001925, 1.0]], [1, [0.19154675482356692, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50785589]
bas 1, expnt(s) = [7618.2507199]
bas 2, expnt(s) = [3618.25065531]
bas 3, expnt(s) = [1618.24878955]
bas 4, expnt(s) = [239.78072]
bas 5, expnt(s) = [51.92712752]
bas 6, expnt(s) = [4.98602647]
bas 7, expnt(s) = [0.85585891]
bas 8, expnt(s) = [0.52786996]
bas 9, expnt(s) = [1362.79299915]
bas 10, expnt(s) = [665.18066487]
bas 11, expnt(s) = [303.32031208]
bas 12, expnt(s) = [316.14616558]
bas 13, expnt(s) = [49.30406868]
bas 14, expnt(s) = [4.79693536]
bas 15, expnt(s) = [14.72091985]
bas 16, expnt(s) = [0.43716103]
bas 17, expnt(s) = [1.13147987]
bas 18, expnt(s) = [0.19154675]
CPU time:        37.97
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024082e+03 7.61825072e+03 2.06018618e+03
 3.61825066e+03 1.17866127e+03 1.61824879e+03 6.44612900e+02
 2.39780720e+02 1.53948591e+02 5.19271275e+01 4.88720716e+01
 4.98602647e+00 8.43006569e+00 8.55858908e-01 2.24810533e+00
 5.27869959e-01 1.56462489e+00 1.36279300e+03 2.41558186e+04
 6.65180665e+02 9.85505185e+03 3.03320312e+02 3.69284654e+03
 3.16146166e+02 3.88905684e+03 4.93040687e+01 3.81142907e+02
 4.79693536e+00 2.07104352e+01 1.47209198e+01 8.41207387e+01
 4.37161034e-01 1.03701777e+00 1.13147987e+00 3.40441841e+00
 1.91546755e-01 3.69681647e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.961183031079514
cond(S) = 83490.18816090665
E1 = -727.5508229904716  E_coul = 202.8371969387276
init E= -524.713626051744
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.563196109417219  LUMO = 0.651158304999715
  mo_energy =
[-1.17941424e+02 -1.21732215e+01 -9.46613310e+00 -9.46613310e+00
 -9.46613310e+00 -1.20849310e+00 -5.63196109e-01 -5.63196109e-01
 -5.63196109e-01  6.51158305e-01  6.51158305e-01  6.51158305e-01
  2.58289722e+00  2.94023968e+00  2.94023968e+00  2.94023968e+00
  1.69594571e+01  1.69594571e+01  1.69594571e+01  8.69603343e+01
  8.69603343e+01  8.69603343e+01  1.87769866e+02  4.19484468e+02
  4.19484468e+02  4.19484468e+02  1.27332125e+03  1.27332125e+03
  1.27332125e+03  1.91801926e+03  2.97547353e+03  2.97547353e+03
  2.97547353e+03  6.60474364e+03  6.60474364e+03  6.60474364e+03
  8.27606268e+03  2.46637335e+04  7.54599264e+04]
E1 = -727.7267747256369  E_coul = 202.06568396410083
cycle= 1 E= -525.661090761536  delta_E= -0.947  |g|= 0.175  |ddm|= 0.788
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.442511
diis-c [-0.19581582  1.        ]
  HOMO = -0.558178729302798  LUMO = 0.660360489673933
  mo_energy =
[-1.18148774e+02 -1.22141107e+01 -9.51420707e+00 -9.51420707e+00
 -9.51420707e+00 -1.21784848e+00 -5.58178729e-01 -5.58178729e-01
 -5.58178729e-01  6.60360490e-01  6.60360490e-01  6.60360490e-01
  2.57330966e+00  2.93963317e+00  2.93963317e+00  2.93963317e+00
  1.69187800e+01  1.69187800e+01  1.69187800e+01  8.68501087e+01
  8.68501087e+01  8.68501087e+01  1.87609699e+02  4.19285166e+02
  4.19285166e+02  4.19285166e+02  1.27306390e+03  1.27306390e+03
  1.27306390e+03  1.91762342e+03  2.97514494e+03  2.97514494e+03
  2.97514494e+03  6.60428891e+03  6.60428891e+03  6.60428891e+03
  8.27551880e+03  2.46630914e+04  7.54591899e+04]
E1 = -727.8853076173984  E_coul = 202.22384863111404
cycle= 2 E= -525.661458986284  delta_E= -0.000368  |g|= 0.0166  |ddm|= 0.204
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0301947
diis-c [-7.30296815e-04  2.95927256e-02  9.70407274e-01]
  HOMO = -0.556947575450371  LUMO = 0.660686728404927
  mo_energy =
[-1.18121746e+02 -1.22034771e+01 -9.50263378e+00 -9.50263378e+00
 -9.50263378e+00 -1.21718395e+00 -5.56947575e-01 -5.56947575e-01
 -5.56947575e-01  6.60686728e-01  6.60686728e-01  6.60686728e-01
  2.57480565e+00  2.94152310e+00  2.94152310e+00  2.94152310e+00
  1.69282037e+01  1.69282037e+01  1.69282037e+01  8.68692070e+01
  8.68692070e+01  8.68692070e+01  1.87635233e+02  4.19311860e+02
  4.19311860e+02  4.19311860e+02  1.27309293e+03  1.27309293e+03
  1.27309293e+03  1.91765433e+03  2.97517524e+03  2.97517524e+03
  2.97517524e+03  6.60432017e+03  6.60432017e+03  6.60432017e+03
  8.27555054e+03  2.46631234e+04  7.54592219e+04]
E1 = -727.8370318837409  E_coul = 202.17556173024326
cycle= 3 E= -525.661470153498  delta_E= -1.12e-05  |g|= 0.00294  |ddm|= 0.0156
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00440489
diis-c [-3.66500198e-07 -7.89609505e-04  1.22034850e-01  8.78754760e-01]
  HOMO = -0.557642187302946  LUMO = 0.660400631424929
  mo_energy =
[-1.18126494e+02 -1.22061696e+01 -9.50538996e+00 -9.50538996e+00
 -9.50538996e+00 -1.21820489e+00 -5.57642187e-01 -5.57642187e-01
 -5.57642187e-01  6.60400631e-01  6.60400631e-01  6.60400631e-01
  2.57344905e+00  2.94054551e+00  2.94054551e+00  2.94054551e+00
  1.69258010e+01  1.69258010e+01  1.69258010e+01  8.68654511e+01
  8.68654511e+01  8.68654511e+01  1.87630681e+02  4.19307155e+02
  4.19307155e+02  4.19307155e+02  1.27308796e+03  1.27308796e+03
  1.27308796e+03  1.91764915e+03  2.97517013e+03  2.97517013e+03
  2.97517013e+03  6.60431494e+03  6.60431494e+03  6.60431494e+03
  8.27554524e+03  2.46631181e+04  7.54592165e+04]
E1 = -727.8464839599479  E_coul = 202.18501330071086
cycle= 4 E= -525.661470659237  delta_E= -5.06e-07  |g|= 0.000326  |ddm|= 0.00767
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000483364
diis-c [-3.35244795e-08  3.31879359e-05 -1.08277710e-02  2.47977199e-02
  9.85996863e-01]
  HOMO = -0.557597770062128  LUMO = 0.660407882554562
  mo_energy =
[-1.18126172e+02 -1.22059580e+01 -9.50514682e+00 -9.50514682e+00
 -9.50514682e+00 -1.21819397e+00 -5.57597770e-01 -5.57597770e-01
 -5.57597770e-01  6.60407883e-01  6.60407883e-01  6.60407883e-01
  2.57346500e+00  2.94059914e+00  2.94059914e+00  2.94059914e+00
  1.69260059e+01  1.69260059e+01  1.69260059e+01  8.68657287e+01
  8.68657287e+01  8.68657287e+01  1.87630984e+02  4.19307473e+02
  4.19307473e+02  4.19307473e+02  1.27308830e+03  1.27308830e+03
  1.27308830e+03  1.91764951e+03  2.97517048e+03  2.97517048e+03
  2.97517048e+03  6.60431531e+03  6.60431531e+03  6.60431531e+03
  8.27554562e+03  2.46631185e+04  7.54592169e+04]
E1 = -727.8454371895144  E_coul = 202.18396651370355
cycle= 5 E= -525.661470675811  delta_E= -1.66e-08  |g|= 4.65e-05  |ddm|= 0.00115
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.09973e-05
diis-c [-1.11509251e-10  2.09103876e-05 -2.66937785e-03 -1.75786215e-02
 -1.23222826e-02  1.03254937e+00]
  HOMO = -0.557610705903108  LUMO = 0.660401405940377
  mo_energy =
[-1.18126195e+02 -1.22059852e+01 -9.50516997e+00 -9.50516997e+00
 -9.50516997e+00 -1.21821729e+00 -5.57610706e-01 -5.57610706e-01
 -5.57610706e-01  6.60401406e-01  6.60401406e-01  6.60401406e-01
  2.57343617e+00  2.94058172e+00  2.94058172e+00  2.94058172e+00
  1.69259832e+01  1.69259832e+01  1.69259832e+01  8.68657051e+01
  8.68657051e+01  8.68657051e+01  1.87630960e+02  4.19307450e+02
  4.19307450e+02  4.19307450e+02  1.27308828e+03  1.27308828e+03
  1.27308828e+03  1.91764950e+03  2.97517046e+03  2.97517046e+03
  2.97517046e+03  6.60431529e+03  6.60431529e+03  6.60431529e+03
  8.27554561e+03  2.46631184e+04  7.54592169e+04]
E1 = -727.845476393351  E_coul = 202.18400571719604
cycle= 6 E= -525.661470676155  delta_E= -3.44e-10  |g|= 1.8e-06  |ddm|= 0.000262
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -727.845476393351  E_coul = 202.18400571719604
  HOMO = -0.557610718571523  LUMO = 0.660401329046247
  mo_energy =
[-1.18126192e+02 -1.22059842e+01 -9.50516875e+00 -9.50516875e+00
 -9.50516875e+00 -1.21821742e+00 -5.57610719e-01 -5.57610719e-01
 -5.57610719e-01  6.60401329e-01  6.60401329e-01  6.60401329e-01
  2.57343608e+00  2.94058175e+00  2.94058175e+00  2.94058175e+00
  1.69259842e+01  1.69259842e+01  1.69259842e+01  8.68657068e+01
  8.68657068e+01  8.68657068e+01  1.87630962e+02  4.19307452e+02
  4.19307452e+02  4.19307452e+02  1.27308828e+03  1.27308828e+03
  1.27308828e+03  1.91764950e+03  2.97517046e+03  2.97517046e+03
  2.97517046e+03  6.60431530e+03  6.60431530e+03  6.60431530e+03
  8.27554561e+03  2.46631184e+04  7.54592169e+04]
E1 = -727.8454702097922  E_coul = 202.18399953363752
Extra cycle  E= -525.661470676155  delta_E= 2.27e-13  |g|= 4.11e-07  |ddm|= 4.48e-06
    CPU time for scf_cycle      0.64 sec, wall time      0.25 sec
exp = [2.61825079e+04 7.61825072e+03 3.61825066e+03 1.61824879e+03
 2.39780720e+02 5.19271275e+01 4.98602647e+00 8.55858908e-01
 5.27869959e-01 1.36279300e+03 6.65180665e+02 3.03320312e+02
 3.16146166e+02 4.93040687e+01 4.79693536e+00 1.47209198e+01
 4.37161034e-01 1.13147987e+00 1.91546755e-01]
E = -525.6614706761547
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:39:07 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5078559        1
[INPUT] 0    0    [1    /1   ]  7618.2507199         1
[INPUT] 0    0    [1    /1   ]  3618.25065531        1
[INPUT] 0    0    [1    /1   ]  1618.24878955        1
[INPUT] 0    0    [1    /1   ]  239.780719999        1
[INPUT] 0    0    [1    /1   ]  51.9271275193        1
[INPUT] 0    0    [1    /1   ]  4.98602646659        1
[INPUT] 0    0    [1    /1   ]  0.855858908457       1
[INPUT] 0    0    [1    /1   ]  0.527869959171       1
[INPUT] 1    0    [1    /1   ]  1362.79299915        1
[INPUT] 1    0    [1    /1   ]  665.180664874        1
[INPUT] 1    0    [1    /1   ]  303.32031208         1
[INPUT] 1    0    [1    /1   ]  316.146165584        1
[INPUT] 1    0    [1    /1   ]  49.3040686797        1
[INPUT] 1    0    [1    /1   ]  4.79693535639        1
[INPUT] 1    0    [1    /1   ]  14.7209198492        1
[INPUT] 1    0    [1    /1   ]  0.437161033504       1
[INPUT] 1    0    [1    /1   ]  1.1314798653         1
[INPUT] 1    0    [1    /1   ]  0.191546754824       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.507855888303, 1.0]], [0, [7618.250719895217, 1.0]], [0, [3618.250655305374, 1.0]], [0, [1618.2487895533036, 1.0]], [0, [239.78071999949262, 1.0]], [0, [51.92712751928125, 1.0]], [0, [4.98602646659169, 1.0]], [0, [0.8558589084572419, 1.0]], [0, [0.5278699591707149, 1.0]], [1, [1362.7929991450633, 1.0]], [1, [665.18066487419, 1.0]], [1, [303.3203120796518, 1.0]], [1, [316.1461655842868, 1.0]], [1, [49.304068679659835, 1.0]], [1, [4.796935356387947, 1.0]], [1, [14.720919849239184, 1.0]], [1, [0.4371610335037231, 1.0]], [1, [1.1314798653001925, 1.0]], [1, [0.19154675482356692, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50785589]
bas 1, expnt(s) = [7618.2507199]
bas 2, expnt(s) = [3618.25065531]
bas 3, expnt(s) = [1618.24878955]
bas 4, expnt(s) = [239.78072]
bas 5, expnt(s) = [51.92712752]
bas 6, expnt(s) = [4.98602647]
bas 7, expnt(s) = [0.85585891]
bas 8, expnt(s) = [0.52786996]
bas 9, expnt(s) = [1362.79299915]
bas 10, expnt(s) = [665.18066487]
bas 11, expnt(s) = [303.32031208]
bas 12, expnt(s) = [316.14616558]
bas 13, expnt(s) = [49.30406868]
bas 14, expnt(s) = [4.79693536]
bas 15, expnt(s) = [14.72091985]
bas 16, expnt(s) = [0.43716103]
bas 17, expnt(s) = [1.13147987]
bas 18, expnt(s) = [0.19154675]
CPU time:        38.66
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024082e+03 7.61825072e+03 2.06018618e+03
 3.61825066e+03 1.17866127e+03 1.61824879e+03 6.44612900e+02
 2.39780720e+02 1.53948591e+02 5.19271275e+01 4.88720716e+01
 4.98602647e+00 8.43006569e+00 8.55858908e-01 2.24810533e+00
 5.27869959e-01 1.56462489e+00 1.36279300e+03 2.41558186e+04
 6.65180665e+02 9.85505185e+03 3.03320312e+02 3.69284654e+03
 3.16146166e+02 3.88905684e+03 4.93040687e+01 3.81142907e+02
 4.79693536e+00 2.07104352e+01 1.47209198e+01 8.41207387e+01
 4.37161034e-01 1.03701777e+00 1.13147987e+00 3.40441841e+00
 1.91546755e-01 3.69681647e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.961183031079514
cond(S) = 83490.18816090665
E1 = -727.5508229904716  E_coul = 202.8371969387276
init E= -524.713626051744
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.563196109417219  LUMO = 0.651158304999715
  mo_energy =
[-1.17941424e+02 -1.21732215e+01 -9.46613310e+00 -9.46613310e+00
 -9.46613310e+00 -1.20849310e+00 -5.63196109e-01 -5.63196109e-01
 -5.63196109e-01  6.51158305e-01  6.51158305e-01  6.51158305e-01
  2.58289722e+00  2.94023968e+00  2.94023968e+00  2.94023968e+00
  1.69594571e+01  1.69594571e+01  1.69594571e+01  8.69603343e+01
  8.69603343e+01  8.69603343e+01  1.87769866e+02  4.19484468e+02
  4.19484468e+02  4.19484468e+02  1.27332125e+03  1.27332125e+03
  1.27332125e+03  1.91801926e+03  2.97547353e+03  2.97547353e+03
  2.97547353e+03  6.60474364e+03  6.60474364e+03  6.60474364e+03
  8.27606268e+03  2.46637335e+04  7.54599264e+04]
E1 = -727.7267747256369  E_coul = 202.06568396410083
cycle= 1 E= -525.661090761536  delta_E= -0.947  |g|= 0.175  |ddm|= 0.788
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.442511
diis-c [-0.19581582  1.        ]
  HOMO = -0.558178729302798  LUMO = 0.660360489673933
  mo_energy =
[-1.18148774e+02 -1.22141107e+01 -9.51420707e+00 -9.51420707e+00
 -9.51420707e+00 -1.21784848e+00 -5.58178729e-01 -5.58178729e-01
 -5.58178729e-01  6.60360490e-01  6.60360490e-01  6.60360490e-01
  2.57330966e+00  2.93963317e+00  2.93963317e+00  2.93963317e+00
  1.69187800e+01  1.69187800e+01  1.69187800e+01  8.68501087e+01
  8.68501087e+01  8.68501087e+01  1.87609699e+02  4.19285166e+02
  4.19285166e+02  4.19285166e+02  1.27306390e+03  1.27306390e+03
  1.27306390e+03  1.91762342e+03  2.97514494e+03  2.97514494e+03
  2.97514494e+03  6.60428891e+03  6.60428891e+03  6.60428891e+03
  8.27551880e+03  2.46630914e+04  7.54591899e+04]
E1 = -727.8853076173984  E_coul = 202.22384863111404
cycle= 2 E= -525.661458986284  delta_E= -0.000368  |g|= 0.0166  |ddm|= 0.204
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0301947
diis-c [-7.30296815e-04  2.95927256e-02  9.70407274e-01]
  HOMO = -0.556947575450371  LUMO = 0.660686728404927
  mo_energy =
[-1.18121746e+02 -1.22034771e+01 -9.50263378e+00 -9.50263378e+00
 -9.50263378e+00 -1.21718395e+00 -5.56947575e-01 -5.56947575e-01
 -5.56947575e-01  6.60686728e-01  6.60686728e-01  6.60686728e-01
  2.57480565e+00  2.94152310e+00  2.94152310e+00  2.94152310e+00
  1.69282037e+01  1.69282037e+01  1.69282037e+01  8.68692070e+01
  8.68692070e+01  8.68692070e+01  1.87635233e+02  4.19311860e+02
  4.19311860e+02  4.19311860e+02  1.27309293e+03  1.27309293e+03
  1.27309293e+03  1.91765433e+03  2.97517524e+03  2.97517524e+03
  2.97517524e+03  6.60432017e+03  6.60432017e+03  6.60432017e+03
  8.27555054e+03  2.46631234e+04  7.54592219e+04]
E1 = -727.8370318837409  E_coul = 202.17556173024326
cycle= 3 E= -525.661470153498  delta_E= -1.12e-05  |g|= 0.00294  |ddm|= 0.0156
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00440489
diis-c [-3.66500198e-07 -7.89609505e-04  1.22034850e-01  8.78754760e-01]
  HOMO = -0.557642187302946  LUMO = 0.660400631424929
  mo_energy =
[-1.18126494e+02 -1.22061696e+01 -9.50538996e+00 -9.50538996e+00
 -9.50538996e+00 -1.21820489e+00 -5.57642187e-01 -5.57642187e-01
 -5.57642187e-01  6.60400631e-01  6.60400631e-01  6.60400631e-01
  2.57344905e+00  2.94054551e+00  2.94054551e+00  2.94054551e+00
  1.69258010e+01  1.69258010e+01  1.69258010e+01  8.68654511e+01
  8.68654511e+01  8.68654511e+01  1.87630681e+02  4.19307155e+02
  4.19307155e+02  4.19307155e+02  1.27308796e+03  1.27308796e+03
  1.27308796e+03  1.91764915e+03  2.97517013e+03  2.97517013e+03
  2.97517013e+03  6.60431494e+03  6.60431494e+03  6.60431494e+03
  8.27554524e+03  2.46631181e+04  7.54592165e+04]
E1 = -727.8464839599479  E_coul = 202.18501330071086
cycle= 4 E= -525.661470659237  delta_E= -5.06e-07  |g|= 0.000326  |ddm|= 0.00767
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000483364
diis-c [-3.35244795e-08  3.31879359e-05 -1.08277710e-02  2.47977199e-02
  9.85996863e-01]
  HOMO = -0.557597770062128  LUMO = 0.660407882554562
  mo_energy =
[-1.18126172e+02 -1.22059580e+01 -9.50514682e+00 -9.50514682e+00
 -9.50514682e+00 -1.21819397e+00 -5.57597770e-01 -5.57597770e-01
 -5.57597770e-01  6.60407883e-01  6.60407883e-01  6.60407883e-01
  2.57346500e+00  2.94059914e+00  2.94059914e+00  2.94059914e+00
  1.69260059e+01  1.69260059e+01  1.69260059e+01  8.68657287e+01
  8.68657287e+01  8.68657287e+01  1.87630984e+02  4.19307473e+02
  4.19307473e+02  4.19307473e+02  1.27308830e+03  1.27308830e+03
  1.27308830e+03  1.91764951e+03  2.97517048e+03  2.97517048e+03
  2.97517048e+03  6.60431531e+03  6.60431531e+03  6.60431531e+03
  8.27554562e+03  2.46631185e+04  7.54592169e+04]
E1 = -727.8454371895144  E_coul = 202.18396651370355
cycle= 5 E= -525.661470675811  delta_E= -1.66e-08  |g|= 4.65e-05  |ddm|= 0.00115
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.09973e-05
diis-c [-1.11509251e-10  2.09103876e-05 -2.66937785e-03 -1.75786215e-02
 -1.23222826e-02  1.03254937e+00]
  HOMO = -0.557610705903108  LUMO = 0.660401405940377
  mo_energy =
[-1.18126195e+02 -1.22059852e+01 -9.50516997e+00 -9.50516997e+00
 -9.50516997e+00 -1.21821729e+00 -5.57610706e-01 -5.57610706e-01
 -5.57610706e-01  6.60401406e-01  6.60401406e-01  6.60401406e-01
  2.57343617e+00  2.94058172e+00  2.94058172e+00  2.94058172e+00
  1.69259832e+01  1.69259832e+01  1.69259832e+01  8.68657051e+01
  8.68657051e+01  8.68657051e+01  1.87630960e+02  4.19307450e+02
  4.19307450e+02  4.19307450e+02  1.27308828e+03  1.27308828e+03
  1.27308828e+03  1.91764950e+03  2.97517046e+03  2.97517046e+03
  2.97517046e+03  6.60431529e+03  6.60431529e+03  6.60431529e+03
  8.27554561e+03  2.46631184e+04  7.54592169e+04]
E1 = -727.845476393351  E_coul = 202.18400571719604
cycle= 6 E= -525.661470676155  delta_E= -3.44e-10  |g|= 1.8e-06  |ddm|= 0.000262
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -727.845476393351  E_coul = 202.18400571719604
  HOMO = -0.557610718571523  LUMO = 0.660401329046247
  mo_energy =
[-1.18126192e+02 -1.22059842e+01 -9.50516875e+00 -9.50516875e+00
 -9.50516875e+00 -1.21821742e+00 -5.57610719e-01 -5.57610719e-01
 -5.57610719e-01  6.60401329e-01  6.60401329e-01  6.60401329e-01
  2.57343608e+00  2.94058175e+00  2.94058175e+00  2.94058175e+00
  1.69259842e+01  1.69259842e+01  1.69259842e+01  8.68657068e+01
  8.68657068e+01  8.68657068e+01  1.87630962e+02  4.19307452e+02
  4.19307452e+02  4.19307452e+02  1.27308828e+03  1.27308828e+03
  1.27308828e+03  1.91764950e+03  2.97517046e+03  2.97517046e+03
  2.97517046e+03  6.60431530e+03  6.60431530e+03  6.60431530e+03
  8.27554561e+03  2.46631184e+04  7.54592169e+04]
E1 = -727.8454702097922  E_coul = 202.18399953363752
Extra cycle  E= -525.661470676155  delta_E= 2.27e-13  |g|= 4.11e-07  |ddm|= 4.48e-06
    CPU time for scf_cycle      0.64 sec, wall time      0.26 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 83490.18816090665
E1 = -727.8454702097922  E_coul = 202.18399953363752
init E= -525.661470676155
    CPU time for initialize scf      2.69 sec, wall time      0.24 sec
  HOMO = -0.557610866789931  LUMO = 0.660401262835692
  mo_energy =
[-1.18126193e+02 -1.22059847e+01 -9.50516918e+00 -9.50516918e+00
 -9.50516918e+00 -1.21821763e+00 -5.57610867e-01 -5.57610867e-01
 -5.57610867e-01  6.60401263e-01  6.60401263e-01  6.60401263e-01
  2.57343581e+00  2.94058155e+00  2.94058155e+00  2.94058155e+00
  1.69259838e+01  1.69259838e+01  1.69259838e+01  8.68657062e+01
  8.68657062e+01  8.68657062e+01  1.87630962e+02  4.19307452e+02
  4.19307452e+02  4.19307452e+02  1.27308828e+03  1.27308828e+03
  1.27308828e+03  1.91764950e+03  2.97517046e+03  2.97517046e+03
  2.97517046e+03  6.60431529e+03  6.60431529e+03  6.60431529e+03
  8.27554561e+03  2.46631184e+04  7.54592169e+04]
E1 = -727.8454715140897  E_coul = 202.18400083793554
cycle= 1 E= -525.661470676154  delta_E= 5.68e-13  |g|= 9e-08  |ddm|= 1.48e-06
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.8454715140897  E_coul = 202.18400083793554
  HOMO = -0.557610848223183  LUMO = 0.660401267824296
  mo_energy =
[-1.18126193e+02 -1.22059846e+01 -9.50516908e+00 -9.50516908e+00
 -9.50516908e+00 -1.21821761e+00 -5.57610848e-01 -5.57610848e-01
 -5.57610848e-01  6.60401268e-01  6.60401268e-01  6.60401268e-01
  2.57343584e+00  2.94058158e+00  2.94058158e+00  2.94058158e+00
  1.69259839e+01  1.69259839e+01  1.69259839e+01  8.68657063e+01
  8.68657063e+01  8.68657063e+01  1.87630962e+02  4.19307452e+02
  4.19307452e+02  4.19307452e+02  1.27308828e+03  1.27308828e+03
  1.27308828e+03  1.91764950e+03  2.97517046e+03  2.97517046e+03
  2.97517046e+03  6.60431530e+03  6.60431530e+03  6.60431530e+03
  8.27554561e+03  2.46631184e+04  7.54592169e+04]
E1 = -727.8454710942354  E_coul = 202.18400041807985
Extra cycle  E= -525.661470676156  delta_E= -1.48e-12  |g|= 2.45e-08  |ddm|= 9.58e-08
    CPU time for scf_cycle      3.02 sec, wall time      0.57 sec
exp = [2.61825079e+04 7.61825072e+03 3.61825066e+03 1.61824879e+03
 2.39780720e+02 5.19271275e+01 4.98602647e+00 8.55858908e-01
 5.27869959e-01 1.36279300e+03 6.65180665e+02 3.03320312e+02
 3.16146166e+02 4.93040687e+01 4.79693536e+00 1.47209198e+01
 4.37161034e-01 1.13147987e+00 1.91546755e-01]
grad_E = [-1.98308528e-06  2.15000750e-05  4.26404943e-05  6.57941356e-04
  1.56080696e-03 -1.75617585e-02 -6.51332005e-02 -5.71889183e-02
  2.78726567e-01  1.22243477e-06  1.91821094e-05  1.03146443e-04
  9.08612856e-05 -3.18991128e-04  2.41941926e-02 -1.30966238e-03
 -1.44700156e-01 -4.18993074e-02  2.52162298e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:39:11 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5078596        1
[INPUT] 0    0    [1    /1   ]  7618.25067964        1
[INPUT] 0    0    [1    /1   ]  3618.2505753         1
[INPUT] 0    0    [1    /1   ]  1618.24755668        1
[INPUT] 0    0    [1    /1   ]  239.77820097         1
[INPUT] 0    0    [1    /1   ]  51.9533819858        1
[INPUT] 0    0    [1    /1   ]  5.21850085203        1
[INPUT] 0    0    [1    /1   ]  1.02852386453        1
[INPUT] 0    0    [1    /1   ]  0.360954372849       1
[INPUT] 1    0    [1    /1   ]  1362.79299674        1
[INPUT] 1    0    [1    /1   ]  665.180628142        1
[INPUT] 1    0    [1    /1   ]  303.32011386         1
[INPUT] 1    0    [1    /1   ]  316.145990981        1
[INPUT] 1    0    [1    /1   ]  49.3055254427        1
[INPUT] 1    0    [1    /1   ]  4.78634692897        1
[INPUT] 1    0    [1    /1   ]  14.7144717807        1
[INPUT] 1    0    [1    /1   ]  0.434503145261       1
[INPUT] 1    0    [1    /1   ]  1.16256945348        1
[INPUT] 1    0    [1    /1   ]  0.15002411032        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.507859589, 1.0]], [0, [7618.250679637676, 1.0]], [0, [3618.250575303077, 1.0]], [0, [1618.2475566779922, 1.0]], [0, [239.7782009700741, 1.0]], [0, [51.95338198575304, 1.0]], [0, [5.218500852029546, 1.0]], [0, [1.028523864526591, 1.0]], [0, [0.36095437284908755, 1.0]], [1, [1362.7929967421837, 1.0]], [1, [665.180628142467, 1.0]], [1, [303.32011385952654, 1.0]], [1, [316.1459909806119, 1.0]], [1, [49.305525442667374, 1.0]], [1, [4.786346928974762, 1.0]], [1, [14.714471780692103, 1.0]], [1, [0.4345031452610642, 1.0]], [1, [1.1625694534808468, 1.0]], [1, [0.1500241103204277, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50785959]
bas 1, expnt(s) = [7618.25067964]
bas 2, expnt(s) = [3618.2505753]
bas 3, expnt(s) = [1618.24755668]
bas 4, expnt(s) = [239.77820097]
bas 5, expnt(s) = [51.95338199]
bas 6, expnt(s) = [5.21850085]
bas 7, expnt(s) = [1.02852386]
bas 8, expnt(s) = [0.36095437]
bas 9, expnt(s) = [1362.79299674]
bas 10, expnt(s) = [665.18062814]
bas 11, expnt(s) = [303.32011386]
bas 12, expnt(s) = [316.14599098]
bas 13, expnt(s) = [49.30552544]
bas 14, expnt(s) = [4.78634693]
bas 15, expnt(s) = [14.71447178]
bas 16, expnt(s) = [0.43450315]
bas 17, expnt(s) = [1.16256945]
bas 18, expnt(s) = [0.15002411]
CPU time:        46.86
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024082e+03 7.61825068e+03 2.06018618e+03
 3.61825058e+03 1.17866125e+03 1.61824756e+03 6.44612532e+02
 2.39778201e+02 1.53947378e+02 5.19533820e+01 4.88906028e+01
 5.21850085e+00 8.72317014e+00 1.02852386e+00 2.58033328e+00
 3.60954373e-01 1.17653338e+00 1.36279300e+03 2.41558186e+04
 6.65180628e+02 9.85505117e+03 3.03320114e+02 3.69284352e+03
 3.16145991e+02 3.88905416e+03 4.93055254e+01 3.81156984e+02
 4.78634693e+00 2.06533075e+01 1.47144718e+01 8.40746829e+01
 4.34503145e-01 1.02914258e+00 1.16256945e+00 3.52174598e+00
 1.50024110e-01 2.72386587e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.987599946888103
cond(S) = 83466.75159960236
E1 = -728.1988975554507  E_coul = 203.27217706767337
init E= -524.926720487777
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.561789281599353  LUMO = 0.532770630995853
  mo_energy =
[-1.17887769e+02 -1.21414518e+01 -9.42713740e+00 -9.42713740e+00
 -9.42713740e+00 -1.22576929e+00 -5.61789282e-01 -5.61789282e-01
 -5.61789282e-01  5.32770631e-01  5.32770631e-01  5.32770631e-01
  2.39156847e+00  2.80028890e+00  2.80028890e+00  2.80028890e+00
  1.69360864e+01  1.69360864e+01  1.69360864e+01  8.69535854e+01
  8.69535854e+01  8.69535854e+01  1.88904606e+02  4.19499385e+02
  4.19499385e+02  4.19499385e+02  1.27334353e+03  1.27334353e+03
  1.27334353e+03  1.91889361e+03  2.97549713e+03  2.97549713e+03
  2.97549713e+03  6.60476963e+03  6.60476963e+03  6.60476963e+03
  8.27683966e+03  2.46644663e+04  7.54606102e+04]
E1 = -726.8301580921967  E_coul = 201.1164401596703
cycle= 1 E= -525.713717932526  delta_E= -0.787  |g|= 0.194  |ddm|= 0.493
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.475795
diis-c [-0.22638074  1.        ]
  HOMO = -0.596426815147072  LUMO = 0.524205705061489
  mo_energy =
[-1.18211067e+02 -1.22860115e+01 -9.58214105e+00 -9.58214105e+00
 -9.58214105e+00 -1.26636387e+00 -5.96426815e-01 -5.96426815e-01
 -5.96426815e-01  5.24205705e-01  5.24205705e-01  5.24205705e-01
  2.33633975e+00  2.75133774e+00  2.75133774e+00  2.75133774e+00
  1.68001670e+01  1.68001670e+01  1.68001670e+01  8.67308549e+01
  8.67308549e+01  8.67308549e+01  1.88619881e+02  4.19183426e+02
  4.19183426e+02  4.19183426e+02  1.27297193e+03  1.27297193e+03
  1.27297193e+03  1.91839174e+03  2.97505897e+03  2.97505897e+03
  2.97505897e+03  6.60421044e+03  6.60421044e+03  6.60421044e+03
  8.27619466e+03  2.46637256e+04  7.54597767e+04]
E1 = -727.4155264704763  E_coul = 201.7010719168059
cycle= 2 E= -525.71445455367  delta_E= -0.000737  |g|= 0.0358  |ddm|= 0.0505
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0612045
diis-c [-0.00230614  0.07421211  0.92578789]
  HOMO = -0.58667575294308  LUMO = 0.527353672506884
  mo_energy =
[-1.18143492e+02 -1.22465423e+01 -9.54133274e+00 -9.54133274e+00
 -9.54133274e+00 -1.25437089e+00 -5.86675753e-01 -5.86675753e-01
 -5.86675753e-01  5.27353673e-01  5.27353673e-01  5.27353673e-01
  2.35319172e+00  2.76483652e+00  2.76483652e+00  2.76483652e+00
  1.68355187e+01  1.68355187e+01  1.68355187e+01  8.67849581e+01
  8.67849581e+01  8.67849581e+01  1.88684795e+02  4.19250368e+02
  4.19250368e+02  4.19250368e+02  1.27304248e+03  1.27304248e+03
  1.27304248e+03  1.91846479e+03  2.97513129e+03  2.97513129e+03
  2.97513129e+03  6.60428402e+03  6.60428402e+03  6.60428402e+03
  8.27626883e+03  2.46638000e+04  7.54598513e+04]
E1 = -727.2565598231495  E_coul = 201.5420429882892
cycle= 3 E= -525.71451683486  delta_E= -6.23e-05  |g|= 0.00658  |ddm|= 0.0195
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0120742
diis-c [-6.82338075e-07 -1.28343449e-03  1.60009867e-01  8.41273567e-01]
  HOMO = -0.588402037524228  LUMO = 0.526805410766848
  mo_energy =
[-1.18154148e+02 -1.22530170e+01 -9.54818036e+00 -9.54818036e+00
 -9.54818036e+00 -1.25633113e+00 -5.88402038e-01 -5.88402038e-01
 -5.88402038e-01  5.26805411e-01  5.26805411e-01  5.26805411e-01
  2.35048519e+00  2.76249403e+00  2.76249403e+00  2.76249403e+00
  1.68295568e+01  1.68295568e+01  1.68295568e+01  8.67762300e+01
  8.67762300e+01  8.67762300e+01  1.88674596e+02  4.19239810e+02
  4.19239810e+02  4.19239810e+02  1.27303135e+03  1.27303135e+03
  1.27303135e+03  1.91845310e+03  2.97511981e+03  2.97511981e+03
  2.97511981e+03  6.60427217e+03  6.60427217e+03  6.60427217e+03
  8.27625677e+03  2.46637878e+04  7.54598390e+04]
E1 = -727.2830903092389  E_coul = 201.56857094091595
cycle= 4 E= -525.714519368323  delta_E= -2.53e-06  |g|= 0.000139  |ddm|= 0.00254
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000142902
diis-c [-4.65304908e-09  3.80331647e-05 -7.41877149e-03 -4.88090386e-02
  1.05618978e+00]
  HOMO = -0.58837426360641  LUMO = 0.526816401514215
  mo_energy =
[-1.18154112e+02 -1.22529426e+01 -9.54812512e+00 -9.54812512e+00
 -9.54812512e+00 -1.25627401e+00 -5.88374264e-01 -5.88374264e-01
 -5.88374264e-01  5.26816402e-01  5.26816402e-01  5.26816402e-01
  2.35055932e+00  2.76253189e+00  2.76253189e+00  2.76253189e+00
  1.68296100e+01  1.68296100e+01  1.68296100e+01  8.67762784e+01
  8.67762784e+01  8.67762784e+01  1.88674641e+02  4.19239847e+02
  4.19239847e+02  4.19239847e+02  1.27303138e+03  1.27303138e+03
  1.27303138e+03  1.91845310e+03  2.97511982e+03  2.97511982e+03
  2.97511982e+03  6.60427217e+03  6.60427217e+03  6.60427217e+03
  8.27625675e+03  2.46637878e+04  7.54598389e+04]
E1 = -727.2829448051962  E_coul = 201.56842543422755
cycle= 5 E= -525.714519370969  delta_E= -2.65e-09  |g|= 2.62e-05  |ddm|= 0.000205
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.81055e-05
diis-c [-4.22163809e-11  1.39463374e-05 -1.88771869e-03 -1.38325417e-02
  9.36350451e-03  1.00634281e+00]
  HOMO = -0.588380893192975  LUMO = 0.526814664555341
  mo_energy =
[-1.18154147e+02 -1.22529667e+01 -9.54815225e+00 -9.54815225e+00
 -9.54815225e+00 -1.25627870e+00 -5.88380893e-01 -5.88380893e-01
 -5.88380893e-01  5.26814665e-01  5.26814665e-01  5.26814665e-01
  2.35055283e+00  2.76252330e+00  2.76252330e+00  2.76252330e+00
  1.68295864e+01  1.68295864e+01  1.68295864e+01  8.67762475e+01
  8.67762475e+01  8.67762475e+01  1.88674607e+02  4.19239812e+02
  4.19239812e+02  4.19239812e+02  1.27303134e+03  1.27303134e+03
  1.27303134e+03  1.91845306e+03  2.97511979e+03  2.97511979e+03
  2.97511979e+03  6.60427213e+03  6.60427213e+03  6.60427213e+03
  8.27625671e+03  2.46637877e+04  7.54598389e+04]
E1 = -727.2830575010821  E_coul = 201.5685381300271
cycle= 6 E= -525.714519371055  delta_E= -8.64e-11  |g|= 1.29e-06  |ddm|= 2.09e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -727.2830575010821  E_coul = 201.5685381300271
  HOMO = -0.588380663669543  LUMO = 0.526814788079221
  mo_energy =
[-1.18154147e+02 -1.22529665e+01 -9.54815217e+00 -9.54815217e+00
 -9.54815217e+00 -1.25627825e+00 -5.88380664e-01 -5.88380664e-01
 -5.88380664e-01  5.26814788e-01  5.26814788e-01  5.26814788e-01
  2.35055336e+00  2.76252359e+00  2.76252359e+00  2.76252359e+00
  1.68295866e+01  1.68295866e+01  1.68295866e+01  8.67762476e+01
  8.67762476e+01  8.67762476e+01  1.88674607e+02  4.19239812e+02
  4.19239812e+02  4.19239812e+02  1.27303134e+03  1.27303134e+03
  1.27303134e+03  1.91845306e+03  2.97511979e+03  2.97511979e+03
  2.97511979e+03  6.60427213e+03  6.60427213e+03  6.60427213e+03
  8.27625671e+03  2.46637877e+04  7.54598389e+04]
E1 = -727.2830586716177  E_coul = 201.56853930056218
Extra cycle  E= -525.714519371056  delta_E= -4.55e-13  |g|= 2.38e-07  |ddm|= 1.92e-06
    CPU time for scf_cycle      0.64 sec, wall time      0.25 sec
exp = [2.61825079e+04 7.61825068e+03 3.61825058e+03 1.61824756e+03
 2.39778201e+02 5.19533820e+01 5.21850085e+00 1.02852386e+00
 3.60954373e-01 1.36279300e+03 6.65180628e+02 3.03320114e+02
 3.16145991e+02 4.93055254e+01 4.78634693e+00 1.47144718e+01
 4.34503145e-01 1.16256945e+00 1.50024110e-01]
E = -525.7145193710555
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:39:12 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5078596        1
[INPUT] 0    0    [1    /1   ]  7618.25067964        1
[INPUT] 0    0    [1    /1   ]  3618.2505753         1
[INPUT] 0    0    [1    /1   ]  1618.24755668        1
[INPUT] 0    0    [1    /1   ]  239.77820097         1
[INPUT] 0    0    [1    /1   ]  51.9533819858        1
[INPUT] 0    0    [1    /1   ]  5.21850085203        1
[INPUT] 0    0    [1    /1   ]  1.02852386453        1
[INPUT] 0    0    [1    /1   ]  0.360954372849       1
[INPUT] 1    0    [1    /1   ]  1362.79299674        1
[INPUT] 1    0    [1    /1   ]  665.180628142        1
[INPUT] 1    0    [1    /1   ]  303.32011386         1
[INPUT] 1    0    [1    /1   ]  316.145990981        1
[INPUT] 1    0    [1    /1   ]  49.3055254427        1
[INPUT] 1    0    [1    /1   ]  4.78634692897        1
[INPUT] 1    0    [1    /1   ]  14.7144717807        1
[INPUT] 1    0    [1    /1   ]  0.434503145261       1
[INPUT] 1    0    [1    /1   ]  1.16256945348        1
[INPUT] 1    0    [1    /1   ]  0.15002411032        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.507859589, 1.0]], [0, [7618.250679637676, 1.0]], [0, [3618.250575303077, 1.0]], [0, [1618.2475566779922, 1.0]], [0, [239.7782009700741, 1.0]], [0, [51.95338198575304, 1.0]], [0, [5.218500852029546, 1.0]], [0, [1.028523864526591, 1.0]], [0, [0.36095437284908755, 1.0]], [1, [1362.7929967421837, 1.0]], [1, [665.180628142467, 1.0]], [1, [303.32011385952654, 1.0]], [1, [316.1459909806119, 1.0]], [1, [49.305525442667374, 1.0]], [1, [4.786346928974762, 1.0]], [1, [14.714471780692103, 1.0]], [1, [0.4345031452610642, 1.0]], [1, [1.1625694534808468, 1.0]], [1, [0.1500241103204277, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50785959]
bas 1, expnt(s) = [7618.25067964]
bas 2, expnt(s) = [3618.2505753]
bas 3, expnt(s) = [1618.24755668]
bas 4, expnt(s) = [239.77820097]
bas 5, expnt(s) = [51.95338199]
bas 6, expnt(s) = [5.21850085]
bas 7, expnt(s) = [1.02852386]
bas 8, expnt(s) = [0.36095437]
bas 9, expnt(s) = [1362.79299674]
bas 10, expnt(s) = [665.18062814]
bas 11, expnt(s) = [303.32011386]
bas 12, expnt(s) = [316.14599098]
bas 13, expnt(s) = [49.30552544]
bas 14, expnt(s) = [4.78634693]
bas 15, expnt(s) = [14.71447178]
bas 16, expnt(s) = [0.43450315]
bas 17, expnt(s) = [1.16256945]
bas 18, expnt(s) = [0.15002411]
CPU time:        47.55
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024082e+03 7.61825068e+03 2.06018618e+03
 3.61825058e+03 1.17866125e+03 1.61824756e+03 6.44612532e+02
 2.39778201e+02 1.53947378e+02 5.19533820e+01 4.88906028e+01
 5.21850085e+00 8.72317014e+00 1.02852386e+00 2.58033328e+00
 3.60954373e-01 1.17653338e+00 1.36279300e+03 2.41558186e+04
 6.65180628e+02 9.85505117e+03 3.03320114e+02 3.69284352e+03
 3.16145991e+02 3.88905416e+03 4.93055254e+01 3.81156984e+02
 4.78634693e+00 2.06533075e+01 1.47144718e+01 8.40746829e+01
 4.34503145e-01 1.02914258e+00 1.16256945e+00 3.52174598e+00
 1.50024110e-01 2.72386587e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.987599946888103
cond(S) = 83466.75159960236
E1 = -728.1988975554507  E_coul = 203.27217706767337
init E= -524.926720487777
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.561789281599353  LUMO = 0.532770630995853
  mo_energy =
[-1.17887769e+02 -1.21414518e+01 -9.42713740e+00 -9.42713740e+00
 -9.42713740e+00 -1.22576929e+00 -5.61789282e-01 -5.61789282e-01
 -5.61789282e-01  5.32770631e-01  5.32770631e-01  5.32770631e-01
  2.39156847e+00  2.80028890e+00  2.80028890e+00  2.80028890e+00
  1.69360864e+01  1.69360864e+01  1.69360864e+01  8.69535854e+01
  8.69535854e+01  8.69535854e+01  1.88904606e+02  4.19499385e+02
  4.19499385e+02  4.19499385e+02  1.27334353e+03  1.27334353e+03
  1.27334353e+03  1.91889361e+03  2.97549713e+03  2.97549713e+03
  2.97549713e+03  6.60476963e+03  6.60476963e+03  6.60476963e+03
  8.27683966e+03  2.46644663e+04  7.54606102e+04]
E1 = -726.8301580921967  E_coul = 201.1164401596703
cycle= 1 E= -525.713717932526  delta_E= -0.787  |g|= 0.194  |ddm|= 0.493
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.475795
diis-c [-0.22638074  1.        ]
  HOMO = -0.596426815147072  LUMO = 0.524205705061489
  mo_energy =
[-1.18211067e+02 -1.22860115e+01 -9.58214105e+00 -9.58214105e+00
 -9.58214105e+00 -1.26636387e+00 -5.96426815e-01 -5.96426815e-01
 -5.96426815e-01  5.24205705e-01  5.24205705e-01  5.24205705e-01
  2.33633975e+00  2.75133774e+00  2.75133774e+00  2.75133774e+00
  1.68001670e+01  1.68001670e+01  1.68001670e+01  8.67308549e+01
  8.67308549e+01  8.67308549e+01  1.88619881e+02  4.19183426e+02
  4.19183426e+02  4.19183426e+02  1.27297193e+03  1.27297193e+03
  1.27297193e+03  1.91839174e+03  2.97505897e+03  2.97505897e+03
  2.97505897e+03  6.60421044e+03  6.60421044e+03  6.60421044e+03
  8.27619466e+03  2.46637256e+04  7.54597767e+04]
E1 = -727.4155264704763  E_coul = 201.7010719168059
cycle= 2 E= -525.71445455367  delta_E= -0.000737  |g|= 0.0358  |ddm|= 0.0505
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0612045
diis-c [-0.00230614  0.07421211  0.92578789]
  HOMO = -0.58667575294308  LUMO = 0.527353672506884
  mo_energy =
[-1.18143492e+02 -1.22465423e+01 -9.54133274e+00 -9.54133274e+00
 -9.54133274e+00 -1.25437089e+00 -5.86675753e-01 -5.86675753e-01
 -5.86675753e-01  5.27353673e-01  5.27353673e-01  5.27353673e-01
  2.35319172e+00  2.76483652e+00  2.76483652e+00  2.76483652e+00
  1.68355187e+01  1.68355187e+01  1.68355187e+01  8.67849581e+01
  8.67849581e+01  8.67849581e+01  1.88684795e+02  4.19250368e+02
  4.19250368e+02  4.19250368e+02  1.27304248e+03  1.27304248e+03
  1.27304248e+03  1.91846479e+03  2.97513129e+03  2.97513129e+03
  2.97513129e+03  6.60428402e+03  6.60428402e+03  6.60428402e+03
  8.27626883e+03  2.46638000e+04  7.54598513e+04]
E1 = -727.2565598231495  E_coul = 201.5420429882892
cycle= 3 E= -525.71451683486  delta_E= -6.23e-05  |g|= 0.00658  |ddm|= 0.0195
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0120742
diis-c [-6.82338075e-07 -1.28343449e-03  1.60009867e-01  8.41273567e-01]
  HOMO = -0.588402037524228  LUMO = 0.526805410766848
  mo_energy =
[-1.18154148e+02 -1.22530170e+01 -9.54818036e+00 -9.54818036e+00
 -9.54818036e+00 -1.25633113e+00 -5.88402038e-01 -5.88402038e-01
 -5.88402038e-01  5.26805411e-01  5.26805411e-01  5.26805411e-01
  2.35048519e+00  2.76249403e+00  2.76249403e+00  2.76249403e+00
  1.68295568e+01  1.68295568e+01  1.68295568e+01  8.67762300e+01
  8.67762300e+01  8.67762300e+01  1.88674596e+02  4.19239810e+02
  4.19239810e+02  4.19239810e+02  1.27303135e+03  1.27303135e+03
  1.27303135e+03  1.91845310e+03  2.97511981e+03  2.97511981e+03
  2.97511981e+03  6.60427217e+03  6.60427217e+03  6.60427217e+03
  8.27625677e+03  2.46637878e+04  7.54598390e+04]
E1 = -727.2830903092389  E_coul = 201.56857094091595
cycle= 4 E= -525.714519368323  delta_E= -2.53e-06  |g|= 0.000139  |ddm|= 0.00254
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000142902
diis-c [-4.65304908e-09  3.80331647e-05 -7.41877149e-03 -4.88090386e-02
  1.05618978e+00]
  HOMO = -0.58837426360641  LUMO = 0.526816401514215
  mo_energy =
[-1.18154112e+02 -1.22529426e+01 -9.54812512e+00 -9.54812512e+00
 -9.54812512e+00 -1.25627401e+00 -5.88374264e-01 -5.88374264e-01
 -5.88374264e-01  5.26816402e-01  5.26816402e-01  5.26816402e-01
  2.35055932e+00  2.76253189e+00  2.76253189e+00  2.76253189e+00
  1.68296100e+01  1.68296100e+01  1.68296100e+01  8.67762784e+01
  8.67762784e+01  8.67762784e+01  1.88674641e+02  4.19239847e+02
  4.19239847e+02  4.19239847e+02  1.27303138e+03  1.27303138e+03
  1.27303138e+03  1.91845310e+03  2.97511982e+03  2.97511982e+03
  2.97511982e+03  6.60427217e+03  6.60427217e+03  6.60427217e+03
  8.27625675e+03  2.46637878e+04  7.54598389e+04]
E1 = -727.2829448051962  E_coul = 201.56842543422755
cycle= 5 E= -525.714519370969  delta_E= -2.65e-09  |g|= 2.62e-05  |ddm|= 0.000205
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.81055e-05
diis-c [-4.22163809e-11  1.39463374e-05 -1.88771869e-03 -1.38325417e-02
  9.36350451e-03  1.00634281e+00]
  HOMO = -0.588380893192975  LUMO = 0.526814664555341
  mo_energy =
[-1.18154147e+02 -1.22529667e+01 -9.54815225e+00 -9.54815225e+00
 -9.54815225e+00 -1.25627870e+00 -5.88380893e-01 -5.88380893e-01
 -5.88380893e-01  5.26814665e-01  5.26814665e-01  5.26814665e-01
  2.35055283e+00  2.76252330e+00  2.76252330e+00  2.76252330e+00
  1.68295864e+01  1.68295864e+01  1.68295864e+01  8.67762475e+01
  8.67762475e+01  8.67762475e+01  1.88674607e+02  4.19239812e+02
  4.19239812e+02  4.19239812e+02  1.27303134e+03  1.27303134e+03
  1.27303134e+03  1.91845306e+03  2.97511979e+03  2.97511979e+03
  2.97511979e+03  6.60427213e+03  6.60427213e+03  6.60427213e+03
  8.27625671e+03  2.46637877e+04  7.54598389e+04]
E1 = -727.2830575010821  E_coul = 201.5685381300271
cycle= 6 E= -525.714519371055  delta_E= -8.64e-11  |g|= 1.29e-06  |ddm|= 2.09e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -727.2830575010821  E_coul = 201.5685381300271
  HOMO = -0.588380663669543  LUMO = 0.526814788079221
  mo_energy =
[-1.18154147e+02 -1.22529665e+01 -9.54815217e+00 -9.54815217e+00
 -9.54815217e+00 -1.25627825e+00 -5.88380664e-01 -5.88380664e-01
 -5.88380664e-01  5.26814788e-01  5.26814788e-01  5.26814788e-01
  2.35055336e+00  2.76252359e+00  2.76252359e+00  2.76252359e+00
  1.68295866e+01  1.68295866e+01  1.68295866e+01  8.67762476e+01
  8.67762476e+01  8.67762476e+01  1.88674607e+02  4.19239812e+02
  4.19239812e+02  4.19239812e+02  1.27303134e+03  1.27303134e+03
  1.27303134e+03  1.91845306e+03  2.97511979e+03  2.97511979e+03
  2.97511979e+03  6.60427213e+03  6.60427213e+03  6.60427213e+03
  8.27625671e+03  2.46637877e+04  7.54598389e+04]
E1 = -727.2830586716177  E_coul = 201.56853930056218
Extra cycle  E= -525.714519371056  delta_E= -4.55e-13  |g|= 2.38e-07  |ddm|= 1.92e-06
    CPU time for scf_cycle      0.64 sec, wall time      0.25 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 83466.75159960236
E1 = -727.2830586716177  E_coul = 201.56853930056218
init E= -525.714519371056
    CPU time for initialize scf      2.69 sec, wall time      0.25 sec
  HOMO = -0.588380612533442  LUMO = 0.526814813562632
  mo_energy =
[-1.18154147e+02 -1.22529664e+01 -9.54815211e+00 -9.54815211e+00
 -9.54815211e+00 -1.25627816e+00 -5.88380613e-01 -5.88380613e-01
 -5.88380613e-01  5.26814814e-01  5.26814814e-01  5.26814814e-01
  2.35055347e+00  2.76252366e+00  2.76252366e+00  2.76252366e+00
  1.68295866e+01  1.68295866e+01  1.68295866e+01  8.67762477e+01
  8.67762477e+01  8.67762477e+01  1.88674607e+02  4.19239812e+02
  4.19239812e+02  4.19239812e+02  1.27303134e+03  1.27303134e+03
  1.27303134e+03  1.91845306e+03  2.97511979e+03  2.97511979e+03
  2.97511979e+03  6.60427213e+03  6.60427213e+03  6.60427213e+03
  8.27625671e+03  2.46637877e+04  7.54598389e+04]
E1 = -727.2830586880407  E_coul = 201.56853931698564
cycle= 1 E= -525.714519371055  delta_E= 4.55e-13  |g|= 4.23e-08  |ddm|= 3.57e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.2830586880407  E_coul = 201.56853931698564
  HOMO = -0.588380607296308  LUMO = 0.526814816818239
  mo_energy =
[-1.18154147e+02 -1.22529664e+01 -9.54815212e+00 -9.54815212e+00
 -9.54815212e+00 -1.25627814e+00 -5.88380607e-01 -5.88380607e-01
 -5.88380607e-01  5.26814817e-01  5.26814817e-01  5.26814817e-01
  2.35055349e+00  2.76252367e+00  2.76252367e+00  2.76252367e+00
  1.68295866e+01  1.68295866e+01  1.68295866e+01  8.67762477e+01
  8.67762477e+01  8.67762477e+01  1.88674607e+02  4.19239812e+02
  4.19239812e+02  4.19239812e+02  1.27303134e+03  1.27303134e+03
  1.27303134e+03  1.91845306e+03  2.97511979e+03  2.97511979e+03
  2.97511979e+03  6.60427213e+03  6.60427213e+03  6.60427213e+03
  8.27625671e+03  2.46637877e+04  7.54598389e+04]
E1 = -727.2830587464529  E_coul = 201.56853937539654
Extra cycle  E= -525.714519371056  delta_E= -1.25e-12  |g|= 8.09e-09  |ddm|= 6.11e-08
    CPU time for scf_cycle      2.81 sec, wall time      0.37 sec
exp = [2.61825079e+04 7.61825068e+03 3.61825058e+03 1.61824756e+03
 2.39778201e+02 5.19533820e+01 5.21850085e+00 1.02852386e+00
 3.60954373e-01 1.36279300e+03 6.65180628e+02 3.03320114e+02
 3.16145991e+02 4.93055254e+01 4.78634693e+00 1.47144718e+01
 4.34503145e-01 1.16256945e+00 1.50024110e-01]
grad_E = [-1.98601402e-06  2.15423195e-05  4.27304034e-05  6.59371228e-04
  1.49247396e-03 -1.69198622e-02  5.78104615e-02 -1.78065008e-01
 -1.93561693e-01  1.23881649e-06  1.92922679e-05  1.03854920e-04
  9.14831959e-05 -4.75394174e-04  1.57073427e-02  6.79168608e-04
 -3.95578013e-02 -6.62551291e-02 -1.93437892e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:39:16 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5078651        1
[INPUT] 0    0    [1    /1   ]  7618.25062002        1
[INPUT] 0    0    [1    /1   ]  3618.25045688        1
[INPUT] 0    0    [1    /1   ]  1618.24573107        1
[INPUT] 0    0    [1    /1   ]  239.774360092        1
[INPUT] 0    0    [1    /1   ]  51.9945039289        1
[INPUT] 0    0    [1    /1   ]  5.40914301371        1
[INPUT] 0    0    [1    /1   ]  1.36187808601        1
[INPUT] 0    0    [1    /1   ]  0.370312021335       1
[INPUT] 1    0    [1    /1   ]  1362.79299322        1
[INPUT] 1    0    [1    /1   ]  665.180574014        1
[INPUT] 1    0    [1    /1   ]  303.319821944        1
[INPUT] 1    0    [1    /1   ]  316.145733843        1
[INPUT] 1    0    [1    /1   ]  49.3074651297        1
[INPUT] 1    0    [1    /1   ]  4.76406700058        1
[INPUT] 1    0    [1    /1   ]  14.706831702         1
[INPUT] 1    0    [1    /1   ]  0.466108772627       1
[INPUT] 1    0    [1    /1   ]  1.24951237629        1
[INPUT] 1    0    [1    /1   ]  0.125569984029       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.50786507421, 1.0]], [0, [7618.250620016431, 1.0]], [0, [3618.250456883215, 1.0]], [0, [1618.2457310691927, 1.0]], [0, [239.77436009198874, 1.0]], [0, [51.99450392889733, 1.0]], [0, [5.409143013711989, 1.0]], [0, [1.361878086008634, 1.0]], [0, [0.3703120213351916, 1.0]], [1, [1362.79299321822, 1.0]], [1, [665.1805740140502, 1.0]], [1, [303.31982194354265, 1.0]], [1, [316.1457338430871, 1.0]], [1, [49.307465129716455, 1.0]], [1, [4.7640670005821955, 1.0]], [1, [14.70683170198026, 1.0]], [1, [0.4661087726273113, 1.0]], [1, [1.2495123762877371, 1.0]], [1, [0.12556998402929054, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50786507]
bas 1, expnt(s) = [7618.25062002]
bas 2, expnt(s) = [3618.25045688]
bas 3, expnt(s) = [1618.24573107]
bas 4, expnt(s) = [239.77436009]
bas 5, expnt(s) = [51.99450393]
bas 6, expnt(s) = [5.40914301]
bas 7, expnt(s) = [1.36187809]
bas 8, expnt(s) = [0.37031202]
bas 9, expnt(s) = [1362.79299322]
bas 10, expnt(s) = [665.18057401]
bas 11, expnt(s) = [303.31982194]
bas 12, expnt(s) = [316.14573384]
bas 13, expnt(s) = [49.30746513]
bas 14, expnt(s) = [4.764067]
bas 15, expnt(s) = [14.7068317]
bas 16, expnt(s) = [0.46610877]
bas 17, expnt(s) = [1.24951238]
bas 18, expnt(s) = [0.12556998]
CPU time:        55.54
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024082e+03 7.61825062e+03 2.06018616e+03
 3.61825046e+03 1.17866122e+03 1.61824573e+03 6.44611986e+02
 2.39774360e+02 1.53945529e+02 5.19945039e+01 4.89196232e+01
 5.40914301e+00 8.96110100e+00 1.36187809e+00 3.18506792e+00
 3.70312021e-01 1.19933603e+00 1.36279299e+03 2.41558185e+04
 6.65180574e+02 9.85505017e+03 3.03319822e+02 3.69283908e+03
 3.16145734e+02 3.88905021e+03 4.93074651e+01 3.81175728e+02
 4.76406700e+00 2.05332038e+01 1.47068317e+01 8.40201197e+01
 4.66108773e-01 1.12355281e+00 1.24951238e+00 3.85398567e+00
 1.25569984e-01 2.18067875e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98335051813587
cond(S) = 83500.19416009099
E1 = -728.1798104658526  E_coul = 203.18726095403022
init E= -524.992549511822
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.560996316990372  LUMO = 0.464464589178268
  mo_energy =
[-1.17909766e+02 -1.21614254e+01 -9.43612992e+00 -9.43612992e+00
 -9.43612992e+00 -1.22421047e+00 -5.60996317e-01 -5.60996317e-01
 -5.60996317e-01  4.64464589e-01  4.64464589e-01  4.64464589e-01
  2.91876679e+00  2.91876679e+00  2.91876679e+00  3.24938962e+00
  1.72387376e+01  1.72387376e+01  1.72387376e+01  8.71380563e+01
  8.71380563e+01  8.71380563e+01  1.91093371e+02  4.19609267e+02
  4.19609267e+02  4.19609267e+02  1.27343325e+03  1.27343325e+03
  1.27343325e+03  1.92049637e+03  2.97557803e+03  2.97557803e+03
  2.97557803e+03  6.60484160e+03  6.60484160e+03  6.60484160e+03
  8.27824694e+03  2.46657865e+04  7.54618339e+04]
E1 = -726.5957932301352  E_coul = 200.83683101173483
cycle= 1 E= -525.7589622184  delta_E= -0.766  |g|= 0.207  |ddm|= 0.895
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.50154
diis-c [-0.25154225  1.        ]
  HOMO = -0.600091306444178  LUMO = 0.455017342474419
  mo_energy =
[-1.18259982e+02 -1.23169098e+01 -9.60530865e+00 -9.60530865e+00
 -9.60530865e+00 -1.26860082e+00 -6.00091306e-01 -6.00091306e-01
 -6.00091306e-01  4.55017342e-01  4.55017342e-01  4.55017342e-01
  2.86069605e+00  2.86069605e+00  2.86069605e+00  3.17883825e+00
  1.70910660e+01  1.70910660e+01  1.70910660e+01  8.68943702e+01
  8.68943702e+01  8.68943702e+01  1.90781222e+02  4.19265448e+02
  4.19265448e+02  4.19265448e+02  1.27303009e+03  1.27303009e+03
  1.27303009e+03  1.91995654e+03  2.97510463e+03  2.97510463e+03
  2.97510463e+03  6.60424319e+03  6.60424319e+03  6.60424319e+03
  8.27756022e+03  2.46650023e+04  7.54609558e+04]
E1 = -727.2188388533916  E_coul = 201.45893976081393
cycle= 2 E= -525.759899092578  delta_E= -0.000937  |g|= 0.0401  |ddm|= 0.0519
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0689141
diis-c [-0.00259543  0.08509737  0.91490263]
  HOMO = -0.590437774786939  LUMO = 0.45795426530054
  mo_energy =
[-1.18186920e+02 -1.22753712e+01 -9.56228513e+00 -9.56228513e+00
 -9.56228513e+00 -1.25654452e+00 -5.90437775e-01 -5.90437775e-01
 -5.90437775e-01  4.57954265e-01  4.57954265e-01  4.57954265e-01
  2.87515488e+00  2.87515488e+00  2.87515488e+00  3.19947161e+00
  1.71281115e+01  1.71281115e+01  1.71281115e+01  8.69523004e+01
  8.69523004e+01  8.69523004e+01  1.90851262e+02  4.19337815e+02
  4.19337815e+02  4.19337815e+02  1.27310649e+03  1.27310649e+03
  1.27310649e+03  1.92003571e+03  2.97518301e+03  2.97518301e+03
  2.97518301e+03  6.60432296e+03  6.60432296e+03  6.60432296e+03
  8.27764065e+03  2.46650830e+04  7.54610367e+04]
E1 = -727.0460247911391  E_coul = 201.2860515802426
cycle= 3 E= -525.759973210897  delta_E= -7.41e-05  |g|= 0.0068  |ddm|= 0.0187
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0125117
diis-c [-1.46306136e-06 -1.42143924e-03  1.47882123e-01  8.53539316e-01]
  HOMO = -0.592349980991648  LUMO = 0.457340810513548
  mo_energy =
[-1.18197890e+02 -1.22820561e+01 -9.56938697e+00 -9.56938697e+00
 -9.56938697e+00 -1.25870399e+00 -5.92349981e-01 -5.92349981e-01
 -5.92349981e-01  4.57340811e-01  4.57340811e-01  4.57340811e-01
  2.87242723e+00  2.87242723e+00  2.87242723e+00  3.19604040e+00
  1.71219018e+01  1.71219018e+01  1.71219018e+01  8.69432975e+01
  8.69432975e+01  8.69432975e+01  1.90840769e+02  4.19326944e+02
  4.19326944e+02  4.19326944e+02  1.27309502e+03  1.27309502e+03
  1.27309502e+03  1.92002362e+03  2.97517116e+03  2.97517116e+03
  2.97517116e+03  6.60431069e+03  6.60431069e+03  6.60431069e+03
  8.27762814e+03  2.46650703e+04  7.54610238e+04]
E1 = -727.0734108214466  E_coul = 201.3134349421075
cycle= 4 E= -525.759975879339  delta_E= -2.67e-06  |g|= 0.000157  |ddm|= 0.00242
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000123014
diis-c [-8.89235407e-09  2.06913249e-05 -6.07689244e-03 -3.89607956e-02
  1.04501700e+00]
  HOMO = -0.592324757899874  LUMO = 0.457346205784893
  mo_energy =
[-1.18197790e+02 -1.22819288e+01 -9.56928065e+00 -9.56928065e+00
 -9.56928065e+00 -1.25864921e+00 -5.92324758e-01 -5.92324758e-01
 -5.92324758e-01  4.57346206e-01  4.57346206e-01  4.57346206e-01
  2.87246666e+00  2.87246666e+00  2.87246666e+00  3.19613293e+00
  1.71219949e+01  1.71219949e+01  1.71219949e+01  8.69434040e+01
  8.69434040e+01  8.69434040e+01  1.90840876e+02  4.19327044e+02
  4.19327044e+02  4.19327044e+02  1.27309511e+03  1.27309511e+03
  1.27309511e+03  1.92002368e+03  2.97517123e+03  2.97517123e+03
  2.97517123e+03  6.60431075e+03  6.60431075e+03  6.60431075e+03
  8.27762818e+03  2.46650704e+04  7.54610239e+04]
E1 = -727.0729641291665  E_coul = 201.31298824720972
cycle= 5 E= -525.759975881957  delta_E= -2.62e-09  |g|= 3.08e-05  |ddm|= 0.000176
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.66563e-05
diis-c [-1.73033592e-11  1.20704732e-05 -1.51825618e-03 -1.31234623e-02
  4.25180293e-02  9.72111619e-01]
  HOMO = -0.592336530423858  LUMO = 0.457342371974487
  mo_energy =
[-1.18197836e+02 -1.22819624e+01 -9.56931744e+00 -9.56931744e+00
 -9.56931744e+00 -1.25866076e+00 -5.92336530e-01 -5.92336530e-01
 -5.92336530e-01  4.57342372e-01  4.57342372e-01  4.57342372e-01
  2.87245053e+00  2.87245053e+00  2.87245053e+00  3.19611586e+00
  1.71219620e+01  1.71219620e+01  1.71219620e+01  8.69433625e+01
  8.69433625e+01  8.69433625e+01  1.90840831e+02  4.19326998e+02
  4.19326998e+02  4.19326998e+02  1.27309506e+03  1.27309506e+03
  1.27309506e+03  1.92002363e+03  2.97517118e+03  2.97517118e+03
  2.97517118e+03  6.60431070e+03  6.60431070e+03  6.60431070e+03
  8.27762813e+03  2.46650703e+04  7.54610238e+04]
E1 = -727.0731029419603  E_coul = 201.31312705991553
cycle= 6 E= -525.759975882045  delta_E= -8.8e-11  |g|= 8.32e-07  |ddm|= 1.31e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -727.0731029419603  E_coul = 201.31312705991553
  HOMO = -0.592336577334106  LUMO = 0.457342377913422
  mo_energy =
[-1.18197837e+02 -1.22819629e+01 -9.56931802e+00 -9.56931802e+00
 -9.56931802e+00 -1.25866071e+00 -5.92336577e-01 -5.92336577e-01
 -5.92336577e-01  4.57342378e-01  4.57342378e-01  4.57342378e-01
  2.87245044e+00  2.87245044e+00  2.87245044e+00  3.19611585e+00
  1.71219615e+01  1.71219615e+01  1.71219615e+01  8.69433618e+01
  8.69433618e+01  8.69433618e+01  1.90840831e+02  4.19326997e+02
  4.19326997e+02  4.19326997e+02  1.27309506e+03  1.27309506e+03
  1.27309506e+03  1.92002362e+03  2.97517118e+03  2.97517118e+03
  2.97517118e+03  6.60431069e+03  6.60431069e+03  6.60431069e+03
  8.27762813e+03  2.46650703e+04  7.54610238e+04]
E1 = -727.0731061430134  E_coul = 201.31313026096893
Extra cycle  E= -525.759975882045  delta_E= 2.27e-13  |g|= 2.05e-07  |ddm|= 8.06e-07
    CPU time for scf_cycle      0.64 sec, wall time      0.25 sec
exp = [2.61825079e+04 7.61825062e+03 3.61825046e+03 1.61824573e+03
 2.39774360e+02 5.19945039e+01 5.40914301e+00 1.36187809e+00
 3.70312021e-01 1.36279299e+03 6.65180574e+02 3.03319822e+02
 3.16145734e+02 4.93074651e+01 4.76406700e+00 1.47068317e+01
 4.66108773e-01 1.24951238e+00 1.25569984e-01]
E = -525.7599758820445
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:39:16 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5078651        1
[INPUT] 0    0    [1    /1   ]  7618.25062002        1
[INPUT] 0    0    [1    /1   ]  3618.25045688        1
[INPUT] 0    0    [1    /1   ]  1618.24573107        1
[INPUT] 0    0    [1    /1   ]  239.774360092        1
[INPUT] 0    0    [1    /1   ]  51.9945039289        1
[INPUT] 0    0    [1    /1   ]  5.40914301371        1
[INPUT] 0    0    [1    /1   ]  1.36187808601        1
[INPUT] 0    0    [1    /1   ]  0.370312021335       1
[INPUT] 1    0    [1    /1   ]  1362.79299322        1
[INPUT] 1    0    [1    /1   ]  665.180574014        1
[INPUT] 1    0    [1    /1   ]  303.319821944        1
[INPUT] 1    0    [1    /1   ]  316.145733843        1
[INPUT] 1    0    [1    /1   ]  49.3074651297        1
[INPUT] 1    0    [1    /1   ]  4.76406700058        1
[INPUT] 1    0    [1    /1   ]  14.706831702         1
[INPUT] 1    0    [1    /1   ]  0.466108772627       1
[INPUT] 1    0    [1    /1   ]  1.24951237629        1
[INPUT] 1    0    [1    /1   ]  0.125569984029       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.50786507421, 1.0]], [0, [7618.250620016431, 1.0]], [0, [3618.250456883215, 1.0]], [0, [1618.2457310691927, 1.0]], [0, [239.77436009198874, 1.0]], [0, [51.99450392889733, 1.0]], [0, [5.409143013711989, 1.0]], [0, [1.361878086008634, 1.0]], [0, [0.3703120213351916, 1.0]], [1, [1362.79299321822, 1.0]], [1, [665.1805740140502, 1.0]], [1, [303.31982194354265, 1.0]], [1, [316.1457338430871, 1.0]], [1, [49.307465129716455, 1.0]], [1, [4.7640670005821955, 1.0]], [1, [14.70683170198026, 1.0]], [1, [0.4661087726273113, 1.0]], [1, [1.2495123762877371, 1.0]], [1, [0.12556998402929054, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50786507]
bas 1, expnt(s) = [7618.25062002]
bas 2, expnt(s) = [3618.25045688]
bas 3, expnt(s) = [1618.24573107]
bas 4, expnt(s) = [239.77436009]
bas 5, expnt(s) = [51.99450393]
bas 6, expnt(s) = [5.40914301]
bas 7, expnt(s) = [1.36187809]
bas 8, expnt(s) = [0.37031202]
bas 9, expnt(s) = [1362.79299322]
bas 10, expnt(s) = [665.18057401]
bas 11, expnt(s) = [303.31982194]
bas 12, expnt(s) = [316.14573384]
bas 13, expnt(s) = [49.30746513]
bas 14, expnt(s) = [4.764067]
bas 15, expnt(s) = [14.7068317]
bas 16, expnt(s) = [0.46610877]
bas 17, expnt(s) = [1.24951238]
bas 18, expnt(s) = [0.12556998]
CPU time:        56.23
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024082e+03 7.61825062e+03 2.06018616e+03
 3.61825046e+03 1.17866122e+03 1.61824573e+03 6.44611986e+02
 2.39774360e+02 1.53945529e+02 5.19945039e+01 4.89196232e+01
 5.40914301e+00 8.96110100e+00 1.36187809e+00 3.18506792e+00
 3.70312021e-01 1.19933603e+00 1.36279299e+03 2.41558185e+04
 6.65180574e+02 9.85505017e+03 3.03319822e+02 3.69283908e+03
 3.16145734e+02 3.88905021e+03 4.93074651e+01 3.81175728e+02
 4.76406700e+00 2.05332038e+01 1.47068317e+01 8.40201197e+01
 4.66108773e-01 1.12355281e+00 1.24951238e+00 3.85398567e+00
 1.25569984e-01 2.18067875e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98335051813587
cond(S) = 83500.19416009099
E1 = -728.1798104658526  E_coul = 203.18726095403022
init E= -524.992549511822
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.560996316990372  LUMO = 0.464464589178268
  mo_energy =
[-1.17909766e+02 -1.21614254e+01 -9.43612992e+00 -9.43612992e+00
 -9.43612992e+00 -1.22421047e+00 -5.60996317e-01 -5.60996317e-01
 -5.60996317e-01  4.64464589e-01  4.64464589e-01  4.64464589e-01
  2.91876679e+00  2.91876679e+00  2.91876679e+00  3.24938962e+00
  1.72387376e+01  1.72387376e+01  1.72387376e+01  8.71380563e+01
  8.71380563e+01  8.71380563e+01  1.91093371e+02  4.19609267e+02
  4.19609267e+02  4.19609267e+02  1.27343325e+03  1.27343325e+03
  1.27343325e+03  1.92049637e+03  2.97557803e+03  2.97557803e+03
  2.97557803e+03  6.60484160e+03  6.60484160e+03  6.60484160e+03
  8.27824694e+03  2.46657865e+04  7.54618339e+04]
E1 = -726.5957932301352  E_coul = 200.83683101173483
cycle= 1 E= -525.7589622184  delta_E= -0.766  |g|= 0.207  |ddm|= 0.895
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.50154
diis-c [-0.25154225  1.        ]
  HOMO = -0.600091306444178  LUMO = 0.455017342474419
  mo_energy =
[-1.18259982e+02 -1.23169098e+01 -9.60530865e+00 -9.60530865e+00
 -9.60530865e+00 -1.26860082e+00 -6.00091306e-01 -6.00091306e-01
 -6.00091306e-01  4.55017342e-01  4.55017342e-01  4.55017342e-01
  2.86069605e+00  2.86069605e+00  2.86069605e+00  3.17883825e+00
  1.70910660e+01  1.70910660e+01  1.70910660e+01  8.68943702e+01
  8.68943702e+01  8.68943702e+01  1.90781222e+02  4.19265448e+02
  4.19265448e+02  4.19265448e+02  1.27303009e+03  1.27303009e+03
  1.27303009e+03  1.91995654e+03  2.97510463e+03  2.97510463e+03
  2.97510463e+03  6.60424319e+03  6.60424319e+03  6.60424319e+03
  8.27756022e+03  2.46650023e+04  7.54609558e+04]
E1 = -727.2188388533916  E_coul = 201.45893976081393
cycle= 2 E= -525.759899092578  delta_E= -0.000937  |g|= 0.0401  |ddm|= 0.0519
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0689141
diis-c [-0.00259543  0.08509737  0.91490263]
  HOMO = -0.590437774786939  LUMO = 0.45795426530054
  mo_energy =
[-1.18186920e+02 -1.22753712e+01 -9.56228513e+00 -9.56228513e+00
 -9.56228513e+00 -1.25654452e+00 -5.90437775e-01 -5.90437775e-01
 -5.90437775e-01  4.57954265e-01  4.57954265e-01  4.57954265e-01
  2.87515488e+00  2.87515488e+00  2.87515488e+00  3.19947161e+00
  1.71281115e+01  1.71281115e+01  1.71281115e+01  8.69523004e+01
  8.69523004e+01  8.69523004e+01  1.90851262e+02  4.19337815e+02
  4.19337815e+02  4.19337815e+02  1.27310649e+03  1.27310649e+03
  1.27310649e+03  1.92003571e+03  2.97518301e+03  2.97518301e+03
  2.97518301e+03  6.60432296e+03  6.60432296e+03  6.60432296e+03
  8.27764065e+03  2.46650830e+04  7.54610367e+04]
E1 = -727.0460247911391  E_coul = 201.2860515802426
cycle= 3 E= -525.759973210897  delta_E= -7.41e-05  |g|= 0.0068  |ddm|= 0.0187
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0125117
diis-c [-1.46306136e-06 -1.42143924e-03  1.47882123e-01  8.53539316e-01]
  HOMO = -0.592349980991648  LUMO = 0.457340810513548
  mo_energy =
[-1.18197890e+02 -1.22820561e+01 -9.56938697e+00 -9.56938697e+00
 -9.56938697e+00 -1.25870399e+00 -5.92349981e-01 -5.92349981e-01
 -5.92349981e-01  4.57340811e-01  4.57340811e-01  4.57340811e-01
  2.87242723e+00  2.87242723e+00  2.87242723e+00  3.19604040e+00
  1.71219018e+01  1.71219018e+01  1.71219018e+01  8.69432975e+01
  8.69432975e+01  8.69432975e+01  1.90840769e+02  4.19326944e+02
  4.19326944e+02  4.19326944e+02  1.27309502e+03  1.27309502e+03
  1.27309502e+03  1.92002362e+03  2.97517116e+03  2.97517116e+03
  2.97517116e+03  6.60431069e+03  6.60431069e+03  6.60431069e+03
  8.27762814e+03  2.46650703e+04  7.54610238e+04]
E1 = -727.0734108214466  E_coul = 201.3134349421075
cycle= 4 E= -525.759975879339  delta_E= -2.67e-06  |g|= 0.000157  |ddm|= 0.00242
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000123014
diis-c [-8.89235407e-09  2.06913249e-05 -6.07689244e-03 -3.89607956e-02
  1.04501700e+00]
  HOMO = -0.592324757899874  LUMO = 0.457346205784893
  mo_energy =
[-1.18197790e+02 -1.22819288e+01 -9.56928065e+00 -9.56928065e+00
 -9.56928065e+00 -1.25864921e+00 -5.92324758e-01 -5.92324758e-01
 -5.92324758e-01  4.57346206e-01  4.57346206e-01  4.57346206e-01
  2.87246666e+00  2.87246666e+00  2.87246666e+00  3.19613293e+00
  1.71219949e+01  1.71219949e+01  1.71219949e+01  8.69434040e+01
  8.69434040e+01  8.69434040e+01  1.90840876e+02  4.19327044e+02
  4.19327044e+02  4.19327044e+02  1.27309511e+03  1.27309511e+03
  1.27309511e+03  1.92002368e+03  2.97517123e+03  2.97517123e+03
  2.97517123e+03  6.60431075e+03  6.60431075e+03  6.60431075e+03
  8.27762818e+03  2.46650704e+04  7.54610239e+04]
E1 = -727.0729641291665  E_coul = 201.31298824720972
cycle= 5 E= -525.759975881957  delta_E= -2.62e-09  |g|= 3.08e-05  |ddm|= 0.000176
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.66563e-05
diis-c [-1.73033592e-11  1.20704732e-05 -1.51825618e-03 -1.31234623e-02
  4.25180293e-02  9.72111619e-01]
  HOMO = -0.592336530423858  LUMO = 0.457342371974487
  mo_energy =
[-1.18197836e+02 -1.22819624e+01 -9.56931744e+00 -9.56931744e+00
 -9.56931744e+00 -1.25866076e+00 -5.92336530e-01 -5.92336530e-01
 -5.92336530e-01  4.57342372e-01  4.57342372e-01  4.57342372e-01
  2.87245053e+00  2.87245053e+00  2.87245053e+00  3.19611586e+00
  1.71219620e+01  1.71219620e+01  1.71219620e+01  8.69433625e+01
  8.69433625e+01  8.69433625e+01  1.90840831e+02  4.19326998e+02
  4.19326998e+02  4.19326998e+02  1.27309506e+03  1.27309506e+03
  1.27309506e+03  1.92002363e+03  2.97517118e+03  2.97517118e+03
  2.97517118e+03  6.60431070e+03  6.60431070e+03  6.60431070e+03
  8.27762813e+03  2.46650703e+04  7.54610238e+04]
E1 = -727.0731029419603  E_coul = 201.31312705991553
cycle= 6 E= -525.759975882045  delta_E= -8.8e-11  |g|= 8.32e-07  |ddm|= 1.31e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -727.0731029419603  E_coul = 201.31312705991553
  HOMO = -0.592336577334106  LUMO = 0.457342377913422
  mo_energy =
[-1.18197837e+02 -1.22819629e+01 -9.56931802e+00 -9.56931802e+00
 -9.56931802e+00 -1.25866071e+00 -5.92336577e-01 -5.92336577e-01
 -5.92336577e-01  4.57342378e-01  4.57342378e-01  4.57342378e-01
  2.87245044e+00  2.87245044e+00  2.87245044e+00  3.19611585e+00
  1.71219615e+01  1.71219615e+01  1.71219615e+01  8.69433618e+01
  8.69433618e+01  8.69433618e+01  1.90840831e+02  4.19326997e+02
  4.19326997e+02  4.19326997e+02  1.27309506e+03  1.27309506e+03
  1.27309506e+03  1.92002362e+03  2.97517118e+03  2.97517118e+03
  2.97517118e+03  6.60431069e+03  6.60431069e+03  6.60431069e+03
  8.27762813e+03  2.46650703e+04  7.54610238e+04]
E1 = -727.0731061430134  E_coul = 201.31313026096893
Extra cycle  E= -525.759975882045  delta_E= 2.27e-13  |g|= 2.05e-07  |ddm|= 8.06e-07
    CPU time for scf_cycle      0.64 sec, wall time      0.25 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 83500.19416009099
E1 = -727.0731061430134  E_coul = 201.31313026096893
init E= -525.759975882045
    CPU time for initialize scf      2.69 sec, wall time      0.25 sec
  HOMO = -0.592336497184543  LUMO = 0.457342406868478
  mo_energy =
[-1.18197837e+02 -1.22819626e+01 -9.56931779e+00 -9.56931779e+00
 -9.56931779e+00 -1.25866060e+00 -5.92336497e-01 -5.92336497e-01
 -5.92336497e-01  4.57342407e-01  4.57342407e-01  4.57342407e-01
  2.87245055e+00  2.87245055e+00  2.87245055e+00  3.19611602e+00
  1.71219617e+01  1.71219617e+01  1.71219617e+01  8.69433621e+01
  8.69433621e+01  8.69433621e+01  1.90840831e+02  4.19326997e+02
  4.19326997e+02  4.19326997e+02  1.27309506e+03  1.27309506e+03
  1.27309506e+03  1.92002363e+03  2.97517118e+03  2.97517118e+03
  2.97517118e+03  6.60431069e+03  6.60431069e+03  6.60431069e+03
  8.27762813e+03  2.46650703e+04  7.54610238e+04]
E1 = -727.0731054036953  E_coul = 201.31312952164959
cycle= 1 E= -525.759975882046  delta_E= -1.25e-12  |g|= 4.75e-08  |ddm|= 1.93e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.0731054036953  E_coul = 201.31312952164959
  HOMO = -0.592336509170135  LUMO = 0.457342403731494
  mo_energy =
[-1.18197837e+02 -1.22819627e+01 -9.56931785e+00 -9.56931785e+00
 -9.56931785e+00 -1.25866061e+00 -5.92336509e-01 -5.92336509e-01
 -5.92336509e-01  4.57342404e-01  4.57342404e-01  4.57342404e-01
  2.87245054e+00  2.87245054e+00  2.87245054e+00  3.19611599e+00
  1.71219617e+01  1.71219617e+01  1.71219617e+01  8.69433620e+01
  8.69433620e+01  8.69433620e+01  1.90840831e+02  4.19326997e+02
  4.19326997e+02  4.19326997e+02  1.27309506e+03  1.27309506e+03
  1.27309506e+03  1.92002363e+03  2.97517118e+03  2.97517118e+03
  2.97517118e+03  6.60431069e+03  6.60431069e+03  6.60431069e+03
  8.27762813e+03  2.46650703e+04  7.54610238e+04]
E1 = -727.0731056565018  E_coul = 201.3131297744569
Extra cycle  E= -525.759975882045  delta_E= 9.09e-13  |g|= 1.45e-08  |ddm|= 2.39e-08
    CPU time for scf_cycle      2.84 sec, wall time      0.39 sec
exp = [2.61825079e+04 7.61825062e+03 3.61825046e+03 1.61824573e+03
 2.39774360e+02 5.19945039e+01 5.40914301e+00 1.36187809e+00
 3.70312021e-01 1.36279299e+03 6.65180574e+02 3.03319822e+02
 3.16145734e+02 4.93074651e+01 4.76406700e+00 1.47068317e+01
 4.66108773e-01 1.24951238e+00 1.25569984e-01]
grad_E = [-1.98430335e-06  2.14812654e-05  4.25603206e-05  6.57172765e-04
  1.65601329e-03 -2.04853825e-02  2.98260853e-02 -1.42568772e-01
 -2.27780996e-01  1.30788111e-06  1.98010955e-05  1.07028062e-04
  9.42716254e-05 -1.04475617e-03 -1.80163101e-02  7.77620801e-03
  2.10204428e-01 -6.80329965e-02 -5.29784124e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:39:20 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.507882         1
[INPUT] 0    0    [1    /1   ]  7618.25043571        1
[INPUT] 0    0    [1    /1   ]  3618.25009102        1
[INPUT] 0    0    [1    /1   ]  1618.24008876        1
[INPUT] 0    0    [1    /1   ]  239.761889506        1
[INPUT] 0    0    [1    /1   ]  52.1335470827        1
[INPUT] 0    0    [1    /1   ]  5.91113940996        1
[INPUT] 0    0    [1    /1   ]  2.36564722226        1
[INPUT] 0    0    [1    /1   ]  0.480168672258       1
[INPUT] 1    0    [1    /1   ]  1362.79298223        1
[INPUT] 1    0    [1    /1   ]  665.180405941        1
[INPUT] 1    0    [1    /1   ]  303.318914966        1
[INPUT] 1    0    [1    /1   ]  316.144934933        1
[INPUT] 1    0    [1    /1   ]  49.3142432179        1
[INPUT] 1    0    [1    /1   ]  4.75169651034        1
[INPUT] 1    0    [1    /1   ]  14.6723653776        1
[INPUT] 1    0    [1    /1   ]  0.600686555639       1
[INPUT] 1    0    [1    /1   ]  1.50940801935        1
[INPUT] 1    0    [1    /1   ]  0.164451657091       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.50788204734, 1.0]], [0, [7618.2504357070275, 1.0]], [0, [3618.2500910199105, 1.0]], [0, [1618.2400887607769, 1.0]], [0, [239.76188950596648, 1.0]], [0, [52.13354708265138, 1.0]], [0, [5.911139409962072, 1.0]], [0, [2.365647222259503, 1.0]], [0, [0.48016867225768756, 1.0]], [1, [1362.7929822319218, 1.0]], [1, [665.1804059407249, 1.0]], [1, [303.318914965757, 1.0]], [1, [316.14493493272374, 1.0]], [1, [49.31424321785564, 1.0]], [1, [4.751696510340225, 1.0]], [1, [14.672365377560912, 1.0]], [1, [0.6006865556391251, 1.0]], [1, [1.5094080193521666, 1.0]], [1, [0.16445165709088494, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50788205]
bas 1, expnt(s) = [7618.25043571]
bas 2, expnt(s) = [3618.25009102]
bas 3, expnt(s) = [1618.24008876]
bas 4, expnt(s) = [239.76188951]
bas 5, expnt(s) = [52.13354708]
bas 6, expnt(s) = [5.91113941]
bas 7, expnt(s) = [2.36564722]
bas 8, expnt(s) = [0.48016867]
bas 9, expnt(s) = [1362.79298223]
bas 10, expnt(s) = [665.18040594]
bas 11, expnt(s) = [303.31891497]
bas 12, expnt(s) = [316.14493493]
bas 13, expnt(s) = [49.31424322]
bas 14, expnt(s) = [4.75169651]
bas 15, expnt(s) = [14.67236538]
bas 16, expnt(s) = [0.60068656]
bas 17, expnt(s) = [1.50940802]
bas 18, expnt(s) = [0.16445166]
CPU time:        64.30
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024083e+03 7.61825044e+03 2.06018613e+03
 3.61825009e+03 1.17866113e+03 1.61824009e+03 6.44610301e+02
 2.39761890e+02 1.53939524e+02 5.21335471e+01 4.90177057e+01
 5.91113941e+00 9.57785870e+00 2.36564722e+00 4.81922840e+00
 4.80168672e-01 1.45733834e+00 1.36279298e+03 2.41558182e+04
 6.65180406e+02 9.85504706e+03 3.03318915e+02 3.69282528e+03
 3.16144935e+02 3.88903792e+03 4.93142432e+01 3.81241227e+02
 4.75169651e+00 2.04665792e+01 1.46723654e+01 8.37740592e+01
 6.00686556e-01 1.54274548e+00 1.50940802e+00 4.88081907e+00
 1.64451657e-01 3.05514769e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.960353103709966
cond(S) = 83745.41426112813
E1 = -728.2642148115137  E_coul = 203.18480730324018
init E= -525.079407508274
    CPU time for initialize scf      0.45 sec, wall time      0.05 sec
  HOMO = -0.550883896962788  LUMO = 0.671031902438231
  mo_energy =
[-1.17965957e+02 -1.21736503e+01 -9.44275747e+00 -9.44275747e+00
 -9.44275747e+00 -1.20082264e+00 -5.50883897e-01 -5.50883897e-01
 -5.50883897e-01  6.71031902e-01  6.71031902e-01  6.71031902e-01
  3.92072659e+00  3.92072659e+00  3.92072659e+00  6.51528088e+00
  1.87797100e+01  1.87797100e+01  1.87797100e+01  8.82326698e+01
  8.82326698e+01  8.82326698e+01  1.97891687e+02  4.20310724e+02
  4.20310724e+02  4.20310724e+02  1.27401784e+03  1.27401784e+03
  1.27401784e+03  1.92556269e+03  2.97611169e+03  2.97611169e+03
  2.97611169e+03  6.60532246e+03  6.60532246e+03  6.60532246e+03
  8.28270287e+03  2.46699686e+04  7.54657114e+04]
E1 = -727.5275439123436  E_coul = 201.69831107544067
cycle= 1 E= -525.829232836903  delta_E= -0.75  |g|= 0.186  |ddm|= 1.26
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.472588
diis-c [-0.22333907  1.        ]
  HOMO = -0.568563515918781  LUMO = 0.667888219148881
  mo_energy =
[-1.18238326e+02 -1.22638627e+01 -9.54007113e+00 -9.54007113e+00
 -9.54007113e+00 -1.23768039e+00 -5.68563516e-01 -5.68563516e-01
 -5.68563516e-01  6.67888219e-01  6.67888219e-01  6.67888219e-01
  3.88409185e+00  3.88409185e+00  3.88409185e+00  6.45090801e+00
  1.86943559e+01  1.86943559e+01  1.86943559e+01  8.80637068e+01
  8.80637068e+01  8.80637068e+01  1.97656716e+02  4.20041398e+02
  4.20041398e+02  4.20041398e+02  1.27368313e+03  1.27368313e+03
  1.27368313e+03  1.92507610e+03  2.97569797e+03  2.97569797e+03
  2.97569797e+03  6.60477504e+03  6.60477504e+03  6.60477504e+03
  8.28206165e+03  2.46692263e+04  7.54648729e+04]
E1 = -727.7976830659439  E_coul = 201.9678935612812
cycle= 2 E= -525.829789504663  delta_E= -0.000557  |g|= 0.0253  |ddm|= 0.0617
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0493781
diis-c [-0.00154424  0.05969667  0.94030333]
  HOMO = -0.566547067065806  LUMO = 0.668727386984053
  mo_energy =
[-1.18196727e+02 -1.22458722e+01 -9.52052199e+00 -9.52052199e+00
 -9.52052199e+00 -1.23520110e+00 -5.66547067e-01 -5.66547067e-01
 -5.66547067e-01  6.68727387e-01  6.68727387e-01  6.68727387e-01
  3.88883933e+00  3.88883933e+00  3.88883933e+00  6.45999903e+00
  1.87102646e+01  1.87102646e+01  1.87102646e+01  8.80939168e+01
  8.80939168e+01  8.80939168e+01  1.97695919e+02  4.20082501e+02
  4.20082501e+02  4.20082501e+02  1.27372756e+03  1.27372756e+03
  1.27372756e+03  1.92512320e+03  2.97574420e+03  2.97574420e+03
  2.97574420e+03  6.60482274e+03  6.60482274e+03  6.60482274e+03
  8.28211011e+03  2.46692752e+04  7.54649221e+04]
E1 = -727.7143153378462  E_coul = 201.88450591441992
cycle= 3 E= -525.829809423426  delta_E= -1.99e-05  |g|= 0.00415  |ddm|= 0.00733
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00707679
diis-c [-1.53360829e-06 -8.26563445e-04  1.19910119e-01  8.80916444e-01]
  HOMO = -0.567718246866836  LUMO = 0.668129029320199
  mo_energy =
[-1.18203615e+02 -1.22499157e+01 -9.52470361e+00 -9.52470361e+00
 -9.52470361e+00 -1.23677940e+00 -5.67718247e-01 -5.67718247e-01
 -5.67718247e-01  6.68129029e-01  6.68129029e-01  6.68129029e-01
  3.88688570e+00  3.88688570e+00  3.88688570e+00  6.45701963e+00
  1.87065957e+01  1.87065957e+01  1.87065957e+01  8.80883956e+01
  8.80883956e+01  8.80883956e+01  1.97689324e+02  4.20075668e+02
  4.20075668e+02  4.20075668e+02  1.27372034e+03  1.27372034e+03
  1.27372034e+03  1.92511564e+03  2.97573676e+03  2.97573676e+03
  2.97573676e+03  6.60481508e+03  6.60481508e+03  6.60481508e+03
  8.28210233e+03  2.46692674e+04  7.54649141e+04]
E1 = -727.7289019376311  E_coul = 201.89909174477472
cycle= 4 E= -525.829810192856  delta_E= -7.69e-07  |g|= 0.000253  |ddm|= 0.00177
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000488003
diis-c [-1.58903494e-08  9.36675552e-06 -4.68525393e-03  3.21002454e-02
  9.72575642e-01]
  HOMO = -0.567659461395926  LUMO = 0.66815286570881
  mo_energy =
[-1.18203223e+02 -1.22496359e+01 -9.52440294e+00 -9.52440294e+00
 -9.52440294e+00 -1.23670964e+00 -5.67659461e-01 -5.67659461e-01
 -5.67659461e-01  6.68152866e-01  6.68152866e-01  6.68152866e-01
  3.88699334e+00  3.88699334e+00  3.88699334e+00  6.45717912e+00
  1.87068500e+01  1.87068500e+01  1.87068500e+01  8.80887380e+01
  8.80887380e+01  8.80887380e+01  1.97689702e+02  4.20076057e+02
  4.20076057e+02  4.20076057e+02  1.27372074e+03  1.27372074e+03
  1.27372074e+03  1.92511606e+03  2.97573717e+03  2.97573717e+03
  2.97573717e+03  6.60481551e+03  6.60481551e+03  6.60481551e+03
  8.28210277e+03  2.46692678e+04  7.54649146e+04]
E1 = -727.7276590532935  E_coul = 201.8978488542453
cycle= 5 E= -525.829810199048  delta_E= -6.19e-09  |g|= 2.49e-05  |ddm|= 0.000155
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.17538e-05
diis-c [-4.48378855e-11  1.48635893e-05 -1.75572967e-03 -1.34186794e-02
  1.12627281e-02  1.00389682e+00]
  HOMO = -0.567671868137144  LUMO = 0.668146292262672
  mo_energy =
[-1.18203251e+02 -1.22496640e+01 -9.52442971e+00 -9.52442971e+00
 -9.52442971e+00 -1.23672689e+00 -5.67671868e-01 -5.67671868e-01
 -5.67671868e-01  6.68146292e-01  6.68146292e-01  6.68146292e-01
  3.88697444e+00  3.88697444e+00  3.88697444e+00  6.45715225e+00
  1.87068245e+01  1.87068245e+01  1.87068245e+01  8.80887096e+01
  8.80887096e+01  8.80887096e+01  1.97689672e+02  4.20076028e+02
  4.20076028e+02  4.20076028e+02  1.27372072e+03  1.27372072e+03
  1.27372072e+03  1.92511603e+03  2.97573715e+03  2.97573715e+03
  2.97573715e+03  6.60481549e+03  6.60481549e+03  6.60481549e+03
  8.28210274e+03  2.46692678e+04  7.54649146e+04]
E1 = -727.7277310655196  E_coul = 201.8979208664241
cycle= 6 E= -525.829810199096  delta_E= -4.74e-11  |g|= 4.16e-07  |ddm|= 1.98e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -727.7277310655196  E_coul = 201.8979208664241
  HOMO = -0.567671721836934  LUMO = 0.668146374815618
  mo_energy =
[-1.18203251e+02 -1.22496638e+01 -9.52442939e+00 -9.52442939e+00
 -9.52442939e+00 -1.23672671e+00 -5.67671722e-01 -5.67671722e-01
 -5.67671722e-01  6.68146375e-01  6.68146375e-01  6.68146375e-01
  3.88697465e+00  3.88697465e+00  3.88697465e+00  6.45715251e+00
  1.87068248e+01  1.87068248e+01  1.87068248e+01  8.80887101e+01
  8.80887101e+01  8.80887101e+01  1.97689673e+02  4.20076029e+02
  4.20076029e+02  4.20076029e+02  1.27372072e+03  1.27372072e+03
  1.27372072e+03  1.92511604e+03  2.97573715e+03  2.97573715e+03
  2.97573715e+03  6.60481549e+03  6.60481549e+03  6.60481549e+03
  8.28210274e+03  2.46692678e+04  7.54649146e+04]
E1 = -727.7277302356638  E_coul = 201.89792003656856
Extra cycle  E= -525.829810199095  delta_E= 3.41e-13  |g|= 7.06e-08  |ddm|= 2.61e-07
    CPU time for scf_cycle      0.66 sec, wall time      0.26 sec
exp = [2.61825079e+04 7.61825044e+03 3.61825009e+03 1.61824009e+03
 2.39761890e+02 5.21335471e+01 5.91113941e+00 2.36564722e+00
 4.80168672e-01 1.36279298e+03 6.65180406e+02 3.03318915e+02
 3.16144935e+02 4.93142432e+01 4.75169651e+00 1.46723654e+01
 6.00686556e-01 1.50940802e+00 1.64451657e-01]
E = -525.8298101990952
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:39:21 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.507882         1
[INPUT] 0    0    [1    /1   ]  7618.25043571        1
[INPUT] 0    0    [1    /1   ]  3618.25009102        1
[INPUT] 0    0    [1    /1   ]  1618.24008876        1
[INPUT] 0    0    [1    /1   ]  239.761889506        1
[INPUT] 0    0    [1    /1   ]  52.1335470827        1
[INPUT] 0    0    [1    /1   ]  5.91113940996        1
[INPUT] 0    0    [1    /1   ]  2.36564722226        1
[INPUT] 0    0    [1    /1   ]  0.480168672258       1
[INPUT] 1    0    [1    /1   ]  1362.79298223        1
[INPUT] 1    0    [1    /1   ]  665.180405941        1
[INPUT] 1    0    [1    /1   ]  303.318914966        1
[INPUT] 1    0    [1    /1   ]  316.144934933        1
[INPUT] 1    0    [1    /1   ]  49.3142432179        1
[INPUT] 1    0    [1    /1   ]  4.75169651034        1
[INPUT] 1    0    [1    /1   ]  14.6723653776        1
[INPUT] 1    0    [1    /1   ]  0.600686555639       1
[INPUT] 1    0    [1    /1   ]  1.50940801935        1
[INPUT] 1    0    [1    /1   ]  0.164451657091       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.50788204734, 1.0]], [0, [7618.2504357070275, 1.0]], [0, [3618.2500910199105, 1.0]], [0, [1618.2400887607769, 1.0]], [0, [239.76188950596648, 1.0]], [0, [52.13354708265138, 1.0]], [0, [5.911139409962072, 1.0]], [0, [2.365647222259503, 1.0]], [0, [0.48016867225768756, 1.0]], [1, [1362.7929822319218, 1.0]], [1, [665.1804059407249, 1.0]], [1, [303.318914965757, 1.0]], [1, [316.14493493272374, 1.0]], [1, [49.31424321785564, 1.0]], [1, [4.751696510340225, 1.0]], [1, [14.672365377560912, 1.0]], [1, [0.6006865556391251, 1.0]], [1, [1.5094080193521666, 1.0]], [1, [0.16445165709088494, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50788205]
bas 1, expnt(s) = [7618.25043571]
bas 2, expnt(s) = [3618.25009102]
bas 3, expnt(s) = [1618.24008876]
bas 4, expnt(s) = [239.76188951]
bas 5, expnt(s) = [52.13354708]
bas 6, expnt(s) = [5.91113941]
bas 7, expnt(s) = [2.36564722]
bas 8, expnt(s) = [0.48016867]
bas 9, expnt(s) = [1362.79298223]
bas 10, expnt(s) = [665.18040594]
bas 11, expnt(s) = [303.31891497]
bas 12, expnt(s) = [316.14493493]
bas 13, expnt(s) = [49.31424322]
bas 14, expnt(s) = [4.75169651]
bas 15, expnt(s) = [14.67236538]
bas 16, expnt(s) = [0.60068656]
bas 17, expnt(s) = [1.50940802]
bas 18, expnt(s) = [0.16445166]
CPU time:        65.01
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024083e+03 7.61825044e+03 2.06018613e+03
 3.61825009e+03 1.17866113e+03 1.61824009e+03 6.44610301e+02
 2.39761890e+02 1.53939524e+02 5.21335471e+01 4.90177057e+01
 5.91113941e+00 9.57785870e+00 2.36564722e+00 4.81922840e+00
 4.80168672e-01 1.45733834e+00 1.36279298e+03 2.41558182e+04
 6.65180406e+02 9.85504706e+03 3.03318915e+02 3.69282528e+03
 3.16144935e+02 3.88903792e+03 4.93142432e+01 3.81241227e+02
 4.75169651e+00 2.04665792e+01 1.46723654e+01 8.37740592e+01
 6.00686556e-01 1.54274548e+00 1.50940802e+00 4.88081907e+00
 1.64451657e-01 3.05514769e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.960353103709966
cond(S) = 83745.41426112813
E1 = -728.2642148115137  E_coul = 203.18480730324018
init E= -525.079407508274
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.550883896962788  LUMO = 0.671031902438231
  mo_energy =
[-1.17965957e+02 -1.21736503e+01 -9.44275747e+00 -9.44275747e+00
 -9.44275747e+00 -1.20082264e+00 -5.50883897e-01 -5.50883897e-01
 -5.50883897e-01  6.71031902e-01  6.71031902e-01  6.71031902e-01
  3.92072659e+00  3.92072659e+00  3.92072659e+00  6.51528088e+00
  1.87797100e+01  1.87797100e+01  1.87797100e+01  8.82326698e+01
  8.82326698e+01  8.82326698e+01  1.97891687e+02  4.20310724e+02
  4.20310724e+02  4.20310724e+02  1.27401784e+03  1.27401784e+03
  1.27401784e+03  1.92556269e+03  2.97611169e+03  2.97611169e+03
  2.97611169e+03  6.60532246e+03  6.60532246e+03  6.60532246e+03
  8.28270287e+03  2.46699686e+04  7.54657114e+04]
E1 = -727.5275439123436  E_coul = 201.69831107544067
cycle= 1 E= -525.829232836903  delta_E= -0.75  |g|= 0.186  |ddm|= 1.26
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.472588
diis-c [-0.22333907  1.        ]
  HOMO = -0.568563515918781  LUMO = 0.667888219148881
  mo_energy =
[-1.18238326e+02 -1.22638627e+01 -9.54007113e+00 -9.54007113e+00
 -9.54007113e+00 -1.23768039e+00 -5.68563516e-01 -5.68563516e-01
 -5.68563516e-01  6.67888219e-01  6.67888219e-01  6.67888219e-01
  3.88409185e+00  3.88409185e+00  3.88409185e+00  6.45090801e+00
  1.86943559e+01  1.86943559e+01  1.86943559e+01  8.80637068e+01
  8.80637068e+01  8.80637068e+01  1.97656716e+02  4.20041398e+02
  4.20041398e+02  4.20041398e+02  1.27368313e+03  1.27368313e+03
  1.27368313e+03  1.92507610e+03  2.97569797e+03  2.97569797e+03
  2.97569797e+03  6.60477504e+03  6.60477504e+03  6.60477504e+03
  8.28206165e+03  2.46692263e+04  7.54648729e+04]
E1 = -727.7976830659439  E_coul = 201.9678935612812
cycle= 2 E= -525.829789504663  delta_E= -0.000557  |g|= 0.0253  |ddm|= 0.0617
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0493781
diis-c [-0.00154424  0.05969667  0.94030333]
  HOMO = -0.566547067065806  LUMO = 0.668727386984053
  mo_energy =
[-1.18196727e+02 -1.22458722e+01 -9.52052199e+00 -9.52052199e+00
 -9.52052199e+00 -1.23520110e+00 -5.66547067e-01 -5.66547067e-01
 -5.66547067e-01  6.68727387e-01  6.68727387e-01  6.68727387e-01
  3.88883933e+00  3.88883933e+00  3.88883933e+00  6.45999903e+00
  1.87102646e+01  1.87102646e+01  1.87102646e+01  8.80939168e+01
  8.80939168e+01  8.80939168e+01  1.97695919e+02  4.20082501e+02
  4.20082501e+02  4.20082501e+02  1.27372756e+03  1.27372756e+03
  1.27372756e+03  1.92512320e+03  2.97574420e+03  2.97574420e+03
  2.97574420e+03  6.60482274e+03  6.60482274e+03  6.60482274e+03
  8.28211011e+03  2.46692752e+04  7.54649221e+04]
E1 = -727.7143153378462  E_coul = 201.88450591441992
cycle= 3 E= -525.829809423426  delta_E= -1.99e-05  |g|= 0.00415  |ddm|= 0.00733
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00707679
diis-c [-1.53360829e-06 -8.26563445e-04  1.19910119e-01  8.80916444e-01]
  HOMO = -0.567718246866836  LUMO = 0.668129029320199
  mo_energy =
[-1.18203615e+02 -1.22499157e+01 -9.52470361e+00 -9.52470361e+00
 -9.52470361e+00 -1.23677940e+00 -5.67718247e-01 -5.67718247e-01
 -5.67718247e-01  6.68129029e-01  6.68129029e-01  6.68129029e-01
  3.88688570e+00  3.88688570e+00  3.88688570e+00  6.45701963e+00
  1.87065957e+01  1.87065957e+01  1.87065957e+01  8.80883956e+01
  8.80883956e+01  8.80883956e+01  1.97689324e+02  4.20075668e+02
  4.20075668e+02  4.20075668e+02  1.27372034e+03  1.27372034e+03
  1.27372034e+03  1.92511564e+03  2.97573676e+03  2.97573676e+03
  2.97573676e+03  6.60481508e+03  6.60481508e+03  6.60481508e+03
  8.28210233e+03  2.46692674e+04  7.54649141e+04]
E1 = -727.7289019376311  E_coul = 201.89909174477472
cycle= 4 E= -525.829810192856  delta_E= -7.69e-07  |g|= 0.000253  |ddm|= 0.00177
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000488003
diis-c [-1.58903494e-08  9.36675552e-06 -4.68525393e-03  3.21002454e-02
  9.72575642e-01]
  HOMO = -0.567659461395926  LUMO = 0.66815286570881
  mo_energy =
[-1.18203223e+02 -1.22496359e+01 -9.52440294e+00 -9.52440294e+00
 -9.52440294e+00 -1.23670964e+00 -5.67659461e-01 -5.67659461e-01
 -5.67659461e-01  6.68152866e-01  6.68152866e-01  6.68152866e-01
  3.88699334e+00  3.88699334e+00  3.88699334e+00  6.45717912e+00
  1.87068500e+01  1.87068500e+01  1.87068500e+01  8.80887380e+01
  8.80887380e+01  8.80887380e+01  1.97689702e+02  4.20076057e+02
  4.20076057e+02  4.20076057e+02  1.27372074e+03  1.27372074e+03
  1.27372074e+03  1.92511606e+03  2.97573717e+03  2.97573717e+03
  2.97573717e+03  6.60481551e+03  6.60481551e+03  6.60481551e+03
  8.28210277e+03  2.46692678e+04  7.54649146e+04]
E1 = -727.7276590532935  E_coul = 201.8978488542453
cycle= 5 E= -525.829810199048  delta_E= -6.19e-09  |g|= 2.49e-05  |ddm|= 0.000155
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.17538e-05
diis-c [-4.48378855e-11  1.48635893e-05 -1.75572967e-03 -1.34186794e-02
  1.12627281e-02  1.00389682e+00]
  HOMO = -0.567671868137144  LUMO = 0.668146292262672
  mo_energy =
[-1.18203251e+02 -1.22496640e+01 -9.52442971e+00 -9.52442971e+00
 -9.52442971e+00 -1.23672689e+00 -5.67671868e-01 -5.67671868e-01
 -5.67671868e-01  6.68146292e-01  6.68146292e-01  6.68146292e-01
  3.88697444e+00  3.88697444e+00  3.88697444e+00  6.45715225e+00
  1.87068245e+01  1.87068245e+01  1.87068245e+01  8.80887096e+01
  8.80887096e+01  8.80887096e+01  1.97689672e+02  4.20076028e+02
  4.20076028e+02  4.20076028e+02  1.27372072e+03  1.27372072e+03
  1.27372072e+03  1.92511603e+03  2.97573715e+03  2.97573715e+03
  2.97573715e+03  6.60481549e+03  6.60481549e+03  6.60481549e+03
  8.28210274e+03  2.46692678e+04  7.54649146e+04]
E1 = -727.7277310655196  E_coul = 201.8979208664241
cycle= 6 E= -525.829810199096  delta_E= -4.74e-11  |g|= 4.16e-07  |ddm|= 1.98e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -727.7277310655196  E_coul = 201.8979208664241
  HOMO = -0.567671721836934  LUMO = 0.668146374815618
  mo_energy =
[-1.18203251e+02 -1.22496638e+01 -9.52442939e+00 -9.52442939e+00
 -9.52442939e+00 -1.23672671e+00 -5.67671722e-01 -5.67671722e-01
 -5.67671722e-01  6.68146375e-01  6.68146375e-01  6.68146375e-01
  3.88697465e+00  3.88697465e+00  3.88697465e+00  6.45715251e+00
  1.87068248e+01  1.87068248e+01  1.87068248e+01  8.80887101e+01
  8.80887101e+01  8.80887101e+01  1.97689673e+02  4.20076029e+02
  4.20076029e+02  4.20076029e+02  1.27372072e+03  1.27372072e+03
  1.27372072e+03  1.92511604e+03  2.97573715e+03  2.97573715e+03
  2.97573715e+03  6.60481549e+03  6.60481549e+03  6.60481549e+03
  8.28210274e+03  2.46692678e+04  7.54649146e+04]
E1 = -727.7277302356638  E_coul = 201.89792003656856
Extra cycle  E= -525.829810199095  delta_E= 3.41e-13  |g|= 7.06e-08  |ddm|= 2.61e-07
    CPU time for scf_cycle      0.64 sec, wall time      0.25 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 83745.41426112813
E1 = -727.7277302356638  E_coul = 201.89792003656856
init E= -525.829810199095
    CPU time for initialize scf      2.73 sec, wall time      0.24 sec
  HOMO = -0.567671728427474  LUMO = 0.668146372680708
  mo_energy =
[-1.18203251e+02 -1.22496638e+01 -9.52442946e+00 -9.52442946e+00
 -9.52442946e+00 -1.23672672e+00 -5.67671728e-01 -5.67671728e-01
 -5.67671728e-01  6.68146373e-01  6.68146373e-01  6.68146373e-01
  3.88697464e+00  3.88697464e+00  3.88697464e+00  6.45715247e+00
  1.87068248e+01  1.87068248e+01  1.87068248e+01  8.80887100e+01
  8.80887100e+01  8.80887100e+01  1.97689673e+02  4.20076028e+02
  4.20076028e+02  4.20076028e+02  1.27372072e+03  1.27372072e+03
  1.27372072e+03  1.92511604e+03  2.97573715e+03  2.97573715e+03
  2.97573715e+03  6.60481549e+03  6.60481549e+03  6.60481549e+03
  8.28210274e+03  2.46692678e+04  7.54649146e+04]
E1 = -727.7277305238523  E_coul = 201.89792032475688
cycle= 1 E= -525.829810199095  delta_E= -2.27e-13  |g|= 1.76e-08  |ddm|= 3.36e-08
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.7277305238523  E_coul = 201.89792032475688
  HOMO = -0.567671722705747  LUMO = 0.66814637558747
  mo_energy =
[-1.18203251e+02 -1.22496638e+01 -9.52442943e+00 -9.52442943e+00
 -9.52442943e+00 -1.23672671e+00 -5.67671723e-01 -5.67671723e-01
 -5.67671723e-01  6.68146376e-01  6.68146376e-01  6.68146376e-01
  3.88697465e+00  3.88697465e+00  3.88697465e+00  6.45715249e+00
  1.87068248e+01  1.87068248e+01  1.87068248e+01  8.80887100e+01
  8.80887100e+01  8.80887100e+01  1.97689673e+02  4.20076028e+02
  4.20076028e+02  4.20076028e+02  1.27372072e+03  1.27372072e+03
  1.27372072e+03  1.92511604e+03  2.97573715e+03  2.97573715e+03
  2.97573715e+03  6.60481549e+03  6.60481549e+03  6.60481549e+03
  8.28210274e+03  2.46692678e+04  7.54649146e+04]
E1 = -727.7277304479618  E_coul = 201.89792024886475
Extra cycle  E= -525.829810199097  delta_E= -1.59e-12  |g|= 4.64e-09  |ddm|= 7.96e-09
    CPU time for scf_cycle      2.85 sec, wall time      0.36 sec
exp = [2.61825079e+04 7.61825044e+03 3.61825009e+03 1.61824009e+03
 2.39761890e+02 5.21335471e+01 5.91113941e+00 2.36564722e+00
 4.80168672e-01 1.36279298e+03 6.65180406e+02 3.03318915e+02
 3.16144935e+02 4.93142432e+01 4.75169651e+00 1.46723654e+01
 6.00686556e-01 1.50940802e+00 1.64451657e-01]
grad_E = [-1.98104865e-06  2.13080906e-05  4.20632336e-05  6.50735667e-04
  2.23527275e-03 -3.24419175e-02 -5.45772050e-02 -1.49274434e-02
  7.12073822e-01  1.37092370e-06  2.02494685e-05  1.09878189e-04
  9.67730338e-05 -1.66945704e-03 -6.85717757e-02  1.75074970e-02
  2.18491340e-01 -1.45894272e-02 -5.65133310e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:39:25 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5079024        1
[INPUT] 0    0    [1    /1   ]  7618.2502147         1
[INPUT] 0    0    [1    /1   ]  3618.24965246        1
[INPUT] 0    0    [1    /1   ]  1618.23332404        1
[INPUT] 0    0    [1    /1   ]  239.746432349        1
[INPUT] 0    0    [1    /1   ]  52.3113344352        1
[INPUT] 0    0    [1    /1   ]  6.45001373361        1
[INPUT] 0    0    [1    /1   ]  3.58968992481        1
[INPUT] 0    0    [1    /1   ]  0.316946773146       1
[INPUT] 1    0    [1    /1   ]  1362.79296896        1
[INPUT] 1    0    [1    /1   ]  665.180203666        1
[INPUT] 1    0    [1    /1   ]  303.317822831        1
[INPUT] 1    0    [1    /1   ]  316.143972939        1
[INPUT] 1    0    [1    /1   ]  49.3232203264        1
[INPUT] 1    0    [1    /1   ]  4.79852470613        1
[INPUT] 1    0    [1    /1   ]  14.6187516862        1
[INPUT] 1    0    [1    /1   ]  0.776918220238       1
[INPUT] 1    0    [1    /1   ]  1.77957631856        1
[INPUT] 1    0    [1    /1   ]  0.260502566177       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.50790241174, 1.0]], [0, [7618.250214701194, 1.0]], [0, [3618.249652463297, 1.0]], [0, [1618.233324039474, 1.0]], [0, [239.74643234864124, 1.0]], [0, [52.311334435157264, 1.0]], [0, [6.450013733606513, 1.0]], [0, [3.589689924811144, 1.0]], [0, [0.31694677314599184, 1.0]], [1, [1362.7929689627194, 1.0]], [1, [665.1802036660099, 1.0]], [1, [303.3178228306435, 1.0]], [1, [316.14397293879523, 1.0]], [1, [49.32322032637329, 1.0]], [1, [4.79852470613224, 1.0]], [1, [14.618751686202266, 1.0]], [1, [0.7769182202380945, 1.0]], [1, [1.7795763185616216, 1.0]], [1, [0.2605025661765524, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50790241]
bas 1, expnt(s) = [7618.2502147]
bas 2, expnt(s) = [3618.24965246]
bas 3, expnt(s) = [1618.23332404]
bas 4, expnt(s) = [239.74643235]
bas 5, expnt(s) = [52.31133444]
bas 6, expnt(s) = [6.45001373]
bas 7, expnt(s) = [3.58968992]
bas 8, expnt(s) = [0.31694677]
bas 9, expnt(s) = [1362.79296896]
bas 10, expnt(s) = [665.18020367]
bas 11, expnt(s) = [303.31782283]
bas 12, expnt(s) = [316.14397294]
bas 13, expnt(s) = [49.32322033]
bas 14, expnt(s) = [4.79852471]
bas 15, expnt(s) = [14.61875169]
bas 16, expnt(s) = [0.77691822]
bas 17, expnt(s) = [1.77957632]
bas 18, expnt(s) = [0.26050257]
CPU time:        73.08
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024083e+03 7.61825021e+03 2.06018608e+03
 3.61824965e+03 1.17866102e+03 1.61823332e+03 6.44608280e+02
 2.39746432e+02 1.53932080e+02 5.23113344e+01 4.91430236e+01
 6.45001373e+00 1.02255224e+01 3.58968992e+00 6.58882126e+00
 3.16946773e-01 1.06722201e+00 1.36279297e+03 2.41558179e+04
 6.65180204e+02 9.85504331e+03 3.03317823e+02 3.69280866e+03
 3.16143973e+02 3.88902313e+03 4.93232203e+01 3.81327980e+02
 4.79852471e+00 2.07190129e+01 1.46187517e+01 8.33915899e+01
 7.76918220e-01 2.12791132e+00 1.77957632e+00 5.99625598e+00
 2.60502566e-01 5.42936951e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.959220253071766
cond(S) = 84184.97174842525
E1 = -727.0151949717674  E_coul = 202.14835023764348
init E= -524.866844734124
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.591538859314606  LUMO = 1.12490586192571
  mo_energy =
[-1.18064768e+02 -1.22131274e+01 -9.51601498e+00 -9.51601498e+00
 -9.51601498e+00 -1.23459523e+00 -5.91538859e-01 -5.91538859e-01
 -5.91538859e-01  1.12490586e+00  1.12490586e+00  1.12490586e+00
  5.25649558e+00  5.25649558e+00  5.25649558e+00  9.08206795e+00
  2.07750583e+01  2.07750583e+01  2.07750583e+01  8.97854988e+01
  8.97854988e+01  8.97854988e+01  2.04946480e+02  4.21324530e+02
  4.21324530e+02  4.21324530e+02  1.27486151e+03  1.27486151e+03
  1.27486151e+03  1.93100036e+03  2.97687805e+03  2.97687805e+03
  2.97687805e+03  6.60600933e+03  6.60600933e+03  6.60600933e+03
  8.28749310e+03  2.46744634e+04  7.54698761e+04]
E1 = -726.5371553863193  E_coul = 200.71644473814428
cycle= 1 E= -525.820710648175  delta_E= -0.954  |g|= 0.208  |ddm|=  1.1
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.535423
diis-c [-0.28667813  1.        ]
  HOMO = -0.594668573813841  LUMO = 1.12836633236407
  mo_energy =
[-1.18362926e+02 -1.23084891e+01 -9.61986595e+00 -9.61986595e+00
 -9.61986595e+00 -1.23757659e+00 -5.94668574e-01 -5.94668574e-01
 -5.94668574e-01  1.12836633e+00  1.12836633e+00  1.12836633e+00
  5.23362885e+00  5.23362885e+00  5.23362885e+00  9.04057662e+00
  2.06901529e+01  2.06901529e+01  2.06901529e+01  8.96036387e+01
  8.96036387e+01  8.96036387e+01  2.04688372e+02  4.21028596e+02
  4.21028596e+02  4.21028596e+02  1.27449023e+03  1.27449023e+03
  1.27449023e+03  1.93045881e+03  2.97641732e+03  2.97641732e+03
  2.97641732e+03  6.60540288e+03  6.60540288e+03  6.60540288e+03
  8.28678523e+03  2.46736489e+04  7.54689615e+04]
E1 = -726.9476407129404  E_coul = 201.12613010518382
cycle= 2 E= -525.821510607757  delta_E= -0.0008  |g|= 0.0326  |ddm|= 0.0485
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0574541
diis-c [-0.00167361  0.07025534  0.92974466]
  HOMO = -0.589116042505968  LUMO = 1.13244294196897
  mo_energy =
[-1.18307615e+02 -1.22813806e+01 -9.59164111e+00 -9.59164111e+00
 -9.59164111e+00 -1.23083380e+00 -5.89116043e-01 -5.89116043e-01
 -5.89116043e-01  1.13244294e+00  1.13244294e+00  1.13244294e+00
  5.24505968e+00  5.24505968e+00  5.24505968e+00  9.06249328e+00
  2.07139405e+01  2.07139405e+01  2.07139405e+01  8.96450004e+01
  8.96450004e+01  8.96450004e+01  2.04740975e+02  4.21083355e+02
  4.21083355e+02  4.21083355e+02  1.27454871e+03  1.27454871e+03
  1.27454871e+03  1.93051964e+03  2.97647754e+03  2.97647754e+03
  2.97647754e+03  6.60546424e+03  6.60546424e+03  6.60546424e+03
  8.28684710e+03  2.46737110e+04  7.54690236e+04]
E1 = -726.8614975200911  E_coul = 201.03995842090276
cycle= 3 E= -525.821539099188  delta_E= -2.85e-05  |g|= 0.00415  |ddm|= 0.011
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00871663
diis-c [-1.05016392e-06 -1.63666989e-03  1.22160716e-01  8.79475954e-01]
  HOMO = -0.589788557752544  LUMO = 1.13197301607711
  mo_energy =
[-1.18314053e+02 -1.22846845e+01 -9.59521314e+00 -9.59521314e+00
 -9.59521314e+00 -1.23152038e+00 -5.89788558e-01 -5.89788558e-01
 -5.89788558e-01  1.13197302e+00  1.13197302e+00  1.13197302e+00
  5.24367198e+00  5.24367198e+00  5.24367198e+00  9.06017305e+00
  2.07109588e+01  2.07109588e+01  2.07109588e+01  8.96400752e+01
  8.96400752e+01  8.96400752e+01  2.04734902e+02  4.21076984e+02
  4.21076984e+02  4.21076984e+02  1.27454185e+03  1.27454185e+03
  1.27454185e+03  1.93051222e+03  2.97647034e+03  2.97647034e+03
  2.97647034e+03  6.60545667e+03  6.60545667e+03  6.60545667e+03
  8.28683930e+03  2.46737030e+04  7.54690156e+04]
E1 = -726.8731545955828  E_coul = 201.05161487552837
cycle= 4 E= -525.821539720054  delta_E= -6.21e-07  |g|= 0.000126  |ddm|= 0.0011
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000183907
diis-c [-4.73297069e-09  6.09034279e-05 -8.45950811e-03 -7.73048804e-02
  1.08570349e+00]
  HOMO = -0.589754603470425  LUMO = 1.13199768768186
  mo_energy =
[-1.18314024e+02 -1.22846097e+01 -9.59515621e+00 -9.59515621e+00
 -9.59515621e+00 -1.23147121e+00 -5.89754603e-01 -5.89754603e-01
 -5.89754603e-01  1.13199769e+00  1.13199769e+00  1.13199769e+00
  5.24372616e+00  5.24372616e+00  5.24372616e+00  9.06026897e+00
  2.07110171e+01  2.07110171e+01  2.07110171e+01  8.96401237e+01
  8.96401237e+01  8.96401237e+01  2.04734939e+02  4.21077014e+02
  4.21077014e+02  4.21077014e+02  1.27454186e+03  1.27454186e+03
  1.27454186e+03  1.93051221e+03  2.97647034e+03  2.97647034e+03
  2.97647034e+03  6.60545665e+03  6.60545665e+03  6.60545665e+03
  8.28683927e+03  2.46737030e+04  7.54690155e+04]
E1 = -726.8731318353468  E_coul = 201.05159211454858
cycle= 5 E= -525.821539720798  delta_E= -7.44e-10  |g|= 1.31e-05  |ddm|= 9e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -726.8731318353468  E_coul = 201.05159211454858
  HOMO = -0.589760154841636  LUMO = 1.13199385122114
  mo_energy =
[-1.18314053e+02 -1.22846300e+01 -9.59517761e+00 -9.59517761e+00
 -9.59517761e+00 -1.23147748e+00 -5.89760155e-01 -5.89760155e-01
 -5.89760155e-01  1.13199385e+00  1.13199385e+00  1.13199385e+00
  5.24371570e+00  5.24371570e+00  5.24371570e+00  9.06025269e+00
  2.07109986e+01  2.07109986e+01  2.07109986e+01  8.96400987e+01
  8.96400987e+01  8.96400987e+01  2.04734911e+02  4.21076985e+02
  4.21076985e+02  4.21076985e+02  1.27454183e+03  1.27454183e+03
  1.27454183e+03  1.93051218e+03  2.97647031e+03  2.97647031e+03
  2.97647031e+03  6.60545662e+03  6.60545662e+03  6.60545662e+03
  8.28683924e+03  2.46737030e+04  7.54690155e+04]
E1 = -726.8731912654364  E_coul = 201.05165154462878
Extra cycle  E= -525.821539720808  delta_E= -9.32e-12  |g|= 3.65e-06  |ddm|= 6.57e-06
    CPU time for scf_cycle      0.61 sec, wall time      0.23 sec
exp = [2.61825079e+04 7.61825021e+03 3.61824965e+03 1.61823332e+03
 2.39746432e+02 5.23113344e+01 6.45001373e+00 3.58968992e+00
 3.16946773e-01 1.36279297e+03 6.65180204e+02 3.03317823e+02
 3.16143973e+02 4.93232203e+01 4.79852471e+00 1.46187517e+01
 7.76918220e-01 1.77957632e+00 2.60502566e-01]
E = -525.8215397208076
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:39:25 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5078918        1
[INPUT] 0    0    [1    /1   ]  7618.25032973        1
[INPUT] 0    0    [1    /1   ]  3618.24988073        1
[INPUT] 0    0    [1    /1   ]  1618.23684497        1
[INPUT] 0    0    [1    /1   ]  239.754477565        1
[INPUT] 0    0    [1    /1   ]  52.218798815         1
[INPUT] 0    0    [1    /1   ]  6.16953782236        1
[INPUT] 0    0    [1    /1   ]  2.95259426569        1
[INPUT] 0    0    [1    /1   ]  0.401901295713       1
[INPUT] 1    0    [1    /1   ]  1362.79297587        1
[INPUT] 1    0    [1    /1   ]  665.180308947        1
[INPUT] 1    0    [1    /1   ]  303.31839127         1
[INPUT] 1    0    [1    /1   ]  316.144473642        1
[INPUT] 1    0    [1    /1   ]  49.3185478776        1
[INPUT] 1    0    [1    /1   ]  4.77415134056        1
[INPUT] 1    0    [1    /1   ]  14.6466567993        1
[INPUT] 1    0    [1    /1   ]  0.685192312081       1
[INPUT] 1    0    [1    /1   ]  1.63895781702        1
[INPUT] 1    0    [1    /1   ]  0.210509524998       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.507891812376, 1.0]], [0, [7618.250329731378, 1.0]], [0, [3618.249880725362, 1.0]], [0, [1618.2368449742976, 1.0]], [0, [239.75447756455867, 1.0]], [0, [52.218798815042675, 1.0]], [0, [6.169537822359573, 1.0]], [0, [2.952594265694412, 1.0]], [0, [0.4019012957129554, 1.0]], [1, [1362.792975869138, 1.0]], [1, [665.1803089469307, 1.0]], [1, [303.3183912704034, 1.0]], [1, [316.1444736420425, 1.0]], [1, [49.318547877564036, 1.0]], [1, [4.774151340561604, 1.0]], [1, [14.646656799285832, 1.0]], [1, [0.6851923120807503, 1.0]], [1, [1.6389578170187538, 1.0]], [1, [0.21050952499822562, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50789181]
bas 1, expnt(s) = [7618.25032973]
bas 2, expnt(s) = [3618.24988073]
bas 3, expnt(s) = [1618.23684497]
bas 4, expnt(s) = [239.75447756]
bas 5, expnt(s) = [52.21879882]
bas 6, expnt(s) = [6.16953782]
bas 7, expnt(s) = [2.95259427]
bas 8, expnt(s) = [0.4019013]
bas 9, expnt(s) = [1362.79297587]
bas 10, expnt(s) = [665.18030895]
bas 11, expnt(s) = [303.31839127]
bas 12, expnt(s) = [316.14447364]
bas 13, expnt(s) = [49.31854788]
bas 14, expnt(s) = [4.77415134]
bas 15, expnt(s) = [14.6466568]
bas 16, expnt(s) = [0.68519231]
bas 17, expnt(s) = [1.63895782]
bas 18, expnt(s) = [0.21050952]
CPU time:        73.75
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024083e+03 7.61825033e+03 2.06018610e+03
 3.61824988e+03 1.17866108e+03 1.61823684e+03 6.44609331e+02
 2.39754478e+02 1.53935955e+02 5.22187988e+01 4.90778108e+01
 6.16953782e+00 9.89018687e+00 2.95259427e+00 5.69072833e+00
 4.01901296e-01 1.27527715e+00 1.36279298e+03 2.41558181e+04
 6.65180309e+02 9.85504526e+03 3.03318391e+02 3.69281731e+03
 3.16144474e+02 3.88903083e+03 4.93185479e+01 3.81282826e+02
 4.77415134e+00 2.05875478e+01 1.46466568e+01 8.35906157e+01
 6.85192312e-01 1.81865363e+00 1.63895782e+00 5.40996073e+00
 2.10509525e-01 4.15981562e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982944371966195
cond(S) = 83940.33646840892
E1 = -728.2529748254541  E_coul = 203.05818908599542
init E= -525.194785739459
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.556375150632946  LUMO = 0.900802836289209
  mo_energy =
[-1.17989008e+02 -1.21746552e+01 -9.45208093e+00 -9.45208093e+00
 -9.45208093e+00 -1.22486584e+00 -5.56375151e-01 -5.56375151e-01
 -5.56375151e-01  9.00802836e-01  9.00802836e-01  9.00802836e-01
  4.58325744e+00  4.58325744e+00  4.58325744e+00  7.75323260e+00
  1.97591533e+01  1.97591533e+01  1.97591533e+01  8.89899183e+01
  8.89899183e+01  8.89899183e+01  2.01280323e+02  4.20811635e+02
  4.20811635e+02  4.20811635e+02  1.27443855e+03  1.27443855e+03
  1.27443855e+03  1.92816457e+03  2.97649598e+03  2.97649598e+03
  2.97649598e+03  6.60566935e+03  6.60566935e+03  6.60566935e+03
  8.28499670e+03  2.46721222e+04  7.54677085e+04]
E1 = -727.1025112346481  E_coul = 201.21786690565838
cycle= 1 E= -525.88464432899  delta_E= -0.69  |g|= 0.192  |ddm|= 0.956
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.505374
diis-c [-0.25540248  1.        ]
  HOMO = -0.581063173433999  LUMO = 0.888385126249524
  mo_energy =
[-1.18302702e+02 -1.22931436e+01 -9.57909181e+00 -9.57909181e+00
 -9.57909181e+00 -1.25744084e+00 -5.81063173e-01 -5.81063173e-01
 -5.81063173e-01  8.88385126e-01  8.88385126e-01  8.88385126e-01
  4.53392665e+00  4.53392665e+00  4.53392665e+00  7.67352048e+00
  1.96486839e+01  1.96486839e+01  1.96486839e+01  8.87868319e+01
  8.87868319e+01  8.87868319e+01  2.01005178e+02  4.20500466e+02
  4.20500466e+02  4.20500466e+02  1.27405697e+03  1.27405697e+03
  1.27405697e+03  1.92762221e+03  2.97603031e+03  2.97603031e+03
  2.97603031e+03  6.60506422e+03  6.60506422e+03  6.60506422e+03
  8.28429414e+03  2.46713159e+04  7.54668042e+04]
E1 = -727.5443518777028  E_coul = 201.65915366160363
cycle= 2 E= -525.885198216099  delta_E= -0.000554  |g|= 0.0324  |ddm|= 0.0355
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0597487
diis-c [-0.00192449  0.07456174  0.92543826]
  HOMO = -0.575020619923372  LUMO = 0.892042692504228
  mo_energy =
[-1.18245658e+02 -1.22639129e+01 -9.54837644e+00 -9.54837644e+00
 -9.54837644e+00 -1.24973654e+00 -5.75020620e-01 -5.75020620e-01
 -5.75020620e-01  8.92042693e-01  8.92042693e-01  8.92042693e-01
  4.54577736e+00  4.54577736e+00  4.54577736e+00  7.69424093e+00
  1.96746322e+01  1.96746322e+01  1.96746322e+01  8.88303052e+01
  8.88303052e+01  8.88303052e+01  2.01059463e+02  4.20556933e+02
  4.20556933e+02  4.20556933e+02  1.27411718e+03  1.27411718e+03
  1.27411718e+03  1.92768510e+03  2.97609241e+03  2.97609241e+03
  2.97609241e+03  6.60512772e+03  6.60512772e+03  6.60512772e+03
  8.28435832e+03  2.46713805e+04  7.54668689e+04]
E1 = -727.4377424833224  E_coul = 201.55251031329271
cycle= 3 E= -525.88523217003  delta_E= -3.4e-05  |g|= 0.00472  |ddm|= 0.0107
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00918612
diis-c [-3.25724891e-07 -1.22192130e-03  1.27496913e-01  8.73725009e-01]
  HOMO = -0.57605970968344  LUMO = 0.891417430069415
  mo_energy =
[-1.18253302e+02 -1.22681850e+01 -9.55289433e+00 -9.55289433e+00
 -9.55289433e+00 -1.25101042e+00 -5.76059710e-01 -5.76059710e-01
 -5.76059710e-01  8.91417430e-01  8.91417430e-01  8.91417430e-01
  4.54385838e+00  4.54385838e+00  4.54385838e+00  7.69117373e+00
  1.96707657e+01  1.96707657e+01  1.96707657e+01  8.88242738e+01
  8.88242738e+01  8.88242738e+01  2.01052195e+02  4.20549361e+02
  4.20549361e+02  4.20549361e+02  1.27410912e+03  1.27410912e+03
  1.27410912e+03  1.92767655e+03  2.97608404e+03  2.97608404e+03
  2.97608404e+03  6.60511903e+03  6.60511903e+03  6.60511903e+03
  8.28434944e+03  2.46713715e+04  7.54668598e+04]
E1 = -727.4529972578105  E_coul = 201.56776418205388
cycle= 4 E= -525.885233075757  delta_E= -9.06e-07  |g|= 6e-05  |ddm|= 0.00141
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.45601e-05
diis-c [-2.17039575e-09 -3.20766407e-05  1.04593042e-03  1.07973398e-02
  9.88188806e-01]
  HOMO = -0.576031194941468  LUMO = 0.89143409395398
  mo_energy =
[-1.18253204e+02 -1.22680885e+01 -9.55280192e+00 -9.55280192e+00
 -9.55280192e+00 -1.25097120e+00 -5.76031195e-01 -5.76031195e-01
 -5.76031195e-01  8.91434094e-01  8.91434094e-01  8.91434094e-01
  4.54390854e+00  4.54390854e+00  4.54390854e+00  7.69125544e+00
  1.96708480e+01  1.96708480e+01  1.96708480e+01  8.88243698e+01
  8.88243698e+01  8.88243698e+01  2.01052292e+02  4.20549457e+02
  4.20549457e+02  4.20549457e+02  1.27410921e+03  1.27410921e+03
  1.27410921e+03  1.92767663e+03  2.97608413e+03  2.97608413e+03
  2.97608413e+03  6.60511911e+03  6.60511911e+03  6.60511911e+03
  8.28434951e+03  2.46713715e+04  7.54668599e+04]
E1 = -727.4527302452846  E_coul = 201.56749716926583
cycle= 5 E= -525.885233076019  delta_E= -2.62e-10  |g|= 1.06e-05  |ddm|= 4.47e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4527302452846  E_coul = 201.56749716926583
  HOMO = -0.576035637754342  LUMO = 0.891431442879169
  mo_energy =
[-1.18253227e+02 -1.22681035e+01 -9.55281807e+00 -9.55281807e+00
 -9.55281807e+00 -1.25097640e+00 -5.76035638e-01 -5.76035638e-01
 -5.76035638e-01  8.91431443e-01  8.91431443e-01  8.91431443e-01
  4.54390075e+00  4.54390075e+00  4.54390075e+00  7.69124444e+00
  1.96708339e+01  1.96708339e+01  1.96708339e+01  8.88243506e+01
  8.88243506e+01  8.88243506e+01  2.01052271e+02  4.20549435e+02
  4.20549435e+02  4.20549435e+02  1.27410919e+03  1.27410919e+03
  1.27410919e+03  1.92767661e+03  2.97608411e+03  2.97608411e+03
  2.97608411e+03  6.60511908e+03  6.60511908e+03  6.60511908e+03
  8.28434949e+03  2.46713715e+04  7.54668599e+04]
E1 = -727.4527827378405  E_coul = 201.56754966181452
Extra cycle  E= -525.885233076026  delta_E= -7.28e-12  |g|= 3.11e-06  |ddm|= 4.58e-06
    CPU time for scf_cycle      0.61 sec, wall time      0.23 sec
exp = [2.61825079e+04 7.61825033e+03 3.61824988e+03 1.61823684e+03
 2.39754478e+02 5.22187988e+01 6.16953782e+00 2.95259427e+00
 4.01901296e-01 1.36279298e+03 6.65180309e+02 3.03318391e+02
 3.16144474e+02 4.93185479e+01 4.77415134e+00 1.46466568e+01
 6.85192312e-01 1.63895782e+00 2.10509525e-01]
E = -525.885233076026
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:39:26 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5078918        1
[INPUT] 0    0    [1    /1   ]  7618.25032973        1
[INPUT] 0    0    [1    /1   ]  3618.24988073        1
[INPUT] 0    0    [1    /1   ]  1618.23684497        1
[INPUT] 0    0    [1    /1   ]  239.754477565        1
[INPUT] 0    0    [1    /1   ]  52.218798815         1
[INPUT] 0    0    [1    /1   ]  6.16953782236        1
[INPUT] 0    0    [1    /1   ]  2.95259426569        1
[INPUT] 0    0    [1    /1   ]  0.401901295713       1
[INPUT] 1    0    [1    /1   ]  1362.79297587        1
[INPUT] 1    0    [1    /1   ]  665.180308947        1
[INPUT] 1    0    [1    /1   ]  303.31839127         1
[INPUT] 1    0    [1    /1   ]  316.144473642        1
[INPUT] 1    0    [1    /1   ]  49.3185478776        1
[INPUT] 1    0    [1    /1   ]  4.77415134056        1
[INPUT] 1    0    [1    /1   ]  14.6466567993        1
[INPUT] 1    0    [1    /1   ]  0.685192312081       1
[INPUT] 1    0    [1    /1   ]  1.63895781702        1
[INPUT] 1    0    [1    /1   ]  0.210509524998       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.507891812376, 1.0]], [0, [7618.250329731378, 1.0]], [0, [3618.249880725362, 1.0]], [0, [1618.2368449742976, 1.0]], [0, [239.75447756455867, 1.0]], [0, [52.218798815042675, 1.0]], [0, [6.169537822359573, 1.0]], [0, [2.952594265694412, 1.0]], [0, [0.4019012957129554, 1.0]], [1, [1362.792975869138, 1.0]], [1, [665.1803089469307, 1.0]], [1, [303.3183912704034, 1.0]], [1, [316.1444736420425, 1.0]], [1, [49.318547877564036, 1.0]], [1, [4.774151340561604, 1.0]], [1, [14.646656799285832, 1.0]], [1, [0.6851923120807503, 1.0]], [1, [1.6389578170187538, 1.0]], [1, [0.21050952499822562, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50789181]
bas 1, expnt(s) = [7618.25032973]
bas 2, expnt(s) = [3618.24988073]
bas 3, expnt(s) = [1618.23684497]
bas 4, expnt(s) = [239.75447756]
bas 5, expnt(s) = [52.21879882]
bas 6, expnt(s) = [6.16953782]
bas 7, expnt(s) = [2.95259427]
bas 8, expnt(s) = [0.4019013]
bas 9, expnt(s) = [1362.79297587]
bas 10, expnt(s) = [665.18030895]
bas 11, expnt(s) = [303.31839127]
bas 12, expnt(s) = [316.14447364]
bas 13, expnt(s) = [49.31854788]
bas 14, expnt(s) = [4.77415134]
bas 15, expnt(s) = [14.6466568]
bas 16, expnt(s) = [0.68519231]
bas 17, expnt(s) = [1.63895782]
bas 18, expnt(s) = [0.21050952]
CPU time:        74.42
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024083e+03 7.61825033e+03 2.06018610e+03
 3.61824988e+03 1.17866108e+03 1.61823684e+03 6.44609331e+02
 2.39754478e+02 1.53935955e+02 5.22187988e+01 4.90778108e+01
 6.16953782e+00 9.89018687e+00 2.95259427e+00 5.69072833e+00
 4.01901296e-01 1.27527715e+00 1.36279298e+03 2.41558181e+04
 6.65180309e+02 9.85504526e+03 3.03318391e+02 3.69281731e+03
 3.16144474e+02 3.88903083e+03 4.93185479e+01 3.81282826e+02
 4.77415134e+00 2.05875478e+01 1.46466568e+01 8.35906157e+01
 6.85192312e-01 1.81865363e+00 1.63895782e+00 5.40996073e+00
 2.10509525e-01 4.15981562e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982944371966195
cond(S) = 83940.33646840892
E1 = -728.2529748254541  E_coul = 203.05818908599542
init E= -525.194785739459
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.556375150632946  LUMO = 0.900802836289209
  mo_energy =
[-1.17989008e+02 -1.21746552e+01 -9.45208093e+00 -9.45208093e+00
 -9.45208093e+00 -1.22486584e+00 -5.56375151e-01 -5.56375151e-01
 -5.56375151e-01  9.00802836e-01  9.00802836e-01  9.00802836e-01
  4.58325744e+00  4.58325744e+00  4.58325744e+00  7.75323260e+00
  1.97591533e+01  1.97591533e+01  1.97591533e+01  8.89899183e+01
  8.89899183e+01  8.89899183e+01  2.01280323e+02  4.20811635e+02
  4.20811635e+02  4.20811635e+02  1.27443855e+03  1.27443855e+03
  1.27443855e+03  1.92816457e+03  2.97649598e+03  2.97649598e+03
  2.97649598e+03  6.60566935e+03  6.60566935e+03  6.60566935e+03
  8.28499670e+03  2.46721222e+04  7.54677085e+04]
E1 = -727.1025112346481  E_coul = 201.21786690565838
cycle= 1 E= -525.88464432899  delta_E= -0.69  |g|= 0.192  |ddm|= 0.956
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.505374
diis-c [-0.25540248  1.        ]
  HOMO = -0.581063173433999  LUMO = 0.888385126249524
  mo_energy =
[-1.18302702e+02 -1.22931436e+01 -9.57909181e+00 -9.57909181e+00
 -9.57909181e+00 -1.25744084e+00 -5.81063173e-01 -5.81063173e-01
 -5.81063173e-01  8.88385126e-01  8.88385126e-01  8.88385126e-01
  4.53392665e+00  4.53392665e+00  4.53392665e+00  7.67352048e+00
  1.96486839e+01  1.96486839e+01  1.96486839e+01  8.87868319e+01
  8.87868319e+01  8.87868319e+01  2.01005178e+02  4.20500466e+02
  4.20500466e+02  4.20500466e+02  1.27405697e+03  1.27405697e+03
  1.27405697e+03  1.92762221e+03  2.97603031e+03  2.97603031e+03
  2.97603031e+03  6.60506422e+03  6.60506422e+03  6.60506422e+03
  8.28429414e+03  2.46713159e+04  7.54668042e+04]
E1 = -727.5443518777028  E_coul = 201.65915366160363
cycle= 2 E= -525.885198216099  delta_E= -0.000554  |g|= 0.0324  |ddm|= 0.0355
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0597487
diis-c [-0.00192449  0.07456174  0.92543826]
  HOMO = -0.575020619923372  LUMO = 0.892042692504228
  mo_energy =
[-1.18245658e+02 -1.22639129e+01 -9.54837644e+00 -9.54837644e+00
 -9.54837644e+00 -1.24973654e+00 -5.75020620e-01 -5.75020620e-01
 -5.75020620e-01  8.92042693e-01  8.92042693e-01  8.92042693e-01
  4.54577736e+00  4.54577736e+00  4.54577736e+00  7.69424093e+00
  1.96746322e+01  1.96746322e+01  1.96746322e+01  8.88303052e+01
  8.88303052e+01  8.88303052e+01  2.01059463e+02  4.20556933e+02
  4.20556933e+02  4.20556933e+02  1.27411718e+03  1.27411718e+03
  1.27411718e+03  1.92768510e+03  2.97609241e+03  2.97609241e+03
  2.97609241e+03  6.60512772e+03  6.60512772e+03  6.60512772e+03
  8.28435832e+03  2.46713805e+04  7.54668689e+04]
E1 = -727.4377424833224  E_coul = 201.55251031329271
cycle= 3 E= -525.88523217003  delta_E= -3.4e-05  |g|= 0.00472  |ddm|= 0.0107
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00918612
diis-c [-3.25724891e-07 -1.22192130e-03  1.27496913e-01  8.73725009e-01]
  HOMO = -0.57605970968344  LUMO = 0.891417430069415
  mo_energy =
[-1.18253302e+02 -1.22681850e+01 -9.55289433e+00 -9.55289433e+00
 -9.55289433e+00 -1.25101042e+00 -5.76059710e-01 -5.76059710e-01
 -5.76059710e-01  8.91417430e-01  8.91417430e-01  8.91417430e-01
  4.54385838e+00  4.54385838e+00  4.54385838e+00  7.69117373e+00
  1.96707657e+01  1.96707657e+01  1.96707657e+01  8.88242738e+01
  8.88242738e+01  8.88242738e+01  2.01052195e+02  4.20549361e+02
  4.20549361e+02  4.20549361e+02  1.27410912e+03  1.27410912e+03
  1.27410912e+03  1.92767655e+03  2.97608404e+03  2.97608404e+03
  2.97608404e+03  6.60511903e+03  6.60511903e+03  6.60511903e+03
  8.28434944e+03  2.46713715e+04  7.54668598e+04]
E1 = -727.4529972578105  E_coul = 201.56776418205388
cycle= 4 E= -525.885233075757  delta_E= -9.06e-07  |g|= 6e-05  |ddm|= 0.00141
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.45601e-05
diis-c [-2.17039575e-09 -3.20766407e-05  1.04593042e-03  1.07973398e-02
  9.88188806e-01]
  HOMO = -0.576031194941468  LUMO = 0.89143409395398
  mo_energy =
[-1.18253204e+02 -1.22680885e+01 -9.55280192e+00 -9.55280192e+00
 -9.55280192e+00 -1.25097120e+00 -5.76031195e-01 -5.76031195e-01
 -5.76031195e-01  8.91434094e-01  8.91434094e-01  8.91434094e-01
  4.54390854e+00  4.54390854e+00  4.54390854e+00  7.69125544e+00
  1.96708480e+01  1.96708480e+01  1.96708480e+01  8.88243698e+01
  8.88243698e+01  8.88243698e+01  2.01052292e+02  4.20549457e+02
  4.20549457e+02  4.20549457e+02  1.27410921e+03  1.27410921e+03
  1.27410921e+03  1.92767663e+03  2.97608413e+03  2.97608413e+03
  2.97608413e+03  6.60511911e+03  6.60511911e+03  6.60511911e+03
  8.28434951e+03  2.46713715e+04  7.54668599e+04]
E1 = -727.4527302452846  E_coul = 201.56749716926583
cycle= 5 E= -525.885233076019  delta_E= -2.62e-10  |g|= 1.06e-05  |ddm|= 4.47e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4527302452846  E_coul = 201.56749716926583
  HOMO = -0.576035637754342  LUMO = 0.891431442879169
  mo_energy =
[-1.18253227e+02 -1.22681035e+01 -9.55281807e+00 -9.55281807e+00
 -9.55281807e+00 -1.25097640e+00 -5.76035638e-01 -5.76035638e-01
 -5.76035638e-01  8.91431443e-01  8.91431443e-01  8.91431443e-01
  4.54390075e+00  4.54390075e+00  4.54390075e+00  7.69124444e+00
  1.96708339e+01  1.96708339e+01  1.96708339e+01  8.88243506e+01
  8.88243506e+01  8.88243506e+01  2.01052271e+02  4.20549435e+02
  4.20549435e+02  4.20549435e+02  1.27410919e+03  1.27410919e+03
  1.27410919e+03  1.92767661e+03  2.97608411e+03  2.97608411e+03
  2.97608411e+03  6.60511908e+03  6.60511908e+03  6.60511908e+03
  8.28434949e+03  2.46713715e+04  7.54668599e+04]
E1 = -727.4527827378405  E_coul = 201.56754966181452
Extra cycle  E= -525.885233076026  delta_E= -7.28e-12  |g|= 3.11e-06  |ddm|= 4.58e-06
    CPU time for scf_cycle      0.61 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 83940.33646840892
E1 = -727.4527827378405  E_coul = 201.56754966181452
init E= -525.885233076026
    CPU time for initialize scf      2.70 sec, wall time      0.24 sec
  HOMO = -0.576034678068928  LUMO = 0.891432016678229
  mo_energy =
[-1.18253221e+02 -1.22680996e+01 -9.55281410e+00 -9.55281410e+00
 -9.55281410e+00 -1.25097517e+00 -5.76034678e-01 -5.76034678e-01
 -5.76034678e-01  8.91432017e-01  8.91432017e-01  8.91432017e-01
  4.54390252e+00  4.54390252e+00  4.54390252e+00  7.69124734e+00
  1.96708373e+01  1.96708373e+01  1.96708373e+01  8.88243557e+01
  8.88243557e+01  8.88243557e+01  2.01052277e+02  4.20549441e+02
  4.20549441e+02  4.20549441e+02  1.27410920e+03  1.27410920e+03
  1.27410920e+03  1.92767661e+03  2.97608411e+03  2.97608411e+03
  2.97608411e+03  6.60511909e+03  6.60511909e+03  6.60511909e+03
  8.28434950e+03  2.46713715e+04  7.54668599e+04]
E1 = -727.4527696831565  E_coul = 201.5675366071296
cycle= 1 E= -525.885233076027  delta_E= -9.09e-13  |g|= 8.11e-07  |ddm|= 1.42e-06
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.4527696831565  E_coul = 201.5675366071296
  HOMO = -0.576034906442601  LUMO = 0.891431879612543
  mo_energy =
[-1.18253222e+02 -1.22681005e+01 -9.55281509e+00 -9.55281509e+00
 -9.55281509e+00 -1.25097545e+00 -5.76034906e-01 -5.76034906e-01
 -5.76034906e-01  8.91431880e-01  8.91431880e-01  8.91431880e-01
  4.54390209e+00  4.54390209e+00  4.54390209e+00  7.69124666e+00
  1.96708365e+01  1.96708365e+01  1.96708365e+01  8.88243544e+01
  8.88243544e+01  8.88243544e+01  2.01052275e+02  4.20549440e+02
  4.20549440e+02  4.20549440e+02  1.27410920e+03  1.27410920e+03
  1.27410920e+03  1.92767661e+03  2.97608411e+03  2.97608411e+03
  2.97608411e+03  6.60511909e+03  6.60511909e+03  6.60511909e+03
  8.28434949e+03  2.46713715e+04  7.54668599e+04]
E1 = -727.4527730164581  E_coul = 201.56753994043322
Extra cycle  E= -525.885233076025  delta_E= 2.05e-12  |g|= 2.12e-07  |ddm|= 3.18e-07
    CPU time for scf_cycle      2.81 sec, wall time      0.36 sec
exp = [2.61825079e+04 7.61825033e+03 3.61824988e+03 1.61823684e+03
 2.39754478e+02 5.22187988e+01 6.16953782e+00 2.95259427e+00
 4.01901296e-01 1.36279298e+03 6.65180309e+02 3.03318391e+02
 3.16144474e+02 4.93185479e+01 4.77415134e+00 1.46466568e+01
 6.85192312e-01 1.63895782e+00 2.10509525e-01]
grad_E = [-1.97801914e-06  2.12281954e-05  4.18532681e-05  6.47867833e-04
  2.46693664e-03 -3.76574438e-02 -5.97985427e-02  2.36893248e-02
  8.96891543e-02  1.32520670e-06  1.99413576e-05  1.07951621e-04
  9.50757919e-05 -1.38677787e-03 -6.80955019e-02  1.58337635e-02
  8.44282570e-02  1.55642206e-03 -7.84694408e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:39:30 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5078971        1
[INPUT] 0    0    [1    /1   ]  7618.25027273        1
[INPUT] 0    0    [1    /1   ]  3618.24976784        1
[INPUT] 0    0    [1    /1   ]  1618.23510181        1
[INPUT] 0    0    [1    /1   ]  239.749590304        1
[INPUT] 0    0    [1    /1   ]  52.2837435802        1
[INPUT] 0    0    [1    /1   ]  6.34815974988        1
[INPUT] 0    0    [1    /1   ]  3.12311846019        1
[INPUT] 0    0    [1    /1   ]  0.388677263754       1
[INPUT] 1    0    [1    /1   ]  1362.7929724         1
[INPUT] 1    0    [1    /1   ]  665.180256314        1
[INPUT] 1    0    [1    /1   ]  303.318106854        1
[INPUT] 1    0    [1    /1   ]  316.144223129        1
[INPUT] 1    0    [1    /1   ]  49.3213201337        1
[INPUT] 1    0    [1    /1   ]  4.84446642525        1
[INPUT] 1    0    [1    /1   ]  14.6231471298        1
[INPUT] 1    0    [1    /1   ]  0.68216435801        1
[INPUT] 1    0    [1    /1   ]  1.66685636251        1
[INPUT] 1    0    [1    /1   ]  0.201355280294       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.50789708443, 1.0]], [0, [7618.250272725626, 1.0]], [0, [3618.249767841295, 1.0]], [0, [1618.2351018105112, 1.0]], [0, [239.74959030399356, 1.0]], [0, [52.28374358017642, 1.0]], [0, [6.348159749877997, 1.0]], [0, [3.123118460190663, 1.0]], [0, [0.3886772637538851, 1.0]], [1, [1362.7929724031749, 1.0]], [1, [665.180256313669, 1.0]], [1, [303.3181068542661, 1.0]], [1, [316.14422312875513, 1.0]], [1, [49.321320133684274, 1.0]], [1, [4.844466425252313, 1.0]], [1, [14.623147129814239, 1.0]], [1, [0.6821643580096051, 1.0]], [1, [1.6668563625054187, 1.0]], [1, [0.2013552802944088, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50789708]
bas 1, expnt(s) = [7618.25027273]
bas 2, expnt(s) = [3618.24976784]
bas 3, expnt(s) = [1618.23510181]
bas 4, expnt(s) = [239.7495903]
bas 5, expnt(s) = [52.28374358]
bas 6, expnt(s) = [6.34815975]
bas 7, expnt(s) = [3.12311846]
bas 8, expnt(s) = [0.38867726]
bas 9, expnt(s) = [1362.7929724]
bas 10, expnt(s) = [665.18025631]
bas 11, expnt(s) = [303.31810685]
bas 12, expnt(s) = [316.14422313]
bas 13, expnt(s) = [49.32132013]
bas 14, expnt(s) = [4.84446643]
bas 15, expnt(s) = [14.62314713]
bas 16, expnt(s) = [0.68216436]
bas 17, expnt(s) = [1.66685636]
bas 18, expnt(s) = [0.20135528]
CPU time:        82.39
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024083e+03 7.61825027e+03 2.06018609e+03
 3.61824977e+03 1.17866105e+03 1.61823510e+03 6.44608811e+02
 2.39749590e+02 1.53933601e+02 5.22837436e+01 4.91235825e+01
 6.34815975e+00 1.01041762e+01 3.12311846e+00 5.93548712e+00
 3.88677264e-01 1.24367492e+00 1.36279297e+03 2.41558180e+04
 6.65180256e+02 9.85504429e+03 3.03318107e+02 3.69281298e+03
 3.16144223e+02 3.88902698e+03 4.93213201e+01 3.81309616e+02
 4.84446643e+00 2.09672672e+01 1.46231471e+01 8.34229330e+01
 6.82164358e-01 1.80861310e+00 1.66685636e+00 5.52531591e+00
 2.01355280e-01 3.93494051e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.984886824073875
cond(S) = 83979.85425661707
E1 = -728.1740201637067  E_coul = 202.9696040995654
init E= -525.204416064141
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559982778200329  LUMO = 0.864327050858841
  mo_energy =
[-1.18000201e+02 -1.21784158e+01 -9.45884347e+00 -9.45884347e+00
 -9.45884347e+00 -1.22864729e+00 -5.59982778e-01 -5.59982778e-01
 -5.59982778e-01  8.64327051e-01  8.64327051e-01  8.64327051e-01
  4.58264889e+00  4.58264889e+00  4.58264889e+00  8.28712725e+00
  1.99595555e+01  1.99595555e+01  1.99595555e+01  8.92249319e+01
  8.92249319e+01  8.92249319e+01  2.02838969e+02  4.20973229e+02
  4.20973229e+02  4.20973229e+02  1.27457491e+03  1.27457491e+03
  1.27457491e+03  1.92941372e+03  2.97662023e+03  2.97662023e+03
  2.97662023e+03  6.60578114e+03  6.60578114e+03  6.60578114e+03
  8.28610200e+03  2.46731604e+04  7.54686714e+04]
E1 = -726.8784319358832  E_coul = 200.98278616595505
cycle= 1 E= -525.895645769928  delta_E= -0.691  |g|= 0.195  |ddm|= 0.872
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.512201
diis-c [-0.26234959  1.        ]
  HOMO = -0.589438935675697  LUMO = 0.849132546377633
  mo_energy =
[-1.18326227e+02 -1.23076932e+01 -9.59647068e+00 -9.59647068e+00
 -9.59647068e+00 -1.26520669e+00 -5.89438936e-01 -5.89438936e-01
 -5.89438936e-01  8.49132546e-01  8.49132546e-01  8.49132546e-01
  4.52581912e+00  4.52581912e+00  4.52581912e+00  8.19793192e+00
  1.98389728e+01  1.98389728e+01  1.98389728e+01  8.90107414e+01
  8.90107414e+01  8.90107414e+01  2.02551038e+02  4.20649406e+02
  4.20649406e+02  4.20649406e+02  1.27417964e+03  1.27417964e+03
  1.27417964e+03  1.92885613e+03  2.97613999e+03  2.97613999e+03
  2.97613999e+03  6.60516039e+03  6.60516039e+03  6.60516039e+03
  8.28538316e+03  2.46723374e+04  7.54677500e+04]
E1 = -727.3647576119985  E_coul = 201.46845943924114
cycle= 2 E= -525.896298172757  delta_E= -0.000652  |g|= 0.0346  |ddm|= 0.0376
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0634207
diis-c [-0.00209172  0.07929553  0.92070447]
  HOMO = -0.582563117096061  LUMO = 0.85320640519397
  mo_energy =
[-1.18265063e+02 -1.22755463e+01 -9.56281230e+00 -9.56281230e+00
 -9.56281230e+00 -1.25647001e+00 -5.82563117e-01 -5.82563117e-01
 -5.82563117e-01  8.53206405e-01  8.53206405e-01  8.53206405e-01
  4.53929334e+00  4.53929334e+00  4.53929334e+00  8.22179877e+00
  1.98676132e+01  1.98676132e+01  1.98676132e+01  8.90577279e+01
  8.90577279e+01  8.90577279e+01  2.02609316e+02  4.20709966e+02
  4.20709966e+02  4.20709966e+02  1.27424409e+03  1.27424409e+03
  1.27424409e+03  1.92892331e+03  2.97620638e+03  2.97620638e+03
  2.97620638e+03  6.60522820e+03  6.60522820e+03  6.60522820e+03
  8.28545166e+03  2.46724063e+04  7.54678191e+04]
E1 = -727.2481769200077  E_coul = 201.35183834189968
cycle= 3 E= -525.896338578108  delta_E= -4.04e-05  |g|= 0.00495  |ddm|= 0.0118
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00968901
diis-c [-3.71486083e-07 -1.27014983e-03  1.26694944e-01  8.74575206e-01]
  HOMO = -0.583675847636817  LUMO = 0.852549500546016
  mo_energy =
[-1.18273053e+02 -1.22800404e+01 -9.56756592e+00 -9.56756592e+00
 -9.56756592e+00 -1.25781025e+00 -5.83675848e-01 -5.83675848e-01
 -5.83675848e-01  8.52549501e-01  8.52549501e-01  8.52549501e-01
  4.53723274e+00  4.53723274e+00  4.53723274e+00  8.21848624e+00
  1.98635253e+01  1.98635253e+01  1.98635253e+01  8.90514117e+01
  8.90514117e+01  8.90514117e+01  2.02601716e+02  4.20702049e+02
  4.20702049e+02  4.20702049e+02  1.27423566e+03  1.27423566e+03
  1.27423566e+03  1.92891436e+03  2.97619763e+03  2.97619763e+03
  2.97619763e+03  6.60521910e+03  6.60521910e+03  6.60521910e+03
  8.28544236e+03  2.46723968e+04  7.54678095e+04]
E1 = -727.2644150775196  E_coul = 201.36807547588904
cycle= 4 E= -525.896339601631  delta_E= -1.02e-06  |g|= 6.19e-05  |ddm|= 0.00145
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.1923e-05
diis-c [-2.46219514e-09 -1.34061344e-05 -1.08607673e-03 -7.78391767e-03
  1.00888340e+00]
  HOMO = -0.583650748052595  LUMO = 0.852563841581789
  mo_energy =
[-1.18272977e+02 -1.22799552e+01 -9.56748738e+00 -9.56748738e+00
 -9.56748738e+00 -1.25777390e+00 -5.83650748e-01 -5.83650748e-01
 -5.83650748e-01  8.52563842e-01  8.52563842e-01  8.52563842e-01
  4.53727744e+00  4.53727744e+00  4.53727744e+00  8.21856409e+00
  1.98635959e+01  1.98635959e+01  1.98635959e+01  8.90514906e+01
  8.90514906e+01  8.90514906e+01  2.02601794e+02  4.20702125e+02
  4.20702125e+02  4.20702125e+02  1.27423573e+03  1.27423573e+03
  1.27423573e+03  1.92891441e+03  2.97619769e+03  2.97619769e+03
  2.97619769e+03  6.60521916e+03  6.60521916e+03  6.60521916e+03
  8.28544241e+03  2.46723969e+04  7.54678095e+04]
E1 = -727.2641980576338  E_coul = 201.36785845577305
cycle= 5 E= -525.896339601861  delta_E= -2.3e-10  |g|= 1.19e-05  |ddm|= 4.75e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.2641980576338  E_coul = 201.36785845577305
  HOMO = -0.583655885301436  LUMO = 0.852560833344143
  mo_energy =
[-1.18273003e+02 -1.22799724e+01 -9.56750589e+00 -9.56750589e+00
 -9.56750589e+00 -1.25777987e+00 -5.83655885e-01 -5.83655885e-01
 -5.83655885e-01  8.52560833e-01  8.52560833e-01  8.52560833e-01
  4.53726837e+00  4.53726837e+00  4.53726837e+00  8.21855113e+00
  1.98635797e+01  1.98635797e+01  1.98635797e+01  8.90514687e+01
  8.90514687e+01  8.90514687e+01  2.02601770e+02  4.20702099e+02
  4.20702099e+02  4.20702099e+02  1.27423570e+03  1.27423570e+03
  1.27423570e+03  1.92891439e+03  2.97619766e+03  2.97619766e+03
  2.97619766e+03  6.60521913e+03  6.60521913e+03  6.60521913e+03
  8.28544238e+03  2.46723969e+04  7.54678095e+04]
E1 = -727.2642590467116  E_coul = 201.36791944484153
Extra cycle  E= -525.89633960187  delta_E= -9.32e-12  |g|= 3.57e-06  |ddm|= 5.31e-06
    CPU time for scf_cycle      0.61 sec, wall time      0.23 sec
exp = [2.61825079e+04 7.61825027e+03 3.61824977e+03 1.61823510e+03
 2.39749590e+02 5.22837436e+01 6.34815975e+00 3.12311846e+00
 3.88677264e-01 1.36279297e+03 6.65180256e+02 3.03318107e+02
 3.16144223e+02 4.93213201e+01 4.84446643e+00 1.46231471e+01
 6.82164358e-01 1.66685636e+00 2.01355280e-01]
E = -525.8963396018701
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:39:30 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5078971        1
[INPUT] 0    0    [1    /1   ]  7618.25027273        1
[INPUT] 0    0    [1    /1   ]  3618.24976784        1
[INPUT] 0    0    [1    /1   ]  1618.23510181        1
[INPUT] 0    0    [1    /1   ]  239.749590304        1
[INPUT] 0    0    [1    /1   ]  52.2837435802        1
[INPUT] 0    0    [1    /1   ]  6.34815974988        1
[INPUT] 0    0    [1    /1   ]  3.12311846019        1
[INPUT] 0    0    [1    /1   ]  0.388677263754       1
[INPUT] 1    0    [1    /1   ]  1362.7929724         1
[INPUT] 1    0    [1    /1   ]  665.180256314        1
[INPUT] 1    0    [1    /1   ]  303.318106854        1
[INPUT] 1    0    [1    /1   ]  316.144223129        1
[INPUT] 1    0    [1    /1   ]  49.3213201337        1
[INPUT] 1    0    [1    /1   ]  4.84446642525        1
[INPUT] 1    0    [1    /1   ]  14.6231471298        1
[INPUT] 1    0    [1    /1   ]  0.68216435801        1
[INPUT] 1    0    [1    /1   ]  1.66685636251        1
[INPUT] 1    0    [1    /1   ]  0.201355280294       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.50789708443, 1.0]], [0, [7618.250272725626, 1.0]], [0, [3618.249767841295, 1.0]], [0, [1618.2351018105112, 1.0]], [0, [239.74959030399356, 1.0]], [0, [52.28374358017642, 1.0]], [0, [6.348159749877997, 1.0]], [0, [3.123118460190663, 1.0]], [0, [0.3886772637538851, 1.0]], [1, [1362.7929724031749, 1.0]], [1, [665.180256313669, 1.0]], [1, [303.3181068542661, 1.0]], [1, [316.14422312875513, 1.0]], [1, [49.321320133684274, 1.0]], [1, [4.844466425252313, 1.0]], [1, [14.623147129814239, 1.0]], [1, [0.6821643580096051, 1.0]], [1, [1.6668563625054187, 1.0]], [1, [0.2013552802944088, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50789708]
bas 1, expnt(s) = [7618.25027273]
bas 2, expnt(s) = [3618.24976784]
bas 3, expnt(s) = [1618.23510181]
bas 4, expnt(s) = [239.7495903]
bas 5, expnt(s) = [52.28374358]
bas 6, expnt(s) = [6.34815975]
bas 7, expnt(s) = [3.12311846]
bas 8, expnt(s) = [0.38867726]
bas 9, expnt(s) = [1362.7929724]
bas 10, expnt(s) = [665.18025631]
bas 11, expnt(s) = [303.31810685]
bas 12, expnt(s) = [316.14422313]
bas 13, expnt(s) = [49.32132013]
bas 14, expnt(s) = [4.84446643]
bas 15, expnt(s) = [14.62314713]
bas 16, expnt(s) = [0.68216436]
bas 17, expnt(s) = [1.66685636]
bas 18, expnt(s) = [0.20135528]
CPU time:        83.05
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024083e+03 7.61825027e+03 2.06018609e+03
 3.61824977e+03 1.17866105e+03 1.61823510e+03 6.44608811e+02
 2.39749590e+02 1.53933601e+02 5.22837436e+01 4.91235825e+01
 6.34815975e+00 1.01041762e+01 3.12311846e+00 5.93548712e+00
 3.88677264e-01 1.24367492e+00 1.36279297e+03 2.41558180e+04
 6.65180256e+02 9.85504429e+03 3.03318107e+02 3.69281298e+03
 3.16144223e+02 3.88902698e+03 4.93213201e+01 3.81309616e+02
 4.84446643e+00 2.09672672e+01 1.46231471e+01 8.34229330e+01
 6.82164358e-01 1.80861310e+00 1.66685636e+00 5.52531591e+00
 2.01355280e-01 3.93494051e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.984886824073875
cond(S) = 83979.85425661707
E1 = -728.1740201637067  E_coul = 202.9696040995654
init E= -525.204416064141
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559982778200329  LUMO = 0.864327050858841
  mo_energy =
[-1.18000201e+02 -1.21784158e+01 -9.45884347e+00 -9.45884347e+00
 -9.45884347e+00 -1.22864729e+00 -5.59982778e-01 -5.59982778e-01
 -5.59982778e-01  8.64327051e-01  8.64327051e-01  8.64327051e-01
  4.58264889e+00  4.58264889e+00  4.58264889e+00  8.28712725e+00
  1.99595555e+01  1.99595555e+01  1.99595555e+01  8.92249319e+01
  8.92249319e+01  8.92249319e+01  2.02838969e+02  4.20973229e+02
  4.20973229e+02  4.20973229e+02  1.27457491e+03  1.27457491e+03
  1.27457491e+03  1.92941372e+03  2.97662023e+03  2.97662023e+03
  2.97662023e+03  6.60578114e+03  6.60578114e+03  6.60578114e+03
  8.28610200e+03  2.46731604e+04  7.54686714e+04]
E1 = -726.8784319358832  E_coul = 200.98278616595505
cycle= 1 E= -525.895645769928  delta_E= -0.691  |g|= 0.195  |ddm|= 0.872
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.512201
diis-c [-0.26234959  1.        ]
  HOMO = -0.589438935675697  LUMO = 0.849132546377633
  mo_energy =
[-1.18326227e+02 -1.23076932e+01 -9.59647068e+00 -9.59647068e+00
 -9.59647068e+00 -1.26520669e+00 -5.89438936e-01 -5.89438936e-01
 -5.89438936e-01  8.49132546e-01  8.49132546e-01  8.49132546e-01
  4.52581912e+00  4.52581912e+00  4.52581912e+00  8.19793192e+00
  1.98389728e+01  1.98389728e+01  1.98389728e+01  8.90107414e+01
  8.90107414e+01  8.90107414e+01  2.02551038e+02  4.20649406e+02
  4.20649406e+02  4.20649406e+02  1.27417964e+03  1.27417964e+03
  1.27417964e+03  1.92885613e+03  2.97613999e+03  2.97613999e+03
  2.97613999e+03  6.60516039e+03  6.60516039e+03  6.60516039e+03
  8.28538316e+03  2.46723374e+04  7.54677500e+04]
E1 = -727.3647576119985  E_coul = 201.46845943924114
cycle= 2 E= -525.896298172757  delta_E= -0.000652  |g|= 0.0346  |ddm|= 0.0376
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0634207
diis-c [-0.00209172  0.07929553  0.92070447]
  HOMO = -0.582563117096061  LUMO = 0.85320640519397
  mo_energy =
[-1.18265063e+02 -1.22755463e+01 -9.56281230e+00 -9.56281230e+00
 -9.56281230e+00 -1.25647001e+00 -5.82563117e-01 -5.82563117e-01
 -5.82563117e-01  8.53206405e-01  8.53206405e-01  8.53206405e-01
  4.53929334e+00  4.53929334e+00  4.53929334e+00  8.22179877e+00
  1.98676132e+01  1.98676132e+01  1.98676132e+01  8.90577279e+01
  8.90577279e+01  8.90577279e+01  2.02609316e+02  4.20709966e+02
  4.20709966e+02  4.20709966e+02  1.27424409e+03  1.27424409e+03
  1.27424409e+03  1.92892331e+03  2.97620638e+03  2.97620638e+03
  2.97620638e+03  6.60522820e+03  6.60522820e+03  6.60522820e+03
  8.28545166e+03  2.46724063e+04  7.54678191e+04]
E1 = -727.2481769200077  E_coul = 201.35183834189968
cycle= 3 E= -525.896338578108  delta_E= -4.04e-05  |g|= 0.00495  |ddm|= 0.0118
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00968901
diis-c [-3.71486083e-07 -1.27014983e-03  1.26694944e-01  8.74575206e-01]
  HOMO = -0.583675847636817  LUMO = 0.852549500546016
  mo_energy =
[-1.18273053e+02 -1.22800404e+01 -9.56756592e+00 -9.56756592e+00
 -9.56756592e+00 -1.25781025e+00 -5.83675848e-01 -5.83675848e-01
 -5.83675848e-01  8.52549501e-01  8.52549501e-01  8.52549501e-01
  4.53723274e+00  4.53723274e+00  4.53723274e+00  8.21848624e+00
  1.98635253e+01  1.98635253e+01  1.98635253e+01  8.90514117e+01
  8.90514117e+01  8.90514117e+01  2.02601716e+02  4.20702049e+02
  4.20702049e+02  4.20702049e+02  1.27423566e+03  1.27423566e+03
  1.27423566e+03  1.92891436e+03  2.97619763e+03  2.97619763e+03
  2.97619763e+03  6.60521910e+03  6.60521910e+03  6.60521910e+03
  8.28544236e+03  2.46723968e+04  7.54678095e+04]
E1 = -727.2644150775196  E_coul = 201.36807547588904
cycle= 4 E= -525.896339601631  delta_E= -1.02e-06  |g|= 6.19e-05  |ddm|= 0.00145
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.1923e-05
diis-c [-2.46219514e-09 -1.34061344e-05 -1.08607673e-03 -7.78391767e-03
  1.00888340e+00]
  HOMO = -0.583650748052595  LUMO = 0.852563841581789
  mo_energy =
[-1.18272977e+02 -1.22799552e+01 -9.56748738e+00 -9.56748738e+00
 -9.56748738e+00 -1.25777390e+00 -5.83650748e-01 -5.83650748e-01
 -5.83650748e-01  8.52563842e-01  8.52563842e-01  8.52563842e-01
  4.53727744e+00  4.53727744e+00  4.53727744e+00  8.21856409e+00
  1.98635959e+01  1.98635959e+01  1.98635959e+01  8.90514906e+01
  8.90514906e+01  8.90514906e+01  2.02601794e+02  4.20702125e+02
  4.20702125e+02  4.20702125e+02  1.27423573e+03  1.27423573e+03
  1.27423573e+03  1.92891441e+03  2.97619769e+03  2.97619769e+03
  2.97619769e+03  6.60521916e+03  6.60521916e+03  6.60521916e+03
  8.28544241e+03  2.46723969e+04  7.54678095e+04]
E1 = -727.2641980576338  E_coul = 201.36785845577305
cycle= 5 E= -525.896339601861  delta_E= -2.3e-10  |g|= 1.19e-05  |ddm|= 4.75e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.2641980576338  E_coul = 201.36785845577305
  HOMO = -0.583655885301436  LUMO = 0.852560833344143
  mo_energy =
[-1.18273003e+02 -1.22799724e+01 -9.56750589e+00 -9.56750589e+00
 -9.56750589e+00 -1.25777987e+00 -5.83655885e-01 -5.83655885e-01
 -5.83655885e-01  8.52560833e-01  8.52560833e-01  8.52560833e-01
  4.53726837e+00  4.53726837e+00  4.53726837e+00  8.21855113e+00
  1.98635797e+01  1.98635797e+01  1.98635797e+01  8.90514687e+01
  8.90514687e+01  8.90514687e+01  2.02601770e+02  4.20702099e+02
  4.20702099e+02  4.20702099e+02  1.27423570e+03  1.27423570e+03
  1.27423570e+03  1.92891439e+03  2.97619766e+03  2.97619766e+03
  2.97619766e+03  6.60521913e+03  6.60521913e+03  6.60521913e+03
  8.28544238e+03  2.46723969e+04  7.54678095e+04]
E1 = -727.2642590467116  E_coul = 201.36791944484153
Extra cycle  E= -525.89633960187  delta_E= -9.32e-12  |g|= 3.57e-06  |ddm|= 5.31e-06
    CPU time for scf_cycle      0.61 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 83979.85425661707
E1 = -727.2642590467116  E_coul = 201.36791944484153
init E= -525.89633960187
    CPU time for initialize scf      2.69 sec, wall time      0.24 sec
  HOMO = -0.583654750084349  LUMO = 0.852561499462582
  mo_energy =
[-1.18272996e+02 -1.22799679e+01 -9.56750127e+00 -9.56750127e+00
 -9.56750127e+00 -1.25777843e+00 -5.83654750e-01 -5.83654750e-01
 -5.83654750e-01  8.52561499e-01  8.52561499e-01  8.52561499e-01
  4.53727046e+00  4.53727046e+00  4.53727046e+00  8.21855461e+00
  1.98635837e+01  1.98635837e+01  1.98635837e+01  8.90514746e+01
  8.90514746e+01  8.90514746e+01  2.02601777e+02  4.20702107e+02
  4.20702107e+02  4.20702107e+02  1.27423571e+03  1.27423571e+03
  1.27423571e+03  1.92891439e+03  2.97619767e+03  2.97619767e+03
  2.97619767e+03  6.60521913e+03  6.60521913e+03  6.60521913e+03
  8.28544239e+03  2.46723969e+04  7.54678095e+04]
E1 = -727.2642437724143  E_coul = 201.36790417054453
cycle= 1 E= -525.89633960187  delta_E= 3.41e-13  |g|= 9.39e-07  |ddm|= 1.62e-06
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.2642437724143  E_coul = 201.36790417054453
  HOMO = -0.583655021324039  LUMO = 0.852561339750554
  mo_energy =
[-1.18272998e+02 -1.22799690e+01 -9.56750243e+00 -9.56750243e+00
 -9.56750243e+00 -1.25777876e+00 -5.83655021e-01 -5.83655021e-01
 -5.83655021e-01  8.52561340e-01  8.52561340e-01  8.52561340e-01
  4.53726996e+00  4.53726996e+00  4.53726996e+00  8.21855378e+00
  1.98635827e+01  1.98635827e+01  1.98635827e+01  8.90514731e+01
  8.90514731e+01  8.90514731e+01  2.02601775e+02  4.20702105e+02
  4.20702105e+02  4.20702105e+02  1.27423571e+03  1.27423571e+03
  1.27423571e+03  1.92891439e+03  2.97619767e+03  2.97619767e+03
  2.97619767e+03  6.60521913e+03  6.60521913e+03  6.60521913e+03
  8.28544238e+03  2.46723969e+04  7.54678095e+04]
E1 = -727.2642477007752  E_coul = 201.36790809890542
Extra cycle  E= -525.89633960187  delta_E=    0  |g|= 2.47e-07  |ddm|= 3.7e-07
    CPU time for scf_cycle      2.81 sec, wall time      0.36 sec
exp = [2.61825079e+04 7.61825027e+03 3.61824977e+03 1.61823510e+03
 2.39749590e+02 5.22837436e+01 6.34815975e+00 3.12311846e+00
 3.88677264e-01 1.36279297e+03 6.65180256e+02 3.03318107e+02
 3.16144223e+02 4.93213201e+01 4.84446643e+00 1.46231471e+01
 6.82164358e-01 1.66685636e+00 2.01355280e-01]
grad_E = [-1.97754127e-06  2.12405398e-05  4.18963873e-05  6.48349490e-04
  2.44694160e-03 -3.87892991e-02 -5.48238301e-02  3.39962032e-02
 -8.07045132e-02  1.19401438e-06  1.89863077e-05  1.02020451e-04
  8.98593746e-05 -4.35629177e-04 -4.73244614e-02  6.92872818e-03
  1.21583772e-01 -3.05058605e-03 -2.40323149e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:39:34 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5079089        1
[INPUT] 0    0    [1    /1   ]  7618.25014574        1
[INPUT] 0    0    [1    /1   ]  3618.24951671        1
[INPUT] 0    0    [1    /1   ]  1618.23122118        1
[INPUT] 0    0    [1    /1   ]  239.737446392        1
[INPUT] 0    0    [1    /1   ]  52.457641799         1
[INPUT] 0    0    [1    /1   ]  6.72857445827        1
[INPUT] 0    0    [1    /1   ]  3.31533145742        1
[INPUT] 0    0    [1    /1   ]  0.391363907698       1
[INPUT] 1    0    [1    /1   ]  1362.79296488        1
[INPUT] 1    0    [1    /1   ]  665.18014036         1
[INPUT] 1    0    [1    /1   ]  303.317481453        1
[INPUT] 1    0    [1    /1   ]  316.143672276        1
[INPUT] 1    0    [1    /1   ]  49.3262664558        1
[INPUT] 1    0    [1    /1   ]  5.04051902523        1
[INPUT] 1    0    [1    /1   ]  14.5748351566        1
[INPUT] 1    0    [1    /1   ]  0.674435083092       1
[INPUT] 1    0    [1    /1   ]  1.68309356389        1
[INPUT] 1    0    [1    /1   ]  0.202335899392       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.50790885421, 1.0]], [0, [7618.250145743634, 1.0]], [0, [3618.249516714404, 1.0]], [0, [1618.2312211825388, 1.0]], [0, [239.73744639218248, 1.0]], [0, [52.45764179902065, 1.0]], [0, [6.728574458274598, 1.0]], [0, [3.315331457422669, 1.0]], [0, [0.391363907697552, 1.0]], [1, [1362.7929648823872, 1.0]], [1, [665.1801403603935, 1.0]], [1, [303.31748145325906, 1.0]], [1, [316.14367227645056, 1.0]], [1, [49.326266455809666, 1.0]], [1, [5.040519025233748, 1.0]], [1, [14.574835156609643, 1.0]], [1, [0.6744350830917992, 1.0]], [1, [1.6830935638874258, 1.0]], [1, [0.20233589939235025, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50790885]
bas 1, expnt(s) = [7618.25014574]
bas 2, expnt(s) = [3618.24951671]
bas 3, expnt(s) = [1618.23122118]
bas 4, expnt(s) = [239.73744639]
bas 5, expnt(s) = [52.4576418]
bas 6, expnt(s) = [6.72857446]
bas 7, expnt(s) = [3.31533146]
bas 8, expnt(s) = [0.39136391]
bas 9, expnt(s) = [1362.79296488]
bas 10, expnt(s) = [665.18014036]
bas 11, expnt(s) = [303.31748145]
bas 12, expnt(s) = [316.14367228]
bas 13, expnt(s) = [49.32626646]
bas 14, expnt(s) = [5.04051903]
bas 15, expnt(s) = [14.57483516]
bas 16, expnt(s) = [0.67443508]
bas 17, expnt(s) = [1.68309356]
bas 18, expnt(s) = [0.2023359]
CPU time:        91.03
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024083e+03 7.61825015e+03 2.06018607e+03
 3.61824952e+03 1.17866099e+03 1.61823122e+03 6.44607651e+02
 2.39737446e+02 1.53927753e+02 5.24576418e+01 4.92460721e+01
 6.72857446e+00 1.05549777e+01 3.31533146e+00 6.20740726e+00
 3.91363908e-01 1.25011683e+00 1.36279296e+03 2.41558179e+04
 6.65180140e+02 9.85504214e+03 3.03317481e+02 3.69280346e+03
 3.16143672e+02 3.88901851e+03 4.93262665e+01 3.81357418e+02
 5.04051903e+00 2.20332451e+01 1.45748352e+01 8.30785594e+01
 6.74435083e-01 1.78303384e+00 1.68309356e+00 5.59267673e+00
 2.02335899e-01 3.95890949e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98479149145465
cond(S) = 84086.93831313941
E1 = -728.2573674426391  E_coul = 202.99658198983067
init E= -525.260785452808
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559654636536865  LUMO = 0.862619881733007
  mo_energy =
[-1.18007324e+02 -1.21755810e+01 -9.45710487e+00 -9.45710487e+00
 -9.45710487e+00 -1.22844940e+00 -5.59654637e-01 -5.59654637e-01
 -5.59654637e-01  8.62619882e-01  8.62619882e-01  8.62619882e-01
  4.61829705e+00  4.61829705e+00  4.61829705e+00  9.23465681e+00
  2.04100518e+01  2.04100518e+01  2.04100518e+01  8.98105786e+01
  8.98105786e+01  8.98105786e+01  2.05679747e+02  4.21396355e+02
  4.21396355e+02  4.21396355e+02  1.27493641e+03  1.27493641e+03
  1.27493641e+03  1.93179128e+03  2.97695138e+03  2.97695138e+03
  2.97695138e+03  6.60608096e+03  6.60608096e+03  6.60608096e+03
  8.28821456e+03  2.46751463e+04  7.54705143e+04]
E1 = -727.0598611258723  E_coul = 201.1413046229747
cycle= 1 E= -525.918556502898  delta_E= -0.658  |g|= 0.188  |ddm|= 0.415
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.500188
diis-c [-0.25018832  1.        ]
  HOMO = -0.586603437215802  LUMO = 0.849099979918089
  mo_energy =
[-1.18317106e+02 -1.22962153e+01 -9.58438663e+00 -9.58438663e+00
 -9.58438663e+00 -1.26269937e+00 -5.86603437e-01 -5.86603437e-01
 -5.86603437e-01  8.49099980e-01  8.49099980e-01  8.49099980e-01
  4.56475561e+00  4.56475561e+00  4.56475561e+00  9.14695200e+00
  2.02971129e+01  2.02971129e+01  2.02971129e+01  8.96101795e+01
  8.96101795e+01  8.96101795e+01  2.05405926e+02  4.21088012e+02
  4.21088012e+02  4.21088012e+02  1.27455674e+03  1.27455674e+03
  1.27455674e+03  1.93124981e+03  2.97648707e+03  2.97648707e+03
  2.97648707e+03  6.60547625e+03  6.60547625e+03  6.60547625e+03
  8.28751183e+03  2.46743394e+04  7.54696090e+04]
E1 = -727.5092716450952  E_coul = 201.59015658679817
cycle= 2 E= -525.919115058297  delta_E= -0.000559  |g|= 0.0322  |ddm|= 0.035
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0593743
diis-c [-0.0019508   0.07376649  0.92623351]
  HOMO = -0.580233632714382  LUMO = 0.852858033962114
  mo_energy =
[-1.18259976e+02 -1.22663901e+01 -9.55313246e+00 -9.55313246e+00
 -9.55313246e+00 -1.25459539e+00 -5.80233633e-01 -5.80233633e-01
 -5.80233633e-01  8.52858034e-01  8.52858034e-01  8.52858034e-01
  4.57738831e+00  4.57738831e+00  4.57738831e+00  9.17005647e+00
  2.03239262e+01  2.03239262e+01  2.03239262e+01  8.96539275e+01
  8.96539275e+01  8.96539275e+01  2.05460333e+02  4.21144569e+02
  4.21144569e+02  4.21144569e+02  1.27461699e+03  1.27461699e+03
  1.27461699e+03  1.93131268e+03  2.97654918e+03  2.97654918e+03
  2.97654918e+03  6.60553973e+03  6.60553973e+03  6.60553973e+03
  8.28757598e+03  2.46744039e+04  7.54696737e+04]
E1 = -727.4024548541959  E_coul = 201.48330581377226
cycle= 3 E= -525.919149040424  delta_E= -3.4e-05  |g|= 0.00474  |ddm|= 0.0105
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00924306
diis-c [-2.60328149e-07 -1.17789969e-03  1.29334645e-01  8.71843255e-01]
  HOMO = -0.581266784917292  LUMO = 0.85225123217394
  mo_energy =
[-1.18267620e+02 -1.22706519e+01 -9.55762842e+00 -9.55762842e+00
 -9.55762842e+00 -1.25585351e+00 -5.81266785e-01 -5.81266785e-01
 -5.81266785e-01  8.52251232e-01  8.52251232e-01  8.52251232e-01
  4.57543826e+00  4.57543826e+00  4.57543826e+00  9.16678269e+00
  2.03200337e+01  2.03200337e+01  2.03200337e+01  8.96479142e+01
  8.96479142e+01  8.96479142e+01  2.05453063e+02  4.21136996e+02
  4.21136996e+02  4.21136996e+02  1.27460892e+03  1.27460892e+03
  1.27460892e+03  1.93130412e+03  2.97654080e+03  2.97654080e+03
  2.97654080e+03  6.60553103e+03  6.60553103e+03  6.60553103e+03
  8.28756709e+03  2.46743949e+04  7.54696645e+04]
E1 = -727.4176134090234  E_coul = 201.49846346885803
cycle= 4 E= -525.919149940165  delta_E= -9e-07  |g|= 5.11e-05  |ddm|= 0.00135
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.18729e-05
diis-c [-1.69822141e-09 -1.64627484e-05 -2.20028070e-04 -5.87258232e-04
  1.00082375e+00]
  HOMO = -0.581243930376231  LUMO = 0.852264246582384
  mo_energy =
[-1.18267548e+02 -1.22705753e+01 -9.55755644e+00 -9.55755644e+00
 -9.55755644e+00 -1.25582126e+00 -5.81243930e-01 -5.81243930e-01
 -5.81243930e-01  8.52264247e-01  8.52264247e-01  8.52264247e-01
  4.57547916e+00  4.57547916e+00  4.57547916e+00  9.16685298e+00
  2.03200985e+01  2.03200985e+01  2.03200985e+01  8.96479874e+01
  8.96479874e+01  8.96479874e+01  2.05453137e+02  4.21137068e+02
  4.21137068e+02  4.21137068e+02  1.27460899e+03  1.27460899e+03
  1.27460899e+03  1.93130417e+03  2.97654086e+03  2.97654086e+03
  2.97654086e+03  6.60553108e+03  6.60553108e+03  6.60553108e+03
  8.28756714e+03  2.46743949e+04  7.54696646e+04]
E1 = -727.417415780711  E_coul = 201.49826584038394
cycle= 5 E= -525.919149940327  delta_E= -1.62e-10  |g|= 9.57e-06  |ddm|= 3.71e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.417415780711  E_coul = 201.49826584038394
  HOMO = -0.581248048608399  LUMO = 0.852261843378509
  mo_energy =
[-1.18267569e+02 -1.22705891e+01 -9.55757126e+00 -9.55757126e+00
 -9.55757126e+00 -1.25582609e+00 -5.81248049e-01 -5.81248049e-01
 -5.81248049e-01  8.52261843e-01  8.52261843e-01  8.52261843e-01
  4.57547181e+00  4.57547181e+00  4.57547181e+00  9.16684219e+00
  2.03200854e+01  2.03200854e+01  2.03200854e+01  8.96479699e+01
  8.96479699e+01  8.96479699e+01  2.05453117e+02  4.21137047e+02
  4.21137047e+02  4.21137047e+02  1.27460897e+03  1.27460897e+03
  1.27460897e+03  1.93130415e+03  2.97654084e+03  2.97654084e+03
  2.97654084e+03  6.60553106e+03  6.60553106e+03  6.60553106e+03
  8.28756712e+03  2.46743949e+04  7.54696646e+04]
E1 = -727.4174636090888  E_coul = 201.49831366875526
Extra cycle  E= -525.919149940334  delta_E= -6.48e-12  |g|= 2.83e-06  |ddm|= 4.12e-06
    CPU time for scf_cycle      0.61 sec, wall time      0.23 sec
exp = [2.61825079e+04 7.61825015e+03 3.61824952e+03 1.61823122e+03
 2.39737446e+02 5.24576418e+01 6.72857446e+00 3.31533146e+00
 3.91363908e-01 1.36279296e+03 6.65180140e+02 3.03317481e+02
 3.16143672e+02 4.93262665e+01 5.04051903e+00 1.45748352e+01
 6.74435083e-01 1.68309356e+00 2.02335899e-01]
E = -525.9191499403336
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:39:34 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5079089        1
[INPUT] 0    0    [1    /1   ]  7618.25014574        1
[INPUT] 0    0    [1    /1   ]  3618.24951671        1
[INPUT] 0    0    [1    /1   ]  1618.23122118        1
[INPUT] 0    0    [1    /1   ]  239.737446392        1
[INPUT] 0    0    [1    /1   ]  52.457641799         1
[INPUT] 0    0    [1    /1   ]  6.72857445827        1
[INPUT] 0    0    [1    /1   ]  3.31533145742        1
[INPUT] 0    0    [1    /1   ]  0.391363907698       1
[INPUT] 1    0    [1    /1   ]  1362.79296488        1
[INPUT] 1    0    [1    /1   ]  665.18014036         1
[INPUT] 1    0    [1    /1   ]  303.317481453        1
[INPUT] 1    0    [1    /1   ]  316.143672276        1
[INPUT] 1    0    [1    /1   ]  49.3262664558        1
[INPUT] 1    0    [1    /1   ]  5.04051902523        1
[INPUT] 1    0    [1    /1   ]  14.5748351566        1
[INPUT] 1    0    [1    /1   ]  0.674435083092       1
[INPUT] 1    0    [1    /1   ]  1.68309356389        1
[INPUT] 1    0    [1    /1   ]  0.202335899392       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.50790885421, 1.0]], [0, [7618.250145743634, 1.0]], [0, [3618.249516714404, 1.0]], [0, [1618.2312211825388, 1.0]], [0, [239.73744639218248, 1.0]], [0, [52.45764179902065, 1.0]], [0, [6.728574458274598, 1.0]], [0, [3.315331457422669, 1.0]], [0, [0.391363907697552, 1.0]], [1, [1362.7929648823872, 1.0]], [1, [665.1801403603935, 1.0]], [1, [303.31748145325906, 1.0]], [1, [316.14367227645056, 1.0]], [1, [49.326266455809666, 1.0]], [1, [5.040519025233748, 1.0]], [1, [14.574835156609643, 1.0]], [1, [0.6744350830917992, 1.0]], [1, [1.6830935638874258, 1.0]], [1, [0.20233589939235025, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50790885]
bas 1, expnt(s) = [7618.25014574]
bas 2, expnt(s) = [3618.24951671]
bas 3, expnt(s) = [1618.23122118]
bas 4, expnt(s) = [239.73744639]
bas 5, expnt(s) = [52.4576418]
bas 6, expnt(s) = [6.72857446]
bas 7, expnt(s) = [3.31533146]
bas 8, expnt(s) = [0.39136391]
bas 9, expnt(s) = [1362.79296488]
bas 10, expnt(s) = [665.18014036]
bas 11, expnt(s) = [303.31748145]
bas 12, expnt(s) = [316.14367228]
bas 13, expnt(s) = [49.32626646]
bas 14, expnt(s) = [5.04051903]
bas 15, expnt(s) = [14.57483516]
bas 16, expnt(s) = [0.67443508]
bas 17, expnt(s) = [1.68309356]
bas 18, expnt(s) = [0.2023359]
CPU time:        91.70
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024083e+03 7.61825015e+03 2.06018607e+03
 3.61824952e+03 1.17866099e+03 1.61823122e+03 6.44607651e+02
 2.39737446e+02 1.53927753e+02 5.24576418e+01 4.92460721e+01
 6.72857446e+00 1.05549777e+01 3.31533146e+00 6.20740726e+00
 3.91363908e-01 1.25011683e+00 1.36279296e+03 2.41558179e+04
 6.65180140e+02 9.85504214e+03 3.03317481e+02 3.69280346e+03
 3.16143672e+02 3.88901851e+03 4.93262665e+01 3.81357418e+02
 5.04051903e+00 2.20332451e+01 1.45748352e+01 8.30785594e+01
 6.74435083e-01 1.78303384e+00 1.68309356e+00 5.59267673e+00
 2.02335899e-01 3.95890949e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98479149145465
cond(S) = 84086.93831313941
E1 = -728.2573674426391  E_coul = 202.99658198983067
init E= -525.260785452808
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559654636536865  LUMO = 0.862619881733007
  mo_energy =
[-1.18007324e+02 -1.21755810e+01 -9.45710487e+00 -9.45710487e+00
 -9.45710487e+00 -1.22844940e+00 -5.59654637e-01 -5.59654637e-01
 -5.59654637e-01  8.62619882e-01  8.62619882e-01  8.62619882e-01
  4.61829705e+00  4.61829705e+00  4.61829705e+00  9.23465681e+00
  2.04100518e+01  2.04100518e+01  2.04100518e+01  8.98105786e+01
  8.98105786e+01  8.98105786e+01  2.05679747e+02  4.21396355e+02
  4.21396355e+02  4.21396355e+02  1.27493641e+03  1.27493641e+03
  1.27493641e+03  1.93179128e+03  2.97695138e+03  2.97695138e+03
  2.97695138e+03  6.60608096e+03  6.60608096e+03  6.60608096e+03
  8.28821456e+03  2.46751463e+04  7.54705143e+04]
E1 = -727.0598611258723  E_coul = 201.1413046229747
cycle= 1 E= -525.918556502898  delta_E= -0.658  |g|= 0.188  |ddm|= 0.415
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.500188
diis-c [-0.25018832  1.        ]
  HOMO = -0.586603437215802  LUMO = 0.849099979918089
  mo_energy =
[-1.18317106e+02 -1.22962153e+01 -9.58438663e+00 -9.58438663e+00
 -9.58438663e+00 -1.26269937e+00 -5.86603437e-01 -5.86603437e-01
 -5.86603437e-01  8.49099980e-01  8.49099980e-01  8.49099980e-01
  4.56475561e+00  4.56475561e+00  4.56475561e+00  9.14695200e+00
  2.02971129e+01  2.02971129e+01  2.02971129e+01  8.96101795e+01
  8.96101795e+01  8.96101795e+01  2.05405926e+02  4.21088012e+02
  4.21088012e+02  4.21088012e+02  1.27455674e+03  1.27455674e+03
  1.27455674e+03  1.93124981e+03  2.97648707e+03  2.97648707e+03
  2.97648707e+03  6.60547625e+03  6.60547625e+03  6.60547625e+03
  8.28751183e+03  2.46743394e+04  7.54696090e+04]
E1 = -727.5092716450952  E_coul = 201.59015658679817
cycle= 2 E= -525.919115058297  delta_E= -0.000559  |g|= 0.0322  |ddm|= 0.035
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0593743
diis-c [-0.0019508   0.07376649  0.92623351]
  HOMO = -0.580233632714382  LUMO = 0.852858033962114
  mo_energy =
[-1.18259976e+02 -1.22663901e+01 -9.55313246e+00 -9.55313246e+00
 -9.55313246e+00 -1.25459539e+00 -5.80233633e-01 -5.80233633e-01
 -5.80233633e-01  8.52858034e-01  8.52858034e-01  8.52858034e-01
  4.57738831e+00  4.57738831e+00  4.57738831e+00  9.17005647e+00
  2.03239262e+01  2.03239262e+01  2.03239262e+01  8.96539275e+01
  8.96539275e+01  8.96539275e+01  2.05460333e+02  4.21144569e+02
  4.21144569e+02  4.21144569e+02  1.27461699e+03  1.27461699e+03
  1.27461699e+03  1.93131268e+03  2.97654918e+03  2.97654918e+03
  2.97654918e+03  6.60553973e+03  6.60553973e+03  6.60553973e+03
  8.28757598e+03  2.46744039e+04  7.54696737e+04]
E1 = -727.4024548541959  E_coul = 201.48330581377226
cycle= 3 E= -525.919149040424  delta_E= -3.4e-05  |g|= 0.00474  |ddm|= 0.0105
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00924306
diis-c [-2.60328149e-07 -1.17789969e-03  1.29334645e-01  8.71843255e-01]
  HOMO = -0.581266784917292  LUMO = 0.85225123217394
  mo_energy =
[-1.18267620e+02 -1.22706519e+01 -9.55762842e+00 -9.55762842e+00
 -9.55762842e+00 -1.25585351e+00 -5.81266785e-01 -5.81266785e-01
 -5.81266785e-01  8.52251232e-01  8.52251232e-01  8.52251232e-01
  4.57543826e+00  4.57543826e+00  4.57543826e+00  9.16678269e+00
  2.03200337e+01  2.03200337e+01  2.03200337e+01  8.96479142e+01
  8.96479142e+01  8.96479142e+01  2.05453063e+02  4.21136996e+02
  4.21136996e+02  4.21136996e+02  1.27460892e+03  1.27460892e+03
  1.27460892e+03  1.93130412e+03  2.97654080e+03  2.97654080e+03
  2.97654080e+03  6.60553103e+03  6.60553103e+03  6.60553103e+03
  8.28756709e+03  2.46743949e+04  7.54696645e+04]
E1 = -727.4176134090234  E_coul = 201.49846346885803
cycle= 4 E= -525.919149940165  delta_E= -9e-07  |g|= 5.11e-05  |ddm|= 0.00135
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.18729e-05
diis-c [-1.69822141e-09 -1.64627484e-05 -2.20028070e-04 -5.87258232e-04
  1.00082375e+00]
  HOMO = -0.581243930376231  LUMO = 0.852264246582384
  mo_energy =
[-1.18267548e+02 -1.22705753e+01 -9.55755644e+00 -9.55755644e+00
 -9.55755644e+00 -1.25582126e+00 -5.81243930e-01 -5.81243930e-01
 -5.81243930e-01  8.52264247e-01  8.52264247e-01  8.52264247e-01
  4.57547916e+00  4.57547916e+00  4.57547916e+00  9.16685298e+00
  2.03200985e+01  2.03200985e+01  2.03200985e+01  8.96479874e+01
  8.96479874e+01  8.96479874e+01  2.05453137e+02  4.21137068e+02
  4.21137068e+02  4.21137068e+02  1.27460899e+03  1.27460899e+03
  1.27460899e+03  1.93130417e+03  2.97654086e+03  2.97654086e+03
  2.97654086e+03  6.60553108e+03  6.60553108e+03  6.60553108e+03
  8.28756714e+03  2.46743949e+04  7.54696646e+04]
E1 = -727.417415780711  E_coul = 201.49826584038394
cycle= 5 E= -525.919149940327  delta_E= -1.62e-10  |g|= 9.57e-06  |ddm|= 3.71e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.417415780711  E_coul = 201.49826584038394
  HOMO = -0.581248048608399  LUMO = 0.852261843378509
  mo_energy =
[-1.18267569e+02 -1.22705891e+01 -9.55757126e+00 -9.55757126e+00
 -9.55757126e+00 -1.25582609e+00 -5.81248049e-01 -5.81248049e-01
 -5.81248049e-01  8.52261843e-01  8.52261843e-01  8.52261843e-01
  4.57547181e+00  4.57547181e+00  4.57547181e+00  9.16684219e+00
  2.03200854e+01  2.03200854e+01  2.03200854e+01  8.96479699e+01
  8.96479699e+01  8.96479699e+01  2.05453117e+02  4.21137047e+02
  4.21137047e+02  4.21137047e+02  1.27460897e+03  1.27460897e+03
  1.27460897e+03  1.93130415e+03  2.97654084e+03  2.97654084e+03
  2.97654084e+03  6.60553106e+03  6.60553106e+03  6.60553106e+03
  8.28756712e+03  2.46743949e+04  7.54696646e+04]
E1 = -727.4174636090888  E_coul = 201.49831366875526
Extra cycle  E= -525.919149940334  delta_E= -6.48e-12  |g|= 2.83e-06  |ddm|= 4.12e-06
    CPU time for scf_cycle      0.61 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 84086.93831313941
E1 = -727.4174636090888  E_coul = 201.49831366875526
init E= -525.919149940334
    CPU time for initialize scf      2.69 sec, wall time      0.25 sec
  HOMO = -0.581247168900677  LUMO = 0.85226235645076
  mo_energy =
[-1.18267563e+02 -1.22705856e+01 -9.55756764e+00 -9.55756764e+00
 -9.55756764e+00 -1.25582497e+00 -5.81247169e-01 -5.81247169e-01
 -5.81247169e-01  8.52262356e-01  8.52262356e-01  8.52262356e-01
  4.57547346e+00  4.57547346e+00  4.57547346e+00  9.16684501e+00
  2.03200885e+01  2.03200885e+01  2.03200885e+01  8.96479745e+01
  8.96479745e+01  8.96479745e+01  2.05453122e+02  4.21137053e+02
  4.21137053e+02  4.21137053e+02  1.27460897e+03  1.27460897e+03
  1.27460897e+03  1.93130416e+03  2.97654085e+03  2.97654085e+03
  2.97654085e+03  6.60553106e+03  6.60553106e+03  6.60553106e+03
  8.28756712e+03  2.46743949e+04  7.54696646e+04]
E1 = -727.4174517944365  E_coul = 201.49830185410391
cycle= 1 E= -525.919149940333  delta_E= 1.02e-12  |g|= 7.33e-07  |ddm|= 1.22e-06
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.4174517944365  E_coul = 201.49830185410391
  HOMO = -0.581247377105314  LUMO = 0.852262234402079
  mo_energy =
[-1.18267565e+02 -1.22705864e+01 -9.55756854e+00 -9.55756854e+00
 -9.55756854e+00 -1.25582523e+00 -5.81247377e-01 -5.81247377e-01
 -5.81247377e-01  8.52262234e-01  8.52262234e-01  8.52262234e-01
  4.57547306e+00  4.57547306e+00  4.57547306e+00  9.16684435e+00
  2.03200878e+01  2.03200878e+01  2.03200878e+01  8.96479733e+01
  8.96479733e+01  8.96479733e+01  2.05453121e+02  4.21137051e+02
  4.21137051e+02  4.21137051e+02  1.27460897e+03  1.27460897e+03
  1.27460897e+03  1.93130415e+03  2.97654085e+03  2.97654085e+03
  2.97654085e+03  6.60553106e+03  6.60553106e+03  6.60553106e+03
  8.28756712e+03  2.46743949e+04  7.54696646e+04]
E1 = -727.4174547831517  E_coul = 201.4983048428185
Extra cycle  E= -525.919149940333  delta_E= -6.82e-13  |g|= 1.9e-07  |ddm|= 2.78e-07
    CPU time for scf_cycle      2.81 sec, wall time      0.37 sec
exp = [2.61825079e+04 7.61825015e+03 3.61824952e+03 1.61823122e+03
 2.39737446e+02 5.24576418e+01 6.72857446e+00 3.31533146e+00
 3.91363908e-01 1.36279296e+03 6.65180140e+02 3.03317481e+02
 3.16143672e+02 4.93262665e+01 5.04051903e+00 1.45748352e+01
 6.74435083e-01 1.68309356e+00 2.02335899e-01]
grad_E = [-1.97767715e-06  2.13504235e-05  4.22318052e-05  6.52467848e-04
  2.17713125e-03 -3.88473078e-02 -4.48242494e-02  4.35403404e-02
 -5.16223637e-02  8.68193370e-07  1.65500130e-05  8.68554514e-05
  7.65422973e-05  2.16893709e-03  1.00435509e-02 -1.64933408e-02
  8.05065698e-02 -1.97487500e-02 -1.44004295e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:39:39 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5079202        1
[INPUT] 0    0    [1    /1   ]  7618.25002387        1
[INPUT] 0    0    [1    /1   ]  3618.24927589        1
[INPUT] 0    0    [1    /1   ]  1618.22749817        1
[INPUT] 0    0    [1    /1   ]  239.724768466        1
[INPUT] 0    0    [1    /1   ]  52.6578168491        1
[INPUT] 0    0    [1    /1   ]  7.07070538134        1
[INPUT] 0    0    [1    /1   ]  3.27063081138        1
[INPUT] 0    0    [1    /1   ]  0.393857301199       1
[INPUT] 1    0    [1    /1   ]  1362.79295829        1
[INPUT] 1    0    [1    /1   ]  665.180033637        1
[INPUT] 1    0    [1    /1   ]  303.316909668        1
[INPUT] 1    0    [1    /1   ]  316.14316859         1
[INPUT] 1    0    [1    /1   ]  49.3263712528        1
[INPUT] 1    0    [1    /1   ]  5.2098763535         1
[INPUT] 1    0    [1    /1   ]  14.5610086979        1
[INPUT] 1    0    [1    /1   ]  0.623599083901       1
[INPUT] 1    0    [1    /1   ]  1.67658571398        1
[INPUT] 1    0    [1    /1   ]  0.18798786057        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.50792016568, 1.0]], [0, [7618.250023869011, 1.0]], [0, [3618.24927588684, 1.0]], [0, [1618.2274981693465, 1.0]], [0, [239.7247684660425, 1.0]], [0, [52.65781684906352, 1.0]], [0, [7.070705381337917, 1.0]], [0, [3.27063081137621, 1.0]], [0, [0.39385730119910667, 1.0]], [1, [1362.7929582923505, 1.0]], [1, [665.1800336368444, 1.0]], [1, [303.3169096682684, 1.0]], [1, [316.1431685900846, 1.0]], [1, [49.32637125279568, 1.0]], [1, [5.209876353495325, 1.0]], [1, [14.561008697926267, 1.0]], [1, [0.6235990839013968, 1.0]], [1, [1.6765857139815263, 1.0]], [1, [0.18798786056955386, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50792017]
bas 1, expnt(s) = [7618.25002387]
bas 2, expnt(s) = [3618.24927589]
bas 3, expnt(s) = [1618.22749817]
bas 4, expnt(s) = [239.72476847]
bas 5, expnt(s) = [52.65781685]
bas 6, expnt(s) = [7.07070538]
bas 7, expnt(s) = [3.27063081]
bas 8, expnt(s) = [0.3938573]
bas 9, expnt(s) = [1362.79295829]
bas 10, expnt(s) = [665.18003364]
bas 11, expnt(s) = [303.31690967]
bas 12, expnt(s) = [316.14316859]
bas 13, expnt(s) = [49.32637125]
bas 14, expnt(s) = [5.20987635]
bas 15, expnt(s) = [14.5610087]
bas 16, expnt(s) = [0.62359908]
bas 17, expnt(s) = [1.67658571]
bas 18, expnt(s) = [0.18798786]
CPU time:        99.66
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024083e+03 7.61825002e+03 2.06018604e+03
 3.61824928e+03 1.17866093e+03 1.61822750e+03 6.44606539e+02
 2.39724768e+02 1.53921648e+02 5.26578168e+01 4.93869449e+01
 7.07070538e+00 1.09549924e+01 3.27063081e+00 6.14452997e+00
 3.93857301e-01 1.25608549e+00 1.36279296e+03 2.41558177e+04
 6.65180034e+02 9.85504016e+03 3.03316910e+02 3.69279476e+03
 3.16143169e+02 3.88901076e+03 4.93263713e+01 3.81358431e+02
 5.20987635e+00 2.29624732e+01 1.45610087e+01 8.29800552e+01
 6.23599084e-01 1.61665082e+00 1.67658571e+00 5.56565900e+00
 1.87987861e-01 3.61115932e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.985696215305133
cond(S) = 84133.69355615962
E1 = -728.3395009827556  E_coul = 203.03552275892815
init E= -525.303978223827
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559624158462776  LUMO = 0.776558046901465
  mo_energy =
[-1.18006775e+02 -1.21794395e+01 -9.45276160e+00 -9.45276160e+00
 -9.45276160e+00 -1.22740585e+00 -5.59624158e-01 -5.59624158e-01
 -5.59624158e-01  7.76558047e-01  7.76558047e-01  7.76558047e-01
  4.40065862e+00  4.40065862e+00  4.40065862e+00  9.56334788e+00
  2.05184547e+01  2.05184547e+01  2.05184547e+01  9.01678065e+01
  9.01678065e+01  9.01678065e+01  2.07460019e+02  4.21691111e+02
  4.21691111e+02  4.21691111e+02  1.27519262e+03  1.27519262e+03
  1.27519262e+03  1.93343623e+03  2.97718613e+03  2.97718613e+03
  2.97718613e+03  6.60629366e+03  6.60629366e+03  6.60629366e+03
  8.28968764e+03  2.46765321e+04  7.54718007e+04]
E1 = -727.0547842856962  E_coul = 201.11923293464528
cycle= 1 E= -525.935551351051  delta_E= -0.632  |g|= 0.189  |ddm|= 0.491
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.502639
diis-c [-0.25264609  1.        ]
  HOMO = -0.588143963012569  LUMO = 0.763716897838377
  mo_energy =
[-1.18320015e+02 -1.23040518e+01 -9.58550291e+00 -9.58550291e+00
 -9.58550291e+00 -1.26354252e+00 -5.88143963e-01 -5.88143963e-01
 -5.88143963e-01  7.63716898e-01  7.63716898e-01  7.63716898e-01
  4.34426917e+00  4.34426917e+00  4.34426917e+00  9.46991377e+00
  2.03995193e+01  2.03995193e+01  2.03995193e+01  8.99631472e+01
  8.99631472e+01  8.99631472e+01  2.07180237e+02  4.21379016e+02
  4.21379016e+02  4.21379016e+02  1.27481027e+03  1.27481027e+03
  1.27481027e+03  1.93289539e+03  2.97672115e+03  2.97672115e+03
  2.97672115e+03  6.60568979e+03  6.60568979e+03  6.60568979e+03
  8.28898675e+03  2.46757276e+04  7.54708981e+04]
E1 = -727.5291314780261  E_coul = 201.5929844480297
cycle= 2 E= -525.936147029996  delta_E= -0.000596  |g|= 0.0333  |ddm|= 0.0362
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0609112
diis-c [-0.00206165  0.07502424  0.92497576]
  HOMO = -0.581220530368254  LUMO = 0.767419583205104
  mo_energy =
[-1.18260686e+02 -1.22725240e+01 -9.55259038e+00 -9.55259038e+00
 -9.55259038e+00 -1.25473767e+00 -5.81220530e-01 -5.81220530e-01
 -5.81220530e-01  7.67419583e-01  7.67419583e-01  7.67419583e-01
  4.35773304e+00  4.35773304e+00  4.35773304e+00  9.49485810e+00
  2.04280699e+01  2.04280699e+01  2.04280699e+01  9.00088292e+01
  9.00088292e+01  9.00088292e+01  2.07236788e+02  4.21437752e+02
  4.21437752e+02  4.21437752e+02  1.27487275e+03  1.27487275e+03
  1.27487275e+03  1.93296050e+03  2.97678550e+03  2.97678550e+03
  2.97678550e+03  6.60575552e+03  6.60575552e+03  6.60575552e+03
  8.28905314e+03  2.46757943e+04  7.54709650e+04]
E1 = -727.4160335510217  E_coul = 201.47984912617477
cycle= 3 E= -525.936184424847  delta_E= -3.74e-05  |g|= 0.00497  |ddm|= 0.0107
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00971179
diis-c [-2.91647700e-07 -1.21959221e-03  1.32121583e-01  8.69098009e-01]
  HOMO = -0.582306837691163  LUMO = 0.766840137636771
  mo_energy =
[-1.18268651e+02 -1.22769686e+01 -9.55729202e+00 -9.55729202e+00
 -9.55729202e+00 -1.25605889e+00 -5.82306838e-01 -5.82306838e-01
 -5.82306838e-01  7.66840138e-01  7.66840138e-01  7.66840138e-01
  4.35569857e+00  4.35569857e+00  4.35569857e+00  9.49138291e+00
  2.04239599e+01  2.04239599e+01  2.04239599e+01  9.00025553e+01
  9.00025553e+01  9.00025553e+01  2.07229210e+02  4.21429862e+02
  4.21429862e+02  4.21429862e+02  1.27486435e+03  1.27486435e+03
  1.27486435e+03  1.93295157e+03  2.97677677e+03  2.97677677e+03
  2.97677677e+03  6.60574645e+03  6.60574645e+03  6.60574645e+03
  8.28904386e+03  2.46757849e+04  7.54709555e+04]
E1 = -727.4320259065793  E_coul = 201.49584048472587
cycle= 4 E= -525.936185421853  delta_E= -9.97e-07  |g|= 5e-05  |ddm|= 0.00138
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.17835e-05
diis-c [-1.92714520e-09  7.65799241e-06 -3.01469952e-03 -2.34463496e-02
  1.02645339e+00]
  HOMO = -0.582288560592414  LUMO = 0.766849513338245
  mo_energy =
[-1.18268608e+02 -1.22769085e+01 -9.55723955e+00 -9.55723955e+00
 -9.55723955e+00 -1.25603183e+00 -5.82288561e-01 -5.82288561e-01
 -5.82288561e-01  7.66849513e-01  7.66849513e-01  7.66849513e-01
  4.35573039e+00  4.35573039e+00  4.35573039e+00  9.49144078e+00
  2.04240077e+01  2.04240077e+01  2.04240077e+01  9.00026044e+01
  9.00026044e+01  9.00026044e+01  2.07229256e+02  4.21429905e+02
  4.21429905e+02  4.21429905e+02  1.27486438e+03  1.27486438e+03
  1.27486438e+03  1.93295160e+03  2.97677680e+03  2.97677680e+03
  2.97677680e+03  6.60574646e+03  6.60574646e+03  6.60574646e+03
  8.28904388e+03  2.46757849e+04  7.54709555e+04]
E1 = -727.4318890058695  E_coul = 201.4957035839029
cycle= 5 E= -525.936185421967  delta_E= -1.13e-10  |g|= 1.05e-05  |ddm|= 3.22e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4318890058695  E_coul = 201.4957035839029
  HOMO = -0.582293237969513  LUMO = 0.766847026501417
  mo_energy =
[-1.18268631e+02 -1.22769241e+01 -9.55725619e+00 -9.55725619e+00
 -9.55725619e+00 -1.25603742e+00 -5.82293238e-01 -5.82293238e-01
 -5.82293238e-01  7.66847027e-01  7.66847027e-01  7.66847027e-01
  4.35572210e+00  4.35572210e+00  4.35572210e+00  9.49142824e+00
  2.04239929e+01  2.04239929e+01  2.04239929e+01  9.00025847e+01
  9.00025847e+01  9.00025847e+01  2.07229234e+02  4.21429882e+02
  4.21429882e+02  4.21429882e+02  1.27486436e+03  1.27486436e+03
  1.27486436e+03  1.93295157e+03  2.97677678e+03  2.97677678e+03
  2.97677678e+03  6.60574644e+03  6.60574644e+03  6.60574644e+03
  8.28904385e+03  2.46757849e+04  7.54709554e+04]
E1 = -727.4319425157145  E_coul = 201.49575709374153
Extra cycle  E= -525.936185421973  delta_E= -6.37e-12  |g|= 3.13e-06  |ddm|= 4.64e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.23 sec
exp = [2.61825079e+04 7.61825002e+03 3.61824928e+03 1.61822750e+03
 2.39724768e+02 5.26578168e+01 7.07070538e+00 3.27063081e+00
 3.93857301e-01 1.36279296e+03 6.65180034e+02 3.03316910e+02
 3.16143169e+02 4.93263713e+01 5.20987635e+00 1.45610087e+01
 6.23599084e-01 1.67658571e+00 1.87987861e-01]
E = -525.9361854219729
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:39:39 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5079202        1
[INPUT] 0    0    [1    /1   ]  7618.25002387        1
[INPUT] 0    0    [1    /1   ]  3618.24927589        1
[INPUT] 0    0    [1    /1   ]  1618.22749817        1
[INPUT] 0    0    [1    /1   ]  239.724768466        1
[INPUT] 0    0    [1    /1   ]  52.6578168491        1
[INPUT] 0    0    [1    /1   ]  7.07070538134        1
[INPUT] 0    0    [1    /1   ]  3.27063081138        1
[INPUT] 0    0    [1    /1   ]  0.393857301199       1
[INPUT] 1    0    [1    /1   ]  1362.79295829        1
[INPUT] 1    0    [1    /1   ]  665.180033637        1
[INPUT] 1    0    [1    /1   ]  303.316909668        1
[INPUT] 1    0    [1    /1   ]  316.14316859         1
[INPUT] 1    0    [1    /1   ]  49.3263712528        1
[INPUT] 1    0    [1    /1   ]  5.2098763535         1
[INPUT] 1    0    [1    /1   ]  14.5610086979        1
[INPUT] 1    0    [1    /1   ]  0.623599083901       1
[INPUT] 1    0    [1    /1   ]  1.67658571398        1
[INPUT] 1    0    [1    /1   ]  0.18798786057        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.50792016568, 1.0]], [0, [7618.250023869011, 1.0]], [0, [3618.24927588684, 1.0]], [0, [1618.2274981693465, 1.0]], [0, [239.7247684660425, 1.0]], [0, [52.65781684906352, 1.0]], [0, [7.070705381337917, 1.0]], [0, [3.27063081137621, 1.0]], [0, [0.39385730119910667, 1.0]], [1, [1362.7929582923505, 1.0]], [1, [665.1800336368444, 1.0]], [1, [303.3169096682684, 1.0]], [1, [316.1431685900846, 1.0]], [1, [49.32637125279568, 1.0]], [1, [5.209876353495325, 1.0]], [1, [14.561008697926267, 1.0]], [1, [0.6235990839013968, 1.0]], [1, [1.6765857139815263, 1.0]], [1, [0.18798786056955386, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50792017]
bas 1, expnt(s) = [7618.25002387]
bas 2, expnt(s) = [3618.24927589]
bas 3, expnt(s) = [1618.22749817]
bas 4, expnt(s) = [239.72476847]
bas 5, expnt(s) = [52.65781685]
bas 6, expnt(s) = [7.07070538]
bas 7, expnt(s) = [3.27063081]
bas 8, expnt(s) = [0.3938573]
bas 9, expnt(s) = [1362.79295829]
bas 10, expnt(s) = [665.18003364]
bas 11, expnt(s) = [303.31690967]
bas 12, expnt(s) = [316.14316859]
bas 13, expnt(s) = [49.32637125]
bas 14, expnt(s) = [5.20987635]
bas 15, expnt(s) = [14.5610087]
bas 16, expnt(s) = [0.62359908]
bas 17, expnt(s) = [1.67658571]
bas 18, expnt(s) = [0.18798786]
CPU time:       100.34
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024083e+03 7.61825002e+03 2.06018604e+03
 3.61824928e+03 1.17866093e+03 1.61822750e+03 6.44606539e+02
 2.39724768e+02 1.53921648e+02 5.26578168e+01 4.93869449e+01
 7.07070538e+00 1.09549924e+01 3.27063081e+00 6.14452997e+00
 3.93857301e-01 1.25608549e+00 1.36279296e+03 2.41558177e+04
 6.65180034e+02 9.85504016e+03 3.03316910e+02 3.69279476e+03
 3.16143169e+02 3.88901076e+03 4.93263713e+01 3.81358431e+02
 5.20987635e+00 2.29624732e+01 1.45610087e+01 8.29800552e+01
 6.23599084e-01 1.61665082e+00 1.67658571e+00 5.56565900e+00
 1.87987861e-01 3.61115932e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.985696215305133
cond(S) = 84133.69355615962
E1 = -728.3395009827556  E_coul = 203.03552275892815
init E= -525.303978223827
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559624158462776  LUMO = 0.776558046901465
  mo_energy =
[-1.18006775e+02 -1.21794395e+01 -9.45276160e+00 -9.45276160e+00
 -9.45276160e+00 -1.22740585e+00 -5.59624158e-01 -5.59624158e-01
 -5.59624158e-01  7.76558047e-01  7.76558047e-01  7.76558047e-01
  4.40065862e+00  4.40065862e+00  4.40065862e+00  9.56334788e+00
  2.05184547e+01  2.05184547e+01  2.05184547e+01  9.01678065e+01
  9.01678065e+01  9.01678065e+01  2.07460019e+02  4.21691111e+02
  4.21691111e+02  4.21691111e+02  1.27519262e+03  1.27519262e+03
  1.27519262e+03  1.93343623e+03  2.97718613e+03  2.97718613e+03
  2.97718613e+03  6.60629366e+03  6.60629366e+03  6.60629366e+03
  8.28968764e+03  2.46765321e+04  7.54718007e+04]
E1 = -727.0547842856962  E_coul = 201.11923293464528
cycle= 1 E= -525.935551351051  delta_E= -0.632  |g|= 0.189  |ddm|= 0.491
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.502639
diis-c [-0.25264609  1.        ]
  HOMO = -0.588143963012569  LUMO = 0.763716897838377
  mo_energy =
[-1.18320015e+02 -1.23040518e+01 -9.58550291e+00 -9.58550291e+00
 -9.58550291e+00 -1.26354252e+00 -5.88143963e-01 -5.88143963e-01
 -5.88143963e-01  7.63716898e-01  7.63716898e-01  7.63716898e-01
  4.34426917e+00  4.34426917e+00  4.34426917e+00  9.46991377e+00
  2.03995193e+01  2.03995193e+01  2.03995193e+01  8.99631472e+01
  8.99631472e+01  8.99631472e+01  2.07180237e+02  4.21379016e+02
  4.21379016e+02  4.21379016e+02  1.27481027e+03  1.27481027e+03
  1.27481027e+03  1.93289539e+03  2.97672115e+03  2.97672115e+03
  2.97672115e+03  6.60568979e+03  6.60568979e+03  6.60568979e+03
  8.28898675e+03  2.46757276e+04  7.54708981e+04]
E1 = -727.5291314780261  E_coul = 201.5929844480297
cycle= 2 E= -525.936147029996  delta_E= -0.000596  |g|= 0.0333  |ddm|= 0.0362
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0609112
diis-c [-0.00206165  0.07502424  0.92497576]
  HOMO = -0.581220530368254  LUMO = 0.767419583205104
  mo_energy =
[-1.18260686e+02 -1.22725240e+01 -9.55259038e+00 -9.55259038e+00
 -9.55259038e+00 -1.25473767e+00 -5.81220530e-01 -5.81220530e-01
 -5.81220530e-01  7.67419583e-01  7.67419583e-01  7.67419583e-01
  4.35773304e+00  4.35773304e+00  4.35773304e+00  9.49485810e+00
  2.04280699e+01  2.04280699e+01  2.04280699e+01  9.00088292e+01
  9.00088292e+01  9.00088292e+01  2.07236788e+02  4.21437752e+02
  4.21437752e+02  4.21437752e+02  1.27487275e+03  1.27487275e+03
  1.27487275e+03  1.93296050e+03  2.97678550e+03  2.97678550e+03
  2.97678550e+03  6.60575552e+03  6.60575552e+03  6.60575552e+03
  8.28905314e+03  2.46757943e+04  7.54709650e+04]
E1 = -727.4160335510217  E_coul = 201.47984912617477
cycle= 3 E= -525.936184424847  delta_E= -3.74e-05  |g|= 0.00497  |ddm|= 0.0107
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00971179
diis-c [-2.91647700e-07 -1.21959221e-03  1.32121583e-01  8.69098009e-01]
  HOMO = -0.582306837691163  LUMO = 0.766840137636771
  mo_energy =
[-1.18268651e+02 -1.22769686e+01 -9.55729202e+00 -9.55729202e+00
 -9.55729202e+00 -1.25605889e+00 -5.82306838e-01 -5.82306838e-01
 -5.82306838e-01  7.66840138e-01  7.66840138e-01  7.66840138e-01
  4.35569857e+00  4.35569857e+00  4.35569857e+00  9.49138291e+00
  2.04239599e+01  2.04239599e+01  2.04239599e+01  9.00025553e+01
  9.00025553e+01  9.00025553e+01  2.07229210e+02  4.21429862e+02
  4.21429862e+02  4.21429862e+02  1.27486435e+03  1.27486435e+03
  1.27486435e+03  1.93295157e+03  2.97677677e+03  2.97677677e+03
  2.97677677e+03  6.60574645e+03  6.60574645e+03  6.60574645e+03
  8.28904386e+03  2.46757849e+04  7.54709555e+04]
E1 = -727.4320259065793  E_coul = 201.49584048472587
cycle= 4 E= -525.936185421853  delta_E= -9.97e-07  |g|= 5e-05  |ddm|= 0.00138
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.17835e-05
diis-c [-1.92714520e-09  7.65799241e-06 -3.01469952e-03 -2.34463496e-02
  1.02645339e+00]
  HOMO = -0.582288560592414  LUMO = 0.766849513338245
  mo_energy =
[-1.18268608e+02 -1.22769085e+01 -9.55723955e+00 -9.55723955e+00
 -9.55723955e+00 -1.25603183e+00 -5.82288561e-01 -5.82288561e-01
 -5.82288561e-01  7.66849513e-01  7.66849513e-01  7.66849513e-01
  4.35573039e+00  4.35573039e+00  4.35573039e+00  9.49144078e+00
  2.04240077e+01  2.04240077e+01  2.04240077e+01  9.00026044e+01
  9.00026044e+01  9.00026044e+01  2.07229256e+02  4.21429905e+02
  4.21429905e+02  4.21429905e+02  1.27486438e+03  1.27486438e+03
  1.27486438e+03  1.93295160e+03  2.97677680e+03  2.97677680e+03
  2.97677680e+03  6.60574646e+03  6.60574646e+03  6.60574646e+03
  8.28904388e+03  2.46757849e+04  7.54709555e+04]
E1 = -727.4318890058695  E_coul = 201.4957035839029
cycle= 5 E= -525.936185421967  delta_E= -1.13e-10  |g|= 1.05e-05  |ddm|= 3.22e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4318890058695  E_coul = 201.4957035839029
  HOMO = -0.582293237969513  LUMO = 0.766847026501417
  mo_energy =
[-1.18268631e+02 -1.22769241e+01 -9.55725619e+00 -9.55725619e+00
 -9.55725619e+00 -1.25603742e+00 -5.82293238e-01 -5.82293238e-01
 -5.82293238e-01  7.66847027e-01  7.66847027e-01  7.66847027e-01
  4.35572210e+00  4.35572210e+00  4.35572210e+00  9.49142824e+00
  2.04239929e+01  2.04239929e+01  2.04239929e+01  9.00025847e+01
  9.00025847e+01  9.00025847e+01  2.07229234e+02  4.21429882e+02
  4.21429882e+02  4.21429882e+02  1.27486436e+03  1.27486436e+03
  1.27486436e+03  1.93295157e+03  2.97677678e+03  2.97677678e+03
  2.97677678e+03  6.60574644e+03  6.60574644e+03  6.60574644e+03
  8.28904385e+03  2.46757849e+04  7.54709554e+04]
E1 = -727.4319425157145  E_coul = 201.49575709374153
Extra cycle  E= -525.936185421973  delta_E= -6.37e-12  |g|= 3.13e-06  |ddm|= 4.64e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 84133.69355615962
E1 = -727.4319425157145  E_coul = 201.49575709374153
init E= -525.936185421973
    CPU time for initialize scf      2.70 sec, wall time      0.24 sec
  HOMO = -0.582292242995721  LUMO = 0.766847553531073
  mo_energy =
[-1.18268625e+02 -1.22769202e+01 -9.55725214e+00 -9.55725214e+00
 -9.55725214e+00 -1.25603616e+00 -5.82292243e-01 -5.82292243e-01
 -5.82292243e-01  7.66847554e-01  7.66847554e-01  7.66847554e-01
  4.35572394e+00  4.35572394e+00  4.35572394e+00  9.49143143e+00
  2.04239964e+01  2.04239964e+01  2.04239964e+01  9.00025899e+01
  9.00025899e+01  9.00025899e+01  2.07229240e+02  4.21429888e+02
  4.21429888e+02  4.21429888e+02  1.27486437e+03  1.27486437e+03
  1.27486437e+03  1.93295158e+03  2.97677678e+03  2.97677678e+03
  2.97677678e+03  6.60574645e+03  6.60574645e+03  6.60574645e+03
  8.28904386e+03  2.46757849e+04  7.54709554e+04]
E1 = -727.4319291352592  E_coul = 201.4957437132852
cycle= 1 E= -525.936185421974  delta_E= -1.02e-12  |g|= 8.27e-07  |ddm|= 1.3e-06
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.4319291352592  E_coul = 201.4957437132852
  HOMO = -0.582292481308936  LUMO = 0.766847426597337
  mo_energy =
[-1.18268626e+02 -1.22769211e+01 -9.55725316e+00 -9.55725316e+00
 -9.55725316e+00 -1.25603645e+00 -5.82292481e-01 -5.82292481e-01
 -5.82292481e-01  7.66847427e-01  7.66847427e-01  7.66847427e-01
  4.35572350e+00  4.35572350e+00  4.35572350e+00  9.49143066e+00
  2.04239955e+01  2.04239955e+01  2.04239955e+01  9.00025886e+01
  9.00025886e+01  9.00025886e+01  2.07229238e+02  4.21429887e+02
  4.21429887e+02  4.21429887e+02  1.27486437e+03  1.27486437e+03
  1.27486437e+03  1.93295158e+03  2.97677678e+03  2.97677678e+03
  2.97677678e+03  6.60574644e+03  6.60574644e+03  6.60574644e+03
  8.28904386e+03  2.46757849e+04  7.54709554e+04]
E1 = -727.4319325423206  E_coul = 201.49574712034635
Extra cycle  E= -525.936185421974  delta_E= -3.41e-13  |g|= 2.16e-07  |ddm|= 3.07e-07
    CPU time for scf_cycle      2.82 sec, wall time      0.36 sec
exp = [2.61825079e+04 7.61825002e+03 3.61824928e+03 1.61822750e+03
 2.39724768e+02 5.26578168e+01 7.07070538e+00 3.27063081e+00
 3.93857301e-01 1.36279296e+03 6.65180034e+02 3.03316910e+02
 3.16143169e+02 4.93263713e+01 5.20987635e+00 1.45610087e+01
 6.23599084e-01 1.67658571e+00 1.87987861e-01]
grad_E = [-1.97827838e-06  2.15543357e-05  4.28516308e-05  6.60136968e-04
  1.61364167e-03 -3.54791244e-02 -3.26313950e-02  2.44242244e-02
 -3.76199576e-02  6.39654621e-07  1.47819316e-05  7.57926555e-05
  6.68495707e-05  4.27926289e-03  5.90953442e-02 -3.44770035e-02
  3.26010239e-02 -4.34136380e-02 -1.23269681e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:39:43 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5079388        1
[INPUT] 0    0    [1    /1   ]  7618.24982294        1
[INPUT] 0    0    [1    /1   ]  3618.24887812        1
[INPUT] 0    0    [1    /1   ]  1618.22135522        1
[INPUT] 0    0    [1    /1   ]  239.706217879        1
[INPUT] 0    0    [1    /1   ]  52.9505971041        1
[INPUT] 0    0    [1    /1   ]  7.60511705551        1
[INPUT] 0    0    [1    /1   ]  3.42908664445        1
[INPUT] 0    0    [1    /1   ]  0.400477709354       1
[INPUT] 1    0    [1    /1   ]  1362.7929478         1
[INPUT] 1    0    [1    /1   ]  665.179860908        1
[INPUT] 1    0    [1    /1   ]  303.315986709        1
[INPUT] 1    0    [1    /1   ]  316.142355459        1
[INPUT] 1    0    [1    /1   ]  49.3230307026        1
[INPUT] 1    0    [1    /1   ]  5.32948799191        1
[INPUT] 1    0    [1    /1   ]  14.5771760236        1
[INPUT] 1    0    [1    /1   ]  0.611278936701       1
[INPUT] 1    0    [1    /1   ]  1.76897199896        1
[INPUT] 1    0    [1    /1   ]  0.190210689425       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.507938754872, 1.0]], [0, [7618.249822939419, 1.0]], [0, [3618.248878123328, 1.0]], [0, [1618.2213552225498, 1.0]], [0, [239.70621787909894, 1.0]], [0, [52.95059710410263, 1.0]], [0, [7.605117055512388, 1.0]], [0, [3.429086644453307, 1.0]], [0, [0.4004777093535049, 1.0]], [1, [1362.7929477989467, 1.0]], [1, [665.1798609084054, 1.0]], [1, [303.3159867085277, 1.0]], [1, [316.14235545859304, 1.0]], [1, [49.32303070255686, 1.0]], [1, [5.329487991907061, 1.0]], [1, [14.57717602355684, 1.0]], [1, [0.6112789367010358, 1.0]], [1, [1.7689719989627366, 1.0]], [1, [0.1902106894246877, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50793875]
bas 1, expnt(s) = [7618.24982294]
bas 2, expnt(s) = [3618.24887812]
bas 3, expnt(s) = [1618.22135522]
bas 4, expnt(s) = [239.70621788]
bas 5, expnt(s) = [52.9505971]
bas 6, expnt(s) = [7.60511706]
bas 7, expnt(s) = [3.42908664]
bas 8, expnt(s) = [0.40047771]
bas 9, expnt(s) = [1362.7929478]
bas 10, expnt(s) = [665.17986091]
bas 11, expnt(s) = [303.31598671]
bas 12, expnt(s) = [316.14235546]
bas 13, expnt(s) = [49.3230307]
bas 14, expnt(s) = [5.32948799]
bas 15, expnt(s) = [14.57717602]
bas 16, expnt(s) = [0.61127894]
bas 17, expnt(s) = [1.768972]
bas 18, expnt(s) = [0.19021069]
CPU time:       108.32
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024083e+03 7.61824982e+03 2.06018600e+03
 3.61824888e+03 1.17866083e+03 1.61822136e+03 6.44604704e+02
 2.39706218e+02 1.53912715e+02 5.29505971e+01 4.95927476e+01
 7.60511706e+00 1.15702955e+01 3.42908664e+00 6.36647251e+00
 4.00477709e-01 1.27188775e+00 1.36279295e+03 2.41558175e+04
 6.65179861e+02 9.85503696e+03 3.03315987e+02 3.69278071e+03
 3.16142355e+02 3.88899826e+03 4.93230307e+01 3.81326147e+02
 5.32948799e+00 2.36233374e+01 1.45771760e+01 8.30952388e+01
 6.11278937e-01 1.57682567e+00 1.76897200e+00 5.95162543e+00
 1.90210689e-01 3.66461236e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.984919189657077
cond(S) = 84284.04713963026
E1 = -728.4256432236514  E_coul = 203.08981329314702
init E= -525.335829930504
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.55778417779748  LUMO = 0.777767669451093
  mo_energy =
[-1.18013577e+02 -1.21746388e+01 -9.44828654e+00 -9.44828654e+00
 -9.44828654e+00 -1.22616078e+00 -5.57784178e-01 -5.57784178e-01
 -5.57784178e-01  7.77767669e-01  7.77767669e-01  7.77767669e-01
  4.52666070e+00  4.52666070e+00  4.52666070e+00  1.07073266e+01
  2.10938326e+01  2.10938326e+01  2.10938326e+01  9.09030347e+01
  9.09030347e+01  9.09030347e+01  2.11127892e+02  4.22259632e+02
  4.22259632e+02  4.22259632e+02  1.27568060e+03  1.27568060e+03
  1.27568060e+03  1.93664717e+03  2.97763297e+03  2.97763297e+03
  2.97763297e+03  6.60669805e+03  6.60669805e+03  6.60669805e+03
  8.29255140e+03  2.46792251e+04  7.54743000e+04]
E1 = -727.2400767886095  E_coul = 201.28648888305108
cycle= 1 E= -525.953587905558  delta_E= -0.618  |g|= 0.185  |ddm|= 0.635
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.497449
diis-c [-0.24745518  1.        ]
  HOMO = -0.582960475449528  LUMO = 0.767007873861697
  mo_energy =
[-1.18314163e+02 -1.22924361e+01 -9.57293090e+00 -9.57293090e+00
 -9.57293090e+00 -1.25961540e+00 -5.82960475e-01 -5.82960475e-01
 -5.82960475e-01  7.67007874e-01  7.67007874e-01  7.67007874e-01
  4.47326662e+00  4.47326662e+00  4.47326662e+00  1.06140937e+01
  2.09813344e+01  2.09813344e+01  2.09813344e+01  9.07087628e+01
  9.07087628e+01  9.07087628e+01  2.10858410e+02  4.21959574e+02
  4.21959574e+02  4.21959574e+02  1.27531102e+03  1.27531102e+03
  1.27531102e+03  1.93612036e+03  2.97718156e+03  2.97718156e+03
  2.97718156e+03  6.60610821e+03  6.60610821e+03  6.60610821e+03
  8.29186484e+03  2.46784350e+04  7.54734118e+04]
E1 = -727.6811991536722  E_coul = 201.72709465546373
cycle= 2 E= -525.954104498208  delta_E= -0.000517  |g|= 0.0313  |ddm|= 0.0352
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0582059
diis-c [-0.00196596  0.07072493  0.92927507]
  HOMO = -0.576511512591474  LUMO = 0.77046649511258
  mo_energy =
[-1.18258334e+02 -1.22630848e+01 -9.54225346e+00 -9.54225346e+00
 -9.54225346e+00 -1.25139508e+00 -5.76511513e-01 -5.76511513e-01
 -5.76511513e-01  7.70466495e-01  7.70466495e-01  7.70466495e-01
  4.48614641e+00  4.48614641e+00  4.48614641e+00  1.06382813e+01
  2.10081157e+01  2.10081157e+01  2.10081157e+01  9.07515502e+01
  9.07515502e+01  9.07515502e+01  2.10911586e+02  4.22014829e+02
  4.22014829e+02  4.22014829e+02  1.27536989e+03  1.27536989e+03
  1.27536989e+03  1.93618181e+03  2.97724226e+03  2.97724226e+03
  2.97724226e+03  6.60617026e+03  6.60617026e+03  6.60617026e+03
  8.29192756e+03  2.46784981e+04  7.54734751e+04]
E1 = -727.5777865481737  E_coul = 201.6236503395894
cycle= 3 E= -525.954136208584  delta_E= -3.17e-05  |g|= 0.00473  |ddm|= 0.00948
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00930181
diis-c [-1.86783779e-07 -1.15177891e-03  1.32719957e-01  8.68431822e-01]
  HOMO = -0.577494996679082  LUMO = 0.76994389002773
  mo_energy =
[-1.18265891e+02 -1.22672492e+01 -9.54664913e+00 -9.54664913e+00
 -9.54664913e+00 -1.25261249e+00 -5.77494997e-01 -5.77494997e-01
 -5.77494997e-01  7.69943890e-01  7.69943890e-01  7.69943890e-01
  4.48422811e+00  4.48422811e+00  4.48422811e+00  1.06348866e+01
  2.10042569e+01  2.10042569e+01  2.10042569e+01  9.07456333e+01
  9.07456333e+01  9.07456333e+01  2.10904397e+02  4.22007345e+02
  4.22007345e+02  4.22007345e+02  1.27536191e+03  1.27536191e+03
  1.27536191e+03  1.93617334e+03  2.97723396e+03  2.97723396e+03
  2.97723396e+03  6.60616165e+03  6.60616165e+03  6.60616165e+03
  8.29191876e+03  2.46784891e+04  7.54734660e+04]
E1 = -727.5924876526625  E_coul = 201.6383505909581
cycle= 4 E= -525.954137061704  delta_E= -8.53e-07  |g|= 3.73e-05  |ddm|= 0.00128
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.67734e-05
diis-c [-1.37488860e-09  3.08514561e-06 -2.06532938e-03 -1.59638377e-02
  1.01802608e+00]
  HOMO = -0.577476985494159  LUMO = 0.769953377226596
  mo_energy =
[-1.18265850e+02 -1.22671960e+01 -9.54660118e+00 -9.54660118e+00
 -9.54660118e+00 -1.25258744e+00 -5.77476985e-01 -5.77476985e-01
 -5.77476985e-01  7.69953377e-01  7.69953377e-01  7.69953377e-01
  4.48425906e+00  4.48425906e+00  4.48425906e+00  1.06349378e+01
  2.10043010e+01  2.10043010e+01  2.10043010e+01  9.07456787e+01
  9.07456787e+01  9.07456787e+01  2.10904440e+02  4.22007386e+02
  4.22007386e+02  4.22007386e+02  1.27536194e+03  1.27536194e+03
  1.27536194e+03  1.93617336e+03  2.97723399e+03  2.97723399e+03
  2.97723399e+03  6.60616167e+03  6.60616167e+03  6.60616167e+03
  8.29191878e+03  2.46784891e+04  7.54734660e+04]
E1 = -727.5923693570063  E_coul = 201.6382322952397
cycle= 5 E= -525.954137061767  delta_E= -6.22e-11  |g|= 8.27e-06  |ddm|= 2.15e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5923693570063  E_coul = 201.6382322952397
  HOMO = -0.577480518057926  LUMO = 0.769951514948161
  mo_energy =
[-1.18265868e+02 -1.22672082e+01 -9.54661421e+00 -9.54661421e+00
 -9.54661421e+00 -1.25259173e+00 -5.77480518e-01 -5.77480518e-01
 -5.77480518e-01  7.69951515e-01  7.69951515e-01  7.69951515e-01
  4.48425256e+00  4.48425256e+00  4.48425256e+00  1.06349276e+01
  2.10042894e+01  2.10042894e+01  2.10042894e+01  9.07456632e+01
  9.07456632e+01  9.07456632e+01  2.10904423e+02  4.22007368e+02
  4.22007368e+02  4.22007368e+02  1.27536192e+03  1.27536192e+03
  1.27536192e+03  1.93617334e+03  2.97723398e+03  2.97723398e+03
  2.97723398e+03  6.60616165e+03  6.60616165e+03  6.60616165e+03
  8.29191876e+03  2.46784891e+04  7.54734660e+04]
E1 = -727.5924104327663  E_coul = 201.63827337099585
Extra cycle  E= -525.95413706177  delta_E= -3.87e-12  |g|= 2.43e-06  |ddm|= 3.68e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.23 sec
exp = [2.61825079e+04 7.61824982e+03 3.61824888e+03 1.61822136e+03
 2.39706218e+02 5.29505971e+01 7.60511706e+00 3.42908664e+00
 4.00477709e-01 1.36279295e+03 6.65179861e+02 3.03315987e+02
 3.16142355e+02 4.93230307e+01 5.32948799e+00 1.45771760e+01
 6.11278937e-01 1.76897200e+00 1.90210689e-01]
E = -525.9541370617704
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:39:43 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5079388        1
[INPUT] 0    0    [1    /1   ]  7618.24982294        1
[INPUT] 0    0    [1    /1   ]  3618.24887812        1
[INPUT] 0    0    [1    /1   ]  1618.22135522        1
[INPUT] 0    0    [1    /1   ]  239.706217879        1
[INPUT] 0    0    [1    /1   ]  52.9505971041        1
[INPUT] 0    0    [1    /1   ]  7.60511705551        1
[INPUT] 0    0    [1    /1   ]  3.42908664445        1
[INPUT] 0    0    [1    /1   ]  0.400477709354       1
[INPUT] 1    0    [1    /1   ]  1362.7929478         1
[INPUT] 1    0    [1    /1   ]  665.179860908        1
[INPUT] 1    0    [1    /1   ]  303.315986709        1
[INPUT] 1    0    [1    /1   ]  316.142355459        1
[INPUT] 1    0    [1    /1   ]  49.3230307026        1
[INPUT] 1    0    [1    /1   ]  5.32948799191        1
[INPUT] 1    0    [1    /1   ]  14.5771760236        1
[INPUT] 1    0    [1    /1   ]  0.611278936701       1
[INPUT] 1    0    [1    /1   ]  1.76897199896        1
[INPUT] 1    0    [1    /1   ]  0.190210689425       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.507938754872, 1.0]], [0, [7618.249822939419, 1.0]], [0, [3618.248878123328, 1.0]], [0, [1618.2213552225498, 1.0]], [0, [239.70621787909894, 1.0]], [0, [52.95059710410263, 1.0]], [0, [7.605117055512388, 1.0]], [0, [3.429086644453307, 1.0]], [0, [0.4004777093535049, 1.0]], [1, [1362.7929477989467, 1.0]], [1, [665.1798609084054, 1.0]], [1, [303.3159867085277, 1.0]], [1, [316.14235545859304, 1.0]], [1, [49.32303070255686, 1.0]], [1, [5.329487991907061, 1.0]], [1, [14.57717602355684, 1.0]], [1, [0.6112789367010358, 1.0]], [1, [1.7689719989627366, 1.0]], [1, [0.1902106894246877, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50793875]
bas 1, expnt(s) = [7618.24982294]
bas 2, expnt(s) = [3618.24887812]
bas 3, expnt(s) = [1618.22135522]
bas 4, expnt(s) = [239.70621788]
bas 5, expnt(s) = [52.9505971]
bas 6, expnt(s) = [7.60511706]
bas 7, expnt(s) = [3.42908664]
bas 8, expnt(s) = [0.40047771]
bas 9, expnt(s) = [1362.7929478]
bas 10, expnt(s) = [665.17986091]
bas 11, expnt(s) = [303.31598671]
bas 12, expnt(s) = [316.14235546]
bas 13, expnt(s) = [49.3230307]
bas 14, expnt(s) = [5.32948799]
bas 15, expnt(s) = [14.57717602]
bas 16, expnt(s) = [0.61127894]
bas 17, expnt(s) = [1.768972]
bas 18, expnt(s) = [0.19021069]
CPU time:       109.00
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825079e+04 5.20024083e+03 7.61824982e+03 2.06018600e+03
 3.61824888e+03 1.17866083e+03 1.61822136e+03 6.44604704e+02
 2.39706218e+02 1.53912715e+02 5.29505971e+01 4.95927476e+01
 7.60511706e+00 1.15702955e+01 3.42908664e+00 6.36647251e+00
 4.00477709e-01 1.27188775e+00 1.36279295e+03 2.41558175e+04
 6.65179861e+02 9.85503696e+03 3.03315987e+02 3.69278071e+03
 3.16142355e+02 3.88899826e+03 4.93230307e+01 3.81326147e+02
 5.32948799e+00 2.36233374e+01 1.45771760e+01 8.30952388e+01
 6.11278937e-01 1.57682567e+00 1.76897200e+00 5.95162543e+00
 1.90210689e-01 3.66461236e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.984919189657077
cond(S) = 84284.04713963026
E1 = -728.4256432236514  E_coul = 203.08981329314702
init E= -525.335829930504
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.55778417779748  LUMO = 0.777767669451093
  mo_energy =
[-1.18013577e+02 -1.21746388e+01 -9.44828654e+00 -9.44828654e+00
 -9.44828654e+00 -1.22616078e+00 -5.57784178e-01 -5.57784178e-01
 -5.57784178e-01  7.77767669e-01  7.77767669e-01  7.77767669e-01
  4.52666070e+00  4.52666070e+00  4.52666070e+00  1.07073266e+01
  2.10938326e+01  2.10938326e+01  2.10938326e+01  9.09030347e+01
  9.09030347e+01  9.09030347e+01  2.11127892e+02  4.22259632e+02
  4.22259632e+02  4.22259632e+02  1.27568060e+03  1.27568060e+03
  1.27568060e+03  1.93664717e+03  2.97763297e+03  2.97763297e+03
  2.97763297e+03  6.60669805e+03  6.60669805e+03  6.60669805e+03
  8.29255140e+03  2.46792251e+04  7.54743000e+04]
E1 = -727.2400767886095  E_coul = 201.28648888305108
cycle= 1 E= -525.953587905558  delta_E= -0.618  |g|= 0.185  |ddm|= 0.635
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.497449
diis-c [-0.24745518  1.        ]
  HOMO = -0.582960475449528  LUMO = 0.767007873861697
  mo_energy =
[-1.18314163e+02 -1.22924361e+01 -9.57293090e+00 -9.57293090e+00
 -9.57293090e+00 -1.25961540e+00 -5.82960475e-01 -5.82960475e-01
 -5.82960475e-01  7.67007874e-01  7.67007874e-01  7.67007874e-01
  4.47326662e+00  4.47326662e+00  4.47326662e+00  1.06140937e+01
  2.09813344e+01  2.09813344e+01  2.09813344e+01  9.07087628e+01
  9.07087628e+01  9.07087628e+01  2.10858410e+02  4.21959574e+02
  4.21959574e+02  4.21959574e+02  1.27531102e+03  1.27531102e+03
  1.27531102e+03  1.93612036e+03  2.97718156e+03  2.97718156e+03
  2.97718156e+03  6.60610821e+03  6.60610821e+03  6.60610821e+03
  8.29186484e+03  2.46784350e+04  7.54734118e+04]
E1 = -727.6811991536722  E_coul = 201.72709465546373
cycle= 2 E= -525.954104498208  delta_E= -0.000517  |g|= 0.0313  |ddm|= 0.0352
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0582059
diis-c [-0.00196596  0.07072493  0.92927507]
  HOMO = -0.576511512591474  LUMO = 0.77046649511258
  mo_energy =
[-1.18258334e+02 -1.22630848e+01 -9.54225346e+00 -9.54225346e+00
 -9.54225346e+00 -1.25139508e+00 -5.76511513e-01 -5.76511513e-01
 -5.76511513e-01  7.70466495e-01  7.70466495e-01  7.70466495e-01
  4.48614641e+00  4.48614641e+00  4.48614641e+00  1.06382813e+01
  2.10081157e+01  2.10081157e+01  2.10081157e+01  9.07515502e+01
  9.07515502e+01  9.07515502e+01  2.10911586e+02  4.22014829e+02
  4.22014829e+02  4.22014829e+02  1.27536989e+03  1.27536989e+03
  1.27536989e+03  1.93618181e+03  2.97724226e+03  2.97724226e+03
  2.97724226e+03  6.60617026e+03  6.60617026e+03  6.60617026e+03
  8.29192756e+03  2.46784981e+04  7.54734751e+04]
E1 = -727.5777865481737  E_coul = 201.6236503395894
cycle= 3 E= -525.954136208584  delta_E= -3.17e-05  |g|= 0.00473  |ddm|= 0.00948
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00930181
diis-c [-1.86783779e-07 -1.15177891e-03  1.32719957e-01  8.68431822e-01]
  HOMO = -0.577494996679082  LUMO = 0.76994389002773
  mo_energy =
[-1.18265891e+02 -1.22672492e+01 -9.54664913e+00 -9.54664913e+00
 -9.54664913e+00 -1.25261249e+00 -5.77494997e-01 -5.77494997e-01
 -5.77494997e-01  7.69943890e-01  7.69943890e-01  7.69943890e-01
  4.48422811e+00  4.48422811e+00  4.48422811e+00  1.06348866e+01
  2.10042569e+01  2.10042569e+01  2.10042569e+01  9.07456333e+01
  9.07456333e+01  9.07456333e+01  2.10904397e+02  4.22007345e+02
  4.22007345e+02  4.22007345e+02  1.27536191e+03  1.27536191e+03
  1.27536191e+03  1.93617334e+03  2.97723396e+03  2.97723396e+03
  2.97723396e+03  6.60616165e+03  6.60616165e+03  6.60616165e+03
  8.29191876e+03  2.46784891e+04  7.54734660e+04]
E1 = -727.5924876526625  E_coul = 201.6383505909581
cycle= 4 E= -525.954137061704  delta_E= -8.53e-07  |g|= 3.73e-05  |ddm|= 0.00128
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.67734e-05
diis-c [-1.37488860e-09  3.08514561e-06 -2.06532938e-03 -1.59638377e-02
  1.01802608e+00]
  HOMO = -0.577476985494159  LUMO = 0.769953377226596
  mo_energy =
[-1.18265850e+02 -1.22671960e+01 -9.54660118e+00 -9.54660118e+00
 -9.54660118e+00 -1.25258744e+00 -5.77476985e-01 -5.77476985e-01
 -5.77476985e-01  7.69953377e-01  7.69953377e-01  7.69953377e-01
  4.48425906e+00  4.48425906e+00  4.48425906e+00  1.06349378e+01
  2.10043010e+01  2.10043010e+01  2.10043010e+01  9.07456787e+01
  9.07456787e+01  9.07456787e+01  2.10904440e+02  4.22007386e+02
  4.22007386e+02  4.22007386e+02  1.27536194e+03  1.27536194e+03
  1.27536194e+03  1.93617336e+03  2.97723399e+03  2.97723399e+03
  2.97723399e+03  6.60616167e+03  6.60616167e+03  6.60616167e+03
  8.29191878e+03  2.46784891e+04  7.54734660e+04]
E1 = -727.5923693570063  E_coul = 201.6382322952397
cycle= 5 E= -525.954137061767  delta_E= -6.22e-11  |g|= 8.27e-06  |ddm|= 2.15e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.5923693570063  E_coul = 201.6382322952397
  HOMO = -0.577480518057926  LUMO = 0.769951514948161
  mo_energy =
[-1.18265868e+02 -1.22672082e+01 -9.54661421e+00 -9.54661421e+00
 -9.54661421e+00 -1.25259173e+00 -5.77480518e-01 -5.77480518e-01
 -5.77480518e-01  7.69951515e-01  7.69951515e-01  7.69951515e-01
  4.48425256e+00  4.48425256e+00  4.48425256e+00  1.06349276e+01
  2.10042894e+01  2.10042894e+01  2.10042894e+01  9.07456632e+01
  9.07456632e+01  9.07456632e+01  2.10904423e+02  4.22007368e+02
  4.22007368e+02  4.22007368e+02  1.27536192e+03  1.27536192e+03
  1.27536192e+03  1.93617334e+03  2.97723398e+03  2.97723398e+03
  2.97723398e+03  6.60616165e+03  6.60616165e+03  6.60616165e+03
  8.29191876e+03  2.46784891e+04  7.54734660e+04]
E1 = -727.5924104327663  E_coul = 201.63827337099585
Extra cycle  E= -525.95413706177  delta_E= -3.87e-12  |g|= 2.43e-06  |ddm|= 3.68e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.24 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 84284.04713963026
E1 = -727.5924104327663  E_coul = 201.63827337099585
init E= -525.95413706177
    CPU time for initialize scf      3.50 sec, wall time      0.29 sec
  HOMO = -0.57747975942491  LUMO = 0.769951917340525
  mo_energy =
[-1.18265863e+02 -1.22672052e+01 -9.54661111e+00 -9.54661111e+00
 -9.54661111e+00 -1.25259076e+00 -5.77479759e-01 -5.77479759e-01
 -5.77479759e-01  7.69951917e-01  7.69951917e-01  7.69951917e-01
  4.48425400e+00  4.48425400e+00  4.48425400e+00  1.06349302e+01
  2.10042921e+01  2.10042921e+01  2.10042921e+01  9.07456672e+01
  9.07456672e+01  9.07456672e+01  2.10904427e+02  4.22007373e+02
  4.22007373e+02  4.22007373e+02  1.27536193e+03  1.27536193e+03
  1.27536193e+03  1.93617335e+03  2.97723398e+03  2.97723398e+03
  2.97723398e+03  6.60616166e+03  6.60616166e+03  6.60616166e+03
  8.29191876e+03  2.46784891e+04  7.54734660e+04]
E1 = -727.5924004261791  E_coul = 201.63826336440872
cycle= 1 E= -525.95413706177  delta_E= 1.14e-13  |g|= 6.29e-07  |ddm|= 9.55e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.5924004261791  E_coul = 201.63826336440872
  HOMO = -0.577479934179492  LUMO = 0.769951824436062
  mo_energy =
[-1.18265865e+02 -1.22672059e+01 -9.54661186e+00 -9.54661186e+00
 -9.54661186e+00 -1.25259098e+00 -5.77479934e-01 -5.77479934e-01
 -5.77479934e-01  7.69951824e-01  7.69951824e-01  7.69951824e-01
  4.48425366e+00  4.48425366e+00  4.48425366e+00  1.06349296e+01
  2.10042914e+01  2.10042914e+01  2.10042914e+01  9.07456662e+01
  9.07456662e+01  9.07456662e+01  2.10904426e+02  4.22007372e+02
  4.22007372e+02  4.22007372e+02  1.27536193e+03  1.27536193e+03
  1.27536193e+03  1.93617335e+03  2.97723398e+03  2.97723398e+03
  2.97723398e+03  6.60616166e+03  6.60616166e+03  6.60616166e+03
  8.29191876e+03  2.46784891e+04  7.54734660e+04]
E1 = -727.5924029243812  E_coul = 201.63826586261115
Extra cycle  E= -525.95413706177  delta_E= 2.27e-13  |g|= 1.61e-07  |ddm|= 2.24e-07
    CPU time for scf_cycle      3.63 sec, wall time      0.42 sec
exp = [2.61825079e+04 7.61824982e+03 3.61824888e+03 1.61822136e+03
 2.39706218e+02 5.29505971e+01 7.60511706e+00 3.42908664e+00
 4.00477709e-01 1.36279295e+03 6.65179861e+02 3.03315987e+02
 3.16142355e+02 4.93230307e+01 5.32948799e+00 1.45771760e+01
 6.11278937e-01 1.76897200e+00 1.90210689e-01]
grad_E = [-1.97836259e-06  2.17778669e-05  4.35400833e-05  6.68522142e-04
  1.04342202e-03 -3.38139064e-02 -2.48523711e-02  2.78702483e-02
  4.70268765e-02  5.62275333e-07  1.41643512e-05  7.19184191e-05
  6.34605233e-05  5.06299211e-03  7.18842929e-02 -4.02842218e-02
 -5.06723178e-02 -4.24936207e-02  4.32509196e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:39:48 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5079797        1
[INPUT] 0    0    [1    /1   ]  7618.24937971        1
[INPUT] 0    0    [1    /1   ]  3618.24799991        1
[INPUT] 0    0    [1    /1   ]  1618.20779958        1
[INPUT] 0    0    [1    /1   ]  239.66695222         1
[INPUT] 0    0    [1    /1   ]  53.6053567225        1
[INPUT] 0    0    [1    /1   ]  8.73185825782        1
[INPUT] 0    0    [1    /1   ]  3.66310185294        1
[INPUT] 0    0    [1    /1   ]  0.403308985728       1
[INPUT] 1    0    [1    /1   ]  1362.79292556        1
[INPUT] 1    0    [1    /1   ]  665.179487098        1
[INPUT] 1    0    [1    /1   ]  303.313995184        1
[INPUT] 1    0    [1    /1   ]  316.140600756        1
[INPUT] 1    0    [1    /1   ]  49.3083207615        1
[INPUT] 1    0    [1    /1   ]  5.48791128855        1
[INPUT] 1    0    [1    /1   ]  14.6697734033        1
[INPUT] 1    0    [1    /1   ]  0.591900197573       1
[INPUT] 1    0    [1    /1   ]  2.00989001058        1
[INPUT] 1    0    [1    /1   ]  0.187310662884       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.50797969428, 1.0]], [0, [7618.249379707393, 1.0]], [0, [3618.247999911238, 1.0]], [0, [1618.207799580187, 1.0]], [0, [239.6669522197848, 1.0]], [0, [53.60535672250968, 1.0]], [0, [8.731858257815508, 1.0]], [0, [3.663101852942716, 1.0]], [0, [0.4033089857284034, 1.0]], [1, [1362.7929255550646, 1.0]], [1, [665.1794870982393, 1.0]], [1, [303.3139951837697, 1.0]], [1, [316.1406007563609, 1.0]], [1, [49.3083207614815, 1.0]], [1, [5.487911288554125, 1.0]], [1, [14.669773403312103, 1.0]], [1, [0.5919001975727406, 1.0]], [1, [2.009890010582952, 1.0]], [1, [0.18731066288420256, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50797969]
bas 1, expnt(s) = [7618.24937971]
bas 2, expnt(s) = [3618.24799991]
bas 3, expnt(s) = [1618.20779958]
bas 4, expnt(s) = [239.66695222]
bas 5, expnt(s) = [53.60535672]
bas 6, expnt(s) = [8.73185826]
bas 7, expnt(s) = [3.66310185]
bas 8, expnt(s) = [0.40330899]
bas 9, expnt(s) = [1362.79292556]
bas 10, expnt(s) = [665.1794871]
bas 11, expnt(s) = [303.31399518]
bas 12, expnt(s) = [316.14060076]
bas 13, expnt(s) = [49.30832076]
bas 14, expnt(s) = [5.48791129]
bas 15, expnt(s) = [14.6697734]
bas 16, expnt(s) = [0.5919002]
bas 17, expnt(s) = [2.00989001]
bas 18, expnt(s) = [0.18731066]
CPU time:       117.89
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825080e+04 5.20024084e+03 7.61824938e+03 2.06018591e+03
 3.61824800e+03 1.17866062e+03 1.61820780e+03 6.44600654e+02
 2.39666952e+02 1.53893806e+02 5.36053567e+01 5.00519690e+01
 8.73185826e+00 1.28334976e+01 3.66310185e+00 6.68962495e+00
 4.03308986e-01 1.27862575e+00 1.36279293e+03 2.41558170e+04
 6.65179487e+02 9.85503004e+03 3.03313995e+02 3.69275040e+03
 3.16140601e+02 3.88897127e+03 4.93083208e+01 3.81183996e+02
 5.48791129e+00 2.45043533e+01 1.46697734e+01 8.37555605e+01
 5.91900198e-01 1.51458970e+00 2.00989001e+00 6.98151631e+00
 1.87310663e-01 3.59490583e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.984176180651655
cond(S) = 84613.85398267704
E1 = -728.479801823055  E_coul = 203.10703362952276
init E= -525.372768193532
    CPU time for initialize scf      0.45 sec, wall time      0.05 sec
  HOMO = -0.556603640118731  LUMO = 0.755442241525656
  mo_energy =
[-1.18031376e+02 -1.21702630e+01 -9.44766742e+00 -9.44766742e+00
 -9.44766742e+00 -1.22653046e+00 -5.56603640e-01 -5.56603640e-01
 -5.56603640e-01  7.55442242e-01  7.55442242e-01  7.55442242e-01
  4.82920243e+00  4.82920243e+00  4.82920243e+00  1.29147627e+01
  2.22869541e+01  2.22869541e+01  2.22869541e+01  9.24422688e+01
  9.24422688e+01  9.24422688e+01  2.18483535e+02  4.23478162e+02
  4.23478162e+02  4.23478162e+02  1.27672690e+03  1.27672690e+03
  1.27672690e+03  1.94326827e+03  2.97859043e+03  2.97859043e+03
  2.97859043e+03  6.60756379e+03  6.60756379e+03  6.60756379e+03
  8.29847021e+03  2.46847923e+04  7.54794666e+04]
E1 = -727.2969863025066  E_coul = 201.3094559394972
cycle= 1 E= -525.987530363009  delta_E= -0.615  |g|= 0.187  |ddm|= 0.801
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.505415
diis-c [-0.25544479  1.        ]
  HOMO = -0.579961814406693  LUMO = 0.746220661823116
  mo_energy =
[-1.18331103e+02 -1.22899247e+01 -9.57318173e+00 -9.57318173e+00
 -9.57318173e+00 -1.25891233e+00 -5.79961814e-01 -5.79961814e-01
 -5.79961814e-01  7.46220662e-01  7.46220662e-01  7.46220662e-01
  4.77336422e+00  4.77336422e+00  4.77336422e+00  1.28123576e+01
  2.21727506e+01  2.21727506e+01  2.21727506e+01  9.22478801e+01
  9.22478801e+01  9.22478801e+01  2.18211586e+02  4.23178324e+02
  4.23178324e+02  4.23178324e+02  1.27635846e+03  1.27635846e+03
  1.27635846e+03  1.94274453e+03  2.97814138e+03  2.97814138e+03
  2.97814138e+03  6.60697673e+03  6.60697673e+03  6.60697673e+03
  8.29778679e+03  2.46840052e+04  7.54785814e+04]
E1 = -727.733925625492  E_coul = 201.74588457333462
cycle= 2 E= -525.988041052157  delta_E= -0.000511  |g|= 0.031  |ddm|= 0.0378
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0592628
diis-c [-0.00204936  0.07061194  0.92938806]
  HOMO = -0.573471961237934  LUMO = 0.749664408218309
  mo_energy =
[-1.18275795e+02 -1.22609394e+01 -9.54290784e+00 -9.54290784e+00
 -9.54290784e+00 -1.25063443e+00 -5.73471961e-01 -5.73471961e-01
 -5.73471961e-01  7.49664408e-01  7.49664408e-01  7.49664408e-01
  4.78704941e+00  4.78704941e+00  4.78704941e+00  1.28380542e+01
  2.21995202e+01  2.21995202e+01  2.21995202e+01  9.22901407e+01
  9.22901407e+01  9.22901407e+01  2.18264261e+02  4.23233040e+02
  4.23233040e+02  4.23233040e+02  1.27641684e+03  1.27641684e+03
  1.27641684e+03  1.94280556e+03  2.97820162e+03  2.97820162e+03
  2.97820162e+03  6.60703839e+03  6.60703839e+03  6.60703839e+03
  8.29784914e+03  2.46840680e+04  7.54786443e+04]
E1 = -727.6356355521893  E_coul = 201.6475647338457
cycle= 3 E= -525.988070818344  delta_E= -2.98e-05  |g|= 0.00455  |ddm|= 0.00875
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00915301
diis-c [-1.26123826e-07 -1.11737376e-03  1.28911712e-01  8.72205661e-01]
  HOMO = -0.574352553784223  LUMO = 0.749206234109819
  mo_energy =
[-1.18283009e+02 -1.22648448e+01 -9.54702425e+00 -9.54702425e+00
 -9.54702425e+00 -1.25174333e+00 -5.74352554e-01 -5.74352554e-01
 -5.74352554e-01  7.49206234e-01  7.49206234e-01  7.49206234e-01
  4.78518390e+00  4.78518390e+00  4.78518390e+00  1.28346435e+01
  2.21958777e+01  2.21958777e+01  2.21958777e+01  9.22845404e+01
  9.22845404e+01  9.22845404e+01  2.18257398e+02  4.23225898e+02
  4.23225898e+02  4.23225898e+02  1.27640921e+03  1.27640921e+03
  1.27640921e+03  1.94279745e+03  2.97819369e+03  2.97819369e+03
  2.97819369e+03  6.60703014e+03  6.60703014e+03  6.60703014e+03
  8.29784071e+03  2.46840594e+04  7.54786356e+04]
E1 = -727.6490859956422  E_coul = 201.6610144469446
cycle= 4 E= -525.988071548698  delta_E= -7.3e-07  |g|= 2.97e-05  |ddm|= 0.00121
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.11645e-05
diis-c [-1.06720508e-09  2.84772204e-05 -4.51577752e-03 -3.43748543e-02
  1.03886215e+00]
  HOMO = -0.574336009215864  LUMO = 0.749215188783944
  mo_energy =
[-1.18282985e+02 -1.22648069e+01 -9.54699072e+00 -9.54699072e+00
 -9.54699072e+00 -1.25172164e+00 -5.74336009e-01 -5.74336009e-01
 -5.74336009e-01  7.49215189e-01  7.49215189e-01  7.49215189e-01
  4.78521122e+00  4.78521122e+00  4.78521122e+00  1.28346820e+01
  2.21959099e+01  2.21959099e+01  2.21959099e+01  9.22845701e+01
  9.22845701e+01  9.22845701e+01  2.18257423e+02  4.23225922e+02
  4.23225922e+02  4.23225922e+02  1.27640923e+03  1.27640923e+03
  1.27640923e+03  1.94279746e+03  2.97819370e+03  2.97819370e+03
  2.97819370e+03  6.60703015e+03  6.60703015e+03  6.60703015e+03
  8.29784072e+03  2.46840594e+04  7.54786356e+04]
E1 = -727.6490276770446  E_coul = 201.66095612831285
cycle= 5 E= -525.988071548732  delta_E= -3.42e-11  |g|= 6.05e-06  |ddm|= 1.22e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.6490276770446  E_coul = 201.66095612831285
  HOMO = -0.574338590822017  LUMO = 0.749213869421402
  mo_energy =
[-1.18282999e+02 -1.22648163e+01 -9.54700063e+00 -9.54700063e+00
 -9.54700063e+00 -1.25172490e+00 -5.74338591e-01 -5.74338591e-01
 -5.74338591e-01  7.49213869e-01  7.49213869e-01  7.49213869e-01
  4.78520609e+00  4.78520609e+00  4.78520609e+00  1.28346738e+01
  2.21959010e+01  2.21959010e+01  2.21959010e+01  9.22845585e+01
  9.22845585e+01  9.22845585e+01  2.18257410e+02  4.23225909e+02
  4.23225909e+02  4.23225909e+02  1.27640921e+03  1.27640921e+03
  1.27640921e+03  1.94279744e+03  2.97819369e+03  2.97819369e+03
  2.97819369e+03  6.60703014e+03  6.60703014e+03  6.60703014e+03
  8.29784070e+03  2.46840594e+04  7.54786356e+04]
E1 = -727.6490578817969  E_coul = 201.66098633306464
Extra cycle  E= -525.988071548732  delta_E= -4.55e-13  |g|= 1.78e-06  |ddm|= 3.05e-06
    CPU time for scf_cycle      0.64 sec, wall time      0.24 sec
exp = [2.61825080e+04 7.61824938e+03 3.61824800e+03 1.61820780e+03
 2.39666952e+02 5.36053567e+01 8.73185826e+00 3.66310185e+00
 4.03308986e-01 1.36279293e+03 6.65179487e+02 3.03313995e+02
 3.16140601e+02 4.93083208e+01 5.48791129e+00 1.46697734e+01
 5.91900198e-01 2.00989001e+00 1.87310663e-01]
E = -525.9880715487323
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:39:48 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5079797        1
[INPUT] 0    0    [1    /1   ]  7618.24937971        1
[INPUT] 0    0    [1    /1   ]  3618.24799991        1
[INPUT] 0    0    [1    /1   ]  1618.20779958        1
[INPUT] 0    0    [1    /1   ]  239.66695222         1
[INPUT] 0    0    [1    /1   ]  53.6053567225        1
[INPUT] 0    0    [1    /1   ]  8.73185825782        1
[INPUT] 0    0    [1    /1   ]  3.66310185294        1
[INPUT] 0    0    [1    /1   ]  0.403308985728       1
[INPUT] 1    0    [1    /1   ]  1362.79292556        1
[INPUT] 1    0    [1    /1   ]  665.179487098        1
[INPUT] 1    0    [1    /1   ]  303.313995184        1
[INPUT] 1    0    [1    /1   ]  316.140600756        1
[INPUT] 1    0    [1    /1   ]  49.3083207615        1
[INPUT] 1    0    [1    /1   ]  5.48791128855        1
[INPUT] 1    0    [1    /1   ]  14.6697734033        1
[INPUT] 1    0    [1    /1   ]  0.591900197573       1
[INPUT] 1    0    [1    /1   ]  2.00989001058        1
[INPUT] 1    0    [1    /1   ]  0.187310662884       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.50797969428, 1.0]], [0, [7618.249379707393, 1.0]], [0, [3618.247999911238, 1.0]], [0, [1618.207799580187, 1.0]], [0, [239.6669522197848, 1.0]], [0, [53.60535672250968, 1.0]], [0, [8.731858257815508, 1.0]], [0, [3.663101852942716, 1.0]], [0, [0.4033089857284034, 1.0]], [1, [1362.7929255550646, 1.0]], [1, [665.1794870982393, 1.0]], [1, [303.3139951837697, 1.0]], [1, [316.1406007563609, 1.0]], [1, [49.3083207614815, 1.0]], [1, [5.487911288554125, 1.0]], [1, [14.669773403312103, 1.0]], [1, [0.5919001975727406, 1.0]], [1, [2.009890010582952, 1.0]], [1, [0.18731066288420256, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50797969]
bas 1, expnt(s) = [7618.24937971]
bas 2, expnt(s) = [3618.24799991]
bas 3, expnt(s) = [1618.20779958]
bas 4, expnt(s) = [239.66695222]
bas 5, expnt(s) = [53.60535672]
bas 6, expnt(s) = [8.73185826]
bas 7, expnt(s) = [3.66310185]
bas 8, expnt(s) = [0.40330899]
bas 9, expnt(s) = [1362.79292556]
bas 10, expnt(s) = [665.1794871]
bas 11, expnt(s) = [303.31399518]
bas 12, expnt(s) = [316.14060076]
bas 13, expnt(s) = [49.30832076]
bas 14, expnt(s) = [5.48791129]
bas 15, expnt(s) = [14.6697734]
bas 16, expnt(s) = [0.5919002]
bas 17, expnt(s) = [2.00989001]
bas 18, expnt(s) = [0.18731066]
CPU time:       118.59
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825080e+04 5.20024084e+03 7.61824938e+03 2.06018591e+03
 3.61824800e+03 1.17866062e+03 1.61820780e+03 6.44600654e+02
 2.39666952e+02 1.53893806e+02 5.36053567e+01 5.00519690e+01
 8.73185826e+00 1.28334976e+01 3.66310185e+00 6.68962495e+00
 4.03308986e-01 1.27862575e+00 1.36279293e+03 2.41558170e+04
 6.65179487e+02 9.85503004e+03 3.03313995e+02 3.69275040e+03
 3.16140601e+02 3.88897127e+03 4.93083208e+01 3.81183996e+02
 5.48791129e+00 2.45043533e+01 1.46697734e+01 8.37555605e+01
 5.91900198e-01 1.51458970e+00 2.00989001e+00 6.98151631e+00
 1.87310663e-01 3.59490583e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.984176180651655
cond(S) = 84613.85398267704
E1 = -728.479801823055  E_coul = 203.10703362952276
init E= -525.372768193532
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.556603640118731  LUMO = 0.755442241525656
  mo_energy =
[-1.18031376e+02 -1.21702630e+01 -9.44766742e+00 -9.44766742e+00
 -9.44766742e+00 -1.22653046e+00 -5.56603640e-01 -5.56603640e-01
 -5.56603640e-01  7.55442242e-01  7.55442242e-01  7.55442242e-01
  4.82920243e+00  4.82920243e+00  4.82920243e+00  1.29147627e+01
  2.22869541e+01  2.22869541e+01  2.22869541e+01  9.24422688e+01
  9.24422688e+01  9.24422688e+01  2.18483535e+02  4.23478162e+02
  4.23478162e+02  4.23478162e+02  1.27672690e+03  1.27672690e+03
  1.27672690e+03  1.94326827e+03  2.97859043e+03  2.97859043e+03
  2.97859043e+03  6.60756379e+03  6.60756379e+03  6.60756379e+03
  8.29847021e+03  2.46847923e+04  7.54794666e+04]
E1 = -727.2969863025066  E_coul = 201.3094559394972
cycle= 1 E= -525.987530363009  delta_E= -0.615  |g|= 0.187  |ddm|= 0.801
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.505415
diis-c [-0.25544479  1.        ]
  HOMO = -0.579961814406693  LUMO = 0.746220661823116
  mo_energy =
[-1.18331103e+02 -1.22899247e+01 -9.57318173e+00 -9.57318173e+00
 -9.57318173e+00 -1.25891233e+00 -5.79961814e-01 -5.79961814e-01
 -5.79961814e-01  7.46220662e-01  7.46220662e-01  7.46220662e-01
  4.77336422e+00  4.77336422e+00  4.77336422e+00  1.28123576e+01
  2.21727506e+01  2.21727506e+01  2.21727506e+01  9.22478801e+01
  9.22478801e+01  9.22478801e+01  2.18211586e+02  4.23178324e+02
  4.23178324e+02  4.23178324e+02  1.27635846e+03  1.27635846e+03
  1.27635846e+03  1.94274453e+03  2.97814138e+03  2.97814138e+03
  2.97814138e+03  6.60697673e+03  6.60697673e+03  6.60697673e+03
  8.29778679e+03  2.46840052e+04  7.54785814e+04]
E1 = -727.733925625492  E_coul = 201.74588457333462
cycle= 2 E= -525.988041052157  delta_E= -0.000511  |g|= 0.031  |ddm|= 0.0378
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0592628
diis-c [-0.00204936  0.07061194  0.92938806]
  HOMO = -0.573471961237934  LUMO = 0.749664408218309
  mo_energy =
[-1.18275795e+02 -1.22609394e+01 -9.54290784e+00 -9.54290784e+00
 -9.54290784e+00 -1.25063443e+00 -5.73471961e-01 -5.73471961e-01
 -5.73471961e-01  7.49664408e-01  7.49664408e-01  7.49664408e-01
  4.78704941e+00  4.78704941e+00  4.78704941e+00  1.28380542e+01
  2.21995202e+01  2.21995202e+01  2.21995202e+01  9.22901407e+01
  9.22901407e+01  9.22901407e+01  2.18264261e+02  4.23233040e+02
  4.23233040e+02  4.23233040e+02  1.27641684e+03  1.27641684e+03
  1.27641684e+03  1.94280556e+03  2.97820162e+03  2.97820162e+03
  2.97820162e+03  6.60703839e+03  6.60703839e+03  6.60703839e+03
  8.29784914e+03  2.46840680e+04  7.54786443e+04]
E1 = -727.6356355521893  E_coul = 201.6475647338457
cycle= 3 E= -525.988070818344  delta_E= -2.98e-05  |g|= 0.00455  |ddm|= 0.00875
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00915301
diis-c [-1.26123826e-07 -1.11737376e-03  1.28911712e-01  8.72205661e-01]
  HOMO = -0.574352553784223  LUMO = 0.749206234109819
  mo_energy =
[-1.18283009e+02 -1.22648448e+01 -9.54702425e+00 -9.54702425e+00
 -9.54702425e+00 -1.25174333e+00 -5.74352554e-01 -5.74352554e-01
 -5.74352554e-01  7.49206234e-01  7.49206234e-01  7.49206234e-01
  4.78518390e+00  4.78518390e+00  4.78518390e+00  1.28346435e+01
  2.21958777e+01  2.21958777e+01  2.21958777e+01  9.22845404e+01
  9.22845404e+01  9.22845404e+01  2.18257398e+02  4.23225898e+02
  4.23225898e+02  4.23225898e+02  1.27640921e+03  1.27640921e+03
  1.27640921e+03  1.94279745e+03  2.97819369e+03  2.97819369e+03
  2.97819369e+03  6.60703014e+03  6.60703014e+03  6.60703014e+03
  8.29784071e+03  2.46840594e+04  7.54786356e+04]
E1 = -727.6490859956422  E_coul = 201.6610144469446
cycle= 4 E= -525.988071548698  delta_E= -7.3e-07  |g|= 2.97e-05  |ddm|= 0.00121
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.11645e-05
diis-c [-1.06720508e-09  2.84772204e-05 -4.51577752e-03 -3.43748543e-02
  1.03886215e+00]
  HOMO = -0.574336009215864  LUMO = 0.749215188783944
  mo_energy =
[-1.18282985e+02 -1.22648069e+01 -9.54699072e+00 -9.54699072e+00
 -9.54699072e+00 -1.25172164e+00 -5.74336009e-01 -5.74336009e-01
 -5.74336009e-01  7.49215189e-01  7.49215189e-01  7.49215189e-01
  4.78521122e+00  4.78521122e+00  4.78521122e+00  1.28346820e+01
  2.21959099e+01  2.21959099e+01  2.21959099e+01  9.22845701e+01
  9.22845701e+01  9.22845701e+01  2.18257423e+02  4.23225922e+02
  4.23225922e+02  4.23225922e+02  1.27640923e+03  1.27640923e+03
  1.27640923e+03  1.94279746e+03  2.97819370e+03  2.97819370e+03
  2.97819370e+03  6.60703015e+03  6.60703015e+03  6.60703015e+03
  8.29784072e+03  2.46840594e+04  7.54786356e+04]
E1 = -727.6490276770446  E_coul = 201.66095612831285
cycle= 5 E= -525.988071548732  delta_E= -3.42e-11  |g|= 6.05e-06  |ddm|= 1.22e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.6490276770446  E_coul = 201.66095612831285
  HOMO = -0.574338590822017  LUMO = 0.749213869421402
  mo_energy =
[-1.18282999e+02 -1.22648163e+01 -9.54700063e+00 -9.54700063e+00
 -9.54700063e+00 -1.25172490e+00 -5.74338591e-01 -5.74338591e-01
 -5.74338591e-01  7.49213869e-01  7.49213869e-01  7.49213869e-01
  4.78520609e+00  4.78520609e+00  4.78520609e+00  1.28346738e+01
  2.21959010e+01  2.21959010e+01  2.21959010e+01  9.22845585e+01
  9.22845585e+01  9.22845585e+01  2.18257410e+02  4.23225909e+02
  4.23225909e+02  4.23225909e+02  1.27640921e+03  1.27640921e+03
  1.27640921e+03  1.94279744e+03  2.97819369e+03  2.97819369e+03
  2.97819369e+03  6.60703014e+03  6.60703014e+03  6.60703014e+03
  8.29784070e+03  2.46840594e+04  7.54786356e+04]
E1 = -727.6490578817969  E_coul = 201.66098633306464
Extra cycle  E= -525.988071548732  delta_E= -4.55e-13  |g|= 1.78e-06  |ddm|= 3.05e-06
    CPU time for scf_cycle      0.61 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 84613.85398267704
E1 = -727.6490578817969  E_coul = 201.66098633306464
init E= -525.988071548732
    CPU time for initialize scf      2.74 sec, wall time      0.25 sec
  HOMO = -0.574338023498476  LUMO = 0.749214167027302
  mo_energy =
[-1.18282995e+02 -1.22648141e+01 -9.54699835e+00 -9.54699835e+00
 -9.54699835e+00 -1.25172418e+00 -5.74338023e-01 -5.74338023e-01
 -5.74338023e-01  7.49214167e-01  7.49214167e-01  7.49214167e-01
  4.78520722e+00  4.78520722e+00  4.78520722e+00  1.28346758e+01
  2.21959030e+01  2.21959030e+01  2.21959030e+01  9.22845614e+01
  9.22845614e+01  9.22845614e+01  2.18257414e+02  4.23225912e+02
  4.23225912e+02  4.23225912e+02  1.27640922e+03  1.27640922e+03
  1.27640922e+03  1.94279745e+03  2.97819369e+03  2.97819369e+03
  2.97819369e+03  6.60703014e+03  6.60703014e+03  6.60703014e+03
  8.29784070e+03  2.46840594e+04  7.54786356e+04]
E1 = -727.649050883034  E_coul = 201.6609793342999
cycle= 1 E= -525.988071548734  delta_E= -1.82e-12  |g|= 4.48e-07  |ddm|= 6.47e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.649050883034  E_coul = 201.6609793342999
  HOMO = -0.57433814282858  LUMO = 0.74921410472615
  mo_energy =
[-1.18282996e+02 -1.22648146e+01 -9.54699888e+00 -9.54699888e+00
 -9.54699888e+00 -1.25172433e+00 -5.74338143e-01 -5.74338143e-01
 -5.74338143e-01  7.49214105e-01  7.49214105e-01  7.49214105e-01
  4.78520697e+00  4.78520697e+00  4.78520697e+00  1.28346753e+01
  2.21959026e+01  2.21959026e+01  2.21959026e+01  9.22845607e+01
  9.22845607e+01  9.22845607e+01  2.18257413e+02  4.23225911e+02
  4.23225911e+02  4.23225911e+02  1.27640922e+03  1.27640922e+03
  1.27640922e+03  1.94279744e+03  2.97819369e+03  2.97819369e+03
  2.97819369e+03  6.60703014e+03  6.60703014e+03  6.60703014e+03
  8.29784070e+03  2.46840594e+04  7.54786356e+04]
E1 = -727.6490525773999  E_coul = 201.66098102866738
Extra cycle  E= -525.988071548732  delta_E= 1.59e-12  |g|= 1.11e-07  |ddm|= 1.54e-07
    CPU time for scf_cycle      2.86 sec, wall time      0.37 sec
exp = [2.61825080e+04 7.61824938e+03 3.61824800e+03 1.61820780e+03
 2.39666952e+02 5.36053567e+01 8.73185826e+00 3.66310185e+00
 4.03308986e-01 1.36279293e+03 6.65179487e+02 3.03313995e+02
 3.16140601e+02 4.93083208e+01 5.48791129e+00 1.46697734e+01
 5.91900198e-01 2.00989001e+00 1.87310663e-01]
grad_E = [-1.97779692e-06  2.22841774e-05  4.51146807e-05  6.87510778e-04
 -2.37497011e-04 -2.94185493e-02 -1.44987591e-02  2.98674395e-02
  8.29616511e-02  6.07483865e-07  1.45071153e-05  7.40328480e-05
  6.53167125e-05  4.74793173e-03  6.10693154e-02 -3.75913586e-02
 -1.88272264e-01 -1.86264610e-02  2.08379363e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:39:52 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5080358        1
[INPUT] 0    0    [1    /1   ]  7618.24877049        1
[INPUT] 0    0    [1    /1   ]  3618.24679122        1
[INPUT] 0    0    [1    /1   ]  1618.18915769        1
[INPUT] 0    0    [1    /1   ]  239.616644878        1
[INPUT] 0    0    [1    /1   ]  54.4995789478        1
[INPUT] 0    0    [1    /1   ]  10.2263959642        1
[INPUT] 0    0    [1    /1   ]  3.91742462036        1
[INPUT] 0    0    [1    /1   ]  0.404253862675       1
[INPUT] 1    0    [1    /1   ]  1362.79289565        1
[INPUT] 1    0    [1    /1   ]  665.178979059        1
[INPUT] 1    0    [1    /1   ]  303.3112927          1
[INPUT] 1    0    [1    /1   ]  316.138219533        1
[INPUT] 1    0    [1    /1   ]  49.2830137979        1
[INPUT] 1    0    [1    /1   ]  5.63305896294        1
[INPUT] 1    0    [1    /1   ]  14.8381771557        1
[INPUT] 1    0    [1    /1   ]  0.630358970775       1
[INPUT] 1    0    [1    /1   ]  2.3518812356         1
[INPUT] 1    0    [1    /1   ]  0.198945357999       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.508035830313, 1.0]], [0, [7618.248770493961, 1.0]], [0, [3618.2467912185043, 1.0]], [0, [1618.1891576881608, 1.0]], [0, [239.616644878206, 1.0]], [0, [54.49957894776896, 1.0]], [0, [10.226395964174529, 1.0]], [0, [3.9174246203638035, 1.0]], [0, [0.4042538626753304, 1.0]], [1, [1362.7928956537176, 1.0]], [1, [665.1789790585954, 1.0]], [1, [303.31129270040964, 1.0]], [1, [316.13821953278216, 1.0]], [1, [49.283013797861415, 1.0]], [1, [5.633058962941723, 1.0]], [1, [14.838177155735385, 1.0]], [1, [0.6303589707745354, 1.0]], [1, [2.3518812355976713, 1.0]], [1, [0.19894535799893073, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50803583]
bas 1, expnt(s) = [7618.24877049]
bas 2, expnt(s) = [3618.24679122]
bas 3, expnt(s) = [1618.18915769]
bas 4, expnt(s) = [239.61664488]
bas 5, expnt(s) = [54.49957895]
bas 6, expnt(s) = [10.22639596]
bas 7, expnt(s) = [3.91742462]
bas 8, expnt(s) = [0.40425386]
bas 9, expnt(s) = [1362.79289565]
bas 10, expnt(s) = [665.17897906]
bas 11, expnt(s) = [303.3112927]
bas 12, expnt(s) = [316.13821953]
bas 13, expnt(s) = [49.2830138]
bas 14, expnt(s) = [5.63305896]
bas 15, expnt(s) = [14.83817716]
bas 16, expnt(s) = [0.63035897]
bas 17, expnt(s) = [2.35188124]
bas 18, expnt(s) = [0.19894536]
CPU time:       126.64
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825080e+04 5.20024085e+03 7.61824877e+03 2.06018579e+03
 3.61824679e+03 1.17866032e+03 1.61818916e+03 6.44595085e+02
 2.39616645e+02 1.53869578e+02 5.44995789e+01 5.06768818e+01
 1.02263960e+01 1.44479749e+01 3.91742462e+00 7.03502282e+00
 4.04253863e-01 1.28087178e+00 1.36279290e+03 2.41558163e+04
 6.65178979e+02 9.85502063e+03 3.03311293e+02 3.69270928e+03
 3.16138220e+02 3.88893466e+03 4.92830138e+01 3.80939463e+02
 5.63305896e+00 2.53171470e+01 1.48381772e+01 8.49591351e+01
 6.30358971e-01 1.63858628e+00 2.35188124e+00 8.49676538e+00
 1.98945358e-01 3.87615964e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982626717122137
cond(S) = 85142.51390616283
E1 = -728.5358971387925  E_coul = 203.12739223157885
init E= -525.408504907214
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.555742979301249  LUMO = 0.82585158484046
  mo_energy =
[-1.18052042e+02 -1.21613561e+01 -9.44722109e+00 -9.44722109e+00
 -9.44722109e+00 -1.22679348e+00 -5.55742979e-01 -5.55742979e-01
 -5.55742979e-01  8.25851585e-01  8.25851585e-01  8.25851585e-01
  5.55121197e+00  5.55121197e+00  5.55121197e+00  1.58598710e+01
  2.40990312e+01  2.40990312e+01  2.40990312e+01  9.46943968e+01
  9.46943968e+01  9.46943968e+01  2.28013666e+02  4.25274069e+02
  4.25274069e+02  4.25274069e+02  1.27826912e+03  1.27826912e+03
  1.27826912e+03  1.95206455e+03  2.98000251e+03  2.98000251e+03
  2.98000251e+03  6.60884108e+03  6.60884108e+03  6.60884108e+03
  8.30635258e+03  2.46922093e+04  7.54863509e+04]
E1 = -727.4675118380494  E_coul = 201.4431649297353
cycle= 1 E= -526.024346908314  delta_E= -0.616  |g|= 0.185  |ddm|= 0.695
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.508829
diis-c [-0.25890688  1.        ]
  HOMO = -0.575703843499681  LUMO = 0.817275636132801
  mo_energy =
[-1.18338833e+02 -1.22749490e+01 -9.56472277e+00 -9.56472277e+00
 -9.56472277e+00 -1.25581282e+00 -5.75703844e-01 -5.75703844e-01
 -5.75703843e-01  8.17275636e-01  8.17275636e-01  8.17275636e-01
  5.49600910e+00  5.49600910e+00  5.49600910e+00  1.57552516e+01
  2.39913880e+01  2.39913880e+01  2.39913880e+01  9.45103958e+01
  9.45103958e+01  9.45103958e+01  2.27751558e+02  4.24986666e+02
  4.24986666e+02  4.24986666e+02  1.27791454e+03  1.27791454e+03
  1.27791454e+03  1.95155630e+03  2.97956840e+03  2.97956840e+03
  2.97956840e+03  6.60826913e+03  6.60826913e+03  6.60826913e+03
  8.30568444e+03  2.46914372e+04  7.54854803e+04]
E1 = -727.8598499521106  E_coul = 201.83506290145507
cycle= 2 E= -526.024787050656  delta_E= -0.00044  |g|= 0.0287  |ddm|= 0.0349
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0567716
diis-c [-0.00196384  0.06542418  0.93457582]
  HOMO = -0.569993727797578  LUMO = 0.820645118266142
  mo_energy =
[-1.18287866e+02 -1.22488962e+01 -9.53748479e+00 -9.53748479e+00
 -9.53748479e+00 -1.24850092e+00 -5.69993728e-01 -5.69993728e-01
 -5.69993728e-01  8.20645118e-01  8.20645118e-01  8.20645118e-01
  5.50920006e+00  5.50920006e+00  5.50920006e+00  1.57801859e+01
  2.40157287e+01  2.40157287e+01  2.40157287e+01  9.45489014e+01
  9.45489014e+01  9.45489014e+01  2.27800077e+02  4.25037046e+02
  4.25037046e+02  4.25037046e+02  1.27796847e+03  1.27796847e+03
  1.27796847e+03  1.95161284e+03  2.97962417e+03  2.97962417e+03
  2.97962417e+03  6.60832629e+03  6.60832629e+03  6.60832629e+03
  8.30574230e+03  2.46914954e+04  7.54855388e+04]
E1 = -727.7737642259368  E_coul = 201.7489534910033
cycle= 3 E= -526.024810734933  delta_E= -2.37e-05  |g|= 0.00415  |ddm|= 0.0076
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00854912
diis-c [-9.89265610e-08 -1.05716551e-03  1.26168461e-01  8.74888704e-01]
  HOMO = -0.570774780254018  LUMO = 0.820193353477753
  mo_energy =
[-1.18294481e+02 -1.22524335e+01 -9.54119937e+00 -9.54119937e+00
 -9.54119937e+00 -1.24949805e+00 -5.70774780e-01 -5.70774780e-01
 -5.70774780e-01  8.20193353e-01  8.20193353e-01  8.20193353e-01
  5.50738881e+00  5.50738881e+00  5.50738881e+00  1.57768540e+01
  2.40124111e+01  2.40124111e+01  2.40124111e+01  9.45438092e+01
  9.45438092e+01  9.45438092e+01  2.27793778e+02  4.25030501e+02
  4.25030501e+02  4.25030501e+02  1.27796147e+03  1.27796147e+03
  1.27796147e+03  1.95160539e+03  2.97961688e+03  2.97961688e+03
  2.97961688e+03  6.60831872e+03  6.60831872e+03  6.60831872e+03
  8.30573455e+03  2.46914875e+04  7.54855308e+04]
E1 = -727.785503297098  E_coul = 201.76069199273806
cycle= 4 E= -526.02481130436  delta_E= -5.69e-07  |g|= 2.7e-05  |ddm|= 0.00108
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.38153e-05
diis-c [-9.89072201e-10  2.79691554e-05 -4.20966456e-03 -2.97032718e-02
  1.03388497e+00]
  HOMO = -0.570756835933491  LUMO = 0.820203941831266
  mo_energy =
[-1.18294441e+02 -1.22523887e+01 -9.54115692e+00 -9.54115692e+00
 -9.54115692e+00 -1.24947524e+00 -5.70756836e-01 -5.70756836e-01
 -5.70756836e-01  8.20203942e-01  8.20203942e-01  8.20203942e-01
  5.50742129e+00  5.50742129e+00  5.50742129e+00  1.57768984e+01
  2.40124515e+01  2.40124515e+01  2.40124515e+01  9.45438516e+01
  9.45438516e+01  9.45438516e+01  2.27793819e+02  4.25030541e+02
  4.25030541e+02  4.25030541e+02  1.27796151e+03  1.27796151e+03
  1.27796151e+03  1.95160542e+03  2.97961692e+03  2.97961692e+03
  2.97961692e+03  6.60831875e+03  6.60831875e+03  6.60831875e+03
  8.30573458e+03  2.46914876e+04  7.54855308e+04]
E1 = -727.7854159746572  E_coul = 201.76060467025692
cycle= 5 E= -526.0248113044  delta_E= -4.04e-11  |g|= 5.25e-06  |ddm|= 1.11e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.7854159746572  E_coul = 201.76060467025692
  HOMO = -0.57075916750637  LUMO = 0.820202622303524
  mo_energy =
[-1.18294453e+02 -1.22523972e+01 -9.54116578e+00 -9.54116578e+00
 -9.54116578e+00 -1.24947823e+00 -5.70759168e-01 -5.70759168e-01
 -5.70759168e-01  8.20202622e-01  8.20202622e-01  8.20202622e-01
  5.50741631e+00  5.50741631e+00  5.50741631e+00  1.57768905e+01
  2.40124435e+01  2.40124435e+01  2.40124435e+01  9.45438413e+01
  9.45438413e+01  9.45438413e+01  2.27793807e+02  4.25030530e+02
  4.25030530e+02  4.25030530e+02  1.27796149e+03  1.27796149e+03
  1.27796149e+03  1.95160541e+03  2.97961691e+03  2.97961691e+03
  2.97961691e+03  6.60831873e+03  6.60831873e+03  6.60831873e+03
  8.30573457e+03  2.46914876e+04  7.54855308e+04]
E1 = -727.7854415687917  E_coul = 201.76063026438936
Extra cycle  E= -526.024811304402  delta_E= -2.16e-12  |g|= 1.51e-06  |ddm|= 2.72e-06
    CPU time for scf_cycle      0.61 sec, wall time      0.23 sec
exp = [2.61825080e+04 7.61824877e+03 3.61824679e+03 1.61818916e+03
 2.39616645e+02 5.44995789e+01 1.02263960e+01 3.91742462e+00
 4.04253863e-01 1.36279290e+03 6.65178979e+02 3.03311293e+02
 3.16138220e+02 4.92830138e+01 5.63305896e+00 1.48381772e+01
 6.30358971e-01 2.35188124e+00 1.98945358e-01]
E = -526.0248113044024
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:39:52 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5080358        1
[INPUT] 0    0    [1    /1   ]  7618.24877049        1
[INPUT] 0    0    [1    /1   ]  3618.24679122        1
[INPUT] 0    0    [1    /1   ]  1618.18915769        1
[INPUT] 0    0    [1    /1   ]  239.616644878        1
[INPUT] 0    0    [1    /1   ]  54.4995789478        1
[INPUT] 0    0    [1    /1   ]  10.2263959642        1
[INPUT] 0    0    [1    /1   ]  3.91742462036        1
[INPUT] 0    0    [1    /1   ]  0.404253862675       1
[INPUT] 1    0    [1    /1   ]  1362.79289565        1
[INPUT] 1    0    [1    /1   ]  665.178979059        1
[INPUT] 1    0    [1    /1   ]  303.3112927          1
[INPUT] 1    0    [1    /1   ]  316.138219533        1
[INPUT] 1    0    [1    /1   ]  49.2830137979        1
[INPUT] 1    0    [1    /1   ]  5.63305896294        1
[INPUT] 1    0    [1    /1   ]  14.8381771557        1
[INPUT] 1    0    [1    /1   ]  0.630358970775       1
[INPUT] 1    0    [1    /1   ]  2.3518812356         1
[INPUT] 1    0    [1    /1   ]  0.198945357999       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.508035830313, 1.0]], [0, [7618.248770493961, 1.0]], [0, [3618.2467912185043, 1.0]], [0, [1618.1891576881608, 1.0]], [0, [239.616644878206, 1.0]], [0, [54.49957894776896, 1.0]], [0, [10.226395964174529, 1.0]], [0, [3.9174246203638035, 1.0]], [0, [0.4042538626753304, 1.0]], [1, [1362.7928956537176, 1.0]], [1, [665.1789790585954, 1.0]], [1, [303.31129270040964, 1.0]], [1, [316.13821953278216, 1.0]], [1, [49.283013797861415, 1.0]], [1, [5.633058962941723, 1.0]], [1, [14.838177155735385, 1.0]], [1, [0.6303589707745354, 1.0]], [1, [2.3518812355976713, 1.0]], [1, [0.19894535799893073, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50803583]
bas 1, expnt(s) = [7618.24877049]
bas 2, expnt(s) = [3618.24679122]
bas 3, expnt(s) = [1618.18915769]
bas 4, expnt(s) = [239.61664488]
bas 5, expnt(s) = [54.49957895]
bas 6, expnt(s) = [10.22639596]
bas 7, expnt(s) = [3.91742462]
bas 8, expnt(s) = [0.40425386]
bas 9, expnt(s) = [1362.79289565]
bas 10, expnt(s) = [665.17897906]
bas 11, expnt(s) = [303.3112927]
bas 12, expnt(s) = [316.13821953]
bas 13, expnt(s) = [49.2830138]
bas 14, expnt(s) = [5.63305896]
bas 15, expnt(s) = [14.83817716]
bas 16, expnt(s) = [0.63035897]
bas 17, expnt(s) = [2.35188124]
bas 18, expnt(s) = [0.19894536]
CPU time:       127.32
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825080e+04 5.20024085e+03 7.61824877e+03 2.06018579e+03
 3.61824679e+03 1.17866032e+03 1.61818916e+03 6.44595085e+02
 2.39616645e+02 1.53869578e+02 5.44995789e+01 5.06768818e+01
 1.02263960e+01 1.44479749e+01 3.91742462e+00 7.03502282e+00
 4.04253863e-01 1.28087178e+00 1.36279290e+03 2.41558163e+04
 6.65178979e+02 9.85502063e+03 3.03311293e+02 3.69270928e+03
 3.16138220e+02 3.88893466e+03 4.92830138e+01 3.80939463e+02
 5.63305896e+00 2.53171470e+01 1.48381772e+01 8.49591351e+01
 6.30358971e-01 1.63858628e+00 2.35188124e+00 8.49676538e+00
 1.98945358e-01 3.87615964e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982626717122137
cond(S) = 85142.51390616283
E1 = -728.5358971387925  E_coul = 203.12739223157885
init E= -525.408504907214
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.555742979301249  LUMO = 0.82585158484046
  mo_energy =
[-1.18052042e+02 -1.21613561e+01 -9.44722109e+00 -9.44722109e+00
 -9.44722109e+00 -1.22679348e+00 -5.55742979e-01 -5.55742979e-01
 -5.55742979e-01  8.25851585e-01  8.25851585e-01  8.25851585e-01
  5.55121197e+00  5.55121197e+00  5.55121197e+00  1.58598710e+01
  2.40990312e+01  2.40990312e+01  2.40990312e+01  9.46943968e+01
  9.46943968e+01  9.46943968e+01  2.28013666e+02  4.25274069e+02
  4.25274069e+02  4.25274069e+02  1.27826912e+03  1.27826912e+03
  1.27826912e+03  1.95206455e+03  2.98000251e+03  2.98000251e+03
  2.98000251e+03  6.60884108e+03  6.60884108e+03  6.60884108e+03
  8.30635258e+03  2.46922093e+04  7.54863509e+04]
E1 = -727.4675118380494  E_coul = 201.4431649297353
cycle= 1 E= -526.024346908314  delta_E= -0.616  |g|= 0.185  |ddm|= 0.695
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.508829
diis-c [-0.25890688  1.        ]
  HOMO = -0.575703843499681  LUMO = 0.817275636132801
  mo_energy =
[-1.18338833e+02 -1.22749490e+01 -9.56472277e+00 -9.56472277e+00
 -9.56472277e+00 -1.25581282e+00 -5.75703844e-01 -5.75703844e-01
 -5.75703843e-01  8.17275636e-01  8.17275636e-01  8.17275636e-01
  5.49600910e+00  5.49600910e+00  5.49600910e+00  1.57552516e+01
  2.39913880e+01  2.39913880e+01  2.39913880e+01  9.45103958e+01
  9.45103958e+01  9.45103958e+01  2.27751558e+02  4.24986666e+02
  4.24986666e+02  4.24986666e+02  1.27791454e+03  1.27791454e+03
  1.27791454e+03  1.95155630e+03  2.97956840e+03  2.97956840e+03
  2.97956840e+03  6.60826913e+03  6.60826913e+03  6.60826913e+03
  8.30568444e+03  2.46914372e+04  7.54854803e+04]
E1 = -727.8598499521106  E_coul = 201.83506290145507
cycle= 2 E= -526.024787050656  delta_E= -0.00044  |g|= 0.0287  |ddm|= 0.0349
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0567716
diis-c [-0.00196384  0.06542418  0.93457582]
  HOMO = -0.569993727797578  LUMO = 0.820645118266142
  mo_energy =
[-1.18287866e+02 -1.22488962e+01 -9.53748479e+00 -9.53748479e+00
 -9.53748479e+00 -1.24850092e+00 -5.69993728e-01 -5.69993728e-01
 -5.69993728e-01  8.20645118e-01  8.20645118e-01  8.20645118e-01
  5.50920006e+00  5.50920006e+00  5.50920006e+00  1.57801859e+01
  2.40157287e+01  2.40157287e+01  2.40157287e+01  9.45489014e+01
  9.45489014e+01  9.45489014e+01  2.27800077e+02  4.25037046e+02
  4.25037046e+02  4.25037046e+02  1.27796847e+03  1.27796847e+03
  1.27796847e+03  1.95161284e+03  2.97962417e+03  2.97962417e+03
  2.97962417e+03  6.60832629e+03  6.60832629e+03  6.60832629e+03
  8.30574230e+03  2.46914954e+04  7.54855388e+04]
E1 = -727.7737642259368  E_coul = 201.7489534910033
cycle= 3 E= -526.024810734933  delta_E= -2.37e-05  |g|= 0.00415  |ddm|= 0.0076
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00854912
diis-c [-9.89265610e-08 -1.05716551e-03  1.26168461e-01  8.74888704e-01]
  HOMO = -0.570774780254018  LUMO = 0.820193353477753
  mo_energy =
[-1.18294481e+02 -1.22524335e+01 -9.54119937e+00 -9.54119937e+00
 -9.54119937e+00 -1.24949805e+00 -5.70774780e-01 -5.70774780e-01
 -5.70774780e-01  8.20193353e-01  8.20193353e-01  8.20193353e-01
  5.50738881e+00  5.50738881e+00  5.50738881e+00  1.57768540e+01
  2.40124111e+01  2.40124111e+01  2.40124111e+01  9.45438092e+01
  9.45438092e+01  9.45438092e+01  2.27793778e+02  4.25030501e+02
  4.25030501e+02  4.25030501e+02  1.27796147e+03  1.27796147e+03
  1.27796147e+03  1.95160539e+03  2.97961688e+03  2.97961688e+03
  2.97961688e+03  6.60831872e+03  6.60831872e+03  6.60831872e+03
  8.30573455e+03  2.46914875e+04  7.54855308e+04]
E1 = -727.785503297098  E_coul = 201.76069199273806
cycle= 4 E= -526.02481130436  delta_E= -5.69e-07  |g|= 2.7e-05  |ddm|= 0.00108
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.38153e-05
diis-c [-9.89072201e-10  2.79691554e-05 -4.20966456e-03 -2.97032718e-02
  1.03388497e+00]
  HOMO = -0.570756835933491  LUMO = 0.820203941831266
  mo_energy =
[-1.18294441e+02 -1.22523887e+01 -9.54115692e+00 -9.54115692e+00
 -9.54115692e+00 -1.24947524e+00 -5.70756836e-01 -5.70756836e-01
 -5.70756836e-01  8.20203942e-01  8.20203942e-01  8.20203942e-01
  5.50742129e+00  5.50742129e+00  5.50742129e+00  1.57768984e+01
  2.40124515e+01  2.40124515e+01  2.40124515e+01  9.45438516e+01
  9.45438516e+01  9.45438516e+01  2.27793819e+02  4.25030541e+02
  4.25030541e+02  4.25030541e+02  1.27796151e+03  1.27796151e+03
  1.27796151e+03  1.95160542e+03  2.97961692e+03  2.97961692e+03
  2.97961692e+03  6.60831875e+03  6.60831875e+03  6.60831875e+03
  8.30573458e+03  2.46914876e+04  7.54855308e+04]
E1 = -727.7854159746572  E_coul = 201.76060467025692
cycle= 5 E= -526.0248113044  delta_E= -4.04e-11  |g|= 5.25e-06  |ddm|= 1.11e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.7854159746572  E_coul = 201.76060467025692
  HOMO = -0.57075916750637  LUMO = 0.820202622303524
  mo_energy =
[-1.18294453e+02 -1.22523972e+01 -9.54116578e+00 -9.54116578e+00
 -9.54116578e+00 -1.24947823e+00 -5.70759168e-01 -5.70759168e-01
 -5.70759168e-01  8.20202622e-01  8.20202622e-01  8.20202622e-01
  5.50741631e+00  5.50741631e+00  5.50741631e+00  1.57768905e+01
  2.40124435e+01  2.40124435e+01  2.40124435e+01  9.45438413e+01
  9.45438413e+01  9.45438413e+01  2.27793807e+02  4.25030530e+02
  4.25030530e+02  4.25030530e+02  1.27796149e+03  1.27796149e+03
  1.27796149e+03  1.95160541e+03  2.97961691e+03  2.97961691e+03
  2.97961691e+03  6.60831873e+03  6.60831873e+03  6.60831873e+03
  8.30573457e+03  2.46914876e+04  7.54855308e+04]
E1 = -727.7854415687917  E_coul = 201.76063026438936
Extra cycle  E= -526.024811304402  delta_E= -2.16e-12  |g|= 1.51e-06  |ddm|= 2.72e-06
    CPU time for scf_cycle      0.61 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 85142.51390616283
E1 = -727.7854415687917  E_coul = 201.76063026438936
init E= -526.024811304402
    CPU time for initialize scf      2.70 sec, wall time      0.24 sec
  HOMO = -0.57075868807927  LUMO = 0.820202900534094
  mo_energy =
[-1.18294450e+02 -1.22523954e+01 -9.54116385e+00 -9.54116385e+00
 -9.54116385e+00 -1.24947762e+00 -5.70758688e-01 -5.70758688e-01
 -5.70758688e-01  8.20202901e-01  8.20202901e-01  8.20202901e-01
  5.50741734e+00  5.50741734e+00  5.50741734e+00  1.57768923e+01
  2.40124452e+01  2.40124452e+01  2.40124452e+01  9.45438438e+01
  9.45438438e+01  9.45438438e+01  2.27793810e+02  4.25030533e+02
  4.25030533e+02  4.25030533e+02  1.27796150e+03  1.27796150e+03
  1.27796150e+03  1.95160541e+03  2.97961691e+03  2.97961691e+03
  2.97961691e+03  6.60831874e+03  6.60831874e+03  6.60831874e+03
  8.30573457e+03  2.46914876e+04  7.54855308e+04]
E1 = -727.7854358662472  E_coul = 201.7606245618452
cycle= 1 E= -526.024811304402  delta_E= 4.55e-13  |g|= 3.68e-07  |ddm|= 5.32e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.7854358662472  E_coul = 201.7606245618452
  HOMO = -0.570758784450219  LUMO = 0.82020284468621
  mo_energy =
[-1.18294451e+02 -1.22523958e+01 -9.54116428e+00 -9.54116428e+00
 -9.54116428e+00 -1.24947774e+00 -5.70758784e-01 -5.70758784e-01
 -5.70758784e-01  8.20202845e-01  8.20202845e-01  8.20202845e-01
  5.50741713e+00  5.50741713e+00  5.50741713e+00  1.57768919e+01
  2.40124448e+01  2.40124448e+01  2.40124448e+01  9.45438432e+01
  9.45438432e+01  9.45438432e+01  2.27793810e+02  4.25030532e+02
  4.25030532e+02  4.25030532e+02  1.27796150e+03  1.27796150e+03
  1.27796150e+03  1.95160541e+03  2.97961691e+03  2.97961691e+03
  2.97961691e+03  6.60831873e+03  6.60831873e+03  6.60831873e+03
  8.30573457e+03  2.46914876e+04  7.54855308e+04]
E1 = -727.7854371940007  E_coul = 201.7606258895986
Extra cycle  E= -526.024811304402  delta_E= -1.14e-13  |g|= 8.84e-08  |ddm|= 1.23e-07
    CPU time for scf_cycle      2.82 sec, wall time      0.36 sec
exp = [2.61825080e+04 7.61824877e+03 3.61824679e+03 1.61818916e+03
 2.39616645e+02 5.44995789e+01 1.02263960e+01 3.91742462e+00
 4.04253863e-01 1.36279290e+03 6.65178979e+02 3.03311293e+02
 3.16138220e+02 4.92830138e+01 5.63305896e+00 1.48381772e+01
 6.30358971e-01 2.35188124e+00 1.98945358e-01]
grad_E = [-1.97617508e-06  2.29356219e-05  4.71622919e-05  7.11860090e-04
 -1.80691637e-03 -2.44489775e-02 -8.64745749e-03  4.56641622e-02
  1.06956582e-01  8.30515775e-07  1.62239202e-05  8.46974211e-05
  7.46691387e-05  2.93552882e-03  2.74925584e-02 -2.47565197e-02
 -2.01280690e-01  7.02844264e-03  2.79725688e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:39:57 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.508117         1
[INPUT] 0    0    [1    /1   ]  7618.24788751        1
[INPUT] 0    0    [1    /1   ]  3618.24503689        1
[INPUT] 0    0    [1    /1   ]  1618.16212418        1
[INPUT] 0    0    [1    /1   ]  239.548251429        1
[INPUT] 0    0    [1    /1   ]  55.834418958         1
[INPUT] 0    0    [1    /1   ]  12.2919054941        1
[INPUT] 0    0    [1    /1   ]  3.83254519236        1
[INPUT] 0    0    [1    /1   ]  0.397269675412       1
[INPUT] 1    0    [1    /1   ]  1362.79285343        1
[INPUT] 1    0    [1    /1   ]  665.178252012        1
[INPUT] 1    0    [1    /1   ]  303.307432045        1
[INPUT] 1    0    [1    /1   ]  316.134817677        1
[INPUT] 1    0    [1    /1   ]  49.2384973538        1
[INPUT] 1    0    [1    /1   ]  5.83275552079        1
[INPUT] 1    0    [1    /1   ]  15.1376451953        1
[INPUT] 1    0    [1    /1   ]  0.660386317383       1
[INPUT] 1    0    [1    /1   ]  2.78265983056        1
[INPUT] 1    0    [1    /1   ]  0.200809893814       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.50811698666, 1.0]], [0, [7618.247887511734, 1.0]], [0, [3618.2450368946497, 1.0]], [0, [1618.1621241751006, 1.0]], [0, [239.5482514292616, 1.0]], [0, [55.83441895799775, 1.0]], [0, [12.291905494109713, 1.0]], [0, [3.832545192363573, 1.0]], [0, [0.39726967541167657, 1.0]], [1, [1362.7928534274013, 1.0]], [1, [665.1782520117367, 1.0]], [1, [303.30743204478, 1.0]], [1, [316.13481767730775, 1.0]], [1, [49.23849735378738, 1.0]], [1, [5.83275552079067, 1.0]], [1, [15.137645195281614, 1.0]], [1, [0.6603863173829578, 1.0]], [1, [2.782659830560761, 1.0]], [1, [0.2008098938142052, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50811699]
bas 1, expnt(s) = [7618.24788751]
bas 2, expnt(s) = [3618.24503689]
bas 3, expnt(s) = [1618.16212418]
bas 4, expnt(s) = [239.54825143]
bas 5, expnt(s) = [55.83441896]
bas 6, expnt(s) = [12.29190549]
bas 7, expnt(s) = [3.83254519]
bas 8, expnt(s) = [0.39726968]
bas 9, expnt(s) = [1362.79285343]
bas 10, expnt(s) = [665.17825201]
bas 11, expnt(s) = [303.30743204]
bas 12, expnt(s) = [316.13481768]
bas 13, expnt(s) = [49.23849735]
bas 14, expnt(s) = [5.83275552]
bas 15, expnt(s) = [15.1376452]
bas 16, expnt(s) = [0.66038632]
bas 17, expnt(s) = [2.78265983]
bas 18, expnt(s) = [0.20080989]
CPU time:       135.39
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825081e+04 5.20024086e+03 7.61824789e+03 2.06018561e+03
 3.61824504e+03 1.17865989e+03 1.61816212e+03 6.44587008e+02
 2.39548251e+02 1.53836637e+02 5.58344190e+01 5.16049694e+01
 1.22919055e+01 1.65855330e+01 3.83254519e+00 6.92038869e+00
 3.97269675e-01 1.26423872e+00 1.36279285e+03 2.41558154e+04
 6.65178252e+02 9.85500717e+03 3.03307432e+02 3.69265053e+03
 3.16134818e+02 3.88888235e+03 4.92384974e+01 3.80509392e+02
 5.83275552e+00 2.64439672e+01 1.51376452e+01 8.71078500e+01
 6.60386317e-01 1.73672868e+00 2.78265983e+00 1.04847853e+01
 2.00809894e-01 3.92162241e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.983524524672745
cond(S) = 85889.73446398148
E1 = -728.3194889105274  E_coul = 203.01470246691505
init E= -525.304786443612
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559043262351994  LUMO = 0.855180216019224
  mo_energy =
[-1.18078863e+02 -1.21662151e+01 -9.45702699e+00 -9.45702699e+00
 -9.45702699e+00 -1.22617952e+00 -5.59043262e-01 -5.59043262e-01
 -5.59043262e-01  8.55180216e-01  8.55180216e-01  8.55180216e-01
  6.32794682e+00  6.32794682e+00  6.32794682e+00  1.86337907e+01
  2.63193592e+01  2.63193592e+01  2.63193592e+01  9.77626910e+01
  9.77626910e+01  9.77626910e+01  2.39493000e+02  4.27818084e+02
  4.27818084e+02  4.27818084e+02  1.28046275e+03  1.28046275e+03
  1.28046275e+03  1.96331359e+03  2.98201085e+03  2.98201085e+03
  2.98201085e+03  6.61065727e+03  6.61065727e+03  6.61065727e+03
  8.31648680e+03  2.47017514e+04  7.54952088e+04]
E1 = -727.1035712591729  E_coul = 201.051608701695
cycle= 1 E= -526.051962557478  delta_E= -0.747  |g|= 0.216  |ddm|= 0.784
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.583642
diis-c [-0.34063753  1.        ]
  HOMO = -0.581828154660641  LUMO = 0.843667762694707
  mo_energy =
[-1.18406419e+02 -1.22947586e+01 -9.59918620e+00 -9.59918620e+00
 -9.59918620e+00 -1.25639949e+00 -5.81828155e-01 -5.81828155e-01
 -5.81828155e-01  8.43667763e-01  8.43667763e-01  8.43667763e-01
  6.25849422e+00  6.25849422e+00  6.25849422e+00  1.85080784e+01
  2.61887843e+01  2.61887843e+01  2.61887843e+01  9.75469068e+01
  9.75469068e+01  9.75469068e+01  2.39186915e+02  4.27490593e+02
  4.27490593e+02  4.27490593e+02  1.28006716e+03  1.28006716e+03
  1.28006716e+03  1.96276581e+03  2.98153694e+03  2.98153694e+03
  2.98153694e+03  6.61004403e+03  6.61004403e+03  6.61004403e+03
  8.31577659e+03  2.47009355e+04  7.54942933e+04]
E1 = -727.5821621083885  E_coul = 201.52949710941428
cycle= 2 E= -526.052664998974  delta_E= -0.000702  |g|= 0.0357  |ddm|= 0.0406
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0691024
diis-c [-0.00247133  0.07624555  0.92375445]
  HOMO = -0.57500191129547  LUMO = 0.847939790631232
  mo_energy =
[-1.18344754e+02 -1.22630591e+01 -9.56644169e+00 -9.56644169e+00
 -9.56644169e+00 -1.24768397e+00 -5.75001911e-01 -5.75001911e-01
 -5.75001911e-01  8.47939791e-01  8.47939791e-01  8.47939791e-01
  6.27564018e+00  6.27564018e+00  6.27564018e+00  1.85408414e+01
  2.62185035e+01  2.62185035e+01  2.62185035e+01  9.75933736e+01
  9.75933736e+01  9.75933736e+01  2.39245751e+02  4.27551507e+02
  4.27551507e+02  4.27551507e+02  1.28013227e+03  1.28013227e+03
  1.28013227e+03  1.96283370e+03  2.98160410e+03  2.98160410e+03
  2.98160410e+03  6.61011260e+03  6.61011260e+03  6.61011260e+03
  8.31584583e+03  2.47010051e+04  7.54943630e+04]
E1 = -727.48072984936  E_coul = 201.42803008688333
cycle= 3 E= -526.052699762477  delta_E= -3.48e-05  |g|= 0.00443  |ddm|= 0.00915
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00984787
diis-c [-7.44085278e-07 -1.43169081e-03  1.17513611e-01  8.83918079e-01]
  HOMO = -0.575854188392519  LUMO = 0.847417538744684
  mo_energy =
[-1.18351806e+02 -1.22667558e+01 -9.57041286e+00 -9.57041286e+00
 -9.57041286e+00 -1.24874163e+00 -5.75854188e-01 -5.75854188e-01
 -5.75854188e-01  8.47417539e-01  8.47417539e-01  8.47417539e-01
  6.27352350e+00  6.27352350e+00  6.27352350e+00  1.85371380e+01
  2.62148967e+01  2.62148967e+01  2.62148967e+01  9.75879663e+01
  9.75879663e+01  9.75879663e+01  2.39239023e+02  4.27544538e+02
  4.27544538e+02  4.27544538e+02  1.28012476e+03  1.28012476e+03
  1.28012476e+03  1.96282563e+03  2.98159624e+03  2.98159624e+03
  2.98159624e+03  6.61010437e+03  6.61010437e+03  6.61010437e+03
  8.31583737e+03  2.47009964e+04  7.54943543e+04]
E1 = -727.493093830749  E_coul = 201.44039341380918
cycle= 4 E= -526.05270041694  delta_E= -6.54e-07  |g|= 7.2e-05  |ddm|= 0.00113
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000180602
diis-c [-1.58676354e-09  7.95568940e-05 -8.18830673e-03 -7.87079775e-02
  1.08681673e+00]
  HOMO = -0.575843131610682  LUMO = 0.847424370236774
  mo_energy =
[-1.18351838e+02 -1.22667350e+01 -9.57040628e+00 -9.57040628e+00
 -9.57040628e+00 -1.24872604e+00 -5.75843132e-01 -5.75843132e-01
 -5.75843132e-01  8.47424370e-01  8.47424370e-01  8.47424370e-01
  6.27353986e+00  6.27353986e+00  6.27353986e+00  1.85371610e+01
  2.62149046e+01  2.62149046e+01  2.62149046e+01  9.75879574e+01
  9.75879574e+01  9.75879574e+01  2.39238996e+02  4.27544507e+02
  4.27544507e+02  4.27544507e+02  1.28012472e+03  1.28012472e+03
  1.28012472e+03  1.96282556e+03  2.98159618e+03  2.98159618e+03
  2.98159618e+03  6.61010430e+03  6.61010430e+03  6.61010430e+03
  8.31583728e+03  2.47009963e+04  7.54943542e+04]
E1 = -727.4931334013739  E_coul = 201.44043298432177
cycle= 5 E= -526.052700417052  delta_E= -1.12e-10  |g|= 7.37e-06  |ddm|= 1.16e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4931334013739  E_coul = 201.44043298432177
  HOMO = -0.575847003541507  LUMO = 0.8474220261358
  mo_energy =
[-1.18351855e+02 -1.22667479e+01 -9.57041956e+00 -9.57041956e+00
 -9.57041956e+00 -1.24873093e+00 -5.75847004e-01 -5.75847004e-01
 -5.75847004e-01  8.47422026e-01  8.47422026e-01  8.47422026e-01
  6.27353136e+00  6.27353136e+00  6.27353136e+00  1.85371483e+01
  2.62148924e+01  2.62148924e+01  2.62148924e+01  9.75879423e+01
  9.75879423e+01  9.75879423e+01  2.39238980e+02  4.27544490e+02
  4.27544490e+02  4.27544490e+02  1.28012470e+03  1.28012470e+03
  1.28012470e+03  1.96282554e+03  2.98159616e+03  2.98159616e+03
  2.98159616e+03  6.61010428e+03  6.61010428e+03  6.61010428e+03
  8.31583726e+03  2.47009963e+04  7.54943542e+04]
E1 = -727.4931691470047  E_coul = 201.44046872994932
Extra cycle  E= -526.052700417055  delta_E= -3.18e-12  |g|= 2.05e-06  |ddm|= 3.81e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.23 sec
exp = [2.61825081e+04 7.61824789e+03 3.61824504e+03 1.61816212e+03
 2.39548251e+02 5.58344190e+01 1.22919055e+01 3.83254519e+00
 3.97269675e-01 1.36279285e+03 6.65178252e+02 3.03307432e+02
 3.16134818e+02 4.92384974e+01 5.83275552e+00 1.51376452e+01
 6.60386317e-01 2.78265983e+00 2.00809894e-01]
E = -526.0527004170553
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:39:57 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.508117         1
[INPUT] 0    0    [1    /1   ]  7618.24788751        1
[INPUT] 0    0    [1    /1   ]  3618.24503689        1
[INPUT] 0    0    [1    /1   ]  1618.16212418        1
[INPUT] 0    0    [1    /1   ]  239.548251429        1
[INPUT] 0    0    [1    /1   ]  55.834418958         1
[INPUT] 0    0    [1    /1   ]  12.2919054941        1
[INPUT] 0    0    [1    /1   ]  3.83254519236        1
[INPUT] 0    0    [1    /1   ]  0.397269675412       1
[INPUT] 1    0    [1    /1   ]  1362.79285343        1
[INPUT] 1    0    [1    /1   ]  665.178252012        1
[INPUT] 1    0    [1    /1   ]  303.307432045        1
[INPUT] 1    0    [1    /1   ]  316.134817677        1
[INPUT] 1    0    [1    /1   ]  49.2384973538        1
[INPUT] 1    0    [1    /1   ]  5.83275552079        1
[INPUT] 1    0    [1    /1   ]  15.1376451953        1
[INPUT] 1    0    [1    /1   ]  0.660386317383       1
[INPUT] 1    0    [1    /1   ]  2.78265983056        1
[INPUT] 1    0    [1    /1   ]  0.200809893814       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.50811698666, 1.0]], [0, [7618.247887511734, 1.0]], [0, [3618.2450368946497, 1.0]], [0, [1618.1621241751006, 1.0]], [0, [239.5482514292616, 1.0]], [0, [55.83441895799775, 1.0]], [0, [12.291905494109713, 1.0]], [0, [3.832545192363573, 1.0]], [0, [0.39726967541167657, 1.0]], [1, [1362.7928534274013, 1.0]], [1, [665.1782520117367, 1.0]], [1, [303.30743204478, 1.0]], [1, [316.13481767730775, 1.0]], [1, [49.23849735378738, 1.0]], [1, [5.83275552079067, 1.0]], [1, [15.137645195281614, 1.0]], [1, [0.6603863173829578, 1.0]], [1, [2.782659830560761, 1.0]], [1, [0.2008098938142052, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50811699]
bas 1, expnt(s) = [7618.24788751]
bas 2, expnt(s) = [3618.24503689]
bas 3, expnt(s) = [1618.16212418]
bas 4, expnt(s) = [239.54825143]
bas 5, expnt(s) = [55.83441896]
bas 6, expnt(s) = [12.29190549]
bas 7, expnt(s) = [3.83254519]
bas 8, expnt(s) = [0.39726968]
bas 9, expnt(s) = [1362.79285343]
bas 10, expnt(s) = [665.17825201]
bas 11, expnt(s) = [303.30743204]
bas 12, expnt(s) = [316.13481768]
bas 13, expnt(s) = [49.23849735]
bas 14, expnt(s) = [5.83275552]
bas 15, expnt(s) = [15.1376452]
bas 16, expnt(s) = [0.66038632]
bas 17, expnt(s) = [2.78265983]
bas 18, expnt(s) = [0.20080989]
CPU time:       136.08
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825081e+04 5.20024086e+03 7.61824789e+03 2.06018561e+03
 3.61824504e+03 1.17865989e+03 1.61816212e+03 6.44587008e+02
 2.39548251e+02 1.53836637e+02 5.58344190e+01 5.16049694e+01
 1.22919055e+01 1.65855330e+01 3.83254519e+00 6.92038869e+00
 3.97269675e-01 1.26423872e+00 1.36279285e+03 2.41558154e+04
 6.65178252e+02 9.85500717e+03 3.03307432e+02 3.69265053e+03
 3.16134818e+02 3.88888235e+03 4.92384974e+01 3.80509392e+02
 5.83275552e+00 2.64439672e+01 1.51376452e+01 8.71078500e+01
 6.60386317e-01 1.73672868e+00 2.78265983e+00 1.04847853e+01
 2.00809894e-01 3.92162241e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.983524524672745
cond(S) = 85889.73446398148
E1 = -728.3194889105274  E_coul = 203.01470246691505
init E= -525.304786443612
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559043262351994  LUMO = 0.855180216019224
  mo_energy =
[-1.18078863e+02 -1.21662151e+01 -9.45702699e+00 -9.45702699e+00
 -9.45702699e+00 -1.22617952e+00 -5.59043262e-01 -5.59043262e-01
 -5.59043262e-01  8.55180216e-01  8.55180216e-01  8.55180216e-01
  6.32794682e+00  6.32794682e+00  6.32794682e+00  1.86337907e+01
  2.63193592e+01  2.63193592e+01  2.63193592e+01  9.77626910e+01
  9.77626910e+01  9.77626910e+01  2.39493000e+02  4.27818084e+02
  4.27818084e+02  4.27818084e+02  1.28046275e+03  1.28046275e+03
  1.28046275e+03  1.96331359e+03  2.98201085e+03  2.98201085e+03
  2.98201085e+03  6.61065727e+03  6.61065727e+03  6.61065727e+03
  8.31648680e+03  2.47017514e+04  7.54952088e+04]
E1 = -727.1035712591729  E_coul = 201.051608701695
cycle= 1 E= -526.051962557478  delta_E= -0.747  |g|= 0.216  |ddm|= 0.784
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.583642
diis-c [-0.34063753  1.        ]
  HOMO = -0.581828154660641  LUMO = 0.843667762694707
  mo_energy =
[-1.18406419e+02 -1.22947586e+01 -9.59918620e+00 -9.59918620e+00
 -9.59918620e+00 -1.25639949e+00 -5.81828155e-01 -5.81828155e-01
 -5.81828155e-01  8.43667763e-01  8.43667763e-01  8.43667763e-01
  6.25849422e+00  6.25849422e+00  6.25849422e+00  1.85080784e+01
  2.61887843e+01  2.61887843e+01  2.61887843e+01  9.75469068e+01
  9.75469068e+01  9.75469068e+01  2.39186915e+02  4.27490593e+02
  4.27490593e+02  4.27490593e+02  1.28006716e+03  1.28006716e+03
  1.28006716e+03  1.96276581e+03  2.98153694e+03  2.98153694e+03
  2.98153694e+03  6.61004403e+03  6.61004403e+03  6.61004403e+03
  8.31577659e+03  2.47009355e+04  7.54942933e+04]
E1 = -727.5821621083885  E_coul = 201.52949710941428
cycle= 2 E= -526.052664998974  delta_E= -0.000702  |g|= 0.0357  |ddm|= 0.0406
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0691024
diis-c [-0.00247133  0.07624555  0.92375445]
  HOMO = -0.57500191129547  LUMO = 0.847939790631232
  mo_energy =
[-1.18344754e+02 -1.22630591e+01 -9.56644169e+00 -9.56644169e+00
 -9.56644169e+00 -1.24768397e+00 -5.75001911e-01 -5.75001911e-01
 -5.75001911e-01  8.47939791e-01  8.47939791e-01  8.47939791e-01
  6.27564018e+00  6.27564018e+00  6.27564018e+00  1.85408414e+01
  2.62185035e+01  2.62185035e+01  2.62185035e+01  9.75933736e+01
  9.75933736e+01  9.75933736e+01  2.39245751e+02  4.27551507e+02
  4.27551507e+02  4.27551507e+02  1.28013227e+03  1.28013227e+03
  1.28013227e+03  1.96283370e+03  2.98160410e+03  2.98160410e+03
  2.98160410e+03  6.61011260e+03  6.61011260e+03  6.61011260e+03
  8.31584583e+03  2.47010051e+04  7.54943630e+04]
E1 = -727.48072984936  E_coul = 201.42803008688333
cycle= 3 E= -526.052699762477  delta_E= -3.48e-05  |g|= 0.00443  |ddm|= 0.00915
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00984787
diis-c [-7.44085278e-07 -1.43169081e-03  1.17513611e-01  8.83918079e-01]
  HOMO = -0.575854188392519  LUMO = 0.847417538744684
  mo_energy =
[-1.18351806e+02 -1.22667558e+01 -9.57041286e+00 -9.57041286e+00
 -9.57041286e+00 -1.24874163e+00 -5.75854188e-01 -5.75854188e-01
 -5.75854188e-01  8.47417539e-01  8.47417539e-01  8.47417539e-01
  6.27352350e+00  6.27352350e+00  6.27352350e+00  1.85371380e+01
  2.62148967e+01  2.62148967e+01  2.62148967e+01  9.75879663e+01
  9.75879663e+01  9.75879663e+01  2.39239023e+02  4.27544538e+02
  4.27544538e+02  4.27544538e+02  1.28012476e+03  1.28012476e+03
  1.28012476e+03  1.96282563e+03  2.98159624e+03  2.98159624e+03
  2.98159624e+03  6.61010437e+03  6.61010437e+03  6.61010437e+03
  8.31583737e+03  2.47009964e+04  7.54943543e+04]
E1 = -727.493093830749  E_coul = 201.44039341380918
cycle= 4 E= -526.05270041694  delta_E= -6.54e-07  |g|= 7.2e-05  |ddm|= 0.00113
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000180602
diis-c [-1.58676354e-09  7.95568940e-05 -8.18830673e-03 -7.87079775e-02
  1.08681673e+00]
  HOMO = -0.575843131610682  LUMO = 0.847424370236774
  mo_energy =
[-1.18351838e+02 -1.22667350e+01 -9.57040628e+00 -9.57040628e+00
 -9.57040628e+00 -1.24872604e+00 -5.75843132e-01 -5.75843132e-01
 -5.75843132e-01  8.47424370e-01  8.47424370e-01  8.47424370e-01
  6.27353986e+00  6.27353986e+00  6.27353986e+00  1.85371610e+01
  2.62149046e+01  2.62149046e+01  2.62149046e+01  9.75879574e+01
  9.75879574e+01  9.75879574e+01  2.39238996e+02  4.27544507e+02
  4.27544507e+02  4.27544507e+02  1.28012472e+03  1.28012472e+03
  1.28012472e+03  1.96282556e+03  2.98159618e+03  2.98159618e+03
  2.98159618e+03  6.61010430e+03  6.61010430e+03  6.61010430e+03
  8.31583728e+03  2.47009963e+04  7.54943542e+04]
E1 = -727.4931334013739  E_coul = 201.44043298432177
cycle= 5 E= -526.052700417052  delta_E= -1.12e-10  |g|= 7.37e-06  |ddm|= 1.16e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.4931334013739  E_coul = 201.44043298432177
  HOMO = -0.575847003541507  LUMO = 0.8474220261358
  mo_energy =
[-1.18351855e+02 -1.22667479e+01 -9.57041956e+00 -9.57041956e+00
 -9.57041956e+00 -1.24873093e+00 -5.75847004e-01 -5.75847004e-01
 -5.75847004e-01  8.47422026e-01  8.47422026e-01  8.47422026e-01
  6.27353136e+00  6.27353136e+00  6.27353136e+00  1.85371483e+01
  2.62148924e+01  2.62148924e+01  2.62148924e+01  9.75879423e+01
  9.75879423e+01  9.75879423e+01  2.39238980e+02  4.27544490e+02
  4.27544490e+02  4.27544490e+02  1.28012470e+03  1.28012470e+03
  1.28012470e+03  1.96282554e+03  2.98159616e+03  2.98159616e+03
  2.98159616e+03  6.61010428e+03  6.61010428e+03  6.61010428e+03
  8.31583726e+03  2.47009963e+04  7.54943542e+04]
E1 = -727.4931691470047  E_coul = 201.44046872994932
Extra cycle  E= -526.052700417055  delta_E= -3.18e-12  |g|= 2.05e-06  |ddm|= 3.81e-06
    CPU time for scf_cycle      0.61 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 85889.73446398148
E1 = -727.4931691470047  E_coul = 201.44046872994932
init E= -526.052700417055
    CPU time for initialize scf      2.70 sec, wall time      0.24 sec
  HOMO = -0.575846329436833  LUMO = 0.847422438135195
  mo_energy =
[-1.18351851e+02 -1.22667453e+01 -9.57041685e+00 -9.57041685e+00
 -9.57041685e+00 -1.24873009e+00 -5.75846329e-01 -5.75846329e-01
 -5.75846329e-01  8.47422438e-01  8.47422438e-01  8.47422438e-01
  6.27353293e+00  6.27353293e+00  6.27353293e+00  1.85371509e+01
  2.62148949e+01  2.62148949e+01  2.62148949e+01  9.75879457e+01
  9.75879457e+01  9.75879457e+01  2.39238984e+02  4.27544494e+02
  4.27544494e+02  4.27544494e+02  1.28012470e+03  1.28012470e+03
  1.28012470e+03  1.96282555e+03  2.98159617e+03  2.98159617e+03
  2.98159617e+03  6.61010428e+03  6.61010428e+03  6.61010428e+03
  8.31583727e+03  2.47009963e+04  7.54943542e+04]
E1 = -727.4931612605595  E_coul = 201.44046084350342
cycle= 1 E= -526.052700417056  delta_E= -7.96e-13  |g|= 5.05e-07  |ddm|= 7.62e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.4931612605595  E_coul = 201.44046084350342
  HOMO = -0.575846466063514  LUMO = 0.847422354117043
  mo_energy =
[-1.18351852e+02 -1.22667459e+01 -9.57041745e+00 -9.57041745e+00
 -9.57041745e+00 -1.24873026e+00 -5.75846466e-01 -5.75846466e-01
 -5.75846466e-01  8.47422354e-01  8.47422354e-01  8.47422354e-01
  6.27353260e+00  6.27353260e+00  6.27353260e+00  1.85371503e+01
  2.62148943e+01  2.62148943e+01  2.62148943e+01  9.75879449e+01
  9.75879449e+01  9.75879449e+01  2.39238983e+02  4.27544493e+02
  4.27544493e+02  4.27544493e+02  1.28012470e+03  1.28012470e+03
  1.28012470e+03  1.96282555e+03  2.98159617e+03  2.98159617e+03
  2.98159617e+03  6.61010428e+03  6.61010428e+03  6.61010428e+03
  8.31583727e+03  2.47009963e+04  7.54943542e+04]
E1 = -727.4931630460039  E_coul = 201.44046262894878
Extra cycle  E= -526.052700417055  delta_E= 1.02e-12  |g|= 1.19e-07  |ddm|= 1.67e-07
    CPU time for scf_cycle      3.04 sec, wall time      0.58 sec
exp = [2.61825081e+04 7.61824789e+03 3.61824504e+03 1.61816212e+03
 2.39548251e+02 5.58344190e+01 1.22919055e+01 3.83254519e+00
 3.97269675e-01 1.36279285e+03 6.65178252e+02 3.03307432e+02
 3.16134818e+02 4.92384974e+01 5.83275552e+00 1.51376452e+01
 6.60386317e-01 2.78265983e+00 2.00809894e-01]
grad_E = [-1.97069595e-06  2.39594812e-05  5.04399752e-05  7.50132053e-04
 -4.26005783e-03 -1.31283591e-02  3.47509449e-03 -7.03789166e-02
  6.42134972e-04  1.23171329e-06  1.92205275e-05  1.03162972e-04
  9.09048564e-05  2.65453735e-04 -1.78199499e-03 -8.51002852e-03
 -1.91206773e-01  3.29542892e-02  1.85507353e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:40:02 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5082267        1
[INPUT] 0    0    [1    /1   ]  7618.2466922         1
[INPUT] 0    0    [1    /1   ]  3618.24265979        1
[INPUT] 0    0    [1    /1   ]  1618.12551463        1
[INPUT] 0    0    [1    /1   ]  239.461856461        1
[INPUT] 0    0    [1    /1   ]  57.5349681713        1
[INPUT] 0    0    [1    /1   ]  15.1505982602        1
[INPUT] 0    0    [1    /1   ]  4.40421276994        1
[INPUT] 0    0    [1    /1   ]  0.393907893407       1
[INPUT] 1    0    [1    /1   ]  1362.79279436        1
[INPUT] 1    0    [1    /1   ]  665.177254346        1
[INPUT] 1    0    [1    /1   ]  303.30212102         1
[INPUT] 1    0    [1    /1   ]  316.130138084        1
[INPUT] 1    0    [1    /1   ]  49.1931523538        1
[INPUT] 1    0    [1    /1   ]  6.15452556897        1
[INPUT] 1    0    [1    /1   ]  15.4492843996        1
[INPUT] 1    0    [1    /1   ]  0.789811626289       1
[INPUT] 1    0    [1    /1   ]  3.37900546864        1
[INPUT] 1    0    [1    /1   ]  0.226728512944       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.508226673588, 1.0]], [0, [7618.24669219552, 1.0]], [0, [3618.2426597891267, 1.0]], [0, [1618.1255146319804, 1.0]], [0, [239.46185646086164, 1.0]], [0, [57.53496817130657, 1.0]], [0, [15.15059826024434, 1.0]], [0, [4.404212769939738, 1.0]], [0, [0.3939078934074941, 1.0]], [1, [1362.7927943551827, 1.0]], [1, [665.1772543456198, 1.0]], [1, [303.30212102034557, 1.0]], [1, [316.13013808377394, 1.0]], [1, [49.19315235384367, 1.0]], [1, [6.154525568965377, 1.0]], [1, [15.44928439960396, 1.0]], [1, [0.7898116262894386, 1.0]], [1, [3.379005468642991, 1.0]], [1, [0.2267285129441632, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50822667]
bas 1, expnt(s) = [7618.2466922]
bas 2, expnt(s) = [3618.24265979]
bas 3, expnt(s) = [1618.12551463]
bas 4, expnt(s) = [239.46185646]
bas 5, expnt(s) = [57.53496817]
bas 6, expnt(s) = [15.15059826]
bas 7, expnt(s) = [4.40421277]
bas 8, expnt(s) = [0.39390789]
bas 9, expnt(s) = [1362.79279436]
bas 10, expnt(s) = [665.17725435]
bas 11, expnt(s) = [303.30212102]
bas 12, expnt(s) = [316.13013808]
bas 13, expnt(s) = [49.19315235]
bas 14, expnt(s) = [6.15452557]
bas 15, expnt(s) = [15.4492844]
bas 16, expnt(s) = [0.78981163]
bas 17, expnt(s) = [3.37900547]
bas 18, expnt(s) = [0.22672851]
CPU time:       144.42
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825082e+04 5.20024088e+03 7.61824669e+03 2.06018537e+03
 3.61824266e+03 1.17865931e+03 1.61812551e+03 6.44576071e+02
 2.39461856e+02 1.53795024e+02 5.75349682e+01 5.27793372e+01
 1.51505983e+01 1.94015917e+01 4.40421277e+00 7.68097308e+00
 3.93907893e-01 1.25620650e+00 1.36279279e+03 2.41558141e+04
 6.65177254e+02 9.85498869e+03 3.03302121e+02 3.69256970e+03
 3.16130138e+02 3.88881039e+03 4.91931524e+01 3.80071417e+02
 6.15452557e+00 2.82798836e+01 1.54492844e+01 8.93552044e+01
 7.89811626e-01 2.17214491e+00 3.37900547e+00 1.33650476e+01
 2.26728513e-01 4.56422523e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97766835608908
cond(S) = 87097.7648382159
E1 = -728.4820645381368  E_coul = 203.1343578964184
init E= -525.347706641718
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559015257292066  LUMO = 1.06270592349156
  mo_energy =
[-1.18093482e+02 -1.21317691e+01 -9.44175105e+00 -9.44175105e+00
 -9.44175105e+00 -1.23119886e+00 -5.59015257e-01 -5.59015257e-01
 -5.59015257e-01  1.06270592e+00  1.06270592e+00  1.06270592e+00
  7.85933420e+00  7.85933420e+00  7.85933420e+00  2.51947884e+01
  2.97834062e+01  2.97834062e+01  2.97834062e+01  1.02270289e+02
  1.02270289e+02  1.02270289e+02  2.57640367e+02  4.31514700e+02
  4.31514700e+02  4.31514700e+02  1.28364925e+03  1.28364925e+03
  1.28364925e+03  1.98080732e+03  2.98493520e+03  2.98493520e+03
  2.98493520e+03  6.61330640e+03  6.61330640e+03  6.61330640e+03
  8.33224515e+03  2.47165956e+04  7.55089940e+04]
E1 = -727.8438617858847  E_coul = 201.79181018303396
cycle= 1 E= -526.052051602851  delta_E= -0.704  |g|= 0.176  |ddm|= 1.07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.491895
diis-c [-0.24196079  1.        ]
  HOMO = -0.576009194999456  LUMO = 1.05204953953164
  mo_energy =
[-1.18324386e+02 -1.22248757e+01 -9.53223142e+00 -9.53223142e+00
 -9.53223142e+00 -1.25628510e+00 -5.76009195e-01 -5.76009195e-01
 -5.76009195e-01  1.05204954e+00  1.05204954e+00  1.05204954e+00
  7.80607036e+00  7.80607036e+00  7.80607036e+00  2.50977702e+01
  2.96969861e+01  2.96969861e+01  2.96969861e+01  1.02127888e+02
  1.02127888e+02  1.02127888e+02  2.57427170e+02  4.31282453e+02
  4.31282453e+02  4.31282453e+02  1.28335563e+03  1.28335563e+03
  1.28335563e+03  1.98036497e+03  2.98456544e+03  2.98456544e+03
  2.98456544e+03  6.61279961e+03  6.61279961e+03  6.61279961e+03
  8.33164290e+03  2.47158886e+04  7.55081880e+04]
E1 = -728.1062950739627  E_coul = 202.05400803910274
cycle= 2 E= -526.05228703486  delta_E= -0.000235  |g|= 0.0203  |ddm|= 0.0223
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0431426
diis-c [-0.0014274  0.040741   0.959259 ]
  HOMO = -0.572426571793481  LUMO = 1.05491101346857
  mo_energy =
[-1.18287898e+02 -1.22070002e+01 -9.51355478e+00 -9.51355478e+00
 -9.51355478e+00 -1.25164553e+00 -5.72426572e-01 -5.72426572e-01
 -5.72426572e-01  1.05491101e+00  1.05491101e+00  1.05491101e+00
  7.81648360e+00  7.81648360e+00  7.81648360e+00  2.51181000e+01
  2.97142661e+01  2.97142661e+01  2.97142661e+01  1.02154850e+02
  1.02154850e+02  1.02154850e+02  2.57462028e+02  4.31318429e+02
  4.31318429e+02  4.31318429e+02  1.28339444e+03  1.28339444e+03
  1.28339444e+03  1.98040581e+03  2.98460570e+03  2.98460570e+03
  2.98460570e+03  6.61284094e+03  6.61284094e+03  6.61284094e+03
  8.33168473e+03  2.47159307e+04  7.55082302e+04]
E1 = -728.0479492889797  E_coul = 201.99565146472622
cycle= 3 E= -526.052297824253  delta_E= -1.08e-05  |g|= 0.00328  |ddm|= 0.00517
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00695705
diis-c [-6.58346057e-08 -9.20548689e-04  1.34887520e-01  8.66033028e-01]
  HOMO = -0.57306731516158  LUMO = 1.05440912999982
  mo_energy =
[-1.18293240e+02 -1.22098503e+01 -9.51651068e+00 -9.51651068e+00
 -9.51651068e+00 -1.25246984e+00 -5.73067315e-01 -5.73067315e-01
 -5.73067315e-01  1.05440913e+00  1.05440913e+00  1.05440913e+00
  7.81474746e+00  7.81474746e+00  7.81474746e+00  2.51149589e+01
  2.97115281e+01  2.97115281e+01  2.97115281e+01  1.02150785e+02
  1.02150785e+02  1.02150785e+02  2.57456916e+02  4.31313156e+02
  4.31313156e+02  4.31313156e+02  1.28338878e+03  1.28338878e+03
  1.28338878e+03  1.98039981e+03  2.98459982e+03  2.98459982e+03
  2.98459982e+03  6.61283484e+03  6.61283484e+03  6.61283484e+03
  8.33167851e+03  2.47159244e+04  7.55082239e+04]
E1 = -728.0569636614568  E_coul = 202.0046654968856
cycle= 4 E= -526.052298164571  delta_E= -3.4e-07  |g|= 4.21e-05  |ddm|= 0.000835
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.26212e-05
diis-c [-4.23518746e-10 -2.59200826e-05  3.72486259e-03  3.34794092e-02
  9.62821648e-01]
  HOMO = -0.57304822840451  LUMO = 1.0544237429544
  mo_energy =
[-1.18293159e+02 -1.22097862e+01 -9.51644580e+00 -9.51644580e+00
 -9.51644580e+00 -1.25244526e+00 -5.73048228e-01 -5.73048228e-01
 -5.73048228e-01  1.05442374e+00  1.05442374e+00  1.05442374e+00
  7.81479299e+00  7.81479299e+00  7.81479299e+00  2.51150252e+01
  2.97115890e+01  2.97115890e+01  2.97115890e+01  1.02150858e+02
  1.02150858e+02  1.02150858e+02  2.57456995e+02  4.31313236e+02
  4.31313236e+02  4.31313236e+02  1.28338886e+03  1.28338886e+03
  1.28338886e+03  1.98039989e+03  2.98459990e+03  2.98459990e+03
  2.98459990e+03  6.61283492e+03  6.61283492e+03  6.61283492e+03
  8.33167859e+03  2.47159245e+04  7.55082239e+04]
E1 = -728.0567936788478  E_coul = 202.00449551416887
cycle= 5 E= -526.052298164679  delta_E= -1.08e-10  |g|= 2.51e-06  |ddm|= 1.83e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.0567936788478  E_coul = 202.00449551416887
  HOMO = -0.573049480251368  LUMO = 1.05442279850537
  mo_energy =
[-1.18293165e+02 -1.22097906e+01 -9.51645021e+00 -9.51645021e+00
 -9.51645021e+00 -1.25244687e+00 -5.73049480e-01 -5.73049480e-01
 -5.73049480e-01  1.05442280e+00  1.05442280e+00  1.05442280e+00
  7.81479000e+00  7.81479000e+00  7.81479000e+00  2.51150208e+01
  2.97115849e+01  2.97115849e+01  2.97115849e+01  1.02150853e+02
  1.02150853e+02  1.02150853e+02  2.57456989e+02  4.31313230e+02
  4.31313230e+02  4.31313230e+02  1.28338886e+03  1.28338886e+03
  1.28338886e+03  1.98039989e+03  2.98459989e+03  2.98459989e+03
  2.98459989e+03  6.61283492e+03  6.61283492e+03  6.61283492e+03
  8.33167858e+03  2.47159245e+04  7.55082239e+04]
E1 = -728.056805933259  E_coul = 202.00450776857858
Extra cycle  E= -526.05229816468  delta_E= -1.48e-12  |g|= 7.02e-07  |ddm|= 1.35e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.23 sec
exp = [2.61825082e+04 7.61824669e+03 3.61824266e+03 1.61812551e+03
 2.39461856e+02 5.75349682e+01 1.51505983e+01 4.40421277e+00
 3.93907893e-01 1.36279279e+03 6.65177254e+02 3.03302121e+02
 3.16130138e+02 4.91931524e+01 6.15452557e+00 1.54492844e+01
 7.89811626e-01 3.37900547e+00 2.26728513e-01]
E = -526.0522981646805
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:40:02 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5081714        1
[INPUT] 0    0    [1    /1   ]  7618.24729413        1
[INPUT] 0    0    [1    /1   ]  3618.24385685        1
[INPUT] 0    0    [1    /1   ]  1618.14395039        1
[INPUT] 0    0    [1    /1   ]  239.505363056        1
[INPUT] 0    0    [1    /1   ]  56.6786091993        1
[INPUT] 0    0    [1    /1   ]  13.7110238102        1
[INPUT] 0    0    [1    /1   ]  4.11633362169        1
[INPUT] 0    0    [1    /1   ]  0.395600812471       1
[INPUT] 1    0    [1    /1   ]  1362.7928241         1
[INPUT] 1    0    [1    /1   ]  665.177756748        1
[INPUT] 1    0    [1    /1   ]  303.304795535        1
[INPUT] 1    0    [1    /1   ]  316.132494624        1
[INPUT] 1    0    [1    /1   ]  49.2159870929        1
[INPUT] 1    0    [1    /1   ]  5.99248928943        1
[INPUT] 1    0    [1    /1   ]  15.292349789         1
[INPUT] 1    0    [1    /1   ]  0.72463590328        1
[INPUT] 1    0    [1    /1   ]  3.07869899494        1
[INPUT] 1    0    [1    /1   ]  0.213676469604       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.50817143768, 1.0]], [0, [7618.247294130328, 1.0]], [0, [3618.2438568468924, 1.0]], [0, [1618.1439503881863, 1.0]], [0, [239.5053630561125, 1.0]], [0, [56.67860919927593, 1.0]], [0, [13.711023810178778, 1.0]], [0, [4.116333621694549, 1.0]], [0, [0.39560081247079554, 1.0]], [1, [1362.7928241026455, 1.0]], [1, [665.1777567482104, 1.0]], [1, [303.3047955347845, 1.0]], [1, [316.132494623577, 1.0]], [1, [49.2159870929001, 1.0]], [1, [5.9924892894336645, 1.0]], [1, [15.292349788967986, 1.0]], [1, [0.7246359032803721, 1.0]], [1, [3.0786989949424193, 1.0]], [1, [0.21367646960376638, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50817144]
bas 1, expnt(s) = [7618.24729413]
bas 2, expnt(s) = [3618.24385685]
bas 3, expnt(s) = [1618.14395039]
bas 4, expnt(s) = [239.50536306]
bas 5, expnt(s) = [56.6786092]
bas 6, expnt(s) = [13.71102381]
bas 7, expnt(s) = [4.11633362]
bas 8, expnt(s) = [0.39560081]
bas 9, expnt(s) = [1362.7928241]
bas 10, expnt(s) = [665.17775675]
bas 11, expnt(s) = [303.30479553]
bas 12, expnt(s) = [316.13249462]
bas 13, expnt(s) = [49.21598709]
bas 14, expnt(s) = [5.99248929]
bas 15, expnt(s) = [15.29234979]
bas 16, expnt(s) = [0.7246359]
bas 17, expnt(s) = [3.07869899]
bas 18, expnt(s) = [0.21367647]
CPU time:       145.12
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825082e+04 5.20024087e+03 7.61824729e+03 2.06018549e+03
 3.61824386e+03 1.17865960e+03 1.61814395e+03 6.44581579e+02
 2.39505363e+02 1.53815980e+02 5.66786092e+01 5.21890526e+01
 1.37110238e+01 1.80018624e+01 4.11633362e+00 7.30126227e+00
 3.95600812e-01 1.26025348e+00 1.36279282e+03 2.41558147e+04
 6.65177757e+02 9.85499800e+03 3.03304796e+02 3.69261040e+03
 3.16132495e+02 3.88884663e+03 4.92159871e+01 3.80291959e+02
 5.99248929e+00 2.73522763e+01 1.52923498e+01 8.82220554e+01
 7.24635903e-01 1.95044722e+00 3.07869899e+00 1.18971635e+01
 2.13676470e-01 4.23818848e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.981605240880555
cond(S) = 86474.23546516306
E1 = -728.4329769610382  E_coul = 203.07039107851162
init E= -525.362585882527
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558837607334601  LUMO = 0.955697236939365
  mo_energy =
[-1.18088986e+02 -1.21537963e+01 -9.45037095e+00 -9.45037095e+00
 -9.45037095e+00 -1.22854639e+00 -5.58837607e-01 -5.58837607e-01
 -5.58837607e-01  9.55697237e-01  9.55697237e-01  9.55697237e-01
  7.09009557e+00  7.09009557e+00  7.09009557e+00  2.18406281e+01
  2.80473239e+01  2.80473239e+01  2.80473239e+01  9.99930466e+01
  9.99930466e+01  9.99930466e+01  2.48535119e+02  4.29637479e+02
  4.29637479e+02  4.29637479e+02  1.28202994e+03  1.28202994e+03
  1.28202994e+03  1.97196566e+03  2.98344858e+03  2.98344858e+03
  2.98344858e+03  6.61195932e+03  6.61195932e+03  6.61195932e+03
  8.32427373e+03  2.47090852e+04  7.55020188e+04]
E1 = -727.4550480452579  E_coul = 201.38767158605916
cycle= 1 E= -526.067376459199  delta_E= -0.705  |g|= 0.196  |ddm|= 0.81
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.542278
diis-c [-0.29406522  1.        ]
  HOMO = -0.579308333654424  LUMO = 0.943838696051607
  mo_energy =
[-1.18373610e+02 -1.22655140e+01 -9.56878747e+00 -9.56878747e+00
 -9.56878747e+00 -1.25672791e+00 -5.79308334e-01 -5.79308334e-01
 -5.79308334e-01  9.43838696e-01  9.43838696e-01  9.43838696e-01
  7.02685192e+00  7.02685192e+00  7.02685192e+00  2.17259950e+01
  2.79365952e+01  2.79365952e+01  2.79365952e+01  9.98104507e+01
  9.98104507e+01  9.98104507e+01  2.48270246e+02  4.29352332e+02
  4.29352332e+02  4.29352332e+02  1.28167921e+03  1.28167921e+03
  1.28167921e+03  1.97146350e+03  2.98302009e+03  2.98302009e+03
  2.98302009e+03  6.61139185e+03  6.61139185e+03  6.61139185e+03
  8.32360955e+03  2.47083154e+04  7.55011494e+04]
E1 = -727.8339177747341  E_coul = 201.76608848235355
cycle= 2 E= -526.067829292381  delta_E= -0.000453  |g|= 0.0287  |ddm|= 0.0314
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0575979
diis-c [-0.00204042  0.06202853  0.93797147]
  HOMO = -0.574006131520269  LUMO = 0.947599637097354
  mo_energy =
[-1.18323244e+02 -1.22400864e+01 -9.54245555e+00 -9.54245555e+00
 -9.54245555e+00 -1.24990739e+00 -5.74006132e-01 -5.74006132e-01
 -5.74006132e-01  9.47599637e-01  9.47599637e-01  9.47599637e-01
  7.04114596e+00  7.04114596e+00  7.04114596e+00  2.17536476e+01
  2.79607155e+01  2.79607155e+01  2.79607155e+01  9.98480883e+01
  9.98480883e+01  9.98480883e+01  2.48318330e+02  4.29402044e+02
  4.29402044e+02  4.29402044e+02  1.28173253e+03  1.28173253e+03
  1.28173253e+03  1.97151926e+03  2.98307518e+03  2.98307518e+03
  2.98307518e+03  6.61144821e+03  6.61144821e+03  6.61144821e+03
  8.32366649e+03  2.47083727e+04  7.55012067e+04]
E1 = -727.7519605577585  E_coul = 201.68410920569735
cycle= 3 E= -526.067851352061  delta_E= -2.21e-05  |g|= 0.00396  |ddm|= 0.00736
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00863992
diis-c [-2.80454603e-07 -1.17763839e-03  1.24766515e-01  8.76411123e-01]
  HOMO = -0.574794057550253  LUMO = 0.947051038683431
  mo_energy =
[-1.18329649e+02 -1.22434933e+01 -9.54605218e+00 -9.54605218e+00
 -9.54605218e+00 -1.25090165e+00 -5.74794058e-01 -5.74794058e-01
 -5.74794058e-01  9.47051039e-01  9.47051039e-01  9.47051039e-01
  7.03911247e+00  7.03911247e+00  7.03911247e+00  2.17500571e+01
  2.79574142e+01  2.79574142e+01  2.79574142e+01  9.98431848e+01
  9.98431848e+01  9.98431848e+01  2.48312207e+02  4.29395717e+02
  4.29395717e+02  4.29395717e+02  1.28172573e+03  1.28172573e+03
  1.28172573e+03  1.97151199e+03  2.98306808e+03  2.98306808e+03
  2.98306808e+03  6.61144081e+03  6.61144081e+03  6.61144081e+03
  8.32365891e+03  2.47083649e+04  7.55011989e+04]
E1 = -727.7630224607087  E_coul = 201.69517059224628
cycle= 4 E= -526.067851868462  delta_E= -5.16e-07  |g|= 3.76e-05  |ddm|= 0.00102
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=6.64007e-05
diis-c [-1.50221713e-09  5.28291190e-05 -6.72547068e-03 -5.23552303e-02
  1.05902787e+00]
  HOMO = -0.574777215617675  LUMO = 0.947062562591651
  mo_energy =
[-1.18329616e+02 -1.22434437e+01 -9.54600885e+00 -9.54600885e+00
 -9.54600885e+00 -1.25087941e+00 -5.74777216e-01 -5.74777216e-01
 -5.74777216e-01  9.47062563e-01  9.47062563e-01  9.47062563e-01
  7.03914731e+00  7.03914731e+00  7.03914731e+00  2.17501074e+01
  2.79574553e+01  2.79574553e+01  2.79574553e+01  9.98432252e+01
  9.98432252e+01  9.98432252e+01  2.48312241e+02  4.29395750e+02
  4.29395750e+02  4.29395750e+02  1.28172575e+03  1.28172575e+03
  1.28172575e+03  1.97151200e+03  2.98306810e+03  2.98306810e+03
  2.98306810e+03  6.61144082e+03  6.61144082e+03  6.61144082e+03
  8.32365892e+03  2.47083649e+04  7.55011989e+04]
E1 = -727.7629333207716  E_coul = 201.6950814522673
cycle= 5 E= -526.067851868504  delta_E= -4.18e-11  |g|= 7.65e-06  |ddm|= 1.29e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -727.7629333207716  E_coul = 201.6950814522673
  HOMO = -0.574781031866049  LUMO = 0.947059958234485
  mo_energy =
[-1.18329634e+02 -1.22434568e+01 -9.54602228e+00 -9.54602228e+00
 -9.54602228e+00 -1.25088426e+00 -5.74781032e-01 -5.74781032e-01
 -5.74781032e-01  9.47059958e-01  9.47059958e-01  9.47059958e-01
  7.03913848e+00  7.03913848e+00  7.03913848e+00  2.17500943e+01
  2.79574428e+01  2.79574428e+01  2.79574428e+01  9.98432097e+01
  9.98432097e+01  9.98432097e+01  2.48312224e+02  4.29395732e+02
  4.29395732e+02  4.29395732e+02  1.28172574e+03  1.28172574e+03
  1.28172574e+03  1.97151199e+03  2.98306808e+03  2.98306808e+03
  2.98306808e+03  6.61144080e+03  6.61144080e+03  6.61144080e+03
  8.32365890e+03  2.47083649e+04  7.55011989e+04]
E1 = -727.7629702012549  E_coul = 201.6951183327458
Extra cycle  E= -526.067851868509  delta_E= -4.89e-12  |g|= 2.12e-06  |ddm|= 3.91e-06
    CPU time for scf_cycle      0.68 sec, wall time      0.29 sec
exp = [2.61825082e+04 7.61824729e+03 3.61824386e+03 1.61814395e+03
 2.39505363e+02 5.66786092e+01 1.37110238e+01 4.11633362e+00
 3.95600812e-01 1.36279282e+03 6.65177757e+02 3.03304796e+02
 3.16132495e+02 4.92159871e+01 5.99248929e+00 1.52923498e+01
 7.24635903e-01 3.07869899e+00 2.13676470e-01]
E = -526.0678518685091
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:40:02 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5081714        1
[INPUT] 0    0    [1    /1   ]  7618.24729413        1
[INPUT] 0    0    [1    /1   ]  3618.24385685        1
[INPUT] 0    0    [1    /1   ]  1618.14395039        1
[INPUT] 0    0    [1    /1   ]  239.505363056        1
[INPUT] 0    0    [1    /1   ]  56.6786091993        1
[INPUT] 0    0    [1    /1   ]  13.7110238102        1
[INPUT] 0    0    [1    /1   ]  4.11633362169        1
[INPUT] 0    0    [1    /1   ]  0.395600812471       1
[INPUT] 1    0    [1    /1   ]  1362.7928241         1
[INPUT] 1    0    [1    /1   ]  665.177756748        1
[INPUT] 1    0    [1    /1   ]  303.304795535        1
[INPUT] 1    0    [1    /1   ]  316.132494624        1
[INPUT] 1    0    [1    /1   ]  49.2159870929        1
[INPUT] 1    0    [1    /1   ]  5.99248928943        1
[INPUT] 1    0    [1    /1   ]  15.292349789         1
[INPUT] 1    0    [1    /1   ]  0.72463590328        1
[INPUT] 1    0    [1    /1   ]  3.07869899494        1
[INPUT] 1    0    [1    /1   ]  0.213676469604       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.50817143768, 1.0]], [0, [7618.247294130328, 1.0]], [0, [3618.2438568468924, 1.0]], [0, [1618.1439503881863, 1.0]], [0, [239.5053630561125, 1.0]], [0, [56.67860919927593, 1.0]], [0, [13.711023810178778, 1.0]], [0, [4.116333621694549, 1.0]], [0, [0.39560081247079554, 1.0]], [1, [1362.7928241026455, 1.0]], [1, [665.1777567482104, 1.0]], [1, [303.3047955347845, 1.0]], [1, [316.132494623577, 1.0]], [1, [49.2159870929001, 1.0]], [1, [5.9924892894336645, 1.0]], [1, [15.292349788967986, 1.0]], [1, [0.7246359032803721, 1.0]], [1, [3.0786989949424193, 1.0]], [1, [0.21367646960376638, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50817144]
bas 1, expnt(s) = [7618.24729413]
bas 2, expnt(s) = [3618.24385685]
bas 3, expnt(s) = [1618.14395039]
bas 4, expnt(s) = [239.50536306]
bas 5, expnt(s) = [56.6786092]
bas 6, expnt(s) = [13.71102381]
bas 7, expnt(s) = [4.11633362]
bas 8, expnt(s) = [0.39560081]
bas 9, expnt(s) = [1362.7928241]
bas 10, expnt(s) = [665.17775675]
bas 11, expnt(s) = [303.30479553]
bas 12, expnt(s) = [316.13249462]
bas 13, expnt(s) = [49.21598709]
bas 14, expnt(s) = [5.99248929]
bas 15, expnt(s) = [15.29234979]
bas 16, expnt(s) = [0.7246359]
bas 17, expnt(s) = [3.07869899]
bas 18, expnt(s) = [0.21367647]
CPU time:       145.88
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825082e+04 5.20024087e+03 7.61824729e+03 2.06018549e+03
 3.61824386e+03 1.17865960e+03 1.61814395e+03 6.44581579e+02
 2.39505363e+02 1.53815980e+02 5.66786092e+01 5.21890526e+01
 1.37110238e+01 1.80018624e+01 4.11633362e+00 7.30126227e+00
 3.95600812e-01 1.26025348e+00 1.36279282e+03 2.41558147e+04
 6.65177757e+02 9.85499800e+03 3.03304796e+02 3.69261040e+03
 3.16132495e+02 3.88884663e+03 4.92159871e+01 3.80291959e+02
 5.99248929e+00 2.73522763e+01 1.52923498e+01 8.82220554e+01
 7.24635903e-01 1.95044722e+00 3.07869899e+00 1.18971635e+01
 2.13676470e-01 4.23818848e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.981605240880555
cond(S) = 86474.23546516306
E1 = -728.4329769610382  E_coul = 203.07039107851162
init E= -525.362585882527
    CPU time for initialize scf      0.45 sec, wall time      0.05 sec
  HOMO = -0.558837607334601  LUMO = 0.955697236939365
  mo_energy =
[-1.18088986e+02 -1.21537963e+01 -9.45037095e+00 -9.45037095e+00
 -9.45037095e+00 -1.22854639e+00 -5.58837607e-01 -5.58837607e-01
 -5.58837607e-01  9.55697237e-01  9.55697237e-01  9.55697237e-01
  7.09009557e+00  7.09009557e+00  7.09009557e+00  2.18406281e+01
  2.80473239e+01  2.80473239e+01  2.80473239e+01  9.99930466e+01
  9.99930466e+01  9.99930466e+01  2.48535119e+02  4.29637479e+02
  4.29637479e+02  4.29637479e+02  1.28202994e+03  1.28202994e+03
  1.28202994e+03  1.97196566e+03  2.98344858e+03  2.98344858e+03
  2.98344858e+03  6.61195932e+03  6.61195932e+03  6.61195932e+03
  8.32427373e+03  2.47090852e+04  7.55020188e+04]
E1 = -727.4550480452579  E_coul = 201.38767158605916
cycle= 1 E= -526.067376459199  delta_E= -0.705  |g|= 0.196  |ddm|= 0.81
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.542278
diis-c [-0.29406522  1.        ]
  HOMO = -0.579308333654424  LUMO = 0.943838696051607
  mo_energy =
[-1.18373610e+02 -1.22655140e+01 -9.56878747e+00 -9.56878747e+00
 -9.56878747e+00 -1.25672791e+00 -5.79308334e-01 -5.79308334e-01
 -5.79308334e-01  9.43838696e-01  9.43838696e-01  9.43838696e-01
  7.02685192e+00  7.02685192e+00  7.02685192e+00  2.17259950e+01
  2.79365952e+01  2.79365952e+01  2.79365952e+01  9.98104507e+01
  9.98104507e+01  9.98104507e+01  2.48270246e+02  4.29352332e+02
  4.29352332e+02  4.29352332e+02  1.28167921e+03  1.28167921e+03
  1.28167921e+03  1.97146350e+03  2.98302009e+03  2.98302009e+03
  2.98302009e+03  6.61139185e+03  6.61139185e+03  6.61139185e+03
  8.32360955e+03  2.47083154e+04  7.55011494e+04]
E1 = -727.8339177747341  E_coul = 201.76608848235355
cycle= 2 E= -526.067829292381  delta_E= -0.000453  |g|= 0.0287  |ddm|= 0.0314
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0575979
diis-c [-0.00204042  0.06202853  0.93797147]
  HOMO = -0.574006131520269  LUMO = 0.947599637097354
  mo_energy =
[-1.18323244e+02 -1.22400864e+01 -9.54245555e+00 -9.54245555e+00
 -9.54245555e+00 -1.24990739e+00 -5.74006132e-01 -5.74006132e-01
 -5.74006132e-01  9.47599637e-01  9.47599637e-01  9.47599637e-01
  7.04114596e+00  7.04114596e+00  7.04114596e+00  2.17536476e+01
  2.79607155e+01  2.79607155e+01  2.79607155e+01  9.98480883e+01
  9.98480883e+01  9.98480883e+01  2.48318330e+02  4.29402044e+02
  4.29402044e+02  4.29402044e+02  1.28173253e+03  1.28173253e+03
  1.28173253e+03  1.97151926e+03  2.98307518e+03  2.98307518e+03
  2.98307518e+03  6.61144821e+03  6.61144821e+03  6.61144821e+03
  8.32366649e+03  2.47083727e+04  7.55012067e+04]
E1 = -727.7519605577585  E_coul = 201.68410920569735
cycle= 3 E= -526.067851352061  delta_E= -2.21e-05  |g|= 0.00396  |ddm|= 0.00736
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00863992
diis-c [-2.80454603e-07 -1.17763839e-03  1.24766515e-01  8.76411123e-01]
  HOMO = -0.574794057550253  LUMO = 0.947051038683431
  mo_energy =
[-1.18329649e+02 -1.22434933e+01 -9.54605218e+00 -9.54605218e+00
 -9.54605218e+00 -1.25090165e+00 -5.74794058e-01 -5.74794058e-01
 -5.74794058e-01  9.47051039e-01  9.47051039e-01  9.47051039e-01
  7.03911247e+00  7.03911247e+00  7.03911247e+00  2.17500571e+01
  2.79574142e+01  2.79574142e+01  2.79574142e+01  9.98431848e+01
  9.98431848e+01  9.98431848e+01  2.48312207e+02  4.29395717e+02
  4.29395717e+02  4.29395717e+02  1.28172573e+03  1.28172573e+03
  1.28172573e+03  1.97151199e+03  2.98306808e+03  2.98306808e+03
  2.98306808e+03  6.61144081e+03  6.61144081e+03  6.61144081e+03
  8.32365891e+03  2.47083649e+04  7.55011989e+04]
E1 = -727.7630224607087  E_coul = 201.69517059224628
cycle= 4 E= -526.067851868462  delta_E= -5.16e-07  |g|= 3.76e-05  |ddm|= 0.00102
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.64007e-05
diis-c [-1.50221713e-09  5.28291190e-05 -6.72547068e-03 -5.23552303e-02
  1.05902787e+00]
  HOMO = -0.574777215617675  LUMO = 0.947062562591651
  mo_energy =
[-1.18329616e+02 -1.22434437e+01 -9.54600885e+00 -9.54600885e+00
 -9.54600885e+00 -1.25087941e+00 -5.74777216e-01 -5.74777216e-01
 -5.74777216e-01  9.47062563e-01  9.47062563e-01  9.47062563e-01
  7.03914731e+00  7.03914731e+00  7.03914731e+00  2.17501074e+01
  2.79574553e+01  2.79574553e+01  2.79574553e+01  9.98432252e+01
  9.98432252e+01  9.98432252e+01  2.48312241e+02  4.29395750e+02
  4.29395750e+02  4.29395750e+02  1.28172575e+03  1.28172575e+03
  1.28172575e+03  1.97151200e+03  2.98306810e+03  2.98306810e+03
  2.98306810e+03  6.61144082e+03  6.61144082e+03  6.61144082e+03
  8.32365892e+03  2.47083649e+04  7.55011989e+04]
E1 = -727.7629333207716  E_coul = 201.6950814522673
cycle= 5 E= -526.067851868504  delta_E= -4.18e-11  |g|= 7.65e-06  |ddm|= 1.29e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.7629333207716  E_coul = 201.6950814522673
  HOMO = -0.574781031866049  LUMO = 0.947059958234485
  mo_energy =
[-1.18329634e+02 -1.22434568e+01 -9.54602228e+00 -9.54602228e+00
 -9.54602228e+00 -1.25088426e+00 -5.74781032e-01 -5.74781032e-01
 -5.74781032e-01  9.47059958e-01  9.47059958e-01  9.47059958e-01
  7.03913848e+00  7.03913848e+00  7.03913848e+00  2.17500943e+01
  2.79574428e+01  2.79574428e+01  2.79574428e+01  9.98432097e+01
  9.98432097e+01  9.98432097e+01  2.48312224e+02  4.29395732e+02
  4.29395732e+02  4.29395732e+02  1.28172574e+03  1.28172574e+03
  1.28172574e+03  1.97151199e+03  2.98306808e+03  2.98306808e+03
  2.98306808e+03  6.61144080e+03  6.61144080e+03  6.61144080e+03
  8.32365890e+03  2.47083649e+04  7.55011989e+04]
E1 = -727.7629702012549  E_coul = 201.6951183327458
Extra cycle  E= -526.067851868509  delta_E= -4.89e-12  |g|= 2.12e-06  |ddm|= 3.91e-06
    CPU time for scf_cycle      0.67 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 86474.23546516306
E1 = -727.7629702012549  E_coul = 201.6951183327458
init E= -526.067851868509
    CPU time for initialize scf      2.73 sec, wall time      0.25 sec
  HOMO = -0.574780339841489  LUMO = 0.947060436526487
  mo_energy =
[-1.18329630e+02 -1.22434541e+01 -9.54601950e+00 -9.54601950e+00
 -9.54601950e+00 -1.25088338e+00 -5.74780340e-01 -5.74780340e-01
 -5.74780340e-01  9.47060437e-01  9.47060437e-01  9.47060437e-01
  7.03914017e+00  7.03914017e+00  7.03914017e+00  2.17500971e+01
  2.79574454e+01  2.79574454e+01  2.79574454e+01  9.98432132e+01
  9.98432132e+01  9.98432132e+01  2.48312228e+02  4.29395736e+02
  4.29395736e+02  4.29395736e+02  1.28172574e+03  1.28172574e+03
  1.28172574e+03  1.97151199e+03  2.98306809e+03  2.98306809e+03
  2.98306809e+03  6.61144080e+03  6.61144080e+03  6.61144080e+03
  8.32365890e+03  2.47083649e+04  7.55011989e+04]
E1 = -727.7629620941199  E_coul = 201.69511022561178
cycle= 1 E= -526.067851868508  delta_E= 1.02e-12  |g|= 5.13e-07  |ddm|= 7.89e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.7629620941199  E_coul = 201.69511022561178
  HOMO = -0.574780480777002  LUMO = 0.947060338533722
  mo_energy =
[-1.18329631e+02 -1.22434547e+01 -9.54602011e+00 -9.54602011e+00
 -9.54602011e+00 -1.25088356e+00 -5.74780481e-01 -5.74780481e-01
 -5.74780481e-01  9.47060339e-01  9.47060339e-01  9.47060339e-01
  7.03913981e+00  7.03913981e+00  7.03913981e+00  2.17500965e+01
  2.79574448e+01  2.79574448e+01  2.79574448e+01  9.98432124e+01
  9.98432124e+01  9.98432124e+01  2.48312227e+02  4.29395735e+02
  4.29395735e+02  4.29395735e+02  1.28172574e+03  1.28172574e+03
  1.28172574e+03  1.97151199e+03  2.98306809e+03  2.98306809e+03
  2.98306809e+03  6.61144080e+03  6.61144080e+03  6.61144080e+03
  8.32365890e+03  2.47083649e+04  7.55011989e+04]
E1 = -727.7629639196228  E_coul = 201.6951120511149
Extra cycle  E= -526.067851868508  delta_E= 2.27e-13  |g|= 1.2e-07  |ddm|= 1.72e-07
    CPU time for scf_cycle      2.87 sec, wall time      0.39 sec
exp = [2.61825082e+04 7.61824729e+03 3.61824386e+03 1.61814395e+03
 2.39505363e+02 5.66786092e+01 1.37110238e+01 4.11633362e+00
 3.95600812e-01 1.36279282e+03 6.65177757e+02 3.03304796e+02
 3.16132495e+02 4.92159871e+01 5.99248929e+00 1.52923498e+01
 7.24635903e-01 3.07869899e+00 2.13676470e-01]
grad_E = [-1.96884047e-06  2.44155752e-05  5.18989489e-05  7.66935192e-04
 -5.14700970e-03 -1.27178753e-02 -9.53110955e-05  1.66998952e-02
 -2.18083500e-03  1.44696640e-06  2.07758838e-05  1.12734969e-04
  9.93347081e-05 -1.01210727e-03 -1.24577445e-02 -1.23819663e-03
 -7.96447216e-02  3.84453283e-02  4.82934013e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:40:07 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5081893        1
[INPUT] 0    0    [1    /1   ]  7618.24709633        1
[INPUT] 0    0    [1    /1   ]  3618.24346008        1
[INPUT] 0    0    [1    /1   ]  1618.13787284        1
[INPUT] 0    0    [1    /1   ]  239.497927453        1
[INPUT] 0    0    [1    /1   ]  56.9469001045        1
[INPUT] 0    0    [1    /1   ]  14.1199826194        1
[INPUT] 0    0    [1    /1   ]  4.12161993197        1
[INPUT] 0    0    [1    /1   ]  0.396070869642       1
[INPUT] 1    0    [1    /1   ]  1362.79281423        1
[INPUT] 1    0    [1    /1   ]  665.177592386        1
[INPUT] 1    0    [1    /1   ]  303.303919417        1
[INPUT] 1    0    [1    /1   ]  316.131722639        1
[INPUT] 1    0    [1    /1   ]  49.209252487         1
[INPUT] 1    0    [1    /1   ]  6.05215324484        1
[INPUT] 1    0    [1    /1   ]  15.3462548652        1
[INPUT] 1    0    [1    /1   ]  0.756379678648       1
[INPUT] 1    0    [1    /1   ]  3.12535288183        1
[INPUT] 1    0    [1    /1   ]  0.224470096032       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.508189311746, 1.0]], [0, [7618.247096328777, 1.0]], [0, [3618.2434600757324, 1.0]], [0, [1618.1378728358895, 1.0]], [0, [239.49792745260663, 1.0]], [0, [56.94690010449784, 1.0]], [0, [14.119982619444682, 1.0]], [0, [4.121619931969678, 1.0]], [0, [0.39607086964211324, 1.0]], [1, [1362.7928142333576, 1.0]], [1, [665.1775923860818, 1.0]], [1, [303.30391941659855, 1.0]], [1, [316.1317226388017, 1.0]], [1, [49.209252487034675, 1.0]], [1, [6.052153244844818, 1.0]], [1, [15.346254865238699, 1.0]], [1, [0.756379678648166, 1.0]], [1, [3.125352881832979, 1.0]], [1, [0.22447009603171905, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50818931]
bas 1, expnt(s) = [7618.24709633]
bas 2, expnt(s) = [3618.24346008]
bas 3, expnt(s) = [1618.13787284]
bas 4, expnt(s) = [239.49792745]
bas 5, expnt(s) = [56.9469001]
bas 6, expnt(s) = [14.11998262]
bas 7, expnt(s) = [4.12161993]
bas 8, expnt(s) = [0.39607087]
bas 9, expnt(s) = [1362.79281423]
bas 10, expnt(s) = [665.17759239]
bas 11, expnt(s) = [303.30391942]
bas 12, expnt(s) = [316.13172264]
bas 13, expnt(s) = [49.20925249]
bas 14, expnt(s) = [6.05215324]
bas 15, expnt(s) = [15.34625487]
bas 16, expnt(s) = [0.75637968]
bas 17, expnt(s) = [3.12535288]
bas 18, expnt(s) = [0.2244701]
CPU time:       154.18
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825082e+04 5.20024087e+03 7.61824710e+03 2.06018545e+03
 3.61824346e+03 1.17865951e+03 1.61813787e+03 6.44579763e+02
 2.39497927e+02 1.53812398e+02 5.69469001e+01 5.23742227e+01
 1.41199826e+01 1.84030856e+01 4.12161993e+00 7.30829350e+00
 3.96070870e-01 1.26137640e+00 1.36279281e+03 2.41558145e+04
 6.65177592e+02 9.85499495e+03 3.03303919e+02 3.69259707e+03
 3.16131723e+02 3.88883476e+03 4.92092525e+01 3.80226912e+02
 6.05215324e+00 2.76931136e+01 1.53462549e+01 8.86109516e+01
 7.56379679e-01 2.05782864e+00 3.12535288e+00 1.21229473e+01
 2.24470096e-01 4.50746650e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.980106650115793
cond(S) = 86652.28184395457
E1 = -728.4300190147768  E_coul = 203.07776049793182
init E= -525.352258516845
    CPU time for initialize scf      0.46 sec, wall time      0.05 sec
  HOMO = -0.5584598728352  LUMO = 1.0239128058035
  mo_energy =
[-1.18091363e+02 -1.21521211e+01 -9.45003046e+00 -9.45003046e+00
 -9.45003046e+00 -1.22798691e+00 -5.58459873e-01 -5.58459873e-01
 -5.58459873e-01  1.02391281e+00  1.02391281e+00  1.02391281e+00
  7.33886814e+00  7.33886814e+00  7.33886814e+00  2.25107449e+01
  2.85219033e+01  2.85219033e+01  2.85219033e+01  1.00629475e+02
  1.00629475e+02  1.00629475e+02  2.50884448e+02  4.30171464e+02
  4.30171464e+02  4.30171464e+02  1.28249189e+03  1.28249189e+03
  1.28249189e+03  1.97433238e+03  2.98387220e+03  2.98387220e+03
  2.98387220e+03  6.61234277e+03  6.61234277e+03  6.61234277e+03
  8.32641598e+03  2.47111040e+04  7.55038935e+04]
E1 = -727.553982584861  E_coul = 201.48311013786434
cycle= 1 E= -526.070872446997  delta_E= -0.719  |g|= 0.197  |ddm|= 0.81
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.545721
diis-c [-0.29781181  1.        ]
  HOMO = -0.576137191159239  LUMO = 1.01311708708091
  mo_energy =
[-1.18369678e+02 -1.22569645e+01 -9.56214602e+00 -9.56214602e+00
 -9.56214602e+00 -1.25266070e+00 -5.76137191e-01 -5.76137191e-01
 -5.76137191e-01  1.01311709e+00  1.01311709e+00  1.01311709e+00
  7.28017573e+00  7.28017573e+00  7.28017573e+00  2.24013431e+01
  2.84169411e+01  2.84169411e+01  2.84169411e+01  1.00453272e+02
  1.00453272e+02  1.00453272e+02  2.50625399e+02  4.29892686e+02
  4.29892686e+02  4.29892686e+02  1.28214758e+03  1.28214758e+03
  1.28214758e+03  1.97383677e+03  2.98345025e+03  2.98345025e+03
  2.98345025e+03  6.61178163e+03  6.61178163e+03  6.61178163e+03
  8.32575800e+03  2.47103402e+04  7.55030299e+04]
E1 = -727.9135167914295  E_coul = 201.84221327589265
cycle= 2 E= -526.071303515537  delta_E= -0.000431  |g|= 0.0281  |ddm|= 0.029
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0562964
diis-c [-0.00196766  0.05991314  0.94008686]
  HOMO = -0.571272008246369  LUMO = 1.01679399754661
  mo_energy =
[-1.18320916e+02 -1.22328015e+01 -9.53713180e+00 -9.53713180e+00
 -9.53713180e+00 -1.24638855e+00 -5.71272008e-01 -5.71272008e-01
 -5.71272008e-01  1.01679400e+00  1.01679400e+00  1.01679400e+00
  7.29367273e+00  7.29367273e+00  7.29367273e+00  2.24280543e+01
  2.84398787e+01  2.84398787e+01  2.84398787e+01  1.00489445e+02
  1.00489445e+02  1.00489445e+02  2.50671936e+02  4.29940798e+02
  4.29940798e+02  4.29940798e+02  1.28219925e+03  1.28219925e+03
  1.28219925e+03  1.97389084e+03  2.98350368e+03  2.98350368e+03
  2.98350368e+03  6.61183628e+03  6.61183628e+03  6.61183628e+03
  8.32581322e+03  2.47103957e+04  7.55030855e+04]
E1 = -727.8358329696514  E_coul = 201.76450920176435
cycle= 3 E= -526.071323767887  delta_E= -2.03e-05  |g|= 0.00385  |ddm|= 0.00691
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00845948
diis-c [-3.13005532e-07 -1.19246155e-03  1.24713854e-01  8.76478607e-01]
  HOMO = -0.572020924070894  LUMO = 1.01623982559808
  mo_energy =
[-1.18327132e+02 -1.22360770e+01 -9.54059632e+00 -9.54059632e+00
 -9.54059632e+00 -1.24733338e+00 -5.72020924e-01 -5.72020924e-01
 -5.72020924e-01  1.01623983e+00  1.01623983e+00  1.01623983e+00
  7.29170657e+00  7.29170657e+00  7.29170657e+00  2.24245609e+01
  2.84366933e+01  2.84366933e+01  2.84366933e+01  1.00484702e+02
  1.00484702e+02  1.00484702e+02  2.50665992e+02  4.29934658e+02
  4.29934658e+02  4.29934658e+02  1.28219265e+03  1.28219265e+03
  1.28219265e+03  1.97388377e+03  2.98349678e+03  2.98349678e+03
  2.98349678e+03  6.61182907e+03  6.61182907e+03  6.61182907e+03
  8.32580583e+03  2.47103881e+04  7.55030778e+04]
E1 = -727.846409021753  E_coul = 201.77508477491776
cycle= 4 E= -526.071324246835  delta_E= -4.79e-07  |g|= 3.98e-05  |ddm|= 0.00097
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=6.76864e-05
diis-c [-1.72196151e-09  5.09826152e-05 -6.52925539e-03 -5.09252273e-02
  1.05740350e+00]
  HOMO = -0.572002785350043  LUMO = 1.01625291191091
  mo_energy =
[-1.18327094e+02 -1.22360220e+01 -9.54054780e+00 -9.54054780e+00
 -9.54054780e+00 -1.24730941e+00 -5.72002785e-01 -5.72002785e-01
 -5.72002785e-01  1.01625291e+00  1.01625291e+00  1.01625291e+00
  7.29174492e+00  7.29174492e+00  7.29174492e+00  2.24246168e+01
  2.84367391e+01  2.84367391e+01  2.84367391e+01  1.00484748e+02
  1.00484748e+02  1.00484748e+02  2.50666032e+02  4.29934697e+02
  4.29934697e+02  4.29934697e+02  1.28219268e+03  1.28219268e+03
  1.28219268e+03  1.97388379e+03  2.98349680e+03  2.98349680e+03
  2.98349680e+03  6.61182909e+03  6.61182909e+03  6.61182909e+03
  8.32580584e+03  2.47103882e+04  7.55030778e+04]
E1 = -727.8463078922982  E_coul = 201.7749836454141
cycle= 5 E= -526.071324246884  delta_E= -4.9e-11  |g|= 8.23e-06  |ddm|= 1.42e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -727.8463078922982  E_coul = 201.7749836454141
  HOMO = -0.572006810836479  LUMO = 1.01625000125071
  mo_energy =
[-1.18327113e+02 -1.22360359e+01 -9.54056213e+00 -9.54056213e+00
 -9.54056213e+00 -1.24731453e+00 -5.72006811e-01 -5.72006811e-01
 -5.72006811e-01  1.01625000e+00  1.01625000e+00  1.01625000e+00
  7.29173547e+00  7.29173547e+00  7.29173547e+00  2.24246027e+01
  2.84367258e+01  2.84367258e+01  2.84367258e+01  1.00484731e+02
  1.00484731e+02  1.00484731e+02  2.50666013e+02  4.29934678e+02
  4.29934678e+02  4.29934678e+02  1.28219266e+03  1.28219266e+03
  1.28219266e+03  1.97388377e+03  2.98349678e+03  2.98349678e+03
  2.98349678e+03  6.61182907e+03  6.61182907e+03  6.61182907e+03
  8.32580582e+03  2.47103881e+04  7.55030778e+04]
E1 = -727.8463467624728  E_coul = 201.77502251558545
Extra cycle  E= -526.071324246887  delta_E= -3.18e-12  |g|= 2.26e-06  |ddm|= 4.1e-06
    CPU time for scf_cycle      0.70 sec, wall time      0.30 sec
exp = [2.61825082e+04 7.61824710e+03 3.61824346e+03 1.61813787e+03
 2.39497927e+02 5.69469001e+01 1.41199826e+01 4.12161993e+00
 3.96070870e-01 1.36279281e+03 6.65177592e+02 3.03303919e+02
 3.16131723e+02 4.92092525e+01 6.05215324e+00 1.53462549e+01
 7.56379679e-01 3.12535288e+00 2.24470096e-01]
E = -526.0713242468873
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:40:07 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5081893        1
[INPUT] 0    0    [1    /1   ]  7618.24709633        1
[INPUT] 0    0    [1    /1   ]  3618.24346008        1
[INPUT] 0    0    [1    /1   ]  1618.13787284        1
[INPUT] 0    0    [1    /1   ]  239.497927453        1
[INPUT] 0    0    [1    /1   ]  56.9469001045        1
[INPUT] 0    0    [1    /1   ]  14.1199826194        1
[INPUT] 0    0    [1    /1   ]  4.12161993197        1
[INPUT] 0    0    [1    /1   ]  0.396070869642       1
[INPUT] 1    0    [1    /1   ]  1362.79281423        1
[INPUT] 1    0    [1    /1   ]  665.177592386        1
[INPUT] 1    0    [1    /1   ]  303.303919417        1
[INPUT] 1    0    [1    /1   ]  316.131722639        1
[INPUT] 1    0    [1    /1   ]  49.209252487         1
[INPUT] 1    0    [1    /1   ]  6.05215324484        1
[INPUT] 1    0    [1    /1   ]  15.3462548652        1
[INPUT] 1    0    [1    /1   ]  0.756379678648       1
[INPUT] 1    0    [1    /1   ]  3.12535288183        1
[INPUT] 1    0    [1    /1   ]  0.224470096032       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.508189311746, 1.0]], [0, [7618.247096328777, 1.0]], [0, [3618.2434600757324, 1.0]], [0, [1618.1378728358895, 1.0]], [0, [239.49792745260663, 1.0]], [0, [56.94690010449784, 1.0]], [0, [14.119982619444682, 1.0]], [0, [4.121619931969678, 1.0]], [0, [0.39607086964211324, 1.0]], [1, [1362.7928142333576, 1.0]], [1, [665.1775923860818, 1.0]], [1, [303.30391941659855, 1.0]], [1, [316.1317226388017, 1.0]], [1, [49.209252487034675, 1.0]], [1, [6.052153244844818, 1.0]], [1, [15.346254865238699, 1.0]], [1, [0.756379678648166, 1.0]], [1, [3.125352881832979, 1.0]], [1, [0.22447009603171905, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50818931]
bas 1, expnt(s) = [7618.24709633]
bas 2, expnt(s) = [3618.24346008]
bas 3, expnt(s) = [1618.13787284]
bas 4, expnt(s) = [239.49792745]
bas 5, expnt(s) = [56.9469001]
bas 6, expnt(s) = [14.11998262]
bas 7, expnt(s) = [4.12161993]
bas 8, expnt(s) = [0.39607087]
bas 9, expnt(s) = [1362.79281423]
bas 10, expnt(s) = [665.17759239]
bas 11, expnt(s) = [303.30391942]
bas 12, expnt(s) = [316.13172264]
bas 13, expnt(s) = [49.20925249]
bas 14, expnt(s) = [6.05215324]
bas 15, expnt(s) = [15.34625487]
bas 16, expnt(s) = [0.75637968]
bas 17, expnt(s) = [3.12535288]
bas 18, expnt(s) = [0.2244701]
CPU time:       154.98
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825082e+04 5.20024087e+03 7.61824710e+03 2.06018545e+03
 3.61824346e+03 1.17865951e+03 1.61813787e+03 6.44579763e+02
 2.39497927e+02 1.53812398e+02 5.69469001e+01 5.23742227e+01
 1.41199826e+01 1.84030856e+01 4.12161993e+00 7.30829350e+00
 3.96070870e-01 1.26137640e+00 1.36279281e+03 2.41558145e+04
 6.65177592e+02 9.85499495e+03 3.03303919e+02 3.69259707e+03
 3.16131723e+02 3.88883476e+03 4.92092525e+01 3.80226912e+02
 6.05215324e+00 2.76931136e+01 1.53462549e+01 8.86109516e+01
 7.56379679e-01 2.05782864e+00 3.12535288e+00 1.21229473e+01
 2.24470096e-01 4.50746650e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.980106650115793
cond(S) = 86652.28184395457
E1 = -728.4300190147768  E_coul = 203.07776049793182
init E= -525.352258516845
    CPU time for initialize scf      0.45 sec, wall time      0.05 sec
  HOMO = -0.5584598728352  LUMO = 1.0239128058035
  mo_energy =
[-1.18091363e+02 -1.21521211e+01 -9.45003046e+00 -9.45003046e+00
 -9.45003046e+00 -1.22798691e+00 -5.58459873e-01 -5.58459873e-01
 -5.58459873e-01  1.02391281e+00  1.02391281e+00  1.02391281e+00
  7.33886814e+00  7.33886814e+00  7.33886814e+00  2.25107449e+01
  2.85219033e+01  2.85219033e+01  2.85219033e+01  1.00629475e+02
  1.00629475e+02  1.00629475e+02  2.50884448e+02  4.30171464e+02
  4.30171464e+02  4.30171464e+02  1.28249189e+03  1.28249189e+03
  1.28249189e+03  1.97433238e+03  2.98387220e+03  2.98387220e+03
  2.98387220e+03  6.61234277e+03  6.61234277e+03  6.61234277e+03
  8.32641598e+03  2.47111040e+04  7.55038935e+04]
E1 = -727.553982584861  E_coul = 201.48311013786434
cycle= 1 E= -526.070872446997  delta_E= -0.719  |g|= 0.197  |ddm|= 0.81
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.545721
diis-c [-0.29781181  1.        ]
  HOMO = -0.576137191159239  LUMO = 1.01311708708091
  mo_energy =
[-1.18369678e+02 -1.22569645e+01 -9.56214602e+00 -9.56214602e+00
 -9.56214602e+00 -1.25266070e+00 -5.76137191e-01 -5.76137191e-01
 -5.76137191e-01  1.01311709e+00  1.01311709e+00  1.01311709e+00
  7.28017573e+00  7.28017573e+00  7.28017573e+00  2.24013431e+01
  2.84169411e+01  2.84169411e+01  2.84169411e+01  1.00453272e+02
  1.00453272e+02  1.00453272e+02  2.50625399e+02  4.29892686e+02
  4.29892686e+02  4.29892686e+02  1.28214758e+03  1.28214758e+03
  1.28214758e+03  1.97383677e+03  2.98345025e+03  2.98345025e+03
  2.98345025e+03  6.61178163e+03  6.61178163e+03  6.61178163e+03
  8.32575800e+03  2.47103402e+04  7.55030299e+04]
E1 = -727.9135167914295  E_coul = 201.84221327589265
cycle= 2 E= -526.071303515537  delta_E= -0.000431  |g|= 0.0281  |ddm|= 0.029
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0562964
diis-c [-0.00196766  0.05991314  0.94008686]
  HOMO = -0.571272008246369  LUMO = 1.01679399754661
  mo_energy =
[-1.18320916e+02 -1.22328015e+01 -9.53713180e+00 -9.53713180e+00
 -9.53713180e+00 -1.24638855e+00 -5.71272008e-01 -5.71272008e-01
 -5.71272008e-01  1.01679400e+00  1.01679400e+00  1.01679400e+00
  7.29367273e+00  7.29367273e+00  7.29367273e+00  2.24280543e+01
  2.84398787e+01  2.84398787e+01  2.84398787e+01  1.00489445e+02
  1.00489445e+02  1.00489445e+02  2.50671936e+02  4.29940798e+02
  4.29940798e+02  4.29940798e+02  1.28219925e+03  1.28219925e+03
  1.28219925e+03  1.97389084e+03  2.98350368e+03  2.98350368e+03
  2.98350368e+03  6.61183628e+03  6.61183628e+03  6.61183628e+03
  8.32581322e+03  2.47103957e+04  7.55030855e+04]
E1 = -727.8358329696514  E_coul = 201.76450920176435
cycle= 3 E= -526.071323767887  delta_E= -2.03e-05  |g|= 0.00385  |ddm|= 0.00691
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00845948
diis-c [-3.13005532e-07 -1.19246155e-03  1.24713854e-01  8.76478607e-01]
  HOMO = -0.572020924070894  LUMO = 1.01623982559808
  mo_energy =
[-1.18327132e+02 -1.22360770e+01 -9.54059632e+00 -9.54059632e+00
 -9.54059632e+00 -1.24733338e+00 -5.72020924e-01 -5.72020924e-01
 -5.72020924e-01  1.01623983e+00  1.01623983e+00  1.01623983e+00
  7.29170657e+00  7.29170657e+00  7.29170657e+00  2.24245609e+01
  2.84366933e+01  2.84366933e+01  2.84366933e+01  1.00484702e+02
  1.00484702e+02  1.00484702e+02  2.50665992e+02  4.29934658e+02
  4.29934658e+02  4.29934658e+02  1.28219265e+03  1.28219265e+03
  1.28219265e+03  1.97388377e+03  2.98349678e+03  2.98349678e+03
  2.98349678e+03  6.61182907e+03  6.61182907e+03  6.61182907e+03
  8.32580583e+03  2.47103881e+04  7.55030778e+04]
E1 = -727.846409021753  E_coul = 201.77508477491776
cycle= 4 E= -526.071324246835  delta_E= -4.79e-07  |g|= 3.98e-05  |ddm|= 0.00097
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=6.76864e-05
diis-c [-1.72196151e-09  5.09826152e-05 -6.52925539e-03 -5.09252273e-02
  1.05740350e+00]
  HOMO = -0.572002785350043  LUMO = 1.01625291191091
  mo_energy =
[-1.18327094e+02 -1.22360220e+01 -9.54054780e+00 -9.54054780e+00
 -9.54054780e+00 -1.24730941e+00 -5.72002785e-01 -5.72002785e-01
 -5.72002785e-01  1.01625291e+00  1.01625291e+00  1.01625291e+00
  7.29174492e+00  7.29174492e+00  7.29174492e+00  2.24246168e+01
  2.84367391e+01  2.84367391e+01  2.84367391e+01  1.00484748e+02
  1.00484748e+02  1.00484748e+02  2.50666032e+02  4.29934697e+02
  4.29934697e+02  4.29934697e+02  1.28219268e+03  1.28219268e+03
  1.28219268e+03  1.97388379e+03  2.98349680e+03  2.98349680e+03
  2.98349680e+03  6.61182909e+03  6.61182909e+03  6.61182909e+03
  8.32580584e+03  2.47103882e+04  7.55030778e+04]
E1 = -727.8463078922982  E_coul = 201.7749836454141
cycle= 5 E= -526.071324246884  delta_E= -4.9e-11  |g|= 8.23e-06  |ddm|= 1.42e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -727.8463078922982  E_coul = 201.7749836454141
  HOMO = -0.572006810836479  LUMO = 1.01625000125071
  mo_energy =
[-1.18327113e+02 -1.22360359e+01 -9.54056213e+00 -9.54056213e+00
 -9.54056213e+00 -1.24731453e+00 -5.72006811e-01 -5.72006811e-01
 -5.72006811e-01  1.01625000e+00  1.01625000e+00  1.01625000e+00
  7.29173547e+00  7.29173547e+00  7.29173547e+00  2.24246027e+01
  2.84367258e+01  2.84367258e+01  2.84367258e+01  1.00484731e+02
  1.00484731e+02  1.00484731e+02  2.50666013e+02  4.29934678e+02
  4.29934678e+02  4.29934678e+02  1.28219266e+03  1.28219266e+03
  1.28219266e+03  1.97388377e+03  2.98349678e+03  2.98349678e+03
  2.98349678e+03  6.61182907e+03  6.61182907e+03  6.61182907e+03
  8.32580582e+03  2.47103881e+04  7.55030778e+04]
E1 = -727.8463467624728  E_coul = 201.77502251558545
Extra cycle  E= -526.071324246887  delta_E= -3.18e-12  |g|= 2.26e-06  |ddm|= 4.1e-06
    CPU time for scf_cycle      0.69 sec, wall time      0.30 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 86652.28184395457
E1 = -727.8463467624728  E_coul = 201.77502251558545
init E= -526.071324246887
    CPU time for initialize scf      2.72 sec, wall time      0.25 sec
  HOMO = -0.572006090991722  LUMO = 1.01625052910778
  mo_energy =
[-1.18327108e+02 -1.22360331e+01 -9.54055919e+00 -9.54055919e+00
 -9.54055919e+00 -1.24731361e+00 -5.72006091e-01 -5.72006091e-01
 -5.72006091e-01  1.01625053e+00  1.01625053e+00  1.01625053e+00
  7.29173726e+00  7.29173726e+00  7.29173726e+00  2.24246057e+01
  2.84367285e+01  2.84367285e+01  2.84367285e+01  1.00484735e+02
  1.00484735e+02  1.00484735e+02  2.50666018e+02  4.29934683e+02
  4.29934683e+02  4.29934683e+02  1.28219266e+03  1.28219266e+03
  1.28219266e+03  1.97388377e+03  2.98349679e+03  2.98349679e+03
  2.98349679e+03  6.61182907e+03  6.61182907e+03  6.61182907e+03
  8.32580583e+03  2.47103881e+04  7.55030778e+04]
E1 = -727.8463382886988  E_coul = 201.77501404181024
cycle= 1 E= -526.071324246889  delta_E= -1.25e-12  |g|= 5.42e-07  |ddm|= 8.21e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.8463382886988  E_coul = 201.77501404181024
  HOMO = -0.572006236392023  LUMO = 1.01625042176999
  mo_energy =
[-1.18327109e+02 -1.22360337e+01 -9.54055983e+00 -9.54055983e+00
 -9.54055983e+00 -1.24731380e+00 -5.72006236e-01 -5.72006236e-01
 -5.72006236e-01  1.01625042e+00  1.01625042e+00  1.01625042e+00
  7.29173689e+00  7.29173689e+00  7.29173689e+00  2.24246050e+01
  2.84367279e+01  2.84367279e+01  2.84367279e+01  1.00484734e+02
  1.00484734e+02  1.00484734e+02  2.50666017e+02  4.29934681e+02
  4.29934681e+02  4.29934681e+02  1.28219266e+03  1.28219266e+03
  1.28219266e+03  1.97388377e+03  2.98349679e+03  2.98349679e+03
  2.98349679e+03  6.61182907e+03  6.61182907e+03  6.61182907e+03
  8.32580582e+03  2.47103881e+04  7.55030778e+04]
E1 = -727.8463401812212  E_coul = 201.77501593433294
Extra cycle  E= -526.071324246888  delta_E= 3.41e-13  |g|= 1.26e-07  |ddm|= 1.78e-07
    CPU time for scf_cycle      2.87 sec, wall time      0.40 sec
exp = [2.61825082e+04 7.61824710e+03 3.61824346e+03 1.61813787e+03
 2.39497927e+02 5.69469001e+01 1.41199826e+01 4.12161993e+00
 3.96070870e-01 1.36279281e+03 6.65177592e+02 3.03303919e+02
 3.16131723e+02 4.92092525e+01 6.05215324e+00 1.53462549e+01
 7.56379679e-01 3.12535288e+00 2.24470096e-01]
grad_E = [-1.96774016e-06  2.45811704e-05  5.24357193e-05  7.73078102e-04
 -5.50100932e-03 -1.14607734e-02  6.03018217e-04  8.19207052e-03
  1.10052730e-02  1.48740653e-06  2.10691825e-05  1.14520658e-04
  1.00909336e-04 -1.20452372e-03 -1.27382520e-02 -6.75422676e-04
 -5.62716477e-02  3.62981310e-02  9.19235199e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:40:11 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5082291        1
[INPUT] 0    0    [1    /1   ]  7618.24665249        1
[INPUT] 0    0    [1    /1   ]  3618.2425654         1
[INPUT] 0    0    [1    /1   ]  1618.12421091        1
[INPUT] 0    0    [1    /1   ]  239.490095142        1
[INPUT] 0    0    [1    /1   ]  57.5184072181        1
[INPUT] 0    0    [1    /1   ]  14.9851637626        1
[INPUT] 0    0    [1    /1   ]  4.13054792361        1
[INPUT] 0    0    [1    /1   ]  0.395845411316       1
[INPUT] 1    0    [1    /1   ]  1362.79279162        1
[INPUT] 1    0    [1    /1   ]  665.177221906        1
[INPUT] 1    0    [1    /1   ]  303.301940872        1
[INPUT] 1    0    [1    /1   ]  316.12997927         1
[INPUT] 1    0    [1    /1   ]  49.1977181271        1
[INPUT] 1    0    [1    /1   ]  6.20641360956        1
[INPUT] 1    0    [1    /1   ]  15.4532354148        1
[INPUT] 1    0    [1    /1   ]  0.802968754703       1
[INPUT] 1    0    [1    /1   ]  3.17206079217        1
[INPUT] 1    0    [1    /1   ]  0.233145662778       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.508229066025, 1.0]], [0, [7618.246652486533, 1.0]], [0, [3618.2425654028725, 1.0]], [0, [1618.1242109105656, 1.0]], [0, [239.49009514199113, 1.0]], [0, [57.518407218088775, 1.0]], [0, [14.985163762632993, 1.0]], [0, [4.130547923614622, 1.0]], [0, [0.39584541131564266, 1.0]], [1, [1362.7927916218785, 1.0]], [1, [665.1772219060416, 1.0]], [1, [303.30194087236106, 1.0]], [1, [316.1299792696547, 1.0]], [1, [49.197718127123025, 1.0]], [1, [6.206413609561258, 1.0]], [1, [15.453235414786771, 1.0]], [1, [0.8029687547028354, 1.0]], [1, [3.1720607921676494, 1.0]], [1, [0.23314566277834486, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50822907]
bas 1, expnt(s) = [7618.24665249]
bas 2, expnt(s) = [3618.2425654]
bas 3, expnt(s) = [1618.12421091]
bas 4, expnt(s) = [239.49009514]
bas 5, expnt(s) = [57.51840722]
bas 6, expnt(s) = [14.98516376]
bas 7, expnt(s) = [4.13054792]
bas 8, expnt(s) = [0.39584541]
bas 9, expnt(s) = [1362.79279162]
bas 10, expnt(s) = [665.17722191]
bas 11, expnt(s) = [303.30194087]
bas 12, expnt(s) = [316.12997927]
bas 13, expnt(s) = [49.19771813]
bas 14, expnt(s) = [6.20641361]
bas 15, expnt(s) = [15.45323541]
bas 16, expnt(s) = [0.80296875]
bas 17, expnt(s) = [3.17206079]
bas 18, expnt(s) = [0.23314566]
CPU time:       163.24
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825082e+04 5.20024088e+03 7.61824665e+03 2.06018536e+03
 3.61824257e+03 1.17865929e+03 1.61812421e+03 6.44575681e+02
 2.39490095e+02 1.53808626e+02 5.75184072e+01 5.27679427e+01
 1.49851638e+01 1.92424845e+01 4.13054792e+00 7.32016336e+00
 3.95845411e-01 1.26083784e+00 1.36279279e+03 2.41558140e+04
 6.65177222e+02 9.85498809e+03 3.03301941e+02 3.69256696e+03
 3.16129979e+02 3.88880795e+03 4.91977181e+01 3.80115512e+02
 6.20641361e+00 2.85782273e+01 1.54532354e+01 8.93837700e+01
 8.02968755e-01 2.21746973e+00 3.17206079e+00 1.23498383e+01
 2.33145663e-01 4.72627044e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97852723430169
cond(S) = 86963.67278470733
E1 = -728.3991349241255  E_coul = 203.0741939433573
init E= -525.324940980768
    CPU time for initialize scf      0.46 sec, wall time      0.05 sec
  HOMO = -0.55841173020292  LUMO = 1.09771413667006
  mo_energy =
[-1.18097023e+02 -1.21494783e+01 -9.45073860e+00 -9.45073860e+00
 -9.45073860e+00 -1.22758364e+00 -5.58411730e-01 -5.58411730e-01
 -5.58411730e-01  1.09771414e+00  1.09771414e+00  1.09771414e+00
  7.66927145e+00  7.66927145e+00  7.66927145e+00  2.39231728e+01
  2.92910856e+01  2.92910856e+01  2.92910856e+01  1.01778873e+02
  1.01778873e+02  1.01778873e+02  2.55836172e+02  4.31167376e+02
  4.31167376e+02  4.31167376e+02  1.28335717e+03  1.28335717e+03
  1.28335717e+03  1.97937830e+03  2.98466572e+03  2.98466572e+03
  2.98466572e+03  6.61306065e+03  6.61306065e+03  6.61306065e+03
  8.33099242e+03  2.47154179e+04  7.55078997e+04]
E1 = -727.5545312314779  E_coul = 201.47800527428262
cycle= 1 E= -526.076525957195  delta_E= -0.752  |g|= 0.201  |ddm|= 0.787
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.557829
diis-c [-0.31117307  1.        ]
  HOMO = -0.575817015356618  LUMO = 1.08599937195707
  mo_energy =
[-1.18378220e+02 -1.22531282e+01 -9.56304756e+00 -9.56304756e+00
 -9.56304756e+00 -1.25160129e+00 -5.75817015e-01 -5.75817015e-01
 -5.75817015e-01  1.08599937e+00  1.08599937e+00  1.08599937e+00
  7.60993721e+00  7.60993721e+00  7.60993721e+00  2.38116861e+01
  2.91852767e+01  2.91852767e+01  2.91852767e+01  1.01601336e+02
  1.01601336e+02  1.01601336e+02  2.55573560e+02  4.30885949e+02
  4.30885949e+02  4.30885949e+02  1.28300985e+03  1.28300985e+03
  1.28300985e+03  1.97887963e+03  2.98424083e+03  2.98424083e+03
  2.98424083e+03  6.61249586e+03  6.61249586e+03  6.61249586e+03
  8.33033042e+03  2.47146494e+04  7.55070309e+04]
E1 = -727.9152298589698  E_coul = 201.8382529393496
cycle= 2 E= -526.07697691962  delta_E= -0.000451  |g|= 0.0287  |ddm|= 0.028
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0573265
diis-c [-0.0020183   0.06018908  0.93981092]
  HOMO = -0.571079023869314  LUMO = 1.08984679964242
  mo_energy =
[-1.18328811e+02 -1.22288439e+01 -9.53795288e+00 -9.53795288e+00
 -9.53795288e+00 -1.24546783e+00 -5.71079024e-01 -5.71079024e-01
 -5.71079024e-01  1.08984680e+00  1.08984680e+00  1.08984680e+00
  7.62352405e+00  7.62352405e+00  7.62352405e+00  2.38392457e+01
  2.92083888e+01  2.92083888e+01  2.92083888e+01  1.01637846e+02
  1.01637846e+02  1.01637846e+02  2.55620747e+02  4.30934680e+02
  4.30934680e+02  4.30934680e+02  1.28306222e+03  1.28306222e+03
  1.28306222e+03  1.97893439e+03  2.98429497e+03  2.98429497e+03
  2.98429497e+03  6.61255121e+03  6.61255121e+03  6.61255121e+03
  8.33038631e+03  2.47147056e+04  7.55070872e+04]
E1 = -727.8372177932225  E_coul = 201.76022015416157
cycle= 3 E= -526.076997639061  delta_E= -2.07e-05  |g|= 0.00387  |ddm|= 0.00688
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00856375
diis-c [-3.98114838e-07 -1.23783708e-03  1.23665798e-01  8.77572039e-01]
  HOMO = -0.571832696899657  LUMO = 1.08924882070098
  mo_energy =
[-1.18335059e+02 -1.22321246e+01 -9.54143019e+00 -9.54143019e+00
 -9.54143019e+00 -1.24641704e+00 -5.71832697e-01 -5.71832697e-01
 -5.71832697e-01  1.08924882e+00  1.08924882e+00  1.08924882e+00
  7.62151726e+00  7.62151726e+00  7.62151726e+00  2.38356707e+01
  2.92051730e+01  2.92051730e+01  2.92051730e+01  1.01633085e+02
  1.01633085e+02  1.01633085e+02  2.55614766e+02  4.30928512e+02
  4.30928512e+02  4.30928512e+02  1.28305558e+03  1.28305558e+03
  1.28305558e+03  1.97892727e+03  2.98428802e+03  2.98428802e+03
  2.98428802e+03  6.61254395e+03  6.61254395e+03  6.61254395e+03
  8.33037887e+03  2.47146980e+04  7.55070795e+04]
E1 = -727.8478004190217  E_coul = 201.77080229615277
cycle= 4 E= -526.076998122869  delta_E= -4.84e-07  |g|= 4.32e-05  |ddm|= 0.000958
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.5843e-05
diis-c [-2.03621628e-09  4.93506856e-05 -6.23644703e-03 -4.99923340e-02
  1.05617943e+00]
  HOMO = -0.571813907666643  LUMO = 1.0892632165212
  mo_energy =
[-1.18335019e+02 -1.22320650e+01 -9.54137783e+00 -9.54137783e+00
 -9.54137783e+00 -1.24639195e+00 -5.71813908e-01 -5.71813908e-01
 -5.71813908e-01  1.08926322e+00  1.08926322e+00  1.08926322e+00
  7.62155817e+00  7.62155817e+00  7.62155817e+00  2.38357310e+01
  2.92052220e+01  2.92052220e+01  2.92052220e+01  1.01633134e+02
  1.01633134e+02  1.01633134e+02  2.55614808e+02  4.30928552e+02
  4.30928552e+02  4.30928552e+02  1.28305561e+03  1.28305561e+03
  1.28305561e+03  1.97892729e+03  2.98428805e+03  2.98428805e+03
  2.98428805e+03  6.61254397e+03  6.61254397e+03  6.61254397e+03
  8.33037888e+03  2.47146980e+04  7.55070795e+04]
E1 = -727.847689909472  E_coul = 201.7706917865481
cycle= 5 E= -526.076998122924  delta_E= -5.49e-11  |g|= 9.1e-06  |ddm|= 1.57e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.847689909472  E_coul = 201.7706917865481
  HOMO = -0.571818292552632  LUMO = 1.08925982430029
  mo_energy =
[-1.18335040e+02 -1.22320802e+01 -9.54139354e+00 -9.54139354e+00
 -9.54139354e+00 -1.24639753e+00 -5.71818293e-01 -5.71818293e-01
 -5.71818293e-01  1.08925982e+00  1.08925982e+00  1.08925982e+00
  7.62154770e+00  7.62154770e+00  7.62154770e+00  2.38357153e+01
  2.92052073e+01  2.92052073e+01  2.92052073e+01  1.01633115e+02
  1.01633115e+02  1.01633115e+02  2.55614788e+02  4.30928531e+02
  4.30928531e+02  4.30928531e+02  1.28305559e+03  1.28305559e+03
  1.28305559e+03  1.97892727e+03  2.98428803e+03  2.98428803e+03
  2.98428803e+03  6.61254394e+03  6.61254394e+03  6.61254394e+03
  8.33037886e+03  2.47146980e+04  7.55070795e+04]
E1 = -727.8477324746714  E_coul = 201.770734351743
Extra cycle  E= -526.076998122928  delta_E= -4.55e-12  |g|= 2.49e-06  |ddm|= 4.45e-06
    CPU time for scf_cycle      0.64 sec, wall time      0.24 sec
exp = [2.61825082e+04 7.61824665e+03 3.61824257e+03 1.61812421e+03
 2.39490095e+02 5.75184072e+01 1.49851638e+01 4.13054792e+00
 3.95845411e-01 1.36279279e+03 6.65177222e+02 3.03301941e+02
 3.16129979e+02 4.91977181e+01 6.20641361e+00 1.54532354e+01
 8.02968755e-01 3.17206079e+00 2.33145663e-01]
E = -526.0769981229284
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:40:12 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5082291        1
[INPUT] 0    0    [1    /1   ]  7618.24665249        1
[INPUT] 0    0    [1    /1   ]  3618.2425654         1
[INPUT] 0    0    [1    /1   ]  1618.12421091        1
[INPUT] 0    0    [1    /1   ]  239.490095142        1
[INPUT] 0    0    [1    /1   ]  57.5184072181        1
[INPUT] 0    0    [1    /1   ]  14.9851637626        1
[INPUT] 0    0    [1    /1   ]  4.13054792361        1
[INPUT] 0    0    [1    /1   ]  0.395845411316       1
[INPUT] 1    0    [1    /1   ]  1362.79279162        1
[INPUT] 1    0    [1    /1   ]  665.177221906        1
[INPUT] 1    0    [1    /1   ]  303.301940872        1
[INPUT] 1    0    [1    /1   ]  316.12997927         1
[INPUT] 1    0    [1    /1   ]  49.1977181271        1
[INPUT] 1    0    [1    /1   ]  6.20641360956        1
[INPUT] 1    0    [1    /1   ]  15.4532354148        1
[INPUT] 1    0    [1    /1   ]  0.802968754703       1
[INPUT] 1    0    [1    /1   ]  3.17206079217        1
[INPUT] 1    0    [1    /1   ]  0.233145662778       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.508229066025, 1.0]], [0, [7618.246652486533, 1.0]], [0, [3618.2425654028725, 1.0]], [0, [1618.1242109105656, 1.0]], [0, [239.49009514199113, 1.0]], [0, [57.518407218088775, 1.0]], [0, [14.985163762632993, 1.0]], [0, [4.130547923614622, 1.0]], [0, [0.39584541131564266, 1.0]], [1, [1362.7927916218785, 1.0]], [1, [665.1772219060416, 1.0]], [1, [303.30194087236106, 1.0]], [1, [316.1299792696547, 1.0]], [1, [49.197718127123025, 1.0]], [1, [6.206413609561258, 1.0]], [1, [15.453235414786771, 1.0]], [1, [0.8029687547028354, 1.0]], [1, [3.1720607921676494, 1.0]], [1, [0.23314566277834486, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50822907]
bas 1, expnt(s) = [7618.24665249]
bas 2, expnt(s) = [3618.2425654]
bas 3, expnt(s) = [1618.12421091]
bas 4, expnt(s) = [239.49009514]
bas 5, expnt(s) = [57.51840722]
bas 6, expnt(s) = [14.98516376]
bas 7, expnt(s) = [4.13054792]
bas 8, expnt(s) = [0.39584541]
bas 9, expnt(s) = [1362.79279162]
bas 10, expnt(s) = [665.17722191]
bas 11, expnt(s) = [303.30194087]
bas 12, expnt(s) = [316.12997927]
bas 13, expnt(s) = [49.19771813]
bas 14, expnt(s) = [6.20641361]
bas 15, expnt(s) = [15.45323541]
bas 16, expnt(s) = [0.80296875]
bas 17, expnt(s) = [3.17206079]
bas 18, expnt(s) = [0.23314566]
CPU time:       163.97
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825082e+04 5.20024088e+03 7.61824665e+03 2.06018536e+03
 3.61824257e+03 1.17865929e+03 1.61812421e+03 6.44575681e+02
 2.39490095e+02 1.53808626e+02 5.75184072e+01 5.27679427e+01
 1.49851638e+01 1.92424845e+01 4.13054792e+00 7.32016336e+00
 3.95845411e-01 1.26083784e+00 1.36279279e+03 2.41558140e+04
 6.65177222e+02 9.85498809e+03 3.03301941e+02 3.69256696e+03
 3.16129979e+02 3.88880795e+03 4.91977181e+01 3.80115512e+02
 6.20641361e+00 2.85782273e+01 1.54532354e+01 8.93837700e+01
 8.02968755e-01 2.21746973e+00 3.17206079e+00 1.23498383e+01
 2.33145663e-01 4.72627044e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97852723430169
cond(S) = 86963.67278470733
E1 = -728.3991349241255  E_coul = 203.0741939433573
init E= -525.324940980768
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.55841173020292  LUMO = 1.09771413667006
  mo_energy =
[-1.18097023e+02 -1.21494783e+01 -9.45073860e+00 -9.45073860e+00
 -9.45073860e+00 -1.22758364e+00 -5.58411730e-01 -5.58411730e-01
 -5.58411730e-01  1.09771414e+00  1.09771414e+00  1.09771414e+00
  7.66927145e+00  7.66927145e+00  7.66927145e+00  2.39231728e+01
  2.92910856e+01  2.92910856e+01  2.92910856e+01  1.01778873e+02
  1.01778873e+02  1.01778873e+02  2.55836172e+02  4.31167376e+02
  4.31167376e+02  4.31167376e+02  1.28335717e+03  1.28335717e+03
  1.28335717e+03  1.97937830e+03  2.98466572e+03  2.98466572e+03
  2.98466572e+03  6.61306065e+03  6.61306065e+03  6.61306065e+03
  8.33099242e+03  2.47154179e+04  7.55078997e+04]
E1 = -727.5545312314779  E_coul = 201.47800527428262
cycle= 1 E= -526.076525957195  delta_E= -0.752  |g|= 0.201  |ddm|= 0.787
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.557829
diis-c [-0.31117307  1.        ]
  HOMO = -0.575817015356618  LUMO = 1.08599937195707
  mo_energy =
[-1.18378220e+02 -1.22531282e+01 -9.56304756e+00 -9.56304756e+00
 -9.56304756e+00 -1.25160129e+00 -5.75817015e-01 -5.75817015e-01
 -5.75817015e-01  1.08599937e+00  1.08599937e+00  1.08599937e+00
  7.60993721e+00  7.60993721e+00  7.60993721e+00  2.38116861e+01
  2.91852767e+01  2.91852767e+01  2.91852767e+01  1.01601336e+02
  1.01601336e+02  1.01601336e+02  2.55573560e+02  4.30885949e+02
  4.30885949e+02  4.30885949e+02  1.28300985e+03  1.28300985e+03
  1.28300985e+03  1.97887963e+03  2.98424083e+03  2.98424083e+03
  2.98424083e+03  6.61249586e+03  6.61249586e+03  6.61249586e+03
  8.33033042e+03  2.47146494e+04  7.55070309e+04]
E1 = -727.9152298589698  E_coul = 201.8382529393496
cycle= 2 E= -526.07697691962  delta_E= -0.000451  |g|= 0.0287  |ddm|= 0.028
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0573265
diis-c [-0.0020183   0.06018908  0.93981092]
  HOMO = -0.571079023869314  LUMO = 1.08984679964242
  mo_energy =
[-1.18328811e+02 -1.22288439e+01 -9.53795288e+00 -9.53795288e+00
 -9.53795288e+00 -1.24546783e+00 -5.71079024e-01 -5.71079024e-01
 -5.71079024e-01  1.08984680e+00  1.08984680e+00  1.08984680e+00
  7.62352405e+00  7.62352405e+00  7.62352405e+00  2.38392457e+01
  2.92083888e+01  2.92083888e+01  2.92083888e+01  1.01637846e+02
  1.01637846e+02  1.01637846e+02  2.55620747e+02  4.30934680e+02
  4.30934680e+02  4.30934680e+02  1.28306222e+03  1.28306222e+03
  1.28306222e+03  1.97893439e+03  2.98429497e+03  2.98429497e+03
  2.98429497e+03  6.61255121e+03  6.61255121e+03  6.61255121e+03
  8.33038631e+03  2.47147056e+04  7.55070872e+04]
E1 = -727.8372177932225  E_coul = 201.76022015416157
cycle= 3 E= -526.076997639061  delta_E= -2.07e-05  |g|= 0.00387  |ddm|= 0.00688
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00856375
diis-c [-3.98114838e-07 -1.23783708e-03  1.23665798e-01  8.77572039e-01]
  HOMO = -0.571832696899657  LUMO = 1.08924882070098
  mo_energy =
[-1.18335059e+02 -1.22321246e+01 -9.54143019e+00 -9.54143019e+00
 -9.54143019e+00 -1.24641704e+00 -5.71832697e-01 -5.71832697e-01
 -5.71832697e-01  1.08924882e+00  1.08924882e+00  1.08924882e+00
  7.62151726e+00  7.62151726e+00  7.62151726e+00  2.38356707e+01
  2.92051730e+01  2.92051730e+01  2.92051730e+01  1.01633085e+02
  1.01633085e+02  1.01633085e+02  2.55614766e+02  4.30928512e+02
  4.30928512e+02  4.30928512e+02  1.28305558e+03  1.28305558e+03
  1.28305558e+03  1.97892727e+03  2.98428802e+03  2.98428802e+03
  2.98428802e+03  6.61254395e+03  6.61254395e+03  6.61254395e+03
  8.33037887e+03  2.47146980e+04  7.55070795e+04]
E1 = -727.8478004190217  E_coul = 201.77080229615277
cycle= 4 E= -526.076998122869  delta_E= -4.84e-07  |g|= 4.32e-05  |ddm|= 0.000958
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.5843e-05
diis-c [-2.03621628e-09  4.93506856e-05 -6.23644703e-03 -4.99923340e-02
  1.05617943e+00]
  HOMO = -0.571813907666643  LUMO = 1.0892632165212
  mo_energy =
[-1.18335019e+02 -1.22320650e+01 -9.54137783e+00 -9.54137783e+00
 -9.54137783e+00 -1.24639195e+00 -5.71813908e-01 -5.71813908e-01
 -5.71813908e-01  1.08926322e+00  1.08926322e+00  1.08926322e+00
  7.62155817e+00  7.62155817e+00  7.62155817e+00  2.38357310e+01
  2.92052220e+01  2.92052220e+01  2.92052220e+01  1.01633134e+02
  1.01633134e+02  1.01633134e+02  2.55614808e+02  4.30928552e+02
  4.30928552e+02  4.30928552e+02  1.28305561e+03  1.28305561e+03
  1.28305561e+03  1.97892729e+03  2.98428805e+03  2.98428805e+03
  2.98428805e+03  6.61254397e+03  6.61254397e+03  6.61254397e+03
  8.33037888e+03  2.47146980e+04  7.55070795e+04]
E1 = -727.847689909472  E_coul = 201.7706917865481
cycle= 5 E= -526.076998122924  delta_E= -5.49e-11  |g|= 9.1e-06  |ddm|= 1.57e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.847689909472  E_coul = 201.7706917865481
  HOMO = -0.571818292552632  LUMO = 1.08925982430029
  mo_energy =
[-1.18335040e+02 -1.22320802e+01 -9.54139354e+00 -9.54139354e+00
 -9.54139354e+00 -1.24639753e+00 -5.71818293e-01 -5.71818293e-01
 -5.71818293e-01  1.08925982e+00  1.08925982e+00  1.08925982e+00
  7.62154770e+00  7.62154770e+00  7.62154770e+00  2.38357153e+01
  2.92052073e+01  2.92052073e+01  2.92052073e+01  1.01633115e+02
  1.01633115e+02  1.01633115e+02  2.55614788e+02  4.30928531e+02
  4.30928531e+02  4.30928531e+02  1.28305559e+03  1.28305559e+03
  1.28305559e+03  1.97892727e+03  2.98428803e+03  2.98428803e+03
  2.98428803e+03  6.61254394e+03  6.61254394e+03  6.61254394e+03
  8.33037886e+03  2.47146980e+04  7.55070795e+04]
E1 = -727.8477324746714  E_coul = 201.770734351743
Extra cycle  E= -526.076998122928  delta_E= -4.55e-12  |g|= 2.49e-06  |ddm|= 4.45e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 86963.67278470733
E1 = -727.8477324746714  E_coul = 201.770734351743
init E= -526.076998122928
    CPU time for initialize scf      2.74 sec, wall time      0.25 sec
  HOMO = -0.571817510126195  LUMO = 1.08926043859271
  mo_energy =
[-1.18335035e+02 -1.22320771e+01 -9.54139033e+00 -9.54139033e+00
 -9.54139033e+00 -1.24639653e+00 -5.71817510e-01 -5.71817510e-01
 -5.71817510e-01  1.08926044e+00  1.08926044e+00  1.08926044e+00
  7.62154968e+00  7.62154968e+00  7.62154968e+00  2.38357187e+01
  2.92052103e+01  2.92052103e+01  2.92052103e+01  1.01633120e+02
  1.01633120e+02  1.01633120e+02  2.55614793e+02  4.30928536e+02
  4.30928536e+02  4.30928536e+02  1.28305559e+03  1.28305559e+03
  1.28305559e+03  1.97892727e+03  2.98428803e+03  2.98428803e+03
  2.98428803e+03  6.61254395e+03  6.61254395e+03  6.61254395e+03
  8.33037886e+03  2.47146980e+04  7.55070795e+04]
E1 = -727.8477232012228  E_coul = 201.77072507829396
cycle= 1 E= -526.076998122929  delta_E= -4.55e-13  |g|= 5.96e-07  |ddm|= 8.92e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.8477232012228  E_coul = 201.77072507829396
  HOMO = -0.571817668397596  LUMO = 1.0892603134136
  mo_energy =
[-1.18335036e+02 -1.22320778e+01 -9.54139102e+00 -9.54139102e+00
 -9.54139102e+00 -1.24639673e+00 -5.71817668e-01 -5.71817668e-01
 -5.71817668e-01  1.08926031e+00  1.08926031e+00  1.08926031e+00
  7.62154927e+00  7.62154927e+00  7.62154927e+00  2.38357180e+01
  2.92052097e+01  2.92052097e+01  2.92052097e+01  1.01633119e+02
  1.01633119e+02  1.01633119e+02  2.55614791e+02  4.30928535e+02
  4.30928535e+02  4.30928535e+02  1.28305559e+03  1.28305559e+03
  1.28305559e+03  1.97892727e+03  2.98428803e+03  2.98428803e+03
  2.98428803e+03  6.61254395e+03  6.61254395e+03  6.61254395e+03
  8.33037886e+03  2.47146980e+04  7.55070795e+04]
E1 = -727.8477252680608  E_coul = 201.77072714513136
Extra cycle  E= -526.076998122929  delta_E= -5.68e-13  |g|= 1.38e-07  |ddm|= 1.93e-07
    CPU time for scf_cycle      2.86 sec, wall time      0.37 sec
exp = [2.61825082e+04 7.61824665e+03 3.61824257e+03 1.61812421e+03
 2.39490095e+02 5.75184072e+01 1.49851638e+01 4.13054792e+00
 3.95845411e-01 1.36279279e+03 6.65177222e+02 3.03301941e+02
 3.16129979e+02 4.91977181e+01 6.20641361e+00 1.54532354e+01
 8.02968755e-01 3.17206079e+00 2.33145663e-01]
grad_E = [-1.96531135e-06  2.49147500e-05  5.35215927e-05  7.85444645e-04
 -6.20148426e-03 -9.04939151e-03  1.87674702e-03 -1.05487315e-02
  1.11961732e-02  1.52238280e-06  2.13239525e-05  1.16043219e-04
  1.02254606e-04 -1.29790449e-03 -1.07568942e-02 -1.37846778e-03
  7.79704568e-03  3.16415654e-02  8.82621502e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:40:16 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5082649        1
[INPUT] 0    0    [1    /1   ]  7618.24624685        1
[INPUT] 0    0    [1    /1   ]  3618.24174166        1
[INPUT] 0    0    [1    /1   ]  1618.11169083        1
[INPUT] 0    0    [1    /1   ]  239.495193871        1
[INPUT] 0    0    [1    /1   ]  57.9971770109        1
[INPUT] 0    0    [1    /1   ]  15.6921672813        1
[INPUT] 0    0    [1    /1   ]  4.15571977822        1
[INPUT] 0    0    [1    /1   ]  0.393431311285       1
[INPUT] 1    0    [1    /1   ]  1362.79277037        1
[INPUT] 1    0    [1    /1   ]  665.176881462        1
[INPUT] 1    0    [1    /1   ]  303.300117969        1
[INPUT] 1    0    [1    /1   ]  316.12837305         1
[INPUT] 1    0    [1    /1   ]  49.1916976165        1
[INPUT] 1    0    [1    /1   ]  6.36667437314        1
[INPUT] 1    0    [1    /1   ]  15.5348845973        1
[INPUT] 1    0    [1    /1   ]  0.836123146844       1
[INPUT] 1    0    [1    /1   ]  3.14093495178        1
[INPUT] 1    0    [1    /1   ]  0.240695392427       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.508264907752, 1.0]], [0, [7618.246246850154, 1.0]], [0, [3618.2417416641156, 1.0]], [0, [1618.1116908264576, 1.0]], [0, [239.49519387110936, 1.0]], [0, [57.99717701091226, 1.0]], [0, [15.692167281291914, 1.0]], [0, [4.155719778219439, 1.0]], [0, [0.3934313112850541, 1.0]], [1, [1362.7927703728694, 1.0]], [1, [665.1768814615223, 1.0]], [1, [303.3001179690476, 1.0]], [1, [316.1283730504791, 1.0]], [1, [49.19169761652529, 1.0]], [1, [6.366674373137162, 1.0]], [1, [15.534884597302895, 1.0]], [1, [0.8361231468442404, 1.0]], [1, [3.140934951779652, 1.0]], [1, [0.2406953924273858, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50826491]
bas 1, expnt(s) = [7618.24624685]
bas 2, expnt(s) = [3618.24174166]
bas 3, expnt(s) = [1618.11169083]
bas 4, expnt(s) = [239.49519387]
bas 5, expnt(s) = [57.99717701]
bas 6, expnt(s) = [15.69216728]
bas 7, expnt(s) = [4.15571978]
bas 8, expnt(s) = [0.39343131]
bas 9, expnt(s) = [1362.79277037]
bas 10, expnt(s) = [665.17688146]
bas 11, expnt(s) = [303.30011797]
bas 12, expnt(s) = [316.12837305]
bas 13, expnt(s) = [49.19169762]
bas 14, expnt(s) = [6.36667437]
bas 15, expnt(s) = [15.5348846]
bas 16, expnt(s) = [0.83612315]
bas 17, expnt(s) = [3.14093495]
bas 18, expnt(s) = [0.24069539]
CPU time:       172.04
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825083e+04 5.20024088e+03 7.61824625e+03 2.06018528e+03
 3.61824174e+03 1.17865909e+03 1.61811169e+03 6.44571941e+02
 2.39495194e+02 1.53811082e+02 5.79971770e+01 5.30970222e+01
 1.56921673e+01 1.99194444e+01 4.15571978e+00 7.35359514e+00
 3.93431311e-01 1.25506643e+00 1.36279277e+03 2.41558135e+04
 6.65176881e+02 9.85498179e+03 3.03300118e+02 3.69253922e+03
 3.16128373e+02 3.88878325e+03 4.91916976e+01 3.80057367e+02
 6.36667437e+00 2.95036122e+01 1.55348846e+01 8.99744979e+01
 8.36123147e-01 2.33250294e+00 3.14093495e+00 1.21985461e+01
 2.40695392e-01 4.91834641e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.977187808688704
cond(S) = 87173.25942174136
E1 = -728.3534545312001  E_coul = 203.04589090500397
init E= -525.307563626196
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558962175838814  LUMO = 1.15541471301623
  mo_energy =
[-1.18103288e+02 -1.21488193e+01 -9.45351848e+00 -9.45351848e+00
 -9.45351848e+00 -1.22830770e+00 -5.58962176e-01 -5.58962176e-01
 -5.58962176e-01  1.15541471e+00  1.15541471e+00  1.15541471e+00
  7.83541206e+00  7.83541206e+00  7.83541206e+00  2.51445238e+01
  2.97422012e+01  2.97422012e+01  2.97422012e+01  1.02563452e+02
  1.02563452e+02  1.02563452e+02  2.59965203e+02  4.31879041e+02
  4.31879041e+02  4.31879041e+02  1.28397946e+03  1.28397946e+03
  1.28397946e+03  1.98364024e+03  2.98523647e+03  2.98523647e+03
  2.98523647e+03  6.61357646e+03  6.61357646e+03  6.61357646e+03
  8.33486838e+03  2.47190727e+04  7.55112938e+04]
E1 = -727.5623963215246  E_coul = 201.48151342812625
cycle= 1 E= -526.080882893398  delta_E= -0.773  |g|= 0.204  |ddm|= 0.672
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.56432
diis-c [-0.31845732  1.        ]
  HOMO = -0.574960413251822  LUMO = 1.14407224827697
  mo_energy =
[-1.18384285e+02 -1.22498165e+01 -9.56355896e+00 -9.56355896e+00
 -9.56355896e+00 -1.25030753e+00 -5.74960413e-01 -5.74960413e-01
 -5.74960413e-01  1.14407225e+00  1.14407225e+00  1.14407225e+00
  7.77797600e+00  7.77797600e+00  7.77797600e+00  2.50331839e+01
  2.96380105e+01  2.96380105e+01  2.96380105e+01  1.02387217e+02
  1.02387217e+02  1.02387217e+02  2.59702394e+02  4.31598000e+02
  4.31598000e+02  4.31598000e+02  1.28363219e+03  1.28363219e+03
  1.28363219e+03  1.98314154e+03  2.98481163e+03  2.98481163e+03
  2.98481163e+03  6.61301120e+03  6.61301120e+03  6.61301120e+03
  8.33420563e+03  2.47183030e+04  7.55104236e+04]
E1 = -727.9168809079562  E_coul = 201.83554538800584
cycle= 2 E= -526.08133551995  delta_E= -0.000453  |g|= 0.0288  |ddm|= 0.0267
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0573448
diis-c [-0.00202184  0.05950205  0.94049795]
  HOMO = -0.570425217770972  LUMO = 1.14793702950356
  mo_energy =
[-1.18335116e+02 -1.22259342e+01 -9.53889356e+00 -9.53889356e+00
 -9.53889356e+00 -1.24443607e+00 -5.70425218e-01 -5.70425218e-01
 -5.70425218e-01  1.14793703e+00  1.14793703e+00  1.14793703e+00
  7.79125431e+00  7.79125431e+00  7.79125431e+00  2.50608979e+01
  2.96608184e+01  2.96608184e+01  2.96608184e+01  1.02423388e+02
  1.02423388e+02  1.02423388e+02  2.59749373e+02  4.31646480e+02
  4.31646480e+02  4.31646480e+02  1.28368435e+03  1.28368435e+03
  1.28368435e+03  1.98319610e+03  2.98486557e+03  2.98486557e+03
  2.98486557e+03  6.61306635e+03  6.61306635e+03  6.61306635e+03
  8.33426132e+03  2.47183590e+04  7.55104797e+04]
E1 = -727.8405498631182  E_coul = 201.7591941107306
cycle= 3 E= -526.081355752388  delta_E= -2.02e-05  |g|= 0.00383  |ddm|= 0.00666
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00848927
diis-c [-4.21625550e-07 -1.24295228e-03  1.22511045e-01  8.78731908e-01]
  HOMO = -0.57115974872737  LUMO = 1.14732686773987
  mo_energy =
[-1.18341295e+02 -1.22291590e+01 -9.54231305e+00 -9.54231305e+00
 -9.54231305e+00 -1.24535918e+00 -5.71159749e-01 -5.71159749e-01
 -5.71159749e-01  1.14732687e+00  1.14732687e+00  1.14732687e+00
  7.78927727e+00  7.78927727e+00  7.78927727e+00  2.50573202e+01
  2.96576426e+01  2.96576426e+01  2.96576426e+01  1.02418689e+02
  1.02418689e+02  1.02418689e+02  2.59743454e+02  4.31640382e+02
  4.31640382e+02  4.31640382e+02  1.28367777e+03  1.28367777e+03
  1.28367777e+03  1.98318905e+03  2.98485869e+03  2.98485869e+03
  2.98485869e+03  6.61305916e+03  6.61305916e+03  6.61305916e+03
  8.33425395e+03  2.47183514e+04  7.55104720e+04]
E1 = -727.850870619026  E_coul = 201.76951440056223
cycle= 4 E= -526.081356218464  delta_E= -4.66e-07  |g|= 4.35e-05  |ddm|= 0.000925
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.45807e-05
diis-c [-2.14878278e-09  4.62856378e-05 -5.87584352e-03 -4.75687684e-02
  1.05339833e+00]
  HOMO = -0.571140467007793  LUMO = 1.14734225834285
  mo_energy =
[-1.18341251e+02 -1.22290966e+01 -9.54225778e+00 -9.54225778e+00
 -9.54225778e+00 -1.24533347e+00 -5.71140467e-01 -5.71140467e-01
 -5.71140467e-01  1.14734226e+00  1.14734226e+00  1.14734226e+00
  7.78931990e+00  7.78931990e+00  7.78931990e+00  2.50573833e+01
  2.96576942e+01  2.96576942e+01  2.96576942e+01  1.02418741e+02
  1.02418741e+02  1.02418741e+02  2.59743499e+02  4.31640426e+02
  4.31640426e+02  4.31640426e+02  1.28367781e+03  1.28367781e+03
  1.28367781e+03  1.98318907e+03  2.98485872e+03  2.98485872e+03
  2.98485872e+03  6.61305918e+03  6.61305918e+03  6.61305918e+03
  8.33425396e+03  2.47183514e+04  7.55104720e+04]
E1 = -727.8507538507497  E_coul = 201.7693976322305
cycle= 5 E= -526.081356218519  delta_E= -5.55e-11  |g|= 9.26e-06  |ddm|= 1.63e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.8507538507497  E_coul = 201.7693976322305
  HOMO = -0.571144857385608  LUMO = 1.14733870968568
  mo_energy =
[-1.18341273e+02 -1.22291120e+01 -9.54227365e+00 -9.54227365e+00
 -9.54227365e+00 -1.24533904e+00 -5.71144857e-01 -5.71144857e-01
 -5.71144857e-01  1.14733871e+00  1.14733871e+00  1.14733871e+00
  7.78930933e+00  7.78930933e+00  7.78930933e+00  2.50573673e+01
  2.96576794e+01  2.96576794e+01  2.96576794e+01  1.02418723e+02
  1.02418723e+02  1.02418723e+02  2.59743478e+02  4.31640404e+02
  4.31640404e+02  4.31640404e+02  1.28367778e+03  1.28367778e+03
  1.28367778e+03  1.98318905e+03  2.98485870e+03  2.98485870e+03
  2.98485870e+03  6.61305915e+03  6.61305915e+03  6.61305915e+03
  8.33425393e+03  2.47183514e+04  7.55104720e+04]
E1 = -727.8507963787032  E_coul = 201.76944016017802
Extra cycle  E= -526.081356218525  delta_E= -5.91e-12  |g|= 2.51e-06  |ddm|= 4.42e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.23 sec
exp = [2.61825083e+04 7.61824625e+03 3.61824174e+03 1.61811169e+03
 2.39495194e+02 5.79971770e+01 1.56921673e+01 4.15571978e+00
 3.93431311e-01 1.36279277e+03 6.65176881e+02 3.03300118e+02
 3.16128373e+02 4.91916976e+01 6.36667437e+00 1.55348846e+01
 8.36123147e-01 3.14093495e+00 2.40695392e-01]
E = -526.0813562185251
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:40:16 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5082649        1
[INPUT] 0    0    [1    /1   ]  7618.24624685        1
[INPUT] 0    0    [1    /1   ]  3618.24174166        1
[INPUT] 0    0    [1    /1   ]  1618.11169083        1
[INPUT] 0    0    [1    /1   ]  239.495193871        1
[INPUT] 0    0    [1    /1   ]  57.9971770109        1
[INPUT] 0    0    [1    /1   ]  15.6921672813        1
[INPUT] 0    0    [1    /1   ]  4.15571977822        1
[INPUT] 0    0    [1    /1   ]  0.393431311285       1
[INPUT] 1    0    [1    /1   ]  1362.79277037        1
[INPUT] 1    0    [1    /1   ]  665.176881462        1
[INPUT] 1    0    [1    /1   ]  303.300117969        1
[INPUT] 1    0    [1    /1   ]  316.12837305         1
[INPUT] 1    0    [1    /1   ]  49.1916976165        1
[INPUT] 1    0    [1    /1   ]  6.36667437314        1
[INPUT] 1    0    [1    /1   ]  15.5348845973        1
[INPUT] 1    0    [1    /1   ]  0.836123146844       1
[INPUT] 1    0    [1    /1   ]  3.14093495178        1
[INPUT] 1    0    [1    /1   ]  0.240695392427       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.508264907752, 1.0]], [0, [7618.246246850154, 1.0]], [0, [3618.2417416641156, 1.0]], [0, [1618.1116908264576, 1.0]], [0, [239.49519387110936, 1.0]], [0, [57.99717701091226, 1.0]], [0, [15.692167281291914, 1.0]], [0, [4.155719778219439, 1.0]], [0, [0.3934313112850541, 1.0]], [1, [1362.7927703728694, 1.0]], [1, [665.1768814615223, 1.0]], [1, [303.3001179690476, 1.0]], [1, [316.1283730504791, 1.0]], [1, [49.19169761652529, 1.0]], [1, [6.366674373137162, 1.0]], [1, [15.534884597302895, 1.0]], [1, [0.8361231468442404, 1.0]], [1, [3.140934951779652, 1.0]], [1, [0.2406953924273858, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50826491]
bas 1, expnt(s) = [7618.24624685]
bas 2, expnt(s) = [3618.24174166]
bas 3, expnt(s) = [1618.11169083]
bas 4, expnt(s) = [239.49519387]
bas 5, expnt(s) = [57.99717701]
bas 6, expnt(s) = [15.69216728]
bas 7, expnt(s) = [4.15571978]
bas 8, expnt(s) = [0.39343131]
bas 9, expnt(s) = [1362.79277037]
bas 10, expnt(s) = [665.17688146]
bas 11, expnt(s) = [303.30011797]
bas 12, expnt(s) = [316.12837305]
bas 13, expnt(s) = [49.19169762]
bas 14, expnt(s) = [6.36667437]
bas 15, expnt(s) = [15.5348846]
bas 16, expnt(s) = [0.83612315]
bas 17, expnt(s) = [3.14093495]
bas 18, expnt(s) = [0.24069539]
CPU time:       172.74
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825083e+04 5.20024088e+03 7.61824625e+03 2.06018528e+03
 3.61824174e+03 1.17865909e+03 1.61811169e+03 6.44571941e+02
 2.39495194e+02 1.53811082e+02 5.79971770e+01 5.30970222e+01
 1.56921673e+01 1.99194444e+01 4.15571978e+00 7.35359514e+00
 3.93431311e-01 1.25506643e+00 1.36279277e+03 2.41558135e+04
 6.65176881e+02 9.85498179e+03 3.03300118e+02 3.69253922e+03
 3.16128373e+02 3.88878325e+03 4.91916976e+01 3.80057367e+02
 6.36667437e+00 2.95036122e+01 1.55348846e+01 8.99744979e+01
 8.36123147e-01 2.33250294e+00 3.14093495e+00 1.21985461e+01
 2.40695392e-01 4.91834641e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.977187808688704
cond(S) = 87173.25942174136
E1 = -728.3534545312001  E_coul = 203.04589090500397
init E= -525.307563626196
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558962175838814  LUMO = 1.15541471301623
  mo_energy =
[-1.18103288e+02 -1.21488193e+01 -9.45351848e+00 -9.45351848e+00
 -9.45351848e+00 -1.22830770e+00 -5.58962176e-01 -5.58962176e-01
 -5.58962176e-01  1.15541471e+00  1.15541471e+00  1.15541471e+00
  7.83541206e+00  7.83541206e+00  7.83541206e+00  2.51445238e+01
  2.97422012e+01  2.97422012e+01  2.97422012e+01  1.02563452e+02
  1.02563452e+02  1.02563452e+02  2.59965203e+02  4.31879041e+02
  4.31879041e+02  4.31879041e+02  1.28397946e+03  1.28397946e+03
  1.28397946e+03  1.98364024e+03  2.98523647e+03  2.98523647e+03
  2.98523647e+03  6.61357646e+03  6.61357646e+03  6.61357646e+03
  8.33486838e+03  2.47190727e+04  7.55112938e+04]
E1 = -727.5623963215246  E_coul = 201.48151342812625
cycle= 1 E= -526.080882893398  delta_E= -0.773  |g|= 0.204  |ddm|= 0.672
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.56432
diis-c [-0.31845732  1.        ]
  HOMO = -0.574960413251822  LUMO = 1.14407224827697
  mo_energy =
[-1.18384285e+02 -1.22498165e+01 -9.56355896e+00 -9.56355896e+00
 -9.56355896e+00 -1.25030753e+00 -5.74960413e-01 -5.74960413e-01
 -5.74960413e-01  1.14407225e+00  1.14407225e+00  1.14407225e+00
  7.77797600e+00  7.77797600e+00  7.77797600e+00  2.50331839e+01
  2.96380105e+01  2.96380105e+01  2.96380105e+01  1.02387217e+02
  1.02387217e+02  1.02387217e+02  2.59702394e+02  4.31598000e+02
  4.31598000e+02  4.31598000e+02  1.28363219e+03  1.28363219e+03
  1.28363219e+03  1.98314154e+03  2.98481163e+03  2.98481163e+03
  2.98481163e+03  6.61301120e+03  6.61301120e+03  6.61301120e+03
  8.33420563e+03  2.47183030e+04  7.55104236e+04]
E1 = -727.9168809079562  E_coul = 201.83554538800584
cycle= 2 E= -526.08133551995  delta_E= -0.000453  |g|= 0.0288  |ddm|= 0.0267
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0573448
diis-c [-0.00202184  0.05950205  0.94049795]
  HOMO = -0.570425217770972  LUMO = 1.14793702950356
  mo_energy =
[-1.18335116e+02 -1.22259342e+01 -9.53889356e+00 -9.53889356e+00
 -9.53889356e+00 -1.24443607e+00 -5.70425218e-01 -5.70425218e-01
 -5.70425218e-01  1.14793703e+00  1.14793703e+00  1.14793703e+00
  7.79125431e+00  7.79125431e+00  7.79125431e+00  2.50608979e+01
  2.96608184e+01  2.96608184e+01  2.96608184e+01  1.02423388e+02
  1.02423388e+02  1.02423388e+02  2.59749373e+02  4.31646480e+02
  4.31646480e+02  4.31646480e+02  1.28368435e+03  1.28368435e+03
  1.28368435e+03  1.98319610e+03  2.98486557e+03  2.98486557e+03
  2.98486557e+03  6.61306635e+03  6.61306635e+03  6.61306635e+03
  8.33426132e+03  2.47183590e+04  7.55104797e+04]
E1 = -727.8405498631182  E_coul = 201.7591941107306
cycle= 3 E= -526.081355752388  delta_E= -2.02e-05  |g|= 0.00383  |ddm|= 0.00666
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00848927
diis-c [-4.21625550e-07 -1.24295228e-03  1.22511045e-01  8.78731908e-01]
  HOMO = -0.57115974872737  LUMO = 1.14732686773987
  mo_energy =
[-1.18341295e+02 -1.22291590e+01 -9.54231305e+00 -9.54231305e+00
 -9.54231305e+00 -1.24535918e+00 -5.71159749e-01 -5.71159749e-01
 -5.71159749e-01  1.14732687e+00  1.14732687e+00  1.14732687e+00
  7.78927727e+00  7.78927727e+00  7.78927727e+00  2.50573202e+01
  2.96576426e+01  2.96576426e+01  2.96576426e+01  1.02418689e+02
  1.02418689e+02  1.02418689e+02  2.59743454e+02  4.31640382e+02
  4.31640382e+02  4.31640382e+02  1.28367777e+03  1.28367777e+03
  1.28367777e+03  1.98318905e+03  2.98485869e+03  2.98485869e+03
  2.98485869e+03  6.61305916e+03  6.61305916e+03  6.61305916e+03
  8.33425395e+03  2.47183514e+04  7.55104720e+04]
E1 = -727.850870619026  E_coul = 201.76951440056223
cycle= 4 E= -526.081356218464  delta_E= -4.66e-07  |g|= 4.35e-05  |ddm|= 0.000925
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.45807e-05
diis-c [-2.14878278e-09  4.62856378e-05 -5.87584352e-03 -4.75687684e-02
  1.05339833e+00]
  HOMO = -0.571140467007793  LUMO = 1.14734225834285
  mo_energy =
[-1.18341251e+02 -1.22290966e+01 -9.54225778e+00 -9.54225778e+00
 -9.54225778e+00 -1.24533347e+00 -5.71140467e-01 -5.71140467e-01
 -5.71140467e-01  1.14734226e+00  1.14734226e+00  1.14734226e+00
  7.78931990e+00  7.78931990e+00  7.78931990e+00  2.50573833e+01
  2.96576942e+01  2.96576942e+01  2.96576942e+01  1.02418741e+02
  1.02418741e+02  1.02418741e+02  2.59743499e+02  4.31640426e+02
  4.31640426e+02  4.31640426e+02  1.28367781e+03  1.28367781e+03
  1.28367781e+03  1.98318907e+03  2.98485872e+03  2.98485872e+03
  2.98485872e+03  6.61305918e+03  6.61305918e+03  6.61305918e+03
  8.33425396e+03  2.47183514e+04  7.55104720e+04]
E1 = -727.8507538507497  E_coul = 201.7693976322305
cycle= 5 E= -526.081356218519  delta_E= -5.55e-11  |g|= 9.26e-06  |ddm|= 1.63e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.8507538507497  E_coul = 201.7693976322305
  HOMO = -0.571144857385608  LUMO = 1.14733870968568
  mo_energy =
[-1.18341273e+02 -1.22291120e+01 -9.54227365e+00 -9.54227365e+00
 -9.54227365e+00 -1.24533904e+00 -5.71144857e-01 -5.71144857e-01
 -5.71144857e-01  1.14733871e+00  1.14733871e+00  1.14733871e+00
  7.78930933e+00  7.78930933e+00  7.78930933e+00  2.50573673e+01
  2.96576794e+01  2.96576794e+01  2.96576794e+01  1.02418723e+02
  1.02418723e+02  1.02418723e+02  2.59743478e+02  4.31640404e+02
  4.31640404e+02  4.31640404e+02  1.28367778e+03  1.28367778e+03
  1.28367778e+03  1.98318905e+03  2.98485870e+03  2.98485870e+03
  2.98485870e+03  6.61305915e+03  6.61305915e+03  6.61305915e+03
  8.33425393e+03  2.47183514e+04  7.55104720e+04]
E1 = -727.8507963787032  E_coul = 201.76944016017802
Extra cycle  E= -526.081356218525  delta_E= -5.91e-12  |g|= 2.51e-06  |ddm|= 4.42e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 87173.25942174136
E1 = -727.8507963787032  E_coul = 201.76944016017802
init E= -526.081356218525
    CPU time for initialize scf      2.73 sec, wall time      0.26 sec
  HOMO = -0.571144084116185  LUMO = 1.14733934463245
  mo_energy =
[-1.18341268e+02 -1.22291089e+01 -9.54227043e+00 -9.54227043e+00
 -9.54227043e+00 -1.24533806e+00 -5.71144084e-01 -5.71144084e-01
 -5.71144084e-01  1.14733934e+00  1.14733934e+00  1.14733934e+00
  7.78931131e+00  7.78931131e+00  7.78931131e+00  2.50573707e+01
  2.96576824e+01  2.96576824e+01  2.96576824e+01  1.02418727e+02
  1.02418727e+02  1.02418727e+02  2.59743483e+02  4.31640410e+02
  4.31640410e+02  4.31640410e+02  1.28367779e+03  1.28367779e+03
  1.28367779e+03  1.98318905e+03  2.98485870e+03  2.98485870e+03
  2.98485870e+03  6.61305916e+03  6.61305916e+03  6.61305916e+03
  8.33425394e+03  2.47183514e+04  7.55104720e+04]
E1 = -727.8507871938208  E_coul = 201.76943097529494
cycle= 1 E= -526.081356218526  delta_E= -6.82e-13  |g|= 5.95e-07  |ddm|= 8.77e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.8507871938208  E_coul = 201.76943097529494
  HOMO = -0.571144239184281  LUMO = 1.14733921629931
  mo_energy =
[-1.18341269e+02 -1.22291095e+01 -9.54227112e+00 -9.54227112e+00
 -9.54227112e+00 -1.24533826e+00 -5.71144239e-01 -5.71144239e-01
 -5.71144239e-01  1.14733922e+00  1.14733922e+00  1.14733922e+00
  7.78931090e+00  7.78931090e+00  7.78931090e+00  2.50573700e+01
  2.96576818e+01  2.96576818e+01  2.96576818e+01  1.02418726e+02
  1.02418726e+02  1.02418726e+02  2.59743482e+02  4.31640408e+02
  4.31640408e+02  4.31640408e+02  1.28367779e+03  1.28367779e+03
  1.28367779e+03  1.98318905e+03  2.98485870e+03  2.98485870e+03
  2.98485870e+03  6.61305916e+03  6.61305916e+03  6.61305916e+03
  8.33425394e+03  2.47183514e+04  7.55104720e+04]
E1 = -727.85078922361  E_coul = 201.76943300508466
Extra cycle  E= -526.081356218525  delta_E= 4.55e-13  |g|= 1.36e-07  |ddm|= 1.88e-07
    CPU time for scf_cycle      2.86 sec, wall time      0.39 sec
exp = [2.61825083e+04 7.61824625e+03 3.61824174e+03 1.61811169e+03
 2.39495194e+02 5.79971770e+01 1.56921673e+01 4.15571978e+00
 3.93431311e-01 1.36279277e+03 6.65176881e+02 3.03300118e+02
 3.16128373e+02 4.91916976e+01 6.36667437e+00 1.55348846e+01
 8.36123147e-01 3.14093495e+00 2.40695392e-01]
grad_E = [-1.96342181e-06  2.51686841e-05  5.43500378e-05  7.94844813e-04
 -6.71856843e-03 -7.49852215e-03  2.37769886e-03 -1.52216238e-02
 -1.91202015e-02  1.47669976e-06  2.09990870e-05  1.14001999e-04
  1.00459481e-04 -9.26552248e-04 -4.94899178e-03 -4.61453572e-03
  3.65949889e-02  2.30554774e-02  3.08402417e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:40:21 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5083053        1
[INPUT] 0    0    [1    /1   ]  7618.24578464        1
[INPUT] 0    0    [1    /1   ]  3618.24079695        1
[INPUT] 0    0    [1    /1   ]  1618.09739068        1
[INPUT] 0    0    [1    /1   ]  239.513143845        1
[INPUT] 0    0    [1    /1   ]  58.5000007028        1
[INPUT] 0    0    [1    /1   ]  16.4212427539        1
[INPUT] 0    0    [1    /1   ]  4.19496861103        1
[INPUT] 0    0    [1    /1   ]  0.394472857236       1
[INPUT] 1    0    [1    /1   ]  1362.79274577        1
[INPUT] 1    0    [1    /1   ]  665.176493099        1
[INPUT] 1    0    [1    /1   ]  303.298034941        1
[INPUT] 1    0    [1    /1   ]  316.126537626        1
[INPUT] 1    0    [1    /1   ]  49.1880417271        1
[INPUT] 1    0    [1    /1   ]  6.55294366593        1
[INPUT] 1    0    [1    /1   ]  15.6207038706        1
[INPUT] 1    0    [1    /1   ]  0.851235286139       1
[INPUT] 1    0    [1    /1   ]  3.05053215512        1
[INPUT] 1    0    [1    /1   ]  0.240482949035       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.50830525666, 1.0]], [0, [7618.245784644846, 1.0]], [0, [3618.2407969464043, 1.0]], [0, [1618.0973906814245, 1.0]], [0, [239.5131438449826, 1.0]], [0, [58.50000070281561, 1.0]], [0, [16.421242753948903, 1.0]], [0, [4.194968611033251, 1.0]], [0, [0.3944728572362038, 1.0]], [1, [1362.7927457718433, 1.0]], [1, [665.1764930991937, 1.0]], [1, [303.2980349409341, 1.0]], [1, [316.1265376256967, 1.0]], [1, [49.1880417271074, 1.0]], [1, [6.552943665933978, 1.0]], [1, [15.620703870599657, 1.0]], [1, [0.8512352861388758, 1.0]], [1, [3.0505321551175553, 1.0]], [1, [0.2404829490351246, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50830526]
bas 1, expnt(s) = [7618.24578464]
bas 2, expnt(s) = [3618.24079695]
bas 3, expnt(s) = [1618.09739068]
bas 4, expnt(s) = [239.51314384]
bas 5, expnt(s) = [58.5000007]
bas 6, expnt(s) = [16.42124275]
bas 7, expnt(s) = [4.19496861]
bas 8, expnt(s) = [0.39447286]
bas 9, expnt(s) = [1362.79274577]
bas 10, expnt(s) = [665.1764931]
bas 11, expnt(s) = [303.29803494]
bas 12, expnt(s) = [316.12653763]
bas 13, expnt(s) = [49.18804173]
bas 14, expnt(s) = [6.55294367]
bas 15, expnt(s) = [15.62070387]
bas 16, expnt(s) = [0.85123529]
bas 17, expnt(s) = [3.05053216]
bas 18, expnt(s) = [0.24048295]
CPU time:       180.86
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825083e+04 5.20024089e+03 7.61824578e+03 2.06018518e+03
 3.61824080e+03 1.17865886e+03 1.61809739e+03 6.44567668e+02
 2.39513144e+02 1.53819728e+02 5.85000007e+01 5.34419046e+01
 1.64212428e+01 2.06095989e+01 4.19496861e+00 7.40562234e+00
 3.94472857e-01 1.25755755e+00 1.36279275e+03 2.41558130e+04
 6.65176493e+02 9.85497459e+03 3.03298035e+02 3.69250752e+03
 3.16126538e+02 3.88875503e+03 4.91880417e+01 3.80022061e+02
 6.55294367e+00 3.05865107e+01 1.56207039e+01 9.05962333e+01
 8.51235286e-01 2.38531871e+00 3.05053216e+00 1.17612614e+01
 2.40482949e-01 4.91292070e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.976879422939565
cond(S) = 87317.46702225765
E1 = -728.3678655068312  E_coul = 203.06257843242585
init E= -525.305287074405
    CPU time for initialize scf      0.45 sec, wall time      0.05 sec
  HOMO = -0.55851617921544  LUMO = 1.16645376078497
  mo_energy =
[-1.18105696e+02 -1.21445768e+01 -9.45240410e+00 -9.45240410e+00
 -9.45240410e+00 -1.22831970e+00 -5.58516179e-01 -5.58516179e-01
 -5.58516179e-01  1.16645376e+00  1.16645376e+00  1.16645376e+00
  7.82426154e+00  7.82426154e+00  7.82426154e+00  2.64886716e+01
  2.99611466e+01  2.99611466e+01  2.99611466e+01  1.03171079e+02
  1.03171079e+02  1.03171079e+02  2.64306701e+02  4.32483517e+02
  4.32483517e+02  4.32483517e+02  1.28451466e+03  1.28451466e+03
  1.28451466e+03  1.98817220e+03  2.98572799e+03  2.98572799e+03
  2.98572799e+03  6.61402055e+03  6.61402055e+03  6.61402055e+03
  8.33900108e+03  2.47229711e+04  7.55149147e+04]
E1 = -727.5411715946719  E_coul = 201.45670183208102
cycle= 1 E= -526.084469762591  delta_E= -0.779  |g|= 0.205  |ddm|= 0.507
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.565581
diis-c [-0.31988134  1.        ]
  HOMO = -0.575829998513114  LUMO = 1.15383755164741
  mo_energy =
[-1.18390455e+02 -1.22487635e+01 -9.56511026e+00 -9.56511026e+00
 -9.56511026e+00 -1.25213049e+00 -5.75829999e-01 -5.75829999e-01
 -5.75829999e-01  1.15383755e+00  1.15383755e+00  1.15383755e+00
  7.76427503e+00  7.76427503e+00  7.76427503e+00  2.63712712e+01
  2.98535897e+01  2.98535897e+01  2.98535897e+01  1.02991498e+02
  1.02991498e+02  1.02991498e+02  2.64039730e+02  4.32198828e+02
  4.32198828e+02  4.32198828e+02  1.28416366e+03  1.28416366e+03
  1.28416366e+03  1.98767005e+03  2.98529961e+03  2.98529961e+03
  2.98529961e+03  6.61345158e+03  6.61345158e+03  6.61345158e+03
  8.33833456e+03  2.47221974e+04  7.55140403e+04]
E1 = -727.9000404838375  E_coul = 201.81511335831198
cycle= 2 E= -526.084927125526  delta_E= -0.000457  |g|= 0.029  |ddm|= 0.0265
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0577618
diis-c [-0.00207057  0.05936464  0.94063536]
  HOMO = -0.571235050517331  LUMO = 1.15779775140232
  mo_energy =
[-1.18340796e+02 -1.22245610e+01 -9.54011397e+00 -9.54011397e+00
 -9.54011397e+00 -1.24615645e+00 -5.71235051e-01 -5.71235051e-01
 -5.71235051e-01  1.15779775e+00  1.15779775e+00  1.15779775e+00
  7.77772766e+00  7.77772766e+00  7.77772766e+00  2.63998066e+01
  2.98768301e+01  2.98768301e+01  2.98768301e+01  1.03028087e+02
  1.03028087e+02  1.03028087e+02  2.64087230e+02  4.32247786e+02
  4.32247786e+02  4.32247786e+02  1.28421634e+03  1.28421634e+03
  1.28421634e+03  1.98772517e+03  2.98535410e+03  2.98535410e+03
  2.98535410e+03  6.61350731e+03  6.61350731e+03  6.61350731e+03
  8.33839085e+03  2.47222540e+04  7.55140970e+04]
E1 = -727.8225672968763  E_coul = 201.7376194689648
cycle= 3 E= -526.084947827911  delta_E= -2.07e-05  |g|= 0.00388  |ddm|= 0.00672
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00851301
diis-c [-3.83898796e-07 -1.21447171e-03  1.22273387e-01  8.78941085e-01]
  HOMO = -0.571986973612832  LUMO = 1.15716528739255
  mo_energy =
[-1.18347067e+02 -1.22278498e+01 -9.54359114e+00 -9.54359114e+00
 -9.54359114e+00 -1.24710569e+00 -5.71986974e-01 -5.71986974e-01
 -5.71986974e-01  1.15716529e+00  1.15716529e+00  1.15716529e+00
  7.77571150e+00  7.77571150e+00  7.77571150e+00  2.63960974e+01
  2.98735827e+01  2.98735827e+01  2.98735827e+01  1.03023311e+02
  1.03023311e+02  1.03023311e+02  2.64081217e+02  4.32241598e+02
  4.32241598e+02  4.32241598e+02  1.28420967e+03  1.28420967e+03
  1.28420967e+03  1.98771803e+03  2.98534713e+03  2.98534713e+03
  2.98534713e+03  6.61350003e+03  6.61350003e+03  6.61350003e+03
  8.33838339e+03  2.47222463e+04  7.55140893e+04]
E1 = -727.8330588526765  E_coul = 201.74811054520592
cycle= 4 E= -526.084948307471  delta_E= -4.8e-07  |g|= 4.1e-05  |ddm|= 0.000932
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.43374e-05
diis-c [-2.10459106e-09  3.83374936e-05 -5.07567527e-03 -4.04090192e-02
  1.04544636e+00]
  HOMO = -0.571967427731855  LUMO = 1.15718106586805
  mo_energy =
[-1.18347017e+02 -1.22277852e+01 -9.54353276e+00 -9.54353276e+00
 -9.54353276e+00 -1.24707956e+00 -5.71967428e-01 -5.71967428e-01
 -5.71967428e-01  1.15718107e+00  1.15718107e+00  1.15718107e+00
  7.77575538e+00  7.77575538e+00  7.77575538e+00  2.63961626e+01
  2.98736370e+01  2.98736370e+01  2.98736370e+01  1.03023367e+02
  1.03023367e+02  1.03023367e+02  2.64081267e+02  4.32241647e+02
  4.32241647e+02  4.32241647e+02  1.28420971e+03  1.28420971e+03
  1.28420971e+03  1.98771806e+03  2.98534717e+03  2.98534717e+03
  2.98534717e+03  6.61350005e+03  6.61350005e+03  6.61350005e+03
  8.33838341e+03  2.47222464e+04  7.55140893e+04]
E1 = -727.8329298458983  E_coul = 201.7479815383684
cycle= 5 E= -526.08494830753  delta_E= -5.93e-11  |g|= 9.09e-06  |ddm|= 1.75e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.8329298458983  E_coul = 201.7479815383684
  HOMO = -0.571971711351038  LUMO = 1.15717755888224
  mo_energy =
[-1.18347038e+02 -1.22278002e+01 -9.54354826e+00 -9.54354826e+00
 -9.54354826e+00 -1.24708502e+00 -5.71971711e-01 -5.71971711e-01
 -5.71971711e-01  1.15717756e+00  1.15717756e+00  1.15717756e+00
  7.77574507e+00  7.77574507e+00  7.77574507e+00  2.63961469e+01
  2.98736225e+01  2.98736225e+01  2.98736225e+01  1.03023348e+02
  1.03023348e+02  1.03023348e+02  2.64081247e+02  4.32241627e+02
  4.32241627e+02  4.32241627e+02  1.28420969e+03  1.28420969e+03
  1.28420969e+03  1.98771804e+03  2.98534714e+03  2.98534714e+03
  2.98534714e+03  6.61350003e+03  6.61350003e+03  6.61350003e+03
  8.33838339e+03  2.47222463e+04  7.55140893e+04]
E1 = -727.8329716509437  E_coul = 201.74802334340885
Extra cycle  E= -526.084948307535  delta_E= -5e-12  |g|= 2.47e-06  |ddm|= 4.3e-06
    CPU time for scf_cycle      0.64 sec, wall time      0.23 sec
exp = [2.61825083e+04 7.61824578e+03 3.61824080e+03 1.61809739e+03
 2.39513144e+02 5.85000007e+01 1.64212428e+01 4.19496861e+00
 3.94472857e-01 1.36279275e+03 6.65176493e+02 3.03298035e+02
 3.16126538e+02 4.91880417e+01 6.55294367e+00 1.56207039e+01
 8.51235286e-01 3.05053216e+00 2.40482949e-01]
E = -526.0849483075349
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:40:21 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5083053        1
[INPUT] 0    0    [1    /1   ]  7618.24578464        1
[INPUT] 0    0    [1    /1   ]  3618.24079695        1
[INPUT] 0    0    [1    /1   ]  1618.09739068        1
[INPUT] 0    0    [1    /1   ]  239.513143845        1
[INPUT] 0    0    [1    /1   ]  58.5000007028        1
[INPUT] 0    0    [1    /1   ]  16.4212427539        1
[INPUT] 0    0    [1    /1   ]  4.19496861103        1
[INPUT] 0    0    [1    /1   ]  0.394472857236       1
[INPUT] 1    0    [1    /1   ]  1362.79274577        1
[INPUT] 1    0    [1    /1   ]  665.176493099        1
[INPUT] 1    0    [1    /1   ]  303.298034941        1
[INPUT] 1    0    [1    /1   ]  316.126537626        1
[INPUT] 1    0    [1    /1   ]  49.1880417271        1
[INPUT] 1    0    [1    /1   ]  6.55294366593        1
[INPUT] 1    0    [1    /1   ]  15.6207038706        1
[INPUT] 1    0    [1    /1   ]  0.851235286139       1
[INPUT] 1    0    [1    /1   ]  3.05053215512        1
[INPUT] 1    0    [1    /1   ]  0.240482949035       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.50830525666, 1.0]], [0, [7618.245784644846, 1.0]], [0, [3618.2407969464043, 1.0]], [0, [1618.0973906814245, 1.0]], [0, [239.5131438449826, 1.0]], [0, [58.50000070281561, 1.0]], [0, [16.421242753948903, 1.0]], [0, [4.194968611033251, 1.0]], [0, [0.3944728572362038, 1.0]], [1, [1362.7927457718433, 1.0]], [1, [665.1764930991937, 1.0]], [1, [303.2980349409341, 1.0]], [1, [316.1265376256967, 1.0]], [1, [49.1880417271074, 1.0]], [1, [6.552943665933978, 1.0]], [1, [15.620703870599657, 1.0]], [1, [0.8512352861388758, 1.0]], [1, [3.0505321551175553, 1.0]], [1, [0.2404829490351246, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50830526]
bas 1, expnt(s) = [7618.24578464]
bas 2, expnt(s) = [3618.24079695]
bas 3, expnt(s) = [1618.09739068]
bas 4, expnt(s) = [239.51314384]
bas 5, expnt(s) = [58.5000007]
bas 6, expnt(s) = [16.42124275]
bas 7, expnt(s) = [4.19496861]
bas 8, expnt(s) = [0.39447286]
bas 9, expnt(s) = [1362.79274577]
bas 10, expnt(s) = [665.1764931]
bas 11, expnt(s) = [303.29803494]
bas 12, expnt(s) = [316.12653763]
bas 13, expnt(s) = [49.18804173]
bas 14, expnt(s) = [6.55294367]
bas 15, expnt(s) = [15.62070387]
bas 16, expnt(s) = [0.85123529]
bas 17, expnt(s) = [3.05053216]
bas 18, expnt(s) = [0.24048295]
CPU time:       181.58
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825083e+04 5.20024089e+03 7.61824578e+03 2.06018518e+03
 3.61824080e+03 1.17865886e+03 1.61809739e+03 6.44567668e+02
 2.39513144e+02 1.53819728e+02 5.85000007e+01 5.34419046e+01
 1.64212428e+01 2.06095989e+01 4.19496861e+00 7.40562234e+00
 3.94472857e-01 1.25755755e+00 1.36279275e+03 2.41558130e+04
 6.65176493e+02 9.85497459e+03 3.03298035e+02 3.69250752e+03
 3.16126538e+02 3.88875503e+03 4.91880417e+01 3.80022061e+02
 6.55294367e+00 3.05865107e+01 1.56207039e+01 9.05962333e+01
 8.51235286e-01 2.38531871e+00 3.05053216e+00 1.17612614e+01
 2.40482949e-01 4.91292070e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.976879422939565
cond(S) = 87317.46702225765
E1 = -728.3678655068312  E_coul = 203.06257843242585
init E= -525.305287074405
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.55851617921544  LUMO = 1.16645376078497
  mo_energy =
[-1.18105696e+02 -1.21445768e+01 -9.45240410e+00 -9.45240410e+00
 -9.45240410e+00 -1.22831970e+00 -5.58516179e-01 -5.58516179e-01
 -5.58516179e-01  1.16645376e+00  1.16645376e+00  1.16645376e+00
  7.82426154e+00  7.82426154e+00  7.82426154e+00  2.64886716e+01
  2.99611466e+01  2.99611466e+01  2.99611466e+01  1.03171079e+02
  1.03171079e+02  1.03171079e+02  2.64306701e+02  4.32483517e+02
  4.32483517e+02  4.32483517e+02  1.28451466e+03  1.28451466e+03
  1.28451466e+03  1.98817220e+03  2.98572799e+03  2.98572799e+03
  2.98572799e+03  6.61402055e+03  6.61402055e+03  6.61402055e+03
  8.33900108e+03  2.47229711e+04  7.55149147e+04]
E1 = -727.5411715946719  E_coul = 201.45670183208102
cycle= 1 E= -526.084469762591  delta_E= -0.779  |g|= 0.205  |ddm|= 0.507
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.565581
diis-c [-0.31988134  1.        ]
  HOMO = -0.575829998513114  LUMO = 1.15383755164741
  mo_energy =
[-1.18390455e+02 -1.22487635e+01 -9.56511026e+00 -9.56511026e+00
 -9.56511026e+00 -1.25213049e+00 -5.75829999e-01 -5.75829999e-01
 -5.75829999e-01  1.15383755e+00  1.15383755e+00  1.15383755e+00
  7.76427503e+00  7.76427503e+00  7.76427503e+00  2.63712712e+01
  2.98535897e+01  2.98535897e+01  2.98535897e+01  1.02991498e+02
  1.02991498e+02  1.02991498e+02  2.64039730e+02  4.32198828e+02
  4.32198828e+02  4.32198828e+02  1.28416366e+03  1.28416366e+03
  1.28416366e+03  1.98767005e+03  2.98529961e+03  2.98529961e+03
  2.98529961e+03  6.61345158e+03  6.61345158e+03  6.61345158e+03
  8.33833456e+03  2.47221974e+04  7.55140403e+04]
E1 = -727.9000404838375  E_coul = 201.81511335831198
cycle= 2 E= -526.084927125526  delta_E= -0.000457  |g|= 0.029  |ddm|= 0.0265
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0577618
diis-c [-0.00207057  0.05936464  0.94063536]
  HOMO = -0.571235050517331  LUMO = 1.15779775140232
  mo_energy =
[-1.18340796e+02 -1.22245610e+01 -9.54011397e+00 -9.54011397e+00
 -9.54011397e+00 -1.24615645e+00 -5.71235051e-01 -5.71235051e-01
 -5.71235051e-01  1.15779775e+00  1.15779775e+00  1.15779775e+00
  7.77772766e+00  7.77772766e+00  7.77772766e+00  2.63998066e+01
  2.98768301e+01  2.98768301e+01  2.98768301e+01  1.03028087e+02
  1.03028087e+02  1.03028087e+02  2.64087230e+02  4.32247786e+02
  4.32247786e+02  4.32247786e+02  1.28421634e+03  1.28421634e+03
  1.28421634e+03  1.98772517e+03  2.98535410e+03  2.98535410e+03
  2.98535410e+03  6.61350731e+03  6.61350731e+03  6.61350731e+03
  8.33839085e+03  2.47222540e+04  7.55140970e+04]
E1 = -727.8225672968763  E_coul = 201.7376194689648
cycle= 3 E= -526.084947827911  delta_E= -2.07e-05  |g|= 0.00388  |ddm|= 0.00672
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00851301
diis-c [-3.83898796e-07 -1.21447171e-03  1.22273387e-01  8.78941085e-01]
  HOMO = -0.571986973612832  LUMO = 1.15716528739255
  mo_energy =
[-1.18347067e+02 -1.22278498e+01 -9.54359114e+00 -9.54359114e+00
 -9.54359114e+00 -1.24710569e+00 -5.71986974e-01 -5.71986974e-01
 -5.71986974e-01  1.15716529e+00  1.15716529e+00  1.15716529e+00
  7.77571150e+00  7.77571150e+00  7.77571150e+00  2.63960974e+01
  2.98735827e+01  2.98735827e+01  2.98735827e+01  1.03023311e+02
  1.03023311e+02  1.03023311e+02  2.64081217e+02  4.32241598e+02
  4.32241598e+02  4.32241598e+02  1.28420967e+03  1.28420967e+03
  1.28420967e+03  1.98771803e+03  2.98534713e+03  2.98534713e+03
  2.98534713e+03  6.61350003e+03  6.61350003e+03  6.61350003e+03
  8.33838339e+03  2.47222463e+04  7.55140893e+04]
E1 = -727.8330588526765  E_coul = 201.74811054520592
cycle= 4 E= -526.084948307471  delta_E= -4.8e-07  |g|= 4.1e-05  |ddm|= 0.000932
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.43374e-05
diis-c [-2.10459106e-09  3.83374936e-05 -5.07567527e-03 -4.04090192e-02
  1.04544636e+00]
  HOMO = -0.571967427731855  LUMO = 1.15718106586805
  mo_energy =
[-1.18347017e+02 -1.22277852e+01 -9.54353276e+00 -9.54353276e+00
 -9.54353276e+00 -1.24707956e+00 -5.71967428e-01 -5.71967428e-01
 -5.71967428e-01  1.15718107e+00  1.15718107e+00  1.15718107e+00
  7.77575538e+00  7.77575538e+00  7.77575538e+00  2.63961626e+01
  2.98736370e+01  2.98736370e+01  2.98736370e+01  1.03023367e+02
  1.03023367e+02  1.03023367e+02  2.64081267e+02  4.32241647e+02
  4.32241647e+02  4.32241647e+02  1.28420971e+03  1.28420971e+03
  1.28420971e+03  1.98771806e+03  2.98534717e+03  2.98534717e+03
  2.98534717e+03  6.61350005e+03  6.61350005e+03  6.61350005e+03
  8.33838341e+03  2.47222464e+04  7.55140893e+04]
E1 = -727.8329298458983  E_coul = 201.7479815383684
cycle= 5 E= -526.08494830753  delta_E= -5.93e-11  |g|= 9.09e-06  |ddm|= 1.75e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.8329298458983  E_coul = 201.7479815383684
  HOMO = -0.571971711351038  LUMO = 1.15717755888224
  mo_energy =
[-1.18347038e+02 -1.22278002e+01 -9.54354826e+00 -9.54354826e+00
 -9.54354826e+00 -1.24708502e+00 -5.71971711e-01 -5.71971711e-01
 -5.71971711e-01  1.15717756e+00  1.15717756e+00  1.15717756e+00
  7.77574507e+00  7.77574507e+00  7.77574507e+00  2.63961469e+01
  2.98736225e+01  2.98736225e+01  2.98736225e+01  1.03023348e+02
  1.03023348e+02  1.03023348e+02  2.64081247e+02  4.32241627e+02
  4.32241627e+02  4.32241627e+02  1.28420969e+03  1.28420969e+03
  1.28420969e+03  1.98771804e+03  2.98534714e+03  2.98534714e+03
  2.98534714e+03  6.61350003e+03  6.61350003e+03  6.61350003e+03
  8.33838339e+03  2.47222463e+04  7.55140893e+04]
E1 = -727.8329716509437  E_coul = 201.74802334340885
Extra cycle  E= -526.084948307535  delta_E= -5e-12  |g|= 2.47e-06  |ddm|= 4.3e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 87317.46702225765
E1 = -727.8329716509437  E_coul = 201.74802334340885
init E= -526.084948307535
    CPU time for initialize scf      2.96 sec, wall time      0.27 sec
  HOMO = -0.571970951965057  LUMO = 1.15717819019603
  mo_energy =
[-1.18347033e+02 -1.22277971e+01 -9.54354510e+00 -9.54354510e+00
 -9.54354510e+00 -1.24708405e+00 -5.71970952e-01 -5.71970952e-01
 -5.71970952e-01  1.15717819e+00  1.15717819e+00  1.15717819e+00
  7.77574702e+00  7.77574702e+00  7.77574702e+00  2.63961503e+01
  2.98736254e+01  2.98736254e+01  2.98736254e+01  1.03023353e+02
  1.03023353e+02  1.03023353e+02  2.64081252e+02  4.32241632e+02
  4.32241632e+02  4.32241632e+02  1.28420970e+03  1.28420970e+03
  1.28420970e+03  1.98771805e+03  2.98534715e+03  2.98534715e+03
  2.98534715e+03  6.61350004e+03  6.61350004e+03  6.61350004e+03
  8.33838339e+03  2.47222463e+04  7.55140893e+04]
E1 = -727.8329625974578  E_coul = 201.74801428992248
cycle= 1 E= -526.084948307535  delta_E= -4.55e-13  |g|= 5.85e-07  |ddm|= 8.59e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.8329625974578  E_coul = 201.74801428992248
  HOMO = -0.571971105143767  LUMO = 1.15717806187221
  mo_energy =
[-1.18347034e+02 -1.22277978e+01 -9.54354578e+00 -9.54354578e+00
 -9.54354578e+00 -1.24708424e+00 -5.71971105e-01 -5.71971105e-01
 -5.71971105e-01  1.15717806e+00  1.15717806e+00  1.15717806e+00
  7.77574661e+00  7.77574661e+00  7.77574661e+00  2.63961495e+01
  2.98736248e+01  2.98736248e+01  2.98736248e+01  1.03023352e+02
  1.03023352e+02  1.03023352e+02  2.64081251e+02  4.32241630e+02
  4.32241630e+02  4.32241630e+02  1.28420970e+03  1.28420970e+03
  1.28420970e+03  1.98771804e+03  2.98534715e+03  2.98534715e+03
  2.98534715e+03  6.61350004e+03  6.61350004e+03  6.61350004e+03
  8.33838339e+03  2.47222463e+04  7.55140893e+04]
E1 = -727.8329646014525  E_coul = 201.74801629391789
Extra cycle  E= -526.084948307535  delta_E= 6.82e-13  |g|= 1.34e-07  |ddm|= 1.84e-07
    CPU time for scf_cycle      3.08 sec, wall time      0.41 sec
exp = [2.61825083e+04 7.61824578e+03 3.61824080e+03 1.61809739e+03
 2.39513144e+02 5.85000007e+01 1.64212428e+01 4.19496861e+00
 3.94472857e-01 1.36279275e+03 6.65176493e+02 3.03298035e+02
 3.16126538e+02 4.91880417e+01 6.55294367e+00 1.56207039e+01
 8.51235286e-01 3.05053216e+00 2.40482949e-01]
grad_E = [-1.96179529e-06  2.54134750e-05  5.51470367e-05  8.03885188e-04
 -7.20074658e-03 -6.23798077e-03  2.57791848e-03 -1.07932748e-02
 -5.69505439e-03  1.37483523e-06  2.02644193e-05  1.09434912e-04
  9.64406685e-05 -2.03476338e-04  4.90029603e-03 -9.64051176e-03
  6.98712753e-02  8.73396245e-03 -7.48481377e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:40:25 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5083222        1
[INPUT] 0    0    [1    /1   ]  7618.2455863         1
[INPUT] 0    0    [1    /1   ]  3618.24038696        1
[INPUT] 0    0    [1    /1   ]  1618.09122882        1
[INPUT] 0    0    [1    /1   ]  239.529786479        1
[INPUT] 0    0    [1    /1   ]  58.6856048425        1
[INPUT] 0    0    [1    /1   ]  16.6695393285        1
[INPUT] 0    0    [1    /1   ]  4.21577461947        1
[INPUT] 0    0    [1    /1   ]  0.393456250921       1
[INPUT] 1    0    [1    /1   ]  1362.79273512        1
[INPUT] 1    0    [1    /1   ]  665.176327529        1
[INPUT] 1    0    [1    /1   ]  303.297145411        1
[INPUT] 1    0    [1    /1   ]  316.125753819        1
[INPUT] 1    0    [1    /1   ]  49.1875410434        1
[INPUT] 1    0    [1    /1   ]  6.61910790089        1
[INPUT] 1    0    [1    /1   ]  15.6607960793        1
[INPUT] 1    0    [1    /1   ]  0.840066320526       1
[INPUT] 1    0    [1    /1   ]  2.99063199118        1
[INPUT] 1    0    [1    /1   ]  0.238309459052       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.508322203463, 1.0]], [0, [7618.245586301049, 1.0]], [0, [3618.2403869592463, 1.0]], [0, [1618.0912288245597, 1.0]], [0, [239.5297864790798, 1.0]], [0, [58.685604842532925, 1.0]], [0, [16.669539328473974, 1.0]], [0, [4.215774619466604, 1.0]], [0, [0.3934562509209827, 1.0]], [1, [1362.7927351183778, 1.0]], [1, [665.176327529396, 1.0]], [1, [303.2971454112895, 1.0]], [1, [316.1257538186582, 1.0]], [1, [49.18754104338716, 1.0]], [1, [6.6191079008891585, 1.0]], [1, [15.660796079284546, 1.0]], [1, [0.8400663205258109, 1.0]], [1, [2.9906319911774597, 1.0]], [1, [0.23830945905158046, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.5083222]
bas 1, expnt(s) = [7618.2455863]
bas 2, expnt(s) = [3618.24038696]
bas 3, expnt(s) = [1618.09122882]
bas 4, expnt(s) = [239.52978648]
bas 5, expnt(s) = [58.68560484]
bas 6, expnt(s) = [16.66953933]
bas 7, expnt(s) = [4.21577462]
bas 8, expnt(s) = [0.39345625]
bas 9, expnt(s) = [1362.79273512]
bas 10, expnt(s) = [665.17632753]
bas 11, expnt(s) = [303.29714541]
bas 12, expnt(s) = [316.12575382]
bas 13, expnt(s) = [49.18754104]
bas 14, expnt(s) = [6.6191079]
bas 15, expnt(s) = [15.66079608]
bas 16, expnt(s) = [0.84006632]
bas 17, expnt(s) = [2.99063199]
bas 18, expnt(s) = [0.23830946]
CPU time:       189.91
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825083e+04 5.20024089e+03 7.61824559e+03 2.06018514e+03
 3.61824039e+03 1.17865876e+03 1.61809123e+03 6.44565827e+02
 2.39529786e+02 1.53827744e+02 5.86856048e+01 5.35690214e+01
 1.66695393e+01 2.08428797e+01 4.21577462e+00 7.43315284e+00
 3.93456251e-01 1.25512610e+00 1.36279274e+03 2.41558128e+04
 6.65176328e+02 9.85497153e+03 3.03297145e+02 3.69249398e+03
 3.16125754e+02 3.88874298e+03 4.91875410e+01 3.80017225e+02
 6.61910790e+00 3.09730318e+01 1.56607961e+01 9.08869827e+01
 8.40066321e-01 2.34626120e+00 2.99063199e+00 1.14732937e+01
 2.38309459e-01 4.85747969e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.977440538849784
cond(S) = 87325.28765881406
E1 = -728.3608792850993  E_coul = 203.05476460066885
init E= -525.30611468443
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558907893602648  LUMO = 1.14688701640244
  mo_energy =
[-1.18107591e+02 -1.21440469e+01 -9.45297466e+00 -9.45297466e+00
 -9.45297466e+00 -1.22878572e+00 -5.58907894e-01 -5.58907894e-01
 -5.58907894e-01  1.14688702e+00  1.14688702e+00  1.14688702e+00
  7.70561639e+00  7.70561639e+00  7.70561639e+00  2.69732217e+01
  2.98794888e+01  2.98794888e+01  2.98794888e+01  1.03258651e+02
  1.03258651e+02  1.03258651e+02  2.65849701e+02  4.32617667e+02
  4.32617667e+02  4.32617667e+02  1.28463828e+03  1.28463828e+03
  1.28463828e+03  1.98982070e+03  2.98584167e+03  2.98584167e+03
  2.98584167e+03  6.61412282e+03  6.61412282e+03  6.61412282e+03
  8.34051210e+03  2.47243971e+04  7.55162392e+04]
E1 = -727.5309103722358  E_coul = 201.44485473154177
cycle= 1 E= -526.086055640694  delta_E= -0.78  |g|= 0.205  |ddm|= 0.408
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.564253
diis-c [-0.31838126  1.        ]
  HOMO = -0.576304243572121  LUMO = 1.13448481856152
  mo_energy =
[-1.18392635e+02 -1.22489123e+01 -9.56590201e+00 -9.56590201e+00
 -9.56590201e+00 -1.25271805e+00 -5.76304244e-01 -5.76304244e-01
 -5.76304244e-01  1.13448482e+00  1.13448482e+00  1.13448482e+00
  7.64569487e+00  7.64569487e+00  7.64569487e+00  2.68543472e+01
  2.97714417e+01  2.97714417e+01  2.97714417e+01  1.03078700e+02
  1.03078700e+02  1.03078700e+02  2.65582319e+02  4.32332711e+02
  4.32332711e+02  4.32332711e+02  1.28428704e+03  1.28428704e+03
  1.28428704e+03  1.98931849e+03  2.98541317e+03  2.98541317e+03
  2.98541317e+03  6.61355371e+03  6.61355371e+03  6.61355371e+03
  8.33984547e+03  2.47236233e+04  7.55153646e+04]
E1 = -727.8897786360697  E_coul = 201.8032699850324
cycle= 2 E= -526.086508651037  delta_E= -0.000453  |g|= 0.0288  |ddm|= 0.0266
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0574968
diis-c [-0.00206978  0.05883488  0.94116512]
  HOMO = -0.57167781320176  LUMO = 1.13839958496483
  mo_energy =
[-1.18343031e+02 -1.22247048e+01 -9.54089907e+00 -9.54089907e+00
 -9.54089907e+00 -1.24671159e+00 -5.71677813e-01 -5.71677813e-01
 -5.71677813e-01  1.13839958e+00  1.13839958e+00  1.13839958e+00
  7.65911288e+00  7.65911288e+00  7.65911288e+00  2.68830367e+01
  2.97947491e+01  2.97947491e+01  2.97947491e+01  1.03115284e+02
  1.03115284e+02  1.03115284e+02  2.65629786e+02  4.32381614e+02
  4.32381614e+02  4.32381614e+02  1.28433967e+03  1.28433967e+03
  1.28433967e+03  1.98937357e+03  2.98546761e+03  2.98546761e+03
  2.98546761e+03  6.61360941e+03  6.61360941e+03  6.61360941e+03
  8.33990174e+03  2.47236798e+04  7.55154212e+04]
E1 = -727.8122956632837  E_coul = 201.72576640371418
cycle= 3 E= -526.08652925957  delta_E= -2.06e-05  |g|= 0.00388  |ddm|= 0.0067
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00847849
diis-c [-3.52889242e-07 -1.19452924e-03  1.22490635e-01  8.78703894e-01]
  HOMO = -0.572433594218386  LUMO = 1.13777477172365
  mo_energy =
[-1.18349322e+02 -1.22280112e+01 -9.54438930e+00 -9.54438930e+00
 -9.54438930e+00 -1.24766594e+00 -5.72433594e-01 -5.72433594e-01
 -5.72433594e-01  1.13777477e+00  1.13777477e+00  1.13777477e+00
  7.65709789e+00  7.65709789e+00  7.65709789e+00  2.68792874e+01
  2.97914827e+01  2.97914827e+01  2.97914827e+01  1.03110488e+02
  1.03110488e+02  1.03110488e+02  2.65623751e+02  4.32375406e+02
  4.32375406e+02  4.32375406e+02  1.28433298e+03  1.28433298e+03
  1.28433298e+03  1.98936642e+03  2.98546062e+03  2.98546062e+03
  2.98546062e+03  6.61360211e+03  6.61360211e+03  6.61360211e+03
  8.33989426e+03  2.47236722e+04  7.55154135e+04]
E1 = -727.8228183666538  E_coul = 201.7362886262903
cycle= 4 E= -526.086529740364  delta_E= -4.81e-07  |g|= 3.96e-05  |ddm|= 0.000933
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.94214e-05
diis-c [-2.03673513e-09  3.50926770e-05 -4.75645134e-03 -3.73565043e-02
  1.04207786e+00]
  HOMO = -0.572413880698334  LUMO = 1.13779043742274
  mo_energy =
[-1.18349270e+02 -1.22279464e+01 -9.54433019e+00 -9.54433019e+00
 -9.54433019e+00 -1.24763970e+00 -5.72413881e-01 -5.72413881e-01
 -5.72413881e-01  1.13779044e+00  1.13779044e+00  1.13779044e+00
  7.65714197e+00  7.65714197e+00  7.65714197e+00  2.68793530e+01
  2.97915377e+01  2.97915377e+01  2.97915377e+01  1.03110545e+02
  1.03110545e+02  1.03110545e+02  2.65623804e+02  4.32375458e+02
  4.32375458e+02  4.32375458e+02  1.28433302e+03  1.28433302e+03
  1.28433302e+03  1.98936645e+03  2.98546066e+03  2.98546066e+03
  2.98546066e+03  6.61360214e+03  6.61360214e+03  6.61360214e+03
  8.33989428e+03  2.47236722e+04  7.55154135e+04]
E1 = -727.8226860129098  E_coul = 201.73615627248574
cycle= 5 E= -526.086529740424  delta_E= -6.06e-11  |g|= 8.85e-06  |ddm|= 1.76e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.8226860129098  E_coul = 201.73615627248574
  HOMO = -0.572418063333218  LUMO = 1.13778706967311
  mo_energy =
[-1.18349291e+02 -1.22279610e+01 -9.54434529e+00 -9.54434529e+00
 -9.54434529e+00 -1.24764502e+00 -5.72418063e-01 -5.72418063e-01
 -5.72418063e-01  1.13778707e+00  1.13778707e+00  1.13778707e+00
  7.65713197e+00  7.65713197e+00  7.65713197e+00  2.68793377e+01
  2.97915235e+01  2.97915235e+01  2.97915235e+01  1.03110528e+02
  1.03110528e+02  1.03110528e+02  2.65623784e+02  4.32375438e+02
  4.32375438e+02  4.32375438e+02  1.28433300e+03  1.28433300e+03
  1.28433300e+03  1.98936643e+03  2.98546064e+03  2.98546064e+03
  2.98546064e+03  6.61360212e+03  6.61360212e+03  6.61360212e+03
  8.33989426e+03  2.47236722e+04  7.55154135e+04]
E1 = -727.8227267740102  E_coul = 201.7361970335818
Extra cycle  E= -526.086529740428  delta_E= -4.32e-12  |g|= 2.4e-06  |ddm|= 4.18e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.23 sec
exp = [2.61825083e+04 7.61824559e+03 3.61824039e+03 1.61809123e+03
 2.39529786e+02 5.86856048e+01 1.66695393e+01 4.21577462e+00
 3.93456251e-01 1.36279274e+03 6.65176328e+02 3.03297145e+02
 3.16125754e+02 4.91875410e+01 6.61910790e+00 1.56607961e+01
 8.40066321e-01 2.99063199e+00 2.38309459e-01]
E = -526.0865297404284
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:40:26 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5083222        1
[INPUT] 0    0    [1    /1   ]  7618.2455863         1
[INPUT] 0    0    [1    /1   ]  3618.24038696        1
[INPUT] 0    0    [1    /1   ]  1618.09122882        1
[INPUT] 0    0    [1    /1   ]  239.529786479        1
[INPUT] 0    0    [1    /1   ]  58.6856048425        1
[INPUT] 0    0    [1    /1   ]  16.6695393285        1
[INPUT] 0    0    [1    /1   ]  4.21577461947        1
[INPUT] 0    0    [1    /1   ]  0.393456250921       1
[INPUT] 1    0    [1    /1   ]  1362.79273512        1
[INPUT] 1    0    [1    /1   ]  665.176327529        1
[INPUT] 1    0    [1    /1   ]  303.297145411        1
[INPUT] 1    0    [1    /1   ]  316.125753819        1
[INPUT] 1    0    [1    /1   ]  49.1875410434        1
[INPUT] 1    0    [1    /1   ]  6.61910790089        1
[INPUT] 1    0    [1    /1   ]  15.6607960793        1
[INPUT] 1    0    [1    /1   ]  0.840066320526       1
[INPUT] 1    0    [1    /1   ]  2.99063199118        1
[INPUT] 1    0    [1    /1   ]  0.238309459052       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.508322203463, 1.0]], [0, [7618.245586301049, 1.0]], [0, [3618.2403869592463, 1.0]], [0, [1618.0912288245597, 1.0]], [0, [239.5297864790798, 1.0]], [0, [58.685604842532925, 1.0]], [0, [16.669539328473974, 1.0]], [0, [4.215774619466604, 1.0]], [0, [0.3934562509209827, 1.0]], [1, [1362.7927351183778, 1.0]], [1, [665.176327529396, 1.0]], [1, [303.2971454112895, 1.0]], [1, [316.1257538186582, 1.0]], [1, [49.18754104338716, 1.0]], [1, [6.6191079008891585, 1.0]], [1, [15.660796079284546, 1.0]], [1, [0.8400663205258109, 1.0]], [1, [2.9906319911774597, 1.0]], [1, [0.23830945905158046, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.5083222]
bas 1, expnt(s) = [7618.2455863]
bas 2, expnt(s) = [3618.24038696]
bas 3, expnt(s) = [1618.09122882]
bas 4, expnt(s) = [239.52978648]
bas 5, expnt(s) = [58.68560484]
bas 6, expnt(s) = [16.66953933]
bas 7, expnt(s) = [4.21577462]
bas 8, expnt(s) = [0.39345625]
bas 9, expnt(s) = [1362.79273512]
bas 10, expnt(s) = [665.17632753]
bas 11, expnt(s) = [303.29714541]
bas 12, expnt(s) = [316.12575382]
bas 13, expnt(s) = [49.18754104]
bas 14, expnt(s) = [6.6191079]
bas 15, expnt(s) = [15.66079608]
bas 16, expnt(s) = [0.84006632]
bas 17, expnt(s) = [2.99063199]
bas 18, expnt(s) = [0.23830946]
CPU time:       190.62
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825083e+04 5.20024089e+03 7.61824559e+03 2.06018514e+03
 3.61824039e+03 1.17865876e+03 1.61809123e+03 6.44565827e+02
 2.39529786e+02 1.53827744e+02 5.86856048e+01 5.35690214e+01
 1.66695393e+01 2.08428797e+01 4.21577462e+00 7.43315284e+00
 3.93456251e-01 1.25512610e+00 1.36279274e+03 2.41558128e+04
 6.65176328e+02 9.85497153e+03 3.03297145e+02 3.69249398e+03
 3.16125754e+02 3.88874298e+03 4.91875410e+01 3.80017225e+02
 6.61910790e+00 3.09730318e+01 1.56607961e+01 9.08869827e+01
 8.40066321e-01 2.34626120e+00 2.99063199e+00 1.14732937e+01
 2.38309459e-01 4.85747969e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.977440538849784
cond(S) = 87325.28765881406
E1 = -728.3608792850993  E_coul = 203.05476460066885
init E= -525.30611468443
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558907893602648  LUMO = 1.14688701640244
  mo_energy =
[-1.18107591e+02 -1.21440469e+01 -9.45297466e+00 -9.45297466e+00
 -9.45297466e+00 -1.22878572e+00 -5.58907894e-01 -5.58907894e-01
 -5.58907894e-01  1.14688702e+00  1.14688702e+00  1.14688702e+00
  7.70561639e+00  7.70561639e+00  7.70561639e+00  2.69732217e+01
  2.98794888e+01  2.98794888e+01  2.98794888e+01  1.03258651e+02
  1.03258651e+02  1.03258651e+02  2.65849701e+02  4.32617667e+02
  4.32617667e+02  4.32617667e+02  1.28463828e+03  1.28463828e+03
  1.28463828e+03  1.98982070e+03  2.98584167e+03  2.98584167e+03
  2.98584167e+03  6.61412282e+03  6.61412282e+03  6.61412282e+03
  8.34051210e+03  2.47243971e+04  7.55162392e+04]
E1 = -727.5309103722358  E_coul = 201.44485473154177
cycle= 1 E= -526.086055640694  delta_E= -0.78  |g|= 0.205  |ddm|= 0.408
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.564253
diis-c [-0.31838126  1.        ]
  HOMO = -0.576304243572121  LUMO = 1.13448481856152
  mo_energy =
[-1.18392635e+02 -1.22489123e+01 -9.56590201e+00 -9.56590201e+00
 -9.56590201e+00 -1.25271805e+00 -5.76304244e-01 -5.76304244e-01
 -5.76304244e-01  1.13448482e+00  1.13448482e+00  1.13448482e+00
  7.64569487e+00  7.64569487e+00  7.64569487e+00  2.68543472e+01
  2.97714417e+01  2.97714417e+01  2.97714417e+01  1.03078700e+02
  1.03078700e+02  1.03078700e+02  2.65582319e+02  4.32332711e+02
  4.32332711e+02  4.32332711e+02  1.28428704e+03  1.28428704e+03
  1.28428704e+03  1.98931849e+03  2.98541317e+03  2.98541317e+03
  2.98541317e+03  6.61355371e+03  6.61355371e+03  6.61355371e+03
  8.33984547e+03  2.47236233e+04  7.55153646e+04]
E1 = -727.8897786360697  E_coul = 201.8032699850324
cycle= 2 E= -526.086508651037  delta_E= -0.000453  |g|= 0.0288  |ddm|= 0.0266
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0574968
diis-c [-0.00206978  0.05883488  0.94116512]
  HOMO = -0.57167781320176  LUMO = 1.13839958496483
  mo_energy =
[-1.18343031e+02 -1.22247048e+01 -9.54089907e+00 -9.54089907e+00
 -9.54089907e+00 -1.24671159e+00 -5.71677813e-01 -5.71677813e-01
 -5.71677813e-01  1.13839958e+00  1.13839958e+00  1.13839958e+00
  7.65911288e+00  7.65911288e+00  7.65911288e+00  2.68830367e+01
  2.97947491e+01  2.97947491e+01  2.97947491e+01  1.03115284e+02
  1.03115284e+02  1.03115284e+02  2.65629786e+02  4.32381614e+02
  4.32381614e+02  4.32381614e+02  1.28433967e+03  1.28433967e+03
  1.28433967e+03  1.98937357e+03  2.98546761e+03  2.98546761e+03
  2.98546761e+03  6.61360941e+03  6.61360941e+03  6.61360941e+03
  8.33990174e+03  2.47236798e+04  7.55154212e+04]
E1 = -727.8122956632837  E_coul = 201.72576640371418
cycle= 3 E= -526.08652925957  delta_E= -2.06e-05  |g|= 0.00388  |ddm|= 0.0067
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00847849
diis-c [-3.52889242e-07 -1.19452924e-03  1.22490635e-01  8.78703894e-01]
  HOMO = -0.572433594218386  LUMO = 1.13777477172365
  mo_energy =
[-1.18349322e+02 -1.22280112e+01 -9.54438930e+00 -9.54438930e+00
 -9.54438930e+00 -1.24766594e+00 -5.72433594e-01 -5.72433594e-01
 -5.72433594e-01  1.13777477e+00  1.13777477e+00  1.13777477e+00
  7.65709789e+00  7.65709789e+00  7.65709789e+00  2.68792874e+01
  2.97914827e+01  2.97914827e+01  2.97914827e+01  1.03110488e+02
  1.03110488e+02  1.03110488e+02  2.65623751e+02  4.32375406e+02
  4.32375406e+02  4.32375406e+02  1.28433298e+03  1.28433298e+03
  1.28433298e+03  1.98936642e+03  2.98546062e+03  2.98546062e+03
  2.98546062e+03  6.61360211e+03  6.61360211e+03  6.61360211e+03
  8.33989426e+03  2.47236722e+04  7.55154135e+04]
E1 = -727.8228183666538  E_coul = 201.7362886262903
cycle= 4 E= -526.086529740364  delta_E= -4.81e-07  |g|= 3.96e-05  |ddm|= 0.000933
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.94214e-05
diis-c [-2.03673513e-09  3.50926770e-05 -4.75645134e-03 -3.73565043e-02
  1.04207786e+00]
  HOMO = -0.572413880698334  LUMO = 1.13779043742274
  mo_energy =
[-1.18349270e+02 -1.22279464e+01 -9.54433019e+00 -9.54433019e+00
 -9.54433019e+00 -1.24763970e+00 -5.72413881e-01 -5.72413881e-01
 -5.72413881e-01  1.13779044e+00  1.13779044e+00  1.13779044e+00
  7.65714197e+00  7.65714197e+00  7.65714197e+00  2.68793530e+01
  2.97915377e+01  2.97915377e+01  2.97915377e+01  1.03110545e+02
  1.03110545e+02  1.03110545e+02  2.65623804e+02  4.32375458e+02
  4.32375458e+02  4.32375458e+02  1.28433302e+03  1.28433302e+03
  1.28433302e+03  1.98936645e+03  2.98546066e+03  2.98546066e+03
  2.98546066e+03  6.61360214e+03  6.61360214e+03  6.61360214e+03
  8.33989428e+03  2.47236722e+04  7.55154135e+04]
E1 = -727.8226860129098  E_coul = 201.73615627248574
cycle= 5 E= -526.086529740424  delta_E= -6.06e-11  |g|= 8.85e-06  |ddm|= 1.76e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.8226860129098  E_coul = 201.73615627248574
  HOMO = -0.572418063333218  LUMO = 1.13778706967311
  mo_energy =
[-1.18349291e+02 -1.22279610e+01 -9.54434529e+00 -9.54434529e+00
 -9.54434529e+00 -1.24764502e+00 -5.72418063e-01 -5.72418063e-01
 -5.72418063e-01  1.13778707e+00  1.13778707e+00  1.13778707e+00
  7.65713197e+00  7.65713197e+00  7.65713197e+00  2.68793377e+01
  2.97915235e+01  2.97915235e+01  2.97915235e+01  1.03110528e+02
  1.03110528e+02  1.03110528e+02  2.65623784e+02  4.32375438e+02
  4.32375438e+02  4.32375438e+02  1.28433300e+03  1.28433300e+03
  1.28433300e+03  1.98936643e+03  2.98546064e+03  2.98546064e+03
  2.98546064e+03  6.61360212e+03  6.61360212e+03  6.61360212e+03
  8.33989426e+03  2.47236722e+04  7.55154135e+04]
E1 = -727.8227267740102  E_coul = 201.7361970335818
Extra cycle  E= -526.086529740428  delta_E= -4.32e-12  |g|= 2.4e-06  |ddm|= 4.18e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 87325.28765881406
E1 = -727.8227267740102  E_coul = 201.7361970335818
init E= -526.086529740428
    CPU time for initialize scf      2.70 sec, wall time      0.24 sec
  HOMO = -0.57241732155003  LUMO = 1.13778767593284
  mo_energy =
[-1.18349286e+02 -1.22279580e+01 -9.54434221e+00 -9.54434221e+00
 -9.54434221e+00 -1.24764407e+00 -5.72417322e-01 -5.72417322e-01
 -5.72417322e-01  1.13778768e+00  1.13778768e+00  1.13778768e+00
  7.65713385e+00  7.65713385e+00  7.65713385e+00  2.68793410e+01
  2.97915264e+01  2.97915264e+01  2.97915264e+01  1.03110532e+02
  1.03110532e+02  1.03110532e+02  2.65623788e+02  4.32375442e+02
  4.32375442e+02  4.32375442e+02  1.28433301e+03  1.28433301e+03
  1.28433301e+03  1.98936643e+03  2.98546064e+03  2.98546064e+03
  2.98546064e+03  6.61360213e+03  6.61360213e+03  6.61360213e+03
  8.33989426e+03  2.47236722e+04  7.55154135e+04]
E1 = -727.8227179510469  E_coul = 201.73618821061936
cycle= 1 E= -526.086529740428  delta_E= 9.09e-13  |g|= 5.68e-07  |ddm|= 8.35e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.8227179510469  E_coul = 201.73618821061936
  HOMO = -0.572417471223054  LUMO = 1.13778755269695
  mo_energy =
[-1.18349287e+02 -1.22279587e+01 -9.54434287e+00 -9.54434287e+00
 -9.54434287e+00 -1.24764426e+00 -5.72417471e-01 -5.72417471e-01
 -5.72417471e-01  1.13778755e+00  1.13778755e+00  1.13778755e+00
  7.65713346e+00  7.65713346e+00  7.65713346e+00  2.68793402e+01
  2.97915258e+01  2.97915258e+01  2.97915258e+01  1.03110531e+02
  1.03110531e+02  1.03110531e+02  2.65623787e+02  4.32375441e+02
  4.32375441e+02  4.32375441e+02  1.28433301e+03  1.28433301e+03
  1.28433301e+03  1.98936643e+03  2.98546064e+03  2.98546064e+03
  2.98546064e+03  6.61360212e+03  6.61360212e+03  6.61360212e+03
  8.33989426e+03  2.47236722e+04  7.55154135e+04]
E1 = -727.8227199028912  E_coul = 201.73619016246266
Extra cycle  E= -526.086529740429  delta_E= -1.02e-12  |g|= 1.3e-07  |ddm|= 1.79e-07
    CPU time for scf_cycle      2.83 sec, wall time      0.36 sec
exp = [2.61825083e+04 7.61824559e+03 3.61824039e+03 1.61809123e+03
 2.39529786e+02 5.86856048e+01 1.66695393e+01 4.21577462e+00
 3.93456251e-01 1.36279274e+03 6.65176328e+02 3.03297145e+02
 3.16125754e+02 4.91875410e+01 6.61910790e+00 1.56607961e+01
 8.40066321e-01 2.99063199e+00 2.38309459e-01]
grad_E = [-1.96128625e-06  2.54962623e-05  5.54160617e-05  8.06947823e-04
 -7.36546230e-03 -5.84609810e-03  2.48922848e-03 -4.65980534e-03
 -2.08516595e-02  1.32411036e-06  1.98951453e-05  1.07139204e-04
  9.44215293e-05  1.64420391e-04  1.05450039e-02 -1.20581638e-02
  6.16340957e-02  8.12157333e-04 -5.48452544e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:40:30 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5083453        1
[INPUT] 0    0    [1    /1   ]  7618.24531089        1
[INPUT] 0    0    [1    /1   ]  3618.23981256        1
[INPUT] 0    0    [1    /1   ]  1618.08264481        1
[INPUT] 0    0    [1    /1   ]  239.56263072         1
[INPUT] 0    0    [1    /1   ]  58.910999199         1
[INPUT] 0    0    [1    /1   ]  16.9465322938        1
[INPUT] 0    0    [1    /1   ]  4.24279423063        1
[INPUT] 0    0    [1    /1   ]  0.394226882056       1
[INPUT] 1    0    [1    /1   ]  1362.79272047        1
[INPUT] 1    0    [1    /1   ]  665.176100636        1
[INPUT] 1    0    [1    /1   ]  303.295926283        1
[INPUT] 1    0    [1    /1   ]  316.124679552        1
[INPUT] 1    0    [1    /1   ]  49.1862639773        1
[INPUT] 1    0    [1    /1   ]  6.67050357555        1
[INPUT] 1    0    [1    /1   ]  15.7320089368        1
[INPUT] 1    0    [1    /1   ]  0.795585054038       1
[INPUT] 1    0    [1    /1   ]  2.9161598695         1
[INPUT] 1    0    [1    /1   ]  0.227708351999       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.50834532771, 1.0]], [0, [7618.245310885924, 1.0]], [0, [3618.2398125613486, 1.0]], [0, [1618.0826448078408, 1.0]], [0, [239.56263071993007, 1.0]], [0, [58.910999198973485, 1.0]], [0, [16.946532293815313, 1.0]], [0, [4.2427942306338915, 1.0]], [0, [0.39422688205591516, 1.0]], [1, [1362.792720465872, 1.0]], [1, [665.1761006358629, 1.0]], [1, [303.2959262830004, 1.0]], [1, [316.12467955181495, 1.0]], [1, [49.186263977317545, 1.0]], [1, [6.670503575550035, 1.0]], [1, [15.732008936794326, 1.0]], [1, [0.7955850540382094, 1.0]], [1, [2.9161598695021462, 1.0]], [1, [0.22770835199909914, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50834533]
bas 1, expnt(s) = [7618.24531089]
bas 2, expnt(s) = [3618.23981256]
bas 3, expnt(s) = [1618.08264481]
bas 4, expnt(s) = [239.56263072]
bas 5, expnt(s) = [58.9109992]
bas 6, expnt(s) = [16.94653229]
bas 7, expnt(s) = [4.24279423]
bas 8, expnt(s) = [0.39422688]
bas 9, expnt(s) = [1362.79272047]
bas 10, expnt(s) = [665.17610064]
bas 11, expnt(s) = [303.29592628]
bas 12, expnt(s) = [316.12467955]
bas 13, expnt(s) = [49.18626398]
bas 14, expnt(s) = [6.67050358]
bas 15, expnt(s) = [15.73200894]
bas 16, expnt(s) = [0.79558505]
bas 17, expnt(s) = [2.91615987]
bas 18, expnt(s) = [0.22770835]
CPU time:       198.72
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825083e+04 5.20024089e+03 7.61824531e+03 2.06018509e+03
 3.61823981e+03 1.17865862e+03 1.61808264e+03 6.44563263e+02
 2.39562631e+02 1.53843563e+02 5.89109992e+01 5.37232548e+01
 1.69465323e+01 2.11020990e+01 4.24279423e+00 7.46885454e+00
 3.94226882e-01 1.25696939e+00 1.36279272e+03 2.41558124e+04
 6.65176101e+02 9.85496732e+03 3.03295926e+02 3.69247543e+03
 3.16124680e+02 3.88872646e+03 4.91862640e+01 3.80004892e+02
 6.67050358e+00 3.12739451e+01 1.57320089e+01 9.14038782e+01
 7.95585054e-01 2.19201066e+00 2.91615987e+00 1.11172803e+01
 2.27708352e-01 4.58889471e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.979294219205258
cond(S) = 87280.89695217999
E1 = -728.3822315809525  E_coul = 203.07052449075488
init E= -525.311707090198
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558857239583925  LUMO = 1.06633322405754
  mo_energy =
[-1.18107864e+02 -1.21415541e+01 -9.45158036e+00 -9.45158036e+00
 -9.45158036e+00 -1.22876047e+00 -5.58857240e-01 -5.58857240e-01
 -5.58857240e-01  1.06633322e+00  1.06633322e+00  1.06633322e+00
  7.40104273e+00  7.40104273e+00  7.40104273e+00  2.75451714e+01
  2.95868275e+01  2.95868275e+01  2.95868275e+01  1.03209432e+02
  1.03209432e+02  1.03209432e+02  2.67648687e+02  4.32684552e+02
  4.32684552e+02  4.32684552e+02  1.28470947e+03  1.28470947e+03
  1.28470947e+03  1.99178886e+03  2.98590768e+03  2.98590768e+03
  2.98590768e+03  6.61418169e+03  6.61418169e+03  6.61418169e+03
  8.34232591e+03  2.47261099e+04  7.55178300e+04]
E1 = -727.4896070204123  E_coul = 201.4010708096084
cycle= 1 E= -526.088536210804  delta_E= -0.777  |g|= 0.205  |ddm|= 0.339
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.561317
diis-c [-0.31507652  1.        ]
  HOMO = -0.578074722007259  LUMO = 1.05361127520754
  mo_energy =
[-1.18396873e+02 -1.22514418e+01 -9.56874607e+00 -9.56874607e+00
 -9.56874607e+00 -1.25524420e+00 -5.78074722e-01 -5.78074722e-01
 -5.78074722e-01  1.05361128e+00  1.05361128e+00  1.05361128e+00
  7.33817678e+00  7.33817678e+00  7.33817678e+00  2.74202047e+01
  2.94743109e+01  2.94743109e+01  2.94743109e+01  1.03025144e+02
  1.03025144e+02  1.03025144e+02  2.67377174e+02  4.32395605e+02
  4.32395605e+02  4.32395605e+02  1.28435442e+03  1.28435442e+03
  1.28435442e+03  1.99128326e+03  2.98547561e+03  2.98547561e+03
  2.98547561e+03  6.61360919e+03  6.61360919e+03  6.61360919e+03
  8.34165603e+03  2.47253328e+04  7.55169522e+04]
E1 = -727.85945105664  E_coul = 201.77045664331678
cycle= 2 E= -526.088994413323  delta_E= -0.000458  |g|= 0.029  |ddm|= 0.028
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0577663
diis-c [-0.00211052  0.05891183  0.94108817]
  HOMO = -0.573142194961942  LUMO = 1.05750085236283
  mo_energy =
[-1.18346455e+02 -1.22264932e+01 -9.54298119e+00 -9.54298119e+00
 -9.54298119e+00 -1.24884638e+00 -5.73142195e-01 -5.73142195e-01
 -5.73142195e-01  1.05750085e+00  1.05750085e+00  1.05750085e+00
  7.35206026e+00  7.35206026e+00  7.35206026e+00  2.74498002e+01
  2.94984297e+01  2.94984297e+01  2.94984297e+01  1.03062551e+02
  1.03062551e+02  1.03062551e+02  2.67425468e+02  4.32445320e+02
  4.32445320e+02  4.32445320e+02  1.28440788e+03  1.28440788e+03
  1.28440788e+03  1.99133920e+03  2.98553090e+03  2.98553090e+03
  2.98553090e+03  6.61366577e+03  6.61366577e+03  6.61366577e+03
  8.34171319e+03  2.47253903e+04  7.55170098e+04]
E1 = -727.7793637275324  E_coul = 201.69034783274566
cycle= 3 E= -526.089015894787  delta_E= -2.15e-05  |g|= 0.00396  |ddm|= 0.00693
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00856229
diis-c [-3.04867470e-07 -1.16856392e-03  1.23369865e-01  8.77798699e-01]
  HOMO = -0.573933197582529  LUMO = 1.05688924348104
  mo_energy =
[-1.18352905e+02 -1.22299171e+01 -9.54658458e+00 -9.54658458e+00
 -9.54658458e+00 -1.24984848e+00 -5.73933198e-01 -5.73933198e-01
 -5.73933198e-01  1.05688924e+00  1.05688924e+00  1.05688924e+00
  7.34998759e+00  7.34998759e+00  7.34998759e+00  2.74459013e+01
  2.94950465e+01  2.94950465e+01  2.94950465e+01  1.03057613e+02
  1.03057613e+02  1.03057613e+02  2.67419276e+02  4.32438954e+02
  4.32438954e+02  4.32438954e+02  1.28440103e+03  1.28440103e+03
  1.28440103e+03  1.99133189e+03  2.98552375e+03  2.98552375e+03
  2.98552375e+03  6.61365831e+03  6.61365831e+03  6.61365831e+03
  8.34170556e+03  2.47253825e+04  7.55170019e+04]
E1 = -727.7902800697611  E_coul = 201.7012636662648
cycle= 4 E= -526.089016403496  delta_E= -5.09e-07  |g|= 3.71e-05  |ddm|= 0.00097
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.35251e-05
diis-c [-1.87831200e-09  3.16747054e-05 -4.40381644e-03 -3.38085147e-02
  1.03818066e+00]
  HOMO = -0.573913554214718  LUMO = 1.05690392828532
  mo_energy =
[-1.18352853e+02 -1.22298537e+01 -9.54652631e+00 -9.54652631e+00
 -9.54652631e+00 -1.24982246e+00 -5.73913554e-01 -5.73913554e-01
 -5.73913554e-01  1.05690393e+00  1.05690393e+00  1.05690393e+00
  7.35003083e+00  7.35003083e+00  7.35003083e+00  2.74459655e+01
  2.94951008e+01  2.94951008e+01  2.94951008e+01  1.03057670e+02
  1.03057670e+02  1.03057670e+02  2.67419328e+02  4.32439006e+02
  4.32439006e+02  4.32439006e+02  1.28440108e+03  1.28440108e+03
  1.28440108e+03  1.99133193e+03  2.98552379e+03  2.98552379e+03
  2.98552379e+03  6.61365835e+03  6.61365835e+03  6.61365835e+03
  8.34170559e+03  2.47253825e+04  7.55170019e+04]
E1 = -727.7901460862914  E_coul = 201.70112968273605
cycle= 5 E= -526.089016403555  delta_E= -5.91e-11  |g|= 8.42e-06  |ddm|= 1.73e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.7901460862914  E_coul = 201.70112968273605
  HOMO = -0.573917612710051  LUMO = 1.05690086310834
  mo_energy =
[-1.18352873e+02 -1.22298678e+01 -9.54654078e+00 -9.54654078e+00
 -9.54654078e+00 -1.24982762e+00 -5.73917613e-01 -5.73917613e-01
 -5.73917613e-01  1.05690086e+00  1.05690086e+00  1.05690086e+00
  7.35002128e+00  7.35002128e+00  7.35002128e+00  2.74459507e+01
  2.94950872e+01  2.94950872e+01  2.94950872e+01  1.03057653e+02
  1.03057653e+02  1.03057653e+02  2.67419309e+02  4.32438987e+02
  4.32438987e+02  4.32438987e+02  1.28440106e+03  1.28440106e+03
  1.28440106e+03  1.99133190e+03  2.98552377e+03  2.98552377e+03
  2.98552377e+03  6.61365832e+03  6.61365832e+03  6.61365832e+03
  8.34170557e+03  2.47253825e+04  7.55170019e+04]
E1 = -727.7901855771654  E_coul = 201.70116917360542
Extra cycle  E= -526.08901640356  delta_E= -4.55e-12  |g|= 2.3e-06  |ddm|= 4.04e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.23 sec
exp = [2.61825083e+04 7.61824531e+03 3.61823981e+03 1.61808264e+03
 2.39562631e+02 5.89109992e+01 1.69465323e+01 4.24279423e+00
 3.94226882e-01 1.36279272e+03 6.65176101e+02 3.03295926e+02
 3.16124680e+02 4.91862640e+01 6.67050358e+00 1.57320089e+01
 7.95585054e-01 2.91615987e+00 2.27708352e-01]
E = -526.08901640356
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:40:30 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5083453        1
[INPUT] 0    0    [1    /1   ]  7618.24531089        1
[INPUT] 0    0    [1    /1   ]  3618.23981256        1
[INPUT] 0    0    [1    /1   ]  1618.08264481        1
[INPUT] 0    0    [1    /1   ]  239.56263072         1
[INPUT] 0    0    [1    /1   ]  58.910999199         1
[INPUT] 0    0    [1    /1   ]  16.9465322938        1
[INPUT] 0    0    [1    /1   ]  4.24279423063        1
[INPUT] 0    0    [1    /1   ]  0.394226882056       1
[INPUT] 1    0    [1    /1   ]  1362.79272047        1
[INPUT] 1    0    [1    /1   ]  665.176100636        1
[INPUT] 1    0    [1    /1   ]  303.295926283        1
[INPUT] 1    0    [1    /1   ]  316.124679552        1
[INPUT] 1    0    [1    /1   ]  49.1862639773        1
[INPUT] 1    0    [1    /1   ]  6.67050357555        1
[INPUT] 1    0    [1    /1   ]  15.7320089368        1
[INPUT] 1    0    [1    /1   ]  0.795585054038       1
[INPUT] 1    0    [1    /1   ]  2.9161598695         1
[INPUT] 1    0    [1    /1   ]  0.227708351999       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.50834532771, 1.0]], [0, [7618.245310885924, 1.0]], [0, [3618.2398125613486, 1.0]], [0, [1618.0826448078408, 1.0]], [0, [239.56263071993007, 1.0]], [0, [58.910999198973485, 1.0]], [0, [16.946532293815313, 1.0]], [0, [4.2427942306338915, 1.0]], [0, [0.39422688205591516, 1.0]], [1, [1362.792720465872, 1.0]], [1, [665.1761006358629, 1.0]], [1, [303.2959262830004, 1.0]], [1, [316.12467955181495, 1.0]], [1, [49.186263977317545, 1.0]], [1, [6.670503575550035, 1.0]], [1, [15.732008936794326, 1.0]], [1, [0.7955850540382094, 1.0]], [1, [2.9161598695021462, 1.0]], [1, [0.22770835199909914, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50834533]
bas 1, expnt(s) = [7618.24531089]
bas 2, expnt(s) = [3618.23981256]
bas 3, expnt(s) = [1618.08264481]
bas 4, expnt(s) = [239.56263072]
bas 5, expnt(s) = [58.9109992]
bas 6, expnt(s) = [16.94653229]
bas 7, expnt(s) = [4.24279423]
bas 8, expnt(s) = [0.39422688]
bas 9, expnt(s) = [1362.79272047]
bas 10, expnt(s) = [665.17610064]
bas 11, expnt(s) = [303.29592628]
bas 12, expnt(s) = [316.12467955]
bas 13, expnt(s) = [49.18626398]
bas 14, expnt(s) = [6.67050358]
bas 15, expnt(s) = [15.73200894]
bas 16, expnt(s) = [0.79558505]
bas 17, expnt(s) = [2.91615987]
bas 18, expnt(s) = [0.22770835]
CPU time:       199.43
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825083e+04 5.20024089e+03 7.61824531e+03 2.06018509e+03
 3.61823981e+03 1.17865862e+03 1.61808264e+03 6.44563263e+02
 2.39562631e+02 1.53843563e+02 5.89109992e+01 5.37232548e+01
 1.69465323e+01 2.11020990e+01 4.24279423e+00 7.46885454e+00
 3.94226882e-01 1.25696939e+00 1.36279272e+03 2.41558124e+04
 6.65176101e+02 9.85496732e+03 3.03295926e+02 3.69247543e+03
 3.16124680e+02 3.88872646e+03 4.91862640e+01 3.80004892e+02
 6.67050358e+00 3.12739451e+01 1.57320089e+01 9.14038782e+01
 7.95585054e-01 2.19201066e+00 2.91615987e+00 1.11172803e+01
 2.27708352e-01 4.58889471e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.979294219205258
cond(S) = 87280.89695217999
E1 = -728.3822315809525  E_coul = 203.07052449075488
init E= -525.311707090198
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558857239583925  LUMO = 1.06633322405754
  mo_energy =
[-1.18107864e+02 -1.21415541e+01 -9.45158036e+00 -9.45158036e+00
 -9.45158036e+00 -1.22876047e+00 -5.58857240e-01 -5.58857240e-01
 -5.58857240e-01  1.06633322e+00  1.06633322e+00  1.06633322e+00
  7.40104273e+00  7.40104273e+00  7.40104273e+00  2.75451714e+01
  2.95868275e+01  2.95868275e+01  2.95868275e+01  1.03209432e+02
  1.03209432e+02  1.03209432e+02  2.67648687e+02  4.32684552e+02
  4.32684552e+02  4.32684552e+02  1.28470947e+03  1.28470947e+03
  1.28470947e+03  1.99178886e+03  2.98590768e+03  2.98590768e+03
  2.98590768e+03  6.61418169e+03  6.61418169e+03  6.61418169e+03
  8.34232591e+03  2.47261099e+04  7.55178300e+04]
E1 = -727.4896070204123  E_coul = 201.4010708096084
cycle= 1 E= -526.088536210804  delta_E= -0.777  |g|= 0.205  |ddm|= 0.339
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.561317
diis-c [-0.31507652  1.        ]
  HOMO = -0.578074722007259  LUMO = 1.05361127520754
  mo_energy =
[-1.18396873e+02 -1.22514418e+01 -9.56874607e+00 -9.56874607e+00
 -9.56874607e+00 -1.25524420e+00 -5.78074722e-01 -5.78074722e-01
 -5.78074722e-01  1.05361128e+00  1.05361128e+00  1.05361128e+00
  7.33817678e+00  7.33817678e+00  7.33817678e+00  2.74202047e+01
  2.94743109e+01  2.94743109e+01  2.94743109e+01  1.03025144e+02
  1.03025144e+02  1.03025144e+02  2.67377174e+02  4.32395605e+02
  4.32395605e+02  4.32395605e+02  1.28435442e+03  1.28435442e+03
  1.28435442e+03  1.99128326e+03  2.98547561e+03  2.98547561e+03
  2.98547561e+03  6.61360919e+03  6.61360919e+03  6.61360919e+03
  8.34165603e+03  2.47253328e+04  7.55169522e+04]
E1 = -727.85945105664  E_coul = 201.77045664331678
cycle= 2 E= -526.088994413323  delta_E= -0.000458  |g|= 0.029  |ddm|= 0.028
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0577663
diis-c [-0.00211052  0.05891183  0.94108817]
  HOMO = -0.573142194961942  LUMO = 1.05750085236283
  mo_energy =
[-1.18346455e+02 -1.22264932e+01 -9.54298119e+00 -9.54298119e+00
 -9.54298119e+00 -1.24884638e+00 -5.73142195e-01 -5.73142195e-01
 -5.73142195e-01  1.05750085e+00  1.05750085e+00  1.05750085e+00
  7.35206026e+00  7.35206026e+00  7.35206026e+00  2.74498002e+01
  2.94984297e+01  2.94984297e+01  2.94984297e+01  1.03062551e+02
  1.03062551e+02  1.03062551e+02  2.67425468e+02  4.32445320e+02
  4.32445320e+02  4.32445320e+02  1.28440788e+03  1.28440788e+03
  1.28440788e+03  1.99133920e+03  2.98553090e+03  2.98553090e+03
  2.98553090e+03  6.61366577e+03  6.61366577e+03  6.61366577e+03
  8.34171319e+03  2.47253903e+04  7.55170098e+04]
E1 = -727.7793637275324  E_coul = 201.69034783274566
cycle= 3 E= -526.089015894787  delta_E= -2.15e-05  |g|= 0.00396  |ddm|= 0.00693
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00856229
diis-c [-3.04867470e-07 -1.16856392e-03  1.23369865e-01  8.77798699e-01]
  HOMO = -0.573933197582529  LUMO = 1.05688924348104
  mo_energy =
[-1.18352905e+02 -1.22299171e+01 -9.54658458e+00 -9.54658458e+00
 -9.54658458e+00 -1.24984848e+00 -5.73933198e-01 -5.73933198e-01
 -5.73933198e-01  1.05688924e+00  1.05688924e+00  1.05688924e+00
  7.34998759e+00  7.34998759e+00  7.34998759e+00  2.74459013e+01
  2.94950465e+01  2.94950465e+01  2.94950465e+01  1.03057613e+02
  1.03057613e+02  1.03057613e+02  2.67419276e+02  4.32438954e+02
  4.32438954e+02  4.32438954e+02  1.28440103e+03  1.28440103e+03
  1.28440103e+03  1.99133189e+03  2.98552375e+03  2.98552375e+03
  2.98552375e+03  6.61365831e+03  6.61365831e+03  6.61365831e+03
  8.34170556e+03  2.47253825e+04  7.55170019e+04]
E1 = -727.7902800697611  E_coul = 201.7012636662648
cycle= 4 E= -526.089016403496  delta_E= -5.09e-07  |g|= 3.71e-05  |ddm|= 0.00097
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.35251e-05
diis-c [-1.87831200e-09  3.16747054e-05 -4.40381644e-03 -3.38085147e-02
  1.03818066e+00]
  HOMO = -0.573913554214718  LUMO = 1.05690392828532
  mo_energy =
[-1.18352853e+02 -1.22298537e+01 -9.54652631e+00 -9.54652631e+00
 -9.54652631e+00 -1.24982246e+00 -5.73913554e-01 -5.73913554e-01
 -5.73913554e-01  1.05690393e+00  1.05690393e+00  1.05690393e+00
  7.35003083e+00  7.35003083e+00  7.35003083e+00  2.74459655e+01
  2.94951008e+01  2.94951008e+01  2.94951008e+01  1.03057670e+02
  1.03057670e+02  1.03057670e+02  2.67419328e+02  4.32439006e+02
  4.32439006e+02  4.32439006e+02  1.28440108e+03  1.28440108e+03
  1.28440108e+03  1.99133193e+03  2.98552379e+03  2.98552379e+03
  2.98552379e+03  6.61365835e+03  6.61365835e+03  6.61365835e+03
  8.34170559e+03  2.47253825e+04  7.55170019e+04]
E1 = -727.7901460862914  E_coul = 201.70112968273605
cycle= 5 E= -526.089016403555  delta_E= -5.91e-11  |g|= 8.42e-06  |ddm|= 1.73e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.7901460862914  E_coul = 201.70112968273605
  HOMO = -0.573917612710051  LUMO = 1.05690086310834
  mo_energy =
[-1.18352873e+02 -1.22298678e+01 -9.54654078e+00 -9.54654078e+00
 -9.54654078e+00 -1.24982762e+00 -5.73917613e-01 -5.73917613e-01
 -5.73917613e-01  1.05690086e+00  1.05690086e+00  1.05690086e+00
  7.35002128e+00  7.35002128e+00  7.35002128e+00  2.74459507e+01
  2.94950872e+01  2.94950872e+01  2.94950872e+01  1.03057653e+02
  1.03057653e+02  1.03057653e+02  2.67419309e+02  4.32438987e+02
  4.32438987e+02  4.32438987e+02  1.28440106e+03  1.28440106e+03
  1.28440106e+03  1.99133190e+03  2.98552377e+03  2.98552377e+03
  2.98552377e+03  6.61365832e+03  6.61365832e+03  6.61365832e+03
  8.34170557e+03  2.47253825e+04  7.55170019e+04]
E1 = -727.7901855771654  E_coul = 201.70116917360542
Extra cycle  E= -526.08901640356  delta_E= -4.55e-12  |g|= 2.3e-06  |ddm|= 4.04e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 87280.89695217999
E1 = -727.7901855771654  E_coul = 201.70116917360542
init E= -526.08901640356
    CPU time for initialize scf      2.71 sec, wall time      0.24 sec
  HOMO = -0.57391688428953  LUMO = 1.05690142067327
  mo_energy =
[-1.18352868e+02 -1.22298649e+01 -9.54653780e+00 -9.54653780e+00
 -9.54653780e+00 -1.24982669e+00 -5.73916884e-01 -5.73916884e-01
 -5.73916884e-01  1.05690142e+00  1.05690142e+00  1.05690142e+00
  7.35002310e+00  7.35002310e+00  7.35002310e+00  2.74459539e+01
  2.94950900e+01  2.94950900e+01  2.94950900e+01  1.03057657e+02
  1.03057657e+02  1.03057657e+02  2.67419314e+02  4.32438992e+02
  4.32438992e+02  4.32438992e+02  1.28440106e+03  1.28440106e+03
  1.28440106e+03  1.99133191e+03  2.98552377e+03  2.98552377e+03
  2.98552377e+03  6.61365833e+03  6.61365833e+03  6.61365833e+03
  8.34170557e+03  2.47253825e+04  7.55170019e+04]
E1 = -727.7901769762613  E_coul = 201.70116057270278
cycle= 1 E= -526.089016403559  delta_E= 1.48e-12  |g|= 5.47e-07  |ddm|= 8.13e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.7901769762613  E_coul = 201.70116057270278
  HOMO = -0.573917032420165  LUMO = 1.05690130654378
  mo_energy =
[-1.18352869e+02 -1.22298655e+01 -9.54653845e+00 -9.54653845e+00
 -9.54653845e+00 -1.24982688e+00 -5.73917032e-01 -5.73917032e-01
 -5.73917032e-01  1.05690131e+00  1.05690131e+00  1.05690131e+00
  7.35002271e+00  7.35002271e+00  7.35002271e+00  2.74459532e+01
  2.94950894e+01  2.94950894e+01  2.94950894e+01  1.03057656e+02
  1.03057656e+02  1.03057656e+02  2.67419313e+02  4.32438990e+02
  4.32438990e+02  4.32438990e+02  1.28440106e+03  1.28440106e+03
  1.28440106e+03  1.99133191e+03  2.98552377e+03  2.98552377e+03
  2.98552377e+03  6.61365833e+03  6.61365833e+03  6.61365833e+03
  8.34170557e+03  2.47253825e+04  7.55170019e+04]
E1 = -727.7901788896427  E_coul = 201.7011624860839
Extra cycle  E= -526.089016403559  delta_E= -3.41e-13  |g|= 1.26e-07  |ddm|= 1.75e-07
    CPU time for scf_cycle      2.83 sec, wall time      0.36 sec
exp = [2.61825083e+04 7.61824531e+03 3.61823981e+03 1.61808264e+03
 2.39562631e+02 5.89109992e+01 1.69465323e+01 4.24279423e+00
 3.94226882e-01 1.36279272e+03 6.65176101e+02 3.03295926e+02
 3.16124680e+02 4.91862640e+01 6.67050358e+00 1.57320089e+01
 7.95585054e-01 2.91615987e+00 2.27708352e-01]
grad_E = [-1.96081485e-06  2.55924866e-05  5.57271339e-05  8.10513956e-04
 -7.56158994e-03 -5.35694225e-03  2.29980288e-03  4.44252519e-03
 -1.41747480e-02  1.29735344e-06  1.96940383e-05  1.05872220e-04
  9.33101464e-05  4.21073708e-04  1.70084618e-02 -1.40749020e-02
  3.05790115e-02 -6.67832136e-03 -3.77741167e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:40:34 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.508361         1
[INPUT] 0    0    [1    /1   ]  7618.24512043        1
[INPUT] 0    0    [1    /1   ]  3618.23941076        1
[INPUT] 0    0    [1    /1   ]  1618.07668384        1
[INPUT] 0    0    [1    /1   ]  239.594045257        1
[INPUT] 0    0    [1    /1   ]  59.038733289         1
[INPUT] 0    0    [1    /1   ]  17.0736209729        1
[INPUT] 0    0    [1    /1   ]  4.25206631654        1
[INPUT] 0    0    [1    /1   ]  0.394797686053       1
[INPUT] 1    0    [1    /1   ]  1362.79271058        1
[INPUT] 1    0    [1    /1   ]  665.175947324        1
[INPUT] 1    0    [1    /1   ]  303.295103147        1
[INPUT] 1    0    [1    /1   ]  316.123954176        1
[INPUT] 1    0    [1    /1   ]  49.1839111746        1
[INPUT] 1    0    [1    /1   ]  6.6528159817         1
[INPUT] 1    0    [1    /1   ]  15.8025221687        1
[INPUT] 1    0    [1    /1   ]  0.750178617383       1
[INPUT] 1    0    [1    /1   ]  2.89049238045        1
[INPUT] 1    0    [1    /1   ]  0.218470007438       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.50836095151, 1.0]], [0, [7618.245120431905, 1.0]], [0, [3618.23941075764, 1.0]], [0, [1618.076683838062, 1.0]], [0, [239.59404525740266, 1.0]], [0, [59.038733289034376, 1.0]], [0, [17.073620972949783, 1.0]], [0, [4.252066316541689, 1.0]], [0, [0.39479768605252263, 1.0]], [1, [1362.792710577384, 1.0]], [1, [665.1759473237513, 1.0]], [1, [303.29510314736467, 1.0]], [1, [316.12395417593433, 1.0]], [1, [49.183911174622736, 1.0]], [1, [6.652815981702875, 1.0]], [1, [15.802522168696601, 1.0]], [1, [0.7501786173826632, 1.0]], [1, [2.8904923804499987, 1.0]], [1, [0.21847000743762932, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50836095]
bas 1, expnt(s) = [7618.24512043]
bas 2, expnt(s) = [3618.23941076]
bas 3, expnt(s) = [1618.07668384]
bas 4, expnt(s) = [239.59404526]
bas 5, expnt(s) = [59.03873329]
bas 6, expnt(s) = [17.07362097]
bas 7, expnt(s) = [4.25206632]
bas 8, expnt(s) = [0.39479769]
bas 9, expnt(s) = [1362.79271058]
bas 10, expnt(s) = [665.17594732]
bas 11, expnt(s) = [303.29510315]
bas 12, expnt(s) = [316.12395418]
bas 13, expnt(s) = [49.18391117]
bas 14, expnt(s) = [6.65281598]
bas 15, expnt(s) = [15.80252217]
bas 16, expnt(s) = [0.75017862]
bas 17, expnt(s) = [2.89049238]
bas 18, expnt(s) = [0.21847001]
CPU time:       207.51
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825084e+04 5.20024090e+03 7.61824512e+03 2.06018505e+03
 3.61823941e+03 1.17865852e+03 1.61807668e+03 6.44561482e+02
 2.39594045e+02 1.53858693e+02 5.90387333e+01 5.38105954e+01
 1.70736210e+01 2.12206778e+01 4.25206632e+00 7.48109287e+00
 3.94797686e-01 1.25833412e+00 1.36279271e+03 2.41558122e+04
 6.65175947e+02 9.85496449e+03 3.03295103e+02 3.69246290e+03
 3.16123954e+02 3.88871531e+03 4.91839112e+01 3.79982171e+02
 6.65281598e+00 3.11703215e+01 1.58025222e+01 9.19162723e+01
 7.50178617e-01 2.03676181e+00 2.89049238e+00 1.09950999e+01
 2.18470007e-01 4.35736732e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98070965064141
cond(S) = 87231.7766729913
E1 = -728.383963821057  E_coul = 203.07503559316456
init E= -525.308928227892
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558736542038715  LUMO = 0.992819410565544
  mo_energy =
[-1.18108409e+02 -1.21407280e+01 -9.45136308e+00 -9.45136308e+00
 -9.45136308e+00 -1.22871449e+00 -5.58736542e-01 -5.58736542e-01
 -5.58736542e-01  9.92819411e-01  9.92819411e-01  9.92819411e-01
  7.14806916e+00  7.14806916e+00  7.14806916e+00  2.78016372e+01
  2.93121695e+01  2.93121695e+01  2.93121695e+01  1.03091430e+02
  1.03091430e+02  1.03091430e+02  2.68533859e+02  4.32672991e+02
  4.32672991e+02  4.32672991e+02  1.28470997e+03  1.28470997e+03
  1.28470997e+03  1.99281891e+03  2.98590862e+03  2.98590862e+03
  2.98590862e+03  6.61418178e+03  6.61418178e+03  6.61418178e+03
  8.34328628e+03  2.47270177e+04  7.55186730e+04]
E1 = -727.4573796436257  E_coul = 201.367095193279
cycle= 1 E= -526.090284450347  delta_E= -0.781  |g|= 0.206  |ddm|= 0.419
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.561235
diis-c [-0.31498497  1.        ]
  HOMO = -0.578635538607114  LUMO = 0.980735200870106
  mo_energy =
[-1.18400825e+02 -1.22539266e+01 -9.57164169e+00 -9.57164169e+00
 -9.57164169e+00 -1.25630661e+00 -5.78635539e-01 -5.78635539e-01
 -5.78635539e-01  9.80735201e-01  9.80735201e-01  9.80735201e-01
  7.08380101e+00  7.08380101e+00  7.08380101e+00  2.76727228e+01
  2.91965653e+01  2.91965653e+01  2.91965653e+01  1.02903751e+02
  1.02903751e+02  1.02903751e+02  2.68258869e+02  4.32380631e+02
  4.32380631e+02  4.32380631e+02  1.28435158e+03  1.28435158e+03
  1.28435158e+03  1.99231016e+03  2.98547331e+03  2.98547331e+03
  2.98547331e+03  6.61360612e+03  6.61360612e+03  6.61360612e+03
  8.34261330e+03  2.47262375e+04  7.55177921e+04]
E1 = -727.8362918671298  E_coul = 201.74553977413055
cycle= 2 E= -526.090752092999  delta_E= -0.000468  |g|= 0.0292  |ddm|= 0.0295
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.058154
diis-c [-0.00214007  0.05926937  0.94073063]
  HOMO = -0.573446260181774  LUMO = 0.98454754995088
  mo_energy =
[-1.18349671e+02 -1.22283925e+01 -9.54528132e+00 -9.54528132e+00
 -9.54528132e+00 -1.24959104e+00 -5.73446260e-01 -5.73446260e-01
 -5.73446260e-01  9.84547550e-01  9.84547550e-01  9.84547550e-01
  7.09806318e+00  7.09806318e+00  7.09806318e+00  2.77030077e+01
  2.92213077e+01  2.92213077e+01  2.92213077e+01  1.02941855e+02
  1.02941855e+02  1.02941855e+02  2.68307897e+02  4.32431080e+02
  4.32431080e+02  4.32431080e+02  1.28440579e+03  1.28440579e+03
  1.28440579e+03  1.99236690e+03  2.98552938e+03  2.98552938e+03
  2.98552938e+03  6.61366349e+03  6.61366349e+03  6.61366349e+03
  8.34267127e+03  2.47262958e+04  7.55178505e+04]
E1 = -727.7546808840624  E_coul = 201.6639066893577
cycle= 3 E= -526.090774194705  delta_E= -2.21e-05  |g|= 0.004  |ddm|= 0.00707
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00861653
diis-c [-2.90401843e-07 -1.16424666e-03  1.23410307e-01  8.77753940e-01]
  HOMO = -0.574250618585925  LUMO = 0.983967253485502
  mo_energy =
[-1.18356193e+02 -1.22318657e+01 -9.54893394e+00 -9.54893394e+00
 -9.54893394e+00 -1.25061209e+00 -5.74250619e-01 -5.74250619e-01
 -5.74250619e-01  9.83967253e-01  9.83967253e-01  9.83967253e-01
  7.09597489e+00  7.09597489e+00  7.09597489e+00  2.76990452e+01
  2.92178733e+01  2.92178733e+01  2.92178733e+01  1.02936854e+02
  1.02936854e+02  1.02936854e+02  2.68301633e+02  4.32424643e+02
  4.32424643e+02  4.32424643e+02  1.28439887e+03  1.28439887e+03
  1.28439887e+03  1.99235951e+03  2.98552216e+03  2.98552216e+03
  2.98552216e+03  6.61365596e+03  6.61365596e+03  6.61365596e+03
  8.34266356e+03  2.47262879e+04  7.55178426e+04]
E1 = -727.7657351907837  E_coul = 201.67496047798912
cycle= 4 E= -526.090774712795  delta_E= -5.18e-07  |g|= 3.55e-05  |ddm|= 0.000989
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.49435e-05
diis-c [-1.73925968e-09  3.65980867e-05 -4.90597092e-03 -3.78945494e-02
  1.04276392e+00]
  HOMO = -0.574231660748442  LUMO = 0.983980571223276
  mo_energy =
[-1.18356147e+02 -1.22318069e+01 -9.54888029e+00 -9.54888029e+00
 -9.54888029e+00 -1.25058714e+00 -5.74231661e-01 -5.74231661e-01
 -5.74231661e-01  9.83980571e-01  9.83980571e-01  9.83980571e-01
  7.09601547e+00  7.09601547e+00  7.09601547e+00  2.76991048e+01
  2.92179236e+01  2.92179236e+01  2.92179236e+01  1.02936906e+02
  1.02936906e+02  1.02936906e+02  2.68301680e+02  4.32424689e+02
  4.32424689e+02  4.32424689e+02  1.28439891e+03  1.28439891e+03
  1.28439891e+03  1.99235954e+03  2.98552219e+03  2.98552219e+03
  2.98552219e+03  6.61365599e+03  6.61365599e+03  6.61365599e+03
  8.34266358e+03  2.47262879e+04  7.55178426e+04]
E1 = -727.7656147508778  E_coul = 201.6748400380329
cycle= 5 E= -526.090774712845  delta_E= -5.02e-11  |g|= 7.98e-06  |ddm|= 1.54e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.7656147508778  E_coul = 201.6748400380329
  HOMO = -0.574235602714528  LUMO = 0.983977787541974
  mo_energy =
[-1.18356165e+02 -1.22318204e+01 -9.54889422e+00 -9.54889422e+00
 -9.54889422e+00 -1.25059216e+00 -5.74235603e-01 -5.74235603e-01
 -5.74235603e-01  9.83977788e-01  9.83977788e-01  9.83977788e-01
  7.09600630e+00  7.09600630e+00  7.09600630e+00  2.76990905e+01
  2.92179105e+01  2.92179105e+01  2.92179105e+01  1.02936890e+02
  1.02936890e+02  1.02936890e+02  2.68301662e+02  4.32424671e+02
  4.32424671e+02  4.32424671e+02  1.28439889e+03  1.28439889e+03
  1.28439889e+03  1.99235952e+03  2.98552217e+03  2.98552217e+03
  2.98552217e+03  6.61365597e+03  6.61365597e+03  6.61365597e+03
  8.34266356e+03  2.47262879e+04  7.55178426e+04]
E1 = -727.7656526171984  E_coul = 201.67487790435078
Extra cycle  E= -526.090774712848  delta_E= -2.73e-12  |g|= 2.18e-06  |ddm|= 3.91e-06
    CPU time for scf_cycle      0.63 sec, wall time      0.24 sec
exp = [2.61825084e+04 7.61824512e+03 3.61823941e+03 1.61807668e+03
 2.39594045e+02 5.90387333e+01 1.70736210e+01 4.25206632e+00
 3.94797686e-01 1.36279271e+03 6.65175947e+02 3.03295103e+02
 3.16123954e+02 4.91839112e+01 6.65281598e+00 1.58025222e+01
 7.50178617e-01 2.89049238e+00 2.18470007e-01]
E = -526.0907747128476
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:40:35 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.508361         1
[INPUT] 0    0    [1    /1   ]  7618.24512043        1
[INPUT] 0    0    [1    /1   ]  3618.23941076        1
[INPUT] 0    0    [1    /1   ]  1618.07668384        1
[INPUT] 0    0    [1    /1   ]  239.594045257        1
[INPUT] 0    0    [1    /1   ]  59.038733289         1
[INPUT] 0    0    [1    /1   ]  17.0736209729        1
[INPUT] 0    0    [1    /1   ]  4.25206631654        1
[INPUT] 0    0    [1    /1   ]  0.394797686053       1
[INPUT] 1    0    [1    /1   ]  1362.79271058        1
[INPUT] 1    0    [1    /1   ]  665.175947324        1
[INPUT] 1    0    [1    /1   ]  303.295103147        1
[INPUT] 1    0    [1    /1   ]  316.123954176        1
[INPUT] 1    0    [1    /1   ]  49.1839111746        1
[INPUT] 1    0    [1    /1   ]  6.6528159817         1
[INPUT] 1    0    [1    /1   ]  15.8025221687        1
[INPUT] 1    0    [1    /1   ]  0.750178617383       1
[INPUT] 1    0    [1    /1   ]  2.89049238045        1
[INPUT] 1    0    [1    /1   ]  0.218470007438       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.50836095151, 1.0]], [0, [7618.245120431905, 1.0]], [0, [3618.23941075764, 1.0]], [0, [1618.076683838062, 1.0]], [0, [239.59404525740266, 1.0]], [0, [59.038733289034376, 1.0]], [0, [17.073620972949783, 1.0]], [0, [4.252066316541689, 1.0]], [0, [0.39479768605252263, 1.0]], [1, [1362.792710577384, 1.0]], [1, [665.1759473237513, 1.0]], [1, [303.29510314736467, 1.0]], [1, [316.12395417593433, 1.0]], [1, [49.183911174622736, 1.0]], [1, [6.652815981702875, 1.0]], [1, [15.802522168696601, 1.0]], [1, [0.7501786173826632, 1.0]], [1, [2.8904923804499987, 1.0]], [1, [0.21847000743762932, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50836095]
bas 1, expnt(s) = [7618.24512043]
bas 2, expnt(s) = [3618.23941076]
bas 3, expnt(s) = [1618.07668384]
bas 4, expnt(s) = [239.59404526]
bas 5, expnt(s) = [59.03873329]
bas 6, expnt(s) = [17.07362097]
bas 7, expnt(s) = [4.25206632]
bas 8, expnt(s) = [0.39479769]
bas 9, expnt(s) = [1362.79271058]
bas 10, expnt(s) = [665.17594732]
bas 11, expnt(s) = [303.29510315]
bas 12, expnt(s) = [316.12395418]
bas 13, expnt(s) = [49.18391117]
bas 14, expnt(s) = [6.65281598]
bas 15, expnt(s) = [15.80252217]
bas 16, expnt(s) = [0.75017862]
bas 17, expnt(s) = [2.89049238]
bas 18, expnt(s) = [0.21847001]
CPU time:       208.22
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825084e+04 5.20024090e+03 7.61824512e+03 2.06018505e+03
 3.61823941e+03 1.17865852e+03 1.61807668e+03 6.44561482e+02
 2.39594045e+02 1.53858693e+02 5.90387333e+01 5.38105954e+01
 1.70736210e+01 2.12206778e+01 4.25206632e+00 7.48109287e+00
 3.94797686e-01 1.25833412e+00 1.36279271e+03 2.41558122e+04
 6.65175947e+02 9.85496449e+03 3.03295103e+02 3.69246290e+03
 3.16123954e+02 3.88871531e+03 4.91839112e+01 3.79982171e+02
 6.65281598e+00 3.11703215e+01 1.58025222e+01 9.19162723e+01
 7.50178617e-01 2.03676181e+00 2.89049238e+00 1.09950999e+01
 2.18470007e-01 4.35736732e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98070965064141
cond(S) = 87231.7766729913
E1 = -728.383963821057  E_coul = 203.07503559316456
init E= -525.308928227892
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558736542038715  LUMO = 0.992819410565544
  mo_energy =
[-1.18108409e+02 -1.21407280e+01 -9.45136308e+00 -9.45136308e+00
 -9.45136308e+00 -1.22871449e+00 -5.58736542e-01 -5.58736542e-01
 -5.58736542e-01  9.92819411e-01  9.92819411e-01  9.92819411e-01
  7.14806916e+00  7.14806916e+00  7.14806916e+00  2.78016372e+01
  2.93121695e+01  2.93121695e+01  2.93121695e+01  1.03091430e+02
  1.03091430e+02  1.03091430e+02  2.68533859e+02  4.32672991e+02
  4.32672991e+02  4.32672991e+02  1.28470997e+03  1.28470997e+03
  1.28470997e+03  1.99281891e+03  2.98590862e+03  2.98590862e+03
  2.98590862e+03  6.61418178e+03  6.61418178e+03  6.61418178e+03
  8.34328628e+03  2.47270177e+04  7.55186730e+04]
E1 = -727.4573796436257  E_coul = 201.367095193279
cycle= 1 E= -526.090284450347  delta_E= -0.781  |g|= 0.206  |ddm|= 0.419
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.561235
diis-c [-0.31498497  1.        ]
  HOMO = -0.578635538607114  LUMO = 0.980735200870106
  mo_energy =
[-1.18400825e+02 -1.22539266e+01 -9.57164169e+00 -9.57164169e+00
 -9.57164169e+00 -1.25630661e+00 -5.78635539e-01 -5.78635539e-01
 -5.78635539e-01  9.80735201e-01  9.80735201e-01  9.80735201e-01
  7.08380101e+00  7.08380101e+00  7.08380101e+00  2.76727228e+01
  2.91965653e+01  2.91965653e+01  2.91965653e+01  1.02903751e+02
  1.02903751e+02  1.02903751e+02  2.68258869e+02  4.32380631e+02
  4.32380631e+02  4.32380631e+02  1.28435158e+03  1.28435158e+03
  1.28435158e+03  1.99231016e+03  2.98547331e+03  2.98547331e+03
  2.98547331e+03  6.61360612e+03  6.61360612e+03  6.61360612e+03
  8.34261330e+03  2.47262375e+04  7.55177921e+04]
E1 = -727.8362918671298  E_coul = 201.74553977413055
cycle= 2 E= -526.090752092999  delta_E= -0.000468  |g|= 0.0292  |ddm|= 0.0295
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.058154
diis-c [-0.00214007  0.05926937  0.94073063]
  HOMO = -0.573446260181774  LUMO = 0.98454754995088
  mo_energy =
[-1.18349671e+02 -1.22283925e+01 -9.54528132e+00 -9.54528132e+00
 -9.54528132e+00 -1.24959104e+00 -5.73446260e-01 -5.73446260e-01
 -5.73446260e-01  9.84547550e-01  9.84547550e-01  9.84547550e-01
  7.09806318e+00  7.09806318e+00  7.09806318e+00  2.77030077e+01
  2.92213077e+01  2.92213077e+01  2.92213077e+01  1.02941855e+02
  1.02941855e+02  1.02941855e+02  2.68307897e+02  4.32431080e+02
  4.32431080e+02  4.32431080e+02  1.28440579e+03  1.28440579e+03
  1.28440579e+03  1.99236690e+03  2.98552938e+03  2.98552938e+03
  2.98552938e+03  6.61366349e+03  6.61366349e+03  6.61366349e+03
  8.34267127e+03  2.47262958e+04  7.55178505e+04]
E1 = -727.7546808840624  E_coul = 201.6639066893577
cycle= 3 E= -526.090774194705  delta_E= -2.21e-05  |g|= 0.004  |ddm|= 0.00707
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00861653
diis-c [-2.90401843e-07 -1.16424666e-03  1.23410307e-01  8.77753940e-01]
  HOMO = -0.574250618585925  LUMO = 0.983967253485502
  mo_energy =
[-1.18356193e+02 -1.22318657e+01 -9.54893394e+00 -9.54893394e+00
 -9.54893394e+00 -1.25061209e+00 -5.74250619e-01 -5.74250619e-01
 -5.74250619e-01  9.83967253e-01  9.83967253e-01  9.83967253e-01
  7.09597489e+00  7.09597489e+00  7.09597489e+00  2.76990452e+01
  2.92178733e+01  2.92178733e+01  2.92178733e+01  1.02936854e+02
  1.02936854e+02  1.02936854e+02  2.68301633e+02  4.32424643e+02
  4.32424643e+02  4.32424643e+02  1.28439887e+03  1.28439887e+03
  1.28439887e+03  1.99235951e+03  2.98552216e+03  2.98552216e+03
  2.98552216e+03  6.61365596e+03  6.61365596e+03  6.61365596e+03
  8.34266356e+03  2.47262879e+04  7.55178426e+04]
E1 = -727.7657351907837  E_coul = 201.67496047798912
cycle= 4 E= -526.090774712795  delta_E= -5.18e-07  |g|= 3.55e-05  |ddm|= 0.000989
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.49435e-05
diis-c [-1.73925968e-09  3.65980867e-05 -4.90597092e-03 -3.78945494e-02
  1.04276392e+00]
  HOMO = -0.574231660748442  LUMO = 0.983980571223276
  mo_energy =
[-1.18356147e+02 -1.22318069e+01 -9.54888029e+00 -9.54888029e+00
 -9.54888029e+00 -1.25058714e+00 -5.74231661e-01 -5.74231661e-01
 -5.74231661e-01  9.83980571e-01  9.83980571e-01  9.83980571e-01
  7.09601547e+00  7.09601547e+00  7.09601547e+00  2.76991048e+01
  2.92179236e+01  2.92179236e+01  2.92179236e+01  1.02936906e+02
  1.02936906e+02  1.02936906e+02  2.68301680e+02  4.32424689e+02
  4.32424689e+02  4.32424689e+02  1.28439891e+03  1.28439891e+03
  1.28439891e+03  1.99235954e+03  2.98552219e+03  2.98552219e+03
  2.98552219e+03  6.61365599e+03  6.61365599e+03  6.61365599e+03
  8.34266358e+03  2.47262879e+04  7.55178426e+04]
E1 = -727.7656147508778  E_coul = 201.6748400380329
cycle= 5 E= -526.090774712845  delta_E= -5.02e-11  |g|= 7.98e-06  |ddm|= 1.54e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.7656147508778  E_coul = 201.6748400380329
  HOMO = -0.574235602714528  LUMO = 0.983977787541974
  mo_energy =
[-1.18356165e+02 -1.22318204e+01 -9.54889422e+00 -9.54889422e+00
 -9.54889422e+00 -1.25059216e+00 -5.74235603e-01 -5.74235603e-01
 -5.74235603e-01  9.83977788e-01  9.83977788e-01  9.83977788e-01
  7.09600630e+00  7.09600630e+00  7.09600630e+00  2.76990905e+01
  2.92179105e+01  2.92179105e+01  2.92179105e+01  1.02936890e+02
  1.02936890e+02  1.02936890e+02  2.68301662e+02  4.32424671e+02
  4.32424671e+02  4.32424671e+02  1.28439889e+03  1.28439889e+03
  1.28439889e+03  1.99235952e+03  2.98552217e+03  2.98552217e+03
  2.98552217e+03  6.61365597e+03  6.61365597e+03  6.61365597e+03
  8.34266356e+03  2.47262879e+04  7.55178426e+04]
E1 = -727.7656526171984  E_coul = 201.67487790435078
Extra cycle  E= -526.090774712848  delta_E= -2.73e-12  |g|= 2.18e-06  |ddm|= 3.91e-06
    CPU time for scf_cycle      0.63 sec, wall time      0.24 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 87231.7766729913
E1 = -727.7656526171984  E_coul = 201.67487790435078
init E= -526.090774712848
    CPU time for initialize scf      2.71 sec, wall time      0.24 sec
  HOMO = -0.574234896500123  LUMO = 0.983978292655142
  mo_energy =
[-1.18356161e+02 -1.22318177e+01 -9.54889136e+00 -9.54889136e+00
 -9.54889136e+00 -1.25059126e+00 -5.74234897e-01 -5.74234897e-01
 -5.74234897e-01  9.83978293e-01  9.83978293e-01  9.83978293e-01
  7.09600803e+00  7.09600803e+00  7.09600803e+00  2.76990936e+01
  2.92179132e+01  2.92179132e+01  2.92179132e+01  1.02936893e+02
  1.02936893e+02  1.02936893e+02  2.68301666e+02  4.32424675e+02
  4.32424675e+02  4.32424675e+02  1.28439889e+03  1.28439889e+03
  1.28439889e+03  1.99235952e+03  2.98552218e+03  2.98552218e+03
  2.98552218e+03  6.61365597e+03  6.61365597e+03  6.61365597e+03
  8.34266356e+03  2.47262879e+04  7.55178426e+04]
E1 = -727.7656444000343  E_coul = 201.67486968718669
cycle= 1 E= -526.090774712848  delta_E=    0  |g|= 5.19e-07  |ddm|= 7.79e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.7656444000343  E_coul = 201.67486968718669
  HOMO = -0.574235039188998  LUMO = 0.983978189992919
  mo_energy =
[-1.18356162e+02 -1.22318183e+01 -9.54889198e+00 -9.54889198e+00
 -9.54889198e+00 -1.25059144e+00 -5.74235039e-01 -5.74235039e-01
 -5.74235039e-01  9.83978190e-01  9.83978190e-01  9.83978190e-01
  7.09600767e+00  7.09600767e+00  7.09600767e+00  2.76990930e+01
  2.92179126e+01  2.92179126e+01  2.92179126e+01  1.02936893e+02
  1.02936893e+02  1.02936893e+02  2.68301665e+02  4.32424674e+02
  4.32424674e+02  4.32424674e+02  1.28439889e+03  1.28439889e+03
  1.28439889e+03  1.99235952e+03  2.98552218e+03  2.98552218e+03
  2.98552218e+03  6.61365597e+03  6.61365597e+03  6.61365597e+03
  8.34266356e+03  2.47262879e+04  7.55178426e+04]
E1 = -727.7656462237785  E_coul = 201.67487151093061
Extra cycle  E= -526.090774712848  delta_E= -2.27e-13  |g|= 1.2e-07  |ddm|= 1.68e-07
    CPU time for scf_cycle      2.84 sec, wall time      0.37 sec
exp = [2.61825084e+04 7.61824512e+03 3.61823941e+03 1.61807668e+03
 2.39594045e+02 5.90387333e+01 1.70736210e+01 4.25206632e+00
 3.94797686e-01 1.36279271e+03 6.65175947e+02 3.03295103e+02
 3.16123954e+02 4.91839112e+01 6.65281598e+00 1.58025222e+01
 7.50178617e-01 2.89049238e+00 2.18470007e-01]
grad_E = [-1.96051741e-06  2.56463568e-05  5.59017147e-05  8.12529136e-04
 -7.68270346e-03 -4.94233093e-03  2.18117744e-03  6.63593600e-03
 -8.47567493e-03  1.35563927e-06  2.01084945e-05  1.08407062e-04
  9.55457173e-05  1.38907420e-04  1.74496775e-02 -1.31364933e-02
 -3.09198066e-02 -3.36192723e-03  3.50203470e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:40:39 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5083734        1
[INPUT] 0    0    [1    /1   ]  7618.24496976        1
[INPUT] 0    0    [1    /1   ]  3618.23909363        1
[INPUT] 0    0    [1    /1   ]  1618.07197209        1
[INPUT] 0    0    [1    /1   ]  239.617376273        1
[INPUT] 0    0    [1    /1   ]  59.1452146976        1
[INPUT] 0    0    [1    /1   ]  17.1865139739        1
[INPUT] 0    0    [1    /1   ]  4.24758373972        1
[INPUT] 0    0    [1    /1   ]  0.396215127593       1
[INPUT] 1    0    [1    /1   ]  1362.79270289        1
[INPUT] 1    0    [1    /1   ]  665.175826726        1
[INPUT] 1    0    [1    /1   ]  303.294456685        1
[INPUT] 1    0    [1    /1   ]  316.123384469        1
[INPUT] 1    0    [1    /1   ]  49.1808244479        1
[INPUT] 1    0    [1    /1   ]  6.61899323119        1
[INPUT] 1    0    [1    /1   ]  15.866763777         1
[INPUT] 1    0    [1    /1   ]  0.73855202568        1
[INPUT] 1    0    [1    /1   ]  2.8957577761         1
[INPUT] 1    0    [1    /1   ]  0.215824975686       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.50837337367, 1.0]], [0, [7618.244969755185, 1.0]], [0, [3618.2390936331853, 1.0]], [0, [1618.0719720891034, 1.0]], [0, [239.61737627322645, 1.0]], [0, [59.145214697583306, 1.0]], [0, [17.186513973913154, 1.0]], [0, [4.247583739723969, 1.0]], [0, [0.3962151275927042, 1.0]], [1, [1362.7927028852532, 1.0]], [1, [665.1758267257172, 1.0]], [1, [303.29445668459095, 1.0]], [1, [316.12338446868824, 1.0]], [1, [49.18082444787831, 1.0]], [1, [6.618993231193561, 1.0]], [1, [15.866763777021228, 1.0]], [1, [0.7385520256800682, 1.0]], [1, [2.8957577761001123, 1.0]], [1, [0.21582497568606906, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50837337]
bas 1, expnt(s) = [7618.24496976]
bas 2, expnt(s) = [3618.23909363]
bas 3, expnt(s) = [1618.07197209]
bas 4, expnt(s) = [239.61737627]
bas 5, expnt(s) = [59.1452147]
bas 6, expnt(s) = [17.18651397]
bas 7, expnt(s) = [4.24758374]
bas 8, expnt(s) = [0.39621513]
bas 9, expnt(s) = [1362.79270289]
bas 10, expnt(s) = [665.17582673]
bas 11, expnt(s) = [303.29445668]
bas 12, expnt(s) = [316.12338447]
bas 13, expnt(s) = [49.18082445]
bas 14, expnt(s) = [6.61899323]
bas 15, expnt(s) = [15.86676378]
bas 16, expnt(s) = [0.73855203]
bas 17, expnt(s) = [2.89575778]
bas 18, expnt(s) = [0.21582498]
CPU time:       216.26
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825084e+04 5.20024090e+03 7.61824497e+03 2.06018502e+03
 3.61823909e+03 1.17865844e+03 1.61807197e+03 6.44560074e+02
 2.39617376e+02 1.53869930e+02 5.91452147e+01 5.38833680e+01
 1.71865140e+01 2.13258265e+01 4.24758374e+00 7.47517710e+00
 3.96215128e-01 1.26172095e+00 1.36279270e+03 2.41558121e+04
 6.65175827e+02 9.85496225e+03 3.03294457e+02 3.69245306e+03
 3.16123384e+02 3.88870655e+03 4.91808244e+01 3.79952362e+02
 6.61899323e+00 3.09723611e+01 1.58667638e+01 9.23835906e+01
 7.38552026e-01 1.99738029e+00 2.89575778e+00 1.10201418e+01
 2.15824976e-01 4.29152373e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.980915741438025
cond(S) = 87241.16513677202
E1 = -728.3899298921388  E_coul = 203.08755588972824
init E= -525.30237400241
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558296923929201  LUMO = 0.973558396189368
  mo_energy =
[-1.18108130e+02 -1.21396210e+01 -9.45059388e+00 -9.45059388e+00
 -9.45059388e+00 -1.22816958e+00 -5.58296924e-01 -5.58296924e-01
 -5.58296924e-01  9.73558396e-01  9.73558396e-01  9.73558396e-01
  7.09134164e+00  7.09134164e+00  7.09134164e+00  2.79834607e+01
  2.92500760e+01  2.92500760e+01  2.92500760e+01  1.03125391e+02
  1.03125391e+02  1.03125391e+02  2.69250272e+02  4.32756357e+02
  4.32756357e+02  4.32756357e+02  1.28478897e+03  1.28478897e+03
  1.28478897e+03  1.99365718e+03  2.98598149e+03  2.98598149e+03
  2.98598149e+03  6.61424737e+03  6.61424737e+03  6.61424737e+03
  8.34406725e+03  2.47277558e+04  7.55193586e+04]
E1 = -727.4530286024135  E_coul = 201.3613531845555
cycle= 1 E= -526.091675417858  delta_E= -0.789  |g|= 0.207  |ddm|= 0.485
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.563377
diis-c [-0.3173942  1.       ]
  HOMO = -0.578512442482415  LUMO = 0.961557639551829
  mo_energy =
[-1.18402541e+02 -1.22539751e+01 -9.57236950e+00 -9.57236950e+00
 -9.57236950e+00 -1.25629976e+00 -5.78512442e-01 -5.78512442e-01
 -5.78512442e-01  9.61557640e-01  9.61557640e-01  9.61557640e-01
  7.02636256e+00  7.02636256e+00  7.02636256e+00  2.78527452e+01
  2.91330017e+01  2.91330017e+01  2.91330017e+01  1.02935929e+02
  1.02935929e+02  1.02935929e+02  2.68973182e+02  4.32462030e+02
  4.32462030e+02  4.32462030e+02  1.28442861e+03  1.28442861e+03
  1.28442861e+03  1.99314647e+03  2.98554423e+03  2.98554423e+03
  2.98554423e+03  6.61366968e+03  6.61366968e+03  6.61366968e+03
  8.34339220e+03  2.47269735e+04  7.55184755e+04]
E1 = -727.8361870014962  E_coul = 201.74403478207756
cycle= 2 E= -526.092152219419  delta_E= -0.000477  |g|= 0.0295  |ddm|= 0.0301
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0585577
diis-c [-0.00216077  0.05964513  0.94035487]
  HOMO = -0.573238659733402  LUMO = 0.965361229477939
  mo_energy =
[-1.18350943e+02 -1.22281630e+01 -9.54573250e+00 -9.54573250e+00
 -9.54573250e+00 -1.24946790e+00 -5.73238660e-01 -5.73238660e-01
 -5.73238660e-01  9.65361229e-01  9.65361229e-01  9.65361229e-01
  7.04078944e+00  7.04078944e+00  7.04078944e+00  2.78834190e+01
  2.91580210e+01  2.91580210e+01  2.91580210e+01  1.02974409e+02
  1.02974409e+02  1.02974409e+02  2.69022650e+02  4.32512918e+02
  4.32512918e+02  4.32512918e+02  1.28448328e+03  1.28448328e+03
  1.28448328e+03  1.99320367e+03  2.98560076e+03  2.98560076e+03
  2.98560076e+03  6.61372751e+03  6.61372751e+03  6.61372751e+03
  8.34345064e+03  2.47270323e+04  7.55185344e+04]
E1 = -727.753829248251  E_coul = 201.66165454276924
cycle= 3 E= -526.092174705482  delta_E= -2.25e-05  |g|= 0.00401  |ddm|= 0.00715
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00866511
diis-c [-3.11978457e-07 -1.17750576e-03  1.23182051e-01  8.77995455e-01]
  HOMO = -0.574049105171889  LUMO = 0.964787254820763
  mo_energy =
[-1.18357495e+02 -1.22316534e+01 -9.54940540e+00 -9.54940540e+00
 -9.54940540e+00 -1.25049825e+00 -5.74049105e-01 -5.74049105e-01
 -5.74049105e-01  9.64787255e-01  9.64787255e-01  9.64787255e-01
  7.03869071e+00  7.03869071e+00  7.03869071e+00  2.78794298e+01
  2.91545659e+01  2.91545659e+01  2.91545659e+01  1.02969381e+02
  1.02969381e+02  1.02969381e+02  2.69016356e+02  4.32506452e+02
  4.32506452e+02  4.32506452e+02  1.28447632e+03  1.28447632e+03
  1.28447632e+03  1.99319625e+03  2.98559351e+03  2.98559351e+03
  2.98559351e+03  6.61371995e+03  6.61371995e+03  6.61371995e+03
  8.34344289e+03  2.47270244e+04  7.55185264e+04]
E1 = -727.7649410513852  E_coul = 201.67276582322728
cycle= 4 E= -526.092175228158  delta_E= -5.23e-07  |g|= 3.61e-05  |ddm|= 0.000998
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.87702e-05
diis-c [-1.76575219e-09  4.03963002e-05 -5.27984118e-03 -4.11763915e-02
  1.04641584e+00]
  HOMO = -0.574030280890657  LUMO = 0.964800264486277
  mo_energy =
[-1.18357451e+02 -1.22315957e+01 -9.54935312e+00 -9.54935312e+00
 -9.54935312e+00 -1.25047347e+00 -5.74030281e-01 -5.74030281e-01
 -5.74030281e-01  9.64800264e-01  9.64800264e-01  9.64800264e-01
  7.03873065e+00  7.03873065e+00  7.03873065e+00  2.78794883e+01
  2.91546150e+01  2.91546150e+01  2.91546150e+01  1.02969431e+02
  1.02969431e+02  1.02969431e+02  2.69016401e+02  4.32506496e+02
  4.32506496e+02  4.32506496e+02  1.28447636e+03  1.28447636e+03
  1.28447636e+03  1.99319627e+03  2.98559354e+03  2.98559354e+03
  2.98559354e+03  6.61371997e+03  6.61371997e+03  6.61371997e+03
  8.34344291e+03  2.47270244e+04  7.55185264e+04]
E1 = -727.7648256014629  E_coul = 201.6726503732563
cycle= 5 E= -526.092175228207  delta_E= -4.88e-11  |g|= 8.03e-06  |ddm|= 1.49e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.7648256014629  E_coul = 201.6726503732563
  HOMO = -0.574034288572602  LUMO = 0.964797484412777
  mo_energy =
[-1.18357470e+02 -1.22316094e+01 -9.54936723e+00 -9.54936723e+00
 -9.54936723e+00 -1.25047859e+00 -5.74034289e-01 -5.74034289e-01
 -5.74034289e-01  9.64797484e-01  9.64797484e-01  9.64797484e-01
  7.03872136e+00  7.03872136e+00  7.03872136e+00  2.78794739e+01
  2.91546017e+01  2.91546017e+01  2.91546017e+01  1.02969415e+02
  1.02969415e+02  1.02969415e+02  2.69016382e+02  4.32506477e+02
  4.32506477e+02  4.32506477e+02  1.28447634e+03  1.28447634e+03
  1.28447634e+03  1.99319625e+03  2.98559352e+03  2.98559352e+03
  2.98559352e+03  6.61371995e+03  6.61371995e+03  6.61371995e+03
  8.34344289e+03  2.47270244e+04  7.55185264e+04]
E1 = -727.7648638693971  E_coul = 201.67268864118648
Extra cycle  E= -526.092175228211  delta_E= -3.98e-12  |g|= 2.19e-06  |ddm|= 3.97e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.23 sec
exp = [2.61825084e+04 7.61824497e+03 3.61823909e+03 1.61807197e+03
 2.39617376e+02 5.91452147e+01 1.71865140e+01 4.24758374e+00
 3.96215128e-01 1.36279270e+03 6.65175827e+02 3.03294457e+02
 3.16123384e+02 4.91808244e+01 6.61899323e+00 1.58667638e+01
 7.38552026e-01 2.89575778e+00 2.15824976e-01]
E = -526.0921752282106
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:40:39 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5083734        1
[INPUT] 0    0    [1    /1   ]  7618.24496976        1
[INPUT] 0    0    [1    /1   ]  3618.23909363        1
[INPUT] 0    0    [1    /1   ]  1618.07197209        1
[INPUT] 0    0    [1    /1   ]  239.617376273        1
[INPUT] 0    0    [1    /1   ]  59.1452146976        1
[INPUT] 0    0    [1    /1   ]  17.1865139739        1
[INPUT] 0    0    [1    /1   ]  4.24758373972        1
[INPUT] 0    0    [1    /1   ]  0.396215127593       1
[INPUT] 1    0    [1    /1   ]  1362.79270289        1
[INPUT] 1    0    [1    /1   ]  665.175826726        1
[INPUT] 1    0    [1    /1   ]  303.294456685        1
[INPUT] 1    0    [1    /1   ]  316.123384469        1
[INPUT] 1    0    [1    /1   ]  49.1808244479        1
[INPUT] 1    0    [1    /1   ]  6.61899323119        1
[INPUT] 1    0    [1    /1   ]  15.866763777         1
[INPUT] 1    0    [1    /1   ]  0.73855202568        1
[INPUT] 1    0    [1    /1   ]  2.8957577761         1
[INPUT] 1    0    [1    /1   ]  0.215824975686       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.50837337367, 1.0]], [0, [7618.244969755185, 1.0]], [0, [3618.2390936331853, 1.0]], [0, [1618.0719720891034, 1.0]], [0, [239.61737627322645, 1.0]], [0, [59.145214697583306, 1.0]], [0, [17.186513973913154, 1.0]], [0, [4.247583739723969, 1.0]], [0, [0.3962151275927042, 1.0]], [1, [1362.7927028852532, 1.0]], [1, [665.1758267257172, 1.0]], [1, [303.29445668459095, 1.0]], [1, [316.12338446868824, 1.0]], [1, [49.18082444787831, 1.0]], [1, [6.618993231193561, 1.0]], [1, [15.866763777021228, 1.0]], [1, [0.7385520256800682, 1.0]], [1, [2.8957577761001123, 1.0]], [1, [0.21582497568606906, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50837337]
bas 1, expnt(s) = [7618.24496976]
bas 2, expnt(s) = [3618.23909363]
bas 3, expnt(s) = [1618.07197209]
bas 4, expnt(s) = [239.61737627]
bas 5, expnt(s) = [59.1452147]
bas 6, expnt(s) = [17.18651397]
bas 7, expnt(s) = [4.24758374]
bas 8, expnt(s) = [0.39621513]
bas 9, expnt(s) = [1362.79270289]
bas 10, expnt(s) = [665.17582673]
bas 11, expnt(s) = [303.29445668]
bas 12, expnt(s) = [316.12338447]
bas 13, expnt(s) = [49.18082445]
bas 14, expnt(s) = [6.61899323]
bas 15, expnt(s) = [15.86676378]
bas 16, expnt(s) = [0.73855203]
bas 17, expnt(s) = [2.89575778]
bas 18, expnt(s) = [0.21582498]
CPU time:       216.98
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825084e+04 5.20024090e+03 7.61824497e+03 2.06018502e+03
 3.61823909e+03 1.17865844e+03 1.61807197e+03 6.44560074e+02
 2.39617376e+02 1.53869930e+02 5.91452147e+01 5.38833680e+01
 1.71865140e+01 2.13258265e+01 4.24758374e+00 7.47517710e+00
 3.96215128e-01 1.26172095e+00 1.36279270e+03 2.41558121e+04
 6.65175827e+02 9.85496225e+03 3.03294457e+02 3.69245306e+03
 3.16123384e+02 3.88870655e+03 4.91808244e+01 3.79952362e+02
 6.61899323e+00 3.09723611e+01 1.58667638e+01 9.23835906e+01
 7.38552026e-01 1.99738029e+00 2.89575778e+00 1.10201418e+01
 2.15824976e-01 4.29152373e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.980915741438025
cond(S) = 87241.16513677202
E1 = -728.3899298921388  E_coul = 203.08755588972824
init E= -525.30237400241
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558296923929201  LUMO = 0.973558396189368
  mo_energy =
[-1.18108130e+02 -1.21396210e+01 -9.45059388e+00 -9.45059388e+00
 -9.45059388e+00 -1.22816958e+00 -5.58296924e-01 -5.58296924e-01
 -5.58296924e-01  9.73558396e-01  9.73558396e-01  9.73558396e-01
  7.09134164e+00  7.09134164e+00  7.09134164e+00  2.79834607e+01
  2.92500760e+01  2.92500760e+01  2.92500760e+01  1.03125391e+02
  1.03125391e+02  1.03125391e+02  2.69250272e+02  4.32756357e+02
  4.32756357e+02  4.32756357e+02  1.28478897e+03  1.28478897e+03
  1.28478897e+03  1.99365718e+03  2.98598149e+03  2.98598149e+03
  2.98598149e+03  6.61424737e+03  6.61424737e+03  6.61424737e+03
  8.34406725e+03  2.47277558e+04  7.55193586e+04]
E1 = -727.4530286024135  E_coul = 201.3613531845555
cycle= 1 E= -526.091675417858  delta_E= -0.789  |g|= 0.207  |ddm|= 0.485
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.563377
diis-c [-0.3173942  1.       ]
  HOMO = -0.578512442482415  LUMO = 0.961557639551829
  mo_energy =
[-1.18402541e+02 -1.22539751e+01 -9.57236950e+00 -9.57236950e+00
 -9.57236950e+00 -1.25629976e+00 -5.78512442e-01 -5.78512442e-01
 -5.78512442e-01  9.61557640e-01  9.61557640e-01  9.61557640e-01
  7.02636256e+00  7.02636256e+00  7.02636256e+00  2.78527452e+01
  2.91330017e+01  2.91330017e+01  2.91330017e+01  1.02935929e+02
  1.02935929e+02  1.02935929e+02  2.68973182e+02  4.32462030e+02
  4.32462030e+02  4.32462030e+02  1.28442861e+03  1.28442861e+03
  1.28442861e+03  1.99314647e+03  2.98554423e+03  2.98554423e+03
  2.98554423e+03  6.61366968e+03  6.61366968e+03  6.61366968e+03
  8.34339220e+03  2.47269735e+04  7.55184755e+04]
E1 = -727.8361870014962  E_coul = 201.74403478207756
cycle= 2 E= -526.092152219419  delta_E= -0.000477  |g|= 0.0295  |ddm|= 0.0301
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0585577
diis-c [-0.00216077  0.05964513  0.94035487]
  HOMO = -0.573238659733402  LUMO = 0.965361229477939
  mo_energy =
[-1.18350943e+02 -1.22281630e+01 -9.54573250e+00 -9.54573250e+00
 -9.54573250e+00 -1.24946790e+00 -5.73238660e-01 -5.73238660e-01
 -5.73238660e-01  9.65361229e-01  9.65361229e-01  9.65361229e-01
  7.04078944e+00  7.04078944e+00  7.04078944e+00  2.78834190e+01
  2.91580210e+01  2.91580210e+01  2.91580210e+01  1.02974409e+02
  1.02974409e+02  1.02974409e+02  2.69022650e+02  4.32512918e+02
  4.32512918e+02  4.32512918e+02  1.28448328e+03  1.28448328e+03
  1.28448328e+03  1.99320367e+03  2.98560076e+03  2.98560076e+03
  2.98560076e+03  6.61372751e+03  6.61372751e+03  6.61372751e+03
  8.34345064e+03  2.47270323e+04  7.55185344e+04]
E1 = -727.753829248251  E_coul = 201.66165454276924
cycle= 3 E= -526.092174705482  delta_E= -2.25e-05  |g|= 0.00401  |ddm|= 0.00715
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00866511
diis-c [-3.11978457e-07 -1.17750576e-03  1.23182051e-01  8.77995455e-01]
  HOMO = -0.574049105171889  LUMO = 0.964787254820763
  mo_energy =
[-1.18357495e+02 -1.22316534e+01 -9.54940540e+00 -9.54940540e+00
 -9.54940540e+00 -1.25049825e+00 -5.74049105e-01 -5.74049105e-01
 -5.74049105e-01  9.64787255e-01  9.64787255e-01  9.64787255e-01
  7.03869071e+00  7.03869071e+00  7.03869071e+00  2.78794298e+01
  2.91545659e+01  2.91545659e+01  2.91545659e+01  1.02969381e+02
  1.02969381e+02  1.02969381e+02  2.69016356e+02  4.32506452e+02
  4.32506452e+02  4.32506452e+02  1.28447632e+03  1.28447632e+03
  1.28447632e+03  1.99319625e+03  2.98559351e+03  2.98559351e+03
  2.98559351e+03  6.61371995e+03  6.61371995e+03  6.61371995e+03
  8.34344289e+03  2.47270244e+04  7.55185264e+04]
E1 = -727.7649410513852  E_coul = 201.67276582322728
cycle= 4 E= -526.092175228158  delta_E= -5.23e-07  |g|= 3.61e-05  |ddm|= 0.000998
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.87702e-05
diis-c [-1.76575219e-09  4.03963002e-05 -5.27984118e-03 -4.11763915e-02
  1.04641584e+00]
  HOMO = -0.574030280890657  LUMO = 0.964800264486277
  mo_energy =
[-1.18357451e+02 -1.22315957e+01 -9.54935312e+00 -9.54935312e+00
 -9.54935312e+00 -1.25047347e+00 -5.74030281e-01 -5.74030281e-01
 -5.74030281e-01  9.64800264e-01  9.64800264e-01  9.64800264e-01
  7.03873065e+00  7.03873065e+00  7.03873065e+00  2.78794883e+01
  2.91546150e+01  2.91546150e+01  2.91546150e+01  1.02969431e+02
  1.02969431e+02  1.02969431e+02  2.69016401e+02  4.32506496e+02
  4.32506496e+02  4.32506496e+02  1.28447636e+03  1.28447636e+03
  1.28447636e+03  1.99319627e+03  2.98559354e+03  2.98559354e+03
  2.98559354e+03  6.61371997e+03  6.61371997e+03  6.61371997e+03
  8.34344291e+03  2.47270244e+04  7.55185264e+04]
E1 = -727.7648256014629  E_coul = 201.6726503732563
cycle= 5 E= -526.092175228207  delta_E= -4.88e-11  |g|= 8.03e-06  |ddm|= 1.49e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.7648256014629  E_coul = 201.6726503732563
  HOMO = -0.574034288572602  LUMO = 0.964797484412777
  mo_energy =
[-1.18357470e+02 -1.22316094e+01 -9.54936723e+00 -9.54936723e+00
 -9.54936723e+00 -1.25047859e+00 -5.74034289e-01 -5.74034289e-01
 -5.74034289e-01  9.64797484e-01  9.64797484e-01  9.64797484e-01
  7.03872136e+00  7.03872136e+00  7.03872136e+00  2.78794739e+01
  2.91546017e+01  2.91546017e+01  2.91546017e+01  1.02969415e+02
  1.02969415e+02  1.02969415e+02  2.69016382e+02  4.32506477e+02
  4.32506477e+02  4.32506477e+02  1.28447634e+03  1.28447634e+03
  1.28447634e+03  1.99319625e+03  2.98559352e+03  2.98559352e+03
  2.98559352e+03  6.61371995e+03  6.61371995e+03  6.61371995e+03
  8.34344289e+03  2.47270244e+04  7.55185264e+04]
E1 = -727.7648638693971  E_coul = 201.67268864118648
Extra cycle  E= -526.092175228211  delta_E= -3.98e-12  |g|= 2.19e-06  |ddm|= 3.97e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 87241.16513677202
E1 = -727.7648638693971  E_coul = 201.67268864118648
init E= -526.092175228211
    CPU time for initialize scf      2.71 sec, wall time      0.24 sec
  HOMO = -0.574033571857665  LUMO = 0.964797987864164
  mo_energy =
[-1.18357465e+02 -1.22316066e+01 -9.54936434e+00 -9.54936434e+00
 -9.54936434e+00 -1.25047767e+00 -5.74033572e-01 -5.74033572e-01
 -5.74033572e-01  9.64797988e-01  9.64797988e-01  9.64797988e-01
  7.03872312e+00  7.03872312e+00  7.03872312e+00  2.78794770e+01
  2.91546044e+01  2.91546044e+01  2.91546044e+01  1.02969419e+02
  1.02969419e+02  1.02969419e+02  2.69016387e+02  4.32506482e+02
  4.32506482e+02  4.32506482e+02  1.28447634e+03  1.28447634e+03
  1.28447634e+03  1.99319626e+03  2.98559352e+03  2.98559352e+03
  2.98559352e+03  6.61371995e+03  6.61371995e+03  6.61371995e+03
  8.34344289e+03  2.47270244e+04  7.55185264e+04]
E1 = -727.7648555767746  E_coul = 201.67268034856494
cycle= 1 E= -526.09217522821  delta_E= 9.09e-13  |g|= 5.22e-07  |ddm|= 7.88e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.7648555767746  E_coul = 201.67268034856494
  HOMO = -0.574033716276151  LUMO = 0.964797885826421
  mo_energy =
[-1.18357466e+02 -1.22316072e+01 -9.54936496e+00 -9.54936496e+00
 -9.54936496e+00 -1.25047785e+00 -5.74033716e-01 -5.74033716e-01
 -5.74033716e-01  9.64797886e-01  9.64797886e-01  9.64797886e-01
  7.03872275e+00  7.03872275e+00  7.03872275e+00  2.78794763e+01
  2.91546038e+01  2.91546038e+01  2.91546038e+01  1.02969418e+02
  1.02969418e+02  1.02969418e+02  2.69016386e+02  4.32506481e+02
  4.32506481e+02  4.32506481e+02  1.28447634e+03  1.28447634e+03
  1.28447634e+03  1.99319626e+03  2.98559352e+03  2.98559352e+03
  2.98559352e+03  6.61371995e+03  6.61371995e+03  6.61371995e+03
  8.34344289e+03  2.47270244e+04  7.55185264e+04]
E1 = -727.7648574153357  E_coul = 201.67268218712428
Extra cycle  E= -526.092175228211  delta_E= -1.59e-12  |g|= 1.2e-07  |ddm|= 1.69e-07
    CPU time for scf_cycle      2.83 sec, wall time      0.36 sec
exp = [2.61825084e+04 7.61824497e+03 3.61823909e+03 1.61807197e+03
 2.39617376e+02 5.91452147e+01 1.71865140e+01 4.24758374e+00
 3.96215128e-01 1.36279270e+03 6.65175827e+02 3.03294457e+02
 3.16123384e+02 4.91808244e+01 6.61899323e+00 1.58667638e+01
 7.38552026e-01 2.89575778e+00 2.15824976e-01]
grad_E = [-1.96012151e-06  2.56942799e-05  5.60590396e-05  8.14324294e-04
 -7.79131011e-03 -4.48775865e-03  2.25376836e-03  1.42856769e-03
  1.16012445e-02  1.45077349e-06  2.07901492e-05  1.12591990e-04
  9.92340546e-05 -3.80871492e-04  1.38073279e-02 -1.07691882e-02
 -4.82754591e-02  3.01050524e-03  4.79085410e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:40:43 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5084182        1
[INPUT] 0    0    [1    /1   ]  7618.24442385        1
[INPUT] 0    0    [1    /1   ]  3618.23794247        1
[INPUT] 0    0    [1    /1   ]  1618.0548884         1
[INPUT] 0    0    [1    /1   ]  239.706647231        1
[INPUT] 0    0    [1    /1   ]  59.5133499639        1
[INPUT] 0    0    [1    /1   ]  17.567220832         1
[INPUT] 0    0    [1    /1   ]  4.2324789194         1
[INPUT] 0    0    [1    /1   ]  0.397953328317       1
[INPUT] 1    0    [1    /1   ]  1362.79267446        1
[INPUT] 1    0    [1    /1   ]  665.175386646        1
[INPUT] 1    0    [1    /1   ]  303.292093936        1
[INPUT] 1    0    [1    /1   ]  316.121302259        1
[INPUT] 1    0    [1    /1   ]  49.1732973429        1
[INPUT] 1    0    [1    /1   ]  6.51977550411        1
[INPUT] 1    0    [1    /1   ]  16.0834245882        1
[INPUT] 1    0    [1    /1   ]  0.729723092799       1
[INPUT] 1    0    [1    /1   ]  2.8629546291         1
[INPUT] 1    0    [1    /1   ]  0.214677904086       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.508418198817, 1.0]], [0, [7618.244423850304, 1.0]], [0, [3618.2379424670135, 1.0]], [0, [1618.0548884041, 1.0]], [0, [239.70664723113168, 1.0]], [0, [59.513349963889944, 1.0]], [0, [17.56722083195684, 1.0]], [0, [4.232478919395555, 1.0]], [0, [0.39795332831672875, 1.0]], [1, [1362.7926744554866, 1.0]], [1, [665.1753866461702, 1.0]], [1, [303.2920939364507, 1.0]], [1, [316.12130225870897, 1.0]], [1, [49.173297342902046, 1.0]], [1, [6.519775504109162, 1.0]], [1, [16.083424588161837, 1.0]], [1, [0.7297230927993549, 1.0]], [1, [2.86295462909799, 1.0]], [1, [0.21467790408552234, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.5084182]
bas 1, expnt(s) = [7618.24442385]
bas 2, expnt(s) = [3618.23794247]
bas 3, expnt(s) = [1618.0548884]
bas 4, expnt(s) = [239.70664723]
bas 5, expnt(s) = [59.51334996]
bas 6, expnt(s) = [17.56722083]
bas 7, expnt(s) = [4.23247892]
bas 8, expnt(s) = [0.39795333]
bas 9, expnt(s) = [1362.79267446]
bas 10, expnt(s) = [665.17538665]
bas 11, expnt(s) = [303.29209394]
bas 12, expnt(s) = [316.12130226]
bas 13, expnt(s) = [49.17329734]
bas 14, expnt(s) = [6.5197755]
bas 15, expnt(s) = [16.08342459]
bas 16, expnt(s) = [0.72972309]
bas 17, expnt(s) = [2.86295463]
bas 18, expnt(s) = [0.2146779]
CPU time:       224.99
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825084e+04 5.20024091e+03 7.61824442e+03 2.06018491e+03
 3.61823794e+03 1.17865816e+03 1.61805489e+03 6.44554970e+02
 2.39706647e+02 1.53912922e+02 5.95133500e+01 5.41347109e+01
 1.75672208e+01 2.16791535e+01 4.23247892e+00 7.45523138e+00
 3.97953328e-01 1.26587007e+00 1.36279267e+03 2.41558114e+04
 6.65175387e+02 9.85495410e+03 3.03292094e+02 3.69241711e+03
 3.16121302e+02 3.88867453e+03 4.91732973e+01 3.79879674e+02
 6.51977550e+00 3.03931137e+01 1.60834246e+01 9.39631465e+01
 7.29723093e-01 1.96757821e+00 2.86295463e+00 1.08643181e+01
 2.14677904e-01 4.26303183e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.980960073750214
cond(S) = 87281.21655745502
E1 = -728.3693738745021  E_coul = 203.0963089484036
init E= -525.273064926099
    CPU time for initialize scf      0.45 sec, wall time      0.05 sec
  HOMO = -0.5578947991991  LUMO = 0.962363130357424
  mo_energy =
[-1.18109755e+02 -1.21380577e+01 -9.45041334e+00 -9.45041334e+00
 -9.45041334e+00 -1.22718668e+00 -5.57894799e-01 -5.57894799e-01
 -5.57894799e-01  9.62363130e-01  9.62363130e-01  9.62363130e-01
  6.97216093e+00  6.97216093e+00  6.97216093e+00  2.85827839e+01
  2.90282352e+01  2.90282352e+01  2.90282352e+01  1.03219150e+02
  1.03219150e+02  1.03219150e+02  2.71680202e+02  4.33030181e+02
  4.33030181e+02  4.33030181e+02  1.28505134e+03  1.28505134e+03
  1.28505134e+03  1.99653986e+03  2.98622361e+03  2.98622361e+03
  2.98622361e+03  6.61446493e+03  6.61446493e+03  6.61446493e+03
  8.34675987e+03  2.47303015e+04  7.55217227e+04]
E1 = -727.4506764192329  E_coul = 201.3555490340378
cycle= 1 E= -526.095127385195  delta_E= -0.822  |g|= 0.211  |ddm|= 0.652
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.570923
diis-c [-0.32595285  1.        ]
  HOMO = -0.577977051163278  LUMO = 0.9506629509994
  mo_energy =
[-1.18407583e+02 -1.22525531e+01 -9.57362102e+00 -9.57362102e+00
 -9.57362102e+00 -1.25517297e+00 -5.77977051e-01 -5.77977051e-01
 -5.77977051e-01  9.50662951e-01  9.50662951e-01  9.50662951e-01
  6.90773004e+00  6.90773004e+00  6.90773004e+00  2.84500501e+01
  2.89097065e+01  2.89097065e+01  2.89097065e+01  1.03027099e+02
  1.03027099e+02  1.03027099e+02  2.71399354e+02  4.32732554e+02
  4.32732554e+02  4.32732554e+02  1.28468749e+03  1.28468749e+03
  1.28468749e+03  1.99602557e+03  2.98578286e+03  2.98578286e+03
  2.98578286e+03  6.61388333e+03  6.61388333e+03  6.61388333e+03
  8.34608071e+03  2.47295147e+04  7.55208348e+04]
E1 = -727.839782294622  E_coul = 201.7441550459203
cycle= 2 E= -526.095627248702  delta_E= -0.0005  |g|= 0.0301  |ddm|= 0.0304
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0594426
diis-c [-0.00220086  0.0602882   0.9397118 ]
  HOMO = -0.572648782192878  LUMO = 0.954456118263515
  mo_energy =
[-1.18355104e+02 -1.22263449e+01 -9.54660472e+00 -9.54660472e+00
 -9.54660472e+00 -1.24825789e+00 -5.72648782e-01 -5.72648782e-01
 -5.72648782e-01  9.54456118e-01  9.54456118e-01  9.54456118e-01
  6.92220640e+00  6.92220640e+00  6.92220640e+00  2.84815038e+01
  2.89351002e+01  2.89351002e+01  2.89351002e+01  1.03066262e+02
  1.03066262e+02  1.03066262e+02  2.71449695e+02  4.32784313e+02
  4.32784313e+02  4.32784313e+02  1.28474308e+03  1.28474308e+03
  1.28474308e+03  1.99608369e+03  2.98584032e+03  2.98584032e+03
  2.98584032e+03  6.61394209e+03  6.61394209e+03  6.61394209e+03
  8.34614005e+03  2.47295744e+04  7.55208946e+04]
E1 = -727.7563386705162  E_coul = 201.66068822400797
cycle= 3 E= -526.095650446508  delta_E= -2.32e-05  |g|= 0.00404  |ddm|= 0.00725
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00876821
diis-c [-3.99590340e-07 -1.22437233e-03  1.22480211e-01  8.78744162e-01]
  HOMO = -0.573467484328338  LUMO = 0.953884355771542
  mo_energy =
[-1.18361704e+02 -1.22298552e+01 -9.55030735e+00 -9.55030735e+00
 -9.55030735e+00 -1.24929919e+00 -5.73467484e-01 -5.73467484e-01
 -5.73467484e-01  9.53884356e-01  9.53884356e-01  9.53884356e-01
  6.92010642e+00  6.92010642e+00  6.92010642e+00  2.84774642e+01
  2.89316146e+01  2.89316146e+01  2.89316146e+01  1.03061191e+02
  1.03061191e+02  1.03061191e+02  2.71443350e+02  4.32777799e+02
  4.32777799e+02  4.32777799e+02  1.28473607e+03  1.28473607e+03
  1.28473607e+03  1.99607620e+03  2.98583301e+03  2.98583301e+03
  2.98583301e+03  6.61393446e+03  6.61393446e+03  6.61393446e+03
  8.34613223e+03  2.47295664e+04  7.55208865e+04]
E1 = -727.7675298518576  E_coul = 201.67187887481975
cycle= 4 E= -526.095650977038  delta_E= -5.31e-07  |g|= 3.97e-05  |ddm|= 0.00101
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.96953e-05
diis-c [-1.99836461e-09  4.64737754e-05 -5.81142473e-03 -4.64158089e-02
  1.05218076e+00]
  HOMO = -0.573448247067374  LUMO = 0.953897486825985
  mo_energy =
[-1.18361663e+02 -1.22297966e+01 -9.55025505e+00 -9.55025505e+00
 -9.55025505e+00 -1.24927381e+00 -5.73448247e-01 -5.73448247e-01
 -5.73448247e-01  9.53897487e-01  9.53897487e-01  9.53897487e-01
  6.92014671e+00  6.92014671e+00  6.92014671e+00  2.84775235e+01
  2.89316636e+01  2.89316636e+01  2.89316636e+01  1.03061240e+02
  1.03061240e+02  1.03061240e+02  2.71443392e+02  4.32777840e+02
  4.32777840e+02  4.32777840e+02  1.28473611e+03  1.28473611e+03
  1.28473611e+03  1.99607622e+03  2.98583303e+03  2.98583303e+03
  2.98583303e+03  6.61393447e+03  6.61393447e+03  6.61393447e+03
  8.34613224e+03  2.47295664e+04  7.55208865e+04]
E1 = -727.7674178826289  E_coul = 201.67176690554254
cycle= 5 E= -526.095650977086  delta_E= -4.85e-11  |g|= 8.5e-06  |ddm|= 1.48e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.7674178826289  E_coul = 201.67176690554254
  HOMO = -0.573452545833843  LUMO = 0.953894544358281
  mo_energy =
[-1.18361683e+02 -1.22298113e+01 -9.55027012e+00 -9.55027012e+00
 -9.55027012e+00 -1.24927931e+00 -5.73452546e-01 -5.73452546e-01
 -5.73452546e-01  9.53894544e-01  9.53894544e-01  9.53894544e-01
  6.92013683e+00  6.92013683e+00  6.92013683e+00  2.84775080e+01
  2.89316494e+01  2.89316494e+01  2.89316494e+01  1.03061223e+02
  1.03061223e+02  1.03061223e+02  2.71443373e+02  4.32777820e+02
  4.32777820e+02  4.32777820e+02  1.28473608e+03  1.28473608e+03
  1.28473608e+03  1.99607619e+03  2.98583301e+03  2.98583301e+03
  2.98583301e+03  6.61393445e+03  6.61393445e+03  6.61393445e+03
  8.34613222e+03  2.47295664e+04  7.55208865e+04]
E1 = -727.7674585907658  E_coul = 201.67180761367368
Extra cycle  E= -526.095650977092  delta_E= -5.8e-12  |g|= 2.32e-06  |ddm|= 4.24e-06
    CPU time for scf_cycle      0.63 sec, wall time      0.23 sec
exp = [2.61825084e+04 7.61824442e+03 3.61823794e+03 1.61805489e+03
 2.39706647e+02 5.95133500e+01 1.75672208e+01 4.23247892e+00
 3.97953328e-01 1.36279267e+03 6.65175387e+02 3.03292094e+02
 3.16121302e+02 4.91732973e+01 6.51977550e+00 1.60834246e+01
 7.29723093e-01 2.86295463e+00 2.14677904e-01]
E = -526.0956509770922
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:40:44 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5084182        1
[INPUT] 0    0    [1    /1   ]  7618.24442385        1
[INPUT] 0    0    [1    /1   ]  3618.23794247        1
[INPUT] 0    0    [1    /1   ]  1618.0548884         1
[INPUT] 0    0    [1    /1   ]  239.706647231        1
[INPUT] 0    0    [1    /1   ]  59.5133499639        1
[INPUT] 0    0    [1    /1   ]  17.567220832         1
[INPUT] 0    0    [1    /1   ]  4.2324789194         1
[INPUT] 0    0    [1    /1   ]  0.397953328317       1
[INPUT] 1    0    [1    /1   ]  1362.79267446        1
[INPUT] 1    0    [1    /1   ]  665.175386646        1
[INPUT] 1    0    [1    /1   ]  303.292093936        1
[INPUT] 1    0    [1    /1   ]  316.121302259        1
[INPUT] 1    0    [1    /1   ]  49.1732973429        1
[INPUT] 1    0    [1    /1   ]  6.51977550411        1
[INPUT] 1    0    [1    /1   ]  16.0834245882        1
[INPUT] 1    0    [1    /1   ]  0.729723092799       1
[INPUT] 1    0    [1    /1   ]  2.8629546291         1
[INPUT] 1    0    [1    /1   ]  0.214677904086       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.508418198817, 1.0]], [0, [7618.244423850304, 1.0]], [0, [3618.2379424670135, 1.0]], [0, [1618.0548884041, 1.0]], [0, [239.70664723113168, 1.0]], [0, [59.513349963889944, 1.0]], [0, [17.56722083195684, 1.0]], [0, [4.232478919395555, 1.0]], [0, [0.39795332831672875, 1.0]], [1, [1362.7926744554866, 1.0]], [1, [665.1753866461702, 1.0]], [1, [303.2920939364507, 1.0]], [1, [316.12130225870897, 1.0]], [1, [49.173297342902046, 1.0]], [1, [6.519775504109162, 1.0]], [1, [16.083424588161837, 1.0]], [1, [0.7297230927993549, 1.0]], [1, [2.86295462909799, 1.0]], [1, [0.21467790408552234, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.5084182]
bas 1, expnt(s) = [7618.24442385]
bas 2, expnt(s) = [3618.23794247]
bas 3, expnt(s) = [1618.0548884]
bas 4, expnt(s) = [239.70664723]
bas 5, expnt(s) = [59.51334996]
bas 6, expnt(s) = [17.56722083]
bas 7, expnt(s) = [4.23247892]
bas 8, expnt(s) = [0.39795333]
bas 9, expnt(s) = [1362.79267446]
bas 10, expnt(s) = [665.17538665]
bas 11, expnt(s) = [303.29209394]
bas 12, expnt(s) = [316.12130226]
bas 13, expnt(s) = [49.17329734]
bas 14, expnt(s) = [6.5197755]
bas 15, expnt(s) = [16.08342459]
bas 16, expnt(s) = [0.72972309]
bas 17, expnt(s) = [2.86295463]
bas 18, expnt(s) = [0.2146779]
CPU time:       225.71
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825084e+04 5.20024091e+03 7.61824442e+03 2.06018491e+03
 3.61823794e+03 1.17865816e+03 1.61805489e+03 6.44554970e+02
 2.39706647e+02 1.53912922e+02 5.95133500e+01 5.41347109e+01
 1.75672208e+01 2.16791535e+01 4.23247892e+00 7.45523138e+00
 3.97953328e-01 1.26587007e+00 1.36279267e+03 2.41558114e+04
 6.65175387e+02 9.85495410e+03 3.03292094e+02 3.69241711e+03
 3.16121302e+02 3.88867453e+03 4.91732973e+01 3.79879674e+02
 6.51977550e+00 3.03931137e+01 1.60834246e+01 9.39631465e+01
 7.29723093e-01 1.96757821e+00 2.86295463e+00 1.08643181e+01
 2.14677904e-01 4.26303183e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.980960073750214
cond(S) = 87281.21655745502
E1 = -728.3693738745021  E_coul = 203.0963089484036
init E= -525.273064926099
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.5578947991991  LUMO = 0.962363130357424
  mo_energy =
[-1.18109755e+02 -1.21380577e+01 -9.45041334e+00 -9.45041334e+00
 -9.45041334e+00 -1.22718668e+00 -5.57894799e-01 -5.57894799e-01
 -5.57894799e-01  9.62363130e-01  9.62363130e-01  9.62363130e-01
  6.97216093e+00  6.97216093e+00  6.97216093e+00  2.85827839e+01
  2.90282352e+01  2.90282352e+01  2.90282352e+01  1.03219150e+02
  1.03219150e+02  1.03219150e+02  2.71680202e+02  4.33030181e+02
  4.33030181e+02  4.33030181e+02  1.28505134e+03  1.28505134e+03
  1.28505134e+03  1.99653986e+03  2.98622361e+03  2.98622361e+03
  2.98622361e+03  6.61446493e+03  6.61446493e+03  6.61446493e+03
  8.34675987e+03  2.47303015e+04  7.55217227e+04]
E1 = -727.4506764192329  E_coul = 201.3555490340378
cycle= 1 E= -526.095127385195  delta_E= -0.822  |g|= 0.211  |ddm|= 0.652
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.570923
diis-c [-0.32595285  1.        ]
  HOMO = -0.577977051163278  LUMO = 0.9506629509994
  mo_energy =
[-1.18407583e+02 -1.22525531e+01 -9.57362102e+00 -9.57362102e+00
 -9.57362102e+00 -1.25517297e+00 -5.77977051e-01 -5.77977051e-01
 -5.77977051e-01  9.50662951e-01  9.50662951e-01  9.50662951e-01
  6.90773004e+00  6.90773004e+00  6.90773004e+00  2.84500501e+01
  2.89097065e+01  2.89097065e+01  2.89097065e+01  1.03027099e+02
  1.03027099e+02  1.03027099e+02  2.71399354e+02  4.32732554e+02
  4.32732554e+02  4.32732554e+02  1.28468749e+03  1.28468749e+03
  1.28468749e+03  1.99602557e+03  2.98578286e+03  2.98578286e+03
  2.98578286e+03  6.61388333e+03  6.61388333e+03  6.61388333e+03
  8.34608071e+03  2.47295147e+04  7.55208348e+04]
E1 = -727.839782294622  E_coul = 201.7441550459203
cycle= 2 E= -526.095627248702  delta_E= -0.0005  |g|= 0.0301  |ddm|= 0.0304
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0594426
diis-c [-0.00220086  0.0602882   0.9397118 ]
  HOMO = -0.572648782192878  LUMO = 0.954456118263515
  mo_energy =
[-1.18355104e+02 -1.22263449e+01 -9.54660472e+00 -9.54660472e+00
 -9.54660472e+00 -1.24825789e+00 -5.72648782e-01 -5.72648782e-01
 -5.72648782e-01  9.54456118e-01  9.54456118e-01  9.54456118e-01
  6.92220640e+00  6.92220640e+00  6.92220640e+00  2.84815038e+01
  2.89351002e+01  2.89351002e+01  2.89351002e+01  1.03066262e+02
  1.03066262e+02  1.03066262e+02  2.71449695e+02  4.32784313e+02
  4.32784313e+02  4.32784313e+02  1.28474308e+03  1.28474308e+03
  1.28474308e+03  1.99608369e+03  2.98584032e+03  2.98584032e+03
  2.98584032e+03  6.61394209e+03  6.61394209e+03  6.61394209e+03
  8.34614005e+03  2.47295744e+04  7.55208946e+04]
E1 = -727.7563386705162  E_coul = 201.66068822400797
cycle= 3 E= -526.095650446508  delta_E= -2.32e-05  |g|= 0.00404  |ddm|= 0.00725
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00876821
diis-c [-3.99590340e-07 -1.22437233e-03  1.22480211e-01  8.78744162e-01]
  HOMO = -0.573467484328338  LUMO = 0.953884355771542
  mo_energy =
[-1.18361704e+02 -1.22298552e+01 -9.55030735e+00 -9.55030735e+00
 -9.55030735e+00 -1.24929919e+00 -5.73467484e-01 -5.73467484e-01
 -5.73467484e-01  9.53884356e-01  9.53884356e-01  9.53884356e-01
  6.92010642e+00  6.92010642e+00  6.92010642e+00  2.84774642e+01
  2.89316146e+01  2.89316146e+01  2.89316146e+01  1.03061191e+02
  1.03061191e+02  1.03061191e+02  2.71443350e+02  4.32777799e+02
  4.32777799e+02  4.32777799e+02  1.28473607e+03  1.28473607e+03
  1.28473607e+03  1.99607620e+03  2.98583301e+03  2.98583301e+03
  2.98583301e+03  6.61393446e+03  6.61393446e+03  6.61393446e+03
  8.34613223e+03  2.47295664e+04  7.55208865e+04]
E1 = -727.7675298518576  E_coul = 201.67187887481975
cycle= 4 E= -526.095650977038  delta_E= -5.31e-07  |g|= 3.97e-05  |ddm|= 0.00101
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.96953e-05
diis-c [-1.99836461e-09  4.64737754e-05 -5.81142473e-03 -4.64158089e-02
  1.05218076e+00]
  HOMO = -0.573448247067374  LUMO = 0.953897486825985
  mo_energy =
[-1.18361663e+02 -1.22297966e+01 -9.55025505e+00 -9.55025505e+00
 -9.55025505e+00 -1.24927381e+00 -5.73448247e-01 -5.73448247e-01
 -5.73448247e-01  9.53897487e-01  9.53897487e-01  9.53897487e-01
  6.92014671e+00  6.92014671e+00  6.92014671e+00  2.84775235e+01
  2.89316636e+01  2.89316636e+01  2.89316636e+01  1.03061240e+02
  1.03061240e+02  1.03061240e+02  2.71443392e+02  4.32777840e+02
  4.32777840e+02  4.32777840e+02  1.28473611e+03  1.28473611e+03
  1.28473611e+03  1.99607622e+03  2.98583303e+03  2.98583303e+03
  2.98583303e+03  6.61393447e+03  6.61393447e+03  6.61393447e+03
  8.34613224e+03  2.47295664e+04  7.55208865e+04]
E1 = -727.7674178826289  E_coul = 201.67176690554254
cycle= 5 E= -526.095650977086  delta_E= -4.85e-11  |g|= 8.5e-06  |ddm|= 1.48e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.7674178826289  E_coul = 201.67176690554254
  HOMO = -0.573452545833843  LUMO = 0.953894544358281
  mo_energy =
[-1.18361683e+02 -1.22298113e+01 -9.55027012e+00 -9.55027012e+00
 -9.55027012e+00 -1.24927931e+00 -5.73452546e-01 -5.73452546e-01
 -5.73452546e-01  9.53894544e-01  9.53894544e-01  9.53894544e-01
  6.92013683e+00  6.92013683e+00  6.92013683e+00  2.84775080e+01
  2.89316494e+01  2.89316494e+01  2.89316494e+01  1.03061223e+02
  1.03061223e+02  1.03061223e+02  2.71443373e+02  4.32777820e+02
  4.32777820e+02  4.32777820e+02  1.28473608e+03  1.28473608e+03
  1.28473608e+03  1.99607619e+03  2.98583301e+03  2.98583301e+03
  2.98583301e+03  6.61393445e+03  6.61393445e+03  6.61393445e+03
  8.34613222e+03  2.47295664e+04  7.55208865e+04]
E1 = -727.7674585907658  E_coul = 201.67180761367368
Extra cycle  E= -526.095650977092  delta_E= -5.8e-12  |g|= 2.32e-06  |ddm|= 4.24e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 87281.21655745502
E1 = -727.7674585907658  E_coul = 201.67180761367368
init E= -526.095650977092
    CPU time for initialize scf      2.71 sec, wall time      0.24 sec
  HOMO = -0.573451780672994  LUMO = 0.953895074595477
  mo_energy =
[-1.18361679e+02 -1.22298083e+01 -9.55026705e+00 -9.55026705e+00
 -9.55026705e+00 -1.24927833e+00 -5.73451781e-01 -5.73451781e-01
 -5.73451781e-01  9.53895075e-01  9.53895075e-01  9.53895075e-01
  6.92013869e+00  6.92013869e+00  6.92013869e+00  2.84775114e+01
  2.89316523e+01  2.89316523e+01  2.89316523e+01  1.03061227e+02
  1.03061227e+02  1.03061227e+02  2.71443377e+02  4.32777825e+02
  4.32777825e+02  4.32777825e+02  1.28473609e+03  1.28473609e+03
  1.28473609e+03  1.99607620e+03  2.98583302e+03  2.98583302e+03
  2.98583302e+03  6.61393446e+03  6.61393446e+03  6.61393446e+03
  8.34613223e+03  2.47295664e+04  7.55208865e+04]
E1 = -727.7674497904112  E_coul = 201.67179881331984
cycle= 1 E= -526.095650977091  delta_E= 7.96e-13  |g|= 5.53e-07  |ddm|= 8.39e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.7674497904112  E_coul = 201.67179881331984
  HOMO = -0.573451934216301  LUMO = 0.953894967576312
  mo_energy =
[-1.18361680e+02 -1.22298089e+01 -9.55026771e+00 -9.55026771e+00
 -9.55026771e+00 -1.24927853e+00 -5.73451934e-01 -5.73451934e-01
 -5.73451934e-01  9.53894968e-01  9.53894968e-01  9.53894968e-01
  6.92013830e+00  6.92013830e+00  6.92013830e+00  2.84775106e+01
  2.89316517e+01  2.89316517e+01  2.89316517e+01  1.03061226e+02
  1.03061226e+02  1.03061226e+02  2.71443376e+02  4.32777824e+02
  4.32777824e+02  4.32777824e+02  1.28473609e+03  1.28473609e+03
  1.28473609e+03  1.99607620e+03  2.98583301e+03  2.98583301e+03
  2.98583301e+03  6.61393446e+03  6.61393446e+03  6.61393446e+03
  8.34613222e+03  2.47295664e+04  7.55208865e+04]
E1 = -727.7674517375052  E_coul = 201.67180076041478
Extra cycle  E= -526.09565097709  delta_E= 1.02e-12  |g|= 1.27e-07  |ddm|= 1.8e-07
    CPU time for scf_cycle      2.83 sec, wall time      0.36 sec
exp = [2.61825084e+04 7.61824442e+03 3.61823794e+03 1.61805489e+03
 2.39706647e+02 5.95133500e+01 1.75672208e+01 4.23247892e+00
 3.97953328e-01 1.36279267e+03 6.65175387e+02 3.03292094e+02
 3.16121302e+02 4.91732973e+01 6.51977550e+00 1.60834246e+01
 7.29723093e-01 2.86295463e+00 2.14677904e-01]
grad_E = [-1.95867918e-06  2.58511468e-05  5.65761654e-05  8.20217069e-04
 -8.15164931e-03 -2.98228090e-03  2.45809538e-03 -1.63248529e-02
  3.81964891e-02  1.74011575e-06  2.28375282e-05  1.25127601e-04
  1.10293063e-04 -1.82514326e-03  4.43482679e-03 -4.37026426e-03
 -5.99772773e-02  1.41043029e-02  6.88968552e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:40:48 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5084747        1
[INPUT] 0    0    [1    /1   ]  7618.24373273        1
[INPUT] 0    0    [1    /1   ]  3618.23648171        1
[INPUT] 0    0    [1    /1   ]  1618.03324118        1
[INPUT] 0    0    [1    /1   ]  239.826573643        1
[INPUT] 0    0    [1    /1   ]  59.9515965926        1
[INPUT] 0    0    [1    /1   ]  18.0134967505        1
[INPUT] 0    0    [1    /1   ]  4.24281277549        1
[INPUT] 0    0    [1    /1   ]  0.39803546084        1
[INPUT] 1    0    [1    /1   ]  1362.79263764        1
[INPUT] 1    0    [1    /1   ]  665.17482495         1
[INPUT] 1    0    [1    /1   ]  303.289072897        1
[INPUT] 1    0    [1    /1   ]  316.118639919        1
[INPUT] 1    0    [1    /1   ]  49.1689885908        1
[INPUT] 1    0    [1    /1   ]  6.42442167163        1
[INPUT] 1    0    [1    /1   ]  16.3343902726        1
[INPUT] 1    0    [1    /1   ]  0.726998959805       1
[INPUT] 1    0    [1    /1   ]  2.76581234072        1
[INPUT] 1    0    [1    /1   ]  0.214221377128       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.50847467613, 1.0]], [0, [7618.24373272893, 1.0]], [0, [3618.236481706524, 1.0]], [0, [1618.0332411782845, 1.0]], [0, [239.8265736425802, 1.0]], [0, [59.95159659263233, 1.0]], [0, [18.013496750467194, 1.0]], [0, [4.2428127754941904, 1.0]], [0, [0.39803546084032376, 1.0]], [1, [1362.7926376449361, 1.0]], [1, [665.1748249496085, 1.0]], [1, [303.2890728968298, 1.0]], [1, [316.1186399187601, 1.0]], [1, [49.168988590765935, 1.0]], [1, [6.424421671629846, 1.0]], [1, [16.33439027256283, 1.0]], [1, [0.7269989598054581, 1.0]], [1, [2.765812340721773, 1.0]], [1, [0.21422137712827366, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50847468]
bas 1, expnt(s) = [7618.24373273]
bas 2, expnt(s) = [3618.23648171]
bas 3, expnt(s) = [1618.03324118]
bas 4, expnt(s) = [239.82657364]
bas 5, expnt(s) = [59.95159659]
bas 6, expnt(s) = [18.01349675]
bas 7, expnt(s) = [4.24281278]
bas 8, expnt(s) = [0.39803546]
bas 9, expnt(s) = [1362.79263764]
bas 10, expnt(s) = [665.17482495]
bas 11, expnt(s) = [303.2890729]
bas 12, expnt(s) = [316.11863992]
bas 13, expnt(s) = [49.16898859]
bas 14, expnt(s) = [6.42442167]
bas 15, expnt(s) = [16.33439027]
bas 16, expnt(s) = [0.72699896]
bas 17, expnt(s) = [2.76581234]
bas 18, expnt(s) = [0.21422138]
CPU time:       233.77
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825085e+04 5.20024091e+03 7.61824373e+03 2.06018477e+03
 3.61823648e+03 1.17865780e+03 1.61803324e+03 6.44548503e+02
 2.39826574e+02 1.53970671e+02 5.99515966e+01 5.44334160e+01
 1.80134968e+01 2.20909068e+01 4.24281278e+00 7.46887903e+00
 3.98035461e-01 1.26606601e+00 1.36279264e+03 2.41558106e+04
 6.65174825e+02 9.85494370e+03 3.03289073e+02 3.69237113e+03
 3.16118640e+02 3.88863359e+03 4.91689886e+01 3.79838066e+02
 6.42442167e+00 2.98384968e+01 1.63343903e+01 9.57994581e+01
 7.26998960e-01 1.95840103e+00 2.76581234e+00 1.04054958e+01
 2.14221377e-01 4.25170282e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.981006045874675
cond(S) = 87302.16238696488
E1 = -728.349879212026  E_coul = 203.09837729508018
init E= -525.251501916946
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558002775962743  LUMO = 0.958110061586777
  mo_energy =
[-1.18112042e+02 -1.21362644e+01 -9.45034880e+00 -9.45034880e+00
 -9.45034880e+00 -1.22701385e+00 -5.58002776e-01 -5.58002776e-01
 -5.58002776e-01  9.58110062e-01  9.58110062e-01  9.58110062e-01
  6.78281039e+00  6.78281039e+00  6.78281039e+00  2.86324916e+01
  2.86324916e+01  2.86324916e+01  2.93917563e+01  1.03213185e+02
  1.03213185e+02  1.03213185e+02  2.74656732e+02  4.33281135e+02
  4.33281135e+02  4.33281135e+02  1.28530331e+03  1.28530331e+03
  1.28530331e+03  2.00007741e+03  2.98645713e+03  2.98645713e+03
  2.98645713e+03  6.61467429e+03  6.61467429e+03  6.61467429e+03
  8.35007014e+03  2.47334317e+04  7.55246297e+04]
E1 = -727.4566344203043  E_coul = 201.35847255379997
cycle= 1 E= -526.098161866504  delta_E= -0.847  |g|= 0.213  |ddm|= 0.81
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.572462
diis-c [-0.32771286  1.        ]
  HOMO = -0.578108987923941  LUMO = 0.946497233264555
  mo_energy =
[-1.18410058e+02 -1.22503963e+01 -9.57347291e+00 -9.57347291e+00
 -9.57347291e+00 -1.25496142e+00 -5.78108988e-01 -5.78108988e-01
 -5.78108988e-01  9.46497233e-01  9.46497233e-01  9.46497233e-01
  6.71981280e+00  6.71981280e+00  6.71981280e+00  2.85138505e+01
  2.85138505e+01  2.85138505e+01  2.92577306e+01  1.03020680e+02
  1.03020680e+02  1.03020680e+02  2.74375277e+02  4.32983348e+02
  4.32983348e+02  4.32983348e+02  1.28493943e+03  1.28493943e+03
  1.28493943e+03  1.99956330e+03  2.98601651e+03  2.98601651e+03
  2.98601651e+03  6.61409267e+03  6.61409267e+03  6.61409267e+03
  8.34939090e+03  2.47326446e+04  7.55237414e+04]
E1 = -727.8456639515232  E_coul = 201.7469980256831
cycle= 2 E= -526.09866592584  delta_E= -0.000504  |g|= 0.0303  |ddm|= 0.03
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0593885
diis-c [-0.00221007  0.05980277  0.94019723]
  HOMO = -0.572811096629699  LUMO = 0.95024114779928
  mo_energy =
[-1.18357454e+02 -1.22241635e+01 -9.54644701e+00 -9.54644701e+00
 -9.54644701e+00 -1.24807650e+00 -5.72811097e-01 -5.72811097e-01
 -5.72811097e-01  9.50241148e-01  9.50241148e-01  9.50241148e-01
  6.73400928e+00  6.73400928e+00  6.73400928e+00  2.85392699e+01
  2.85392699e+01  2.85392699e+01  2.92895465e+01  1.03059989e+02
  1.03059989e+02  1.03059989e+02  2.74425775e+02  4.33035232e+02
  4.33035232e+02  4.33035232e+02  1.28499516e+03  1.28499516e+03
  1.28499516e+03  1.99962154e+03  2.98607411e+03  2.98607411e+03
  2.98607411e+03  6.61415155e+03  6.61415155e+03  6.61415155e+03
  8.34945037e+03  2.47327044e+04  7.55238013e+04]
E1 = -727.76194646216  E_coul = 201.66325725392676
cycle= 3 E= -526.098689208233  delta_E= -2.33e-05  |g|= 0.00406  |ddm|= 0.00726
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00878904
diis-c [-4.28537069e-07 -1.23388769e-03  1.22793576e-01  8.78440312e-01]
  HOMO = -0.573639946924178  LUMO = 0.949666585116111
  mo_energy =
[-1.18364098e+02 -1.22277019e+01 -9.55017879e+00 -9.55017879e+00
 -9.55017879e+00 -1.24913076e+00 -5.73639947e-01 -5.73639947e-01
 -5.73639947e-01  9.49666585e-01  9.49666585e-01  9.49666585e-01
  6.73192243e+00  6.73192243e+00  6.73192243e+00  2.85357539e+01
  2.85357539e+01  2.85357539e+01  2.92854413e+01  1.03054873e+02
  1.03054873e+02  1.03054873e+02  2.74419382e+02  4.33028674e+02
  4.33028674e+02  4.33028674e+02  1.28498810e+03  1.28498810e+03
  1.28498810e+03  1.99961400e+03  2.98606675e+03  2.98606675e+03
  2.98606675e+03  6.61414387e+03  6.61414387e+03  6.61414387e+03
  8.34944250e+03  2.47326964e+04  7.55237932e+04]
E1 = -727.7732420543755  E_coul = 201.67455230736547
cycle= 4 E= -526.09868974701  delta_E= -5.39e-07  |g|= 4.09e-05  |ddm|= 0.00101
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.96203e-05
diis-c [-2.18526552e-09  4.50885070e-05 -5.64118640e-03 -4.47730686e-02
  1.05036917e+00]
  HOMO = -0.573619919800131  LUMO = 0.949680160552282
  mo_energy =
[-1.18364053e+02 -1.22276401e+01 -9.55012323e+00 -9.55012323e+00
 -9.55012323e+00 -1.24910432e+00 -5.73619920e-01 -5.73619920e-01
 -5.73619920e-01  9.49680161e-01  9.49680161e-01  9.49680161e-01
  6.73196427e+00  6.73196427e+00  6.73196427e+00  2.85358058e+01
  2.85358058e+01  2.85358058e+01  2.92855041e+01  1.03054925e+02
  1.03054925e+02  1.03054925e+02  2.74419427e+02  4.33028719e+02
  4.33028719e+02  4.33028719e+02  1.28498814e+03  1.28498814e+03
  1.28498814e+03  1.99961403e+03  2.98606678e+03  2.98606678e+03
  2.98606678e+03  6.61414389e+03  6.61414389e+03  6.61414389e+03
  8.34944251e+03  2.47326964e+04  7.55237932e+04]
E1 = -727.7731209078925  E_coul = 201.6744311608271
cycle= 5 E= -526.098689747065  delta_E= -5.54e-11  |g|= 8.81e-06  |ddm|= 1.59e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.7731209078925  E_coul = 201.6744311608271
  HOMO = -0.573624377932055  LUMO = 0.949677130029689
  mo_energy =
[-1.18364074e+02 -1.22276553e+01 -9.55013886e+00 -9.55013886e+00
 -9.55013886e+00 -1.24911002e+00 -5.73624378e-01 -5.73624378e-01
 -5.73624378e-01  9.49677130e-01  9.49677130e-01  9.49677130e-01
  6.73195416e+00  6.73195416e+00  6.73195416e+00  2.85357911e+01
  2.85357911e+01  2.85357911e+01  2.92854879e+01  1.03054907e+02
  1.03054907e+02  1.03054907e+02  2.74419407e+02  4.33028698e+02
  4.33028698e+02  4.33028698e+02  1.28498812e+03  1.28498812e+03
  1.28498812e+03  1.99961401e+03  2.98606676e+03  2.98606676e+03
  2.98606676e+03  6.61414387e+03  6.61414387e+03  6.61414387e+03
  8.34944249e+03  2.47326964e+04  7.55237931e+04]
E1 = -727.7731632650932  E_coul = 201.67447351802232
Extra cycle  E= -526.098689747071  delta_E= -5.57e-12  |g|= 2.41e-06  |ddm|= 4.4e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.23 sec
exp = [2.61825085e+04 7.61824373e+03 3.61823648e+03 1.61803324e+03
 2.39826574e+02 5.99515966e+01 1.80134968e+01 4.24281278e+00
 3.98035461e-01 1.36279264e+03 6.65174825e+02 3.03289073e+02
 3.16118640e+02 4.91689886e+01 6.42442167e+00 1.63343903e+01
 7.26998960e-01 2.76581234e+00 2.14221377e-01]
E = -526.0986897470709
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:40:48 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5084747        1
[INPUT] 0    0    [1    /1   ]  7618.24373273        1
[INPUT] 0    0    [1    /1   ]  3618.23648171        1
[INPUT] 0    0    [1    /1   ]  1618.03324118        1
[INPUT] 0    0    [1    /1   ]  239.826573643        1
[INPUT] 0    0    [1    /1   ]  59.9515965926        1
[INPUT] 0    0    [1    /1   ]  18.0134967505        1
[INPUT] 0    0    [1    /1   ]  4.24281277549        1
[INPUT] 0    0    [1    /1   ]  0.39803546084        1
[INPUT] 1    0    [1    /1   ]  1362.79263764        1
[INPUT] 1    0    [1    /1   ]  665.17482495         1
[INPUT] 1    0    [1    /1   ]  303.289072897        1
[INPUT] 1    0    [1    /1   ]  316.118639919        1
[INPUT] 1    0    [1    /1   ]  49.1689885908        1
[INPUT] 1    0    [1    /1   ]  6.42442167163        1
[INPUT] 1    0    [1    /1   ]  16.3343902726        1
[INPUT] 1    0    [1    /1   ]  0.726998959805       1
[INPUT] 1    0    [1    /1   ]  2.76581234072        1
[INPUT] 1    0    [1    /1   ]  0.214221377128       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.50847467613, 1.0]], [0, [7618.24373272893, 1.0]], [0, [3618.236481706524, 1.0]], [0, [1618.0332411782845, 1.0]], [0, [239.8265736425802, 1.0]], [0, [59.95159659263233, 1.0]], [0, [18.013496750467194, 1.0]], [0, [4.2428127754941904, 1.0]], [0, [0.39803546084032376, 1.0]], [1, [1362.7926376449361, 1.0]], [1, [665.1748249496085, 1.0]], [1, [303.2890728968298, 1.0]], [1, [316.1186399187601, 1.0]], [1, [49.168988590765935, 1.0]], [1, [6.424421671629846, 1.0]], [1, [16.33439027256283, 1.0]], [1, [0.7269989598054581, 1.0]], [1, [2.765812340721773, 1.0]], [1, [0.21422137712827366, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50847468]
bas 1, expnt(s) = [7618.24373273]
bas 2, expnt(s) = [3618.23648171]
bas 3, expnt(s) = [1618.03324118]
bas 4, expnt(s) = [239.82657364]
bas 5, expnt(s) = [59.95159659]
bas 6, expnt(s) = [18.01349675]
bas 7, expnt(s) = [4.24281278]
bas 8, expnt(s) = [0.39803546]
bas 9, expnt(s) = [1362.79263764]
bas 10, expnt(s) = [665.17482495]
bas 11, expnt(s) = [303.2890729]
bas 12, expnt(s) = [316.11863992]
bas 13, expnt(s) = [49.16898859]
bas 14, expnt(s) = [6.42442167]
bas 15, expnt(s) = [16.33439027]
bas 16, expnt(s) = [0.72699896]
bas 17, expnt(s) = [2.76581234]
bas 18, expnt(s) = [0.21422138]
CPU time:       234.49
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825085e+04 5.20024091e+03 7.61824373e+03 2.06018477e+03
 3.61823648e+03 1.17865780e+03 1.61803324e+03 6.44548503e+02
 2.39826574e+02 1.53970671e+02 5.99515966e+01 5.44334160e+01
 1.80134968e+01 2.20909068e+01 4.24281278e+00 7.46887903e+00
 3.98035461e-01 1.26606601e+00 1.36279264e+03 2.41558106e+04
 6.65174825e+02 9.85494370e+03 3.03289073e+02 3.69237113e+03
 3.16118640e+02 3.88863359e+03 4.91689886e+01 3.79838066e+02
 6.42442167e+00 2.98384968e+01 1.63343903e+01 9.57994581e+01
 7.26998960e-01 1.95840103e+00 2.76581234e+00 1.04054958e+01
 2.14221377e-01 4.25170282e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.981006045874675
cond(S) = 87302.16238696488
E1 = -728.349879212026  E_coul = 203.09837729508018
init E= -525.251501916946
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558002775962743  LUMO = 0.958110061586777
  mo_energy =
[-1.18112042e+02 -1.21362644e+01 -9.45034880e+00 -9.45034880e+00
 -9.45034880e+00 -1.22701385e+00 -5.58002776e-01 -5.58002776e-01
 -5.58002776e-01  9.58110062e-01  9.58110062e-01  9.58110062e-01
  6.78281039e+00  6.78281039e+00  6.78281039e+00  2.86324916e+01
  2.86324916e+01  2.86324916e+01  2.93917563e+01  1.03213185e+02
  1.03213185e+02  1.03213185e+02  2.74656732e+02  4.33281135e+02
  4.33281135e+02  4.33281135e+02  1.28530331e+03  1.28530331e+03
  1.28530331e+03  2.00007741e+03  2.98645713e+03  2.98645713e+03
  2.98645713e+03  6.61467429e+03  6.61467429e+03  6.61467429e+03
  8.35007014e+03  2.47334317e+04  7.55246297e+04]
E1 = -727.4566344203043  E_coul = 201.35847255379997
cycle= 1 E= -526.098161866504  delta_E= -0.847  |g|= 0.213  |ddm|= 0.81
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.572462
diis-c [-0.32771286  1.        ]
  HOMO = -0.578108987923941  LUMO = 0.946497233264555
  mo_energy =
[-1.18410058e+02 -1.22503963e+01 -9.57347291e+00 -9.57347291e+00
 -9.57347291e+00 -1.25496142e+00 -5.78108988e-01 -5.78108988e-01
 -5.78108988e-01  9.46497233e-01  9.46497233e-01  9.46497233e-01
  6.71981280e+00  6.71981280e+00  6.71981280e+00  2.85138505e+01
  2.85138505e+01  2.85138505e+01  2.92577306e+01  1.03020680e+02
  1.03020680e+02  1.03020680e+02  2.74375277e+02  4.32983348e+02
  4.32983348e+02  4.32983348e+02  1.28493943e+03  1.28493943e+03
  1.28493943e+03  1.99956330e+03  2.98601651e+03  2.98601651e+03
  2.98601651e+03  6.61409267e+03  6.61409267e+03  6.61409267e+03
  8.34939090e+03  2.47326446e+04  7.55237414e+04]
E1 = -727.8456639515232  E_coul = 201.7469980256831
cycle= 2 E= -526.09866592584  delta_E= -0.000504  |g|= 0.0303  |ddm|= 0.03
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0593885
diis-c [-0.00221007  0.05980277  0.94019723]
  HOMO = -0.572811096629699  LUMO = 0.95024114779928
  mo_energy =
[-1.18357454e+02 -1.22241635e+01 -9.54644701e+00 -9.54644701e+00
 -9.54644701e+00 -1.24807650e+00 -5.72811097e-01 -5.72811097e-01
 -5.72811097e-01  9.50241148e-01  9.50241148e-01  9.50241148e-01
  6.73400928e+00  6.73400928e+00  6.73400928e+00  2.85392699e+01
  2.85392699e+01  2.85392699e+01  2.92895465e+01  1.03059989e+02
  1.03059989e+02  1.03059989e+02  2.74425775e+02  4.33035232e+02
  4.33035232e+02  4.33035232e+02  1.28499516e+03  1.28499516e+03
  1.28499516e+03  1.99962154e+03  2.98607411e+03  2.98607411e+03
  2.98607411e+03  6.61415155e+03  6.61415155e+03  6.61415155e+03
  8.34945037e+03  2.47327044e+04  7.55238013e+04]
E1 = -727.76194646216  E_coul = 201.66325725392676
cycle= 3 E= -526.098689208233  delta_E= -2.33e-05  |g|= 0.00406  |ddm|= 0.00726
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00878904
diis-c [-4.28537069e-07 -1.23388769e-03  1.22793576e-01  8.78440312e-01]
  HOMO = -0.573639946924178  LUMO = 0.949666585116111
  mo_energy =
[-1.18364098e+02 -1.22277019e+01 -9.55017879e+00 -9.55017879e+00
 -9.55017879e+00 -1.24913076e+00 -5.73639947e-01 -5.73639947e-01
 -5.73639947e-01  9.49666585e-01  9.49666585e-01  9.49666585e-01
  6.73192243e+00  6.73192243e+00  6.73192243e+00  2.85357539e+01
  2.85357539e+01  2.85357539e+01  2.92854413e+01  1.03054873e+02
  1.03054873e+02  1.03054873e+02  2.74419382e+02  4.33028674e+02
  4.33028674e+02  4.33028674e+02  1.28498810e+03  1.28498810e+03
  1.28498810e+03  1.99961400e+03  2.98606675e+03  2.98606675e+03
  2.98606675e+03  6.61414387e+03  6.61414387e+03  6.61414387e+03
  8.34944250e+03  2.47326964e+04  7.55237932e+04]
E1 = -727.7732420543755  E_coul = 201.67455230736547
cycle= 4 E= -526.09868974701  delta_E= -5.39e-07  |g|= 4.09e-05  |ddm|= 0.00101
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.96203e-05
diis-c [-2.18526552e-09  4.50885070e-05 -5.64118640e-03 -4.47730686e-02
  1.05036917e+00]
  HOMO = -0.573619919800131  LUMO = 0.949680160552282
  mo_energy =
[-1.18364053e+02 -1.22276401e+01 -9.55012323e+00 -9.55012323e+00
 -9.55012323e+00 -1.24910432e+00 -5.73619920e-01 -5.73619920e-01
 -5.73619920e-01  9.49680161e-01  9.49680161e-01  9.49680161e-01
  6.73196427e+00  6.73196427e+00  6.73196427e+00  2.85358058e+01
  2.85358058e+01  2.85358058e+01  2.92855041e+01  1.03054925e+02
  1.03054925e+02  1.03054925e+02  2.74419427e+02  4.33028719e+02
  4.33028719e+02  4.33028719e+02  1.28498814e+03  1.28498814e+03
  1.28498814e+03  1.99961403e+03  2.98606678e+03  2.98606678e+03
  2.98606678e+03  6.61414389e+03  6.61414389e+03  6.61414389e+03
  8.34944251e+03  2.47326964e+04  7.55237932e+04]
E1 = -727.7731209078925  E_coul = 201.6744311608271
cycle= 5 E= -526.098689747065  delta_E= -5.54e-11  |g|= 8.81e-06  |ddm|= 1.59e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.7731209078925  E_coul = 201.6744311608271
  HOMO = -0.573624377932055  LUMO = 0.949677130029689
  mo_energy =
[-1.18364074e+02 -1.22276553e+01 -9.55013886e+00 -9.55013886e+00
 -9.55013886e+00 -1.24911002e+00 -5.73624378e-01 -5.73624378e-01
 -5.73624378e-01  9.49677130e-01  9.49677130e-01  9.49677130e-01
  6.73195416e+00  6.73195416e+00  6.73195416e+00  2.85357911e+01
  2.85357911e+01  2.85357911e+01  2.92854879e+01  1.03054907e+02
  1.03054907e+02  1.03054907e+02  2.74419407e+02  4.33028698e+02
  4.33028698e+02  4.33028698e+02  1.28498812e+03  1.28498812e+03
  1.28498812e+03  1.99961401e+03  2.98606676e+03  2.98606676e+03
  2.98606676e+03  6.61414387e+03  6.61414387e+03  6.61414387e+03
  8.34944249e+03  2.47326964e+04  7.55237931e+04]
E1 = -727.7731632650932  E_coul = 201.67447351802232
Extra cycle  E= -526.098689747071  delta_E= -5.57e-12  |g|= 2.41e-06  |ddm|= 4.4e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 87302.16238696488
E1 = -727.7731632650932  E_coul = 201.67447351802232
init E= -526.098689747071
    CPU time for initialize scf      3.18 sec, wall time      0.28 sec
  HOMO = -0.573623580884161  LUMO = 0.949677678408796
  mo_energy =
[-1.18364069e+02 -1.22276522e+01 -9.55013567e+00 -9.55013567e+00
 -9.55013567e+00 -1.24910900e+00 -5.73623581e-01 -5.73623581e-01
 -5.73623581e-01  9.49677678e-01  9.49677678e-01  9.49677678e-01
  6.73195607e+00  6.73195607e+00  6.73195607e+00  2.85357941e+01
  2.85357941e+01  2.85357941e+01  2.92854914e+01  1.03054911e+02
  1.03054911e+02  1.03054911e+02  2.74419412e+02  4.33028703e+02
  4.33028703e+02  4.33028703e+02  1.28498812e+03  1.28498812e+03
  1.28498812e+03  1.99961401e+03  2.98606676e+03  2.98606676e+03
  2.98606676e+03  6.61414387e+03  6.61414387e+03  6.61414387e+03
  8.34944249e+03  2.47326964e+04  7.55237931e+04]
E1 = -727.7731540874934  E_coul = 201.67446434042358
cycle= 1 E= -526.09868974707  delta_E= 1.14e-12  |g|= 5.76e-07  |ddm|= 8.73e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.7731540874934  E_coul = 201.67446434042358
  HOMO = -0.573623741325822  LUMO = 0.949677567408297
  mo_energy =
[-1.18364070e+02 -1.22276528e+01 -9.55013635e+00 -9.55013635e+00
 -9.55013635e+00 -1.24910920e+00 -5.73623741e-01 -5.73623741e-01
 -5.73623741e-01  9.49677567e-01  9.49677567e-01  9.49677567e-01
  6.73195567e+00  6.73195567e+00  6.73195567e+00  2.85357935e+01
  2.85357935e+01  2.85357935e+01  2.92854906e+01  1.03054910e+02
  1.03054910e+02  1.03054910e+02  2.74419411e+02  4.33028702e+02
  4.33028702e+02  4.33028702e+02  1.28498812e+03  1.28498812e+03
  1.28498812e+03  1.99961401e+03  2.98606676e+03  2.98606676e+03
  2.98606676e+03  6.61414387e+03  6.61414387e+03  6.61414387e+03
  8.34944249e+03  2.47326964e+04  7.55237931e+04]
E1 = -727.7731561217721  E_coul = 201.6744663747028
Extra cycle  E= -526.098689747069  delta_E= 4.55e-13  |g|= 1.33e-07  |ddm|= 1.88e-07
    CPU time for scf_cycle      3.30 sec, wall time      0.40 sec
exp = [2.61825085e+04 7.61824373e+03 3.61823648e+03 1.61803324e+03
 2.39826574e+02 5.99515966e+01 1.80134968e+01 4.24281278e+00
 3.98035461e-01 1.36279264e+03 6.65174825e+02 3.03289073e+02
 3.16118640e+02 4.91689886e+01 6.42442167e+00 1.63343903e+01
 7.26998960e-01 2.76581234e+00 2.14221377e-01]
grad_E = [-1.95736842e-06  2.60149894e-05  5.71135687e-05  8.26374512e-04
 -8.52324897e-03 -1.65102664e-03  2.31616518e-03 -2.02127843e-02
  4.08164112e-02  2.04373899e-06  2.49421970e-05  1.37972116e-04
  1.21640917e-04 -3.14690002e-03 -3.21802426e-03  1.28859063e-03
 -4.79729373e-02  1.76552200e-02  6.00141721e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:40:53 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5085342        1
[INPUT] 0    0    [1    /1   ]  7618.2429875         1
[INPUT] 0    0    [1    /1   ]  3618.23488962        1
[INPUT] 0    0    [1    /1   ]  1618.00980465        1
[INPUT] 0    0    [1    /1   ]  239.989419738        1
[INPUT] 0    0    [1    /1   ]  60.3083947368        1
[INPUT] 0    0    [1    /1   ]  18.2753736412        1
[INPUT] 0    0    [1    /1   ]  4.25145587547        1
[INPUT] 0    0    [1    /1   ]  0.397190121786       1
[INPUT] 1    0    [1    /1   ]  1362.79259647        1
[INPUT] 1    0    [1    /1   ]  665.174215428        1
[INPUT] 1    0    [1    /1   ]  303.285783222        1
[INPUT] 1    0    [1    /1   ]  316.11574072         1
[INPUT] 1    0    [1    /1   ]  49.1737861274        1
[INPUT] 1    0    [1    /1   ]  6.30326487951        1
[INPUT] 1    0    [1    /1   ]  16.5907316897        1
[INPUT] 1    0    [1    /1   ]  0.720770964738       1
[INPUT] 1    0    [1    /1   ]  2.55513146217        1
[INPUT] 1    0    [1    /1   ]  0.21259204871        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.50853421295, 1.0]], [0, [7618.242987495799, 1.0]], [0, [3618.2348896173585, 1.0]], [0, [1618.0098046514922, 1.0]], [0, [239.98941973845535, 1.0]], [0, [60.308394736807024, 1.0]], [0, [18.275373641213044, 1.0]], [0, [4.251455875465926, 1.0]], [0, [0.39719012178595664, 1.0]], [1, [1362.7925964684193, 1.0]], [1, [665.1742154282089, 1.0]], [1, [303.2857832222315, 1.0]], [1, [316.11574072003265, 1.0]], [1, [49.17378612738588, 1.0]], [1, [6.3032648795074095, 1.0]], [1, [16.590731689706217, 1.0]], [1, [0.7207709647376045, 1.0]], [1, [2.5551314621736054, 1.0]], [1, [0.21259204871007414, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50853421]
bas 1, expnt(s) = [7618.2429875]
bas 2, expnt(s) = [3618.23488962]
bas 3, expnt(s) = [1618.00980465]
bas 4, expnt(s) = [239.98941974]
bas 5, expnt(s) = [60.30839474]
bas 6, expnt(s) = [18.27537364]
bas 7, expnt(s) = [4.25145588]
bas 8, expnt(s) = [0.39719012]
bas 9, expnt(s) = [1362.79259647]
bas 10, expnt(s) = [665.17421543]
bas 11, expnt(s) = [303.28578322]
bas 12, expnt(s) = [316.11574072]
bas 13, expnt(s) = [49.17378613]
bas 14, expnt(s) = [6.30326488]
bas 15, expnt(s) = [16.59073169]
bas 16, expnt(s) = [0.72077096]
bas 17, expnt(s) = [2.55513146]
bas 18, expnt(s) = [0.21259205]
CPU time:       242.98
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825085e+04 5.20024092e+03 7.61824299e+03 2.06018462e+03
 3.61823489e+03 1.17865741e+03 1.61800980e+03 6.44541501e+02
 2.39989420e+02 1.54049075e+02 6.03083947e+01 5.46762034e+01
 1.82753736e+01 2.23313369e+01 4.25145588e+00 7.48028735e+00
 3.97190122e-01 1.26404884e+00 1.36279260e+03 2.41558097e+04
 6.65174215e+02 9.85493241e+03 3.03285783e+02 3.69232107e+03
 3.16115741e+02 3.88858901e+03 4.91737861e+01 3.79884394e+02
 6.30326488e+00 2.91367656e+01 1.65907317e+01 9.76823991e+01
 7.20770965e-01 1.93745220e+00 2.55513146e+00 9.42434019e+00
 2.12592049e-01 4.21131924e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.981334547988716
cond(S) = 87208.92886831568
E1 = -728.3264813861789  E_coul = 203.09106862600706
init E= -525.235412760172
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558471702480188  LUMO = 0.945546908588714
  mo_energy =
[-1.18114597e+02 -1.21355624e+01 -9.45088236e+00 -9.45088236e+00
 -9.45088236e+00 -1.22723367e+00 -5.58471702e-01 -5.58471702e-01
 -5.58471702e-01  9.45546909e-01  9.45546909e-01  9.45546909e-01
  6.39512837e+00  6.39512837e+00  6.39512837e+00  2.77579407e+01
  2.77579407e+01  2.77579407e+01  2.98955833e+01  1.02731042e+02
  1.02731042e+02  1.02731042e+02  2.76721340e+02  4.33200832e+02
  4.33200832e+02  4.33200832e+02  1.28527985e+03  1.28527985e+03
  1.28527985e+03  2.00279555e+03  2.98643912e+03  2.98643912e+03
  2.98643912e+03  6.61465541e+03  6.61465541e+03  6.61465541e+03
  8.35266434e+03  2.47358891e+04  7.55269112e+04]
E1 = -727.4387474466462  E_coul = 201.33773515819368
cycle= 1 E= -526.101012288452  delta_E= -0.866  |g|= 0.215  |ddm|= 0.905
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.571589
diis-c [-0.32671407  1.        ]
  HOMO = -0.579047308774478  LUMO = 0.933885396117584
  mo_energy =
[-1.18414078e+02 -1.22504590e+01 -9.57490563e+00 -9.57490563e+00
 -9.57490563e+00 -1.25556521e+00 -5.79047309e-01 -5.79047309e-01
 -5.79047309e-01  9.33885396e-01  9.33885396e-01  9.33885396e-01
  6.33405849e+00  6.33405849e+00  6.33405849e+00  2.76383680e+01
  2.76383680e+01  2.76383680e+01  2.97596463e+01  1.02536704e+02
  1.02536704e+02  1.02536704e+02  2.76438089e+02  4.32901533e+02
  4.32901533e+02  4.32901533e+02  1.28491460e+03  1.28491460e+03
  1.28491460e+03  2.00228037e+03  2.98599734e+03  2.98599734e+03
  2.98599734e+03  6.61407261e+03  6.61407261e+03  6.61407261e+03
  8.35198396e+03  2.47351007e+04  7.55260216e+04]
E1 = -727.8317484612046  E_coul = 201.73022342616062
cycle= 2 E= -526.101525035044  delta_E= -0.000513  |g|= 0.0306  |ddm|= 0.0295
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0594274
diis-c [-0.00223095  0.05954241  0.94045759]
  HOMO = -0.573713476387393  LUMO = 0.937576956325036
  mo_energy =
[-1.18360920e+02 -1.22239267e+01 -9.54757879e+00 -9.54757879e+00
 -9.54757879e+00 -1.24862955e+00 -5.73713476e-01 -5.73713476e-01
 -5.73713476e-01  9.37576956e-01  9.37576956e-01  9.37576956e-01
  6.34786369e+00  6.34786369e+00  6.34786369e+00  2.76640478e+01
  2.76640478e+01  2.76640478e+01  2.97920024e+01  1.02576548e+02
  1.02576548e+02  1.02576548e+02  2.76489150e+02  4.32953975e+02
  4.32953975e+02  4.32953975e+02  1.28497091e+03  1.28497091e+03
  1.28497091e+03  2.00233922e+03  2.98605554e+03  2.98605554e+03
  2.98605554e+03  6.61413211e+03  6.61413211e+03  6.61413211e+03
  8.35204404e+03  2.47351611e+04  7.55260821e+04]
E1 = -727.7464662253906  E_coul = 201.64491726304888
cycle= 3 E= -526.101548962342  delta_E= -2.39e-05  |g|= 0.00414  |ddm|= 0.00733
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00885385
diis-c [-4.40210609e-07 -1.23301081e-03  1.23615421e-01  8.77617590e-01]
  HOMO = -0.574567851626914  LUMO = 0.936996097152132
  mo_energy =
[-1.18367697e+02 -1.22275496e+01 -9.55139645e+00 -9.55139645e+00
 -9.55139645e+00 -1.24971474e+00 -5.74567852e-01 -5.74567852e-01
 -5.74567852e-01  9.36996097e-01  9.36996097e-01  9.36996097e-01
  6.34579401e+00  6.34579401e+00  6.34579401e+00  2.76604519e+01
  2.76604519e+01  2.76604519e+01  2.97877803e+01  1.02571310e+02
  1.02571310e+02  1.02571310e+02  2.76482624e+02  4.32947284e+02
  4.32947284e+02  4.32947284e+02  1.28496372e+03  1.28496372e+03
  1.28496372e+03  2.00233154e+03  2.98604803e+03  2.98604803e+03
  2.98604803e+03  6.61412428e+03  6.61412428e+03  6.61412428e+03
  8.35203602e+03  2.47351529e+04  7.55260738e+04]
E1 = -727.758081453923  E_coul = 201.65653192558915
cycle= 4 E= -526.101549528334  delta_E= -5.66e-07  |g|= 4.15e-05  |ddm|= 0.00103
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.71035e-05
diis-c [-2.39898805e-09  4.03045376e-05 -5.15497606e-03 -4.03551822e-02
  1.04546985e+00]
  HOMO = -0.574547083045828  LUMO = 0.937009896915188
  mo_energy =
[-1.18367648e+02 -1.22274839e+01 -9.55133690e+00 -9.55133690e+00
 -9.55133690e+00 -1.24968723e+00 -5.74547083e-01 -5.74547083e-01
 -5.74547083e-01  9.37009897e-01  9.37009897e-01  9.37009897e-01
  6.34583690e+00  6.34583690e+00  6.34583690e+00  2.76605073e+01
  2.76605073e+01  2.76605073e+01  2.97878471e+01  1.02571366e+02
  1.02571366e+02  1.02571366e+02  2.76482674e+02  4.32947334e+02
  4.32947334e+02  4.32947334e+02  1.28496376e+03  1.28496376e+03
  1.28496376e+03  2.00233157e+03  2.98604807e+03  2.98604807e+03
  2.98604807e+03  6.61412430e+03  6.61412430e+03  6.61412430e+03
  8.35203604e+03  2.47351529e+04  7.55260739e+04]
E1 = -727.7579468202905  E_coul = 201.65639729189468
cycle= 5 E= -526.101549528396  delta_E= -6.2e-11  |g|= 9.14e-06  |ddm|= 1.74e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.7579468202905  E_coul = 201.65639729189468
  HOMO = -0.574551689170951  LUMO = 0.937006822333895
  mo_energy =
[-1.18367669e+02 -1.22274996e+01 -9.55135304e+00 -9.55135304e+00
 -9.55135304e+00 -1.24969312e+00 -5.74551689e-01 -5.74551689e-01
 -5.74551689e-01  9.37006822e-01  9.37006822e-01  9.37006822e-01
  6.34582676e+00  6.34582676e+00  6.34582676e+00  2.76604921e+01
  2.76604921e+01  2.76604921e+01  2.97878303e+01  1.02571347e+02
  1.02571347e+02  1.02571347e+02  2.76482653e+02  4.32947313e+02
  4.32947313e+02  4.32947313e+02  1.28496374e+03  1.28496374e+03
  1.28496374e+03  2.00233154e+03  2.98604804e+03  2.98604804e+03
  2.98604804e+03  6.61412428e+03  6.61412428e+03  6.61412428e+03
  8.35203602e+03  2.47351529e+04  7.55260738e+04]
E1 = -727.7579909921608  E_coul = 201.65644146375993
Extra cycle  E= -526.101549528401  delta_E= -5e-12  |g|= 2.52e-06  |ddm|= 4.51e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.23 sec
exp = [2.61825085e+04 7.61824299e+03 3.61823489e+03 1.61800980e+03
 2.39989420e+02 6.03083947e+01 1.82753736e+01 4.25145588e+00
 3.97190122e-01 1.36279260e+03 6.65174215e+02 3.03285783e+02
 3.16115741e+02 4.91737861e+01 6.30326488e+00 1.65907317e+01
 7.20770965e-01 2.55513146e+00 2.12592049e-01]
E = -526.1015495284008
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:40:53 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5085342        1
[INPUT] 0    0    [1    /1   ]  7618.2429875         1
[INPUT] 0    0    [1    /1   ]  3618.23488962        1
[INPUT] 0    0    [1    /1   ]  1618.00980465        1
[INPUT] 0    0    [1    /1   ]  239.989419738        1
[INPUT] 0    0    [1    /1   ]  60.3083947368        1
[INPUT] 0    0    [1    /1   ]  18.2753736412        1
[INPUT] 0    0    [1    /1   ]  4.25145587547        1
[INPUT] 0    0    [1    /1   ]  0.397190121786       1
[INPUT] 1    0    [1    /1   ]  1362.79259647        1
[INPUT] 1    0    [1    /1   ]  665.174215428        1
[INPUT] 1    0    [1    /1   ]  303.285783222        1
[INPUT] 1    0    [1    /1   ]  316.11574072         1
[INPUT] 1    0    [1    /1   ]  49.1737861274        1
[INPUT] 1    0    [1    /1   ]  6.30326487951        1
[INPUT] 1    0    [1    /1   ]  16.5907316897        1
[INPUT] 1    0    [1    /1   ]  0.720770964738       1
[INPUT] 1    0    [1    /1   ]  2.55513146217        1
[INPUT] 1    0    [1    /1   ]  0.21259204871        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.50853421295, 1.0]], [0, [7618.242987495799, 1.0]], [0, [3618.2348896173585, 1.0]], [0, [1618.0098046514922, 1.0]], [0, [239.98941973845535, 1.0]], [0, [60.308394736807024, 1.0]], [0, [18.275373641213044, 1.0]], [0, [4.251455875465926, 1.0]], [0, [0.39719012178595664, 1.0]], [1, [1362.7925964684193, 1.0]], [1, [665.1742154282089, 1.0]], [1, [303.2857832222315, 1.0]], [1, [316.11574072003265, 1.0]], [1, [49.17378612738588, 1.0]], [1, [6.3032648795074095, 1.0]], [1, [16.590731689706217, 1.0]], [1, [0.7207709647376045, 1.0]], [1, [2.5551314621736054, 1.0]], [1, [0.21259204871007414, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50853421]
bas 1, expnt(s) = [7618.2429875]
bas 2, expnt(s) = [3618.23488962]
bas 3, expnt(s) = [1618.00980465]
bas 4, expnt(s) = [239.98941974]
bas 5, expnt(s) = [60.30839474]
bas 6, expnt(s) = [18.27537364]
bas 7, expnt(s) = [4.25145588]
bas 8, expnt(s) = [0.39719012]
bas 9, expnt(s) = [1362.79259647]
bas 10, expnt(s) = [665.17421543]
bas 11, expnt(s) = [303.28578322]
bas 12, expnt(s) = [316.11574072]
bas 13, expnt(s) = [49.17378613]
bas 14, expnt(s) = [6.30326488]
bas 15, expnt(s) = [16.59073169]
bas 16, expnt(s) = [0.72077096]
bas 17, expnt(s) = [2.55513146]
bas 18, expnt(s) = [0.21259205]
CPU time:       243.70
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825085e+04 5.20024092e+03 7.61824299e+03 2.06018462e+03
 3.61823489e+03 1.17865741e+03 1.61800980e+03 6.44541501e+02
 2.39989420e+02 1.54049075e+02 6.03083947e+01 5.46762034e+01
 1.82753736e+01 2.23313369e+01 4.25145588e+00 7.48028735e+00
 3.97190122e-01 1.26404884e+00 1.36279260e+03 2.41558097e+04
 6.65174215e+02 9.85493241e+03 3.03285783e+02 3.69232107e+03
 3.16115741e+02 3.88858901e+03 4.91737861e+01 3.79884394e+02
 6.30326488e+00 2.91367656e+01 1.65907317e+01 9.76823991e+01
 7.20770965e-01 1.93745220e+00 2.55513146e+00 9.42434019e+00
 2.12592049e-01 4.21131924e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.981334547988716
cond(S) = 87208.92886831568
E1 = -728.3264813861789  E_coul = 203.09106862600706
init E= -525.235412760172
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558471702480188  LUMO = 0.945546908588714
  mo_energy =
[-1.18114597e+02 -1.21355624e+01 -9.45088236e+00 -9.45088236e+00
 -9.45088236e+00 -1.22723367e+00 -5.58471702e-01 -5.58471702e-01
 -5.58471702e-01  9.45546909e-01  9.45546909e-01  9.45546909e-01
  6.39512837e+00  6.39512837e+00  6.39512837e+00  2.77579407e+01
  2.77579407e+01  2.77579407e+01  2.98955833e+01  1.02731042e+02
  1.02731042e+02  1.02731042e+02  2.76721340e+02  4.33200832e+02
  4.33200832e+02  4.33200832e+02  1.28527985e+03  1.28527985e+03
  1.28527985e+03  2.00279555e+03  2.98643912e+03  2.98643912e+03
  2.98643912e+03  6.61465541e+03  6.61465541e+03  6.61465541e+03
  8.35266434e+03  2.47358891e+04  7.55269112e+04]
E1 = -727.4387474466462  E_coul = 201.33773515819368
cycle= 1 E= -526.101012288452  delta_E= -0.866  |g|= 0.215  |ddm|= 0.905
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.571589
diis-c [-0.32671407  1.        ]
  HOMO = -0.579047308774478  LUMO = 0.933885396117584
  mo_energy =
[-1.18414078e+02 -1.22504590e+01 -9.57490563e+00 -9.57490563e+00
 -9.57490563e+00 -1.25556521e+00 -5.79047309e-01 -5.79047309e-01
 -5.79047309e-01  9.33885396e-01  9.33885396e-01  9.33885396e-01
  6.33405849e+00  6.33405849e+00  6.33405849e+00  2.76383680e+01
  2.76383680e+01  2.76383680e+01  2.97596463e+01  1.02536704e+02
  1.02536704e+02  1.02536704e+02  2.76438089e+02  4.32901533e+02
  4.32901533e+02  4.32901533e+02  1.28491460e+03  1.28491460e+03
  1.28491460e+03  2.00228037e+03  2.98599734e+03  2.98599734e+03
  2.98599734e+03  6.61407261e+03  6.61407261e+03  6.61407261e+03
  8.35198396e+03  2.47351007e+04  7.55260216e+04]
E1 = -727.8317484612046  E_coul = 201.73022342616062
cycle= 2 E= -526.101525035044  delta_E= -0.000513  |g|= 0.0306  |ddm|= 0.0295
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0594274
diis-c [-0.00223095  0.05954241  0.94045759]
  HOMO = -0.573713476387393  LUMO = 0.937576956325036
  mo_energy =
[-1.18360920e+02 -1.22239267e+01 -9.54757879e+00 -9.54757879e+00
 -9.54757879e+00 -1.24862955e+00 -5.73713476e-01 -5.73713476e-01
 -5.73713476e-01  9.37576956e-01  9.37576956e-01  9.37576956e-01
  6.34786369e+00  6.34786369e+00  6.34786369e+00  2.76640478e+01
  2.76640478e+01  2.76640478e+01  2.97920024e+01  1.02576548e+02
  1.02576548e+02  1.02576548e+02  2.76489150e+02  4.32953975e+02
  4.32953975e+02  4.32953975e+02  1.28497091e+03  1.28497091e+03
  1.28497091e+03  2.00233922e+03  2.98605554e+03  2.98605554e+03
  2.98605554e+03  6.61413211e+03  6.61413211e+03  6.61413211e+03
  8.35204404e+03  2.47351611e+04  7.55260821e+04]
E1 = -727.7464662253906  E_coul = 201.64491726304888
cycle= 3 E= -526.101548962342  delta_E= -2.39e-05  |g|= 0.00414  |ddm|= 0.00733
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00885385
diis-c [-4.40210609e-07 -1.23301081e-03  1.23615421e-01  8.77617590e-01]
  HOMO = -0.574567851626914  LUMO = 0.936996097152132
  mo_energy =
[-1.18367697e+02 -1.22275496e+01 -9.55139645e+00 -9.55139645e+00
 -9.55139645e+00 -1.24971474e+00 -5.74567852e-01 -5.74567852e-01
 -5.74567852e-01  9.36996097e-01  9.36996097e-01  9.36996097e-01
  6.34579401e+00  6.34579401e+00  6.34579401e+00  2.76604519e+01
  2.76604519e+01  2.76604519e+01  2.97877803e+01  1.02571310e+02
  1.02571310e+02  1.02571310e+02  2.76482624e+02  4.32947284e+02
  4.32947284e+02  4.32947284e+02  1.28496372e+03  1.28496372e+03
  1.28496372e+03  2.00233154e+03  2.98604803e+03  2.98604803e+03
  2.98604803e+03  6.61412428e+03  6.61412428e+03  6.61412428e+03
  8.35203602e+03  2.47351529e+04  7.55260738e+04]
E1 = -727.758081453923  E_coul = 201.65653192558915
cycle= 4 E= -526.101549528334  delta_E= -5.66e-07  |g|= 4.15e-05  |ddm|= 0.00103
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.71035e-05
diis-c [-2.39898805e-09  4.03045376e-05 -5.15497606e-03 -4.03551822e-02
  1.04546985e+00]
  HOMO = -0.574547083045828  LUMO = 0.937009896915188
  mo_energy =
[-1.18367648e+02 -1.22274839e+01 -9.55133690e+00 -9.55133690e+00
 -9.55133690e+00 -1.24968723e+00 -5.74547083e-01 -5.74547083e-01
 -5.74547083e-01  9.37009897e-01  9.37009897e-01  9.37009897e-01
  6.34583690e+00  6.34583690e+00  6.34583690e+00  2.76605073e+01
  2.76605073e+01  2.76605073e+01  2.97878471e+01  1.02571366e+02
  1.02571366e+02  1.02571366e+02  2.76482674e+02  4.32947334e+02
  4.32947334e+02  4.32947334e+02  1.28496376e+03  1.28496376e+03
  1.28496376e+03  2.00233157e+03  2.98604807e+03  2.98604807e+03
  2.98604807e+03  6.61412430e+03  6.61412430e+03  6.61412430e+03
  8.35203604e+03  2.47351529e+04  7.55260739e+04]
E1 = -727.7579468202905  E_coul = 201.65639729189468
cycle= 5 E= -526.101549528396  delta_E= -6.2e-11  |g|= 9.14e-06  |ddm|= 1.74e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.7579468202905  E_coul = 201.65639729189468
  HOMO = -0.574551689170951  LUMO = 0.937006822333895
  mo_energy =
[-1.18367669e+02 -1.22274996e+01 -9.55135304e+00 -9.55135304e+00
 -9.55135304e+00 -1.24969312e+00 -5.74551689e-01 -5.74551689e-01
 -5.74551689e-01  9.37006822e-01  9.37006822e-01  9.37006822e-01
  6.34582676e+00  6.34582676e+00  6.34582676e+00  2.76604921e+01
  2.76604921e+01  2.76604921e+01  2.97878303e+01  1.02571347e+02
  1.02571347e+02  1.02571347e+02  2.76482653e+02  4.32947313e+02
  4.32947313e+02  4.32947313e+02  1.28496374e+03  1.28496374e+03
  1.28496374e+03  2.00233154e+03  2.98604804e+03  2.98604804e+03
  2.98604804e+03  6.61412428e+03  6.61412428e+03  6.61412428e+03
  8.35203602e+03  2.47351529e+04  7.55260738e+04]
E1 = -727.7579909921608  E_coul = 201.65644146375993
Extra cycle  E= -526.101549528401  delta_E= -5e-12  |g|= 2.52e-06  |ddm|= 4.51e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 87208.92886831568
E1 = -727.7579909921608  E_coul = 201.65644146375993
init E= -526.101549528401
    CPU time for initialize scf      2.71 sec, wall time      0.24 sec
  HOMO = -0.574550857846679  LUMO = 0.937007383460086
  mo_energy =
[-1.18367664e+02 -1.22274963e+01 -9.55134970e+00 -9.55134970e+00
 -9.55134970e+00 -1.24969205e+00 -5.74550858e-01 -5.74550858e-01
 -5.74550858e-01  9.37007383e-01  9.37007383e-01  9.37007383e-01
  6.34582869e+00  6.34582869e+00  6.34582869e+00  2.76604953e+01
  2.76604953e+01  2.76604953e+01  2.97878340e+01  1.02571352e+02
  1.02571352e+02  1.02571352e+02  2.76482658e+02  4.32947318e+02
  4.32947318e+02  4.32947318e+02  1.28496374e+03  1.28496374e+03
  1.28496374e+03  2.00233155e+03  2.98604805e+03  2.98604805e+03
  2.98604805e+03  6.61412429e+03  6.61412429e+03  6.61412429e+03
  8.35203602e+03  2.47351529e+04  7.55260738e+04]
E1 = -727.7579813444711  E_coul = 201.65643181606987
cycle= 1 E= -526.101549528401  delta_E= -3.41e-13  |g|= 6.04e-07  |ddm|= 9.06e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.7579813444711  E_coul = 201.65643181606987
  HOMO = -0.574551027008428  LUMO = 0.937007268692941
  mo_energy =
[-1.18367665e+02 -1.22274970e+01 -9.55135043e+00 -9.55135043e+00
 -9.55135043e+00 -1.24969227e+00 -5.74551027e-01 -5.74551027e-01
 -5.74551027e-01  9.37007269e-01  9.37007269e-01  9.37007269e-01
  6.34582829e+00  6.34582829e+00  6.34582829e+00  2.76604946e+01
  2.76604946e+01  2.76604946e+01  2.97878332e+01  1.02571351e+02
  1.02571351e+02  1.02571351e+02  2.76482657e+02  4.32947317e+02
  4.32947317e+02  4.32947317e+02  1.28496374e+03  1.28496374e+03
  1.28496374e+03  2.00233155e+03  2.98604805e+03  2.98604805e+03
  2.98604805e+03  6.61412429e+03  6.61412429e+03  6.61412429e+03
  8.35203602e+03  2.47351529e+04  7.55260738e+04]
E1 = -727.7579834977761  E_coul = 201.65643396937512
Extra cycle  E= -526.101549528401  delta_E= 2.27e-13  |g|= 1.4e-07  |ddm|= 1.96e-07
    CPU time for scf_cycle      2.84 sec, wall time      0.37 sec
exp = [2.61825085e+04 7.61824299e+03 3.61823489e+03 1.61800980e+03
 2.39989420e+02 6.03083947e+01 1.82753736e+01 4.25145588e+00
 3.97190122e-01 1.36279260e+03 6.65174215e+02 3.03285783e+02
 3.16115741e+02 4.91737861e+01 6.30326488e+00 1.65907317e+01
 7.20770965e-01 2.55513146e+00 2.12592049e-01]
grad_E = [-1.95650971e-06  2.61270960e-05  5.74801435e-05  8.30674697e-04
 -8.82288644e-03 -4.09170662e-04  1.89709874e-03 -2.17064461e-02
  2.87788412e-02  2.33229569e-06  2.69083322e-05  1.49933908e-04
  1.32222376e-04 -4.23775927e-03 -6.26245439e-03  5.52943553e-03
 -2.38621205e-02  1.00502571e-02  3.58427902e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:40:57 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5085468        1
[INPUT] 0    0    [1    /1   ]  7618.24281513        1
[INPUT] 0    0    [1    /1   ]  3618.23450667        1
[INPUT] 0    0    [1    /1   ]  1618.00430232        1
[INPUT] 0    0    [1    /1   ]  240.056046031        1
[INPUT] 0    0    [1    /1   ]  60.2870573063        1
[INPUT] 0    0    [1    /1   ]  18.1576107127        1
[INPUT] 0    0    [1    /1   ]  4.27656690575        1
[INPUT] 0    0    [1    /1   ]  0.39537274381        1
[INPUT] 1    0    [1    /1   ]  1362.79258518        1
[INPUT] 1    0    [1    /1   ]  665.174067848        1
[INPUT] 1    0    [1    /1   ]  303.284974657        1
[INPUT] 1    0    [1    /1   ]  316.115027967        1
[INPUT] 1    0    [1    /1   ]  49.1848840296        1
[INPUT] 1    0    [1    /1   ]  6.25299678441        1
[INPUT] 1    0    [1    /1   ]  16.6317780332        1
[INPUT] 1    0    [1    /1   ]  0.722622413692       1
[INPUT] 1    0    [1    /1   ]  2.44484842178        1
[INPUT] 1    0    [1    /1   ]  0.212419819375       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.508546803827, 1.0]], [0, [7618.242815130477, 1.0]], [0, [3618.234506667825, 1.0]], [0, [1618.0043023165956, 1.0]], [0, [240.05604603100568, 1.0]], [0, [60.28705730626589, 1.0]], [0, [18.15761071269456, 1.0]], [0, [4.276566905748719, 1.0]], [0, [0.39537274381016824, 1.0]], [1, [1362.7925851839175, 1.0]], [1, [665.1740678477278, 1.0]], [1, [303.284974656527, 1.0]], [1, [316.11502796747584, 1.0]], [1, [49.18488402963455, 1.0]], [1, [6.2529967844126135, 1.0]], [1, [16.631778033187583, 1.0]], [1, [0.7226224136915508, 1.0]], [1, [2.4448484217816864, 1.0]], [1, [0.2124198193754247, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.5085468]
bas 1, expnt(s) = [7618.24281513]
bas 2, expnt(s) = [3618.23450667]
bas 3, expnt(s) = [1618.00430232]
bas 4, expnt(s) = [240.05604603]
bas 5, expnt(s) = [60.28705731]
bas 6, expnt(s) = [18.15761071]
bas 7, expnt(s) = [4.27656691]
bas 8, expnt(s) = [0.39537274]
bas 9, expnt(s) = [1362.79258518]
bas 10, expnt(s) = [665.17406785]
bas 11, expnt(s) = [303.28497466]
bas 12, expnt(s) = [316.11502797]
bas 13, expnt(s) = [49.18488403]
bas 14, expnt(s) = [6.25299678]
bas 15, expnt(s) = [16.63177803]
bas 16, expnt(s) = [0.72262241]
bas 17, expnt(s) = [2.44484842]
bas 18, expnt(s) = [0.21241982]
CPU time:       251.73
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825085e+04 5.20024092e+03 7.61824282e+03 2.06018458e+03
 3.61823451e+03 1.17865732e+03 1.61800430e+03 6.44539857e+02
 2.40056046e+02 1.54081150e+02 6.02870573e+01 5.46616943e+01
 1.81576107e+01 2.22233256e+01 4.27656691e+00 7.51339943e+00
 3.95372744e-01 1.25970853e+00 1.36279259e+03 2.41558094e+04
 6.65174068e+02 9.85492968e+03 3.03284975e+02 3.69230877e+03
 3.16115028e+02 3.88857805e+03 4.91848840e+01 3.79991566e+02
 6.25299678e+00 2.88466011e+01 1.66317780e+01 9.79845817e+01
 7.22622414e-01 1.94367513e+00 2.44484842e+00 8.91865400e+00
 2.12419819e-01 4.20705497e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.981426641603182
cond(S) = 87113.44848775989
E1 = -728.3369343604674  E_coul = 203.0840232107836
init E= -525.252911149684
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559113176066872  LUMO = 0.945133433992266
  mo_energy =
[-1.18115056e+02 -1.21358882e+01 -9.45105052e+00 -9.45105052e+00
 -9.45105052e+00 -1.22822203e+00 -5.59113176e-01 -5.59113176e-01
 -5.59113176e-01  9.45133434e-01  9.45133434e-01  9.45133434e-01
  6.21743250e+00  6.21743250e+00  6.21743250e+00  2.72859879e+01
  2.72859879e+01  2.72859879e+01  2.98030222e+01  1.02301019e+02
  1.02301019e+02  1.02301019e+02  2.76349537e+02  4.32939304e+02
  4.32939304e+02  4.32939304e+02  1.28506965e+03  1.28506965e+03
  1.28506965e+03  2.00257971e+03  2.98624788e+03  2.98624788e+03
  2.98624788e+03  6.61448149e+03  6.61448149e+03  6.61448149e+03
  8.35251096e+03  2.47357479e+04  7.55267796e+04]
E1 = -727.4566460807558  E_coul = 201.3542383675924
cycle= 1 E= -526.102407713163  delta_E= -0.849  |g|= 0.212  |ddm|= 0.867
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.5619
diis-c [-0.31573153  1.        ]
  HOMO = -0.579879993820031  LUMO = 0.933401119431761
  mo_energy =
[-1.18409260e+02 -1.22499019e+01 -9.57296342e+00 -9.57296342e+00
 -9.57296342e+00 -1.25669903e+00 -5.79879994e-01 -5.79879994e-01
 -5.79879994e-01  9.33401119e-01  9.33401119e-01  9.33401119e-01
  6.15804897e+00  6.15804897e+00  6.15804897e+00  2.71685581e+01
  2.71685581e+01  2.71685581e+01  2.96690599e+01  1.02110036e+02
  1.02110036e+02  1.02110036e+02  2.76071435e+02  4.32645068e+02
  4.32645068e+02  4.32645068e+02  1.28471011e+03  1.28471011e+03
  1.28471011e+03  2.00207088e+03  2.98581218e+03  2.98581218e+03
  2.98581218e+03  6.61390532e+03  6.61390532e+03  6.61390532e+03
  8.35183752e+03  2.47349668e+04  7.55258974e+04]
E1 = -727.8411784607318  E_coul = 201.73828540389405
cycle= 2 E= -526.102893056838  delta_E= -0.000485  |g|= 0.0298  |ddm|= 0.0284
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0578647
diis-c [-0.00217145  0.05772732  0.94227268]
  HOMO = -0.574653098699241  LUMO = 0.937000978162259
  mo_energy =
[-1.18357201e+02 -1.22238839e+01 -9.54615165e+00 -9.54615165e+00
 -9.54615165e+00 -1.24990584e+00 -5.74653099e-01 -5.74653099e-01
 -5.74653099e-01  9.37000978e-01  9.37000978e-01  9.37000978e-01
  6.17132217e+00  6.17132217e+00  6.17132217e+00  2.71937128e+01
  2.71937128e+01  2.71937128e+01  2.97006835e+01  1.02149114e+02
  1.02149114e+02  1.02149114e+02  2.76121440e+02  4.32696431e+02
  4.32696431e+02  4.32696431e+02  1.28476527e+03  1.28476527e+03
  1.28476527e+03  2.00212855e+03  2.98586920e+03  2.98586920e+03
  2.98586920e+03  6.61396363e+03  6.61396363e+03  6.61396363e+03
  8.35189642e+03  2.47350261e+04  7.55259567e+04]
E1 = -727.757066877163  E_coul = 201.65415082225155
cycle= 3 E= -526.102916054911  delta_E= -2.3e-05  |g|= 0.00414  |ddm|= 0.00719
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00874373
diis-c [-3.66974487e-07 -1.18705208e-03  1.25590576e-01  8.75596476e-01]
  HOMO = -0.575509801462762  LUMO = 0.936420329548381
  mo_energy =
[-1.18363975e+02 -1.22275163e+01 -9.54996936e+00 -9.54996936e+00
 -9.54996936e+00 -1.25099327e+00 -5.75509801e-01 -5.75509801e-01
 -5.75509801e-01  9.36420330e-01  9.36420330e-01  9.36420330e-01
  6.16928797e+00  6.16928797e+00  6.16928797e+00  2.71901217e+01
  2.71901217e+01  2.71901217e+01  2.96964569e+01  1.02143871e+02
  1.02143871e+02  1.02143871e+02  2.76114917e+02  4.32689743e+02
  4.32689743e+02  4.32689743e+02  1.28475808e+03  1.28475808e+03
  1.28475808e+03  2.00212089e+03  2.98586171e+03  2.98586171e+03
  2.98586171e+03  6.61395582e+03  6.61395582e+03  6.61395582e+03
  8.35188843e+03  2.47350179e+04  7.55259485e+04]
E1 = -727.7687264096525  E_coul = 201.6658097868342
cycle= 4 E= -526.102916622818  delta_E= -5.68e-07  |g|= 3.94e-05  |ddm|= 0.00102
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.69629e-05
diis-c [-2.25064984e-09  3.20622709e-05 -4.36393858e-03 -3.27661048e-02
  1.03709798e+00]
  HOMO = -0.575489096829645  LUMO = 0.936434017923271
  mo_energy =
[-1.18363920e+02 -1.22274493e+01 -9.54990765e+00 -9.54990765e+00
 -9.54990765e+00 -1.25096583e+00 -5.75489097e-01 -5.75489097e-01
 -5.75489097e-01  9.36434018e-01  9.36434018e-01  9.36434018e-01
  6.16933076e+00  6.16933076e+00  6.16933076e+00  2.71901789e+01
  2.71901789e+01  2.71901789e+01  2.96965252e+01  1.02143930e+02
  1.02143930e+02  1.02143930e+02  2.76114972e+02  4.32689798e+02
  4.32689798e+02  4.32689798e+02  1.28475813e+03  1.28475813e+03
  1.28475813e+03  2.00212092e+03  2.98586175e+03  2.98586175e+03
  2.98586175e+03  6.61395585e+03  6.61395585e+03  6.61395585e+03
  8.35188846e+03  2.47350179e+04  7.55259485e+04]
E1 = -727.7685810347242  E_coul = 201.66566441183897
cycle= 5 E= -526.102916622885  delta_E= -6.7e-11  |g|= 8.81e-06  |ddm|= 1.84e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.7685810347242  E_coul = 201.66566441183897
  HOMO = -0.575493489440457  LUMO = 0.936431093723436
  mo_energy =
[-1.18363941e+02 -1.22274642e+01 -9.54992304e+00 -9.54992304e+00
 -9.54992304e+00 -1.25097142e+00 -5.75493489e-01 -5.75493489e-01
 -5.75493489e-01  9.36431094e-01  9.36431094e-01  9.36431094e-01
  6.16932125e+00  6.16932125e+00  6.16932125e+00  2.71901644e+01
  2.71901644e+01  2.71901644e+01  2.96965093e+01  1.02143912e+02
  1.02143912e+02  1.02143912e+02  2.76114952e+02  4.32689777e+02
  4.32689777e+02  4.32689777e+02  1.28475811e+03  1.28475811e+03
  1.28475811e+03  2.00212090e+03  2.98586173e+03  2.98586173e+03
  2.98586173e+03  6.61395583e+03  6.61395583e+03  6.61395583e+03
  8.35188843e+03  2.47350179e+04  7.55259485e+04]
E1 = -727.7686235517566  E_coul = 201.66570692886683
Extra cycle  E= -526.10291662289  delta_E= -4.55e-12  |g|= 2.43e-06  |ddm|= 4.28e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.23 sec
exp = [2.61825085e+04 7.61824282e+03 3.61823451e+03 1.61800430e+03
 2.40056046e+02 6.02870573e+01 1.81576107e+01 4.27656691e+00
 3.95372744e-01 1.36279259e+03 6.65174068e+02 3.03284975e+02
 3.16115028e+02 4.91848840e+01 6.25299678e+00 1.66317780e+01
 7.22622414e-01 2.44484842e+00 2.12419819e-01]
E = -526.1029166228898
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:40:57 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5085468        1
[INPUT] 0    0    [1    /1   ]  7618.24281513        1
[INPUT] 0    0    [1    /1   ]  3618.23450667        1
[INPUT] 0    0    [1    /1   ]  1618.00430232        1
[INPUT] 0    0    [1    /1   ]  240.056046031        1
[INPUT] 0    0    [1    /1   ]  60.2870573063        1
[INPUT] 0    0    [1    /1   ]  18.1576107127        1
[INPUT] 0    0    [1    /1   ]  4.27656690575        1
[INPUT] 0    0    [1    /1   ]  0.39537274381        1
[INPUT] 1    0    [1    /1   ]  1362.79258518        1
[INPUT] 1    0    [1    /1   ]  665.174067848        1
[INPUT] 1    0    [1    /1   ]  303.284974657        1
[INPUT] 1    0    [1    /1   ]  316.115027967        1
[INPUT] 1    0    [1    /1   ]  49.1848840296        1
[INPUT] 1    0    [1    /1   ]  6.25299678441        1
[INPUT] 1    0    [1    /1   ]  16.6317780332        1
[INPUT] 1    0    [1    /1   ]  0.722622413692       1
[INPUT] 1    0    [1    /1   ]  2.44484842178        1
[INPUT] 1    0    [1    /1   ]  0.212419819375       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.508546803827, 1.0]], [0, [7618.242815130477, 1.0]], [0, [3618.234506667825, 1.0]], [0, [1618.0043023165956, 1.0]], [0, [240.05604603100568, 1.0]], [0, [60.28705730626589, 1.0]], [0, [18.15761071269456, 1.0]], [0, [4.276566905748719, 1.0]], [0, [0.39537274381016824, 1.0]], [1, [1362.7925851839175, 1.0]], [1, [665.1740678477278, 1.0]], [1, [303.284974656527, 1.0]], [1, [316.11502796747584, 1.0]], [1, [49.18488402963455, 1.0]], [1, [6.2529967844126135, 1.0]], [1, [16.631778033187583, 1.0]], [1, [0.7226224136915508, 1.0]], [1, [2.4448484217816864, 1.0]], [1, [0.2124198193754247, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.5085468]
bas 1, expnt(s) = [7618.24281513]
bas 2, expnt(s) = [3618.23450667]
bas 3, expnt(s) = [1618.00430232]
bas 4, expnt(s) = [240.05604603]
bas 5, expnt(s) = [60.28705731]
bas 6, expnt(s) = [18.15761071]
bas 7, expnt(s) = [4.27656691]
bas 8, expnt(s) = [0.39537274]
bas 9, expnt(s) = [1362.79258518]
bas 10, expnt(s) = [665.17406785]
bas 11, expnt(s) = [303.28497466]
bas 12, expnt(s) = [316.11502797]
bas 13, expnt(s) = [49.18488403]
bas 14, expnt(s) = [6.25299678]
bas 15, expnt(s) = [16.63177803]
bas 16, expnt(s) = [0.72262241]
bas 17, expnt(s) = [2.44484842]
bas 18, expnt(s) = [0.21241982]
CPU time:       252.46
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825085e+04 5.20024092e+03 7.61824282e+03 2.06018458e+03
 3.61823451e+03 1.17865732e+03 1.61800430e+03 6.44539857e+02
 2.40056046e+02 1.54081150e+02 6.02870573e+01 5.46616943e+01
 1.81576107e+01 2.22233256e+01 4.27656691e+00 7.51339943e+00
 3.95372744e-01 1.25970853e+00 1.36279259e+03 2.41558094e+04
 6.65174068e+02 9.85492968e+03 3.03284975e+02 3.69230877e+03
 3.16115028e+02 3.88857805e+03 4.91848840e+01 3.79991566e+02
 6.25299678e+00 2.88466011e+01 1.66317780e+01 9.79845817e+01
 7.22622414e-01 1.94367513e+00 2.44484842e+00 8.91865400e+00
 2.12419819e-01 4.20705497e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.981426641603182
cond(S) = 87113.44848775989
E1 = -728.3369343604674  E_coul = 203.0840232107836
init E= -525.252911149684
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559113176066872  LUMO = 0.945133433992266
  mo_energy =
[-1.18115056e+02 -1.21358882e+01 -9.45105052e+00 -9.45105052e+00
 -9.45105052e+00 -1.22822203e+00 -5.59113176e-01 -5.59113176e-01
 -5.59113176e-01  9.45133434e-01  9.45133434e-01  9.45133434e-01
  6.21743250e+00  6.21743250e+00  6.21743250e+00  2.72859879e+01
  2.72859879e+01  2.72859879e+01  2.98030222e+01  1.02301019e+02
  1.02301019e+02  1.02301019e+02  2.76349537e+02  4.32939304e+02
  4.32939304e+02  4.32939304e+02  1.28506965e+03  1.28506965e+03
  1.28506965e+03  2.00257971e+03  2.98624788e+03  2.98624788e+03
  2.98624788e+03  6.61448149e+03  6.61448149e+03  6.61448149e+03
  8.35251096e+03  2.47357479e+04  7.55267796e+04]
E1 = -727.4566460807558  E_coul = 201.3542383675924
cycle= 1 E= -526.102407713163  delta_E= -0.849  |g|= 0.212  |ddm|= 0.867
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.5619
diis-c [-0.31573153  1.        ]
  HOMO = -0.579879993820031  LUMO = 0.933401119431761
  mo_energy =
[-1.18409260e+02 -1.22499019e+01 -9.57296342e+00 -9.57296342e+00
 -9.57296342e+00 -1.25669903e+00 -5.79879994e-01 -5.79879994e-01
 -5.79879994e-01  9.33401119e-01  9.33401119e-01  9.33401119e-01
  6.15804897e+00  6.15804897e+00  6.15804897e+00  2.71685581e+01
  2.71685581e+01  2.71685581e+01  2.96690599e+01  1.02110036e+02
  1.02110036e+02  1.02110036e+02  2.76071435e+02  4.32645068e+02
  4.32645068e+02  4.32645068e+02  1.28471011e+03  1.28471011e+03
  1.28471011e+03  2.00207088e+03  2.98581218e+03  2.98581218e+03
  2.98581218e+03  6.61390532e+03  6.61390532e+03  6.61390532e+03
  8.35183752e+03  2.47349668e+04  7.55258974e+04]
E1 = -727.8411784607318  E_coul = 201.73828540389405
cycle= 2 E= -526.102893056838  delta_E= -0.000485  |g|= 0.0298  |ddm|= 0.0284
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0578647
diis-c [-0.00217145  0.05772732  0.94227268]
  HOMO = -0.574653098699241  LUMO = 0.937000978162259
  mo_energy =
[-1.18357201e+02 -1.22238839e+01 -9.54615165e+00 -9.54615165e+00
 -9.54615165e+00 -1.24990584e+00 -5.74653099e-01 -5.74653099e-01
 -5.74653099e-01  9.37000978e-01  9.37000978e-01  9.37000978e-01
  6.17132217e+00  6.17132217e+00  6.17132217e+00  2.71937128e+01
  2.71937128e+01  2.71937128e+01  2.97006835e+01  1.02149114e+02
  1.02149114e+02  1.02149114e+02  2.76121440e+02  4.32696431e+02
  4.32696431e+02  4.32696431e+02  1.28476527e+03  1.28476527e+03
  1.28476527e+03  2.00212855e+03  2.98586920e+03  2.98586920e+03
  2.98586920e+03  6.61396363e+03  6.61396363e+03  6.61396363e+03
  8.35189642e+03  2.47350261e+04  7.55259567e+04]
E1 = -727.757066877163  E_coul = 201.65415082225155
cycle= 3 E= -526.102916054911  delta_E= -2.3e-05  |g|= 0.00414  |ddm|= 0.00719
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00874373
diis-c [-3.66974487e-07 -1.18705208e-03  1.25590576e-01  8.75596476e-01]
  HOMO = -0.575509801462762  LUMO = 0.936420329548381
  mo_energy =
[-1.18363975e+02 -1.22275163e+01 -9.54996936e+00 -9.54996936e+00
 -9.54996936e+00 -1.25099327e+00 -5.75509801e-01 -5.75509801e-01
 -5.75509801e-01  9.36420330e-01  9.36420330e-01  9.36420330e-01
  6.16928797e+00  6.16928797e+00  6.16928797e+00  2.71901217e+01
  2.71901217e+01  2.71901217e+01  2.96964569e+01  1.02143871e+02
  1.02143871e+02  1.02143871e+02  2.76114917e+02  4.32689743e+02
  4.32689743e+02  4.32689743e+02  1.28475808e+03  1.28475808e+03
  1.28475808e+03  2.00212089e+03  2.98586171e+03  2.98586171e+03
  2.98586171e+03  6.61395582e+03  6.61395582e+03  6.61395582e+03
  8.35188843e+03  2.47350179e+04  7.55259485e+04]
E1 = -727.7687264096525  E_coul = 201.6658097868342
cycle= 4 E= -526.102916622818  delta_E= -5.68e-07  |g|= 3.94e-05  |ddm|= 0.00102
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.69629e-05
diis-c [-2.25064984e-09  3.20622709e-05 -4.36393858e-03 -3.27661048e-02
  1.03709798e+00]
  HOMO = -0.575489096829645  LUMO = 0.936434017923271
  mo_energy =
[-1.18363920e+02 -1.22274493e+01 -9.54990765e+00 -9.54990765e+00
 -9.54990765e+00 -1.25096583e+00 -5.75489097e-01 -5.75489097e-01
 -5.75489097e-01  9.36434018e-01  9.36434018e-01  9.36434018e-01
  6.16933076e+00  6.16933076e+00  6.16933076e+00  2.71901789e+01
  2.71901789e+01  2.71901789e+01  2.96965252e+01  1.02143930e+02
  1.02143930e+02  1.02143930e+02  2.76114972e+02  4.32689798e+02
  4.32689798e+02  4.32689798e+02  1.28475813e+03  1.28475813e+03
  1.28475813e+03  2.00212092e+03  2.98586175e+03  2.98586175e+03
  2.98586175e+03  6.61395585e+03  6.61395585e+03  6.61395585e+03
  8.35188846e+03  2.47350179e+04  7.55259485e+04]
E1 = -727.7685810347242  E_coul = 201.66566441183897
cycle= 5 E= -526.102916622885  delta_E= -6.7e-11  |g|= 8.81e-06  |ddm|= 1.84e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.7685810347242  E_coul = 201.66566441183897
  HOMO = -0.575493489440457  LUMO = 0.936431093723436
  mo_energy =
[-1.18363941e+02 -1.22274642e+01 -9.54992304e+00 -9.54992304e+00
 -9.54992304e+00 -1.25097142e+00 -5.75493489e-01 -5.75493489e-01
 -5.75493489e-01  9.36431094e-01  9.36431094e-01  9.36431094e-01
  6.16932125e+00  6.16932125e+00  6.16932125e+00  2.71901644e+01
  2.71901644e+01  2.71901644e+01  2.96965093e+01  1.02143912e+02
  1.02143912e+02  1.02143912e+02  2.76114952e+02  4.32689777e+02
  4.32689777e+02  4.32689777e+02  1.28475811e+03  1.28475811e+03
  1.28475811e+03  2.00212090e+03  2.98586173e+03  2.98586173e+03
  2.98586173e+03  6.61395583e+03  6.61395583e+03  6.61395583e+03
  8.35188843e+03  2.47350179e+04  7.55259485e+04]
E1 = -727.7686235517566  E_coul = 201.66570692886683
Extra cycle  E= -526.10291662289  delta_E= -4.55e-12  |g|= 2.43e-06  |ddm|= 4.28e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 87113.44848775989
E1 = -727.7686235517566  E_coul = 201.66570692886683
init E= -526.10291662289
    CPU time for initialize scf      2.72 sec, wall time      0.24 sec
  HOMO = -0.575492691698187  LUMO = 0.936431630318401
  mo_energy =
[-1.18363936e+02 -1.22274611e+01 -9.54991984e+00 -9.54991984e+00
 -9.54991984e+00 -1.25097040e+00 -5.75492692e-01 -5.75492692e-01
 -5.75492692e-01  9.36431630e-01  9.36431630e-01  9.36431630e-01
  6.16932307e+00  6.16932307e+00  6.16932307e+00  2.71901674e+01
  2.71901674e+01  2.71901674e+01  2.96965128e+01  1.02143917e+02
  1.02143917e+02  1.02143917e+02  2.76114957e+02  4.32689782e+02
  4.32689782e+02  4.32689782e+02  1.28475811e+03  1.28475811e+03
  1.28475811e+03  2.00212091e+03  2.98586173e+03  2.98586173e+03
  2.98586173e+03  6.61395584e+03  6.61395584e+03  6.61395584e+03
  8.35188844e+03  2.47350179e+04  7.55259485e+04]
E1 = -727.7686142044955  E_coul = 201.6656975816062
cycle= 1 E= -526.102916622889  delta_E= 4.55e-13  |g|= 5.84e-07  |ddm|= 8.7e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.7686142044955  E_coul = 201.6656975816062
  HOMO = -0.575492855746853  LUMO = 0.936431519420817
  mo_energy =
[-1.18363937e+02 -1.22274618e+01 -9.54992054e+00 -9.54992054e+00
 -9.54992054e+00 -1.25097061e+00 -5.75492856e-01 -5.75492856e-01
 -5.75492856e-01  9.36431519e-01  9.36431519e-01  9.36431519e-01
  6.16932268e+00  6.16932268e+00  6.16932268e+00  2.71901668e+01
  2.71901668e+01  2.71901668e+01  2.96965120e+01  1.02143916e+02
  1.02143916e+02  1.02143916e+02  2.76114956e+02  4.32689781e+02
  4.32689781e+02  4.32689781e+02  1.28475811e+03  1.28475811e+03
  1.28475811e+03  2.00212090e+03  2.98586173e+03  2.98586173e+03
  2.98586173e+03  6.61395584e+03  6.61395584e+03  6.61395584e+03
  8.35188844e+03  2.47350179e+04  7.55259485e+04]
E1 = -727.7686163017497  E_coul = 201.6656996788591
Extra cycle  E= -526.102916622891  delta_E= -1.25e-12  |g|= 1.36e-07  |ddm|= 1.89e-07
    CPU time for scf_cycle      2.84 sec, wall time      0.36 sec
exp = [2.61825085e+04 7.61824282e+03 3.61823451e+03 1.61800430e+03
 2.40056046e+02 6.02870573e+01 1.81576107e+01 4.27656691e+00
 3.95372744e-01 1.36279259e+03 6.65174068e+02 3.03284975e+02
 3.16115028e+02 4.91848840e+01 6.25299678e+00 1.66317780e+01
 7.22622414e-01 2.44484842e+00 2.12419819e-01]
grad_E = [-1.95714626e-06  2.60923569e-05  5.73598371e-05  8.29456983e-04
 -8.79312404e-03 -5.10510956e-04  1.33588920e-03 -4.64001541e-03
  1.62949596e-03  2.36168077e-06  2.71063709e-05  1.51137483e-04
  1.33287515e-04 -4.32987016e-03 -3.04472993e-03  5.48109362e-03
 -2.35514339e-03  1.17286470e-03  4.20149255e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:41:02 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5085231        1
[INPUT] 0    0    [1    /1   ]  7618.2430669         1
[INPUT] 0    0    [1    /1   ]  3618.23499971        1
[INPUT] 0    0    [1    /1   ]  1618.0119712         1
[INPUT] 0    0    [1    /1   ]  240.089150251        1
[INPUT] 0    0    [1    /1   ]  59.8620619151        1
[INPUT] 0    0    [1    /1   ]  17.4940201919        1
[INPUT] 0    0    [1    /1   ]  4.25850248332        1
[INPUT] 0    0    [1    /1   ]  0.394738025018       1
[INPUT] 1    0    [1    /1   ]  1362.79259543        1
[INPUT] 1    0    [1    /1   ]  665.174265625        1
[INPUT] 1    0    [1    /1   ]  303.286014139        1
[INPUT] 1    0    [1    /1   ]  316.115943647        1
[INPUT] 1    0    [1    /1   ]  49.2050276717        1
[INPUT] 1    0    [1    /1   ]  6.16527211849        1
[INPUT] 1    0    [1    /1   ]  16.5365995067        1
[INPUT] 1    0    [1    /1   ]  0.721030888919       1
[INPUT] 1    0    [1    /1   ]  2.34939579632        1
[INPUT] 1    0    [1    /1   ]  0.212356353671       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.508523094624, 1.0]], [0, [7618.243066896257, 1.0]], [0, [3618.2349997114834, 1.0]], [0, [1618.011971199099, 1.0]], [0, [240.08915025108467, 1.0]], [0, [59.86206191509268, 1.0]], [0, [17.49402019193466, 1.0]], [0, [4.2585024833246825, 1.0]], [0, [0.3947380250179764, 1.0]], [1, [1362.7925954303525, 1.0]], [1, [665.1742656248034, 1.0]], [1, [303.28601413850845, 1.0]], [1, [316.11594364740114, 1.0]], [1, [49.205027671652175, 1.0]], [1, [6.165272118493103, 1.0]], [1, [16.536599506747763, 1.0]], [1, [0.7210308889186003, 1.0]], [1, [2.349395796319319, 1.0]], [1, [0.21235635367145264, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50852309]
bas 1, expnt(s) = [7618.2430669]
bas 2, expnt(s) = [3618.23499971]
bas 3, expnt(s) = [1618.0119712]
bas 4, expnt(s) = [240.08915025]
bas 5, expnt(s) = [59.86206192]
bas 6, expnt(s) = [17.49402019]
bas 7, expnt(s) = [4.25850248]
bas 8, expnt(s) = [0.39473803]
bas 9, expnt(s) = [1362.79259543]
bas 10, expnt(s) = [665.17426562]
bas 11, expnt(s) = [303.28601414]
bas 12, expnt(s) = [316.11594365]
bas 13, expnt(s) = [49.20502767]
bas 14, expnt(s) = [6.16527212]
bas 15, expnt(s) = [16.53659951]
bas 16, expnt(s) = [0.72103089]
bas 17, expnt(s) = [2.3493958]
bas 18, expnt(s) = [0.21235635]
CPU time:       260.50
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825085e+04 5.20024092e+03 7.61824307e+03 2.06018463e+03
 3.61823500e+03 1.17865744e+03 1.61801197e+03 6.44542148e+02
 2.40089150e+02 1.54097086e+02 5.98620619e+01 5.43724344e+01
 1.74940202e+01 2.16113672e+01 4.25850248e+00 7.48958412e+00
 3.94738025e-01 1.25819150e+00 1.36279260e+03 2.41558097e+04
 6.65174266e+02 9.85493334e+03 3.03286014e+02 3.69232458e+03
 3.16115944e+02 3.88859213e+03 4.92050277e+01 3.80186107e+02
 6.16527212e+00 2.83416222e+01 1.65365995e+01 9.72841644e+01
 7.21030889e-01 1.93832559e+00 2.34939580e+00 8.48554277e+00
 2.12356354e-01 4.20548383e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98161620583017
cond(S) = 86899.13171790437
E1 = -728.3449827409668  E_coul = 203.07566083520888
init E= -525.269321905758
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559412332273432  LUMO = 0.942639914472864
  mo_energy =
[-1.18113917e+02 -1.21384913e+01 -9.45173049e+00 -9.45173049e+00
 -9.45173049e+00 -1.22843732e+00 -5.59412332e-01 -5.59412332e-01
 -5.59412332e-01  9.42639914e-01  9.42639914e-01  9.42639914e-01
  6.04242076e+00  6.04242076e+00  6.04242076e+00  2.66836165e+01
  2.66836165e+01  2.66836165e+01  2.86278215e+01  1.01424403e+02
  1.01424403e+02  1.01424403e+02  2.72628070e+02  4.32190345e+02
  4.32190345e+02  4.32190345e+02  1.28442299e+03  1.28442299e+03
  1.28442299e+03  1.99875604e+03  2.98565503e+03  2.98565503e+03
  2.98565503e+03  6.61394467e+03  6.61394467e+03  6.61394467e+03
  8.34904643e+03  2.47324809e+04  7.55237441e+04]
E1 = -727.452810527408  E_coul = 201.34955143375507
cycle= 1 E= -526.103259093653  delta_E= -0.834  |g|= 0.21  |ddm|= 0.796
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.557121
diis-c [-0.31038406  1.        ]
  HOMO = -0.580289975432963  LUMO = 0.930937204678893
  mo_energy =
[-1.18406952e+02 -1.22523047e+01 -9.57337540e+00 -9.57337540e+00
 -9.57337540e+00 -1.25690734e+00 -5.80289975e-01 -5.80289975e-01
 -5.80289975e-01  9.30937205e-01  9.30937205e-01  9.30937205e-01
  5.98432944e+00  5.98432944e+00  5.98432944e+00  2.65670588e+01
  2.65670588e+01  2.65670588e+01  2.84963001e+01  1.01233992e+02
  1.01233992e+02  1.01233992e+02  2.72351421e+02  4.31897094e+02
  4.31897094e+02  4.31897094e+02  1.28406463e+03  1.28406463e+03
  1.28406463e+03  1.99824866e+03  2.98522066e+03  2.98522066e+03
  2.98522066e+03  6.61337023e+03  6.61337023e+03  6.61337023e+03
  8.34837494e+03  2.47317020e+04  7.55228644e+04]
E1 = -727.8383162466461  E_coul = 201.73457339997464
cycle= 2 E= -526.103742846671  delta_E= -0.000484  |g|= 0.0298  |ddm|= 0.0282
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0576023
diis-c [-0.00215601  0.05784836  0.94215164]
  HOMO = -0.575047391082557  LUMO = 0.934516419700298
  mo_energy =
[-1.18354833e+02 -1.22262214e+01 -9.54648012e+00 -9.54648012e+00
 -9.54648012e+00 -1.25010122e+00 -5.75047391e-01 -5.75047391e-01
 -5.75047391e-01  9.34516420e-01  9.34516420e-01  9.34516420e-01
  5.99736894e+00  5.99736894e+00  5.99736894e+00  2.65921627e+01
  2.65921627e+01  2.65921627e+01  2.85275574e+01  1.01273156e+02
  1.01273156e+02  1.01273156e+02  2.72401444e+02  4.31948530e+02
  4.31948530e+02  4.31948530e+02  1.28411985e+03  1.28411985e+03
  1.28411985e+03  1.99830640e+03  2.98527773e+03  2.98527773e+03
  2.98527773e+03  6.61342860e+03  6.61342860e+03  6.61342860e+03
  8.34843391e+03  2.47317613e+04  7.55229238e+04]
E1 = -727.7535616181818  E_coul = 201.64979553355917
cycle= 3 E= -526.103766084623  delta_E= -2.32e-05  |g|= 0.00418  |ddm|= 0.0072
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00876853
diis-c [-3.55963407e-07 -1.17982421e-03  1.26523059e-01  8.74656765e-01]
  HOMO = -0.575910830575246  LUMO = 0.933935548582114
  mo_energy =
[-1.18361655e+02 -1.22298809e+01 -9.55032728e+00 -9.55032728e+00
 -9.55032728e+00 -1.25119485e+00 -5.75910831e-01 -5.75910831e-01
 -5.75910831e-01  9.33935549e-01  9.33935549e-01  9.33935549e-01
  5.99535851e+00  5.99535851e+00  5.99535851e+00  2.65885598e+01
  2.65885598e+01  2.65885598e+01  2.85233495e+01  1.01267871e+02
  1.01267871e+02  1.01267871e+02  2.72394879e+02  4.31941791e+02
  4.31941791e+02  4.31941791e+02  1.28411261e+03  1.28411261e+03
  1.28411261e+03  1.99829868e+03  2.98527019e+03  2.98527019e+03
  2.98527019e+03  6.61342074e+03  6.61342074e+03  6.61342074e+03
  8.34842586e+03  2.47317531e+04  7.55229155e+04]
E1 = -727.765363644352  E_coul = 201.6615969782373
cycle= 4 E= -526.103766666115  delta_E= -5.81e-07  |g|= 3.92e-05  |ddm|= 0.00102
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.68317e-05
diis-c [-2.23089785e-09  3.06628707e-05 -4.25769610e-03 -3.18844209e-02
  1.03611145e+00]
  HOMO = -0.575890635916318  LUMO = 0.933948775345276
  mo_energy =
[-1.18361602e+02 -1.22298149e+01 -9.55026664e+00 -9.55026664e+00
 -9.55026664e+00 -1.25116798e+00 -5.75890636e-01 -5.75890636e-01
 -5.75890636e-01  9.33948775e-01  9.33948775e-01  9.33948775e-01
  5.99539979e+00  5.99539979e+00  5.99539979e+00  2.65886158e+01
  2.65886158e+01  2.65886158e+01  2.85234165e+01  1.01267930e+02
  1.01267930e+02  1.01267930e+02  2.72394933e+02  4.31941844e+02
  4.31941844e+02  4.31941844e+02  1.28411266e+03  1.28411266e+03
  1.28411266e+03  1.99829871e+03  2.98527023e+03  2.98527023e+03
  2.98527023e+03  6.61342077e+03  6.61342077e+03  6.61342077e+03
  8.34842589e+03  2.47317531e+04  7.55229155e+04]
E1 = -727.7652196900518  E_coul = 201.66145302387062
cycle= 5 E= -526.103766666181  delta_E= -6.65e-11  |g|= 8.81e-06  |ddm|= 1.85e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.7652196900518  E_coul = 201.66145302387062
  HOMO = -0.575895003260815  LUMO = 0.933945887943936
  mo_energy =
[-1.18361623e+02 -1.22298297e+01 -9.55028194e+00 -9.55028194e+00
 -9.55028194e+00 -1.25117353e+00 -5.75895003e-01 -5.75895003e-01
 -5.75895003e-01  9.33945888e-01  9.33945888e-01  9.33945888e-01
  5.99539049e+00  5.99539049e+00  5.99539049e+00  2.65886015e+01
  2.65886015e+01  2.65886015e+01  2.85234008e+01  1.01267912e+02
  1.01267912e+02  1.01267912e+02  2.72394913e+02  4.31941824e+02
  4.31941824e+02  4.31941824e+02  1.28411264e+03  1.28411264e+03
  1.28411264e+03  1.99829869e+03  2.98527021e+03  2.98527021e+03
  2.98527021e+03  6.61342075e+03  6.61342075e+03  6.61342075e+03
  8.34842586e+03  2.47317531e+04  7.55229155e+04]
E1 = -727.7652621823602  E_coul = 201.66149551617357
Extra cycle  E= -526.103766666187  delta_E= -5.46e-12  |g|= 2.44e-06  |ddm|= 4.22e-06
    CPU time for scf_cycle      0.63 sec, wall time      0.24 sec
exp = [2.61825085e+04 7.61824307e+03 3.61823500e+03 1.61801197e+03
 2.40089150e+02 5.98620619e+01 1.74940202e+01 4.25850248e+00
 3.94738025e-01 1.36279260e+03 6.65174266e+02 3.03286014e+02
 3.16115944e+02 4.92050277e+01 6.16527212e+00 1.65365995e+01
 7.21030889e-01 2.34939580e+00 2.12356354e-01]
E = -526.1037666661866
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:41:02 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5085231        1
[INPUT] 0    0    [1    /1   ]  7618.2430669         1
[INPUT] 0    0    [1    /1   ]  3618.23499971        1
[INPUT] 0    0    [1    /1   ]  1618.0119712         1
[INPUT] 0    0    [1    /1   ]  240.089150251        1
[INPUT] 0    0    [1    /1   ]  59.8620619151        1
[INPUT] 0    0    [1    /1   ]  17.4940201919        1
[INPUT] 0    0    [1    /1   ]  4.25850248332        1
[INPUT] 0    0    [1    /1   ]  0.394738025018       1
[INPUT] 1    0    [1    /1   ]  1362.79259543        1
[INPUT] 1    0    [1    /1   ]  665.174265625        1
[INPUT] 1    0    [1    /1   ]  303.286014139        1
[INPUT] 1    0    [1    /1   ]  316.115943647        1
[INPUT] 1    0    [1    /1   ]  49.2050276717        1
[INPUT] 1    0    [1    /1   ]  6.16527211849        1
[INPUT] 1    0    [1    /1   ]  16.5365995067        1
[INPUT] 1    0    [1    /1   ]  0.721030888919       1
[INPUT] 1    0    [1    /1   ]  2.34939579632        1
[INPUT] 1    0    [1    /1   ]  0.212356353671       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.508523094624, 1.0]], [0, [7618.243066896257, 1.0]], [0, [3618.2349997114834, 1.0]], [0, [1618.011971199099, 1.0]], [0, [240.08915025108467, 1.0]], [0, [59.86206191509268, 1.0]], [0, [17.49402019193466, 1.0]], [0, [4.2585024833246825, 1.0]], [0, [0.3947380250179764, 1.0]], [1, [1362.7925954303525, 1.0]], [1, [665.1742656248034, 1.0]], [1, [303.28601413850845, 1.0]], [1, [316.11594364740114, 1.0]], [1, [49.205027671652175, 1.0]], [1, [6.165272118493103, 1.0]], [1, [16.536599506747763, 1.0]], [1, [0.7210308889186003, 1.0]], [1, [2.349395796319319, 1.0]], [1, [0.21235635367145264, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50852309]
bas 1, expnt(s) = [7618.2430669]
bas 2, expnt(s) = [3618.23499971]
bas 3, expnt(s) = [1618.0119712]
bas 4, expnt(s) = [240.08915025]
bas 5, expnt(s) = [59.86206192]
bas 6, expnt(s) = [17.49402019]
bas 7, expnt(s) = [4.25850248]
bas 8, expnt(s) = [0.39473803]
bas 9, expnt(s) = [1362.79259543]
bas 10, expnt(s) = [665.17426562]
bas 11, expnt(s) = [303.28601414]
bas 12, expnt(s) = [316.11594365]
bas 13, expnt(s) = [49.20502767]
bas 14, expnt(s) = [6.16527212]
bas 15, expnt(s) = [16.53659951]
bas 16, expnt(s) = [0.72103089]
bas 17, expnt(s) = [2.3493958]
bas 18, expnt(s) = [0.21235635]
CPU time:       261.24
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825085e+04 5.20024092e+03 7.61824307e+03 2.06018463e+03
 3.61823500e+03 1.17865744e+03 1.61801197e+03 6.44542148e+02
 2.40089150e+02 1.54097086e+02 5.98620619e+01 5.43724344e+01
 1.74940202e+01 2.16113672e+01 4.25850248e+00 7.48958412e+00
 3.94738025e-01 1.25819150e+00 1.36279260e+03 2.41558097e+04
 6.65174266e+02 9.85493334e+03 3.03286014e+02 3.69232458e+03
 3.16115944e+02 3.88859213e+03 4.92050277e+01 3.80186107e+02
 6.16527212e+00 2.83416222e+01 1.65365995e+01 9.72841644e+01
 7.21030889e-01 1.93832559e+00 2.34939580e+00 8.48554277e+00
 2.12356354e-01 4.20548383e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98161620583017
cond(S) = 86899.13171790437
E1 = -728.3449827409668  E_coul = 203.07566083520888
init E= -525.269321905758
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559412332273432  LUMO = 0.942639914472864
  mo_energy =
[-1.18113917e+02 -1.21384913e+01 -9.45173049e+00 -9.45173049e+00
 -9.45173049e+00 -1.22843732e+00 -5.59412332e-01 -5.59412332e-01
 -5.59412332e-01  9.42639914e-01  9.42639914e-01  9.42639914e-01
  6.04242076e+00  6.04242076e+00  6.04242076e+00  2.66836165e+01
  2.66836165e+01  2.66836165e+01  2.86278215e+01  1.01424403e+02
  1.01424403e+02  1.01424403e+02  2.72628070e+02  4.32190345e+02
  4.32190345e+02  4.32190345e+02  1.28442299e+03  1.28442299e+03
  1.28442299e+03  1.99875604e+03  2.98565503e+03  2.98565503e+03
  2.98565503e+03  6.61394467e+03  6.61394467e+03  6.61394467e+03
  8.34904643e+03  2.47324809e+04  7.55237441e+04]
E1 = -727.452810527408  E_coul = 201.34955143375507
cycle= 1 E= -526.103259093653  delta_E= -0.834  |g|= 0.21  |ddm|= 0.796
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.557121
diis-c [-0.31038406  1.        ]
  HOMO = -0.580289975432963  LUMO = 0.930937204678893
  mo_energy =
[-1.18406952e+02 -1.22523047e+01 -9.57337540e+00 -9.57337540e+00
 -9.57337540e+00 -1.25690734e+00 -5.80289975e-01 -5.80289975e-01
 -5.80289975e-01  9.30937205e-01  9.30937205e-01  9.30937205e-01
  5.98432944e+00  5.98432944e+00  5.98432944e+00  2.65670588e+01
  2.65670588e+01  2.65670588e+01  2.84963001e+01  1.01233992e+02
  1.01233992e+02  1.01233992e+02  2.72351421e+02  4.31897094e+02
  4.31897094e+02  4.31897094e+02  1.28406463e+03  1.28406463e+03
  1.28406463e+03  1.99824866e+03  2.98522066e+03  2.98522066e+03
  2.98522066e+03  6.61337023e+03  6.61337023e+03  6.61337023e+03
  8.34837494e+03  2.47317020e+04  7.55228644e+04]
E1 = -727.8383162466461  E_coul = 201.73457339997464
cycle= 2 E= -526.103742846671  delta_E= -0.000484  |g|= 0.0298  |ddm|= 0.0282
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0576023
diis-c [-0.00215601  0.05784836  0.94215164]
  HOMO = -0.575047391082557  LUMO = 0.934516419700298
  mo_energy =
[-1.18354833e+02 -1.22262214e+01 -9.54648012e+00 -9.54648012e+00
 -9.54648012e+00 -1.25010122e+00 -5.75047391e-01 -5.75047391e-01
 -5.75047391e-01  9.34516420e-01  9.34516420e-01  9.34516420e-01
  5.99736894e+00  5.99736894e+00  5.99736894e+00  2.65921627e+01
  2.65921627e+01  2.65921627e+01  2.85275574e+01  1.01273156e+02
  1.01273156e+02  1.01273156e+02  2.72401444e+02  4.31948530e+02
  4.31948530e+02  4.31948530e+02  1.28411985e+03  1.28411985e+03
  1.28411985e+03  1.99830640e+03  2.98527773e+03  2.98527773e+03
  2.98527773e+03  6.61342860e+03  6.61342860e+03  6.61342860e+03
  8.34843391e+03  2.47317613e+04  7.55229238e+04]
E1 = -727.7535616181818  E_coul = 201.64979553355917
cycle= 3 E= -526.103766084623  delta_E= -2.32e-05  |g|= 0.00418  |ddm|= 0.0072
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00876853
diis-c [-3.55963407e-07 -1.17982421e-03  1.26523059e-01  8.74656765e-01]
  HOMO = -0.575910830575246  LUMO = 0.933935548582114
  mo_energy =
[-1.18361655e+02 -1.22298809e+01 -9.55032728e+00 -9.55032728e+00
 -9.55032728e+00 -1.25119485e+00 -5.75910831e-01 -5.75910831e-01
 -5.75910831e-01  9.33935549e-01  9.33935549e-01  9.33935549e-01
  5.99535851e+00  5.99535851e+00  5.99535851e+00  2.65885598e+01
  2.65885598e+01  2.65885598e+01  2.85233495e+01  1.01267871e+02
  1.01267871e+02  1.01267871e+02  2.72394879e+02  4.31941791e+02
  4.31941791e+02  4.31941791e+02  1.28411261e+03  1.28411261e+03
  1.28411261e+03  1.99829868e+03  2.98527019e+03  2.98527019e+03
  2.98527019e+03  6.61342074e+03  6.61342074e+03  6.61342074e+03
  8.34842586e+03  2.47317531e+04  7.55229155e+04]
E1 = -727.765363644352  E_coul = 201.6615969782373
cycle= 4 E= -526.103766666115  delta_E= -5.81e-07  |g|= 3.92e-05  |ddm|= 0.00102
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.68317e-05
diis-c [-2.23089785e-09  3.06628707e-05 -4.25769610e-03 -3.18844209e-02
  1.03611145e+00]
  HOMO = -0.575890635916318  LUMO = 0.933948775345276
  mo_energy =
[-1.18361602e+02 -1.22298149e+01 -9.55026664e+00 -9.55026664e+00
 -9.55026664e+00 -1.25116798e+00 -5.75890636e-01 -5.75890636e-01
 -5.75890636e-01  9.33948775e-01  9.33948775e-01  9.33948775e-01
  5.99539979e+00  5.99539979e+00  5.99539979e+00  2.65886158e+01
  2.65886158e+01  2.65886158e+01  2.85234165e+01  1.01267930e+02
  1.01267930e+02  1.01267930e+02  2.72394933e+02  4.31941844e+02
  4.31941844e+02  4.31941844e+02  1.28411266e+03  1.28411266e+03
  1.28411266e+03  1.99829871e+03  2.98527023e+03  2.98527023e+03
  2.98527023e+03  6.61342077e+03  6.61342077e+03  6.61342077e+03
  8.34842589e+03  2.47317531e+04  7.55229155e+04]
E1 = -727.7652196900518  E_coul = 201.66145302387062
cycle= 5 E= -526.103766666181  delta_E= -6.65e-11  |g|= 8.81e-06  |ddm|= 1.85e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.7652196900518  E_coul = 201.66145302387062
  HOMO = -0.575895003260815  LUMO = 0.933945887943936
  mo_energy =
[-1.18361623e+02 -1.22298297e+01 -9.55028194e+00 -9.55028194e+00
 -9.55028194e+00 -1.25117353e+00 -5.75895003e-01 -5.75895003e-01
 -5.75895003e-01  9.33945888e-01  9.33945888e-01  9.33945888e-01
  5.99539049e+00  5.99539049e+00  5.99539049e+00  2.65886015e+01
  2.65886015e+01  2.65886015e+01  2.85234008e+01  1.01267912e+02
  1.01267912e+02  1.01267912e+02  2.72394913e+02  4.31941824e+02
  4.31941824e+02  4.31941824e+02  1.28411264e+03  1.28411264e+03
  1.28411264e+03  1.99829869e+03  2.98527021e+03  2.98527021e+03
  2.98527021e+03  6.61342075e+03  6.61342075e+03  6.61342075e+03
  8.34842586e+03  2.47317531e+04  7.55229155e+04]
E1 = -727.7652621823602  E_coul = 201.66149551617357
Extra cycle  E= -526.103766666187  delta_E= -5.46e-12  |g|= 2.44e-06  |ddm|= 4.22e-06
    CPU time for scf_cycle      0.63 sec, wall time      0.25 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 86899.13171790437
E1 = -727.7652621823602  E_coul = 201.66149551617357
init E= -526.103766666187
    CPU time for initialize scf      2.75 sec, wall time      0.26 sec
  HOMO = -0.575894208082394  LUMO = 0.933946418735734
  mo_energy =
[-1.18361618e+02 -1.22298266e+01 -9.55027873e+00 -9.55027873e+00
 -9.55027873e+00 -1.25117251e+00 -5.75894208e-01 -5.75894208e-01
 -5.75894208e-01  9.33946419e-01  9.33946419e-01  9.33946419e-01
  5.99539228e+00  5.99539228e+00  5.99539228e+00  2.65886045e+01
  2.65886045e+01  2.65886045e+01  2.85234042e+01  1.01267916e+02
  1.01267916e+02  1.01267916e+02  2.72394918e+02  4.31941829e+02
  4.31941829e+02  4.31941829e+02  1.28411264e+03  1.28411264e+03
  1.28411264e+03  1.99829870e+03  2.98527021e+03  2.98527021e+03
  2.98527021e+03  6.61342076e+03  6.61342076e+03  6.61342076e+03
  8.34842587e+03  2.47317531e+04  7.55229155e+04]
E1 = -727.765252784863  E_coul = 201.66148611867695
cycle= 1 E= -526.103766666186  delta_E= 5.68e-13  |g|= 5.89e-07  |ddm|= 8.68e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.765252784863  E_coul = 201.66148611867695
  HOMO = -0.575894372854941  LUMO = 0.933946308194687
  mo_energy =
[-1.18361619e+02 -1.22298273e+01 -9.55027944e+00 -9.55027944e+00
 -9.55027944e+00 -1.25117272e+00 -5.75894373e-01 -5.75894373e-01
 -5.75894373e-01  9.33946308e-01  9.33946308e-01  9.33946308e-01
  5.99539190e+00  5.99539190e+00  5.99539190e+00  2.65886038e+01
  2.65886038e+01  2.65886038e+01  2.85234035e+01  1.01267915e+02
  1.01267915e+02  1.01267915e+02  2.72394917e+02  4.31941828e+02
  4.31941828e+02  4.31941828e+02  1.28411264e+03  1.28411264e+03
  1.28411264e+03  1.99829870e+03  2.98527021e+03  2.98527021e+03
  2.98527021e+03  6.61342075e+03  6.61342075e+03  6.61342075e+03
  8.34842587e+03  2.47317531e+04  7.55229155e+04]
E1 = -727.7652549047317  E_coul = 201.6614882385458
Extra cycle  E= -526.103766666186  delta_E= 1.14e-13  |g|= 1.38e-07  |ddm|= 1.9e-07
    CPU time for scf_cycle      2.88 sec, wall time      0.39 sec
exp = [2.61825085e+04 7.61824307e+03 3.61823500e+03 1.61801197e+03
 2.40089150e+02 5.98620619e+01 1.74940202e+01 4.25850248e+00
 3.94738025e-01 1.36279260e+03 6.65174266e+02 3.03286014e+02
 3.16115944e+02 4.92050277e+01 6.16527212e+00 1.65365995e+01
 7.21030889e-01 2.34939580e+00 2.12356354e-01]
grad_E = [-1.95873665e-06  2.59052983e-05  5.67430019e-05  8.22639946e-04
 -8.49424229e-03 -1.00249592e-03  8.14621765e-04 -3.41795957e-03
 -8.59456205e-03  2.28579888e-06  2.65966260e-05  1.48060372e-04
  1.30560899e-04 -4.09946947e-03  7.94467698e-04  4.43508000e-03
  6.92647677e-03 -5.58356190e-03 -3.42981576e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:41:06 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5085009        1
[INPUT] 0    0    [1    /1   ]  7618.24331273        1
[INPUT] 0    0    [1    /1   ]  3618.23549315        1
[INPUT] 0    0    [1    /1   ]  1618.01952594        1
[INPUT] 0    0    [1    /1   ]  240.097854585        1
[INPUT] 0    0    [1    /1   ]  59.5254422243        1
[INPUT] 0    0    [1    /1   ]  17.0105287305        1
[INPUT] 0    0    [1    /1   ]  4.25910079192        1
[INPUT] 0    0    [1    /1   ]  0.394599378181       1
[INPUT] 1    0    [1    /1   ]  1362.7926058         1
[INPUT] 1    0    [1    /1   ]  665.174456635        1
[INPUT] 1    0    [1    /1   ]  303.287022281        1
[INPUT] 1    0    [1    /1   ]  316.116831773        1
[INPUT] 1    0    [1    /1   ]  49.2214014596        1
[INPUT] 1    0    [1    /1   ]  6.10648311301        1
[INPUT] 1    0    [1    /1   ]  16.4380624802        1
[INPUT] 1    0    [1    /1   ]  0.71973345211        1
[INPUT] 1    0    [1    /1   ]  2.33745593791        1
[INPUT] 1    0    [1    /1   ]  0.212090508776       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.50850091094, 1.0]], [0, [7618.2433127257, 1.0]], [0, [3618.2354931464597, 1.0]], [0, [1618.0195259403695, 1.0]], [0, [240.09785458481034, 1.0]], [0, [59.525442224272275, 1.0]], [0, [17.010528730538013, 1.0]], [0, [4.25910079191918, 1.0]], [0, [0.3945993781812459, 1.0]], [1, [1362.7926058025387, 1.0]], [1, [665.1744566351701, 1.0]], [1, [303.2870222813708, 1.0]], [1, [316.11683177279826, 1.0]], [1, [49.22140145957869, 1.0]], [1, [6.106483113013492, 1.0]], [1, [16.438062480162642, 1.0]], [1, [0.7197334521104093, 1.0]], [1, [2.3374559379115136, 1.0]], [1, [0.21209050877613295, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50850091]
bas 1, expnt(s) = [7618.24331273]
bas 2, expnt(s) = [3618.23549315]
bas 3, expnt(s) = [1618.01952594]
bas 4, expnt(s) = [240.09785458]
bas 5, expnt(s) = [59.52544222]
bas 6, expnt(s) = [17.01052873]
bas 7, expnt(s) = [4.25910079]
bas 8, expnt(s) = [0.39459938]
bas 9, expnt(s) = [1362.7926058]
bas 10, expnt(s) = [665.17445664]
bas 11, expnt(s) = [303.28702228]
bas 12, expnt(s) = [316.11683177]
bas 13, expnt(s) = [49.22140146]
bas 14, expnt(s) = [6.10648311]
bas 15, expnt(s) = [16.43806248]
bas 16, expnt(s) = [0.71973345]
bas 17, expnt(s) = [2.33745594]
bas 18, expnt(s) = [0.21209051]
CPU time:       269.34
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825085e+04 5.20024092e+03 7.61824331e+03 2.06018468e+03
 3.61823549e+03 1.17865756e+03 1.61801953e+03 6.44544405e+02
 2.40097855e+02 1.54101276e+02 5.95254422e+01 5.41429603e+01
 1.70105287e+01 2.11618379e+01 4.25910079e+00 7.49037330e+00
 3.94599378e-01 1.25786004e+00 1.36279261e+03 2.41558099e+04
 6.65174457e+02 9.85493688e+03 3.03287022e+02 3.69233993e+03
 3.16116832e+02 3.88860579e+03 4.92214015e+01 3.80344256e+02
 6.10648311e+00 2.80042111e+01 1.64380625e+01 9.65600932e+01
 7.19733452e-01 1.93396675e+00 2.33745594e+00 8.43167161e+00
 2.12090509e-01 4.19890390e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.981682614385832
cond(S) = 86776.46801722344
E1 = -728.3710989930121  E_coul = 203.08041921752252
init E= -525.29067977549
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559401748078629  LUMO = 0.940615935552472
  mo_energy =
[-1.18111852e+02 -1.21394528e+01 -9.45130629e+00 -9.45130629e+00
 -9.45130629e+00 -1.22863705e+00 -5.59401748e-01 -5.59401748e-01
 -5.59401748e-01  9.40615936e-01  9.40615936e-01  9.40615936e-01
  6.00559155e+00  6.00559155e+00  6.00559155e+00  2.64429843e+01
  2.64429843e+01  2.64429843e+01  2.78265232e+01  1.00923521e+02
  1.00923521e+02  1.00923521e+02  2.69886547e+02  4.31717946e+02
  4.31717946e+02  4.31717946e+02  1.28401057e+03  1.28401057e+03
  1.28401057e+03  1.99587791e+03  2.98527697e+03  2.98527697e+03
  2.98527697e+03  6.61360280e+03  6.61360280e+03  6.61360280e+03
  8.34642706e+03  2.47300101e+04  7.55214487e+04]
E1 = -727.4736455602111  E_coul = 201.37003288077346
cycle= 1 E= -526.103612679438  delta_E= -0.813  |g|= 0.208  |ddm|= 0.79
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.55059
diis-c [-0.30314929  1.        ]
  HOMO = -0.580313734553486  LUMO = 0.928945958267611
  mo_energy =
[-1.18401388e+02 -1.22527016e+01 -9.57161813e+00 -9.57161813e+00
 -9.57161813e+00 -1.25720103e+00 -5.80313735e-01 -5.80313735e-01
 -5.80313735e-01  9.28945958e-01  9.28945958e-01  9.28945958e-01
  5.94810868e+00  5.94810868e+00  5.94810868e+00  2.63281438e+01
  2.63281438e+01  2.63281438e+01  2.76974813e+01  1.00735472e+02
  1.00735472e+02  1.00735472e+02  2.69613618e+02  4.31428019e+02
  4.31428019e+02  4.31428019e+02  1.28365596e+03  1.28365596e+03
  1.28365596e+03  1.99537462e+03  2.98484651e+03  2.98484651e+03
  2.98484651e+03  6.61303280e+03  6.61303280e+03  6.61303280e+03
  8.34576030e+03  2.47292363e+04  7.55205744e+04]
E1 = -727.8542336850892  E_coul = 201.75015414505535
cycle= 2 E= -526.104079540034  delta_E= -0.000467  |g|= 0.0294  |ddm|= 0.0279
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0568286
diis-c [-0.00211772  0.05728992  0.94271008]
  HOMO = -0.575121793993708  LUMO = 0.932479887963065
  mo_energy =
[-1.18349978e+02 -1.22269460e+01 -9.54503830e+00 -9.54503830e+00
 -9.54503830e+00 -1.25046360e+00 -5.75121794e-01 -5.75121794e-01
 -5.75121794e-01  9.32479888e-01  9.32479888e-01  9.32479888e-01
  5.96094711e+00  5.96094711e+00  5.96094711e+00  2.63528663e+01
  2.63528663e+01  2.63528663e+01  2.77280051e+01  1.00774118e+02
  1.00774118e+02  1.00774118e+02  2.69662932e+02  4.31478760e+02
  4.31478760e+02  4.31478760e+02  1.28371043e+03  1.28371043e+03
  1.28371043e+03  1.99543160e+03  2.98490282e+03  2.98490282e+03
  2.98490282e+03  6.61309041e+03  6.61309041e+03  6.61309041e+03
  8.34581851e+03  2.47292949e+04  7.55206330e+04]
E1 = -727.7702961910045  E_coul = 201.66619397524488
cycle= 3 E= -526.10410221576  delta_E= -2.27e-05  |g|= 0.00417  |ddm|= 0.00713
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00870432
diis-c [-3.11319311e-07 -1.15457147e-03  1.27430242e-01  8.73724329e-01]
  HOMO = -0.575979574266222  LUMO = 0.931904253136447
  mo_energy =
[-1.18356764e+02 -1.22305885e+01 -9.54886409e+00 -9.54886409e+00
 -9.54886409e+00 -1.25155031e+00 -5.75979574e-01 -5.75979574e-01
 -5.75979574e-01  9.31904253e-01  9.31904253e-01  9.31904253e-01
  5.95895833e+00  5.95895833e+00  5.95895833e+00  2.63492955e+01
  2.63492955e+01  2.63492955e+01  2.77238536e+01  1.00768861e+02
  1.00768861e+02  1.00768861e+02  2.69656406e+02  4.31472056e+02
  4.31472056e+02  4.31472056e+02  1.28370323e+03  1.28370323e+03
  1.28370323e+03  1.99542393e+03  2.98489532e+03  2.98489532e+03
  2.98489532e+03  6.61308260e+03  6.61308260e+03  6.61308260e+03
  8.34581052e+03  2.47292867e+04  7.55206248e+04]
E1 = -727.7820605737012  E_coul = 201.6779577809411
cycle= 4 E= -526.10410279276  delta_E= -5.77e-07  |g|= 3.78e-05  |ddm|= 0.00102
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.23747e-05
diis-c [-2.07448740e-09  2.71715897e-05 -3.89213832e-03 -2.86146372e-02
  1.03247960e+00]
  HOMO = -0.575959742589014  LUMO = 0.931917210800613
  mo_energy =
[-1.18356710e+02 -1.22305234e+01 -9.54880401e+00 -9.54880401e+00
 -9.54880401e+00 -1.25152394e+00 -5.75959743e-01 -5.75959743e-01
 -5.75959743e-01  9.31917211e-01  9.31917211e-01  9.31917211e-01
  5.95899887e+00  5.95899887e+00  5.95899887e+00  2.63493509e+01
  2.63493509e+01  2.63493509e+01  2.77239196e+01  1.00768920e+02
  1.00768920e+02  1.00768920e+02  2.69656461e+02  4.31472110e+02
  4.31472110e+02  4.31472110e+02  1.28370328e+03  1.28370328e+03
  1.28370328e+03  1.99542396e+03  2.98489536e+03  2.98489536e+03
  2.98489536e+03  6.61308263e+03  6.61308263e+03  6.61308263e+03
  8.34581055e+03  2.47292868e+04  7.55206248e+04]
E1 = -727.7819162826606  E_coul = 201.67781348983442
cycle= 5 E= -526.104102792826  delta_E= -6.62e-11  |g|= 8.49e-06  |ddm|= 1.84e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.7819162826606  E_coul = 201.67781348983442
  HOMO = -0.575963919547481  LUMO = 0.931914455771437
  mo_energy =
[-1.18356730e+02 -1.22305376e+01 -9.54881866e+00 -9.54881866e+00
 -9.54881866e+00 -1.25152924e+00 -5.75963920e-01 -5.75963920e-01
 -5.75963920e-01  9.31914456e-01  9.31914456e-01  9.31914456e-01
  5.95899002e+00  5.95899002e+00  5.95899002e+00  2.63493373e+01
  2.63493373e+01  2.63493373e+01  2.77239047e+01  1.00768903e+02
  1.00768903e+02  1.00768903e+02  2.69656441e+02  4.31472090e+02
  4.31472090e+02  4.31472090e+02  1.28370326e+03  1.28370326e+03
  1.28370326e+03  1.99542394e+03  2.98489534e+03  2.98489534e+03
  2.98489534e+03  6.61308261e+03  6.61308261e+03  6.61308261e+03
  8.34581052e+03  2.47292867e+04  7.55206248e+04]
E1 = -727.7819571416713  E_coul = 201.67785434884152
Extra cycle  E= -526.10410279283  delta_E= -3.64e-12  |g|= 2.35e-06  |ddm|= 4.03e-06
    CPU time for scf_cycle      0.63 sec, wall time      0.25 sec
exp = [2.61825085e+04 7.61824331e+03 3.61823549e+03 1.61801953e+03
 2.40097855e+02 5.95254422e+01 1.70105287e+01 4.25910079e+00
 3.94599378e-01 1.36279261e+03 6.65174457e+02 3.03287022e+02
 3.16116832e+02 4.92214015e+01 6.10648311e+00 1.64380625e+01
 7.19733452e-01 2.33745594e+00 2.12090509e-01]
E = -526.1041027928298
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:41:07 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5085009        1
[INPUT] 0    0    [1    /1   ]  7618.24331273        1
[INPUT] 0    0    [1    /1   ]  3618.23549315        1
[INPUT] 0    0    [1    /1   ]  1618.01952594        1
[INPUT] 0    0    [1    /1   ]  240.097854585        1
[INPUT] 0    0    [1    /1   ]  59.5254422243        1
[INPUT] 0    0    [1    /1   ]  17.0105287305        1
[INPUT] 0    0    [1    /1   ]  4.25910079192        1
[INPUT] 0    0    [1    /1   ]  0.394599378181       1
[INPUT] 1    0    [1    /1   ]  1362.7926058         1
[INPUT] 1    0    [1    /1   ]  665.174456635        1
[INPUT] 1    0    [1    /1   ]  303.287022281        1
[INPUT] 1    0    [1    /1   ]  316.116831773        1
[INPUT] 1    0    [1    /1   ]  49.2214014596        1
[INPUT] 1    0    [1    /1   ]  6.10648311301        1
[INPUT] 1    0    [1    /1   ]  16.4380624802        1
[INPUT] 1    0    [1    /1   ]  0.71973345211        1
[INPUT] 1    0    [1    /1   ]  2.33745593791        1
[INPUT] 1    0    [1    /1   ]  0.212090508776       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.50850091094, 1.0]], [0, [7618.2433127257, 1.0]], [0, [3618.2354931464597, 1.0]], [0, [1618.0195259403695, 1.0]], [0, [240.09785458481034, 1.0]], [0, [59.525442224272275, 1.0]], [0, [17.010528730538013, 1.0]], [0, [4.25910079191918, 1.0]], [0, [0.3945993781812459, 1.0]], [1, [1362.7926058025387, 1.0]], [1, [665.1744566351701, 1.0]], [1, [303.2870222813708, 1.0]], [1, [316.11683177279826, 1.0]], [1, [49.22140145957869, 1.0]], [1, [6.106483113013492, 1.0]], [1, [16.438062480162642, 1.0]], [1, [0.7197334521104093, 1.0]], [1, [2.3374559379115136, 1.0]], [1, [0.21209050877613295, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50850091]
bas 1, expnt(s) = [7618.24331273]
bas 2, expnt(s) = [3618.23549315]
bas 3, expnt(s) = [1618.01952594]
bas 4, expnt(s) = [240.09785458]
bas 5, expnt(s) = [59.52544222]
bas 6, expnt(s) = [17.01052873]
bas 7, expnt(s) = [4.25910079]
bas 8, expnt(s) = [0.39459938]
bas 9, expnt(s) = [1362.7926058]
bas 10, expnt(s) = [665.17445664]
bas 11, expnt(s) = [303.28702228]
bas 12, expnt(s) = [316.11683177]
bas 13, expnt(s) = [49.22140146]
bas 14, expnt(s) = [6.10648311]
bas 15, expnt(s) = [16.43806248]
bas 16, expnt(s) = [0.71973345]
bas 17, expnt(s) = [2.33745594]
bas 18, expnt(s) = [0.21209051]
CPU time:       270.09
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825085e+04 5.20024092e+03 7.61824331e+03 2.06018468e+03
 3.61823549e+03 1.17865756e+03 1.61801953e+03 6.44544405e+02
 2.40097855e+02 1.54101276e+02 5.95254422e+01 5.41429603e+01
 1.70105287e+01 2.11618379e+01 4.25910079e+00 7.49037330e+00
 3.94599378e-01 1.25786004e+00 1.36279261e+03 2.41558099e+04
 6.65174457e+02 9.85493688e+03 3.03287022e+02 3.69233993e+03
 3.16116832e+02 3.88860579e+03 4.92214015e+01 3.80344256e+02
 6.10648311e+00 2.80042111e+01 1.64380625e+01 9.65600932e+01
 7.19733452e-01 1.93396675e+00 2.33745594e+00 8.43167161e+00
 2.12090509e-01 4.19890390e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.981682614385832
cond(S) = 86776.46801722344
E1 = -728.3710989930121  E_coul = 203.08041921752252
init E= -525.29067977549
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559401748078629  LUMO = 0.940615935552472
  mo_energy =
[-1.18111852e+02 -1.21394528e+01 -9.45130629e+00 -9.45130629e+00
 -9.45130629e+00 -1.22863705e+00 -5.59401748e-01 -5.59401748e-01
 -5.59401748e-01  9.40615936e-01  9.40615936e-01  9.40615936e-01
  6.00559155e+00  6.00559155e+00  6.00559155e+00  2.64429843e+01
  2.64429843e+01  2.64429843e+01  2.78265232e+01  1.00923521e+02
  1.00923521e+02  1.00923521e+02  2.69886547e+02  4.31717946e+02
  4.31717946e+02  4.31717946e+02  1.28401057e+03  1.28401057e+03
  1.28401057e+03  1.99587791e+03  2.98527697e+03  2.98527697e+03
  2.98527697e+03  6.61360280e+03  6.61360280e+03  6.61360280e+03
  8.34642706e+03  2.47300101e+04  7.55214487e+04]
E1 = -727.4736455602111  E_coul = 201.37003288077346
cycle= 1 E= -526.103612679438  delta_E= -0.813  |g|= 0.208  |ddm|= 0.79
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.55059
diis-c [-0.30314929  1.        ]
  HOMO = -0.580313734553486  LUMO = 0.928945958267611
  mo_energy =
[-1.18401388e+02 -1.22527016e+01 -9.57161813e+00 -9.57161813e+00
 -9.57161813e+00 -1.25720103e+00 -5.80313735e-01 -5.80313735e-01
 -5.80313735e-01  9.28945958e-01  9.28945958e-01  9.28945958e-01
  5.94810868e+00  5.94810868e+00  5.94810868e+00  2.63281438e+01
  2.63281438e+01  2.63281438e+01  2.76974813e+01  1.00735472e+02
  1.00735472e+02  1.00735472e+02  2.69613618e+02  4.31428019e+02
  4.31428019e+02  4.31428019e+02  1.28365596e+03  1.28365596e+03
  1.28365596e+03  1.99537462e+03  2.98484651e+03  2.98484651e+03
  2.98484651e+03  6.61303280e+03  6.61303280e+03  6.61303280e+03
  8.34576030e+03  2.47292363e+04  7.55205744e+04]
E1 = -727.8542336850892  E_coul = 201.75015414505535
cycle= 2 E= -526.104079540034  delta_E= -0.000467  |g|= 0.0294  |ddm|= 0.0279
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0568286
diis-c [-0.00211772  0.05728992  0.94271008]
  HOMO = -0.575121793993708  LUMO = 0.932479887963065
  mo_energy =
[-1.18349978e+02 -1.22269460e+01 -9.54503830e+00 -9.54503830e+00
 -9.54503830e+00 -1.25046360e+00 -5.75121794e-01 -5.75121794e-01
 -5.75121794e-01  9.32479888e-01  9.32479888e-01  9.32479888e-01
  5.96094711e+00  5.96094711e+00  5.96094711e+00  2.63528663e+01
  2.63528663e+01  2.63528663e+01  2.77280051e+01  1.00774118e+02
  1.00774118e+02  1.00774118e+02  2.69662932e+02  4.31478760e+02
  4.31478760e+02  4.31478760e+02  1.28371043e+03  1.28371043e+03
  1.28371043e+03  1.99543160e+03  2.98490282e+03  2.98490282e+03
  2.98490282e+03  6.61309041e+03  6.61309041e+03  6.61309041e+03
  8.34581851e+03  2.47292949e+04  7.55206330e+04]
E1 = -727.7702961910045  E_coul = 201.66619397524488
cycle= 3 E= -526.10410221576  delta_E= -2.27e-05  |g|= 0.00417  |ddm|= 0.00713
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00870432
diis-c [-3.11319311e-07 -1.15457147e-03  1.27430242e-01  8.73724329e-01]
  HOMO = -0.575979574266222  LUMO = 0.931904253136447
  mo_energy =
[-1.18356764e+02 -1.22305885e+01 -9.54886409e+00 -9.54886409e+00
 -9.54886409e+00 -1.25155031e+00 -5.75979574e-01 -5.75979574e-01
 -5.75979574e-01  9.31904253e-01  9.31904253e-01  9.31904253e-01
  5.95895833e+00  5.95895833e+00  5.95895833e+00  2.63492955e+01
  2.63492955e+01  2.63492955e+01  2.77238536e+01  1.00768861e+02
  1.00768861e+02  1.00768861e+02  2.69656406e+02  4.31472056e+02
  4.31472056e+02  4.31472056e+02  1.28370323e+03  1.28370323e+03
  1.28370323e+03  1.99542393e+03  2.98489532e+03  2.98489532e+03
  2.98489532e+03  6.61308260e+03  6.61308260e+03  6.61308260e+03
  8.34581052e+03  2.47292867e+04  7.55206248e+04]
E1 = -727.7820605737012  E_coul = 201.6779577809411
cycle= 4 E= -526.10410279276  delta_E= -5.77e-07  |g|= 3.78e-05  |ddm|= 0.00102
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.23747e-05
diis-c [-2.07448740e-09  2.71715897e-05 -3.89213832e-03 -2.86146372e-02
  1.03247960e+00]
  HOMO = -0.575959742589014  LUMO = 0.931917210800613
  mo_energy =
[-1.18356710e+02 -1.22305234e+01 -9.54880401e+00 -9.54880401e+00
 -9.54880401e+00 -1.25152394e+00 -5.75959743e-01 -5.75959743e-01
 -5.75959743e-01  9.31917211e-01  9.31917211e-01  9.31917211e-01
  5.95899887e+00  5.95899887e+00  5.95899887e+00  2.63493509e+01
  2.63493509e+01  2.63493509e+01  2.77239196e+01  1.00768920e+02
  1.00768920e+02  1.00768920e+02  2.69656461e+02  4.31472110e+02
  4.31472110e+02  4.31472110e+02  1.28370328e+03  1.28370328e+03
  1.28370328e+03  1.99542396e+03  2.98489536e+03  2.98489536e+03
  2.98489536e+03  6.61308263e+03  6.61308263e+03  6.61308263e+03
  8.34581055e+03  2.47292868e+04  7.55206248e+04]
E1 = -727.7819162826606  E_coul = 201.67781348983442
cycle= 5 E= -526.104102792826  delta_E= -6.62e-11  |g|= 8.49e-06  |ddm|= 1.84e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.7819162826606  E_coul = 201.67781348983442
  HOMO = -0.575963919547481  LUMO = 0.931914455771437
  mo_energy =
[-1.18356730e+02 -1.22305376e+01 -9.54881866e+00 -9.54881866e+00
 -9.54881866e+00 -1.25152924e+00 -5.75963920e-01 -5.75963920e-01
 -5.75963920e-01  9.31914456e-01  9.31914456e-01  9.31914456e-01
  5.95899002e+00  5.95899002e+00  5.95899002e+00  2.63493373e+01
  2.63493373e+01  2.63493373e+01  2.77239047e+01  1.00768903e+02
  1.00768903e+02  1.00768903e+02  2.69656441e+02  4.31472090e+02
  4.31472090e+02  4.31472090e+02  1.28370326e+03  1.28370326e+03
  1.28370326e+03  1.99542394e+03  2.98489534e+03  2.98489534e+03
  2.98489534e+03  6.61308261e+03  6.61308261e+03  6.61308261e+03
  8.34581052e+03  2.47292867e+04  7.55206248e+04]
E1 = -727.7819571416713  E_coul = 201.67785434884152
Extra cycle  E= -526.10410279283  delta_E= -3.64e-12  |g|= 2.35e-06  |ddm|= 4.03e-06
    CPU time for scf_cycle      0.63 sec, wall time      0.25 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 86776.46801722344
E1 = -727.7819571416713  E_coul = 201.67785434884152
init E= -526.10410279283
    CPU time for initialize scf      2.71 sec, wall time      0.25 sec
  HOMO = -0.5759631565739  LUMO = 0.931914963786317
  mo_energy =
[-1.18356725e+02 -1.22305346e+01 -9.54881557e+00 -9.54881557e+00
 -9.54881557e+00 -1.25152826e+00 -5.75963157e-01 -5.75963157e-01
 -5.75963157e-01  9.31914964e-01  9.31914964e-01  9.31914964e-01
  5.95899172e+00  5.95899172e+00  5.95899172e+00  2.63493401e+01
  2.63493401e+01  2.63493401e+01  2.77239080e+01  1.00768907e+02
  1.00768907e+02  1.00768907e+02  2.69656446e+02  4.31472095e+02
  4.31472095e+02  4.31472095e+02  1.28370326e+03  1.28370326e+03
  1.28370326e+03  1.99542395e+03  2.98489535e+03  2.98489535e+03
  2.98489535e+03  6.61308262e+03  6.61308262e+03  6.61308262e+03
  8.34581053e+03  2.47292867e+04  7.55206248e+04]
E1 = -727.7819480780456  E_coul = 201.67784528521506
cycle= 1 E= -526.104102792831  delta_E= -6.82e-13  |g|= 5.69e-07  |ddm|= 8.36e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.7819480780456  E_coul = 201.67784528521506
  HOMO = -0.575963315367475  LUMO = 0.931914857527622
  mo_energy =
[-1.18356726e+02 -1.22305353e+01 -9.54881625e+00 -9.54881625e+00
 -9.54881625e+00 -1.25152847e+00 -5.75963315e-01 -5.75963315e-01
 -5.75963315e-01  9.31914858e-01  9.31914858e-01  9.31914858e-01
  5.95899136e+00  5.95899136e+00  5.95899136e+00  2.63493395e+01
  2.63493395e+01  2.63493395e+01  2.77239073e+01  1.00768906e+02
  1.00768906e+02  1.00768906e+02  2.69656445e+02  4.31472094e+02
  4.31472094e+02  4.31472094e+02  1.28370326e+03  1.28370326e+03
  1.28370326e+03  1.99542395e+03  2.98489535e+03  2.98489535e+03
  2.98489535e+03  6.61308262e+03  6.61308262e+03  6.61308262e+03
  8.34581053e+03  2.47292867e+04  7.55206248e+04]
E1 = -727.7819501283738  E_coul = 201.677847335543
Extra cycle  E= -526.104102792831  delta_E= -2.27e-13  |g|= 1.33e-07  |ddm|= 1.83e-07
    CPU time for scf_cycle      2.85 sec, wall time      0.38 sec
exp = [2.61825085e+04 7.61824331e+03 3.61823549e+03 1.61801953e+03
 2.40097855e+02 5.95254422e+01 1.70105287e+01 4.25910079e+00
 3.94599378e-01 1.36279261e+03 6.65174457e+02 3.03287022e+02
 3.16116832e+02 4.92214015e+01 6.10648311e+00 1.64380625e+01
 7.19733452e-01 2.33745594e+00 2.12090509e-01]
grad_E = [-1.96020751e-06  2.57460283e-05  5.62168188e-05  8.16789294e-04
 -8.20969976e-03 -1.78016289e-03  3.38551451e-04  6.46644530e-03
 -1.14879843e-02  2.22837954e-06  2.62081209e-05  1.45733028e-04
  1.28497431e-04 -3.96756299e-03 -7.60712923e-04  4.42527665e-03
  9.28777547e-03 -3.66223885e-03 -6.66458618e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:41:11 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5084987        1
[INPUT] 0    0    [1    /1   ]  7618.24332982        1
[INPUT] 0    0    [1    /1   ]  3618.23551913        1
[INPUT] 0    0    [1    /1   ]  1618.02000461        1
[INPUT] 0    0    [1    /1   ]  240.115021189        1
[INPUT] 0    0    [1    /1   ]  59.4431606509        1
[INPUT] 0    0    [1    /1   ]  16.8781944977        1
[INPUT] 0    0    [1    /1   ]  4.25114254019        1
[INPUT] 0    0    [1    /1   ]  0.395411642956       1
[INPUT] 1    0    [1    /1   ]  1362.79260487        1
[INPUT] 1    0    [1    /1   ]  665.174461597        1
[INPUT] 1    0    [1    /1   ]  303.287037437        1
[INPUT] 1    0    [1    /1   ]  316.116844954        1
[INPUT] 1    0    [1    /1   ]  49.230983409         1
[INPUT] 1    0    [1    /1   ]  6.09088471748        1
[INPUT] 1    0    [1    /1   ]  16.4117002183        1
[INPUT] 1    0    [1    /1   ]  0.713169236506       1
[INPUT] 1    0    [1    /1   ]  2.32708376633        1
[INPUT] 1    0    [1    /1   ]  0.21035468013        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.508498702588, 1.0]], [0, [7618.243329817668, 1.0]], [0, [3618.23551913495, 1.0]], [0, [1618.0200046091504, 1.0]], [0, [240.11502118896934, 1.0]], [0, [59.443160650885616, 1.0]], [0, [16.878194497652302, 1.0]], [0, [4.251142540194996, 1.0]], [0, [0.3954116429561461, 1.0]], [1, [1362.7926048680952, 1.0]], [1, [665.1744615969884, 1.0]], [1, [303.28703743662965, 1.0]], [1, [316.1168449543783, 1.0]], [1, [49.23098340901284, 1.0]], [1, [6.090884717480131, 1.0]], [1, [16.41170021833995, 1.0]], [1, [0.7131692365063476, 1.0]], [1, [2.3270837663316275, 1.0]], [1, [0.21035468013033481, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.5084987]
bas 1, expnt(s) = [7618.24332982]
bas 2, expnt(s) = [3618.23551913]
bas 3, expnt(s) = [1618.02000461]
bas 4, expnt(s) = [240.11502119]
bas 5, expnt(s) = [59.44316065]
bas 6, expnt(s) = [16.8781945]
bas 7, expnt(s) = [4.25114254]
bas 8, expnt(s) = [0.39541164]
bas 9, expnt(s) = [1362.79260487]
bas 10, expnt(s) = [665.1744616]
bas 11, expnt(s) = [303.28703744]
bas 12, expnt(s) = [316.11684495]
bas 13, expnt(s) = [49.23098341]
bas 14, expnt(s) = [6.09088472]
bas 15, expnt(s) = [16.41170022]
bas 16, expnt(s) = [0.71316924]
bas 17, expnt(s) = [2.32708377]
bas 18, expnt(s) = [0.21035468]
CPU time:       278.14
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825085e+04 5.20024092e+03 7.61824333e+03 2.06018468e+03
 3.61823552e+03 1.17865757e+03 1.61802000e+03 6.44544548e+02
 2.40115021e+02 1.54109539e+02 5.94431607e+01 5.40868195e+01
 1.68781945e+01 2.10382453e+01 4.25114254e+00 7.47987387e+00
 3.95411643e-01 1.25980148e+00 1.36279260e+03 2.41558099e+04
 6.65174462e+02 9.85493697e+03 3.03287037e+02 3.69234016e+03
 3.16116845e+02 3.88860599e+03 4.92309834e+01 3.80436810e+02
 6.09088472e+00 2.79148223e+01 1.64117002e+01 9.63665612e+01
 7.13169237e-01 1.91194389e+00 2.32708377e+00 8.38492946e+00
 2.10354680e-01 4.15599117e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.981830894714893
cond(S) = 86734.43396590007
E1 = -728.3822427862932  E_coul = 203.0882564521174
init E= -525.293986334176
    CPU time for initialize scf      0.45 sec, wall time      0.05 sec
  HOMO = -0.55914214777442  LUMO = 0.929071518604862
  mo_energy =
[-1.18110844e+02 -1.21394039e+01 -9.45075564e+00 -9.45075564e+00
 -9.45075564e+00 -1.22832873e+00 -5.59142148e-01 -5.59142148e-01
 -5.59142148e-01  9.29071519e-01  9.29071519e-01  9.29071519e-01
  5.95538287e+00  5.95538287e+00  5.95538287e+00  2.63255902e+01
  2.63255902e+01  2.63255902e+01  2.75823381e+01  1.00748971e+02
  1.00748971e+02  1.00748971e+02  2.69139396e+02  4.31574489e+02
  4.31574489e+02  4.31574489e+02  1.28388952e+03  1.28388952e+03
  1.28388952e+03  1.99514693e+03  2.98516656e+03  2.98516656e+03
  2.98516656e+03  6.61350289e+03  6.61350289e+03  6.61350289e+03
  8.34577276e+03  2.47293939e+04  7.55208762e+04]
E1 = -727.4681596909459  E_coul = 201.3643353099837
cycle= 1 E= -526.103824380962  delta_E= -0.81  |g|= 0.208  |ddm|= 0.771
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.550581
diis-c [-0.30313922  1.        ]
  HOMO = -0.580384313737473  LUMO = 0.917366859798323
  mo_energy =
[-1.18401646e+02 -1.22535747e+01 -9.57210099e+00 -9.57210099e+00
 -9.57210099e+00 -1.25736758e+00 -5.80384314e-01 -5.80384314e-01
 -5.80384314e-01  9.17366860e-01  9.17366860e-01  9.17366860e-01
  5.89743068e+00  5.89743068e+00  5.89743068e+00  2.62098619e+01
  2.62098619e+01  2.62098619e+01  2.74526399e+01  1.00559751e+02
  1.00559751e+02  1.00559751e+02  2.68865269e+02  4.31283277e+02
  4.31283277e+02  4.31283277e+02  1.28353361e+03  1.28353361e+03
  1.28353361e+03  1.99464239e+03  2.98473482e+03  2.98473482e+03
  2.98473482e+03  6.61293169e+03  6.61293169e+03  6.61293169e+03
  8.34510484e+03  2.47286190e+04  7.55200008e+04]
E1 = -727.8522897645474  E_coul = 201.7479933001915
cycle= 2 E= -526.104296464356  delta_E= -0.000472  |g|= 0.0295  |ddm|= 0.0283
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0571117
diis-c [-0.00213167  0.05773484  0.94226516]
  HOMO = -0.575123257809332  LUMO = 0.920904862196501
  mo_energy =
[-1.18349894e+02 -1.22275906e+01 -9.54528386e+00 -9.54528386e+00
 -9.54528386e+00 -1.25053777e+00 -5.75123258e-01 -5.75123258e-01
 -5.75123258e-01  9.20904862e-01  9.20904862e-01  9.20904862e-01
  5.91036762e+00  5.91036762e+00  5.91036762e+00  2.62347859e+01
  2.62347859e+01  2.62347859e+01  2.74833202e+01  1.00598688e+02
  1.00598688e+02  1.00598688e+02  2.68914908e+02  4.31334360e+02
  4.31334360e+02  4.31334360e+02  1.28358843e+03  1.28358843e+03
  1.28358843e+03  1.99469973e+03  2.98479149e+03  2.98479149e+03
  2.98479149e+03  6.61298966e+03  6.61298966e+03  6.61298966e+03
  8.34516341e+03  2.47286779e+04  7.55200598e+04]
E1 = -727.7674943759163  E_coul = 201.6631748391265
cycle= 3 E= -526.10431953679  delta_E= -2.31e-05  |g|= 0.00419  |ddm|= 0.00721
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00875196
diis-c [-3.14236079e-07 -1.15808531e-03  1.27482536e-01  8.73675549e-01]
  HOMO = -0.57598873361517  LUMO = 0.920330815570806
  mo_energy =
[-1.18356722e+02 -1.22312588e+01 -9.54913733e+00 -9.54913733e+00
 -9.54913733e+00 -1.25163482e+00 -5.75988734e-01 -5.75988734e-01
 -5.75988734e-01  9.20330816e-01  9.20330816e-01  9.20330816e-01
  5.90836903e+00  5.90836903e+00  5.90836903e+00  2.62311916e+01
  2.62311916e+01  2.62311916e+01  2.74791514e+01  1.00593397e+02
  1.00593397e+02  1.00593397e+02  2.68908342e+02  4.31327614e+02
  4.31327614e+02  4.31327614e+02  1.28358119e+03  1.28358119e+03
  1.28358119e+03  1.99469202e+03  2.98478395e+03  2.98478395e+03
  2.98478395e+03  6.61298181e+03  6.61298181e+03  6.61298181e+03
  8.34515537e+03  2.47286697e+04  7.55200516e+04]
E1 = -727.7793632604845  E_coul = 201.6750431375938
cycle= 4 E= -526.104320122891  delta_E= -5.86e-07  |g|= 3.78e-05  |ddm|= 0.00103
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.33134e-05
diis-c [-2.07717129e-09  2.80503200e-05 -3.99401219e-03 -2.95107737e-02
  1.03347674e+00]
  HOMO = -0.575969072210105  LUMO = 0.920343518386652
  mo_energy =
[-1.18356669e+02 -1.22311945e+01 -9.54907808e+00 -9.54907808e+00
 -9.54907808e+00 -1.25160863e+00 -5.75969072e-01 -5.75969072e-01
 -5.75969072e-01  9.20343518e-01  9.20343518e-01  9.20343518e-01
  5.90840905e+00  5.90840905e+00  5.90840905e+00  2.62312463e+01
  2.62312463e+01  2.62312463e+01  2.74792166e+01  1.00593455e+02
  1.00593455e+02  1.00593455e+02  2.68908396e+02  4.31327667e+02
  4.31327667e+02  4.31327667e+02  1.28358124e+03  1.28358124e+03
  1.28358124e+03  1.99469205e+03  2.98478399e+03  2.98478399e+03
  2.98478399e+03  6.61298184e+03  6.61298184e+03  6.61298184e+03
  8.34515540e+03  2.47286698e+04  7.55200516e+04]
E1 = -727.7792210506198  E_coul = 201.6749009276653
cycle= 5 E= -526.104320122955  delta_E= -6.38e-11  |g|= 8.51e-06  |ddm|= 1.82e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.7792210506198  E_coul = 201.6749009276653
  HOMO = -0.575973273000743  LUMO = 0.920340778605981
  mo_energy =
[-1.18356689e+02 -1.22312087e+01 -9.54909280e+00 -9.54909280e+00
 -9.54909280e+00 -1.25161397e+00 -5.75973273e-01 -5.75973273e-01
 -5.75973273e-01  9.20340779e-01  9.20340779e-01  9.20340779e-01
  5.90840017e+00  5.90840017e+00  5.90840017e+00  2.62312326e+01
  2.62312326e+01  2.62312326e+01  2.74792016e+01  1.00593437e+02
  1.00593437e+02  1.00593437e+02  2.68908376e+02  4.31327647e+02
  4.31327647e+02  4.31327647e+02  1.28358122e+03  1.28358122e+03
  1.28358122e+03  1.99469203e+03  2.98478397e+03  2.98478397e+03
  2.98478397e+03  6.61298182e+03  6.61298182e+03  6.61298182e+03
  8.34515538e+03  2.47286697e+04  7.55200516e+04]
E1 = -727.7792621596402  E_coul = 201.6749420366819
Extra cycle  E= -526.104320122958  delta_E= -3.87e-12  |g|= 2.37e-06  |ddm|= 4.05e-06
    CPU time for scf_cycle      0.63 sec, wall time      0.23 sec
exp = [2.61825085e+04 7.61824333e+03 3.61823552e+03 1.61802000e+03
 2.40115021e+02 5.94431607e+01 1.68781945e+01 4.25114254e+00
 3.95411643e-01 1.36279260e+03 6.65174462e+02 3.03287037e+02
 3.16116845e+02 4.92309834e+01 6.09088472e+00 1.64117002e+01
 7.13169237e-01 2.32708377e+00 2.10354680e-01]
E = -526.1043201229584
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:41:11 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5084987        1
[INPUT] 0    0    [1    /1   ]  7618.24332982        1
[INPUT] 0    0    [1    /1   ]  3618.23551913        1
[INPUT] 0    0    [1    /1   ]  1618.02000461        1
[INPUT] 0    0    [1    /1   ]  240.115021189        1
[INPUT] 0    0    [1    /1   ]  59.4431606509        1
[INPUT] 0    0    [1    /1   ]  16.8781944977        1
[INPUT] 0    0    [1    /1   ]  4.25114254019        1
[INPUT] 0    0    [1    /1   ]  0.395411642956       1
[INPUT] 1    0    [1    /1   ]  1362.79260487        1
[INPUT] 1    0    [1    /1   ]  665.174461597        1
[INPUT] 1    0    [1    /1   ]  303.287037437        1
[INPUT] 1    0    [1    /1   ]  316.116844954        1
[INPUT] 1    0    [1    /1   ]  49.230983409         1
[INPUT] 1    0    [1    /1   ]  6.09088471748        1
[INPUT] 1    0    [1    /1   ]  16.4117002183        1
[INPUT] 1    0    [1    /1   ]  0.713169236506       1
[INPUT] 1    0    [1    /1   ]  2.32708376633        1
[INPUT] 1    0    [1    /1   ]  0.21035468013        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.508498702588, 1.0]], [0, [7618.243329817668, 1.0]], [0, [3618.23551913495, 1.0]], [0, [1618.0200046091504, 1.0]], [0, [240.11502118896934, 1.0]], [0, [59.443160650885616, 1.0]], [0, [16.878194497652302, 1.0]], [0, [4.251142540194996, 1.0]], [0, [0.3954116429561461, 1.0]], [1, [1362.7926048680952, 1.0]], [1, [665.1744615969884, 1.0]], [1, [303.28703743662965, 1.0]], [1, [316.1168449543783, 1.0]], [1, [49.23098340901284, 1.0]], [1, [6.090884717480131, 1.0]], [1, [16.41170021833995, 1.0]], [1, [0.7131692365063476, 1.0]], [1, [2.3270837663316275, 1.0]], [1, [0.21035468013033481, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.5084987]
bas 1, expnt(s) = [7618.24332982]
bas 2, expnt(s) = [3618.23551913]
bas 3, expnt(s) = [1618.02000461]
bas 4, expnt(s) = [240.11502119]
bas 5, expnt(s) = [59.44316065]
bas 6, expnt(s) = [16.8781945]
bas 7, expnt(s) = [4.25114254]
bas 8, expnt(s) = [0.39541164]
bas 9, expnt(s) = [1362.79260487]
bas 10, expnt(s) = [665.1744616]
bas 11, expnt(s) = [303.28703744]
bas 12, expnt(s) = [316.11684495]
bas 13, expnt(s) = [49.23098341]
bas 14, expnt(s) = [6.09088472]
bas 15, expnt(s) = [16.41170022]
bas 16, expnt(s) = [0.71316924]
bas 17, expnt(s) = [2.32708377]
bas 18, expnt(s) = [0.21035468]
CPU time:       278.87
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825085e+04 5.20024092e+03 7.61824333e+03 2.06018468e+03
 3.61823552e+03 1.17865757e+03 1.61802000e+03 6.44544548e+02
 2.40115021e+02 1.54109539e+02 5.94431607e+01 5.40868195e+01
 1.68781945e+01 2.10382453e+01 4.25114254e+00 7.47987387e+00
 3.95411643e-01 1.25980148e+00 1.36279260e+03 2.41558099e+04
 6.65174462e+02 9.85493697e+03 3.03287037e+02 3.69234016e+03
 3.16116845e+02 3.88860599e+03 4.92309834e+01 3.80436810e+02
 6.09088472e+00 2.79148223e+01 1.64117002e+01 9.63665612e+01
 7.13169237e-01 1.91194389e+00 2.32708377e+00 8.38492946e+00
 2.10354680e-01 4.15599117e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.981830894714893
cond(S) = 86734.43396590007
E1 = -728.3822427862932  E_coul = 203.0882564521174
init E= -525.293986334176
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.55914214777442  LUMO = 0.929071518604862
  mo_energy =
[-1.18110844e+02 -1.21394039e+01 -9.45075564e+00 -9.45075564e+00
 -9.45075564e+00 -1.22832873e+00 -5.59142148e-01 -5.59142148e-01
 -5.59142148e-01  9.29071519e-01  9.29071519e-01  9.29071519e-01
  5.95538287e+00  5.95538287e+00  5.95538287e+00  2.63255902e+01
  2.63255902e+01  2.63255902e+01  2.75823381e+01  1.00748971e+02
  1.00748971e+02  1.00748971e+02  2.69139396e+02  4.31574489e+02
  4.31574489e+02  4.31574489e+02  1.28388952e+03  1.28388952e+03
  1.28388952e+03  1.99514693e+03  2.98516656e+03  2.98516656e+03
  2.98516656e+03  6.61350289e+03  6.61350289e+03  6.61350289e+03
  8.34577276e+03  2.47293939e+04  7.55208762e+04]
E1 = -727.4681596909459  E_coul = 201.3643353099837
cycle= 1 E= -526.103824380962  delta_E= -0.81  |g|= 0.208  |ddm|= 0.771
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.550581
diis-c [-0.30313922  1.        ]
  HOMO = -0.580384313737473  LUMO = 0.917366859798323
  mo_energy =
[-1.18401646e+02 -1.22535747e+01 -9.57210099e+00 -9.57210099e+00
 -9.57210099e+00 -1.25736758e+00 -5.80384314e-01 -5.80384314e-01
 -5.80384314e-01  9.17366860e-01  9.17366860e-01  9.17366860e-01
  5.89743068e+00  5.89743068e+00  5.89743068e+00  2.62098619e+01
  2.62098619e+01  2.62098619e+01  2.74526399e+01  1.00559751e+02
  1.00559751e+02  1.00559751e+02  2.68865269e+02  4.31283277e+02
  4.31283277e+02  4.31283277e+02  1.28353361e+03  1.28353361e+03
  1.28353361e+03  1.99464239e+03  2.98473482e+03  2.98473482e+03
  2.98473482e+03  6.61293169e+03  6.61293169e+03  6.61293169e+03
  8.34510484e+03  2.47286190e+04  7.55200008e+04]
E1 = -727.8522897645474  E_coul = 201.7479933001915
cycle= 2 E= -526.104296464356  delta_E= -0.000472  |g|= 0.0295  |ddm|= 0.0283
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0571117
diis-c [-0.00213167  0.05773484  0.94226516]
  HOMO = -0.575123257809332  LUMO = 0.920904862196501
  mo_energy =
[-1.18349894e+02 -1.22275906e+01 -9.54528386e+00 -9.54528386e+00
 -9.54528386e+00 -1.25053777e+00 -5.75123258e-01 -5.75123258e-01
 -5.75123258e-01  9.20904862e-01  9.20904862e-01  9.20904862e-01
  5.91036762e+00  5.91036762e+00  5.91036762e+00  2.62347859e+01
  2.62347859e+01  2.62347859e+01  2.74833202e+01  1.00598688e+02
  1.00598688e+02  1.00598688e+02  2.68914908e+02  4.31334360e+02
  4.31334360e+02  4.31334360e+02  1.28358843e+03  1.28358843e+03
  1.28358843e+03  1.99469973e+03  2.98479149e+03  2.98479149e+03
  2.98479149e+03  6.61298966e+03  6.61298966e+03  6.61298966e+03
  8.34516341e+03  2.47286779e+04  7.55200598e+04]
E1 = -727.7674943759163  E_coul = 201.6631748391265
cycle= 3 E= -526.10431953679  delta_E= -2.31e-05  |g|= 0.00419  |ddm|= 0.00721
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00875196
diis-c [-3.14236079e-07 -1.15808531e-03  1.27482536e-01  8.73675549e-01]
  HOMO = -0.57598873361517  LUMO = 0.920330815570806
  mo_energy =
[-1.18356722e+02 -1.22312588e+01 -9.54913733e+00 -9.54913733e+00
 -9.54913733e+00 -1.25163482e+00 -5.75988734e-01 -5.75988734e-01
 -5.75988734e-01  9.20330816e-01  9.20330816e-01  9.20330816e-01
  5.90836903e+00  5.90836903e+00  5.90836903e+00  2.62311916e+01
  2.62311916e+01  2.62311916e+01  2.74791514e+01  1.00593397e+02
  1.00593397e+02  1.00593397e+02  2.68908342e+02  4.31327614e+02
  4.31327614e+02  4.31327614e+02  1.28358119e+03  1.28358119e+03
  1.28358119e+03  1.99469202e+03  2.98478395e+03  2.98478395e+03
  2.98478395e+03  6.61298181e+03  6.61298181e+03  6.61298181e+03
  8.34515537e+03  2.47286697e+04  7.55200516e+04]
E1 = -727.7793632604845  E_coul = 201.6750431375938
cycle= 4 E= -526.104320122891  delta_E= -5.86e-07  |g|= 3.78e-05  |ddm|= 0.00103
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.33134e-05
diis-c [-2.07717129e-09  2.80503200e-05 -3.99401219e-03 -2.95107737e-02
  1.03347674e+00]
  HOMO = -0.575969072210105  LUMO = 0.920343518386652
  mo_energy =
[-1.18356669e+02 -1.22311945e+01 -9.54907808e+00 -9.54907808e+00
 -9.54907808e+00 -1.25160863e+00 -5.75969072e-01 -5.75969072e-01
 -5.75969072e-01  9.20343518e-01  9.20343518e-01  9.20343518e-01
  5.90840905e+00  5.90840905e+00  5.90840905e+00  2.62312463e+01
  2.62312463e+01  2.62312463e+01  2.74792166e+01  1.00593455e+02
  1.00593455e+02  1.00593455e+02  2.68908396e+02  4.31327667e+02
  4.31327667e+02  4.31327667e+02  1.28358124e+03  1.28358124e+03
  1.28358124e+03  1.99469205e+03  2.98478399e+03  2.98478399e+03
  2.98478399e+03  6.61298184e+03  6.61298184e+03  6.61298184e+03
  8.34515540e+03  2.47286698e+04  7.55200516e+04]
E1 = -727.7792210506198  E_coul = 201.6749009276653
cycle= 5 E= -526.104320122955  delta_E= -6.38e-11  |g|= 8.51e-06  |ddm|= 1.82e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.7792210506198  E_coul = 201.6749009276653
  HOMO = -0.575973273000743  LUMO = 0.920340778605981
  mo_energy =
[-1.18356689e+02 -1.22312087e+01 -9.54909280e+00 -9.54909280e+00
 -9.54909280e+00 -1.25161397e+00 -5.75973273e-01 -5.75973273e-01
 -5.75973273e-01  9.20340779e-01  9.20340779e-01  9.20340779e-01
  5.90840017e+00  5.90840017e+00  5.90840017e+00  2.62312326e+01
  2.62312326e+01  2.62312326e+01  2.74792016e+01  1.00593437e+02
  1.00593437e+02  1.00593437e+02  2.68908376e+02  4.31327647e+02
  4.31327647e+02  4.31327647e+02  1.28358122e+03  1.28358122e+03
  1.28358122e+03  1.99469203e+03  2.98478397e+03  2.98478397e+03
  2.98478397e+03  6.61298182e+03  6.61298182e+03  6.61298182e+03
  8.34515538e+03  2.47286697e+04  7.55200516e+04]
E1 = -727.7792621596402  E_coul = 201.6749420366819
Extra cycle  E= -526.104320122958  delta_E= -3.87e-12  |g|= 2.37e-06  |ddm|= 4.05e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 86734.43396590007
E1 = -727.7792621596402  E_coul = 201.6749420366819
init E= -526.104320122958
    CPU time for initialize scf      2.71 sec, wall time      0.24 sec
  HOMO = -0.57597250419451  LUMO = 0.920341284653518
  mo_energy =
[-1.18356684e+02 -1.22312057e+01 -9.54908969e+00 -9.54908969e+00
 -9.54908969e+00 -1.25161298e+00 -5.75972504e-01 -5.75972504e-01
 -5.75972504e-01  9.20341285e-01  9.20341285e-01  9.20341285e-01
  5.90840188e+00  5.90840188e+00  5.90840188e+00  2.62312355e+01
  2.62312355e+01  2.62312355e+01  2.74792049e+01  1.00593441e+02
  1.00593441e+02  1.00593441e+02  2.68908381e+02  4.31327652e+02
  4.31327652e+02  4.31327652e+02  1.28358122e+03  1.28358122e+03
  1.28358122e+03  1.99469203e+03  2.98478397e+03  2.98478397e+03
  2.98478397e+03  6.61298182e+03  6.61298182e+03  6.61298182e+03
  8.34515538e+03  2.47286697e+04  7.55200516e+04]
E1 = -727.7792530236045  E_coul = 201.6749329006459
cycle= 1 E= -526.104320122959  delta_E= -2.27e-13  |g|= 5.73e-07  |ddm|= 8.42e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.7792530236045  E_coul = 201.6749329006459
  HOMO = -0.575972664493224  LUMO = 0.920341178621456
  mo_energy =
[-1.18356685e+02 -1.22312064e+01 -9.54909038e+00 -9.54909038e+00
 -9.54909038e+00 -1.25161319e+00 -5.75972664e-01 -5.75972664e-01
 -5.75972664e-01  9.20341179e-01  9.20341179e-01  9.20341179e-01
  5.90840152e+00  5.90840152e+00  5.90840152e+00  2.62312348e+01
  2.62312348e+01  2.62312348e+01  2.74792042e+01  1.00593441e+02
  1.00593441e+02  1.00593441e+02  2.68908380e+02  4.31327651e+02
  4.31327651e+02  4.31327651e+02  1.28358122e+03  1.28358122e+03
  1.28358122e+03  1.99469203e+03  2.98478397e+03  2.98478397e+03
  2.98478397e+03  6.61298182e+03  6.61298182e+03  6.61298182e+03
  8.34515538e+03  2.47286697e+04  7.55200516e+04]
E1 = -727.7792550941192  E_coul = 201.67493497116172
Extra cycle  E= -526.104320122957  delta_E= 1.14e-12  |g|= 1.34e-07  |ddm|= 1.85e-07
    CPU time for scf_cycle      2.83 sec, wall time      0.37 sec
exp = [2.61825085e+04 7.61824333e+03 3.61823552e+03 1.61802000e+03
 2.40115021e+02 5.94431607e+01 1.68781945e+01 4.25114254e+00
 3.95411643e-01 1.36279260e+03 6.65174462e+02 3.03287037e+02
 3.16116845e+02 4.92309834e+01 6.09088472e+00 1.64117002e+01
 7.13169237e-01 2.32708377e+00 2.10354680e-01]
grad_E = [-1.96054315e-06  2.57028629e-05  5.60751020e-05  8.15224085e-04
 -8.14356252e-03 -1.85990854e-03  2.71883571e-04  4.41502846e-03
 -5.57485298e-04  2.20198671e-06  2.60292223e-05  1.44653831e-04
  1.27541482e-04 -3.88508801e-03 -8.98074699e-07  4.10507028e-03
  4.03140916e-03 -3.83325742e-03 -5.43297917e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:41:15 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5085112        1
[INPUT] 0    0    [1    /1   ]  7618.24314333        1
[INPUT] 0    0    [1    /1   ]  3618.23509074        1
[INPUT] 0    0    [1    /1   ]  1618.01397088        1
[INPUT] 0    0    [1    /1   ]  240.215967833        1
[INPUT] 0    0    [1    /1   ]  59.3110133063        1
[INPUT] 0    0    [1    /1   ]  16.6149943221        1
[INPUT] 0    0    [1    /1   ]  4.2347129369         1
[INPUT] 0    0    [1    /1   ]  0.397007455673       1
[INPUT] 1    0    [1    /1   ]  1362.79258589        1
[INPUT] 1    0    [1    /1   ]  665.174260198        1
[INPUT] 1    0    [1    /1   ]  303.285900831        1
[INPUT] 1    0    [1    /1   ]  316.115842512        1
[INPUT] 1    0    [1    /1   ]  49.2747433108        1
[INPUT] 1    0    [1    /1   ]  6.04516944559        1
[INPUT] 1    0    [1    /1   ]  16.3569495302        1
[INPUT] 1    0    [1    /1   ]  0.691906556566       1
[INPUT] 1    0    [1    /1   ]  2.30765535663        1
[INPUT] 1    0    [1    /1   ]  0.204853920285       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.50851120507, 1.0]], [0, [7618.243143330262, 1.0]], [0, [3618.2350907380646, 1.0]], [0, [1618.0139708803165, 1.0]], [0, [240.2159678328287, 1.0]], [0, [59.31101330626739, 1.0]], [0, [16.61499432208141, 1.0]], [0, [4.234712936896583, 1.0]], [0, [0.39700745567289075, 1.0]], [1, [1362.79258588881, 1.0]], [1, [665.1742601984913, 1.0]], [1, [303.2859008306534, 1.0]], [1, [316.1158425116792, 1.0]], [1, [49.2747433107806, 1.0]], [1, [6.045169445590734, 1.0]], [1, [16.356949530204194, 1.0]], [1, [0.6919065565660152, 1.0]], [1, [2.3076553566278792, 1.0]], [1, [0.2048539202854324, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50851121]
bas 1, expnt(s) = [7618.24314333]
bas 2, expnt(s) = [3618.23509074]
bas 3, expnt(s) = [1618.01397088]
bas 4, expnt(s) = [240.21596783]
bas 5, expnt(s) = [59.31101331]
bas 6, expnt(s) = [16.61499432]
bas 7, expnt(s) = [4.23471294]
bas 8, expnt(s) = [0.39700746]
bas 9, expnt(s) = [1362.79258589]
bas 10, expnt(s) = [665.1742602]
bas 11, expnt(s) = [303.28590083]
bas 12, expnt(s) = [316.11584251]
bas 13, expnt(s) = [49.27474331]
bas 14, expnt(s) = [6.04516945]
bas 15, expnt(s) = [16.35694953]
bas 16, expnt(s) = [0.69190656]
bas 17, expnt(s) = [2.30765536]
bas 18, expnt(s) = [0.20485392]
CPU time:       286.92
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825085e+04 5.20024092e+03 7.61824314e+03 2.06018465e+03
 3.61823509e+03 1.17865746e+03 1.61801397e+03 6.44542746e+02
 2.40215968e+02 1.54158128e+02 5.93110133e+01 5.39966146e+01
 1.66149943e+01 2.07917082e+01 4.23471294e+00 7.45818250e+00
 3.97007456e-01 1.26361281e+00 1.36279259e+03 2.41558095e+04
 6.65174260e+02 9.85493324e+03 3.03285901e+02 3.69232286e+03
 3.16115843e+02 3.88859058e+03 4.92747433e+01 3.80859555e+02
 6.04516945e+00 2.76531743e+01 1.63569495e+01 9.59648712e+01
 6.91906557e-01 1.84095724e+00 2.30765536e+00 8.29751561e+00
 2.04853920e-01 4.02058957e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982296073259935
cond(S) = 86650.68977901601
E1 = -728.4012084152076  E_coul = 203.10219076074594
init E= -525.299017654462
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558662264968622  LUMO = 0.892425173753209
  mo_energy =
[-1.18109241e+02 -1.21393969e+01 -9.44979112e+00 -9.44979112e+00
 -9.44979112e+00 -1.22775700e+00 -5.58662265e-01 -5.58662265e-01
 -5.58662265e-01  8.92425174e-01  8.92425174e-01  8.92425174e-01
  5.81526199e+00  5.81526199e+00  5.81526199e+00  2.60247283e+01
  2.60247283e+01  2.60247283e+01  2.71006882e+01  1.00343676e+02
  1.00343676e+02  1.00343676e+02  2.67771487e+02  4.31295318e+02
  4.31295318e+02  4.31295318e+02  1.28367022e+03  1.28367022e+03
  1.28367022e+03  1.99400505e+03  2.98496915e+03  2.98496915e+03
  2.98496915e+03  6.61332396e+03  6.61332396e+03  6.61332396e+03
  8.34479999e+03  2.47284821e+04  7.55200286e+04]
E1 = -727.4452909145381  E_coul = 201.34064926343447
cycle= 1 E= -526.104641651104  delta_E= -0.806  |g|= 0.208  |ddm|= 0.748
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.551129
diis-c [-0.30374332  1.        ]
  HOMO = -0.580760096830551  LUMO = 0.880768239394162
  mo_energy =
[-1.18403624e+02 -1.22562257e+01 -9.57405507e+00 -9.57405507e+00
 -9.57405507e+00 -1.25801028e+00 -5.80760097e-01 -5.80760097e-01
 -5.80760097e-01  8.80768239e-01  8.80768239e-01  8.80768239e-01
  5.75602674e+00  5.75602674e+00  5.75602674e+00  2.59064627e+01
  2.59064627e+01  2.59064627e+01  2.69688065e+01  1.00151113e+02
  1.00151113e+02  1.00151113e+02  2.67493882e+02  4.31000484e+02
  4.31000484e+02  4.31000484e+02  1.28331069e+03  1.28331069e+03
  1.28331069e+03  1.99349706e+03  2.98453388e+03  2.98453388e+03
  2.98453388e+03  6.61274943e+03  6.61274943e+03  6.61274943e+03
  8.34412886e+03  2.47277042e+04  7.55191502e+04]
E1 = -727.8394837759724  E_coul = 201.73435485260632
cycle= 2 E= -526.105128923366  delta_E= -0.000487  |g|= 0.03  |ddm|= 0.0293
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0579296
diis-c [-0.0021733   0.05892996  0.94107004]
  HOMO = -0.575294597296899  LUMO = 0.884303646828002
  mo_energy =
[-1.18350909e+02 -1.22295930e+01 -9.54656847e+00 -9.54656847e+00
 -9.54656847e+00 -1.25091349e+00 -5.75294597e-01 -5.75294597e-01
 -5.75294597e-01  8.84303647e-01  8.84303647e-01  8.84303647e-01
  5.76926453e+00  5.76926453e+00  5.76926453e+00  2.59319677e+01
  2.59319677e+01  2.59319677e+01  2.70000046e+01  1.00190877e+02
  1.00190877e+02  1.00190877e+02  2.67544445e+02  4.31052528e+02
  4.31052528e+02  4.31052528e+02  1.28336651e+03  1.28336651e+03
  1.28336651e+03  1.99355542e+03  2.98459157e+03  2.98459157e+03
  2.98459157e+03  6.61280844e+03  6.61280844e+03  6.61280844e+03
  8.34418847e+03  2.47277641e+04  7.55192103e+04]
E1 = -727.7523973673624  E_coul = 201.64724428426533
cycle= 3 E= -526.105153083097  delta_E= -2.42e-05  |g|= 0.00426  |ddm|= 0.0074
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00887856
diis-c [-3.21279734e-07 -1.16749339e-03  1.27487458e-01  8.73680035e-01]
  HOMO = -0.576179480343106  LUMO = 0.883738707101427
  mo_energy =
[-1.18357843e+02 -1.22333272e+01 -9.55049277e+00 -9.55049277e+00
 -9.55049277e+00 -1.25203639e+00 -5.76179480e-01 -5.76179480e-01
 -5.76179480e-01  8.83738707e-01  8.83738707e-01  8.83738707e-01
  5.76724109e+00  5.76724109e+00  5.76724109e+00  2.59283132e+01
  2.59283132e+01  2.59283132e+01  2.69957858e+01  1.00185496e+02
  1.00185496e+02  1.00185496e+02  2.67537778e+02  4.31045677e+02
  4.31045677e+02  4.31045677e+02  1.28335915e+03  1.28335915e+03
  1.28335915e+03  1.99354759e+03  2.98458391e+03  2.98458391e+03
  2.98458391e+03  6.61280046e+03  6.61280046e+03  6.61280046e+03
  8.34418031e+03  2.47277558e+04  7.55192018e+04]
E1 = -727.7645259390202  E_coul = 201.65937224711683
cycle= 4 E= -526.105153691903  delta_E= -6.09e-07  |g|= 3.75e-05  |ddm|= 0.00105
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.6439e-05
diis-c [-2.06702208e-09  3.13410787e-05 -4.35561131e-03 -3.26342984e-02
  1.03695857e+00]
  HOMO = -0.576160354476597  LUMO = 0.883750633408184
  mo_energy =
[-1.18357795e+02 -1.22332654e+01 -9.55043640e+00 -9.55043640e+00
 -9.55043640e+00 -1.25201086e+00 -5.76160354e-01 -5.76160354e-01
 -5.76160354e-01  8.83750633e-01  8.83750633e-01  8.83750633e-01
  5.76727946e+00  5.76727946e+00  5.76727946e+00  2.59283652e+01
  2.59283652e+01  2.59283652e+01  2.69958481e+01  1.00185550e+02
  1.00185550e+02  1.00185550e+02  2.67537827e+02  4.31045725e+02
  4.31045725e+02  4.31045725e+02  1.28335920e+03  1.28335920e+03
  1.28335920e+03  1.99354762e+03  2.98458394e+03  2.98458394e+03
  2.98458394e+03  6.61280049e+03  6.61280049e+03  6.61280049e+03
  8.34418033e+03  2.47277558e+04  7.55192019e+04]
E1 = -727.7643917629634  E_coul = 201.65923807100174
cycle= 5 E= -526.105153691962  delta_E= -5.83e-11  |g|= 8.52e-06  |ddm|= 1.73e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.7643917629634  E_coul = 201.65923807100174
  HOMO = -0.576164592429354  LUMO = 0.883747969494669
  mo_energy =
[-1.18357814e+02 -1.22332797e+01 -9.55045119e+00 -9.55045119e+00
 -9.55045119e+00 -1.25201626e+00 -5.76164592e-01 -5.76164592e-01
 -5.76164592e-01  8.83747969e-01  8.83747969e-01  8.83747969e-01
  5.76727058e+00  5.76727058e+00  5.76727058e+00  2.59283514e+01
  2.59283514e+01  2.59283514e+01  2.69958331e+01  1.00185533e+02
  1.00185533e+02  1.00185533e+02  2.67537808e+02  4.31045706e+02
  4.31045706e+02  4.31045706e+02  1.28335917e+03  1.28335917e+03
  1.28335917e+03  1.99354760e+03  2.98458392e+03  2.98458392e+03
  2.98458392e+03  6.61280047e+03  6.61280047e+03  6.61280047e+03
  8.34418031e+03  2.47277558e+04  7.55192018e+04]
E1 = -727.7644332250137  E_coul = 201.65927953304856
Extra cycle  E= -526.105153691965  delta_E= -3.41e-12  |g|= 2.38e-06  |ddm|= 4.09e-06
    CPU time for scf_cycle      0.63 sec, wall time      0.24 sec
exp = [2.61825085e+04 7.61824314e+03 3.61823509e+03 1.61801397e+03
 2.40215968e+02 5.93110133e+01 1.66149943e+01 4.23471294e+00
 3.97007456e-01 1.36279259e+03 6.65174260e+02 3.03285901e+02
 3.16115843e+02 4.92747433e+01 6.04516945e+00 1.63569495e+01
 6.91906557e-01 2.30765536e+00 2.04853920e-01]
E = -526.1051536919651
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:41:16 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5085112        1
[INPUT] 0    0    [1    /1   ]  7618.24314333        1
[INPUT] 0    0    [1    /1   ]  3618.23509074        1
[INPUT] 0    0    [1    /1   ]  1618.01397088        1
[INPUT] 0    0    [1    /1   ]  240.215967833        1
[INPUT] 0    0    [1    /1   ]  59.3110133063        1
[INPUT] 0    0    [1    /1   ]  16.6149943221        1
[INPUT] 0    0    [1    /1   ]  4.2347129369         1
[INPUT] 0    0    [1    /1   ]  0.397007455673       1
[INPUT] 1    0    [1    /1   ]  1362.79258589        1
[INPUT] 1    0    [1    /1   ]  665.174260198        1
[INPUT] 1    0    [1    /1   ]  303.285900831        1
[INPUT] 1    0    [1    /1   ]  316.115842512        1
[INPUT] 1    0    [1    /1   ]  49.2747433108        1
[INPUT] 1    0    [1    /1   ]  6.04516944559        1
[INPUT] 1    0    [1    /1   ]  16.3569495302        1
[INPUT] 1    0    [1    /1   ]  0.691906556566       1
[INPUT] 1    0    [1    /1   ]  2.30765535663        1
[INPUT] 1    0    [1    /1   ]  0.204853920285       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.50851120507, 1.0]], [0, [7618.243143330262, 1.0]], [0, [3618.2350907380646, 1.0]], [0, [1618.0139708803165, 1.0]], [0, [240.2159678328287, 1.0]], [0, [59.31101330626739, 1.0]], [0, [16.61499432208141, 1.0]], [0, [4.234712936896583, 1.0]], [0, [0.39700745567289075, 1.0]], [1, [1362.79258588881, 1.0]], [1, [665.1742601984913, 1.0]], [1, [303.2859008306534, 1.0]], [1, [316.1158425116792, 1.0]], [1, [49.2747433107806, 1.0]], [1, [6.045169445590734, 1.0]], [1, [16.356949530204194, 1.0]], [1, [0.6919065565660152, 1.0]], [1, [2.3076553566278792, 1.0]], [1, [0.2048539202854324, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50851121]
bas 1, expnt(s) = [7618.24314333]
bas 2, expnt(s) = [3618.23509074]
bas 3, expnt(s) = [1618.01397088]
bas 4, expnt(s) = [240.21596783]
bas 5, expnt(s) = [59.31101331]
bas 6, expnt(s) = [16.61499432]
bas 7, expnt(s) = [4.23471294]
bas 8, expnt(s) = [0.39700746]
bas 9, expnt(s) = [1362.79258589]
bas 10, expnt(s) = [665.1742602]
bas 11, expnt(s) = [303.28590083]
bas 12, expnt(s) = [316.11584251]
bas 13, expnt(s) = [49.27474331]
bas 14, expnt(s) = [6.04516945]
bas 15, expnt(s) = [16.35694953]
bas 16, expnt(s) = [0.69190656]
bas 17, expnt(s) = [2.30765536]
bas 18, expnt(s) = [0.20485392]
CPU time:       287.67
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825085e+04 5.20024092e+03 7.61824314e+03 2.06018465e+03
 3.61823509e+03 1.17865746e+03 1.61801397e+03 6.44542746e+02
 2.40215968e+02 1.54158128e+02 5.93110133e+01 5.39966146e+01
 1.66149943e+01 2.07917082e+01 4.23471294e+00 7.45818250e+00
 3.97007456e-01 1.26361281e+00 1.36279259e+03 2.41558095e+04
 6.65174260e+02 9.85493324e+03 3.03285901e+02 3.69232286e+03
 3.16115843e+02 3.88859058e+03 4.92747433e+01 3.80859555e+02
 6.04516945e+00 2.76531743e+01 1.63569495e+01 9.59648712e+01
 6.91906557e-01 1.84095724e+00 2.30765536e+00 8.29751561e+00
 2.04853920e-01 4.02058957e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982296073259935
cond(S) = 86650.68977901601
E1 = -728.4012084152076  E_coul = 203.10219076074594
init E= -525.299017654462
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558662264968622  LUMO = 0.892425173753209
  mo_energy =
[-1.18109241e+02 -1.21393969e+01 -9.44979112e+00 -9.44979112e+00
 -9.44979112e+00 -1.22775700e+00 -5.58662265e-01 -5.58662265e-01
 -5.58662265e-01  8.92425174e-01  8.92425174e-01  8.92425174e-01
  5.81526199e+00  5.81526199e+00  5.81526199e+00  2.60247283e+01
  2.60247283e+01  2.60247283e+01  2.71006882e+01  1.00343676e+02
  1.00343676e+02  1.00343676e+02  2.67771487e+02  4.31295318e+02
  4.31295318e+02  4.31295318e+02  1.28367022e+03  1.28367022e+03
  1.28367022e+03  1.99400505e+03  2.98496915e+03  2.98496915e+03
  2.98496915e+03  6.61332396e+03  6.61332396e+03  6.61332396e+03
  8.34479999e+03  2.47284821e+04  7.55200286e+04]
E1 = -727.4452909145381  E_coul = 201.34064926343447
cycle= 1 E= -526.104641651104  delta_E= -0.806  |g|= 0.208  |ddm|= 0.748
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.551129
diis-c [-0.30374332  1.        ]
  HOMO = -0.580760096830551  LUMO = 0.880768239394162
  mo_energy =
[-1.18403624e+02 -1.22562257e+01 -9.57405507e+00 -9.57405507e+00
 -9.57405507e+00 -1.25801028e+00 -5.80760097e-01 -5.80760097e-01
 -5.80760097e-01  8.80768239e-01  8.80768239e-01  8.80768239e-01
  5.75602674e+00  5.75602674e+00  5.75602674e+00  2.59064627e+01
  2.59064627e+01  2.59064627e+01  2.69688065e+01  1.00151113e+02
  1.00151113e+02  1.00151113e+02  2.67493882e+02  4.31000484e+02
  4.31000484e+02  4.31000484e+02  1.28331069e+03  1.28331069e+03
  1.28331069e+03  1.99349706e+03  2.98453388e+03  2.98453388e+03
  2.98453388e+03  6.61274943e+03  6.61274943e+03  6.61274943e+03
  8.34412886e+03  2.47277042e+04  7.55191502e+04]
E1 = -727.8394837759724  E_coul = 201.73435485260632
cycle= 2 E= -526.105128923366  delta_E= -0.000487  |g|= 0.03  |ddm|= 0.0293
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0579296
diis-c [-0.0021733   0.05892996  0.94107004]
  HOMO = -0.575294597296899  LUMO = 0.884303646828002
  mo_energy =
[-1.18350909e+02 -1.22295930e+01 -9.54656847e+00 -9.54656847e+00
 -9.54656847e+00 -1.25091349e+00 -5.75294597e-01 -5.75294597e-01
 -5.75294597e-01  8.84303647e-01  8.84303647e-01  8.84303647e-01
  5.76926453e+00  5.76926453e+00  5.76926453e+00  2.59319677e+01
  2.59319677e+01  2.59319677e+01  2.70000046e+01  1.00190877e+02
  1.00190877e+02  1.00190877e+02  2.67544445e+02  4.31052528e+02
  4.31052528e+02  4.31052528e+02  1.28336651e+03  1.28336651e+03
  1.28336651e+03  1.99355542e+03  2.98459157e+03  2.98459157e+03
  2.98459157e+03  6.61280844e+03  6.61280844e+03  6.61280844e+03
  8.34418847e+03  2.47277641e+04  7.55192103e+04]
E1 = -727.7523973673624  E_coul = 201.64724428426533
cycle= 3 E= -526.105153083097  delta_E= -2.42e-05  |g|= 0.00426  |ddm|= 0.0074
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00887856
diis-c [-3.21279734e-07 -1.16749339e-03  1.27487458e-01  8.73680035e-01]
  HOMO = -0.576179480343106  LUMO = 0.883738707101427
  mo_energy =
[-1.18357843e+02 -1.22333272e+01 -9.55049277e+00 -9.55049277e+00
 -9.55049277e+00 -1.25203639e+00 -5.76179480e-01 -5.76179480e-01
 -5.76179480e-01  8.83738707e-01  8.83738707e-01  8.83738707e-01
  5.76724109e+00  5.76724109e+00  5.76724109e+00  2.59283132e+01
  2.59283132e+01  2.59283132e+01  2.69957858e+01  1.00185496e+02
  1.00185496e+02  1.00185496e+02  2.67537778e+02  4.31045677e+02
  4.31045677e+02  4.31045677e+02  1.28335915e+03  1.28335915e+03
  1.28335915e+03  1.99354759e+03  2.98458391e+03  2.98458391e+03
  2.98458391e+03  6.61280046e+03  6.61280046e+03  6.61280046e+03
  8.34418031e+03  2.47277558e+04  7.55192018e+04]
E1 = -727.7645259390202  E_coul = 201.65937224711683
cycle= 4 E= -526.105153691903  delta_E= -6.09e-07  |g|= 3.75e-05  |ddm|= 0.00105
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.6439e-05
diis-c [-2.06702208e-09  3.13410787e-05 -4.35561131e-03 -3.26342984e-02
  1.03695857e+00]
  HOMO = -0.576160354476597  LUMO = 0.883750633408184
  mo_energy =
[-1.18357795e+02 -1.22332654e+01 -9.55043640e+00 -9.55043640e+00
 -9.55043640e+00 -1.25201086e+00 -5.76160354e-01 -5.76160354e-01
 -5.76160354e-01  8.83750633e-01  8.83750633e-01  8.83750633e-01
  5.76727946e+00  5.76727946e+00  5.76727946e+00  2.59283652e+01
  2.59283652e+01  2.59283652e+01  2.69958481e+01  1.00185550e+02
  1.00185550e+02  1.00185550e+02  2.67537827e+02  4.31045725e+02
  4.31045725e+02  4.31045725e+02  1.28335920e+03  1.28335920e+03
  1.28335920e+03  1.99354762e+03  2.98458394e+03  2.98458394e+03
  2.98458394e+03  6.61280049e+03  6.61280049e+03  6.61280049e+03
  8.34418033e+03  2.47277558e+04  7.55192019e+04]
E1 = -727.7643917629634  E_coul = 201.65923807100174
cycle= 5 E= -526.105153691962  delta_E= -5.83e-11  |g|= 8.52e-06  |ddm|= 1.73e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.7643917629634  E_coul = 201.65923807100174
  HOMO = -0.576164592429354  LUMO = 0.883747969494669
  mo_energy =
[-1.18357814e+02 -1.22332797e+01 -9.55045119e+00 -9.55045119e+00
 -9.55045119e+00 -1.25201626e+00 -5.76164592e-01 -5.76164592e-01
 -5.76164592e-01  8.83747969e-01  8.83747969e-01  8.83747969e-01
  5.76727058e+00  5.76727058e+00  5.76727058e+00  2.59283514e+01
  2.59283514e+01  2.59283514e+01  2.69958331e+01  1.00185533e+02
  1.00185533e+02  1.00185533e+02  2.67537808e+02  4.31045706e+02
  4.31045706e+02  4.31045706e+02  1.28335917e+03  1.28335917e+03
  1.28335917e+03  1.99354760e+03  2.98458392e+03  2.98458392e+03
  2.98458392e+03  6.61280047e+03  6.61280047e+03  6.61280047e+03
  8.34418031e+03  2.47277558e+04  7.55192018e+04]
E1 = -727.7644332250137  E_coul = 201.65927953304856
Extra cycle  E= -526.105153691965  delta_E= -3.41e-12  |g|= 2.38e-06  |ddm|= 4.09e-06
    CPU time for scf_cycle      0.63 sec, wall time      0.25 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 86650.68977901601
E1 = -727.7644332250137  E_coul = 201.65927953304856
init E= -526.105153691965
    CPU time for initialize scf      2.77 sec, wall time      0.26 sec
  HOMO = -0.576163813106235  LUMO = 0.883748463652107
  mo_energy =
[-1.18357810e+02 -1.22332767e+01 -9.55044806e+00 -9.55044806e+00
 -9.55044806e+00 -1.25201526e+00 -5.76163813e-01 -5.76163813e-01
 -5.76163813e-01  8.83748464e-01  8.83748464e-01  8.83748464e-01
  5.76727230e+00  5.76727230e+00  5.76727230e+00  2.59283543e+01
  2.59283543e+01  2.59283543e+01  2.69958364e+01  1.00185537e+02
  1.00185537e+02  1.00185537e+02  2.67537813e+02  4.31045711e+02
  4.31045711e+02  4.31045711e+02  1.28335918e+03  1.28335918e+03
  1.28335918e+03  1.99354760e+03  2.98458393e+03  2.98458393e+03
  2.98458393e+03  6.61280047e+03  6.61280047e+03  6.61280047e+03
  8.34418031e+03  2.47277558e+04  7.55192018e+04]
E1 = -727.7644239801045  E_coul = 201.6592702881384
cycle= 1 E= -526.105153691966  delta_E= -1.02e-12  |g|= 5.78e-07  |ddm|= 8.5e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.7644239801045  E_coul = 201.6592702881384
  HOMO = -0.576163975972783  LUMO = 0.883748359906446
  mo_energy =
[-1.18357811e+02 -1.22332773e+01 -9.55044876e+00 -9.55044876e+00
 -9.55044876e+00 -1.25201547e+00 -5.76163976e-01 -5.76163976e-01
 -5.76163976e-01  8.83748360e-01  8.83748360e-01  8.83748360e-01
  5.76727194e+00  5.76727194e+00  5.76727194e+00  2.59283536e+01
  2.59283536e+01  2.59283536e+01  2.69958357e+01  1.00185536e+02
  1.00185536e+02  1.00185536e+02  2.67537812e+02  4.31045709e+02
  4.31045709e+02  4.31045709e+02  1.28335918e+03  1.28335918e+03
  1.28335918e+03  1.99354760e+03  2.98458393e+03  2.98458393e+03
  2.98458393e+03  6.61280047e+03  6.61280047e+03  6.61280047e+03
  8.34418031e+03  2.47277558e+04  7.55192018e+04]
E1 = -727.7644260829212  E_coul = 201.65927239095436
Extra cycle  E= -526.105153691967  delta_E= -6.82e-13  |g|= 1.36e-07  |ddm|= 1.87e-07
    CPU time for scf_cycle      2.90 sec, wall time      0.38 sec
exp = [2.61825085e+04 7.61824314e+03 3.61823509e+03 1.61801397e+03
 2.40215968e+02 5.93110133e+01 1.66149943e+01 4.23471294e+00
 3.97007456e-01 1.36279259e+03 6.65174260e+02 3.03285901e+02
 3.16115843e+02 4.92747433e+01 6.04516945e+00 1.63569495e+01
 6.91906557e-01 2.30765536e+00 2.04853920e-01]
grad_E = [-1.96133615e-06  2.56013904e-05  5.57414137e-05  8.11609725e-04
 -8.02069684e-03 -1.88056869e-03  6.16796292e-05 -1.09300855e-04
  2.01875551e-02  2.14888052e-06  2.56696800e-05  1.42509691e-04
  1.25639328e-04 -3.76628811e-03  1.55470833e-04  3.96702103e-03
 -1.78184381e-02 -1.78423753e-03  5.48382198e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:41:20 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5085535        1
[INPUT] 0    0    [1    /1   ]  7618.24256981        1
[INPUT] 0    0    [1    /1   ]  3618.2338211         1
[INPUT] 0    0    [1    /1   ]  1617.99568225        1
[INPUT] 0    0    [1    /1   ]  240.43145962         1
[INPUT] 0    0    [1    /1   ]  59.2421826725        1
[INPUT] 0    0    [1    /1   ]  16.3755638908        1
[INPUT] 0    0    [1    /1   ]  4.21918532275        1
[INPUT] 0    0    [1    /1   ]  0.399078862214       1
[INPUT] 1    0    [1    /1   ]  1362.79253658        1
[INPUT] 1    0    [1    /1   ]  665.173685453        1
[INPUT] 1    0    [1    /1   ]  303.282701549        1
[INPUT] 1    0    [1    /1   ]  316.113021523        1
[INPUT] 1    0    [1    /1   ]  49.3631897358        1
[INPUT] 1    0    [1    /1   ]  5.99325353414        1
[INPUT] 1    0    [1    /1   ]  16.2876458536        1
[INPUT] 1    0    [1    /1   ]  0.670863422516       1
[INPUT] 1    0    [1    /1   ]  2.28568177016        1
[INPUT] 1    0    [1    /1   ]  0.198999585135       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.50855348505, 1.0]], [0, [7618.242569807913, 1.0]], [0, [3618.233821104512, 1.0]], [0, [1617.9956822507954, 1.0]], [0, [240.43145962020247, 1.0]], [0, [59.24218267254979, 1.0]], [0, [16.37556389076637, 1.0]], [0, [4.219185322753646, 1.0]], [0, [0.3990788622135721, 1.0]], [1, [1362.7925365848444, 1.0]], [1, [665.1736854533196, 1.0]], [1, [303.2827015489872, 1.0]], [1, [316.11302152269735, 1.0]], [1, [49.363189735830844, 1.0]], [1, [5.99325353413511, 1.0]], [1, [16.287645853626344, 1.0]], [1, [0.6708634225161177, 1.0]], [1, [2.2856817701630257, 1.0]], [1, [0.1989995851346581, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50855349]
bas 1, expnt(s) = [7618.24256981]
bas 2, expnt(s) = [3618.2338211]
bas 3, expnt(s) = [1617.99568225]
bas 4, expnt(s) = [240.43145962]
bas 5, expnt(s) = [59.24218267]
bas 6, expnt(s) = [16.37556389]
bas 7, expnt(s) = [4.21918532]
bas 8, expnt(s) = [0.39907886]
bas 9, expnt(s) = [1362.79253658]
bas 10, expnt(s) = [665.17368545]
bas 11, expnt(s) = [303.28270155]
bas 12, expnt(s) = [316.11302152]
bas 13, expnt(s) = [49.36318974]
bas 14, expnt(s) = [5.99325353]
bas 15, expnt(s) = [16.28764585]
bas 16, expnt(s) = [0.67086342]
bas 17, expnt(s) = [2.28568177]
bas 18, expnt(s) = [0.19899959]
CPU time:       295.80
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825086e+04 5.20024093e+03 7.61824257e+03 2.06018453e+03
 3.61823382e+03 1.17865715e+03 1.61799568e+03 6.44537281e+02
 2.40431460e+02 1.54261835e+02 5.92421827e+01 5.39496104e+01
 1.63755639e+01 2.05665868e+01 4.21918532e+00 7.43766264e+00
 3.99078862e-01 1.26855432e+00 1.36279254e+03 2.41558084e+04
 6.65173685e+02 9.85492260e+03 3.03282702e+02 3.69227417e+03
 3.16113022e+02 3.88854720e+03 4.93631897e+01 3.81714284e+02
 5.99325353e+00 2.73566368e+01 1.62876459e+01 9.54568920e+01
 6.70863423e-01 1.77123846e+00 2.28568177e+00 8.19887185e+00
 1.98999585e-01 3.87748036e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982580534355044
cond(S) = 86588.39426701913
E1 = -728.4249771864414  E_coul = 203.12087844287535
init E= -525.304098743566
    CPU time for initialize scf      0.47 sec, wall time      0.05 sec
  HOMO = -0.558012923421793  LUMO = 0.855054192776781
  mo_energy =
[-1.18107821e+02 -1.21388916e+01 -9.44846443e+00 -9.44846443e+00
 -9.44846443e+00 -1.22705424e+00 -5.58012923e-01 -5.58012923e-01
 -5.58012923e-01  8.55054193e-01  8.55054193e-01  8.55054193e-01
  5.66964743e+00  5.66964743e+00  5.66964743e+00  2.56917140e+01
  2.56917140e+01  2.56917140e+01  2.66734378e+01  9.99120324e+01
  9.99120324e+01  9.99120324e+01  2.66734063e+02  4.31077880e+02
  4.31077880e+02  4.31077880e+02  1.28353170e+03  1.28353170e+03
  1.28353170e+03  1.99352215e+03  2.98485032e+03  2.98485032e+03
  2.98485032e+03  6.61321578e+03  6.61321578e+03  6.61321578e+03
  8.34450278e+03  2.47282141e+04  7.55197782e+04]
E1 = -727.4262242023085  E_coul = 201.32009491190266
cycle= 1 E= -526.106129290406  delta_E= -0.802  |g|= 0.209  |ddm|= 0.715
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.551612
diis-c [-0.30427578  1.        ]
  HOMO = -0.581024676196462  LUMO = 0.843485722741507
  mo_energy =
[-1.18405768e+02 -1.22585218e+01 -9.57576908e+00 -9.57576908e+00
 -9.57576908e+00 -1.25866571e+00 -5.81024676e-01 -5.81024676e-01
 -5.81024676e-01  8.43485723e-01  8.43485723e-01  8.43485723e-01
  5.60906966e+00  5.60906966e+00  5.60906966e+00  2.55708494e+01
  2.55708494e+01  2.55708494e+01  2.65391051e+01  9.97160143e+01
  9.97160143e+01  9.97160143e+01  2.66452886e+02  4.30779429e+02
  4.30779429e+02  4.30779429e+02  1.28316866e+03  1.28316866e+03
  1.28316866e+03  1.99301102e+03  2.98441175e+03  2.98441175e+03
  2.98441175e+03  6.61263828e+03  6.61263828e+03  6.61263828e+03
  8.34382889e+03  2.47274336e+04  7.55188974e+04]
E1 = -727.8303056688975  E_coul = 201.72367411178413
cycle= 2 E= -526.106631557113  delta_E= -0.000502  |g|= 0.0305  |ddm|= 0.0303
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0587177
diis-c [-0.00221489  0.06005056  0.93994944]
  HOMO = -0.575357699268114  LUMO = 0.847004237826613
  mo_energy =
[-1.18352116e+02 -1.22312522e+01 -9.54762426e+00 -9.54762426e+00
 -9.54762426e+00 -1.25130018e+00 -5.75357699e-01 -5.75357699e-01
 -5.75357699e-01  8.47004238e-01  8.47004238e-01  8.47004238e-01
  5.62258641e+00  5.62258641e+00  5.62258641e+00  2.55969113e+01
  2.55969113e+01  2.55969113e+01  2.65708175e+01  9.97565943e+01
  9.97565943e+01  9.97565943e+01  2.66504355e+02  4.30832409e+02
  4.30832409e+02  4.30832409e+02  1.28322544e+03  1.28322544e+03
  1.28322544e+03  1.99307038e+03  2.98447042e+03  2.98447042e+03
  2.98447042e+03  6.61269829e+03  6.61269829e+03  6.61269829e+03
  8.34388952e+03  2.47274945e+04  7.55189584e+04]
E1 = -727.7409586539376  E_coul = 201.63430185031442
cycle= 3 E= -526.106656803623  delta_E= -2.52e-05  |g|= 0.00432  |ddm|= 0.00759
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00900106
diis-c [-3.27264632e-07 -1.17448556e-03  1.27513457e-01  8.73661029e-01]
  HOMO = -0.576261774742634  LUMO = 0.846449877889251
  mo_energy =
[-1.18359154e+02 -1.22350514e+01 -9.55161827e+00 -9.55161827e+00
 -9.55161827e+00 -1.25244953e+00 -5.76261775e-01 -5.76261775e-01
 -5.76261775e-01  8.46449878e-01  8.46449878e-01  8.46449878e-01
  5.62054059e+00  5.62054059e+00  5.62054059e+00  2.55931991e+01
  2.55931991e+01  2.55931991e+01  2.65665475e+01  9.97511246e+01
  9.97511246e+01  9.97511246e+01  2.66497588e+02  4.30825453e+02
  4.30825453e+02  4.30825453e+02  1.28321798e+03  1.28321798e+03
  1.28321798e+03  1.99306243e+03  2.98446265e+03  2.98446265e+03
  2.98446265e+03  6.61269020e+03  6.61269020e+03  6.61269020e+03
  8.34388124e+03  2.47274861e+04  7.55189499e+04]
E1 = -727.7533426141074  E_coul = 201.64668517905417
cycle= 4 E= -526.106657435053  delta_E= -6.31e-07  |g|= 3.72e-05  |ddm|= 0.00107
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.96935e-05
diis-c [-2.03839906e-09  3.43513141e-05 -4.68084276e-03 -3.54663990e-02
  1.04011289e+00]
  HOMO = -0.576243262895676  LUMO = 0.846460995769317
  mo_energy =
[-1.18359111e+02 -1.22349924e+01 -9.55156493e+00 -9.55156493e+00
 -9.55156493e+00 -1.25242476e+00 -5.76243263e-01 -5.76243263e-01
 -5.76243263e-01  8.46460996e-01  8.46460996e-01  8.46460996e-01
  5.62057719e+00  5.62057719e+00  5.62057719e+00  2.55932483e+01
  2.55932483e+01  2.55932483e+01  2.65666068e+01  9.97511748e+01
  9.97511748e+01  9.97511748e+01  2.66497632e+02  4.30825497e+02
  4.30825497e+02  4.30825497e+02  1.28321801e+03  1.28321801e+03
  1.28321801e+03  1.99306245e+03  2.98446268e+03  2.98446268e+03
  2.98446268e+03  6.61269022e+03  6.61269022e+03  6.61269022e+03
  8.34388125e+03  2.47274861e+04  7.55189499e+04]
E1 = -727.7532168877531  E_coul = 201.64655945264607
cycle= 5 E= -526.106657435107  delta_E= -5.38e-11  |g|= 8.48e-06  |ddm|= 1.64e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.7532168877531  E_coul = 201.64655945264607
  HOMO = -0.576247514883987  LUMO = 0.846458425296197
  mo_energy =
[-1.18359130e+02 -1.22350067e+01 -9.55157971e+00 -9.55157971e+00
 -9.55157971e+00 -1.25243018e+00 -5.76247515e-01 -5.76247515e-01
 -5.76247515e-01  8.46458425e-01  8.46458425e-01  8.46458425e-01
  5.62056837e+00  5.62056837e+00  5.62056837e+00  2.55932345e+01
  2.55932345e+01  2.55932345e+01  2.65665919e+01  9.97511575e+01
  9.97511575e+01  9.97511575e+01  2.66497613e+02  4.30825477e+02
  4.30825477e+02  4.30825477e+02  1.28321799e+03  1.28321799e+03
  1.28321799e+03  1.99306243e+03  2.98446265e+03  2.98446265e+03
  2.98446265e+03  6.61269020e+03  6.61269020e+03  6.61269020e+03
  8.34388123e+03  2.47274861e+04  7.55189499e+04]
E1 = -727.7532584648627  E_coul = 201.64660102975316
Extra cycle  E= -526.10665743511  delta_E= -2.61e-12  |g|= 2.37e-06  |ddm|= 4.1e-06
    CPU time for scf_cycle      0.65 sec, wall time      0.23 sec
exp = [2.61825086e+04 7.61824257e+03 3.61823382e+03 1.61799568e+03
 2.40431460e+02 5.92421827e+01 1.63755639e+01 4.21918532e+00
 3.99078862e-01 1.36279254e+03 6.65173685e+02 3.03282702e+02
 3.16113022e+02 4.93631897e+01 5.99325353e+00 1.62876459e+01
 6.70863423e-01 2.28568177e+00 1.98999585e-01]
E = -526.1066574351096
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:41:20 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5085535        1
[INPUT] 0    0    [1    /1   ]  7618.24256981        1
[INPUT] 0    0    [1    /1   ]  3618.2338211         1
[INPUT] 0    0    [1    /1   ]  1617.99568225        1
[INPUT] 0    0    [1    /1   ]  240.43145962         1
[INPUT] 0    0    [1    /1   ]  59.2421826725        1
[INPUT] 0    0    [1    /1   ]  16.3755638908        1
[INPUT] 0    0    [1    /1   ]  4.21918532275        1
[INPUT] 0    0    [1    /1   ]  0.399078862214       1
[INPUT] 1    0    [1    /1   ]  1362.79253658        1
[INPUT] 1    0    [1    /1   ]  665.173685453        1
[INPUT] 1    0    [1    /1   ]  303.282701549        1
[INPUT] 1    0    [1    /1   ]  316.113021523        1
[INPUT] 1    0    [1    /1   ]  49.3631897358        1
[INPUT] 1    0    [1    /1   ]  5.99325353414        1
[INPUT] 1    0    [1    /1   ]  16.2876458536        1
[INPUT] 1    0    [1    /1   ]  0.670863422516       1
[INPUT] 1    0    [1    /1   ]  2.28568177016        1
[INPUT] 1    0    [1    /1   ]  0.198999585135       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.50855348505, 1.0]], [0, [7618.242569807913, 1.0]], [0, [3618.233821104512, 1.0]], [0, [1617.9956822507954, 1.0]], [0, [240.43145962020247, 1.0]], [0, [59.24218267254979, 1.0]], [0, [16.37556389076637, 1.0]], [0, [4.219185322753646, 1.0]], [0, [0.3990788622135721, 1.0]], [1, [1362.7925365848444, 1.0]], [1, [665.1736854533196, 1.0]], [1, [303.2827015489872, 1.0]], [1, [316.11302152269735, 1.0]], [1, [49.363189735830844, 1.0]], [1, [5.99325353413511, 1.0]], [1, [16.287645853626344, 1.0]], [1, [0.6708634225161177, 1.0]], [1, [2.2856817701630257, 1.0]], [1, [0.1989995851346581, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50855349]
bas 1, expnt(s) = [7618.24256981]
bas 2, expnt(s) = [3618.2338211]
bas 3, expnt(s) = [1617.99568225]
bas 4, expnt(s) = [240.43145962]
bas 5, expnt(s) = [59.24218267]
bas 6, expnt(s) = [16.37556389]
bas 7, expnt(s) = [4.21918532]
bas 8, expnt(s) = [0.39907886]
bas 9, expnt(s) = [1362.79253658]
bas 10, expnt(s) = [665.17368545]
bas 11, expnt(s) = [303.28270155]
bas 12, expnt(s) = [316.11302152]
bas 13, expnt(s) = [49.36318974]
bas 14, expnt(s) = [5.99325353]
bas 15, expnt(s) = [16.28764585]
bas 16, expnt(s) = [0.67086342]
bas 17, expnt(s) = [2.28568177]
bas 18, expnt(s) = [0.19899959]
CPU time:       296.57
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825086e+04 5.20024093e+03 7.61824257e+03 2.06018453e+03
 3.61823382e+03 1.17865715e+03 1.61799568e+03 6.44537281e+02
 2.40431460e+02 1.54261835e+02 5.92421827e+01 5.39496104e+01
 1.63755639e+01 2.05665868e+01 4.21918532e+00 7.43766264e+00
 3.99078862e-01 1.26855432e+00 1.36279254e+03 2.41558084e+04
 6.65173685e+02 9.85492260e+03 3.03282702e+02 3.69227417e+03
 3.16113022e+02 3.88854720e+03 4.93631897e+01 3.81714284e+02
 5.99325353e+00 2.73566368e+01 1.62876459e+01 9.54568920e+01
 6.70863423e-01 1.77123846e+00 2.28568177e+00 8.19887185e+00
 1.98999585e-01 3.87748036e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982580534355044
cond(S) = 86588.39426701913
E1 = -728.4249771864414  E_coul = 203.12087844287535
init E= -525.304098743566
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558012923421793  LUMO = 0.855054192776781
  mo_energy =
[-1.18107821e+02 -1.21388916e+01 -9.44846443e+00 -9.44846443e+00
 -9.44846443e+00 -1.22705424e+00 -5.58012923e-01 -5.58012923e-01
 -5.58012923e-01  8.55054193e-01  8.55054193e-01  8.55054193e-01
  5.66964743e+00  5.66964743e+00  5.66964743e+00  2.56917140e+01
  2.56917140e+01  2.56917140e+01  2.66734378e+01  9.99120324e+01
  9.99120324e+01  9.99120324e+01  2.66734063e+02  4.31077880e+02
  4.31077880e+02  4.31077880e+02  1.28353170e+03  1.28353170e+03
  1.28353170e+03  1.99352215e+03  2.98485032e+03  2.98485032e+03
  2.98485032e+03  6.61321578e+03  6.61321578e+03  6.61321578e+03
  8.34450278e+03  2.47282141e+04  7.55197782e+04]
E1 = -727.4262242023085  E_coul = 201.32009491190266
cycle= 1 E= -526.106129290406  delta_E= -0.802  |g|= 0.209  |ddm|= 0.715
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.551612
diis-c [-0.30427578  1.        ]
  HOMO = -0.581024676196462  LUMO = 0.843485722741507
  mo_energy =
[-1.18405768e+02 -1.22585218e+01 -9.57576908e+00 -9.57576908e+00
 -9.57576908e+00 -1.25866571e+00 -5.81024676e-01 -5.81024676e-01
 -5.81024676e-01  8.43485723e-01  8.43485723e-01  8.43485723e-01
  5.60906966e+00  5.60906966e+00  5.60906966e+00  2.55708494e+01
  2.55708494e+01  2.55708494e+01  2.65391051e+01  9.97160143e+01
  9.97160143e+01  9.97160143e+01  2.66452886e+02  4.30779429e+02
  4.30779429e+02  4.30779429e+02  1.28316866e+03  1.28316866e+03
  1.28316866e+03  1.99301102e+03  2.98441175e+03  2.98441175e+03
  2.98441175e+03  6.61263828e+03  6.61263828e+03  6.61263828e+03
  8.34382889e+03  2.47274336e+04  7.55188974e+04]
E1 = -727.8303056688975  E_coul = 201.72367411178413
cycle= 2 E= -526.106631557113  delta_E= -0.000502  |g|= 0.0305  |ddm|= 0.0303
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0587177
diis-c [-0.00221489  0.06005056  0.93994944]
  HOMO = -0.575357699268114  LUMO = 0.847004237826613
  mo_energy =
[-1.18352116e+02 -1.22312522e+01 -9.54762426e+00 -9.54762426e+00
 -9.54762426e+00 -1.25130018e+00 -5.75357699e-01 -5.75357699e-01
 -5.75357699e-01  8.47004238e-01  8.47004238e-01  8.47004238e-01
  5.62258641e+00  5.62258641e+00  5.62258641e+00  2.55969113e+01
  2.55969113e+01  2.55969113e+01  2.65708175e+01  9.97565943e+01
  9.97565943e+01  9.97565943e+01  2.66504355e+02  4.30832409e+02
  4.30832409e+02  4.30832409e+02  1.28322544e+03  1.28322544e+03
  1.28322544e+03  1.99307038e+03  2.98447042e+03  2.98447042e+03
  2.98447042e+03  6.61269829e+03  6.61269829e+03  6.61269829e+03
  8.34388952e+03  2.47274945e+04  7.55189584e+04]
E1 = -727.7409586539376  E_coul = 201.63430185031442
cycle= 3 E= -526.106656803623  delta_E= -2.52e-05  |g|= 0.00432  |ddm|= 0.00759
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00900106
diis-c [-3.27264632e-07 -1.17448556e-03  1.27513457e-01  8.73661029e-01]
  HOMO = -0.576261774742634  LUMO = 0.846449877889251
  mo_energy =
[-1.18359154e+02 -1.22350514e+01 -9.55161827e+00 -9.55161827e+00
 -9.55161827e+00 -1.25244953e+00 -5.76261775e-01 -5.76261775e-01
 -5.76261775e-01  8.46449878e-01  8.46449878e-01  8.46449878e-01
  5.62054059e+00  5.62054059e+00  5.62054059e+00  2.55931991e+01
  2.55931991e+01  2.55931991e+01  2.65665475e+01  9.97511246e+01
  9.97511246e+01  9.97511246e+01  2.66497588e+02  4.30825453e+02
  4.30825453e+02  4.30825453e+02  1.28321798e+03  1.28321798e+03
  1.28321798e+03  1.99306243e+03  2.98446265e+03  2.98446265e+03
  2.98446265e+03  6.61269020e+03  6.61269020e+03  6.61269020e+03
  8.34388124e+03  2.47274861e+04  7.55189499e+04]
E1 = -727.7533426141074  E_coul = 201.64668517905417
cycle= 4 E= -526.106657435053  delta_E= -6.31e-07  |g|= 3.72e-05  |ddm|= 0.00107
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.96935e-05
diis-c [-2.03839906e-09  3.43513141e-05 -4.68084276e-03 -3.54663990e-02
  1.04011289e+00]
  HOMO = -0.576243262895676  LUMO = 0.846460995769317
  mo_energy =
[-1.18359111e+02 -1.22349924e+01 -9.55156493e+00 -9.55156493e+00
 -9.55156493e+00 -1.25242476e+00 -5.76243263e-01 -5.76243263e-01
 -5.76243263e-01  8.46460996e-01  8.46460996e-01  8.46460996e-01
  5.62057719e+00  5.62057719e+00  5.62057719e+00  2.55932483e+01
  2.55932483e+01  2.55932483e+01  2.65666068e+01  9.97511748e+01
  9.97511748e+01  9.97511748e+01  2.66497632e+02  4.30825497e+02
  4.30825497e+02  4.30825497e+02  1.28321801e+03  1.28321801e+03
  1.28321801e+03  1.99306245e+03  2.98446268e+03  2.98446268e+03
  2.98446268e+03  6.61269022e+03  6.61269022e+03  6.61269022e+03
  8.34388125e+03  2.47274861e+04  7.55189499e+04]
E1 = -727.7532168877531  E_coul = 201.64655945264607
cycle= 5 E= -526.106657435107  delta_E= -5.38e-11  |g|= 8.48e-06  |ddm|= 1.64e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.7532168877531  E_coul = 201.64655945264607
  HOMO = -0.576247514883987  LUMO = 0.846458425296197
  mo_energy =
[-1.18359130e+02 -1.22350067e+01 -9.55157971e+00 -9.55157971e+00
 -9.55157971e+00 -1.25243018e+00 -5.76247515e-01 -5.76247515e-01
 -5.76247515e-01  8.46458425e-01  8.46458425e-01  8.46458425e-01
  5.62056837e+00  5.62056837e+00  5.62056837e+00  2.55932345e+01
  2.55932345e+01  2.55932345e+01  2.65665919e+01  9.97511575e+01
  9.97511575e+01  9.97511575e+01  2.66497613e+02  4.30825477e+02
  4.30825477e+02  4.30825477e+02  1.28321799e+03  1.28321799e+03
  1.28321799e+03  1.99306243e+03  2.98446265e+03  2.98446265e+03
  2.98446265e+03  6.61269020e+03  6.61269020e+03  6.61269020e+03
  8.34388123e+03  2.47274861e+04  7.55189499e+04]
E1 = -727.7532584648627  E_coul = 201.64660102975316
Extra cycle  E= -526.10665743511  delta_E= -2.61e-12  |g|= 2.37e-06  |ddm|= 4.1e-06
    CPU time for scf_cycle      0.63 sec, wall time      0.24 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 86588.39426701913
E1 = -727.7532584648627  E_coul = 201.64660102975316
init E= -526.10665743511
    CPU time for initialize scf      2.71 sec, wall time      0.24 sec
  HOMO = -0.576246729766092  LUMO = 0.846458903814666
  mo_energy =
[-1.18359125e+02 -1.22350037e+01 -9.55157658e+00 -9.55157658e+00
 -9.55157658e+00 -1.25242917e+00 -5.76246730e-01 -5.76246730e-01
 -5.76246730e-01  8.46458904e-01  8.46458904e-01  8.46458904e-01
  5.62057008e+00  5.62057008e+00  5.62057008e+00  2.55932374e+01
  2.55932374e+01  2.55932374e+01  2.65665952e+01  9.97511616e+01
  9.97511616e+01  9.97511616e+01  2.66497618e+02  4.30825482e+02
  4.30825482e+02  4.30825482e+02  1.28321800e+03  1.28321800e+03
  1.28321800e+03  1.99306244e+03  2.98446266e+03  2.98446266e+03
  2.98446266e+03  6.61269020e+03  6.61269020e+03  6.61269020e+03
  8.34388124e+03  2.47274861e+04  7.55189499e+04]
E1 = -727.7532491653737  E_coul = 201.64659173026357
cycle= 1 E= -526.10665743511  delta_E= -5.68e-13  |g|= 5.8e-07  |ddm|= 8.53e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.7532491653737  E_coul = 201.64659173026357
  HOMO = -0.576246894223553  LUMO = 0.84645880315121
  mo_energy =
[-1.18359127e+02 -1.22350043e+01 -9.55157728e+00 -9.55157728e+00
 -9.55157728e+00 -1.25242938e+00 -5.76246894e-01 -5.76246894e-01
 -5.76246894e-01  8.46458803e-01  8.46458803e-01  8.46458803e-01
  5.62056971e+00  5.62056971e+00  5.62056971e+00  2.55932368e+01
  2.55932368e+01  2.55932368e+01  2.65665945e+01  9.97511606e+01
  9.97511606e+01  9.97511606e+01  2.66497617e+02  4.30825481e+02
  4.30825481e+02  4.30825481e+02  1.28321800e+03  1.28321800e+03
  1.28321800e+03  1.99306244e+03  2.98446266e+03  2.98446266e+03
  2.98446266e+03  6.61269020e+03  6.61269020e+03  6.61269020e+03
  8.34388124e+03  2.47274861e+04  7.55189499e+04]
E1 = -727.7532512878543  E_coul = 201.64659385274348
Extra cycle  E= -526.106657435111  delta_E= -5.68e-13  |g|= 1.37e-07  |ddm|= 1.89e-07
    CPU time for scf_cycle      2.84 sec, wall time      0.36 sec
exp = [2.61825086e+04 7.61824257e+03 3.61823382e+03 1.61799568e+03
 2.40431460e+02 5.92421827e+01 1.63755639e+01 4.21918532e+00
 3.99078862e-01 1.36279254e+03 6.65173685e+02 3.03282702e+02
 3.16113022e+02 4.93631897e+01 5.99325353e+00 1.62876459e+01
 6.70863423e-01 2.28568177e+00 1.98999585e-01]
grad_E = [-1.96233350e-06  2.54763053e-05  5.53291387e-05  8.07250346e-04
 -7.91724797e-03 -1.68337718e-03 -2.58731024e-04 -4.79587237e-03
  4.72521353e-02  2.05122372e-06  2.50064998e-05  1.38550158e-04
  1.22127636e-04 -3.52802227e-03  8.18127918e-04  3.44356464e-03
 -4.13019027e-02  4.31716293e-04  1.22227170e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:41:25 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5087201        1
[INPUT] 0    0    [1    /1   ]  7618.24035249        1
[INPUT] 0    0    [1    /1   ]  3618.22895203        1
[INPUT] 0    0    [1    /1   ]  1617.92519667        1
[INPUT] 0    0    [1    /1   ]  241.186221254        1
[INPUT] 0    0    [1    /1   ]  59.2565212625        1
[INPUT] 0    0    [1    /1   ]  15.9091757411        1
[INPUT] 0    0    [1    /1   ]  4.1886087476         1
[INPUT] 0    0    [1    /1   ]  0.40310354139        1
[INPUT] 1    0    [1    /1   ]  1362.79235462        1
[INPUT] 1    0    [1    /1   ]  665.171508408        1
[INPUT] 1    0    [1    /1   ]  303.270626951        1
[INPUT] 1    0    [1    /1   ]  316.102375326        1
[INPUT] 1    0    [1    /1   ]  49.6618823955        1
[INPUT] 1    0    [1    /1   ]  5.84644508801        1
[INPUT] 1    0    [1    /1   ]  16.1235806656        1
[INPUT] 1    0    [1    /1   ]  0.634137762705       1
[INPUT] 1    0    [1    /1   ]  2.21443233359        1
[INPUT] 1    0    [1    /1   ]  0.18852116295        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.508720104503, 1.0]], [0, [7618.240352492722, 1.0]], [0, [3618.228952030162, 1.0]], [0, [1617.9251966699962, 1.0]], [0, [241.1862212539197, 1.0]], [0, [59.25652126252944, 1.0]], [0, [15.90917574108135, 1.0]], [0, [4.188608747604371, 1.0]], [0, [0.40310354139045923, 1.0]], [1, [1362.79235461997, 1.0]], [1, [665.1715084079362, 1.0]], [1, [303.2706269507469, 1.0]], [1, [316.10237532594294, 1.0]], [1, [49.661882395492434, 1.0]], [1, [5.8464450880129615, 1.0]], [1, [16.123580665606593, 1.0]], [1, [0.6341377627048506, 1.0]], [1, [2.214432333594267, 1.0]], [1, [0.18852116294978247, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.5087201]
bas 1, expnt(s) = [7618.24035249]
bas 2, expnt(s) = [3618.22895203]
bas 3, expnt(s) = [1617.92519667]
bas 4, expnt(s) = [241.18622125]
bas 5, expnt(s) = [59.25652126]
bas 6, expnt(s) = [15.90917574]
bas 7, expnt(s) = [4.18860875]
bas 8, expnt(s) = [0.40310354]
bas 9, expnt(s) = [1362.79235462]
bas 10, expnt(s) = [665.17150841]
bas 11, expnt(s) = [303.27062695]
bas 12, expnt(s) = [316.10237533]
bas 13, expnt(s) = [49.6618824]
bas 14, expnt(s) = [5.84644509]
bas 15, expnt(s) = [16.12358067]
bas 16, expnt(s) = [0.63413776]
bas 17, expnt(s) = [2.21443233]
bas 18, expnt(s) = [0.18852116]
CPU time:       304.62
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825087e+04 5.20024095e+03 7.61824035e+03 2.06018408e+03
 3.61822895e+03 1.17865596e+03 1.61792520e+03 6.44516223e+02
 2.41186221e+02 1.54624887e+02 5.92565213e+01 5.39594033e+01
 1.59091757e+01 2.01256902e+01 4.18860875e+00 7.39720017e+00
 4.03103541e-01 1.27813723e+00 1.36279235e+03 2.41558043e+04
 6.65171508e+02 9.85488228e+03 3.03270627e+02 3.69209042e+03
 3.16102375e+02 3.88838350e+03 4.96618824e+01 3.84603617e+02
 5.84644509e+00 2.65215704e+01 1.61235807e+01 9.42564895e+01
 6.34137763e-01 1.65087394e+00 2.21443233e+00 7.88065672e+00
 1.88521163e-01 3.62396947e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982716003602796
cond(S) = 86504.16733092224
E1 = -728.4654022383423  E_coul = 203.15500072186077
init E= -525.310401516482
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.556802477677599  LUMO = 0.789924563226958
  mo_energy =
[-1.18106512e+02 -1.21378558e+01 -9.44603408e+00 -9.44603408e+00
 -9.44603408e+00 -1.22567444e+00 -5.56802478e-01 -5.56802478e-01
 -5.56802478e-01  7.89924563e-01  7.89924563e-01  7.89924563e-01
  5.35320055e+00  5.35320055e+00  5.35320055e+00  2.48373968e+01
  2.48373968e+01  2.48373968e+01  2.58656150e+01  9.88715793e+01
  9.88715793e+01  9.88715793e+01  2.65296040e+02  4.30744153e+02
  4.30744153e+02  4.30744153e+02  1.28341983e+03  1.28341983e+03
  1.28341983e+03  1.99411798e+03  2.98477678e+03  2.98477678e+03
  2.98477678e+03  6.61314690e+03  6.61314690e+03  6.61314690e+03
  8.34554505e+03  2.47292407e+04  7.55207268e+04]
E1 = -727.4002761208925  E_coul = 201.28945296434654
cycle= 1 E= -526.110823156546  delta_E= -0.8  |g|= 0.211  |ddm|= 0.661
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.552196
diis-c [-0.30492097  1.        ]
  HOMO = -0.581291716059081  LUMO = 0.778770165416274
  mo_energy =
[-1.18410196e+02 -1.22620657e+01 -9.57844162e+00 -9.57844162e+00
 -9.57844162e+00 -1.25956151e+00 -5.81291716e-01 -5.81291716e-01
 -5.81291716e-01  7.78770165e-01  7.78770165e-01  7.78770165e-01
  5.29116241e+00  5.29116241e+00  5.29116241e+00  2.47125754e+01
  2.47125754e+01  2.47125754e+01  2.57273907e+01  9.86696130e+01
  9.86696130e+01  9.86696130e+01  2.65008835e+02  4.30439821e+02
  4.30439821e+02  4.30439821e+02  1.28305141e+03  1.28305141e+03
  1.28305141e+03  1.99360283e+03  2.98433364e+03  2.98433364e+03
  2.98433364e+03  6.61256585e+03  6.61256585e+03  6.61256585e+03
  8.34486827e+03  2.47284579e+04  7.55198439e+04]
E1 = -727.8208339867083  E_coul = 201.70948174980938
cycle= 2 E= -526.111352236899  delta_E= -0.000529  |g|= 0.0313  |ddm|= 0.0317
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0599679
diis-c [-0.00228267  0.06180747  0.93819253]
  HOMO = -0.575302856315657  LUMO = 0.782208663506962
  mo_energy =
[-1.18354942e+02 -1.22337345e+01 -9.54919754e+00 -9.54919754e+00
 -9.54919754e+00 -1.25175778e+00 -5.75302856e-01 -5.75302856e-01
 -5.75302856e-01  7.82208664e-01  7.82208664e-01  7.82208664e-01
  5.30497406e+00  5.30497406e+00  5.30497406e+00  2.47394788e+01
  2.47394788e+01  2.47394788e+01  2.57599171e+01  9.87116110e+01
  9.87116110e+01  9.87116110e+01  2.65061865e+02  4.30494409e+02
  4.30494409e+02  4.30494409e+02  1.28310984e+03  1.28310984e+03
  1.28310984e+03  1.99366389e+03  2.98439400e+03  2.98439400e+03
  2.98439400e+03  6.61262758e+03  6.61262758e+03  6.61262758e+03
  8.34493063e+03  2.47285206e+04  7.55199067e+04]
E1 = -727.7276103832911  E_coul = 201.616230981169
cycle= 3 E= -526.111379402122  delta_E= -2.72e-05  |g|= 0.00444  |ddm|= 0.00789
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00920776
diis-c [-3.43965587e-07 -1.18397456e-03  1.27718733e-01  8.73465241e-01]
  HOMO = -0.576240064350464  LUMO = 0.781676696568899
  mo_energy =
[-1.18362167e+02 -1.22376462e+01 -9.55331341e+00 -9.55331341e+00
 -9.55331341e+00 -1.25295330e+00 -5.76240064e-01 -5.76240064e-01
 -5.76240064e-01  7.81676697e-01  7.81676697e-01  7.81676697e-01
  5.30290946e+00  5.30290946e+00  5.30290946e+00  2.47356758e+01
  2.47356758e+01  2.47356758e+01  2.57555623e+01  9.87059792e+01
  9.87059792e+01  9.87059792e+01  2.65054916e+02  4.30487266e+02
  4.30487266e+02  4.30487266e+02  1.28310218e+03  1.28310218e+03
  1.28310218e+03  1.99365574e+03  2.98438602e+03  2.98438602e+03
  2.98438602e+03  6.61261928e+03  6.61261928e+03  6.61261928e+03
  8.34492214e+03  2.47285119e+04  7.55198980e+04]
E1 = -727.7404453186829  E_coul = 201.62906524375956
cycle= 4 E= -526.111380074923  delta_E= -6.73e-07  |g|= 3.76e-05  |ddm|= 0.0011
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.67365e-05
diis-c [-2.01281417e-09  3.91634540e-05 -5.19611399e-03 -4.00251262e-02
  1.04518208e+00]
  HOMO = -0.576222683360516  LUMO = 0.781686403544988
  mo_energy =
[-1.18362131e+02 -1.22375918e+01 -9.55326525e+00 -9.55326525e+00
 -9.55326525e+00 -1.25292987e+00 -5.76222683e-01 -5.76222683e-01
 -5.76222683e-01  7.81686404e-01  7.81686404e-01  7.81686404e-01
  5.30294279e+00  5.30294279e+00  5.30294279e+00  2.47357202e+01
  2.47357202e+01  2.47357202e+01  2.57556166e+01  9.87060229e+01
  9.87060229e+01  9.87060229e+01  2.65054953e+02  4.30487302e+02
  4.30487302e+02  4.30487302e+02  1.28310221e+03  1.28310221e+03
  1.28310221e+03  1.99365575e+03  2.98438604e+03  2.98438604e+03
  2.98438604e+03  6.61261929e+03  6.61261929e+03  6.61261929e+03
  8.34492215e+03  2.47285119e+04  7.55198980e+04]
E1 = -727.7403341760469  E_coul = 201.62895410107961
cycle= 5 E= -526.111380074967  delta_E= -4.39e-11  |g|= 8.44e-06  |ddm|= 1.5e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.7403341760469  E_coul = 201.62895410107961
  HOMO = -0.576226967402649  LUMO = 0.781684000042041
  mo_energy =
[-1.18362150e+02 -1.22376062e+01 -9.55328005e+00 -9.55328005e+00
 -9.55328005e+00 -1.25293535e+00 -5.76226967e-01 -5.76226967e-01
 -5.76226967e-01  7.81684000e-01  7.81684000e-01  7.81684000e-01
  5.30293410e+00  5.30293410e+00  5.30293410e+00  2.47357064e+01
  2.47357064e+01  2.47357064e+01  2.57556017e+01  9.87060056e+01
  9.87060056e+01  9.87060056e+01  2.65054934e+02  4.30487283e+02
  4.30487283e+02  4.30487283e+02  1.28310219e+03  1.28310219e+03
  1.28310219e+03  1.99365573e+03  2.98438602e+03  2.98438602e+03
  2.98438602e+03  6.61261927e+03  6.61261927e+03  6.61261927e+03
  8.34492212e+03  2.47285119e+04  7.55198980e+04]
E1 = -727.7403760433941  E_coul = 201.62899596842314
Extra cycle  E= -526.111380074971  delta_E= -3.75e-12  |g|= 2.38e-06  |ddm|= 4.1e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.23 sec
exp = [2.61825087e+04 7.61824035e+03 3.61822895e+03 1.61792520e+03
 2.41186221e+02 5.92565213e+01 1.59091757e+01 4.18860875e+00
 4.03103541e-01 1.36279235e+03 6.65171508e+02 3.03270627e+02
 3.16102375e+02 4.96618824e+01 5.84644509e+00 1.61235807e+01
 6.34137763e-01 2.21443233e+00 1.88521163e-01]
E = -526.111380074971
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:41:25 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5087201        1
[INPUT] 0    0    [1    /1   ]  7618.24035249        1
[INPUT] 0    0    [1    /1   ]  3618.22895203        1
[INPUT] 0    0    [1    /1   ]  1617.92519667        1
[INPUT] 0    0    [1    /1   ]  241.186221254        1
[INPUT] 0    0    [1    /1   ]  59.2565212625        1
[INPUT] 0    0    [1    /1   ]  15.9091757411        1
[INPUT] 0    0    [1    /1   ]  4.1886087476         1
[INPUT] 0    0    [1    /1   ]  0.40310354139        1
[INPUT] 1    0    [1    /1   ]  1362.79235462        1
[INPUT] 1    0    [1    /1   ]  665.171508408        1
[INPUT] 1    0    [1    /1   ]  303.270626951        1
[INPUT] 1    0    [1    /1   ]  316.102375326        1
[INPUT] 1    0    [1    /1   ]  49.6618823955        1
[INPUT] 1    0    [1    /1   ]  5.84644508801        1
[INPUT] 1    0    [1    /1   ]  16.1235806656        1
[INPUT] 1    0    [1    /1   ]  0.634137762705       1
[INPUT] 1    0    [1    /1   ]  2.21443233359        1
[INPUT] 1    0    [1    /1   ]  0.18852116295        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.508720104503, 1.0]], [0, [7618.240352492722, 1.0]], [0, [3618.228952030162, 1.0]], [0, [1617.9251966699962, 1.0]], [0, [241.1862212539197, 1.0]], [0, [59.25652126252944, 1.0]], [0, [15.90917574108135, 1.0]], [0, [4.188608747604371, 1.0]], [0, [0.40310354139045923, 1.0]], [1, [1362.79235461997, 1.0]], [1, [665.1715084079362, 1.0]], [1, [303.2706269507469, 1.0]], [1, [316.10237532594294, 1.0]], [1, [49.661882395492434, 1.0]], [1, [5.8464450880129615, 1.0]], [1, [16.123580665606593, 1.0]], [1, [0.6341377627048506, 1.0]], [1, [2.214432333594267, 1.0]], [1, [0.18852116294978247, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.5087201]
bas 1, expnt(s) = [7618.24035249]
bas 2, expnt(s) = [3618.22895203]
bas 3, expnt(s) = [1617.92519667]
bas 4, expnt(s) = [241.18622125]
bas 5, expnt(s) = [59.25652126]
bas 6, expnt(s) = [15.90917574]
bas 7, expnt(s) = [4.18860875]
bas 8, expnt(s) = [0.40310354]
bas 9, expnt(s) = [1362.79235462]
bas 10, expnt(s) = [665.17150841]
bas 11, expnt(s) = [303.27062695]
bas 12, expnt(s) = [316.10237533]
bas 13, expnt(s) = [49.6618824]
bas 14, expnt(s) = [5.84644509]
bas 15, expnt(s) = [16.12358067]
bas 16, expnt(s) = [0.63413776]
bas 17, expnt(s) = [2.21443233]
bas 18, expnt(s) = [0.18852116]
CPU time:       305.36
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825087e+04 5.20024095e+03 7.61824035e+03 2.06018408e+03
 3.61822895e+03 1.17865596e+03 1.61792520e+03 6.44516223e+02
 2.41186221e+02 1.54624887e+02 5.92565213e+01 5.39594033e+01
 1.59091757e+01 2.01256902e+01 4.18860875e+00 7.39720017e+00
 4.03103541e-01 1.27813723e+00 1.36279235e+03 2.41558043e+04
 6.65171508e+02 9.85488228e+03 3.03270627e+02 3.69209042e+03
 3.16102375e+02 3.88838350e+03 4.96618824e+01 3.84603617e+02
 5.84644509e+00 2.65215704e+01 1.61235807e+01 9.42564895e+01
 6.34137763e-01 1.65087394e+00 2.21443233e+00 7.88065672e+00
 1.88521163e-01 3.62396947e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982716003602796
cond(S) = 86504.16733092224
E1 = -728.4654022383423  E_coul = 203.15500072186077
init E= -525.310401516482
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.556802477677599  LUMO = 0.789924563226958
  mo_energy =
[-1.18106512e+02 -1.21378558e+01 -9.44603408e+00 -9.44603408e+00
 -9.44603408e+00 -1.22567444e+00 -5.56802478e-01 -5.56802478e-01
 -5.56802478e-01  7.89924563e-01  7.89924563e-01  7.89924563e-01
  5.35320055e+00  5.35320055e+00  5.35320055e+00  2.48373968e+01
  2.48373968e+01  2.48373968e+01  2.58656150e+01  9.88715793e+01
  9.88715793e+01  9.88715793e+01  2.65296040e+02  4.30744153e+02
  4.30744153e+02  4.30744153e+02  1.28341983e+03  1.28341983e+03
  1.28341983e+03  1.99411798e+03  2.98477678e+03  2.98477678e+03
  2.98477678e+03  6.61314690e+03  6.61314690e+03  6.61314690e+03
  8.34554505e+03  2.47292407e+04  7.55207268e+04]
E1 = -727.4002761208925  E_coul = 201.28945296434654
cycle= 1 E= -526.110823156546  delta_E= -0.8  |g|= 0.211  |ddm|= 0.661
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.552196
diis-c [-0.30492097  1.        ]
  HOMO = -0.581291716059081  LUMO = 0.778770165416274
  mo_energy =
[-1.18410196e+02 -1.22620657e+01 -9.57844162e+00 -9.57844162e+00
 -9.57844162e+00 -1.25956151e+00 -5.81291716e-01 -5.81291716e-01
 -5.81291716e-01  7.78770165e-01  7.78770165e-01  7.78770165e-01
  5.29116241e+00  5.29116241e+00  5.29116241e+00  2.47125754e+01
  2.47125754e+01  2.47125754e+01  2.57273907e+01  9.86696130e+01
  9.86696130e+01  9.86696130e+01  2.65008835e+02  4.30439821e+02
  4.30439821e+02  4.30439821e+02  1.28305141e+03  1.28305141e+03
  1.28305141e+03  1.99360283e+03  2.98433364e+03  2.98433364e+03
  2.98433364e+03  6.61256585e+03  6.61256585e+03  6.61256585e+03
  8.34486827e+03  2.47284579e+04  7.55198439e+04]
E1 = -727.8208339867083  E_coul = 201.70948174980938
cycle= 2 E= -526.111352236899  delta_E= -0.000529  |g|= 0.0313  |ddm|= 0.0317
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0599679
diis-c [-0.00228267  0.06180747  0.93819253]
  HOMO = -0.575302856315657  LUMO = 0.782208663506962
  mo_energy =
[-1.18354942e+02 -1.22337345e+01 -9.54919754e+00 -9.54919754e+00
 -9.54919754e+00 -1.25175778e+00 -5.75302856e-01 -5.75302856e-01
 -5.75302856e-01  7.82208664e-01  7.82208664e-01  7.82208664e-01
  5.30497406e+00  5.30497406e+00  5.30497406e+00  2.47394788e+01
  2.47394788e+01  2.47394788e+01  2.57599171e+01  9.87116110e+01
  9.87116110e+01  9.87116110e+01  2.65061865e+02  4.30494409e+02
  4.30494409e+02  4.30494409e+02  1.28310984e+03  1.28310984e+03
  1.28310984e+03  1.99366389e+03  2.98439400e+03  2.98439400e+03
  2.98439400e+03  6.61262758e+03  6.61262758e+03  6.61262758e+03
  8.34493063e+03  2.47285206e+04  7.55199067e+04]
E1 = -727.7276103832911  E_coul = 201.616230981169
cycle= 3 E= -526.111379402122  delta_E= -2.72e-05  |g|= 0.00444  |ddm|= 0.00789
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00920776
diis-c [-3.43965587e-07 -1.18397456e-03  1.27718733e-01  8.73465241e-01]
  HOMO = -0.576240064350464  LUMO = 0.781676696568899
  mo_energy =
[-1.18362167e+02 -1.22376462e+01 -9.55331341e+00 -9.55331341e+00
 -9.55331341e+00 -1.25295330e+00 -5.76240064e-01 -5.76240064e-01
 -5.76240064e-01  7.81676697e-01  7.81676697e-01  7.81676697e-01
  5.30290946e+00  5.30290946e+00  5.30290946e+00  2.47356758e+01
  2.47356758e+01  2.47356758e+01  2.57555623e+01  9.87059792e+01
  9.87059792e+01  9.87059792e+01  2.65054916e+02  4.30487266e+02
  4.30487266e+02  4.30487266e+02  1.28310218e+03  1.28310218e+03
  1.28310218e+03  1.99365574e+03  2.98438602e+03  2.98438602e+03
  2.98438602e+03  6.61261928e+03  6.61261928e+03  6.61261928e+03
  8.34492214e+03  2.47285119e+04  7.55198980e+04]
E1 = -727.7404453186829  E_coul = 201.62906524375956
cycle= 4 E= -526.111380074923  delta_E= -6.73e-07  |g|= 3.76e-05  |ddm|= 0.0011
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.67365e-05
diis-c [-2.01281417e-09  3.91634540e-05 -5.19611399e-03 -4.00251262e-02
  1.04518208e+00]
  HOMO = -0.576222683360516  LUMO = 0.781686403544988
  mo_energy =
[-1.18362131e+02 -1.22375918e+01 -9.55326525e+00 -9.55326525e+00
 -9.55326525e+00 -1.25292987e+00 -5.76222683e-01 -5.76222683e-01
 -5.76222683e-01  7.81686404e-01  7.81686404e-01  7.81686404e-01
  5.30294279e+00  5.30294279e+00  5.30294279e+00  2.47357202e+01
  2.47357202e+01  2.47357202e+01  2.57556166e+01  9.87060229e+01
  9.87060229e+01  9.87060229e+01  2.65054953e+02  4.30487302e+02
  4.30487302e+02  4.30487302e+02  1.28310221e+03  1.28310221e+03
  1.28310221e+03  1.99365575e+03  2.98438604e+03  2.98438604e+03
  2.98438604e+03  6.61261929e+03  6.61261929e+03  6.61261929e+03
  8.34492215e+03  2.47285119e+04  7.55198980e+04]
E1 = -727.7403341760469  E_coul = 201.62895410107961
cycle= 5 E= -526.111380074967  delta_E= -4.39e-11  |g|= 8.44e-06  |ddm|= 1.5e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.7403341760469  E_coul = 201.62895410107961
  HOMO = -0.576226967402649  LUMO = 0.781684000042041
  mo_energy =
[-1.18362150e+02 -1.22376062e+01 -9.55328005e+00 -9.55328005e+00
 -9.55328005e+00 -1.25293535e+00 -5.76226967e-01 -5.76226967e-01
 -5.76226967e-01  7.81684000e-01  7.81684000e-01  7.81684000e-01
  5.30293410e+00  5.30293410e+00  5.30293410e+00  2.47357064e+01
  2.47357064e+01  2.47357064e+01  2.57556017e+01  9.87060056e+01
  9.87060056e+01  9.87060056e+01  2.65054934e+02  4.30487283e+02
  4.30487283e+02  4.30487283e+02  1.28310219e+03  1.28310219e+03
  1.28310219e+03  1.99365573e+03  2.98438602e+03  2.98438602e+03
  2.98438602e+03  6.61261927e+03  6.61261927e+03  6.61261927e+03
  8.34492212e+03  2.47285119e+04  7.55198980e+04]
E1 = -727.7403760433941  E_coul = 201.62899596842314
Extra cycle  E= -526.111380074971  delta_E= -3.75e-12  |g|= 2.38e-06  |ddm|= 4.1e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 86504.16733092224
E1 = -727.7403760433941  E_coul = 201.62899596842314
init E= -526.111380074971
    CPU time for initialize scf      2.87 sec, wall time      0.26 sec
  HOMO = -0.576226171846931  LUMO = 0.781684449472599
  mo_energy =
[-1.18362145e+02 -1.22376031e+01 -9.55327690e+00 -9.55327690e+00
 -9.55327690e+00 -1.25293432e+00 -5.76226172e-01 -5.76226172e-01
 -5.76226172e-01  7.81684449e-01  7.81684449e-01  7.81684449e-01
  5.30293580e+00  5.30293580e+00  5.30293580e+00  2.47357094e+01
  2.47357094e+01  2.47357094e+01  2.57556050e+01  9.87060097e+01
  9.87060097e+01  9.87060097e+01  2.65054939e+02  4.30487288e+02
  4.30487288e+02  4.30487288e+02  1.28310220e+03  1.28310220e+03
  1.28310220e+03  1.99365574e+03  2.98438603e+03  2.98438603e+03
  2.98438603e+03  6.61261927e+03  6.61261927e+03  6.61261927e+03
  8.34492213e+03  2.47285119e+04  7.55198980e+04]
E1 = -727.7403666252269  E_coul = 201.62898655025552
cycle= 1 E= -526.111380074971  delta_E= -4.55e-13  |g|= 5.85e-07  |ddm|= 8.58e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.7403666252269  E_coul = 201.62898655025552
  HOMO = -0.576226339301624  LUMO = 0.781684354519617
  mo_energy =
[-1.18362147e+02 -1.22376038e+01 -9.55327760e+00 -9.55327760e+00
 -9.55327760e+00 -1.25293454e+00 -5.76226339e-01 -5.76226339e-01
 -5.76226339e-01  7.81684355e-01  7.81684355e-01  7.81684355e-01
  5.30293543e+00  5.30293543e+00  5.30293543e+00  2.47357087e+01
  2.47357087e+01  2.47357087e+01  2.57556043e+01  9.87060087e+01
  9.87060087e+01  9.87060087e+01  2.65054938e+02  4.30487286e+02
  4.30487286e+02  4.30487286e+02  1.28310220e+03  1.28310220e+03
  1.28310220e+03  1.99365573e+03  2.98438603e+03  2.98438603e+03
  2.98438603e+03  6.61261927e+03  6.61261927e+03  6.61261927e+03
  8.34492213e+03  2.47285119e+04  7.55198980e+04]
E1 = -727.7403687879319  E_coul = 201.62898871296085
Extra cycle  E= -526.111380074971  delta_E= 3.41e-13  |g|= 1.39e-07  |ddm|= 1.91e-07
    CPU time for scf_cycle      2.99 sec, wall time      0.38 sec
exp = [2.61825087e+04 7.61824035e+03 3.61822895e+03 1.61792520e+03
 2.41186221e+02 5.92565213e+01 1.59091757e+01 4.18860875e+00
 4.03103541e-01 1.36279235e+03 6.65171508e+02 3.03270627e+02
 3.16102375e+02 4.96618824e+01 5.84644509e+00 1.61235807e+01
 6.34137763e-01 2.21443233e+00 1.88521163e-01]
grad_E = [-1.96486699e-06  2.51555636e-05  5.42715214e-05  7.96287973e-04
 -7.76277388e-03 -5.80553294e-04 -1.33785292e-03 -1.48339790e-02
  9.93680584e-02  1.78465089e-06  2.31824775e-05  1.27697440e-04
  1.12502196e-04 -2.92521860e-03  6.22772216e-04  2.59312931e-03
 -8.26749072e-02  5.59818837e-03  2.00552956e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:41:29 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5091449        1
[INPUT] 0    0    [1    /1   ]  7618.23476456        1
[INPUT] 0    0    [1    /1   ]  3618.21674287        1
[INPUT] 0    0    [1    /1   ]  1617.74790606        1
[INPUT] 0    0    [1    /1   ]  242.966971399        1
[INPUT] 0    0    [1    /1   ]  59.7228898052        1
[INPUT] 0    0    [1    /1   ]  15.4635343812        1
[INPUT] 0    0    [1    /1   ]  4.15793078273        1
[INPUT] 0    0    [1    /1   ]  0.408459546513       1
[INPUT] 1    0    [1    /1   ]  1362.79190796        1
[INPUT] 1    0    [1    /1   ]  665.166081123        1
[INPUT] 1    0    [1    /1   ]  303.24058866         1
[INPUT] 1    0    [1    /1   ]  316.075891516        1
[INPUT] 1    0    [1    /1   ]  50.3549316631        1
[INPUT] 1    0    [1    /1   ]  5.59577812454        1
[INPUT] 1    0    [1    /1   ]  15.8366837614        1
[INPUT] 1    0    [1    /1   ]  0.594267083824       1
[INPUT] 1    0    [1    /1   ]  2.07623711272        1
[INPUT] 1    0    [1    /1   ]  0.17655007132        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.509144932843, 1.0]], [0, [7618.234764560223, 1.0]], [0, [3618.2167428662738, 1.0]], [0, [1617.7479060620049, 1.0]], [0, [242.96697139853944, 1.0]], [0, [59.72288980516358, 1.0]], [0, [15.463534381192344, 1.0]], [0, [4.157930782733938, 1.0]], [0, [0.4084595465132627, 1.0]], [1, [1362.7919079592039, 1.0]], [1, [665.1660811228232, 1.0]], [1, [303.24058866042213, 1.0]], [1, [316.0758915156484, 1.0]], [1, [50.354931663052724, 1.0]], [1, [5.595778124540215, 1.0]], [1, [15.836683761423942, 1.0]], [1, [0.5942670838240168, 1.0]], [1, [2.0762371127193555, 1.0]], [1, [0.1765500713195591, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50914493]
bas 1, expnt(s) = [7618.23476456]
bas 2, expnt(s) = [3618.21674287]
bas 3, expnt(s) = [1617.74790606]
bas 4, expnt(s) = [242.9669714]
bas 5, expnt(s) = [59.72288981]
bas 6, expnt(s) = [15.46353438]
bas 7, expnt(s) = [4.15793078]
bas 8, expnt(s) = [0.40845955]
bas 9, expnt(s) = [1362.79190796]
bas 10, expnt(s) = [665.16608112]
bas 11, expnt(s) = [303.24058866]
bas 12, expnt(s) = [316.07589152]
bas 13, expnt(s) = [50.35493166]
bas 14, expnt(s) = [5.59577812]
bas 15, expnt(s) = [15.83668376]
bas 16, expnt(s) = [0.59426708]
bas 17, expnt(s) = [2.07623711]
bas 18, expnt(s) = [0.17655007]
CPU time:       313.82
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825091e+04 5.20024101e+03 7.61823476e+03 2.06018295e+03
 3.61821674e+03 1.17865298e+03 1.61774791e+03 6.44463253e+02
 2.42966971e+02 1.55480330e+02 5.97228898e+01 5.42775998e+01
 1.54635344e+01 1.97013777e+01 4.15793078e+00 7.35652924e+00
 4.08459547e-01 1.29085307e+00 1.36279191e+03 2.41557944e+04
 6.65166081e+02 9.85478177e+03 3.03240589e+02 3.69163331e+03
 3.16075892e+02 3.88797628e+03 5.03549317e+01 3.91324380e+02
 5.59577812e+00 2.51078775e+01 1.58366838e+01 9.21647179e+01
 5.94267084e-01 1.52216414e+00 2.07623711e+00 7.27077290e+00
 1.76550071e-01 3.33863748e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982228489454116
cond(S) = 86542.27161784633
E1 = -728.5110199369087  E_coul = 203.20147957908137
init E= -525.309540357827
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.555325509788055  LUMO = 0.718960953065029
  mo_energy =
[-1.18108020e+02 -1.21351324e+01 -9.44257615e+00 -9.44257615e+00
 -9.44257615e+00 -1.22365629e+00 -5.55325510e-01 -5.55325510e-01
 -5.55325510e-01  7.18960953e-01  7.18960953e-01  7.18960953e-01
  4.90310582e+00  4.90310582e+00  4.90310582e+00  2.34130267e+01
  2.34130267e+01  2.34130267e+01  2.51665984e+01  9.72715865e+01
  9.72715865e+01  9.72715865e+01  2.65739660e+02  4.30717160e+02
  4.30717160e+02  4.30717160e+02  1.28382290e+03  1.28382290e+03
  1.28382290e+03  1.99948052e+03  2.98521789e+03  2.98521789e+03
  2.98521789e+03  6.61354147e+03  6.61354147e+03  6.61354147e+03
  8.35161028e+03  2.47350664e+04  7.55261268e+04]
E1 = -727.3988808944345  E_coul = 201.27773471888437
cycle= 1 E= -526.12114617555  delta_E= -0.812  |g|= 0.214  |ddm|= 0.548
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.552321
diis-c [-0.30505855  1.        ]
  HOMO = -0.581263801323205  LUMO = 0.708614939109884
  mo_energy =
[-1.18416255e+02 -1.22632661e+01 -9.57960794e+00 -9.57960794e+00
 -9.57960794e+00 -1.25992508e+00 -5.81263801e-01 -5.81263801e-01
 -5.81263801e-01  7.08614939e-01  7.08614939e-01  7.08614939e-01
  4.84128096e+00  4.84128096e+00  4.84128096e+00  2.32855349e+01
  2.32855349e+01  2.32855349e+01  2.50247652e+01  9.70638564e+01
  9.70638564e+01  9.70638564e+01  2.65446792e+02  4.30408031e+02
  4.30408031e+02  4.30408031e+02  1.28345104e+03  1.28345104e+03
  1.28345104e+03  1.99896518e+03  2.98477327e+03  2.98477327e+03
  2.98477327e+03  6.61296115e+03  6.61296115e+03  6.61296115e+03
  8.35093568e+03  2.47342867e+04  7.55252478e+04]
E1 = -727.8335790149954  E_coul = 201.71187846697205
cycle= 2 E= -526.121700548023  delta_E= -0.000554  |g|= 0.0322  |ddm|= 0.0322
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0608136
diis-c [-0.00233964  0.06278757  0.93721243]
  HOMO = -0.57503043314815  LUMO = 0.711861780857758
  mo_energy =
[-1.18359521e+02 -1.22340017e+01 -9.54939586e+00 -9.54939586e+00
 -9.54939586e+00 -1.25176005e+00 -5.75030433e-01 -5.75030433e-01
 -5.75030433e-01  7.11861781e-01  7.11861781e-01  7.11861781e-01
  4.85494943e+00  4.85494943e+00  4.85494943e+00  2.33129622e+01
  2.33129622e+01  2.33129622e+01  2.50580122e+01  9.71072360e+01
  9.71072360e+01  9.71072360e+01  2.65501316e+02  4.30464126e+02
  4.30464126e+02  4.30464126e+02  1.28351102e+03  1.28351102e+03
  1.28351102e+03  1.99902783e+03  2.98483521e+03  2.98483521e+03
  2.98483521e+03  6.61302449e+03  6.61302449e+03  6.61302449e+03
  8.35099967e+03  2.47343510e+04  7.55253123e+04]
E1 = -727.7363584586288  E_coul = 201.61462884171604
cycle= 3 E= -526.121729616913  delta_E= -2.91e-05  |g|= 0.00459  |ddm|= 0.00813
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00941086
diis-c [-3.74063332e-07 -1.18322541e-03  1.28691584e-01  8.72491641e-01]
  HOMO = -0.576013370271297  LUMO = 0.711354344594848
  mo_energy =
[-1.18366980e+02 -1.22380570e+01 -9.55366604e+00 -9.55366604e+00
 -9.55366604e+00 -1.25301915e+00 -5.76013370e-01 -5.76013370e-01
 -5.76013370e-01  7.11354345e-01  7.11354345e-01  7.11354345e-01
  4.85288796e+00  4.85288796e+00  4.85288796e+00  2.33090611e+01
  2.33090611e+01  2.33090611e+01  2.50535346e+01  9.71013908e+01
  9.71013908e+01  9.71013908e+01  2.65494131e+02  4.30456745e+02
  4.30456745e+02  4.30456745e+02  1.28350311e+03  1.28350311e+03
  1.28350311e+03  1.99901942e+03  2.98482697e+03  2.98482697e+03
  2.98482697e+03  6.61301592e+03  6.61301592e+03  6.61301592e+03
  8.35099090e+03  2.47343421e+04  7.55253032e+04]
E1 = -727.7497750079038  E_coul = 201.62804466349544
cycle= 4 E= -526.121730344408  delta_E= -7.27e-07  |g|= 3.93e-05  |ddm|= 0.00113
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=7.24392e-05
diis-c [-2.12882480e-09  4.02163793e-05 -5.32921843e-03 -4.12500586e-02
  1.04653906e+00]
  HOMO = -0.575996677926354  LUMO = 0.711362798910235
  mo_energy =
[-1.18366948e+02 -1.22380038e+01 -9.55361959e+00 -9.55361959e+00
 -9.55361959e+00 -1.25299629e+00 -5.75996678e-01 -5.75996678e-01
 -5.75996678e-01  7.11362799e-01  7.11362799e-01  7.11362799e-01
  4.85291903e+00  4.85291903e+00  4.85291903e+00  2.33091035e+01
  2.33091035e+01  2.33091035e+01  2.50535873e+01  9.71014317e+01
  9.71014317e+01  9.71014317e+01  2.65494164e+02  4.30456777e+02
  4.30456777e+02  4.30456777e+02  1.28350314e+03  1.28350314e+03
  1.28350314e+03  1.99901943e+03  2.98482699e+03  2.98482699e+03
  2.98482699e+03  6.61301593e+03  6.61301593e+03  6.61301593e+03
  8.35099090e+03  2.47343421e+04  7.55253032e+04]
E1 = -727.7496657969916  E_coul = 201.6279354525383
cycle= 5 E= -526.121730344453  delta_E= -4.49e-11  |g|= 8.77e-06  |ddm|= 1.55e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -727.7496657969916  E_coul = 201.6279354525383
  HOMO = -0.576001176821521  LUMO = 0.711360495400502
  mo_energy =
[-1.18366968e+02 -1.22380187e+01 -9.55363499e+00 -9.55363499e+00
 -9.55363499e+00 -1.25300207e+00 -5.76001177e-01 -5.76001177e-01
 -5.76001177e-01  7.11360495e-01  7.11360495e-01  7.11360495e-01
  4.85291030e+00  4.85291030e+00  4.85291030e+00  2.33090893e+01
  2.33090893e+01  2.33090893e+01  2.50535719e+01  9.71014137e+01
  9.71014137e+01  9.71014137e+01  2.65494144e+02  4.30456757e+02
  4.30456757e+02  4.30456757e+02  1.28350312e+03  1.28350312e+03
  1.28350312e+03  1.99901941e+03  2.98482697e+03  2.98482697e+03
  2.98482697e+03  6.61301591e+03  6.61301591e+03  6.61301591e+03
  8.35099088e+03  2.47343421e+04  7.55253032e+04]
E1 = -727.7497097289651  E_coul = 201.62797938450666
Extra cycle  E= -526.121730344458  delta_E= -5.12e-12  |g|= 2.49e-06  |ddm|= 4.2e-06
    CPU time for scf_cycle      0.69 sec, wall time      0.30 sec
exp = [2.61825091e+04 7.61823476e+03 3.61821674e+03 1.61774791e+03
 2.42966971e+02 5.97228898e+01 1.54635344e+01 4.15793078e+00
 4.08459547e-01 1.36279191e+03 6.65166081e+02 3.03240589e+02
 3.16075892e+02 5.03549317e+01 5.59577812e+00 1.58366838e+01
 5.94267084e-01 2.07623711e+00 1.76550071e-01]
E = -526.1217303444585
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:41:30 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5091449        1
[INPUT] 0    0    [1    /1   ]  7618.23476456        1
[INPUT] 0    0    [1    /1   ]  3618.21674287        1
[INPUT] 0    0    [1    /1   ]  1617.74790606        1
[INPUT] 0    0    [1    /1   ]  242.966971399        1
[INPUT] 0    0    [1    /1   ]  59.7228898052        1
[INPUT] 0    0    [1    /1   ]  15.4635343812        1
[INPUT] 0    0    [1    /1   ]  4.15793078273        1
[INPUT] 0    0    [1    /1   ]  0.408459546513       1
[INPUT] 1    0    [1    /1   ]  1362.79190796        1
[INPUT] 1    0    [1    /1   ]  665.166081123        1
[INPUT] 1    0    [1    /1   ]  303.24058866         1
[INPUT] 1    0    [1    /1   ]  316.075891516        1
[INPUT] 1    0    [1    /1   ]  50.3549316631        1
[INPUT] 1    0    [1    /1   ]  5.59577812454        1
[INPUT] 1    0    [1    /1   ]  15.8366837614        1
[INPUT] 1    0    [1    /1   ]  0.594267083824       1
[INPUT] 1    0    [1    /1   ]  2.07623711272        1
[INPUT] 1    0    [1    /1   ]  0.17655007132        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.509144932843, 1.0]], [0, [7618.234764560223, 1.0]], [0, [3618.2167428662738, 1.0]], [0, [1617.7479060620049, 1.0]], [0, [242.96697139853944, 1.0]], [0, [59.72288980516358, 1.0]], [0, [15.463534381192344, 1.0]], [0, [4.157930782733938, 1.0]], [0, [0.4084595465132627, 1.0]], [1, [1362.7919079592039, 1.0]], [1, [665.1660811228232, 1.0]], [1, [303.24058866042213, 1.0]], [1, [316.0758915156484, 1.0]], [1, [50.354931663052724, 1.0]], [1, [5.595778124540215, 1.0]], [1, [15.836683761423942, 1.0]], [1, [0.5942670838240168, 1.0]], [1, [2.0762371127193555, 1.0]], [1, [0.1765500713195591, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.50914493]
bas 1, expnt(s) = [7618.23476456]
bas 2, expnt(s) = [3618.21674287]
bas 3, expnt(s) = [1617.74790606]
bas 4, expnt(s) = [242.9669714]
bas 5, expnt(s) = [59.72288981]
bas 6, expnt(s) = [15.46353438]
bas 7, expnt(s) = [4.15793078]
bas 8, expnt(s) = [0.40845955]
bas 9, expnt(s) = [1362.79190796]
bas 10, expnt(s) = [665.16608112]
bas 11, expnt(s) = [303.24058866]
bas 12, expnt(s) = [316.07589152]
bas 13, expnt(s) = [50.35493166]
bas 14, expnt(s) = [5.59577812]
bas 15, expnt(s) = [15.83668376]
bas 16, expnt(s) = [0.59426708]
bas 17, expnt(s) = [2.07623711]
bas 18, expnt(s) = [0.17655007]
CPU time:       314.68
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825091e+04 5.20024101e+03 7.61823476e+03 2.06018295e+03
 3.61821674e+03 1.17865298e+03 1.61774791e+03 6.44463253e+02
 2.42966971e+02 1.55480330e+02 5.97228898e+01 5.42775998e+01
 1.54635344e+01 1.97013777e+01 4.15793078e+00 7.35652924e+00
 4.08459547e-01 1.29085307e+00 1.36279191e+03 2.41557944e+04
 6.65166081e+02 9.85478177e+03 3.03240589e+02 3.69163331e+03
 3.16075892e+02 3.88797628e+03 5.03549317e+01 3.91324380e+02
 5.59577812e+00 2.51078775e+01 1.58366838e+01 9.21647179e+01
 5.94267084e-01 1.52216414e+00 2.07623711e+00 7.27077290e+00
 1.76550071e-01 3.33863748e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982228489454116
cond(S) = 86542.27161784633
E1 = -728.5110199369087  E_coul = 203.20147957908137
init E= -525.309540357827
    CPU time for initialize scf      0.45 sec, wall time      0.05 sec
  HOMO = -0.555325509788055  LUMO = 0.718960953065029
  mo_energy =
[-1.18108020e+02 -1.21351324e+01 -9.44257615e+00 -9.44257615e+00
 -9.44257615e+00 -1.22365629e+00 -5.55325510e-01 -5.55325510e-01
 -5.55325510e-01  7.18960953e-01  7.18960953e-01  7.18960953e-01
  4.90310582e+00  4.90310582e+00  4.90310582e+00  2.34130267e+01
  2.34130267e+01  2.34130267e+01  2.51665984e+01  9.72715865e+01
  9.72715865e+01  9.72715865e+01  2.65739660e+02  4.30717160e+02
  4.30717160e+02  4.30717160e+02  1.28382290e+03  1.28382290e+03
  1.28382290e+03  1.99948052e+03  2.98521789e+03  2.98521789e+03
  2.98521789e+03  6.61354147e+03  6.61354147e+03  6.61354147e+03
  8.35161028e+03  2.47350664e+04  7.55261268e+04]
E1 = -727.3988808944345  E_coul = 201.27773471888437
cycle= 1 E= -526.12114617555  delta_E= -0.812  |g|= 0.214  |ddm|= 0.548
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.552321
diis-c [-0.30505855  1.        ]
  HOMO = -0.581263801323205  LUMO = 0.708614939109884
  mo_energy =
[-1.18416255e+02 -1.22632661e+01 -9.57960794e+00 -9.57960794e+00
 -9.57960794e+00 -1.25992508e+00 -5.81263801e-01 -5.81263801e-01
 -5.81263801e-01  7.08614939e-01  7.08614939e-01  7.08614939e-01
  4.84128096e+00  4.84128096e+00  4.84128096e+00  2.32855349e+01
  2.32855349e+01  2.32855349e+01  2.50247652e+01  9.70638564e+01
  9.70638564e+01  9.70638564e+01  2.65446792e+02  4.30408031e+02
  4.30408031e+02  4.30408031e+02  1.28345104e+03  1.28345104e+03
  1.28345104e+03  1.99896518e+03  2.98477327e+03  2.98477327e+03
  2.98477327e+03  6.61296115e+03  6.61296115e+03  6.61296115e+03
  8.35093568e+03  2.47342867e+04  7.55252478e+04]
E1 = -727.8335790149954  E_coul = 201.71187846697205
cycle= 2 E= -526.121700548023  delta_E= -0.000554  |g|= 0.0322  |ddm|= 0.0322
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0608136
diis-c [-0.00233964  0.06278757  0.93721243]
  HOMO = -0.57503043314815  LUMO = 0.711861780857758
  mo_energy =
[-1.18359521e+02 -1.22340017e+01 -9.54939586e+00 -9.54939586e+00
 -9.54939586e+00 -1.25176005e+00 -5.75030433e-01 -5.75030433e-01
 -5.75030433e-01  7.11861781e-01  7.11861781e-01  7.11861781e-01
  4.85494943e+00  4.85494943e+00  4.85494943e+00  2.33129622e+01
  2.33129622e+01  2.33129622e+01  2.50580122e+01  9.71072360e+01
  9.71072360e+01  9.71072360e+01  2.65501316e+02  4.30464126e+02
  4.30464126e+02  4.30464126e+02  1.28351102e+03  1.28351102e+03
  1.28351102e+03  1.99902783e+03  2.98483521e+03  2.98483521e+03
  2.98483521e+03  6.61302449e+03  6.61302449e+03  6.61302449e+03
  8.35099967e+03  2.47343510e+04  7.55253123e+04]
E1 = -727.7363584586288  E_coul = 201.61462884171604
cycle= 3 E= -526.121729616913  delta_E= -2.91e-05  |g|= 0.00459  |ddm|= 0.00813
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00941086
diis-c [-3.74063332e-07 -1.18322541e-03  1.28691584e-01  8.72491641e-01]
  HOMO = -0.576013370271297  LUMO = 0.711354344594848
  mo_energy =
[-1.18366980e+02 -1.22380570e+01 -9.55366604e+00 -9.55366604e+00
 -9.55366604e+00 -1.25301915e+00 -5.76013370e-01 -5.76013370e-01
 -5.76013370e-01  7.11354345e-01  7.11354345e-01  7.11354345e-01
  4.85288796e+00  4.85288796e+00  4.85288796e+00  2.33090611e+01
  2.33090611e+01  2.33090611e+01  2.50535346e+01  9.71013908e+01
  9.71013908e+01  9.71013908e+01  2.65494131e+02  4.30456745e+02
  4.30456745e+02  4.30456745e+02  1.28350311e+03  1.28350311e+03
  1.28350311e+03  1.99901942e+03  2.98482697e+03  2.98482697e+03
  2.98482697e+03  6.61301592e+03  6.61301592e+03  6.61301592e+03
  8.35099090e+03  2.47343421e+04  7.55253032e+04]
E1 = -727.7497750079038  E_coul = 201.62804466349544
cycle= 4 E= -526.121730344408  delta_E= -7.27e-07  |g|= 3.93e-05  |ddm|= 0.00113
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.24392e-05
diis-c [-2.12882480e-09  4.02163793e-05 -5.32921843e-03 -4.12500586e-02
  1.04653906e+00]
  HOMO = -0.575996677926354  LUMO = 0.711362798910235
  mo_energy =
[-1.18366948e+02 -1.22380038e+01 -9.55361959e+00 -9.55361959e+00
 -9.55361959e+00 -1.25299629e+00 -5.75996678e-01 -5.75996678e-01
 -5.75996678e-01  7.11362799e-01  7.11362799e-01  7.11362799e-01
  4.85291903e+00  4.85291903e+00  4.85291903e+00  2.33091035e+01
  2.33091035e+01  2.33091035e+01  2.50535873e+01  9.71014317e+01
  9.71014317e+01  9.71014317e+01  2.65494164e+02  4.30456777e+02
  4.30456777e+02  4.30456777e+02  1.28350314e+03  1.28350314e+03
  1.28350314e+03  1.99901943e+03  2.98482699e+03  2.98482699e+03
  2.98482699e+03  6.61301593e+03  6.61301593e+03  6.61301593e+03
  8.35099090e+03  2.47343421e+04  7.55253032e+04]
E1 = -727.7496657969916  E_coul = 201.6279354525383
cycle= 5 E= -526.121730344453  delta_E= -4.49e-11  |g|= 8.77e-06  |ddm|= 1.55e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.05 sec
E1 = -727.7496657969916  E_coul = 201.6279354525383
  HOMO = -0.576001176821521  LUMO = 0.711360495400502
  mo_energy =
[-1.18366968e+02 -1.22380187e+01 -9.55363499e+00 -9.55363499e+00
 -9.55363499e+00 -1.25300207e+00 -5.76001177e-01 -5.76001177e-01
 -5.76001177e-01  7.11360495e-01  7.11360495e-01  7.11360495e-01
  4.85291030e+00  4.85291030e+00  4.85291030e+00  2.33090893e+01
  2.33090893e+01  2.33090893e+01  2.50535719e+01  9.71014137e+01
  9.71014137e+01  9.71014137e+01  2.65494144e+02  4.30456757e+02
  4.30456757e+02  4.30456757e+02  1.28350312e+03  1.28350312e+03
  1.28350312e+03  1.99901941e+03  2.98482697e+03  2.98482697e+03
  2.98482697e+03  6.61301591e+03  6.61301591e+03  6.61301591e+03
  8.35099088e+03  2.47343421e+04  7.55253032e+04]
E1 = -727.7497097289651  E_coul = 201.62797938450666
Extra cycle  E= -526.121730344458  delta_E= -5.12e-12  |g|= 2.49e-06  |ddm|= 4.2e-06
    CPU time for scf_cycle      0.68 sec, wall time      0.30 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 86542.27161784633
E1 = -727.7497097289651  E_coul = 201.62797938450666
init E= -526.121730344458
    CPU time for initialize scf      2.74 sec, wall time      0.25 sec
  HOMO = -0.576000339413287  LUMO = 0.711360925723303
  mo_energy =
[-1.18366963e+02 -1.22380155e+01 -9.55363168e+00 -9.55363168e+00
 -9.55363168e+00 -1.25300098e+00 -5.76000339e-01 -5.76000339e-01
 -5.76000339e-01  7.11360926e-01  7.11360926e-01  7.11360926e-01
  4.85291200e+00  4.85291200e+00  4.85291200e+00  2.33090924e+01
  2.33090924e+01  2.33090924e+01  2.50535753e+01  9.71014180e+01
  9.71014180e+01  9.71014180e+01  2.65494149e+02  4.30456762e+02
  4.30456762e+02  4.30456762e+02  1.28350312e+03  1.28350312e+03
  1.28350312e+03  1.99901941e+03  2.98482698e+03  2.98482698e+03
  2.98482698e+03  6.61301591e+03  6.61301591e+03  6.61301591e+03
  8.35099089e+03  2.47343421e+04  7.55253032e+04]
E1 = -727.7496997377153  E_coul = 201.6279693932562
cycle= 1 E= -526.121730344459  delta_E= -6.82e-13  |g|= 6.18e-07  |ddm|= 8.97e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.7496997377153  E_coul = 201.6279693932562
  HOMO = -0.57600051831286  LUMO = 0.711360833443291
  mo_energy =
[-1.18366964e+02 -1.22380162e+01 -9.55363243e+00 -9.55363243e+00
 -9.55363243e+00 -1.25300121e+00 -5.76000518e-01 -5.76000518e-01
 -5.76000518e-01  7.11360833e-01  7.11360833e-01  7.11360833e-01
  4.85291163e+00  4.85291163e+00  4.85291163e+00  2.33090917e+01
  2.33090917e+01  2.33090917e+01  2.50535746e+01  9.71014170e+01
  9.71014170e+01  9.71014170e+01  2.65494148e+02  4.30456761e+02
  4.30456761e+02  4.30456761e+02  1.28350312e+03  1.28350312e+03
  1.28350312e+03  1.99901941e+03  2.98482697e+03  2.98482697e+03
  2.98482697e+03  6.61301591e+03  6.61301591e+03  6.61301591e+03
  8.35099089e+03  2.47343421e+04  7.55253032e+04]
E1 = -727.749702052492  E_coul = 201.6279717080334
Extra cycle  E= -526.121730344459  delta_E= 5.68e-13  |g|= 1.48e-07  |ddm|= 2.01e-07
    CPU time for scf_cycle      2.88 sec, wall time      0.39 sec
exp = [2.61825091e+04 7.61823476e+03 3.61821674e+03 1.61774791e+03
 2.42966971e+02 5.97228898e+01 1.54635344e+01 4.15793078e+00
 4.08459547e-01 1.36279191e+03 6.65166081e+02 3.03240589e+02
 3.16075892e+02 5.03549317e+01 5.59577812e+00 1.58366838e+01
 5.94267084e-01 2.07623711e+00 1.76550071e-01]
grad_E = [-1.96904618e-06  2.46119297e-05  5.24797225e-05  7.78231109e-04
 -7.76424427e-03  2.75768525e-03 -3.86686285e-03 -2.89441032e-02
  1.68346055e-01  1.22346499e-06  1.92372890e-05  1.04201805e-04
  9.16965088e-05 -1.47297772e-03  1.59197435e-04 -2.03573368e-04
 -1.13313306e-01  1.11235169e-02  8.41857432e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:41:34 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5100011        1
[INPUT] 0    0    [1    /1   ]  7618.2236206         1
[INPUT] 0    0    [1    /1   ]  3618.19250614        1
[INPUT] 0    0    [1    /1   ]  1617.39495953        1
[INPUT] 0    0    [1    /1   ]  246.297785682        1
[INPUT] 0    0    [1    /1   ]  61.4386693014        1
[INPUT] 0    0    [1    /1   ]  15.8835386689        1
[INPUT] 0    0    [1    /1   ]  4.17846290094        1
[INPUT] 0    0    [1    /1   ]  0.411182871854       1
[INPUT] 1    0    [1    /1   ]  1362.79104079        1
[INPUT] 1    0    [1    /1   ]  665.155378821        1
[INPUT] 1    0    [1    /1   ]  303.181478692        1
[INPUT] 1    0    [1    /1   ]  316.023778067        1
[INPUT] 1    0    [1    /1   ]  51.6197586057        1
[INPUT] 1    0    [1    /1   ]  5.28438918694        1
[INPUT] 1    0    [1    /1   ]  15.5314185389        1
[INPUT] 1    0    [1    /1   ]  0.562596495163       1
[INPUT] 1    0    [1    /1   ]  1.86193084745        1
[INPUT] 1    0    [1    /1   ]  0.167500381839       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.510001114784, 1.0]], [0, [7618.223620598824, 1.0]], [0, [3618.1925061421593, 1.0]], [0, [1617.39495952799, 1.0]], [0, [246.29778568203375, 1.0]], [0, [61.43866930141047, 1.0]], [0, [15.8835386688811, 1.0]], [0, [4.178462900939615, 1.0]], [0, [0.4111828718541977, 1.0]], [1, [1362.7910407903887, 1.0]], [1, [665.1553788209511, 1.0]], [1, [303.1814786918044, 1.0]], [1, [316.023778066993, 1.0]], [1, [51.61975860569728, 1.0]], [1, [5.284389186944194, 1.0]], [1, [15.531418538912023, 1.0]], [1, [0.5625964951626333, 1.0]], [1, [1.861930847446706, 1.0]], [1, [0.16750038183940918, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.51000111]
bas 1, expnt(s) = [7618.2236206]
bas 2, expnt(s) = [3618.19250614]
bas 3, expnt(s) = [1617.39495953]
bas 4, expnt(s) = [246.29778568]
bas 5, expnt(s) = [61.4386693]
bas 6, expnt(s) = [15.88353867]
bas 7, expnt(s) = [4.1784629]
bas 8, expnt(s) = [0.41118287]
bas 9, expnt(s) = [1362.79104079]
bas 10, expnt(s) = [665.15537882]
bas 11, expnt(s) = [303.18147869]
bas 12, expnt(s) = [316.02377807]
bas 13, expnt(s) = [51.61975861]
bas 14, expnt(s) = [5.28438919]
bas 15, expnt(s) = [15.53141854]
bas 16, expnt(s) = [0.5625965]
bas 17, expnt(s) = [1.86193085]
bas 18, expnt(s) = [0.16750038]
CPU time:       323.00
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825100e+04 5.20024114e+03 7.61822362e+03 2.06018069e+03
 3.61819251e+03 1.17864706e+03 1.61739496e+03 6.44357797e+02
 2.46297786e+02 1.57076207e+02 6.14386693e+01 5.54429557e+01
 1.58835387e+01 2.01013614e+01 4.17846290e+00 7.38375771e+00
 4.11182872e-01 1.29730259e+00 1.36279104e+03 2.41557752e+04
 6.65155379e+02 9.85458357e+03 3.03181479e+02 3.69073383e+03
 3.16023778e+02 3.88717501e+03 5.16197586e+01 4.03649440e+02
 5.28438919e+00 2.33737227e+01 1.55314185e+01 8.99494053e+01
 5.62596495e-01 1.42144700e+00 1.86193085e+00 6.34510519e+00
 1.67500382e-01 3.12610920e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.981720350991996
cond(S) = 87004.68126554023
E1 = -728.507079429129  E_coul = 203.23272667075224
init E= -525.274352758377
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.554772824762936  LUMO = 0.666033376018727
  mo_energy =
[-1.18119446e+02 -1.21287012e+01 -9.43966962e+00 -9.43966962e+00
 -9.43966962e+00 -1.22216392e+00 -5.54772825e-01 -5.54772825e-01
 -5.54772825e-01  6.66033376e-01  6.66033376e-01  6.66033376e-01
  4.38317161e+00  4.38317161e+00  4.38317161e+00  2.15918652e+01
  2.15918652e+01  2.15918652e+01  2.61831141e+01  9.57288402e+01
  9.57288402e+01  9.57288402e+01  2.73990186e+02  4.31991824e+02
  4.31991824e+02  4.31991824e+02  1.28574846e+03  1.28574846e+03
  1.28574846e+03  2.01710938e+03  2.98712614e+03  2.98712614e+03
  2.98712614e+03  6.61526264e+03  6.61526264e+03  6.61526264e+03
  8.36990183e+03  2.47525251e+04  7.55423262e+04]
E1 = -727.4276554199479  E_coul = 201.28891734293737
cycle= 1 E= -526.138738077011  delta_E= -0.864  |g|= 0.22  |ddm|= 0.395
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.555315
diis-c [-0.30837475  1.        ]
  HOMO = -0.581450546834319  LUMO = 0.656597723799712
  mo_energy =
[-1.18429239e+02 -1.22575344e+01 -9.57820840e+00 -9.57820840e+00
 -9.57820840e+00 -1.25952592e+00 -5.81450547e-01 -5.81450547e-01
 -5.81450547e-01  6.56597724e-01  6.56597724e-01  6.56597724e-01
  4.32502101e+00  4.32502101e+00  4.32502101e+00  2.14652432e+01
  2.14652432e+01  2.14652432e+01  2.60377229e+01  9.55174250e+01
  9.55174250e+01  9.55174250e+01  2.73693109e+02  4.31680817e+02
  4.31680817e+02  4.31680817e+02  1.28537675e+03  1.28537675e+03
  1.28537675e+03  2.01659923e+03  2.98668481e+03  2.98668481e+03
  2.98668481e+03  6.61468858e+03  6.61468858e+03  6.61468858e+03
  8.36923554e+03  2.47517547e+04  7.55414572e+04]
E1 = -727.8656149207582  E_coul = 201.7263054362055
cycle= 2 E= -526.139309484553  delta_E= -0.000571  |g|= 0.0326  |ddm|= 0.0305
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0604716
diis-c [-0.00235449  0.06124059  0.93875941]
  HOMO = -0.575248840239777  LUMO = 0.659546101239772
  mo_energy =
[-1.18371748e+02 -1.22279650e+01 -9.54770297e+00 -9.54770297e+00
 -9.54770297e+00 -1.25134823e+00 -5.75248840e-01 -5.75248840e-01
 -5.75248840e-01  6.59546101e-01  6.59546101e-01  6.59546101e-01
  4.33773058e+00  4.33773058e+00  4.33773058e+00  2.14924165e+01
  2.14924165e+01  2.14924165e+01  2.60718450e+01  9.55616400e+01
  9.55616400e+01  9.55616400e+01  2.73748546e+02  4.31737720e+02
  4.31737720e+02  4.31737720e+02  1.28543754e+03  1.28543754e+03
  1.28543754e+03  2.01666274e+03  2.98674759e+03  2.98674759e+03
  2.98674759e+03  6.61475278e+03  6.61475278e+03  6.61475278e+03
  8.36930040e+03  2.47518199e+04  7.55415226e+04]
E1 = -727.7658603160044  E_coul = 201.6265208435135
cycle= 3 E= -526.139339472491  delta_E= -3e-05  |g|= 0.00473  |ddm|= 0.00813
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00949026
diis-c [-4.50009436e-07 -1.17107658e-03  1.30378625e-01  8.70792451e-01]
  HOMO = -0.576298540056401  LUMO = 0.659047584514013
  mo_energy =
[-1.18379465e+02 -1.22321938e+01 -9.55215290e+00 -9.55215290e+00
 -9.55215290e+00 -1.25269444e+00 -5.76298540e-01 -5.76298540e-01
 -5.76298540e-01  6.59047585e-01  6.59047585e-01  6.59047585e-01
  4.33569629e+00  4.33569629e+00  4.33569629e+00  2.14884099e+01
  2.14884099e+01  2.14884099e+01  2.60671228e+01  9.55555384e+01
  9.55555384e+01  9.55555384e+01  2.73741082e+02  4.31730075e+02
  4.31730075e+02  4.31730075e+02  1.28542936e+03  1.28542936e+03
  1.28542936e+03  2.01665404e+03  2.98673908e+03  2.98673908e+03
  2.98673908e+03  6.61474393e+03  6.61474393e+03  6.61474393e+03
  8.36929135e+03  2.47518107e+04  7.55415132e+04]
E1 = -727.7799200712342  E_coul = 201.64057981046906
cycle= 4 E= -526.139340260765  delta_E= -7.88e-07  |g|= 4.36e-05  |ddm|= 0.00114
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=6.88459e-05
diis-c [-2.73065046e-09  3.26728764e-05 -4.51112595e-03 -3.39448427e-02
  1.03842330e+00]
  HOMO = -0.576280236529283  LUMO = 0.659055838680956
  mo_energy =
[-1.18379419e+02 -1.22321287e+01 -9.55209459e+00 -9.55209459e+00
 -9.55209459e+00 -1.25266881e+00 -5.76280237e-01 -5.76280237e-01
 -5.76280237e-01  6.59055839e-01  6.59055839e-01  6.59055839e-01
  4.33572997e+00  4.33572997e+00  4.33572997e+00  2.14884621e+01
  2.14884621e+01  2.14884621e+01  2.60671876e+01  9.55555920e+01
  9.55555920e+01  9.55555920e+01  2.73741129e+02  4.31730122e+02
  4.31730122e+02  4.31730122e+02  1.28542940e+03  1.28542940e+03
  1.28542940e+03  2.01665407e+03  2.98673911e+03  2.98673911e+03
  2.98673911e+03  6.61474395e+03  6.61474395e+03  6.61474395e+03
  8.36929136e+03  2.47518107e+04  7.55415132e+04]
E1 = -727.7797644732472  E_coul = 201.640424212401
cycle= 5 E= -526.139340260846  delta_E= -8.11e-11  |g|= 1.02e-05  |ddm|= 2.26e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -727.7797644732472  E_coul = 201.640424212401
  HOMO = -0.576285586758869  LUMO = 0.659053304562786
  mo_energy =
[-1.18379442e+02 -1.22321460e+01 -9.55211241e+00 -9.55211241e+00
 -9.55211241e+00 -1.25267566e+00 -5.76285587e-01 -5.76285587e-01
 -5.76285587e-01  6.59053305e-01  6.59053305e-01  6.59053305e-01
  4.33572029e+00  4.33572029e+00  4.33572029e+00  2.14884459e+01
  2.14884459e+01  2.14884459e+01  2.60671696e+01  9.55555712e+01
  9.55555712e+01  9.55555712e+01  2.73741106e+02  4.31730098e+02
  4.31730098e+02  4.31730098e+02  1.28542937e+03  1.28542937e+03
  1.28542937e+03  2.01665404e+03  2.98673908e+03  2.98673908e+03
  2.98673908e+03  6.61474392e+03  6.61474392e+03  6.61474392e+03
  8.36929133e+03  2.47518107e+04  7.55415132e+04]
E1 = -727.779815593366  E_coul = 201.64047533251357
Extra cycle  E= -526.139340260852  delta_E= -6.25e-12  |g|= 2.88e-06  |ddm|= 4.59e-06
    CPU time for scf_cycle      0.69 sec, wall time      0.30 sec
exp = [2.61825100e+04 7.61822362e+03 3.61819251e+03 1.61739496e+03
 2.46297786e+02 6.14386693e+01 1.58835387e+01 4.17846290e+00
 4.11182872e-01 1.36279104e+03 6.65155379e+02 3.03181479e+02
 3.16023778e+02 5.16197586e+01 5.28438919e+00 1.55314185e+01
 5.62596495e-01 1.86193085e+00 1.67500382e-01]
E = -526.1393402608525
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:41:35 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5100011        1
[INPUT] 0    0    [1    /1   ]  7618.2236206         1
[INPUT] 0    0    [1    /1   ]  3618.19250614        1
[INPUT] 0    0    [1    /1   ]  1617.39495953        1
[INPUT] 0    0    [1    /1   ]  246.297785682        1
[INPUT] 0    0    [1    /1   ]  61.4386693014        1
[INPUT] 0    0    [1    /1   ]  15.8835386689        1
[INPUT] 0    0    [1    /1   ]  4.17846290094        1
[INPUT] 0    0    [1    /1   ]  0.411182871854       1
[INPUT] 1    0    [1    /1   ]  1362.79104079        1
[INPUT] 1    0    [1    /1   ]  665.155378821        1
[INPUT] 1    0    [1    /1   ]  303.181478692        1
[INPUT] 1    0    [1    /1   ]  316.023778067        1
[INPUT] 1    0    [1    /1   ]  51.6197586057        1
[INPUT] 1    0    [1    /1   ]  5.28438918694        1
[INPUT] 1    0    [1    /1   ]  15.5314185389        1
[INPUT] 1    0    [1    /1   ]  0.562596495163       1
[INPUT] 1    0    [1    /1   ]  1.86193084745        1
[INPUT] 1    0    [1    /1   ]  0.167500381839       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.510001114784, 1.0]], [0, [7618.223620598824, 1.0]], [0, [3618.1925061421593, 1.0]], [0, [1617.39495952799, 1.0]], [0, [246.29778568203375, 1.0]], [0, [61.43866930141047, 1.0]], [0, [15.8835386688811, 1.0]], [0, [4.178462900939615, 1.0]], [0, [0.4111828718541977, 1.0]], [1, [1362.7910407903887, 1.0]], [1, [665.1553788209511, 1.0]], [1, [303.1814786918044, 1.0]], [1, [316.023778066993, 1.0]], [1, [51.61975860569728, 1.0]], [1, [5.284389186944194, 1.0]], [1, [15.531418538912023, 1.0]], [1, [0.5625964951626333, 1.0]], [1, [1.861930847446706, 1.0]], [1, [0.16750038183940918, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.51000111]
bas 1, expnt(s) = [7618.2236206]
bas 2, expnt(s) = [3618.19250614]
bas 3, expnt(s) = [1617.39495953]
bas 4, expnt(s) = [246.29778568]
bas 5, expnt(s) = [61.4386693]
bas 6, expnt(s) = [15.88353867]
bas 7, expnt(s) = [4.1784629]
bas 8, expnt(s) = [0.41118287]
bas 9, expnt(s) = [1362.79104079]
bas 10, expnt(s) = [665.15537882]
bas 11, expnt(s) = [303.18147869]
bas 12, expnt(s) = [316.02377807]
bas 13, expnt(s) = [51.61975861]
bas 14, expnt(s) = [5.28438919]
bas 15, expnt(s) = [15.53141854]
bas 16, expnt(s) = [0.5625965]
bas 17, expnt(s) = [1.86193085]
bas 18, expnt(s) = [0.16750038]
CPU time:       323.85
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825100e+04 5.20024114e+03 7.61822362e+03 2.06018069e+03
 3.61819251e+03 1.17864706e+03 1.61739496e+03 6.44357797e+02
 2.46297786e+02 1.57076207e+02 6.14386693e+01 5.54429557e+01
 1.58835387e+01 2.01013614e+01 4.17846290e+00 7.38375771e+00
 4.11182872e-01 1.29730259e+00 1.36279104e+03 2.41557752e+04
 6.65155379e+02 9.85458357e+03 3.03181479e+02 3.69073383e+03
 3.16023778e+02 3.88717501e+03 5.16197586e+01 4.03649440e+02
 5.28438919e+00 2.33737227e+01 1.55314185e+01 8.99494053e+01
 5.62596495e-01 1.42144700e+00 1.86193085e+00 6.34510519e+00
 1.67500382e-01 3.12610920e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.981720350991996
cond(S) = 87004.68126554023
E1 = -728.507079429129  E_coul = 203.23272667075224
init E= -525.274352758377
    CPU time for initialize scf      0.45 sec, wall time      0.05 sec
  HOMO = -0.554772824762936  LUMO = 0.666033376018727
  mo_energy =
[-1.18119446e+02 -1.21287012e+01 -9.43966962e+00 -9.43966962e+00
 -9.43966962e+00 -1.22216392e+00 -5.54772825e-01 -5.54772825e-01
 -5.54772825e-01  6.66033376e-01  6.66033376e-01  6.66033376e-01
  4.38317161e+00  4.38317161e+00  4.38317161e+00  2.15918652e+01
  2.15918652e+01  2.15918652e+01  2.61831141e+01  9.57288402e+01
  9.57288402e+01  9.57288402e+01  2.73990186e+02  4.31991824e+02
  4.31991824e+02  4.31991824e+02  1.28574846e+03  1.28574846e+03
  1.28574846e+03  2.01710938e+03  2.98712614e+03  2.98712614e+03
  2.98712614e+03  6.61526264e+03  6.61526264e+03  6.61526264e+03
  8.36990183e+03  2.47525251e+04  7.55423262e+04]
E1 = -727.4276554199479  E_coul = 201.28891734293737
cycle= 1 E= -526.138738077011  delta_E= -0.864  |g|= 0.22  |ddm|= 0.395
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.555315
diis-c [-0.30837475  1.        ]
  HOMO = -0.581450546834319  LUMO = 0.656597723799712
  mo_energy =
[-1.18429239e+02 -1.22575344e+01 -9.57820840e+00 -9.57820840e+00
 -9.57820840e+00 -1.25952592e+00 -5.81450547e-01 -5.81450547e-01
 -5.81450547e-01  6.56597724e-01  6.56597724e-01  6.56597724e-01
  4.32502101e+00  4.32502101e+00  4.32502101e+00  2.14652432e+01
  2.14652432e+01  2.14652432e+01  2.60377229e+01  9.55174250e+01
  9.55174250e+01  9.55174250e+01  2.73693109e+02  4.31680817e+02
  4.31680817e+02  4.31680817e+02  1.28537675e+03  1.28537675e+03
  1.28537675e+03  2.01659923e+03  2.98668481e+03  2.98668481e+03
  2.98668481e+03  6.61468858e+03  6.61468858e+03  6.61468858e+03
  8.36923554e+03  2.47517547e+04  7.55414572e+04]
E1 = -727.8656149207582  E_coul = 201.7263054362055
cycle= 2 E= -526.139309484553  delta_E= -0.000571  |g|= 0.0326  |ddm|= 0.0305
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0604716
diis-c [-0.00235449  0.06124059  0.93875941]
  HOMO = -0.575248840239777  LUMO = 0.659546101239772
  mo_energy =
[-1.18371748e+02 -1.22279650e+01 -9.54770297e+00 -9.54770297e+00
 -9.54770297e+00 -1.25134823e+00 -5.75248840e-01 -5.75248840e-01
 -5.75248840e-01  6.59546101e-01  6.59546101e-01  6.59546101e-01
  4.33773058e+00  4.33773058e+00  4.33773058e+00  2.14924165e+01
  2.14924165e+01  2.14924165e+01  2.60718450e+01  9.55616400e+01
  9.55616400e+01  9.55616400e+01  2.73748546e+02  4.31737720e+02
  4.31737720e+02  4.31737720e+02  1.28543754e+03  1.28543754e+03
  1.28543754e+03  2.01666274e+03  2.98674759e+03  2.98674759e+03
  2.98674759e+03  6.61475278e+03  6.61475278e+03  6.61475278e+03
  8.36930040e+03  2.47518199e+04  7.55415226e+04]
E1 = -727.7658603160044  E_coul = 201.6265208435135
cycle= 3 E= -526.139339472491  delta_E= -3e-05  |g|= 0.00473  |ddm|= 0.00813
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00949026
diis-c [-4.50009436e-07 -1.17107658e-03  1.30378625e-01  8.70792451e-01]
  HOMO = -0.576298540056401  LUMO = 0.659047584514013
  mo_energy =
[-1.18379465e+02 -1.22321938e+01 -9.55215290e+00 -9.55215290e+00
 -9.55215290e+00 -1.25269444e+00 -5.76298540e-01 -5.76298540e-01
 -5.76298540e-01  6.59047585e-01  6.59047585e-01  6.59047585e-01
  4.33569629e+00  4.33569629e+00  4.33569629e+00  2.14884099e+01
  2.14884099e+01  2.14884099e+01  2.60671228e+01  9.55555384e+01
  9.55555384e+01  9.55555384e+01  2.73741082e+02  4.31730075e+02
  4.31730075e+02  4.31730075e+02  1.28542936e+03  1.28542936e+03
  1.28542936e+03  2.01665404e+03  2.98673908e+03  2.98673908e+03
  2.98673908e+03  6.61474393e+03  6.61474393e+03  6.61474393e+03
  8.36929135e+03  2.47518107e+04  7.55415132e+04]
E1 = -727.7799200712342  E_coul = 201.64057981046906
cycle= 4 E= -526.139340260765  delta_E= -7.88e-07  |g|= 4.36e-05  |ddm|= 0.00114
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=6.88459e-05
diis-c [-2.73065046e-09  3.26728764e-05 -4.51112595e-03 -3.39448427e-02
  1.03842330e+00]
  HOMO = -0.576280236529283  LUMO = 0.659055838680956
  mo_energy =
[-1.18379419e+02 -1.22321287e+01 -9.55209459e+00 -9.55209459e+00
 -9.55209459e+00 -1.25266881e+00 -5.76280237e-01 -5.76280237e-01
 -5.76280237e-01  6.59055839e-01  6.59055839e-01  6.59055839e-01
  4.33572997e+00  4.33572997e+00  4.33572997e+00  2.14884621e+01
  2.14884621e+01  2.14884621e+01  2.60671876e+01  9.55555920e+01
  9.55555920e+01  9.55555920e+01  2.73741129e+02  4.31730122e+02
  4.31730122e+02  4.31730122e+02  1.28542940e+03  1.28542940e+03
  1.28542940e+03  2.01665407e+03  2.98673911e+03  2.98673911e+03
  2.98673911e+03  6.61474395e+03  6.61474395e+03  6.61474395e+03
  8.36929136e+03  2.47518107e+04  7.55415132e+04]
E1 = -727.7797644732472  E_coul = 201.640424212401
cycle= 5 E= -526.139340260846  delta_E= -8.11e-11  |g|= 1.02e-05  |ddm|= 2.26e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -727.7797644732472  E_coul = 201.640424212401
  HOMO = -0.576285586758869  LUMO = 0.659053304562786
  mo_energy =
[-1.18379442e+02 -1.22321460e+01 -9.55211241e+00 -9.55211241e+00
 -9.55211241e+00 -1.25267566e+00 -5.76285587e-01 -5.76285587e-01
 -5.76285587e-01  6.59053305e-01  6.59053305e-01  6.59053305e-01
  4.33572029e+00  4.33572029e+00  4.33572029e+00  2.14884459e+01
  2.14884459e+01  2.14884459e+01  2.60671696e+01  9.55555712e+01
  9.55555712e+01  9.55555712e+01  2.73741106e+02  4.31730098e+02
  4.31730098e+02  4.31730098e+02  1.28542937e+03  1.28542937e+03
  1.28542937e+03  2.01665404e+03  2.98673908e+03  2.98673908e+03
  2.98673908e+03  6.61474392e+03  6.61474392e+03  6.61474392e+03
  8.36929133e+03  2.47518107e+04  7.55415132e+04]
E1 = -727.779815593366  E_coul = 201.64047533251357
Extra cycle  E= -526.139340260852  delta_E= -6.25e-12  |g|= 2.88e-06  |ddm|= 4.59e-06
    CPU time for scf_cycle      0.70 sec, wall time      0.31 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 87004.68126554023
E1 = -727.779815593366  E_coul = 201.64047533251357
init E= -526.139340260852
    CPU time for initialize scf      2.74 sec, wall time      0.25 sec
  HOMO = -0.576284615360544  LUMO = 0.659053761197237
  mo_energy =
[-1.18379436e+02 -1.22321423e+01 -9.55210855e+00 -9.55210855e+00
 -9.55210855e+00 -1.25267440e+00 -5.76284615e-01 -5.76284615e-01
 -5.76284615e-01  6.59053761e-01  6.59053761e-01  6.59053761e-01
  4.33572215e+00  4.33572215e+00  4.33572215e+00  2.14884493e+01
  2.14884493e+01  2.14884493e+01  2.60671737e+01  9.55555762e+01
  9.55555762e+01  9.55555762e+01  2.73741111e+02  4.31730104e+02
  4.31730104e+02  4.31730104e+02  1.28542938e+03  1.28542938e+03
  1.28542938e+03  2.01665405e+03  2.98673909e+03  2.98673909e+03
  2.98673909e+03  6.61474393e+03  6.61474393e+03  6.61474393e+03
  8.36929134e+03  2.47518107e+04  7.55415132e+04]
E1 = -727.7798037466434  E_coul = 201.64046348579106
cycle= 1 E= -526.139340260852  delta_E= 1.14e-13  |g|= 7.23e-07  |ddm|= 1.04e-06
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
E1 = -727.7798037466434  E_coul = 201.64046348579106
  HOMO = -0.576284830933717  LUMO = 0.65905365906548
  mo_energy =
[-1.18379438e+02 -1.22321431e+01 -9.55210944e+00 -9.55210944e+00
 -9.55210944e+00 -1.25267468e+00 -5.76284831e-01 -5.76284831e-01
 -5.76284831e-01  6.59053659e-01  6.59053659e-01  6.59053659e-01
  4.33572173e+00  4.33572173e+00  4.33572173e+00  2.14884485e+01
  2.14884485e+01  2.14884485e+01  2.60671727e+01  9.55555750e+01
  9.55555750e+01  9.55555750e+01  2.73741110e+02  4.31730103e+02
  4.31730103e+02  4.31730103e+02  1.28542938e+03  1.28542938e+03
  1.28542938e+03  2.01665405e+03  2.98673909e+03  2.98673909e+03
  2.98673909e+03  6.61474393e+03  6.61474393e+03  6.61474393e+03
  8.36929134e+03  2.47518107e+04  7.55415132e+04]
E1 = -727.7798065121273  E_coul = 201.6404662512738
Extra cycle  E= -526.139340260853  delta_E= -1.14e-12  |g|= 1.75e-07  |ddm|= 2.31e-07
    CPU time for scf_cycle      2.89 sec, wall time      0.40 sec
exp = [2.61825100e+04 7.61822362e+03 3.61819251e+03 1.61739496e+03
 2.46297786e+02 6.14386693e+01 1.58835387e+01 4.17846290e+00
 4.11182872e-01 1.36279104e+03 6.65155379e+02 3.03181479e+02
 3.16023778e+02 5.16197586e+01 5.28438919e+00 1.55314185e+01
 5.62596495e-01 1.86193085e+00 1.67500382e-01]
grad_E = [-1.97336578e-06  2.40098459e-05  5.04920228e-05  7.59608457e-04
 -8.38636530e-03  9.56492018e-03 -8.42970955e-03 -4.21432472e-02
  2.06560119e-01  4.57675194e-07  1.35020287e-05  7.01147996e-05
  6.16033936e-05  8.15038530e-04 -4.38389121e-03 -4.59091274e-03
 -8.70889931e-02  1.14076172e-02 -3.53737118e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:41:39 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5112692        1
[INPUT] 0    0    [1    /1   ]  7618.20733868        1
[INPUT] 0    0    [1    /1   ]  3618.15730894        1
[INPUT] 0    0    [1    /1   ]  1616.88047384        1
[INPUT] 0    0    [1    /1   ]  250.743568867        1
[INPUT] 0    0    [1    /1   ]  65.433379489         1
[INPUT] 0    0    [1    /1   ]  19.0624023805        1
[INPUT] 0    0    [1    /1   ]  4.35264200203        1
[INPUT] 0    0    [1    /1   ]  0.406727276397       1
[INPUT] 1    0    [1    /1   ]  1362.78981247        1
[INPUT] 1    0    [1    /1   ]  665.139929399        1
[INPUT] 1    0    [1    /1   ]  303.096363177        1
[INPUT] 1    0    [1    /1   ]  315.948740432        1
[INPUT] 1    0    [1    /1   ]  53.2719842293        1
[INPUT] 1    0    [1    /1   ]  5.28506553154        1
[INPUT] 1    0    [1    /1   ]  15.4761085483        1
[INPUT] 1    0    [1    /1   ]  0.547971790739       1
[INPUT] 1    0    [1    /1   ]  1.80073067254        1
[INPUT] 1    0    [1    /1   ]  0.164658740689       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.511269165527, 1.0]], [0, [7618.207338682932, 1.0]], [0, [3618.1573089362532, 1.0]], [0, [1616.8804738444237, 1.0]], [0, [250.74356886699556, 1.0]], [0, [65.43337948900256, 1.0]], [0, [19.062402380473472, 1.0]], [0, [4.352642002031339, 1.0]], [0, [0.4067272763968127, 1.0]], [1, [1362.7898124661035, 1.0]], [1, [665.1399293990352, 1.0]], [1, [303.09636317653974, 1.0]], [1, [315.94874043217027, 1.0]], [1, [53.271984229253526, 1.0]], [1, [5.2850655315365245, 1.0]], [1, [15.476108548300134, 1.0]], [1, [0.5479717907386304, 1.0]], [1, [1.8007306725359171, 1.0]], [1, [0.164658740689038, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.51126917]
bas 1, expnt(s) = [7618.20733868]
bas 2, expnt(s) = [3618.15730894]
bas 3, expnt(s) = [1616.88047384]
bas 4, expnt(s) = [250.74356887]
bas 5, expnt(s) = [65.43337949]
bas 6, expnt(s) = [19.06240238]
bas 7, expnt(s) = [4.352642]
bas 8, expnt(s) = [0.40672728]
bas 9, expnt(s) = [1362.78981247]
bas 10, expnt(s) = [665.1399294]
bas 11, expnt(s) = [303.09636318]
bas 12, expnt(s) = [315.94874043]
bas 13, expnt(s) = [53.27198423]
bas 14, expnt(s) = [5.28506553]
bas 15, expnt(s) = [15.47610855]
bas 16, expnt(s) = [0.54797179]
bas 17, expnt(s) = [1.80073067]
bas 18, expnt(s) = [0.16465874]
CPU time:       332.18
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825113e+04 5.20024133e+03 7.61820734e+03 2.06017738e+03
 3.61815731e+03 1.17863846e+03 1.61688047e+03 6.44204066e+02
 2.50743569e+02 1.59197915e+02 6.54333795e+01 5.81252104e+01
 1.90624024e+01 2.30487962e+01 4.35264200e+00 7.61341907e+00
 4.06727276e-01 1.28674503e+00 1.36278981e+03 2.41557480e+04
 6.65139929e+02 9.85429746e+03 3.03096363e+02 3.68943870e+03
 3.15948740e+02 3.88602131e+03 5.32719842e+01 4.19863367e+02
 5.28506553e+00 2.33774622e+01 1.54761085e+01 8.95491776e+01
 5.47971791e-01 1.37540990e+00 1.80073067e+00 6.08548709e+00
 1.64658741e-01 3.05995739e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.981537724390734
cond(S) = 88413.21466183737
E1 = -728.4633287377732  E_coul = 203.22666214272056
init E= -525.236666595053
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.55590015231888  LUMO = 0.646314747312139
  mo_energy =
[-1.18146947e+02 -1.21149589e+01 -9.43806477e+00 -9.43806477e+00
 -9.43806477e+00 -1.22460233e+00 -5.55900152e-01 -5.55900152e-01
 -5.55900152e-01  6.46314747e-01  6.46314747e-01  6.46314747e-01
  4.23128329e+00  4.23128329e+00  4.23128329e+00  2.12569985e+01
  2.12569985e+01  2.12569985e+01  3.26487660e+01  9.68918800e+01
  9.68918800e+01  9.68918800e+01  3.00147099e+02  4.36452656e+02
  4.36452656e+02  4.36452656e+02  1.29075218e+03  1.29075218e+03
  1.29075218e+03  2.05639137e+03  2.99192266e+03  2.99192266e+03
  2.99192266e+03  6.61960154e+03  6.61960154e+03  6.61960154e+03
  8.40879953e+03  2.47895240e+04  7.55766844e+04]
E1 = -727.5080479759599  E_coul = 201.34556784130808
cycle= 1 E= -526.162480134652  delta_E= -0.926  |g|= 0.22  |ddm|= 0.611
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.557337
diis-c [-0.3106244  1.       ]
  HOMO = -0.58156301327505  LUMO = 0.637934285176278
  mo_energy =
[-1.18449976e+02 -1.22401108e+01 -9.57107908e+00 -9.57107908e+00
 -9.57107908e+00 -1.26077622e+00 -5.81563013e-01 -5.81563013e-01
 -5.81563013e-01  6.37934285e-01  6.37934285e-01  6.37934285e-01
  4.17611785e+00  4.17611785e+00  4.17611785e+00  2.11350909e+01
  2.11350909e+01  2.11350909e+01  3.24971201e+01  9.66847506e+01
  9.66847506e+01  9.66847506e+01  2.99852147e+02  4.36148032e+02
  4.36148032e+02  4.36148032e+02  1.29038717e+03  1.29038717e+03
  1.29038717e+03  2.05588980e+03  2.99148940e+03  2.99148940e+03
  2.99148940e+03  6.61903626e+03  6.61903626e+03  6.61903626e+03
  8.40814287e+03  2.47887629e+04  7.55758246e+04]
E1 = -727.9230417774278  E_coul = 201.76003767009948
cycle= 2 E= -526.163004107328  delta_E= -0.000524  |g|= 0.0309  |ddm|= 0.0285
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0571661
diis-c [-0.00222753  0.05489494  0.94510506]
  HOMO = -0.575659894669198  LUMO = 0.640638388043186
  mo_energy =
[-1.18394951e+02 -1.22118769e+01 -9.54203081e+00 -9.54203081e+00
 -9.54203081e+00 -1.25297786e+00 -5.75659895e-01 -5.75659895e-01
 -5.75659895e-01  6.40638388e-01  6.40638388e-01  6.40638388e-01
  4.18797183e+00  4.18797183e+00  4.18797183e+00  2.11609481e+01
  2.11609481e+01  2.11609481e+01  3.25321222e+01  9.67273173e+01
  9.67273173e+01  9.67273173e+01  2.99905591e+02  4.36202534e+02
  4.36202534e+02  4.36202534e+02  1.29044539e+03  1.29044539e+03
  1.29044539e+03  2.05595067e+03  2.99154955e+03  2.99154955e+03
  2.99154955e+03  6.61909779e+03  6.61909779e+03  6.61909779e+03
  8.40820503e+03  2.47888254e+04  7.55758872e+04]
E1 = -727.8294613653178  E_coul = 201.66643096571508
cycle= 3 E= -526.163030399603  delta_E= -2.63e-05  |g|= 0.00455  |ddm|= 0.00745
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00903995
diis-c [-3.83513069e-07 -1.11282330e-03  1.31529129e-01  8.69583695e-01]
  HOMO = -0.576682926976693  LUMO = 0.640170276269874
  mo_energy =
[-1.18402485e+02 -1.22160262e+01 -9.54636941e+00 -9.54636941e+00
 -9.54636941e+00 -1.25429723e+00 -5.76682927e-01 -5.76682927e-01
 -5.76682927e-01  6.40170276e-01  6.40170276e-01  6.40170276e-01
  4.18602306e+00  4.18602306e+00  4.18602306e+00  2.11570434e+01
  2.11570434e+01  2.11570434e+01  3.25271907e+01  9.67213203e+01
  9.67213203e+01  9.67213203e+01  2.99898252e+02  4.36195066e+02
  4.36195066e+02  4.36195066e+02  1.29043741e+03  1.29043741e+03
  1.29043741e+03  2.05594219e+03  2.99154126e+03  2.99154126e+03
  2.99154126e+03  6.61908917e+03  6.61908917e+03  6.61908917e+03
  8.40819623e+03  2.47888164e+04  7.55758782e+04]
E1 = -727.842963168996  E_coul = 201.67993204471588
cycle= 4 E= -526.16303112428  delta_E= -7.25e-07  |g|= 4.04e-05  |ddm|= 0.00108
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.2069e-05
diis-c [-2.43952448e-09  1.93764138e-05 -2.98784069e-03 -2.04651998e-02
  1.02343366e+00]
  HOMO = -0.576662027995823  LUMO = 0.640179433556075
  mo_energy =
[-1.18402422e+02 -1.22159535e+01 -9.54630129e+00 -9.54630129e+00
 -9.54630129e+00 -1.25426867e+00 -5.76662028e-01 -5.76662028e-01
 -5.76662028e-01  6.40179434e-01  6.40179434e-01  6.40179434e-01
  4.18606080e+00  4.18606080e+00  4.18606080e+00  2.11571045e+01
  2.11571045e+01  2.11571045e+01  3.25272648e+01  9.67213870e+01
  9.67213870e+01  9.67213870e+01  2.99898314e+02  4.36195129e+02
  4.36195129e+02  4.36195129e+02  1.29043747e+03  1.29043747e+03
  1.29043747e+03  2.05594224e+03  2.99154131e+03  2.99154131e+03
  2.99154131e+03  6.61908921e+03  6.61908921e+03  6.61908921e+03
  8.40819626e+03  2.47888164e+04  7.55758782e+04]
E1 = -727.8427786300828  E_coul = 201.67974750570335
cycle= 5 E= -526.163031124379  delta_E= -9.92e-11  |g|= 9.24e-06  |ddm|= 2.36e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -727.8427786300828  E_coul = 201.67974750570335
  HOMO = -0.576666948927364  LUMO = 0.640177180767431
  mo_energy =
[-1.18402444e+02 -1.22159693e+01 -9.54631758e+00 -9.54631758e+00
 -9.54631758e+00 -1.25427497e+00 -5.76666949e-01 -5.76666949e-01
 -5.76666949e-01  6.40177181e-01  6.40177181e-01  6.40177181e-01
  4.18605207e+00  4.18605207e+00  4.18605207e+00  2.11570897e+01
  2.11570897e+01  2.11570897e+01  3.25272477e+01  9.67213678e+01
  9.67213678e+01  9.67213678e+01  2.99898293e+02  4.36195108e+02
  4.36195108e+02  4.36195108e+02  1.29043745e+03  1.29043745e+03
  1.29043745e+03  2.05594222e+03  2.99154128e+03  2.99154128e+03
  2.99154128e+03  6.61908919e+03  6.61908919e+03  6.61908919e+03
  8.40819624e+03  2.47888164e+04  7.55758782e+04]
E1 = -727.842824512522  E_coul = 201.6797933881365
Extra cycle  E= -526.163031124385  delta_E= -6.14e-12  |g|= 2.57e-06  |ddm|= 4.02e-06
    CPU time for scf_cycle      0.70 sec, wall time      0.31 sec
exp = [2.61825113e+04 7.61820734e+03 3.61815731e+03 1.61688047e+03
 2.50743569e+02 6.54333795e+01 1.90624024e+01 4.35264200e+00
 4.06727276e-01 1.36278981e+03 6.65139929e+02 3.03096363e+02
 3.15948740e+02 5.32719842e+01 5.28506553e+00 1.54761085e+01
 5.47971791e-01 1.80073067e+00 1.64658741e-01]
E = -526.1630311243855
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:41:40 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5112692        1
[INPUT] 0    0    [1    /1   ]  7618.20733868        1
[INPUT] 0    0    [1    /1   ]  3618.15730894        1
[INPUT] 0    0    [1    /1   ]  1616.88047384        1
[INPUT] 0    0    [1    /1   ]  250.743568867        1
[INPUT] 0    0    [1    /1   ]  65.433379489         1
[INPUT] 0    0    [1    /1   ]  19.0624023805        1
[INPUT] 0    0    [1    /1   ]  4.35264200203        1
[INPUT] 0    0    [1    /1   ]  0.406727276397       1
[INPUT] 1    0    [1    /1   ]  1362.78981247        1
[INPUT] 1    0    [1    /1   ]  665.139929399        1
[INPUT] 1    0    [1    /1   ]  303.096363177        1
[INPUT] 1    0    [1    /1   ]  315.948740432        1
[INPUT] 1    0    [1    /1   ]  53.2719842293        1
[INPUT] 1    0    [1    /1   ]  5.28506553154        1
[INPUT] 1    0    [1    /1   ]  15.4761085483        1
[INPUT] 1    0    [1    /1   ]  0.547971790739       1
[INPUT] 1    0    [1    /1   ]  1.80073067254        1
[INPUT] 1    0    [1    /1   ]  0.164658740689       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.511269165527, 1.0]], [0, [7618.207338682932, 1.0]], [0, [3618.1573089362532, 1.0]], [0, [1616.8804738444237, 1.0]], [0, [250.74356886699556, 1.0]], [0, [65.43337948900256, 1.0]], [0, [19.062402380473472, 1.0]], [0, [4.352642002031339, 1.0]], [0, [0.4067272763968127, 1.0]], [1, [1362.7898124661035, 1.0]], [1, [665.1399293990352, 1.0]], [1, [303.09636317653974, 1.0]], [1, [315.94874043217027, 1.0]], [1, [53.271984229253526, 1.0]], [1, [5.2850655315365245, 1.0]], [1, [15.476108548300134, 1.0]], [1, [0.5479717907386304, 1.0]], [1, [1.8007306725359171, 1.0]], [1, [0.164658740689038, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.51126917]
bas 1, expnt(s) = [7618.20733868]
bas 2, expnt(s) = [3618.15730894]
bas 3, expnt(s) = [1616.88047384]
bas 4, expnt(s) = [250.74356887]
bas 5, expnt(s) = [65.43337949]
bas 6, expnt(s) = [19.06240238]
bas 7, expnt(s) = [4.352642]
bas 8, expnt(s) = [0.40672728]
bas 9, expnt(s) = [1362.78981247]
bas 10, expnt(s) = [665.1399294]
bas 11, expnt(s) = [303.09636318]
bas 12, expnt(s) = [315.94874043]
bas 13, expnt(s) = [53.27198423]
bas 14, expnt(s) = [5.28506553]
bas 15, expnt(s) = [15.47610855]
bas 16, expnt(s) = [0.54797179]
bas 17, expnt(s) = [1.80073067]
bas 18, expnt(s) = [0.16465874]
CPU time:       333.04
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825113e+04 5.20024133e+03 7.61820734e+03 2.06017738e+03
 3.61815731e+03 1.17863846e+03 1.61688047e+03 6.44204066e+02
 2.50743569e+02 1.59197915e+02 6.54333795e+01 5.81252104e+01
 1.90624024e+01 2.30487962e+01 4.35264200e+00 7.61341907e+00
 4.06727276e-01 1.28674503e+00 1.36278981e+03 2.41557480e+04
 6.65139929e+02 9.85429746e+03 3.03096363e+02 3.68943870e+03
 3.15948740e+02 3.88602131e+03 5.32719842e+01 4.19863367e+02
 5.28506553e+00 2.33774622e+01 1.54761085e+01 8.95491776e+01
 5.47971791e-01 1.37540990e+00 1.80073067e+00 6.08548709e+00
 1.64658741e-01 3.05995739e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.981537724390734
cond(S) = 88413.21466183737
E1 = -728.4633287377732  E_coul = 203.22666214272056
init E= -525.236666595053
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.55590015231888  LUMO = 0.646314747312139
  mo_energy =
[-1.18146947e+02 -1.21149589e+01 -9.43806477e+00 -9.43806477e+00
 -9.43806477e+00 -1.22460233e+00 -5.55900152e-01 -5.55900152e-01
 -5.55900152e-01  6.46314747e-01  6.46314747e-01  6.46314747e-01
  4.23128329e+00  4.23128329e+00  4.23128329e+00  2.12569985e+01
  2.12569985e+01  2.12569985e+01  3.26487660e+01  9.68918800e+01
  9.68918800e+01  9.68918800e+01  3.00147099e+02  4.36452656e+02
  4.36452656e+02  4.36452656e+02  1.29075218e+03  1.29075218e+03
  1.29075218e+03  2.05639137e+03  2.99192266e+03  2.99192266e+03
  2.99192266e+03  6.61960154e+03  6.61960154e+03  6.61960154e+03
  8.40879953e+03  2.47895240e+04  7.55766844e+04]
E1 = -727.5080479759599  E_coul = 201.34556784130808
cycle= 1 E= -526.162480134652  delta_E= -0.926  |g|= 0.22  |ddm|= 0.611
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.557337
diis-c [-0.3106244  1.       ]
  HOMO = -0.58156301327505  LUMO = 0.637934285176278
  mo_energy =
[-1.18449976e+02 -1.22401108e+01 -9.57107908e+00 -9.57107908e+00
 -9.57107908e+00 -1.26077622e+00 -5.81563013e-01 -5.81563013e-01
 -5.81563013e-01  6.37934285e-01  6.37934285e-01  6.37934285e-01
  4.17611785e+00  4.17611785e+00  4.17611785e+00  2.11350909e+01
  2.11350909e+01  2.11350909e+01  3.24971201e+01  9.66847506e+01
  9.66847506e+01  9.66847506e+01  2.99852147e+02  4.36148032e+02
  4.36148032e+02  4.36148032e+02  1.29038717e+03  1.29038717e+03
  1.29038717e+03  2.05588980e+03  2.99148940e+03  2.99148940e+03
  2.99148940e+03  6.61903626e+03  6.61903626e+03  6.61903626e+03
  8.40814287e+03  2.47887629e+04  7.55758246e+04]
E1 = -727.9230417774278  E_coul = 201.76003767009948
cycle= 2 E= -526.163004107328  delta_E= -0.000524  |g|= 0.0309  |ddm|= 0.0285
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0571661
diis-c [-0.00222753  0.05489494  0.94510506]
  HOMO = -0.575659894669198  LUMO = 0.640638388043186
  mo_energy =
[-1.18394951e+02 -1.22118769e+01 -9.54203081e+00 -9.54203081e+00
 -9.54203081e+00 -1.25297786e+00 -5.75659895e-01 -5.75659895e-01
 -5.75659895e-01  6.40638388e-01  6.40638388e-01  6.40638388e-01
  4.18797183e+00  4.18797183e+00  4.18797183e+00  2.11609481e+01
  2.11609481e+01  2.11609481e+01  3.25321222e+01  9.67273173e+01
  9.67273173e+01  9.67273173e+01  2.99905591e+02  4.36202534e+02
  4.36202534e+02  4.36202534e+02  1.29044539e+03  1.29044539e+03
  1.29044539e+03  2.05595067e+03  2.99154955e+03  2.99154955e+03
  2.99154955e+03  6.61909779e+03  6.61909779e+03  6.61909779e+03
  8.40820503e+03  2.47888254e+04  7.55758872e+04]
E1 = -727.8294613653178  E_coul = 201.66643096571508
cycle= 3 E= -526.163030399603  delta_E= -2.63e-05  |g|= 0.00455  |ddm|= 0.00745
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00903995
diis-c [-3.83513069e-07 -1.11282330e-03  1.31529129e-01  8.69583695e-01]
  HOMO = -0.576682926976693  LUMO = 0.640170276269874
  mo_energy =
[-1.18402485e+02 -1.22160262e+01 -9.54636941e+00 -9.54636941e+00
 -9.54636941e+00 -1.25429723e+00 -5.76682927e-01 -5.76682927e-01
 -5.76682927e-01  6.40170276e-01  6.40170276e-01  6.40170276e-01
  4.18602306e+00  4.18602306e+00  4.18602306e+00  2.11570434e+01
  2.11570434e+01  2.11570434e+01  3.25271907e+01  9.67213203e+01
  9.67213203e+01  9.67213203e+01  2.99898252e+02  4.36195066e+02
  4.36195066e+02  4.36195066e+02  1.29043741e+03  1.29043741e+03
  1.29043741e+03  2.05594219e+03  2.99154126e+03  2.99154126e+03
  2.99154126e+03  6.61908917e+03  6.61908917e+03  6.61908917e+03
  8.40819623e+03  2.47888164e+04  7.55758782e+04]
E1 = -727.842963168996  E_coul = 201.67993204471588
cycle= 4 E= -526.16303112428  delta_E= -7.25e-07  |g|= 4.04e-05  |ddm|= 0.00108
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.2069e-05
diis-c [-2.43952448e-09  1.93764138e-05 -2.98784069e-03 -2.04651998e-02
  1.02343366e+00]
  HOMO = -0.576662027995823  LUMO = 0.640179433556075
  mo_energy =
[-1.18402422e+02 -1.22159535e+01 -9.54630129e+00 -9.54630129e+00
 -9.54630129e+00 -1.25426867e+00 -5.76662028e-01 -5.76662028e-01
 -5.76662028e-01  6.40179434e-01  6.40179434e-01  6.40179434e-01
  4.18606080e+00  4.18606080e+00  4.18606080e+00  2.11571045e+01
  2.11571045e+01  2.11571045e+01  3.25272648e+01  9.67213870e+01
  9.67213870e+01  9.67213870e+01  2.99898314e+02  4.36195129e+02
  4.36195129e+02  4.36195129e+02  1.29043747e+03  1.29043747e+03
  1.29043747e+03  2.05594224e+03  2.99154131e+03  2.99154131e+03
  2.99154131e+03  6.61908921e+03  6.61908921e+03  6.61908921e+03
  8.40819626e+03  2.47888164e+04  7.55758782e+04]
E1 = -727.8427786300828  E_coul = 201.67974750570335
cycle= 5 E= -526.163031124379  delta_E= -9.92e-11  |g|= 9.24e-06  |ddm|= 2.36e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -727.8427786300828  E_coul = 201.67974750570335
  HOMO = -0.576666948927364  LUMO = 0.640177180767431
  mo_energy =
[-1.18402444e+02 -1.22159693e+01 -9.54631758e+00 -9.54631758e+00
 -9.54631758e+00 -1.25427497e+00 -5.76666949e-01 -5.76666949e-01
 -5.76666949e-01  6.40177181e-01  6.40177181e-01  6.40177181e-01
  4.18605207e+00  4.18605207e+00  4.18605207e+00  2.11570897e+01
  2.11570897e+01  2.11570897e+01  3.25272477e+01  9.67213678e+01
  9.67213678e+01  9.67213678e+01  2.99898293e+02  4.36195108e+02
  4.36195108e+02  4.36195108e+02  1.29043745e+03  1.29043745e+03
  1.29043745e+03  2.05594222e+03  2.99154128e+03  2.99154128e+03
  2.99154128e+03  6.61908919e+03  6.61908919e+03  6.61908919e+03
  8.40819624e+03  2.47888164e+04  7.55758782e+04]
E1 = -727.842824512522  E_coul = 201.6797933881365
Extra cycle  E= -526.163031124385  delta_E= -6.14e-12  |g|= 2.57e-06  |ddm|= 4.02e-06
    CPU time for scf_cycle      0.70 sec, wall time      0.31 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 88413.21466183737
E1 = -727.842824512522  E_coul = 201.6797933881365
init E= -526.163031124385
    CPU time for initialize scf      2.72 sec, wall time      0.25 sec
  HOMO = -0.576666080288849  LUMO = 0.640177573667372
  mo_energy =
[-1.18402439e+02 -1.22159659e+01 -9.54631412e+00 -9.54631412e+00
 -9.54631412e+00 -1.25427383e+00 -5.76666080e-01 -5.76666080e-01
 -5.76666080e-01  6.40177574e-01  6.40177574e-01  6.40177574e-01
  4.18605370e+00  4.18605370e+00  4.18605370e+00  2.11570928e+01
  2.11570928e+01  2.11570928e+01  3.25272516e+01  9.67213723e+01
  9.67213723e+01  9.67213723e+01  2.99898298e+02  4.36195113e+02
  4.36195113e+02  4.36195113e+02  1.29043745e+03  1.29043745e+03
  1.29043745e+03  2.05594222e+03  2.99154129e+03  2.99154129e+03
  2.99154129e+03  6.61908919e+03  6.61908919e+03  6.61908919e+03
  8.40819624e+03  2.47888164e+04  7.55758782e+04]
E1 = -727.8428140168891  E_coul = 201.67978289250377
cycle= 1 E= -526.163031124385  delta_E= 2.27e-13  |g|= 6.32e-07  |ddm|= 9.13e-07
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
E1 = -727.8428140168891  E_coul = 201.67978289250377
  HOMO = -0.576666272491109  LUMO = 0.64017748585651
  mo_energy =
[-1.18402440e+02 -1.22159667e+01 -9.54631490e+00 -9.54631490e+00
 -9.54631490e+00 -1.25427408e+00 -5.76666272e-01 -5.76666272e-01
 -5.76666272e-01  6.40177486e-01  6.40177486e-01  6.40177486e-01
  4.18605334e+00  4.18605334e+00  4.18605334e+00  2.11570921e+01
  2.11570921e+01  2.11570921e+01  3.25272507e+01  9.67213712e+01
  9.67213712e+01  9.67213712e+01  2.99898297e+02  4.36195112e+02
  4.36195112e+02  4.36195112e+02  1.29043745e+03  1.29043745e+03
  1.29043745e+03  2.05594222e+03  2.99154129e+03  2.99154129e+03
  2.99154129e+03  6.61908919e+03  6.61908919e+03  6.61908919e+03
  8.40819624e+03  2.47888164e+04  7.55758782e+04]
E1 = -727.8428164209516  E_coul = 201.67978529656605
Extra cycle  E= -526.163031124386  delta_E= -3.41e-13  |g|= 1.5e-07  |ddm|= 1.98e-07
    CPU time for scf_cycle      2.87 sec, wall time      0.40 sec
exp = [2.61825113e+04 7.61820734e+03 3.61815731e+03 1.61688047e+03
 2.50743569e+02 6.54333795e+01 1.90624024e+01 4.35264200e+00
 4.06727276e-01 1.36278981e+03 6.65139929e+02 3.03096363e+02
 3.15948740e+02 5.32719842e+01 5.28506553e+00 1.54761085e+01
 5.47971791e-01 1.80073067e+00 1.64658741e-01]
grad_E = [-1.97515536e-06  2.36524460e-05  4.93002861e-05  7.50651123e-04
 -9.42366112e-03  1.33798036e-02 -1.08018672e-02 -1.13683280e-02
  1.57005997e-01 -2.38588897e-07  7.42874214e-06  3.38797350e-05
  2.98553097e-05  4.24383369e-03  2.68449817e-02 -2.29330171e-02
 -1.18280599e-01 -2.14368167e-04 -5.63070381e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:41:44 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5149358        1
[INPUT] 0    0    [1    /1   ]  7618.16031737        1
[INPUT] 0    0    [1    /1   ]  3618.05571945        1
[INPUT] 0    0    [1    /1   ]  1615.39499254        1
[INPUT] 0    0    [1    /1   ]  263.465787734        1
[INPUT] 0    0    [1    /1   ]  77.4733107119        1
[INPUT] 0    0    [1    /1   ]  28.5687749154        1
[INPUT] 0    0    [1    /1   ]  4.79961775731        1
[INPUT] 0    0    [1    /1   ]  0.391588719336       1
[INPUT] 1    0    [1    /1   ]  1362.7863157         1
[INPUT] 1    0    [1    /1   ]  665.095646048        1
[INPUT] 1    0    [1    /1   ]  302.852620486        1
[INPUT] 1    0    [1    /1   ]  315.733860049        1
[INPUT] 1    0    [1    /1   ]  57.804413228         1
[INPUT] 1    0    [1    /1   ]  4.68542533495        1
[INPUT] 1    0    [1    /1   ]  16.2372222721        1
[INPUT] 1    0    [1    /1   ]  0.519265290946       1
[INPUT] 1    0    [1    /1   ]  1.17258707831        1
[INPUT] 1    0    [1    /1   ]  0.165734343044       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.514935826595, 1.0]], [0, [7618.160317366826, 1.0]], [0, [3618.0557194497824, 1.0]], [0, [1615.3949925385987, 1.0]], [0, [263.4657877341401, 1.0]], [0, [77.47331071187696, 1.0]], [0, [28.568774915439512, 1.0]], [0, [4.799617757310548, 1.0]], [0, [0.39158871933620254, 1.0]], [1, [1362.7863157001766, 1.0]], [1, [665.0956460479176, 1.0]], [1, [302.8526204860377, 1.0]], [1, [315.73386004920354, 1.0]], [1, [57.804413227987524, 1.0]], [1, [4.685425334948606, 1.0]], [1, [16.237222272117737, 1.0]], [1, [0.5192652909464301, 1.0]], [1, [1.1725870783056118, 1.0]], [1, [0.16573434304399137, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.51493583]
bas 1, expnt(s) = [7618.16031737]
bas 2, expnt(s) = [3618.05571945]
bas 3, expnt(s) = [1615.39499254]
bas 4, expnt(s) = [263.46578773]
bas 5, expnt(s) = [77.47331071]
bas 6, expnt(s) = [28.56877492]
bas 7, expnt(s) = [4.79961776]
bas 8, expnt(s) = [0.39158872]
bas 9, expnt(s) = [1362.7863157]
bas 10, expnt(s) = [665.09564605]
bas 11, expnt(s) = [302.85262049]
bas 12, expnt(s) = [315.73386005]
bas 13, expnt(s) = [57.80441323]
bas 14, expnt(s) = [4.68542533]
bas 15, expnt(s) = [16.23722227]
bas 16, expnt(s) = [0.51926529]
bas 17, expnt(s) = [1.17258708]
bas 18, expnt(s) = [0.16573434]
CPU time:       341.22
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825149e+04 5.20024188e+03 7.61816032e+03 2.06016785e+03
 3.61805572e+03 1.17861364e+03 1.61539499e+03 6.43760126e+02
 2.63465788e+02 1.65218318e+02 7.74733107e+01 6.59749562e+01
 2.85687749e+01 3.12200603e+01 4.79961776e+00 8.19256721e+00
 3.91588719e-01 1.25065537e+00 1.36278632e+03 2.41556705e+04
 6.65095646e+02 9.85347737e+03 3.02852620e+02 3.68573038e+03
 3.15733860e+02 3.88271793e+03 5.78044132e+01 4.64981462e+02
 4.68542533e+00 2.01103982e+01 1.62372223e+01 9.50876386e+01
 5.19265291e-01 1.28594090e+00 1.17258708e+00 3.55971946e+00
 1.65734343e-01 3.08496351e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97722720281108
cond(S) = 92562.39044767506
E1 = -728.510157587697  E_coul = 203.21977308710055
init E= -525.290384500596
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.560552060917265  LUMO = 0.6313075491459
  mo_energy =
[-1.18178037e+02 -1.20835786e+01 -9.42402063e+00 -9.42402063e+00
 -9.42402063e+00 -1.23467804e+00 -5.60552061e-01 -5.60552061e-01
 -5.60552061e-01  6.31307549e-01  6.31307549e-01  6.31307549e-01
  3.14865167e+00  3.14865167e+00  3.14865167e+00  1.77726975e+01
  1.77726975e+01  1.77726975e+01  5.34681990e+01  9.93231548e+01
  9.93231548e+01  9.93231548e+01  3.76483463e+02  4.48895753e+02
  4.48895753e+02  4.48895753e+02  1.30498082e+03  1.30498082e+03
  1.30498082e+03  2.17280655e+03  3.00566333e+03  3.00566333e+03
  3.00566333e+03  6.63207431e+03  6.63207431e+03  6.63207431e+03
  8.52490916e+03  2.49001956e+04  7.56795637e+04]
E1 = -727.6328217181739  E_coul = 201.51254547692756
cycle= 1 E= -526.120276241246  delta_E= -0.83  |g|= 0.202  |ddm|= 1.47
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.51904
diis-c [-0.26940302  1.        ]
  HOMO = -0.583251816120673  LUMO = 0.62545421907204
  mo_energy =
[-1.18448015e+02 -1.22094794e+01 -9.54298960e+00 -9.54298960e+00
 -9.54298960e+00 -1.26785543e+00 -5.83251816e-01 -5.83251816e-01
 -5.83251816e-01  6.25454219e-01  6.25454219e-01  6.25454219e-01
  3.11297276e+00  3.11297276e+00  3.11297276e+00  1.76683190e+01
  1.76683190e+01  1.76683190e+01  5.32972347e+01  9.91301895e+01
  9.91301895e+01  9.91301895e+01  3.76213360e+02  4.48623668e+02
  4.48623668e+02  4.48623668e+02  1.30465767e+03  1.30465767e+03
  1.30465767e+03  2.17235549e+03  3.00527656e+03  3.00527656e+03
  3.00527656e+03  6.63156458e+03  6.63156458e+03  6.63156458e+03
  8.52431470e+03  2.48995013e+04  7.56787742e+04]
E1 = -727.9118675602784  E_coul = 201.79124298788733
cycle= 2 E= -526.120624572391  delta_E= -0.000348  |g|= 0.0224  |ddm|= 0.0288
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0409442
diis-c [-0.00143474  0.02915633  0.97084367]
  HOMO = -0.579859066855873  LUMO = 0.626752358069599
  mo_energy =
[-1.18407283e+02 -1.21899446e+01 -9.52291579e+00 -9.52291579e+00
 -9.52291579e+00 -1.26321031e+00 -5.79859067e-01 -5.79859067e-01
 -5.79859067e-01  6.26752358e-01  6.26752358e-01  6.26752358e-01
  3.11842575e+00  3.11842575e+00  3.11842575e+00  1.76859380e+01
  1.76859380e+01  1.76859380e+01  5.33258124e+01  9.91619224e+01
  9.91619224e+01  9.91619224e+01  3.76253665e+02  4.48664049e+02
  4.48664049e+02  4.48664049e+02  1.30470112e+03  1.30470112e+03
  1.30470112e+03  2.17240134e+03  3.00532172e+03  3.00532172e+03
  3.00532172e+03  6.63161102e+03  6.63161102e+03  6.63161102e+03
  8.52436175e+03  2.48995487e+04  7.56788218e+04]
E1 = -727.8444000092994  E_coul = 201.72376210309434
cycle= 3 E= -526.120637906205  delta_E= -1.33e-05  |g|= 0.0037  |ddm|= 0.00537
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00659058
diis-c [-3.31808938e-07 -8.86077152e-04  1.34957365e-01  8.65928712e-01]
  HOMO = -0.580797969706405  LUMO = 0.626351124751642
  mo_energy =
[-1.18413679e+02 -1.21935435e+01 -9.52658540e+00 -9.52658540e+00
 -9.52658540e+00 -1.26441888e+00 -5.80797970e-01 -5.80797970e-01
 -5.80797970e-01  6.26351125e-01  6.26351125e-01  6.26351125e-01
  3.11707118e+00  3.11707118e+00  3.11707118e+00  1.76826623e+01
  1.76826623e+01  1.76826623e+01  5.33210114e+01  9.91567072e+01
  9.91567072e+01  9.91567072e+01  3.76247331e+02  4.48657696e+02
  4.48657696e+02  4.48657696e+02  1.30469436e+03  1.30469436e+03
  1.30469436e+03  2.17239422e+03  3.00531472e+03  3.00531472e+03
  3.00531472e+03  6.63160380e+03  6.63160380e+03  6.63160380e+03
  8.52435440e+03  2.48995413e+04  7.56788142e+04]
E1 = -727.8554362410063  E_coul = 201.73479785124712
cycle= 4 E= -526.120638389759  delta_E= -4.84e-07  |g|= 9.02e-05  |ddm|= 0.000834
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000142342
diis-c [-1.70600848e-09 -4.58144124e-06  2.10529422e-03  3.29993278e-02
  9.64899959e-01]
  HOMO = -0.580775291067421  LUMO = 0.62635758564551
  mo_energy =
[-1.18413520e+02 -1.21934225e+01 -9.52646282e+00 -9.52646282e+00
 -9.52646282e+00 -1.26438521e+00 -5.80775291e-01 -5.80775291e-01
 -5.80775291e-01  6.26357586e-01  6.26357586e-01  6.26357586e-01
  3.11710700e+00  3.11710700e+00  3.11710700e+00  1.76827689e+01
  1.76827689e+01  1.76827689e+01  5.33211507e+01  9.91568510e+01
  9.91568510e+01  9.91568510e+01  3.76247488e+02  4.48657853e+02
  4.48657853e+02  4.48657853e+02  1.30469452e+03  1.30469452e+03
  1.30469452e+03  2.17239438e+03  3.00531488e+03  3.00531488e+03
  3.00531488e+03  6.63160396e+03  6.63160396e+03  6.63160396e+03
  8.52435456e+03  2.48995414e+04  7.56788144e+04]
E1 = -727.8550217184941  E_coul = 201.73438332786117
cycle= 5 E= -526.120638390633  delta_E= -8.74e-10  |g|= 8.3e-06  |ddm|= 7.04e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.8550217184941  E_coul = 201.73438332786117
  HOMO = -0.580781056369903  LUMO = 0.626354824443372
  mo_energy =
[-1.18413534e+02 -1.21934342e+01 -9.52647461e+00 -9.52647461e+00
 -9.52647461e+00 -1.26439211e+00 -5.80781056e-01 -5.80781056e-01
 -5.80781056e-01  6.26354824e-01  6.26354824e-01  6.26354824e-01
  3.11709949e+00  3.11709949e+00  3.11709949e+00  1.76827577e+01
  1.76827577e+01  1.76827577e+01  5.33211380e+01  9.91568381e+01
  9.91568381e+01  9.91568381e+01  3.76247474e+02  4.48657840e+02
  4.48657840e+02  4.48657840e+02  1.30469451e+03  1.30469451e+03
  1.30469451e+03  2.17239437e+03  3.00531487e+03  3.00531487e+03
  3.00531487e+03  6.63160394e+03  6.63160394e+03  6.63160394e+03
  8.52435455e+03  2.48995414e+04  7.56788144e+04]
E1 = -727.8550462265958  E_coul = 201.7344078359551
Extra cycle  E= -526.120638390641  delta_E= -7.96e-12  |g|= 1.51e-06  |ddm|= 7.47e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.23 sec
exp = [2.61825149e+04 7.61816032e+03 3.61805572e+03 1.61539499e+03
 2.63465788e+02 7.74733107e+01 2.85687749e+01 4.79961776e+00
 3.91588719e-01 1.36278632e+03 6.65095646e+02 3.02852620e+02
 3.15733860e+02 5.78044132e+01 4.68542533e+00 1.62372223e+01
 5.19265291e-01 1.17258708e+00 1.65734343e-01]
E = -526.1206383906408
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:41:44 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.512472         1
[INPUT] 0    0    [1    /1   ]  7618.19191372        1
[INPUT] 0    0    [1    /1   ]  3618.12398332        1
[INPUT] 0    0    [1    /1   ]  1616.39317365        1
[INPUT] 0    0    [1    /1   ]  254.91699044         1
[INPUT] 0    0    [1    /1   ]  69.3829820885        1
[INPUT] 0    0    [1    /1   ]  22.18089143          1
[INPUT] 0    0    [1    /1   ]  4.49926880349        1
[INPUT] 0    0    [1    /1   ]  0.401761194514       1
[INPUT] 1    0    [1    /1   ]  1362.78866538        1
[INPUT] 1    0    [1    /1   ]  665.125402602        1
[INPUT] 1    0    [1    /1   ]  303.016405347        1
[INPUT] 1    0    [1    /1   ]  315.878250651        1
[INPUT] 1    0    [1    /1   ]  54.7588111076        1
[INPUT] 1    0    [1    /1   ]  5.088358388          1
[INPUT] 1    0    [1    /1   ]  15.7257857837        1
[INPUT] 1    0    [1    /1   ]  0.538554854371       1
[INPUT] 1    0    [1    /1   ]  1.59467321866        1
[INPUT] 1    0    [1    /1   ]  0.16501158339        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.5124719842, 1.0]], [0, [7618.1919137183795, 1.0]], [0, [3618.1239833223094, 1.0]], [0, [1616.3931736498996, 1.0]], [0, [254.91699044048056, 1.0]], [0, [69.38298208848192, 1.0]], [0, [22.18089143001119, 1.0]], [0, [4.4992688034869, 1.0]], [0, [0.4017611945137737, 1.0]], [1, [1362.7886653801659, 1.0]], [1, [665.1254026018759, 1.0]], [1, [303.0164053473636, 1.0]], [1, [315.8782506508391, 1.0]], [1, [54.758811107578644, 1.0]], [1, [5.088358388002647, 1.0]], [1, [15.72578578369648, 1.0]], [1, [0.5385548543706036, 1.0]], [1, [1.594673218660692, 1.0]], [1, [0.16501158339041977, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.51247198]
bas 1, expnt(s) = [7618.19191372]
bas 2, expnt(s) = [3618.12398332]
bas 3, expnt(s) = [1616.39317365]
bas 4, expnt(s) = [254.91699044]
bas 5, expnt(s) = [69.38298209]
bas 6, expnt(s) = [22.18089143]
bas 7, expnt(s) = [4.4992688]
bas 8, expnt(s) = [0.40176119]
bas 9, expnt(s) = [1362.78866538]
bas 10, expnt(s) = [665.1254026]
bas 11, expnt(s) = [303.01640535]
bas 12, expnt(s) = [315.87825065]
bas 13, expnt(s) = [54.75881111]
bas 14, expnt(s) = [5.08835839]
bas 15, expnt(s) = [15.72578578]
bas 16, expnt(s) = [0.53855485]
bas 17, expnt(s) = [1.59467322]
bas 18, expnt(s) = [0.16501158]
CPU time:       341.96
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825125e+04 5.20024151e+03 7.61819191e+03 2.06017426e+03
 3.61812398e+03 1.17863032e+03 1.61639317e+03 6.44058446e+02
 2.54916990e+02 1.61181098e+02 6.93829821e+01 6.07371970e+01
 2.21808914e+01 2.58225586e+01 4.49926880e+00 7.80497434e+00
 4.01761195e-01 1.27494372e+00 1.36278867e+03 2.41557226e+04
 6.65125403e+02 9.85402843e+03 3.03016405e+02 3.68822213e+03
 3.15878251e+02 3.88493760e+03 5.47588111e+01 4.34562159e+02
 5.08835839e+00 2.22949503e+01 1.57257858e+01 9.13586844e+01
 5.38554854e-01 1.34592799e+00 1.59467322e+00 5.22786084e+00
 1.65011583e-01 3.06815596e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98145749758916
cond(S) = 89718.46231972416
E1 = -728.5094613148009  E_coul = 203.23596491925463
init E= -525.273496395546
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.557595166633172  LUMO = 0.642115629078653
  mo_energy =
[-1.18163689e+02 -1.21039606e+01 -9.43521201e+00 -9.43521201e+00
 -9.43521201e+00 -1.22681346e+00 -5.57595167e-01 -5.57595167e-01
 -5.57595167e-01  6.42115629e-01  6.42115629e-01  6.42115629e-01
  3.86760832e+00  3.86760832e+00  3.86760832e+00  2.01330788e+01
  2.01330788e+01  2.01330788e+01  3.92266745e+01  9.76503858e+01
  9.76503858e+01  9.76503858e+01  3.25414244e+02  4.40526877e+02
  4.40526877e+02  4.40526877e+02  1.29538244e+03  1.29538244e+03
  1.29538244e+03  2.09451442e+03  2.99637799e+03  2.99637799e+03
  2.99637799e+03  6.62363785e+03  6.62363785e+03  6.62363785e+03
  8.44664885e+03  2.48255597e+04  7.56101661e+04]
E1 = -727.6364929845561  E_coul = 201.4554641817656
cycle= 1 E= -526.18102880279  delta_E= -0.908  |g|= 0.215  |ddm|=  0.3
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.547847
diis-c [-0.30013615  1.        ]
  HOMO = -0.581950974157864  LUMO = 0.634498235365322
  mo_energy =
[-1.18453233e+02 -1.22236771e+01 -9.55970951e+00 -9.55970951e+00
 -9.55970951e+00 -1.26117267e+00 -5.81950974e-01 -5.81950974e-01
 -5.81950974e-01  6.34498235e-01  6.34498235e-01  6.34498235e-01
  3.81994893e+00  3.81994893e+00  3.81994893e+00  2.00195593e+01
  2.00195593e+01  2.00195593e+01  3.90731774e+01  9.74513511e+01
  9.74513511e+01  9.74513511e+01  3.25128946e+02  4.40235340e+02
  4.40235340e+02  4.40235340e+02  1.29503194e+03  1.29503194e+03
  1.29503194e+03  2.09402861e+03  2.99596006e+03  2.99596006e+03
  2.99596006e+03  6.62308907e+03  6.62308907e+03  6.62308907e+03
  8.44600980e+03  2.48248165e+04  7.56093245e+04]
E1 = -728.0077189787326  E_coul = 201.8262430605574
cycle= 2 E= -526.181475918175  delta_E= -0.000447  |g|= 0.0282  |ddm|= 0.024
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0515734
diis-c [-0.00195698  0.04630197  0.95369803]
  HOMO = -0.576833865661507  LUMO = 0.636756150005149
  mo_energy =
[-1.18402689e+02 -1.21981604e+01 -9.53349742e+00 -9.53349742e+00
 -9.53349742e+00 -1.25437180e+00 -5.76833866e-01 -5.76833866e-01
 -5.76833866e-01  6.36756150e-01  6.36756150e-01  6.36756150e-01
  3.82960656e+00  3.82960656e+00  3.82960656e+00  2.00427668e+01
  2.00427668e+01  2.00427668e+01  3.91068152e+01  9.74905903e+01
  9.74905903e+01  9.74905903e+01  3.25178345e+02  4.40285431e+02
  4.40285431e+02  4.40285431e+02  1.29508551e+03  1.29508551e+03
  1.29508551e+03  2.09408468e+03  2.99601546e+03  2.99601546e+03
  2.99601546e+03  6.62314578e+03  6.62314578e+03  6.62314578e+03
  8.44606710e+03  2.48248742e+04  7.56093822e+04]
E1 = -727.9221696387112  E_coul = 201.74067224404317
cycle= 3 E= -526.181497394668  delta_E= -2.15e-05  |g|= 0.00433  |ddm|= 0.00667
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00832369
diis-c [-3.52649582e-07 -1.04621980e-03  1.34265495e-01  8.66780725e-01]
  HOMO = -0.577851567997426  LUMO = 0.63630043790469
  mo_energy =
[-1.18409965e+02 -1.22022117e+01 -9.53770156e+00 -9.53770156e+00
 -9.53770156e+00 -1.25568347e+00 -5.77851568e-01 -5.77851568e-01
 -5.77851568e-01  6.36300438e-01  6.36300438e-01  6.36300438e-01
  3.82781847e+00  3.82781847e+00  3.82781847e+00  2.00389936e+01
  2.00389936e+01  2.00389936e+01  3.91017794e+01  9.74847420e+01
  9.74847420e+01  9.74847420e+01  3.25171212e+02  4.40278215e+02
  4.40278215e+02  4.40278215e+02  1.29507782e+03  1.29507782e+03
  1.29507782e+03  2.09407653e+03  2.99600747e+03  2.99600747e+03
  2.99600747e+03  6.62313749e+03  6.62313749e+03  6.62313749e+03
  8.44605864e+03  2.48248656e+04  7.56093736e+04]
E1 = -727.9351785153743  E_coul = 201.75368045601067
cycle= 4 E= -526.181498059364  delta_E= -6.65e-07  |g|= 5.21e-05  |ddm|= 0.000995
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.43699e-05
diis-c [-2.25845355e-09 -4.14930639e-06  3.42018633e-04  7.41615913e-03
  9.92245972e-01]
  HOMO = -0.577827298319018  LUMO = 0.636310363759626
  mo_energy =
[-1.18409865e+02 -1.22021178e+01 -9.53760980e+00 -9.53760980e+00
 -9.53760980e+00 -1.25565004e+00 -5.77827298e-01 -5.77827298e-01
 -5.77827298e-01  6.36310364e-01  6.36310364e-01  6.36310364e-01
  3.82786126e+00  3.82786126e+00  3.82786126e+00  2.00390752e+01
  2.00390752e+01  2.00390752e+01  3.91018792e+01  9.74848391e+01
  9.74848391e+01  9.74848391e+01  3.25171311e+02  4.40278314e+02
  4.40278314e+02  4.40278314e+02  1.29507791e+03  1.29507791e+03
  1.29507791e+03  2.09407662e+03  2.99600756e+03  2.99600756e+03
  2.99600756e+03  6.62313758e+03  6.62313758e+03  6.62313758e+03
  8.44605872e+03  2.48248657e+04  7.56093736e+04]
E1 = -727.9349042618627  E_coul = 201.75340620224802
cycle= 5 E= -526.181498059615  delta_E= -2.51e-10  |g|= 8.64e-06  |ddm|= 3.54e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.9349042618627  E_coul = 201.75340620224802
  HOMO = -0.577832321199261  LUMO = 0.636308066120259
  mo_energy =
[-1.18409885e+02 -1.22021325e+01 -9.53762499e+00 -9.53762499e+00
 -9.53762499e+00 -1.25565636e+00 -5.77832321e-01 -5.77832321e-01
 -5.77832321e-01  6.36308066e-01  6.36308066e-01  6.36308066e-01
  3.82785313e+00  3.82785313e+00  3.82785313e+00  2.00390612e+01
  2.00390612e+01  2.00390612e+01  3.91018628e+01  9.74848211e+01
  9.74848211e+01  9.74848211e+01  3.25171291e+02  4.40278294e+02
  4.40278294e+02  4.40278294e+02  1.29507789e+03  1.29507789e+03
  1.29507789e+03  2.09407660e+03  2.99600754e+03  2.99600754e+03
  2.99600754e+03  6.62313756e+03  6.62313756e+03  6.62313756e+03
  8.44605870e+03  2.48248656e+04  7.56093736e+04]
E1 = -727.9349455680128  E_coul = 201.753447508393
Extra cycle  E= -526.18149805962  delta_E= -5.12e-12  |g|= 2.31e-06  |ddm|= 3.4e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.23 sec
exp = [2.61825125e+04 7.61819191e+03 3.61812398e+03 1.61639317e+03
 2.54916990e+02 6.93829821e+01 2.21808914e+01 4.49926880e+00
 4.01761195e-01 1.36278867e+03 6.65125403e+02 3.03016405e+02
 3.15878251e+02 5.47588111e+01 5.08835839e+00 1.57257858e+01
 5.38554854e-01 1.59467322e+00 1.65011583e-01]
E = -526.1814980596198
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:41:45 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.512472         1
[INPUT] 0    0    [1    /1   ]  7618.19191372        1
[INPUT] 0    0    [1    /1   ]  3618.12398332        1
[INPUT] 0    0    [1    /1   ]  1616.39317365        1
[INPUT] 0    0    [1    /1   ]  254.91699044         1
[INPUT] 0    0    [1    /1   ]  69.3829820885        1
[INPUT] 0    0    [1    /1   ]  22.18089143          1
[INPUT] 0    0    [1    /1   ]  4.49926880349        1
[INPUT] 0    0    [1    /1   ]  0.401761194514       1
[INPUT] 1    0    [1    /1   ]  1362.78866538        1
[INPUT] 1    0    [1    /1   ]  665.125402602        1
[INPUT] 1    0    [1    /1   ]  303.016405347        1
[INPUT] 1    0    [1    /1   ]  315.878250651        1
[INPUT] 1    0    [1    /1   ]  54.7588111076        1
[INPUT] 1    0    [1    /1   ]  5.088358388          1
[INPUT] 1    0    [1    /1   ]  15.7257857837        1
[INPUT] 1    0    [1    /1   ]  0.538554854371       1
[INPUT] 1    0    [1    /1   ]  1.59467321866        1
[INPUT] 1    0    [1    /1   ]  0.16501158339        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.5124719842, 1.0]], [0, [7618.1919137183795, 1.0]], [0, [3618.1239833223094, 1.0]], [0, [1616.3931736498996, 1.0]], [0, [254.91699044048056, 1.0]], [0, [69.38298208848192, 1.0]], [0, [22.18089143001119, 1.0]], [0, [4.4992688034869, 1.0]], [0, [0.4017611945137737, 1.0]], [1, [1362.7886653801659, 1.0]], [1, [665.1254026018759, 1.0]], [1, [303.0164053473636, 1.0]], [1, [315.8782506508391, 1.0]], [1, [54.758811107578644, 1.0]], [1, [5.088358388002647, 1.0]], [1, [15.72578578369648, 1.0]], [1, [0.5385548543706036, 1.0]], [1, [1.594673218660692, 1.0]], [1, [0.16501158339041977, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.51247198]
bas 1, expnt(s) = [7618.19191372]
bas 2, expnt(s) = [3618.12398332]
bas 3, expnt(s) = [1616.39317365]
bas 4, expnt(s) = [254.91699044]
bas 5, expnt(s) = [69.38298209]
bas 6, expnt(s) = [22.18089143]
bas 7, expnt(s) = [4.4992688]
bas 8, expnt(s) = [0.40176119]
bas 9, expnt(s) = [1362.78866538]
bas 10, expnt(s) = [665.1254026]
bas 11, expnt(s) = [303.01640535]
bas 12, expnt(s) = [315.87825065]
bas 13, expnt(s) = [54.75881111]
bas 14, expnt(s) = [5.08835839]
bas 15, expnt(s) = [15.72578578]
bas 16, expnt(s) = [0.53855485]
bas 17, expnt(s) = [1.59467322]
bas 18, expnt(s) = [0.16501158]
CPU time:       342.70
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825125e+04 5.20024151e+03 7.61819191e+03 2.06017426e+03
 3.61812398e+03 1.17863032e+03 1.61639317e+03 6.44058446e+02
 2.54916990e+02 1.61181098e+02 6.93829821e+01 6.07371970e+01
 2.21808914e+01 2.58225586e+01 4.49926880e+00 7.80497434e+00
 4.01761195e-01 1.27494372e+00 1.36278867e+03 2.41557226e+04
 6.65125403e+02 9.85402843e+03 3.03016405e+02 3.68822213e+03
 3.15878251e+02 3.88493760e+03 5.47588111e+01 4.34562159e+02
 5.08835839e+00 2.22949503e+01 1.57257858e+01 9.13586844e+01
 5.38554854e-01 1.34592799e+00 1.59467322e+00 5.22786084e+00
 1.65011583e-01 3.06815596e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98145749758916
cond(S) = 89718.46231972416
E1 = -728.5094613148009  E_coul = 203.23596491925463
init E= -525.273496395546
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.557595166633172  LUMO = 0.642115629078653
  mo_energy =
[-1.18163689e+02 -1.21039606e+01 -9.43521201e+00 -9.43521201e+00
 -9.43521201e+00 -1.22681346e+00 -5.57595167e-01 -5.57595167e-01
 -5.57595167e-01  6.42115629e-01  6.42115629e-01  6.42115629e-01
  3.86760832e+00  3.86760832e+00  3.86760832e+00  2.01330788e+01
  2.01330788e+01  2.01330788e+01  3.92266745e+01  9.76503858e+01
  9.76503858e+01  9.76503858e+01  3.25414244e+02  4.40526877e+02
  4.40526877e+02  4.40526877e+02  1.29538244e+03  1.29538244e+03
  1.29538244e+03  2.09451442e+03  2.99637799e+03  2.99637799e+03
  2.99637799e+03  6.62363785e+03  6.62363785e+03  6.62363785e+03
  8.44664885e+03  2.48255597e+04  7.56101661e+04]
E1 = -727.6364929845561  E_coul = 201.4554641817656
cycle= 1 E= -526.18102880279  delta_E= -0.908  |g|= 0.215  |ddm|=  0.3
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.547847
diis-c [-0.30013615  1.        ]
  HOMO = -0.581950974157864  LUMO = 0.634498235365322
  mo_energy =
[-1.18453233e+02 -1.22236771e+01 -9.55970951e+00 -9.55970951e+00
 -9.55970951e+00 -1.26117267e+00 -5.81950974e-01 -5.81950974e-01
 -5.81950974e-01  6.34498235e-01  6.34498235e-01  6.34498235e-01
  3.81994893e+00  3.81994893e+00  3.81994893e+00  2.00195593e+01
  2.00195593e+01  2.00195593e+01  3.90731774e+01  9.74513511e+01
  9.74513511e+01  9.74513511e+01  3.25128946e+02  4.40235340e+02
  4.40235340e+02  4.40235340e+02  1.29503194e+03  1.29503194e+03
  1.29503194e+03  2.09402861e+03  2.99596006e+03  2.99596006e+03
  2.99596006e+03  6.62308907e+03  6.62308907e+03  6.62308907e+03
  8.44600980e+03  2.48248165e+04  7.56093245e+04]
E1 = -728.0077189787326  E_coul = 201.8262430605574
cycle= 2 E= -526.181475918175  delta_E= -0.000447  |g|= 0.0282  |ddm|= 0.024
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0515734
diis-c [-0.00195698  0.04630197  0.95369803]
  HOMO = -0.576833865661507  LUMO = 0.636756150005149
  mo_energy =
[-1.18402689e+02 -1.21981604e+01 -9.53349742e+00 -9.53349742e+00
 -9.53349742e+00 -1.25437180e+00 -5.76833866e-01 -5.76833866e-01
 -5.76833866e-01  6.36756150e-01  6.36756150e-01  6.36756150e-01
  3.82960656e+00  3.82960656e+00  3.82960656e+00  2.00427668e+01
  2.00427668e+01  2.00427668e+01  3.91068152e+01  9.74905903e+01
  9.74905903e+01  9.74905903e+01  3.25178345e+02  4.40285431e+02
  4.40285431e+02  4.40285431e+02  1.29508551e+03  1.29508551e+03
  1.29508551e+03  2.09408468e+03  2.99601546e+03  2.99601546e+03
  2.99601546e+03  6.62314578e+03  6.62314578e+03  6.62314578e+03
  8.44606710e+03  2.48248742e+04  7.56093822e+04]
E1 = -727.9221696387112  E_coul = 201.74067224404317
cycle= 3 E= -526.181497394668  delta_E= -2.15e-05  |g|= 0.00433  |ddm|= 0.00667
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00832369
diis-c [-3.52649582e-07 -1.04621980e-03  1.34265495e-01  8.66780725e-01]
  HOMO = -0.577851567997426  LUMO = 0.63630043790469
  mo_energy =
[-1.18409965e+02 -1.22022117e+01 -9.53770156e+00 -9.53770156e+00
 -9.53770156e+00 -1.25568347e+00 -5.77851568e-01 -5.77851568e-01
 -5.77851568e-01  6.36300438e-01  6.36300438e-01  6.36300438e-01
  3.82781847e+00  3.82781847e+00  3.82781847e+00  2.00389936e+01
  2.00389936e+01  2.00389936e+01  3.91017794e+01  9.74847420e+01
  9.74847420e+01  9.74847420e+01  3.25171212e+02  4.40278215e+02
  4.40278215e+02  4.40278215e+02  1.29507782e+03  1.29507782e+03
  1.29507782e+03  2.09407653e+03  2.99600747e+03  2.99600747e+03
  2.99600747e+03  6.62313749e+03  6.62313749e+03  6.62313749e+03
  8.44605864e+03  2.48248656e+04  7.56093736e+04]
E1 = -727.9351785153743  E_coul = 201.75368045601067
cycle= 4 E= -526.181498059364  delta_E= -6.65e-07  |g|= 5.21e-05  |ddm|= 0.000995
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.43699e-05
diis-c [-2.25845355e-09 -4.14930639e-06  3.42018633e-04  7.41615913e-03
  9.92245972e-01]
  HOMO = -0.577827298319018  LUMO = 0.636310363759626
  mo_energy =
[-1.18409865e+02 -1.22021178e+01 -9.53760980e+00 -9.53760980e+00
 -9.53760980e+00 -1.25565004e+00 -5.77827298e-01 -5.77827298e-01
 -5.77827298e-01  6.36310364e-01  6.36310364e-01  6.36310364e-01
  3.82786126e+00  3.82786126e+00  3.82786126e+00  2.00390752e+01
  2.00390752e+01  2.00390752e+01  3.91018792e+01  9.74848391e+01
  9.74848391e+01  9.74848391e+01  3.25171311e+02  4.40278314e+02
  4.40278314e+02  4.40278314e+02  1.29507791e+03  1.29507791e+03
  1.29507791e+03  2.09407662e+03  2.99600756e+03  2.99600756e+03
  2.99600756e+03  6.62313758e+03  6.62313758e+03  6.62313758e+03
  8.44605872e+03  2.48248657e+04  7.56093736e+04]
E1 = -727.9349042618627  E_coul = 201.75340620224802
cycle= 5 E= -526.181498059615  delta_E= -2.51e-10  |g|= 8.64e-06  |ddm|= 3.54e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.9349042618627  E_coul = 201.75340620224802
  HOMO = -0.577832321199261  LUMO = 0.636308066120259
  mo_energy =
[-1.18409885e+02 -1.22021325e+01 -9.53762499e+00 -9.53762499e+00
 -9.53762499e+00 -1.25565636e+00 -5.77832321e-01 -5.77832321e-01
 -5.77832321e-01  6.36308066e-01  6.36308066e-01  6.36308066e-01
  3.82785313e+00  3.82785313e+00  3.82785313e+00  2.00390612e+01
  2.00390612e+01  2.00390612e+01  3.91018628e+01  9.74848211e+01
  9.74848211e+01  9.74848211e+01  3.25171291e+02  4.40278294e+02
  4.40278294e+02  4.40278294e+02  1.29507789e+03  1.29507789e+03
  1.29507789e+03  2.09407660e+03  2.99600754e+03  2.99600754e+03
  2.99600754e+03  6.62313756e+03  6.62313756e+03  6.62313756e+03
  8.44605870e+03  2.48248656e+04  7.56093736e+04]
E1 = -727.9349455680128  E_coul = 201.753447508393
Extra cycle  E= -526.18149805962  delta_E= -5.12e-12  |g|= 2.31e-06  |ddm|= 3.4e-06
    CPU time for scf_cycle      0.61 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 89718.46231972416
E1 = -727.9349455680128  E_coul = 201.753447508393
init E= -526.18149805962
    CPU time for initialize scf      2.72 sec, wall time      0.24 sec
  HOMO = -0.577831566528737  LUMO = 0.636308391935919
  mo_energy =
[-1.18409880e+02 -1.22021295e+01 -9.53762185e+00 -9.53762185e+00
 -9.53762185e+00 -1.25565536e+00 -5.77831567e-01 -5.77831567e-01
 -5.77831567e-01  6.36308392e-01  6.36308392e-01  6.36308392e-01
  3.82785447e+00  3.82785447e+00  3.82785447e+00  2.00390640e+01
  2.00390640e+01  2.00390640e+01  3.91018664e+01  9.74848252e+01
  9.74848252e+01  9.74848252e+01  3.25171296e+02  4.40278299e+02
  4.40278299e+02  4.40278299e+02  1.29507790e+03  1.29507790e+03
  1.29507790e+03  2.09407660e+03  2.99600754e+03  2.99600754e+03
  2.99600754e+03  6.62313756e+03  6.62313756e+03  6.62313756e+03
  8.44605871e+03  2.48248656e+04  7.56093736e+04]
E1 = -727.9349358311472  E_coul = 201.75343777152787
cycle= 1 E= -526.181498059619  delta_E= 4.55e-13  |g|= 5.68e-07  |ddm|= 8.73e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.9349358311472  E_coul = 201.75343777152787
  HOMO = -0.577831751552112  LUMO = 0.63630830909592
  mo_energy =
[-1.18409881e+02 -1.22021302e+01 -9.53762258e+00 -9.53762258e+00
 -9.53762258e+00 -1.25565560e+00 -5.77831752e-01 -5.77831752e-01
 -5.77831752e-01  6.36308309e-01  6.36308309e-01  6.36308309e-01
  3.82785415e+00  3.82785415e+00  3.82785415e+00  2.00390634e+01
  2.00390634e+01  2.00390634e+01  3.91018656e+01  9.74848243e+01
  9.74848243e+01  9.74848243e+01  3.25171295e+02  4.40278298e+02
  4.40278298e+02  4.40278298e+02  1.29507790e+03  1.29507790e+03
  1.29507790e+03  2.09407660e+03  2.99600754e+03  2.99600754e+03
  2.99600754e+03  6.62313756e+03  6.62313756e+03  6.62313756e+03
  8.44605871e+03  2.48248656e+04  7.56093736e+04]
E1 = -727.9349380318013  E_coul = 201.7534399721823
Extra cycle  E= -526.181498059619  delta_E= 3.41e-13  |g|= 1.34e-07  |ddm|= 1.73e-07
    CPU time for scf_cycle      2.84 sec, wall time      0.37 sec
exp = [2.61825125e+04 7.61819191e+03 3.61812398e+03 1.61639317e+03
 2.54916990e+02 6.93829821e+01 2.21808914e+01 4.49926880e+00
 4.01761195e-01 1.36278867e+03 6.65125403e+02 3.03016405e+02
 3.15878251e+02 5.47588111e+01 5.08835839e+00 1.57257858e+01
 5.38554854e-01 1.59467322e+00 1.65011583e-01]
grad_E = [-1.97798711e-06  2.30884787e-05  4.74542642e-05  7.33363698e-04
 -9.62585958e-03  1.31456513e-02 -1.05435963e-02  4.02070774e-02
  9.05940900e-02 -3.66281350e-07  6.18220461e-06  2.74438175e-05
  2.41389334e-05  3.16119230e-03 -1.75774670e-02 -6.11537873e-03
 -2.74742418e-02 -3.17668053e-03 -5.93197292e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:41:49 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5148113        1
[INPUT] 0    0    [1    /1   ]  7618.16211971        1
[INPUT] 0    0    [1    /1   ]  3618.05981343        1
[INPUT] 0    0    [1    /1   ]  1615.45302001        1
[INPUT] 0    0    [1    /1   ]  262.59479456         1
[INPUT] 0    0    [1    /1   ]  78.3466181969        1
[INPUT] 0    0    [1    /1   ]  30.7032722163        1
[INPUT] 0    0    [1    /1   ]  4.72601455242        1
[INPUT] 0    0    [1    /1   ]  0.389652557069       1
[INPUT] 1    0    [1    /1   ]  1362.78646989        1
[INPUT] 1    0    [1    /1   ]  665.097409069        1
[INPUT] 1    0    [1    /1   ]  302.862457582        1
[INPUT] 1    0    [1    /1   ]  315.74253418         1
[INPUT] 1    0    [1    /1   ]  57.5224505236        1
[INPUT] 1    0    [1    /1   ]  5.36674916365        1
[INPUT] 1    0    [1    /1   ]  16.2638178022        1
[INPUT] 1    0    [1    /1   ]  0.59736856504        1
[INPUT] 1    0    [1    /1   ]  1.75099893045        1
[INPUT] 1    0    [1    /1   ]  0.185621971827       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.51481129804, 1.0]], [0, [7618.162119710172, 1.0]], [0, [3618.059813432793, 1.0]], [0, [1615.4530200141462, 1.0]], [0, [262.5947945601123, 1.0]], [0, [78.34661819692269, 1.0]], [0, [30.703272216326237, 1.0]], [0, [4.726014552423718, 1.0]], [0, [0.38965255706913515, 1.0]], [1, [1362.7864698931637, 1.0]], [1, [665.0974090685958, 1.0]], [1, [302.8624575817368, 1.0]], [1, [315.7425341801534, 1.0]], [1, [57.52245052358535, 1.0]], [1, [5.366749163652667, 1.0]], [1, [16.26381780218843, 1.0]], [1, [0.5973685650398222, 1.0]], [1, [1.7509989304502858, 1.0]], [1, [0.18562197182689677, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.5148113]
bas 1, expnt(s) = [7618.16211971]
bas 2, expnt(s) = [3618.05981343]
bas 3, expnt(s) = [1615.45302001]
bas 4, expnt(s) = [262.59479456]
bas 5, expnt(s) = [78.3466182]
bas 6, expnt(s) = [30.70327222]
bas 7, expnt(s) = [4.72601455]
bas 8, expnt(s) = [0.38965256]
bas 9, expnt(s) = [1362.78646989]
bas 10, expnt(s) = [665.09740907]
bas 11, expnt(s) = [302.86245758]
bas 12, expnt(s) = [315.74253418]
bas 13, expnt(s) = [57.52245052]
bas 14, expnt(s) = [5.36674916]
bas 15, expnt(s) = [16.2638178]
bas 16, expnt(s) = [0.59736857]
bas 17, expnt(s) = [1.75099893]
bas 18, expnt(s) = [0.18562197]
CPU time:       350.80
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825148e+04 5.20024186e+03 7.61816212e+03 2.06016821e+03
 3.61805981e+03 1.17861464e+03 1.61545302e+03 6.43777470e+02
 2.62594795e+02 1.64808501e+02 7.83466182e+01 6.65319443e+01
 3.07032722e+01 3.29536498e+01 4.72601455e+00 8.09815929e+00
 3.89652557e-01 1.24601472e+00 1.36278647e+03 2.41556740e+04
 6.65097409e+02 9.85351002e+03 3.02862458e+02 3.68588003e+03
 3.15742534e+02 3.88285127e+03 5.75224505e+01 4.62148041e+02
 5.36674916e+00 2.38299710e+01 1.62638178e+01 9.52823628e+01
 5.97368565e-01 1.53210083e+00 1.75099893e+00 5.87613471e+00
 1.85621972e-01 3.55443944e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.979760956481925
cond(S) = 93266.74774339145
E1 = -728.6570879633651  E_coul = 203.22575061338586
init E= -525.431337349979
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.562042441592525  LUMO = 0.750973094984101
  mo_energy =
[-1.18172184e+02 -1.20904522e+01 -9.43241001e+00 -9.43241001e+00
 -9.43241001e+00 -1.23397462e+00 -5.62042442e-01 -5.62042442e-01
 -5.62042442e-01  7.50973095e-01  7.50973095e-01  7.50973095e-01
  4.42915976e+00  4.42915976e+00  4.42915976e+00  2.19069948e+01
  2.19069948e+01  2.19069948e+01  5.69717874e+01  1.03424001e+02
  1.03424001e+02  1.03424001e+02  3.85522630e+02  4.51432355e+02
  4.51432355e+02  4.51432355e+02  1.30695771e+03  1.30695771e+03
  1.30695771e+03  2.18093622e+03  3.00743058e+03  3.00743058e+03
  3.00743058e+03  6.63367026e+03  6.63367026e+03  6.63367026e+03
  8.53189817e+03  2.49067586e+04  7.56856765e+04]
E1 = -727.9559033191897  E_coul = 201.77026542697092
cycle= 1 E= -526.185637892219  delta_E= -0.754  |g|= 0.185  |ddm|= 0.565
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.514547
diis-c [-0.2647582  1.       ]
  HOMO = -0.580556941592434  LUMO = 0.744629873523481
  mo_energy =
[-1.18416607e+02 -1.21939752e+01 -9.53139568e+00 -9.53139568e+00
 -9.53139568e+00 -1.26139396e+00 -5.80556942e-01 -5.80556942e-01
 -5.80556942e-01  7.44629874e-01  7.44629874e-01  7.44629874e-01
  4.38799271e+00  4.38799271e+00  4.38799271e+00  2.18149842e+01
  2.18149842e+01  2.18149842e+01  5.68287602e+01  1.03258476e+02
  1.03258476e+02  1.03258476e+02  3.85277839e+02  4.51187792e+02
  4.51187792e+02  4.51187792e+02  1.30665983e+03  1.30665983e+03
  1.30665983e+03  2.18050751e+03  3.00706738e+03  3.00706738e+03
  3.00706738e+03  6.63318213e+03  6.63318213e+03  6.63318213e+03
  8.53132409e+03  2.49060838e+04  7.56849058e+04]
E1 = -728.2185987150158  E_coul = 202.03272407160614
cycle= 2 E= -526.18587464341  delta_E= -0.000237  |g|= 0.0198  |ddm|= 0.0173
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0381149
diis-c [-0.00125535  0.0266409   0.9733591 ]
  HOMO = -0.576909915726863  LUMO = 0.746534682946759
  mo_energy =
[-1.18379637e+02 -1.21755538e+01 -9.51252862e+00 -9.51252862e+00
 -9.51252862e+00 -1.25657223e+00 -5.76909916e-01 -5.76909916e-01
 -5.76909916e-01  7.46534683e-01  7.46534683e-01  7.46534683e-01
  4.39547841e+00  4.39547841e+00  4.39547841e+00  2.18320978e+01
  2.18320978e+01  2.18320978e+01  5.68557519e+01  1.03287329e+02
  1.03287329e+02  1.03287329e+02  3.85314526e+02  4.51224436e+02
  4.51224436e+02  4.51224436e+02  1.30669919e+03  1.30669919e+03
  1.30669919e+03  2.18054887e+03  3.00710819e+03  3.00710819e+03
  3.00710819e+03  6.63322398e+03  6.63322398e+03  6.63322398e+03
  8.53136640e+03  2.49061263e+04  7.56849484e+04]
E1 = -728.1591495025833  E_coul = 201.9732645334307
cycle= 3 E= -526.185884969153  delta_E= -1.03e-05  |g|= 0.00335  |ddm|= 0.00468
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0064238
diis-c [-1.32142631e-07 -8.89694056e-04  1.40654976e-01  8.60234718e-01]
  HOMO = -0.577666606313605  LUMO = 0.746138960984068
  mo_energy =
[-1.18385383e+02 -1.21787391e+01 -9.51578753e+00 -9.51578753e+00
 -9.51578753e+00 -1.25755359e+00 -5.77666606e-01 -5.77666606e-01
 -5.77666606e-01  7.46138961e-01  7.46138961e-01  7.46138961e-01
  4.39402570e+00  4.39402570e+00  4.39402570e+00  2.18291249e+01
  2.18291249e+01  2.18291249e+01  5.68513942e+01  1.03282693e+02
  1.03282693e+02  1.03282693e+02  3.85308834e+02  4.51218741e+02
  4.51218741e+02  4.51218741e+02  1.30669312e+03  1.30669312e+03
  1.30669312e+03  2.18054248e+03  3.00710191e+03  3.00710191e+03
  3.00710191e+03  6.63321750e+03  6.63321750e+03  6.63321750e+03
  8.53135980e+03  2.49061196e+04  7.56849416e+04]
E1 = -728.1689328690359  E_coul = 201.9830475205426
cycle= 4 E= -526.185885348493  delta_E= -3.79e-07  |g|= 5.01e-05  |ddm|= 0.000778
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=8.324e-05
diis-c [-3.62230824e-10 -3.85700843e-05  6.64717008e-03  5.19686861e-02
  9.41422714e-01]
  HOMO = -0.577643386561493  LUMO = 0.746150646998859
  mo_energy =
[-1.18385282e+02 -1.21786563e+01 -9.51570419e+00 -9.51570419e+00
 -9.51570419e+00 -1.25752290e+00 -5.77643387e-01 -5.77643387e-01
 -5.77643387e-01  7.46150647e-01  7.46150647e-01  7.46150647e-01
  4.39406857e+00  4.39406857e+00  4.39406857e+00  2.18292007e+01
  2.18292007e+01  2.18292007e+01  5.68514875e+01  1.03282786e+02
  1.03282786e+02  1.03282786e+02  3.85308935e+02  4.51218842e+02
  4.51218842e+02  4.51218842e+02  1.30669322e+03  1.30669322e+03
  1.30669322e+03  2.18054258e+03  3.00710201e+03  3.00710201e+03
  3.00710201e+03  6.63321760e+03  6.63321760e+03  6.63321760e+03
  8.53135990e+03  2.49061197e+04  7.56849417e+04]
E1 = -728.1686989516508  E_coul = 201.9828136029567
cycle= 5 E= -526.185885348694  delta_E= -2.01e-10  |g|= 2.76e-06  |ddm|= 2.54e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.1686989516508  E_coul = 201.9828136029567
  HOMO = -0.577645070422313  LUMO = 0.746149739852727
  mo_energy =
[-1.18385288e+02 -1.21786609e+01 -9.51570886e+00 -9.51570886e+00
 -9.51570886e+00 -1.25752498e+00 -5.77645070e-01 -5.77645070e-01
 -5.77645070e-01  7.46149740e-01  7.46149740e-01  7.46149740e-01
  4.39406575e+00  4.39406575e+00  4.39406575e+00  2.18291963e+01
  2.18291963e+01  2.18291963e+01  5.68514822e+01  1.03282781e+02
  1.03282781e+02  1.03282781e+02  3.85308929e+02  4.51218836e+02
  4.51218836e+02  4.51218836e+02  1.30669322e+03  1.30669322e+03
  1.30669322e+03  2.18054257e+03  3.00710200e+03  3.00710200e+03
  3.00710200e+03  6.63321759e+03  6.63321759e+03  6.63321759e+03
  8.53135990e+03  2.49061197e+04  7.56849417e+04]
E1 = -728.1687106680163  E_coul = 201.98282531932318
Extra cycle  E= -526.185885348693  delta_E= 9.09e-13  |g|= 6.51e-07  |ddm|= 1.04e-06
    CPU time for scf_cycle      0.68 sec, wall time      0.29 sec
exp = [2.61825148e+04 7.61816212e+03 3.61805981e+03 1.61545302e+03
 2.62594795e+02 7.83466182e+01 3.07032722e+01 4.72601455e+00
 3.89652557e-01 1.36278647e+03 6.65097409e+02 3.02862458e+02
 3.15742534e+02 5.75224505e+01 5.36674916e+00 1.62638178e+01
 5.97368565e-01 1.75099893e+00 1.85621972e-01]
E = -526.1858853486931
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:41:50 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5148113        1
[INPUT] 0    0    [1    /1   ]  7618.16211971        1
[INPUT] 0    0    [1    /1   ]  3618.05981343        1
[INPUT] 0    0    [1    /1   ]  1615.45302001        1
[INPUT] 0    0    [1    /1   ]  262.59479456         1
[INPUT] 0    0    [1    /1   ]  78.3466181969        1
[INPUT] 0    0    [1    /1   ]  30.7032722163        1
[INPUT] 0    0    [1    /1   ]  4.72601455242        1
[INPUT] 0    0    [1    /1   ]  0.389652557069       1
[INPUT] 1    0    [1    /1   ]  1362.78646989        1
[INPUT] 1    0    [1    /1   ]  665.097409069        1
[INPUT] 1    0    [1    /1   ]  302.862457582        1
[INPUT] 1    0    [1    /1   ]  315.74253418         1
[INPUT] 1    0    [1    /1   ]  57.5224505236        1
[INPUT] 1    0    [1    /1   ]  5.36674916365        1
[INPUT] 1    0    [1    /1   ]  16.2638178022        1
[INPUT] 1    0    [1    /1   ]  0.59736856504        1
[INPUT] 1    0    [1    /1   ]  1.75099893045        1
[INPUT] 1    0    [1    /1   ]  0.185621971827       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.51481129804, 1.0]], [0, [7618.162119710172, 1.0]], [0, [3618.059813432793, 1.0]], [0, [1615.4530200141462, 1.0]], [0, [262.5947945601123, 1.0]], [0, [78.34661819692269, 1.0]], [0, [30.703272216326237, 1.0]], [0, [4.726014552423718, 1.0]], [0, [0.38965255706913515, 1.0]], [1, [1362.7864698931637, 1.0]], [1, [665.0974090685958, 1.0]], [1, [302.8624575817368, 1.0]], [1, [315.7425341801534, 1.0]], [1, [57.52245052358535, 1.0]], [1, [5.366749163652667, 1.0]], [1, [16.26381780218843, 1.0]], [1, [0.5973685650398222, 1.0]], [1, [1.7509989304502858, 1.0]], [1, [0.18562197182689677, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.5148113]
bas 1, expnt(s) = [7618.16211971]
bas 2, expnt(s) = [3618.05981343]
bas 3, expnt(s) = [1615.45302001]
bas 4, expnt(s) = [262.59479456]
bas 5, expnt(s) = [78.3466182]
bas 6, expnt(s) = [30.70327222]
bas 7, expnt(s) = [4.72601455]
bas 8, expnt(s) = [0.38965256]
bas 9, expnt(s) = [1362.78646989]
bas 10, expnt(s) = [665.09740907]
bas 11, expnt(s) = [302.86245758]
bas 12, expnt(s) = [315.74253418]
bas 13, expnt(s) = [57.52245052]
bas 14, expnt(s) = [5.36674916]
bas 15, expnt(s) = [16.2638178]
bas 16, expnt(s) = [0.59736857]
bas 17, expnt(s) = [1.75099893]
bas 18, expnt(s) = [0.18562197]
CPU time:       351.61
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825148e+04 5.20024186e+03 7.61816212e+03 2.06016821e+03
 3.61805981e+03 1.17861464e+03 1.61545302e+03 6.43777470e+02
 2.62594795e+02 1.64808501e+02 7.83466182e+01 6.65319443e+01
 3.07032722e+01 3.29536498e+01 4.72601455e+00 8.09815929e+00
 3.89652557e-01 1.24601472e+00 1.36278647e+03 2.41556740e+04
 6.65097409e+02 9.85351002e+03 3.02862458e+02 3.68588003e+03
 3.15742534e+02 3.88285127e+03 5.75224505e+01 4.62148041e+02
 5.36674916e+00 2.38299710e+01 1.62638178e+01 9.52823628e+01
 5.97368565e-01 1.53210083e+00 1.75099893e+00 5.87613471e+00
 1.85621972e-01 3.55443944e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.979760956481925
cond(S) = 93266.74774339145
E1 = -728.6570879633651  E_coul = 203.22575061338586
init E= -525.431337349979
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.562042441592525  LUMO = 0.750973094984101
  mo_energy =
[-1.18172184e+02 -1.20904522e+01 -9.43241001e+00 -9.43241001e+00
 -9.43241001e+00 -1.23397462e+00 -5.62042442e-01 -5.62042442e-01
 -5.62042442e-01  7.50973095e-01  7.50973095e-01  7.50973095e-01
  4.42915976e+00  4.42915976e+00  4.42915976e+00  2.19069948e+01
  2.19069948e+01  2.19069948e+01  5.69717874e+01  1.03424001e+02
  1.03424001e+02  1.03424001e+02  3.85522630e+02  4.51432355e+02
  4.51432355e+02  4.51432355e+02  1.30695771e+03  1.30695771e+03
  1.30695771e+03  2.18093622e+03  3.00743058e+03  3.00743058e+03
  3.00743058e+03  6.63367026e+03  6.63367026e+03  6.63367026e+03
  8.53189817e+03  2.49067586e+04  7.56856765e+04]
E1 = -727.9559033191897  E_coul = 201.77026542697092
cycle= 1 E= -526.185637892219  delta_E= -0.754  |g|= 0.185  |ddm|= 0.565
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.514547
diis-c [-0.2647582  1.       ]
  HOMO = -0.580556941592434  LUMO = 0.744629873523481
  mo_energy =
[-1.18416607e+02 -1.21939752e+01 -9.53139568e+00 -9.53139568e+00
 -9.53139568e+00 -1.26139396e+00 -5.80556942e-01 -5.80556942e-01
 -5.80556942e-01  7.44629874e-01  7.44629874e-01  7.44629874e-01
  4.38799271e+00  4.38799271e+00  4.38799271e+00  2.18149842e+01
  2.18149842e+01  2.18149842e+01  5.68287602e+01  1.03258476e+02
  1.03258476e+02  1.03258476e+02  3.85277839e+02  4.51187792e+02
  4.51187792e+02  4.51187792e+02  1.30665983e+03  1.30665983e+03
  1.30665983e+03  2.18050751e+03  3.00706738e+03  3.00706738e+03
  3.00706738e+03  6.63318213e+03  6.63318213e+03  6.63318213e+03
  8.53132409e+03  2.49060838e+04  7.56849058e+04]
E1 = -728.2185987150158  E_coul = 202.03272407160614
cycle= 2 E= -526.18587464341  delta_E= -0.000237  |g|= 0.0198  |ddm|= 0.0173
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0381149
diis-c [-0.00125535  0.0266409   0.9733591 ]
  HOMO = -0.576909915726863  LUMO = 0.746534682946759
  mo_energy =
[-1.18379637e+02 -1.21755538e+01 -9.51252862e+00 -9.51252862e+00
 -9.51252862e+00 -1.25657223e+00 -5.76909916e-01 -5.76909916e-01
 -5.76909916e-01  7.46534683e-01  7.46534683e-01  7.46534683e-01
  4.39547841e+00  4.39547841e+00  4.39547841e+00  2.18320978e+01
  2.18320978e+01  2.18320978e+01  5.68557519e+01  1.03287329e+02
  1.03287329e+02  1.03287329e+02  3.85314526e+02  4.51224436e+02
  4.51224436e+02  4.51224436e+02  1.30669919e+03  1.30669919e+03
  1.30669919e+03  2.18054887e+03  3.00710819e+03  3.00710819e+03
  3.00710819e+03  6.63322398e+03  6.63322398e+03  6.63322398e+03
  8.53136640e+03  2.49061263e+04  7.56849484e+04]
E1 = -728.1591495025833  E_coul = 201.9732645334307
cycle= 3 E= -526.185884969153  delta_E= -1.03e-05  |g|= 0.00335  |ddm|= 0.00468
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0064238
diis-c [-1.32142631e-07 -8.89694056e-04  1.40654976e-01  8.60234718e-01]
  HOMO = -0.577666606313605  LUMO = 0.746138960984068
  mo_energy =
[-1.18385383e+02 -1.21787391e+01 -9.51578753e+00 -9.51578753e+00
 -9.51578753e+00 -1.25755359e+00 -5.77666606e-01 -5.77666606e-01
 -5.77666606e-01  7.46138961e-01  7.46138961e-01  7.46138961e-01
  4.39402570e+00  4.39402570e+00  4.39402570e+00  2.18291249e+01
  2.18291249e+01  2.18291249e+01  5.68513942e+01  1.03282693e+02
  1.03282693e+02  1.03282693e+02  3.85308834e+02  4.51218741e+02
  4.51218741e+02  4.51218741e+02  1.30669312e+03  1.30669312e+03
  1.30669312e+03  2.18054248e+03  3.00710191e+03  3.00710191e+03
  3.00710191e+03  6.63321750e+03  6.63321750e+03  6.63321750e+03
  8.53135980e+03  2.49061196e+04  7.56849416e+04]
E1 = -728.1689328690359  E_coul = 201.9830475205426
cycle= 4 E= -526.185885348493  delta_E= -3.79e-07  |g|= 5.01e-05  |ddm|= 0.000778
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=8.324e-05
diis-c [-3.62230824e-10 -3.85700843e-05  6.64717008e-03  5.19686861e-02
  9.41422714e-01]
  HOMO = -0.577643386561493  LUMO = 0.746150646998859
  mo_energy =
[-1.18385282e+02 -1.21786563e+01 -9.51570419e+00 -9.51570419e+00
 -9.51570419e+00 -1.25752290e+00 -5.77643387e-01 -5.77643387e-01
 -5.77643387e-01  7.46150647e-01  7.46150647e-01  7.46150647e-01
  4.39406857e+00  4.39406857e+00  4.39406857e+00  2.18292007e+01
  2.18292007e+01  2.18292007e+01  5.68514875e+01  1.03282786e+02
  1.03282786e+02  1.03282786e+02  3.85308935e+02  4.51218842e+02
  4.51218842e+02  4.51218842e+02  1.30669322e+03  1.30669322e+03
  1.30669322e+03  2.18054258e+03  3.00710201e+03  3.00710201e+03
  3.00710201e+03  6.63321760e+03  6.63321760e+03  6.63321760e+03
  8.53135990e+03  2.49061197e+04  7.56849417e+04]
E1 = -728.1686989516508  E_coul = 201.9828136029567
cycle= 5 E= -526.185885348694  delta_E= -2.01e-10  |g|= 2.76e-06  |ddm|= 2.54e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.1686989516508  E_coul = 201.9828136029567
  HOMO = -0.577645070422313  LUMO = 0.746149739852727
  mo_energy =
[-1.18385288e+02 -1.21786609e+01 -9.51570886e+00 -9.51570886e+00
 -9.51570886e+00 -1.25752498e+00 -5.77645070e-01 -5.77645070e-01
 -5.77645070e-01  7.46149740e-01  7.46149740e-01  7.46149740e-01
  4.39406575e+00  4.39406575e+00  4.39406575e+00  2.18291963e+01
  2.18291963e+01  2.18291963e+01  5.68514822e+01  1.03282781e+02
  1.03282781e+02  1.03282781e+02  3.85308929e+02  4.51218836e+02
  4.51218836e+02  4.51218836e+02  1.30669322e+03  1.30669322e+03
  1.30669322e+03  2.18054257e+03  3.00710200e+03  3.00710200e+03
  3.00710200e+03  6.63321759e+03  6.63321759e+03  6.63321759e+03
  8.53135990e+03  2.49061197e+04  7.56849417e+04]
E1 = -728.1687106680163  E_coul = 201.98282531932318
Extra cycle  E= -526.185885348693  delta_E= 9.09e-13  |g|= 6.51e-07  |ddm|= 1.04e-06
    CPU time for scf_cycle      0.63 sec, wall time      0.25 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 93266.74774339145
E1 = -728.1687106680163  E_coul = 201.98282531932318
init E= -526.185885348693
    CPU time for initialize scf      2.73 sec, wall time      0.26 sec
  HOMO = -0.577644868069215  LUMO = 0.74614984106183
  mo_energy =
[-1.18385287e+02 -1.21786600e+01 -9.51570797e+00 -9.51570797e+00
 -9.51570797e+00 -1.25752471e+00 -5.77644868e-01 -5.77644868e-01
 -5.77644868e-01  7.46149841e-01  7.46149841e-01  7.46149841e-01
  4.39406614e+00  4.39406614e+00  4.39406614e+00  2.18291971e+01
  2.18291971e+01  2.18291971e+01  5.68514833e+01  1.03282782e+02
  1.03282782e+02  1.03282782e+02  3.85308930e+02  4.51218837e+02
  4.51218837e+02  4.51218837e+02  1.30669322e+03  1.30669322e+03
  1.30669322e+03  2.18054257e+03  3.00710200e+03  3.00710200e+03
  3.00710200e+03  6.63321759e+03  6.63321759e+03  6.63321759e+03
  8.53135990e+03  2.49061197e+04  7.56849417e+04]
E1 = -728.1687079540131  E_coul = 201.98282260531874
cycle= 1 E= -526.185885348694  delta_E= -1.36e-12  |g|= 1.55e-07  |ddm|= 2.71e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.1687079540131  E_coul = 201.98282260531874
  HOMO = -0.577644920056084  LUMO = 0.746149813735974
  mo_energy =
[-1.18385287e+02 -1.21786602e+01 -9.51570817e+00 -9.51570817e+00
 -9.51570817e+00 -1.25752477e+00 -5.77644920e-01 -5.77644920e-01
 -5.77644920e-01  7.46149814e-01  7.46149814e-01  7.46149814e-01
  4.39406605e+00  4.39406605e+00  4.39406605e+00  2.18291969e+01
  2.18291969e+01  2.18291969e+01  5.68514831e+01  1.03282782e+02
  1.03282782e+02  1.03282782e+02  3.85308930e+02  4.51218837e+02
  4.51218837e+02  4.51218837e+02  1.30669322e+03  1.30669322e+03
  1.30669322e+03  2.18054257e+03  3.00710200e+03  3.00710200e+03
  3.00710200e+03  6.63321759e+03  6.63321759e+03  6.63321759e+03
  8.53135990e+03  2.49061197e+04  7.56849417e+04]
E1 = -728.1687085386127  E_coul = 201.9828231899187
Extra cycle  E= -526.185885348694  delta_E= 4.55e-13  |g|= 3.5e-08  |ddm|= 4.66e-08
    CPU time for scf_cycle      2.86 sec, wall time      0.39 sec
exp = [2.61825148e+04 7.61816212e+03 3.61805981e+03 1.61545302e+03
 2.62594795e+02 7.83466182e+01 3.07032722e+01 4.72601455e+00
 3.89652557e-01 1.36278647e+03 6.65097409e+02 3.02862458e+02
 3.15742534e+02 5.75224505e+01 5.36674916e+00 1.62638178e+01
 5.97368565e-01 1.75099893e+00 1.85621972e-01]
grad_E = [-1.98565909e-06  2.10572994e-05  4.09775007e-05  6.63894432e-04
 -7.84963587e-03  3.71519638e-03  4.05370834e-03  1.64161101e-01
 -1.11185022e-01 -6.13303174e-07  2.36157603e-06  5.52369253e-06
  5.20893526e-06  4.90917865e-03  1.15857634e-02 -1.99532343e-02
 -3.45637274e-02 -1.36909407e-02  2.20536547e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:41:54 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5141544        1
[INPUT] 0    0    [1    /1   ]  7618.17044405        1
[INPUT] 0    0    [1    /1   ]  3618.07770118        1
[INPUT] 0    0    [1    /1   ]  1615.71544096        1
[INPUT] 0    0    [1    /1   ]  260.543121002        1
[INPUT] 0    0    [1    /1   ]  75.5066142381        1
[INPUT] 0    0    [1    /1   ]  27.7820923505        1
[INPUT] 0    0    [1    /1   ]  4.50219610606        1
[INPUT] 0    0    [1    /1   ]  0.388478177261       1
[INPUT] 1    0    [1    /1   ]  1362.78707499        1
[INPUT] 1    0    [1    /1   ]  665.105191324        1
[INPUT] 1    0    [1    /1   ]  302.905206273        1
[INPUT] 1    0    [1    /1   ]  315.780219407        1
[INPUT] 1    0    [1    /1   ]  56.7964954392        1
[INPUT] 1    0    [1    /1   ]  5.22767456538        1
[INPUT] 1    0    [1    /1   ]  16.0011644893        1
[INPUT] 1    0    [1    /1   ]  0.622563652984       1
[INPUT] 1    0    [1    /1   ]  1.71845809613        1
[INPUT] 1    0    [1    /1   ]  0.194181061011       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.514154391894, 1.0]], [0, [7618.170444050159, 1.0]], [0, [3618.0777011769687, 1.0]], [0, [1615.715440955682, 1.0]], [0, [260.54312100197563, 1.0]], [0, [75.50661423805762, 1.0]], [0, [27.782092350517654, 1.0]], [0, [4.502196106059607, 1.0]], [0, [0.3884781772609259, 1.0]], [1, [1362.7870749869826, 1.0]], [1, [665.1051913237809, 1.0]], [1, [302.9052062730457, 1.0]], [1, [315.78021940690803, 1.0]], [1, [56.796495439154384, 1.0]], [1, [5.227674565383293, 1.0]], [1, [16.00116448926284, 1.0]], [1, [0.6225636529836962, 1.0]], [1, [1.7184580961257427, 1.0]], [1, [0.1941810610111752, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.51415439]
bas 1, expnt(s) = [7618.17044405]
bas 2, expnt(s) = [3618.07770118]
bas 3, expnt(s) = [1615.71544096]
bas 4, expnt(s) = [260.543121]
bas 5, expnt(s) = [75.50661424]
bas 6, expnt(s) = [27.78209235]
bas 7, expnt(s) = [4.50219611]
bas 8, expnt(s) = [0.38847818]
bas 9, expnt(s) = [1362.78707499]
bas 10, expnt(s) = [665.10519132]
bas 11, expnt(s) = [302.90520627]
bas 12, expnt(s) = [315.78021941]
bas 13, expnt(s) = [56.79649544]
bas 14, expnt(s) = [5.22767457]
bas 15, expnt(s) = [16.00116449]
bas 16, expnt(s) = [0.62256365]
bas 17, expnt(s) = [1.7184581]
bas 18, expnt(s) = [0.19418106]
CPU time:       359.70
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825142e+04 5.20024176e+03 7.61817044e+03 2.06016990e+03
 3.61807770e+03 1.17861901e+03 1.61571544e+03 6.43855902e+02
 2.60543121e+02 1.63841808e+02 7.55066142e+01 6.47148236e+01
 2.77820924e+01 3.05730479e+01 4.50219611e+00 7.80878257e+00
 3.88478177e-01 1.24319712e+00 1.36278707e+03 2.41556874e+04
 6.65105191e+02 9.85365414e+03 3.02905206e+02 3.68653036e+03
 3.15780219e+02 3.88343057e+03 5.67964954e+01 4.54868975e+02
 5.22767457e+00 2.30605718e+01 1.60011645e+01 9.33628025e+01
 6.22563653e-01 1.61329614e+00 1.71845810e+00 5.73994956e+00
 1.94181061e-01 3.76047737e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982053168934172
cond(S) = 92210.4358981408
E1 = -728.2916328036666  E_coul = 203.02095050261502
init E= -525.270682301052
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.562863191404769  LUMO = 0.798399052993874
  mo_energy =
[-1.18198666e+02 -1.21159241e+01 -9.45241998e+00 -9.45241998e+00
 -9.45241998e+00 -1.23167075e+00 -5.62863191e-01 -5.62863191e-01
 -5.62863191e-01  7.98399053e-01  7.98399053e-01  7.98399053e-01
  4.48130565e+00  4.48130565e+00  4.48130565e+00  2.14290830e+01
  2.14290830e+01  2.14290830e+01  5.01723480e+01  1.01479032e+02
  1.01479032e+02  1.01479032e+02  3.65457963e+02  4.48096585e+02
  4.48096585e+02  4.48096585e+02  1.30347601e+03  1.30347601e+03
  1.30347601e+03  2.15329170e+03  3.00411204e+03  3.00411204e+03
  3.00411204e+03  6.63065480e+03  6.63065480e+03  6.63065480e+03
  8.50481680e+03  2.48809690e+04  7.56616821e+04]
E1 = -727.5127401368463  E_coul = 201.30827690512524
cycle= 1 E= -526.204463231721  delta_E= -0.934  |g|= 0.217  |ddm|= 0.469
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.576667
diis-c [-0.33254438  1.        ]
  HOMO = -0.583104524498942  LUMO = 0.789988281015212
  mo_energy =
[-1.18497981e+02 -1.22271046e+01 -9.57157448e+00 -9.57157448e+00
 -9.57157448e+00 -1.25927688e+00 -5.83104524e-01 -5.83104524e-01
 -5.83104524e-01  7.89988281e-01  7.89988281e-01  7.89988281e-01
  4.43632098e+00  4.43632098e+00  4.43632098e+00  2.13197218e+01
  2.13197218e+01  2.13197218e+01  5.00118398e+01  1.01275111e+02
  1.01275111e+02  1.01275111e+02  3.65159059e+02  4.47797485e+02
  4.47797485e+02  4.47797485e+02  1.30311450e+03  1.30311450e+03
  1.30311450e+03  2.15278995e+03  3.00368012e+03  3.00368012e+03
  3.00368012e+03  6.63008956e+03  6.63008956e+03  6.63008956e+03
  8.50416032e+03  2.48802071e+04  7.56608210e+04]
E1 = -727.8816370354684  E_coul = 201.67667887483904
cycle= 2 E= -526.204958160629  delta_E= -0.000495  |g|= 0.0291  |ddm|= 0.0233
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0529031
diis-c [-0.00196924  0.04770284  0.95229716]
  HOMO = -0.578244250094753  LUMO = 0.792661872205483
  mo_energy =
[-1.18446581e+02 -1.22017592e+01 -9.54565049e+00 -9.54565049e+00
 -9.54565049e+00 -1.25291711e+00 -5.78244250e-01 -5.78244250e-01
 -5.78244250e-01  7.92661872e-01  7.92661872e-01  7.92661872e-01
  4.44628665e+00  4.44628665e+00  4.44628665e+00  2.13428370e+01
  2.13428370e+01  2.13428370e+01  5.00485286e+01  1.01314984e+02
  1.01314984e+02  1.01314984e+02  3.65209766e+02  4.47848442e+02
  4.47848442e+02  4.47848442e+02  1.30316902e+03  1.30316902e+03
  1.30316902e+03  2.15284689e+03  3.00373647e+03  3.00373647e+03
  3.00373647e+03  6.63014713e+03  6.63014713e+03  6.63014713e+03
  8.50421840e+03  2.48802654e+04  7.56608794e+04]
E1 = -727.8002730162524  E_coul = 201.59529400787886
cycle= 3 E= -526.204979008374  delta_E= -2.08e-05  |g|= 0.00404  |ddm|= 0.00635
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00798229
diis-c [-4.67570842e-07 -1.13717806e-03  1.25296476e-01  8.75840702e-01]
  HOMO = -0.57918079107264  LUMO = 0.792148663665503
  mo_energy =
[-1.18453508e+02 -1.22055753e+01 -9.54961564e+00 -9.54961564e+00
 -9.54961564e+00 -1.25410823e+00 -5.79180791e-01 -5.79180791e-01
 -5.79180791e-01  7.92148664e-01  7.92148664e-01  7.92148664e-01
  4.44451970e+00  4.44451970e+00  4.44451970e+00  2.13392572e+01
  2.13392572e+01  2.13392572e+01  5.00434589e+01  1.01309401e+02
  1.01309401e+02  1.01309401e+02  3.65202918e+02  4.47841575e+02
  4.47841575e+02  4.47841575e+02  1.30316168e+03  1.30316168e+03
  1.30316168e+03  2.15283910e+03  3.00372883e+03  3.00372883e+03
  3.00372883e+03  6.63013920e+03  6.63013920e+03  6.63013920e+03
  8.50421030e+03  2.48802572e+04  7.56608711e+04]
E1 = -727.8121742573998  E_coul = 201.6071946800965
cycle= 4 E= -526.204979577303  delta_E= -5.69e-07  |g|= 5.47e-05  |ddm|= 0.000941
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.83782e-05
diis-c [-3.03067459e-09 -3.08446862e-06 -3.31842188e-04  2.99074987e-03
  9.97344177e-01]
  HOMO = -0.579150246530417  LUMO = 0.792164795775988
  mo_energy =
[-1.18453397e+02 -1.22054693e+01 -9.54951196e+00 -9.54951196e+00
 -9.54951196e+00 -1.25406809e+00 -5.79150247e-01 -5.79150247e-01
 -5.79150247e-01  7.92164796e-01  7.92164796e-01  7.92164796e-01
  4.44457487e+00  4.44457487e+00  4.44457487e+00  2.13393506e+01
  2.13393506e+01  2.13393506e+01  5.00435735e+01  1.01309510e+02
  1.01309510e+02  1.01309510e+02  3.65203028e+02  4.47841685e+02
  4.47841685e+02  4.47841685e+02  1.30316179e+03  1.30316179e+03
  1.30316179e+03  2.15283919e+03  3.00372893e+03  3.00372893e+03
  3.00372893e+03  6.63013929e+03  6.63013929e+03  6.63013929e+03
  8.50421039e+03  2.48802573e+04  7.56608712e+04]
E1 = -727.8118983546286  E_coul = 201.60691877708763
cycle= 5 E= -526.204979577541  delta_E= -2.38e-10  |g|= 9.21e-06  |ddm|= 3.16e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.8118983546286  E_coul = 201.60691877708763
  HOMO = -0.579155240416661  LUMO = 0.792162070921507
  mo_energy =
[-1.18453419e+02 -1.22054854e+01 -9.54952847e+00 -9.54952847e+00
 -9.54952847e+00 -1.25407439e+00 -5.79155240e-01 -5.79155240e-01
 -5.79155240e-01  7.92162071e-01  7.92162071e-01  7.92162071e-01
  4.44456608e+00  4.44456608e+00  4.44456608e+00  2.13393356e+01
  2.13393356e+01  2.13393356e+01  5.00435549e+01  1.01309491e+02
  1.01309491e+02  1.01309491e+02  3.65203006e+02  4.47841663e+02
  4.47841663e+02  4.47841663e+02  1.30316176e+03  1.30316176e+03
  1.30316176e+03  2.15283917e+03  3.00372891e+03  3.00372891e+03
  3.00372891e+03  6.63013927e+03  6.63013927e+03  6.63013927e+03
  8.50421037e+03  2.48802573e+04  7.56608712e+04]
E1 = -727.811943562368  E_coul = 201.6069639848203
Extra cycle  E= -526.204979577548  delta_E= -6.59e-12  |g|= 2.47e-06  |ddm|= 3.92e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.23 sec
exp = [2.61825142e+04 7.61817044e+03 3.61807770e+03 1.61571544e+03
 2.60543121e+02 7.55066142e+01 2.77820924e+01 4.50219611e+00
 3.88478177e-01 1.36278707e+03 6.65105191e+02 3.02905206e+02
 3.15780219e+02 5.67964954e+01 5.22767457e+00 1.60011645e+01
 6.22563653e-01 1.71845810e+00 1.94181061e-01]
E = -526.2049795775476
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:41:54 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5141544        1
[INPUT] 0    0    [1    /1   ]  7618.17044405        1
[INPUT] 0    0    [1    /1   ]  3618.07770118        1
[INPUT] 0    0    [1    /1   ]  1615.71544096        1
[INPUT] 0    0    [1    /1   ]  260.543121002        1
[INPUT] 0    0    [1    /1   ]  75.5066142381        1
[INPUT] 0    0    [1    /1   ]  27.7820923505        1
[INPUT] 0    0    [1    /1   ]  4.50219610606        1
[INPUT] 0    0    [1    /1   ]  0.388478177261       1
[INPUT] 1    0    [1    /1   ]  1362.78707499        1
[INPUT] 1    0    [1    /1   ]  665.105191324        1
[INPUT] 1    0    [1    /1   ]  302.905206273        1
[INPUT] 1    0    [1    /1   ]  315.780219407        1
[INPUT] 1    0    [1    /1   ]  56.7964954392        1
[INPUT] 1    0    [1    /1   ]  5.22767456538        1
[INPUT] 1    0    [1    /1   ]  16.0011644893        1
[INPUT] 1    0    [1    /1   ]  0.622563652984       1
[INPUT] 1    0    [1    /1   ]  1.71845809613        1
[INPUT] 1    0    [1    /1   ]  0.194181061011       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.514154391894, 1.0]], [0, [7618.170444050159, 1.0]], [0, [3618.0777011769687, 1.0]], [0, [1615.715440955682, 1.0]], [0, [260.54312100197563, 1.0]], [0, [75.50661423805762, 1.0]], [0, [27.782092350517654, 1.0]], [0, [4.502196106059607, 1.0]], [0, [0.3884781772609259, 1.0]], [1, [1362.7870749869826, 1.0]], [1, [665.1051913237809, 1.0]], [1, [302.9052062730457, 1.0]], [1, [315.78021940690803, 1.0]], [1, [56.796495439154384, 1.0]], [1, [5.227674565383293, 1.0]], [1, [16.00116448926284, 1.0]], [1, [0.6225636529836962, 1.0]], [1, [1.7184580961257427, 1.0]], [1, [0.1941810610111752, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.51415439]
bas 1, expnt(s) = [7618.17044405]
bas 2, expnt(s) = [3618.07770118]
bas 3, expnt(s) = [1615.71544096]
bas 4, expnt(s) = [260.543121]
bas 5, expnt(s) = [75.50661424]
bas 6, expnt(s) = [27.78209235]
bas 7, expnt(s) = [4.50219611]
bas 8, expnt(s) = [0.38847818]
bas 9, expnt(s) = [1362.78707499]
bas 10, expnt(s) = [665.10519132]
bas 11, expnt(s) = [302.90520627]
bas 12, expnt(s) = [315.78021941]
bas 13, expnt(s) = [56.79649544]
bas 14, expnt(s) = [5.22767457]
bas 15, expnt(s) = [16.00116449]
bas 16, expnt(s) = [0.62256365]
bas 17, expnt(s) = [1.7184581]
bas 18, expnt(s) = [0.19418106]
CPU time:       360.49
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825142e+04 5.20024176e+03 7.61817044e+03 2.06016990e+03
 3.61807770e+03 1.17861901e+03 1.61571544e+03 6.43855902e+02
 2.60543121e+02 1.63841808e+02 7.55066142e+01 6.47148236e+01
 2.77820924e+01 3.05730479e+01 4.50219611e+00 7.80878257e+00
 3.88478177e-01 1.24319712e+00 1.36278707e+03 2.41556874e+04
 6.65105191e+02 9.85365414e+03 3.02905206e+02 3.68653036e+03
 3.15780219e+02 3.88343057e+03 5.67964954e+01 4.54868975e+02
 5.22767457e+00 2.30605718e+01 1.60011645e+01 9.33628025e+01
 6.22563653e-01 1.61329614e+00 1.71845810e+00 5.73994956e+00
 1.94181061e-01 3.76047737e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.982053168934172
cond(S) = 92210.4358981408
E1 = -728.2916328036666  E_coul = 203.02095050261502
init E= -525.270682301052
    CPU time for initialize scf      0.49 sec, wall time      0.06 sec
  HOMO = -0.562863191404769  LUMO = 0.798399052993874
  mo_energy =
[-1.18198666e+02 -1.21159241e+01 -9.45241998e+00 -9.45241998e+00
 -9.45241998e+00 -1.23167075e+00 -5.62863191e-01 -5.62863191e-01
 -5.62863191e-01  7.98399053e-01  7.98399053e-01  7.98399053e-01
  4.48130565e+00  4.48130565e+00  4.48130565e+00  2.14290830e+01
  2.14290830e+01  2.14290830e+01  5.01723480e+01  1.01479032e+02
  1.01479032e+02  1.01479032e+02  3.65457963e+02  4.48096585e+02
  4.48096585e+02  4.48096585e+02  1.30347601e+03  1.30347601e+03
  1.30347601e+03  2.15329170e+03  3.00411204e+03  3.00411204e+03
  3.00411204e+03  6.63065480e+03  6.63065480e+03  6.63065480e+03
  8.50481680e+03  2.48809690e+04  7.56616821e+04]
E1 = -727.5127401368463  E_coul = 201.30827690512524
cycle= 1 E= -526.204463231721  delta_E= -0.934  |g|= 0.217  |ddm|= 0.469
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.576667
diis-c [-0.33254438  1.        ]
  HOMO = -0.583104524498942  LUMO = 0.789988281015212
  mo_energy =
[-1.18497981e+02 -1.22271046e+01 -9.57157448e+00 -9.57157448e+00
 -9.57157448e+00 -1.25927688e+00 -5.83104524e-01 -5.83104524e-01
 -5.83104524e-01  7.89988281e-01  7.89988281e-01  7.89988281e-01
  4.43632098e+00  4.43632098e+00  4.43632098e+00  2.13197218e+01
  2.13197218e+01  2.13197218e+01  5.00118398e+01  1.01275111e+02
  1.01275111e+02  1.01275111e+02  3.65159059e+02  4.47797485e+02
  4.47797485e+02  4.47797485e+02  1.30311450e+03  1.30311450e+03
  1.30311450e+03  2.15278995e+03  3.00368012e+03  3.00368012e+03
  3.00368012e+03  6.63008956e+03  6.63008956e+03  6.63008956e+03
  8.50416032e+03  2.48802071e+04  7.56608210e+04]
E1 = -727.8816370354684  E_coul = 201.67667887483904
cycle= 2 E= -526.204958160629  delta_E= -0.000495  |g|= 0.0291  |ddm|= 0.0233
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0529031
diis-c [-0.00196924  0.04770284  0.95229716]
  HOMO = -0.578244250094753  LUMO = 0.792661872205483
  mo_energy =
[-1.18446581e+02 -1.22017592e+01 -9.54565049e+00 -9.54565049e+00
 -9.54565049e+00 -1.25291711e+00 -5.78244250e-01 -5.78244250e-01
 -5.78244250e-01  7.92661872e-01  7.92661872e-01  7.92661872e-01
  4.44628665e+00  4.44628665e+00  4.44628665e+00  2.13428370e+01
  2.13428370e+01  2.13428370e+01  5.00485286e+01  1.01314984e+02
  1.01314984e+02  1.01314984e+02  3.65209766e+02  4.47848442e+02
  4.47848442e+02  4.47848442e+02  1.30316902e+03  1.30316902e+03
  1.30316902e+03  2.15284689e+03  3.00373647e+03  3.00373647e+03
  3.00373647e+03  6.63014713e+03  6.63014713e+03  6.63014713e+03
  8.50421840e+03  2.48802654e+04  7.56608794e+04]
E1 = -727.8002730162524  E_coul = 201.59529400787886
cycle= 3 E= -526.204979008374  delta_E= -2.08e-05  |g|= 0.00404  |ddm|= 0.00635
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00798229
diis-c [-4.67570842e-07 -1.13717806e-03  1.25296476e-01  8.75840702e-01]
  HOMO = -0.57918079107264  LUMO = 0.792148663665503
  mo_energy =
[-1.18453508e+02 -1.22055753e+01 -9.54961564e+00 -9.54961564e+00
 -9.54961564e+00 -1.25410823e+00 -5.79180791e-01 -5.79180791e-01
 -5.79180791e-01  7.92148664e-01  7.92148664e-01  7.92148664e-01
  4.44451970e+00  4.44451970e+00  4.44451970e+00  2.13392572e+01
  2.13392572e+01  2.13392572e+01  5.00434589e+01  1.01309401e+02
  1.01309401e+02  1.01309401e+02  3.65202918e+02  4.47841575e+02
  4.47841575e+02  4.47841575e+02  1.30316168e+03  1.30316168e+03
  1.30316168e+03  2.15283910e+03  3.00372883e+03  3.00372883e+03
  3.00372883e+03  6.63013920e+03  6.63013920e+03  6.63013920e+03
  8.50421030e+03  2.48802572e+04  7.56608711e+04]
E1 = -727.8121742573998  E_coul = 201.6071946800965
cycle= 4 E= -526.204979577303  delta_E= -5.69e-07  |g|= 5.47e-05  |ddm|= 0.000941
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=6.83782e-05
diis-c [-3.03067459e-09 -3.08446862e-06 -3.31842188e-04  2.99074987e-03
  9.97344177e-01]
  HOMO = -0.579150246530417  LUMO = 0.792164795775988
  mo_energy =
[-1.18453397e+02 -1.22054693e+01 -9.54951196e+00 -9.54951196e+00
 -9.54951196e+00 -1.25406809e+00 -5.79150247e-01 -5.79150247e-01
 -5.79150247e-01  7.92164796e-01  7.92164796e-01  7.92164796e-01
  4.44457487e+00  4.44457487e+00  4.44457487e+00  2.13393506e+01
  2.13393506e+01  2.13393506e+01  5.00435735e+01  1.01309510e+02
  1.01309510e+02  1.01309510e+02  3.65203028e+02  4.47841685e+02
  4.47841685e+02  4.47841685e+02  1.30316179e+03  1.30316179e+03
  1.30316179e+03  2.15283919e+03  3.00372893e+03  3.00372893e+03
  3.00372893e+03  6.63013929e+03  6.63013929e+03  6.63013929e+03
  8.50421039e+03  2.48802573e+04  7.56608712e+04]
E1 = -727.8118983546286  E_coul = 201.60691877708763
cycle= 5 E= -526.204979577541  delta_E= -2.38e-10  |g|= 9.21e-06  |ddm|= 3.16e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -727.8118983546286  E_coul = 201.60691877708763
  HOMO = -0.579155240416661  LUMO = 0.792162070921507
  mo_energy =
[-1.18453419e+02 -1.22054854e+01 -9.54952847e+00 -9.54952847e+00
 -9.54952847e+00 -1.25407439e+00 -5.79155240e-01 -5.79155240e-01
 -5.79155240e-01  7.92162071e-01  7.92162071e-01  7.92162071e-01
  4.44456608e+00  4.44456608e+00  4.44456608e+00  2.13393356e+01
  2.13393356e+01  2.13393356e+01  5.00435549e+01  1.01309491e+02
  1.01309491e+02  1.01309491e+02  3.65203006e+02  4.47841663e+02
  4.47841663e+02  4.47841663e+02  1.30316176e+03  1.30316176e+03
  1.30316176e+03  2.15283917e+03  3.00372891e+03  3.00372891e+03
  3.00372891e+03  6.63013927e+03  6.63013927e+03  6.63013927e+03
  8.50421037e+03  2.48802573e+04  7.56608712e+04]
E1 = -727.811943562368  E_coul = 201.6069639848203
Extra cycle  E= -526.204979577548  delta_E= -6.59e-12  |g|= 2.47e-06  |ddm|= 3.92e-06
    CPU time for scf_cycle      0.74 sec, wall time      0.30 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 92210.4358981408
E1 = -727.811943562368  E_coul = 201.6069639848203
init E= -526.204979577548
    CPU time for initialize scf      2.72 sec, wall time      0.24 sec
  HOMO = -0.579154386024612  LUMO = 0.792162532817296
  mo_energy =
[-1.18453414e+02 -1.22054821e+01 -9.54952505e+00 -9.54952505e+00
 -9.54952505e+00 -1.25407329e+00 -5.79154386e-01 -5.79154386e-01
 -5.79154386e-01  7.92162533e-01  7.92162533e-01  7.92162533e-01
  4.44456768e+00  4.44456768e+00  4.44456768e+00  2.13393386e+01
  2.13393386e+01  2.13393386e+01  5.00435591e+01  1.01309495e+02
  1.01309495e+02  1.01309495e+02  3.65203011e+02  4.47841669e+02
  4.47841669e+02  4.47841669e+02  1.30316177e+03  1.30316177e+03
  1.30316177e+03  2.15283918e+03  3.00372892e+03  3.00372892e+03
  3.00372892e+03  6.63013927e+03  6.63013927e+03  6.63013927e+03
  8.50421037e+03  2.48802573e+04  7.56608712e+04]
E1 = -727.811933602113  E_coul = 201.60695402456633
cycle= 1 E= -526.204979577547  delta_E= 1.02e-12  |g|= 5.85e-07  |ddm|= 8.69e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.811933602113  E_coul = 201.60695402456633
  HOMO = -0.579154569040209  LUMO = 0.792162432909778
  mo_energy =
[-1.18453415e+02 -1.22054828e+01 -9.54952580e+00 -9.54952580e+00
 -9.54952580e+00 -1.25407353e+00 -5.79154569e-01 -5.79154569e-01
 -5.79154569e-01  7.92162433e-01  7.92162433e-01  7.92162433e-01
  4.44456733e+00  4.44456733e+00  4.44456733e+00  2.13393380e+01
  2.13393380e+01  2.13393380e+01  5.00435582e+01  1.01309494e+02
  1.01309494e+02  1.01309494e+02  3.65203010e+02  4.47841668e+02
  4.47841668e+02  4.47841668e+02  1.30316177e+03  1.30316177e+03
  1.30316177e+03  2.15283918e+03  3.00372891e+03  3.00372891e+03
  3.00372891e+03  6.63013927e+03  6.63013927e+03  6.63013927e+03
  8.50421037e+03  2.48802573e+04  7.56608712e+04]
E1 = -727.8119357979149  E_coul = 201.60695622036724
Extra cycle  E= -526.204979577548  delta_E= -1.02e-12  |g|= 1.33e-07  |ddm|= 1.81e-07
    CPU time for scf_cycle      2.85 sec, wall time      0.37 sec
exp = [2.61825142e+04 7.61817044e+03 3.61807770e+03 1.61571544e+03
 2.60543121e+02 7.55066142e+01 2.77820924e+01 4.50219611e+00
 3.88478177e-01 1.36278707e+03 6.65105191e+02 3.02905206e+02
 3.15780219e+02 5.67964954e+01 5.22767457e+00 1.60011645e+01
 6.22563653e-01 1.71845810e+00 1.94181061e-01]
grad_E = [-1.97953632e-06  2.17875082e-05  4.33340517e-05  6.89675215e-04
 -8.69366776e-03  7.98520654e-03 -2.42676600e-03  5.96316994e-03
 -9.91206993e-02 -5.94397344e-07  2.95388290e-06  8.75136305e-06
  7.97826193e-06  4.76659497e-03 -9.05642125e-03 -1.54663756e-02
  1.11373499e-02 -8.76614739e-03  1.60799540e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:41:59 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5146578        1
[INPUT] 0    0    [1    /1   ]  7618.1640066         1
[INPUT] 0    0    [1    /1   ]  3618.06381093        1
[INPUT] 0    0    [1    /1   ]  1615.51214346        1
[INPUT] 0    0    [1    /1   ]  262.262111931        1
[INPUT] 0    0    [1    /1   ]  77.2312600301        1
[INPUT] 0    0    [1    /1   ]  29.2556121144        1
[INPUT] 0    0    [1    /1   ]  4.50710148216        1
[INPUT] 0    0    [1    /1   ]  0.393208895163       1
[INPUT] 1    0    [1    /1   ]  1362.78659864        1
[INPUT] 1    0    [1    /1   ]  665.099142434        1
[INPUT] 1    0    [1    /1   ]  302.871923478        1
[INPUT] 1    0    [1    /1   ]  315.750877495        1
[INPUT] 1    0    [1    /1   ]  57.4085275527        1
[INPUT] 1    0    [1    /1   ]  5.21645891151        1
[INPUT] 1    0    [1    /1   ]  16.1014561379        1
[INPUT] 1    0    [1    /1   ]  0.626800009696       1
[INPUT] 1    0    [1    /1   ]  1.70751328646        1
[INPUT] 1    0    [1    /1   ]  0.195494331509       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.514657786112, 1.0]], [0, [7618.164006597417, 1.0]], [0, [3618.063810927934, 1.0]], [0, [1615.5121434634787, 1.0]], [0, [262.2621119310963, 1.0]], [0, [77.23126003012288, 1.0]], [0, [29.255612114364606, 1.0]], [0, [4.507101482159363, 1.0]], [0, [0.3932088951625108, 1.0]], [1, [1362.7865986418706, 1.0]], [1, [665.0991424342996, 1.0]], [1, [302.8719234781502, 1.0]], [1, [315.7508774951214, 1.0]], [1, [57.40852755273995, 1.0]], [1, [5.216458911513184, 1.0]], [1, [16.101456137923716, 1.0]], [1, [0.6268000096955892, 1.0]], [1, [1.707513286458903, 1.0]], [1, [0.19549433150876208, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.51465779]
bas 1, expnt(s) = [7618.1640066]
bas 2, expnt(s) = [3618.06381093]
bas 3, expnt(s) = [1615.51214346]
bas 4, expnt(s) = [262.26211193]
bas 5, expnt(s) = [77.23126003]
bas 6, expnt(s) = [29.25561211]
bas 7, expnt(s) = [4.50710148]
bas 8, expnt(s) = [0.3932089]
bas 9, expnt(s) = [1362.78659864]
bas 10, expnt(s) = [665.09914243]
bas 11, expnt(s) = [302.87192348]
bas 12, expnt(s) = [315.7508775]
bas 13, expnt(s) = [57.40852755]
bas 14, expnt(s) = [5.21645891]
bas 15, expnt(s) = [16.10145614]
bas 16, expnt(s) = [0.62680001]
bas 17, expnt(s) = [1.70751329]
bas 18, expnt(s) = [0.19549433]
CPU time:       368.65
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825147e+04 5.20024183e+03 7.61816401e+03 2.06016860e+03
 3.61806381e+03 1.17861562e+03 1.61551214e+03 6.43795141e+02
 2.62262112e+02 1.64651878e+02 7.72312600e+01 6.58203011e+01
 2.92556121e+01 3.17813189e+01 4.50710148e+00 7.81516275e+00
 3.93208895e-01 1.25453426e+00 1.36278660e+03 2.41556768e+04
 6.65099142e+02 9.85354212e+03 3.02871923e+02 3.68602403e+03
 3.15750877e+02 3.88297952e+03 5.74085276e+01 4.61004222e+02
 5.21645891e+00 2.29987446e+01 1.61014561e+01 9.40948456e+01
 6.26800010e-01 1.62703028e+00 1.70751329e+00 5.69428903e+00
 1.95494332e-01 3.79229492e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.981391293888713
cond(S) = 92896.25884956977
E1 = -728.3874616007054  E_coul = 203.08650125648248
init E= -525.300960344223
    CPU time for initialize scf      0.72 sec, wall time      0.07 sec
  HOMO = -0.560872976132136  LUMO = 0.80666115910827
  mo_energy =
[-1.18195444e+02 -1.21115464e+01 -9.44700683e+00 -9.44700683e+00
 -9.44700683e+00 -1.22995637e+00 -5.60872976e-01 -5.60872976e-01
 -5.60872976e-01  8.06661159e-01  8.06661159e-01  8.06661159e-01
  4.48592953e+00  4.48592953e+00  4.48592953e+00  2.14364245e+01
  2.14364245e+01  2.14364245e+01  5.32322642e+01  1.02283927e+02
  1.02283927e+02  1.02283927e+02  3.76382871e+02  4.50124173e+02
  4.50124173e+02  4.50124173e+02  1.30571100e+03  1.30571100e+03
  1.30571100e+03  2.16993793e+03  3.00626286e+03  3.00626286e+03
  3.00626286e+03  6.63261020e+03  6.63261020e+03  6.63261020e+03
  8.52144996e+03  2.48968386e+04  7.56764437e+04]
E1 = -727.5763221192602  E_coul = 201.36936020344584
cycle= 1 E= -526.206961915814  delta_E= -0.906  |g|= 0.215  |ddm|= 0.444
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.575745
diis-c [-0.33148247  1.        ]
  HOMO = -0.581158329840965  LUMO = 0.798190727314463
  mo_energy =
[-1.18495586e+02 -1.22230831e+01 -9.56628186e+00 -9.56628186e+00
 -9.56628186e+00 -1.25811258e+00 -5.81158330e-01 -5.81158330e-01
 -5.81158330e-01  7.98190727e-01  7.98190727e-01  7.98190727e-01
  4.44094885e+00  4.44094885e+00  4.44094885e+00  2.13267908e+01
  2.13267908e+01  2.13267908e+01  5.30676278e+01  1.02078532e+02
  1.02078532e+02  1.02078532e+02  3.76082357e+02  4.49824858e+02
  4.49824858e+02  4.49824858e+02  1.30534970e+03  1.30534970e+03
  1.30534970e+03  2.16943661e+03  3.00583118e+03  3.00583118e+03
  3.00583118e+03  6.63204588e+03  6.63204588e+03  6.63204588e+03
  8.52079496e+03  2.48960786e+04  7.56755848e+04]
E1 = -727.939798530519  E_coul = 201.73234952626254
cycle= 2 E= -526.207449004257  delta_E= -0.000487  |g|= 0.0287  |ddm|= 0.0229
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0521722
diis-c [-0.00193097  0.0467033   0.9532967 ]
  HOMO = -0.576400565938853  LUMO = 0.800831649489996
  mo_energy =
[-1.18444771e+02 -1.21980833e+01 -9.54071552e+00 -9.54071552e+00
 -9.54071552e+00 -1.25183762e+00 -5.76400566e-01 -5.76400566e-01
 -5.76400566e-01  8.00831649e-01  8.00831649e-01  8.00831649e-01
  4.45071553e+00  4.45071553e+00  4.45071553e+00  2.13496193e+01
  2.13496193e+01  2.13496193e+01  5.31044822e+01  1.02118038e+02
  1.02118038e+02  1.02118038e+02  3.76132615e+02  4.49875242e+02
  4.49875242e+02  4.49875242e+02  1.30540361e+03  1.30540361e+03
  1.30540361e+03  2.16949291e+03  3.00588689e+03  3.00588689e+03
  3.00588689e+03  6.63210279e+03  6.63210279e+03  6.63210279e+03
  8.52085238e+03  2.48961362e+04  7.56756425e+04]
E1 = -727.8596576466435  E_coul = 201.65218842637353
cycle= 3 E= -526.20746922027  delta_E= -2.02e-05  |g|= 0.00399  |ddm|= 0.00626
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00784349
diis-c [-4.57044794e-07 -1.12971959e-03  1.24891928e-01  8.76237792e-01]
  HOMO = -0.5773316679166  LUMO = 0.800316491508859
  mo_energy =
[-1.18451637e+02 -1.22018717e+01 -9.54464746e+00 -9.54464746e+00
 -9.54464746e+00 -1.25302956e+00 -5.77331668e-01 -5.77331668e-01
 -5.77331668e-01  8.00316492e-01  8.00316492e-01  8.00316492e-01
  4.44896340e+00  4.44896340e+00  4.44896340e+00  2.13460649e+01
  2.13460649e+01  2.13460649e+01  5.30993806e+01  1.02112490e+02
  1.02112490e+02  1.02112490e+02  3.76125815e+02  4.49868437e+02
  4.49868437e+02  4.49868437e+02  1.30539634e+03  1.30539634e+03
  1.30539634e+03  2.16948519e+03  3.00587933e+03  3.00587933e+03
  3.00587933e+03  6.63209494e+03  6.63209494e+03  6.63209494e+03
  8.52084437e+03  2.48961281e+04  7.56756343e+04]
E1 = -727.8714224449492  E_coul = 201.66395266978063
cycle= 4 E= -526.207469775169  delta_E= -5.55e-07  |g|= 5.64e-05  |ddm|= 0.000931
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.23052e-05
diis-c [-2.90596784e-09 -6.73597140e-06  1.50622991e-04  7.34982309e-03
  9.92506290e-01]
  HOMO = -0.577300527638913  LUMO = 0.800333079362318
  mo_energy =
[-1.18451521e+02 -1.22017630e+01 -9.54454066e+00 -9.54454066e+00
 -9.54454066e+00 -1.25298841e+00 -5.77300528e-01 -5.77300528e-01
 -5.77300528e-01  8.00333079e-01  8.00333079e-01  8.00333079e-01
  4.44901974e+00  4.44901974e+00  4.44901974e+00  2.13461612e+01
  2.13461612e+01  2.13461612e+01  5.30994991e+01  1.02112603e+02
  1.02112603e+02  1.02112603e+02  3.76125929e+02  4.49868552e+02
  4.49868552e+02  4.49868552e+02  1.30539645e+03  1.30539645e+03
  1.30539645e+03  2.16948530e+03  3.00587944e+03  3.00587944e+03
  3.00587944e+03  6.63209504e+03  6.63209504e+03  6.63209504e+03
  8.52084446e+03  2.48961282e+04  7.56756344e+04]
E1 = -727.8711366946533  E_coul = 201.66366691922468
cycle= 5 E= -526.207469775429  delta_E= -2.6e-10  |g|= 8.89e-06  |ddm|= 3.27e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.8711366946533  E_coul = 201.66366691922468
  HOMO = -0.577305396215961  LUMO = 0.800330394543625
  mo_energy =
[-1.18451542e+02 -1.22017786e+01 -9.54455664e+00 -9.54455664e+00
 -9.54455664e+00 -1.25299458e+00 -5.77305396e-01 -5.77305396e-01
 -5.77305396e-01  8.00330395e-01  8.00330395e-01  8.00330395e-01
  4.44901120e+00  4.44901120e+00  4.44901120e+00  2.13461466e+01
  2.13461466e+01  2.13461466e+01  5.30994809e+01  1.02112584e+02
  1.02112584e+02  1.02112584e+02  3.76125908e+02  4.49868531e+02
  4.49868531e+02  4.49868531e+02  1.30539643e+03  1.30539643e+03
  1.30539643e+03  2.16948527e+03  3.00587942e+03  3.00587942e+03
  3.00587942e+03  6.63209502e+03  6.63209502e+03  6.63209502e+03
  8.52084444e+03  2.48961282e+04  7.56756343e+04]
E1 = -727.8711803267778  E_coul = 201.66371055134377
Extra cycle  E= -526.207469775434  delta_E= -5.46e-12  |g|= 2.38e-06  |ddm|= 3.76e-06
    CPU time for scf_cycle      0.91 sec, wall time      0.25 sec
exp = [2.61825147e+04 7.61816401e+03 3.61806381e+03 1.61551214e+03
 2.62262112e+02 7.72312600e+01 2.92556121e+01 4.50710148e+00
 3.93208895e-01 1.36278660e+03 6.65099142e+02 3.02871923e+02
 3.15750877e+02 5.74085276e+01 5.21645891e+00 1.61014561e+01
 6.26800010e-01 1.70751329e+00 1.95494332e-01]
E = -526.207469775434
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:41:59 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5146578        1
[INPUT] 0    0    [1    /1   ]  7618.1640066         1
[INPUT] 0    0    [1    /1   ]  3618.06381093        1
[INPUT] 0    0    [1    /1   ]  1615.51214346        1
[INPUT] 0    0    [1    /1   ]  262.262111931        1
[INPUT] 0    0    [1    /1   ]  77.2312600301        1
[INPUT] 0    0    [1    /1   ]  29.2556121144        1
[INPUT] 0    0    [1    /1   ]  4.50710148216        1
[INPUT] 0    0    [1    /1   ]  0.393208895163       1
[INPUT] 1    0    [1    /1   ]  1362.78659864        1
[INPUT] 1    0    [1    /1   ]  665.099142434        1
[INPUT] 1    0    [1    /1   ]  302.871923478        1
[INPUT] 1    0    [1    /1   ]  315.750877495        1
[INPUT] 1    0    [1    /1   ]  57.4085275527        1
[INPUT] 1    0    [1    /1   ]  5.21645891151        1
[INPUT] 1    0    [1    /1   ]  16.1014561379        1
[INPUT] 1    0    [1    /1   ]  0.626800009696       1
[INPUT] 1    0    [1    /1   ]  1.70751328646        1
[INPUT] 1    0    [1    /1   ]  0.195494331509       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.514657786112, 1.0]], [0, [7618.164006597417, 1.0]], [0, [3618.063810927934, 1.0]], [0, [1615.5121434634787, 1.0]], [0, [262.2621119310963, 1.0]], [0, [77.23126003012288, 1.0]], [0, [29.255612114364606, 1.0]], [0, [4.507101482159363, 1.0]], [0, [0.3932088951625108, 1.0]], [1, [1362.7865986418706, 1.0]], [1, [665.0991424342996, 1.0]], [1, [302.8719234781502, 1.0]], [1, [315.7508774951214, 1.0]], [1, [57.40852755273995, 1.0]], [1, [5.216458911513184, 1.0]], [1, [16.101456137923716, 1.0]], [1, [0.6268000096955892, 1.0]], [1, [1.707513286458903, 1.0]], [1, [0.19549433150876208, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.51465779]
bas 1, expnt(s) = [7618.1640066]
bas 2, expnt(s) = [3618.06381093]
bas 3, expnt(s) = [1615.51214346]
bas 4, expnt(s) = [262.26211193]
bas 5, expnt(s) = [77.23126003]
bas 6, expnt(s) = [29.25561211]
bas 7, expnt(s) = [4.50710148]
bas 8, expnt(s) = [0.3932089]
bas 9, expnt(s) = [1362.78659864]
bas 10, expnt(s) = [665.09914243]
bas 11, expnt(s) = [302.87192348]
bas 12, expnt(s) = [315.7508775]
bas 13, expnt(s) = [57.40852755]
bas 14, expnt(s) = [5.21645891]
bas 15, expnt(s) = [16.10145614]
bas 16, expnt(s) = [0.62680001]
bas 17, expnt(s) = [1.70751329]
bas 18, expnt(s) = [0.19549433]
CPU time:       369.69
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825147e+04 5.20024183e+03 7.61816401e+03 2.06016860e+03
 3.61806381e+03 1.17861562e+03 1.61551214e+03 6.43795141e+02
 2.62262112e+02 1.64651878e+02 7.72312600e+01 6.58203011e+01
 2.92556121e+01 3.17813189e+01 4.50710148e+00 7.81516275e+00
 3.93208895e-01 1.25453426e+00 1.36278660e+03 2.41556768e+04
 6.65099142e+02 9.85354212e+03 3.02871923e+02 3.68602403e+03
 3.15750877e+02 3.88297952e+03 5.74085276e+01 4.61004222e+02
 5.21645891e+00 2.29987446e+01 1.61014561e+01 9.40948456e+01
 6.26800010e-01 1.62703028e+00 1.70751329e+00 5.69428903e+00
 1.95494332e-01 3.79229492e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.981391293888713
cond(S) = 92896.25884956977
E1 = -728.3874616007054  E_coul = 203.08650125648248
init E= -525.300960344223
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.560872976132136  LUMO = 0.80666115910827
  mo_energy =
[-1.18195444e+02 -1.21115464e+01 -9.44700683e+00 -9.44700683e+00
 -9.44700683e+00 -1.22995637e+00 -5.60872976e-01 -5.60872976e-01
 -5.60872976e-01  8.06661159e-01  8.06661159e-01  8.06661159e-01
  4.48592953e+00  4.48592953e+00  4.48592953e+00  2.14364245e+01
  2.14364245e+01  2.14364245e+01  5.32322642e+01  1.02283927e+02
  1.02283927e+02  1.02283927e+02  3.76382871e+02  4.50124173e+02
  4.50124173e+02  4.50124173e+02  1.30571100e+03  1.30571100e+03
  1.30571100e+03  2.16993793e+03  3.00626286e+03  3.00626286e+03
  3.00626286e+03  6.63261020e+03  6.63261020e+03  6.63261020e+03
  8.52144996e+03  2.48968386e+04  7.56764437e+04]
E1 = -727.5763221192602  E_coul = 201.36936020344584
cycle= 1 E= -526.206961915814  delta_E= -0.906  |g|= 0.215  |ddm|= 0.444
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.575745
diis-c [-0.33148247  1.        ]
  HOMO = -0.581158329840965  LUMO = 0.798190727314463
  mo_energy =
[-1.18495586e+02 -1.22230831e+01 -9.56628186e+00 -9.56628186e+00
 -9.56628186e+00 -1.25811258e+00 -5.81158330e-01 -5.81158330e-01
 -5.81158330e-01  7.98190727e-01  7.98190727e-01  7.98190727e-01
  4.44094885e+00  4.44094885e+00  4.44094885e+00  2.13267908e+01
  2.13267908e+01  2.13267908e+01  5.30676278e+01  1.02078532e+02
  1.02078532e+02  1.02078532e+02  3.76082357e+02  4.49824858e+02
  4.49824858e+02  4.49824858e+02  1.30534970e+03  1.30534970e+03
  1.30534970e+03  2.16943661e+03  3.00583118e+03  3.00583118e+03
  3.00583118e+03  6.63204588e+03  6.63204588e+03  6.63204588e+03
  8.52079496e+03  2.48960786e+04  7.56755848e+04]
E1 = -727.939798530519  E_coul = 201.73234952626254
cycle= 2 E= -526.207449004257  delta_E= -0.000487  |g|= 0.0287  |ddm|= 0.0229
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0521722
diis-c [-0.00193097  0.0467033   0.9532967 ]
  HOMO = -0.576400565938853  LUMO = 0.800831649489996
  mo_energy =
[-1.18444771e+02 -1.21980833e+01 -9.54071552e+00 -9.54071552e+00
 -9.54071552e+00 -1.25183762e+00 -5.76400566e-01 -5.76400566e-01
 -5.76400566e-01  8.00831649e-01  8.00831649e-01  8.00831649e-01
  4.45071553e+00  4.45071553e+00  4.45071553e+00  2.13496193e+01
  2.13496193e+01  2.13496193e+01  5.31044822e+01  1.02118038e+02
  1.02118038e+02  1.02118038e+02  3.76132615e+02  4.49875242e+02
  4.49875242e+02  4.49875242e+02  1.30540361e+03  1.30540361e+03
  1.30540361e+03  2.16949291e+03  3.00588689e+03  3.00588689e+03
  3.00588689e+03  6.63210279e+03  6.63210279e+03  6.63210279e+03
  8.52085238e+03  2.48961362e+04  7.56756425e+04]
E1 = -727.8596576466435  E_coul = 201.65218842637353
cycle= 3 E= -526.20746922027  delta_E= -2.02e-05  |g|= 0.00399  |ddm|= 0.00626
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00784349
diis-c [-4.57044794e-07 -1.12971959e-03  1.24891928e-01  8.76237792e-01]
  HOMO = -0.5773316679166  LUMO = 0.800316491508859
  mo_energy =
[-1.18451637e+02 -1.22018717e+01 -9.54464746e+00 -9.54464746e+00
 -9.54464746e+00 -1.25302956e+00 -5.77331668e-01 -5.77331668e-01
 -5.77331668e-01  8.00316492e-01  8.00316492e-01  8.00316492e-01
  4.44896340e+00  4.44896340e+00  4.44896340e+00  2.13460649e+01
  2.13460649e+01  2.13460649e+01  5.30993806e+01  1.02112490e+02
  1.02112490e+02  1.02112490e+02  3.76125815e+02  4.49868437e+02
  4.49868437e+02  4.49868437e+02  1.30539634e+03  1.30539634e+03
  1.30539634e+03  2.16948519e+03  3.00587933e+03  3.00587933e+03
  3.00587933e+03  6.63209494e+03  6.63209494e+03  6.63209494e+03
  8.52084437e+03  2.48961281e+04  7.56756343e+04]
E1 = -727.8714224449492  E_coul = 201.66395266978063
cycle= 4 E= -526.207469775169  delta_E= -5.55e-07  |g|= 5.64e-05  |ddm|= 0.000931
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.23052e-05
diis-c [-2.90596784e-09 -6.73597140e-06  1.50622991e-04  7.34982309e-03
  9.92506290e-01]
  HOMO = -0.577300527638913  LUMO = 0.800333079362318
  mo_energy =
[-1.18451521e+02 -1.22017630e+01 -9.54454066e+00 -9.54454066e+00
 -9.54454066e+00 -1.25298841e+00 -5.77300528e-01 -5.77300528e-01
 -5.77300528e-01  8.00333079e-01  8.00333079e-01  8.00333079e-01
  4.44901974e+00  4.44901974e+00  4.44901974e+00  2.13461612e+01
  2.13461612e+01  2.13461612e+01  5.30994991e+01  1.02112603e+02
  1.02112603e+02  1.02112603e+02  3.76125929e+02  4.49868552e+02
  4.49868552e+02  4.49868552e+02  1.30539645e+03  1.30539645e+03
  1.30539645e+03  2.16948530e+03  3.00587944e+03  3.00587944e+03
  3.00587944e+03  6.63209504e+03  6.63209504e+03  6.63209504e+03
  8.52084446e+03  2.48961282e+04  7.56756344e+04]
E1 = -727.8711366946533  E_coul = 201.66366691922468
cycle= 5 E= -526.207469775429  delta_E= -2.6e-10  |g|= 8.89e-06  |ddm|= 3.27e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.8711366946533  E_coul = 201.66366691922468
  HOMO = -0.577305396215961  LUMO = 0.800330394543625
  mo_energy =
[-1.18451542e+02 -1.22017786e+01 -9.54455664e+00 -9.54455664e+00
 -9.54455664e+00 -1.25299458e+00 -5.77305396e-01 -5.77305396e-01
 -5.77305396e-01  8.00330395e-01  8.00330395e-01  8.00330395e-01
  4.44901120e+00  4.44901120e+00  4.44901120e+00  2.13461466e+01
  2.13461466e+01  2.13461466e+01  5.30994809e+01  1.02112584e+02
  1.02112584e+02  1.02112584e+02  3.76125908e+02  4.49868531e+02
  4.49868531e+02  4.49868531e+02  1.30539643e+03  1.30539643e+03
  1.30539643e+03  2.16948527e+03  3.00587942e+03  3.00587942e+03
  3.00587942e+03  6.63209502e+03  6.63209502e+03  6.63209502e+03
  8.52084444e+03  2.48961282e+04  7.56756343e+04]
E1 = -727.8711803267778  E_coul = 201.66371055134377
Extra cycle  E= -526.207469775434  delta_E= -5.46e-12  |g|= 2.38e-06  |ddm|= 3.76e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 92896.25884956977
E1 = -727.8711803267778  E_coul = 201.66371055134377
init E= -526.207469775434
    CPU time for initialize scf      2.80 sec, wall time      0.26 sec
  HOMO = -0.577304573413362  LUMO = 0.800330843151522
  mo_energy =
[-1.18451537e+02 -1.22017754e+01 -9.54455334e+00 -9.54455334e+00
 -9.54455334e+00 -1.25299352e+00 -5.77304573e-01 -5.77304573e-01
 -5.77304573e-01  8.00330843e-01  8.00330843e-01  8.00330843e-01
  4.44901274e+00  4.44901274e+00  4.44901274e+00  2.13461496e+01
  2.13461496e+01  2.13461496e+01  5.30994850e+01  1.02112589e+02
  1.02112589e+02  1.02112589e+02  3.76125913e+02  4.49868536e+02
  4.49868536e+02  4.49868536e+02  1.30539644e+03  1.30539644e+03
  1.30539644e+03  2.16948528e+03  3.00587942e+03  3.00587942e+03
  3.00587942e+03  6.63209502e+03  6.63209502e+03  6.63209502e+03
  8.52084444e+03  2.48961282e+04  7.56756343e+04]
E1 = -727.8711707228296  E_coul = 201.6637009473963
cycle= 1 E= -526.207469775433  delta_E= 6.82e-13  |g|= 5.6e-07  |ddm|= 8.43e-07
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
E1 = -727.8711707228296  E_coul = 201.6637009473963
  HOMO = -0.577304750351808  LUMO = 0.800330745638388
  mo_energy =
[-1.18451538e+02 -1.22017761e+01 -9.54455406e+00 -9.54455406e+00
 -9.54455406e+00 -1.25299375e+00 -5.77304750e-01 -5.77304750e-01
 -5.77304750e-01  8.00330746e-01  8.00330746e-01  8.00330746e-01
  4.44901241e+00  4.44901241e+00  4.44901241e+00  2.13461489e+01
  2.13461489e+01  2.13461489e+01  5.30994841e+01  1.02112588e+02
  1.02112588e+02  1.02112588e+02  3.76125912e+02  4.49868535e+02
  4.49868535e+02  4.49868535e+02  1.30539644e+03  1.30539644e+03
  1.30539644e+03  2.16948528e+03  3.00587942e+03  3.00587942e+03
  3.00587942e+03  6.63209502e+03  6.63209502e+03  6.63209502e+03
  8.52084444e+03  2.48961282e+04  7.56756343e+04]
E1 = -727.8711728329911  E_coul = 201.66370305755714
Extra cycle  E= -526.207469775434  delta_E= -6.82e-13  |g|= 1.27e-07  |ddm|= 1.74e-07
    CPU time for scf_cycle      2.95 sec, wall time      0.42 sec
exp = [2.61825147e+04 7.61816401e+03 3.61806381e+03 1.61551214e+03
 2.62262112e+02 7.72312600e+01 2.92556121e+01 4.50710148e+00
 3.93208895e-01 1.36278660e+03 6.65099142e+02 3.02871923e+02
 3.15750877e+02 5.74085276e+01 5.21645891e+00 1.61014561e+01
 6.26800010e-01 1.70751329e+00 1.95494332e-01]
grad_E = [-1.98047371e-06  2.12909597e-05  4.17712269e-05  6.72620234e-04
 -8.27594007e-03  6.47912899e-03  1.33484980e-04  2.41440249e-03
 -2.85992749e-02 -6.12479171e-07  2.48281393e-06  6.24531894e-06
  5.81862302e-06  4.71068035e-03 -1.74374458e-02 -1.30943080e-02
  1.90876343e-02 -7.50891866e-03 -1.52332499e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:42:03 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5149586        1
[INPUT] 0    0    [1    /1   ]  7618.16015846        1
[INPUT] 0    0    [1    /1   ]  3618.05550661        1
[INPUT] 0    0    [1    /1   ]  1615.39058302        1
[INPUT] 0    0    [1    /1   ]  263.305073807        1
[INPUT] 0    0    [1    /1   ]  78.201204335         1
[INPUT] 0    0    [1    /1   ]  30.0668687297        1
[INPUT] 0    0    [1    /1   ]  4.50941411449        1
[INPUT] 0    0    [1    /1   ]  0.396175498139       1
[INPUT] 1    0    [1    /1   ]  1362.78631422        1
[INPUT] 1    0    [1    /1   ]  665.095533952        1
[INPUT] 1    0    [1    /1   ]  302.852066165        1
[INPUT] 1    0    [1    /1   ]  315.733370858        1
[INPUT] 1    0    [1    /1   ]  57.777302493         1
[INPUT] 1    0    [1    /1   ]  5.2327563666         1
[INPUT] 1    0    [1    /1   ]  16.1433425194        1
[INPUT] 1    0    [1    /1   ]  0.6228327644         1
[INPUT] 1    0    [1    /1   ]  1.72317606804        1
[INPUT] 1    0    [1    /1   ]  0.193942730468       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.514958594118, 1.0]], [0, [7618.160158460662, 1.0]], [0, [3618.0555066080633, 1.0]], [0, [1615.3905830217009, 1.0]], [0, [263.3050738074112, 1.0]], [0, [78.20120433504738, 1.0]], [0, [30.066868729687023, 1.0]], [0, [4.5094141144912605, 1.0]], [0, [0.3961754981386977, 1.0]], [1, [1362.7863142239762, 1.0]], [1, [665.0955339517243, 1.0]], [1, [302.8520661652097, 1.0]], [1, [315.7333708583542, 1.0]], [1, [57.77730249301781, 1.0]], [1, [5.232756366597238, 1.0]], [1, [16.143342519356803, 1.0]], [1, [0.6228327643996017, 1.0]], [1, [1.7231760680390282, 1.0]], [1, [0.19394273046782481, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.51495859]
bas 1, expnt(s) = [7618.16015846]
bas 2, expnt(s) = [3618.05550661]
bas 3, expnt(s) = [1615.39058302]
bas 4, expnt(s) = [263.30507381]
bas 5, expnt(s) = [78.20120434]
bas 6, expnt(s) = [30.06686873]
bas 7, expnt(s) = [4.50941411]
bas 8, expnt(s) = [0.3961755]
bas 9, expnt(s) = [1362.78631422]
bas 10, expnt(s) = [665.09553395]
bas 11, expnt(s) = [302.85206617]
bas 12, expnt(s) = [315.73337086]
bas 13, expnt(s) = [57.77730249]
bas 14, expnt(s) = [5.23275637]
bas 15, expnt(s) = [16.14334252]
bas 16, expnt(s) = [0.62283276]
bas 17, expnt(s) = [1.72317607]
bas 18, expnt(s) = [0.19394273]
CPU time:       377.82
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825150e+04 5.20024188e+03 7.61816016e+03 2.06016782e+03
 3.61805551e+03 1.17861359e+03 1.61539058e+03 6.43758808e+02
 2.63305074e+02 1.65142724e+02 7.82012043e+01 6.64393088e+01
 3.00668687e+01 3.24400246e+01 4.50941411e+00 7.81817008e+00
 3.96175498e-01 1.26162630e+00 1.36278631e+03 2.41556705e+04
 6.65095534e+02 9.85347529e+03 3.02852066e+02 3.68572195e+03
 3.15733371e+02 3.88271041e+03 5.77773025e+01 4.64708878e+02
 5.23275637e+00 2.30885966e+01 1.61433425e+01 9.44009184e+01
 6.22832764e-01 1.61416790e+00 1.72317607e+00 5.75965487e+00
 1.93942730e-01 3.75470892e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98109334654529
cond(S) = 93324.49660275107
E1 = -728.4460597447847  E_coul = 203.12758168210556
init E= -525.318478062679
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559715341414894  LUMO = 0.798963341048923
  mo_energy =
[-1.18192960e+02 -1.21089220e+01 -9.44358959e+00 -9.44358959e+00
 -9.44358959e+00 -1.22886894e+00 -5.59715341e-01 -5.59715341e-01
 -5.59715341e-01  7.98963341e-01  7.98963341e-01  7.98963341e-01
  4.49359216e+00  4.49359216e+00  4.49359216e+00  2.15345752e+01
  2.15345752e+01  2.15345752e+01  5.49376205e+01  1.02841630e+02
  1.02841630e+02  1.02841630e+02  3.82498174e+02  4.51382616e+02
  4.51382616e+02  4.51382616e+02  1.30708944e+03  1.30708944e+03
  1.30708944e+03  2.17946153e+03  3.00758923e+03  3.00758923e+03
  3.00758923e+03  6.63381679e+03  6.63381679e+03  6.63381679e+03
  8.53101843e+03  2.49059748e+04  7.56849431e+04]
E1 = -727.6114793978516  E_coul = 201.40327680731065
cycle= 1 E= -526.208202590541  delta_E= -0.89  |g|= 0.213  |ddm|= 0.478
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.574567
diis-c [-0.33012685  1.        ]
  HOMO = -0.580243331181476  LUMO = 0.790505538669925
  mo_energy =
[-1.18493538e+02 -1.22210763e+01 -9.56324485e+00 -9.56324485e+00
 -9.56324485e+00 -1.25768131e+00 -5.80243331e-01 -5.80243331e-01
 -5.80243331e-01  7.90505539e-01  7.90505539e-01  7.90505539e-01
  4.44791699e+00  4.44791699e+00  4.44791699e+00  2.14243090e+01
  2.14243090e+01  2.14243090e+01  5.47706309e+01  1.02635398e+02
  1.02635398e+02  1.02635398e+02  3.82196815e+02  4.51083252e+02
  4.51083252e+02  4.51083252e+02  1.30672842e+03  1.30672842e+03
  1.30672842e+03  2.17896079e+03  3.00715794e+03  3.00715794e+03
  3.00715794e+03  6.63325342e+03  6.63325342e+03  6.63325342e+03
  8.53036480e+03  2.49052165e+04  7.56840862e+04]
E1 = -727.9734598148463  E_coul = 201.7647761233327
cycle= 2 E= -526.208683691514  delta_E= -0.000481  |g|= 0.0284  |ddm|= 0.0228
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0518458
diis-c [-0.00191478  0.0462898   0.9537102 ]
  HOMO = -0.575486679363914  LUMO = 0.793129350222335
  mo_energy =
[-1.18443007e+02 -1.21961662e+01 -9.53777279e+00 -9.53777279e+00
 -9.53777279e+00 -1.25138266e+00 -5.75486679e-01 -5.75486679e-01
 -5.75486679e-01  7.93129350e-01  7.93129350e-01  7.93129350e-01
  4.45771656e+00  4.45771656e+00  4.45771656e+00  2.14471023e+01
  2.14471023e+01  2.14471023e+01  5.48076294e+01  1.02674764e+02
  1.02674764e+02  1.02674764e+02  3.82246867e+02  4.51133359e+02
  4.51133359e+02  4.51133359e+02  1.30678202e+03  1.30678202e+03
  1.30678202e+03  2.17901677e+03  3.00721333e+03  3.00721333e+03
  3.00721333e+03  6.63331001e+03  6.63331001e+03  6.63331001e+03
  8.53042189e+03  2.49052738e+04  7.56841436e+04]
E1 = -727.8936399674276  E_coul = 201.68493631339408
cycle= 3 E= -526.208703654034  delta_E= -2e-05  |g|= 0.00396  |ddm|= 0.00625
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00779587
diis-c [-4.42683235e-07 -1.12339126e-03  1.24957099e-01  8.76166292e-01]
  HOMO = -0.576418243862132  LUMO = 0.792617158091652
  mo_energy =
[-1.18449853e+02 -1.21999522e+01 -9.54169922e+00 -9.54169922e+00
 -9.54169922e+00 -1.25258012e+00 -5.76418244e-01 -5.76418244e-01
 -5.76418244e-01  7.92617158e-01  7.92617158e-01  7.92617158e-01
  4.45595671e+00  4.45595671e+00  4.45595671e+00  2.14435467e+01
  2.14435467e+01  2.14435467e+01  5.48024982e+01  1.02669222e+02
  1.02669222e+02  1.02669222e+02  3.82240080e+02  4.51126574e+02
  4.51126574e+02  4.51126574e+02  1.30677478e+03  1.30677478e+03
  1.30677478e+03  2.17900909e+03  3.00720580e+03  3.00720580e+03
  3.00720580e+03  6.63330219e+03  6.63330219e+03  6.63330219e+03
  8.53041391e+03  2.49052657e+04  7.56841354e+04]
E1 = -727.9053832601633  E_coul = 201.6966790552292
cycle= 4 E= -526.208704204934  delta_E= -5.51e-07  |g|= 5.67e-05  |ddm|= 0.000932
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.37989e-05
diis-c [-2.78711836e-09 -8.66930679e-06  4.12890508e-04  9.60346506e-03
  9.89992314e-01]
  HOMO = -0.576386942043617  LUMO = 0.792633743659129
  mo_energy =
[-1.18449736e+02 -1.21998431e+01 -9.54159182e+00 -9.54159182e+00
 -9.54159182e+00 -1.25253866e+00 -5.76386942e-01 -5.76386942e-01
 -5.76386942e-01  7.92633744e-01  7.92633744e-01  7.92633744e-01
  4.45601355e+00  4.45601355e+00  4.45601355e+00  2.14436437e+01
  2.14436437e+01  2.14436437e+01  5.48026175e+01  1.02669336e+02
  1.02669336e+02  1.02669336e+02  3.82240195e+02  4.51126691e+02
  4.51126691e+02  4.51126691e+02  1.30677489e+03  1.30677489e+03
  1.30677489e+03  2.17900919e+03  3.00720591e+03  3.00720591e+03
  3.00720591e+03  6.63330229e+03  6.63330229e+03  6.63330229e+03
  8.53041401e+03  2.49052658e+04  7.56841355e+04]
E1 = -727.9050948803687  E_coul = 201.6963906751692
cycle= 5 E= -526.208704205199  delta_E= -2.65e-10  |g|= 8.65e-06  |ddm|= 3.28e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -727.9050948803687  E_coul = 201.6963906751692
  HOMO = -0.576391697609559  LUMO = 0.792631135858883
  mo_energy =
[-1.18449756e+02 -1.21998583e+01 -9.54160739e+00 -9.54160739e+00
 -9.54160739e+00 -1.25254470e+00 -5.76391698e-01 -5.76391698e-01
 -5.76391698e-01  7.92631136e-01  7.92631136e-01  7.92631136e-01
  4.45600519e+00  4.45600519e+00  4.45600519e+00  2.14436294e+01
  2.14436294e+01  2.14436294e+01  5.48025997e+01  1.02669318e+02
  1.02669318e+02  1.02669318e+02  3.82240174e+02  4.51126670e+02
  4.51126670e+02  4.51126670e+02  1.30677487e+03  1.30677487e+03
  1.30677487e+03  2.17900917e+03  3.00720589e+03  3.00720589e+03
  3.00720589e+03  6.63330227e+03  6.63330227e+03  6.63330227e+03
  8.53041398e+03  2.49052658e+04  7.56841355e+04]
E1 = -727.90513738264  E_coul = 201.6964331774363
Extra cycle  E= -526.208704205204  delta_E= -4.32e-12  |g|= 2.31e-06  |ddm|= 3.66e-06
    CPU time for scf_cycle      0.64 sec, wall time      0.26 sec
exp = [2.61825150e+04 7.61816016e+03 3.61805551e+03 1.61539058e+03
 2.63305074e+02 7.82012043e+01 3.00668687e+01 4.50941411e+00
 3.96175498e-01 1.36278631e+03 6.65095534e+02 3.02852066e+02
 3.15733371e+02 5.77773025e+01 5.23275637e+00 1.61433425e+01
 6.22832764e-01 1.72317607e+00 1.93942730e-01]
E = -526.2087042052037
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:42:04 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5149586        1
[INPUT] 0    0    [1    /1   ]  7618.16015846        1
[INPUT] 0    0    [1    /1   ]  3618.05550661        1
[INPUT] 0    0    [1    /1   ]  1615.39058302        1
[INPUT] 0    0    [1    /1   ]  263.305073807        1
[INPUT] 0    0    [1    /1   ]  78.201204335         1
[INPUT] 0    0    [1    /1   ]  30.0668687297        1
[INPUT] 0    0    [1    /1   ]  4.50941411449        1
[INPUT] 0    0    [1    /1   ]  0.396175498139       1
[INPUT] 1    0    [1    /1   ]  1362.78631422        1
[INPUT] 1    0    [1    /1   ]  665.095533952        1
[INPUT] 1    0    [1    /1   ]  302.852066165        1
[INPUT] 1    0    [1    /1   ]  315.733370858        1
[INPUT] 1    0    [1    /1   ]  57.777302493         1
[INPUT] 1    0    [1    /1   ]  5.2327563666         1
[INPUT] 1    0    [1    /1   ]  16.1433425194        1
[INPUT] 1    0    [1    /1   ]  0.6228327644         1
[INPUT] 1    0    [1    /1   ]  1.72317606804        1
[INPUT] 1    0    [1    /1   ]  0.193942730468       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.514958594118, 1.0]], [0, [7618.160158460662, 1.0]], [0, [3618.0555066080633, 1.0]], [0, [1615.3905830217009, 1.0]], [0, [263.3050738074112, 1.0]], [0, [78.20120433504738, 1.0]], [0, [30.066868729687023, 1.0]], [0, [4.5094141144912605, 1.0]], [0, [0.3961754981386977, 1.0]], [1, [1362.7863142239762, 1.0]], [1, [665.0955339517243, 1.0]], [1, [302.8520661652097, 1.0]], [1, [315.7333708583542, 1.0]], [1, [57.77730249301781, 1.0]], [1, [5.232756366597238, 1.0]], [1, [16.143342519356803, 1.0]], [1, [0.6228327643996017, 1.0]], [1, [1.7231760680390282, 1.0]], [1, [0.19394273046782481, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.51495859]
bas 1, expnt(s) = [7618.16015846]
bas 2, expnt(s) = [3618.05550661]
bas 3, expnt(s) = [1615.39058302]
bas 4, expnt(s) = [263.30507381]
bas 5, expnt(s) = [78.20120434]
bas 6, expnt(s) = [30.06686873]
bas 7, expnt(s) = [4.50941411]
bas 8, expnt(s) = [0.3961755]
bas 9, expnt(s) = [1362.78631422]
bas 10, expnt(s) = [665.09553395]
bas 11, expnt(s) = [302.85206617]
bas 12, expnt(s) = [315.73337086]
bas 13, expnt(s) = [57.77730249]
bas 14, expnt(s) = [5.23275637]
bas 15, expnt(s) = [16.14334252]
bas 16, expnt(s) = [0.62283276]
bas 17, expnt(s) = [1.72317607]
bas 18, expnt(s) = [0.19394273]
CPU time:       378.65
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825150e+04 5.20024188e+03 7.61816016e+03 2.06016782e+03
 3.61805551e+03 1.17861359e+03 1.61539058e+03 6.43758808e+02
 2.63305074e+02 1.65142724e+02 7.82012043e+01 6.64393088e+01
 3.00668687e+01 3.24400246e+01 4.50941411e+00 7.81817008e+00
 3.96175498e-01 1.26162630e+00 1.36278631e+03 2.41556705e+04
 6.65095534e+02 9.85347529e+03 3.02852066e+02 3.68572195e+03
 3.15733371e+02 3.88271041e+03 5.77773025e+01 4.64708878e+02
 5.23275637e+00 2.30885966e+01 1.61433425e+01 9.44009184e+01
 6.22832764e-01 1.61416790e+00 1.72317607e+00 5.75965487e+00
 1.93942730e-01 3.75470892e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98109334654529
cond(S) = 93324.49660275107
E1 = -728.4460597447847  E_coul = 203.12758168210556
init E= -525.318478062679
    CPU time for initialize scf      0.45 sec, wall time      0.06 sec
  HOMO = -0.559715341414894  LUMO = 0.798963341048923
  mo_energy =
[-1.18192960e+02 -1.21089220e+01 -9.44358959e+00 -9.44358959e+00
 -9.44358959e+00 -1.22886894e+00 -5.59715341e-01 -5.59715341e-01
 -5.59715341e-01  7.98963341e-01  7.98963341e-01  7.98963341e-01
  4.49359216e+00  4.49359216e+00  4.49359216e+00  2.15345752e+01
  2.15345752e+01  2.15345752e+01  5.49376205e+01  1.02841630e+02
  1.02841630e+02  1.02841630e+02  3.82498174e+02  4.51382616e+02
  4.51382616e+02  4.51382616e+02  1.30708944e+03  1.30708944e+03
  1.30708944e+03  2.17946153e+03  3.00758923e+03  3.00758923e+03
  3.00758923e+03  6.63381679e+03  6.63381679e+03  6.63381679e+03
  8.53101843e+03  2.49059748e+04  7.56849431e+04]
E1 = -727.6114793978516  E_coul = 201.40327680731065
cycle= 1 E= -526.208202590541  delta_E= -0.89  |g|= 0.213  |ddm|= 0.478
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.574567
diis-c [-0.33012685  1.        ]
  HOMO = -0.580243331181476  LUMO = 0.790505538669925
  mo_energy =
[-1.18493538e+02 -1.22210763e+01 -9.56324485e+00 -9.56324485e+00
 -9.56324485e+00 -1.25768131e+00 -5.80243331e-01 -5.80243331e-01
 -5.80243331e-01  7.90505539e-01  7.90505539e-01  7.90505539e-01
  4.44791699e+00  4.44791699e+00  4.44791699e+00  2.14243090e+01
  2.14243090e+01  2.14243090e+01  5.47706309e+01  1.02635398e+02
  1.02635398e+02  1.02635398e+02  3.82196815e+02  4.51083252e+02
  4.51083252e+02  4.51083252e+02  1.30672842e+03  1.30672842e+03
  1.30672842e+03  2.17896079e+03  3.00715794e+03  3.00715794e+03
  3.00715794e+03  6.63325342e+03  6.63325342e+03  6.63325342e+03
  8.53036480e+03  2.49052165e+04  7.56840862e+04]
E1 = -727.9734598148463  E_coul = 201.7647761233327
cycle= 2 E= -526.208683691514  delta_E= -0.000481  |g|= 0.0284  |ddm|= 0.0228
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0518458
diis-c [-0.00191478  0.0462898   0.9537102 ]
  HOMO = -0.575486679363914  LUMO = 0.793129350222335
  mo_energy =
[-1.18443007e+02 -1.21961662e+01 -9.53777279e+00 -9.53777279e+00
 -9.53777279e+00 -1.25138266e+00 -5.75486679e-01 -5.75486679e-01
 -5.75486679e-01  7.93129350e-01  7.93129350e-01  7.93129350e-01
  4.45771656e+00  4.45771656e+00  4.45771656e+00  2.14471023e+01
  2.14471023e+01  2.14471023e+01  5.48076294e+01  1.02674764e+02
  1.02674764e+02  1.02674764e+02  3.82246867e+02  4.51133359e+02
  4.51133359e+02  4.51133359e+02  1.30678202e+03  1.30678202e+03
  1.30678202e+03  2.17901677e+03  3.00721333e+03  3.00721333e+03
  3.00721333e+03  6.63331001e+03  6.63331001e+03  6.63331001e+03
  8.53042189e+03  2.49052738e+04  7.56841436e+04]
E1 = -727.8936399674276  E_coul = 201.68493631339408
cycle= 3 E= -526.208703654034  delta_E= -2e-05  |g|= 0.00396  |ddm|= 0.00625
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00779587
diis-c [-4.42683235e-07 -1.12339126e-03  1.24957099e-01  8.76166292e-01]
  HOMO = -0.576418243862132  LUMO = 0.792617158091652
  mo_energy =
[-1.18449853e+02 -1.21999522e+01 -9.54169922e+00 -9.54169922e+00
 -9.54169922e+00 -1.25258012e+00 -5.76418244e-01 -5.76418244e-01
 -5.76418244e-01  7.92617158e-01  7.92617158e-01  7.92617158e-01
  4.45595671e+00  4.45595671e+00  4.45595671e+00  2.14435467e+01
  2.14435467e+01  2.14435467e+01  5.48024982e+01  1.02669222e+02
  1.02669222e+02  1.02669222e+02  3.82240080e+02  4.51126574e+02
  4.51126574e+02  4.51126574e+02  1.30677478e+03  1.30677478e+03
  1.30677478e+03  2.17900909e+03  3.00720580e+03  3.00720580e+03
  3.00720580e+03  6.63330219e+03  6.63330219e+03  6.63330219e+03
  8.53041391e+03  2.49052657e+04  7.56841354e+04]
E1 = -727.9053832601633  E_coul = 201.6966790552292
cycle= 4 E= -526.208704204934  delta_E= -5.51e-07  |g|= 5.67e-05  |ddm|= 0.000932
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.37989e-05
diis-c [-2.78711836e-09 -8.66930679e-06  4.12890508e-04  9.60346506e-03
  9.89992314e-01]
  HOMO = -0.576386942043617  LUMO = 0.792633743659129
  mo_energy =
[-1.18449736e+02 -1.21998431e+01 -9.54159182e+00 -9.54159182e+00
 -9.54159182e+00 -1.25253866e+00 -5.76386942e-01 -5.76386942e-01
 -5.76386942e-01  7.92633744e-01  7.92633744e-01  7.92633744e-01
  4.45601355e+00  4.45601355e+00  4.45601355e+00  2.14436437e+01
  2.14436437e+01  2.14436437e+01  5.48026175e+01  1.02669336e+02
  1.02669336e+02  1.02669336e+02  3.82240195e+02  4.51126691e+02
  4.51126691e+02  4.51126691e+02  1.30677489e+03  1.30677489e+03
  1.30677489e+03  2.17900919e+03  3.00720591e+03  3.00720591e+03
  3.00720591e+03  6.63330229e+03  6.63330229e+03  6.63330229e+03
  8.53041401e+03  2.49052658e+04  7.56841355e+04]
E1 = -727.9050948803687  E_coul = 201.6963906751692
cycle= 5 E= -526.208704205199  delta_E= -2.65e-10  |g|= 8.65e-06  |ddm|= 3.28e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.9050948803687  E_coul = 201.6963906751692
  HOMO = -0.576391697609559  LUMO = 0.792631135858883
  mo_energy =
[-1.18449756e+02 -1.21998583e+01 -9.54160739e+00 -9.54160739e+00
 -9.54160739e+00 -1.25254470e+00 -5.76391698e-01 -5.76391698e-01
 -5.76391698e-01  7.92631136e-01  7.92631136e-01  7.92631136e-01
  4.45600519e+00  4.45600519e+00  4.45600519e+00  2.14436294e+01
  2.14436294e+01  2.14436294e+01  5.48025997e+01  1.02669318e+02
  1.02669318e+02  1.02669318e+02  3.82240174e+02  4.51126670e+02
  4.51126670e+02  4.51126670e+02  1.30677487e+03  1.30677487e+03
  1.30677487e+03  2.17900917e+03  3.00720589e+03  3.00720589e+03
  3.00720589e+03  6.63330227e+03  6.63330227e+03  6.63330227e+03
  8.53041398e+03  2.49052658e+04  7.56841355e+04]
E1 = -727.90513738264  E_coul = 201.6964331774363
Extra cycle  E= -526.208704205204  delta_E= -4.32e-12  |g|= 2.31e-06  |ddm|= 3.66e-06
    CPU time for scf_cycle      0.65 sec, wall time      0.26 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 93324.49660275107
E1 = -727.90513738264  E_coul = 201.6964331774363
init E= -526.208704205204
    CPU time for initialize scf      2.70 sec, wall time      0.24 sec
  HOMO = -0.576390895983745  LUMO = 0.792631570172409
  mo_energy =
[-1.18449751e+02 -1.21998552e+01 -9.54160418e+00 -9.54160418e+00
 -9.54160418e+00 -1.25254366e+00 -5.76390896e-01 -5.76390896e-01
 -5.76390896e-01  7.92631570e-01  7.92631570e-01  7.92631570e-01
  4.45600669e+00  4.45600669e+00  4.45600669e+00  2.14436323e+01
  2.14436323e+01  2.14436323e+01  5.48026037e+01  1.02669322e+02
  1.02669322e+02  1.02669322e+02  3.82240179e+02  4.51126675e+02
  4.51126675e+02  4.51126675e+02  1.30677488e+03  1.30677488e+03
  1.30677488e+03  2.17900918e+03  3.00720590e+03  3.00720590e+03
  3.00720590e+03  6.63330228e+03  6.63330228e+03  6.63330228e+03
  8.53041399e+03  2.49052658e+04  7.56841355e+04]
E1 = -727.9051280205516  E_coul = 201.6964238153482
cycle= 1 E= -526.208704205203  delta_E= 3.41e-13  |g|= 5.43e-07  |ddm|= 8.25e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.9051280205516  E_coul = 201.6964238153482
  HOMO = -0.576391068835569  LUMO = 0.792631475485815
  mo_energy =
[-1.18449753e+02 -1.21998559e+01 -9.54160488e+00 -9.54160488e+00
 -9.54160488e+00 -1.25254388e+00 -5.76391069e-01 -5.76391069e-01
 -5.76391069e-01  7.92631475e-01  7.92631475e-01  7.92631475e-01
  4.45600636e+00  4.45600636e+00  4.45600636e+00  2.14436317e+01
  2.14436317e+01  2.14436317e+01  5.48026028e+01  1.02669321e+02
  1.02669321e+02  1.02669321e+02  3.82240178e+02  4.51126674e+02
  4.51126674e+02  4.51126674e+02  1.30677488e+03  1.30677488e+03
  1.30677488e+03  2.17900918e+03  3.00720590e+03  3.00720590e+03
  3.00720590e+03  6.63330228e+03  6.63330228e+03  6.63330228e+03
  8.53041399e+03  2.49052658e+04  7.56841355e+04]
E1 = -727.9051300767309  E_coul = 201.69642587152742
Extra cycle  E= -526.208704205204  delta_E= -1.14e-13  |g|= 1.24e-07  |ddm|= 1.7e-07
    CPU time for scf_cycle      2.82 sec, wall time      0.36 sec
exp = [2.61825150e+04 7.61816016e+03 3.61805551e+03 1.61539058e+03
 2.63305074e+02 7.82012043e+01 3.00668687e+01 4.50941411e+00
 3.96175498e-01 1.36278631e+03 6.65095534e+02 3.02852066e+02
 3.15733371e+02 5.77773025e+01 5.23275637e+00 1.61433425e+01
 6.22832764e-01 1.72317607e+00 1.93942730e-01]
grad_E = [-1.98094966e-06  2.09714727e-05  4.07710593e-05  6.61602943e-04
 -8.00803933e-03  5.63210964e-03  1.66015732e-03  5.87390581e-04
  1.41686573e-02 -6.20796599e-07  2.07055865e-06  3.89930339e-06
  3.82636499e-06  4.96140358e-03 -1.51783616e-02 -1.47032456e-02
  1.26241559e-02 -6.52262746e-03  1.96245925e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:42:08 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.515303         1
[INPUT] 0    0    [1    /1   ]  7618.15573654        1
[INPUT] 0    0    [1    /1   ]  3618.04594828        1
[INPUT] 0    0    [1    /1   ]  1615.25076209        1
[INPUT] 0    0    [1    /1   ]  264.556605439        1
[INPUT] 0    0    [1    /1   ]  79.121815823         1
[INPUT] 0    0    [1    /1   ]  30.6911905716        1
[INPUT] 0    0    [1    /1   ]  4.50747631941        1
[INPUT] 0    0    [1    /1   ]  0.398917518179       1
[INPUT] 1    0    [1    /1   ]  1362.78598781        1
[INPUT] 1    0    [1    /1   ]  665.091404477        1
[INPUT] 1    0    [1    /1   ]  302.829333904        1
[INPUT] 1    0    [1    /1   ]  315.713328548        1
[INPUT] 1    0    [1    /1   ]  58.2077085567        1
[INPUT] 1    0    [1    /1   ]  5.22576693275        1
[INPUT] 1    0    [1    /1   ]  16.1819149648        1
[INPUT] 1    0    [1    /1   ]  0.601636194792       1
[INPUT] 1    0    [1    /1   ]  1.71657137319        1
[INPUT] 1    0    [1    /1   ]  0.187421313164       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.515302955715, 1.0]], [0, [7618.155736543506, 1.0]], [0, [3618.045948284184, 1.0]], [0, [1615.2507620886813, 1.0]], [0, [264.55660543860716, 1.0]], [0, [79.12181582302962, 1.0]], [0, [30.691190571614335, 1.0]], [0, [4.5074763194051695, 1.0]], [0, [0.3989175181794644, 1.0]], [1, [1362.7859878080253, 1.0]], [1, [665.0914044765541, 1.0]], [1, [302.82933390397716, 1.0]], [1, [315.7133285482682, 1.0]], [1, [58.207708556652314, 1.0]], [1, [5.225766932752474, 1.0]], [1, [16.181914964772446, 1.0]], [1, [0.6016361947916968, 1.0]], [1, [1.716571373193049, 1.0]], [1, [0.18742131316385455, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.51530296]
bas 1, expnt(s) = [7618.15573654]
bas 2, expnt(s) = [3618.04594828]
bas 3, expnt(s) = [1615.25076209]
bas 4, expnt(s) = [264.55660544]
bas 5, expnt(s) = [79.12181582]
bas 6, expnt(s) = [30.69119057]
bas 7, expnt(s) = [4.50747632]
bas 8, expnt(s) = [0.39891752]
bas 9, expnt(s) = [1362.78598781]
bas 10, expnt(s) = [665.09140448]
bas 11, expnt(s) = [302.8293339]
bas 12, expnt(s) = [315.71332855]
bas 13, expnt(s) = [58.20770856]
bas 14, expnt(s) = [5.22576693]
bas 15, expnt(s) = [16.18191496]
bas 16, expnt(s) = [0.60163619]
bas 17, expnt(s) = [1.71657137]
bas 18, expnt(s) = [0.18742131]
CPU time:       386.67
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825153e+04 5.20024193e+03 7.61815574e+03 2.06016692e+03
 3.61804595e+03 1.17861125e+03 1.61525076e+03 6.43717017e+02
 2.64556605e+02 1.65731088e+02 7.91218158e+01 6.70250595e+01
 3.06911906e+01 3.29439239e+01 4.50747632e+00 7.81565022e+00
 3.98917518e-01 1.26816965e+00 1.36278599e+03 2.41556633e+04
 6.65091404e+02 9.85339882e+03 3.02829334e+02 3.68537613e+03
 3.15713329e+02 3.88240233e+03 5.82077086e+01 4.69040151e+02
 5.22576693e+00 2.30500535e+01 1.61819150e+01 9.46829511e+01
 6.01636195e-01 1.54579478e+00 1.71657137e+00 5.73207316e+00
 1.87421313e-01 3.59756056e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.981099878746523
cond(S) = 93764.283501057
E1 = -728.4902995575263  E_coul = 203.16058524745813
init E= -525.329714310068
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558783124492569  LUMO = 0.761710968162002
  mo_energy =
[-1.18192114e+02 -1.21067911e+01 -9.44067870e+00 -9.44067870e+00
 -9.44067870e+00 -1.22785388e+00 -5.58783124e-01 -5.58783124e-01
 -5.58783124e-01  7.61710968e-01  7.61710968e-01  7.61710968e-01
  4.38222753e+00  4.38222753e+00  4.38222753e+00  2.14140231e+01
  2.14140231e+01  2.14140231e+01  5.63059136e+01  1.03240999e+02
  1.03240999e+02  1.03240999e+02  3.87930459e+02  4.52649379e+02
  4.52649379e+02  4.52649379e+02  1.30852483e+03  1.30852483e+03
  1.30852483e+03  2.18872002e+03  3.00897934e+03  3.00897934e+03
  3.00897934e+03  6.63508265e+03  6.63508265e+03  6.63508265e+03
  8.54048826e+03  2.49150343e+04  7.56933712e+04]
E1 = -727.6139558498246  E_coul = 201.40383040885723
cycle= 1 E= -526.210125440967  delta_E= -0.88  |g|= 0.213  |ddm|= 0.52
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.574549
diis-c [-0.33010695  1.        ]
  HOMO = -0.580127237225298  LUMO = 0.753433136666446
  mo_energy =
[-1.18495858e+02 -1.22212432e+01 -9.56265420e+00 -9.56265420e+00
 -9.56265420e+00 -1.25800377e+00 -5.80127237e-01 -5.80127237e-01
 -5.80127237e-01  7.53433137e-01  7.53433137e-01  7.53433137e-01
  4.33547528e+00  4.33547528e+00  4.33547528e+00  2.13013702e+01
  2.13013702e+01  2.13013702e+01  5.61348192e+01  1.03031369e+02
  1.03031369e+02  1.03031369e+02  3.87625442e+02  4.52347155e+02
  4.52347155e+02  4.52347155e+02  1.30816115e+03  1.30816115e+03
  1.30816115e+03  2.18821689e+03  3.00854549e+03  3.00854549e+03
  3.00854549e+03  6.63451723e+03  6.63451723e+03  6.63451723e+03
  8.53983298e+03  2.49142746e+04  7.56925131e+04]
E1 = -727.9817156210405  E_coul = 201.77110212902835
cycle= 2 E= -526.210613492012  delta_E= -0.000488  |g|= 0.0286  |ddm|= 0.0232
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0521117
diis-c [-0.00193118  0.04661236  0.95338764]
  HOMO = -0.57523573760471  LUMO = 0.756011685667181
  mo_energy =
[-1.18444837e+02 -1.21959368e+01 -9.53677998e+00 -9.53677998e+00
 -9.53677998e+00 -1.25150864e+00 -5.75235738e-01 -5.75235738e-01
 -5.75235738e-01  7.56011686e-01  7.56011686e-01  7.56011686e-01
  4.34542927e+00  4.34542927e+00  4.34542927e+00  2.13245663e+01
  2.13245663e+01  2.13245663e+01  5.61725211e+01  1.03071270e+02
  1.03071270e+02  1.03071270e+02  3.87676049e+02  4.52397759e+02
  4.52397759e+02  4.52397759e+02  1.30821525e+03  1.30821525e+03
  1.30821525e+03  2.18827337e+03  3.00860139e+03  3.00860139e+03
  3.00860139e+03  6.63457432e+03  6.63457432e+03  6.63457432e+03
  8.53989056e+03  2.49143324e+04  7.56925710e+04]
E1 = -727.9004337085325  E_coul = 201.68979974406642
cycle= 3 E= -526.210633964466  delta_E= -2.05e-05  |g|= 0.004  |ddm|= 0.00637
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00784479
diis-c [-4.44742009e-07 -1.12731609e-03  1.25091854e-01  8.76035462e-01]
  HOMO = -0.576189347179215  LUMO = 0.755509798395745
  mo_energy =
[-1.18451764e+02 -1.21997875e+01 -9.54077101e+00 -9.54077101e+00
 -9.54077101e+00 -1.25273832e+00 -5.76189347e-01 -5.76189347e-01
 -5.76189347e-01  7.55509798e-01  7.55509798e-01  7.55509798e-01
  4.34364425e+00  4.34364425e+00  4.34364425e+00  2.13209468e+01
  2.13209468e+01  2.13209468e+01  5.61672860e+01  1.03065644e+02
  1.03065644e+02  1.03065644e+02  3.87669173e+02  4.52390892e+02
  4.52390892e+02  4.52390892e+02  1.30820793e+03  1.30820793e+03
  1.30820793e+03  2.18826560e+03  3.00859378e+03  3.00859378e+03
  3.00859378e+03  6.63456643e+03  6.63456643e+03  6.63456643e+03
  8.53988251e+03  2.49143242e+04  7.56925628e+04]
E1 = -727.9123967559066  E_coul = 201.7017622242535
cycle= 4 E= -526.210634531653  delta_E= -5.67e-07  |g|= 5.72e-05  |ddm|= 0.000949
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.53124e-05
diis-c [-2.76036365e-09 -9.83802462e-06  5.53561454e-04  1.08198305e-02
  9.88636446e-01]
  HOMO = -0.576157758351733  LUMO = 0.755525811242373
  mo_energy =
[-1.18451646e+02 -1.21996774e+01 -9.54066253e+00 -9.54066253e+00
 -9.54066253e+00 -1.25269635e+00 -5.76157758e-01 -5.76157758e-01
 -5.76157758e-01  7.55525811e-01  7.55525811e-01  7.55525811e-01
  4.34370123e+00  4.34370123e+00  4.34370123e+00  2.13210448e+01
  2.13210448e+01  2.13210448e+01  5.61674066e+01  1.03065760e+02
  1.03065760e+02  1.03065760e+02  3.87669290e+02  4.52391010e+02
  4.52391010e+02  4.52391010e+02  1.30820804e+03  1.30820804e+03
  1.30820804e+03  2.18826571e+03  3.00859389e+03  3.00859389e+03
  3.00859389e+03  6.63456653e+03  6.63456653e+03  6.63456653e+03
  8.53988261e+03  2.49143243e+04  7.56925628e+04]
E1 = -727.912102205128  E_coul = 201.70146767319974
cycle= 5 E= -526.210634531928  delta_E= -2.75e-10  |g|= 8.61e-06  |ddm|= 3.33e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.912102205128  E_coul = 201.70146767319974
  HOMO = -0.576162550313316  LUMO = 0.755523289344531
  mo_energy =
[-1.18451666e+02 -1.21996926e+01 -9.54067809e+00 -9.54067809e+00
 -9.54067809e+00 -1.25270245e+00 -5.76162550e-01 -5.76162550e-01
 -5.76162550e-01  7.55523289e-01  7.55523289e-01  7.55523289e-01
  4.34369288e+00  4.34369288e+00  4.34369288e+00  2.13210305e+01
  2.13210305e+01  2.13210305e+01  5.61673888e+01  1.03065741e+02
  1.03065741e+02  1.03065741e+02  3.87669269e+02  4.52390990e+02
  4.52390990e+02  4.52390990e+02  1.30820802e+03  1.30820802e+03
  1.30820802e+03  2.18826569e+03  3.00859387e+03  3.00859387e+03
  3.00859387e+03  6.63456651e+03  6.63456651e+03  6.63456651e+03
  8.53988258e+03  2.49143243e+04  7.56925628e+04]
E1 = -727.9121447289112  E_coul = 201.70151019697826
Extra cycle  E= -526.210634531933  delta_E= -4.77e-12  |g|= 2.3e-06  |ddm|= 3.64e-06
    CPU time for scf_cycle      0.61 sec, wall time      0.23 sec
exp = [2.61825153e+04 7.61815574e+03 3.61804595e+03 1.61525076e+03
 2.64556605e+02 7.91218158e+01 3.06911906e+01 4.50747632e+00
 3.98917518e-01 1.36278599e+03 6.65091404e+02 3.02829334e+02
 3.15713329e+02 5.82077086e+01 5.22576693e+00 1.61819150e+01
 6.01636195e-01 1.71657137e+00 1.87421313e-01]
E = -526.210634531933
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:42:08 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.515303         1
[INPUT] 0    0    [1    /1   ]  7618.15573654        1
[INPUT] 0    0    [1    /1   ]  3618.04594828        1
[INPUT] 0    0    [1    /1   ]  1615.25076209        1
[INPUT] 0    0    [1    /1   ]  264.556605439        1
[INPUT] 0    0    [1    /1   ]  79.121815823         1
[INPUT] 0    0    [1    /1   ]  30.6911905716        1
[INPUT] 0    0    [1    /1   ]  4.50747631941        1
[INPUT] 0    0    [1    /1   ]  0.398917518179       1
[INPUT] 1    0    [1    /1   ]  1362.78598781        1
[INPUT] 1    0    [1    /1   ]  665.091404477        1
[INPUT] 1    0    [1    /1   ]  302.829333904        1
[INPUT] 1    0    [1    /1   ]  315.713328548        1
[INPUT] 1    0    [1    /1   ]  58.2077085567        1
[INPUT] 1    0    [1    /1   ]  5.22576693275        1
[INPUT] 1    0    [1    /1   ]  16.1819149648        1
[INPUT] 1    0    [1    /1   ]  0.601636194792       1
[INPUT] 1    0    [1    /1   ]  1.71657137319        1
[INPUT] 1    0    [1    /1   ]  0.187421313164       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.515302955715, 1.0]], [0, [7618.155736543506, 1.0]], [0, [3618.045948284184, 1.0]], [0, [1615.2507620886813, 1.0]], [0, [264.55660543860716, 1.0]], [0, [79.12181582302962, 1.0]], [0, [30.691190571614335, 1.0]], [0, [4.5074763194051695, 1.0]], [0, [0.3989175181794644, 1.0]], [1, [1362.7859878080253, 1.0]], [1, [665.0914044765541, 1.0]], [1, [302.82933390397716, 1.0]], [1, [315.7133285482682, 1.0]], [1, [58.207708556652314, 1.0]], [1, [5.225766932752474, 1.0]], [1, [16.181914964772446, 1.0]], [1, [0.6016361947916968, 1.0]], [1, [1.716571373193049, 1.0]], [1, [0.18742131316385455, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.51530296]
bas 1, expnt(s) = [7618.15573654]
bas 2, expnt(s) = [3618.04594828]
bas 3, expnt(s) = [1615.25076209]
bas 4, expnt(s) = [264.55660544]
bas 5, expnt(s) = [79.12181582]
bas 6, expnt(s) = [30.69119057]
bas 7, expnt(s) = [4.50747632]
bas 8, expnt(s) = [0.39891752]
bas 9, expnt(s) = [1362.78598781]
bas 10, expnt(s) = [665.09140448]
bas 11, expnt(s) = [302.8293339]
bas 12, expnt(s) = [315.71332855]
bas 13, expnt(s) = [58.20770856]
bas 14, expnt(s) = [5.22576693]
bas 15, expnt(s) = [16.18191496]
bas 16, expnt(s) = [0.60163619]
bas 17, expnt(s) = [1.71657137]
bas 18, expnt(s) = [0.18742131]
CPU time:       387.42
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825153e+04 5.20024193e+03 7.61815574e+03 2.06016692e+03
 3.61804595e+03 1.17861125e+03 1.61525076e+03 6.43717017e+02
 2.64556605e+02 1.65731088e+02 7.91218158e+01 6.70250595e+01
 3.06911906e+01 3.29439239e+01 4.50747632e+00 7.81565022e+00
 3.98917518e-01 1.26816965e+00 1.36278599e+03 2.41556633e+04
 6.65091404e+02 9.85339882e+03 3.02829334e+02 3.68537613e+03
 3.15713329e+02 3.88240233e+03 5.82077086e+01 4.69040151e+02
 5.22576693e+00 2.30500535e+01 1.61819150e+01 9.46829511e+01
 6.01636195e-01 1.54579478e+00 1.71657137e+00 5.73207316e+00
 1.87421313e-01 3.59756056e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.981099878746523
cond(S) = 93764.283501057
E1 = -728.4902995575263  E_coul = 203.16058524745813
init E= -525.329714310068
    CPU time for initialize scf      0.45 sec, wall time      0.05 sec
  HOMO = -0.558783124492569  LUMO = 0.761710968162002
  mo_energy =
[-1.18192114e+02 -1.21067911e+01 -9.44067870e+00 -9.44067870e+00
 -9.44067870e+00 -1.22785388e+00 -5.58783124e-01 -5.58783124e-01
 -5.58783124e-01  7.61710968e-01  7.61710968e-01  7.61710968e-01
  4.38222753e+00  4.38222753e+00  4.38222753e+00  2.14140231e+01
  2.14140231e+01  2.14140231e+01  5.63059136e+01  1.03240999e+02
  1.03240999e+02  1.03240999e+02  3.87930459e+02  4.52649379e+02
  4.52649379e+02  4.52649379e+02  1.30852483e+03  1.30852483e+03
  1.30852483e+03  2.18872002e+03  3.00897934e+03  3.00897934e+03
  3.00897934e+03  6.63508265e+03  6.63508265e+03  6.63508265e+03
  8.54048826e+03  2.49150343e+04  7.56933712e+04]
E1 = -727.6139558498246  E_coul = 201.40383040885723
cycle= 1 E= -526.210125440967  delta_E= -0.88  |g|= 0.213  |ddm|= 0.52
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.574549
diis-c [-0.33010695  1.        ]
  HOMO = -0.580127237225298  LUMO = 0.753433136666446
  mo_energy =
[-1.18495858e+02 -1.22212432e+01 -9.56265420e+00 -9.56265420e+00
 -9.56265420e+00 -1.25800377e+00 -5.80127237e-01 -5.80127237e-01
 -5.80127237e-01  7.53433137e-01  7.53433137e-01  7.53433137e-01
  4.33547528e+00  4.33547528e+00  4.33547528e+00  2.13013702e+01
  2.13013702e+01  2.13013702e+01  5.61348192e+01  1.03031369e+02
  1.03031369e+02  1.03031369e+02  3.87625442e+02  4.52347155e+02
  4.52347155e+02  4.52347155e+02  1.30816115e+03  1.30816115e+03
  1.30816115e+03  2.18821689e+03  3.00854549e+03  3.00854549e+03
  3.00854549e+03  6.63451723e+03  6.63451723e+03  6.63451723e+03
  8.53983298e+03  2.49142746e+04  7.56925131e+04]
E1 = -727.9817156210405  E_coul = 201.77110212902835
cycle= 2 E= -526.210613492012  delta_E= -0.000488  |g|= 0.0286  |ddm|= 0.0232
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0521117
diis-c [-0.00193118  0.04661236  0.95338764]
  HOMO = -0.57523573760471  LUMO = 0.756011685667181
  mo_energy =
[-1.18444837e+02 -1.21959368e+01 -9.53677998e+00 -9.53677998e+00
 -9.53677998e+00 -1.25150864e+00 -5.75235738e-01 -5.75235738e-01
 -5.75235738e-01  7.56011686e-01  7.56011686e-01  7.56011686e-01
  4.34542927e+00  4.34542927e+00  4.34542927e+00  2.13245663e+01
  2.13245663e+01  2.13245663e+01  5.61725211e+01  1.03071270e+02
  1.03071270e+02  1.03071270e+02  3.87676049e+02  4.52397759e+02
  4.52397759e+02  4.52397759e+02  1.30821525e+03  1.30821525e+03
  1.30821525e+03  2.18827337e+03  3.00860139e+03  3.00860139e+03
  3.00860139e+03  6.63457432e+03  6.63457432e+03  6.63457432e+03
  8.53989056e+03  2.49143324e+04  7.56925710e+04]
E1 = -727.9004337085325  E_coul = 201.68979974406642
cycle= 3 E= -526.210633964466  delta_E= -2.05e-05  |g|= 0.004  |ddm|= 0.00637
    CPU time for cycle= 3      0.03 sec, wall time      0.04 sec
diis-norm(errvec)=0.00784479
diis-c [-4.44742009e-07 -1.12731609e-03  1.25091854e-01  8.76035462e-01]
  HOMO = -0.576189347179215  LUMO = 0.755509798395745
  mo_energy =
[-1.18451764e+02 -1.21997875e+01 -9.54077101e+00 -9.54077101e+00
 -9.54077101e+00 -1.25273832e+00 -5.76189347e-01 -5.76189347e-01
 -5.76189347e-01  7.55509798e-01  7.55509798e-01  7.55509798e-01
  4.34364425e+00  4.34364425e+00  4.34364425e+00  2.13209468e+01
  2.13209468e+01  2.13209468e+01  5.61672860e+01  1.03065644e+02
  1.03065644e+02  1.03065644e+02  3.87669173e+02  4.52390892e+02
  4.52390892e+02  4.52390892e+02  1.30820793e+03  1.30820793e+03
  1.30820793e+03  2.18826560e+03  3.00859378e+03  3.00859378e+03
  3.00859378e+03  6.63456643e+03  6.63456643e+03  6.63456643e+03
  8.53988251e+03  2.49143242e+04  7.56925628e+04]
E1 = -727.9123967559066  E_coul = 201.7017622242535
cycle= 4 E= -526.210634531653  delta_E= -5.67e-07  |g|= 5.72e-05  |ddm|= 0.000949
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.53124e-05
diis-c [-2.76036365e-09 -9.83802462e-06  5.53561454e-04  1.08198305e-02
  9.88636446e-01]
  HOMO = -0.576157758351733  LUMO = 0.755525811242373
  mo_energy =
[-1.18451646e+02 -1.21996774e+01 -9.54066253e+00 -9.54066253e+00
 -9.54066253e+00 -1.25269635e+00 -5.76157758e-01 -5.76157758e-01
 -5.76157758e-01  7.55525811e-01  7.55525811e-01  7.55525811e-01
  4.34370123e+00  4.34370123e+00  4.34370123e+00  2.13210448e+01
  2.13210448e+01  2.13210448e+01  5.61674066e+01  1.03065760e+02
  1.03065760e+02  1.03065760e+02  3.87669290e+02  4.52391010e+02
  4.52391010e+02  4.52391010e+02  1.30820804e+03  1.30820804e+03
  1.30820804e+03  2.18826571e+03  3.00859389e+03  3.00859389e+03
  3.00859389e+03  6.63456653e+03  6.63456653e+03  6.63456653e+03
  8.53988261e+03  2.49143243e+04  7.56925628e+04]
E1 = -727.912102205128  E_coul = 201.70146767319974
cycle= 5 E= -526.210634531928  delta_E= -2.75e-10  |g|= 8.61e-06  |ddm|= 3.33e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.912102205128  E_coul = 201.70146767319974
  HOMO = -0.576162550313316  LUMO = 0.755523289344531
  mo_energy =
[-1.18451666e+02 -1.21996926e+01 -9.54067809e+00 -9.54067809e+00
 -9.54067809e+00 -1.25270245e+00 -5.76162550e-01 -5.76162550e-01
 -5.76162550e-01  7.55523289e-01  7.55523289e-01  7.55523289e-01
  4.34369288e+00  4.34369288e+00  4.34369288e+00  2.13210305e+01
  2.13210305e+01  2.13210305e+01  5.61673888e+01  1.03065741e+02
  1.03065741e+02  1.03065741e+02  3.87669269e+02  4.52390990e+02
  4.52390990e+02  4.52390990e+02  1.30820802e+03  1.30820802e+03
  1.30820802e+03  2.18826569e+03  3.00859387e+03  3.00859387e+03
  3.00859387e+03  6.63456651e+03  6.63456651e+03  6.63456651e+03
  8.53988258e+03  2.49143243e+04  7.56925628e+04]
E1 = -727.9121447289112  E_coul = 201.70151019697826
Extra cycle  E= -526.210634531933  delta_E= -4.77e-12  |g|= 2.3e-06  |ddm|= 3.64e-06
    CPU time for scf_cycle      0.66 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 93764.283501057
E1 = -727.9121447289112  E_coul = 201.70151019697826
init E= -526.210634531933
    CPU time for initialize scf      2.71 sec, wall time      0.24 sec
  HOMO = -0.576161747034418  LUMO = 0.755523705598882
  mo_energy =
[-1.18451661e+02 -1.21996894e+01 -9.54067488e+00 -9.54067488e+00
 -9.54067488e+00 -1.25270140e+00 -5.76161747e-01 -5.76161747e-01
 -5.76161747e-01  7.55523706e-01  7.55523706e-01  7.55523706e-01
  4.34369437e+00  4.34369437e+00  4.34369437e+00  2.13210334e+01
  2.13210334e+01  2.13210334e+01  5.61673928e+01  1.03065745e+02
  1.03065745e+02  1.03065745e+02  3.87669274e+02  4.52390995e+02
  4.52390995e+02  4.52390995e+02  1.30820802e+03  1.30820802e+03
  1.30820802e+03  2.18826569e+03  3.00859387e+03  3.00859387e+03
  3.00859387e+03  6.63456651e+03  6.63456651e+03  6.63456651e+03
  8.53988259e+03  2.49143243e+04  7.56925628e+04]
E1 = -727.9121353074936  E_coul = 201.70150077556002
cycle= 1 E= -526.210634531934  delta_E= -5.68e-13  |g|= 5.43e-07  |ddm|= 8.31e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.9121353074936  E_coul = 201.70150077556002
  HOMO = -0.576161922118256  LUMO = 0.755523613738235
  mo_energy =
[-1.18451663e+02 -1.21996901e+01 -9.54067558e+00 -9.54067558e+00
 -9.54067558e+00 -1.25270163e+00 -5.76161922e-01 -5.76161922e-01
 -5.76161922e-01  7.55523614e-01  7.55523614e-01  7.55523614e-01
  4.34369405e+00  4.34369405e+00  4.34369405e+00  2.13210328e+01
  2.13210328e+01  2.13210328e+01  5.61673919e+01  1.03065744e+02
  1.03065744e+02  1.03065744e+02  3.87669273e+02  4.52390993e+02
  4.52390993e+02  4.52390993e+02  1.30820802e+03  1.30820802e+03
  1.30820802e+03  2.18826569e+03  3.00859387e+03  3.00859387e+03
  3.00859387e+03  6.63456651e+03  6.63456651e+03  6.63456651e+03
  8.53988259e+03  2.49143243e+04  7.56925628e+04]
E1 = -727.9121373815751  E_coul = 201.7015028496414
Extra cycle  E= -526.210634531934  delta_E= -1.14e-13  |g|= 1.24e-07  |ddm|= 1.71e-07
    CPU time for scf_cycle      2.83 sec, wall time      0.36 sec
exp = [2.61825153e+04 7.61815574e+03 3.61804595e+03 1.61525076e+03
 2.64556605e+02 7.91218158e+01 3.06911906e+01 4.50747632e+00
 3.98917518e-01 1.36278599e+03 6.65091404e+02 3.02829334e+02
 3.15713329e+02 5.82077086e+01 5.22576693e+00 1.61819150e+01
 6.01636195e-01 1.71657137e+00 1.87421313e-01]
grad_E = [-1.98120979e-06  2.06124622e-05  3.96527651e-05  6.49317047e-04
 -7.75528006e-03  5.09584255e-03  2.69365185e-03 -4.19358458e-03
  5.25393268e-02 -6.22102227e-07  1.66881061e-06  1.65705698e-06
  1.93166636e-06  5.16627446e-03 -1.50083234e-02 -1.53856250e-02
 -5.84660068e-03 -3.96604688e-03  5.34619417e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:42:13 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5158183        1
[INPUT] 0    0    [1    /1   ]  7618.14910498        1
[INPUT] 0    0    [1    /1   ]  3618.03160041        1
[INPUT] 0    0    [1    /1   ]  1615.04088902        1
[INPUT] 0    0    [1    /1   ]  266.510489364        1
[INPUT] 0    0    [1    /1   ]  80.2130471681        1
[INPUT] 0    0    [1    /1   ]  31.2099665424        1
[INPUT] 0    0    [1    /1   ]  4.49814192175        1
[INPUT] 0    0    [1    /1   ]  0.402420957317       1
[INPUT] 1    0    [1    /1   ]  1362.78550182        1
[INPUT] 1    0    [1    /1   ]  665.085260003        1
[INPUT] 1    0    [1    /1   ]  302.795507816        1
[INPUT] 1    0    [1    /1   ]  315.683502937        1
[INPUT] 1    0    [1    /1   ]  58.8541577136        1
[INPUT] 1    0    [1    /1   ]  5.22447207375        1
[INPUT] 1    0    [1    /1   ]  16.2322321609        1
[INPUT] 1    0    [1    /1   ]  0.559036161656       1
[INPUT] 1    0    [1    /1   ]  1.69913950425        1
[INPUT] 1    0    [1    /1   ]  0.174139508435       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.51581825854, 1.0]], [0, [7618.149104978584, 1.0]], [0, [3618.031600409146, 1.0]], [0, [1615.0408890182387, 1.0]], [0, [266.5104893636918, 1.0]], [0, [80.2130471680994, 1.0]], [0, [31.20996654242368, 1.0]], [0, [4.49814192175097, 1.0]], [0, [0.40242095731714506, 1.0]], [1, [1362.7855018152702, 1.0]], [1, [665.0852600033897, 1.0]], [1, [302.7955078163655, 1.0]], [1, [315.68350293679686, 1.0]], [1, [58.85415771360639, 1.0]], [1, [5.224472073749484, 1.0]], [1, [16.232232160859546, 1.0]], [1, [0.5590361616560894, 1.0]], [1, [1.699139504248608, 1.0]], [1, [0.17413950843498358, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.51581826]
bas 1, expnt(s) = [7618.14910498]
bas 2, expnt(s) = [3618.03160041]
bas 3, expnt(s) = [1615.04088902]
bas 4, expnt(s) = [266.51048936]
bas 5, expnt(s) = [80.21304717]
bas 6, expnt(s) = [31.20996654]
bas 7, expnt(s) = [4.49814192]
bas 8, expnt(s) = [0.40242096]
bas 9, expnt(s) = [1362.78550182]
bas 10, expnt(s) = [665.08526]
bas 11, expnt(s) = [302.79550782]
bas 12, expnt(s) = [315.68350294]
bas 13, expnt(s) = [58.85415771]
bas 14, expnt(s) = [5.22447207]
bas 15, expnt(s) = [16.23223216]
bas 16, expnt(s) = [0.55903616]
bas 17, expnt(s) = [1.6991395]
bas 18, expnt(s) = [0.17413951]
CPU time:       395.51
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825158e+04 5.20024201e+03 7.61814910e+03 2.06016557e+03
 3.61803160e+03 1.17860775e+03 1.61504089e+03 6.43654286e+02
 2.66510489e+02 1.66648249e+02 8.02130472e+01 6.77171677e+01
 3.12099665e+01 3.33606882e+01 4.49814192e+00 7.80350817e+00
 4.02420957e-01 1.27651366e+00 1.36278550e+03 2.41556525e+04
 6.65085260e+02 9.85328503e+03 3.02795508e+02 3.68486157e+03
 3.15683503e+02 3.88194387e+03 5.88541577e+01 4.75560559e+02
 5.22447207e+00 2.30429145e+01 1.62322322e+01 9.50511114e+01
 5.59036162e-01 1.41021156e+00 1.69913950e+00 5.65940389e+00
 1.74139508e-01 3.28175409e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98105052782911
cond(S) = 94418.07493053887
E1 = -728.5250477130043  E_coul = 203.19324723251123
init E= -525.331800480493
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.557689909146408  LUMO = 0.686960818784642
  mo_energy =
[-1.18193894e+02 -1.21043935e+01 -9.43756903e+00 -9.43756903e+00
 -9.43756903e+00 -1.22666752e+00 -5.57689909e-01 -5.57689909e-01
 -5.57689909e-01  6.86960819e-01  6.86960819e-01  6.86960819e-01
  4.14976383e+00  4.14976383e+00  4.14976383e+00  2.11726939e+01
  2.11726939e+01  2.11726939e+01  5.75410895e+01  1.03792415e+02
  1.03792415e+02  1.03792415e+02  3.93867012e+02  4.54507062e+02
  4.54507062e+02  4.54507062e+02  1.31064610e+03  1.31064610e+03
  1.31064610e+03  2.20023177e+03  3.01103828e+03  3.01103828e+03
  3.01103828e+03  6.63695913e+03  6.63695913e+03  6.63695913e+03
  8.55253901e+03  2.49265916e+04  7.57041231e+04]
E1 = -727.5894215081486  E_coul = 201.37553036960514
cycle= 1 E= -526.213891138543  delta_E= -0.882  |g|= 0.213  |ddm|= 0.667
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.576017
diis-c [-0.33179609  1.        ]
  HOMO = -0.580329096413535  LUMO = 0.679418130492056
  mo_energy =
[-1.18504193e+02 -1.22230298e+01 -9.56413376e+00 -9.56413376e+00
 -9.56413376e+00 -1.25888558e+00 -5.80329096e-01 -5.80329096e-01
 -5.80329096e-01  6.79418130e-01  6.79418130e-01  6.79418130e-01
  4.10133194e+00  4.10133194e+00  4.10133194e+00  2.10552623e+01
  2.10552623e+01  2.10552623e+01  5.73637053e+01  1.03576263e+02
  1.03576263e+02  1.03576263e+02  3.93554571e+02  4.54198563e+02
  4.54198563e+02  4.54198563e+02  1.31027602e+03  1.31027602e+03
  1.31027602e+03  2.19972239e+03  3.01059810e+03  3.01059810e+03
  3.01059810e+03  6.63638787e+03  6.63638787e+03  6.63638787e+03
  8.55187828e+03  2.49258267e+04  7.57032601e+04]
E1 = -727.9721037285594  E_coul = 201.75770289963802
cycle= 2 E= -526.214400828921  delta_E= -0.00051  |g|= 0.0292  |ddm|= 0.0245
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0530805
diis-c [-0.00198343  0.04788164  0.95211836]
  HOMO = -0.575108120306242  LUMO = 0.681907416600667
  mo_energy =
[-1.18451787e+02 -1.21967273e+01 -9.53724471e+00 -9.53724471e+00
 -9.53724471e+00 -1.25194062e+00 -5.75108120e-01 -5.75108120e-01
 -5.75108120e-01  6.81907417e-01  6.81907417e-01  6.81907417e-01
  4.11167378e+00  4.11167378e+00  4.11167378e+00  2.10794554e+01
  2.10794554e+01  2.10794554e+01  5.74028480e+01  1.03617514e+02
  1.03617514e+02  1.03617514e+02  3.93606634e+02  4.54250558e+02
  4.54250558e+02  4.54250558e+02  1.31033154e+03  1.31033154e+03
  1.31033154e+03  2.19978031e+03  3.01065543e+03  3.01065543e+03
  3.01065543e+03  6.63644640e+03  6.63644640e+03  6.63644640e+03
  8.55193731e+03  2.49258860e+04  7.57033194e+04]
E1 = -727.8875481220091  E_coul = 201.6731254499825
cycle= 3 E= -526.214422672027  delta_E= -2.18e-05  |g|= 0.00408  |ddm|= 0.0066
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00799864
diis-c [-4.53982728e-07 -1.14583604e-03  1.25150003e-01  8.75995833e-01]
  HOMO = -0.576098000428439  LUMO = 0.681435653976089
  mo_energy =
[-1.18458888e+02 -1.22006995e+01 -9.54136091e+00 -9.54136091e+00
 -9.54136091e+00 -1.25322240e+00 -5.76098000e-01 -5.76098000e-01
 -5.76098000e-01  6.81435654e-01  6.81435654e-01  6.81435654e-01
  4.10985196e+00  4.10985196e+00  4.10985196e+00  2.10757122e+01
  2.10757122e+01  2.10757122e+01  5.73974384e+01  1.03611721e+02
  1.03611721e+02  1.03611721e+02  3.93599577e+02  4.54243519e+02
  4.54243519e+02  4.54243519e+02  1.31032404e+03  1.31032404e+03
  1.31032404e+03  2.19977237e+03  3.01064764e+03  3.01064764e+03
  3.01064764e+03  6.63643832e+03  6.63643832e+03  6.63643832e+03
  8.55192907e+03  2.49258776e+04  7.57033110e+04]
E1 = -727.8999167486744  E_coul = 201.68549347616116
cycle= 4 E= -526.214423272513  delta_E= -6e-07  |g|= 5.57e-05  |ddm|= 0.000981
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.3236e-05
diis-c [-2.76080057e-09 -8.71057996e-06  3.61521049e-04  9.02769663e-03
  9.90619493e-01]
  HOMO = -0.576066612800518  LUMO = 0.681450088504618
  mo_energy =
[-1.18458772e+02 -1.22005913e+01 -9.54125432e+00 -9.54125432e+00
 -9.54125432e+00 -1.25318059e+00 -5.76066613e-01 -5.76066613e-01
 -5.76066613e-01  6.81450089e-01  6.81450089e-01  6.81450089e-01
  4.10990752e+00  4.10990752e+00  4.10990752e+00  2.10758088e+01
  2.10758088e+01  2.10758088e+01  5.73975568e+01  1.03611834e+02
  1.03611834e+02  1.03611834e+02  3.93599691e+02  4.54243634e+02
  4.54243634e+02  4.54243634e+02  1.31032416e+03  1.31032416e+03
  1.31032416e+03  2.19977247e+03  3.01064775e+03  3.01064775e+03
  3.01064775e+03  6.63643842e+03  6.63643842e+03  6.63643842e+03
  8.55192916e+03  2.49258777e+04  7.57033111e+04]
E1 = -727.8996249024166  E_coul = 201.685201629639
cycle= 5 E= -526.214423272778  delta_E= -2.64e-10  |g|= 8.67e-06  |ddm|= 3.26e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -727.8996249024166  E_coul = 201.685201629639
  HOMO = -0.576071474130889  LUMO = 0.681447763439044
  mo_energy =
[-1.18458793e+02 -1.22006066e+01 -9.54127007e+00 -9.54127007e+00
 -9.54127007e+00 -1.25318680e+00 -5.76071474e-01 -5.76071474e-01
 -5.76071474e-01  6.81447763e-01  6.81447763e-01  6.81447763e-01
  4.10989917e+00  4.10989917e+00  4.10989917e+00  2.10757943e+01
  2.10757943e+01  2.10757943e+01  5.73975387e+01  1.03611815e+02
  1.03611815e+02  1.03611815e+02  3.93599670e+02  4.54243613e+02
  4.54243613e+02  4.54243613e+02  1.31032413e+03  1.31032413e+03
  1.31032413e+03  2.19977245e+03  3.01064773e+03  3.01064773e+03
  3.01064773e+03  6.63643840e+03  6.63643840e+03  6.63643840e+03
  8.55192914e+03  2.49258777e+04  7.57033110e+04]
E1 = -727.8996679456998  E_coul = 201.68524467291664
Extra cycle  E= -526.214423272783  delta_E= -5.57e-12  |g|= 2.32e-06  |ddm|= 3.67e-06
    CPU time for scf_cycle      0.65 sec, wall time      0.27 sec
exp = [2.61825158e+04 7.61814910e+03 3.61803160e+03 1.61504089e+03
 2.66510489e+02 8.02130472e+01 3.12099665e+01 4.49814192e+00
 4.02420957e-01 1.36278550e+03 6.65085260e+02 3.02795508e+02
 3.15683503e+02 5.88541577e+01 5.22447207e+00 1.62322322e+01
 5.59036162e-01 1.69913950e+00 1.74139508e-01]
E = -526.2144232727832
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:42:13 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5158183        1
[INPUT] 0    0    [1    /1   ]  7618.14910498        1
[INPUT] 0    0    [1    /1   ]  3618.03160041        1
[INPUT] 0    0    [1    /1   ]  1615.04088902        1
[INPUT] 0    0    [1    /1   ]  266.510489364        1
[INPUT] 0    0    [1    /1   ]  80.2130471681        1
[INPUT] 0    0    [1    /1   ]  31.2099665424        1
[INPUT] 0    0    [1    /1   ]  4.49814192175        1
[INPUT] 0    0    [1    /1   ]  0.402420957317       1
[INPUT] 1    0    [1    /1   ]  1362.78550182        1
[INPUT] 1    0    [1    /1   ]  665.085260003        1
[INPUT] 1    0    [1    /1   ]  302.795507816        1
[INPUT] 1    0    [1    /1   ]  315.683502937        1
[INPUT] 1    0    [1    /1   ]  58.8541577136        1
[INPUT] 1    0    [1    /1   ]  5.22447207375        1
[INPUT] 1    0    [1    /1   ]  16.2322321609        1
[INPUT] 1    0    [1    /1   ]  0.559036161656       1
[INPUT] 1    0    [1    /1   ]  1.69913950425        1
[INPUT] 1    0    [1    /1   ]  0.174139508435       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.51581825854, 1.0]], [0, [7618.149104978584, 1.0]], [0, [3618.031600409146, 1.0]], [0, [1615.0408890182387, 1.0]], [0, [266.5104893636918, 1.0]], [0, [80.2130471680994, 1.0]], [0, [31.20996654242368, 1.0]], [0, [4.49814192175097, 1.0]], [0, [0.40242095731714506, 1.0]], [1, [1362.7855018152702, 1.0]], [1, [665.0852600033897, 1.0]], [1, [302.7955078163655, 1.0]], [1, [315.68350293679686, 1.0]], [1, [58.85415771360639, 1.0]], [1, [5.224472073749484, 1.0]], [1, [16.232232160859546, 1.0]], [1, [0.5590361616560894, 1.0]], [1, [1.699139504248608, 1.0]], [1, [0.17413950843498358, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.51581826]
bas 1, expnt(s) = [7618.14910498]
bas 2, expnt(s) = [3618.03160041]
bas 3, expnt(s) = [1615.04088902]
bas 4, expnt(s) = [266.51048936]
bas 5, expnt(s) = [80.21304717]
bas 6, expnt(s) = [31.20996654]
bas 7, expnt(s) = [4.49814192]
bas 8, expnt(s) = [0.40242096]
bas 9, expnt(s) = [1362.78550182]
bas 10, expnt(s) = [665.08526]
bas 11, expnt(s) = [302.79550782]
bas 12, expnt(s) = [315.68350294]
bas 13, expnt(s) = [58.85415771]
bas 14, expnt(s) = [5.22447207]
bas 15, expnt(s) = [16.23223216]
bas 16, expnt(s) = [0.55903616]
bas 17, expnt(s) = [1.6991395]
bas 18, expnt(s) = [0.17413951]
CPU time:       396.31
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825158e+04 5.20024201e+03 7.61814910e+03 2.06016557e+03
 3.61803160e+03 1.17860775e+03 1.61504089e+03 6.43654286e+02
 2.66510489e+02 1.66648249e+02 8.02130472e+01 6.77171677e+01
 3.12099665e+01 3.33606882e+01 4.49814192e+00 7.80350817e+00
 4.02420957e-01 1.27651366e+00 1.36278550e+03 2.41556525e+04
 6.65085260e+02 9.85328503e+03 3.02795508e+02 3.68486157e+03
 3.15683503e+02 3.88194387e+03 5.88541577e+01 4.75560559e+02
 5.22447207e+00 2.30429145e+01 1.62322322e+01 9.50511114e+01
 5.59036162e-01 1.41021156e+00 1.69913950e+00 5.65940389e+00
 1.74139508e-01 3.28175409e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98105052782911
cond(S) = 94418.07493053887
E1 = -728.5250477130043  E_coul = 203.19324723251123
init E= -525.331800480493
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.557689909146408  LUMO = 0.686960818784642
  mo_energy =
[-1.18193894e+02 -1.21043935e+01 -9.43756903e+00 -9.43756903e+00
 -9.43756903e+00 -1.22666752e+00 -5.57689909e-01 -5.57689909e-01
 -5.57689909e-01  6.86960819e-01  6.86960819e-01  6.86960819e-01
  4.14976383e+00  4.14976383e+00  4.14976383e+00  2.11726939e+01
  2.11726939e+01  2.11726939e+01  5.75410895e+01  1.03792415e+02
  1.03792415e+02  1.03792415e+02  3.93867012e+02  4.54507062e+02
  4.54507062e+02  4.54507062e+02  1.31064610e+03  1.31064610e+03
  1.31064610e+03  2.20023177e+03  3.01103828e+03  3.01103828e+03
  3.01103828e+03  6.63695913e+03  6.63695913e+03  6.63695913e+03
  8.55253901e+03  2.49265916e+04  7.57041231e+04]
E1 = -727.5894215081486  E_coul = 201.37553036960514
cycle= 1 E= -526.213891138543  delta_E= -0.882  |g|= 0.213  |ddm|= 0.667
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.576017
diis-c [-0.33179609  1.        ]
  HOMO = -0.580329096413535  LUMO = 0.679418130492056
  mo_energy =
[-1.18504193e+02 -1.22230298e+01 -9.56413376e+00 -9.56413376e+00
 -9.56413376e+00 -1.25888558e+00 -5.80329096e-01 -5.80329096e-01
 -5.80329096e-01  6.79418130e-01  6.79418130e-01  6.79418130e-01
  4.10133194e+00  4.10133194e+00  4.10133194e+00  2.10552623e+01
  2.10552623e+01  2.10552623e+01  5.73637053e+01  1.03576263e+02
  1.03576263e+02  1.03576263e+02  3.93554571e+02  4.54198563e+02
  4.54198563e+02  4.54198563e+02  1.31027602e+03  1.31027602e+03
  1.31027602e+03  2.19972239e+03  3.01059810e+03  3.01059810e+03
  3.01059810e+03  6.63638787e+03  6.63638787e+03  6.63638787e+03
  8.55187828e+03  2.49258267e+04  7.57032601e+04]
E1 = -727.9721037285594  E_coul = 201.75770289963802
cycle= 2 E= -526.214400828921  delta_E= -0.00051  |g|= 0.0292  |ddm|= 0.0245
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0530805
diis-c [-0.00198343  0.04788164  0.95211836]
  HOMO = -0.575108120306242  LUMO = 0.681907416600667
  mo_energy =
[-1.18451787e+02 -1.21967273e+01 -9.53724471e+00 -9.53724471e+00
 -9.53724471e+00 -1.25194062e+00 -5.75108120e-01 -5.75108120e-01
 -5.75108120e-01  6.81907417e-01  6.81907417e-01  6.81907417e-01
  4.11167378e+00  4.11167378e+00  4.11167378e+00  2.10794554e+01
  2.10794554e+01  2.10794554e+01  5.74028480e+01  1.03617514e+02
  1.03617514e+02  1.03617514e+02  3.93606634e+02  4.54250558e+02
  4.54250558e+02  4.54250558e+02  1.31033154e+03  1.31033154e+03
  1.31033154e+03  2.19978031e+03  3.01065543e+03  3.01065543e+03
  3.01065543e+03  6.63644640e+03  6.63644640e+03  6.63644640e+03
  8.55193731e+03  2.49258860e+04  7.57033194e+04]
E1 = -727.8875481220091  E_coul = 201.6731254499825
cycle= 3 E= -526.214422672027  delta_E= -2.18e-05  |g|= 0.00408  |ddm|= 0.0066
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00799864
diis-c [-4.53982728e-07 -1.14583604e-03  1.25150003e-01  8.75995833e-01]
  HOMO = -0.576098000428439  LUMO = 0.681435653976089
  mo_energy =
[-1.18458888e+02 -1.22006995e+01 -9.54136091e+00 -9.54136091e+00
 -9.54136091e+00 -1.25322240e+00 -5.76098000e-01 -5.76098000e-01
 -5.76098000e-01  6.81435654e-01  6.81435654e-01  6.81435654e-01
  4.10985196e+00  4.10985196e+00  4.10985196e+00  2.10757122e+01
  2.10757122e+01  2.10757122e+01  5.73974384e+01  1.03611721e+02
  1.03611721e+02  1.03611721e+02  3.93599577e+02  4.54243519e+02
  4.54243519e+02  4.54243519e+02  1.31032404e+03  1.31032404e+03
  1.31032404e+03  2.19977237e+03  3.01064764e+03  3.01064764e+03
  3.01064764e+03  6.63643832e+03  6.63643832e+03  6.63643832e+03
  8.55192907e+03  2.49258776e+04  7.57033110e+04]
E1 = -727.8999167486744  E_coul = 201.68549347616116
cycle= 4 E= -526.214423272513  delta_E= -6e-07  |g|= 5.57e-05  |ddm|= 0.000981
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=7.3236e-05
diis-c [-2.76080057e-09 -8.71057996e-06  3.61521049e-04  9.02769663e-03
  9.90619493e-01]
  HOMO = -0.576066612800518  LUMO = 0.681450088504618
  mo_energy =
[-1.18458772e+02 -1.22005913e+01 -9.54125432e+00 -9.54125432e+00
 -9.54125432e+00 -1.25318059e+00 -5.76066613e-01 -5.76066613e-01
 -5.76066613e-01  6.81450089e-01  6.81450089e-01  6.81450089e-01
  4.10990752e+00  4.10990752e+00  4.10990752e+00  2.10758088e+01
  2.10758088e+01  2.10758088e+01  5.73975568e+01  1.03611834e+02
  1.03611834e+02  1.03611834e+02  3.93599691e+02  4.54243634e+02
  4.54243634e+02  4.54243634e+02  1.31032416e+03  1.31032416e+03
  1.31032416e+03  2.19977247e+03  3.01064775e+03  3.01064775e+03
  3.01064775e+03  6.63643842e+03  6.63643842e+03  6.63643842e+03
  8.55192916e+03  2.49258777e+04  7.57033111e+04]
E1 = -727.8996249024166  E_coul = 201.685201629639
cycle= 5 E= -526.214423272778  delta_E= -2.64e-10  |g|= 8.67e-06  |ddm|= 3.26e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.8996249024166  E_coul = 201.685201629639
  HOMO = -0.576071474130889  LUMO = 0.681447763439044
  mo_energy =
[-1.18458793e+02 -1.22006066e+01 -9.54127007e+00 -9.54127007e+00
 -9.54127007e+00 -1.25318680e+00 -5.76071474e-01 -5.76071474e-01
 -5.76071474e-01  6.81447763e-01  6.81447763e-01  6.81447763e-01
  4.10989917e+00  4.10989917e+00  4.10989917e+00  2.10757943e+01
  2.10757943e+01  2.10757943e+01  5.73975387e+01  1.03611815e+02
  1.03611815e+02  1.03611815e+02  3.93599670e+02  4.54243613e+02
  4.54243613e+02  4.54243613e+02  1.31032413e+03  1.31032413e+03
  1.31032413e+03  2.19977245e+03  3.01064773e+03  3.01064773e+03
  3.01064773e+03  6.63643840e+03  6.63643840e+03  6.63643840e+03
  8.55192914e+03  2.49258777e+04  7.57033110e+04]
E1 = -727.8996679456998  E_coul = 201.68524467291664
Extra cycle  E= -526.214423272783  delta_E= -5.57e-12  |g|= 2.32e-06  |ddm|= 3.67e-06
    CPU time for scf_cycle      0.66 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 94418.07493053887
E1 = -727.8996679456998  E_coul = 201.68524467291664
init E= -526.214423272783
    CPU time for initialize scf      2.71 sec, wall time      0.24 sec
  HOMO = -0.576070658479266  LUMO = 0.681448146181296
  mo_energy =
[-1.18458788e+02 -1.22006035e+01 -9.54126682e+00 -9.54126682e+00
 -9.54126682e+00 -1.25318573e+00 -5.76070658e-01 -5.76070658e-01
 -5.76070658e-01  6.81448146e-01  6.81448146e-01  6.81448146e-01
  4.10990066e+00  4.10990066e+00  4.10990066e+00  2.10757972e+01
  2.10757972e+01  2.10757972e+01  5.73975428e+01  1.03611819e+02
  1.03611819e+02  1.03611819e+02  3.93599675e+02  4.54243618e+02
  4.54243618e+02  4.54243618e+02  1.31032414e+03  1.31032414e+03
  1.31032414e+03  2.19977245e+03  3.01064773e+03  3.01064773e+03
  3.01064773e+03  6.63643841e+03  6.63643841e+03  6.63643841e+03
  8.55192915e+03  2.49258777e+04  7.57033110e+04]
E1 = -727.899658351019  E_coul = 201.68523507823573
cycle= 1 E= -526.214423272783  delta_E= -1.14e-13  |g|= 5.49e-07  |ddm|= 8.42e-07
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
E1 = -727.899658351019  E_coul = 201.68523507823573
  HOMO = -0.576070837903445  LUMO = 0.681448060804694
  mo_energy =
[-1.18458789e+02 -1.22006042e+01 -9.54126753e+00 -9.54126753e+00
 -9.54126753e+00 -1.25318597e+00 -5.76070838e-01 -5.76070838e-01
 -5.76070838e-01  6.81448061e-01  6.81448061e-01  6.81448061e-01
  4.10990034e+00  4.10990034e+00  4.10990034e+00  2.10757966e+01
  2.10757966e+01  2.10757966e+01  5.73975419e+01  1.03611818e+02
  1.03611818e+02  1.03611818e+02  3.93599674e+02  4.54243617e+02
  4.54243617e+02  4.54243617e+02  1.31032414e+03  1.31032414e+03
  1.31032414e+03  2.19977245e+03  3.01064773e+03  3.01064773e+03
  3.01064773e+03  6.63643840e+03  6.63643840e+03  6.63643840e+03
  8.55192915e+03  2.49258777e+04  7.57033110e+04]
E1 = -727.8996604680317  E_coul = 201.68523719524933
Extra cycle  E= -526.214423272782  delta_E= 9.09e-13  |g|= 1.26e-07  |ddm|= 1.73e-07
    CPU time for scf_cycle      2.87 sec, wall time      0.40 sec
exp = [2.61825158e+04 7.61814910e+03 3.61803160e+03 1.61504089e+03
 2.66510489e+02 8.02130472e+01 3.12099665e+01 4.49814192e+00
 4.02420957e-01 1.36278550e+03 6.65085260e+02 3.02795508e+02
 3.15683503e+02 5.88541577e+01 5.22447207e+00 1.62322322e+01
 5.59036162e-01 1.69913950e+00 1.74139508e-01]
grad_E = [-1.98104996e-06  2.00886951e-05  3.80325808e-05  6.31526844e-04
 -7.45094181e-03  4.80720021e-03  3.29675490e-03 -1.54120187e-02
  1.01060599e-01 -6.05559124e-07  1.08365075e-06 -1.63931792e-06
 -8.15340668e-07  5.61701359e-03 -7.93669637e-03 -1.84022656e-02
 -6.55731507e-02  1.60204673e-03  2.82150743e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:42:17 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5164393        1
[INPUT] 0    0    [1    /1   ]  7618.14109589        1
[INPUT] 0    0    [1    /1   ]  3618.01425622        1
[INPUT] 0    0    [1    /1   ]  1614.78725012        1
[INPUT] 0    0    [1    /1   ]  268.93986237         1
[INPUT] 0    0    [1    /1   ]  81.272055548         1
[INPUT] 0    0    [1    /1   ]  31.4448381063        1
[INPUT] 0    0    [1    /1   ]  4.48530288199        1
[INPUT] 0    0    [1    /1   ]  0.403622021857       1
[INPUT] 1    0    [1    /1   ]  1362.78491695        1
[INPUT] 1    0    [1    /1   ]  665.077874336        1
[INPUT] 1    0    [1    /1   ]  302.754844064        1
[INPUT] 1    0    [1    /1   ]  315.647646459        1
[INPUT] 1    0    [1    /1   ]  59.6380674092        1
[INPUT] 1    0    [1    /1   ]  5.20537660663        1
[INPUT] 1    0    [1    /1   ]  16.2895202026        1
[INPUT] 1    0    [1    /1   ]  0.527662398267       1
[INPUT] 1    0    [1    /1   ]  1.63978060478        1
[INPUT] 1    0    [1    /1   ]  0.163646404123       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.51643926599, 1.0]], [0, [7618.141095894433, 1.0]], [0, [3618.0142562157243, 1.0]], [0, [1614.7872501168467, 1.0]], [0, [268.9398623703784, 1.0]], [0, [81.27205554802427, 1.0]], [0, [31.444838106254515, 1.0]], [0, [4.485302881986162, 1.0]], [0, [0.40362202185714957, 1.0]], [1, [1362.7849169508056, 1.0]], [1, [665.0778743357605, 1.0]], [1, [302.7548440639868, 1.0]], [1, [315.6476464594947, 1.0]], [1, [59.638067409245245, 1.0]], [1, [5.205376606631118, 1.0]], [1, [16.28952020258567, 1.0]], [1, [0.5276623982674544, 1.0]], [1, [1.639780604784868, 1.0]], [1, [0.16364640412254194, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.51643927]
bas 1, expnt(s) = [7618.14109589]
bas 2, expnt(s) = [3618.01425622]
bas 3, expnt(s) = [1614.78725012]
bas 4, expnt(s) = [268.93986237]
bas 5, expnt(s) = [81.27205555]
bas 6, expnt(s) = [31.44483811]
bas 7, expnt(s) = [4.48530288]
bas 8, expnt(s) = [0.40362202]
bas 9, expnt(s) = [1362.78491695]
bas 10, expnt(s) = [665.07787434]
bas 11, expnt(s) = [302.75484406]
bas 12, expnt(s) = [315.64764646]
bas 13, expnt(s) = [59.63806741]
bas 14, expnt(s) = [5.20537661]
bas 15, expnt(s) = [16.2895202]
bas 16, expnt(s) = [0.5276624]
bas 17, expnt(s) = [1.6397806]
bas 18, expnt(s) = [0.1636464]
CPU time:       404.49
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825164e+04 5.20024210e+03 7.61814110e+03 2.06016395e+03
 3.61801426e+03 1.17860351e+03 1.61478725e+03 6.43578472e+02
 2.68939862e+02 1.67786266e+02 8.12720555e+01 6.83865913e+01
 3.14448381e+01 3.35488043e+01 4.48530288e+00 7.78679705e+00
 4.03622022e-01 1.27937001e+00 1.36278492e+03 2.41556395e+04
 6.65077874e+02 9.85314826e+03 3.02754844e+02 3.68424301e+03
 3.15647646e+02 3.88139272e+03 5.96380674e+01 4.83491501e+02
 5.20537661e+00 2.29376852e+01 1.62895202e+01 9.54706234e+01
 5.27662398e-01 1.31198713e+00 1.63978060e+00 5.41335582e+00
 1.63646404e-01 3.03645938e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98096231627344
cond(S) = 95199.7525114366
E1 = -728.512713728398  E_coul = 203.18968146769822
init E= -525.3230322607
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.557450661246477  LUMO = 0.630541550785094
  mo_energy =
[-1.18201079e+02 -1.21041956e+01 -9.43714605e+00 -9.43714605e+00
 -9.43714605e+00 -1.22635609e+00 -5.57450661e-01 -5.57450661e-01
 -5.57450661e-01  6.30541551e-01  6.30541551e-01  6.30541551e-01
  3.90215516e+00  3.90215516e+00  3.90215516e+00  2.07871753e+01
  2.07871753e+01  2.07871753e+01  5.82724625e+01  1.04337141e+02
  1.04337141e+02  1.04337141e+02  3.99009578e+02  4.56652158e+02
  4.56652158e+02  4.56652158e+02  1.31313155e+03  1.31313155e+03
  1.31313155e+03  2.21194326e+03  3.01345937e+03  3.01345937e+03
  3.01345937e+03  6.63916793e+03  6.63916793e+03  6.63916793e+03
  8.56510979e+03  2.49386808e+04  7.57153705e+04]
E1 = -727.5406973719669  E_coul = 201.3210309776504
cycle= 1 E= -526.219666394317  delta_E= -0.897  |g|= 0.215  |ddm|= 0.793
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.578407
diis-c [-0.33455518  1.        ]
  HOMO = -0.581144920284205  LUMO = 0.623644372590519
  mo_energy =
[-1.18517875e+02 -1.22258229e+01 -9.56751563e+00 -9.56751563e+00
 -9.56751563e+00 -1.25997409e+00 -5.81144920e-01 -5.81144920e-01
 -5.81144920e-01  6.23644373e-01  6.23644373e-01  6.23644373e-01
  3.85331645e+00  3.85331645e+00  3.85331645e+00  2.06658515e+01
  2.06658515e+01  2.06658515e+01  5.80902422e+01  1.04114601e+02
  1.04114601e+02  1.04114601e+02  3.98689463e+02  4.56337275e+02
  4.56337275e+02  4.56337275e+02  1.31275465e+03  1.31275465e+03
  1.31275465e+03  2.21142694e+03  3.01301235e+03  3.01301235e+03
  3.01301235e+03  6.63859009e+03  6.63859009e+03  6.63859009e+03
  8.56444274e+03  2.49379097e+04  7.57145014e+04]
E1 = -727.9373242884233  E_coul = 201.71711843121082
cycle= 2 E= -526.220205857212  delta_E= -0.000539  |g|= 0.03  |ddm|= 0.0254
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0540589
diis-c [-0.00203081  0.04923084  0.95076916]
  HOMO = -0.575674507114601  LUMO = 0.626027053975729
  mo_energy =
[-1.18463966e+02 -1.21985910e+01 -9.53967831e+00 -9.53967831e+00
 -9.53967831e+00 -1.25269418e+00 -5.75674507e-01 -5.75674507e-01
 -5.75674507e-01  6.26027054e-01  6.26027054e-01  6.26027054e-01
  3.86379455e+00  3.86379455e+00  3.86379455e+00  2.06909399e+01
  2.06909399e+01  2.06909399e+01  5.81307839e+01  1.04157276e+02
  1.04157276e+02  1.04157276e+02  3.98743096e+02  4.56390781e+02
  4.56390781e+02  4.56390781e+02  1.31281173e+03  1.31281173e+03
  1.31281173e+03  2.21148645e+03  3.01307126e+03  3.01307126e+03
  3.01307126e+03  6.63865021e+03  6.63865021e+03  6.63865021e+03
  8.56450337e+03  2.49379706e+04  7.57145624e+04]
E1 = -727.8495352043096  E_coul = 201.629305997485
cycle= 3 E= -526.220229206825  delta_E= -2.33e-05  |g|= 0.00417  |ddm|= 0.00679
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00812675
diis-c [-4.94529115e-07 -1.16865540e-03  1.24740876e-01  8.76427779e-01]
  HOMO = -0.576702324019126  LUMO = 0.625578070376364
  mo_energy =
[-1.18471240e+02 -1.22026803e+01 -9.54391732e+00 -9.54391732e+00
 -9.54391732e+00 -1.25402565e+00 -5.76702324e-01 -5.76702324e-01
 -5.76702324e-01  6.25578070e-01  6.25578070e-01  6.25578070e-01
  3.86195721e+00  3.86195721e+00  3.86195721e+00  2.06870785e+01
  2.06870785e+01  2.06870785e+01  5.81252132e+01  1.04151311e+02
  1.04151311e+02  1.04151311e+02  3.98735856e+02  4.56383568e+02
  4.56383568e+02  4.56383568e+02  1.31280405e+03  1.31280405e+03
  1.31280405e+03  2.21147832e+03  3.01306329e+03  3.01306329e+03
  3.01306329e+03  6.63864195e+03  6.63864195e+03  6.63864195e+03
  8.56449494e+03  2.49379620e+04  7.57145537e+04]
E1 = -727.8622953555428  E_coul = 201.6420655132214
cycle= 4 E= -526.220229842321  delta_E= -6.35e-07  |g|= 5.61e-05  |ddm|= 0.001
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.32841e-05
diis-c [-2.89760935e-09 -6.98863679e-06  7.38399987e-05  6.82833888e-03
  9.93104810e-01]
  HOMO = -0.576670955235103  LUMO = 0.625591207027424
  mo_energy =
[-1.18471124e+02 -1.22025713e+01 -9.54380997e+00 -9.54380997e+00
 -9.54380997e+00 -1.25398369e+00 -5.76670955e-01 -5.76670955e-01
 -5.76670955e-01  6.25591207e-01  6.25591207e-01  6.25591207e-01
  3.86201147e+00  3.86201147e+00  3.86201147e+00  2.06871757e+01
  2.06871757e+01  2.06871757e+01  5.81253324e+01  1.04151424e+02
  1.04151424e+02  1.04151424e+02  3.98735970e+02  4.56383684e+02
  4.56383684e+02  4.56383684e+02  1.31280416e+03  1.31280416e+03
  1.31280416e+03  2.21147842e+03  3.01306339e+03  3.01306339e+03
  3.01306339e+03  6.63864204e+03  6.63864204e+03  6.63864204e+03
  8.56449503e+03  2.49379621e+04  7.57145538e+04]
E1 = -727.8619965966428  E_coul = 201.64176675404897
cycle= 5 E= -526.220229842594  delta_E= -2.73e-10  |g|= 9.05e-06  |ddm|= 3.36e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -727.8619965966428  E_coul = 201.64176675404897
  HOMO = -0.576676112700619  LUMO = 0.625588933232392
  mo_energy =
[-1.18471146e+02 -1.22025874e+01 -9.54382648e+00 -9.54382648e+00
 -9.54382648e+00 -1.25399028e+00 -5.76676113e-01 -5.76676113e-01
 -5.76676113e-01  6.25588933e-01  6.25588933e-01  6.25588933e-01
  3.86200285e+00  3.86200285e+00  3.86200285e+00  2.06871604e+01
  2.06871604e+01  2.06871604e+01  5.81253135e+01  1.04151405e+02
  1.04151405e+02  1.04151405e+02  3.98735948e+02  4.56383662e+02
  4.56383662e+02  4.56383662e+02  1.31280414e+03  1.31280414e+03
  1.31280414e+03  2.21147840e+03  3.01306337e+03  3.01306337e+03
  3.01306337e+03  6.63864202e+03  6.63864202e+03  6.63864202e+03
  8.56449501e+03  2.49379621e+04  7.57145538e+04]
E1 = -727.8620414936308  E_coul = 201.6418116510307
Extra cycle  E= -526.2202298426  delta_E= -6.25e-12  |g|= 2.41e-06  |ddm|= 3.76e-06
    CPU time for scf_cycle      0.67 sec, wall time      0.28 sec
exp = [2.61825164e+04 7.61814110e+03 3.61801426e+03 1.61478725e+03
 2.68939862e+02 8.12720555e+01 3.14448381e+01 4.48530288e+00
 4.03622022e-01 1.36278492e+03 6.65077874e+02 3.02754844e+02
 3.15647646e+02 5.96380674e+01 5.20537661e+00 1.62895202e+01
 5.27662398e-01 1.63978060e+00 1.63646404e-01]
E = -526.2202298426001
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:42:18 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5164393        1
[INPUT] 0    0    [1    /1   ]  7618.14109589        1
[INPUT] 0    0    [1    /1   ]  3618.01425622        1
[INPUT] 0    0    [1    /1   ]  1614.78725012        1
[INPUT] 0    0    [1    /1   ]  268.93986237         1
[INPUT] 0    0    [1    /1   ]  81.272055548         1
[INPUT] 0    0    [1    /1   ]  31.4448381063        1
[INPUT] 0    0    [1    /1   ]  4.48530288199        1
[INPUT] 0    0    [1    /1   ]  0.403622021857       1
[INPUT] 1    0    [1    /1   ]  1362.78491695        1
[INPUT] 1    0    [1    /1   ]  665.077874336        1
[INPUT] 1    0    [1    /1   ]  302.754844064        1
[INPUT] 1    0    [1    /1   ]  315.647646459        1
[INPUT] 1    0    [1    /1   ]  59.6380674092        1
[INPUT] 1    0    [1    /1   ]  5.20537660663        1
[INPUT] 1    0    [1    /1   ]  16.2895202026        1
[INPUT] 1    0    [1    /1   ]  0.527662398267       1
[INPUT] 1    0    [1    /1   ]  1.63978060478        1
[INPUT] 1    0    [1    /1   ]  0.163646404123       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.51643926599, 1.0]], [0, [7618.141095894433, 1.0]], [0, [3618.0142562157243, 1.0]], [0, [1614.7872501168467, 1.0]], [0, [268.9398623703784, 1.0]], [0, [81.27205554802427, 1.0]], [0, [31.444838106254515, 1.0]], [0, [4.485302881986162, 1.0]], [0, [0.40362202185714957, 1.0]], [1, [1362.7849169508056, 1.0]], [1, [665.0778743357605, 1.0]], [1, [302.7548440639868, 1.0]], [1, [315.6476464594947, 1.0]], [1, [59.638067409245245, 1.0]], [1, [5.205376606631118, 1.0]], [1, [16.28952020258567, 1.0]], [1, [0.5276623982674544, 1.0]], [1, [1.639780604784868, 1.0]], [1, [0.16364640412254194, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.51643927]
bas 1, expnt(s) = [7618.14109589]
bas 2, expnt(s) = [3618.01425622]
bas 3, expnt(s) = [1614.78725012]
bas 4, expnt(s) = [268.93986237]
bas 5, expnt(s) = [81.27205555]
bas 6, expnt(s) = [31.44483811]
bas 7, expnt(s) = [4.48530288]
bas 8, expnt(s) = [0.40362202]
bas 9, expnt(s) = [1362.78491695]
bas 10, expnt(s) = [665.07787434]
bas 11, expnt(s) = [302.75484406]
bas 12, expnt(s) = [315.64764646]
bas 13, expnt(s) = [59.63806741]
bas 14, expnt(s) = [5.20537661]
bas 15, expnt(s) = [16.2895202]
bas 16, expnt(s) = [0.5276624]
bas 17, expnt(s) = [1.6397806]
bas 18, expnt(s) = [0.1636464]
CPU time:       405.31
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825164e+04 5.20024210e+03 7.61814110e+03 2.06016395e+03
 3.61801426e+03 1.17860351e+03 1.61478725e+03 6.43578472e+02
 2.68939862e+02 1.67786266e+02 8.12720555e+01 6.83865913e+01
 3.14448381e+01 3.35488043e+01 4.48530288e+00 7.78679705e+00
 4.03622022e-01 1.27937001e+00 1.36278492e+03 2.41556395e+04
 6.65077874e+02 9.85314826e+03 3.02754844e+02 3.68424301e+03
 3.15647646e+02 3.88139272e+03 5.96380674e+01 4.83491501e+02
 5.20537661e+00 2.29376852e+01 1.62895202e+01 9.54706234e+01
 5.27662398e-01 1.31198713e+00 1.63978060e+00 5.41335582e+00
 1.63646404e-01 3.03645938e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98096231627344
cond(S) = 95199.7525114366
E1 = -728.512713728398  E_coul = 203.18968146769822
init E= -525.3230322607
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.557450661246477  LUMO = 0.630541550785094
  mo_energy =
[-1.18201079e+02 -1.21041956e+01 -9.43714605e+00 -9.43714605e+00
 -9.43714605e+00 -1.22635609e+00 -5.57450661e-01 -5.57450661e-01
 -5.57450661e-01  6.30541551e-01  6.30541551e-01  6.30541551e-01
  3.90215516e+00  3.90215516e+00  3.90215516e+00  2.07871753e+01
  2.07871753e+01  2.07871753e+01  5.82724625e+01  1.04337141e+02
  1.04337141e+02  1.04337141e+02  3.99009578e+02  4.56652158e+02
  4.56652158e+02  4.56652158e+02  1.31313155e+03  1.31313155e+03
  1.31313155e+03  2.21194326e+03  3.01345937e+03  3.01345937e+03
  3.01345937e+03  6.63916793e+03  6.63916793e+03  6.63916793e+03
  8.56510979e+03  2.49386808e+04  7.57153705e+04]
E1 = -727.5406973719669  E_coul = 201.3210309776504
cycle= 1 E= -526.219666394317  delta_E= -0.897  |g|= 0.215  |ddm|= 0.793
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.578407
diis-c [-0.33455518  1.        ]
  HOMO = -0.581144920284205  LUMO = 0.623644372590519
  mo_energy =
[-1.18517875e+02 -1.22258229e+01 -9.56751563e+00 -9.56751563e+00
 -9.56751563e+00 -1.25997409e+00 -5.81144920e-01 -5.81144920e-01
 -5.81144920e-01  6.23644373e-01  6.23644373e-01  6.23644373e-01
  3.85331645e+00  3.85331645e+00  3.85331645e+00  2.06658515e+01
  2.06658515e+01  2.06658515e+01  5.80902422e+01  1.04114601e+02
  1.04114601e+02  1.04114601e+02  3.98689463e+02  4.56337275e+02
  4.56337275e+02  4.56337275e+02  1.31275465e+03  1.31275465e+03
  1.31275465e+03  2.21142694e+03  3.01301235e+03  3.01301235e+03
  3.01301235e+03  6.63859009e+03  6.63859009e+03  6.63859009e+03
  8.56444274e+03  2.49379097e+04  7.57145014e+04]
E1 = -727.9373242884233  E_coul = 201.71711843121082
cycle= 2 E= -526.220205857212  delta_E= -0.000539  |g|= 0.03  |ddm|= 0.0254
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0540589
diis-c [-0.00203081  0.04923084  0.95076916]
  HOMO = -0.575674507114601  LUMO = 0.626027053975729
  mo_energy =
[-1.18463966e+02 -1.21985910e+01 -9.53967831e+00 -9.53967831e+00
 -9.53967831e+00 -1.25269418e+00 -5.75674507e-01 -5.75674507e-01
 -5.75674507e-01  6.26027054e-01  6.26027054e-01  6.26027054e-01
  3.86379455e+00  3.86379455e+00  3.86379455e+00  2.06909399e+01
  2.06909399e+01  2.06909399e+01  5.81307839e+01  1.04157276e+02
  1.04157276e+02  1.04157276e+02  3.98743096e+02  4.56390781e+02
  4.56390781e+02  4.56390781e+02  1.31281173e+03  1.31281173e+03
  1.31281173e+03  2.21148645e+03  3.01307126e+03  3.01307126e+03
  3.01307126e+03  6.63865021e+03  6.63865021e+03  6.63865021e+03
  8.56450337e+03  2.49379706e+04  7.57145624e+04]
E1 = -727.8495352043096  E_coul = 201.629305997485
cycle= 3 E= -526.220229206825  delta_E= -2.33e-05  |g|= 0.00417  |ddm|= 0.00679
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00812675
diis-c [-4.94529115e-07 -1.16865540e-03  1.24740876e-01  8.76427779e-01]
  HOMO = -0.576702324019126  LUMO = 0.625578070376364
  mo_energy =
[-1.18471240e+02 -1.22026803e+01 -9.54391732e+00 -9.54391732e+00
 -9.54391732e+00 -1.25402565e+00 -5.76702324e-01 -5.76702324e-01
 -5.76702324e-01  6.25578070e-01  6.25578070e-01  6.25578070e-01
  3.86195721e+00  3.86195721e+00  3.86195721e+00  2.06870785e+01
  2.06870785e+01  2.06870785e+01  5.81252132e+01  1.04151311e+02
  1.04151311e+02  1.04151311e+02  3.98735856e+02  4.56383568e+02
  4.56383568e+02  4.56383568e+02  1.31280405e+03  1.31280405e+03
  1.31280405e+03  2.21147832e+03  3.01306329e+03  3.01306329e+03
  3.01306329e+03  6.63864195e+03  6.63864195e+03  6.63864195e+03
  8.56449494e+03  2.49379620e+04  7.57145537e+04]
E1 = -727.8622953555428  E_coul = 201.6420655132214
cycle= 4 E= -526.220229842321  delta_E= -6.35e-07  |g|= 5.61e-05  |ddm|= 0.001
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=7.32841e-05
diis-c [-2.89760935e-09 -6.98863679e-06  7.38399987e-05  6.82833888e-03
  9.93104810e-01]
  HOMO = -0.576670955235103  LUMO = 0.625591207027424
  mo_energy =
[-1.18471124e+02 -1.22025713e+01 -9.54380997e+00 -9.54380997e+00
 -9.54380997e+00 -1.25398369e+00 -5.76670955e-01 -5.76670955e-01
 -5.76670955e-01  6.25591207e-01  6.25591207e-01  6.25591207e-01
  3.86201147e+00  3.86201147e+00  3.86201147e+00  2.06871757e+01
  2.06871757e+01  2.06871757e+01  5.81253324e+01  1.04151424e+02
  1.04151424e+02  1.04151424e+02  3.98735970e+02  4.56383684e+02
  4.56383684e+02  4.56383684e+02  1.31280416e+03  1.31280416e+03
  1.31280416e+03  2.21147842e+03  3.01306339e+03  3.01306339e+03
  3.01306339e+03  6.63864204e+03  6.63864204e+03  6.63864204e+03
  8.56449503e+03  2.49379621e+04  7.57145538e+04]
E1 = -727.8619965966428  E_coul = 201.64176675404897
cycle= 5 E= -526.220229842594  delta_E= -2.73e-10  |g|= 9.05e-06  |ddm|= 3.36e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -727.8619965966428  E_coul = 201.64176675404897
  HOMO = -0.576676112700619  LUMO = 0.625588933232392
  mo_energy =
[-1.18471146e+02 -1.22025874e+01 -9.54382648e+00 -9.54382648e+00
 -9.54382648e+00 -1.25399028e+00 -5.76676113e-01 -5.76676113e-01
 -5.76676113e-01  6.25588933e-01  6.25588933e-01  6.25588933e-01
  3.86200285e+00  3.86200285e+00  3.86200285e+00  2.06871604e+01
  2.06871604e+01  2.06871604e+01  5.81253135e+01  1.04151405e+02
  1.04151405e+02  1.04151405e+02  3.98735948e+02  4.56383662e+02
  4.56383662e+02  4.56383662e+02  1.31280414e+03  1.31280414e+03
  1.31280414e+03  2.21147840e+03  3.01306337e+03  3.01306337e+03
  3.01306337e+03  6.63864202e+03  6.63864202e+03  6.63864202e+03
  8.56449501e+03  2.49379621e+04  7.57145538e+04]
E1 = -727.8620414936308  E_coul = 201.6418116510307
Extra cycle  E= -526.2202298426  delta_E= -6.25e-12  |g|= 2.41e-06  |ddm|= 3.76e-06
    CPU time for scf_cycle      0.66 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 95199.7525114366
E1 = -727.8620414936308  E_coul = 201.6418116510307
init E= -526.2202298426
    CPU time for initialize scf      2.71 sec, wall time      0.25 sec
  HOMO = -0.576675264430148  LUMO = 0.625589296671472
  mo_energy =
[-1.18471141e+02 -1.22025841e+01 -9.54382308e+00 -9.54382308e+00
 -9.54382308e+00 -1.25398916e+00 -5.76675264e-01 -5.76675264e-01
 -5.76675264e-01  6.25589297e-01  6.25589297e-01  6.25589297e-01
  3.86200437e+00  3.86200437e+00  3.86200437e+00  2.06871635e+01
  2.06871635e+01  2.06871635e+01  5.81253178e+01  1.04151409e+02
  1.04151409e+02  1.04151409e+02  3.98735954e+02  4.56383667e+02
  4.56383667e+02  4.56383667e+02  1.31280414e+03  1.31280414e+03
  1.31280414e+03  2.21147840e+03  3.01306338e+03  3.01306338e+03
  3.01306338e+03  6.63864203e+03  6.63864203e+03  6.63864203e+03
  8.56449501e+03  2.49379621e+04  7.57145538e+04]
E1 = -727.8620313865865  E_coul = 201.6418015439872
cycle= 1 E= -526.220229842599  delta_E= 7.96e-13  |g|= 5.75e-07  |ddm|= 8.84e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.8620313865865  E_coul = 201.6418015439872
  HOMO = -0.576675454991984  LUMO = 0.6255892134428
  mo_energy =
[-1.18471142e+02 -1.22025848e+01 -9.54382384e+00 -9.54382384e+00
 -9.54382384e+00 -1.25398941e+00 -5.76675455e-01 -5.76675455e-01
 -5.76675455e-01  6.25589213e-01  6.25589213e-01  6.25589213e-01
  3.86200403e+00  3.86200403e+00  3.86200403e+00  2.06871628e+01
  2.06871628e+01  2.06871628e+01  5.81253168e+01  1.04151408e+02
  1.04151408e+02  1.04151408e+02  3.98735952e+02  4.56383666e+02
  4.56383666e+02  4.56383666e+02  1.31280414e+03  1.31280414e+03
  1.31280414e+03  2.21147840e+03  3.01306338e+03  3.01306338e+03
  3.01306338e+03  6.63864203e+03  6.63864203e+03  6.63864203e+03
  8.56449501e+03  2.49379621e+04  7.57145538e+04]
E1 = -727.8620336181982  E_coul = 201.64180377559887
Extra cycle  E= -526.220229842599  delta_E=    0  |g|= 1.32e-07  |ddm|= 1.8e-07
    CPU time for scf_cycle      2.85 sec, wall time      0.39 sec
exp = [2.61825164e+04 7.61814110e+03 3.61801426e+03 1.61478725e+03
 2.68939862e+02 8.12720555e+01 3.14448381e+01 4.48530288e+00
 4.03622022e-01 1.36278492e+03 6.65077874e+02 3.02754844e+02
 3.15647646e+02 5.96380674e+01 5.20537661e+00 1.62895202e+01
 5.27662398e-01 1.63978060e+00 1.63646404e-01]
grad_E = [-1.98013822e-06  1.94934888e-05  3.62070077e-05  6.11479098e-04
 -7.17370627e-03  4.95026051e-03  3.03095454e-03 -2.92201534e-02
  1.17278087e-01 -5.59895719e-07  5.51533061e-07 -4.55258208e-06
 -3.18960052e-06  6.05210629e-03 -1.44831768e-03 -2.09832435e-02
 -1.02717606e-01  2.02709361e-03  2.31985294e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:42:22 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5182998        1
[INPUT] 0    0    [1    /1   ]  7618.11710935        1
[INPUT] 0    0    [1    /1   ]  3617.96232229        1
[INPUT] 0    0    [1    /1   ]  1614.02742679        1
[INPUT] 0    0    [1    /1   ]  276.313256219        1
[INPUT] 0    0    [1    /1   ]  84.0584305384        1
[INPUT] 0    0    [1    /1   ]  31.6668150651        1
[INPUT] 0    0    [1    /1   ]  4.4632712342         1
[INPUT] 0    0    [1    /1   ]  0.40413760323        1
[INPUT] 1    0    [1    /1   ]  1362.78318048        1
[INPUT] 1    0    [1    /1   ]  665.055901859        1
[INPUT] 1    0    [1    /1   ]  302.633906487        1
[INPUT] 1    0    [1    /1   ]  315.541000908        1
[INPUT] 1    0    [1    /1   ]  61.9486223177        1
[INPUT] 1    0    [1    /1   ]  5.20284954902        1
[INPUT] 1    0    [1    /1   ]  16.5388688577        1
[INPUT] 1    0    [1    /1   ]  0.484597357615       1
[INPUT] 1    0    [1    /1   ]  1.51159610096        1
[INPUT] 1    0    [1    /1   ]  0.147429308045       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.51829980268, 1.0]], [0, [7618.117109345763, 1.0]], [0, [3617.9623222930504, 1.0]], [0, [1614.0274267912587, 1.0]], [0, [276.3132562188268, 1.0]], [0, [84.05843053838012, 1.0]], [0, [31.666815065124883, 1.0]], [0, [4.463271234204452, 1.0]], [0, [0.4041376032302348, 1.0]], [1, [1362.783180483554, 1.0]], [1, [665.0559018585767, 1.0]], [1, [302.63390648734395, 1.0]], [1, [315.54100090846134, 1.0]], [1, [61.94862231773779, 1.0]], [1, [5.202849549021381, 1.0]], [1, [16.53886885774, 1.0]], [1, [0.4845973576154816, 1.0]], [1, [1.5115961009620518, 1.0]], [1, [0.14742930804501556, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.5182998]
bas 1, expnt(s) = [7618.11710935]
bas 2, expnt(s) = [3617.96232229]
bas 3, expnt(s) = [1614.02742679]
bas 4, expnt(s) = [276.31325622]
bas 5, expnt(s) = [84.05843054]
bas 6, expnt(s) = [31.66681507]
bas 7, expnt(s) = [4.46327123]
bas 8, expnt(s) = [0.4041376]
bas 9, expnt(s) = [1362.78318048]
bas 10, expnt(s) = [665.05590186]
bas 11, expnt(s) = [302.63390649]
bas 12, expnt(s) = [315.54100091]
bas 13, expnt(s) = [61.94862232]
bas 14, expnt(s) = [5.20284955]
bas 15, expnt(s) = [16.53886886]
bas 16, expnt(s) = [0.48459736]
bas 17, expnt(s) = [1.5115961]
bas 18, expnt(s) = [0.14742931]
CPU time:       413.45
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825183e+04 5.20024238e+03 7.61811711e+03 2.06015908e+03
 3.61796232e+03 1.17859082e+03 1.61402743e+03 6.43351336e+02
 2.76313256e+02 1.71224661e+02 8.40584305e+01 7.01376131e+01
 3.16668151e+01 3.37262701e+01 4.46327123e+00 7.75809305e+00
 4.04137603e-01 1.28059550e+00 1.36278318e+03 2.41556011e+04
 6.65055902e+02 9.85274136e+03 3.02633906e+02 3.68240348e+03
 3.15541001e+02 3.87975357e+03 6.19486223e+01 5.07018678e+02
 5.20284955e+00 2.29237665e+01 1.65388689e+01 9.73008529e+01
 4.84597358e-01 1.17953463e+00 1.51159610e+00 4.88966489e+00
 1.47429308e-01 2.66510409e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.980564921158194
cond(S) = 97777.78078784184
E1 = -728.4649120648479  E_coul = 203.16088243045593
init E= -525.304029634392
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.557626738142555  LUMO = 0.549345808179443
  mo_energy =
[-1.18223884e+02 -1.21042569e+01 -9.43745492e+00 -9.43745492e+00
 -9.43745492e+00 -1.22626544e+00 -5.57626738e-01 -5.57626738e-01
 -5.57626738e-01  5.49345808e-01  5.49345808e-01  5.49345808e-01
  3.48841049e+00  3.48841049e+00  3.48841049e+00  2.02203351e+01
  2.02203351e+01  2.02203351e+01  5.95827700e+01  1.06665945e+02
  1.06665945e+02  1.06665945e+02  4.11856858e+02  4.63558471e+02
  4.63558471e+02  4.63558471e+02  1.32101999e+03  1.32101999e+03
  1.32101999e+03  2.24409589e+03  3.02114111e+03  3.02114111e+03
  3.02114111e+03  6.64618500e+03  6.64618500e+03  6.64618500e+03
  8.60019363e+03  2.49725031e+04  7.57468504e+04]
E1 = -727.4694643596816  E_coul = 201.2300838352795
cycle= 1 E= -526.239380524402  delta_E= -0.935  |g|= 0.219  |ddm|= 1.03
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.581536
diis-c [-0.33818359  1.        ]
  HOMO = -0.582748697810675  LUMO = 0.543561717600658
  mo_energy =
[-1.18549888e+02 -1.22285408e+01 -9.57228651e+00 -9.57228651e+00
 -9.57228651e+00 -1.26148090e+00 -5.82748698e-01 -5.82748698e-01
 -5.82748698e-01  5.43561718e-01  5.43561718e-01  5.43561718e-01
  3.44039071e+00  3.44039071e+00  3.44039071e+00  2.00935605e+01
  2.00935605e+01  2.00935605e+01  5.93947506e+01  1.06433317e+02
  1.06433317e+02  1.06433317e+02  4.11523852e+02  4.63234303e+02
  4.63234303e+02  4.63234303e+02  1.32063287e+03  1.32063287e+03
  1.32063287e+03  2.24356924e+03  3.02068398e+03  3.02068398e+03
  3.02068398e+03  6.64559795e+03  6.64559795e+03  6.64559795e+03
  8.59951821e+03  2.49717240e+04  7.57459737e+04]
E1 = -727.8831699999866  E_coul = 201.64319842628473
cycle= 2 E= -526.239971573702  delta_E= -0.000591  |g|= 0.0312  |ddm|= 0.0263
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.055154
diis-c [-0.00206467  0.05116326  0.94883674]
  HOMO = -0.577050359247278  LUMO = 0.545687011322353
  mo_energy =
[-1.18493897e+02 -1.22001729e+01 -9.54328788e+00 -9.54328788e+00
 -9.54328788e+00 -1.25388814e+00 -5.77050359e-01 -5.77050359e-01
 -5.77050359e-01  5.45687011e-01  5.45687011e-01  5.45687011e-01
  3.45065822e+00  3.45065822e+00  3.45065822e+00  2.01198616e+01
  2.01198616e+01  2.01198616e+01  5.94372781e+01  1.06478130e+02
  1.06478130e+02  1.06478130e+02  4.11579765e+02  4.63289924e+02
  4.63289924e+02  4.63289924e+02  1.32069211e+03  1.32069211e+03
  1.32069211e+03  2.24363097e+03  3.02074509e+03  3.02074509e+03
  3.02074509e+03  6.64566030e+03  6.64566030e+03  6.64566030e+03
  8.59958106e+03  2.49717872e+04  7.57460369e+04]
E1 = -727.790621869534  E_coul = 201.55062468376374
cycle= 3 E= -526.23999718577  delta_E= -2.56e-05  |g|= 0.00429  |ddm|= 0.00706
    CPU time for cycle= 3      0.03 sec, wall time      0.04 sec
diis-norm(errvec)=0.00823824
diis-c [-6.20844546e-07 -1.20732908e-03  1.23649757e-01  8.77557572e-01]
  HOMO = -0.578149200310335  LUMO = 0.545270290763232
  mo_energy =
[-1.18501422e+02 -1.22044420e+01 -9.54771716e+00 -9.54771716e+00
 -9.54771716e+00 -1.25530728e+00 -5.78149200e-01 -5.78149200e-01
 -5.78149200e-01  5.45270291e-01  5.45270291e-01  5.45270291e-01
  3.44881323e+00  3.44881323e+00  3.44881323e+00  2.01157988e+01
  2.01157988e+01  2.01157988e+01  5.94314622e+01  1.06471888e+02
  1.06471888e+02  1.06471888e+02  4.11572246e+02  4.63282456e+02
  4.63282456e+02  4.63282456e+02  1.32068417e+03  1.32068417e+03
  1.32068417e+03  2.24362256e+03  3.02073685e+03  3.02073685e+03
  3.02073685e+03  6.64565175e+03  6.64565175e+03  6.64565175e+03
  8.59957234e+03  2.49717783e+04  7.57460279e+04]
E1 = -727.8039786137364  E_coul = 201.5639807363616
cycle= 4 E= -526.239997877375  delta_E= -6.92e-07  |g|= 6.12e-05  |ddm|= 0.00102
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=7.9737e-05
diis-c [-3.36788757e-09 -4.14368886e-06 -4.39321954e-04  3.84352879e-03
  9.96599937e-01]
  HOMO = -0.578117885858028  LUMO = 0.545281185594538
  mo_energy =
[-1.18501298e+02 -1.22043261e+01 -9.54760295e+00 -9.54760295e+00
 -9.54760295e+00 -1.25526469e+00 -5.78117886e-01 -5.78117886e-01
 -5.78117886e-01  5.45281186e-01  5.45281186e-01  5.45281186e-01
  3.44886546e+00  3.44886546e+00  3.44886546e+00  2.01159018e+01
  2.01159018e+01  2.01159018e+01  5.94315895e+01  1.06472009e+02
  1.06472009e+02  1.06472009e+02  4.11572368e+02  4.63282580e+02
  4.63282580e+02  4.63282580e+02  1.32068429e+03  1.32068429e+03
  1.32068429e+03  2.24362266e+03  3.02073696e+03  3.02073696e+03
  3.02073696e+03  6.64565185e+03  6.64565185e+03  6.64565185e+03
  8.59957244e+03  2.49717784e+04  7.57460280e+04]
E1 = -727.8036401287836  E_coul = 201.5636422510453
cycle= 5 E= -526.239997877738  delta_E= -3.64e-10  |g|= 1.03e-05  |ddm|= 4.1e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -727.8036401287836  E_coul = 201.5636422510453
  HOMO = -0.578124108723534  LUMO = 0.545278760491754
  mo_energy =
[-1.18501323e+02 -1.22043446e+01 -9.54762192e+00 -9.54762192e+00
 -9.54762192e+00 -1.25527258e+00 -5.78124109e-01 -5.78124109e-01
 -5.78124109e-01  5.45278760e-01  5.45278760e-01  5.45278760e-01
  3.44885570e+00  3.44885570e+00  3.44885570e+00  2.01158842e+01
  2.01158842e+01  2.01158842e+01  5.94315678e+01  1.06471986e+02
  1.06471986e+02  1.06471986e+02  4.11572343e+02  4.63282555e+02
  4.63282555e+02  4.63282555e+02  1.32068426e+03  1.32068426e+03
  1.32068426e+03  2.24362264e+03  3.02073694e+03  3.02073694e+03
  3.02073694e+03  6.64565183e+03  6.64565183e+03  6.64565183e+03
  8.59957241e+03  2.49717784e+04  7.57460280e+04]
E1 = -727.8036903307982  E_coul = 201.56369245305237
Extra cycle  E= -526.239997877746  delta_E= -7.5e-12  |g|= 2.71e-06  |ddm|= 4.16e-06
    CPU time for scf_cycle      0.67 sec, wall time      0.28 sec
exp = [2.61825183e+04 7.61811711e+03 3.61796232e+03 1.61402743e+03
 2.76313256e+02 8.40584305e+01 3.16668151e+01 4.46327123e+00
 4.04137603e-01 1.36278318e+03 6.65055902e+02 3.02633906e+02
 3.15541001e+02 6.19486223e+01 5.20284955e+00 1.65388689e+01
 4.84597358e-01 1.51159610e+00 1.47429308e-01]
E = -526.2399978777459
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:42:23 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5182998        1
[INPUT] 0    0    [1    /1   ]  7618.11710935        1
[INPUT] 0    0    [1    /1   ]  3617.96232229        1
[INPUT] 0    0    [1    /1   ]  1614.02742679        1
[INPUT] 0    0    [1    /1   ]  276.313256219        1
[INPUT] 0    0    [1    /1   ]  84.0584305384        1
[INPUT] 0    0    [1    /1   ]  31.6668150651        1
[INPUT] 0    0    [1    /1   ]  4.4632712342         1
[INPUT] 0    0    [1    /1   ]  0.40413760323        1
[INPUT] 1    0    [1    /1   ]  1362.78318048        1
[INPUT] 1    0    [1    /1   ]  665.055901859        1
[INPUT] 1    0    [1    /1   ]  302.633906487        1
[INPUT] 1    0    [1    /1   ]  315.541000908        1
[INPUT] 1    0    [1    /1   ]  61.9486223177        1
[INPUT] 1    0    [1    /1   ]  5.20284954902        1
[INPUT] 1    0    [1    /1   ]  16.5388688577        1
[INPUT] 1    0    [1    /1   ]  0.484597357615       1
[INPUT] 1    0    [1    /1   ]  1.51159610096        1
[INPUT] 1    0    [1    /1   ]  0.147429308045       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.51829980268, 1.0]], [0, [7618.117109345763, 1.0]], [0, [3617.9623222930504, 1.0]], [0, [1614.0274267912587, 1.0]], [0, [276.3132562188268, 1.0]], [0, [84.05843053838012, 1.0]], [0, [31.666815065124883, 1.0]], [0, [4.463271234204452, 1.0]], [0, [0.4041376032302348, 1.0]], [1, [1362.783180483554, 1.0]], [1, [665.0559018585767, 1.0]], [1, [302.63390648734395, 1.0]], [1, [315.54100090846134, 1.0]], [1, [61.94862231773779, 1.0]], [1, [5.202849549021381, 1.0]], [1, [16.53886885774, 1.0]], [1, [0.4845973576154816, 1.0]], [1, [1.5115961009620518, 1.0]], [1, [0.14742930804501556, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.5182998]
bas 1, expnt(s) = [7618.11710935]
bas 2, expnt(s) = [3617.96232229]
bas 3, expnt(s) = [1614.02742679]
bas 4, expnt(s) = [276.31325622]
bas 5, expnt(s) = [84.05843054]
bas 6, expnt(s) = [31.66681507]
bas 7, expnt(s) = [4.46327123]
bas 8, expnt(s) = [0.4041376]
bas 9, expnt(s) = [1362.78318048]
bas 10, expnt(s) = [665.05590186]
bas 11, expnt(s) = [302.63390649]
bas 12, expnt(s) = [315.54100091]
bas 13, expnt(s) = [61.94862232]
bas 14, expnt(s) = [5.20284955]
bas 15, expnt(s) = [16.53886886]
bas 16, expnt(s) = [0.48459736]
bas 17, expnt(s) = [1.5115961]
bas 18, expnt(s) = [0.14742931]
CPU time:       414.29
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825183e+04 5.20024238e+03 7.61811711e+03 2.06015908e+03
 3.61796232e+03 1.17859082e+03 1.61402743e+03 6.43351336e+02
 2.76313256e+02 1.71224661e+02 8.40584305e+01 7.01376131e+01
 3.16668151e+01 3.37262701e+01 4.46327123e+00 7.75809305e+00
 4.04137603e-01 1.28059550e+00 1.36278318e+03 2.41556011e+04
 6.65055902e+02 9.85274136e+03 3.02633906e+02 3.68240348e+03
 3.15541001e+02 3.87975357e+03 6.19486223e+01 5.07018678e+02
 5.20284955e+00 2.29237665e+01 1.65388689e+01 9.73008529e+01
 4.84597358e-01 1.17953463e+00 1.51159610e+00 4.88966489e+00
 1.47429308e-01 2.66510409e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.980564921158194
cond(S) = 97777.78078784184
E1 = -728.4649120648479  E_coul = 203.16088243045593
init E= -525.304029634392
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.557626738142555  LUMO = 0.549345808179443
  mo_energy =
[-1.18223884e+02 -1.21042569e+01 -9.43745492e+00 -9.43745492e+00
 -9.43745492e+00 -1.22626544e+00 -5.57626738e-01 -5.57626738e-01
 -5.57626738e-01  5.49345808e-01  5.49345808e-01  5.49345808e-01
  3.48841049e+00  3.48841049e+00  3.48841049e+00  2.02203351e+01
  2.02203351e+01  2.02203351e+01  5.95827700e+01  1.06665945e+02
  1.06665945e+02  1.06665945e+02  4.11856858e+02  4.63558471e+02
  4.63558471e+02  4.63558471e+02  1.32101999e+03  1.32101999e+03
  1.32101999e+03  2.24409589e+03  3.02114111e+03  3.02114111e+03
  3.02114111e+03  6.64618500e+03  6.64618500e+03  6.64618500e+03
  8.60019363e+03  2.49725031e+04  7.57468504e+04]
E1 = -727.4694643596816  E_coul = 201.2300838352795
cycle= 1 E= -526.239380524402  delta_E= -0.935  |g|= 0.219  |ddm|= 1.03
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.581536
diis-c [-0.33818359  1.        ]
  HOMO = -0.582748697810675  LUMO = 0.543561717600658
  mo_energy =
[-1.18549888e+02 -1.22285408e+01 -9.57228651e+00 -9.57228651e+00
 -9.57228651e+00 -1.26148090e+00 -5.82748698e-01 -5.82748698e-01
 -5.82748698e-01  5.43561718e-01  5.43561718e-01  5.43561718e-01
  3.44039071e+00  3.44039071e+00  3.44039071e+00  2.00935605e+01
  2.00935605e+01  2.00935605e+01  5.93947506e+01  1.06433317e+02
  1.06433317e+02  1.06433317e+02  4.11523852e+02  4.63234303e+02
  4.63234303e+02  4.63234303e+02  1.32063287e+03  1.32063287e+03
  1.32063287e+03  2.24356924e+03  3.02068398e+03  3.02068398e+03
  3.02068398e+03  6.64559795e+03  6.64559795e+03  6.64559795e+03
  8.59951821e+03  2.49717240e+04  7.57459737e+04]
E1 = -727.8831699999866  E_coul = 201.64319842628473
cycle= 2 E= -526.239971573702  delta_E= -0.000591  |g|= 0.0312  |ddm|= 0.0263
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.055154
diis-c [-0.00206467  0.05116326  0.94883674]
  HOMO = -0.577050359247278  LUMO = 0.545687011322353
  mo_energy =
[-1.18493897e+02 -1.22001729e+01 -9.54328788e+00 -9.54328788e+00
 -9.54328788e+00 -1.25388814e+00 -5.77050359e-01 -5.77050359e-01
 -5.77050359e-01  5.45687011e-01  5.45687011e-01  5.45687011e-01
  3.45065822e+00  3.45065822e+00  3.45065822e+00  2.01198616e+01
  2.01198616e+01  2.01198616e+01  5.94372781e+01  1.06478130e+02
  1.06478130e+02  1.06478130e+02  4.11579765e+02  4.63289924e+02
  4.63289924e+02  4.63289924e+02  1.32069211e+03  1.32069211e+03
  1.32069211e+03  2.24363097e+03  3.02074509e+03  3.02074509e+03
  3.02074509e+03  6.64566030e+03  6.64566030e+03  6.64566030e+03
  8.59958106e+03  2.49717872e+04  7.57460369e+04]
E1 = -727.790621869534  E_coul = 201.55062468376374
cycle= 3 E= -526.23999718577  delta_E= -2.56e-05  |g|= 0.00429  |ddm|= 0.00706
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00823824
diis-c [-6.20844546e-07 -1.20732908e-03  1.23649757e-01  8.77557572e-01]
  HOMO = -0.578149200310335  LUMO = 0.545270290763232
  mo_energy =
[-1.18501422e+02 -1.22044420e+01 -9.54771716e+00 -9.54771716e+00
 -9.54771716e+00 -1.25530728e+00 -5.78149200e-01 -5.78149200e-01
 -5.78149200e-01  5.45270291e-01  5.45270291e-01  5.45270291e-01
  3.44881323e+00  3.44881323e+00  3.44881323e+00  2.01157988e+01
  2.01157988e+01  2.01157988e+01  5.94314622e+01  1.06471888e+02
  1.06471888e+02  1.06471888e+02  4.11572246e+02  4.63282456e+02
  4.63282456e+02  4.63282456e+02  1.32068417e+03  1.32068417e+03
  1.32068417e+03  2.24362256e+03  3.02073685e+03  3.02073685e+03
  3.02073685e+03  6.64565175e+03  6.64565175e+03  6.64565175e+03
  8.59957234e+03  2.49717783e+04  7.57460279e+04]
E1 = -727.8039786137364  E_coul = 201.5639807363616
cycle= 4 E= -526.239997877375  delta_E= -6.92e-07  |g|= 6.12e-05  |ddm|= 0.00102
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=7.9737e-05
diis-c [-3.36788757e-09 -4.14368886e-06 -4.39321954e-04  3.84352879e-03
  9.96599937e-01]
  HOMO = -0.578117885858028  LUMO = 0.545281185594538
  mo_energy =
[-1.18501298e+02 -1.22043261e+01 -9.54760295e+00 -9.54760295e+00
 -9.54760295e+00 -1.25526469e+00 -5.78117886e-01 -5.78117886e-01
 -5.78117886e-01  5.45281186e-01  5.45281186e-01  5.45281186e-01
  3.44886546e+00  3.44886546e+00  3.44886546e+00  2.01159018e+01
  2.01159018e+01  2.01159018e+01  5.94315895e+01  1.06472009e+02
  1.06472009e+02  1.06472009e+02  4.11572368e+02  4.63282580e+02
  4.63282580e+02  4.63282580e+02  1.32068429e+03  1.32068429e+03
  1.32068429e+03  2.24362266e+03  3.02073696e+03  3.02073696e+03
  3.02073696e+03  6.64565185e+03  6.64565185e+03  6.64565185e+03
  8.59957244e+03  2.49717784e+04  7.57460280e+04]
E1 = -727.8036401287836  E_coul = 201.5636422510453
cycle= 5 E= -526.239997877738  delta_E= -3.64e-10  |g|= 1.03e-05  |ddm|= 4.1e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -727.8036401287836  E_coul = 201.5636422510453
  HOMO = -0.578124108723534  LUMO = 0.545278760491754
  mo_energy =
[-1.18501323e+02 -1.22043446e+01 -9.54762192e+00 -9.54762192e+00
 -9.54762192e+00 -1.25527258e+00 -5.78124109e-01 -5.78124109e-01
 -5.78124109e-01  5.45278760e-01  5.45278760e-01  5.45278760e-01
  3.44885570e+00  3.44885570e+00  3.44885570e+00  2.01158842e+01
  2.01158842e+01  2.01158842e+01  5.94315678e+01  1.06471986e+02
  1.06471986e+02  1.06471986e+02  4.11572343e+02  4.63282555e+02
  4.63282555e+02  4.63282555e+02  1.32068426e+03  1.32068426e+03
  1.32068426e+03  2.24362264e+03  3.02073694e+03  3.02073694e+03
  3.02073694e+03  6.64565183e+03  6.64565183e+03  6.64565183e+03
  8.59957241e+03  2.49717784e+04  7.57460280e+04]
E1 = -727.8036903307982  E_coul = 201.56369245305237
Extra cycle  E= -526.239997877746  delta_E= -7.5e-12  |g|= 2.71e-06  |ddm|= 4.16e-06
    CPU time for scf_cycle      0.67 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 97777.78078784184
E1 = -727.8036903307982  E_coul = 201.56369245305237
init E= -526.239997877746
    CPU time for initialize scf      2.76 sec, wall time      0.25 sec
  HOMO = -0.578123182331592  LUMO = 0.545279097218128
  mo_energy =
[-1.18501317e+02 -1.22043409e+01 -9.54761810e+00 -9.54761810e+00
 -9.54761810e+00 -1.25527135e+00 -5.78123182e-01 -5.78123182e-01
 -5.78123182e-01  5.45279097e-01  5.45279097e-01  5.45279097e-01
  3.44885728e+00  3.44885728e+00  3.44885728e+00  2.01158877e+01
  2.01158877e+01  2.01158877e+01  5.94315727e+01  1.06471991e+02
  1.06471991e+02  1.06471991e+02  4.11572349e+02  4.63282561e+02
  4.63282561e+02  4.63282561e+02  1.32068427e+03  1.32068427e+03
  1.32068427e+03  2.24362264e+03  3.02073694e+03  3.02073694e+03
  3.02073694e+03  6.64565183e+03  6.64565183e+03  6.64565183e+03
  8.59957242e+03  2.49717784e+04  7.57460280e+04]
E1 = -727.803678627215  E_coul = 201.56368074946897
cycle= 1 E= -526.239997877746  delta_E= -2.27e-13  |g|= 6.55e-07  |ddm|= 1.04e-06
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.803678627215  E_coul = 201.56368074946897
  HOMO = -0.578123409015184  LUMO = 0.545279010920552
  mo_energy =
[-1.18501318e+02 -1.22043418e+01 -9.54761897e+00 -9.54761897e+00
 -9.54761897e+00 -1.25527165e+00 -5.78123409e-01 -5.78123409e-01
 -5.78123409e-01  5.45279011e-01  5.45279011e-01  5.45279011e-01
  3.44885690e+00  3.44885690e+00  3.44885690e+00  2.01158869e+01
  2.01158869e+01  2.01158869e+01  5.94315715e+01  1.06471990e+02
  1.06471990e+02  1.06471990e+02  4.11572347e+02  4.63282560e+02
  4.63282560e+02  4.63282560e+02  1.32068427e+03  1.32068427e+03
  1.32068427e+03  2.24362264e+03  3.02073694e+03  3.02073694e+03
  3.02073694e+03  6.64565183e+03  6.64565183e+03  6.64565183e+03
  8.59957242e+03  2.49717784e+04  7.57460280e+04]
E1 = -727.8036811991344  E_coul = 201.5636833213875
Extra cycle  E= -526.239997877747  delta_E= -7.96e-13  |g|= 1.51e-07  |ddm|= 1.99e-07
    CPU time for scf_cycle      2.90 sec, wall time      0.39 sec
exp = [2.61825183e+04 7.61811711e+03 3.61796232e+03 1.61402743e+03
 2.76313256e+02 8.40584305e+01 3.16668151e+01 4.46327123e+00
 4.04137603e-01 1.36278318e+03 6.65055902e+02 3.02633906e+02
 3.15541001e+02 6.19486223e+01 5.20284955e+00 1.65388689e+01
 4.84597358e-01 1.51159610e+00 1.47429308e-01]
grad_E = [-1.97444032e-06  1.78466347e-05  3.12409312e-05  5.56257822e-04
 -6.49481563e-03  5.87277790e-03  8.73057817e-04 -5.58392504e-02
  1.24832875e-01 -3.09073763e-07 -1.60712630e-07 -7.93047625e-06
 -5.60392450e-06  6.84669306e-03  1.61134609e-02 -2.66773266e-02
 -1.30994141e-01 -9.86833366e-03 -2.73120615e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:42:27 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5215481        1
[INPUT] 0    0    [1    /1   ]  7618.07530955        1
[INPUT] 0    0    [1    /1   ]  3617.87189941        1
[INPUT] 0    0    [1    /1   ]  1612.7034073         1
[INPUT] 0    0    [1    /1   ]  289.176472086        1
[INPUT] 0    0    [1    /1   ]  88.8075483086        1
[INPUT] 0    0    [1    /1   ]  32.1312184853        1
[INPUT] 0    0    [1    /1   ]  4.46644196991        1
[INPUT] 0    0    [1    /1   ]  0.399404447133       1
[INPUT] 1    0    [1    /1   ]  1362.78018538        1
[INPUT] 1    0    [1    /1   ]  665.017863779        1
[INPUT] 1    0    [1    /1   ]  302.424654156        1
[INPUT] 1    0    [1    /1   ]  315.356470051        1
[INPUT] 1    0    [1    /1   ]  65.8694594573        1
[INPUT] 1    0    [1    /1   ]  5.35177282634        1
[INPUT] 1    0    [1    /1   ]  17.198121062         1
[INPUT] 1    0    [1    /1   ]  0.477497284746       1
[INPUT] 1    0    [1    /1   ]  1.55769416845        1
[INPUT] 1    0    [1    /1   ]  0.141728770821       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.521548139386, 1.0]], [0, [7618.075309547564, 1.0]], [0, [3617.871899412375, 1.0]], [0, [1612.7034072968645, 1.0]], [0, [289.17647208612266, 1.0]], [0, [88.80754830862642, 1.0]], [0, [32.131218485340625, 1.0]], [0, [4.466441969906683, 1.0]], [0, [0.3994044471334887, 1.0]], [1, [1362.7801853808273, 1.0]], [1, [665.0178637791053, 1.0]], [1, [302.42465415601345, 1.0]], [1, [315.3564700505091, 1.0]], [1, [65.86945945727354, 1.0]], [1, [5.351772826337908, 1.0]], [1, [17.198121061984374, 1.0]], [1, [0.4774972847456011, 1.0]], [1, [1.5576941684539314, 1.0]], [1, [0.14172877082101454, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.52154814]
bas 1, expnt(s) = [7618.07530955]
bas 2, expnt(s) = [3617.87189941]
bas 3, expnt(s) = [1612.7034073]
bas 4, expnt(s) = [289.17647209]
bas 5, expnt(s) = [88.80754831]
bas 6, expnt(s) = [32.13121849]
bas 7, expnt(s) = [4.46644197]
bas 8, expnt(s) = [0.39940445]
bas 9, expnt(s) = [1362.78018538]
bas 10, expnt(s) = [665.01786378]
bas 11, expnt(s) = [302.42465416]
bas 12, expnt(s) = [315.35647005]
bas 13, expnt(s) = [65.86945946]
bas 14, expnt(s) = [5.35177283]
bas 15, expnt(s) = [17.19812106]
bas 16, expnt(s) = [0.47749728]
bas 17, expnt(s) = [1.55769417]
bas 18, expnt(s) = [0.14172877]
CPU time:       422.50
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825215e+04 5.20024286e+03 7.61807531e+03 2.06015061e+03
 3.61787190e+03 1.17856873e+03 1.61270341e+03 6.42955479e+02
 2.89176472e+02 1.77168799e+02 8.88075483e+01 7.30890698e+01
 3.21312185e+01 3.40965486e+01 4.46644197e+00 7.76222623e+00
 3.99404447e-01 1.26933044e+00 1.36278019e+03 2.41555347e+04
 6.65017864e+02 9.85203695e+03 3.02424654e+02 3.67922107e+03
 3.15356470e+02 3.87691764e+03 6.58694595e+01 5.47443769e+02
 5.35177283e+00 2.37468758e+01 1.71981211e+01 1.02172882e+02
 4.77497285e-01 1.15797191e+00 1.55769417e+00 5.07676587e+00
 1.41728771e-01 2.53692085e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.980594543894412
cond(S) = 103028.28108936003
E1 = -728.3874251710295  E_coul = 203.07440644965044
init E= -525.313018721379
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559411949075072  LUMO = 0.524957034400602
  mo_energy =
[-1.18257814e+02 -1.21073280e+01 -9.44276468e+00 -9.44276468e+00
 -9.44276468e+00 -1.22882794e+00 -5.59411949e-01 -5.59411949e-01
 -5.59411949e-01  5.24957034e-01  5.24957034e-01  5.24957034e-01
  3.51468107e+00  3.51468107e+00  3.51468107e+00  2.10404893e+01
  2.10404893e+01  2.10404893e+01  6.21348313e+01  1.12785237e+02
  1.12785237e+02  1.12785237e+02  4.34477462e+02  4.77015456e+02
  4.77015456e+02  4.77015456e+02  1.33610397e+03  1.33610397e+03
  1.33610397e+03  2.29981662e+03  3.03583427e+03  3.03583427e+03
  3.03583427e+03  6.65963630e+03  6.65963630e+03  6.65963630e+03
  8.66142291e+03  2.50316780e+04  7.58019796e+04]
E1 = -727.3717942838887  E_coul = 201.09725686977495
cycle= 1 E= -526.274537414114  delta_E= -0.962  |g|= 0.222  |ddm|= 1.31
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.586928
diis-c [-0.34448457  1.        ]
  HOMO = -0.585021119735088  LUMO = 0.519437207465085
  mo_energy =
[-1.18592126e+02 -1.22341933e+01 -9.58118543e+00 -9.58118543e+00
 -9.58118543e+00 -1.26409556e+00 -5.85021120e-01 -5.85021120e-01
 -5.85021120e-01  5.19437207e-01  5.19437207e-01  5.19437207e-01
  3.46437799e+00  3.46437799e+00  3.46437799e+00  2.09070954e+01
  2.09070954e+01  2.09070954e+01  6.19395898e+01  1.12541933e+02
  1.12541933e+02  1.12541933e+02  4.34130196e+02  4.76682771e+02
  4.76682771e+02  4.76682771e+02  1.33570786e+03  1.33570786e+03
  1.33570786e+03  2.29928145e+03  3.03536872e+03  3.03536872e+03
  3.03536872e+03  6.65904293e+03  6.65904293e+03  6.65904293e+03
  8.66074292e+03  2.50308955e+04  7.58011004e+04]
E1 = -727.8020333697312  E_coul = 201.52686086710585
cycle= 2 E= -526.275172502625  delta_E= -0.000635  |g|= 0.0322  |ddm|= 0.0274
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0568609
diis-c [-0.0020985   0.05443371  0.94556629]
  HOMO = -0.579050990317767  LUMO = 0.521590054662844
  mo_energy =
[-1.18534301e+02 -1.22047920e+01 -9.55114081e+00 -9.55114081e+00
 -9.55114081e+00 -1.25619890e+00 -5.79050990e-01 -5.79050990e-01
 -5.79050990e-01  5.21590055e-01  5.21590055e-01  5.21590055e-01
  3.47533437e+00  3.47533437e+00  3.47533437e+00  2.09349222e+01
  2.09349222e+01  2.09349222e+01  6.19841576e+01  1.12588896e+02
  1.12588896e+02  1.12588896e+02  4.34188288e+02  4.76740257e+02
  4.76740257e+02  4.76740257e+02  1.33576897e+03  1.33576897e+03
  1.33576897e+03  2.29934516e+03  3.03543176e+03  3.03543176e+03
  3.03543176e+03  6.65910724e+03  6.65910724e+03  6.65910724e+03
  8.66080776e+03  2.50309606e+04  7.58011656e+04]
E1 = -727.7070131839066  E_coul = 201.4318133438832
cycle= 3 E= -526.275199840023  delta_E= -2.73e-05  |g|= 0.00428  |ddm|= 0.00726
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00827468
diis-c [-6.59808590e-07 -1.23292585e-03  1.20400431e-01  8.80832495e-01]
  HOMO = -0.580151396119464  LUMO = 0.52118877623265
  mo_energy =
[-1.18541845e+02 -1.22090791e+01 -9.55559109e+00 -9.55559109e+00
 -9.55559109e+00 -1.25761417e+00 -5.80151396e-01 -5.80151396e-01
 -5.80151396e-01  5.21188776e-01  5.21188776e-01  5.21188776e-01
  3.47344715e+00  3.47344715e+00  3.47344715e+00  2.09307705e+01
  2.09307705e+01  2.09307705e+01  6.19782645e+01  1.12582563e+02
  1.12582563e+02  1.12582563e+02  4.34180705e+02  4.76732766e+02
  4.76732766e+02  4.76732766e+02  1.33576102e+03  1.33576102e+03
  1.33576102e+03  2.29933671e+03  3.03542350e+03  3.03542350e+03
  3.03542350e+03  6.65909866e+03  6.65909866e+03  6.65909866e+03
  8.66079900e+03  2.50309517e+04  7.58011566e+04]
E1 = -727.7203622958373  E_coul = 201.44516176456523
cycle= 4 E= -526.275200531272  delta_E= -6.91e-07  |g|= 5.87e-05  |ddm|= 0.00103
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.59702e-05
diis-c [-3.42289460e-09 -2.65770183e-06 -7.97236596e-04  4.82989924e-04
  1.00031690e+00]
  HOMO = -0.580119469937965  LUMO = 0.521199662719494
  mo_energy =
[-1.18541725e+02 -1.22089647e+01 -9.55547856e+00 -9.55547856e+00
 -9.55547856e+00 -1.25757128e+00 -5.80119470e-01 -5.80119470e-01
 -5.80119470e-01  5.21199663e-01  5.21199663e-01  5.21199663e-01
  3.47350087e+00  3.47350087e+00  3.47350087e+00  2.09308731e+01
  2.09308731e+01  2.09308731e+01  6.19783896e+01  1.12582682e+02
  1.12582682e+02  1.12582682e+02  4.34180822e+02  4.76732886e+02
  4.76732886e+02  4.76732886e+02  1.33576113e+03  1.33576113e+03
  1.33576113e+03  2.29933682e+03  3.03542361e+03  3.03542361e+03
  3.03542361e+03  6.65909877e+03  6.65909877e+03  6.65909877e+03
  8.66079910e+03  2.50309518e+04  7.58011567e+04]
E1 = -727.7200373412254  E_coul = 201.4448368096328
cycle= 5 E= -526.275200531593  delta_E= -3.21e-10  |g|= 1.04e-05  |ddm|= 3.79e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.7200373412254  E_coul = 201.4448368096328
  HOMO = -0.580125579396718  LUMO = 0.521197383796218
  mo_energy =
[-1.18541750e+02 -1.22089834e+01 -9.55549765e+00 -9.55549765e+00
 -9.55549765e+00 -1.25757903e+00 -5.80125579e-01 -5.80125579e-01
 -5.80125579e-01  5.21197384e-01  5.21197384e-01  5.21197384e-01
  3.47349106e+00  3.47349106e+00  3.47349106e+00  2.09308552e+01
  2.09308552e+01  2.09308552e+01  6.19783676e+01  1.12582659e+02
  1.12582659e+02  1.12582659e+02  4.34180797e+02  4.76732861e+02
  4.76732861e+02  4.76732861e+02  1.33576111e+03  1.33576111e+03
  1.33576111e+03  2.29933679e+03  3.03542358e+03  3.03542358e+03
  3.03542358e+03  6.65909874e+03  6.65909874e+03  6.65909874e+03
  8.66079907e+03  2.50309518e+04  7.58011567e+04]
E1 = -727.7200880428477  E_coul = 201.44488751124752
Extra cycle  E= -526.2752005316  delta_E= -7.5e-12  |g|= 2.73e-06  |ddm|= 4.2e-06
    CPU time for scf_cycle      0.66 sec, wall time      0.27 sec
exp = [2.61825215e+04 7.61807531e+03 3.61787190e+03 1.61270341e+03
 2.89176472e+02 8.88075483e+01 3.21312185e+01 4.46644197e+00
 3.99404447e-01 1.36278019e+03 6.65017864e+02 3.02424654e+02
 3.15356470e+02 6.58694595e+01 5.35177283e+00 1.71981211e+01
 4.77497285e-01 1.55769417e+00 1.41728771e-01]
E = -526.2752005316001
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:42:27 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5215481        1
[INPUT] 0    0    [1    /1   ]  7618.07530955        1
[INPUT] 0    0    [1    /1   ]  3617.87189941        1
[INPUT] 0    0    [1    /1   ]  1612.7034073         1
[INPUT] 0    0    [1    /1   ]  289.176472086        1
[INPUT] 0    0    [1    /1   ]  88.8075483086        1
[INPUT] 0    0    [1    /1   ]  32.1312184853        1
[INPUT] 0    0    [1    /1   ]  4.46644196991        1
[INPUT] 0    0    [1    /1   ]  0.399404447133       1
[INPUT] 1    0    [1    /1   ]  1362.78018538        1
[INPUT] 1    0    [1    /1   ]  665.017863779        1
[INPUT] 1    0    [1    /1   ]  302.424654156        1
[INPUT] 1    0    [1    /1   ]  315.356470051        1
[INPUT] 1    0    [1    /1   ]  65.8694594573        1
[INPUT] 1    0    [1    /1   ]  5.35177282634        1
[INPUT] 1    0    [1    /1   ]  17.198121062         1
[INPUT] 1    0    [1    /1   ]  0.477497284746       1
[INPUT] 1    0    [1    /1   ]  1.55769416845        1
[INPUT] 1    0    [1    /1   ]  0.141728770821       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.521548139386, 1.0]], [0, [7618.075309547564, 1.0]], [0, [3617.871899412375, 1.0]], [0, [1612.7034072968645, 1.0]], [0, [289.17647208612266, 1.0]], [0, [88.80754830862642, 1.0]], [0, [32.131218485340625, 1.0]], [0, [4.466441969906683, 1.0]], [0, [0.3994044471334887, 1.0]], [1, [1362.7801853808273, 1.0]], [1, [665.0178637791053, 1.0]], [1, [302.42465415601345, 1.0]], [1, [315.3564700505091, 1.0]], [1, [65.86945945727354, 1.0]], [1, [5.351772826337908, 1.0]], [1, [17.198121061984374, 1.0]], [1, [0.4774972847456011, 1.0]], [1, [1.5576941684539314, 1.0]], [1, [0.14172877082101454, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.52154814]
bas 1, expnt(s) = [7618.07530955]
bas 2, expnt(s) = [3617.87189941]
bas 3, expnt(s) = [1612.7034073]
bas 4, expnt(s) = [289.17647209]
bas 5, expnt(s) = [88.80754831]
bas 6, expnt(s) = [32.13121849]
bas 7, expnt(s) = [4.46644197]
bas 8, expnt(s) = [0.39940445]
bas 9, expnt(s) = [1362.78018538]
bas 10, expnt(s) = [665.01786378]
bas 11, expnt(s) = [302.42465416]
bas 12, expnt(s) = [315.35647005]
bas 13, expnt(s) = [65.86945946]
bas 14, expnt(s) = [5.35177283]
bas 15, expnt(s) = [17.19812106]
bas 16, expnt(s) = [0.47749728]
bas 17, expnt(s) = [1.55769417]
bas 18, expnt(s) = [0.14172877]
CPU time:       423.33
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825215e+04 5.20024286e+03 7.61807531e+03 2.06015061e+03
 3.61787190e+03 1.17856873e+03 1.61270341e+03 6.42955479e+02
 2.89176472e+02 1.77168799e+02 8.88075483e+01 7.30890698e+01
 3.21312185e+01 3.40965486e+01 4.46644197e+00 7.76222623e+00
 3.99404447e-01 1.26933044e+00 1.36278019e+03 2.41555347e+04
 6.65017864e+02 9.85203695e+03 3.02424654e+02 3.67922107e+03
 3.15356470e+02 3.87691764e+03 6.58694595e+01 5.47443769e+02
 5.35177283e+00 2.37468758e+01 1.71981211e+01 1.02172882e+02
 4.77497285e-01 1.15797191e+00 1.55769417e+00 5.07676587e+00
 1.41728771e-01 2.53692085e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.980594543894412
cond(S) = 103028.28108936003
E1 = -728.3874251710295  E_coul = 203.07440644965044
init E= -525.313018721379
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559411949075072  LUMO = 0.524957034400602
  mo_energy =
[-1.18257814e+02 -1.21073280e+01 -9.44276468e+00 -9.44276468e+00
 -9.44276468e+00 -1.22882794e+00 -5.59411949e-01 -5.59411949e-01
 -5.59411949e-01  5.24957034e-01  5.24957034e-01  5.24957034e-01
  3.51468107e+00  3.51468107e+00  3.51468107e+00  2.10404893e+01
  2.10404893e+01  2.10404893e+01  6.21348313e+01  1.12785237e+02
  1.12785237e+02  1.12785237e+02  4.34477462e+02  4.77015456e+02
  4.77015456e+02  4.77015456e+02  1.33610397e+03  1.33610397e+03
  1.33610397e+03  2.29981662e+03  3.03583427e+03  3.03583427e+03
  3.03583427e+03  6.65963630e+03  6.65963630e+03  6.65963630e+03
  8.66142291e+03  2.50316780e+04  7.58019796e+04]
E1 = -727.3717942838887  E_coul = 201.09725686977495
cycle= 1 E= -526.274537414114  delta_E= -0.962  |g|= 0.222  |ddm|= 1.31
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.586928
diis-c [-0.34448457  1.        ]
  HOMO = -0.585021119735088  LUMO = 0.519437207465085
  mo_energy =
[-1.18592126e+02 -1.22341933e+01 -9.58118543e+00 -9.58118543e+00
 -9.58118543e+00 -1.26409556e+00 -5.85021120e-01 -5.85021120e-01
 -5.85021120e-01  5.19437207e-01  5.19437207e-01  5.19437207e-01
  3.46437799e+00  3.46437799e+00  3.46437799e+00  2.09070954e+01
  2.09070954e+01  2.09070954e+01  6.19395898e+01  1.12541933e+02
  1.12541933e+02  1.12541933e+02  4.34130196e+02  4.76682771e+02
  4.76682771e+02  4.76682771e+02  1.33570786e+03  1.33570786e+03
  1.33570786e+03  2.29928145e+03  3.03536872e+03  3.03536872e+03
  3.03536872e+03  6.65904293e+03  6.65904293e+03  6.65904293e+03
  8.66074292e+03  2.50308955e+04  7.58011004e+04]
E1 = -727.8020333697312  E_coul = 201.52686086710585
cycle= 2 E= -526.275172502625  delta_E= -0.000635  |g|= 0.0322  |ddm|= 0.0274
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0568609
diis-c [-0.0020985   0.05443371  0.94556629]
  HOMO = -0.579050990317767  LUMO = 0.521590054662844
  mo_energy =
[-1.18534301e+02 -1.22047920e+01 -9.55114081e+00 -9.55114081e+00
 -9.55114081e+00 -1.25619890e+00 -5.79050990e-01 -5.79050990e-01
 -5.79050990e-01  5.21590055e-01  5.21590055e-01  5.21590055e-01
  3.47533437e+00  3.47533437e+00  3.47533437e+00  2.09349222e+01
  2.09349222e+01  2.09349222e+01  6.19841576e+01  1.12588896e+02
  1.12588896e+02  1.12588896e+02  4.34188288e+02  4.76740257e+02
  4.76740257e+02  4.76740257e+02  1.33576897e+03  1.33576897e+03
  1.33576897e+03  2.29934516e+03  3.03543176e+03  3.03543176e+03
  3.03543176e+03  6.65910724e+03  6.65910724e+03  6.65910724e+03
  8.66080776e+03  2.50309606e+04  7.58011656e+04]
E1 = -727.7070131839066  E_coul = 201.4318133438832
cycle= 3 E= -526.275199840023  delta_E= -2.73e-05  |g|= 0.00428  |ddm|= 0.00726
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00827468
diis-c [-6.59808590e-07 -1.23292585e-03  1.20400431e-01  8.80832495e-01]
  HOMO = -0.580151396119464  LUMO = 0.52118877623265
  mo_energy =
[-1.18541845e+02 -1.22090791e+01 -9.55559109e+00 -9.55559109e+00
 -9.55559109e+00 -1.25761417e+00 -5.80151396e-01 -5.80151396e-01
 -5.80151396e-01  5.21188776e-01  5.21188776e-01  5.21188776e-01
  3.47344715e+00  3.47344715e+00  3.47344715e+00  2.09307705e+01
  2.09307705e+01  2.09307705e+01  6.19782645e+01  1.12582563e+02
  1.12582563e+02  1.12582563e+02  4.34180705e+02  4.76732766e+02
  4.76732766e+02  4.76732766e+02  1.33576102e+03  1.33576102e+03
  1.33576102e+03  2.29933671e+03  3.03542350e+03  3.03542350e+03
  3.03542350e+03  6.65909866e+03  6.65909866e+03  6.65909866e+03
  8.66079900e+03  2.50309517e+04  7.58011566e+04]
E1 = -727.7203622958373  E_coul = 201.44516176456523
cycle= 4 E= -526.275200531272  delta_E= -6.91e-07  |g|= 5.87e-05  |ddm|= 0.00103
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=7.59702e-05
diis-c [-3.42289460e-09 -2.65770183e-06 -7.97236596e-04  4.82989924e-04
  1.00031690e+00]
  HOMO = -0.580119469937965  LUMO = 0.521199662719494
  mo_energy =
[-1.18541725e+02 -1.22089647e+01 -9.55547856e+00 -9.55547856e+00
 -9.55547856e+00 -1.25757128e+00 -5.80119470e-01 -5.80119470e-01
 -5.80119470e-01  5.21199663e-01  5.21199663e-01  5.21199663e-01
  3.47350087e+00  3.47350087e+00  3.47350087e+00  2.09308731e+01
  2.09308731e+01  2.09308731e+01  6.19783896e+01  1.12582682e+02
  1.12582682e+02  1.12582682e+02  4.34180822e+02  4.76732886e+02
  4.76732886e+02  4.76732886e+02  1.33576113e+03  1.33576113e+03
  1.33576113e+03  2.29933682e+03  3.03542361e+03  3.03542361e+03
  3.03542361e+03  6.65909877e+03  6.65909877e+03  6.65909877e+03
  8.66079910e+03  2.50309518e+04  7.58011567e+04]
E1 = -727.7200373412254  E_coul = 201.4448368096328
cycle= 5 E= -526.275200531593  delta_E= -3.21e-10  |g|= 1.04e-05  |ddm|= 3.79e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.7200373412254  E_coul = 201.4448368096328
  HOMO = -0.580125579396718  LUMO = 0.521197383796218
  mo_energy =
[-1.18541750e+02 -1.22089834e+01 -9.55549765e+00 -9.55549765e+00
 -9.55549765e+00 -1.25757903e+00 -5.80125579e-01 -5.80125579e-01
 -5.80125579e-01  5.21197384e-01  5.21197384e-01  5.21197384e-01
  3.47349106e+00  3.47349106e+00  3.47349106e+00  2.09308552e+01
  2.09308552e+01  2.09308552e+01  6.19783676e+01  1.12582659e+02
  1.12582659e+02  1.12582659e+02  4.34180797e+02  4.76732861e+02
  4.76732861e+02  4.76732861e+02  1.33576111e+03  1.33576111e+03
  1.33576111e+03  2.29933679e+03  3.03542358e+03  3.03542358e+03
  3.03542358e+03  6.65909874e+03  6.65909874e+03  6.65909874e+03
  8.66079907e+03  2.50309518e+04  7.58011567e+04]
E1 = -727.7200880428477  E_coul = 201.44488751124752
Extra cycle  E= -526.2752005316  delta_E= -7.5e-12  |g|= 2.73e-06  |ddm|= 4.2e-06
    CPU time for scf_cycle      0.66 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103028.28108936003
E1 = -727.7200880428477  E_coul = 201.44488751124752
init E= -526.2752005316
    CPU time for initialize scf      2.71 sec, wall time      0.24 sec
  HOMO = -0.580124634859612  LUMO = 0.521197716933135
  mo_energy =
[-1.18541744e+02 -1.22089796e+01 -9.55549380e+00 -9.55549380e+00
 -9.55549380e+00 -1.25757779e+00 -5.80124635e-01 -5.80124635e-01
 -5.80124635e-01  5.21197717e-01  5.21197717e-01  5.21197717e-01
  3.47349269e+00  3.47349269e+00  3.47349269e+00  2.09308588e+01
  2.09308588e+01  2.09308588e+01  6.19783725e+01  1.12582664e+02
  1.12582664e+02  1.12582664e+02  4.34180803e+02  4.76732867e+02
  4.76732867e+02  4.76732867e+02  1.33576111e+03  1.33576111e+03
  1.33576111e+03  2.29933680e+03  3.03542359e+03  3.03542359e+03
  3.03542359e+03  6.65909875e+03  6.65909875e+03  6.65909875e+03
  8.66079908e+03  2.50309518e+04  7.58011567e+04]
E1 = -727.7200763876426  E_coul = 201.44487585604273
cycle= 1 E= -526.2752005316  delta_E= 2.27e-13  |g|= 6.55e-07  |ddm|= 1.02e-06
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.7200763876426  E_coul = 201.44487585604273
  HOMO = -0.580124858555623  LUMO = 0.521197635040137
  mo_energy =
[-1.18541745e+02 -1.22089805e+01 -9.55549467e+00 -9.55549467e+00
 -9.55549467e+00 -1.25757808e+00 -5.80124859e-01 -5.80124859e-01
 -5.80124859e-01  5.21197635e-01  5.21197635e-01  5.21197635e-01
  3.47349231e+00  3.47349231e+00  3.47349231e+00  2.09308580e+01
  2.09308580e+01  2.09308580e+01  6.19783714e+01  1.12582663e+02
  1.12582663e+02  1.12582663e+02  4.34180802e+02  4.76732865e+02
  4.76732865e+02  4.76732865e+02  1.33576111e+03  1.33576111e+03
  1.33576111e+03  2.29933680e+03  3.03542358e+03  3.03542358e+03
  3.03542358e+03  6.65909874e+03  6.65909874e+03  6.65909874e+03
  8.66079908e+03  2.50309518e+04  7.58011567e+04]
E1 = -727.7200789421297  E_coul = 201.44487841052933
Extra cycle  E= -526.2752005316  delta_E= -4.55e-13  |g|= 1.5e-07  |ddm|= 2e-07
    CPU time for scf_cycle      2.85 sec, wall time      0.39 sec
exp = [2.61825215e+04 7.61807531e+03 3.61787190e+03 1.61270341e+03
 2.89176472e+02 8.88075483e+01 3.21312185e+01 4.46644197e+00
 3.99404447e-01 1.36278019e+03 6.65017864e+02 3.02424654e+02
 3.15356470e+02 6.58694595e+01 5.35177283e+00 1.71981211e+01
 4.77497285e-01 1.55769417e+00 1.41728771e-01]
grad_E = [-1.95572570e-06  1.53392690e-05  2.39571313e-05  4.72354271e-04
 -5.47682624e-03  7.08554572e-03 -2.87908973e-03 -6.66229093e-02
  5.64362944e-02  2.50192169e-07  2.62515396e-07 -3.65546221e-06
 -1.08332903e-06  6.82286596e-03  2.08611867e-02 -2.80090649e-02
 -1.90059149e-01 -6.26240727e-03 -3.23851272e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:42:32 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5286108        1
[INPUT] 0    0    [1    /1   ]  7617.98462587        1
[INPUT] 0    0    [1    /1   ]  3617.67592334        1
[INPUT] 0    0    [1    /1   ]  1609.83176497        1
[INPUT] 0    0    [1    /1   ]  316.838248487        1
[INPUT] 0    0    [1    /1   ]  99.9481787896        1
[INPUT] 0    0    [1    /1   ]  34.7068323223        1
[INPUT] 0    0    [1    /1   ]  4.49261297394        1
[INPUT] 0    0    [1    /1   ]  0.393469285572       1
[INPUT] 1    0    [1    /1   ]  1362.77373626        1
[INPUT] 1    0    [1    /1   ]  664.93566404         1
[INPUT] 1    0    [1    /1   ]  301.972689354        1
[INPUT] 1    0    [1    /1   ]  314.957895898        1
[INPUT] 1    0    [1    /1   ]  74.1623600084        1
[INPUT] 1    0    [1    /1   ]  6.03150981392        1
[INPUT] 1    0    [1    /1   ]  19.1020006503        1
[INPUT] 1    0    [1    /1   ]  0.60261078045        1
[INPUT] 1    0    [1    /1   ]  1.91020434583        1
[INPUT] 1    0    [1    /1   ]  0.169420789715       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.5286107546, 1.0]], [0, [7617.984625874145, 1.0]], [0, [3617.675923344693, 1.0]], [0, [1609.8317649659184, 1.0]], [0, [316.8382484874282, 1.0]], [0, [99.94817878955635, 1.0]], [0, [34.70683232233587, 1.0]], [0, [4.492612973936314, 1.0]], [0, [0.3934692855723833, 1.0]], [1, [1362.7737362634853, 1.0]], [1, [664.9356640399092, 1.0]], [1, [301.97268935409517, 1.0]], [1, [314.9578958981633, 1.0]], [1, [74.16236000838244, 1.0]], [1, [6.031509813918687, 1.0]], [1, [19.10200065030763, 1.0]], [1, [0.60261078045047, 1.0]], [1, [1.9102043458252231, 1.0]], [1, [0.16942078971536717, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.52861075]
bas 1, expnt(s) = [7617.98462587]
bas 2, expnt(s) = [3617.67592334]
bas 3, expnt(s) = [1609.83176497]
bas 4, expnt(s) = [316.83824849]
bas 5, expnt(s) = [99.94817879]
bas 6, expnt(s) = [34.70683232]
bas 7, expnt(s) = [4.49261297]
bas 8, expnt(s) = [0.39346929]
bas 9, expnt(s) = [1362.77373626]
bas 10, expnt(s) = [664.93566404]
bas 11, expnt(s) = [301.97268935]
bas 12, expnt(s) = [314.9578959]
bas 13, expnt(s) = [74.16236001]
bas 14, expnt(s) = [6.03150981]
bas 15, expnt(s) = [19.10200065]
bas 16, expnt(s) = [0.60261078]
bas 17, expnt(s) = [1.91020435]
bas 18, expnt(s) = [0.16942079]
CPU time:       431.55
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825286e+04 5.20024391e+03 7.61798463e+03 2.06013221e+03
 3.61767592e+03 1.17852085e+03 1.60983176e+03 6.42096635e+02
 3.16838248e+02 1.89733154e+02 9.99481788e+01 7.98631044e+01
 3.47068323e+01 3.61265307e+01 4.49261297e+00 7.79631323e+00
 3.93469286e-01 1.25515729e+00 1.36277374e+03 2.41553918e+04
 6.64935664e+02 9.85051477e+03 3.01972689e+02 3.67234924e+03
 3.14957896e+02 3.87079363e+03 7.41623600e+01 6.34912415e+02
 6.03150981e+00 2.75750902e+01 1.91020007e+01 1.16501888e+02
 6.02610780e-01 1.54892544e+00 1.91020435e+00 6.55140094e+00
 1.69420790e-01 3.17097465e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.980091777325825
cond(S) = 116786.56392274152
E1 = -728.3918130120246  E_coul = 202.9821951888302
init E= -525.409617823194
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.561530579034225  LUMO = 0.694625499438137
  mo_energy =
[-1.18296718e+02 -1.21133783e+01 -9.45162888e+00 -9.45162888e+00
 -9.45162888e+00 -1.23099159e+00 -5.61530579e-01 -5.61530579e-01
 -5.61530579e-01  6.94625499e-01  6.94625499e-01  6.94625499e-01
  4.71446407e+00  4.71446407e+00  4.71446407e+00  2.55754478e+01
  2.55754478e+01  2.55754478e+01  7.11245147e+01  1.29394375e+02
  1.29394375e+02  1.29394375e+02  4.91451183e+02  5.08348769e+02
  5.08348769e+02  5.08348769e+02  1.37122719e+03  1.37122719e+03
  1.37122719e+03  2.42724932e+03  3.07028097e+03  3.07028097e+03
  3.07028097e+03  6.69132120e+03  6.69132120e+03  6.69132120e+03
  8.80189423e+03  2.51679448e+04  7.59291635e+04]
E1 = -727.3728461469728  E_coul = 201.03021391605662
cycle= 1 E= -526.342632230916  delta_E= -0.933  |g|= 0.216  |ddm|= 1.37
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.586801
diis-c [-0.34433591  1.        ]
  HOMO = -0.587711427686715  LUMO = 0.684438299478829
  mo_energy =
[-1.18628817e+02 -1.22376243e+01 -9.58697743e+00 -9.58697743e+00
 -9.58697743e+00 -1.26608427e+00 -5.87711428e-01 -5.87711428e-01
 -5.87711428e-01  6.84438299e-01  6.84438299e-01  6.84438299e-01
  4.65393086e+00  4.65393086e+00  4.65393086e+00  2.54363304e+01
  2.54363304e+01  2.54363304e+01  7.09235054e+01  1.29146590e+02
  1.29146590e+02  1.29146590e+02  4.91096240e+02  5.08019054e+02
  5.08019054e+02  5.08019054e+02  1.37083577e+03  1.37083577e+03
  1.37083577e+03  2.42672010e+03  3.06982136e+03  3.06982136e+03
  3.06982136e+03  6.69073844e+03  6.69073844e+03  6.69073844e+03
  8.80122853e+03  2.51671792e+04  7.59283032e+04]
E1 = -727.7877490907215  E_coul = 201.44449551917157
cycle= 2 E= -526.34325357155  delta_E= -0.000621  |g|= 0.0314  |ddm|= 0.0265
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.056756
diis-c [-0.00199501  0.05646941  0.94353059]
  HOMO = -0.582144742390665  LUMO = 0.687265797191052
  mo_energy =
[-1.18572550e+02 -1.22092840e+01 -9.55802886e+00 -9.55802886e+00
 -9.55802886e+00 -1.25874017e+00 -5.82144742e-01 -5.82144742e-01
 -5.82144742e-01  6.87265797e-01  6.87265797e-01  6.87265797e-01
  4.66633166e+00  4.66633166e+00  4.66633166e+00  2.54647338e+01
  2.54647338e+01  2.54647338e+01  7.09683524e+01  1.29193218e+02
  1.29193218e+02  1.29193218e+02  4.91153466e+02  5.08075028e+02
  5.08075028e+02  5.08075028e+02  1.37089520e+03  1.37089520e+03
  1.37089520e+03  2.42678217e+03  3.06988270e+03  3.06988270e+03
  3.06988270e+03  6.69080105e+03  6.69080105e+03  6.69080105e+03
  8.80129167e+03  2.51672426e+04  7.59283667e+04]
E1 = -727.6958279332449  E_coul = 201.35254857184552
cycle= 3 E= -526.343279361399  delta_E= -2.58e-05  |g|= 0.00401  |ddm|= 0.00748
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00791531
diis-c [-6.95915970e-07 -1.17800024e-03  1.15641088e-01  8.85536912e-01]
  HOMO = -0.583226209079665  LUMO = 0.68671467952336
  mo_energy =
[-1.18579741e+02 -1.22134115e+01 -9.56230296e+00 -9.56230296e+00
 -9.56230296e+00 -1.26011922e+00 -5.83226209e-01 -5.83226209e-01
 -5.83226209e-01  6.86714680e-01  6.86714680e-01  6.86714680e-01
  4.66417447e+00  4.66417447e+00  4.66417447e+00  2.54605556e+01
  2.54605556e+01  2.54605556e+01  7.09625455e+01  1.29187059e+02
  1.29187059e+02  1.29187059e+02  4.91146157e+02  5.08067883e+02
  5.08067883e+02  5.08067883e+02  1.37088763e+03  1.37088763e+03
  1.37088763e+03  2.42677413e+03  3.06987484e+03  3.06987484e+03
  3.06987484e+03  6.69079289e+03  6.69079289e+03  6.69079289e+03
  8.80128335e+03  2.51672341e+04  7.59283581e+04]
E1 = -727.7087099309844  E_coul = 201.36542993725425
cycle= 4 E= -526.34327999373  delta_E= -6.32e-07  |g|= 7.07e-05  |ddm|= 0.00106
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=9.85933e-05
diis-c [-3.62257202e-09 -1.26375235e-05  8.27866445e-05  1.08999247e-02
  9.89029926e-01]
  HOMO = -0.583186674618446  LUMO = 0.686734044341042
  mo_energy =
[-1.18579590e+02 -1.22132741e+01 -9.56216625e+00 -9.56216625e+00
 -9.56216625e+00 -1.26006700e+00 -5.83186675e-01 -5.83186675e-01
 -5.83186675e-01  6.86734044e-01  6.86734044e-01  6.86734044e-01
  4.66425135e+00  4.66425135e+00  4.66425135e+00  2.54606837e+01
  2.54606837e+01  2.54606837e+01  7.09626982e+01  1.29187207e+02
  1.29187207e+02  1.29187207e+02  4.91146305e+02  5.08068034e+02
  5.08068034e+02  5.08068034e+02  1.37088778e+03  1.37088778e+03
  1.37088778e+03  2.42677426e+03  3.06987498e+03  3.06987498e+03
  3.06987498e+03  6.69079303e+03  6.69079303e+03  6.69079303e+03
  8.80128348e+03  2.51672342e+04  7.59283583e+04]
E1 = -727.7083219850318  E_coul = 201.36504199083132
cycle= 5 E= -526.343279994201  delta_E= -4.7e-10  |g|= 1.06e-05  |ddm|= 4.47e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -727.7083219850318  E_coul = 201.36504199083132
  HOMO = -0.583192823341774  LUMO = 0.686730902854776
  mo_energy =
[-1.18579616e+02 -1.22132932e+01 -9.56218566e+00 -9.56218566e+00
 -9.56218566e+00 -1.26007477e+00 -5.83192823e-01 -5.83192823e-01
 -5.83192823e-01  6.86730903e-01  6.86730903e-01  6.86730903e-01
  4.66423995e+00  4.66423995e+00  4.66423995e+00  2.54606650e+01
  2.54606650e+01  2.54606650e+01  7.09626753e+01  1.29187183e+02
  1.29187183e+02  1.29187183e+02  4.91146279e+02  5.08068008e+02
  5.08068008e+02  5.08068008e+02  1.37088775e+03  1.37088775e+03
  1.37088775e+03  2.42677424e+03  3.06987496e+03  3.06987496e+03
  3.06987496e+03  6.69079300e+03  6.69079300e+03  6.69079300e+03
  8.80128345e+03  2.51672342e+04  7.59283582e+04]
E1 = -727.7083758054299  E_coul = 201.36509581122183
Extra cycle  E= -526.343279994208  delta_E= -7.5e-12  |g|= 2.79e-06  |ddm|= 4.73e-06
    CPU time for scf_cycle      0.67 sec, wall time      0.28 sec
exp = [2.61825286e+04 7.61798463e+03 3.61767592e+03 1.60983176e+03
 3.16838248e+02 9.99481788e+01 3.47068323e+01 4.49261297e+00
 3.93469286e-01 1.36277374e+03 6.64935664e+02 3.01972689e+02
 3.14957896e+02 7.41623600e+01 6.03150981e+00 1.91020007e+01
 6.02610780e-01 1.91020435e+00 1.69420790e-01]
E = -526.343279994208
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:42:32 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5286108        1
[INPUT] 0    0    [1    /1   ]  7617.98462587        1
[INPUT] 0    0    [1    /1   ]  3617.67592334        1
[INPUT] 0    0    [1    /1   ]  1609.83176497        1
[INPUT] 0    0    [1    /1   ]  316.838248487        1
[INPUT] 0    0    [1    /1   ]  99.9481787896        1
[INPUT] 0    0    [1    /1   ]  34.7068323223        1
[INPUT] 0    0    [1    /1   ]  4.49261297394        1
[INPUT] 0    0    [1    /1   ]  0.393469285572       1
[INPUT] 1    0    [1    /1   ]  1362.77373626        1
[INPUT] 1    0    [1    /1   ]  664.93566404         1
[INPUT] 1    0    [1    /1   ]  301.972689354        1
[INPUT] 1    0    [1    /1   ]  314.957895898        1
[INPUT] 1    0    [1    /1   ]  74.1623600084        1
[INPUT] 1    0    [1    /1   ]  6.03150981392        1
[INPUT] 1    0    [1    /1   ]  19.1020006503        1
[INPUT] 1    0    [1    /1   ]  0.60261078045        1
[INPUT] 1    0    [1    /1   ]  1.91020434583        1
[INPUT] 1    0    [1    /1   ]  0.169420789715       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.5286107546, 1.0]], [0, [7617.984625874145, 1.0]], [0, [3617.675923344693, 1.0]], [0, [1609.8317649659184, 1.0]], [0, [316.8382484874282, 1.0]], [0, [99.94817878955635, 1.0]], [0, [34.70683232233587, 1.0]], [0, [4.492612973936314, 1.0]], [0, [0.3934692855723833, 1.0]], [1, [1362.7737362634853, 1.0]], [1, [664.9356640399092, 1.0]], [1, [301.97268935409517, 1.0]], [1, [314.9578958981633, 1.0]], [1, [74.16236000838244, 1.0]], [1, [6.031509813918687, 1.0]], [1, [19.10200065030763, 1.0]], [1, [0.60261078045047, 1.0]], [1, [1.9102043458252231, 1.0]], [1, [0.16942078971536717, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.52861075]
bas 1, expnt(s) = [7617.98462587]
bas 2, expnt(s) = [3617.67592334]
bas 3, expnt(s) = [1609.83176497]
bas 4, expnt(s) = [316.83824849]
bas 5, expnt(s) = [99.94817879]
bas 6, expnt(s) = [34.70683232]
bas 7, expnt(s) = [4.49261297]
bas 8, expnt(s) = [0.39346929]
bas 9, expnt(s) = [1362.77373626]
bas 10, expnt(s) = [664.93566404]
bas 11, expnt(s) = [301.97268935]
bas 12, expnt(s) = [314.9578959]
bas 13, expnt(s) = [74.16236001]
bas 14, expnt(s) = [6.03150981]
bas 15, expnt(s) = [19.10200065]
bas 16, expnt(s) = [0.60261078]
bas 17, expnt(s) = [1.91020435]
bas 18, expnt(s) = [0.16942079]
CPU time:       432.39
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825286e+04 5.20024391e+03 7.61798463e+03 2.06013221e+03
 3.61767592e+03 1.17852085e+03 1.60983176e+03 6.42096635e+02
 3.16838248e+02 1.89733154e+02 9.99481788e+01 7.98631044e+01
 3.47068323e+01 3.61265307e+01 4.49261297e+00 7.79631323e+00
 3.93469286e-01 1.25515729e+00 1.36277374e+03 2.41553918e+04
 6.64935664e+02 9.85051477e+03 3.01972689e+02 3.67234924e+03
 3.14957896e+02 3.87079363e+03 7.41623600e+01 6.34912415e+02
 6.03150981e+00 2.75750902e+01 1.91020007e+01 1.16501888e+02
 6.02610780e-01 1.54892544e+00 1.91020435e+00 6.55140094e+00
 1.69420790e-01 3.17097465e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.980091777325825
cond(S) = 116786.56392274152
E1 = -728.3918130120246  E_coul = 202.9821951888302
init E= -525.409617823194
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.561530579034225  LUMO = 0.694625499438137
  mo_energy =
[-1.18296718e+02 -1.21133783e+01 -9.45162888e+00 -9.45162888e+00
 -9.45162888e+00 -1.23099159e+00 -5.61530579e-01 -5.61530579e-01
 -5.61530579e-01  6.94625499e-01  6.94625499e-01  6.94625499e-01
  4.71446407e+00  4.71446407e+00  4.71446407e+00  2.55754478e+01
  2.55754478e+01  2.55754478e+01  7.11245147e+01  1.29394375e+02
  1.29394375e+02  1.29394375e+02  4.91451183e+02  5.08348769e+02
  5.08348769e+02  5.08348769e+02  1.37122719e+03  1.37122719e+03
  1.37122719e+03  2.42724932e+03  3.07028097e+03  3.07028097e+03
  3.07028097e+03  6.69132120e+03  6.69132120e+03  6.69132120e+03
  8.80189423e+03  2.51679448e+04  7.59291635e+04]
E1 = -727.3728461469728  E_coul = 201.03021391605662
cycle= 1 E= -526.342632230916  delta_E= -0.933  |g|= 0.216  |ddm|= 1.37
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.586801
diis-c [-0.34433591  1.        ]
  HOMO = -0.587711427686715  LUMO = 0.684438299478829
  mo_energy =
[-1.18628817e+02 -1.22376243e+01 -9.58697743e+00 -9.58697743e+00
 -9.58697743e+00 -1.26608427e+00 -5.87711428e-01 -5.87711428e-01
 -5.87711428e-01  6.84438299e-01  6.84438299e-01  6.84438299e-01
  4.65393086e+00  4.65393086e+00  4.65393086e+00  2.54363304e+01
  2.54363304e+01  2.54363304e+01  7.09235054e+01  1.29146590e+02
  1.29146590e+02  1.29146590e+02  4.91096240e+02  5.08019054e+02
  5.08019054e+02  5.08019054e+02  1.37083577e+03  1.37083577e+03
  1.37083577e+03  2.42672010e+03  3.06982136e+03  3.06982136e+03
  3.06982136e+03  6.69073844e+03  6.69073844e+03  6.69073844e+03
  8.80122853e+03  2.51671792e+04  7.59283032e+04]
E1 = -727.7877490907215  E_coul = 201.44449551917157
cycle= 2 E= -526.34325357155  delta_E= -0.000621  |g|= 0.0314  |ddm|= 0.0265
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.056756
diis-c [-0.00199501  0.05646941  0.94353059]
  HOMO = -0.582144742390665  LUMO = 0.687265797191052
  mo_energy =
[-1.18572550e+02 -1.22092840e+01 -9.55802886e+00 -9.55802886e+00
 -9.55802886e+00 -1.25874017e+00 -5.82144742e-01 -5.82144742e-01
 -5.82144742e-01  6.87265797e-01  6.87265797e-01  6.87265797e-01
  4.66633166e+00  4.66633166e+00  4.66633166e+00  2.54647338e+01
  2.54647338e+01  2.54647338e+01  7.09683524e+01  1.29193218e+02
  1.29193218e+02  1.29193218e+02  4.91153466e+02  5.08075028e+02
  5.08075028e+02  5.08075028e+02  1.37089520e+03  1.37089520e+03
  1.37089520e+03  2.42678217e+03  3.06988270e+03  3.06988270e+03
  3.06988270e+03  6.69080105e+03  6.69080105e+03  6.69080105e+03
  8.80129167e+03  2.51672426e+04  7.59283667e+04]
E1 = -727.6958279332449  E_coul = 201.35254857184552
cycle= 3 E= -526.343279361399  delta_E= -2.58e-05  |g|= 0.00401  |ddm|= 0.00748
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00791531
diis-c [-6.95915970e-07 -1.17800024e-03  1.15641088e-01  8.85536912e-01]
  HOMO = -0.583226209079665  LUMO = 0.68671467952336
  mo_energy =
[-1.18579741e+02 -1.22134115e+01 -9.56230296e+00 -9.56230296e+00
 -9.56230296e+00 -1.26011922e+00 -5.83226209e-01 -5.83226209e-01
 -5.83226209e-01  6.86714680e-01  6.86714680e-01  6.86714680e-01
  4.66417447e+00  4.66417447e+00  4.66417447e+00  2.54605556e+01
  2.54605556e+01  2.54605556e+01  7.09625455e+01  1.29187059e+02
  1.29187059e+02  1.29187059e+02  4.91146157e+02  5.08067883e+02
  5.08067883e+02  5.08067883e+02  1.37088763e+03  1.37088763e+03
  1.37088763e+03  2.42677413e+03  3.06987484e+03  3.06987484e+03
  3.06987484e+03  6.69079289e+03  6.69079289e+03  6.69079289e+03
  8.80128335e+03  2.51672341e+04  7.59283581e+04]
E1 = -727.7087099309844  E_coul = 201.36542993725425
cycle= 4 E= -526.34327999373  delta_E= -6.32e-07  |g|= 7.07e-05  |ddm|= 0.00106
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=9.85933e-05
diis-c [-3.62257202e-09 -1.26375235e-05  8.27866445e-05  1.08999247e-02
  9.89029926e-01]
  HOMO = -0.583186674618446  LUMO = 0.686734044341042
  mo_energy =
[-1.18579590e+02 -1.22132741e+01 -9.56216625e+00 -9.56216625e+00
 -9.56216625e+00 -1.26006700e+00 -5.83186675e-01 -5.83186675e-01
 -5.83186675e-01  6.86734044e-01  6.86734044e-01  6.86734044e-01
  4.66425135e+00  4.66425135e+00  4.66425135e+00  2.54606837e+01
  2.54606837e+01  2.54606837e+01  7.09626982e+01  1.29187207e+02
  1.29187207e+02  1.29187207e+02  4.91146305e+02  5.08068034e+02
  5.08068034e+02  5.08068034e+02  1.37088778e+03  1.37088778e+03
  1.37088778e+03  2.42677426e+03  3.06987498e+03  3.06987498e+03
  3.06987498e+03  6.69079303e+03  6.69079303e+03  6.69079303e+03
  8.80128348e+03  2.51672342e+04  7.59283583e+04]
E1 = -727.7083219850318  E_coul = 201.36504199083132
cycle= 5 E= -526.343279994201  delta_E= -4.7e-10  |g|= 1.06e-05  |ddm|= 4.47e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -727.7083219850318  E_coul = 201.36504199083132
  HOMO = -0.583192823341774  LUMO = 0.686730902854776
  mo_energy =
[-1.18579616e+02 -1.22132932e+01 -9.56218566e+00 -9.56218566e+00
 -9.56218566e+00 -1.26007477e+00 -5.83192823e-01 -5.83192823e-01
 -5.83192823e-01  6.86730903e-01  6.86730903e-01  6.86730903e-01
  4.66423995e+00  4.66423995e+00  4.66423995e+00  2.54606650e+01
  2.54606650e+01  2.54606650e+01  7.09626753e+01  1.29187183e+02
  1.29187183e+02  1.29187183e+02  4.91146279e+02  5.08068008e+02
  5.08068008e+02  5.08068008e+02  1.37088775e+03  1.37088775e+03
  1.37088775e+03  2.42677424e+03  3.06987496e+03  3.06987496e+03
  3.06987496e+03  6.69079300e+03  6.69079300e+03  6.69079300e+03
  8.80128345e+03  2.51672342e+04  7.59283582e+04]
E1 = -727.7083758054299  E_coul = 201.36509581122183
Extra cycle  E= -526.343279994208  delta_E= -7.5e-12  |g|= 2.79e-06  |ddm|= 4.73e-06
    CPU time for scf_cycle      0.67 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 116786.56392274152
E1 = -727.7083758054299  E_coul = 201.36509581122183
init E= -526.343279994208
    CPU time for initialize scf      2.71 sec, wall time      0.24 sec
  HOMO = -0.583191781589886  LUMO = 0.68673142520793
  mo_energy =
[-1.18579609e+02 -1.22132892e+01 -9.56218159e+00 -9.56218159e+00
 -9.56218159e+00 -1.26007342e+00 -5.83191782e-01 -5.83191782e-01
 -5.83191782e-01  6.86731425e-01  6.86731425e-01  6.86731425e-01
  4.66424203e+00  4.66424203e+00  4.66424203e+00  2.54606689e+01
  2.54606689e+01  2.54606689e+01  7.09626806e+01  1.29187189e+02
  1.29187189e+02  1.29187189e+02  4.91146286e+02  5.08068014e+02
  5.08068014e+02  5.08068014e+02  1.37088776e+03  1.37088776e+03
  1.37088776e+03  2.42677424e+03  3.06987496e+03  3.06987496e+03
  3.06987496e+03  6.69079301e+03  6.69079301e+03  6.69079301e+03
  8.80128346e+03  2.51672342e+04  7.59283582e+04]
E1 = -727.708363657192  E_coul = 201.3650836629842
cycle= 1 E= -526.343279994208  delta_E= 3.41e-13  |g|= 6.72e-07  |ddm|= 1.11e-06
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.708363657192  E_coul = 201.3650836629842
  HOMO = -0.583192014253483  LUMO = 0.686731307067026
  mo_energy =
[-1.18579611e+02 -1.22132901e+01 -9.56218250e+00 -9.56218250e+00
 -9.56218250e+00 -1.26007372e+00 -5.83192014e-01 -5.83192014e-01
 -5.83192014e-01  6.86731307e-01  6.86731307e-01  6.86731307e-01
  4.66424157e+00  4.66424157e+00  4.66424157e+00  2.54606680e+01
  2.54606680e+01  2.54606680e+01  7.09626794e+01  1.29187187e+02
  1.29187187e+02  1.29187187e+02  4.91146284e+02  5.08068013e+02
  5.08068013e+02  5.08068013e+02  1.37088776e+03  1.37088776e+03
  1.37088776e+03  2.42677424e+03  3.06987496e+03  3.06987496e+03
  3.06987496e+03  6.69079300e+03  6.69079300e+03  6.69079300e+03
  8.80128345e+03  2.51672342e+04  7.59283582e+04]
E1 = -727.7083663666526  E_coul = 201.36508637244322
Extra cycle  E= -526.343279994209  delta_E= -1.71e-12  |g|= 1.55e-07  |ddm|= 2.31e-07
    CPU time for scf_cycle      2.85 sec, wall time      0.38 sec
exp = [2.61825286e+04 7.61798463e+03 3.61767592e+03 1.60983176e+03
 3.16838248e+02 9.99481788e+01 3.47068323e+01 4.49261297e+00
 3.93469286e-01 1.36277374e+03 6.64935664e+02 3.01972689e+02
 3.14957896e+02 7.41623600e+01 6.03150981e+00 1.91020007e+01
 6.02610780e-01 1.91020435e+00 1.69420790e-01]
grad_E = [-1.88523281e-06  1.10381996e-05  1.25073018e-05  3.28317233e-04
 -3.56833469e-03  6.29227378e-03 -3.00104463e-03 -6.57339790e-02
 -3.84260451e-02  1.31529498e-06  2.72898588e-06  1.47587472e-05
  1.60644428e-05  5.27376537e-03  2.73220456e-02 -2.62031694e-02
  2.79658717e-03 -3.87518431e-02 -2.59470550e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:42:37 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5379107        1
[INPUT] 0    0    [1    /1   ]  7617.86537555        1
[INPUT] 0    0    [1    /1   ]  3617.41837675        1
[INPUT] 0    0    [1    /1   ]  1606.05514661        1
[INPUT] 0    0    [1    /1   ]  353.490291295        1
[INPUT] 0    0    [1    /1   ]  113.429860523        1
[INPUT] 0    0    [1    /1   ]  36.9518430373        1
[INPUT] 0    0    [1    /1   ]  4.58937279371        1
[INPUT] 0    0    [1    /1   ]  0.393225446896       1
[INPUT] 1    0    [1    /1   ]  1362.76534639        1
[INPUT] 1    0    [1    /1   ]  664.82837615         1
[INPUT] 1    0    [1    /1   ]  301.383067317        1
[INPUT] 1    0    [1    /1   ]  314.437898784        1
[INPUT] 1    0    [1    /1   ]  84.7929327401        1
[INPUT] 1    0    [1    /1   ]  7.33530167301        1
[INPUT] 1    0    [1    /1   ]  22.1946031363        1
[INPUT] 1    0    [1    /1   ]  0.799164443301       1
[INPUT] 1    0    [1    /1   ]  2.99252249647        1
[INPUT] 1    0    [1    /1   ]  0.226829626712       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.537910744275, 1.0]], [0, [7617.8653755491105, 1.0]], [0, [3617.418376747816, 1.0]], [0, [1606.0551466135767, 1.0]], [0, [353.4902912953695, 1.0]], [0, [113.42986052272187, 1.0]], [0, [36.951843037251855, 1.0]], [0, [4.58937279371117, 1.0]], [0, [0.3932254468961696, 1.0]], [1, [1362.7653463873414, 1.0]], [1, [664.8283761504443, 1.0]], [1, [301.3830673172864, 1.0]], [1, [314.43789878434046, 1.0]], [1, [84.79293274006395, 1.0]], [1, [7.335301673006413, 1.0]], [1, [22.194603136288045, 1.0]], [1, [0.7991644433007892, 1.0]], [1, [2.992522496467222, 1.0]], [1, [0.22682962671171042, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.53791074]
bas 1, expnt(s) = [7617.86537555]
bas 2, expnt(s) = [3617.41837675]
bas 3, expnt(s) = [1606.05514661]
bas 4, expnt(s) = [353.4902913]
bas 5, expnt(s) = [113.42986052]
bas 6, expnt(s) = [36.95184304]
bas 7, expnt(s) = [4.58937279]
bas 8, expnt(s) = [0.39322545]
bas 9, expnt(s) = [1362.76534639]
bas 10, expnt(s) = [664.82837615]
bas 11, expnt(s) = [301.38306732]
bas 12, expnt(s) = [314.43789878]
bas 13, expnt(s) = [84.79293274]
bas 14, expnt(s) = [7.33530167]
bas 15, expnt(s) = [22.19460314]
bas 16, expnt(s) = [0.79916444]
bas 17, expnt(s) = [2.9925225]
bas 18, expnt(s) = [0.22682963]
CPU time:       440.58
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825379e+04 5.20024530e+03 7.61786538e+03 2.06010803e+03
 3.61741838e+03 1.17845792e+03 1.60605515e+03 6.40966548e+02
 3.53490291e+02 2.05967236e+02 1.13429861e+02 8.78133555e+01
 3.69518430e+01 3.78653611e+01 4.58937279e+00 7.92191224e+00
 3.93225447e-01 1.25457386e+00 1.36276535e+03 2.41552059e+04
 6.64828376e+02 9.84852807e+03 3.01383067e+02 3.66338829e+03
 3.14437899e+02 3.86280691e+03 8.47929327e+01 7.50643906e+02
 7.33530167e+00 3.52173657e+01 2.21946031e+01 1.40537953e+02
 7.99164443e-01 2.20434509e+00 2.99252250e+00 1.14823604e+01
 2.26829627e-01 4.56676974e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.975804691992565
cond(S) = 140448.377654465
E1 = -728.6797807960442  E_coul = 203.08562548472898
init E= -525.594155311315
    CPU time for initialize scf      0.46 sec, wall time      0.06 sec
  HOMO = -0.560163993908853  LUMO = 1.06820967348437
  mo_energy =
[-1.18300452e+02 -1.21045316e+01 -9.44599386e+00 -9.44599386e+00
 -9.44599386e+00 -1.23100361e+00 -5.60163994e-01 -5.60163994e-01
 -5.60163994e-01  1.06820967e+00  1.06820967e+00  1.06820967e+00
  7.78660281e+00  7.78660281e+00  7.78660281e+00  3.55145968e+01
  3.55145968e+01  3.55145968e+01  8.12570594e+01  1.55639514e+02
  1.55639514e+02  1.55639514e+02  5.52390332e+02  5.52390332e+02
  5.52390332e+02  5.59876851e+02  1.42097064e+03  1.42097064e+03
  1.42097064e+03  2.58415665e+03  3.11962977e+03  3.11962977e+03
  3.11962977e+03  6.73703890e+03  6.73703890e+03  6.73703890e+03
  8.97977922e+03  2.53420345e+04  7.60921444e+04]
E1 = -727.909011812307  E_coul = 201.514905393292
cycle= 1 E= -526.394106419015  delta_E= -0.8  |g|= 0.194  |ddm|= 0.526
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.570184
diis-c [-0.32510976  1.        ]
  HOMO = -0.576739916116431  LUMO = 1.05748173974679
  mo_energy =
[-1.18588847e+02 -1.22052592e+01 -9.55348795e+00 -9.55348795e+00
 -9.55348795e+00 -1.25506744e+00 -5.76739916e-01 -5.76739916e-01
 -5.76739916e-01  1.05748174e+00  1.05748174e+00  1.05748174e+00
  7.72680981e+00  7.72680981e+00  7.72680981e+00  3.53921204e+01
  3.53921204e+01  3.53921204e+01  8.10785373e+01  1.55423807e+02
  1.55423807e+02  1.55423807e+02  5.52103773e+02  5.52103773e+02
  5.52103773e+02  5.59556164e+02  1.42062805e+03  1.42062805e+03
  1.42062805e+03  2.58368096e+03  3.11922263e+03  3.11922263e+03
  3.11922263e+03  6.73651554e+03  6.73651554e+03  6.73651554e+03
  8.97917788e+03  2.53413370e+04  7.60913550e+04]
E1 = -728.2255301824854  E_coul = 201.8309998950949
cycle= 2 E= -526.39453028739  delta_E= -0.000424  |g|= 0.0257  |ddm|= 0.0217
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0494117
diis-c [-0.00154749  0.04993986  0.95006014]
  HOMO = -0.572837146463197  LUMO = 1.06063862223428
  mo_energy =
[-1.18543562e+02 -1.21835752e+01 -9.53137712e+00 -9.53137712e+00
 -9.53137712e+00 -1.24988855e+00 -5.72837146e-01 -5.72837146e-01
 -5.72837146e-01  1.06063862e+00  1.06063862e+00  1.06063862e+00
  7.73897967e+00  7.73897967e+00  7.73897967e+00  3.54159161e+01
  3.54159161e+01  3.54159161e+01  8.11153729e+01  1.55461709e+02
  1.55461709e+02  1.55461709e+02  5.52148809e+02  5.52148809e+02
  5.52148809e+02  5.59602879e+02  1.42067597e+03  1.42067597e+03
  1.42067597e+03  2.58373128e+03  3.11927222e+03  3.11927222e+03
  3.11927222e+03  6.73656625e+03  6.73656625e+03  6.73656625e+03
  8.97922906e+03  2.53413884e+04  7.60914064e+04]
E1 = -728.1598021902444  E_coul = 201.76525706106105
cycle= 3 E= -526.394545129183  delta_E= -1.48e-05  |g|= 0.0031  |ddm|= 0.00562
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00657248
diis-c [-3.54216998e-07 -1.01273657e-03  1.11077005e-01  8.89935731e-01]
  HOMO = -0.573564952863858  LUMO = 1.06006958729271
  mo_energy =
[-1.18549109e+02 -1.21866289e+01 -9.53453413e+00 -9.53453413e+00
 -9.53453413e+00 -1.25083147e+00 -5.73564953e-01 -5.73564953e-01
 -5.73564953e-01  1.06006959e+00  1.06006959e+00  1.06006959e+00
  7.73702824e+00  7.73702824e+00  7.73702824e+00  3.54126111e+01
  3.54126111e+01  3.54126111e+01  8.11108289e+01  1.55456935e+02
  1.55456935e+02  1.55456935e+02  5.52143298e+02  5.52143298e+02
  5.52143298e+02  5.59597165e+02  1.42067012e+03  1.42067012e+03
  1.42067012e+03  2.58372503e+03  3.11926613e+03  3.11926613e+03
  3.11926613e+03  6.73655991e+03  6.73655991e+03  6.73655991e+03
  8.97922259e+03  2.53413818e+04  7.60913997e+04]
E1 = -728.1688121362876  E_coul = 201.77426667418663
cycle= 4 E= -526.394545462101  delta_E= -3.33e-07  |g|= 5.38e-05  |ddm|= 0.000834
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.57436e-05
diis-c [-2.13348290e-09 -5.85255373e-06 -1.93415626e-04  7.91764038e-03
  9.92281628e-01]
  HOMO = -0.573532266622206  LUMO = 1.06009453933409
  mo_energy =
[-1.18548989e+02 -1.21865219e+01 -9.53442762e+00 -9.53442762e+00
 -9.53442762e+00 -1.25078908e+00 -5.73532267e-01 -5.73532267e-01
 -5.73532267e-01  1.06009454e+00  1.06009454e+00  1.06009454e+00
  7.73710516e+00  7.73710516e+00  7.73710516e+00  3.54127153e+01
  3.54127153e+01  3.54127153e+01  8.11109495e+01  1.55457053e+02
  1.55457053e+02  1.55457053e+02  5.52143418e+02  5.52143418e+02
  5.52143418e+02  5.59597282e+02  1.42067024e+03  1.42067024e+03
  1.42067024e+03  2.58372514e+03  3.11926624e+03  3.11926624e+03
  3.11926624e+03  6.73656002e+03  6.73656002e+03  6.73656002e+03
  8.97922269e+03  2.53413819e+04  7.60913998e+04]
E1 = -728.1685493385576  E_coul = 201.77400387622666
cycle= 5 E= -526.394545462331  delta_E= -2.3e-10  |g|= 7.58e-06  |ddm|= 2.98e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.1685493385576  E_coul = 201.77400387622666
  HOMO = -0.573536201043475  LUMO = 1.06009152614572
  mo_energy =
[-1.18549008e+02 -1.21865356e+01 -9.53444151e+00 -9.53444151e+00
 -9.53444151e+00 -1.25079417e+00 -5.73536201e-01 -5.73536201e-01
 -5.73536201e-01  1.06009153e+00  1.06009153e+00  1.06009153e+00
  7.73709559e+00  7.73709559e+00  7.73709559e+00  3.54127014e+01
  3.54127014e+01  3.54127014e+01  8.11109326e+01  1.55457035e+02
  1.55457035e+02  1.55457035e+02  5.52143399e+02  5.52143399e+02
  5.52143399e+02  5.59597263e+02  1.42067022e+03  1.42067022e+03
  1.42067022e+03  2.58372512e+03  3.11926622e+03  3.11926622e+03
  3.11926622e+03  6.73656000e+03  6.73656000e+03  6.73656000e+03
  8.97922267e+03  2.53413819e+04  7.60913998e+04]
E1 = -728.1685859141096  E_coul = 201.77404045177386
Extra cycle  E= -526.394545462336  delta_E= -4.77e-12  |g|= 1.95e-06  |ddm|= 3.86e-06
    CPU time for scf_cycle      0.68 sec, wall time      0.27 sec
exp = [2.61825379e+04 7.61786538e+03 3.61741838e+03 1.60605515e+03
 3.53490291e+02 1.13429861e+02 3.69518430e+01 4.58937279e+00
 3.93225447e-01 1.36276535e+03 6.64828376e+02 3.01383067e+02
 3.14437899e+02 8.47929327e+01 7.33530167e+00 2.21946031e+01
 7.99164443e-01 2.99252250e+00 2.26829627e-01]
E = -526.3945454623357
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:42:37 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5379107        1
[INPUT] 0    0    [1    /1   ]  7617.86537555        1
[INPUT] 0    0    [1    /1   ]  3617.41837675        1
[INPUT] 0    0    [1    /1   ]  1606.05514661        1
[INPUT] 0    0    [1    /1   ]  353.490291295        1
[INPUT] 0    0    [1    /1   ]  113.429860523        1
[INPUT] 0    0    [1    /1   ]  36.9518430373        1
[INPUT] 0    0    [1    /1   ]  4.58937279371        1
[INPUT] 0    0    [1    /1   ]  0.393225446896       1
[INPUT] 1    0    [1    /1   ]  1362.76534639        1
[INPUT] 1    0    [1    /1   ]  664.82837615         1
[INPUT] 1    0    [1    /1   ]  301.383067317        1
[INPUT] 1    0    [1    /1   ]  314.437898784        1
[INPUT] 1    0    [1    /1   ]  84.7929327401        1
[INPUT] 1    0    [1    /1   ]  7.33530167301        1
[INPUT] 1    0    [1    /1   ]  22.1946031363        1
[INPUT] 1    0    [1    /1   ]  0.799164443301       1
[INPUT] 1    0    [1    /1   ]  2.99252249647        1
[INPUT] 1    0    [1    /1   ]  0.226829626712       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.537910744275, 1.0]], [0, [7617.8653755491105, 1.0]], [0, [3617.418376747816, 1.0]], [0, [1606.0551466135767, 1.0]], [0, [353.4902912953695, 1.0]], [0, [113.42986052272187, 1.0]], [0, [36.951843037251855, 1.0]], [0, [4.58937279371117, 1.0]], [0, [0.3932254468961696, 1.0]], [1, [1362.7653463873414, 1.0]], [1, [664.8283761504443, 1.0]], [1, [301.3830673172864, 1.0]], [1, [314.43789878434046, 1.0]], [1, [84.79293274006395, 1.0]], [1, [7.335301673006413, 1.0]], [1, [22.194603136288045, 1.0]], [1, [0.7991644433007892, 1.0]], [1, [2.992522496467222, 1.0]], [1, [0.22682962671171042, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.53791074]
bas 1, expnt(s) = [7617.86537555]
bas 2, expnt(s) = [3617.41837675]
bas 3, expnt(s) = [1606.05514661]
bas 4, expnt(s) = [353.4902913]
bas 5, expnt(s) = [113.42986052]
bas 6, expnt(s) = [36.95184304]
bas 7, expnt(s) = [4.58937279]
bas 8, expnt(s) = [0.39322545]
bas 9, expnt(s) = [1362.76534639]
bas 10, expnt(s) = [664.82837615]
bas 11, expnt(s) = [301.38306732]
bas 12, expnt(s) = [314.43789878]
bas 13, expnt(s) = [84.79293274]
bas 14, expnt(s) = [7.33530167]
bas 15, expnt(s) = [22.19460314]
bas 16, expnt(s) = [0.79916444]
bas 17, expnt(s) = [2.9925225]
bas 18, expnt(s) = [0.22682963]
CPU time:       441.41
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825379e+04 5.20024530e+03 7.61786538e+03 2.06010803e+03
 3.61741838e+03 1.17845792e+03 1.60605515e+03 6.40966548e+02
 3.53490291e+02 2.05967236e+02 1.13429861e+02 8.78133555e+01
 3.69518430e+01 3.78653611e+01 4.58937279e+00 7.92191224e+00
 3.93225447e-01 1.25457386e+00 1.36276535e+03 2.41552059e+04
 6.64828376e+02 9.84852807e+03 3.01383067e+02 3.66338829e+03
 3.14437899e+02 3.86280691e+03 8.47929327e+01 7.50643906e+02
 7.33530167e+00 3.52173657e+01 2.21946031e+01 1.40537953e+02
 7.99164443e-01 2.20434509e+00 2.99252250e+00 1.14823604e+01
 2.26829627e-01 4.56676974e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.975804691992565
cond(S) = 140448.377654465
E1 = -728.6797807960442  E_coul = 203.08562548472898
init E= -525.594155311315
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.560163993908853  LUMO = 1.06820967348437
  mo_energy =
[-1.18300452e+02 -1.21045316e+01 -9.44599386e+00 -9.44599386e+00
 -9.44599386e+00 -1.23100361e+00 -5.60163994e-01 -5.60163994e-01
 -5.60163994e-01  1.06820967e+00  1.06820967e+00  1.06820967e+00
  7.78660281e+00  7.78660281e+00  7.78660281e+00  3.55145968e+01
  3.55145968e+01  3.55145968e+01  8.12570594e+01  1.55639514e+02
  1.55639514e+02  1.55639514e+02  5.52390332e+02  5.52390332e+02
  5.52390332e+02  5.59876851e+02  1.42097064e+03  1.42097064e+03
  1.42097064e+03  2.58415665e+03  3.11962977e+03  3.11962977e+03
  3.11962977e+03  6.73703890e+03  6.73703890e+03  6.73703890e+03
  8.97977922e+03  2.53420345e+04  7.60921444e+04]
E1 = -727.909011812307  E_coul = 201.514905393292
cycle= 1 E= -526.394106419015  delta_E= -0.8  |g|= 0.194  |ddm|= 0.526
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.570184
diis-c [-0.32510976  1.        ]
  HOMO = -0.576739916116431  LUMO = 1.05748173974679
  mo_energy =
[-1.18588847e+02 -1.22052592e+01 -9.55348795e+00 -9.55348795e+00
 -9.55348795e+00 -1.25506744e+00 -5.76739916e-01 -5.76739916e-01
 -5.76739916e-01  1.05748174e+00  1.05748174e+00  1.05748174e+00
  7.72680981e+00  7.72680981e+00  7.72680981e+00  3.53921204e+01
  3.53921204e+01  3.53921204e+01  8.10785373e+01  1.55423807e+02
  1.55423807e+02  1.55423807e+02  5.52103773e+02  5.52103773e+02
  5.52103773e+02  5.59556164e+02  1.42062805e+03  1.42062805e+03
  1.42062805e+03  2.58368096e+03  3.11922263e+03  3.11922263e+03
  3.11922263e+03  6.73651554e+03  6.73651554e+03  6.73651554e+03
  8.97917788e+03  2.53413370e+04  7.60913550e+04]
E1 = -728.2255301824854  E_coul = 201.8309998950949
cycle= 2 E= -526.39453028739  delta_E= -0.000424  |g|= 0.0257  |ddm|= 0.0217
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0494117
diis-c [-0.00154749  0.04993986  0.95006014]
  HOMO = -0.572837146463197  LUMO = 1.06063862223428
  mo_energy =
[-1.18543562e+02 -1.21835752e+01 -9.53137712e+00 -9.53137712e+00
 -9.53137712e+00 -1.24988855e+00 -5.72837146e-01 -5.72837146e-01
 -5.72837146e-01  1.06063862e+00  1.06063862e+00  1.06063862e+00
  7.73897967e+00  7.73897967e+00  7.73897967e+00  3.54159161e+01
  3.54159161e+01  3.54159161e+01  8.11153729e+01  1.55461709e+02
  1.55461709e+02  1.55461709e+02  5.52148809e+02  5.52148809e+02
  5.52148809e+02  5.59602879e+02  1.42067597e+03  1.42067597e+03
  1.42067597e+03  2.58373128e+03  3.11927222e+03  3.11927222e+03
  3.11927222e+03  6.73656625e+03  6.73656625e+03  6.73656625e+03
  8.97922906e+03  2.53413884e+04  7.60914064e+04]
E1 = -728.1598021902444  E_coul = 201.76525706106105
cycle= 3 E= -526.394545129183  delta_E= -1.48e-05  |g|= 0.0031  |ddm|= 0.00562
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00657248
diis-c [-3.54216998e-07 -1.01273657e-03  1.11077005e-01  8.89935731e-01]
  HOMO = -0.573564952863858  LUMO = 1.06006958729271
  mo_energy =
[-1.18549109e+02 -1.21866289e+01 -9.53453413e+00 -9.53453413e+00
 -9.53453413e+00 -1.25083147e+00 -5.73564953e-01 -5.73564953e-01
 -5.73564953e-01  1.06006959e+00  1.06006959e+00  1.06006959e+00
  7.73702824e+00  7.73702824e+00  7.73702824e+00  3.54126111e+01
  3.54126111e+01  3.54126111e+01  8.11108289e+01  1.55456935e+02
  1.55456935e+02  1.55456935e+02  5.52143298e+02  5.52143298e+02
  5.52143298e+02  5.59597165e+02  1.42067012e+03  1.42067012e+03
  1.42067012e+03  2.58372503e+03  3.11926613e+03  3.11926613e+03
  3.11926613e+03  6.73655991e+03  6.73655991e+03  6.73655991e+03
  8.97922259e+03  2.53413818e+04  7.60913997e+04]
E1 = -728.1688121362876  E_coul = 201.77426667418663
cycle= 4 E= -526.394545462101  delta_E= -3.33e-07  |g|= 5.38e-05  |ddm|= 0.000834
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.57436e-05
diis-c [-2.13348290e-09 -5.85255373e-06 -1.93415626e-04  7.91764038e-03
  9.92281628e-01]
  HOMO = -0.573532266622206  LUMO = 1.06009453933409
  mo_energy =
[-1.18548989e+02 -1.21865219e+01 -9.53442762e+00 -9.53442762e+00
 -9.53442762e+00 -1.25078908e+00 -5.73532267e-01 -5.73532267e-01
 -5.73532267e-01  1.06009454e+00  1.06009454e+00  1.06009454e+00
  7.73710516e+00  7.73710516e+00  7.73710516e+00  3.54127153e+01
  3.54127153e+01  3.54127153e+01  8.11109495e+01  1.55457053e+02
  1.55457053e+02  1.55457053e+02  5.52143418e+02  5.52143418e+02
  5.52143418e+02  5.59597282e+02  1.42067024e+03  1.42067024e+03
  1.42067024e+03  2.58372514e+03  3.11926624e+03  3.11926624e+03
  3.11926624e+03  6.73656002e+03  6.73656002e+03  6.73656002e+03
  8.97922269e+03  2.53413819e+04  7.60913998e+04]
E1 = -728.1685493385576  E_coul = 201.77400387622666
cycle= 5 E= -526.394545462331  delta_E= -2.3e-10  |g|= 7.58e-06  |ddm|= 2.98e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.1685493385576  E_coul = 201.77400387622666
  HOMO = -0.573536201043475  LUMO = 1.06009152614572
  mo_energy =
[-1.18549008e+02 -1.21865356e+01 -9.53444151e+00 -9.53444151e+00
 -9.53444151e+00 -1.25079417e+00 -5.73536201e-01 -5.73536201e-01
 -5.73536201e-01  1.06009153e+00  1.06009153e+00  1.06009153e+00
  7.73709559e+00  7.73709559e+00  7.73709559e+00  3.54127014e+01
  3.54127014e+01  3.54127014e+01  8.11109326e+01  1.55457035e+02
  1.55457035e+02  1.55457035e+02  5.52143399e+02  5.52143399e+02
  5.52143399e+02  5.59597263e+02  1.42067022e+03  1.42067022e+03
  1.42067022e+03  2.58372512e+03  3.11926622e+03  3.11926622e+03
  3.11926622e+03  6.73656000e+03  6.73656000e+03  6.73656000e+03
  8.97922267e+03  2.53413819e+04  7.60913998e+04]
E1 = -728.1685859141096  E_coul = 201.77404045177386
Extra cycle  E= -526.394545462336  delta_E= -4.77e-12  |g|= 1.95e-06  |ddm|= 3.86e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 140448.377654465
E1 = -728.1685859141096  E_coul = 201.77404045177386
init E= -526.394545462336
    CPU time for initialize scf      2.71 sec, wall time      0.24 sec
  HOMO = -0.573535507843519  LUMO = 1.06009206385857
  mo_energy =
[-1.18549004e+02 -1.21865329e+01 -9.53443876e+00 -9.53443876e+00
 -9.53443876e+00 -1.25079327e+00 -5.73535508e-01 -5.73535508e-01
 -5.73535508e-01  1.06009206e+00  1.06009206e+00  1.06009206e+00
  7.73709738e+00  7.73709738e+00  7.73709738e+00  3.54127042e+01
  3.54127042e+01  3.54127042e+01  8.11109363e+01  1.55457039e+02
  1.55457039e+02  1.55457039e+02  5.52143403e+02  5.52143403e+02
  5.52143403e+02  5.59597267e+02  1.42067022e+03  1.42067022e+03
  1.42067022e+03  2.58372512e+03  3.11926623e+03  3.11926623e+03
  3.11926623e+03  6.73656000e+03  6.73656000e+03  6.73656000e+03
  8.97922268e+03  2.53413819e+04  7.60913998e+04]
E1 = -728.1685783651639  E_coul = 201.77403290282973
cycle= 1 E= -526.394545462334  delta_E= 1.59e-12  |g|= 4.35e-07  |ddm|= 7.38e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.1685783651639  E_coul = 201.77403290282973
  HOMO = -0.573535643092966  LUMO = 1.06009195845141
  mo_energy =
[-1.18549005e+02 -1.21865334e+01 -9.53443932e+00 -9.53443932e+00
 -9.53443932e+00 -1.25079344e+00 -5.73535643e-01 -5.73535643e-01
 -5.73535643e-01  1.06009196e+00  1.06009196e+00  1.06009196e+00
  7.73709702e+00  7.73709702e+00  7.73709702e+00  3.54127036e+01
  3.54127036e+01  3.54127036e+01  8.11109355e+01  1.55457038e+02
  1.55457038e+02  1.55457038e+02  5.52143402e+02  5.52143402e+02
  5.52143402e+02  5.59597266e+02  1.42067022e+03  1.42067022e+03
  1.42067022e+03  2.58372512e+03  3.11926623e+03  3.11926623e+03
  3.11926623e+03  6.73656000e+03  6.73656000e+03  6.73656000e+03
  8.97922268e+03  2.53413819e+04  7.60913998e+04]
E1 = -728.1685799444322  E_coul = 201.7740344820963
Extra cycle  E= -526.394545462336  delta_E= -1.71e-12  |g|= 9.39e-08  |ddm|= 1.51e-07
    CPU time for scf_cycle      2.85 sec, wall time      0.39 sec
exp = [2.61825379e+04 7.61786538e+03 3.61741838e+03 1.60605515e+03
 3.53490291e+02 1.13429861e+02 3.69518430e+01 4.58937279e+00
 3.93225447e-01 1.36276535e+03 6.64828376e+02 3.01383067e+02
 3.14437899e+02 8.47929327e+01 7.33530167e+00 2.21946031e+01
 7.99164443e-01 2.99252250e+00 2.26829627e-01]
grad_E = [-1.77243241e-06  7.47143859e-06  4.43326262e-06  2.11257983e-04
 -2.27241851e-03  6.69508306e-03 -6.21665190e-03  1.08780681e-03
 -2.94482983e-02  1.40829025e-06  3.19849949e-06  2.09926284e-05
  2.10746856e-05  2.48715676e-03 -3.35726565e-02 -5.87469652e-03
  3.53182657e-02  4.53738238e-02 -9.30453566e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:42:41 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5390299        1
[INPUT] 0    0    [1    /1   ]  7617.85117725        1
[INPUT] 0    0    [1    /1   ]  3617.38786147        1
[INPUT] 0    0    [1    /1   ]  1605.60594275        1
[INPUT] 0    0    [1    /1   ]  357.739921763        1
[INPUT] 0    0    [1    /1   ]  115.434210569        1
[INPUT] 0    0    [1    /1   ]  37.8666352047        1
[INPUT] 0    0    [1    /1   ]  4.60556693239        1
[INPUT] 0    0    [1    /1   ]  0.397208448831       1
[INPUT] 1    0    [1    /1   ]  1362.76440517        1
[INPUT] 1    0    [1    /1   ]  664.816022378        1
[INPUT] 1    0    [1    /1   ]  301.31541764         1
[INPUT] 1    0    [1    /1   ]  314.378230218        1
[INPUT] 1    0    [1    /1   ]  85.8219057065        1
[INPUT] 1    0    [1    /1   ]  7.71028625483        1
[INPUT] 1    0    [1    /1   ]  23.1833377064        1
[INPUT] 1    0    [1    /1   ]  0.795625160482       1
[INPUT] 1    0    [1    /1   ]  2.90934971732        1
[INPUT] 1    0    [1    /1   ]  0.230781543918       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.53902994071, 1.0]], [0, [7617.851177253019, 1.0]], [0, [3617.3878614651926, 1.0]], [0, [1605.6059427544938, 1.0]], [0, [357.7399217626523, 1.0]], [0, [115.43421056862176, 1.0]], [0, [37.866635204705275, 1.0]], [0, [4.605566932391037, 1.0]], [0, [0.3972084488306775, 1.0]], [1, [1362.764405174774, 1.0]], [1, [664.8160223777841, 1.0]], [1, [301.31541763987883, 1.0]], [1, [314.3782302180826, 1.0]], [1, [85.82190570647377, 1.0]], [1, [7.710286254825535, 1.0]], [1, [23.183337706407585, 1.0]], [1, [0.7956251604820679, 1.0]], [1, [2.909349717322638, 1.0]], [1, [0.23078154391792388, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.53902994]
bas 1, expnt(s) = [7617.85117725]
bas 2, expnt(s) = [3617.38786147]
bas 3, expnt(s) = [1605.60594275]
bas 4, expnt(s) = [357.73992176]
bas 5, expnt(s) = [115.43421057]
bas 6, expnt(s) = [37.8666352]
bas 7, expnt(s) = [4.60556693]
bas 8, expnt(s) = [0.39720845]
bas 9, expnt(s) = [1362.76440517]
bas 10, expnt(s) = [664.81602238]
bas 11, expnt(s) = [301.31541764]
bas 12, expnt(s) = [314.37823022]
bas 13, expnt(s) = [85.82190571]
bas 14, expnt(s) = [7.71028625]
bas 15, expnt(s) = [23.18333771]
bas 16, expnt(s) = [0.79562516]
bas 17, expnt(s) = [2.90934972]
bas 18, expnt(s) = [0.23078154]
CPU time:       449.55
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825390e+04 5.20024547e+03 7.61785118e+03 2.06010515e+03
 3.61738786e+03 1.17845046e+03 1.60560594e+03 6.40832087e+02
 3.57739922e+02 2.07821550e+02 1.15434211e+02 8.89745760e+01
 3.78666352e+01 3.85662632e+01 4.60556693e+00 7.94286805e+00
 3.97208449e-01 1.26409258e+00 1.36276441e+03 2.41551851e+04
 6.64816022e+02 9.84829932e+03 3.01315418e+02 3.66236045e+03
 3.14378230e+02 3.86189066e+03 8.58219057e+01 7.62047574e+02
 7.71028625e+00 3.74819796e+01 2.31833377e+01 1.48406986e+02
 7.95625160e-01 2.19214879e+00 2.90934972e+00 1.10848368e+01
 2.30781544e-01 4.66644053e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97489420951918
cond(S) = 144164.84062501887
E1 = -728.8224945751011  E_coul = 203.17343990874397
init E= -525.649054666357
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558049613795015  LUMO = 1.08003364486497
  mo_energy =
[-1.18290249e+02 -1.21008808e+01 -9.44104355e+00 -9.44104355e+00
 -9.44104355e+00 -1.22960048e+00 -5.58049614e-01 -5.58049614e-01
 -5.58049614e-01  1.08003364e+00  1.08003364e+00  1.08003364e+00
  7.75852361e+00  7.75852361e+00  7.75852361e+00  3.68295225e+01
  3.68295225e+01  3.68295225e+01  8.39760243e+01  1.60321018e+02
  1.60321018e+02  1.60321018e+02  5.59106380e+02  5.59106380e+02
  5.59106380e+02  5.71314399e+02  1.42819901e+03  1.42819901e+03
  1.42819901e+03  2.60612403e+03  3.12672104e+03  3.12672104e+03
  3.12672104e+03  6.74359853e+03  6.74359853e+03  6.74359853e+03
  9.00423361e+03  2.53659718e+04  7.61145798e+04]
E1 = -728.1116535391313  E_coul = 201.7025777156389
cycle= 1 E= -526.409075823492  delta_E= -0.76  |g|= 0.186  |ddm|= 0.775
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.549394
diis-c [-0.30183388  1.        ]
  HOMO = -0.571477195669412  LUMO = 1.07183410495923
  mo_energy =
[-1.18564265e+02 -1.21971979e+01 -9.54234660e+00 -9.54234660e+00
 -9.54234660e+00 -1.25052934e+00 -5.71477196e-01 -5.71477196e-01
 -5.71477196e-01  1.07183410e+00  1.07183410e+00  1.07183410e+00
  7.70338597e+00  7.70338597e+00  7.70338597e+00  3.67110881e+01
  3.67110881e+01  3.67110881e+01  8.38045371e+01  1.60115879e+02
  1.60115879e+02  1.60115879e+02  5.58835094e+02  5.58835094e+02
  5.58835094e+02  5.71009286e+02  1.42787449e+03  1.42787449e+03
  1.42787449e+03  2.60566932e+03  3.12633360e+03  3.12633360e+03
  3.12633360e+03  6.74309744e+03  6.74309744e+03  6.74309744e+03
  9.00365607e+03  2.53652995e+04  7.61138165e+04]
E1 = -728.3974211943807  E_coul = 201.9879910058398
cycle= 2 E= -526.409430188541  delta_E= -0.000354  |g|= 0.0234  |ddm|= 0.0191
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0452226
diis-c [-0.00138626  0.04473286  0.95526714]
  HOMO = -0.56798130677532  LUMO = 1.07466391185506
  mo_energy =
[-1.18522719e+02 -1.21775682e+01 -9.52233881e+00 -9.52233881e+00
 -9.52233881e+00 -1.24586466e+00 -5.67981307e-01 -5.67981307e-01
 -5.67981307e-01  1.07466391e+00  1.07466391e+00  1.07466391e+00
  7.71440277e+00  7.71440277e+00  7.71440277e+00  3.67332023e+01
  3.67332023e+01  3.67332023e+01  8.38384365e+01  1.60150666e+02
  1.60150666e+02  1.60150666e+02  5.58876399e+02  5.58876399e+02
  5.58876399e+02  5.71052259e+02  1.42791851e+03  1.42791851e+03
  1.42791851e+03  2.60571562e+03  3.12637920e+03  3.12637920e+03
  3.12637920e+03  6.74314410e+03  6.74314410e+03  6.74314410e+03
  9.00370318e+03  2.53653468e+04  7.61138638e+04]
E1 = -728.3383173559221  E_coul = 201.92887504443883
cycle= 3 E= -526.409442311483  delta_E= -1.21e-05  |g|= 0.00294  |ddm|= 0.00498
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00616994
diis-c [-2.69583748e-07 -9.58548570e-04  1.14201283e-01  8.86757266e-01]
  HOMO = -0.568637937564614  LUMO = 1.07415015634259
  mo_energy =
[-1.18527943e+02 -1.21804086e+01 -9.52527090e+00 -9.52527090e+00
 -9.52527090e+00 -1.24672221e+00 -5.68637938e-01 -5.68637938e-01
 -5.68637938e-01  1.07415016e+00  1.07415016e+00  1.07415016e+00
  7.71260653e+00  7.71260653e+00  7.71260653e+00  3.67300682e+01
  3.67300682e+01  3.67300682e+01  8.38341364e+01  1.60146169e+02
  1.60146169e+02  1.60146169e+02  5.58871212e+02  5.58871212e+02
  5.58871212e+02  5.71046872e+02  1.42791300e+03  1.42791300e+03
  1.42791300e+03  2.60570974e+03  3.12637347e+03  3.12637347e+03
  3.12637347e+03  6.74313814e+03  6.74313814e+03  6.74313814e+03
  9.00369709e+03  2.53653406e+04  7.61138576e+04]
E1 = -728.346566143813  E_coul = 201.93712354818365
cycle= 4 E= -526.409442595629  delta_E= -2.84e-07  |g|= 4.74e-05  |ddm|= 0.000758
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=6.75385e-05
diis-c [-1.61421194e-09 -6.11541359e-06  1.41915599e-04  1.00479564e-02
  9.89816243e-01]
  HOMO = -0.568609152541781  LUMO = 1.07417211304765
  mo_energy =
[-1.18527837e+02 -1.21803149e+01 -9.52517754e+00 -9.52517754e+00
 -9.52517754e+00 -1.24668479e+00 -5.68609153e-01 -5.68609153e-01
 -5.68609153e-01  1.07417211e+00  1.07417211e+00  1.07417211e+00
  7.71267408e+00  7.71267408e+00  7.71267408e+00  3.67301604e+01
  3.67301604e+01  3.67301604e+01  8.38342427e+01  1.60146273e+02
  1.60146273e+02  1.60146273e+02  5.58871317e+02  5.58871317e+02
  5.58871317e+02  5.71046975e+02  1.42791310e+03  1.42791310e+03
  1.42791310e+03  2.60570983e+03  3.12637357e+03  3.12637357e+03
  3.12637357e+03  6.74313823e+03  6.74313823e+03  6.74313823e+03
  9.00369719e+03  2.53653407e+04  7.61138577e+04]
E1 = -728.3463413837271  E_coul = 201.9368987879248
cycle= 5 E= -526.409442595802  delta_E= -1.73e-10  |g|= 6.33e-06  |ddm|= 2.52e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3463413837271  E_coul = 201.9368987879248
  HOMO = -0.568612361773964  LUMO = 1.07416965900779
  mo_energy =
[-1.18527853e+02 -1.21803262e+01 -9.52518904e+00 -9.52518904e+00
 -9.52518904e+00 -1.24668896e+00 -5.68612362e-01 -5.68612362e-01
 -5.68612362e-01  1.07416966e+00  1.07416966e+00  1.07416966e+00
  7.71266621e+00  7.71266621e+00  7.71266621e+00  3.67301488e+01
  3.67301488e+01  3.67301488e+01  8.38342286e+01  1.60146258e+02
  1.60146258e+02  1.60146258e+02  5.58871301e+02  5.58871301e+02
  5.58871301e+02  5.71046959e+02  1.42791308e+03  1.42791308e+03
  1.42791308e+03  2.60570982e+03  3.12637355e+03  3.12637355e+03
  3.12637355e+03  6.74313822e+03  6.74313822e+03  6.74313822e+03
  9.00369717e+03  2.53653407e+04  7.61138576e+04]
E1 = -728.3463710132335  E_coul = 201.93692841743098
Extra cycle  E= -526.409442595802  delta_E= -1.14e-13  |g|= 1.6e-06  |ddm|= 3.13e-06
    CPU time for scf_cycle      0.67 sec, wall time      0.28 sec
exp = [2.61825390e+04 7.61785118e+03 3.61738786e+03 1.60560594e+03
 3.57739922e+02 1.15434211e+02 3.78666352e+01 4.60556693e+00
 3.97208449e-01 1.36276441e+03 6.64816022e+02 3.01315418e+02
 3.14378230e+02 8.58219057e+01 7.71028625e+00 2.31833377e+01
 7.95625160e-01 2.90934972e+00 2.30781544e-01]
E = -526.4094425958025
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:42:42 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5390299        1
[INPUT] 0    0    [1    /1   ]  7617.85117725        1
[INPUT] 0    0    [1    /1   ]  3617.38786147        1
[INPUT] 0    0    [1    /1   ]  1605.60594275        1
[INPUT] 0    0    [1    /1   ]  357.739921763        1
[INPUT] 0    0    [1    /1   ]  115.434210569        1
[INPUT] 0    0    [1    /1   ]  37.8666352047        1
[INPUT] 0    0    [1    /1   ]  4.60556693239        1
[INPUT] 0    0    [1    /1   ]  0.397208448831       1
[INPUT] 1    0    [1    /1   ]  1362.76440517        1
[INPUT] 1    0    [1    /1   ]  664.816022378        1
[INPUT] 1    0    [1    /1   ]  301.31541764         1
[INPUT] 1    0    [1    /1   ]  314.378230218        1
[INPUT] 1    0    [1    /1   ]  85.8219057065        1
[INPUT] 1    0    [1    /1   ]  7.71028625483        1
[INPUT] 1    0    [1    /1   ]  23.1833377064        1
[INPUT] 1    0    [1    /1   ]  0.795625160482       1
[INPUT] 1    0    [1    /1   ]  2.90934971732        1
[INPUT] 1    0    [1    /1   ]  0.230781543918       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.53902994071, 1.0]], [0, [7617.851177253019, 1.0]], [0, [3617.3878614651926, 1.0]], [0, [1605.6059427544938, 1.0]], [0, [357.7399217626523, 1.0]], [0, [115.43421056862176, 1.0]], [0, [37.866635204705275, 1.0]], [0, [4.605566932391037, 1.0]], [0, [0.3972084488306775, 1.0]], [1, [1362.764405174774, 1.0]], [1, [664.8160223777841, 1.0]], [1, [301.31541763987883, 1.0]], [1, [314.3782302180826, 1.0]], [1, [85.82190570647377, 1.0]], [1, [7.710286254825535, 1.0]], [1, [23.183337706407585, 1.0]], [1, [0.7956251604820679, 1.0]], [1, [2.909349717322638, 1.0]], [1, [0.23078154391792388, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.53902994]
bas 1, expnt(s) = [7617.85117725]
bas 2, expnt(s) = [3617.38786147]
bas 3, expnt(s) = [1605.60594275]
bas 4, expnt(s) = [357.73992176]
bas 5, expnt(s) = [115.43421057]
bas 6, expnt(s) = [37.8666352]
bas 7, expnt(s) = [4.60556693]
bas 8, expnt(s) = [0.39720845]
bas 9, expnt(s) = [1362.76440517]
bas 10, expnt(s) = [664.81602238]
bas 11, expnt(s) = [301.31541764]
bas 12, expnt(s) = [314.37823022]
bas 13, expnt(s) = [85.82190571]
bas 14, expnt(s) = [7.71028625]
bas 15, expnt(s) = [23.18333771]
bas 16, expnt(s) = [0.79562516]
bas 17, expnt(s) = [2.90934972]
bas 18, expnt(s) = [0.23078154]
CPU time:       450.40
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825390e+04 5.20024547e+03 7.61785118e+03 2.06010515e+03
 3.61738786e+03 1.17845046e+03 1.60560594e+03 6.40832087e+02
 3.57739922e+02 2.07821550e+02 1.15434211e+02 8.89745760e+01
 3.78666352e+01 3.85662632e+01 4.60556693e+00 7.94286805e+00
 3.97208449e-01 1.26409258e+00 1.36276441e+03 2.41551851e+04
 6.64816022e+02 9.84829932e+03 3.01315418e+02 3.66236045e+03
 3.14378230e+02 3.86189066e+03 8.58219057e+01 7.62047574e+02
 7.71028625e+00 3.74819796e+01 2.31833377e+01 1.48406986e+02
 7.95625160e-01 2.19214879e+00 2.90934972e+00 1.10848368e+01
 2.30781544e-01 4.66644053e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97489420951918
cond(S) = 144164.84062501887
E1 = -728.8224945751011  E_coul = 203.17343990874397
init E= -525.649054666357
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558049613795015  LUMO = 1.08003364486497
  mo_energy =
[-1.18290249e+02 -1.21008808e+01 -9.44104355e+00 -9.44104355e+00
 -9.44104355e+00 -1.22960048e+00 -5.58049614e-01 -5.58049614e-01
 -5.58049614e-01  1.08003364e+00  1.08003364e+00  1.08003364e+00
  7.75852361e+00  7.75852361e+00  7.75852361e+00  3.68295225e+01
  3.68295225e+01  3.68295225e+01  8.39760243e+01  1.60321018e+02
  1.60321018e+02  1.60321018e+02  5.59106380e+02  5.59106380e+02
  5.59106380e+02  5.71314399e+02  1.42819901e+03  1.42819901e+03
  1.42819901e+03  2.60612403e+03  3.12672104e+03  3.12672104e+03
  3.12672104e+03  6.74359853e+03  6.74359853e+03  6.74359853e+03
  9.00423361e+03  2.53659718e+04  7.61145798e+04]
E1 = -728.1116535391313  E_coul = 201.7025777156389
cycle= 1 E= -526.409075823492  delta_E= -0.76  |g|= 0.186  |ddm|= 0.775
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.549394
diis-c [-0.30183388  1.        ]
  HOMO = -0.571477195669412  LUMO = 1.07183410495923
  mo_energy =
[-1.18564265e+02 -1.21971979e+01 -9.54234660e+00 -9.54234660e+00
 -9.54234660e+00 -1.25052934e+00 -5.71477196e-01 -5.71477196e-01
 -5.71477196e-01  1.07183410e+00  1.07183410e+00  1.07183410e+00
  7.70338597e+00  7.70338597e+00  7.70338597e+00  3.67110881e+01
  3.67110881e+01  3.67110881e+01  8.38045371e+01  1.60115879e+02
  1.60115879e+02  1.60115879e+02  5.58835094e+02  5.58835094e+02
  5.58835094e+02  5.71009286e+02  1.42787449e+03  1.42787449e+03
  1.42787449e+03  2.60566932e+03  3.12633360e+03  3.12633360e+03
  3.12633360e+03  6.74309744e+03  6.74309744e+03  6.74309744e+03
  9.00365607e+03  2.53652995e+04  7.61138165e+04]
E1 = -728.3974211943807  E_coul = 201.9879910058398
cycle= 2 E= -526.409430188541  delta_E= -0.000354  |g|= 0.0234  |ddm|= 0.0191
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0452226
diis-c [-0.00138626  0.04473286  0.95526714]
  HOMO = -0.56798130677532  LUMO = 1.07466391185506
  mo_energy =
[-1.18522719e+02 -1.21775682e+01 -9.52233881e+00 -9.52233881e+00
 -9.52233881e+00 -1.24586466e+00 -5.67981307e-01 -5.67981307e-01
 -5.67981307e-01  1.07466391e+00  1.07466391e+00  1.07466391e+00
  7.71440277e+00  7.71440277e+00  7.71440277e+00  3.67332023e+01
  3.67332023e+01  3.67332023e+01  8.38384365e+01  1.60150666e+02
  1.60150666e+02  1.60150666e+02  5.58876399e+02  5.58876399e+02
  5.58876399e+02  5.71052259e+02  1.42791851e+03  1.42791851e+03
  1.42791851e+03  2.60571562e+03  3.12637920e+03  3.12637920e+03
  3.12637920e+03  6.74314410e+03  6.74314410e+03  6.74314410e+03
  9.00370318e+03  2.53653468e+04  7.61138638e+04]
E1 = -728.3383173559221  E_coul = 201.92887504443883
cycle= 3 E= -526.409442311483  delta_E= -1.21e-05  |g|= 0.00294  |ddm|= 0.00498
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00616994
diis-c [-2.69583748e-07 -9.58548570e-04  1.14201283e-01  8.86757266e-01]
  HOMO = -0.568637937564614  LUMO = 1.07415015634259
  mo_energy =
[-1.18527943e+02 -1.21804086e+01 -9.52527090e+00 -9.52527090e+00
 -9.52527090e+00 -1.24672221e+00 -5.68637938e-01 -5.68637938e-01
 -5.68637938e-01  1.07415016e+00  1.07415016e+00  1.07415016e+00
  7.71260653e+00  7.71260653e+00  7.71260653e+00  3.67300682e+01
  3.67300682e+01  3.67300682e+01  8.38341364e+01  1.60146169e+02
  1.60146169e+02  1.60146169e+02  5.58871212e+02  5.58871212e+02
  5.58871212e+02  5.71046872e+02  1.42791300e+03  1.42791300e+03
  1.42791300e+03  2.60570974e+03  3.12637347e+03  3.12637347e+03
  3.12637347e+03  6.74313814e+03  6.74313814e+03  6.74313814e+03
  9.00369709e+03  2.53653406e+04  7.61138576e+04]
E1 = -728.346566143813  E_coul = 201.93712354818365
cycle= 4 E= -526.409442595629  delta_E= -2.84e-07  |g|= 4.74e-05  |ddm|= 0.000758
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=6.75385e-05
diis-c [-1.61421194e-09 -6.11541359e-06  1.41915599e-04  1.00479564e-02
  9.89816243e-01]
  HOMO = -0.568609152541781  LUMO = 1.07417211304765
  mo_energy =
[-1.18527837e+02 -1.21803149e+01 -9.52517754e+00 -9.52517754e+00
 -9.52517754e+00 -1.24668479e+00 -5.68609153e-01 -5.68609153e-01
 -5.68609153e-01  1.07417211e+00  1.07417211e+00  1.07417211e+00
  7.71267408e+00  7.71267408e+00  7.71267408e+00  3.67301604e+01
  3.67301604e+01  3.67301604e+01  8.38342427e+01  1.60146273e+02
  1.60146273e+02  1.60146273e+02  5.58871317e+02  5.58871317e+02
  5.58871317e+02  5.71046975e+02  1.42791310e+03  1.42791310e+03
  1.42791310e+03  2.60570983e+03  3.12637357e+03  3.12637357e+03
  3.12637357e+03  6.74313823e+03  6.74313823e+03  6.74313823e+03
  9.00369719e+03  2.53653407e+04  7.61138577e+04]
E1 = -728.3463413837271  E_coul = 201.9368987879248
cycle= 5 E= -526.409442595802  delta_E= -1.73e-10  |g|= 6.33e-06  |ddm|= 2.52e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3463413837271  E_coul = 201.9368987879248
  HOMO = -0.568612361773964  LUMO = 1.07416965900779
  mo_energy =
[-1.18527853e+02 -1.21803262e+01 -9.52518904e+00 -9.52518904e+00
 -9.52518904e+00 -1.24668896e+00 -5.68612362e-01 -5.68612362e-01
 -5.68612362e-01  1.07416966e+00  1.07416966e+00  1.07416966e+00
  7.71266621e+00  7.71266621e+00  7.71266621e+00  3.67301488e+01
  3.67301488e+01  3.67301488e+01  8.38342286e+01  1.60146258e+02
  1.60146258e+02  1.60146258e+02  5.58871301e+02  5.58871301e+02
  5.58871301e+02  5.71046959e+02  1.42791308e+03  1.42791308e+03
  1.42791308e+03  2.60570982e+03  3.12637355e+03  3.12637355e+03
  3.12637355e+03  6.74313822e+03  6.74313822e+03  6.74313822e+03
  9.00369717e+03  2.53653407e+04  7.61138576e+04]
E1 = -728.3463710132335  E_coul = 201.93692841743098
Extra cycle  E= -526.409442595802  delta_E= -1.14e-13  |g|= 1.6e-06  |ddm|= 3.13e-06
    CPU time for scf_cycle      0.67 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 144164.84062501887
E1 = -728.3463710132335  E_coul = 201.93692841743098
init E= -526.409442595802
    CPU time for initialize scf      2.72 sec, wall time      0.24 sec
  HOMO = -0.568611807402558  LUMO = 1.07417008889968
  mo_energy =
[-1.18527849e+02 -1.21803240e+01 -9.52518681e+00 -9.52518681e+00
 -9.52518681e+00 -1.24668824e+00 -5.68611807e-01 -5.68611807e-01
 -5.68611807e-01  1.07417009e+00  1.07417009e+00  1.07417009e+00
  7.71266765e+00  7.71266765e+00  7.71266765e+00  3.67301511e+01
  3.67301511e+01  3.67301511e+01  8.38342317e+01  1.60146261e+02
  1.60146261e+02  1.60146261e+02  5.58871305e+02  5.58871305e+02
  5.58871305e+02  5.71046963e+02  1.42791309e+03  1.42791309e+03
  1.42791309e+03  2.60570982e+03  3.12637355e+03  3.12637355e+03
  3.12637355e+03  6.74313822e+03  6.74313822e+03  6.74313822e+03
  9.00369717e+03  2.53653407e+04  7.61138576e+04]
E1 = -728.3463650082999  E_coul = 201.93692241249616
cycle= 1 E= -526.409442595804  delta_E= -1.25e-12  |g|= 3.51e-07  |ddm|= 5.82e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3463650082999  E_coul = 201.93692241249616
  HOMO = -0.568611913277644  LUMO = 1.0741700064175
  mo_energy =
[-1.18527850e+02 -1.21803245e+01 -9.52518726e+00 -9.52518726e+00
 -9.52518726e+00 -1.24668838e+00 -5.68611913e-01 -5.68611913e-01
 -5.68611913e-01  1.07417001e+00  1.07417001e+00  1.07417001e+00
  7.71266737e+00  7.71266737e+00  7.71266737e+00  3.67301506e+01
  3.67301506e+01  3.67301506e+01  8.38342310e+01  1.60146261e+02
  1.60146261e+02  1.60146261e+02  5.58871304e+02  5.58871304e+02
  5.58871304e+02  5.71046962e+02  1.42791309e+03  1.42791309e+03
  1.42791309e+03  2.60570982e+03  3.12637355e+03  3.12637355e+03
  3.12637355e+03  6.74313822e+03  6.74313822e+03  6.74313822e+03
  9.00369717e+03  2.53653407e+04  7.61138576e+04]
E1 = -728.3463662444464  E_coul = 201.93692364864282
Extra cycle  E= -526.409442595804  delta_E= 2.27e-13  |g|= 7.45e-08  |ddm|= 1.17e-07
    CPU time for scf_cycle      2.86 sec, wall time      0.38 sec
exp = [2.61825390e+04 7.61785118e+03 3.61738786e+03 1.60560594e+03
 3.57739922e+02 1.15434211e+02 3.78666352e+01 4.60556693e+00
 3.97208449e-01 1.36276441e+03 6.64816022e+02 3.01315418e+02
 3.14378230e+02 8.58219057e+01 7.71028625e+00 2.31833377e+01
 7.95625160e-01 2.90934972e+00 2.30781544e-01]
grad_E = [-1.75252969e-06  6.99876174e-06  3.52334637e-06  1.95061933e-04
 -1.99418089e-03  5.25014136e-03 -9.62096163e-04  1.53895883e-02
  2.82161884e-02  1.06688367e-06  2.32721315e-06  1.57553290e-05
  1.60280167e-05  2.01178151e-03 -6.88458587e-03 -7.55899210e-03
 -7.64648690e-03  8.00907570e-03  7.45147494e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:42:46 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5392971        1
[INPUT] 0    0    [1    /1   ]  7617.84803638        1
[INPUT] 0    0    [1    /1   ]  3617.38136528        1
[INPUT] 0    0    [1    /1   ]  1605.50593358        1
[INPUT] 0    0    [1    /1   ]  359.144207696        1
[INPUT] 0    0    [1    /1   ]  113.99480061         1
[INPUT] 0    0    [1    /1   ]  35.8634735437        1
[INPUT] 0    0    [1    /1   ]  4.58198898789        1
[INPUT] 0    0    [1    /1   ]  0.408521159632       1
[INPUT] 1    0    [1    /1   ]  1362.76436193        1
[INPUT] 1    0    [1    /1   ]  664.814719935        1
[INPUT] 1    0    [1    /1   ]  301.308852219        1
[INPUT] 1    0    [1    /1   ]  314.372396124        1
[INPUT] 1    0    [1    /1   ]  85.5275847193        1
[INPUT] 1    0    [1    /1   ]  8.41375608494        1
[INPUT] 1    0    [1    /1   ]  24.6562122287        1
[INPUT] 1    0    [1    /1   ]  0.80416259002        1
[INPUT] 1    0    [1    /1   ]  2.94547544284        1
[INPUT] 1    0    [1    /1   ]  0.230252312803       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.539297125673, 1.0]], [0, [7617.848036378871, 1.0]], [0, [3617.381365283965, 1.0]], [0, [1605.5059335837254, 1.0]], [0, [359.1442076959562, 1.0]], [0, [113.99480061045837, 1.0]], [0, [35.863473543723295, 1.0]], [0, [4.581988987886586, 1.0]], [0, [0.40852115963238705, 1.0]], [1, [1362.7643619267203, 1.0]], [1, [664.8147199352906, 1.0]], [1, [301.3088522188548, 1.0]], [1, [314.3723961240407, 1.0]], [1, [85.52758471929812, 1.0]], [1, [8.413756084936868, 1.0]], [1, [24.656212228655765, 1.0]], [1, [0.8041625900195787, 1.0]], [1, [2.945475442838972, 1.0]], [1, [0.23025231280251793, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.53929713]
bas 1, expnt(s) = [7617.84803638]
bas 2, expnt(s) = [3617.38136528]
bas 3, expnt(s) = [1605.50593358]
bas 4, expnt(s) = [359.1442077]
bas 5, expnt(s) = [113.99480061]
bas 6, expnt(s) = [35.86347354]
bas 7, expnt(s) = [4.58198899]
bas 8, expnt(s) = [0.40852116]
bas 9, expnt(s) = [1362.76436193]
bas 10, expnt(s) = [664.81471994]
bas 11, expnt(s) = [301.30885222]
bas 12, expnt(s) = [314.37239612]
bas 13, expnt(s) = [85.52758472]
bas 14, expnt(s) = [8.41375608]
bas 15, expnt(s) = [24.65621223]
bas 16, expnt(s) = [0.80416259]
bas 17, expnt(s) = [2.94547544]
bas 18, expnt(s) = [0.23025231]
CPU time:       458.64
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825393e+04 5.20024550e+03 7.61784804e+03 2.06010451e+03
 3.61738137e+03 1.17844888e+03 1.60550593e+03 6.40802150e+02
 3.59144208e+02 2.08433093e+02 1.13994801e+02 8.81411691e+01
 3.58634735e+01 3.70257860e+01 4.58198899e+00 7.91235119e+00
 4.08521160e-01 1.29099911e+00 1.36276436e+03 2.41551841e+04
 6.64814720e+02 9.84827520e+03 3.01308852e+02 3.66226070e+03
 3.14372396e+02 3.86180108e+03 8.55275847e+01 7.58782231e+02
 8.41375608e+00 4.18043803e+01 2.46562122e+01 1.60284801e+02
 8.04162590e-01 2.22159160e+00 2.94547544e+00 1.12571551e+01
 2.30252313e-01 4.65306794e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.972964150978186
cond(S) = 146986.02998018096
E1 = -728.8537602334358  E_coul = 203.2927589407182
init E= -525.561001292718
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.55396653303542  LUMO = 1.08589889092072
  mo_energy =
[-1.18289672e+02 -1.20830697e+01 -9.43321093e+00 -9.43321093e+00
 -9.43321093e+00 -1.22351103e+00 -5.53966533e-01 -5.53966533e-01
 -5.53966533e-01  1.08589889e+00  1.08589889e+00  1.08589889e+00
  8.06126962e+00  8.06126962e+00  8.06126962e+00  3.97736767e+01
  3.97736767e+01  3.97736767e+01  7.93838925e+01  1.66793698e+02
  1.66793698e+02  1.66793698e+02  5.61398019e+02  5.65560416e+02
  5.65560416e+02  5.65560416e+02  1.43405294e+03  1.43405294e+03
  1.43405294e+03  2.59732562e+03  3.13211798e+03  3.13211798e+03
  3.13211798e+03  6.74849888e+03  6.74849888e+03  6.74849888e+03
  8.99685917e+03  2.53591377e+04  7.61082314e+04]
E1 = -728.1051649023202  E_coul = 201.6972322919053
cycle= 1 E= -526.407932610415  delta_E= -0.847  |g|=  0.2  |ddm|= 1.08
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.574715
diis-c [-0.33029789  1.        ]
  HOMO = -0.568434069373106  LUMO = 1.07680234625428
  mo_energy =
[-1.18582687e+02 -1.21865247e+01 -9.54476390e+00 -9.54476390e+00
 -9.54476390e+00 -1.24680508e+00 -5.68434069e-01 -5.68434069e-01
 -5.68434069e-01  1.07680235e+00  1.07680235e+00  1.07680235e+00
  7.99763692e+00  7.99763692e+00  7.99763692e+00  3.96378635e+01
  3.96378635e+01  3.96378635e+01  7.92016971e+01  1.66572785e+02
  1.66572785e+02  1.66572785e+02  5.61067855e+02  5.65268255e+02
  5.65268255e+02  5.65268255e+02  1.43370222e+03  1.43370222e+03
  1.43370222e+03  2.59683917e+03  3.13170180e+03  3.13170180e+03
  3.13170180e+03  6.74796492e+03  6.74796492e+03  6.74796492e+03
  8.99624644e+03  2.53584278e+04  7.61074290e+04]
E1 = -728.4209422316302  E_coul = 202.01257833446368
cycle= 2 E= -526.408363897167  delta_E= -0.000431  |g|= 0.0261  |ddm|= 0.0212
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0495797
diis-c [-0.00152866  0.05048667  0.94951333]
  HOMO = -0.564570411900461  LUMO = 1.07996239274917
  mo_energy =
[-1.18537131e+02 -1.21650137e+01 -9.52281079e+00 -9.52281079e+00
 -9.52281079e+00 -1.24157565e+00 -5.64570412e-01 -5.64570412e-01
 -5.64570412e-01  1.07996239e+00  1.07996239e+00  1.07996239e+00
  8.01019246e+00  8.01019246e+00  8.01019246e+00  3.96629259e+01
  3.96629259e+01  3.96629259e+01  7.92384310e+01  1.66610959e+02
  1.66610959e+02  1.66610959e+02  5.61114877e+02  5.65313487e+02
  5.65313487e+02  5.65313487e+02  1.43375039e+03  1.43375039e+03
  1.43375039e+03  2.59688978e+03  3.13175167e+03  3.13175167e+03
  3.13175167e+03  6.74801590e+03  6.74801590e+03  6.74801590e+03
  8.99629788e+03  2.53584795e+04  7.61074807e+04]
E1 = -728.3556987348893  E_coul = 201.94731989825593
cycle= 3 E= -526.408378836633  delta_E= -1.49e-05  |g|= 0.00313  |ddm|= 0.00549
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00663682
diis-c [-4.27685044e-07 -1.10017758e-03  1.10971494e-01  8.90128684e-01]
  HOMO = -0.565270479238468  LUMO = 1.07940860997226
  mo_energy =
[-1.18542655e+02 -1.21680197e+01 -9.52592843e+00 -9.52592843e+00
 -9.52592843e+00 -1.24249968e+00 -5.65270479e-01 -5.65270479e-01
 -5.65270479e-01  1.07940861e+00  1.07940861e+00  1.07940861e+00
  8.00822062e+00  8.00822062e+00  8.00822062e+00  3.96595014e+01
  3.96595014e+01  3.96595014e+01  7.92339355e+01  1.66606194e+02
  1.66606194e+02  1.66606194e+02  5.61109169e+02  5.65308001e+02
  5.65308001e+02  5.65308001e+02  1.43374455e+03  1.43374455e+03
  1.43374455e+03  2.59688352e+03  3.13174558e+03  3.13174558e+03
  3.13174558e+03  6.74800955e+03  6.74800955e+03  6.74800955e+03
  8.99629139e+03  2.53584729e+04  7.61074740e+04]
E1 = -728.3644863906059  E_coul = 201.95610723063191
cycle= 4 E= -526.408379159974  delta_E= -3.23e-07  |g|= 4.55e-05  |ddm|= 0.000805
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=6.02099e-05
diis-c [-2.05174124e-09  4.08988006e-07 -1.16774129e-03 -2.78319491e-03
  1.00395053e+00]
  HOMO = -0.565240387345151  LUMO = 1.07943173551679
  mo_energy =
[-1.18542552e+02 -1.21679236e+01 -9.52583320e+00 -9.52583320e+00
 -9.52583320e+00 -1.24246003e+00 -5.65240387e-01 -5.65240387e-01
 -5.65240387e-01  1.07943174e+00  1.07943174e+00  1.07943174e+00
  8.00829168e+00  8.00829168e+00  8.00829168e+00  3.96595953e+01
  3.96595953e+01  3.96595953e+01  7.92340414e+01  1.66606296e+02
  1.66606296e+02  1.66606296e+02  5.61109268e+02  5.65308104e+02
  5.65308104e+02  5.65308104e+02  1.43374465e+03  1.43374465e+03
  1.43374465e+03  2.59688361e+03  3.13174568e+03  3.13174568e+03
  3.13174568e+03  6.74800964e+03  6.74800964e+03  6.74800964e+03
  8.99629147e+03  2.53584729e+04  7.61074741e+04]
E1 = -728.3642591207667  E_coul = 201.95587996062756
cycle= 5 E= -526.408379160139  delta_E= -1.65e-10  |g|= 7.81e-06  |ddm|= 2.62e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3642591207667  E_coul = 201.95587996062756
  HOMO = -0.565244368024276  LUMO = 1.07942865583143
  mo_energy =
[-1.18542572e+02 -1.21679375e+01 -9.52584738e+00 -9.52584738e+00
 -9.52584738e+00 -1.24246526e+00 -5.65244368e-01 -5.65244368e-01
 -5.65244368e-01  1.07942866e+00  1.07942866e+00  1.07942866e+00
  8.00828172e+00  8.00828172e+00  8.00828172e+00  3.96595807e+01
  3.96595807e+01  3.96595807e+01  7.92340241e+01  1.66606278e+02
  1.66606278e+02  1.66606278e+02  5.61109249e+02  5.65308085e+02
  5.65308085e+02  5.65308085e+02  1.43374463e+03  1.43374463e+03
  1.43374463e+03  2.59688359e+03  3.13174566e+03  3.13174566e+03
  3.13174566e+03  6.74800962e+03  6.74800962e+03  6.74800962e+03
  8.99629145e+03  2.53584729e+04  7.61074741e+04]
E1 = -728.3642955790365  E_coul = 201.9559164188916
Extra cycle  E= -526.408379160145  delta_E= -5.68e-12  |g|= 1.98e-06  |ddm|= 3.84e-06
    CPU time for scf_cycle      0.67 sec, wall time      0.28 sec
exp = [2.61825393e+04 7.61784804e+03 3.61738137e+03 1.60550593e+03
 3.59144208e+02 1.13994801e+02 3.58634735e+01 4.58198899e+00
 4.08521160e-01 1.36276436e+03 6.64814720e+02 3.01308852e+02
 3.14372396e+02 8.55275847e+01 8.41375608e+00 2.46562122e+01
 8.04162590e-01 2.94547544e+00 2.30252313e-01]
E = -526.4083791601449
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:42:47 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5391581        1
[INPUT] 0    0    [1    /1   ]  7617.84967119        1
[INPUT] 0    0    [1    /1   ]  3617.38474653        1
[INPUT] 0    0    [1    /1   ]  1605.55798806        1
[INPUT] 0    0    [1    /1   ]  358.41328097         1
[INPUT] 0    0    [1    /1   ]  114.744009288        1
[INPUT] 0    0    [1    /1   ]  36.9061133358        1
[INPUT] 0    0    [1    /1   ]  4.59426123912        1
[INPUT] 0    0    [1    /1   ]  0.402632926711       1
[INPUT] 1    0    [1    /1   ]  1362.76438444        1
[INPUT] 1    0    [1    /1   ]  664.815397853        1
[INPUT] 1    0    [1    /1   ]  301.312269501        1
[INPUT] 1    0    [1    /1   ]  314.375432753        1
[INPUT] 1    0    [1    /1   ]  85.6807779332        1
[INPUT] 1    0    [1    /1   ]  8.04760209362        1
[INPUT] 1    0    [1    /1   ]  23.889585343         1
[INPUT] 1    0    [1    /1   ]  0.799718882888       1
[INPUT] 1    0    [1    /1   ]  2.92667210825        1
[INPUT] 1    0    [1    /1   ]  0.230527776052       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.539158056683, 1.0]], [0, [7617.849671194689, 1.0]], [0, [3617.3847465273147, 1.0]], [0, [1605.5579880649236, 1.0]], [0, [358.4132809704306, 1.0]], [0, [114.74400928830502, 1.0]], [0, [36.906113335831115, 1.0]], [0, [4.594261239115875, 1.0]], [0, [0.4026329267112916, 1.0]], [1, [1362.764384437206, 1.0]], [1, [664.8153978528032, 1.0]], [1, [301.3122695013163, 1.0]], [1, [314.3754327529446, 1.0]], [1, [85.6807779332354, 1.0]], [1, [8.047602093620037, 1.0]], [1, [23.88958534297299, 1.0]], [1, [0.7997188828882422, 1.0]], [1, [2.926672108252571, 1.0]], [1, [0.23052777605188612, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.53915806]
bas 1, expnt(s) = [7617.84967119]
bas 2, expnt(s) = [3617.38474653]
bas 3, expnt(s) = [1605.55798806]
bas 4, expnt(s) = [358.41328097]
bas 5, expnt(s) = [114.74400929]
bas 6, expnt(s) = [36.90611334]
bas 7, expnt(s) = [4.59426124]
bas 8, expnt(s) = [0.40263293]
bas 9, expnt(s) = [1362.76438444]
bas 10, expnt(s) = [664.81539785]
bas 11, expnt(s) = [301.3122695]
bas 12, expnt(s) = [314.37543275]
bas 13, expnt(s) = [85.68077793]
bas 14, expnt(s) = [8.04760209]
bas 15, expnt(s) = [23.88958534]
bas 16, expnt(s) = [0.79971888]
bas 17, expnt(s) = [2.92667211]
bas 18, expnt(s) = [0.23052778]
CPU time:       459.52
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825392e+04 5.20024548e+03 7.61784967e+03 2.06010484e+03
 3.61738475e+03 1.17844970e+03 1.60555799e+03 6.40817733e+02
 3.58413281e+02 2.08114862e+02 1.14744009e+02 8.85752812e+01
 3.69061133e+01 3.78302105e+01 4.59426124e+00 7.92824001e+00
 4.02632927e-01 1.27701792e+00 1.36276438e+03 2.41551846e+04
 6.64815398e+02 9.84828775e+03 3.01312270e+02 3.66231262e+03
 3.14375433e+02 3.86184770e+03 8.56807779e+01 7.60481483e+02
 8.04760209e+00 3.95428085e+01 2.38895853e+01 1.54079605e+02
 7.99718883e-01 2.20625690e+00 2.92667211e+00 1.11673976e+01
 2.30527776e-01 4.66002738e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.974146843433637
cond(S) = 145500.211910766
E1 = -728.856875357498  E_coul = 203.23413743886215
init E= -525.622737918636
    CPU time for initialize scf      0.45 sec, wall time      0.05 sec
  HOMO = -0.555991355900582  LUMO = 1.0829371958937
  mo_energy =
[-1.18291275e+02 -1.20923202e+01 -9.43746674e+00 -9.43746674e+00
 -9.43746674e+00 -1.22669563e+00 -5.55991356e-01 -5.55991356e-01
 -5.55991356e-01  1.08293720e+00  1.08293720e+00  1.08293720e+00
  7.90373361e+00  7.90373361e+00  7.90373361e+00  3.82386321e+01
  3.82386321e+01  3.82386321e+01  8.17765680e+01  1.63432702e+02
  1.63432702e+02  1.63432702e+02  5.62191938e+02  5.62191938e+02
  5.62191938e+02  5.66569856e+02  1.43099240e+03  1.43099240e+03
  1.43099240e+03  2.60190377e+03  3.12929450e+03  3.12929450e+03
  3.12929450e+03  6.74593431e+03  6.74593431e+03  6.74593431e+03
  9.00069320e+03  2.53626899e+04  7.61115308e+04]
E1 = -728.1184405408236  E_coul = 201.7034021099
cycle= 1 E= -526.415038430924  delta_E= -0.792  |g|= 0.192  |ddm|= 0.893
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.561108
diis-c [-0.31484237  1.        ]
  HOMO = -0.570009063724755  LUMO = 1.0742284670699
  mo_energy =
[-1.18574257e+02 -1.21920222e+01 -9.54364116e+00 -9.54364116e+00
 -9.54364116e+00 -1.24882382e+00 -5.70009064e-01 -5.70009064e-01
 -5.70009064e-01  1.07422847e+00  1.07422847e+00  1.07422847e+00
  7.84452204e+00  7.84452204e+00  7.84452204e+00  3.81119455e+01
  3.81119455e+01  3.81119455e+01  8.16000162e+01  1.63220111e+02
  1.63220111e+02  1.63220111e+02  5.61910749e+02  5.61910749e+02
  5.61910749e+02  5.66252775e+02  1.43065533e+03  1.43065533e+03
  1.43065533e+03  2.60143365e+03  3.12889318e+03  3.12889318e+03
  3.12889318e+03  6.74541722e+03  6.74541722e+03  6.74541722e+03
  9.00009846e+03  2.53619992e+04  7.61107483e+04]
E1 = -728.4189517300811  E_coul = 202.00352377618992
cycle= 2 E= -526.415427953891  delta_E= -0.00039  |g|= 0.0247  |ddm|= 0.0201
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0472986
diis-c [-0.00145479  0.04758714  0.95241286]
  HOMO = -0.566325708667874  LUMO = 1.07722420873579
  mo_energy =
[-1.18530769e+02 -1.21714619e+01 -9.52267304e+00 -9.52267304e+00
 -9.52267304e+00 -1.24387563e+00 -5.66325709e-01 -5.66325709e-01
 -5.66325709e-01  1.07722421e+00  1.07722421e+00  1.07722421e+00
  7.85629173e+00  7.85629173e+00  7.85629173e+00  3.81354901e+01
  3.81354901e+01  3.81354901e+01  8.16353132e+01  1.63256541e+02
  1.63256541e+02  1.63256541e+02  5.61953957e+02  5.61953957e+02
  5.61953957e+02  5.66297708e+02  1.43070136e+03  1.43070136e+03
  1.43070136e+03  2.60148203e+03  3.12894085e+03  3.12894085e+03
  3.12894085e+03  6.74546596e+03  6.74546596e+03  6.74546596e+03
  9.00014766e+03  2.53620486e+04  7.61107978e+04]
E1 = -728.3568601610515  E_coul = 201.94141876028172
cycle= 3 E= -526.41544140077  delta_E= -1.34e-05  |g|= 0.00303  |ddm|= 0.00523
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00639476
diis-c [-3.36822647e-07 -1.02277892e-03  1.12682151e-01  8.88340628e-01]
  HOMO = -0.567003840159154  LUMO = 1.07669082745354
  mo_energy =
[-1.18536140e+02 -1.21743842e+01 -9.52569646e+00 -9.52569646e+00
 -9.52569646e+00 -1.24476585e+00 -5.67003840e-01 -5.67003840e-01
 -5.67003840e-01  1.07669083e+00  1.07669083e+00  1.07669083e+00
  7.85441025e+00  7.85441025e+00  7.85441025e+00  3.81322146e+01
  3.81322146e+01  3.81322146e+01  8.16309155e+01  1.63251914e+02
  1.63251914e+02  1.63251914e+02  5.61948624e+02  5.61948624e+02
  5.61948624e+02  5.66292164e+02  1.43069569e+03  1.43069569e+03
  1.43069569e+03  2.60147596e+03  3.12893494e+03  3.12893494e+03
  3.12893494e+03  6.74545982e+03  6.74545982e+03  6.74545982e+03
  9.00014138e+03  2.53620422e+04  7.61107913e+04]
E1 = -728.3653719929262  E_coul = 201.94993028917256
cycle= 4 E= -526.415441703754  delta_E= -3.03e-07  |g|= 4.61e-05  |ddm|= 0.000781
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=6.32185e-05
diis-c [-1.81285658e-09 -2.56079412e-06 -5.73764915e-04  3.18581318e-03
  9.97390513e-01]
  HOMO = -0.566974520469434  LUMO = 1.07671327279757
  mo_energy =
[-1.18536036e+02 -1.21742897e+01 -9.52560253e+00 -9.52560253e+00
 -9.52560253e+00 -1.24472748e+00 -5.66974520e-01 -5.66974520e-01
 -5.66974520e-01  1.07671327e+00  1.07671327e+00  1.07671327e+00
  7.85447927e+00  7.85447927e+00  7.85447927e+00  3.81323074e+01
  3.81323074e+01  3.81323074e+01  8.16310211e+01  1.63252016e+02
  1.63252016e+02  1.63252016e+02  5.61948727e+02  5.61948727e+02
  5.61948727e+02  5.66292265e+02  1.43069579e+03  1.43069579e+03
  1.43069579e+03  2.60147606e+03  3.12893504e+03  3.12893504e+03
  3.12893504e+03  6.74545991e+03  6.74545991e+03  6.74545991e+03
  9.00014146e+03  2.53620422e+04  7.61107914e+04]
E1 = -728.3651468625991  E_coul = 201.94970515867797
cycle= 5 E= -526.415441703921  delta_E= -1.68e-10  |g|= 7.06e-06  |ddm|= 2.56e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3651468625991  E_coul = 201.94970515867797
  HOMO = -0.56697810954517  LUMO = 1.0767105123816
  mo_energy =
[-1.18536053e+02 -1.21743023e+01 -9.52561536e+00 -9.52561536e+00
 -9.52561536e+00 -1.24473218e+00 -5.66978110e-01 -5.66978110e-01
 -5.66978110e-01  1.07671051e+00  1.07671051e+00  1.07671051e+00
  7.85447038e+00  7.85447038e+00  7.85447038e+00  3.81322943e+01
  3.81322943e+01  3.81322943e+01  8.16310055e+01  1.63252000e+02
  1.63252000e+02  1.63252000e+02  5.61948710e+02  5.61948710e+02
  5.61948710e+02  5.66292247e+02  1.43069577e+03  1.43069577e+03
  1.43069577e+03  2.60147604e+03  3.12893502e+03  3.12893502e+03
  3.12893502e+03  6.74545989e+03  6.74545989e+03  6.74545989e+03
  9.00014145e+03  2.53620422e+04  7.61107914e+04]
E1 = -728.3651798595421  E_coul = 201.9497381556165
Extra cycle  E= -526.415441703926  delta_E= -4.43e-12  |g|= 1.79e-06  |ddm|= 3.48e-06
    CPU time for scf_cycle      0.70 sec, wall time      0.31 sec
exp = [2.61825392e+04 7.61784967e+03 3.61738475e+03 1.60555799e+03
 3.58413281e+02 1.14744009e+02 3.69061133e+01 4.59426124e+00
 4.02632927e-01 1.36276438e+03 6.64815398e+02 3.01312270e+02
 3.14375433e+02 8.56807779e+01 8.04760209e+00 2.38895853e+01
 7.99718883e-01 2.92667211e+00 2.30527776e-01]
E = -526.4154417039256
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:42:47 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5391581        1
[INPUT] 0    0    [1    /1   ]  7617.84967119        1
[INPUT] 0    0    [1    /1   ]  3617.38474653        1
[INPUT] 0    0    [1    /1   ]  1605.55798806        1
[INPUT] 0    0    [1    /1   ]  358.41328097         1
[INPUT] 0    0    [1    /1   ]  114.744009288        1
[INPUT] 0    0    [1    /1   ]  36.9061133358        1
[INPUT] 0    0    [1    /1   ]  4.59426123912        1
[INPUT] 0    0    [1    /1   ]  0.402632926711       1
[INPUT] 1    0    [1    /1   ]  1362.76438444        1
[INPUT] 1    0    [1    /1   ]  664.815397853        1
[INPUT] 1    0    [1    /1   ]  301.312269501        1
[INPUT] 1    0    [1    /1   ]  314.375432753        1
[INPUT] 1    0    [1    /1   ]  85.6807779332        1
[INPUT] 1    0    [1    /1   ]  8.04760209362        1
[INPUT] 1    0    [1    /1   ]  23.889585343         1
[INPUT] 1    0    [1    /1   ]  0.799718882888       1
[INPUT] 1    0    [1    /1   ]  2.92667210825        1
[INPUT] 1    0    [1    /1   ]  0.230527776052       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.539158056683, 1.0]], [0, [7617.849671194689, 1.0]], [0, [3617.3847465273147, 1.0]], [0, [1605.5579880649236, 1.0]], [0, [358.4132809704306, 1.0]], [0, [114.74400928830502, 1.0]], [0, [36.906113335831115, 1.0]], [0, [4.594261239115875, 1.0]], [0, [0.4026329267112916, 1.0]], [1, [1362.764384437206, 1.0]], [1, [664.8153978528032, 1.0]], [1, [301.3122695013163, 1.0]], [1, [314.3754327529446, 1.0]], [1, [85.6807779332354, 1.0]], [1, [8.047602093620037, 1.0]], [1, [23.88958534297299, 1.0]], [1, [0.7997188828882422, 1.0]], [1, [2.926672108252571, 1.0]], [1, [0.23052777605188612, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.53915806]
bas 1, expnt(s) = [7617.84967119]
bas 2, expnt(s) = [3617.38474653]
bas 3, expnt(s) = [1605.55798806]
bas 4, expnt(s) = [358.41328097]
bas 5, expnt(s) = [114.74400929]
bas 6, expnt(s) = [36.90611334]
bas 7, expnt(s) = [4.59426124]
bas 8, expnt(s) = [0.40263293]
bas 9, expnt(s) = [1362.76438444]
bas 10, expnt(s) = [664.81539785]
bas 11, expnt(s) = [301.3122695]
bas 12, expnt(s) = [314.37543275]
bas 13, expnt(s) = [85.68077793]
bas 14, expnt(s) = [8.04760209]
bas 15, expnt(s) = [23.88958534]
bas 16, expnt(s) = [0.79971888]
bas 17, expnt(s) = [2.92667211]
bas 18, expnt(s) = [0.23052778]
CPU time:       460.42
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825392e+04 5.20024548e+03 7.61784967e+03 2.06010484e+03
 3.61738475e+03 1.17844970e+03 1.60555799e+03 6.40817733e+02
 3.58413281e+02 2.08114862e+02 1.14744009e+02 8.85752812e+01
 3.69061133e+01 3.78302105e+01 4.59426124e+00 7.92824001e+00
 4.02632927e-01 1.27701792e+00 1.36276438e+03 2.41551846e+04
 6.64815398e+02 9.84828775e+03 3.01312270e+02 3.66231262e+03
 3.14375433e+02 3.86184770e+03 8.56807779e+01 7.60481483e+02
 8.04760209e+00 3.95428085e+01 2.38895853e+01 1.54079605e+02
 7.99718883e-01 2.20625690e+00 2.92667211e+00 1.11673976e+01
 2.30527776e-01 4.66002738e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.974146843433637
cond(S) = 145500.211910766
E1 = -728.856875357498  E_coul = 203.23413743886215
init E= -525.622737918636
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.555991355900582  LUMO = 1.0829371958937
  mo_energy =
[-1.18291275e+02 -1.20923202e+01 -9.43746674e+00 -9.43746674e+00
 -9.43746674e+00 -1.22669563e+00 -5.55991356e-01 -5.55991356e-01
 -5.55991356e-01  1.08293720e+00  1.08293720e+00  1.08293720e+00
  7.90373361e+00  7.90373361e+00  7.90373361e+00  3.82386321e+01
  3.82386321e+01  3.82386321e+01  8.17765680e+01  1.63432702e+02
  1.63432702e+02  1.63432702e+02  5.62191938e+02  5.62191938e+02
  5.62191938e+02  5.66569856e+02  1.43099240e+03  1.43099240e+03
  1.43099240e+03  2.60190377e+03  3.12929450e+03  3.12929450e+03
  3.12929450e+03  6.74593431e+03  6.74593431e+03  6.74593431e+03
  9.00069320e+03  2.53626899e+04  7.61115308e+04]
E1 = -728.1184405408236  E_coul = 201.7034021099
cycle= 1 E= -526.415038430924  delta_E= -0.792  |g|= 0.192  |ddm|= 0.893
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.561108
diis-c [-0.31484237  1.        ]
  HOMO = -0.570009063724755  LUMO = 1.0742284670699
  mo_energy =
[-1.18574257e+02 -1.21920222e+01 -9.54364116e+00 -9.54364116e+00
 -9.54364116e+00 -1.24882382e+00 -5.70009064e-01 -5.70009064e-01
 -5.70009064e-01  1.07422847e+00  1.07422847e+00  1.07422847e+00
  7.84452204e+00  7.84452204e+00  7.84452204e+00  3.81119455e+01
  3.81119455e+01  3.81119455e+01  8.16000162e+01  1.63220111e+02
  1.63220111e+02  1.63220111e+02  5.61910749e+02  5.61910749e+02
  5.61910749e+02  5.66252775e+02  1.43065533e+03  1.43065533e+03
  1.43065533e+03  2.60143365e+03  3.12889318e+03  3.12889318e+03
  3.12889318e+03  6.74541722e+03  6.74541722e+03  6.74541722e+03
  9.00009846e+03  2.53619992e+04  7.61107483e+04]
E1 = -728.4189517300811  E_coul = 202.00352377618992
cycle= 2 E= -526.415427953891  delta_E= -0.00039  |g|= 0.0247  |ddm|= 0.0201
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0472986
diis-c [-0.00145479  0.04758714  0.95241286]
  HOMO = -0.566325708667874  LUMO = 1.07722420873579
  mo_energy =
[-1.18530769e+02 -1.21714619e+01 -9.52267304e+00 -9.52267304e+00
 -9.52267304e+00 -1.24387563e+00 -5.66325709e-01 -5.66325709e-01
 -5.66325709e-01  1.07722421e+00  1.07722421e+00  1.07722421e+00
  7.85629173e+00  7.85629173e+00  7.85629173e+00  3.81354901e+01
  3.81354901e+01  3.81354901e+01  8.16353132e+01  1.63256541e+02
  1.63256541e+02  1.63256541e+02  5.61953957e+02  5.61953957e+02
  5.61953957e+02  5.66297708e+02  1.43070136e+03  1.43070136e+03
  1.43070136e+03  2.60148203e+03  3.12894085e+03  3.12894085e+03
  3.12894085e+03  6.74546596e+03  6.74546596e+03  6.74546596e+03
  9.00014766e+03  2.53620486e+04  7.61107978e+04]
E1 = -728.3568601610515  E_coul = 201.94141876028172
cycle= 3 E= -526.41544140077  delta_E= -1.34e-05  |g|= 0.00303  |ddm|= 0.00523
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00639476
diis-c [-3.36822647e-07 -1.02277892e-03  1.12682151e-01  8.88340628e-01]
  HOMO = -0.567003840159154  LUMO = 1.07669082745354
  mo_energy =
[-1.18536140e+02 -1.21743842e+01 -9.52569646e+00 -9.52569646e+00
 -9.52569646e+00 -1.24476585e+00 -5.67003840e-01 -5.67003840e-01
 -5.67003840e-01  1.07669083e+00  1.07669083e+00  1.07669083e+00
  7.85441025e+00  7.85441025e+00  7.85441025e+00  3.81322146e+01
  3.81322146e+01  3.81322146e+01  8.16309155e+01  1.63251914e+02
  1.63251914e+02  1.63251914e+02  5.61948624e+02  5.61948624e+02
  5.61948624e+02  5.66292164e+02  1.43069569e+03  1.43069569e+03
  1.43069569e+03  2.60147596e+03  3.12893494e+03  3.12893494e+03
  3.12893494e+03  6.74545982e+03  6.74545982e+03  6.74545982e+03
  9.00014138e+03  2.53620422e+04  7.61107913e+04]
E1 = -728.3653719929262  E_coul = 201.94993028917256
cycle= 4 E= -526.415441703754  delta_E= -3.03e-07  |g|= 4.61e-05  |ddm|= 0.000781
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=6.32185e-05
diis-c [-1.81285658e-09 -2.56079412e-06 -5.73764915e-04  3.18581318e-03
  9.97390513e-01]
  HOMO = -0.566974520469434  LUMO = 1.07671327279757
  mo_energy =
[-1.18536036e+02 -1.21742897e+01 -9.52560253e+00 -9.52560253e+00
 -9.52560253e+00 -1.24472748e+00 -5.66974520e-01 -5.66974520e-01
 -5.66974520e-01  1.07671327e+00  1.07671327e+00  1.07671327e+00
  7.85447927e+00  7.85447927e+00  7.85447927e+00  3.81323074e+01
  3.81323074e+01  3.81323074e+01  8.16310211e+01  1.63252016e+02
  1.63252016e+02  1.63252016e+02  5.61948727e+02  5.61948727e+02
  5.61948727e+02  5.66292265e+02  1.43069579e+03  1.43069579e+03
  1.43069579e+03  2.60147606e+03  3.12893504e+03  3.12893504e+03
  3.12893504e+03  6.74545991e+03  6.74545991e+03  6.74545991e+03
  9.00014146e+03  2.53620422e+04  7.61107914e+04]
E1 = -728.3651468625991  E_coul = 201.94970515867797
cycle= 5 E= -526.415441703921  delta_E= -1.68e-10  |g|= 7.06e-06  |ddm|= 2.56e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3651468625991  E_coul = 201.94970515867797
  HOMO = -0.56697810954517  LUMO = 1.0767105123816
  mo_energy =
[-1.18536053e+02 -1.21743023e+01 -9.52561536e+00 -9.52561536e+00
 -9.52561536e+00 -1.24473218e+00 -5.66978110e-01 -5.66978110e-01
 -5.66978110e-01  1.07671051e+00  1.07671051e+00  1.07671051e+00
  7.85447038e+00  7.85447038e+00  7.85447038e+00  3.81322943e+01
  3.81322943e+01  3.81322943e+01  8.16310055e+01  1.63252000e+02
  1.63252000e+02  1.63252000e+02  5.61948710e+02  5.61948710e+02
  5.61948710e+02  5.66292247e+02  1.43069577e+03  1.43069577e+03
  1.43069577e+03  2.60147604e+03  3.12893502e+03  3.12893502e+03
  3.12893502e+03  6.74545989e+03  6.74545989e+03  6.74545989e+03
  9.00014145e+03  2.53620422e+04  7.61107914e+04]
E1 = -728.3651798595421  E_coul = 201.9497381556165
Extra cycle  E= -526.415441703926  delta_E= -4.43e-12  |g|= 1.79e-06  |ddm|= 3.48e-06
    CPU time for scf_cycle      0.69 sec, wall time      0.31 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 145500.211910766
E1 = -728.3651798595421  E_coul = 201.9497381556165
init E= -526.415441703926
    CPU time for initialize scf      2.72 sec, wall time      0.26 sec
  HOMO = -0.566977492560962  LUMO = 1.07671099325479
  mo_energy =
[-1.18536049e+02 -1.21742998e+01 -9.52561288e+00 -9.52561288e+00
 -9.52561288e+00 -1.24473137e+00 -5.66977493e-01 -5.66977493e-01
 -5.66977493e-01  1.07671099e+00  1.07671099e+00  1.07671099e+00
  7.85447200e+00  7.85447200e+00  7.85447200e+00  3.81322969e+01
  3.81322969e+01  3.81322969e+01  8.16310089e+01  1.63252003e+02
  1.63252003e+02  1.63252003e+02  5.61948714e+02  5.61948714e+02
  5.61948714e+02  5.66292251e+02  1.43069578e+03  1.43069578e+03
  1.43069578e+03  2.60147604e+03  3.12893503e+03  3.12893503e+03
  3.12893503e+03  6.74545989e+03  6.74545989e+03  6.74545989e+03
  9.00014145e+03  2.53620422e+04  7.61107914e+04]
E1 = -728.3651731590214  E_coul = 201.9497314550963
cycle= 1 E= -526.415441703925  delta_E= 4.55e-13  |g|= 3.94e-07  |ddm|= 6.5e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3651731590214  E_coul = 201.9497314550963
  HOMO = -0.56697761057997  LUMO = 1.07671090079987
  mo_energy =
[-1.18536050e+02 -1.21743003e+01 -9.52561338e+00 -9.52561338e+00
 -9.52561338e+00 -1.24473152e+00 -5.66977611e-01 -5.66977611e-01
 -5.66977611e-01  1.07671090e+00  1.07671090e+00  1.07671090e+00
  7.85447168e+00  7.85447168e+00  7.85447168e+00  3.81322964e+01
  3.81322964e+01  3.81322964e+01  8.16310082e+01  1.63252003e+02
  1.63252003e+02  1.63252003e+02  5.61948713e+02  5.61948713e+02
  5.61948713e+02  5.66292250e+02  1.43069578e+03  1.43069578e+03
  1.43069578e+03  2.60147604e+03  3.12893503e+03  3.12893503e+03
  3.12893503e+03  6.74545989e+03  6.74545989e+03  6.74545989e+03
  9.00014145e+03  2.53620422e+04  7.61107914e+04]
E1 = -728.3651745407637  E_coul = 201.94973283683822
Extra cycle  E= -526.415441703926  delta_E= -4.55e-13  |g|= 8.38e-08  |ddm|= 1.31e-07
    CPU time for scf_cycle      2.87 sec, wall time      0.41 sec
exp = [2.61825392e+04 7.61784967e+03 3.61738475e+03 1.60555799e+03
 3.58413281e+02 1.14744009e+02 3.69061133e+01 4.59426124e+00
 4.02632927e-01 1.36276438e+03 6.64815398e+02 3.01312270e+02
 3.14375433e+02 8.56807779e+01 8.04760209e+00 2.38895853e+01
 7.99718883e-01 2.92667211e+00 2.30527776e-01]
grad_E = [-1.75822024e-06  7.14297448e-06  3.77932150e-06  2.00893930e-04
 -2.20087510e-03  7.32418331e-03 -8.84258710e-03  1.83712883e-03
  1.12932569e-01  7.53331743e-07  1.57434066e-06  1.09250680e-05
  1.14134043e-05  1.72620503e-03  1.24660189e-02 -8.67416301e-03
 -9.99056858e-03 -2.04484824e-02  7.19498988e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:42:52 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5404963        1
[INPUT] 0    0    [1    /1   ]  7617.83280667        1
[INPUT] 0    0    [1    /1   ]  3617.34861178        1
[INPUT] 0    0    [1    /1   ]  1605.02435915        1
[INPUT] 0    0    [1    /1   ]  363.568666287        1
[INPUT] 0    0    [1    /1   ]  116.638726626        1
[INPUT] 0    0    [1    /1   ]  37.6517303366        1
[INPUT] 0    0    [1    /1   ]  4.57890007711        1
[INPUT] 0    0    [1    /1   ]  0.396977553309       1
[INPUT] 1    0    [1    /1   ]  1362.76331487        1
[INPUT] 1    0    [1    /1   ]  664.801144418        1
[INPUT] 1    0    [1    /1   ]  301.234382131        1
[INPUT] 1    0    [1    /1   ]  314.306719908        1
[INPUT] 1    0    [1    /1   ]  86.7542474516        1
[INPUT] 1    0    [1    /1   ]  8.75008791989        1
[INPUT] 1    0    [1    /1   ]  25.3654706133        1
[INPUT] 1    0    [1    /1   ]  0.832386766421       1
[INPUT] 1    0    [1    /1   ]  3.21596399301        1
[INPUT] 1    0    [1    /1   ]  0.233376543249       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.54049625015, 1.0]], [0, [7617.832806667804, 1.0]], [0, [3617.348611782732, 1.0]], [0, [1605.0243591470905, 1.0]], [0, [363.56866628731, 1.0]], [0, [116.63872662629505, 1.0]], [0, [37.65173033656665, 1.0]], [0, [4.5789000771131825, 1.0]], [0, [0.3969775533087307, 1.0]], [1, [1362.7633148696634, 1.0]], [1, [664.8011444181913, 1.0]], [1, [301.2343821306944, 1.0]], [1, [314.3067199084954, 1.0]], [1, [86.75424745156057, 1.0]], [1, [8.750087919891623, 1.0]], [1, [25.365470613333194, 1.0]], [1, [0.8323867664213478, 1.0]], [1, [3.2159639930063944, 1.0]], [1, [0.2333765432485954, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.54049625]
bas 1, expnt(s) = [7617.83280667]
bas 2, expnt(s) = [3617.34861178]
bas 3, expnt(s) = [1605.02435915]
bas 4, expnt(s) = [363.56866629]
bas 5, expnt(s) = [116.63872663]
bas 6, expnt(s) = [37.65173034]
bas 7, expnt(s) = [4.57890008]
bas 8, expnt(s) = [0.39697755]
bas 9, expnt(s) = [1362.76331487]
bas 10, expnt(s) = [664.80114442]
bas 11, expnt(s) = [301.23438213]
bas 12, expnt(s) = [314.30671991]
bas 13, expnt(s) = [86.75424745]
bas 14, expnt(s) = [8.75008792]
bas 15, expnt(s) = [25.36547061]
bas 16, expnt(s) = [0.83238677]
bas 17, expnt(s) = [3.21596399]
bas 18, expnt(s) = [0.23337654]
CPU time:       468.66
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825405e+04 5.20024568e+03 7.61783281e+03 2.06010142e+03
 3.61734861e+03 1.17844087e+03 1.60502436e+03 6.40657988e+02
 3.63568666e+02 2.10355978e+02 1.16638727e+02 8.96699859e+01
 3.76517303e+01 3.84019899e+01 4.57890008e+00 7.90835031e+00
 3.96977553e-01 1.26354143e+00 1.36276331e+03 2.41551609e+04
 6.64801144e+02 9.84802382e+03 3.01234382e+02 3.66112930e+03
 3.14306720e+02 3.86079263e+03 8.67542475e+01 7.72409890e+02
 8.75008792e+00 4.39035778e+01 2.53654706e+01 1.66068800e+02
 8.32386766e-01 2.31948117e+00 3.21596399e+00 1.25638680e+01
 2.33376543e-01 4.73212160e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.974306987097094
cond(S) = 151335.6878586291
E1 = -728.7587473743903  E_coul = 203.13421515850757
init E= -525.624532215883
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558337715603105  LUMO = 1.12403870271863
  mo_energy =
[-1.18299070e+02 -1.21016064e+01 -9.44657332e+00 -9.44657332e+00
 -9.44657332e+00 -1.22951737e+00 -5.58337716e-01 -5.58337716e-01
 -5.58337716e-01  1.12403870e+00  1.12403870e+00  1.12403870e+00
  8.77942012e+00  8.77942012e+00  8.77942012e+00  4.21782295e+01
  4.21782295e+01  4.21782295e+01  8.39350453e+01  1.71850817e+02
  1.71850817e+02  1.71850817e+02  5.72709526e+02  5.72709526e+02
  5.72709526e+02  5.77619183e+02  1.44184079e+03  1.44184079e+03
  1.44184079e+03  2.62506725e+03  3.13980182e+03  3.13980182e+03
  3.13980182e+03  6.75562278e+03  6.75562278e+03  6.75562278e+03
  9.02704214e+03  2.53885902e+04  7.61358268e+04]
E1 = -728.0116514680049  E_coul = 201.5879034634075
cycle= 1 E= -526.423748004597  delta_E= -0.799  |g|= 0.19  |ddm|= 0.621
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.561407
diis-c [-0.3151778  1.       ]
  HOMO = -0.573757216006539  LUMO = 1.11336527834379
  mo_energy =
[-1.18580851e+02 -1.22019771e+01 -9.55380165e+00 -9.55380165e+00
 -9.55380165e+00 -1.25265594e+00 -5.73757216e-01 -5.73757216e-01
 -5.73757216e-01  1.11336528e+00  1.11336528e+00  1.11336528e+00
  8.71395191e+00  8.71395191e+00  8.71395191e+00  4.20465320e+01
  4.20465320e+01  4.20465320e+01  8.37585623e+01  1.71638531e+02
  1.71638531e+02  1.71638531e+02  5.72430723e+02  5.72430723e+02
  5.72430723e+02  5.77303424e+02  1.44150703e+03  1.44150703e+03
  1.44150703e+03  2.62460034e+03  3.13940387e+03  3.13940387e+03
  3.13940387e+03  6.75510953e+03  6.75510953e+03  6.75510953e+03
  9.02645155e+03  2.53879039e+04  7.61350490e+04]
E1 = -728.316690592458  E_coul = 201.89254870514563
cycle= 2 E= -526.424141887312  delta_E= -0.000394  |g|= 0.0247  |ddm|= 0.021
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0476168
diis-c [-0.00147151  0.04795266  0.95204734]
  HOMO = -0.569956092970153  LUMO = 1.11661806970281
  mo_energy =
[-1.18537141e+02 -1.21810657e+01 -9.53248143e+00 -9.53248143e+00
 -9.53248143e+00 -1.24759130e+00 -5.69956093e-01 -5.69956093e-01
 -5.69956093e-01  1.11661807e+00  1.11661807e+00  1.11661807e+00
  8.72684421e+00  8.72684421e+00  8.72684421e+00  4.20711447e+01
  4.20711447e+01  4.20711447e+01  8.37944040e+01  1.71675312e+02
  1.71675312e+02  1.71675312e+02  5.72474110e+02  5.72474110e+02
  5.72474110e+02  5.77348630e+02  1.44155322e+03  1.44155322e+03
  1.44155322e+03  2.62464884e+03  3.13945168e+03  3.13945168e+03
  3.13945168e+03  6.75515838e+03  6.75515838e+03  6.75515838e+03
  9.02650083e+03  2.53879533e+04  7.61350985e+04]
E1 = -728.253930575112  E_coul = 201.82977500282794
cycle= 3 E= -526.424155572284  delta_E= -1.37e-05  |g|= 0.00303  |ddm|= 0.00538
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00644246
diis-c [-3.42172046e-07 -1.03373109e-03  1.12722361e-01  8.88311370e-01]
  HOMO = -0.570643430599628  LUMO = 1.11604950250993
  mo_energy =
[-1.18542529e+02 -1.21840076e+01 -9.53552456e+00 -9.53552456e+00
 -9.53552456e+00 -1.24848703e+00 -5.70643431e-01 -5.70643431e-01
 -5.70643431e-01  1.11604950e+00  1.11604950e+00  1.11604950e+00
  8.72483283e+00  8.72483283e+00  8.72483283e+00  4.20677686e+01
  4.20677686e+01  4.20677686e+01  8.37899651e+01  1.71670660e+02
  1.71670660e+02  1.71670660e+02  5.72468766e+02  5.72468766e+02
  5.72468766e+02  5.77343063e+02  1.44154754e+03  1.44154754e+03
  1.44154754e+03  2.62464277e+03  3.13944576e+03  3.13944576e+03
  3.13944576e+03  6.75515222e+03  6.75515222e+03  6.75515222e+03
  9.02649454e+03  2.53879469e+04  7.61350920e+04]
E1 = -728.2624985908875  E_coul = 201.83834271090865
cycle= 4 E= -526.424155879979  delta_E= -3.08e-07  |g|= 4.5e-05  |ddm|= 0.000796
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=6.17846e-05
diis-c [-1.70165266e-09 -5.84848013e-08 -8.56485025e-04  8.18815453e-04
  1.00003773e+00]
  HOMO = -0.570614776640191  LUMO = 1.11607251567148
  mo_energy =
[-1.18542427e+02 -1.21839149e+01 -9.53543238e+00 -9.53543238e+00
 -9.53543238e+00 -1.24844970e+00 -5.70614777e-01 -5.70614777e-01
 -5.70614777e-01  1.11607252e+00  1.11607252e+00  1.11607252e+00
  8.72490328e+00  8.72490328e+00  8.72490328e+00  4.20678605e+01
  4.20678605e+01  4.20678605e+01  8.37900688e+01  1.71670760e+02
  1.71670760e+02  1.71670760e+02  5.72468867e+02  5.72468867e+02
  5.72468867e+02  5.77343162e+02  1.44154764e+03  1.44154764e+03
  1.44154764e+03  2.62464286e+03  3.13944585e+03  3.13944585e+03
  3.13944585e+03  6.75515231e+03  6.75515231e+03  6.75515231e+03
  9.02649463e+03  2.53879470e+04  7.61350921e+04]
E1 = -728.2622761334275  E_coul = 201.83812025328496
cycle= 5 E= -526.424155880143  delta_E= -1.64e-10  |g|= 7.06e-06  |ddm|= 2.56e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.2622761334275  E_coul = 201.83812025328496
  HOMO = -0.570618408388732  LUMO = 1.11606958183889
  mo_energy =
[-1.18542445e+02 -1.21839275e+01 -9.53544530e+00 -9.53544530e+00
 -9.53544530e+00 -1.24845442e+00 -5.70618408e-01 -5.70618408e-01
 -5.70618408e-01  1.11606958e+00  1.11606958e+00  1.11606958e+00
  8.72489388e+00  8.72489388e+00  8.72489388e+00  4.20678470e+01
  4.20678470e+01  4.20678470e+01  8.37900530e+01  1.71670744e+02
  1.71670744e+02  1.71670744e+02  5.72468849e+02  5.72468849e+02
  5.72468849e+02  5.77343144e+02  1.44154762e+03  1.44154762e+03
  1.44154762e+03  2.62464284e+03  3.13944584e+03  3.13944584e+03
  3.13944584e+03  6.75515230e+03  6.75515230e+03  6.75515230e+03
  9.02649461e+03  2.53879470e+04  7.61350921e+04]
E1 = -728.2623094398162  E_coul = 201.8381535596699
Extra cycle  E= -526.424155880146  delta_E= -3.87e-12  |g|= 1.79e-06  |ddm|= 3.54e-06
    CPU time for scf_cycle      0.67 sec, wall time      0.28 sec
exp = [2.61825405e+04 7.61783281e+03 3.61734861e+03 1.60502436e+03
 3.63568666e+02 1.16638727e+02 3.76517303e+01 4.57890008e+00
 3.96977553e-01 1.36276331e+03 6.64801144e+02 3.01234382e+02
 3.14306720e+02 8.67542475e+01 8.75008792e+00 2.53654706e+01
 8.32386766e-01 3.21596399e+00 2.33376543e-01]
E = -526.4241558801464
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:42:52 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5404963        1
[INPUT] 0    0    [1    /1   ]  7617.83280667        1
[INPUT] 0    0    [1    /1   ]  3617.34861178        1
[INPUT] 0    0    [1    /1   ]  1605.02435915        1
[INPUT] 0    0    [1    /1   ]  363.568666287        1
[INPUT] 0    0    [1    /1   ]  116.638726626        1
[INPUT] 0    0    [1    /1   ]  37.6517303366        1
[INPUT] 0    0    [1    /1   ]  4.57890007711        1
[INPUT] 0    0    [1    /1   ]  0.396977553309       1
[INPUT] 1    0    [1    /1   ]  1362.76331487        1
[INPUT] 1    0    [1    /1   ]  664.801144418        1
[INPUT] 1    0    [1    /1   ]  301.234382131        1
[INPUT] 1    0    [1    /1   ]  314.306719908        1
[INPUT] 1    0    [1    /1   ]  86.7542474516        1
[INPUT] 1    0    [1    /1   ]  8.75008791989        1
[INPUT] 1    0    [1    /1   ]  25.3654706133        1
[INPUT] 1    0    [1    /1   ]  0.832386766421       1
[INPUT] 1    0    [1    /1   ]  3.21596399301        1
[INPUT] 1    0    [1    /1   ]  0.233376543249       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.54049625015, 1.0]], [0, [7617.832806667804, 1.0]], [0, [3617.348611782732, 1.0]], [0, [1605.0243591470905, 1.0]], [0, [363.56866628731, 1.0]], [0, [116.63872662629505, 1.0]], [0, [37.65173033656665, 1.0]], [0, [4.5789000771131825, 1.0]], [0, [0.3969775533087307, 1.0]], [1, [1362.7633148696634, 1.0]], [1, [664.8011444181913, 1.0]], [1, [301.2343821306944, 1.0]], [1, [314.3067199084954, 1.0]], [1, [86.75424745156057, 1.0]], [1, [8.750087919891623, 1.0]], [1, [25.365470613333194, 1.0]], [1, [0.8323867664213478, 1.0]], [1, [3.2159639930063944, 1.0]], [1, [0.2333765432485954, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.54049625]
bas 1, expnt(s) = [7617.83280667]
bas 2, expnt(s) = [3617.34861178]
bas 3, expnt(s) = [1605.02435915]
bas 4, expnt(s) = [363.56866629]
bas 5, expnt(s) = [116.63872663]
bas 6, expnt(s) = [37.65173034]
bas 7, expnt(s) = [4.57890008]
bas 8, expnt(s) = [0.39697755]
bas 9, expnt(s) = [1362.76331487]
bas 10, expnt(s) = [664.80114442]
bas 11, expnt(s) = [301.23438213]
bas 12, expnt(s) = [314.30671991]
bas 13, expnt(s) = [86.75424745]
bas 14, expnt(s) = [8.75008792]
bas 15, expnt(s) = [25.36547061]
bas 16, expnt(s) = [0.83238677]
bas 17, expnt(s) = [3.21596399]
bas 18, expnt(s) = [0.23337654]
CPU time:       469.52
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825405e+04 5.20024568e+03 7.61783281e+03 2.06010142e+03
 3.61734861e+03 1.17844087e+03 1.60502436e+03 6.40657988e+02
 3.63568666e+02 2.10355978e+02 1.16638727e+02 8.96699859e+01
 3.76517303e+01 3.84019899e+01 4.57890008e+00 7.90835031e+00
 3.96977553e-01 1.26354143e+00 1.36276331e+03 2.41551609e+04
 6.64801144e+02 9.84802382e+03 3.01234382e+02 3.66112930e+03
 3.14306720e+02 3.86079263e+03 8.67542475e+01 7.72409890e+02
 8.75008792e+00 4.39035778e+01 2.53654706e+01 1.66068800e+02
 8.32386766e-01 2.31948117e+00 3.21596399e+00 1.25638680e+01
 2.33376543e-01 4.73212160e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.974306987097094
cond(S) = 151335.6878586291
E1 = -728.7587473743903  E_coul = 203.13421515850757
init E= -525.624532215883
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558337715603105  LUMO = 1.12403870271863
  mo_energy =
[-1.18299070e+02 -1.21016064e+01 -9.44657332e+00 -9.44657332e+00
 -9.44657332e+00 -1.22951737e+00 -5.58337716e-01 -5.58337716e-01
 -5.58337716e-01  1.12403870e+00  1.12403870e+00  1.12403870e+00
  8.77942012e+00  8.77942012e+00  8.77942012e+00  4.21782295e+01
  4.21782295e+01  4.21782295e+01  8.39350453e+01  1.71850817e+02
  1.71850817e+02  1.71850817e+02  5.72709526e+02  5.72709526e+02
  5.72709526e+02  5.77619183e+02  1.44184079e+03  1.44184079e+03
  1.44184079e+03  2.62506725e+03  3.13980182e+03  3.13980182e+03
  3.13980182e+03  6.75562278e+03  6.75562278e+03  6.75562278e+03
  9.02704214e+03  2.53885902e+04  7.61358268e+04]
E1 = -728.0116514680049  E_coul = 201.5879034634075
cycle= 1 E= -526.423748004597  delta_E= -0.799  |g|= 0.19  |ddm|= 0.621
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.561407
diis-c [-0.3151778  1.       ]
  HOMO = -0.573757216006539  LUMO = 1.11336527834379
  mo_energy =
[-1.18580851e+02 -1.22019771e+01 -9.55380165e+00 -9.55380165e+00
 -9.55380165e+00 -1.25265594e+00 -5.73757216e-01 -5.73757216e-01
 -5.73757216e-01  1.11336528e+00  1.11336528e+00  1.11336528e+00
  8.71395191e+00  8.71395191e+00  8.71395191e+00  4.20465320e+01
  4.20465320e+01  4.20465320e+01  8.37585623e+01  1.71638531e+02
  1.71638531e+02  1.71638531e+02  5.72430723e+02  5.72430723e+02
  5.72430723e+02  5.77303424e+02  1.44150703e+03  1.44150703e+03
  1.44150703e+03  2.62460034e+03  3.13940387e+03  3.13940387e+03
  3.13940387e+03  6.75510953e+03  6.75510953e+03  6.75510953e+03
  9.02645155e+03  2.53879039e+04  7.61350490e+04]
E1 = -728.316690592458  E_coul = 201.89254870514563
cycle= 2 E= -526.424141887312  delta_E= -0.000394  |g|= 0.0247  |ddm|= 0.021
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0476168
diis-c [-0.00147151  0.04795266  0.95204734]
  HOMO = -0.569956092970153  LUMO = 1.11661806970281
  mo_energy =
[-1.18537141e+02 -1.21810657e+01 -9.53248143e+00 -9.53248143e+00
 -9.53248143e+00 -1.24759130e+00 -5.69956093e-01 -5.69956093e-01
 -5.69956093e-01  1.11661807e+00  1.11661807e+00  1.11661807e+00
  8.72684421e+00  8.72684421e+00  8.72684421e+00  4.20711447e+01
  4.20711447e+01  4.20711447e+01  8.37944040e+01  1.71675312e+02
  1.71675312e+02  1.71675312e+02  5.72474110e+02  5.72474110e+02
  5.72474110e+02  5.77348630e+02  1.44155322e+03  1.44155322e+03
  1.44155322e+03  2.62464884e+03  3.13945168e+03  3.13945168e+03
  3.13945168e+03  6.75515838e+03  6.75515838e+03  6.75515838e+03
  9.02650083e+03  2.53879533e+04  7.61350985e+04]
E1 = -728.253930575112  E_coul = 201.82977500282794
cycle= 3 E= -526.424155572284  delta_E= -1.37e-05  |g|= 0.00303  |ddm|= 0.00538
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00644246
diis-c [-3.42172046e-07 -1.03373109e-03  1.12722361e-01  8.88311370e-01]
  HOMO = -0.570643430599628  LUMO = 1.11604950250993
  mo_energy =
[-1.18542529e+02 -1.21840076e+01 -9.53552456e+00 -9.53552456e+00
 -9.53552456e+00 -1.24848703e+00 -5.70643431e-01 -5.70643431e-01
 -5.70643431e-01  1.11604950e+00  1.11604950e+00  1.11604950e+00
  8.72483283e+00  8.72483283e+00  8.72483283e+00  4.20677686e+01
  4.20677686e+01  4.20677686e+01  8.37899651e+01  1.71670660e+02
  1.71670660e+02  1.71670660e+02  5.72468766e+02  5.72468766e+02
  5.72468766e+02  5.77343063e+02  1.44154754e+03  1.44154754e+03
  1.44154754e+03  2.62464277e+03  3.13944576e+03  3.13944576e+03
  3.13944576e+03  6.75515222e+03  6.75515222e+03  6.75515222e+03
  9.02649454e+03  2.53879469e+04  7.61350920e+04]
E1 = -728.2624985908875  E_coul = 201.83834271090865
cycle= 4 E= -526.424155879979  delta_E= -3.08e-07  |g|= 4.5e-05  |ddm|= 0.000796
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=6.17846e-05
diis-c [-1.70165266e-09 -5.84848013e-08 -8.56485025e-04  8.18815453e-04
  1.00003773e+00]
  HOMO = -0.570614776640191  LUMO = 1.11607251567148
  mo_energy =
[-1.18542427e+02 -1.21839149e+01 -9.53543238e+00 -9.53543238e+00
 -9.53543238e+00 -1.24844970e+00 -5.70614777e-01 -5.70614777e-01
 -5.70614777e-01  1.11607252e+00  1.11607252e+00  1.11607252e+00
  8.72490328e+00  8.72490328e+00  8.72490328e+00  4.20678605e+01
  4.20678605e+01  4.20678605e+01  8.37900688e+01  1.71670760e+02
  1.71670760e+02  1.71670760e+02  5.72468867e+02  5.72468867e+02
  5.72468867e+02  5.77343162e+02  1.44154764e+03  1.44154764e+03
  1.44154764e+03  2.62464286e+03  3.13944585e+03  3.13944585e+03
  3.13944585e+03  6.75515231e+03  6.75515231e+03  6.75515231e+03
  9.02649463e+03  2.53879470e+04  7.61350921e+04]
E1 = -728.2622761334275  E_coul = 201.83812025328496
cycle= 5 E= -526.424155880143  delta_E= -1.64e-10  |g|= 7.06e-06  |ddm|= 2.56e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.2622761334275  E_coul = 201.83812025328496
  HOMO = -0.570618408388732  LUMO = 1.11606958183889
  mo_energy =
[-1.18542445e+02 -1.21839275e+01 -9.53544530e+00 -9.53544530e+00
 -9.53544530e+00 -1.24845442e+00 -5.70618408e-01 -5.70618408e-01
 -5.70618408e-01  1.11606958e+00  1.11606958e+00  1.11606958e+00
  8.72489388e+00  8.72489388e+00  8.72489388e+00  4.20678470e+01
  4.20678470e+01  4.20678470e+01  8.37900530e+01  1.71670744e+02
  1.71670744e+02  1.71670744e+02  5.72468849e+02  5.72468849e+02
  5.72468849e+02  5.77343144e+02  1.44154762e+03  1.44154762e+03
  1.44154762e+03  2.62464284e+03  3.13944584e+03  3.13944584e+03
  3.13944584e+03  6.75515230e+03  6.75515230e+03  6.75515230e+03
  9.02649461e+03  2.53879470e+04  7.61350921e+04]
E1 = -728.2623094398162  E_coul = 201.8381535596699
Extra cycle  E= -526.424155880146  delta_E= -3.87e-12  |g|= 1.79e-06  |ddm|= 3.54e-06
    CPU time for scf_cycle      0.67 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 151335.6878586291
E1 = -728.2623094398162  E_coul = 201.8381535596699
init E= -526.424155880146
    CPU time for initialize scf      2.72 sec, wall time      0.25 sec
  HOMO = -0.570617783145674  LUMO = 1.11607009388379
  mo_energy =
[-1.18542441e+02 -1.21839251e+01 -9.53544279e+00 -9.53544279e+00
 -9.53544279e+00 -1.24845360e+00 -5.70617783e-01 -5.70617783e-01
 -5.70617783e-01  1.11607009e+00  1.11607009e+00  1.11607009e+00
  8.72489561e+00  8.72489561e+00  8.72489561e+00  4.20678497e+01
  4.20678497e+01  4.20678497e+01  8.37900564e+01  1.71670747e+02
  1.71670747e+02  1.71670747e+02  5.72468853e+02  5.72468853e+02
  5.72468853e+02  5.77343148e+02  1.44154763e+03  1.44154763e+03
  1.44154763e+03  2.62464284e+03  3.13944584e+03  3.13944584e+03
  3.13944584e+03  6.75515230e+03  6.75515230e+03  6.75515230e+03
  9.02649461e+03  2.53879470e+04  7.61350921e+04]
E1 = -728.2623026612614  E_coul = 201.83814678111486
cycle= 1 E= -526.424155880147  delta_E= -2.27e-13  |g|= 3.95e-07  |ddm|= 6.67e-07
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
E1 = -728.2623026612614  E_coul = 201.83814678111486
  HOMO = -0.5706179031249  LUMO = 1.11606999506293
  mo_energy =
[-1.18542442e+02 -1.21839256e+01 -9.53544330e+00 -9.53544330e+00
 -9.53544330e+00 -1.24845376e+00 -5.70617903e-01 -5.70617903e-01
 -5.70617903e-01  1.11607000e+00  1.11607000e+00  1.11607000e+00
  8.72489527e+00  8.72489527e+00  8.72489527e+00  4.20678492e+01
  4.20678492e+01  4.20678492e+01  8.37900557e+01  1.71670747e+02
  1.71670747e+02  1.71670747e+02  5.72468853e+02  5.72468853e+02
  5.72468853e+02  5.77343147e+02  1.44154763e+03  1.44154763e+03
  1.44154763e+03  2.62464284e+03  3.13944584e+03  3.13944584e+03
  3.13944584e+03  6.75515230e+03  6.75515230e+03  6.75515230e+03
  9.02649461e+03  2.53879470e+04  7.61350921e+04]
E1 = -728.2623040605353  E_coul = 201.8381481803885
Extra cycle  E= -526.424155880147  delta_E= -2.27e-13  |g|= 8.42e-08  |ddm|= 1.34e-07
    CPU time for scf_cycle      2.86 sec, wall time      0.39 sec
exp = [2.61825405e+04 7.61783281e+03 3.61734861e+03 1.60502436e+03
 3.63568666e+02 1.16638727e+02 3.76517303e+01 4.57890008e+00
 3.96977553e-01 1.36276331e+03 6.64801144e+02 3.01234382e+02
 3.14306720e+02 8.67542475e+01 8.75008792e+00 2.53654706e+01
 8.32386766e-01 3.21596399e+00 2.33376543e-01]
grad_E = [-1.73361403e-06  6.61919960e-06  2.81543711e-06  1.83170949e-04
 -1.92391838e-03  6.10812732e-03 -4.63120264e-03 -9.74639316e-03
  2.62699599e-02  2.87000672e-07  6.40151764e-07  4.91443427e-06
  5.51182656e-06  1.10784995e-03  8.58520037e-03 -5.21041203e-03
  2.86484326e-02 -9.75954931e-03 -6.10498638e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:42:57 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5402625        1
[INPUT] 0    0    [1    /1   ]  7617.83610648        1
[INPUT] 0    0    [1    /1   ]  3617.35603261        1
[INPUT] 0    0    [1    /1   ]  1605.12910669        1
[INPUT] 0    0    [1    /1   ]  362.637273122        1
[INPUT] 0    0    [1    /1   ]  115.81595576         1
[INPUT] 0    0    [1    /1   ]  37.4614473916        1
[INPUT] 0    0    [1    /1   ]  4.57793595543        1
[INPUT] 0    0    [1    /1   ]  0.393107812249       1
[INPUT] 1    0    [1    /1   ]  1362.76367515        1
[INPUT] 1    0    [1    /1   ]  664.805152721        1
[INPUT] 1    0    [1    /1   ]  301.256874814        1
[INPUT] 1    0    [1    /1   ]  314.32652858         1
[INPUT] 1    0    [1    /1   ]  86.0115734868        1
[INPUT] 1    0    [1    /1   ]  9.25505834553        1
[INPUT] 1    0    [1    /1   ]  26.3483063614        1
[INPUT] 1    0    [1    /1   ]  0.8429779196         1
[INPUT] 1    0    [1    /1   ]  3.41979264866        1
[INPUT] 1    0    [1    /1   ]  0.236009803967       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.54026247065, 1.0]], [0, [7617.836106478727, 1.0]], [0, [3617.3560326136994, 1.0]], [0, [1605.129106687739, 1.0]], [0, [362.6372731216204, 1.0]], [0, [115.8159557599343, 1.0]], [0, [37.46144739159963, 1.0]], [0, [4.577935955427301, 1.0]], [0, [0.3931078122486224, 1.0]], [1, [1362.7636751493542, 1.0]], [1, [664.8051527213063, 1.0]], [1, [301.2568748137086, 1.0]], [1, [314.3265285799939, 1.0]], [1, [86.0115734867957, 1.0]], [1, [9.255058345534428, 1.0]], [1, [26.348306361353295, 1.0]], [1, [0.8429779195995812, 1.0]], [1, [3.419792648655958, 1.0]], [1, [0.23600980396705926, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.54026247]
bas 1, expnt(s) = [7617.83610648]
bas 2, expnt(s) = [3617.35603261]
bas 3, expnt(s) = [1605.12910669]
bas 4, expnt(s) = [362.63727312]
bas 5, expnt(s) = [115.81595576]
bas 6, expnt(s) = [37.46144739]
bas 7, expnt(s) = [4.57793596]
bas 8, expnt(s) = [0.39310781]
bas 9, expnt(s) = [1362.76367515]
bas 10, expnt(s) = [664.80515272]
bas 11, expnt(s) = [301.25687481]
bas 12, expnt(s) = [314.32652858]
bas 13, expnt(s) = [86.01157349]
bas 14, expnt(s) = [9.25505835]
bas 15, expnt(s) = [26.34830636]
bas 16, expnt(s) = [0.84297792]
bas 17, expnt(s) = [3.41979265]
bas 18, expnt(s) = [0.2360098]
CPU time:       477.72
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825403e+04 5.20024565e+03 7.61783611e+03 2.06010209e+03
 3.61735603e+03 1.17844269e+03 1.60512911e+03 6.40689345e+02
 3.62637273e+02 2.09951680e+02 1.15815956e+02 8.91951666e+01
 3.74614474e+01 3.82563418e+01 4.57793596e+00 7.90710141e+00
 3.93107812e-01 1.25429237e+00 1.36276368e+03 2.41551689e+04
 6.64805153e+02 9.84809804e+03 3.01256875e+02 3.66147102e+03
 3.14326529e+02 3.86109678e+03 8.60115735e+01 7.64153327e+02
 9.25505835e+00 4.70932154e+01 2.63483064e+01 1.74150720e+02
 8.42977920e-01 2.35643053e+00 3.41979265e+00 1.35670089e+01
 2.36009804e-01 4.79895799e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97419904336969
cond(S) = 152652.9390616935
E1 = -728.700866478984  E_coul = 203.07570836978581
init E= -525.625158109198
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.55987391882116  LUMO = 1.14510585238093
  mo_energy =
[-1.18304806e+02 -1.21057215e+01 -9.45161932e+00 -9.45161932e+00
 -9.45161932e+00 -1.23118771e+00 -5.59873919e-01 -5.59873919e-01
 -5.59873919e-01  1.14510585e+00  1.14510585e+00  1.14510585e+00
  9.37547473e+00  9.37547473e+00  9.37547473e+00  4.49009970e+01
  4.49009970e+01  4.49009970e+01  8.31962214e+01  1.76384335e+02
  1.76384335e+02  1.76384335e+02  5.74212302e+02  5.76353501e+02
  5.76353501e+02  5.76353501e+02  1.44465126e+03  1.44465126e+03
  1.44465126e+03  2.61893785e+03  3.14220514e+03  3.14220514e+03
  3.14220514e+03  6.75775087e+03  6.75775087e+03  6.75775087e+03
  9.02034927e+03  2.53820547e+04  7.61297010e+04]
E1 = -727.9963191950952  E_coul = 201.56844335072714
cycle= 1 E= -526.427875844368  delta_E= -0.803  |g|= 0.189  |ddm|= 0.512
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.56158
diis-c [-0.3153726  1.       ]
  HOMO = -0.574518934078581  LUMO = 1.13467277102154
  mo_energy =
[-1.18581752e+02 -1.22031916e+01 -9.55614606e+00 -9.55614606e+00
 -9.55614606e+00 -1.25300999e+00 -5.74518934e-01 -5.74518934e-01
 -5.74518934e-01  1.13467277e+00  1.13467277e+00  1.13467277e+00
  9.30907356e+00  9.30907356e+00  9.30907356e+00  4.47696845e+01
  4.47696845e+01  4.47696845e+01  8.30247500e+01  1.76176877e+02
  1.76176877e+02  1.76176877e+02  5.73901772e+02  5.76079838e+02
  5.76079838e+02  5.76079838e+02  1.44432257e+03  1.44432257e+03
  1.44432257e+03  2.61847559e+03  3.14181201e+03  3.14181201e+03
  3.14181201e+03  6.75724218e+03  6.75724218e+03  6.75724218e+03
  9.01976300e+03  2.53813726e+04  7.61289274e+04]
E1 = -728.294741062252  E_coul = 201.8664803388734
cycle= 2 E= -526.428260723379  delta_E= -0.000385  |g|= 0.0243  |ddm|= 0.0208
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0470745
diis-c [-0.00144426  0.04723951  0.95276049]
  HOMO = -0.570813089387109  LUMO = 1.13792137392187
  mo_energy =
[-1.18538803e+02 -1.21827273e+01 -9.53528904e+00 -9.53528904e+00
 -9.53528904e+00 -1.24810243e+00 -5.70813089e-01 -5.70813089e-01
 -5.70813089e-01  1.13792137e+00  1.13792137e+00  1.13792137e+00
  9.32221999e+00  9.32221999e+00  9.32221999e+00  4.47942501e+01
  4.47942501e+01  4.47942501e+01  8.30598870e+01  1.76212956e+02
  1.76212956e+02  1.76212956e+02  5.73946172e+02  5.76122420e+02
  5.76122420e+02  5.76122420e+02  1.44436794e+03  1.44436794e+03
  1.44436794e+03  2.61852324e+03  3.14185898e+03  3.14185898e+03
  3.14185898e+03  6.75729016e+03  6.75729016e+03  6.75729016e+03
  9.01981140e+03  2.53814212e+04  7.61289760e+04]
E1 = -728.2337036694447  E_coul = 201.80542986715213
cycle= 3 E= -526.428273802293  delta_E= -1.31e-05  |g|= 0.00297  |ddm|= 0.00526
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00636701
diis-c [-3.46548305e-07 -1.04083761e-03  1.12569025e-01  8.88471813e-01]
  HOMO = -0.571480685806697  LUMO = 1.13735678832028
  mo_energy =
[-1.18544080e+02 -1.21855961e+01 -9.53825876e+00 -9.53825876e+00
 -9.53825876e+00 -1.24896858e+00 -5.71480686e-01 -5.71480686e-01
 -5.71480686e-01  1.13735679e+00  1.13735679e+00  1.13735679e+00
  9.32018979e+00  9.32018979e+00  9.32018979e+00  4.47909034e+01
  4.47909034e+01  4.47909034e+01  8.30555556e+01  1.76208408e+02
  1.76208408e+02  1.76208408e+02  5.73940720e+02  5.76117191e+02
  5.76117191e+02  5.76117191e+02  1.44436237e+03  1.44436237e+03
  1.44436237e+03  2.61851728e+03  3.14185318e+03  3.14185318e+03
  3.14185318e+03  6.75728412e+03  6.75728412e+03  6.75728412e+03
  9.01980522e+03  2.53814149e+04  7.61289696e+04]
E1 = -728.2420232057981  E_coul = 201.81374911111885
cycle= 4 E= -526.428274094679  delta_E= -2.92e-07  |g|= 4.37e-05  |ddm|= 0.000778
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.92778e-05
diis-c [-1.67515240e-09  3.66106871e-06 -1.28824415e-03 -2.96852108e-03
  1.00425310e+00]
  HOMO = -0.571452687571457  LUMO = 1.13737974021695
  mo_energy =
[-1.18543981e+02 -1.21855058e+01 -9.53816910e+00 -9.53816910e+00
 -9.53816910e+00 -1.24893230e+00 -5.71452688e-01 -5.71452688e-01
 -5.71452688e-01  1.13737974e+00  1.13737974e+00  1.13737974e+00
  9.32026016e+00  9.32026016e+00  9.32026016e+00  4.47909933e+01
  4.47909933e+01  4.47909933e+01  8.30556565e+01  1.76208506e+02
  1.76208506e+02  1.76208506e+02  5.73940816e+02  5.76117289e+02
  5.76117289e+02  5.76117289e+02  1.44436247e+03  1.44436247e+03
  1.44436247e+03  2.61851736e+03  3.14185327e+03  3.14185327e+03
  3.14185327e+03  6.75728420e+03  6.75728420e+03  6.75728420e+03
  9.01980531e+03  2.53814149e+04  7.61289697e+04]
E1 = -728.2418093900615  E_coul = 201.81353529523216
cycle= 5 E= -526.428274094829  delta_E= -1.5e-10  |g|= 7.06e-06  |ddm|= 2.47e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.2418093900615  E_coul = 201.81353529523216
  HOMO = -0.571456334067997  LUMO = 1.13737673336194
  mo_energy =
[-1.18543999e+02 -1.21855185e+01 -9.53818209e+00 -9.53818209e+00
 -9.53818209e+00 -1.24893702e+00 -5.71456334e-01 -5.71456334e-01
 -5.71456334e-01  1.13737673e+00  1.13737673e+00  1.13737673e+00
  9.32025044e+00  9.32025044e+00  9.32025044e+00  4.47909797e+01
  4.47909797e+01  4.47909797e+01  8.30556407e+01  1.76208490e+02
  1.76208490e+02  1.76208490e+02  5.73940798e+02  5.76117272e+02
  5.76117272e+02  5.76117272e+02  1.44436245e+03  1.44436245e+03
  1.44436245e+03  2.61851735e+03  3.14185325e+03  3.14185325e+03
  3.14185325e+03  6.75728418e+03  6.75728418e+03  6.75728418e+03
  9.01980529e+03  2.53814149e+04  7.61289697e+04]
E1 = -728.2418425665097  E_coul = 201.81356847167763
Extra cycle  E= -526.428274094832  delta_E= -2.84e-12  |g|= 1.78e-06  |ddm|= 3.56e-06
    CPU time for scf_cycle      0.67 sec, wall time      0.28 sec
exp = [2.61825403e+04 7.61783611e+03 3.61735603e+03 1.60512911e+03
 3.62637273e+02 1.15815956e+02 3.74614474e+01 4.57793596e+00
 3.93107812e-01 1.36276368e+03 6.64805153e+02 3.01256875e+02
 3.14326529e+02 8.60115735e+01 9.25505835e+00 2.63483064e+01
 8.42977920e-01 3.41979265e+00 2.36009804e-01]
E = -526.4282740948321
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:42:57 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5402625        1
[INPUT] 0    0    [1    /1   ]  7617.83610648        1
[INPUT] 0    0    [1    /1   ]  3617.35603261        1
[INPUT] 0    0    [1    /1   ]  1605.12910669        1
[INPUT] 0    0    [1    /1   ]  362.637273122        1
[INPUT] 0    0    [1    /1   ]  115.81595576         1
[INPUT] 0    0    [1    /1   ]  37.4614473916        1
[INPUT] 0    0    [1    /1   ]  4.57793595543        1
[INPUT] 0    0    [1    /1   ]  0.393107812249       1
[INPUT] 1    0    [1    /1   ]  1362.76367515        1
[INPUT] 1    0    [1    /1   ]  664.805152721        1
[INPUT] 1    0    [1    /1   ]  301.256874814        1
[INPUT] 1    0    [1    /1   ]  314.32652858         1
[INPUT] 1    0    [1    /1   ]  86.0115734868        1
[INPUT] 1    0    [1    /1   ]  9.25505834553        1
[INPUT] 1    0    [1    /1   ]  26.3483063614        1
[INPUT] 1    0    [1    /1   ]  0.8429779196         1
[INPUT] 1    0    [1    /1   ]  3.41979264866        1
[INPUT] 1    0    [1    /1   ]  0.236009803967       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.54026247065, 1.0]], [0, [7617.836106478727, 1.0]], [0, [3617.3560326136994, 1.0]], [0, [1605.129106687739, 1.0]], [0, [362.6372731216204, 1.0]], [0, [115.8159557599343, 1.0]], [0, [37.46144739159963, 1.0]], [0, [4.577935955427301, 1.0]], [0, [0.3931078122486224, 1.0]], [1, [1362.7636751493542, 1.0]], [1, [664.8051527213063, 1.0]], [1, [301.2568748137086, 1.0]], [1, [314.3265285799939, 1.0]], [1, [86.0115734867957, 1.0]], [1, [9.255058345534428, 1.0]], [1, [26.348306361353295, 1.0]], [1, [0.8429779195995812, 1.0]], [1, [3.419792648655958, 1.0]], [1, [0.23600980396705926, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.54026247]
bas 1, expnt(s) = [7617.83610648]
bas 2, expnt(s) = [3617.35603261]
bas 3, expnt(s) = [1605.12910669]
bas 4, expnt(s) = [362.63727312]
bas 5, expnt(s) = [115.81595576]
bas 6, expnt(s) = [37.46144739]
bas 7, expnt(s) = [4.57793596]
bas 8, expnt(s) = [0.39310781]
bas 9, expnt(s) = [1362.76367515]
bas 10, expnt(s) = [664.80515272]
bas 11, expnt(s) = [301.25687481]
bas 12, expnt(s) = [314.32652858]
bas 13, expnt(s) = [86.01157349]
bas 14, expnt(s) = [9.25505835]
bas 15, expnt(s) = [26.34830636]
bas 16, expnt(s) = [0.84297792]
bas 17, expnt(s) = [3.41979265]
bas 18, expnt(s) = [0.2360098]
CPU time:       478.59
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825403e+04 5.20024565e+03 7.61783611e+03 2.06010209e+03
 3.61735603e+03 1.17844269e+03 1.60512911e+03 6.40689345e+02
 3.62637273e+02 2.09951680e+02 1.15815956e+02 8.91951666e+01
 3.74614474e+01 3.82563418e+01 4.57793596e+00 7.90710141e+00
 3.93107812e-01 1.25429237e+00 1.36276368e+03 2.41551689e+04
 6.64805153e+02 9.84809804e+03 3.01256875e+02 3.66147102e+03
 3.14326529e+02 3.86109678e+03 8.60115735e+01 7.64153327e+02
 9.25505835e+00 4.70932154e+01 2.63483064e+01 1.74150720e+02
 8.42977920e-01 2.35643053e+00 3.41979265e+00 1.35670089e+01
 2.36009804e-01 4.79895799e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97419904336969
cond(S) = 152652.9390616935
E1 = -728.700866478984  E_coul = 203.07570836978581
init E= -525.625158109198
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.55987391882116  LUMO = 1.14510585238093
  mo_energy =
[-1.18304806e+02 -1.21057215e+01 -9.45161932e+00 -9.45161932e+00
 -9.45161932e+00 -1.23118771e+00 -5.59873919e-01 -5.59873919e-01
 -5.59873919e-01  1.14510585e+00  1.14510585e+00  1.14510585e+00
  9.37547473e+00  9.37547473e+00  9.37547473e+00  4.49009970e+01
  4.49009970e+01  4.49009970e+01  8.31962214e+01  1.76384335e+02
  1.76384335e+02  1.76384335e+02  5.74212302e+02  5.76353501e+02
  5.76353501e+02  5.76353501e+02  1.44465126e+03  1.44465126e+03
  1.44465126e+03  2.61893785e+03  3.14220514e+03  3.14220514e+03
  3.14220514e+03  6.75775087e+03  6.75775087e+03  6.75775087e+03
  9.02034927e+03  2.53820547e+04  7.61297010e+04]
E1 = -727.9963191950952  E_coul = 201.56844335072714
cycle= 1 E= -526.427875844368  delta_E= -0.803  |g|= 0.189  |ddm|= 0.512
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.56158
diis-c [-0.3153726  1.       ]
  HOMO = -0.574518934078581  LUMO = 1.13467277102154
  mo_energy =
[-1.18581752e+02 -1.22031916e+01 -9.55614606e+00 -9.55614606e+00
 -9.55614606e+00 -1.25300999e+00 -5.74518934e-01 -5.74518934e-01
 -5.74518934e-01  1.13467277e+00  1.13467277e+00  1.13467277e+00
  9.30907356e+00  9.30907356e+00  9.30907356e+00  4.47696845e+01
  4.47696845e+01  4.47696845e+01  8.30247500e+01  1.76176877e+02
  1.76176877e+02  1.76176877e+02  5.73901772e+02  5.76079838e+02
  5.76079838e+02  5.76079838e+02  1.44432257e+03  1.44432257e+03
  1.44432257e+03  2.61847559e+03  3.14181201e+03  3.14181201e+03
  3.14181201e+03  6.75724218e+03  6.75724218e+03  6.75724218e+03
  9.01976300e+03  2.53813726e+04  7.61289274e+04]
E1 = -728.294741062252  E_coul = 201.8664803388734
cycle= 2 E= -526.428260723379  delta_E= -0.000385  |g|= 0.0243  |ddm|= 0.0208
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0470745
diis-c [-0.00144426  0.04723951  0.95276049]
  HOMO = -0.570813089387109  LUMO = 1.13792137392187
  mo_energy =
[-1.18538803e+02 -1.21827273e+01 -9.53528904e+00 -9.53528904e+00
 -9.53528904e+00 -1.24810243e+00 -5.70813089e-01 -5.70813089e-01
 -5.70813089e-01  1.13792137e+00  1.13792137e+00  1.13792137e+00
  9.32221999e+00  9.32221999e+00  9.32221999e+00  4.47942501e+01
  4.47942501e+01  4.47942501e+01  8.30598870e+01  1.76212956e+02
  1.76212956e+02  1.76212956e+02  5.73946172e+02  5.76122420e+02
  5.76122420e+02  5.76122420e+02  1.44436794e+03  1.44436794e+03
  1.44436794e+03  2.61852324e+03  3.14185898e+03  3.14185898e+03
  3.14185898e+03  6.75729016e+03  6.75729016e+03  6.75729016e+03
  9.01981140e+03  2.53814212e+04  7.61289760e+04]
E1 = -728.2337036694447  E_coul = 201.80542986715213
cycle= 3 E= -526.428273802293  delta_E= -1.31e-05  |g|= 0.00297  |ddm|= 0.00526
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00636701
diis-c [-3.46548305e-07 -1.04083761e-03  1.12569025e-01  8.88471813e-01]
  HOMO = -0.571480685806697  LUMO = 1.13735678832028
  mo_energy =
[-1.18544080e+02 -1.21855961e+01 -9.53825876e+00 -9.53825876e+00
 -9.53825876e+00 -1.24896858e+00 -5.71480686e-01 -5.71480686e-01
 -5.71480686e-01  1.13735679e+00  1.13735679e+00  1.13735679e+00
  9.32018979e+00  9.32018979e+00  9.32018979e+00  4.47909034e+01
  4.47909034e+01  4.47909034e+01  8.30555556e+01  1.76208408e+02
  1.76208408e+02  1.76208408e+02  5.73940720e+02  5.76117191e+02
  5.76117191e+02  5.76117191e+02  1.44436237e+03  1.44436237e+03
  1.44436237e+03  2.61851728e+03  3.14185318e+03  3.14185318e+03
  3.14185318e+03  6.75728412e+03  6.75728412e+03  6.75728412e+03
  9.01980522e+03  2.53814149e+04  7.61289696e+04]
E1 = -728.2420232057981  E_coul = 201.81374911111885
cycle= 4 E= -526.428274094679  delta_E= -2.92e-07  |g|= 4.37e-05  |ddm|= 0.000778
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.92778e-05
diis-c [-1.67515240e-09  3.66106871e-06 -1.28824415e-03 -2.96852108e-03
  1.00425310e+00]
  HOMO = -0.571452687571457  LUMO = 1.13737974021695
  mo_energy =
[-1.18543981e+02 -1.21855058e+01 -9.53816910e+00 -9.53816910e+00
 -9.53816910e+00 -1.24893230e+00 -5.71452688e-01 -5.71452688e-01
 -5.71452688e-01  1.13737974e+00  1.13737974e+00  1.13737974e+00
  9.32026016e+00  9.32026016e+00  9.32026016e+00  4.47909933e+01
  4.47909933e+01  4.47909933e+01  8.30556565e+01  1.76208506e+02
  1.76208506e+02  1.76208506e+02  5.73940816e+02  5.76117289e+02
  5.76117289e+02  5.76117289e+02  1.44436247e+03  1.44436247e+03
  1.44436247e+03  2.61851736e+03  3.14185327e+03  3.14185327e+03
  3.14185327e+03  6.75728420e+03  6.75728420e+03  6.75728420e+03
  9.01980531e+03  2.53814149e+04  7.61289697e+04]
E1 = -728.2418093900615  E_coul = 201.81353529523216
cycle= 5 E= -526.428274094829  delta_E= -1.5e-10  |g|= 7.06e-06  |ddm|= 2.47e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.2418093900615  E_coul = 201.81353529523216
  HOMO = -0.571456334067997  LUMO = 1.13737673336194
  mo_energy =
[-1.18543999e+02 -1.21855185e+01 -9.53818209e+00 -9.53818209e+00
 -9.53818209e+00 -1.24893702e+00 -5.71456334e-01 -5.71456334e-01
 -5.71456334e-01  1.13737673e+00  1.13737673e+00  1.13737673e+00
  9.32025044e+00  9.32025044e+00  9.32025044e+00  4.47909797e+01
  4.47909797e+01  4.47909797e+01  8.30556407e+01  1.76208490e+02
  1.76208490e+02  1.76208490e+02  5.73940798e+02  5.76117272e+02
  5.76117272e+02  5.76117272e+02  1.44436245e+03  1.44436245e+03
  1.44436245e+03  2.61851735e+03  3.14185325e+03  3.14185325e+03
  3.14185325e+03  6.75728418e+03  6.75728418e+03  6.75728418e+03
  9.01980529e+03  2.53814149e+04  7.61289697e+04]
E1 = -728.2418425665097  E_coul = 201.81356847167763
Extra cycle  E= -526.428274094832  delta_E= -2.84e-12  |g|= 1.78e-06  |ddm|= 3.56e-06
    CPU time for scf_cycle      0.68 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 152652.9390616935
E1 = -728.2418425665097  E_coul = 201.81356847167763
init E= -526.428274094832
    CPU time for initialize scf      2.71 sec, wall time      0.25 sec
  HOMO = -0.571455711227155  LUMO = 1.13737725444011
  mo_energy =
[-1.18543995e+02 -1.21855161e+01 -9.53817958e+00 -9.53817958e+00
 -9.53817958e+00 -1.24893621e+00 -5.71455711e-01 -5.71455711e-01
 -5.71455711e-01  1.13737725e+00  1.13737725e+00  1.13737725e+00
  9.32025222e+00  9.32025222e+00  9.32025222e+00  4.47909825e+01
  4.47909825e+01  4.47909825e+01  8.30556441e+01  1.76208493e+02
  1.76208493e+02  1.76208493e+02  5.73940802e+02  5.76117276e+02
  5.76117276e+02  5.76117276e+02  1.44436246e+03  1.44436246e+03
  1.44436246e+03  2.61851735e+03  3.14185326e+03  3.14185326e+03
  3.14185326e+03  6.75728419e+03  6.75728419e+03  6.75728419e+03
  9.01980529e+03  2.53814149e+04  7.61289697e+04]
E1 = -728.2418358624965  E_coul = 201.81356176766408
cycle= 1 E= -526.428274094832  delta_E= -3.41e-13  |g|= 3.92e-07  |ddm|= 6.64e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2418358624965  E_coul = 201.81356176766408
  HOMO = -0.571455829698313  LUMO = 1.13737715472102
  mo_energy =
[-1.18543995e+02 -1.21855166e+01 -9.53818009e+00 -9.53818009e+00
 -9.53818009e+00 -1.24893637e+00 -5.71455830e-01 -5.71455830e-01
 -5.71455830e-01  1.13737715e+00  1.13737715e+00  1.13737715e+00
  9.32025187e+00  9.32025187e+00  9.32025187e+00  4.47909819e+01
  4.47909819e+01  4.47909819e+01  8.30556434e+01  1.76208493e+02
  1.76208493e+02  1.76208493e+02  5.73940801e+02  5.76117275e+02
  5.76117275e+02  5.76117275e+02  1.44436245e+03  1.44436245e+03
  1.44436245e+03  2.61851735e+03  3.14185325e+03  3.14185325e+03
  3.14185325e+03  6.75728419e+03  6.75728419e+03  6.75728419e+03
  9.01980529e+03  2.53814149e+04  7.61289697e+04]
E1 = -728.2418372373763  E_coul = 201.81356314254361
Extra cycle  E= -526.428274094833  delta_E= -2.27e-13  |g|= 8.31e-08  |ddm|= 1.32e-07
    CPU time for scf_cycle      2.86 sec, wall time      0.39 sec
exp = [2.61825403e+04 7.61783611e+03 3.61735603e+03 1.60512911e+03
 3.62637273e+02 1.15815956e+02 3.74614474e+01 4.57793596e+00
 3.93107812e-01 1.36276368e+03 6.64805153e+02 3.01256875e+02
 3.14326529e+02 8.60115735e+01 9.25505835e+00 2.63483064e+01
 8.42977920e-01 3.41979265e+00 2.36009804e-01]
grad_E = [-1.73326924e-06  6.61507798e-06  2.81657448e-06  1.82821231e-04
 -1.90810453e-03  5.99227026e-03 -4.52251071e-03 -9.46076858e-03
 -2.98191760e-02 -9.19782944e-08  1.14462009e-07  9.61762056e-07
  1.54847075e-06  7.11762596e-04  4.23842205e-03 -2.75266011e-03
  1.97607064e-02  4.06351511e-03 -6.35969035e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:43:02 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.538759         1
[INPUT] 0    0    [1    /1   ]  7617.85572953        1
[INPUT] 0    0    [1    /1   ]  3617.39874481        1
[INPUT] 0    0    [1    /1   ]  1605.75086031        1
[INPUT] 0    0    [1    /1   ]  356.692686609        1
[INPUT] 0    0    [1    /1   ]  113.114634491        1
[INPUT] 0    0    [1    /1   ]  36.9708544562        1
[INPUT] 0    0    [1    /1   ]  4.58117138298        1
[INPUT] 0    0    [1    /1   ]  0.392198468829       1
[INPUT] 1    0    [1    /1   ]  1362.76519701        1
[INPUT] 1    0    [1    /1   ]  664.823951209        1
[INPUT] 1    0    [1    /1   ]  301.360696604        1
[INPUT] 1    0    [1    /1   ]  314.418059947        1
[INPUT] 1    0    [1    /1   ]  83.7680761164        1
[INPUT] 1    0    [1    /1   ]  9.60872067134        1
[INPUT] 1    0    [1    /1   ]  27.0225326304        1
[INPUT] 1    0    [1    /1   ]  0.830269143687       1
[INPUT] 1    0    [1    /1   ]  3.49422406303        1
[INPUT] 1    0    [1    /1   ]  0.233804471993       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.538758969415, 1.0]], [0, [7617.855729532392, 1.0]], [0, [3617.398744809494, 1.0]], [0, [1605.7508603100457, 1.0]], [0, [356.6926866088823, 1.0]], [0, [113.11463449095251, 1.0]], [0, [36.97085445622414, 1.0]], [0, [4.581171382983725, 1.0]], [0, [0.3921984688286025, 1.0]], [1, [1362.765197011492, 1.0]], [1, [664.8239512091582, 1.0]], [1, [301.36069660445406, 1.0]], [1, [314.41805994677077, 1.0]], [1, [83.76807611636593, 1.0]], [1, [9.608720671344738, 1.0]], [1, [27.022532630423566, 1.0]], [1, [0.8302691436873312, 1.0]], [1, [3.4942240630332653, 1.0]], [1, [0.23380447199285467, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.53875897]
bas 1, expnt(s) = [7617.85572953]
bas 2, expnt(s) = [3617.39874481]
bas 3, expnt(s) = [1605.75086031]
bas 4, expnt(s) = [356.69268661]
bas 5, expnt(s) = [113.11463449]
bas 6, expnt(s) = [36.97085446]
bas 7, expnt(s) = [4.58117138]
bas 8, expnt(s) = [0.39219847]
bas 9, expnt(s) = [1362.76519701]
bas 10, expnt(s) = [664.82395121]
bas 11, expnt(s) = [301.3606966]
bas 12, expnt(s) = [314.41805995]
bas 13, expnt(s) = [83.76807612]
bas 14, expnt(s) = [9.60872067]
bas 15, expnt(s) = [27.02253263]
bas 16, expnt(s) = [0.83026914]
bas 17, expnt(s) = [3.49422406]
bas 18, expnt(s) = [0.23380447]
CPU time:       486.79
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825388e+04 5.20024542e+03 7.61785573e+03 2.06010607e+03
 3.61739874e+03 1.17845312e+03 1.60575086e+03 6.40875467e+02
 3.56692687e+02 2.07365106e+02 1.13114634e+02 8.76302643e+01
 3.69708545e+01 3.78799712e+01 4.58117138e+00 7.91129226e+00
 3.92198469e-01 1.25211565e+00 1.36276520e+03 2.41552026e+04
 6.64823951e+02 9.84844614e+03 3.01360697e+02 3.66304839e+03
 3.14418060e+02 3.86250226e+03 8.37680761e+01 7.39320194e+02
 9.60872067e+00 4.93533177e+01 2.70225326e+01 1.79738848e+02
 8.30269144e-01 2.31210746e+00 3.49422406e+00 1.39371133e+01
 2.33804472e-01 4.74297035e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.974719842247804
cond(S) = 150207.32502209864
E1 = -728.7057745867263  E_coul = 203.06703987268986
init E= -525.638734714036
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.560136488269863  LUMO = 1.12490650258147
  mo_energy =
[-1.18305725e+02 -1.21067382e+01 -9.45242418e+00 -9.45242418e+00
 -9.45242418e+00 -1.23166188e+00 -5.60136488e-01 -5.60136488e-01
 -5.60136488e-01  1.12490650e+00  1.12490650e+00  1.12490650e+00
  9.57654715e+00  9.57654715e+00  9.57654715e+00  4.64630667e+01
  4.64630667e+01  4.64630667e+01  8.11299583e+01  1.77784563e+02
  1.77784563e+02  1.77784563e+02  5.61477789e+02  5.74436112e+02
  5.74436112e+02  5.74436112e+02  1.44094751e+03  1.44094751e+03
  1.44094751e+03  2.59164221e+03  3.13804905e+03  3.13804905e+03
  3.13804905e+03  6.75376462e+03  6.75376462e+03  6.75376462e+03
  8.98932351e+03  2.53515688e+04  7.61011056e+04]
E1 = -727.979458368838  E_coul = 201.54906642852
cycle= 1 E= -526.430391940318  delta_E= -0.792  |g|= 0.189  |ddm|= 0.585
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.560858
diis-c [-0.31456138  1.        ]
  HOMO = -0.574751999356117  LUMO = 1.11471781645376
  mo_energy =
[-1.18582643e+02 -1.22056649e+01 -9.55827747e+00 -9.55827747e+00
 -9.55827747e+00 -1.25349817e+00 -5.74751999e-01 -5.74751999e-01
 -5.74751999e-01  1.11471782e+00  1.11471782e+00  1.11471782e+00
  9.50807974e+00  9.50807974e+00  9.50807974e+00  4.63290317e+01
  4.63290317e+01  4.63290317e+01  8.09590114e+01  1.77577706e+02
  1.77577706e+02  1.77577706e+02  5.61169081e+02  5.74162809e+02
  5.74162809e+02  5.74162809e+02  1.44061900e+03  1.44061900e+03
  1.44061900e+03  2.59118021e+03  3.13765595e+03  3.13765595e+03
  3.13765595e+03  6.75325572e+03  6.75325572e+03  6.75325572e+03
  8.98873674e+03  2.53508862e+04  7.61003314e+04]
E1 = -728.2792270831994  E_coul = 201.84845137476003
cycle= 2 E= -526.430775708439  delta_E= -0.000384  |g|= 0.0243  |ddm|= 0.0214
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0471844
diis-c [-0.00145789  0.04720329  0.95279671]
  HOMO = -0.570974314423783  LUMO = 1.11797328484254
  mo_energy =
[-1.18539648e+02 -1.21851214e+01 -9.53734453e+00 -9.53734453e+00
 -9.53734453e+00 -1.24851172e+00 -5.70974314e-01 -5.70974314e-01
 -5.70974314e-01  1.11797328e+00  1.11797328e+00  1.11797328e+00
  9.52160167e+00  9.52160167e+00  9.52160167e+00  4.63539579e+01
  4.63539579e+01  4.63539579e+01  8.09939681e+01  1.77613715e+02
  1.77613715e+02  1.77613715e+02  5.61213441e+02  5.74205381e+02
  5.74205381e+02  5.74205381e+02  1.44066441e+03  1.44066441e+03
  1.44066441e+03  2.59122790e+03  3.13770297e+03  3.13770297e+03
  3.13770297e+03  6.75330375e+03  6.75330375e+03  6.75330375e+03
  8.98878518e+03  2.53509348e+04  7.61003800e+04]
E1 = -728.2181959078079  E_coul = 201.7874071084241
cycle= 3 E= -526.430788799384  delta_E= -1.31e-05  |g|= 0.00297  |ddm|= 0.00528
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00639299
diis-c [-3.40512432e-07 -1.04311057e-03  1.12806432e-01  8.88236678e-01]
  HOMO = -0.571640045447979  LUMO = 1.11741897823141
  mo_energy =
[-1.18544920e+02 -1.21879837e+01 -9.54030844e+00 -9.54030844e+00
 -9.54030844e+00 -1.24937471e+00 -5.71640045e-01 -5.71640045e-01
 -5.71640045e-01  1.11741898e+00  1.11741898e+00  1.11741898e+00
  9.51954337e+00  9.51954337e+00  9.51954337e+00  4.63505854e+01
  4.63505854e+01  4.63505854e+01  8.09896667e+01  1.77609187e+02
  1.77609187e+02  1.77609187e+02  5.61208003e+02  5.74200162e+02
  5.74200162e+02  5.74200162e+02  1.44065885e+03  1.44065885e+03
  1.44065885e+03  2.59122194e+03  3.13769717e+03  3.13769717e+03
  3.13769717e+03  6.75329771e+03  6.75329771e+03  6.75329771e+03
  8.98877900e+03  2.53509285e+04  7.61003736e+04]
E1 = -728.2264738443127  E_coul = 201.7956847545825
cycle= 4 E= -526.43078908973  delta_E= -2.9e-07  |g|= 4.17e-05  |ddm|= 0.000778
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.57405e-05
diis-c [-1.63028191e-09  7.19694741e-06 -1.65166019e-03 -6.56334500e-03
  1.00820781e+00]
  HOMO = -0.571612894487705  LUMO = 1.11744090096043
  mo_energy =
[-1.18544826e+02 -1.21878970e+01 -9.54022265e+00 -9.54022265e+00
 -9.54022265e+00 -1.24933963e+00 -5.71612894e-01 -5.71612894e-01
 -5.71612894e-01  1.11744090e+00  1.11744090e+00  1.11744090e+00
  9.51961175e+00  9.51961175e+00  9.51961175e+00  4.63506717e+01
  4.63506717e+01  4.63506717e+01  8.09897631e+01  1.77609280e+02
  1.77609280e+02  1.77609280e+02  5.61208094e+02  5.74200255e+02
  5.74200255e+02  5.74200255e+02  1.44065894e+03  1.44065894e+03
  1.44065894e+03  2.59122202e+03  3.13769725e+03  3.13769725e+03
  3.13769725e+03  6.75329779e+03  6.75329779e+03  6.75329779e+03
  8.98877908e+03  2.53509286e+04  7.61003737e+04]
E1 = -728.2262712877913  E_coul = 201.79548219792596
cycle= 5 E= -526.430789089865  delta_E= -1.35e-10  |g|= 6.94e-06  |ddm|= 2.35e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.2262712877913  E_coul = 201.79548219792596
  HOMO = -0.571616519143198  LUMO = 1.11743795902512
  mo_energy =
[-1.18544843e+02 -1.21879097e+01 -9.54023550e+00 -9.54023550e+00
 -9.54023550e+00 -1.24934432e+00 -5.71616519e-01 -5.71616519e-01
 -5.71616519e-01  1.11743796e+00  1.11743796e+00  1.11743796e+00
  9.51960201e+00  9.51960201e+00  9.51960201e+00  4.63506582e+01
  4.63506582e+01  4.63506582e+01  8.09897475e+01  1.77609264e+02
  1.77609264e+02  1.77609264e+02  5.61208076e+02  5.74200238e+02
  5.74200238e+02  5.74200238e+02  1.44065892e+03  1.44065892e+03
  1.44065892e+03  2.59122201e+03  3.13769724e+03  3.13769724e+03
  3.13769724e+03  6.75329777e+03  6.75329777e+03  6.75329777e+03
  8.98877906e+03  2.53509286e+04  7.61003737e+04]
E1 = -728.2263039252271  E_coul = 201.7955148353578
Extra cycle  E= -526.430789089869  delta_E= -3.87e-12  |g|= 1.75e-06  |ddm|= 3.53e-06
    CPU time for scf_cycle      0.63 sec, wall time      0.24 sec
exp = [2.61825388e+04 7.61785573e+03 3.61739874e+03 1.60575086e+03
 3.56692687e+02 1.13114634e+02 3.69708545e+01 4.58117138e+00
 3.92198469e-01 1.36276520e+03 6.64823951e+02 3.01360697e+02
 3.14418060e+02 8.37680761e+01 9.60872067e+00 2.70225326e+01
 8.30269144e-01 3.49422406e+00 2.33804472e-01]
E = -526.4307890898692
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:43:02 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.538759         1
[INPUT] 0    0    [1    /1   ]  7617.85572953        1
[INPUT] 0    0    [1    /1   ]  3617.39874481        1
[INPUT] 0    0    [1    /1   ]  1605.75086031        1
[INPUT] 0    0    [1    /1   ]  356.692686609        1
[INPUT] 0    0    [1    /1   ]  113.114634491        1
[INPUT] 0    0    [1    /1   ]  36.9708544562        1
[INPUT] 0    0    [1    /1   ]  4.58117138298        1
[INPUT] 0    0    [1    /1   ]  0.392198468829       1
[INPUT] 1    0    [1    /1   ]  1362.76519701        1
[INPUT] 1    0    [1    /1   ]  664.823951209        1
[INPUT] 1    0    [1    /1   ]  301.360696604        1
[INPUT] 1    0    [1    /1   ]  314.418059947        1
[INPUT] 1    0    [1    /1   ]  83.7680761164        1
[INPUT] 1    0    [1    /1   ]  9.60872067134        1
[INPUT] 1    0    [1    /1   ]  27.0225326304        1
[INPUT] 1    0    [1    /1   ]  0.830269143687       1
[INPUT] 1    0    [1    /1   ]  3.49422406303        1
[INPUT] 1    0    [1    /1   ]  0.233804471993       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.538758969415, 1.0]], [0, [7617.855729532392, 1.0]], [0, [3617.398744809494, 1.0]], [0, [1605.7508603100457, 1.0]], [0, [356.6926866088823, 1.0]], [0, [113.11463449095251, 1.0]], [0, [36.97085445622414, 1.0]], [0, [4.581171382983725, 1.0]], [0, [0.3921984688286025, 1.0]], [1, [1362.765197011492, 1.0]], [1, [664.8239512091582, 1.0]], [1, [301.36069660445406, 1.0]], [1, [314.41805994677077, 1.0]], [1, [83.76807611636593, 1.0]], [1, [9.608720671344738, 1.0]], [1, [27.022532630423566, 1.0]], [1, [0.8302691436873312, 1.0]], [1, [3.4942240630332653, 1.0]], [1, [0.23380447199285467, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.53875897]
bas 1, expnt(s) = [7617.85572953]
bas 2, expnt(s) = [3617.39874481]
bas 3, expnt(s) = [1605.75086031]
bas 4, expnt(s) = [356.69268661]
bas 5, expnt(s) = [113.11463449]
bas 6, expnt(s) = [36.97085446]
bas 7, expnt(s) = [4.58117138]
bas 8, expnt(s) = [0.39219847]
bas 9, expnt(s) = [1362.76519701]
bas 10, expnt(s) = [664.82395121]
bas 11, expnt(s) = [301.3606966]
bas 12, expnt(s) = [314.41805995]
bas 13, expnt(s) = [83.76807612]
bas 14, expnt(s) = [9.60872067]
bas 15, expnt(s) = [27.02253263]
bas 16, expnt(s) = [0.83026914]
bas 17, expnt(s) = [3.49422406]
bas 18, expnt(s) = [0.23380447]
CPU time:       487.65
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825388e+04 5.20024542e+03 7.61785573e+03 2.06010607e+03
 3.61739874e+03 1.17845312e+03 1.60575086e+03 6.40875467e+02
 3.56692687e+02 2.07365106e+02 1.13114634e+02 8.76302643e+01
 3.69708545e+01 3.78799712e+01 4.58117138e+00 7.91129226e+00
 3.92198469e-01 1.25211565e+00 1.36276520e+03 2.41552026e+04
 6.64823951e+02 9.84844614e+03 3.01360697e+02 3.66304839e+03
 3.14418060e+02 3.86250226e+03 8.37680761e+01 7.39320194e+02
 9.60872067e+00 4.93533177e+01 2.70225326e+01 1.79738848e+02
 8.30269144e-01 2.31210746e+00 3.49422406e+00 1.39371133e+01
 2.33804472e-01 4.74297035e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.974719842247804
cond(S) = 150207.32502209864
E1 = -728.7057745867263  E_coul = 203.06703987268986
init E= -525.638734714036
    CPU time for initialize scf      0.46 sec, wall time      0.06 sec
  HOMO = -0.560136488269863  LUMO = 1.12490650258147
  mo_energy =
[-1.18305725e+02 -1.21067382e+01 -9.45242418e+00 -9.45242418e+00
 -9.45242418e+00 -1.23166188e+00 -5.60136488e-01 -5.60136488e-01
 -5.60136488e-01  1.12490650e+00  1.12490650e+00  1.12490650e+00
  9.57654715e+00  9.57654715e+00  9.57654715e+00  4.64630667e+01
  4.64630667e+01  4.64630667e+01  8.11299583e+01  1.77784563e+02
  1.77784563e+02  1.77784563e+02  5.61477789e+02  5.74436112e+02
  5.74436112e+02  5.74436112e+02  1.44094751e+03  1.44094751e+03
  1.44094751e+03  2.59164221e+03  3.13804905e+03  3.13804905e+03
  3.13804905e+03  6.75376462e+03  6.75376462e+03  6.75376462e+03
  8.98932351e+03  2.53515688e+04  7.61011056e+04]
E1 = -727.979458368838  E_coul = 201.54906642852
cycle= 1 E= -526.430391940318  delta_E= -0.792  |g|= 0.189  |ddm|= 0.585
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.560858
diis-c [-0.31456138  1.        ]
  HOMO = -0.574751999356117  LUMO = 1.11471781645376
  mo_energy =
[-1.18582643e+02 -1.22056649e+01 -9.55827747e+00 -9.55827747e+00
 -9.55827747e+00 -1.25349817e+00 -5.74751999e-01 -5.74751999e-01
 -5.74751999e-01  1.11471782e+00  1.11471782e+00  1.11471782e+00
  9.50807974e+00  9.50807974e+00  9.50807974e+00  4.63290317e+01
  4.63290317e+01  4.63290317e+01  8.09590114e+01  1.77577706e+02
  1.77577706e+02  1.77577706e+02  5.61169081e+02  5.74162809e+02
  5.74162809e+02  5.74162809e+02  1.44061900e+03  1.44061900e+03
  1.44061900e+03  2.59118021e+03  3.13765595e+03  3.13765595e+03
  3.13765595e+03  6.75325572e+03  6.75325572e+03  6.75325572e+03
  8.98873674e+03  2.53508862e+04  7.61003314e+04]
E1 = -728.2792270831994  E_coul = 201.84845137476003
cycle= 2 E= -526.430775708439  delta_E= -0.000384  |g|= 0.0243  |ddm|= 0.0214
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0471844
diis-c [-0.00145789  0.04720329  0.95279671]
  HOMO = -0.570974314423783  LUMO = 1.11797328484254
  mo_energy =
[-1.18539648e+02 -1.21851214e+01 -9.53734453e+00 -9.53734453e+00
 -9.53734453e+00 -1.24851172e+00 -5.70974314e-01 -5.70974314e-01
 -5.70974314e-01  1.11797328e+00  1.11797328e+00  1.11797328e+00
  9.52160167e+00  9.52160167e+00  9.52160167e+00  4.63539579e+01
  4.63539579e+01  4.63539579e+01  8.09939681e+01  1.77613715e+02
  1.77613715e+02  1.77613715e+02  5.61213441e+02  5.74205381e+02
  5.74205381e+02  5.74205381e+02  1.44066441e+03  1.44066441e+03
  1.44066441e+03  2.59122790e+03  3.13770297e+03  3.13770297e+03
  3.13770297e+03  6.75330375e+03  6.75330375e+03  6.75330375e+03
  8.98878518e+03  2.53509348e+04  7.61003800e+04]
E1 = -728.2181959078079  E_coul = 201.7874071084241
cycle= 3 E= -526.430788799384  delta_E= -1.31e-05  |g|= 0.00297  |ddm|= 0.00528
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00639299
diis-c [-3.40512432e-07 -1.04311057e-03  1.12806432e-01  8.88236678e-01]
  HOMO = -0.571640045447979  LUMO = 1.11741897823141
  mo_energy =
[-1.18544920e+02 -1.21879837e+01 -9.54030844e+00 -9.54030844e+00
 -9.54030844e+00 -1.24937471e+00 -5.71640045e-01 -5.71640045e-01
 -5.71640045e-01  1.11741898e+00  1.11741898e+00  1.11741898e+00
  9.51954337e+00  9.51954337e+00  9.51954337e+00  4.63505854e+01
  4.63505854e+01  4.63505854e+01  8.09896667e+01  1.77609187e+02
  1.77609187e+02  1.77609187e+02  5.61208003e+02  5.74200162e+02
  5.74200162e+02  5.74200162e+02  1.44065885e+03  1.44065885e+03
  1.44065885e+03  2.59122194e+03  3.13769717e+03  3.13769717e+03
  3.13769717e+03  6.75329771e+03  6.75329771e+03  6.75329771e+03
  8.98877900e+03  2.53509285e+04  7.61003736e+04]
E1 = -728.2264738443127  E_coul = 201.7956847545825
cycle= 4 E= -526.43078908973  delta_E= -2.9e-07  |g|= 4.17e-05  |ddm|= 0.000778
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.57405e-05
diis-c [-1.63028191e-09  7.19694741e-06 -1.65166019e-03 -6.56334500e-03
  1.00820781e+00]
  HOMO = -0.571612894487705  LUMO = 1.11744090096043
  mo_energy =
[-1.18544826e+02 -1.21878970e+01 -9.54022265e+00 -9.54022265e+00
 -9.54022265e+00 -1.24933963e+00 -5.71612894e-01 -5.71612894e-01
 -5.71612894e-01  1.11744090e+00  1.11744090e+00  1.11744090e+00
  9.51961175e+00  9.51961175e+00  9.51961175e+00  4.63506717e+01
  4.63506717e+01  4.63506717e+01  8.09897631e+01  1.77609280e+02
  1.77609280e+02  1.77609280e+02  5.61208094e+02  5.74200255e+02
  5.74200255e+02  5.74200255e+02  1.44065894e+03  1.44065894e+03
  1.44065894e+03  2.59122202e+03  3.13769725e+03  3.13769725e+03
  3.13769725e+03  6.75329779e+03  6.75329779e+03  6.75329779e+03
  8.98877908e+03  2.53509286e+04  7.61003737e+04]
E1 = -728.2262712877913  E_coul = 201.79548219792596
cycle= 5 E= -526.430789089865  delta_E= -1.35e-10  |g|= 6.94e-06  |ddm|= 2.35e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.2262712877913  E_coul = 201.79548219792596
  HOMO = -0.571616519143198  LUMO = 1.11743795902512
  mo_energy =
[-1.18544843e+02 -1.21879097e+01 -9.54023550e+00 -9.54023550e+00
 -9.54023550e+00 -1.24934432e+00 -5.71616519e-01 -5.71616519e-01
 -5.71616519e-01  1.11743796e+00  1.11743796e+00  1.11743796e+00
  9.51960201e+00  9.51960201e+00  9.51960201e+00  4.63506582e+01
  4.63506582e+01  4.63506582e+01  8.09897475e+01  1.77609264e+02
  1.77609264e+02  1.77609264e+02  5.61208076e+02  5.74200238e+02
  5.74200238e+02  5.74200238e+02  1.44065892e+03  1.44065892e+03
  1.44065892e+03  2.59122201e+03  3.13769724e+03  3.13769724e+03
  3.13769724e+03  6.75329777e+03  6.75329777e+03  6.75329777e+03
  8.98877906e+03  2.53509286e+04  7.61003737e+04]
E1 = -728.2263039252271  E_coul = 201.7955148353578
Extra cycle  E= -526.430789089869  delta_E= -3.87e-12  |g|= 1.75e-06  |ddm|= 3.53e-06
    CPU time for scf_cycle      0.67 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 150207.32502209864
E1 = -728.2263039252271  E_coul = 201.7955148353578
init E= -526.430789089869
    CPU time for initialize scf      2.71 sec, wall time      0.24 sec
  HOMO = -0.571615904049637  LUMO = 1.11743846565031
  mo_energy =
[-1.18544840e+02 -1.21879073e+01 -9.54023304e+00 -9.54023304e+00
 -9.54023304e+00 -1.24934352e+00 -5.71615904e-01 -5.71615904e-01
 -5.71615904e-01  1.11743847e+00  1.11743847e+00  1.11743847e+00
  9.51960378e+00  9.51960378e+00  9.51960378e+00  4.63506609e+01
  4.63506609e+01  4.63506609e+01  8.09897509e+01  1.77609267e+02
  1.77609267e+02  1.77609267e+02  5.61208080e+02  5.74200242e+02
  5.74200242e+02  5.74200242e+02  1.44065892e+03  1.44065892e+03
  1.44065892e+03  2.59122201e+03  3.13769724e+03  3.13769724e+03
  3.13769724e+03  6.75329777e+03  6.75329777e+03  6.75329777e+03
  8.98877906e+03  2.53509286e+04  7.61003737e+04]
E1 = -728.2262973633999  E_coul = 201.7955082735315
cycle= 1 E= -526.430789089868  delta_E= 7.96e-13  |g|= 3.84e-07  |ddm|= 6.52e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2262973633999  E_coul = 201.7955082735315
  HOMO = -0.571616020237606  LUMO = 1.11743836936429
  mo_energy =
[-1.18544840e+02 -1.21879077e+01 -9.54023353e+00 -9.54023353e+00
 -9.54023353e+00 -1.24934367e+00 -5.71616020e-01 -5.71616020e-01
 -5.71616020e-01  1.11743837e+00  1.11743837e+00  1.11743837e+00
  9.51960344e+00  9.51960344e+00  9.51960344e+00  4.63506603e+01
  4.63506603e+01  4.63506603e+01  8.09897502e+01  1.77609267e+02
  1.77609267e+02  1.77609267e+02  5.61208079e+02  5.74200241e+02
  5.74200241e+02  5.74200241e+02  1.44065892e+03  1.44065892e+03
  1.44065892e+03  2.59122201e+03  3.13769724e+03  3.13769724e+03
  3.13769724e+03  6.75329777e+03  6.75329777e+03  6.75329777e+03
  8.98877906e+03  2.53509286e+04  7.61003737e+04]
E1 = -728.2262987035413  E_coul = 201.7955096136719
Extra cycle  E= -526.430789089869  delta_E= -9.09e-13  |g|= 8.12e-08  |ddm|= 1.3e-07
    CPU time for scf_cycle      2.83 sec, wall time      0.36 sec
exp = [2.61825388e+04 7.61785573e+03 3.61739874e+03 1.60575086e+03
 3.56692687e+02 1.13114634e+02 3.69708545e+01 4.58117138e+00
 3.92198469e-01 1.36276520e+03 6.64823951e+02 3.01360697e+02
 3.14418060e+02 8.37680761e+01 9.60872067e+00 2.70225326e+01
 8.30269144e-01 3.49422406e+00 2.33804472e-01]
grad_E = [-1.74841228e-06  6.93288388e-06  3.42060998e-06  1.92702735e-04
 -1.98338519e-03  5.68852202e-03 -3.79134775e-03 -4.51901512e-03
 -4.46802053e-02 -3.80988134e-07  3.04360430e-08 -5.80199342e-07
 -1.93303469e-07  4.41043875e-04  8.60670199e-03 -1.89863001e-03
 -1.12589431e-02 -2.88324552e-03 -2.57555793e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:43:06 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5380503        1
[INPUT] 0    0    [1    /1   ]  7617.86497648        1
[INPUT] 0    0    [1    /1   ]  3617.41886692        1
[INPUT] 0    0    [1    /1   ]  1606.04378139        1
[INPUT] 0    0    [1    /1   ]  353.923823904        1
[INPUT] 0    0    [1    /1   ]  111.712513427        1
[INPUT] 0    0    [1    /1   ]  36.5791282985        1
[INPUT] 0    0    [1    /1   ]  4.58330531495        1
[INPUT] 0    0    [1    /1   ]  0.395461023128       1
[INPUT] 1    0    [1    /1   ]  1362.76591084        1
[INPUT] 1    0    [1    /1   ]  664.83279173         1
[INPUT] 1    0    [1    /1   ]  301.409500591        1
[INPUT] 1    0    [1    /1   ]  314.461086181        1
[INPUT] 1    0    [1    /1   ]  82.7325278033        1
[INPUT] 1    0    [1    /1   ]  9.76285348255        1
[INPUT] 1    0    [1    /1   ]  27.2747767682        1
[INPUT] 1    0    [1    /1   ]  0.839908820166       1
[INPUT] 1    0    [1    /1   ]  3.56820914458        1
[INPUT] 1    0    [1    /1   ]  0.237549014049       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.5380502874, 1.0]], [0, [7617.8649764829515, 1.0]], [0, [3617.4188669164923, 1.0]], [0, [1606.043781386353, 1.0]], [0, [353.92382390422, 1.0]], [0, [111.71251342703309, 1.0]], [0, [36.57912829853694, 1.0]], [0, [4.58330531495249, 1.0]], [0, [0.39546102312762693, 1.0]], [1, [1362.7659108391592, 1.0]], [1, [664.832791729802, 1.0]], [1, [301.40950059097884, 1.0]], [1, [314.4610861813685, 1.0]], [1, [82.73252780331642, 1.0]], [1, [9.762853482551403, 1.0]], [1, [27.274776768183138, 1.0]], [1, [0.8399088201664392, 1.0]], [1, [3.5682091445844315, 1.0]], [1, [0.2375490140485059, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.53805029]
bas 1, expnt(s) = [7617.86497648]
bas 2, expnt(s) = [3617.41886692]
bas 3, expnt(s) = [1606.04378139]
bas 4, expnt(s) = [353.9238239]
bas 5, expnt(s) = [111.71251343]
bas 6, expnt(s) = [36.5791283]
bas 7, expnt(s) = [4.58330531]
bas 8, expnt(s) = [0.39546102]
bas 9, expnt(s) = [1362.76591084]
bas 10, expnt(s) = [664.83279173]
bas 11, expnt(s) = [301.40950059]
bas 12, expnt(s) = [314.46108618]
bas 13, expnt(s) = [82.7325278]
bas 14, expnt(s) = [9.76285348]
bas 15, expnt(s) = [27.27477677]
bas 16, expnt(s) = [0.83990882]
bas 17, expnt(s) = [3.56820914]
bas 18, expnt(s) = [0.23754901]
CPU time:       495.83
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825381e+04 5.20024532e+03 7.61786498e+03 2.06010795e+03
 3.61741887e+03 1.17845804e+03 1.60604378e+03 6.40963146e+02
 3.53923824e+02 2.06156661e+02 1.11712513e+02 8.68143247e+01
 3.65791283e+01 3.75785517e+01 4.58330531e+00 7.91405594e+00
 3.95461023e-01 1.25991947e+00 1.36276591e+03 2.41552184e+04
 6.64832792e+02 9.84860984e+03 3.01409501e+02 3.66378993e+03
 3.14461086e+02 3.86316298e+03 8.27325278e+01 7.27913477e+02
 9.76285348e+00 5.03448855e+01 2.72747768e+01 1.81838524e+02
 8.39908820e-01 2.34571135e+00 3.56820914e+00 1.43069569e+01
 2.37549014e-01 4.83811217e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97361983256757
cond(S) = 149082.9722912455
E1 = -728.7722433152574  E_coul = 203.12250564434376
init E= -525.649737670914
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558615206048214  LUMO = 1.15040360965017
  mo_energy =
[-1.18301862e+02 -1.21024254e+01 -9.44801866e+00 -9.44801866e+00
 -9.44801866e+00 -1.23014843e+00 -5.58615206e-01 -5.58615206e-01
 -5.58615206e-01  1.15040361e+00  1.15040361e+00  1.15040361e+00
  9.82618019e+00  9.82618019e+00  9.82618019e+00  4.73246735e+01
  4.73246735e+01  4.73246735e+01  7.98188017e+01  1.78400582e+02
  1.78400582e+02  1.78400582e+02  5.54605703e+02  5.73457985e+02
  5.73457985e+02  5.73457985e+02  1.43915149e+03  1.43915149e+03
  1.43915149e+03  2.57779517e+03  3.13605965e+03  3.13605965e+03
  3.13605965e+03  6.75186595e+03  6.75186595e+03  6.75186595e+03
  8.97381385e+03  2.53363745e+04  7.60868636e+04]
E1 = -728.0846878356558  E_coul = 201.65370206955419
cycle= 1 E= -526.430985766102  delta_E= -0.781  |g|= 0.188  |ddm|= 0.552
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.559265
diis-c [-0.31277683  1.        ]
  HOMO = -0.571923491198329  LUMO = 1.14102720282042
  mo_energy =
[-1.18573577e+02 -1.21978885e+01 -9.55031334e+00 -9.55031334e+00
 -9.55031334e+00 -1.25068722e+00 -5.71923491e-01 -5.71923491e-01
 -5.71923491e-01  1.14102720e+00  1.14102720e+00  1.14102720e+00
  9.75961729e+00  9.75961729e+00  9.75961729e+00  4.71939347e+01
  4.71939347e+01  4.71939347e+01  7.96529065e+01  1.78199026e+02
  1.78199026e+02  1.78199026e+02  5.54302788e+02  5.73189762e+02
  5.73189762e+02  5.73189762e+02  1.43882794e+03  1.43882794e+03
  1.43882794e+03  2.57733815e+03  3.13567144e+03  3.13567144e+03
  3.13567144e+03  6.75136179e+03  6.75136179e+03  6.75136179e+03
  8.97323165e+03  2.53356964e+04  7.60860939e+04]
E1 = -728.3727225427504  E_coul = 201.941369148634
cycle= 2 E= -526.431353394116  delta_E= -0.000368  |g|= 0.0238  |ddm|= 0.0203
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0462387
diis-c [-0.00141393  0.04600544  0.95399456]
  HOMO = -0.568367208580038  LUMO = 1.14416444676576
  mo_energy =
[-1.18531791e+02 -1.21781533e+01 -9.53020123e+00 -9.53020123e+00
 -9.53020123e+00 -1.24596802e+00 -5.68367209e-01 -5.68367209e-01
 -5.68367209e-01  1.14416445e+00  1.14416445e+00  1.14416445e+00
  9.77270568e+00  9.77270568e+00  9.77270568e+00  4.72180725e+01
  4.72180725e+01  4.72180725e+01  7.96866553e+01  1.78233880e+02
  1.78233880e+02  1.78233880e+02  5.54345873e+02  5.73231107e+02
  5.73231107e+02  5.73231107e+02  1.43887209e+03  1.43887209e+03
  1.43887209e+03  2.57738454e+03  3.13571718e+03  3.13571718e+03
  3.13571718e+03  6.75140853e+03  6.75140853e+03  6.75140853e+03
  8.97327879e+03  2.53357437e+04  7.60861412e+04]
E1 = -728.31416050597  E_coul = 201.88279490441755
cycle= 3 E= -526.431365601552  delta_E= -1.22e-05  |g|= 0.0029  |ddm|= 0.00505
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00626941
diis-c [-3.40090497e-07 -1.03856566e-03  1.12832265e-01  8.88206300e-01]
  HOMO = -0.56900521113644  LUMO = 1.14362224993298
  mo_energy =
[-1.18536922e+02 -1.21809199e+01 -9.53306852e+00 -9.53306852e+00
 -9.53306852e+00 -1.24679879e+00 -5.69005211e-01 -5.69005211e-01
 -5.69005211e-01  1.14362225e+00  1.14362225e+00  1.14362225e+00
  9.77069807e+00  9.77069807e+00  9.77069807e+00  4.72147940e+01
  4.72147940e+01  4.72147940e+01  7.96824936e+01  1.78229487e+02
  1.78229487e+02  1.78229487e+02  5.54340583e+02  5.73226030e+02
  5.73226030e+02  5.73226030e+02  1.43886668e+03  1.43886668e+03
  1.43886668e+03  2.57737873e+03  3.13571153e+03  3.13571153e+03
  3.13571153e+03  6.75140263e+03  6.75140263e+03  6.75140263e+03
  8.97327276e+03  2.53357375e+04  7.60861349e+04]
E1 = -728.3221383652311  E_coul = 201.8907724919182
cycle= 4 E= -526.431365873313  delta_E= -2.72e-07  |g|= 4.17e-05  |ddm|= 0.00075
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.54213e-05
diis-c [-1.62490114e-09  8.65608867e-06 -1.81372817e-03 -7.78673128e-03
  1.00959180e+00]
  HOMO = -0.568978389597501  LUMO = 1.14364431512252
  mo_energy =
[-1.18536829e+02 -1.21808340e+01 -9.53298344e+00 -9.53298344e+00
 -9.53298344e+00 -1.24676402e+00 -5.68978390e-01 -5.68978390e-01
 -5.68978390e-01  1.14364432e+00  1.14364432e+00  1.14364432e+00
  9.77076633e+00  9.77076633e+00  9.77076633e+00  4.72148798e+01
  4.72148798e+01  4.72148798e+01  7.96825895e+01  1.78229579e+02
  1.78229579e+02  1.78229579e+02  5.54340673e+02  5.73226123e+02
  5.73226123e+02  5.73226123e+02  1.43886677e+03  1.43886677e+03
  1.43886677e+03  2.57737882e+03  3.13571161e+03  3.13571161e+03
  3.13571161e+03  6.75140271e+03  6.75140271e+03  6.75140271e+03
  8.97327283e+03  2.53357376e+04  7.60861350e+04]
E1 = -728.3219394948102  E_coul = 201.89057362136407
cycle= 5 E= -526.431365873446  delta_E= -1.33e-10  |g|= 6.93e-06  |ddm|= 2.31e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3219394948102  E_coul = 201.89057362136407
  HOMO = -0.568981983231049  LUMO = 1.14364134260122
  mo_energy =
[-1.18536846e+02 -1.21808465e+01 -9.53299623e+00 -9.53299623e+00
 -9.53299623e+00 -1.24676868e+00 -5.68981983e-01 -5.68981983e-01
 -5.68981983e-01  1.14364134e+00  1.14364134e+00  1.14364134e+00
  9.77075656e+00  9.77075656e+00  9.77075656e+00  4.72148663e+01
  4.72148663e+01  4.72148663e+01  7.96825740e+01  1.78229563e+02
  1.78229563e+02  1.78229563e+02  5.54340656e+02  5.73226106e+02
  5.73226106e+02  5.73226106e+02  1.43886675e+03  1.43886675e+03
  1.43886675e+03  2.57737880e+03  3.13571159e+03  3.13571159e+03
  3.13571159e+03  6.75140269e+03  6.75140269e+03  6.75140269e+03
  8.97327282e+03  2.53357376e+04  7.60861350e+04]
E1 = -728.3219717353542  E_coul = 201.89060586190666
Extra cycle  E= -526.431365873447  delta_E= -1.36e-12  |g|= 1.74e-06  |ddm|= 3.5e-06
    CPU time for scf_cycle      0.67 sec, wall time      0.28 sec
exp = [2.61825381e+04 7.61786498e+03 3.61741887e+03 1.60604378e+03
 3.53923824e+02 1.11712513e+02 3.65791283e+01 4.58330531e+00
 3.95461023e-01 1.36276591e+03 6.64832792e+02 3.01409501e+02
 3.14461086e+02 8.27325278e+01 9.76285348e+00 2.72747768e+01
 8.39908820e-01 3.56820914e+00 2.37549014e-01]
E = -526.4313658734475
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:43:07 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5380503        1
[INPUT] 0    0    [1    /1   ]  7617.86497648        1
[INPUT] 0    0    [1    /1   ]  3617.41886692        1
[INPUT] 0    0    [1    /1   ]  1606.04378139        1
[INPUT] 0    0    [1    /1   ]  353.923823904        1
[INPUT] 0    0    [1    /1   ]  111.712513427        1
[INPUT] 0    0    [1    /1   ]  36.5791282985        1
[INPUT] 0    0    [1    /1   ]  4.58330531495        1
[INPUT] 0    0    [1    /1   ]  0.395461023128       1
[INPUT] 1    0    [1    /1   ]  1362.76591084        1
[INPUT] 1    0    [1    /1   ]  664.83279173         1
[INPUT] 1    0    [1    /1   ]  301.409500591        1
[INPUT] 1    0    [1    /1   ]  314.461086181        1
[INPUT] 1    0    [1    /1   ]  82.7325278033        1
[INPUT] 1    0    [1    /1   ]  9.76285348255        1
[INPUT] 1    0    [1    /1   ]  27.2747767682        1
[INPUT] 1    0    [1    /1   ]  0.839908820166       1
[INPUT] 1    0    [1    /1   ]  3.56820914458        1
[INPUT] 1    0    [1    /1   ]  0.237549014049       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.5380502874, 1.0]], [0, [7617.8649764829515, 1.0]], [0, [3617.4188669164923, 1.0]], [0, [1606.043781386353, 1.0]], [0, [353.92382390422, 1.0]], [0, [111.71251342703309, 1.0]], [0, [36.57912829853694, 1.0]], [0, [4.58330531495249, 1.0]], [0, [0.39546102312762693, 1.0]], [1, [1362.7659108391592, 1.0]], [1, [664.832791729802, 1.0]], [1, [301.40950059097884, 1.0]], [1, [314.4610861813685, 1.0]], [1, [82.73252780331642, 1.0]], [1, [9.762853482551403, 1.0]], [1, [27.274776768183138, 1.0]], [1, [0.8399088201664392, 1.0]], [1, [3.5682091445844315, 1.0]], [1, [0.2375490140485059, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.53805029]
bas 1, expnt(s) = [7617.86497648]
bas 2, expnt(s) = [3617.41886692]
bas 3, expnt(s) = [1606.04378139]
bas 4, expnt(s) = [353.9238239]
bas 5, expnt(s) = [111.71251343]
bas 6, expnt(s) = [36.5791283]
bas 7, expnt(s) = [4.58330531]
bas 8, expnt(s) = [0.39546102]
bas 9, expnt(s) = [1362.76591084]
bas 10, expnt(s) = [664.83279173]
bas 11, expnt(s) = [301.40950059]
bas 12, expnt(s) = [314.46108618]
bas 13, expnt(s) = [82.7325278]
bas 14, expnt(s) = [9.76285348]
bas 15, expnt(s) = [27.27477677]
bas 16, expnt(s) = [0.83990882]
bas 17, expnt(s) = [3.56820914]
bas 18, expnt(s) = [0.23754901]
CPU time:       496.70
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825381e+04 5.20024532e+03 7.61786498e+03 2.06010795e+03
 3.61741887e+03 1.17845804e+03 1.60604378e+03 6.40963146e+02
 3.53923824e+02 2.06156661e+02 1.11712513e+02 8.68143247e+01
 3.65791283e+01 3.75785517e+01 4.58330531e+00 7.91405594e+00
 3.95461023e-01 1.25991947e+00 1.36276591e+03 2.41552184e+04
 6.64832792e+02 9.84860984e+03 3.01409501e+02 3.66378993e+03
 3.14461086e+02 3.86316298e+03 8.27325278e+01 7.27913477e+02
 9.76285348e+00 5.03448855e+01 2.72747768e+01 1.81838524e+02
 8.39908820e-01 2.34571135e+00 3.56820914e+00 1.43069569e+01
 2.37549014e-01 4.83811217e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97361983256757
cond(S) = 149082.9722912455
E1 = -728.7722433152574  E_coul = 203.12250564434376
init E= -525.649737670914
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558615206048214  LUMO = 1.15040360965017
  mo_energy =
[-1.18301862e+02 -1.21024254e+01 -9.44801866e+00 -9.44801866e+00
 -9.44801866e+00 -1.23014843e+00 -5.58615206e-01 -5.58615206e-01
 -5.58615206e-01  1.15040361e+00  1.15040361e+00  1.15040361e+00
  9.82618019e+00  9.82618019e+00  9.82618019e+00  4.73246735e+01
  4.73246735e+01  4.73246735e+01  7.98188017e+01  1.78400582e+02
  1.78400582e+02  1.78400582e+02  5.54605703e+02  5.73457985e+02
  5.73457985e+02  5.73457985e+02  1.43915149e+03  1.43915149e+03
  1.43915149e+03  2.57779517e+03  3.13605965e+03  3.13605965e+03
  3.13605965e+03  6.75186595e+03  6.75186595e+03  6.75186595e+03
  8.97381385e+03  2.53363745e+04  7.60868636e+04]
E1 = -728.0846878356558  E_coul = 201.65370206955419
cycle= 1 E= -526.430985766102  delta_E= -0.781  |g|= 0.188  |ddm|= 0.552
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.559265
diis-c [-0.31277683  1.        ]
  HOMO = -0.571923491198329  LUMO = 1.14102720282042
  mo_energy =
[-1.18573577e+02 -1.21978885e+01 -9.55031334e+00 -9.55031334e+00
 -9.55031334e+00 -1.25068722e+00 -5.71923491e-01 -5.71923491e-01
 -5.71923491e-01  1.14102720e+00  1.14102720e+00  1.14102720e+00
  9.75961729e+00  9.75961729e+00  9.75961729e+00  4.71939347e+01
  4.71939347e+01  4.71939347e+01  7.96529065e+01  1.78199026e+02
  1.78199026e+02  1.78199026e+02  5.54302788e+02  5.73189762e+02
  5.73189762e+02  5.73189762e+02  1.43882794e+03  1.43882794e+03
  1.43882794e+03  2.57733815e+03  3.13567144e+03  3.13567144e+03
  3.13567144e+03  6.75136179e+03  6.75136179e+03  6.75136179e+03
  8.97323165e+03  2.53356964e+04  7.60860939e+04]
E1 = -728.3727225427504  E_coul = 201.941369148634
cycle= 2 E= -526.431353394116  delta_E= -0.000368  |g|= 0.0238  |ddm|= 0.0203
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0462387
diis-c [-0.00141393  0.04600544  0.95399456]
  HOMO = -0.568367208580038  LUMO = 1.14416444676576
  mo_energy =
[-1.18531791e+02 -1.21781533e+01 -9.53020123e+00 -9.53020123e+00
 -9.53020123e+00 -1.24596802e+00 -5.68367209e-01 -5.68367209e-01
 -5.68367209e-01  1.14416445e+00  1.14416445e+00  1.14416445e+00
  9.77270568e+00  9.77270568e+00  9.77270568e+00  4.72180725e+01
  4.72180725e+01  4.72180725e+01  7.96866553e+01  1.78233880e+02
  1.78233880e+02  1.78233880e+02  5.54345873e+02  5.73231107e+02
  5.73231107e+02  5.73231107e+02  1.43887209e+03  1.43887209e+03
  1.43887209e+03  2.57738454e+03  3.13571718e+03  3.13571718e+03
  3.13571718e+03  6.75140853e+03  6.75140853e+03  6.75140853e+03
  8.97327879e+03  2.53357437e+04  7.60861412e+04]
E1 = -728.31416050597  E_coul = 201.88279490441755
cycle= 3 E= -526.431365601552  delta_E= -1.22e-05  |g|= 0.0029  |ddm|= 0.00505
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00626941
diis-c [-3.40090497e-07 -1.03856566e-03  1.12832265e-01  8.88206300e-01]
  HOMO = -0.56900521113644  LUMO = 1.14362224993298
  mo_energy =
[-1.18536922e+02 -1.21809199e+01 -9.53306852e+00 -9.53306852e+00
 -9.53306852e+00 -1.24679879e+00 -5.69005211e-01 -5.69005211e-01
 -5.69005211e-01  1.14362225e+00  1.14362225e+00  1.14362225e+00
  9.77069807e+00  9.77069807e+00  9.77069807e+00  4.72147940e+01
  4.72147940e+01  4.72147940e+01  7.96824936e+01  1.78229487e+02
  1.78229487e+02  1.78229487e+02  5.54340583e+02  5.73226030e+02
  5.73226030e+02  5.73226030e+02  1.43886668e+03  1.43886668e+03
  1.43886668e+03  2.57737873e+03  3.13571153e+03  3.13571153e+03
  3.13571153e+03  6.75140263e+03  6.75140263e+03  6.75140263e+03
  8.97327276e+03  2.53357375e+04  7.60861349e+04]
E1 = -728.3221383652311  E_coul = 201.8907724919182
cycle= 4 E= -526.431365873313  delta_E= -2.72e-07  |g|= 4.17e-05  |ddm|= 0.00075
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.54213e-05
diis-c [-1.62490114e-09  8.65608867e-06 -1.81372817e-03 -7.78673128e-03
  1.00959180e+00]
  HOMO = -0.568978389597501  LUMO = 1.14364431512252
  mo_energy =
[-1.18536829e+02 -1.21808340e+01 -9.53298344e+00 -9.53298344e+00
 -9.53298344e+00 -1.24676402e+00 -5.68978390e-01 -5.68978390e-01
 -5.68978390e-01  1.14364432e+00  1.14364432e+00  1.14364432e+00
  9.77076633e+00  9.77076633e+00  9.77076633e+00  4.72148798e+01
  4.72148798e+01  4.72148798e+01  7.96825895e+01  1.78229579e+02
  1.78229579e+02  1.78229579e+02  5.54340673e+02  5.73226123e+02
  5.73226123e+02  5.73226123e+02  1.43886677e+03  1.43886677e+03
  1.43886677e+03  2.57737882e+03  3.13571161e+03  3.13571161e+03
  3.13571161e+03  6.75140271e+03  6.75140271e+03  6.75140271e+03
  8.97327283e+03  2.53357376e+04  7.60861350e+04]
E1 = -728.3219394948102  E_coul = 201.89057362136407
cycle= 5 E= -526.431365873446  delta_E= -1.33e-10  |g|= 6.93e-06  |ddm|= 2.31e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3219394948102  E_coul = 201.89057362136407
  HOMO = -0.568981983231049  LUMO = 1.14364134260122
  mo_energy =
[-1.18536846e+02 -1.21808465e+01 -9.53299623e+00 -9.53299623e+00
 -9.53299623e+00 -1.24676868e+00 -5.68981983e-01 -5.68981983e-01
 -5.68981983e-01  1.14364134e+00  1.14364134e+00  1.14364134e+00
  9.77075656e+00  9.77075656e+00  9.77075656e+00  4.72148663e+01
  4.72148663e+01  4.72148663e+01  7.96825740e+01  1.78229563e+02
  1.78229563e+02  1.78229563e+02  5.54340656e+02  5.73226106e+02
  5.73226106e+02  5.73226106e+02  1.43886675e+03  1.43886675e+03
  1.43886675e+03  2.57737880e+03  3.13571159e+03  3.13571159e+03
  3.13571159e+03  6.75140269e+03  6.75140269e+03  6.75140269e+03
  8.97327282e+03  2.53357376e+04  7.60861350e+04]
E1 = -728.3219717353542  E_coul = 201.89060586190666
Extra cycle  E= -526.431365873447  delta_E= -1.36e-12  |g|= 1.74e-06  |ddm|= 3.5e-06
    CPU time for scf_cycle      0.66 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 149082.9722912455
E1 = -728.3219717353542  E_coul = 201.89060586190666
init E= -526.431365873447
    CPU time for initialize scf      2.72 sec, wall time      0.24 sec
  HOMO = -0.56898137889528  LUMO = 1.14364185020241
  mo_energy =
[-1.18536842e+02 -1.21808442e+01 -9.53299380e+00 -9.53299380e+00
 -9.53299380e+00 -1.24676790e+00 -5.68981379e-01 -5.68981379e-01
 -5.68981379e-01  1.14364185e+00  1.14364185e+00  1.14364185e+00
  9.77075833e+00  9.77075833e+00  9.77075833e+00  4.72148690e+01
  4.72148690e+01  4.72148690e+01  7.96825773e+01  1.78229567e+02
  1.78229567e+02  1.78229567e+02  5.54340660e+02  5.73226110e+02
  5.73226110e+02  5.73226110e+02  1.43886675e+03  1.43886675e+03
  1.43886675e+03  2.57737880e+03  3.13571160e+03  3.13571160e+03
  3.13571160e+03  6.75140270e+03  6.75140270e+03  6.75140270e+03
  8.97327282e+03  2.53357376e+04  7.60861350e+04]
E1 = -728.3219652928055  E_coul = 201.89059941935815
cycle= 1 E= -526.431365873447  delta_E= 1.14e-13  |g|= 3.8e-07  |ddm|= 6.41e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3219652928055  E_coul = 201.89059941935815
  HOMO = -0.568981492245613  LUMO = 1.14364175438434
  mo_energy =
[-1.18536843e+02 -1.21808446e+01 -9.53299429e+00 -9.53299429e+00
 -9.53299429e+00 -1.24676805e+00 -5.68981492e-01 -5.68981492e-01
 -5.68981492e-01  1.14364175e+00  1.14364175e+00  1.14364175e+00
  9.77075798e+00  9.77075798e+00  9.77075798e+00  4.72148684e+01
  4.72148684e+01  4.72148684e+01  7.96825766e+01  1.78229566e+02
  1.78229566e+02  1.78229566e+02  5.54340659e+02  5.73226109e+02
  5.73226109e+02  5.73226109e+02  1.43886675e+03  1.43886675e+03
  1.43886675e+03  2.57737880e+03  3.13571160e+03  3.13571160e+03
  3.13571160e+03  6.75140270e+03  6.75140270e+03  6.75140270e+03
  8.97327282e+03  2.53357376e+04  7.60861350e+04]
E1 = -728.3219666012989  E_coul = 201.89060072785247
Extra cycle  E= -526.431365873446  delta_E= 1.02e-12  |g|= 7.98e-08  |ddm|= 1.27e-07
    CPU time for scf_cycle      2.86 sec, wall time      0.39 sec
exp = [2.61825381e+04 7.61786498e+03 3.61741887e+03 1.60604378e+03
 3.53923824e+02 1.11712513e+02 3.65791283e+01 4.58330531e+00
 3.95461023e-01 1.36276591e+03 6.64832792e+02 3.01409501e+02
 3.14461086e+02 8.27325278e+01 9.76285348e+00 2.72747768e+01
 8.39908820e-01 3.56820914e+00 2.37549014e-01]
grad_E = [-1.75694641e-06  7.11996549e-06  3.77948018e-06  1.98756250e-04
 -2.05619630e-03  5.86755804e-03 -4.63789087e-03 -2.22662998e-03
  8.76441162e-03 -4.86994421e-07  1.54879965e-07 -3.23916862e-07
 -1.35531741e-07  2.92835089e-04  4.63445208e-03 -8.38343941e-04
 -1.76148308e-02  7.30459030e-03  9.73252261e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:43:11 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5376372        1
[INPUT] 0    0    [1    /1   ]  7617.87031996        1
[INPUT] 0    0    [1    /1   ]  3617.43044759        1
[INPUT] 0    0    [1    /1   ]  1606.21305345        1
[INPUT] 0    0    [1    /1   ]  352.294165785        1
[INPUT] 0    0    [1    /1   ]  111.037992505        1
[INPUT] 0    0    [1    /1   ]  36.4425997809        1
[INPUT] 0    0    [1    /1   ]  4.58468626633        1
[INPUT] 0    0    [1    /1   ]  0.395876579516       1
[INPUT] 1    0    [1    /1   ]  1362.76629881        1
[INPUT] 1    0    [1    /1   ]  664.837696346        1
[INPUT] 1    0    [1    /1   ]  301.436493776        1
[INPUT] 1    0    [1    /1   ]  314.484889105        1
[INPUT] 1    0    [1    /1   ]  82.2183379242        1
[INPUT] 1    0    [1    /1   ]  9.73110125908        1
[INPUT] 1    0    [1    /1   ]  27.226162483         1
[INPUT] 1    0    [1    /1   ]  0.840900222883       1
[INPUT] 1    0    [1    /1   ]  3.5406490851         1
[INPUT] 1    0    [1    /1   ]  0.238238108326       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.5376372157, 1.0]], [0, [7617.8703199591555, 1.0]], [0, [3617.43044759401, 1.0]], [0, [1606.2130534478333, 1.0]], [0, [352.2941657854065, 1.0]], [0, [111.03799250502068, 1.0]], [0, [36.442599780866374, 1.0]], [0, [4.5846862663273935, 1.0]], [0, [0.3958765795162432, 1.0]], [1, [1362.7662988092986, 1.0]], [1, [664.8376963456825, 1.0]], [1, [301.43649377634927, 1.0]], [1, [314.48488910463925, 1.0]], [1, [82.21833792424819, 1.0]], [1, [9.73110125908303, 1.0]], [1, [27.226162482953956, 1.0]], [1, [0.8409002228826804, 1.0]], [1, [3.540649085097188, 1.0]], [1, [0.23823810832589526, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.53763722]
bas 1, expnt(s) = [7617.87031996]
bas 2, expnt(s) = [3617.43044759]
bas 3, expnt(s) = [1606.21305345]
bas 4, expnt(s) = [352.29416579]
bas 5, expnt(s) = [111.03799251]
bas 6, expnt(s) = [36.44259978]
bas 7, expnt(s) = [4.58468627]
bas 8, expnt(s) = [0.39587658]
bas 9, expnt(s) = [1362.76629881]
bas 10, expnt(s) = [664.83769635]
bas 11, expnt(s) = [301.43649378]
bas 12, expnt(s) = [314.4848891]
bas 13, expnt(s) = [82.21833792]
bas 14, expnt(s) = [9.73110126]
bas 15, expnt(s) = [27.22616248]
bas 16, expnt(s) = [0.84090022]
bas 17, expnt(s) = [3.54064909]
bas 18, expnt(s) = [0.23823811]
CPU time:       504.91
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825376e+04 5.20024526e+03 7.61787032e+03 2.06010903e+03
 3.61743045e+03 1.17846087e+03 1.60621305e+03 6.41013812e+02
 3.52294166e+02 2.05444308e+02 1.11037993e+02 8.64208882e+01
 3.64425998e+01 3.74733085e+01 4.58468627e+00 7.91584425e+00
 3.95876580e-01 1.26091230e+00 1.36276630e+03 2.41552270e+04
 6.64837696e+02 9.84870066e+03 3.01436494e+02 3.66420008e+03
 3.14484889e+02 3.86352850e+03 8.22183379e+01 7.22262820e+02
 9.73110126e+00 5.01402947e+01 2.72261625e+01 1.81433481e+02
 8.40900223e-01 2.34917287e+00 3.54064909e+00 1.41689608e+01
 2.38238108e-01 4.85566183e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.973483114336336
cond(S) = 147974.53005948744
E1 = -728.7865631014981  E_coul = 203.13166414101426
init E= -525.654898960484
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558355554884994  LUMO = 1.1539257844387
  mo_energy =
[-1.18300948e+02 -1.21018162e+01 -9.44738490e+00 -9.44738490e+00
 -9.44738490e+00 -1.22993904e+00 -5.58355555e-01 -5.58355555e-01
 -5.58355555e-01  1.15392578e+00  1.15392578e+00  1.15392578e+00
  9.76695874e+00  9.76695874e+00  9.76695874e+00  4.71133337e+01
  4.71133337e+01  4.71133337e+01  7.92871729e+01  1.77636559e+02
  1.77636559e+02  1.77636559e+02  5.51269977e+02  5.71849326e+02
  5.71849326e+02  5.71849326e+02  1.43720215e+03  1.43720215e+03
  1.43720215e+03  2.57051486e+03  3.13408215e+03  3.13408215e+03
  3.13408215e+03  6.75001987e+03  6.75001987e+03  6.75001987e+03
  8.96553903e+03  2.53282515e+04  7.60792483e+04]
E1 = -728.0996654405437  E_coul = 201.66837238001855
cycle= 1 E= -526.431293060525  delta_E= -0.776  |g|= 0.188  |ddm|= 0.553
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.559201
diis-c [-0.31270625  1.        ]
  HOMO = -0.571341446044264  LUMO = 1.14479531325425
  mo_energy =
[-1.18572391e+02 -1.21970502e+01 -9.54936228e+00 -9.54936228e+00
 -9.54936228e+00 -1.25012785e+00 -5.71341446e-01 -5.71341446e-01
 -5.71341446e-01  1.14479531e+00  1.14479531e+00  1.14479531e+00
  9.70110062e+00  9.70110062e+00  9.70110062e+00  4.69830254e+01
  4.69830254e+01  4.69830254e+01  7.91216887e+01  1.77435450e+02
  1.77435450e+02  1.77435450e+02  5.50967767e+02  5.71581366e+02
  5.71581366e+02  5.71581366e+02  1.43687880e+03  1.43687880e+03
  1.43687880e+03  2.57005813e+03  3.13369415e+03  3.13369415e+03
  3.13369415e+03  6.74951585e+03  6.74951585e+03  6.74951585e+03
  8.96495691e+03  2.53275734e+04  7.60784785e+04]
E1 = -728.3863118679586  E_coul = 201.9546530516603
cycle= 2 E= -526.431658816298  delta_E= -0.000366  |g|= 0.0238  |ddm|= 0.0201
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0462228
diis-c [-0.00141441  0.04595124  0.95404876]
  HOMO = -0.567819224513374  LUMO = 1.14790824276268
  mo_energy =
[-1.18530709e+02 -1.21774162e+01 -9.52935192e+00 -9.52935192e+00
 -9.52935192e+00 -1.24544975e+00 -5.67819225e-01 -5.67819225e-01
 -5.67819225e-01  1.14790824e+00  1.14790824e+00  1.14790824e+00
  9.71405335e+00  9.71405335e+00  9.71405335e+00  4.70070334e+01
  4.70070334e+01  4.70070334e+01  7.91552649e+01  1.77470167e+02
  1.77470167e+02  1.77470167e+02  5.51010728e+02  5.71622601e+02
  5.71622601e+02  5.71622601e+02  1.43692285e+03  1.43692285e+03
  1.43692285e+03  2.57010443e+03  3.13373979e+03  3.13373979e+03
  3.13373979e+03  6.74956250e+03  6.74956250e+03  6.74956250e+03
  8.96500396e+03  2.53276206e+04  7.60785258e+04]
E1 = -728.3279988540772  E_coul = 201.89632790220747
cycle= 3 E= -526.43167095187  delta_E= -1.21e-05  |g|= 0.0029  |ddm|= 0.00501
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00626616
diis-c [-3.37790452e-07 -1.03755625e-03  1.12827840e-01  8.88209716e-01]
  HOMO = -0.568453103102543  LUMO = 1.14736876725615
  mo_energy =
[-1.18535829e+02 -1.21801726e+01 -9.53220879e+00 -9.53220879e+00
 -9.53220879e+00 -1.24627564e+00 -5.68453103e-01 -5.68453103e-01
 -5.68453103e-01  1.14736877e+00  1.14736877e+00  1.14736877e+00
  9.71206153e+00  9.71206153e+00  9.71206153e+00  4.70037683e+01
  4.70037683e+01  4.70037683e+01  7.91511201e+01  1.77465787e+02
  1.77465787e+02  1.77465787e+02  5.51005451e+02  5.71617536e+02
  5.71617536e+02  5.71617536e+02  1.43691745e+03  1.43691745e+03
  1.43691745e+03  2.57009863e+03  3.13373415e+03  3.13373415e+03
  3.13373415e+03  6.74955662e+03  6.74955662e+03  6.74955662e+03
  8.96499795e+03  2.53276145e+04  7.60785196e+04]
E1 = -728.3359430594126  E_coul = 201.90427183757132
cycle= 4 E= -526.431671221841  delta_E= -2.7e-07  |g|= 4.16e-05  |ddm|= 0.000745
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.52401e-05
diis-c [-1.62181829e-09  8.51769851e-06 -1.78658115e-03 -7.61170115e-03
  1.00938976e+00]
  HOMO = -0.568426390361451  LUMO = 1.14739076921946
  mo_energy =
[-1.18535736e+02 -1.21800869e+01 -9.53212399e+00 -9.53212399e+00
 -9.53212399e+00 -1.24624098e+00 -5.68426390e-01 -5.68426390e-01
 -5.68426390e-01  1.14739077e+00  1.14739077e+00  1.14739077e+00
  9.71212939e+00  9.71212939e+00  9.71212939e+00  4.70038538e+01
  4.70038538e+01  4.70038538e+01  7.91512156e+01  1.77465879e+02
  1.77465879e+02  1.77465879e+02  5.51005541e+02  5.71617629e+02
  5.71617629e+02  5.71617629e+02  1.43691754e+03  1.43691754e+03
  1.43691754e+03  2.57009871e+03  3.13373423e+03  3.13373423e+03
  3.13373423e+03  6.74955670e+03  6.74955670e+03  6.74955670e+03
  8.96499802e+03  2.53276146e+04  7.60785196e+04]
E1 = -728.3357452684251  E_coul = 201.90407404645512
cycle= 5 E= -526.43167122197  delta_E= -1.29e-10  |g|= 6.91e-06  |ddm|= 2.3e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3357452684251  E_coul = 201.90407404645512
  HOMO = -0.568429958397661  LUMO = 1.14738781419209
  mo_energy =
[-1.18535754e+02 -1.21800994e+01 -9.53213671e+00 -9.53213671e+00
 -9.53213671e+00 -1.24624561e+00 -5.68429958e-01 -5.68429958e-01
 -5.68429958e-01  1.14738781e+00  1.14738781e+00  1.14738781e+00
  9.71211970e+00  9.71211970e+00  9.71211970e+00  4.70038403e+01
  4.70038403e+01  4.70038403e+01  7.91512002e+01  1.77465864e+02
  1.77465864e+02  1.77465864e+02  5.51005524e+02  5.71617612e+02
  5.71617612e+02  5.71617612e+02  1.43691752e+03  1.43691752e+03
  1.43691752e+03  2.57009870e+03  3.13373422e+03  3.13373422e+03
  3.13373422e+03  6.74955668e+03  6.74955668e+03  6.74955668e+03
  8.96499800e+03  2.53276146e+04  7.60785196e+04]
E1 = -728.3357772829554  E_coul = 201.90410606098197
Extra cycle  E= -526.431671221973  delta_E= -3.41e-12  |g|= 1.73e-06  |ddm|= 3.47e-06
    CPU time for scf_cycle      0.67 sec, wall time      0.28 sec
exp = [2.61825376e+04 7.61787032e+03 3.61743045e+03 1.60621305e+03
 3.52294166e+02 1.11037993e+02 3.64425998e+01 4.58468627e+00
 3.95876580e-01 1.36276630e+03 6.64837696e+02 3.01436494e+02
 3.14484889e+02 8.22183379e+01 9.73110126e+00 2.72261625e+01
 8.40900223e-01 3.54064909e+00 2.38238108e-01]
E = -526.4316712219734
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:43:12 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5376372        1
[INPUT] 0    0    [1    /1   ]  7617.87031996        1
[INPUT] 0    0    [1    /1   ]  3617.43044759        1
[INPUT] 0    0    [1    /1   ]  1606.21305345        1
[INPUT] 0    0    [1    /1   ]  352.294165785        1
[INPUT] 0    0    [1    /1   ]  111.037992505        1
[INPUT] 0    0    [1    /1   ]  36.4425997809        1
[INPUT] 0    0    [1    /1   ]  4.58468626633        1
[INPUT] 0    0    [1    /1   ]  0.395876579516       1
[INPUT] 1    0    [1    /1   ]  1362.76629881        1
[INPUT] 1    0    [1    /1   ]  664.837696346        1
[INPUT] 1    0    [1    /1   ]  301.436493776        1
[INPUT] 1    0    [1    /1   ]  314.484889105        1
[INPUT] 1    0    [1    /1   ]  82.2183379242        1
[INPUT] 1    0    [1    /1   ]  9.73110125908        1
[INPUT] 1    0    [1    /1   ]  27.226162483         1
[INPUT] 1    0    [1    /1   ]  0.840900222883       1
[INPUT] 1    0    [1    /1   ]  3.5406490851         1
[INPUT] 1    0    [1    /1   ]  0.238238108326       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.5376372157, 1.0]], [0, [7617.8703199591555, 1.0]], [0, [3617.43044759401, 1.0]], [0, [1606.2130534478333, 1.0]], [0, [352.2941657854065, 1.0]], [0, [111.03799250502068, 1.0]], [0, [36.442599780866374, 1.0]], [0, [4.5846862663273935, 1.0]], [0, [0.3958765795162432, 1.0]], [1, [1362.7662988092986, 1.0]], [1, [664.8376963456825, 1.0]], [1, [301.43649377634927, 1.0]], [1, [314.48488910463925, 1.0]], [1, [82.21833792424819, 1.0]], [1, [9.73110125908303, 1.0]], [1, [27.226162482953956, 1.0]], [1, [0.8409002228826804, 1.0]], [1, [3.540649085097188, 1.0]], [1, [0.23823810832589526, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.53763722]
bas 1, expnt(s) = [7617.87031996]
bas 2, expnt(s) = [3617.43044759]
bas 3, expnt(s) = [1606.21305345]
bas 4, expnt(s) = [352.29416579]
bas 5, expnt(s) = [111.03799251]
bas 6, expnt(s) = [36.44259978]
bas 7, expnt(s) = [4.58468627]
bas 8, expnt(s) = [0.39587658]
bas 9, expnt(s) = [1362.76629881]
bas 10, expnt(s) = [664.83769635]
bas 11, expnt(s) = [301.43649378]
bas 12, expnt(s) = [314.4848891]
bas 13, expnt(s) = [82.21833792]
bas 14, expnt(s) = [9.73110126]
bas 15, expnt(s) = [27.22616248]
bas 16, expnt(s) = [0.84090022]
bas 17, expnt(s) = [3.54064909]
bas 18, expnt(s) = [0.23823811]
CPU time:       505.78
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825376e+04 5.20024526e+03 7.61787032e+03 2.06010903e+03
 3.61743045e+03 1.17846087e+03 1.60621305e+03 6.41013812e+02
 3.52294166e+02 2.05444308e+02 1.11037993e+02 8.64208882e+01
 3.64425998e+01 3.74733085e+01 4.58468627e+00 7.91584425e+00
 3.95876580e-01 1.26091230e+00 1.36276630e+03 2.41552270e+04
 6.64837696e+02 9.84870066e+03 3.01436494e+02 3.66420008e+03
 3.14484889e+02 3.86352850e+03 8.22183379e+01 7.22262820e+02
 9.73110126e+00 5.01402947e+01 2.72261625e+01 1.81433481e+02
 8.40900223e-01 2.34917287e+00 3.54064909e+00 1.41689608e+01
 2.38238108e-01 4.85566183e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.973483114336336
cond(S) = 147974.53005948744
E1 = -728.7865631014981  E_coul = 203.13166414101426
init E= -525.654898960484
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558355554884994  LUMO = 1.1539257844387
  mo_energy =
[-1.18300948e+02 -1.21018162e+01 -9.44738490e+00 -9.44738490e+00
 -9.44738490e+00 -1.22993904e+00 -5.58355555e-01 -5.58355555e-01
 -5.58355555e-01  1.15392578e+00  1.15392578e+00  1.15392578e+00
  9.76695874e+00  9.76695874e+00  9.76695874e+00  4.71133337e+01
  4.71133337e+01  4.71133337e+01  7.92871729e+01  1.77636559e+02
  1.77636559e+02  1.77636559e+02  5.51269977e+02  5.71849326e+02
  5.71849326e+02  5.71849326e+02  1.43720215e+03  1.43720215e+03
  1.43720215e+03  2.57051486e+03  3.13408215e+03  3.13408215e+03
  3.13408215e+03  6.75001987e+03  6.75001987e+03  6.75001987e+03
  8.96553903e+03  2.53282515e+04  7.60792483e+04]
E1 = -728.0996654405437  E_coul = 201.66837238001855
cycle= 1 E= -526.431293060525  delta_E= -0.776  |g|= 0.188  |ddm|= 0.553
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.559201
diis-c [-0.31270625  1.        ]
  HOMO = -0.571341446044264  LUMO = 1.14479531325425
  mo_energy =
[-1.18572391e+02 -1.21970502e+01 -9.54936228e+00 -9.54936228e+00
 -9.54936228e+00 -1.25012785e+00 -5.71341446e-01 -5.71341446e-01
 -5.71341446e-01  1.14479531e+00  1.14479531e+00  1.14479531e+00
  9.70110062e+00  9.70110062e+00  9.70110062e+00  4.69830254e+01
  4.69830254e+01  4.69830254e+01  7.91216887e+01  1.77435450e+02
  1.77435450e+02  1.77435450e+02  5.50967767e+02  5.71581366e+02
  5.71581366e+02  5.71581366e+02  1.43687880e+03  1.43687880e+03
  1.43687880e+03  2.57005813e+03  3.13369415e+03  3.13369415e+03
  3.13369415e+03  6.74951585e+03  6.74951585e+03  6.74951585e+03
  8.96495691e+03  2.53275734e+04  7.60784785e+04]
E1 = -728.3863118679586  E_coul = 201.9546530516603
cycle= 2 E= -526.431658816298  delta_E= -0.000366  |g|= 0.0238  |ddm|= 0.0201
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0462228
diis-c [-0.00141441  0.04595124  0.95404876]
  HOMO = -0.567819224513374  LUMO = 1.14790824276268
  mo_energy =
[-1.18530709e+02 -1.21774162e+01 -9.52935192e+00 -9.52935192e+00
 -9.52935192e+00 -1.24544975e+00 -5.67819225e-01 -5.67819225e-01
 -5.67819225e-01  1.14790824e+00  1.14790824e+00  1.14790824e+00
  9.71405335e+00  9.71405335e+00  9.71405335e+00  4.70070334e+01
  4.70070334e+01  4.70070334e+01  7.91552649e+01  1.77470167e+02
  1.77470167e+02  1.77470167e+02  5.51010728e+02  5.71622601e+02
  5.71622601e+02  5.71622601e+02  1.43692285e+03  1.43692285e+03
  1.43692285e+03  2.57010443e+03  3.13373979e+03  3.13373979e+03
  3.13373979e+03  6.74956250e+03  6.74956250e+03  6.74956250e+03
  8.96500396e+03  2.53276206e+04  7.60785258e+04]
E1 = -728.3279988540772  E_coul = 201.89632790220747
cycle= 3 E= -526.43167095187  delta_E= -1.21e-05  |g|= 0.0029  |ddm|= 0.00501
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00626616
diis-c [-3.37790452e-07 -1.03755625e-03  1.12827840e-01  8.88209716e-01]
  HOMO = -0.568453103102543  LUMO = 1.14736876725615
  mo_energy =
[-1.18535829e+02 -1.21801726e+01 -9.53220879e+00 -9.53220879e+00
 -9.53220879e+00 -1.24627564e+00 -5.68453103e-01 -5.68453103e-01
 -5.68453103e-01  1.14736877e+00  1.14736877e+00  1.14736877e+00
  9.71206153e+00  9.71206153e+00  9.71206153e+00  4.70037683e+01
  4.70037683e+01  4.70037683e+01  7.91511201e+01  1.77465787e+02
  1.77465787e+02  1.77465787e+02  5.51005451e+02  5.71617536e+02
  5.71617536e+02  5.71617536e+02  1.43691745e+03  1.43691745e+03
  1.43691745e+03  2.57009863e+03  3.13373415e+03  3.13373415e+03
  3.13373415e+03  6.74955662e+03  6.74955662e+03  6.74955662e+03
  8.96499795e+03  2.53276145e+04  7.60785196e+04]
E1 = -728.3359430594126  E_coul = 201.90427183757132
cycle= 4 E= -526.431671221841  delta_E= -2.7e-07  |g|= 4.16e-05  |ddm|= 0.000745
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.52401e-05
diis-c [-1.62181829e-09  8.51769851e-06 -1.78658115e-03 -7.61170115e-03
  1.00938976e+00]
  HOMO = -0.568426390361451  LUMO = 1.14739076921946
  mo_energy =
[-1.18535736e+02 -1.21800869e+01 -9.53212399e+00 -9.53212399e+00
 -9.53212399e+00 -1.24624098e+00 -5.68426390e-01 -5.68426390e-01
 -5.68426390e-01  1.14739077e+00  1.14739077e+00  1.14739077e+00
  9.71212939e+00  9.71212939e+00  9.71212939e+00  4.70038538e+01
  4.70038538e+01  4.70038538e+01  7.91512156e+01  1.77465879e+02
  1.77465879e+02  1.77465879e+02  5.51005541e+02  5.71617629e+02
  5.71617629e+02  5.71617629e+02  1.43691754e+03  1.43691754e+03
  1.43691754e+03  2.57009871e+03  3.13373423e+03  3.13373423e+03
  3.13373423e+03  6.74955670e+03  6.74955670e+03  6.74955670e+03
  8.96499802e+03  2.53276146e+04  7.60785196e+04]
E1 = -728.3357452684251  E_coul = 201.90407404645512
cycle= 5 E= -526.43167122197  delta_E= -1.29e-10  |g|= 6.91e-06  |ddm|= 2.3e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3357452684251  E_coul = 201.90407404645512
  HOMO = -0.568429958397661  LUMO = 1.14738781419209
  mo_energy =
[-1.18535754e+02 -1.21800994e+01 -9.53213671e+00 -9.53213671e+00
 -9.53213671e+00 -1.24624561e+00 -5.68429958e-01 -5.68429958e-01
 -5.68429958e-01  1.14738781e+00  1.14738781e+00  1.14738781e+00
  9.71211970e+00  9.71211970e+00  9.71211970e+00  4.70038403e+01
  4.70038403e+01  4.70038403e+01  7.91512002e+01  1.77465864e+02
  1.77465864e+02  1.77465864e+02  5.51005524e+02  5.71617612e+02
  5.71617612e+02  5.71617612e+02  1.43691752e+03  1.43691752e+03
  1.43691752e+03  2.57009870e+03  3.13373422e+03  3.13373422e+03
  3.13373422e+03  6.74955668e+03  6.74955668e+03  6.74955668e+03
  8.96499800e+03  2.53276146e+04  7.60785196e+04]
E1 = -728.3357772829554  E_coul = 201.90410606098197
Extra cycle  E= -526.431671221973  delta_E= -3.41e-12  |g|= 1.73e-06  |ddm|= 3.47e-06
    CPU time for scf_cycle      0.65 sec, wall time      0.26 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 147974.53005948744
E1 = -728.3357772829554  E_coul = 201.90410606098197
init E= -526.431671221973
    CPU time for initialize scf      2.77 sec, wall time      0.25 sec
  HOMO = -0.568429359605774  LUMO = 1.14738831782312
  mo_energy =
[-1.18535750e+02 -1.21800970e+01 -9.53213430e+00 -9.53213430e+00
 -9.53213430e+00 -1.24624483e+00 -5.68429360e-01 -5.68429360e-01
 -5.68429360e-01  1.14738832e+00  1.14738832e+00  1.14738832e+00
  9.71212146e+00  9.71212146e+00  9.71212146e+00  4.70038430e+01
  4.70038430e+01  4.70038430e+01  7.91512035e+01  1.77465867e+02
  1.77465867e+02  1.77465867e+02  5.51005528e+02  5.71617615e+02
  5.71617615e+02  5.71617615e+02  1.43691753e+03  1.43691753e+03
  1.43691753e+03  2.57009870e+03  3.13373422e+03  3.13373422e+03
  3.13373422e+03  6.74955668e+03  6.74955668e+03  6.74955668e+03
  8.96499801e+03  2.53276146e+04  7.60785196e+04]
E1 = -728.3357708912538  E_coul = 201.90409966928064
cycle= 1 E= -526.431671221973  delta_E= 2.27e-13  |g|= 3.78e-07  |ddm|= 6.35e-07
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
E1 = -728.3357708912538  E_coul = 201.90409966928064
  HOMO = -0.568429471784837  LUMO = 1.14738822286278
  mo_energy =
[-1.18535751e+02 -1.21800975e+01 -9.53213478e+00 -9.53213478e+00
 -9.53213478e+00 -1.24624498e+00 -5.68429472e-01 -5.68429472e-01
 -5.68429472e-01  1.14738822e+00  1.14738822e+00  1.14738822e+00
  9.71212112e+00  9.71212112e+00  9.71212112e+00  4.70038425e+01
  4.70038425e+01  4.70038425e+01  7.91512028e+01  1.77465866e+02
  1.77465866e+02  1.77465866e+02  5.51005527e+02  5.71617615e+02
  5.71617615e+02  5.71617615e+02  1.43691753e+03  1.43691753e+03
  1.43691753e+03  2.57009870e+03  3.13373422e+03  3.13373422e+03
  3.13373422e+03  6.74955668e+03  6.74955668e+03  6.74955668e+03
  8.96499801e+03  2.53276146e+04  7.60785196e+04]
E1 = -728.3357721885682  E_coul = 201.9041009665948
Extra cycle  E= -526.431671221973  delta_E= -2.27e-13  |g|= 7.94e-08  |ddm|= 1.25e-07
    CPU time for scf_cycle      2.92 sec, wall time      0.40 sec
exp = [2.61825376e+04 7.61787032e+03 3.61743045e+03 1.60621305e+03
 3.52294166e+02 1.11037993e+02 3.64425998e+01 4.58468627e+00
 3.95876580e-01 1.36276630e+03 6.64837696e+02 3.01436494e+02
 3.14484889e+02 8.22183379e+01 9.73110126e+00 2.72261625e+01
 8.40900223e-01 3.54064909e+00 2.38238108e-01]
grad_E = [-1.76199708e-06  7.23284060e-06  3.99944817e-06  2.02375648e-04
 -2.09187704e-03  5.84789945e-03 -4.60364064e-03 -6.02243247e-04
  1.54767483e-02 -5.08016130e-07  1.97834186e-07 -2.06177888e-07
 -6.24962110e-08  2.75643669e-04  6.31062070e-03 -8.80987969e-04
 -1.73206197e-02  1.32082813e-03  2.56301021e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:43:16 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5372149        1
[INPUT] 0    0    [1    /1   ]  7617.87580506        1
[INPUT] 0    0    [1    /1   ]  3617.44234875        1
[INPUT] 0    0    [1    /1   ]  1606.38685461        1
[INPUT] 0    0    [1    /1   ]  350.62124428         1
[INPUT] 0    0    [1    /1   ]  110.334557244        1
[INPUT] 0    0    [1    /1   ]  36.3013335946        1
[INPUT] 0    0    [1    /1   ]  4.58857125496        1
[INPUT] 0    0    [1    /1   ]  0.395939871943       1
[INPUT] 1    0    [1    /1   ]  1362.76669391        1
[INPUT] 1    0    [1    /1   ]  664.842702859        1
[INPUT] 1    0    [1    /1   ]  301.464030368        1
[INPUT] 1    0    [1    /1   ]  314.509171831        1
[INPUT] 1    0    [1    /1   ]  81.7075101622        1
[INPUT] 1    0    [1    /1   ]  9.65635816035        1
[INPUT] 1    0    [1    /1   ]  27.1337795052        1
[INPUT] 1    0    [1    /1   ]  0.847557747809       1
[INPUT] 1    0    [1    /1   ]  3.50431878969        1
[INPUT] 1    0    [1    /1   ]  0.239456593082       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.537214914853, 1.0]], [0, [7617.875805060939, 1.0]], [0, [3617.442348751457, 1.0]], [0, [1606.3868546061503, 1.0]], [0, [350.6212442796032, 1.0]], [0, [110.33455724392745, 1.0]], [0, [36.301333594617454, 1.0]], [0, [4.5885712549643465, 1.0]], [0, [0.39593987194297137, 1.0]], [1, [1362.7666939099486, 1.0]], [1, [664.8427028592481, 1.0]], [1, [301.4640303680829, 1.0]], [1, [314.50917183090377, 1.0]], [1, [81.70751016224108, 1.0]], [1, [9.656358160350228, 1.0]], [1, [27.133779505197175, 1.0]], [1, [0.8475577478086742, 1.0]], [1, [3.504318789691336, 1.0]], [1, [0.23945659308185469, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.53721491]
bas 1, expnt(s) = [7617.87580506]
bas 2, expnt(s) = [3617.44234875]
bas 3, expnt(s) = [1606.38685461]
bas 4, expnt(s) = [350.62124428]
bas 5, expnt(s) = [110.33455724]
bas 6, expnt(s) = [36.30133359]
bas 7, expnt(s) = [4.58857125]
bas 8, expnt(s) = [0.39593987]
bas 9, expnt(s) = [1362.76669391]
bas 10, expnt(s) = [664.84270286]
bas 11, expnt(s) = [301.46403037]
bas 12, expnt(s) = [314.50917183]
bas 13, expnt(s) = [81.70751016]
bas 14, expnt(s) = [9.65635816]
bas 15, expnt(s) = [27.13377951]
bas 16, expnt(s) = [0.84755775]
bas 17, expnt(s) = [3.50431879]
bas 18, expnt(s) = [0.23945659]
CPU time:       514.06
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825372e+04 5.20024519e+03 7.61787581e+03 2.06011014e+03
 3.61744235e+03 1.17846378e+03 1.60638685e+03 6.41065832e+02
 3.50621244e+02 2.04712185e+02 1.10334557e+02 8.60099493e+01
 3.63013336e+01 3.73643094e+01 4.58857125e+00 7.92087454e+00
 3.95939872e-01 1.26106349e+00 1.36276669e+03 2.41552358e+04
 6.64842703e+02 9.84879336e+03 3.01464030e+02 3.66461849e+03
 3.14509172e+02 3.86390141e+03 8.17075102e+01 7.16657852e+02
 9.65635816e+00 4.96593579e+01 2.71337795e+01 1.80664264e+02
 8.47557748e-01 2.37244425e+00 3.50431879e+00 1.39874614e+01
 2.39456593e-01 4.88672491e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.973220783974245
cond(S) = 146739.15664144704
E1 = -728.8041354738881  E_coul = 203.1403093608397
init E= -525.663826113048
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558269767529256  LUMO = 1.16466987641194
  mo_energy =
[-1.18299844e+02 -1.21011649e+01 -9.44670136e+00 -9.44670136e+00
 -9.44670136e+00 -1.22991368e+00 -5.58269768e-01 -5.58269768e-01
 -5.58269768e-01  1.16466988e+00  1.16466988e+00  1.16466988e+00
  9.69946726e+00  9.69946726e+00  9.69946726e+00  4.67535309e+01
  4.67535309e+01  4.67535309e+01  7.87458960e+01  1.76594570e+02
  1.76594570e+02  1.76594570e+02  5.47822220e+02  5.69949656e+02
  5.69949656e+02  5.69949656e+02  1.43498287e+03  1.43498287e+03
  1.43498287e+03  2.56299715e+03  3.13185423e+03  3.13185423e+03
  3.13185423e+03  6.74794604e+03  6.74794604e+03  6.74794604e+03
  8.95700727e+03  2.53198801e+04  7.60714013e+04]
E1 = -728.115273849262  E_coul = 201.68353577143756
cycle= 1 E= -526.431738077825  delta_E= -0.768  |g|= 0.187  |ddm|= 0.501
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.558086
diis-c [-0.31146042  1.        ]
  HOMO = -0.571172206366285  LUMO = 1.15549931053653
  mo_energy =
[-1.18570248e+02 -1.21960958e+01 -9.54815619e+00 -9.54815619e+00
 -9.54815619e+00 -1.24998986e+00 -5.71172206e-01 -5.71172206e-01
 -5.71172206e-01  1.15549931e+00  1.15549931e+00  1.15549931e+00
  9.63437266e+00  9.63437266e+00  9.63437266e+00  4.66241302e+01
  4.66241302e+01  4.66241302e+01  7.85812461e+01  1.76394474e+02
  1.76394474e+02  1.76394474e+02  5.47521573e+02  5.69682678e+02
  5.69682678e+02  5.69682678e+02  1.43466059e+03  1.43466059e+03
  1.43466059e+03  2.56254173e+03  3.13146737e+03  3.13146737e+03
  3.13146737e+03  6.74744323e+03  6.74744323e+03  6.74744323e+03
  8.95642634e+03  2.53192033e+04  7.60706328e+04]
E1 = -728.4001497686234  E_coul = 201.96805022845413
cycle= 2 E= -526.432099540169  delta_E= -0.000361  |g|= 0.0237  |ddm|= 0.0198
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0461162
diis-c [-0.00141322  0.04577487  0.95422513]
  HOMO = -0.567690921290242  LUMO = 1.15860276954816
  mo_energy =
[-1.18528753e+02 -1.21765754e+01 -9.52826095e+00 -9.52826095e+00
 -9.52826095e+00 -1.24536040e+00 -5.67690921e-01 -5.67690921e-01
 -5.67690921e-01  1.15860277e+00  1.15860277e+00  1.15860277e+00
  9.64714957e+00  9.64714957e+00  9.64714957e+00  4.66479523e+01
  4.66479523e+01  4.66479523e+01  7.86145884e+01  1.76428991e+02
  1.76428991e+02  1.76428991e+02  5.47564319e+02  5.69723723e+02
  5.69723723e+02  5.69723723e+02  1.43470446e+03  1.43470446e+03
  1.43470446e+03  2.56258784e+03  3.13151282e+03  3.13151282e+03
  3.13151282e+03  6.74748968e+03  6.74748968e+03  6.74748968e+03
  8.95647320e+03  2.53192503e+04  7.60706798e+04]
E1 = -728.3420369041215  E_coul = 201.90992531573124
cycle= 3 E= -526.43211158839  delta_E= -1.2e-05  |g|= 0.0029  |ddm|= 0.00498
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00626968
diis-c [-3.33396043e-07 -1.03347217e-03  1.13187050e-01  8.87846422e-01]
  HOMO = -0.568322481500545  LUMO = 1.15806082147306
  mo_energy =
[-1.18533869e+02 -1.21793277e+01 -9.53111298e+00 -9.53111298e+00
 -9.53111298e+00 -1.24618348e+00 -5.68322482e-01 -5.68322482e-01
 -5.68322482e-01  1.15806082e+00  1.15806082e+00  1.15806082e+00
  9.64517239e+00  9.64517239e+00  9.64517239e+00  4.66446976e+01
  4.66446976e+01  4.66446976e+01  7.86104533e+01  1.76424619e+02
  1.76424619e+02  1.76424619e+02  5.47559050e+02  5.69718662e+02
  5.69718662e+02  5.69718662e+02  1.43469906e+03  1.43469906e+03
  1.43469906e+03  2.56258204e+03  3.13150718e+03  3.13150718e+03
  3.13150718e+03  6.74748380e+03  6.74748380e+03  6.74748380e+03
  8.95646719e+03  2.53192442e+04  7.60706736e+04]
E1 = -728.3499798596416  E_coul = 201.91786800116247
cycle= 4 E= -526.432111858479  delta_E= -2.7e-07  |g|= 4.17e-05  |ddm|= 0.000742
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.55266e-05
diis-c [-1.61141340e-09  7.51496865e-06 -1.65604473e-03 -6.45920772e-03
  1.00810774e+00]
  HOMO = -0.568295854210581  LUMO = 1.15808292292445
  mo_energy =
[-1.18533776e+02 -1.21792419e+01 -9.53102803e+00 -9.53102803e+00
 -9.53102803e+00 -1.24614889e+00 -5.68295854e-01 -5.68295854e-01
 -5.68295854e-01  1.15808292e+00  1.15808292e+00  1.15808292e+00
  9.64524001e+00  9.64524001e+00  9.64524001e+00  4.66447831e+01
  4.66447831e+01  4.66447831e+01  7.86105490e+01  1.76424711e+02
  1.76424711e+02  1.76424711e+02  5.47559140e+02  5.69718755e+02
  5.69718755e+02  5.69718755e+02  1.43469915e+03  1.43469915e+03
  1.43469915e+03  2.56258212e+03  3.13150727e+03  3.13150727e+03
  3.13150727e+03  6.74748388e+03  6.74748388e+03  6.74748388e+03
  8.95646726e+03  2.53192443e+04  7.60706737e+04]
E1 = -728.3497811874248  E_coul = 201.91766932881467
cycle= 5 E= -526.43211185861  delta_E= -1.31e-10  |g|= 6.89e-06  |ddm|= 2.31e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3497811874248  E_coul = 201.91766932881467
  HOMO = -0.568299389411844  LUMO = 1.15807997141142
  mo_energy =
[-1.18533793e+02 -1.21792543e+01 -9.53104067e+00 -9.53104067e+00
 -9.53104067e+00 -1.24615348e+00 -5.68299389e-01 -5.68299389e-01
 -5.68299389e-01  1.15807997e+00  1.15807997e+00  1.15807997e+00
  9.64523043e+00  9.64523043e+00  9.64523043e+00  4.66447698e+01
  4.66447698e+01  4.66447698e+01  7.86105336e+01  1.76424695e+02
  1.76424695e+02  1.76424695e+02  5.47559123e+02  5.69718738e+02
  5.69718738e+02  5.69718738e+02  1.43469913e+03  1.43469913e+03
  1.43469913e+03  2.56258211e+03  3.13150725e+03  3.13150725e+03
  3.13150725e+03  6.74748386e+03  6.74748386e+03  6.74748386e+03
  8.95646725e+03  2.53192443e+04  7.60706737e+04]
E1 = -728.3498130490857  E_coul = 201.91770119047288
Extra cycle  E= -526.432111858613  delta_E= -2.73e-12  |g|= 1.73e-06  |ddm|= 3.44e-06
    CPU time for scf_cycle      0.67 sec, wall time      0.27 sec
exp = [2.61825372e+04 7.61787581e+03 3.61744235e+03 1.60638685e+03
 3.50621244e+02 1.10334557e+02 3.63013336e+01 4.58857125e+00
 3.95939872e-01 1.36276669e+03 6.64842703e+02 3.01464030e+02
 3.14509172e+02 8.17075102e+01 9.65635816e+00 2.71337795e+01
 8.47557748e-01 3.50431879e+00 2.39456593e-01]
E = -526.4321118586129
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:43:17 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5372149        1
[INPUT] 0    0    [1    /1   ]  7617.87580506        1
[INPUT] 0    0    [1    /1   ]  3617.44234875        1
[INPUT] 0    0    [1    /1   ]  1606.38685461        1
[INPUT] 0    0    [1    /1   ]  350.62124428         1
[INPUT] 0    0    [1    /1   ]  110.334557244        1
[INPUT] 0    0    [1    /1   ]  36.3013335946        1
[INPUT] 0    0    [1    /1   ]  4.58857125496        1
[INPUT] 0    0    [1    /1   ]  0.395939871943       1
[INPUT] 1    0    [1    /1   ]  1362.76669391        1
[INPUT] 1    0    [1    /1   ]  664.842702859        1
[INPUT] 1    0    [1    /1   ]  301.464030368        1
[INPUT] 1    0    [1    /1   ]  314.509171831        1
[INPUT] 1    0    [1    /1   ]  81.7075101622        1
[INPUT] 1    0    [1    /1   ]  9.65635816035        1
[INPUT] 1    0    [1    /1   ]  27.1337795052        1
[INPUT] 1    0    [1    /1   ]  0.847557747809       1
[INPUT] 1    0    [1    /1   ]  3.50431878969        1
[INPUT] 1    0    [1    /1   ]  0.239456593082       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.537214914853, 1.0]], [0, [7617.875805060939, 1.0]], [0, [3617.442348751457, 1.0]], [0, [1606.3868546061503, 1.0]], [0, [350.6212442796032, 1.0]], [0, [110.33455724392745, 1.0]], [0, [36.301333594617454, 1.0]], [0, [4.5885712549643465, 1.0]], [0, [0.39593987194297137, 1.0]], [1, [1362.7666939099486, 1.0]], [1, [664.8427028592481, 1.0]], [1, [301.4640303680829, 1.0]], [1, [314.50917183090377, 1.0]], [1, [81.70751016224108, 1.0]], [1, [9.656358160350228, 1.0]], [1, [27.133779505197175, 1.0]], [1, [0.8475577478086742, 1.0]], [1, [3.504318789691336, 1.0]], [1, [0.23945659308185469, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.53721491]
bas 1, expnt(s) = [7617.87580506]
bas 2, expnt(s) = [3617.44234875]
bas 3, expnt(s) = [1606.38685461]
bas 4, expnt(s) = [350.62124428]
bas 5, expnt(s) = [110.33455724]
bas 6, expnt(s) = [36.30133359]
bas 7, expnt(s) = [4.58857125]
bas 8, expnt(s) = [0.39593987]
bas 9, expnt(s) = [1362.76669391]
bas 10, expnt(s) = [664.84270286]
bas 11, expnt(s) = [301.46403037]
bas 12, expnt(s) = [314.50917183]
bas 13, expnt(s) = [81.70751016]
bas 14, expnt(s) = [9.65635816]
bas 15, expnt(s) = [27.13377951]
bas 16, expnt(s) = [0.84755775]
bas 17, expnt(s) = [3.50431879]
bas 18, expnt(s) = [0.23945659]
CPU time:       514.92
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825372e+04 5.20024519e+03 7.61787581e+03 2.06011014e+03
 3.61744235e+03 1.17846378e+03 1.60638685e+03 6.41065832e+02
 3.50621244e+02 2.04712185e+02 1.10334557e+02 8.60099493e+01
 3.63013336e+01 3.73643094e+01 4.58857125e+00 7.92087454e+00
 3.95939872e-01 1.26106349e+00 1.36276669e+03 2.41552358e+04
 6.64842703e+02 9.84879336e+03 3.01464030e+02 3.66461849e+03
 3.14509172e+02 3.86390141e+03 8.17075102e+01 7.16657852e+02
 9.65635816e+00 4.96593579e+01 2.71337795e+01 1.80664264e+02
 8.47557748e-01 2.37244425e+00 3.50431879e+00 1.39874614e+01
 2.39456593e-01 4.88672491e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.973220783974245
cond(S) = 146739.15664144704
E1 = -728.8041354738881  E_coul = 203.1403093608397
init E= -525.663826113048
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558269767529256  LUMO = 1.16466987641194
  mo_energy =
[-1.18299844e+02 -1.21011649e+01 -9.44670136e+00 -9.44670136e+00
 -9.44670136e+00 -1.22991368e+00 -5.58269768e-01 -5.58269768e-01
 -5.58269768e-01  1.16466988e+00  1.16466988e+00  1.16466988e+00
  9.69946726e+00  9.69946726e+00  9.69946726e+00  4.67535309e+01
  4.67535309e+01  4.67535309e+01  7.87458960e+01  1.76594570e+02
  1.76594570e+02  1.76594570e+02  5.47822220e+02  5.69949656e+02
  5.69949656e+02  5.69949656e+02  1.43498287e+03  1.43498287e+03
  1.43498287e+03  2.56299715e+03  3.13185423e+03  3.13185423e+03
  3.13185423e+03  6.74794604e+03  6.74794604e+03  6.74794604e+03
  8.95700727e+03  2.53198801e+04  7.60714013e+04]
E1 = -728.115273849262  E_coul = 201.68353577143756
cycle= 1 E= -526.431738077825  delta_E= -0.768  |g|= 0.187  |ddm|= 0.501
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.558086
diis-c [-0.31146042  1.        ]
  HOMO = -0.571172206366285  LUMO = 1.15549931053653
  mo_energy =
[-1.18570248e+02 -1.21960958e+01 -9.54815619e+00 -9.54815619e+00
 -9.54815619e+00 -1.24998986e+00 -5.71172206e-01 -5.71172206e-01
 -5.71172206e-01  1.15549931e+00  1.15549931e+00  1.15549931e+00
  9.63437266e+00  9.63437266e+00  9.63437266e+00  4.66241302e+01
  4.66241302e+01  4.66241302e+01  7.85812461e+01  1.76394474e+02
  1.76394474e+02  1.76394474e+02  5.47521573e+02  5.69682678e+02
  5.69682678e+02  5.69682678e+02  1.43466059e+03  1.43466059e+03
  1.43466059e+03  2.56254173e+03  3.13146737e+03  3.13146737e+03
  3.13146737e+03  6.74744323e+03  6.74744323e+03  6.74744323e+03
  8.95642634e+03  2.53192033e+04  7.60706328e+04]
E1 = -728.4001497686234  E_coul = 201.96805022845413
cycle= 2 E= -526.432099540169  delta_E= -0.000361  |g|= 0.0237  |ddm|= 0.0198
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0461162
diis-c [-0.00141322  0.04577487  0.95422513]
  HOMO = -0.567690921290242  LUMO = 1.15860276954816
  mo_energy =
[-1.18528753e+02 -1.21765754e+01 -9.52826095e+00 -9.52826095e+00
 -9.52826095e+00 -1.24536040e+00 -5.67690921e-01 -5.67690921e-01
 -5.67690921e-01  1.15860277e+00  1.15860277e+00  1.15860277e+00
  9.64714957e+00  9.64714957e+00  9.64714957e+00  4.66479523e+01
  4.66479523e+01  4.66479523e+01  7.86145884e+01  1.76428991e+02
  1.76428991e+02  1.76428991e+02  5.47564319e+02  5.69723723e+02
  5.69723723e+02  5.69723723e+02  1.43470446e+03  1.43470446e+03
  1.43470446e+03  2.56258784e+03  3.13151282e+03  3.13151282e+03
  3.13151282e+03  6.74748968e+03  6.74748968e+03  6.74748968e+03
  8.95647320e+03  2.53192503e+04  7.60706798e+04]
E1 = -728.3420369041215  E_coul = 201.90992531573124
cycle= 3 E= -526.43211158839  delta_E= -1.2e-05  |g|= 0.0029  |ddm|= 0.00498
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00626968
diis-c [-3.33396043e-07 -1.03347217e-03  1.13187050e-01  8.87846422e-01]
  HOMO = -0.568322481500545  LUMO = 1.15806082147306
  mo_energy =
[-1.18533869e+02 -1.21793277e+01 -9.53111298e+00 -9.53111298e+00
 -9.53111298e+00 -1.24618348e+00 -5.68322482e-01 -5.68322482e-01
 -5.68322482e-01  1.15806082e+00  1.15806082e+00  1.15806082e+00
  9.64517239e+00  9.64517239e+00  9.64517239e+00  4.66446976e+01
  4.66446976e+01  4.66446976e+01  7.86104533e+01  1.76424619e+02
  1.76424619e+02  1.76424619e+02  5.47559050e+02  5.69718662e+02
  5.69718662e+02  5.69718662e+02  1.43469906e+03  1.43469906e+03
  1.43469906e+03  2.56258204e+03  3.13150718e+03  3.13150718e+03
  3.13150718e+03  6.74748380e+03  6.74748380e+03  6.74748380e+03
  8.95646719e+03  2.53192442e+04  7.60706736e+04]
E1 = -728.3499798596416  E_coul = 201.91786800116247
cycle= 4 E= -526.432111858479  delta_E= -2.7e-07  |g|= 4.17e-05  |ddm|= 0.000742
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.55266e-05
diis-c [-1.61141340e-09  7.51496865e-06 -1.65604473e-03 -6.45920772e-03
  1.00810774e+00]
  HOMO = -0.568295854210581  LUMO = 1.15808292292445
  mo_energy =
[-1.18533776e+02 -1.21792419e+01 -9.53102803e+00 -9.53102803e+00
 -9.53102803e+00 -1.24614889e+00 -5.68295854e-01 -5.68295854e-01
 -5.68295854e-01  1.15808292e+00  1.15808292e+00  1.15808292e+00
  9.64524001e+00  9.64524001e+00  9.64524001e+00  4.66447831e+01
  4.66447831e+01  4.66447831e+01  7.86105490e+01  1.76424711e+02
  1.76424711e+02  1.76424711e+02  5.47559140e+02  5.69718755e+02
  5.69718755e+02  5.69718755e+02  1.43469915e+03  1.43469915e+03
  1.43469915e+03  2.56258212e+03  3.13150727e+03  3.13150727e+03
  3.13150727e+03  6.74748388e+03  6.74748388e+03  6.74748388e+03
  8.95646726e+03  2.53192443e+04  7.60706737e+04]
E1 = -728.3497811874248  E_coul = 201.91766932881467
cycle= 5 E= -526.43211185861  delta_E= -1.31e-10  |g|= 6.89e-06  |ddm|= 2.31e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3497811874248  E_coul = 201.91766932881467
  HOMO = -0.568299389411844  LUMO = 1.15807997141142
  mo_energy =
[-1.18533793e+02 -1.21792543e+01 -9.53104067e+00 -9.53104067e+00
 -9.53104067e+00 -1.24615348e+00 -5.68299389e-01 -5.68299389e-01
 -5.68299389e-01  1.15807997e+00  1.15807997e+00  1.15807997e+00
  9.64523043e+00  9.64523043e+00  9.64523043e+00  4.66447698e+01
  4.66447698e+01  4.66447698e+01  7.86105336e+01  1.76424695e+02
  1.76424695e+02  1.76424695e+02  5.47559123e+02  5.69718738e+02
  5.69718738e+02  5.69718738e+02  1.43469913e+03  1.43469913e+03
  1.43469913e+03  2.56258211e+03  3.13150725e+03  3.13150725e+03
  3.13150725e+03  6.74748386e+03  6.74748386e+03  6.74748386e+03
  8.95646725e+03  2.53192443e+04  7.60706737e+04]
E1 = -728.3498130490857  E_coul = 201.91770119047288
Extra cycle  E= -526.432111858613  delta_E= -2.73e-12  |g|= 1.73e-06  |ddm|= 3.44e-06
    CPU time for scf_cycle      0.67 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 146739.15664144704
E1 = -728.3498130490857  E_coul = 201.91770119047288
init E= -526.432111858613
    CPU time for initialize scf      2.72 sec, wall time      0.24 sec
  HOMO = -0.568298795208805  LUMO = 1.15808047524482
  mo_energy =
[-1.18533789e+02 -1.21792519e+01 -9.53103827e+00 -9.53103827e+00
 -9.53103827e+00 -1.24615271e+00 -5.68298795e-01 -5.68298795e-01
 -5.68298795e-01  1.15808048e+00  1.15808048e+00  1.15808048e+00
  9.64523217e+00  9.64523217e+00  9.64523217e+00  4.66447724e+01
  4.66447724e+01  4.66447724e+01  7.86105369e+01  1.76424699e+02
  1.76424699e+02  1.76424699e+02  5.47559127e+02  5.69718742e+02
  5.69718742e+02  5.69718742e+02  1.43469913e+03  1.43469913e+03
  1.43469913e+03  2.56258211e+03  3.13150725e+03  3.13150725e+03
  3.13150725e+03  6.74748387e+03  6.74748387e+03  6.74748387e+03
  8.95646725e+03  2.53192443e+04  7.60706737e+04]
E1 = -728.3498066748252  E_coul = 201.91769481621367
cycle= 1 E= -526.432111858612  delta_E= 1.36e-12  |g|= 3.78e-07  |ddm|= 6.32e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3498066748252  E_coul = 201.91769481621367
  HOMO = -0.568298906805762  LUMO = 1.15808038000502
  mo_energy =
[-1.18533790e+02 -1.21792524e+01 -9.53103874e+00 -9.53103874e+00
 -9.53103874e+00 -1.24615285e+00 -5.68298907e-01 -5.68298907e-01
 -5.68298907e-01  1.15808038e+00  1.15808038e+00  1.15808038e+00
  9.64523183e+00  9.64523183e+00  9.64523183e+00  4.66447719e+01
  4.66447719e+01  4.66447719e+01  7.86105362e+01  1.76424698e+02
  1.76424698e+02  1.76424698e+02  5.47559126e+02  5.69718741e+02
  5.69718741e+02  5.69718741e+02  1.43469913e+03  1.43469913e+03
  1.43469913e+03  2.56258211e+03  3.13150725e+03  3.13150725e+03
  3.13150725e+03  6.74748387e+03  6.74748387e+03  6.74748387e+03
  8.95646725e+03  2.53192443e+04  7.60706737e+04]
E1 = -728.349807971052  E_coul = 201.91769611243808
Extra cycle  E= -526.432111858614  delta_E= -2.39e-12  |g|= 7.95e-08  |ddm|= 1.25e-07
    CPU time for scf_cycle      2.86 sec, wall time      0.39 sec
exp = [2.61825372e+04 7.61787581e+03 3.61744235e+03 1.60638685e+03
 3.50621244e+02 1.10334557e+02 3.63013336e+01 4.58857125e+00
 3.95939872e-01 1.36276669e+03 6.64842703e+02 3.01464030e+02
 3.14509172e+02 8.17075102e+01 9.65635816e+00 2.71337795e+01
 8.47557748e-01 3.50431879e+00 2.39456593e-01]
grad_E = [-1.76712591e-06  7.34845795e-06  4.22682688e-06  2.06073945e-04
 -2.12715039e-03  5.81001569e-03 -4.52009176e-03  3.22690416e-03
  1.65625653e-02 -5.33749133e-07  2.59342415e-07  7.44357884e-09
  8.22080406e-08  2.36613886e-04  6.31805085e-03 -5.77398113e-04
 -3.72684379e-03 -2.68307026e-03  1.46206943e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:43:21 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5370253        1
[INPUT] 0    0    [1    /1   ]  7617.87832495        1
[INPUT] 0    0    [1    /1   ]  3617.44785556        1
[INPUT] 0    0    [1    /1   ]  1606.46680055        1
[INPUT] 0    0    [1    /1   ]  349.853312398        1
[INPUT] 0    0    [1    /1   ]  109.983012701        1
[INPUT] 0    0    [1    /1   ]  36.2345497607        1
[INPUT] 0    0    [1    /1   ]  4.5906690576         1
[INPUT] 0    0    [1    /1   ]  0.395098205211       1
[INPUT] 1    0    [1    /1   ]  1362.76687492        1
[INPUT] 1    0    [1    /1   ]  664.844992459        1
[INPUT] 1    0    [1    /1   ]  301.476610338        1
[INPUT] 1    0    [1    /1   ]  314.520265516        1
[INPUT] 1    0    [1    /1   ]  81.4854306496        1
[INPUT] 1    0    [1    /1   ]  9.55728736452        1
[INPUT] 1    0    [1    /1   ]  27.0611665033        1
[INPUT] 1    0    [1    /1   ]  0.857298426928       1
[INPUT] 1    0    [1    /1   ]  3.46669944729        1
[INPUT] 1    0    [1    /1   ]  0.241410321367       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.537025308633, 1.0]], [0, [7617.878324953544, 1.0]], [0, [3617.4478555552864, 1.0]], [0, [1606.4668005543056, 1.0]], [0, [349.85331239777753, 1.0]], [0, [109.98301270113926, 1.0]], [0, [36.23454976069588, 1.0]], [0, [4.590669057598789, 1.0]], [0, [0.39509820521076433, 1.0]], [1, [1362.766874923576, 1.0]], [1, [664.8449924590161, 1.0]], [1, [301.4766103378076, 1.0]], [1, [314.5202655161006, 1.0]], [1, [81.48543064963084, 1.0]], [1, [9.55728736451922, 1.0]], [1, [27.061166503252792, 1.0]], [1, [0.8572984269279006, 1.0]], [1, [3.466699447292018, 1.0]], [1, [0.24141032136656737, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.53702531]
bas 1, expnt(s) = [7617.87832495]
bas 2, expnt(s) = [3617.44785556]
bas 3, expnt(s) = [1606.46680055]
bas 4, expnt(s) = [349.8533124]
bas 5, expnt(s) = [109.9830127]
bas 6, expnt(s) = [36.23454976]
bas 7, expnt(s) = [4.59066906]
bas 8, expnt(s) = [0.39509821]
bas 9, expnt(s) = [1362.76687492]
bas 10, expnt(s) = [664.84499246]
bas 11, expnt(s) = [301.47661034]
bas 12, expnt(s) = [314.52026552]
bas 13, expnt(s) = [81.48543065]
bas 14, expnt(s) = [9.55728736]
bas 15, expnt(s) = [27.0611665]
bas 16, expnt(s) = [0.85729843]
bas 17, expnt(s) = [3.46669945]
bas 18, expnt(s) = [0.24141032]
CPU time:       523.17
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825370e+04 5.20024517e+03 7.61787832e+03 2.06011065e+03
 3.61744786e+03 1.17846512e+03 1.60646680e+03 6.41089760e+02
 3.49853312e+02 2.04375822e+02 1.09983013e+02 8.58043357e+01
 3.62345498e+01 3.73127429e+01 4.59066906e+00 7.92359033e+00
 3.95098205e-01 1.25905243e+00 1.36276687e+03 2.41552398e+04
 6.64844992e+02 9.84883576e+03 3.01476610e+02 3.66480965e+03
 3.14520266e+02 3.86407177e+03 8.14854306e+01 7.14223851e+02
 9.55728736e+00 4.90233176e+01 2.70611665e+01 1.80060120e+02
 8.57298427e-01 2.40657514e+00 3.46669945e+00 1.38000173e+01
 2.41410321e-01 4.93661417e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.972920262268268
cond(S) = 146029.72247337142
E1 = -728.8005997448462  E_coul = 203.13240028607927
init E= -525.668199458767
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558573191282123  LUMO = 1.18102308517504
  mo_energy =
[-1.18300290e+02 -1.21017148e+01 -9.44734081e+00 -9.44734081e+00
 -9.44734081e+00 -1.23027472e+00 -5.58573191e-01 -5.58573191e-01
 -5.58573191e-01  1.18102309e+00  1.18102309e+00  1.18102309e+00
  9.63529041e+00  9.63529041e+00  9.63529041e+00  4.63572521e+01
  4.63572521e+01  4.63572521e+01  7.84796730e+01  1.75772008e+02
  1.75772008e+02  1.75772008e+02  5.46159589e+02  5.68757808e+02
  5.68757808e+02  5.68757808e+02  1.43367839e+03  1.43367839e+03
  1.43367839e+03  2.55943178e+03  3.13056851e+03  3.13056851e+03
  3.13056851e+03  6.74675490e+03  6.74675490e+03  6.74675490e+03
  8.95297967e+03  2.53159315e+04  7.60677004e+04]
E1 = -728.1238468831168  E_coul = 201.69164305208437
cycle= 1 E= -526.432203831032  delta_E= -0.764  |g|= 0.187  |ddm|= 0.436
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.557447
diis-c [-0.31074677  1.        ]
  HOMO = -0.571197183645345  LUMO = 1.17190917485898
  mo_energy =
[-1.18569068e+02 -1.21954589e+01 -9.54749957e+00 -9.54749957e+00
 -9.54749957e+00 -1.24987808e+00 -5.71197184e-01 -5.71197184e-01
 -5.71197184e-01  1.17190917e+00  1.17190917e+00  1.17190917e+00
  9.57162339e+00  9.57162339e+00  9.57162339e+00  4.62294899e+01
  4.62294899e+01  4.62294899e+01  7.83165774e+01  1.75573455e+02
  1.75573455e+02  1.75573455e+02  5.45860852e+02  5.68492405e+02
  5.68492405e+02  5.68492405e+02  1.43335777e+03  1.43335777e+03
  1.43335777e+03  2.55897814e+03  3.13018334e+03  3.13018334e+03
  3.13018334e+03  6.74625379e+03  6.74625379e+03  6.74625379e+03
  8.95240045e+03  2.53152564e+04  7.60669336e+04]
E1 = -728.4058548644153  E_coul = 201.97329359997872
cycle= 2 E= -526.432561264437  delta_E= -0.000357  |g|= 0.0236  |ddm|= 0.0193
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0459503
diis-c [-0.001407    0.04554659  0.95445341]
  HOMO = -0.567786962995184  LUMO = 1.17499025467711
  mo_energy =
[-1.18527842e+02 -1.21761259e+01 -9.52779520e+00 -9.52779520e+00
 -9.52779520e+00 -1.24534191e+00 -5.67786963e-01 -5.67786963e-01
 -5.67786963e-01  1.17499025e+00  1.17499025e+00  1.17499025e+00
  9.58414780e+00  9.58414780e+00  9.58414780e+00  4.62530488e+01
  4.62530488e+01  4.62530488e+01  7.83496469e+01  1.75607716e+02
  1.75607716e+02  1.75607716e+02  5.45903316e+02  5.68533186e+02
  5.68533186e+02  5.68533186e+02  1.43340136e+03  1.43340136e+03
  1.43340136e+03  2.55902397e+03  3.13022851e+03  3.13022851e+03
  3.13022851e+03  6.74629997e+03  6.74629997e+03  6.74629997e+03
  8.95244702e+03  2.53153031e+04  7.60669804e+04]
E1 = -728.3481815831279  E_coul = 201.9156084279057
cycle= 3 E= -526.432573155222  delta_E= -1.19e-05  |g|= 0.0029  |ddm|= 0.00493
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00625578
diis-c [-3.33072062e-07 -1.03134508e-03  1.13346512e-01  8.87684833e-01]
  HOMO = -0.568413519751754  LUMO = 1.1744459833222
  mo_energy =
[-1.18532939e+02 -1.21788642e+01 -9.53063233e+00 -9.53063233e+00
 -9.53063233e+00 -1.24615768e+00 -5.68413520e-01 -5.68413520e-01
 -5.68413520e-01  1.17444598e+00  1.17444598e+00  1.17444598e+00
  9.58219401e+00  9.58219401e+00  9.58219401e+00  4.62498158e+01
  4.62498158e+01  4.62498158e+01  7.83455319e+01  1.75603362e+02
  1.75603362e+02  1.75603362e+02  5.45898068e+02  5.68528144e+02
  5.68528144e+02  5.68528144e+02  1.43339598e+03  1.43339598e+03
  1.43339598e+03  2.55901819e+03  3.13022289e+03  3.13022289e+03
  3.13022289e+03  6.74629411e+03  6.74629411e+03  6.74629411e+03
  8.95244103e+03  2.53152970e+04  7.60669742e+04]
E1 = -728.3560908725548  E_coul = 201.92351744910837
cycle= 4 E= -526.432573423446  delta_E= -2.68e-07  |g|= 4.21e-05  |ddm|= 0.000736
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.63161e-05
diis-c [-1.61214931e-09  6.46415602e-06 -1.52653457e-03 -5.23065215e-03
  1.00675072e+00]
  HOMO = -0.568386868703672  LUMO = 1.1744683610685
  mo_energy =
[-1.18532845e+02 -1.21787777e+01 -9.53054671e+00 -9.53054671e+00
 -9.53054671e+00 -1.24612304e+00 -5.68386869e-01 -5.68386869e-01
 -5.68386869e-01  1.17446836e+00  1.17446836e+00  1.17446836e+00
  9.58226173e+00  9.58226173e+00  9.58226173e+00  4.62499019e+01
  4.62499019e+01  4.62499019e+01  7.83456283e+01  1.75603455e+02
  1.75603455e+02  1.75603455e+02  5.45898160e+02  5.68528237e+02
  5.68528237e+02  5.68528237e+02  1.43339607e+03  1.43339607e+03
  1.43339607e+03  2.55901828e+03  3.13022298e+03  3.13022298e+03
  3.13022298e+03  6.74629419e+03  6.74629419e+03  6.74629419e+03
  8.95244111e+03  2.53152971e+04  7.60669743e+04]
E1 = -728.3558902613734  E_coul = 201.92331683779452
cycle= 5 E= -526.432573423579  delta_E= -1.32e-10  |g|= 6.9e-06  |ddm|= 2.33e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3558902613734  E_coul = 201.92331683779452
  HOMO = -0.56839037983818  LUMO = 1.17446539444605
  mo_energy =
[-1.18532862e+02 -1.21787901e+01 -9.53055931e+00 -9.53055931e+00
 -9.53055931e+00 -1.24612759e+00 -5.68390380e-01 -5.68390380e-01
 -5.68390380e-01  1.17446539e+00  1.17446539e+00  1.17446539e+00
  9.58225224e+00  9.58225224e+00  9.58225224e+00  4.62498886e+01
  4.62498886e+01  4.62498886e+01  7.83456131e+01  1.75603440e+02
  1.75603440e+02  1.75603440e+02  5.45898142e+02  5.68528221e+02
  5.68528221e+02  5.68528221e+02  1.43339605e+03  1.43339605e+03
  1.43339605e+03  2.55901826e+03  3.13022296e+03  3.13022296e+03
  3.13022296e+03  6.74629417e+03  6.74629417e+03  6.74629417e+03
  8.95244109e+03  2.53152971e+04  7.60669743e+04]
E1 = -728.3559220461437  E_coul = 201.92334862256226
Extra cycle  E= -526.432573423582  delta_E= -2.73e-12  |g|= 1.73e-06  |ddm|= 3.42e-06
    CPU time for scf_cycle      0.67 sec, wall time      0.28 sec
exp = [2.61825370e+04 7.61787832e+03 3.61744786e+03 1.60646680e+03
 3.49853312e+02 1.09983013e+02 3.62345498e+01 4.59066906e+00
 3.95098205e-01 1.36276687e+03 6.64844992e+02 3.01476610e+02
 3.14520266e+02 8.14854306e+01 9.55728736e+00 2.70611665e+01
 8.57298427e-01 3.46669945e+00 2.41410321e-01]
E = -526.4325734235815
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:43:22 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5370253        1
[INPUT] 0    0    [1    /1   ]  7617.87832495        1
[INPUT] 0    0    [1    /1   ]  3617.44785556        1
[INPUT] 0    0    [1    /1   ]  1606.46680055        1
[INPUT] 0    0    [1    /1   ]  349.853312398        1
[INPUT] 0    0    [1    /1   ]  109.983012701        1
[INPUT] 0    0    [1    /1   ]  36.2345497607        1
[INPUT] 0    0    [1    /1   ]  4.5906690576         1
[INPUT] 0    0    [1    /1   ]  0.395098205211       1
[INPUT] 1    0    [1    /1   ]  1362.76687492        1
[INPUT] 1    0    [1    /1   ]  664.844992459        1
[INPUT] 1    0    [1    /1   ]  301.476610338        1
[INPUT] 1    0    [1    /1   ]  314.520265516        1
[INPUT] 1    0    [1    /1   ]  81.4854306496        1
[INPUT] 1    0    [1    /1   ]  9.55728736452        1
[INPUT] 1    0    [1    /1   ]  27.0611665033        1
[INPUT] 1    0    [1    /1   ]  0.857298426928       1
[INPUT] 1    0    [1    /1   ]  3.46669944729        1
[INPUT] 1    0    [1    /1   ]  0.241410321367       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.537025308633, 1.0]], [0, [7617.878324953544, 1.0]], [0, [3617.4478555552864, 1.0]], [0, [1606.4668005543056, 1.0]], [0, [349.85331239777753, 1.0]], [0, [109.98301270113926, 1.0]], [0, [36.23454976069588, 1.0]], [0, [4.590669057598789, 1.0]], [0, [0.39509820521076433, 1.0]], [1, [1362.766874923576, 1.0]], [1, [664.8449924590161, 1.0]], [1, [301.4766103378076, 1.0]], [1, [314.5202655161006, 1.0]], [1, [81.48543064963084, 1.0]], [1, [9.55728736451922, 1.0]], [1, [27.061166503252792, 1.0]], [1, [0.8572984269279006, 1.0]], [1, [3.466699447292018, 1.0]], [1, [0.24141032136656737, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.53702531]
bas 1, expnt(s) = [7617.87832495]
bas 2, expnt(s) = [3617.44785556]
bas 3, expnt(s) = [1606.46680055]
bas 4, expnt(s) = [349.8533124]
bas 5, expnt(s) = [109.9830127]
bas 6, expnt(s) = [36.23454976]
bas 7, expnt(s) = [4.59066906]
bas 8, expnt(s) = [0.39509821]
bas 9, expnt(s) = [1362.76687492]
bas 10, expnt(s) = [664.84499246]
bas 11, expnt(s) = [301.47661034]
bas 12, expnt(s) = [314.52026552]
bas 13, expnt(s) = [81.48543065]
bas 14, expnt(s) = [9.55728736]
bas 15, expnt(s) = [27.0611665]
bas 16, expnt(s) = [0.85729843]
bas 17, expnt(s) = [3.46669945]
bas 18, expnt(s) = [0.24141032]
CPU time:       524.06
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825370e+04 5.20024517e+03 7.61787832e+03 2.06011065e+03
 3.61744786e+03 1.17846512e+03 1.60646680e+03 6.41089760e+02
 3.49853312e+02 2.04375822e+02 1.09983013e+02 8.58043357e+01
 3.62345498e+01 3.73127429e+01 4.59066906e+00 7.92359033e+00
 3.95098205e-01 1.25905243e+00 1.36276687e+03 2.41552398e+04
 6.64844992e+02 9.84883576e+03 3.01476610e+02 3.66480965e+03
 3.14520266e+02 3.86407177e+03 8.14854306e+01 7.14223851e+02
 9.55728736e+00 4.90233176e+01 2.70611665e+01 1.80060120e+02
 8.57298427e-01 2.40657514e+00 3.46669945e+00 1.38000173e+01
 2.41410321e-01 4.93661417e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.972920262268268
cond(S) = 146029.72247337142
E1 = -728.8005997448462  E_coul = 203.13240028607927
init E= -525.668199458767
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558573191282123  LUMO = 1.18102308517504
  mo_energy =
[-1.18300290e+02 -1.21017148e+01 -9.44734081e+00 -9.44734081e+00
 -9.44734081e+00 -1.23027472e+00 -5.58573191e-01 -5.58573191e-01
 -5.58573191e-01  1.18102309e+00  1.18102309e+00  1.18102309e+00
  9.63529041e+00  9.63529041e+00  9.63529041e+00  4.63572521e+01
  4.63572521e+01  4.63572521e+01  7.84796730e+01  1.75772008e+02
  1.75772008e+02  1.75772008e+02  5.46159589e+02  5.68757808e+02
  5.68757808e+02  5.68757808e+02  1.43367839e+03  1.43367839e+03
  1.43367839e+03  2.55943178e+03  3.13056851e+03  3.13056851e+03
  3.13056851e+03  6.74675490e+03  6.74675490e+03  6.74675490e+03
  8.95297967e+03  2.53159315e+04  7.60677004e+04]
E1 = -728.1238468831168  E_coul = 201.69164305208437
cycle= 1 E= -526.432203831032  delta_E= -0.764  |g|= 0.187  |ddm|= 0.436
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.557447
diis-c [-0.31074677  1.        ]
  HOMO = -0.571197183645345  LUMO = 1.17190917485898
  mo_energy =
[-1.18569068e+02 -1.21954589e+01 -9.54749957e+00 -9.54749957e+00
 -9.54749957e+00 -1.24987808e+00 -5.71197184e-01 -5.71197184e-01
 -5.71197184e-01  1.17190917e+00  1.17190917e+00  1.17190917e+00
  9.57162339e+00  9.57162339e+00  9.57162339e+00  4.62294899e+01
  4.62294899e+01  4.62294899e+01  7.83165774e+01  1.75573455e+02
  1.75573455e+02  1.75573455e+02  5.45860852e+02  5.68492405e+02
  5.68492405e+02  5.68492405e+02  1.43335777e+03  1.43335777e+03
  1.43335777e+03  2.55897814e+03  3.13018334e+03  3.13018334e+03
  3.13018334e+03  6.74625379e+03  6.74625379e+03  6.74625379e+03
  8.95240045e+03  2.53152564e+04  7.60669336e+04]
E1 = -728.4058548644153  E_coul = 201.97329359997872
cycle= 2 E= -526.432561264437  delta_E= -0.000357  |g|= 0.0236  |ddm|= 0.0193
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0459503
diis-c [-0.001407    0.04554659  0.95445341]
  HOMO = -0.567786962995184  LUMO = 1.17499025467711
  mo_energy =
[-1.18527842e+02 -1.21761259e+01 -9.52779520e+00 -9.52779520e+00
 -9.52779520e+00 -1.24534191e+00 -5.67786963e-01 -5.67786963e-01
 -5.67786963e-01  1.17499025e+00  1.17499025e+00  1.17499025e+00
  9.58414780e+00  9.58414780e+00  9.58414780e+00  4.62530488e+01
  4.62530488e+01  4.62530488e+01  7.83496469e+01  1.75607716e+02
  1.75607716e+02  1.75607716e+02  5.45903316e+02  5.68533186e+02
  5.68533186e+02  5.68533186e+02  1.43340136e+03  1.43340136e+03
  1.43340136e+03  2.55902397e+03  3.13022851e+03  3.13022851e+03
  3.13022851e+03  6.74629997e+03  6.74629997e+03  6.74629997e+03
  8.95244702e+03  2.53153031e+04  7.60669804e+04]
E1 = -728.3481815831279  E_coul = 201.9156084279057
cycle= 3 E= -526.432573155222  delta_E= -1.19e-05  |g|= 0.0029  |ddm|= 0.00493
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00625578
diis-c [-3.33072062e-07 -1.03134508e-03  1.13346512e-01  8.87684833e-01]
  HOMO = -0.568413519751754  LUMO = 1.1744459833222
  mo_energy =
[-1.18532939e+02 -1.21788642e+01 -9.53063233e+00 -9.53063233e+00
 -9.53063233e+00 -1.24615768e+00 -5.68413520e-01 -5.68413520e-01
 -5.68413520e-01  1.17444598e+00  1.17444598e+00  1.17444598e+00
  9.58219401e+00  9.58219401e+00  9.58219401e+00  4.62498158e+01
  4.62498158e+01  4.62498158e+01  7.83455319e+01  1.75603362e+02
  1.75603362e+02  1.75603362e+02  5.45898068e+02  5.68528144e+02
  5.68528144e+02  5.68528144e+02  1.43339598e+03  1.43339598e+03
  1.43339598e+03  2.55901819e+03  3.13022289e+03  3.13022289e+03
  3.13022289e+03  6.74629411e+03  6.74629411e+03  6.74629411e+03
  8.95244103e+03  2.53152970e+04  7.60669742e+04]
E1 = -728.3560908725548  E_coul = 201.92351744910837
cycle= 4 E= -526.432573423446  delta_E= -2.68e-07  |g|= 4.21e-05  |ddm|= 0.000736
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.63161e-05
diis-c [-1.61214931e-09  6.46415602e-06 -1.52653457e-03 -5.23065215e-03
  1.00675072e+00]
  HOMO = -0.568386868703672  LUMO = 1.1744683610685
  mo_energy =
[-1.18532845e+02 -1.21787777e+01 -9.53054671e+00 -9.53054671e+00
 -9.53054671e+00 -1.24612304e+00 -5.68386869e-01 -5.68386869e-01
 -5.68386869e-01  1.17446836e+00  1.17446836e+00  1.17446836e+00
  9.58226173e+00  9.58226173e+00  9.58226173e+00  4.62499019e+01
  4.62499019e+01  4.62499019e+01  7.83456283e+01  1.75603455e+02
  1.75603455e+02  1.75603455e+02  5.45898160e+02  5.68528237e+02
  5.68528237e+02  5.68528237e+02  1.43339607e+03  1.43339607e+03
  1.43339607e+03  2.55901828e+03  3.13022298e+03  3.13022298e+03
  3.13022298e+03  6.74629419e+03  6.74629419e+03  6.74629419e+03
  8.95244111e+03  2.53152971e+04  7.60669743e+04]
E1 = -728.3558902613734  E_coul = 201.92331683779452
cycle= 5 E= -526.432573423579  delta_E= -1.32e-10  |g|= 6.9e-06  |ddm|= 2.33e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3558902613734  E_coul = 201.92331683779452
  HOMO = -0.56839037983818  LUMO = 1.17446539444605
  mo_energy =
[-1.18532862e+02 -1.21787901e+01 -9.53055931e+00 -9.53055931e+00
 -9.53055931e+00 -1.24612759e+00 -5.68390380e-01 -5.68390380e-01
 -5.68390380e-01  1.17446539e+00  1.17446539e+00  1.17446539e+00
  9.58225224e+00  9.58225224e+00  9.58225224e+00  4.62498886e+01
  4.62498886e+01  4.62498886e+01  7.83456131e+01  1.75603440e+02
  1.75603440e+02  1.75603440e+02  5.45898142e+02  5.68528221e+02
  5.68528221e+02  5.68528221e+02  1.43339605e+03  1.43339605e+03
  1.43339605e+03  2.55901826e+03  3.13022296e+03  3.13022296e+03
  3.13022296e+03  6.74629417e+03  6.74629417e+03  6.74629417e+03
  8.95244109e+03  2.53152971e+04  7.60669743e+04]
E1 = -728.3559220461437  E_coul = 201.92334862256226
Extra cycle  E= -526.432573423582  delta_E= -2.73e-12  |g|= 1.73e-06  |ddm|= 3.42e-06
    CPU time for scf_cycle      0.67 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 146029.72247337142
E1 = -728.3559220461437  E_coul = 201.92334862256226
init E= -526.432573423582
    CPU time for initialize scf      2.71 sec, wall time      0.24 sec
  HOMO = -0.568389789322937  LUMO = 1.17446590121063
  mo_energy =
[-1.18532858e+02 -1.21787877e+01 -9.53055691e+00 -9.53055691e+00
 -9.53055691e+00 -1.24612683e+00 -5.68389789e-01 -5.68389789e-01
 -5.68389789e-01  1.17446590e+00  1.17446590e+00  1.17446590e+00
  9.58225396e+00  9.58225396e+00  9.58225396e+00  4.62498913e+01
  4.62498913e+01  4.62498913e+01  7.83456163e+01  1.75603443e+02
  1.75603443e+02  1.75603443e+02  5.45898146e+02  5.68528224e+02
  5.68528224e+02  5.68528224e+02  1.43339606e+03  1.43339606e+03
  1.43339606e+03  2.55901826e+03  3.13022297e+03  3.13022297e+03
  3.13022297e+03  6.74629418e+03  6.74629418e+03  6.74629418e+03
  8.95244110e+03  2.53152971e+04  7.60669743e+04]
E1 = -728.3559156781919  E_coul = 201.92334225460883
cycle= 1 E= -526.432573423583  delta_E= -1.59e-12  |g|= 3.79e-07  |ddm|= 6.29e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3559156781919  E_coul = 201.92334225460883
  HOMO = -0.568389900439522  LUMO = 1.17446580522674
  mo_energy =
[-1.18532859e+02 -1.21787882e+01 -9.53055739e+00 -9.53055739e+00
 -9.53055739e+00 -1.24612697e+00 -5.68389900e-01 -5.68389900e-01
 -5.68389900e-01  1.17446581e+00  1.17446581e+00  1.17446581e+00
  9.58225362e+00  9.58225362e+00  9.58225362e+00  4.62498907e+01
  4.62498907e+01  4.62498907e+01  7.83456156e+01  1.75603442e+02
  1.75603442e+02  1.75603442e+02  5.45898145e+02  5.68528223e+02
  5.68528223e+02  5.68528223e+02  1.43339606e+03  1.43339606e+03
  1.43339606e+03  2.55901826e+03  3.13022297e+03  3.13022297e+03
  3.13022297e+03  6.74629418e+03  6.74629418e+03  6.74629418e+03
  8.95244110e+03  2.53152971e+04  7.60669743e+04]
E1 = -728.3559169747492  E_coul = 201.92334355116708
Extra cycle  E= -526.432573423582  delta_E= 9.09e-13  |g|= 7.97e-08  |ddm|= 1.25e-07
    CPU time for scf_cycle      2.86 sec, wall time      0.39 sec
exp = [2.61825370e+04 7.61787832e+03 3.61744786e+03 1.60646680e+03
 3.49853312e+02 1.09983013e+02 3.62345498e+01 4.59066906e+00
 3.95098205e-01 1.36276687e+03 6.64844992e+02 3.01476610e+02
 3.14520266e+02 8.14854306e+01 9.55728736e+00 2.70611665e+01
 8.57298427e-01 3.46669945e+00 2.41410321e-01]
grad_E = [-1.76917307e-06  7.39528284e-06  4.32041195e-06  2.07542040e-04
 -2.13808338e-03  5.76178466e-03 -4.40143126e-03  5.40331442e-03
  4.60764109e-03 -5.57149133e-07  3.25707296e-07  2.91786986e-07
  2.84670329e-07  1.75757448e-04  4.21256859e-03  1.39059511e-04
  1.26624944e-02 -3.32135056e-03  4.48947368e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:43:26 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5371343        1
[INPUT] 0    0    [1    /1   ]  7617.87704396        1
[INPUT] 0    0    [1    /1   ]  3617.44517577        1
[INPUT] 0    0    [1    /1   ]  1606.42642687        1
[INPUT] 0    0    [1    /1   ]  350.251177299        1
[INPUT] 0    0    [1    /1   ]  110.059536557        1
[INPUT] 0    0    [1    /1   ]  36.2539717478        1
[INPUT] 0    0    [1    /1   ]  4.59178686635        1
[INPUT] 0    0    [1    /1   ]  0.394467462317       1
[INPUT] 1    0    [1    /1   ]  1362.76679199        1
[INPUT] 1    0    [1    /1   ]  664.843885653        1
[INPUT] 1    0    [1    /1   ]  301.470534267        1
[INPUT] 1    0    [1    /1   ]  314.514905845        1
[INPUT] 1    0    [1    /1   ]  81.5931881235        1
[INPUT] 1    0    [1    /1   ]  9.49250645764        1
[INPUT] 1    0    [1    /1   ]  27.1105933978        1
[INPUT] 1    0    [1    /1   ]  0.863999736155       1
[INPUT] 1    0    [1    /1   ]  3.44235066774        1
[INPUT] 1    0    [1    /1   ]  0.24225081431        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.537134343434, 1.0]], [0, [7617.877043962518, 1.0]], [0, [3617.4451757684365, 1.0]], [0, [1606.4264268686175, 1.0]], [0, [350.25117729886625, 1.0]], [0, [110.05953655747501, 1.0]], [0, [36.253971747835145, 1.0]], [0, [4.591786866352652, 1.0]], [0, [0.3944674623165857, 1.0]], [1, [1362.7667919854566, 1.0]], [1, [664.8438856534628, 1.0]], [1, [301.470534267075, 1.0]], [1, [314.51490584483935, 1.0]], [1, [81.59318812351368, 1.0]], [1, [9.492506457640223, 1.0]], [1, [27.11059339775107, 1.0]], [1, [0.8639997361549842, 1.0]], [1, [3.4423506677429794, 1.0]], [1, [0.24225081430976617, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.53713434]
bas 1, expnt(s) = [7617.87704396]
bas 2, expnt(s) = [3617.44517577]
bas 3, expnt(s) = [1606.42642687]
bas 4, expnt(s) = [350.2511773]
bas 5, expnt(s) = [110.05953656]
bas 6, expnt(s) = [36.25397175]
bas 7, expnt(s) = [4.59178687]
bas 8, expnt(s) = [0.39446746]
bas 9, expnt(s) = [1362.76679199]
bas 10, expnt(s) = [664.84388565]
bas 11, expnt(s) = [301.47053427]
bas 12, expnt(s) = [314.51490584]
bas 13, expnt(s) = [81.59318812]
bas 14, expnt(s) = [9.49250646]
bas 15, expnt(s) = [27.1105934]
bas 16, expnt(s) = [0.86399974]
bas 17, expnt(s) = [3.44235067]
bas 18, expnt(s) = [0.24225081]
CPU time:       532.36
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825371e+04 5.20024518e+03 7.61787704e+03 2.06011039e+03
 3.61744518e+03 1.17846447e+03 1.60642643e+03 6.41077677e+02
 3.50251177e+02 2.04550115e+02 1.10059537e+02 8.58491074e+01
 3.62539717e+01 3.73277419e+01 4.59178687e+00 7.92503731e+00
 3.94467462e-01 1.25754465e+00 1.36276679e+03 2.41552380e+04
 6.64843886e+02 9.84881526e+03 3.01470534e+02 3.66471732e+03
 3.14514906e+02 3.86398946e+03 8.15931881e+01 7.15404670e+02
 9.49250646e+00 4.86083097e+01 2.71105934e+01 1.80471310e+02
 8.63999736e-01 2.43011264e+00 3.44235067e+00 1.36789663e+01
 2.42250814e-01 4.95810762e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.972777812385548
cond(S) = 146178.6953205638
E1 = -728.795037787589  E_coul = 203.12479799160835
init E= -525.670239795981
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558857160076127  LUMO = 1.19026161107317
  mo_energy =
[-1.18300978e+02 -1.21022501e+01 -9.44788463e+00 -9.44788463e+00
 -9.44788463e+00 -1.23058647e+00 -5.58857160e-01 -5.58857160e-01
 -5.58857160e-01  1.19026161e+00  1.19026161e+00  1.19026161e+00
  9.59336648e+00  9.59336648e+00  9.59336648e+00  4.61701496e+01
  4.61701496e+01  4.61701496e+01  7.85504182e+01  1.75712307e+02
  1.75712307e+02  1.75712307e+02  5.46709965e+02  5.68935300e+02
  5.68935300e+02  5.68935300e+02  1.43395020e+03  1.43395020e+03
  1.43395020e+03  2.56084858e+03  3.13085677e+03  3.13085677e+03
  3.13085677e+03  6.74702638e+03  6.74702638e+03  6.74702638e+03
  8.95464039e+03  2.53175681e+04  7.60692349e+04]
E1 = -728.1189298643653  E_coul = 201.68628757652266
cycle= 1 E= -526.432642287843  delta_E= -0.762  |g|= 0.186  |ddm|= 0.391
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.557086
diis-c [-0.31034487  1.        ]
  HOMO = -0.57161214157452  LUMO = 1.18093043063601
  mo_energy =
[-1.18569327e+02 -1.21957474e+01 -9.54774260e+00 -9.54774260e+00
 -9.54774260e+00 -1.25025332e+00 -5.71612142e-01 -5.71612142e-01
 -5.71612142e-01  1.18093043e+00  1.18093043e+00  1.18093043e+00
  9.53009217e+00  9.53009217e+00  9.53009217e+00  4.60427284e+01
  4.60427284e+01  4.60427284e+01  7.83875976e+01  1.75513991e+02
  1.75513991e+02  1.75513991e+02  5.46411652e+02  5.68670300e+02
  5.68670300e+02  5.68670300e+02  1.43363010e+03  1.43363010e+03
  1.43363010e+03  2.56039552e+03  3.13047216e+03  3.13047216e+03
  3.13047216e+03  6.74652591e+03  6.74652591e+03  6.74652591e+03
  8.95406187e+03  2.53168937e+04  7.60684689e+04]
E1 = -728.4008242653903  E_coul = 201.96782477183126
cycle= 2 E= -526.432999493559  delta_E= -0.000357  |g|= 0.0236  |ddm|= 0.0192
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0459749
diis-c [-0.00140902  0.04558262  0.95441738]
  HOMO = -0.568215797056037  LUMO = 1.18402331800619
  mo_energy =
[-1.18528107e+02 -1.21764125e+01 -9.52803659e+00 -9.52803659e+00
 -9.52803659e+00 -1.24573511e+00 -5.68215797e-01 -5.68215797e-01
 -5.68215797e-01  1.18402332e+00  1.18402332e+00  1.18402332e+00
  9.54254734e+00  9.54254734e+00  9.54254734e+00  4.60662755e+01
  4.60662755e+01  4.60662755e+01  7.84206716e+01  1.75548265e+02
  1.75548265e+02  1.75548265e+02  5.46454113e+02  5.68711078e+02
  5.68711078e+02  5.68711078e+02  1.43367369e+03  1.43367369e+03
  1.43367369e+03  2.56044134e+03  3.13051733e+03  3.13051733e+03
  3.13051733e+03  6.74657208e+03  6.74657208e+03  6.74657208e+03
  8.95410843e+03  2.53169405e+04  7.60685157e+04]
E1 = -728.3430711868118  E_coul = 201.91005978191893
cycle= 3 E= -526.433011404893  delta_E= -1.19e-05  |g|= 0.0029  |ddm|= 0.00493
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00626347
diis-c [-3.34537641e-07 -1.03056041e-03  1.13435195e-01  8.87595366e-01]
  HOMO = -0.568843579225604  LUMO = 1.1834738671943
  mo_energy =
[-1.18533211e+02 -1.21791557e+01 -9.53087832e+00 -9.53087832e+00
 -9.53087832e+00 -1.24655186e+00 -5.68843579e-01 -5.68843579e-01
 -5.68843579e-01  1.18347387e+00  1.18347387e+00  1.18347387e+00
  9.54059725e+00  9.54059725e+00  9.54059725e+00  4.60630385e+01
  4.60630385e+01  4.60630385e+01  7.84165493e+01  1.75543903e+02
  1.75543903e+02  1.75543903e+02  5.46448857e+02  5.68706029e+02
  5.68706029e+02  5.68706029e+02  1.43366830e+03  1.43366830e+03
  1.43366830e+03  2.56043556e+03  3.13051170e+03  3.13051170e+03
  3.13051170e+03  6.74656621e+03  6.74656621e+03  6.74656621e+03
  8.95410244e+03  2.53169344e+04  7.60685095e+04]
E1 = -728.3510056899997  E_coul = 201.9179940153045
cycle= 4 E= -526.433011674695  delta_E= -2.7e-07  |g|= 4.26e-05  |ddm|= 0.000737
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.71492e-05
diis-c [-1.61555216e-09  5.64895783e-06 -1.42776635e-03 -4.27422518e-03
  1.00569634e+00]
  HOMO = -0.568816823486576  LUMO = 1.18349649771585
  mo_energy =
[-1.18533116e+02 -1.21790686e+01 -9.53079193e+00 -9.53079193e+00
 -9.53079193e+00 -1.24651707e+00 -5.68816823e-01 -5.68816823e-01
 -5.68816823e-01  1.18349650e+00  1.18349650e+00  1.18349650e+00
  9.54066527e+00  9.54066527e+00  9.54066527e+00  4.60631254e+01
  4.60631254e+01  4.60631254e+01  7.84166466e+01  1.75543997e+02
  1.75543997e+02  1.75543997e+02  5.46448949e+02  5.68706123e+02
  5.68706123e+02  5.68706123e+02  1.43366839e+03  1.43366839e+03
  1.43366839e+03  2.56043564e+03  3.13051179e+03  3.13051179e+03
  3.13051179e+03  6.74656629e+03  6.74656629e+03  6.74656629e+03
  8.95410252e+03  2.53169344e+04  7.60685096e+04]
E1 = -728.3508025216877  E_coul = 201.9177908468544
cycle= 5 E= -526.433011674833  delta_E= -1.38e-10  |g|= 6.93e-06  |ddm|= 2.36e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3508025216877  E_coul = 201.9177908468544
  HOMO = -0.56882033297714  LUMO = 1.18349350997559
  mo_energy =
[-1.18533133e+02 -1.21790809e+01 -9.53080454e+00 -9.53080454e+00
 -9.53080454e+00 -1.24652163e+00 -5.68820333e-01 -5.68820333e-01
 -5.68820333e-01  1.18349351e+00  1.18349351e+00  1.18349351e+00
  9.54065580e+00  9.54065580e+00  9.54065580e+00  4.60631121e+01
  4.60631121e+01  4.60631121e+01  7.84166313e+01  1.75543982e+02
  1.75543982e+02  1.75543982e+02  5.46448932e+02  5.68706106e+02
  5.68706106e+02  5.68706106e+02  1.43366838e+03  1.43366838e+03
  1.43366838e+03  2.56043562e+03  3.13051177e+03  3.13051177e+03
  3.13051177e+03  6.74656628e+03  6.74656628e+03  6.74656628e+03
  8.95410250e+03  2.53169344e+04  7.60685095e+04]
E1 = -728.3508344143071  E_coul = 201.91782273947146
Extra cycle  E= -526.433011674836  delta_E= -2.27e-12  |g|= 1.74e-06  |ddm|= 3.42e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.23 sec
exp = [2.61825371e+04 7.61787704e+03 3.61744518e+03 1.60642643e+03
 3.50251177e+02 1.10059537e+02 3.62539717e+01 4.59178687e+00
 3.94467462e-01 1.36276679e+03 6.64843886e+02 3.01470534e+02
 3.14514906e+02 8.15931881e+01 9.49250646e+00 2.71105934e+01
 8.63999736e-01 3.44235067e+00 2.42250814e-01]
E = -526.4330116748356
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:43:26 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5371343        1
[INPUT] 0    0    [1    /1   ]  7617.87704396        1
[INPUT] 0    0    [1    /1   ]  3617.44517577        1
[INPUT] 0    0    [1    /1   ]  1606.42642687        1
[INPUT] 0    0    [1    /1   ]  350.251177299        1
[INPUT] 0    0    [1    /1   ]  110.059536557        1
[INPUT] 0    0    [1    /1   ]  36.2539717478        1
[INPUT] 0    0    [1    /1   ]  4.59178686635        1
[INPUT] 0    0    [1    /1   ]  0.394467462317       1
[INPUT] 1    0    [1    /1   ]  1362.76679199        1
[INPUT] 1    0    [1    /1   ]  664.843885653        1
[INPUT] 1    0    [1    /1   ]  301.470534267        1
[INPUT] 1    0    [1    /1   ]  314.514905845        1
[INPUT] 1    0    [1    /1   ]  81.5931881235        1
[INPUT] 1    0    [1    /1   ]  9.49250645764        1
[INPUT] 1    0    [1    /1   ]  27.1105933978        1
[INPUT] 1    0    [1    /1   ]  0.863999736155       1
[INPUT] 1    0    [1    /1   ]  3.44235066774        1
[INPUT] 1    0    [1    /1   ]  0.24225081431        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.537134343434, 1.0]], [0, [7617.877043962518, 1.0]], [0, [3617.4451757684365, 1.0]], [0, [1606.4264268686175, 1.0]], [0, [350.25117729886625, 1.0]], [0, [110.05953655747501, 1.0]], [0, [36.253971747835145, 1.0]], [0, [4.591786866352652, 1.0]], [0, [0.3944674623165857, 1.0]], [1, [1362.7667919854566, 1.0]], [1, [664.8438856534628, 1.0]], [1, [301.470534267075, 1.0]], [1, [314.51490584483935, 1.0]], [1, [81.59318812351368, 1.0]], [1, [9.492506457640223, 1.0]], [1, [27.11059339775107, 1.0]], [1, [0.8639997361549842, 1.0]], [1, [3.4423506677429794, 1.0]], [1, [0.24225081430976617, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.53713434]
bas 1, expnt(s) = [7617.87704396]
bas 2, expnt(s) = [3617.44517577]
bas 3, expnt(s) = [1606.42642687]
bas 4, expnt(s) = [350.2511773]
bas 5, expnt(s) = [110.05953656]
bas 6, expnt(s) = [36.25397175]
bas 7, expnt(s) = [4.59178687]
bas 8, expnt(s) = [0.39446746]
bas 9, expnt(s) = [1362.76679199]
bas 10, expnt(s) = [664.84388565]
bas 11, expnt(s) = [301.47053427]
bas 12, expnt(s) = [314.51490584]
bas 13, expnt(s) = [81.59318812]
bas 14, expnt(s) = [9.49250646]
bas 15, expnt(s) = [27.1105934]
bas 16, expnt(s) = [0.86399974]
bas 17, expnt(s) = [3.44235067]
bas 18, expnt(s) = [0.24225081]
CPU time:       533.17
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825371e+04 5.20024518e+03 7.61787704e+03 2.06011039e+03
 3.61744518e+03 1.17846447e+03 1.60642643e+03 6.41077677e+02
 3.50251177e+02 2.04550115e+02 1.10059537e+02 8.58491074e+01
 3.62539717e+01 3.73277419e+01 4.59178687e+00 7.92503731e+00
 3.94467462e-01 1.25754465e+00 1.36276679e+03 2.41552380e+04
 6.64843886e+02 9.84881526e+03 3.01470534e+02 3.66471732e+03
 3.14514906e+02 3.86398946e+03 8.15931881e+01 7.15404670e+02
 9.49250646e+00 4.86083097e+01 2.71105934e+01 1.80471310e+02
 8.63999736e-01 2.43011264e+00 3.44235067e+00 1.36789663e+01
 2.42250814e-01 4.95810762e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.972777812385548
cond(S) = 146178.6953205638
E1 = -728.795037787589  E_coul = 203.12479799160835
init E= -525.670239795981
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558857160076127  LUMO = 1.19026161107317
  mo_energy =
[-1.18300978e+02 -1.21022501e+01 -9.44788463e+00 -9.44788463e+00
 -9.44788463e+00 -1.23058647e+00 -5.58857160e-01 -5.58857160e-01
 -5.58857160e-01  1.19026161e+00  1.19026161e+00  1.19026161e+00
  9.59336648e+00  9.59336648e+00  9.59336648e+00  4.61701496e+01
  4.61701496e+01  4.61701496e+01  7.85504182e+01  1.75712307e+02
  1.75712307e+02  1.75712307e+02  5.46709965e+02  5.68935300e+02
  5.68935300e+02  5.68935300e+02  1.43395020e+03  1.43395020e+03
  1.43395020e+03  2.56084858e+03  3.13085677e+03  3.13085677e+03
  3.13085677e+03  6.74702638e+03  6.74702638e+03  6.74702638e+03
  8.95464039e+03  2.53175681e+04  7.60692349e+04]
E1 = -728.1189298643653  E_coul = 201.68628757652266
cycle= 1 E= -526.432642287843  delta_E= -0.762  |g|= 0.186  |ddm|= 0.391
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.557086
diis-c [-0.31034487  1.        ]
  HOMO = -0.57161214157452  LUMO = 1.18093043063601
  mo_energy =
[-1.18569327e+02 -1.21957474e+01 -9.54774260e+00 -9.54774260e+00
 -9.54774260e+00 -1.25025332e+00 -5.71612142e-01 -5.71612142e-01
 -5.71612142e-01  1.18093043e+00  1.18093043e+00  1.18093043e+00
  9.53009217e+00  9.53009217e+00  9.53009217e+00  4.60427284e+01
  4.60427284e+01  4.60427284e+01  7.83875976e+01  1.75513991e+02
  1.75513991e+02  1.75513991e+02  5.46411652e+02  5.68670300e+02
  5.68670300e+02  5.68670300e+02  1.43363010e+03  1.43363010e+03
  1.43363010e+03  2.56039552e+03  3.13047216e+03  3.13047216e+03
  3.13047216e+03  6.74652591e+03  6.74652591e+03  6.74652591e+03
  8.95406187e+03  2.53168937e+04  7.60684689e+04]
E1 = -728.4008242653903  E_coul = 201.96782477183126
cycle= 2 E= -526.432999493559  delta_E= -0.000357  |g|= 0.0236  |ddm|= 0.0192
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0459749
diis-c [-0.00140902  0.04558262  0.95441738]
  HOMO = -0.568215797056037  LUMO = 1.18402331800619
  mo_energy =
[-1.18528107e+02 -1.21764125e+01 -9.52803659e+00 -9.52803659e+00
 -9.52803659e+00 -1.24573511e+00 -5.68215797e-01 -5.68215797e-01
 -5.68215797e-01  1.18402332e+00  1.18402332e+00  1.18402332e+00
  9.54254734e+00  9.54254734e+00  9.54254734e+00  4.60662755e+01
  4.60662755e+01  4.60662755e+01  7.84206716e+01  1.75548265e+02
  1.75548265e+02  1.75548265e+02  5.46454113e+02  5.68711078e+02
  5.68711078e+02  5.68711078e+02  1.43367369e+03  1.43367369e+03
  1.43367369e+03  2.56044134e+03  3.13051733e+03  3.13051733e+03
  3.13051733e+03  6.74657208e+03  6.74657208e+03  6.74657208e+03
  8.95410843e+03  2.53169405e+04  7.60685157e+04]
E1 = -728.3430711868118  E_coul = 201.91005978191893
cycle= 3 E= -526.433011404893  delta_E= -1.19e-05  |g|= 0.0029  |ddm|= 0.00493
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00626347
diis-c [-3.34537641e-07 -1.03056041e-03  1.13435195e-01  8.87595366e-01]
  HOMO = -0.568843579225604  LUMO = 1.1834738671943
  mo_energy =
[-1.18533211e+02 -1.21791557e+01 -9.53087832e+00 -9.53087832e+00
 -9.53087832e+00 -1.24655186e+00 -5.68843579e-01 -5.68843579e-01
 -5.68843579e-01  1.18347387e+00  1.18347387e+00  1.18347387e+00
  9.54059725e+00  9.54059725e+00  9.54059725e+00  4.60630385e+01
  4.60630385e+01  4.60630385e+01  7.84165493e+01  1.75543903e+02
  1.75543903e+02  1.75543903e+02  5.46448857e+02  5.68706029e+02
  5.68706029e+02  5.68706029e+02  1.43366830e+03  1.43366830e+03
  1.43366830e+03  2.56043556e+03  3.13051170e+03  3.13051170e+03
  3.13051170e+03  6.74656621e+03  6.74656621e+03  6.74656621e+03
  8.95410244e+03  2.53169344e+04  7.60685095e+04]
E1 = -728.3510056899997  E_coul = 201.9179940153045
cycle= 4 E= -526.433011674695  delta_E= -2.7e-07  |g|= 4.26e-05  |ddm|= 0.000737
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.71492e-05
diis-c [-1.61555216e-09  5.64895783e-06 -1.42776635e-03 -4.27422518e-03
  1.00569634e+00]
  HOMO = -0.568816823486576  LUMO = 1.18349649771585
  mo_energy =
[-1.18533116e+02 -1.21790686e+01 -9.53079193e+00 -9.53079193e+00
 -9.53079193e+00 -1.24651707e+00 -5.68816823e-01 -5.68816823e-01
 -5.68816823e-01  1.18349650e+00  1.18349650e+00  1.18349650e+00
  9.54066527e+00  9.54066527e+00  9.54066527e+00  4.60631254e+01
  4.60631254e+01  4.60631254e+01  7.84166466e+01  1.75543997e+02
  1.75543997e+02  1.75543997e+02  5.46448949e+02  5.68706123e+02
  5.68706123e+02  5.68706123e+02  1.43366839e+03  1.43366839e+03
  1.43366839e+03  2.56043564e+03  3.13051179e+03  3.13051179e+03
  3.13051179e+03  6.74656629e+03  6.74656629e+03  6.74656629e+03
  8.95410252e+03  2.53169344e+04  7.60685096e+04]
E1 = -728.3508025216877  E_coul = 201.9177908468544
cycle= 5 E= -526.433011674833  delta_E= -1.38e-10  |g|= 6.93e-06  |ddm|= 2.36e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3508025216877  E_coul = 201.9177908468544
  HOMO = -0.56882033297714  LUMO = 1.18349350997559
  mo_energy =
[-1.18533133e+02 -1.21790809e+01 -9.53080454e+00 -9.53080454e+00
 -9.53080454e+00 -1.24652163e+00 -5.68820333e-01 -5.68820333e-01
 -5.68820333e-01  1.18349351e+00  1.18349351e+00  1.18349351e+00
  9.54065580e+00  9.54065580e+00  9.54065580e+00  4.60631121e+01
  4.60631121e+01  4.60631121e+01  7.84166313e+01  1.75543982e+02
  1.75543982e+02  1.75543982e+02  5.46448932e+02  5.68706106e+02
  5.68706106e+02  5.68706106e+02  1.43366838e+03  1.43366838e+03
  1.43366838e+03  2.56043562e+03  3.13051177e+03  3.13051177e+03
  3.13051177e+03  6.74656628e+03  6.74656628e+03  6.74656628e+03
  8.95410250e+03  2.53169344e+04  7.60685095e+04]
E1 = -728.3508344143071  E_coul = 201.91782273947146
Extra cycle  E= -526.433011674836  delta_E= -2.27e-12  |g|= 1.74e-06  |ddm|= 3.42e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 146178.6953205638
E1 = -728.3508344143071  E_coul = 201.91782273947146
init E= -526.433011674836
    CPU time for initialize scf      2.72 sec, wall time      0.25 sec
  HOMO = -0.568819741316248  LUMO = 1.1834940215476
  mo_energy =
[-1.18533129e+02 -1.21790786e+01 -9.53080213e+00 -9.53080213e+00
 -9.53080213e+00 -1.24652086e+00 -5.68819741e-01 -5.68819741e-01
 -5.68819741e-01  1.18349402e+00  1.18349402e+00  1.18349402e+00
  9.54065752e+00  9.54065752e+00  9.54065752e+00  4.60631148e+01
  4.60631148e+01  4.60631148e+01  7.84166346e+01  1.75543985e+02
  1.75543985e+02  1.75543985e+02  5.46448936e+02  5.68706110e+02
  5.68706110e+02  5.68706110e+02  1.43366838e+03  1.43366838e+03
  1.43366838e+03  2.56043563e+03  3.13051178e+03  3.13051178e+03
  3.13051178e+03  6.74656628e+03  6.74656628e+03  6.74656628e+03
  8.95410250e+03  2.53169344e+04  7.60685095e+04]
E1 = -728.3508280100921  E_coul = 201.91781633525628
cycle= 1 E= -526.433011674836  delta_E= -2.27e-13  |g|= 3.81e-07  |ddm|= 6.32e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3508280100921  E_coul = 201.91781633525628
  HOMO = -0.568819852973409  LUMO = 1.18349392436918
  mo_energy =
[-1.18533130e+02 -1.21790790e+01 -9.53080261e+00 -9.53080261e+00
 -9.53080261e+00 -1.24652100e+00 -5.68819853e-01 -5.68819853e-01
 -5.68819853e-01  1.18349392e+00  1.18349392e+00  1.18349392e+00
  9.54065719e+00  9.54065719e+00  9.54065719e+00  4.60631142e+01
  4.60631142e+01  4.60631142e+01  7.84166339e+01  1.75543984e+02
  1.75543984e+02  1.75543984e+02  5.46448935e+02  5.68706109e+02
  5.68706109e+02  5.68706109e+02  1.43366838e+03  1.43366838e+03
  1.43366838e+03  2.56043563e+03  3.13051177e+03  3.13051177e+03
  3.13051177e+03  6.74656628e+03  6.74656628e+03  6.74656628e+03
  8.95410250e+03  2.53169344e+04  7.60685095e+04]
E1 = -728.3508293165851  E_coul = 201.91781764174954
Extra cycle  E= -526.433011674836  delta_E= 2.27e-13  |g|= 8.03e-08  |ddm|= 1.25e-07
    CPU time for scf_cycle      2.86 sec, wall time      0.39 sec
exp = [2.61825371e+04 7.61787704e+03 3.61744518e+03 1.60642643e+03
 3.50251177e+02 1.10059537e+02 3.62539717e+01 4.59178687e+00
 3.94467462e-01 1.36276679e+03 6.64843886e+02 3.01470534e+02
 3.14514906e+02 8.15931881e+01 9.49250646e+00 2.71105934e+01
 8.63999736e-01 3.44235067e+00 2.42250814e-01]
grad_E = [-1.76718117e-06  7.34863012e-06  4.22965836e-06  2.05968503e-04
 -2.11588875e-03  5.70354065e-03 -4.27044239e-03  6.36249959e-03
 -5.03331671e-03 -5.79663520e-07  4.02963976e-07  6.67781174e-07
  5.61167052e-07  9.61334746e-05  9.85535254e-04  1.10286598e-03
  2.65484378e-02 -1.40381739e-03 -2.39522128e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:43:31 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5375187        1
[INPUT] 0    0    [1    /1   ]  7617.87232464        1
[INPUT] 0    0    [1    /1   ]  3617.43514576        1
[INPUT] 0    0    [1    /1   ]  1606.27729416        1
[INPUT] 0    0    [1    /1   ]  351.714388457        1
[INPUT] 0    0    [1    /1   ]  110.45261667         1
[INPUT] 0    0    [1    /1   ]  36.3271841294        1
[INPUT] 0    0    [1    /1   ]  4.59049485712        1
[INPUT] 0    0    [1    /1   ]  0.393849702027       1
[INPUT] 1    0    [1    /1   ]  1362.76648415        1
[INPUT] 1    0    [1    /1   ]  664.839814487        1
[INPUT] 1    0    [1    /1   ]  301.4482188          1
[INPUT] 1    0    [1    /1   ]  314.495221368        1
[INPUT] 1    0    [1    /1   ]  81.9581144807        1
[INPUT] 1    0    [1    /1   ]  9.48643038638        1
[INPUT] 1    0    [1    /1   ]  27.3664252867        1
[INPUT] 1    0    [1    /1   ]  0.868555593487       1
[INPUT] 1    0    [1    /1   ]  3.43448960315        1
[INPUT] 1    0    [1    /1   ]  0.242907643903       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.53751872366, 1.0]], [0, [7617.872324638817, 1.0]], [0, [3617.435145758184, 1.0]], [0, [1606.2772941616383, 1.0]], [0, [351.71438845652114, 1.0]], [0, [110.45261666994065, 1.0]], [0, [36.327184129410725, 1.0]], [0, [4.590494857124354, 1.0]], [0, [0.39384970202701514, 1.0]], [1, [1362.7664841540209, 1.0]], [1, [664.839814487384, 1.0]], [1, [301.4482188002975, 1.0]], [1, [314.49522136777944, 1.0]], [1, [81.95811448067259, 1.0]], [1, [9.48643038637708, 1.0]], [1, [27.36642528670621, 1.0]], [1, [0.8685555934871043, 1.0]], [1, [3.434489603147211, 1.0]], [1, [0.24290764390310168, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.53751872]
bas 1, expnt(s) = [7617.87232464]
bas 2, expnt(s) = [3617.43514576]
bas 3, expnt(s) = [1606.27729416]
bas 4, expnt(s) = [351.71438846]
bas 5, expnt(s) = [110.45261667]
bas 6, expnt(s) = [36.32718413]
bas 7, expnt(s) = [4.59049486]
bas 8, expnt(s) = [0.3938497]
bas 9, expnt(s) = [1362.76648415]
bas 10, expnt(s) = [664.83981449]
bas 11, expnt(s) = [301.4482188]
bas 12, expnt(s) = [314.49522137]
bas 13, expnt(s) = [81.95811448]
bas 14, expnt(s) = [9.48643039]
bas 15, expnt(s) = [27.36642529]
bas 16, expnt(s) = [0.86855559]
bas 17, expnt(s) = [3.4344896]
bas 18, expnt(s) = [0.24290764]
CPU time:       541.37
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825375e+04 5.20024524e+03 7.61787232e+03 2.06010944e+03
 3.61743515e+03 1.17846202e+03 1.60627729e+03 6.41033040e+02
 3.51714388e+02 2.05190678e+02 1.10452617e+02 8.60789639e+01
 3.63271841e+01 3.73842632e+01 4.59049486e+00 7.92336482e+00
 3.93849702e-01 1.25606732e+00 1.36276648e+03 2.41552311e+04
 6.64839814e+02 9.84873988e+03 3.01448219e+02 3.66437824e+03
 3.14495221e+02 3.86368717e+03 8.19581145e+01 7.19406472e+02
 9.48643039e+00 4.85694206e+01 2.73664253e+01 1.82602611e+02
 8.68555593e-01 2.44614062e+00 3.43448960e+00 1.36399303e+01
 2.42907644e-01 4.97491734e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.972689914708265
cond(S) = 147241.20953325924
E1 = -728.7814639010036  E_coul = 203.11305819895384
init E= -525.66840570205
    CPU time for initialize scf      0.48 sec, wall time      0.05 sec
  HOMO = -0.559143165901673  LUMO = 1.19694812957462
  mo_energy =
[-1.18302525e+02 -1.21031296e+01 -9.44874598e+00 -9.44874598e+00
 -9.44874598e+00 -1.23087187e+00 -5.59143166e-01 -5.59143166e-01
 -5.59143166e-01  1.19694813e+00  1.19694813e+00  1.19694813e+00
  9.59382952e+00  9.59382952e+00  9.59382952e+00  4.63278716e+01
  4.63278716e+01  4.63278716e+01  7.88429008e+01  1.76677047e+02
  1.76677047e+02  1.76677047e+02  5.49000399e+02  5.70672751e+02
  5.70672751e+02  5.70672751e+02  1.43592536e+03  1.43592536e+03
  1.43592536e+03  2.56645016e+03  3.13281967e+03  3.13281967e+03
  3.13281967e+03  6.74884763e+03  6.74884763e+03  6.74884763e+03
  8.96114212e+03  2.53239681e+04  7.60752360e+04]
E1 = -728.1099307098673  E_coul = 201.67670771337112
cycle= 1 E= -526.433222996496  delta_E= -0.765  |g|= 0.187  |ddm|= 0.386
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.557492
diis-c [-0.31079787  1.        ]
  HOMO = -0.571924487909593  LUMO = 1.18750998145409
  mo_energy =
[-1.18570906e+02 -1.21962865e+01 -9.54834361e+00 -9.54834361e+00
 -9.54834361e+00 -1.25047716e+00 -5.71924488e-01 -5.71924488e-01
 -5.71924488e-01  1.18750998e+00  1.18750998e+00  1.18750998e+00
  9.53077016e+00  9.53077016e+00  9.53077016e+00  4.62002068e+01
  4.62002068e+01  4.62002068e+01  7.86800775e+01  1.76478497e+02
  1.76478497e+02  1.76478497e+02  5.48701757e+02  5.70407744e+02
  5.70407744e+02  5.70407744e+02  1.43560533e+03  1.43560533e+03
  1.43560533e+03  2.56599705e+03  3.13243508e+03  3.13243508e+03
  3.13243508e+03  6.74834726e+03  6.74834726e+03  6.74834726e+03
  8.96056374e+03  2.53232940e+04  7.60744703e+04]
E1 = -728.3921067697968  E_coul = 201.95852451319976
cycle= 2 E= -526.433582256597  delta_E= -0.000359  |g|= 0.0237  |ddm|= 0.0192
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0460739
diis-c [-0.00141159  0.0457523   0.9542477 ]
  HOMO = -0.568537286480982  LUMO = 1.19061304322111
  mo_energy =
[-1.18529621e+02 -1.21769302e+01 -9.52861595e+00 -9.52861595e+00
 -9.52861595e+00 -1.24597277e+00 -5.68537286e-01 -5.68537286e-01
 -5.68537286e-01  1.19061304e+00  1.19061304e+00  1.19061304e+00
  9.54321943e+00  9.54321943e+00  9.54321943e+00  4.62238481e+01
  4.62238481e+01  4.62238481e+01  7.87132395e+01  1.76512867e+02
  1.76512867e+02  1.76512867e+02  5.48744301e+02  5.70448588e+02
  5.70448588e+02  5.70448588e+02  1.43564899e+03  1.43564899e+03
  1.43564899e+03  2.56604294e+03  3.13248032e+03  3.13248032e+03
  3.13248032e+03  6.74839349e+03  6.74839349e+03  6.74839349e+03
  8.96061037e+03  2.53233408e+04  7.60745171e+04]
E1 = -728.3342761041702  E_coul = 201.90068189452592
cycle= 3 E= -526.433594209644  delta_E= -1.2e-05  |g|= 0.0029  |ddm|= 0.00494
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00626428
diis-c [-3.39267228e-07 -1.03272904e-03  1.13194396e-01  8.87838333e-01]
  HOMO = -0.569165728052546  LUMO = 1.19006003962446
  mo_energy =
[-1.18534727e+02 -1.21796751e+01 -9.53145936e+00 -9.53145936e+00
 -9.53145936e+00 -1.24678968e+00 -5.69165728e-01 -5.69165728e-01
 -5.69165728e-01  1.19006004e+00  1.19006004e+00  1.19006004e+00
  9.54126876e+00  9.54126876e+00  9.54126876e+00  4.62206026e+01
  4.62206026e+01  4.62206026e+01  7.87091122e+01  1.76508499e+02
  1.76508499e+02  1.76508499e+02  5.48739041e+02  5.70443537e+02
  5.70443537e+02  5.70443537e+02  1.43564360e+03  1.43564360e+03
  1.43564360e+03  2.56603715e+03  3.13247469e+03  3.13247469e+03
  3.13247469e+03  6.74838762e+03  6.74838762e+03  6.74838762e+03
  8.96060437e+03  2.53233346e+04  7.60745109e+04]
E1 = -728.3422185080017  E_coul = 201.90862402806846
cycle= 4 E= -526.433594479933  delta_E= -2.7e-07  |g|= 4.31e-05  |ddm|= 0.000738
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.80165e-05
diis-c [-1.63040505e-09  5.32233010e-06 -1.39293772e-03 -3.85645833e-03
  1.00524407e+00]
  HOMO = -0.569138786373572  LUMO = 1.19008294959527
  mo_energy =
[-1.18534631e+02 -1.21795870e+01 -9.53137210e+00 -9.53137210e+00
 -9.53137210e+00 -1.24675466e+00 -5.69138786e-01 -5.69138786e-01
 -5.69138786e-01  1.19008295e+00  1.19008295e+00  1.19008295e+00
  9.54133737e+00  9.54133737e+00  9.54133737e+00  4.62206904e+01
  4.62206904e+01  4.62206904e+01  7.87092106e+01  1.76508594e+02
  1.76508594e+02  1.76508594e+02  5.48739135e+02  5.70443633e+02
  5.70443633e+02  5.70443633e+02  1.43564369e+03  1.43564369e+03
  1.43564369e+03  2.56603724e+03  3.13247478e+03  3.13247478e+03
  3.13247478e+03  6.74838770e+03  6.74838770e+03  6.74838770e+03
  8.96060445e+03  2.53233347e+04  7.60745110e+04]
E1 = -728.3420129601458  E_coul = 201.9084184800719
cycle= 5 E= -526.433594480074  delta_E= -1.41e-10  |g|= 6.97e-06  |ddm|= 2.38e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3420129601458  E_coul = 201.9084184800719
  HOMO = -0.569142310689562  LUMO = 1.19007993291173
  mo_energy =
[-1.18534648e+02 -1.21795995e+01 -9.53138477e+00 -9.53138477e+00
 -9.53138477e+00 -1.24675923e+00 -5.69142311e-01 -5.69142311e-01
 -5.69142311e-01  1.19007993e+00  1.19007993e+00  1.19007993e+00
  9.54132786e+00  9.54132786e+00  9.54132786e+00  4.62206770e+01
  4.62206770e+01  4.62206770e+01  7.87091952e+01  1.76508578e+02
  1.76508578e+02  1.76508578e+02  5.48739117e+02  5.70443616e+02
  5.70443616e+02  5.70443616e+02  1.43564367e+03  1.43564367e+03
  1.43564367e+03  2.56603722e+03  3.13247476e+03  3.13247476e+03
  3.13247476e+03  6.74838769e+03  6.74838769e+03  6.74838769e+03
  8.96060443e+03  2.53233347e+04  7.60745109e+04]
E1 = -728.3420450396297  E_coul = 201.90845055955228
Extra cycle  E= -526.433594480077  delta_E= -3.52e-12  |g|= 1.75e-06  |ddm|= 3.44e-06
    CPU time for scf_cycle      0.71 sec, wall time      0.29 sec
exp = [2.61825375e+04 7.61787232e+03 3.61743515e+03 1.60627729e+03
 3.51714388e+02 1.10452617e+02 3.63271841e+01 4.59049486e+00
 3.93849702e-01 1.36276648e+03 6.64839814e+02 3.01448219e+02
 3.14495221e+02 8.19581145e+01 9.48643039e+00 2.73664253e+01
 8.68555593e-01 3.43448960e+00 2.42907644e-01]
E = -526.4335944800774
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:43:31 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5375187        1
[INPUT] 0    0    [1    /1   ]  7617.87232464        1
[INPUT] 0    0    [1    /1   ]  3617.43514576        1
[INPUT] 0    0    [1    /1   ]  1606.27729416        1
[INPUT] 0    0    [1    /1   ]  351.714388457        1
[INPUT] 0    0    [1    /1   ]  110.45261667         1
[INPUT] 0    0    [1    /1   ]  36.3271841294        1
[INPUT] 0    0    [1    /1   ]  4.59049485712        1
[INPUT] 0    0    [1    /1   ]  0.393849702027       1
[INPUT] 1    0    [1    /1   ]  1362.76648415        1
[INPUT] 1    0    [1    /1   ]  664.839814487        1
[INPUT] 1    0    [1    /1   ]  301.4482188          1
[INPUT] 1    0    [1    /1   ]  314.495221368        1
[INPUT] 1    0    [1    /1   ]  81.9581144807        1
[INPUT] 1    0    [1    /1   ]  9.48643038638        1
[INPUT] 1    0    [1    /1   ]  27.3664252867        1
[INPUT] 1    0    [1    /1   ]  0.868555593487       1
[INPUT] 1    0    [1    /1   ]  3.43448960315        1
[INPUT] 1    0    [1    /1   ]  0.242907643903       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.53751872366, 1.0]], [0, [7617.872324638817, 1.0]], [0, [3617.435145758184, 1.0]], [0, [1606.2772941616383, 1.0]], [0, [351.71438845652114, 1.0]], [0, [110.45261666994065, 1.0]], [0, [36.327184129410725, 1.0]], [0, [4.590494857124354, 1.0]], [0, [0.39384970202701514, 1.0]], [1, [1362.7664841540209, 1.0]], [1, [664.839814487384, 1.0]], [1, [301.4482188002975, 1.0]], [1, [314.49522136777944, 1.0]], [1, [81.95811448067259, 1.0]], [1, [9.48643038637708, 1.0]], [1, [27.36642528670621, 1.0]], [1, [0.8685555934871043, 1.0]], [1, [3.434489603147211, 1.0]], [1, [0.24290764390310168, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.53751872]
bas 1, expnt(s) = [7617.87232464]
bas 2, expnt(s) = [3617.43514576]
bas 3, expnt(s) = [1606.27729416]
bas 4, expnt(s) = [351.71438846]
bas 5, expnt(s) = [110.45261667]
bas 6, expnt(s) = [36.32718413]
bas 7, expnt(s) = [4.59049486]
bas 8, expnt(s) = [0.3938497]
bas 9, expnt(s) = [1362.76648415]
bas 10, expnt(s) = [664.83981449]
bas 11, expnt(s) = [301.4482188]
bas 12, expnt(s) = [314.49522137]
bas 13, expnt(s) = [81.95811448]
bas 14, expnt(s) = [9.48643039]
bas 15, expnt(s) = [27.36642529]
bas 16, expnt(s) = [0.86855559]
bas 17, expnt(s) = [3.4344896]
bas 18, expnt(s) = [0.24290764]
CPU time:       542.31
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825375e+04 5.20024524e+03 7.61787232e+03 2.06010944e+03
 3.61743515e+03 1.17846202e+03 1.60627729e+03 6.41033040e+02
 3.51714388e+02 2.05190678e+02 1.10452617e+02 8.60789639e+01
 3.63271841e+01 3.73842632e+01 4.59049486e+00 7.92336482e+00
 3.93849702e-01 1.25606732e+00 1.36276648e+03 2.41552311e+04
 6.64839814e+02 9.84873988e+03 3.01448219e+02 3.66437824e+03
 3.14495221e+02 3.86368717e+03 8.19581145e+01 7.19406472e+02
 9.48643039e+00 4.85694206e+01 2.73664253e+01 1.82602611e+02
 8.68555593e-01 2.44614062e+00 3.43448960e+00 1.36399303e+01
 2.42907644e-01 4.97491734e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.972689914708265
cond(S) = 147241.20953325924
E1 = -728.7814639010036  E_coul = 203.11305819895384
init E= -525.66840570205
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559143165901673  LUMO = 1.19694812957462
  mo_energy =
[-1.18302525e+02 -1.21031296e+01 -9.44874598e+00 -9.44874598e+00
 -9.44874598e+00 -1.23087187e+00 -5.59143166e-01 -5.59143166e-01
 -5.59143166e-01  1.19694813e+00  1.19694813e+00  1.19694813e+00
  9.59382952e+00  9.59382952e+00  9.59382952e+00  4.63278716e+01
  4.63278716e+01  4.63278716e+01  7.88429008e+01  1.76677047e+02
  1.76677047e+02  1.76677047e+02  5.49000399e+02  5.70672751e+02
  5.70672751e+02  5.70672751e+02  1.43592536e+03  1.43592536e+03
  1.43592536e+03  2.56645016e+03  3.13281967e+03  3.13281967e+03
  3.13281967e+03  6.74884763e+03  6.74884763e+03  6.74884763e+03
  8.96114212e+03  2.53239681e+04  7.60752360e+04]
E1 = -728.1099307098673  E_coul = 201.67670771337112
cycle= 1 E= -526.433222996496  delta_E= -0.765  |g|= 0.187  |ddm|= 0.386
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.557492
diis-c [-0.31079787  1.        ]
  HOMO = -0.571924487909593  LUMO = 1.18750998145409
  mo_energy =
[-1.18570906e+02 -1.21962865e+01 -9.54834361e+00 -9.54834361e+00
 -9.54834361e+00 -1.25047716e+00 -5.71924488e-01 -5.71924488e-01
 -5.71924488e-01  1.18750998e+00  1.18750998e+00  1.18750998e+00
  9.53077016e+00  9.53077016e+00  9.53077016e+00  4.62002068e+01
  4.62002068e+01  4.62002068e+01  7.86800775e+01  1.76478497e+02
  1.76478497e+02  1.76478497e+02  5.48701757e+02  5.70407744e+02
  5.70407744e+02  5.70407744e+02  1.43560533e+03  1.43560533e+03
  1.43560533e+03  2.56599705e+03  3.13243508e+03  3.13243508e+03
  3.13243508e+03  6.74834726e+03  6.74834726e+03  6.74834726e+03
  8.96056374e+03  2.53232940e+04  7.60744703e+04]
E1 = -728.3921067697968  E_coul = 201.95852451319976
cycle= 2 E= -526.433582256597  delta_E= -0.000359  |g|= 0.0237  |ddm|= 0.0192
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0460739
diis-c [-0.00141159  0.0457523   0.9542477 ]
  HOMO = -0.568537286480982  LUMO = 1.19061304322111
  mo_energy =
[-1.18529621e+02 -1.21769302e+01 -9.52861595e+00 -9.52861595e+00
 -9.52861595e+00 -1.24597277e+00 -5.68537286e-01 -5.68537286e-01
 -5.68537286e-01  1.19061304e+00  1.19061304e+00  1.19061304e+00
  9.54321943e+00  9.54321943e+00  9.54321943e+00  4.62238481e+01
  4.62238481e+01  4.62238481e+01  7.87132395e+01  1.76512867e+02
  1.76512867e+02  1.76512867e+02  5.48744301e+02  5.70448588e+02
  5.70448588e+02  5.70448588e+02  1.43564899e+03  1.43564899e+03
  1.43564899e+03  2.56604294e+03  3.13248032e+03  3.13248032e+03
  3.13248032e+03  6.74839349e+03  6.74839349e+03  6.74839349e+03
  8.96061037e+03  2.53233408e+04  7.60745171e+04]
E1 = -728.3342761041702  E_coul = 201.90068189452592
cycle= 3 E= -526.433594209644  delta_E= -1.2e-05  |g|= 0.0029  |ddm|= 0.00494
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00626428
diis-c [-3.39267228e-07 -1.03272904e-03  1.13194396e-01  8.87838333e-01]
  HOMO = -0.569165728052546  LUMO = 1.19006003962446
  mo_energy =
[-1.18534727e+02 -1.21796751e+01 -9.53145936e+00 -9.53145936e+00
 -9.53145936e+00 -1.24678968e+00 -5.69165728e-01 -5.69165728e-01
 -5.69165728e-01  1.19006004e+00  1.19006004e+00  1.19006004e+00
  9.54126876e+00  9.54126876e+00  9.54126876e+00  4.62206026e+01
  4.62206026e+01  4.62206026e+01  7.87091122e+01  1.76508499e+02
  1.76508499e+02  1.76508499e+02  5.48739041e+02  5.70443537e+02
  5.70443537e+02  5.70443537e+02  1.43564360e+03  1.43564360e+03
  1.43564360e+03  2.56603715e+03  3.13247469e+03  3.13247469e+03
  3.13247469e+03  6.74838762e+03  6.74838762e+03  6.74838762e+03
  8.96060437e+03  2.53233346e+04  7.60745109e+04]
E1 = -728.3422185080017  E_coul = 201.90862402806846
cycle= 4 E= -526.433594479933  delta_E= -2.7e-07  |g|= 4.31e-05  |ddm|= 0.000738
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.80165e-05
diis-c [-1.63040505e-09  5.32233010e-06 -1.39293772e-03 -3.85645833e-03
  1.00524407e+00]
  HOMO = -0.569138786373572  LUMO = 1.19008294959527
  mo_energy =
[-1.18534631e+02 -1.21795870e+01 -9.53137210e+00 -9.53137210e+00
 -9.53137210e+00 -1.24675466e+00 -5.69138786e-01 -5.69138786e-01
 -5.69138786e-01  1.19008295e+00  1.19008295e+00  1.19008295e+00
  9.54133737e+00  9.54133737e+00  9.54133737e+00  4.62206904e+01
  4.62206904e+01  4.62206904e+01  7.87092106e+01  1.76508594e+02
  1.76508594e+02  1.76508594e+02  5.48739135e+02  5.70443633e+02
  5.70443633e+02  5.70443633e+02  1.43564369e+03  1.43564369e+03
  1.43564369e+03  2.56603724e+03  3.13247478e+03  3.13247478e+03
  3.13247478e+03  6.74838770e+03  6.74838770e+03  6.74838770e+03
  8.96060445e+03  2.53233347e+04  7.60745110e+04]
E1 = -728.3420129601458  E_coul = 201.9084184800719
cycle= 5 E= -526.433594480074  delta_E= -1.41e-10  |g|= 6.97e-06  |ddm|= 2.38e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3420129601458  E_coul = 201.9084184800719
  HOMO = -0.569142310689562  LUMO = 1.19007993291173
  mo_energy =
[-1.18534648e+02 -1.21795995e+01 -9.53138477e+00 -9.53138477e+00
 -9.53138477e+00 -1.24675923e+00 -5.69142311e-01 -5.69142311e-01
 -5.69142311e-01  1.19007993e+00  1.19007993e+00  1.19007993e+00
  9.54132786e+00  9.54132786e+00  9.54132786e+00  4.62206770e+01
  4.62206770e+01  4.62206770e+01  7.87091952e+01  1.76508578e+02
  1.76508578e+02  1.76508578e+02  5.48739117e+02  5.70443616e+02
  5.70443616e+02  5.70443616e+02  1.43564367e+03  1.43564367e+03
  1.43564367e+03  2.56603722e+03  3.13247476e+03  3.13247476e+03
  3.13247476e+03  6.74838769e+03  6.74838769e+03  6.74838769e+03
  8.96060443e+03  2.53233347e+04  7.60745109e+04]
E1 = -728.3420450396297  E_coul = 201.90845055955228
Extra cycle  E= -526.433594480077  delta_E= -3.52e-12  |g|= 1.75e-06  |ddm|= 3.44e-06
    CPU time for scf_cycle      0.68 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 147241.20953325924
E1 = -728.3420450396297  E_coul = 201.90845055955228
init E= -526.433594480077
    CPU time for initialize scf      2.71 sec, wall time      0.25 sec
  HOMO = -0.569141716028203  LUMO = 1.19008044987626
  mo_energy =
[-1.18534644e+02 -1.21795971e+01 -9.53138235e+00 -9.53138235e+00
 -9.53138235e+00 -1.24675846e+00 -5.69141716e-01 -5.69141716e-01
 -5.69141716e-01  1.19008045e+00  1.19008045e+00  1.19008045e+00
  9.54132958e+00  9.54132958e+00  9.54132958e+00  4.62206797e+01
  4.62206797e+01  4.62206797e+01  7.87091985e+01  1.76508581e+02
  1.76508581e+02  1.76508581e+02  5.48739121e+02  5.70443619e+02
  5.70443619e+02  5.70443619e+02  1.43564368e+03  1.43564368e+03
  1.43564368e+03  2.56603722e+03  3.13247476e+03  3.13247476e+03
  3.13247476e+03  6.74838769e+03  6.74838769e+03  6.74838769e+03
  8.96060444e+03  2.53233347e+04  7.60745109e+04]
E1 = -728.34203859298  E_coul = 201.90844411290396
cycle= 1 E= -526.433594480076  delta_E= 1.48e-12  |g|= 3.84e-07  |ddm|= 6.36e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.34203859298  E_coul = 201.90844411290396
  HOMO = -0.569141828367715  LUMO = 1.19008035156939
  mo_energy =
[-1.18534645e+02 -1.21795976e+01 -9.53138283e+00 -9.53138283e+00
 -9.53138283e+00 -1.24675860e+00 -5.69141828e-01 -5.69141828e-01
 -5.69141828e-01  1.19008035e+00  1.19008035e+00  1.19008035e+00
  9.54132925e+00  9.54132925e+00  9.54132925e+00  4.62206792e+01
  4.62206792e+01  4.62206792e+01  7.87091978e+01  1.76508581e+02
  1.76508581e+02  1.76508581e+02  5.48739121e+02  5.70443619e+02
  5.70443619e+02  5.70443619e+02  1.43564368e+03  1.43564368e+03
  1.43564368e+03  2.56603722e+03  3.13247476e+03  3.13247476e+03
  3.13247476e+03  6.74838769e+03  6.74838769e+03  6.74838769e+03
  8.96060444e+03  2.53233347e+04  7.60745109e+04]
E1 = -728.3420399089283  E_coul = 201.90844542885037
Extra cycle  E= -526.433594480078  delta_E= -2.05e-12  |g|= 8.09e-08  |ddm|= 1.26e-07
    CPU time for scf_cycle      2.86 sec, wall time      0.39 sec
exp = [2.61825375e+04 7.61787232e+03 3.61743515e+03 1.60627729e+03
 3.51714388e+02 1.10452617e+02 3.63271841e+01 4.59049486e+00
 3.93849702e-01 1.36276648e+03 6.64839814e+02 3.01448219e+02
 3.14495221e+02 8.19581145e+01 9.48643039e+00 2.73664253e+01
 8.68555593e-01 3.43448960e+00 2.42907644e-01]
grad_E = [-1.76102404e-06  7.20873609e-06  3.95880347e-06  2.01337333e-04
 -2.05897685e-03  5.62979902e-03 -4.15326548e-03  5.00287935e-03
 -1.42186097e-02 -6.11743006e-07  5.46495121e-07  1.38389217e-06
  1.10707553e-06 -2.35367700e-05 -3.17774310e-03  2.40296768e-03
  3.42728353e-02  1.96100702e-03 -3.85152708e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:43:36 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5381383        1
[INPUT] 0    0    [1    /1   ]  7617.8647187         1
[INPUT] 0    0    [1    /1   ]  3617.41899022        1
[INPUT] 0    0    [1    /1   ]  1606.03690856        1
[INPUT] 0    0    [1    /1   ]  354.083810738        1
[INPUT] 0    0    [1    /1   ]  111.042569426        1
[INPUT] 0    0    [1    /1   ]  36.4211128072        1
[INPUT] 0    0    [1    /1   ]  4.58830934499        1
[INPUT] 0    0    [1    /1   ]  0.393808581439       1
[INPUT] 1    0    [1    /1   ]  1362.76600165        1
[INPUT] 1    0    [1    /1   ]  664.833366283        1
[INPUT] 1    0    [1    /1   ]  301.412930199        1
[INPUT] 1    0    [1    /1   ]  314.464090359        1
[INPUT] 1    0    [1    /1   ]  82.4948822107        1
[INPUT] 1    0    [1    /1   ]  9.58505012373        1
[INPUT] 1    0    [1    /1   ]  27.8942330184        1
[INPUT] 1    0    [1    /1   ]  0.867797226484       1
[INPUT] 1    0    [1    /1   ]  3.45533217396        1
[INPUT] 1    0    [1    /1   ]  0.242336190946       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.538138296888, 1.0]], [0, [7617.864718700486, 1.0]], [0, [3617.4189902214052, 1.0]], [0, [1606.0369085606208, 1.0]], [0, [354.08381073795647, 1.0]], [0, [111.04256942641086, 1.0]], [0, [36.421112807162224, 1.0]], [0, [4.588309344990439, 1.0]], [0, [0.39380858143948444, 1.0]], [1, [1362.76600165107, 1.0]], [1, [664.833366282727, 1.0]], [1, [301.4129301992527, 1.0]], [1, [314.4640903587194, 1.0]], [1, [82.49488221074648, 1.0]], [1, [9.585050123727067, 1.0]], [1, [27.89423301842302, 1.0]], [1, [0.8677972264843351, 1.0]], [1, [3.4553321739579608, 1.0]], [1, [0.2423361909461083, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.5381383]
bas 1, expnt(s) = [7617.8647187]
bas 2, expnt(s) = [3617.41899022]
bas 3, expnt(s) = [1606.03690856]
bas 4, expnt(s) = [354.08381074]
bas 5, expnt(s) = [111.04256943]
bas 6, expnt(s) = [36.42111281]
bas 7, expnt(s) = [4.58830934]
bas 8, expnt(s) = [0.39380858]
bas 9, expnt(s) = [1362.76600165]
bas 10, expnt(s) = [664.83336628]
bas 11, expnt(s) = [301.4129302]
bas 12, expnt(s) = [314.46409036]
bas 13, expnt(s) = [82.49488221]
bas 14, expnt(s) = [9.58505012]
bas 15, expnt(s) = [27.89423302]
bas 16, expnt(s) = [0.86779723]
bas 17, expnt(s) = [3.45533217]
bas 18, expnt(s) = [0.24233619]
CPU time:       550.57
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825381e+04 5.20024533e+03 7.61786472e+03 2.06010789e+03
 3.61741899e+03 1.17845807e+03 1.60603691e+03 6.40961089e+02
 3.54083811e+02 2.06226550e+02 1.11042569e+02 8.64235598e+01
 3.64211128e+01 3.74567362e+01 4.58830934e+00 7.92053545e+00
 3.93808581e-01 1.25596896e+00 1.36276600e+03 2.41552204e+04
 6.64833366e+02 9.84862047e+03 3.01412930e+02 3.66384204e+03
 3.14464090e+02 3.86320911e+03 8.24948822e+01 7.25300791e+02
 9.58505012e+00 4.92013906e+01 2.78942330e+01 1.87015423e+02
 8.67797226e-01 2.44347114e+00 3.45533217e+00 1.37434779e+01
 2.42336191e-01 4.96029196e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97278601464436
cond(S) = 149279.68050596534
E1 = -728.7738843872157  E_coul = 203.1080422412494
init E= -525.665842145966
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559219891962773  LUMO = 1.19415006392669
  mo_energy =
[-1.18304002e+02 -1.21035230e+01 -9.44899478e+00 -9.44899478e+00
 -9.44899478e+00 -1.23091685e+00 -5.59219892e-01 -5.59219892e-01
 -5.59219892e-01  1.19415006e+00  1.19415006e+00  1.19415006e+00
  9.66074706e+00  9.66074706e+00  9.66074706e+00  4.70223369e+01
  4.70223369e+01  4.70223369e+01  7.92552883e+01  1.78953119e+02
  1.78953119e+02  1.78953119e+02  5.52506763e+02  5.74147889e+02
  5.74147889e+02  5.74147889e+02  1.43970778e+03  1.43970778e+03
  1.43970778e+03  2.57525490e+03  3.13653373e+03  3.13653373e+03
  3.13653373e+03  6.75228384e+03  6.75228384e+03  6.75228384e+03
  8.97142188e+03  2.53340995e+04  7.60847388e+04]
E1 = -728.0948271815473  E_coul = 201.66083018749362
cycle= 1 E= -526.433996994054  delta_E= -0.768  |g|= 0.187  |ddm|= 0.428
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.558112
diis-c [-0.31148899  1.        ]
  HOMO = -0.572304500228375  LUMO = 1.18446114955146
  mo_energy =
[-1.18573634e+02 -1.21973127e+01 -9.54935274e+00 -9.54935274e+00
 -9.54935274e+00 -1.25088456e+00 -5.72304500e-01 -5.72304500e-01
 -5.72304500e-01  1.18446115e+00  1.18446115e+00  1.18446115e+00
  9.59666649e+00  9.59666649e+00  9.59666649e+00  4.68927476e+01
  4.68927476e+01  4.68927476e+01  7.90912524e+01  1.78753062e+02
  1.78753062e+02  1.78753062e+02  5.52206346e+02  5.73881707e+02
  5.73881707e+02  5.73881707e+02  1.43938663e+03  1.43938663e+03
  1.43938663e+03  2.57480044e+03  3.13614796e+03  3.13614796e+03
  3.13614796e+03  6.75178236e+03  6.75178236e+03  6.75178236e+03
  8.97084248e+03  2.53334244e+04  7.60839721e+04]
E1 = -728.3796512900864  E_coul = 201.9452899627243
cycle= 2 E= -526.434361327362  delta_E= -0.000364  |g|= 0.0238  |ddm|= 0.0195
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.04634
diis-c [-0.00142095  0.04616826  0.95383174]
  HOMO = -0.5688717204369  LUMO = 1.18760212265828
  mo_energy =
[-1.18532064e+02 -1.21777785e+01 -9.52944394e+00 -9.52944394e+00
 -9.52944394e+00 -1.24632156e+00 -5.68871720e-01 -5.68871720e-01
 -5.68871720e-01  1.18760212e+00  1.18760212e+00  1.18760212e+00
  9.60932703e+00  9.60932703e+00  9.60932703e+00  4.69167609e+01
  4.69167609e+01  4.69167609e+01  7.91247158e+01  1.78787753e+02
  1.78787753e+02  1.78787753e+02  5.52249206e+02  5.73922833e+02
  5.73922833e+02  5.73922833e+02  1.43943057e+03  1.43943057e+03
  1.43943057e+03  2.57484663e+03  3.13619348e+03  3.13619348e+03
  3.13619348e+03  6.75182888e+03  6.75182888e+03  6.75182888e+03
  8.97088941e+03  2.53334715e+04  7.60840192e+04]
E1 = -728.3213286431213  E_coul = 201.88695517494546
cycle= 3 E= -526.434373468176  delta_E= -1.21e-05  |g|= 0.00291  |ddm|= 0.00499
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00628183
diis-c [-3.44242254e-07 -1.03654838e-03  1.12853567e-01  8.88182981e-01]
  HOMO = -0.569505450247773  LUMO = 1.18704500530655
  mo_energy =
[-1.18537190e+02 -1.21805388e+01 -9.53230339e+00 -9.53230339e+00
 -9.53230339e+00 -1.24714521e+00 -5.69505450e-01 -5.69505450e-01
 -5.69505450e-01  1.18704501e+00  1.18704501e+00  1.18704501e+00
  9.60735354e+00  9.60735354e+00  9.60735354e+00  4.69134802e+01
  4.69134802e+01  4.69134802e+01  7.91205653e+01  1.78783360e+02
  1.78783360e+02  1.78783360e+02  5.52243921e+02  5.73917761e+02
  5.73917761e+02  5.73917761e+02  1.43942516e+03  1.43942516e+03
  1.43942516e+03  2.57484082e+03  3.13618783e+03  3.13618783e+03
  3.13618783e+03  6.75182299e+03  6.75182299e+03  6.75182299e+03
  8.97088338e+03  2.53334654e+04  7.60840130e+04]
E1 = -728.3293185430824  E_coul = 201.8949448018422
cycle= 4 E= -526.43437374124  delta_E= -2.73e-07  |g|= 4.34e-05  |ddm|= 0.000744
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.85177e-05
diis-c [-1.64570066e-09  5.50827898e-06 -1.42076845e-03 -4.03974251e-03
  1.00545500e+00]
  HOMO = -0.569478298561455  LUMO = 1.18706808026142
  mo_energy =
[-1.18537093e+02 -1.21804501e+01 -9.53221552e+00 -9.53221552e+00
 -9.53221552e+00 -1.24710992e+00 -5.69478299e-01 -5.69478299e-01
 -5.69478299e-01  1.18706808e+00  1.18706808e+00  1.18706808e+00
  9.60742286e+00  9.60742286e+00  9.60742286e+00  4.69135688e+01
  4.69135688e+01  4.69135688e+01  7.91206644e+01  1.78783456e+02
  1.78783456e+02  1.78783456e+02  5.52244015e+02  5.73917857e+02
  5.73917857e+02  5.73917857e+02  1.43942525e+03  1.43942525e+03
  1.43942525e+03  2.57484091e+03  3.13618792e+03  3.13618792e+03
  3.13618792e+03  6.75182308e+03  6.75182308e+03  6.75182308e+03
  8.97088346e+03  2.53334654e+04  7.60840131e+04]
E1 = -728.3291111810313  E_coul = 201.89473743964774
cycle= 5 E= -526.434373741384  delta_E= -1.43e-10  |g|= 7.01e-06  |ddm|= 2.41e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3291111810313  E_coul = 201.89473743964774
  HOMO = -0.569481856793253  LUMO = 1.18706503675987
  mo_energy =
[-1.18537111e+02 -1.21804626e+01 -9.53222829e+00 -9.53222829e+00
 -9.53222829e+00 -1.24711454e+00 -5.69481857e-01 -5.69481857e-01
 -5.69481857e-01  1.18706504e+00  1.18706504e+00  1.18706504e+00
  9.60741323e+00  9.60741323e+00  9.60741323e+00  4.69135553e+01
  4.69135553e+01  4.69135553e+01  7.91206489e+01  1.78783440e+02
  1.78783440e+02  1.78783440e+02  5.52243998e+02  5.73917840e+02
  5.73917840e+02  5.73917840e+02  1.43942523e+03  1.43942523e+03
  1.43942523e+03  2.57484089e+03  3.13618791e+03  3.13618791e+03
  3.13618791e+03  6.75182306e+03  6.75182306e+03  6.75182306e+03
  8.97088344e+03  2.53334654e+04  7.60840131e+04]
E1 = -728.3291435641997  E_coul = 201.89476982281403
Extra cycle  E= -526.434373741386  delta_E= -2.16e-12  |g|= 1.76e-06  |ddm|= 3.48e-06
    CPU time for scf_cycle      0.68 sec, wall time      0.29 sec
exp = [2.61825381e+04 7.61786472e+03 3.61741899e+03 1.60603691e+03
 3.54083811e+02 1.11042569e+02 3.64211128e+01 4.58830934e+00
 3.93808581e-01 1.36276600e+03 6.64833366e+02 3.01412930e+02
 3.14464090e+02 8.24948822e+01 9.58505012e+00 2.78942330e+01
 8.67797226e-01 3.45533217e+00 2.42336191e-01]
E = -526.4343737413857
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:43:36 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5381383        1
[INPUT] 0    0    [1    /1   ]  7617.8647187         1
[INPUT] 0    0    [1    /1   ]  3617.41899022        1
[INPUT] 0    0    [1    /1   ]  1606.03690856        1
[INPUT] 0    0    [1    /1   ]  354.083810738        1
[INPUT] 0    0    [1    /1   ]  111.042569426        1
[INPUT] 0    0    [1    /1   ]  36.4211128072        1
[INPUT] 0    0    [1    /1   ]  4.58830934499        1
[INPUT] 0    0    [1    /1   ]  0.393808581439       1
[INPUT] 1    0    [1    /1   ]  1362.76600165        1
[INPUT] 1    0    [1    /1   ]  664.833366283        1
[INPUT] 1    0    [1    /1   ]  301.412930199        1
[INPUT] 1    0    [1    /1   ]  314.464090359        1
[INPUT] 1    0    [1    /1   ]  82.4948822107        1
[INPUT] 1    0    [1    /1   ]  9.58505012373        1
[INPUT] 1    0    [1    /1   ]  27.8942330184        1
[INPUT] 1    0    [1    /1   ]  0.867797226484       1
[INPUT] 1    0    [1    /1   ]  3.45533217396        1
[INPUT] 1    0    [1    /1   ]  0.242336190946       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.538138296888, 1.0]], [0, [7617.864718700486, 1.0]], [0, [3617.4189902214052, 1.0]], [0, [1606.0369085606208, 1.0]], [0, [354.08381073795647, 1.0]], [0, [111.04256942641086, 1.0]], [0, [36.421112807162224, 1.0]], [0, [4.588309344990439, 1.0]], [0, [0.39380858143948444, 1.0]], [1, [1362.76600165107, 1.0]], [1, [664.833366282727, 1.0]], [1, [301.4129301992527, 1.0]], [1, [314.4640903587194, 1.0]], [1, [82.49488221074648, 1.0]], [1, [9.585050123727067, 1.0]], [1, [27.89423301842302, 1.0]], [1, [0.8677972264843351, 1.0]], [1, [3.4553321739579608, 1.0]], [1, [0.2423361909461083, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.5381383]
bas 1, expnt(s) = [7617.8647187]
bas 2, expnt(s) = [3617.41899022]
bas 3, expnt(s) = [1606.03690856]
bas 4, expnt(s) = [354.08381074]
bas 5, expnt(s) = [111.04256943]
bas 6, expnt(s) = [36.42111281]
bas 7, expnt(s) = [4.58830934]
bas 8, expnt(s) = [0.39380858]
bas 9, expnt(s) = [1362.76600165]
bas 10, expnt(s) = [664.83336628]
bas 11, expnt(s) = [301.4129302]
bas 12, expnt(s) = [314.46409036]
bas 13, expnt(s) = [82.49488221]
bas 14, expnt(s) = [9.58505012]
bas 15, expnt(s) = [27.89423302]
bas 16, expnt(s) = [0.86779723]
bas 17, expnt(s) = [3.45533217]
bas 18, expnt(s) = [0.24233619]
CPU time:       551.47
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825381e+04 5.20024533e+03 7.61786472e+03 2.06010789e+03
 3.61741899e+03 1.17845807e+03 1.60603691e+03 6.40961089e+02
 3.54083811e+02 2.06226550e+02 1.11042569e+02 8.64235598e+01
 3.64211128e+01 3.74567362e+01 4.58830934e+00 7.92053545e+00
 3.93808581e-01 1.25596896e+00 1.36276600e+03 2.41552204e+04
 6.64833366e+02 9.84862047e+03 3.01412930e+02 3.66384204e+03
 3.14464090e+02 3.86320911e+03 8.24948822e+01 7.25300791e+02
 9.58505012e+00 4.92013906e+01 2.78942330e+01 1.87015423e+02
 8.67797226e-01 2.44347114e+00 3.45533217e+00 1.37434779e+01
 2.42336191e-01 4.96029196e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97278601464436
cond(S) = 149279.68050596534
E1 = -728.7738843872157  E_coul = 203.1080422412494
init E= -525.665842145966
    CPU time for initialize scf      0.45 sec, wall time      0.06 sec
  HOMO = -0.559219891962773  LUMO = 1.19415006392669
  mo_energy =
[-1.18304002e+02 -1.21035230e+01 -9.44899478e+00 -9.44899478e+00
 -9.44899478e+00 -1.23091685e+00 -5.59219892e-01 -5.59219892e-01
 -5.59219892e-01  1.19415006e+00  1.19415006e+00  1.19415006e+00
  9.66074706e+00  9.66074706e+00  9.66074706e+00  4.70223369e+01
  4.70223369e+01  4.70223369e+01  7.92552883e+01  1.78953119e+02
  1.78953119e+02  1.78953119e+02  5.52506763e+02  5.74147889e+02
  5.74147889e+02  5.74147889e+02  1.43970778e+03  1.43970778e+03
  1.43970778e+03  2.57525490e+03  3.13653373e+03  3.13653373e+03
  3.13653373e+03  6.75228384e+03  6.75228384e+03  6.75228384e+03
  8.97142188e+03  2.53340995e+04  7.60847388e+04]
E1 = -728.0948271815473  E_coul = 201.66083018749362
cycle= 1 E= -526.433996994054  delta_E= -0.768  |g|= 0.187  |ddm|= 0.428
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.558112
diis-c [-0.31148899  1.        ]
  HOMO = -0.572304500228375  LUMO = 1.18446114955146
  mo_energy =
[-1.18573634e+02 -1.21973127e+01 -9.54935274e+00 -9.54935274e+00
 -9.54935274e+00 -1.25088456e+00 -5.72304500e-01 -5.72304500e-01
 -5.72304500e-01  1.18446115e+00  1.18446115e+00  1.18446115e+00
  9.59666649e+00  9.59666649e+00  9.59666649e+00  4.68927476e+01
  4.68927476e+01  4.68927476e+01  7.90912524e+01  1.78753062e+02
  1.78753062e+02  1.78753062e+02  5.52206346e+02  5.73881707e+02
  5.73881707e+02  5.73881707e+02  1.43938663e+03  1.43938663e+03
  1.43938663e+03  2.57480044e+03  3.13614796e+03  3.13614796e+03
  3.13614796e+03  6.75178236e+03  6.75178236e+03  6.75178236e+03
  8.97084248e+03  2.53334244e+04  7.60839721e+04]
E1 = -728.3796512900864  E_coul = 201.9452899627243
cycle= 2 E= -526.434361327362  delta_E= -0.000364  |g|= 0.0238  |ddm|= 0.0195
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.04634
diis-c [-0.00142095  0.04616826  0.95383174]
  HOMO = -0.5688717204369  LUMO = 1.18760212265828
  mo_energy =
[-1.18532064e+02 -1.21777785e+01 -9.52944394e+00 -9.52944394e+00
 -9.52944394e+00 -1.24632156e+00 -5.68871720e-01 -5.68871720e-01
 -5.68871720e-01  1.18760212e+00  1.18760212e+00  1.18760212e+00
  9.60932703e+00  9.60932703e+00  9.60932703e+00  4.69167609e+01
  4.69167609e+01  4.69167609e+01  7.91247158e+01  1.78787753e+02
  1.78787753e+02  1.78787753e+02  5.52249206e+02  5.73922833e+02
  5.73922833e+02  5.73922833e+02  1.43943057e+03  1.43943057e+03
  1.43943057e+03  2.57484663e+03  3.13619348e+03  3.13619348e+03
  3.13619348e+03  6.75182888e+03  6.75182888e+03  6.75182888e+03
  8.97088941e+03  2.53334715e+04  7.60840192e+04]
E1 = -728.3213286431213  E_coul = 201.88695517494546
cycle= 3 E= -526.434373468176  delta_E= -1.21e-05  |g|= 0.00291  |ddm|= 0.00499
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00628183
diis-c [-3.44242254e-07 -1.03654838e-03  1.12853567e-01  8.88182981e-01]
  HOMO = -0.569505450247773  LUMO = 1.18704500530655
  mo_energy =
[-1.18537190e+02 -1.21805388e+01 -9.53230339e+00 -9.53230339e+00
 -9.53230339e+00 -1.24714521e+00 -5.69505450e-01 -5.69505450e-01
 -5.69505450e-01  1.18704501e+00  1.18704501e+00  1.18704501e+00
  9.60735354e+00  9.60735354e+00  9.60735354e+00  4.69134802e+01
  4.69134802e+01  4.69134802e+01  7.91205653e+01  1.78783360e+02
  1.78783360e+02  1.78783360e+02  5.52243921e+02  5.73917761e+02
  5.73917761e+02  5.73917761e+02  1.43942516e+03  1.43942516e+03
  1.43942516e+03  2.57484082e+03  3.13618783e+03  3.13618783e+03
  3.13618783e+03  6.75182299e+03  6.75182299e+03  6.75182299e+03
  8.97088338e+03  2.53334654e+04  7.60840130e+04]
E1 = -728.3293185430824  E_coul = 201.8949448018422
cycle= 4 E= -526.43437374124  delta_E= -2.73e-07  |g|= 4.34e-05  |ddm|= 0.000744
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.85177e-05
diis-c [-1.64570066e-09  5.50827898e-06 -1.42076845e-03 -4.03974251e-03
  1.00545500e+00]
  HOMO = -0.569478298561455  LUMO = 1.18706808026142
  mo_energy =
[-1.18537093e+02 -1.21804501e+01 -9.53221552e+00 -9.53221552e+00
 -9.53221552e+00 -1.24710992e+00 -5.69478299e-01 -5.69478299e-01
 -5.69478299e-01  1.18706808e+00  1.18706808e+00  1.18706808e+00
  9.60742286e+00  9.60742286e+00  9.60742286e+00  4.69135688e+01
  4.69135688e+01  4.69135688e+01  7.91206644e+01  1.78783456e+02
  1.78783456e+02  1.78783456e+02  5.52244015e+02  5.73917857e+02
  5.73917857e+02  5.73917857e+02  1.43942525e+03  1.43942525e+03
  1.43942525e+03  2.57484091e+03  3.13618792e+03  3.13618792e+03
  3.13618792e+03  6.75182308e+03  6.75182308e+03  6.75182308e+03
  8.97088346e+03  2.53334654e+04  7.60840131e+04]
E1 = -728.3291111810313  E_coul = 201.89473743964774
cycle= 5 E= -526.434373741384  delta_E= -1.43e-10  |g|= 7.01e-06  |ddm|= 2.41e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3291111810313  E_coul = 201.89473743964774
  HOMO = -0.569481856793253  LUMO = 1.18706503675987
  mo_energy =
[-1.18537111e+02 -1.21804626e+01 -9.53222829e+00 -9.53222829e+00
 -9.53222829e+00 -1.24711454e+00 -5.69481857e-01 -5.69481857e-01
 -5.69481857e-01  1.18706504e+00  1.18706504e+00  1.18706504e+00
  9.60741323e+00  9.60741323e+00  9.60741323e+00  4.69135553e+01
  4.69135553e+01  4.69135553e+01  7.91206489e+01  1.78783440e+02
  1.78783440e+02  1.78783440e+02  5.52243998e+02  5.73917840e+02
  5.73917840e+02  5.73917840e+02  1.43942523e+03  1.43942523e+03
  1.43942523e+03  2.57484089e+03  3.13618791e+03  3.13618791e+03
  3.13618791e+03  6.75182306e+03  6.75182306e+03  6.75182306e+03
  8.97088344e+03  2.53334654e+04  7.60840131e+04]
E1 = -728.3291435641997  E_coul = 201.89476982281403
Extra cycle  E= -526.434373741386  delta_E= -2.16e-12  |g|= 1.76e-06  |ddm|= 3.48e-06
    CPU time for scf_cycle      0.71 sec, wall time      0.31 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 149279.68050596534
E1 = -728.3291435641997  E_coul = 201.89476982281403
init E= -526.434373741386
    CPU time for initialize scf      2.75 sec, wall time      0.25 sec
  HOMO = -0.569481255464603  LUMO = 1.18706555911143
  mo_energy =
[-1.18537107e+02 -1.21804602e+01 -9.53222585e+00 -9.53222585e+00
 -9.53222585e+00 -1.24711376e+00 -5.69481255e-01 -5.69481255e-01
 -5.69481255e-01  1.18706556e+00  1.18706556e+00  1.18706556e+00
  9.60741499e+00  9.60741499e+00  9.60741499e+00  4.69135580e+01
  4.69135580e+01  4.69135580e+01  7.91206522e+01  1.78783443e+02
  1.78783443e+02  1.78783443e+02  5.52244002e+02  5.73917844e+02
  5.73917844e+02  5.73917844e+02  1.43942524e+03  1.43942524e+03
  1.43942524e+03  2.57484089e+03  3.13618791e+03  3.13618791e+03
  3.13618791e+03  6.75182306e+03  6.75182306e+03  6.75182306e+03
  8.97088345e+03  2.53334654e+04  7.60840131e+04]
E1 = -728.329137052125  E_coul = 201.8947633107385
cycle= 1 E= -526.434373741386  delta_E= -7.96e-13  |g|= 3.87e-07  |ddm|= 6.44e-07
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
E1 = -728.329137052125  E_coul = 201.8947633107385
  HOMO = -0.56948136915462  LUMO = 1.1870654597021
  mo_energy =
[-1.18537107e+02 -1.21804607e+01 -9.53222634e+00 -9.53222634e+00
 -9.53222634e+00 -1.24711391e+00 -5.69481369e-01 -5.69481369e-01
 -5.69481369e-01  1.18706546e+00  1.18706546e+00  1.18706546e+00
  9.60741464e+00  9.60741464e+00  9.60741464e+00  4.69135574e+01
  4.69135574e+01  4.69135574e+01  7.91206515e+01  1.78783442e+02
  1.78783442e+02  1.78783442e+02  5.52244001e+02  5.73917843e+02
  5.73917843e+02  5.73917843e+02  1.43942524e+03  1.43942524e+03
  1.43942524e+03  2.57484089e+03  3.13618791e+03  3.13618791e+03
  3.13618791e+03  6.75182306e+03  6.75182306e+03  6.75182306e+03
  8.97088345e+03  2.53334654e+04  7.60840131e+04]
E1 = -728.3291383821403  E_coul = 201.8947646407539
Extra cycle  E= -526.434373741386  delta_E= 1.14e-13  |g|= 8.16e-08  |ddm|= 1.28e-07
    CPU time for scf_cycle      2.90 sec, wall time      0.40 sec
exp = [2.61825381e+04 7.61786472e+03 3.61741899e+03 1.60603691e+03
 3.54083811e+02 1.11042569e+02 3.64211128e+01 4.58830934e+00
 3.93808581e-01 1.36276600e+03 6.64833366e+02 3.01412930e+02
 3.14464090e+02 8.24948822e+01 9.58505012e+00 2.78942330e+01
 8.67797226e-01 3.45533217e+00 2.42336191e-01]
grad_E = [-1.75093448e-06  6.98606458e-06  3.53534539e-06  1.93977199e-04
 -1.97036988e-03  5.53650332e-03 -4.07498475e-03  2.58780272e-03
 -1.52746495e-02 -6.49059791e-07  7.92757002e-07  2.61325042e-06
  2.08068153e-06 -1.64104061e-04 -6.82578242e-03  3.67014965e-03
  3.42703430e-02  5.59709722e-03 -4.98459427e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:43:41 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5388696        1
[INPUT] 0    0    [1    /1   ]  7617.85583977        1
[INPUT] 0    0    [1    /1   ]  3617.40021884        1
[INPUT] 0    0    [1    /1   ]  1605.75640373        1
[INPUT] 0    0    [1    /1   ]  356.872920033        1
[INPUT] 0    0    [1    /1   ]  111.594639461        1
[INPUT] 0    0    [1    /1   ]  36.4788538511        1
[INPUT] 0    0    [1    /1   ]  4.58484909118        1
[INPUT] 0    0    [1    /1   ]  0.39416298421        1
[INPUT] 1    0    [1    /1   ]  1362.76546288        1
[INPUT] 1    0    [1    /1   ]  664.826030534        1
[INPUT] 1    0    [1    /1   ]  301.372866677        1
[INPUT] 1    0    [1    /1   ]  314.428742012        1
[INPUT] 1    0    [1    /1   ]  83.0492593408        1
[INPUT] 1    0    [1    /1   ]  9.79535439899        1
[INPUT] 1    0    [1    /1   ]  28.6657286722        1
[INPUT] 1    0    [1    /1   ]  0.861379535929       1
[INPUT] 1    0    [1    /1   ]  3.50637757633        1
[INPUT] 1    0    [1    /1   ]  0.241121320928       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.53886961277, 1.0]], [0, [7617.855839774416, 1.0]], [0, [3617.4002188421605, 1.0]], [0, [1605.7564037282364, 1.0]], [0, [356.87292003298745, 1.0]], [0, [111.5946394608604, 1.0]], [0, [36.478853851112085, 1.0]], [0, [4.584849091176302, 1.0]], [0, [0.39416298421020723, 1.0]], [1, [1362.7654628842654, 1.0]], [1, [664.8260305336152, 1.0]], [1, [301.37286667717814, 1.0]], [1, [314.428742011514, 1.0]], [1, [83.04925934078993, 1.0]], [1, [9.79535439899466, 1.0]], [1, [28.665728672226777, 1.0]], [1, [0.861379535928615, 1.0]], [1, [3.506377576330556, 1.0]], [1, [0.24112132092816305, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.53886961]
bas 1, expnt(s) = [7617.85583977]
bas 2, expnt(s) = [3617.40021884]
bas 3, expnt(s) = [1605.75640373]
bas 4, expnt(s) = [356.87292003]
bas 5, expnt(s) = [111.59463946]
bas 6, expnt(s) = [36.47885385]
bas 7, expnt(s) = [4.58484909]
bas 8, expnt(s) = [0.39416298]
bas 9, expnt(s) = [1362.76546288]
bas 10, expnt(s) = [664.82603053]
bas 11, expnt(s) = [301.37286668]
bas 12, expnt(s) = [314.42874201]
bas 13, expnt(s) = [83.04925934]
bas 14, expnt(s) = [9.7953544]
bas 15, expnt(s) = [28.66572867]
bas 16, expnt(s) = [0.86137954]
bas 17, expnt(s) = [3.50637758]
bas 18, expnt(s) = [0.24112132]
CPU time:       559.80
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825389e+04 5.20024544e+03 7.61785584e+03 2.06010609e+03
 3.61740022e+03 1.17845348e+03 1.60575640e+03 6.40877126e+02
 3.56872920e+02 2.07443686e+02 1.11594639e+02 8.67456138e+01
 3.64788539e+01 3.75012646e+01 4.58484909e+00 7.91605510e+00
 3.94162984e-01 1.25681658e+00 1.36276546e+03 2.41552085e+04
 6.64826031e+02 9.84848464e+03 3.01372867e+02 3.66323330e+03
 3.14428742e+02 3.86266630e+03 8.30492593e+01 7.31398553e+02
 9.79535440e+00 5.05544726e+01 2.86657287e+01 1.93503188e+02
 8.61379536e-01 2.42090407e+00 3.50637758e+00 1.39977342e+01
 2.41121321e-01 4.92922804e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.973007818577333
cond(S) = 152020.5932724155
E1 = -728.7689730599405  E_coul = 203.10672738137936
init E= -525.662245678561
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559105716388929  LUMO = 1.1838430324066
  mo_energy =
[-1.18305710e+02 -1.21036512e+01 -9.44893108e+00 -9.44893108e+00
 -9.44893108e+00 -1.23075316e+00 -5.59105716e-01 -5.59105716e-01
 -5.59105716e-01  1.18384303e+00  1.18384303e+00  1.18384303e+00
  9.80189874e+00  9.80189874e+00  9.80189874e+00  4.82571219e+01
  4.82571219e+01  4.82571219e+01  7.95791992e+01  1.82351323e+02
  1.82351323e+02  1.82351323e+02  5.56085530e+02  5.78910180e+02
  5.78910180e+02  5.78910180e+02  1.44474732e+03  1.44474732e+03
  1.44474732e+03  2.58489483e+03  3.14144112e+03  3.14144112e+03
  3.14144112e+03  6.75681504e+03  6.75681504e+03  6.75681504e+03
  8.98282938e+03  2.53453700e+04  7.60953152e+04]
E1 = -728.0827648391279  E_coul = 201.647801237498
cycle= 1 E= -526.43496360163  delta_E= -0.773  |g|= 0.187  |ddm|= 0.499
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.559027
diis-c [-0.31251071  1.        ]
  HOMO = -0.572327237411507  LUMO = 1.17412820816799
  mo_energy =
[-1.18576982e+02 -1.21981835e+01 -9.55023556e+00 -9.55023556e+00
 -9.55023556e+00 -1.25094970e+00 -5.72327237e-01 -5.72327237e-01
 -5.72327237e-01  1.17412821e+00  1.17412821e+00  1.17412821e+00
  9.73633212e+00  9.73633212e+00  9.73633212e+00  4.81248261e+01
  4.81248261e+01  4.81248261e+01  7.94137792e+01  1.82149423e+02
  1.82149423e+02  1.82149423e+02  5.55782804e+02  5.78642479e+02
  5.78642479e+02  5.78642479e+02  1.44442460e+03  1.44442460e+03
  1.44442460e+03  2.58443839e+03  3.14105363e+03  3.14105363e+03
  3.14105363e+03  6.75631186e+03  6.75631186e+03  6.75631186e+03
  8.98224832e+03  2.53446933e+04  7.60945470e+04]
E1 = -728.3702185301557  E_coul = 201.93488486725107
cycle= 2 E= -526.435333662905  delta_E= -0.00037  |g|= 0.0239  |ddm|= 0.0199
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0465985
diis-c [-0.00142779  0.04661332  0.95338668]
  HOMO = -0.568840255258871  LUMO = 1.17729535666189
  mo_energy =
[-1.18535124e+02 -1.21784842e+01 -9.53015875e+00 -9.53015875e+00
 -9.53015875e+00 -1.24631846e+00 -5.68840255e-01 -5.68840255e-01
 -5.68840255e-01  1.17729536e+00  1.17729536e+00  1.17729536e+00
  9.74929806e+00  9.74929806e+00  9.74929806e+00  4.81492989e+01
  4.81492989e+01  4.81492989e+01  7.94475340e+01  1.82184443e+02
  1.82184443e+02  1.82184443e+02  5.55825986e+02  5.78683883e+02
  5.78683883e+02  5.78683883e+02  1.44446883e+03  1.44446883e+03
  1.44446883e+03  2.58448489e+03  3.14109946e+03  3.14109946e+03
  3.14109946e+03  6.75635869e+03  6.75635869e+03  6.75635869e+03
  8.98229556e+03  2.53447407e+04  7.60945944e+04]
E1 = -728.3115269183477  E_coul = 201.8761809532754
cycle= 3 E= -526.435345965072  delta_E= -1.23e-05  |g|= 0.00291  |ddm|= 0.00505
    CPU time for cycle= 3      0.04 sec, wall time      0.05 sec
diis-norm(errvec)=0.00628586
diis-c [-3.49075843e-07 -1.04200962e-03  1.12280412e-01  8.88761598e-01]
  HOMO = -0.56947732980813  LUMO = 1.17673919019188
  mo_energy =
[-1.18540259e+02 -1.21812516e+01 -9.53302632e+00 -9.53302632e+00
 -9.53302632e+00 -1.24714667e+00 -5.69477330e-01 -5.69477330e-01
 -5.69477330e-01  1.17673919e+00  1.17673919e+00  1.17673919e+00
  9.74729621e+00  9.74729621e+00  9.74729621e+00  4.81459818e+01
  4.81459818e+01  4.81459818e+01  7.94433727e+01  1.82180034e+02
  1.82180034e+02  1.82180034e+02  5.55820689e+02  5.78678803e+02
  5.78678803e+02  5.78678803e+02  1.44446342e+03  1.44446342e+03
  1.44446342e+03  2.58447907e+03  3.14109380e+03  3.14109380e+03
  3.14109380e+03  6.75635278e+03  6.75635278e+03  6.75635278e+03
  8.98228952e+03  2.53447345e+04  7.60945881e+04]
E1 = -728.3195279260138  E_coul = 201.8841816873891
cycle= 4 E= -526.435346238625  delta_E= -2.74e-07  |g|= 4.34e-05  |ddm|= 0.000749
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.83629e-05
diis-c [-1.66121296e-09  6.56926846e-06 -1.55269084e-03 -5.20179727e-03
  1.00674792e+00]
  HOMO = -0.569450030246679  LUMO = 1.17676224203905
  mo_energy =
[-1.18540162e+02 -1.21811629e+01 -9.53293843e+00 -9.53293843e+00
 -9.53293843e+00 -1.24711123e+00 -5.69450030e-01 -5.69450030e-01
 -5.69450030e-01  1.17676224e+00  1.17676224e+00  1.17676224e+00
  9.74736614e+00  9.74736614e+00  9.74736614e+00  4.81460707e+01
  4.81460707e+01  4.81460707e+01  7.94434719e+01  1.82180130e+02
  1.82180130e+02  1.82180130e+02  5.55820783e+02  5.78678900e+02
  5.78678900e+02  5.78678900e+02  1.44446351e+03  1.44446351e+03
  1.44446351e+03  2.58447915e+03  3.14109389e+03  3.14109389e+03
  3.14109389e+03  6.75635287e+03  6.75635287e+03  6.75635287e+03
  8.98228960e+03  2.53447346e+04  7.60945882e+04]
E1 = -728.3193209467057  E_coul = 201.8839747079388
cycle= 5 E= -526.435346238767  delta_E= -1.42e-10  |g|= 7.04e-06  |ddm|= 2.4e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3193209467057  E_coul = 201.8839747079388
  HOMO = -0.569453629182805  LUMO = 1.17675918462868
  mo_energy =
[-1.18540179e+02 -1.21811756e+01 -9.53295132e+00 -9.53295132e+00
 -9.53295132e+00 -1.24711590e+00 -5.69453629e-01 -5.69453629e-01
 -5.69453629e-01  1.17675918e+00  1.17675918e+00  1.17675918e+00
  9.74735634e+00  9.74735634e+00  9.74735634e+00  4.81460570e+01
  4.81460570e+01  4.81460570e+01  7.94434562e+01  1.82180114e+02
  1.82180114e+02  1.82180114e+02  5.55820766e+02  5.78678882e+02
  5.78678882e+02  5.78678882e+02  1.44446349e+03  1.44446349e+03
  1.44446349e+03  2.58447914e+03  3.14109387e+03  3.14109387e+03
  3.14109387e+03  6.75635285e+03  6.75635285e+03  6.75635285e+03
  8.98228959e+03  2.53447346e+04  7.60945882e+04]
E1 = -728.3193535618113  E_coul = 201.88400732304112
Extra cycle  E= -526.43534623877  delta_E= -3.3e-12  |g|= 1.77e-06  |ddm|= 3.52e-06
    CPU time for scf_cycle      0.68 sec, wall time      0.30 sec
exp = [2.61825389e+04 7.61785584e+03 3.61740022e+03 1.60575640e+03
 3.56872920e+02 1.11594639e+02 3.64788539e+01 4.58484909e+00
 3.94162984e-01 1.36276546e+03 6.64826031e+02 3.01372867e+02
 3.14428742e+02 8.30492593e+01 9.79535440e+00 2.86657287e+01
 8.61379536e-01 3.50637758e+00 2.41121321e-01]
E = -526.4353462387702
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:43:41 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5388696        1
[INPUT] 0    0    [1    /1   ]  7617.85583977        1
[INPUT] 0    0    [1    /1   ]  3617.40021884        1
[INPUT] 0    0    [1    /1   ]  1605.75640373        1
[INPUT] 0    0    [1    /1   ]  356.872920033        1
[INPUT] 0    0    [1    /1   ]  111.594639461        1
[INPUT] 0    0    [1    /1   ]  36.4788538511        1
[INPUT] 0    0    [1    /1   ]  4.58484909118        1
[INPUT] 0    0    [1    /1   ]  0.39416298421        1
[INPUT] 1    0    [1    /1   ]  1362.76546288        1
[INPUT] 1    0    [1    /1   ]  664.826030534        1
[INPUT] 1    0    [1    /1   ]  301.372866677        1
[INPUT] 1    0    [1    /1   ]  314.428742012        1
[INPUT] 1    0    [1    /1   ]  83.0492593408        1
[INPUT] 1    0    [1    /1   ]  9.79535439899        1
[INPUT] 1    0    [1    /1   ]  28.6657286722        1
[INPUT] 1    0    [1    /1   ]  0.861379535929       1
[INPUT] 1    0    [1    /1   ]  3.50637757633        1
[INPUT] 1    0    [1    /1   ]  0.241121320928       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.53886961277, 1.0]], [0, [7617.855839774416, 1.0]], [0, [3617.4002188421605, 1.0]], [0, [1605.7564037282364, 1.0]], [0, [356.87292003298745, 1.0]], [0, [111.5946394608604, 1.0]], [0, [36.478853851112085, 1.0]], [0, [4.584849091176302, 1.0]], [0, [0.39416298421020723, 1.0]], [1, [1362.7654628842654, 1.0]], [1, [664.8260305336152, 1.0]], [1, [301.37286667717814, 1.0]], [1, [314.428742011514, 1.0]], [1, [83.04925934078993, 1.0]], [1, [9.79535439899466, 1.0]], [1, [28.665728672226777, 1.0]], [1, [0.861379535928615, 1.0]], [1, [3.506377576330556, 1.0]], [1, [0.24112132092816305, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.53886961]
bas 1, expnt(s) = [7617.85583977]
bas 2, expnt(s) = [3617.40021884]
bas 3, expnt(s) = [1605.75640373]
bas 4, expnt(s) = [356.87292003]
bas 5, expnt(s) = [111.59463946]
bas 6, expnt(s) = [36.47885385]
bas 7, expnt(s) = [4.58484909]
bas 8, expnt(s) = [0.39416298]
bas 9, expnt(s) = [1362.76546288]
bas 10, expnt(s) = [664.82603053]
bas 11, expnt(s) = [301.37286668]
bas 12, expnt(s) = [314.42874201]
bas 13, expnt(s) = [83.04925934]
bas 14, expnt(s) = [9.7953544]
bas 15, expnt(s) = [28.66572867]
bas 16, expnt(s) = [0.86137954]
bas 17, expnt(s) = [3.50637758]
bas 18, expnt(s) = [0.24112132]
CPU time:       560.70
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825389e+04 5.20024544e+03 7.61785584e+03 2.06010609e+03
 3.61740022e+03 1.17845348e+03 1.60575640e+03 6.40877126e+02
 3.56872920e+02 2.07443686e+02 1.11594639e+02 8.67456138e+01
 3.64788539e+01 3.75012646e+01 4.58484909e+00 7.91605510e+00
 3.94162984e-01 1.25681658e+00 1.36276546e+03 2.41552085e+04
 6.64826031e+02 9.84848464e+03 3.01372867e+02 3.66323330e+03
 3.14428742e+02 3.86266630e+03 8.30492593e+01 7.31398553e+02
 9.79535440e+00 5.05544726e+01 2.86657287e+01 1.93503188e+02
 8.61379536e-01 2.42090407e+00 3.50637758e+00 1.39977342e+01
 2.41121321e-01 4.92922804e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.973007818577333
cond(S) = 152020.5932724155
E1 = -728.7689730599405  E_coul = 203.10672738137936
init E= -525.662245678561
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559105716388929  LUMO = 1.1838430324066
  mo_energy =
[-1.18305710e+02 -1.21036512e+01 -9.44893108e+00 -9.44893108e+00
 -9.44893108e+00 -1.23075316e+00 -5.59105716e-01 -5.59105716e-01
 -5.59105716e-01  1.18384303e+00  1.18384303e+00  1.18384303e+00
  9.80189874e+00  9.80189874e+00  9.80189874e+00  4.82571219e+01
  4.82571219e+01  4.82571219e+01  7.95791992e+01  1.82351323e+02
  1.82351323e+02  1.82351323e+02  5.56085530e+02  5.78910180e+02
  5.78910180e+02  5.78910180e+02  1.44474732e+03  1.44474732e+03
  1.44474732e+03  2.58489483e+03  3.14144112e+03  3.14144112e+03
  3.14144112e+03  6.75681504e+03  6.75681504e+03  6.75681504e+03
  8.98282938e+03  2.53453700e+04  7.60953152e+04]
E1 = -728.0827648391279  E_coul = 201.647801237498
cycle= 1 E= -526.43496360163  delta_E= -0.773  |g|= 0.187  |ddm|= 0.499
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.559027
diis-c [-0.31251071  1.        ]
  HOMO = -0.572327237411507  LUMO = 1.17412820816799
  mo_energy =
[-1.18576982e+02 -1.21981835e+01 -9.55023556e+00 -9.55023556e+00
 -9.55023556e+00 -1.25094970e+00 -5.72327237e-01 -5.72327237e-01
 -5.72327237e-01  1.17412821e+00  1.17412821e+00  1.17412821e+00
  9.73633212e+00  9.73633212e+00  9.73633212e+00  4.81248261e+01
  4.81248261e+01  4.81248261e+01  7.94137792e+01  1.82149423e+02
  1.82149423e+02  1.82149423e+02  5.55782804e+02  5.78642479e+02
  5.78642479e+02  5.78642479e+02  1.44442460e+03  1.44442460e+03
  1.44442460e+03  2.58443839e+03  3.14105363e+03  3.14105363e+03
  3.14105363e+03  6.75631186e+03  6.75631186e+03  6.75631186e+03
  8.98224832e+03  2.53446933e+04  7.60945470e+04]
E1 = -728.3702185301557  E_coul = 201.93488486725107
cycle= 2 E= -526.435333662905  delta_E= -0.00037  |g|= 0.0239  |ddm|= 0.0199
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0465985
diis-c [-0.00142779  0.04661332  0.95338668]
  HOMO = -0.568840255258871  LUMO = 1.17729535666189
  mo_energy =
[-1.18535124e+02 -1.21784842e+01 -9.53015875e+00 -9.53015875e+00
 -9.53015875e+00 -1.24631846e+00 -5.68840255e-01 -5.68840255e-01
 -5.68840255e-01  1.17729536e+00  1.17729536e+00  1.17729536e+00
  9.74929806e+00  9.74929806e+00  9.74929806e+00  4.81492989e+01
  4.81492989e+01  4.81492989e+01  7.94475340e+01  1.82184443e+02
  1.82184443e+02  1.82184443e+02  5.55825986e+02  5.78683883e+02
  5.78683883e+02  5.78683883e+02  1.44446883e+03  1.44446883e+03
  1.44446883e+03  2.58448489e+03  3.14109946e+03  3.14109946e+03
  3.14109946e+03  6.75635869e+03  6.75635869e+03  6.75635869e+03
  8.98229556e+03  2.53447407e+04  7.60945944e+04]
E1 = -728.3115269183477  E_coul = 201.8761809532754
cycle= 3 E= -526.435345965072  delta_E= -1.23e-05  |g|= 0.00291  |ddm|= 0.00505
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00628586
diis-c [-3.49075843e-07 -1.04200962e-03  1.12280412e-01  8.88761598e-01]
  HOMO = -0.56947732980813  LUMO = 1.17673919019188
  mo_energy =
[-1.18540259e+02 -1.21812516e+01 -9.53302632e+00 -9.53302632e+00
 -9.53302632e+00 -1.24714667e+00 -5.69477330e-01 -5.69477330e-01
 -5.69477330e-01  1.17673919e+00  1.17673919e+00  1.17673919e+00
  9.74729621e+00  9.74729621e+00  9.74729621e+00  4.81459818e+01
  4.81459818e+01  4.81459818e+01  7.94433727e+01  1.82180034e+02
  1.82180034e+02  1.82180034e+02  5.55820689e+02  5.78678803e+02
  5.78678803e+02  5.78678803e+02  1.44446342e+03  1.44446342e+03
  1.44446342e+03  2.58447907e+03  3.14109380e+03  3.14109380e+03
  3.14109380e+03  6.75635278e+03  6.75635278e+03  6.75635278e+03
  8.98228952e+03  2.53447345e+04  7.60945881e+04]
E1 = -728.3195279260138  E_coul = 201.8841816873891
cycle= 4 E= -526.435346238625  delta_E= -2.74e-07  |g|= 4.34e-05  |ddm|= 0.000749
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.83629e-05
diis-c [-1.66121296e-09  6.56926846e-06 -1.55269084e-03 -5.20179727e-03
  1.00674792e+00]
  HOMO = -0.569450030246679  LUMO = 1.17676224203905
  mo_energy =
[-1.18540162e+02 -1.21811629e+01 -9.53293843e+00 -9.53293843e+00
 -9.53293843e+00 -1.24711123e+00 -5.69450030e-01 -5.69450030e-01
 -5.69450030e-01  1.17676224e+00  1.17676224e+00  1.17676224e+00
  9.74736614e+00  9.74736614e+00  9.74736614e+00  4.81460707e+01
  4.81460707e+01  4.81460707e+01  7.94434719e+01  1.82180130e+02
  1.82180130e+02  1.82180130e+02  5.55820783e+02  5.78678900e+02
  5.78678900e+02  5.78678900e+02  1.44446351e+03  1.44446351e+03
  1.44446351e+03  2.58447915e+03  3.14109389e+03  3.14109389e+03
  3.14109389e+03  6.75635287e+03  6.75635287e+03  6.75635287e+03
  8.98228960e+03  2.53447346e+04  7.60945882e+04]
E1 = -728.3193209467057  E_coul = 201.8839747079388
cycle= 5 E= -526.435346238767  delta_E= -1.42e-10  |g|= 7.04e-06  |ddm|= 2.4e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3193209467057  E_coul = 201.8839747079388
  HOMO = -0.569453629182805  LUMO = 1.17675918462868
  mo_energy =
[-1.18540179e+02 -1.21811756e+01 -9.53295132e+00 -9.53295132e+00
 -9.53295132e+00 -1.24711590e+00 -5.69453629e-01 -5.69453629e-01
 -5.69453629e-01  1.17675918e+00  1.17675918e+00  1.17675918e+00
  9.74735634e+00  9.74735634e+00  9.74735634e+00  4.81460570e+01
  4.81460570e+01  4.81460570e+01  7.94434562e+01  1.82180114e+02
  1.82180114e+02  1.82180114e+02  5.55820766e+02  5.78678882e+02
  5.78678882e+02  5.78678882e+02  1.44446349e+03  1.44446349e+03
  1.44446349e+03  2.58447914e+03  3.14109387e+03  3.14109387e+03
  3.14109387e+03  6.75635285e+03  6.75635285e+03  6.75635285e+03
  8.98228959e+03  2.53447346e+04  7.60945882e+04]
E1 = -728.3193535618113  E_coul = 201.88400732304112
Extra cycle  E= -526.43534623877  delta_E= -3.3e-12  |g|= 1.77e-06  |ddm|= 3.52e-06
    CPU time for scf_cycle      0.67 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 152020.5932724155
E1 = -728.3193535618113  E_coul = 201.88400732304112
init E= -526.43534623877
    CPU time for initialize scf      2.71 sec, wall time      0.24 sec
  HOMO = -0.569453021700405  LUMO = 1.17675970875491
  mo_energy =
[-1.18540176e+02 -1.21811732e+01 -9.53294886e+00 -9.53294886e+00
 -9.53294886e+00 -1.24711511e+00 -5.69453022e-01 -5.69453022e-01
 -5.69453022e-01  1.17675971e+00  1.17675971e+00  1.17675971e+00
  9.74735813e+00  9.74735813e+00  9.74735813e+00  4.81460598e+01
  4.81460598e+01  4.81460598e+01  7.94434596e+01  1.82180117e+02
  1.82180117e+02  1.82180117e+02  5.55820770e+02  5.78678886e+02
  5.78678886e+02  5.78678886e+02  1.44446350e+03  1.44446350e+03
  1.44446350e+03  2.58447914e+03  3.14109387e+03  3.14109387e+03
  3.14109387e+03  6.75635286e+03  6.75635286e+03  6.75635286e+03
  8.98228959e+03  2.53447346e+04  7.60945882e+04]
E1 = -728.3193470151944  E_coul = 201.8840007764244
cycle= 1 E= -526.43534623877  delta_E= 2.27e-13  |g|= 3.88e-07  |ddm|= 6.5e-07
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
E1 = -728.3193470151944  E_coul = 201.8840007764244
  HOMO = -0.569453136288483  LUMO = 1.17675960924258
  mo_energy =
[-1.18540176e+02 -1.21811736e+01 -9.53294935e+00 -9.53294935e+00
 -9.53294935e+00 -1.24711526e+00 -5.69453136e-01 -5.69453136e-01
 -5.69453136e-01  1.17675961e+00  1.17675961e+00  1.17675961e+00
  9.74735778e+00  9.74735778e+00  9.74735778e+00  4.81460592e+01
  4.81460592e+01  4.81460592e+01  7.94434589e+01  1.82180117e+02
  1.82180117e+02  1.82180117e+02  5.55820769e+02  5.78678885e+02
  5.78678885e+02  5.78678885e+02  1.44446349e+03  1.44446349e+03
  1.44446349e+03  2.58447914e+03  3.14109387e+03  3.14109387e+03
  3.14109387e+03  6.75635285e+03  6.75635285e+03  6.75635285e+03
  8.98228959e+03  2.53447346e+04  7.60945882e+04]
E1 = -728.3193483500061  E_coul = 201.88400211123607
Extra cycle  E= -526.43534623877  delta_E=    0  |g|= 8.17e-08  |ddm|= 1.29e-07
    CPU time for scf_cycle      2.86 sec, wall time      0.39 sec
exp = [2.61825389e+04 7.61785584e+03 3.61740022e+03 1.60575640e+03
 3.56872920e+02 1.11594639e+02 3.64788539e+01 4.58484909e+00
 3.94162984e-01 1.36276546e+03 6.64826031e+02 3.01372867e+02
 3.14428742e+02 8.30492593e+01 9.79535440e+00 2.86657287e+01
 8.61379536e-01 3.50637758e+00 2.41121321e-01]
grad_E = [-1.73823990e-06  6.71760798e-06  3.03932281e-06  1.85085212e-04
 -1.86281662e-03  5.43139505e-03 -4.09333592e-03 -1.01078026e-03
 -1.00872768e-02 -6.80137108e-07  1.14857006e-06  4.39282051e-06
  3.53698390e-06 -2.91005006e-04 -8.61203685e-03  4.49743731e-03
  2.08562490e-02  8.35064589e-03 -3.81132205e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:43:46 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5394316        1
[INPUT] 0    0    [1    /1   ]  7617.84924736        1
[INPUT] 0    0    [1    /1   ]  3617.38647686        1
[INPUT] 0    0    [1    /1   ]  1605.54845764        1
[INPUT] 0    0    [1    /1   ]  358.981971313        1
[INPUT] 0    0    [1    /1   ]  111.743663939        1
[INPUT] 0    0    [1    /1   ]  36.4390385448        1
[INPUT] 0    0    [1    /1   ]  4.58267297258        1
[INPUT] 0    0    [1    /1   ]  0.394976926483       1
[INPUT] 1    0    [1    /1   ]  1362.76510022        1
[INPUT] 1    0    [1    /1   ]  664.820865366        1
[INPUT] 1    0    [1    /1   ]  301.344768429        1
[INPUT] 1    0    [1    /1   ]  314.40394339         1
[INPUT] 1    0    [1    /1   ]  83.3689957013        1
[INPUT] 1    0    [1    /1   ]  10.0244894045        1
[INPUT] 1    0    [1    /1   ]  29.4230674964        1
[INPUT] 1    0    [1    /1   ]  0.852254029731       1
[INPUT] 1    0    [1    /1   ]  3.55919290395        1
[INPUT] 1    0    [1    /1   ]  0.239385628901       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.53943163435, 1.0]], [0, [7617.84924735962, 1.0]], [0, [3617.3864768576072, 1.0]], [0, [1605.5484576389274, 1.0]], [0, [358.9819713131558, 1.0]], [0, [111.74366393878351, 1.0]], [0, [36.439038544765474, 1.0]], [0, [4.58267297258126, 1.0]], [0, [0.3949769264831932, 1.0]], [1, [1362.765100215463, 1.0]], [1, [664.820865365789, 1.0]], [1, [301.34476842887653, 1.0]], [1, [314.40394338994827, 1.0]], [1, [83.36899570130375, 1.0]], [1, [10.024489404504491, 1.0]], [1, [29.42306749636177, 1.0]], [1, [0.8522540297310545, 1.0]], [1, [3.55919290394719, 1.0]], [1, [0.23938562890137638, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.53943163]
bas 1, expnt(s) = [7617.84924736]
bas 2, expnt(s) = [3617.38647686]
bas 3, expnt(s) = [1605.54845764]
bas 4, expnt(s) = [358.98197131]
bas 5, expnt(s) = [111.74366394]
bas 6, expnt(s) = [36.43903854]
bas 7, expnt(s) = [4.58267297]
bas 8, expnt(s) = [0.39497693]
bas 9, expnt(s) = [1362.76510022]
bas 10, expnt(s) = [664.82086537]
bas 11, expnt(s) = [301.34476843]
bas 12, expnt(s) = [314.40394339]
bas 13, expnt(s) = [83.3689957]
bas 14, expnt(s) = [10.0244894]
bas 15, expnt(s) = [29.4230675]
bas 16, expnt(s) = [0.85225403]
bas 17, expnt(s) = [3.5591929]
bas 18, expnt(s) = [0.23938563]
CPU time:       569.01
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825394e+04 5.20024552e+03 7.61784925e+03 2.06010476e+03
 3.61738648e+03 1.17845013e+03 1.60554846e+03 6.40814880e+02
 3.58981971e+02 2.08362473e+02 1.11743664e+02 8.68324799e+01
 3.64390385e+01 3.74705620e+01 4.58267297e+00 7.91323702e+00
 3.94976926e-01 1.25876257e+00 1.36276510e+03 2.41552005e+04
 6.64820865e+02 9.84838899e+03 3.01344768e+02 3.66280639e+03
 3.14403943e+02 3.86228550e+03 8.33689957e+01 7.34920065e+02
 1.00244894e+01 5.20369962e+01 2.94230675e+01 1.99914515e+02
 8.52254030e-01 2.38888763e+00 3.55919290e+00 1.42617822e+01
 2.39385629e-01 4.88491472e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.973262047635966
cond(S) = 154382.717992945
E1 = -728.7759190002381  E_coul = 203.11370362881655
init E= -525.662215371422
    CPU time for initialize scf      0.46 sec, wall time      0.06 sec
  HOMO = -0.558778787327953  LUMO = 1.16898535216195
  mo_energy =
[-1.18306811e+02 -1.21031729e+01 -9.44817347e+00 -9.44817347e+00
 -9.44817347e+00 -1.23041339e+00 -5.58778787e-01 -5.58778787e-01
 -5.58778787e-01  1.16898535e+00  1.16898535e+00  1.16898535e+00
  9.94366813e+00  9.94366813e+00  9.94366813e+00  4.95244007e+01
  4.95244007e+01  4.95244007e+01  7.95575112e+01  1.85558705e+02
  1.85558705e+02  1.85558705e+02  5.57824207e+02  5.83106357e+02
  5.83106357e+02  5.83106357e+02  1.44906303e+03  1.44906303e+03
  1.44906303e+03  2.59090635e+03  3.14560465e+03  3.14560465e+03
  3.14560465e+03  6.76065018e+03  6.76065018e+03  6.76065018e+03
  8.99021227e+03  2.53527071e+04  7.61022070e+04]
E1 = -728.0744943658577  E_coul = 201.63850922519242
cycle= 1 E= -526.435985140665  delta_E= -0.774  |g|= 0.188  |ddm|= 0.569
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.559539
diis-c [-0.31308344  1.        ]
  HOMO = -0.572189265296835  LUMO = 1.1592653114929
  mo_energy =
[-1.18579993e+02 -1.21989223e+01 -9.55083427e+00 -9.55083427e+00
 -9.55083427e+00 -1.25097729e+00 -5.72189265e-01 -5.72189265e-01
 -5.72189265e-01  1.15926531e+00  1.15926531e+00  1.15926531e+00
  9.87626960e+00  9.87626960e+00  9.87626960e+00  4.93890732e+01
  4.93890732e+01  4.93890732e+01  7.93904900e+01  1.85354745e+02
  1.85354745e+02  1.85354745e+02  5.57519081e+02  5.82836848e+02
  5.82836848e+02  5.82836848e+02  1.44873842e+03  1.44873842e+03
  1.44873842e+03  2.59044765e+03  3.14521512e+03  3.14521512e+03
  3.14521512e+03  6.76014497e+03  6.76014497e+03  6.76014497e+03
  8.98962920e+03  2.53520285e+04  7.61014369e+04]
E1 = -728.3648997647146  E_coul = 201.92853917421982
cycle= 2 E= -526.436360590495  delta_E= -0.000375  |g|= 0.0241  |ddm|= 0.0205
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0468574
diis-c [-0.0014357   0.04705651  0.95294349]
  HOMO = -0.568634291356352  LUMO = 1.16245695202702
  mo_energy =
[-1.18537834e+02 -1.21790391e+01 -9.53056991e+00 -9.53056991e+00
 -9.53056991e+00 -1.24625764e+00 -5.68634291e-01 -5.68634291e-01
 -5.68634291e-01  1.16245695e+00  1.16245695e+00  1.16245695e+00
  9.88957515e+00  9.88957515e+00  9.88957515e+00  4.94140184e+01
  4.94140184e+01  4.94140184e+01  7.94245087e+01  1.85390092e+02
  1.85390092e+02  1.85390092e+02  5.57562587e+02  5.82878540e+02
  5.82878540e+02  5.82878540e+02  1.44878296e+03  1.44878296e+03
  1.44878296e+03  2.59049447e+03  3.14526126e+03  3.14526126e+03
  3.14526126e+03  6.76019212e+03  6.76019212e+03  6.76019212e+03
  8.98967676e+03  2.53520762e+04  7.61014846e+04]
E1 = -728.3058053051341  E_coul = 201.86943223945622
cycle= 3 E= -526.436373065678  delta_E= -1.25e-05  |g|= 0.00291  |ddm|= 0.00511
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00629239
diis-c [-3.51635200e-07 -1.04625556e-03  1.11774605e-01  8.89271650e-01]
  HOMO = -0.569274863768882  LUMO = 1.16190373256002
  mo_energy =
[-1.18542978e+02 -1.21818141e+01 -9.53344619e+00 -9.53344619e+00
 -9.53344619e+00 -1.24709117e+00 -5.69274864e-01 -5.69274864e-01
 -5.69274864e-01  1.16190373e+00  1.16190373e+00  1.16190373e+00
  9.88754355e+00  9.88754355e+00  9.88754355e+00  4.94106650e+01
  4.94106650e+01  4.94106650e+01  7.94203394e+01  1.85385668e+02
  1.85385668e+02  1.85385668e+02  5.57557278e+02  5.82873452e+02
  5.82873452e+02  5.82873452e+02  1.44877753e+03  1.44877753e+03
  1.44877753e+03  2.59048864e+03  3.14525559e+03  3.14525559e+03
  3.14525559e+03  6.76018621e+03  6.76018621e+03  6.76018621e+03
  8.98967071e+03  2.53520700e+04  7.61014784e+04]
E1 = -728.3138163027396  E_coul = 201.87744296304382
cycle= 4 E= -526.436373339696  delta_E= -2.74e-07  |g|= 4.31e-05  |ddm|= 0.000754
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.76701e-05
diis-c [-1.66662122e-09  7.99311094e-06 -1.71912344e-03 -6.75624452e-03
  1.00846737e+00]
  HOMO = -0.569247550593712  LUMO = 1.16192656317456
  mo_energy =
[-1.18542882e+02 -1.21817259e+01 -9.53335887e+00 -9.53335887e+00
 -9.53335887e+00 -1.24705573e+00 -5.69247551e-01 -5.69247551e-01
 -5.69247551e-01  1.16192656e+00  1.16192656e+00  1.16192656e+00
  9.88761368e+00  9.88761368e+00  9.88761368e+00  4.94107537e+01
  4.94107537e+01  4.94107537e+01  7.94204380e+01  1.85385764e+02
  1.85385764e+02  1.85385764e+02  5.57557372e+02  5.82873548e+02
  5.82873548e+02  5.82873548e+02  1.44877762e+03  1.44877762e+03
  1.44877762e+03  2.59048872e+03  3.14525568e+03  3.14525568e+03
  3.14525568e+03  6.76018629e+03  6.76018629e+03  6.76018629e+03
  8.98967079e+03  2.53520701e+04  7.61014785e+04]
E1 = -728.3136113386288  E_coul = 201.8772379987929
cycle= 5 E= -526.436373339836  delta_E= -1.4e-10  |g|= 7.05e-06  |ddm|= 2.38e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3136113386288  E_coul = 201.8772379987929
  HOMO = -0.569251182952767  LUMO = 1.16192350989185
  mo_energy =
[-1.18542899e+02 -1.21817387e+01 -9.53337184e+00 -9.53337184e+00
 -9.53337184e+00 -1.24706045e+00 -5.69251183e-01 -5.69251183e-01
 -5.69251183e-01  1.16192351e+00  1.16192351e+00  1.16192351e+00
  9.88760374e+00  9.88760374e+00  9.88760374e+00  4.94107398e+01
  4.94107398e+01  4.94107398e+01  7.94204222e+01  1.85385748e+02
  1.85385748e+02  1.85385748e+02  5.57557354e+02  5.82873531e+02
  5.82873531e+02  5.82873531e+02  1.44877760e+03  1.44877760e+03
  1.44877760e+03  2.59048870e+03  3.14525566e+03  3.14525566e+03
  3.14525566e+03  6.76018627e+03  6.76018627e+03  6.76018627e+03
  8.98967077e+03  2.53520701e+04  7.61014784e+04]
E1 = -728.3136440657722  E_coul = 201.8772707259344
Extra cycle  E= -526.436373339838  delta_E= -1.93e-12  |g|= 1.77e-06  |ddm|= 3.55e-06
    CPU time for scf_cycle      0.70 sec, wall time      0.30 sec
exp = [2.61825394e+04 7.61784925e+03 3.61738648e+03 1.60554846e+03
 3.58981971e+02 1.11743664e+02 3.64390385e+01 4.58267297e+00
 3.94976926e-01 1.36276510e+03 6.64820865e+02 3.01344768e+02
 3.14403943e+02 8.33689957e+01 1.00244894e+01 2.94230675e+01
 8.52254030e-01 3.55919290e+00 2.39385629e-01]
E = -526.4363733398378
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:43:46 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5394316        1
[INPUT] 0    0    [1    /1   ]  7617.84924736        1
[INPUT] 0    0    [1    /1   ]  3617.38647686        1
[INPUT] 0    0    [1    /1   ]  1605.54845764        1
[INPUT] 0    0    [1    /1   ]  358.981971313        1
[INPUT] 0    0    [1    /1   ]  111.743663939        1
[INPUT] 0    0    [1    /1   ]  36.4390385448        1
[INPUT] 0    0    [1    /1   ]  4.58267297258        1
[INPUT] 0    0    [1    /1   ]  0.394976926483       1
[INPUT] 1    0    [1    /1   ]  1362.76510022        1
[INPUT] 1    0    [1    /1   ]  664.820865366        1
[INPUT] 1    0    [1    /1   ]  301.344768429        1
[INPUT] 1    0    [1    /1   ]  314.40394339         1
[INPUT] 1    0    [1    /1   ]  83.3689957013        1
[INPUT] 1    0    [1    /1   ]  10.0244894045        1
[INPUT] 1    0    [1    /1   ]  29.4230674964        1
[INPUT] 1    0    [1    /1   ]  0.852254029731       1
[INPUT] 1    0    [1    /1   ]  3.55919290395        1
[INPUT] 1    0    [1    /1   ]  0.239385628901       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.53943163435, 1.0]], [0, [7617.84924735962, 1.0]], [0, [3617.3864768576072, 1.0]], [0, [1605.5484576389274, 1.0]], [0, [358.9819713131558, 1.0]], [0, [111.74366393878351, 1.0]], [0, [36.439038544765474, 1.0]], [0, [4.58267297258126, 1.0]], [0, [0.3949769264831932, 1.0]], [1, [1362.765100215463, 1.0]], [1, [664.820865365789, 1.0]], [1, [301.34476842887653, 1.0]], [1, [314.40394338994827, 1.0]], [1, [83.36899570130375, 1.0]], [1, [10.024489404504491, 1.0]], [1, [29.42306749636177, 1.0]], [1, [0.8522540297310545, 1.0]], [1, [3.55919290394719, 1.0]], [1, [0.23938562890137638, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.53943163]
bas 1, expnt(s) = [7617.84924736]
bas 2, expnt(s) = [3617.38647686]
bas 3, expnt(s) = [1605.54845764]
bas 4, expnt(s) = [358.98197131]
bas 5, expnt(s) = [111.74366394]
bas 6, expnt(s) = [36.43903854]
bas 7, expnt(s) = [4.58267297]
bas 8, expnt(s) = [0.39497693]
bas 9, expnt(s) = [1362.76510022]
bas 10, expnt(s) = [664.82086537]
bas 11, expnt(s) = [301.34476843]
bas 12, expnt(s) = [314.40394339]
bas 13, expnt(s) = [83.3689957]
bas 14, expnt(s) = [10.0244894]
bas 15, expnt(s) = [29.4230675]
bas 16, expnt(s) = [0.85225403]
bas 17, expnt(s) = [3.5591929]
bas 18, expnt(s) = [0.23938563]
CPU time:       569.94
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825394e+04 5.20024552e+03 7.61784925e+03 2.06010476e+03
 3.61738648e+03 1.17845013e+03 1.60554846e+03 6.40814880e+02
 3.58981971e+02 2.08362473e+02 1.11743664e+02 8.68324799e+01
 3.64390385e+01 3.74705620e+01 4.58267297e+00 7.91323702e+00
 3.94976926e-01 1.25876257e+00 1.36276510e+03 2.41552005e+04
 6.64820865e+02 9.84838899e+03 3.01344768e+02 3.66280639e+03
 3.14403943e+02 3.86228550e+03 8.33689957e+01 7.34920065e+02
 1.00244894e+01 5.20369962e+01 2.94230675e+01 1.99914515e+02
 8.52254030e-01 2.38888763e+00 3.55919290e+00 1.42617822e+01
 2.39385629e-01 4.88491472e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.973262047635966
cond(S) = 154382.717992945
E1 = -728.7759190002381  E_coul = 203.11370362881655
init E= -525.662215371422
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558778787327953  LUMO = 1.16898535216195
  mo_energy =
[-1.18306811e+02 -1.21031729e+01 -9.44817347e+00 -9.44817347e+00
 -9.44817347e+00 -1.23041339e+00 -5.58778787e-01 -5.58778787e-01
 -5.58778787e-01  1.16898535e+00  1.16898535e+00  1.16898535e+00
  9.94366813e+00  9.94366813e+00  9.94366813e+00  4.95244007e+01
  4.95244007e+01  4.95244007e+01  7.95575112e+01  1.85558705e+02
  1.85558705e+02  1.85558705e+02  5.57824207e+02  5.83106357e+02
  5.83106357e+02  5.83106357e+02  1.44906303e+03  1.44906303e+03
  1.44906303e+03  2.59090635e+03  3.14560465e+03  3.14560465e+03
  3.14560465e+03  6.76065018e+03  6.76065018e+03  6.76065018e+03
  8.99021227e+03  2.53527071e+04  7.61022070e+04]
E1 = -728.0744943658577  E_coul = 201.63850922519242
cycle= 1 E= -526.435985140665  delta_E= -0.774  |g|= 0.188  |ddm|= 0.569
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.559539
diis-c [-0.31308344  1.        ]
  HOMO = -0.572189265296835  LUMO = 1.1592653114929
  mo_energy =
[-1.18579993e+02 -1.21989223e+01 -9.55083427e+00 -9.55083427e+00
 -9.55083427e+00 -1.25097729e+00 -5.72189265e-01 -5.72189265e-01
 -5.72189265e-01  1.15926531e+00  1.15926531e+00  1.15926531e+00
  9.87626960e+00  9.87626960e+00  9.87626960e+00  4.93890732e+01
  4.93890732e+01  4.93890732e+01  7.93904900e+01  1.85354745e+02
  1.85354745e+02  1.85354745e+02  5.57519081e+02  5.82836848e+02
  5.82836848e+02  5.82836848e+02  1.44873842e+03  1.44873842e+03
  1.44873842e+03  2.59044765e+03  3.14521512e+03  3.14521512e+03
  3.14521512e+03  6.76014497e+03  6.76014497e+03  6.76014497e+03
  8.98962920e+03  2.53520285e+04  7.61014369e+04]
E1 = -728.3648997647146  E_coul = 201.92853917421982
cycle= 2 E= -526.436360590495  delta_E= -0.000375  |g|= 0.0241  |ddm|= 0.0205
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0468574
diis-c [-0.0014357   0.04705651  0.95294349]
  HOMO = -0.568634291356352  LUMO = 1.16245695202702
  mo_energy =
[-1.18537834e+02 -1.21790391e+01 -9.53056991e+00 -9.53056991e+00
 -9.53056991e+00 -1.24625764e+00 -5.68634291e-01 -5.68634291e-01
 -5.68634291e-01  1.16245695e+00  1.16245695e+00  1.16245695e+00
  9.88957515e+00  9.88957515e+00  9.88957515e+00  4.94140184e+01
  4.94140184e+01  4.94140184e+01  7.94245087e+01  1.85390092e+02
  1.85390092e+02  1.85390092e+02  5.57562587e+02  5.82878540e+02
  5.82878540e+02  5.82878540e+02  1.44878296e+03  1.44878296e+03
  1.44878296e+03  2.59049447e+03  3.14526126e+03  3.14526126e+03
  3.14526126e+03  6.76019212e+03  6.76019212e+03  6.76019212e+03
  8.98967676e+03  2.53520762e+04  7.61014846e+04]
E1 = -728.3058053051341  E_coul = 201.86943223945622
cycle= 3 E= -526.436373065678  delta_E= -1.25e-05  |g|= 0.00291  |ddm|= 0.00511
    CPU time for cycle= 3      0.03 sec, wall time      0.04 sec
diis-norm(errvec)=0.00629239
diis-c [-3.51635200e-07 -1.04625556e-03  1.11774605e-01  8.89271650e-01]
  HOMO = -0.569274863768882  LUMO = 1.16190373256002
  mo_energy =
[-1.18542978e+02 -1.21818141e+01 -9.53344619e+00 -9.53344619e+00
 -9.53344619e+00 -1.24709117e+00 -5.69274864e-01 -5.69274864e-01
 -5.69274864e-01  1.16190373e+00  1.16190373e+00  1.16190373e+00
  9.88754355e+00  9.88754355e+00  9.88754355e+00  4.94106650e+01
  4.94106650e+01  4.94106650e+01  7.94203394e+01  1.85385668e+02
  1.85385668e+02  1.85385668e+02  5.57557278e+02  5.82873452e+02
  5.82873452e+02  5.82873452e+02  1.44877753e+03  1.44877753e+03
  1.44877753e+03  2.59048864e+03  3.14525559e+03  3.14525559e+03
  3.14525559e+03  6.76018621e+03  6.76018621e+03  6.76018621e+03
  8.98967071e+03  2.53520700e+04  7.61014784e+04]
E1 = -728.3138163027396  E_coul = 201.87744296304382
cycle= 4 E= -526.436373339696  delta_E= -2.74e-07  |g|= 4.31e-05  |ddm|= 0.000754
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.76701e-05
diis-c [-1.66662122e-09  7.99311094e-06 -1.71912344e-03 -6.75624452e-03
  1.00846737e+00]
  HOMO = -0.569247550593712  LUMO = 1.16192656317456
  mo_energy =
[-1.18542882e+02 -1.21817259e+01 -9.53335887e+00 -9.53335887e+00
 -9.53335887e+00 -1.24705573e+00 -5.69247551e-01 -5.69247551e-01
 -5.69247551e-01  1.16192656e+00  1.16192656e+00  1.16192656e+00
  9.88761368e+00  9.88761368e+00  9.88761368e+00  4.94107537e+01
  4.94107537e+01  4.94107537e+01  7.94204380e+01  1.85385764e+02
  1.85385764e+02  1.85385764e+02  5.57557372e+02  5.82873548e+02
  5.82873548e+02  5.82873548e+02  1.44877762e+03  1.44877762e+03
  1.44877762e+03  2.59048872e+03  3.14525568e+03  3.14525568e+03
  3.14525568e+03  6.76018629e+03  6.76018629e+03  6.76018629e+03
  8.98967079e+03  2.53520701e+04  7.61014785e+04]
E1 = -728.3136113386288  E_coul = 201.8772379987929
cycle= 5 E= -526.436373339836  delta_E= -1.4e-10  |g|= 7.05e-06  |ddm|= 2.38e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3136113386288  E_coul = 201.8772379987929
  HOMO = -0.569251182952767  LUMO = 1.16192350989185
  mo_energy =
[-1.18542899e+02 -1.21817387e+01 -9.53337184e+00 -9.53337184e+00
 -9.53337184e+00 -1.24706045e+00 -5.69251183e-01 -5.69251183e-01
 -5.69251183e-01  1.16192351e+00  1.16192351e+00  1.16192351e+00
  9.88760374e+00  9.88760374e+00  9.88760374e+00  4.94107398e+01
  4.94107398e+01  4.94107398e+01  7.94204222e+01  1.85385748e+02
  1.85385748e+02  1.85385748e+02  5.57557354e+02  5.82873531e+02
  5.82873531e+02  5.82873531e+02  1.44877760e+03  1.44877760e+03
  1.44877760e+03  2.59048870e+03  3.14525566e+03  3.14525566e+03
  3.14525566e+03  6.76018627e+03  6.76018627e+03  6.76018627e+03
  8.98967077e+03  2.53520701e+04  7.61014784e+04]
E1 = -728.3136440657722  E_coul = 201.8772707259344
Extra cycle  E= -526.436373339838  delta_E= -1.93e-12  |g|= 1.77e-06  |ddm|= 3.55e-06
    CPU time for scf_cycle      0.67 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 154382.717992945
E1 = -728.3136440657722  E_coul = 201.8772707259344
init E= -526.436373339838
    CPU time for initialize scf      2.77 sec, wall time      0.26 sec
  HOMO = -0.56925057114918  LUMO = 1.16192403218185
  mo_energy =
[-1.18542896e+02 -1.21817363e+01 -9.53336937e+00 -9.53336937e+00
 -9.53336937e+00 -1.24705965e+00 -5.69250571e-01 -5.69250571e-01
 -5.69250571e-01  1.16192403e+00  1.16192403e+00  1.16192403e+00
  9.88760555e+00  9.88760555e+00  9.88760555e+00  4.94107426e+01
  4.94107426e+01  4.94107426e+01  7.94204256e+01  1.85385751e+02
  1.85385751e+02  1.85385751e+02  5.57557358e+02  5.82873535e+02
  5.82873535e+02  5.82873535e+02  1.44877761e+03  1.44877761e+03
  1.44877761e+03  2.59048871e+03  3.14525566e+03  3.14525566e+03
  3.14525566e+03  6.76018627e+03  6.76018627e+03  6.76018627e+03
  8.98967078e+03  2.53520701e+04  7.61014784e+04]
E1 = -728.3136375126403  E_coul = 201.87726417280237
cycle= 1 E= -526.436373339838  delta_E= -1.14e-13  |g|= 3.87e-07  |ddm|= 6.53e-07
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
E1 = -728.3136375126403  E_coul = 201.87726417280237
  HOMO = -0.569250686194201  LUMO = 1.16192393332836
  mo_energy =
[-1.18542896e+02 -1.21817367e+01 -9.53336986e+00 -9.53336986e+00
 -9.53336986e+00 -1.24705980e+00 -5.69250686e-01 -5.69250686e-01
 -5.69250686e-01  1.16192393e+00  1.16192393e+00  1.16192393e+00
  9.88760519e+00  9.88760519e+00  9.88760519e+00  4.94107420e+01
  4.94107420e+01  4.94107420e+01  7.94204249e+01  1.85385750e+02
  1.85385750e+02  1.85385750e+02  5.57557357e+02  5.82873534e+02
  5.82873534e+02  5.82873534e+02  1.44877761e+03  1.44877761e+03
  1.44877761e+03  2.59048871e+03  3.14525566e+03  3.14525566e+03
  3.14525566e+03  6.76018627e+03  6.76018627e+03  6.76018627e+03
  8.98967078e+03  2.53520701e+04  7.61014784e+04]
E1 = -728.3136388458819  E_coul = 201.8772655060432
Extra cycle  E= -526.436373339839  delta_E= -7.96e-13  |g|= 8.15e-08  |ddm|= 1.29e-07
    CPU time for scf_cycle      2.92 sec, wall time      0.41 sec
exp = [2.61825394e+04 7.61784925e+03 3.61738648e+03 1.60554846e+03
 3.58981971e+02 1.11743664e+02 3.64390385e+01 4.58267297e+00
 3.94976926e-01 1.36276510e+03 6.64820865e+02 3.01344768e+02
 3.14403943e+02 8.33689957e+01 1.00244894e+01 2.94230675e+01
 8.52254030e-01 3.55919290e+00 2.39385629e-01]
grad_E = [-1.72680886e-06  6.48550097e-06  2.62549323e-06  1.77314164e-04
 -1.76288238e-03  5.29968339e-03 -4.13983474e-03 -3.32292022e-03
  1.74115170e-03 -6.95496325e-07  1.53116089e-06  6.31612760e-06
  5.14757374e-06 -3.75966706e-04 -8.47388011e-03  4.81314294e-03
  2.10886354e-03  9.00668955e-03 -1.97793392e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:43:51 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5399515        1
[INPUT] 0    0    [1    /1   ]  7617.84354833        1
[INPUT] 0    0    [1    /1   ]  3617.3749374         1
[INPUT] 0    0    [1    /1   ]  1605.36929519        1
[INPUT] 0    0    [1    /1   ]  360.866626034        1
[INPUT] 0    0    [1    /1   ]  111.430028084        1
[INPUT] 0    0    [1    /1   ]  36.2725939268        1
[INPUT] 0    0    [1    /1   ]  4.58004405145        1
[INPUT] 0    0    [1    /1   ]  0.395952610913       1
[INPUT] 1    0    [1    /1   ]  1362.76483966        1
[INPUT] 1    0    [1    /1   ]  664.816787968        1
[INPUT] 1    0    [1    /1   ]  301.322733575        1
[INPUT] 1    0    [1    /1   ]  314.384485754        1
[INPUT] 1    0    [1    /1   ]  83.5366845067        1
[INPUT] 1    0    [1    /1   ]  10.28029972          1
[INPUT] 1    0    [1    /1   ]  30.2670787642        1
[INPUT] 1    0    [1    /1   ]  0.843741214711       1
[INPUT] 1    0    [1    /1   ]  3.61371715461        1
[INPUT] 1    0    [1    /1   ]  0.238222706804       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.539951467606, 1.0]], [0, [7617.843548328728, 1.0]], [0, [3617.374937399999, 1.0]], [0, [1605.369295189555, 1.0]], [0, [360.86662603355416, 1.0]], [0, [111.4300280835948, 1.0]], [0, [36.27259392679184, 1.0]], [0, [4.580044051452113, 1.0]], [0, [0.3959526109127369, 1.0]], [1, [1362.764839661025, 1.0]], [1, [664.8167879676262, 1.0]], [1, [301.3227335746845, 1.0]], [1, [314.3844857542056, 1.0]], [1, [83.53668450674581, 1.0]], [1, [10.280299719996965, 1.0]], [1, [30.267078764193275, 1.0]], [1, [0.8437412147111685, 1.0]], [1, [3.6137171546146054, 1.0]], [1, [0.23822270680380533, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.53995147]
bas 1, expnt(s) = [7617.84354833]
bas 2, expnt(s) = [3617.3749374]
bas 3, expnt(s) = [1605.36929519]
bas 4, expnt(s) = [360.86662603]
bas 5, expnt(s) = [111.43002808]
bas 6, expnt(s) = [36.27259393]
bas 7, expnt(s) = [4.58004405]
bas 8, expnt(s) = [0.39595261]
bas 9, expnt(s) = [1362.76483966]
bas 10, expnt(s) = [664.81678797]
bas 11, expnt(s) = [301.32273357]
bas 12, expnt(s) = [314.38448575]
bas 13, expnt(s) = [83.53668451]
bas 14, expnt(s) = [10.28029972]
bas 15, expnt(s) = [30.26707876]
bas 16, expnt(s) = [0.84374121]
bas 17, expnt(s) = [3.61371715]
bas 18, expnt(s) = [0.23822271]
CPU time:       578.30
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825400e+04 5.20024560e+03 7.61784355e+03 2.06010360e+03
 3.61737494e+03 1.17844731e+03 1.60536930e+03 6.40761248e+02
 3.60866626e+02 2.09182362e+02 1.11430028e+02 8.66496283e+01
 3.62725939e+01 3.73421212e+01 4.58004405e+00 7.90983211e+00
 3.95952611e-01 1.26109392e+00 1.36276484e+03 2.41551947e+04
 6.64816788e+02 9.84831349e+03 3.01322734e+02 3.66247160e+03
 3.14384486e+02 3.86198671e+03 8.35366845e+01 7.36768307e+02
 1.02802997e+01 5.37021426e+01 3.02670788e+01 2.07108311e+02
 8.43741215e-01 2.35909795e+00 3.61371715e+00 1.45354034e+01
 2.38222707e-01 4.85526945e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.973379881736413
cond(S) = 156704.07696794329
E1 = -728.7865307841482  E_coul = 203.12180163722874
init E= -525.66472914692
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558330687656556  LUMO = 1.15702629493545
  mo_energy =
[-1.18308444e+02 -1.21026649e+01 -9.44729977e+00 -9.44729977e+00
 -9.44729977e+00 -1.23000178e+00 -5.58330688e-01 -5.58330688e-01
 -5.58330688e-01  1.15702629e+00  1.15702629e+00  1.15702629e+00
  1.01050509e+01  1.01050509e+01  1.01050509e+01  5.09270580e+01
  5.09270580e+01  5.09270580e+01  7.90994668e+01  1.88944261e+02
  1.88944261e+02  1.88944261e+02  5.57785761e+02  5.87315797e+02
  5.87315797e+02  5.87315797e+02  1.45328468e+03  1.45328468e+03
  1.45328468e+03  2.59418622e+03  3.14964108e+03  3.14964108e+03
  3.14964108e+03  6.76435910e+03  6.76435910e+03  6.76435910e+03
  8.99476359e+03  2.53573071e+04  7.61065383e+04]
E1 = -728.0744689793141  E_coul = 201.63690532850367
cycle= 1 E= -526.43756365081  delta_E= -0.773  |g|= 0.188  |ddm|= 0.647
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.560111
diis-c [-0.31372424  1.        ]
  HOMO = -0.571605908339935  LUMO = 1.14755112477696
  mo_energy =
[-1.18583263e+02 -1.21991952e+01 -9.55090697e+00 -9.55090697e+00
 -9.55090697e+00 -1.25056051e+00 -5.71605908e-01 -5.71605908e-01
 -5.71605908e-01  1.14755112e+00  1.14755112e+00  1.14755112e+00
  1.00362023e+01  1.00362023e+01  1.00362023e+01  5.07889531e+01
  5.07889531e+01  5.07889531e+01  7.89314837e+01  1.88738578e+02
  1.88738578e+02  1.88738578e+02  5.57478596e+02  5.87044750e+02
  5.87044750e+02  5.87044750e+02  1.45295837e+03  1.45295837e+03
  1.45295837e+03  2.59372530e+03  3.14924961e+03  3.14924961e+03
  3.14924961e+03  6.76385189e+03  6.76385189e+03  6.76385189e+03
  8.99417849e+03  2.53566265e+04  7.61057662e+04]
E1 = -728.3663815657969  E_coul = 201.92843779159233
cycle= 2 E= -526.437943774205  delta_E= -0.00038  |g|= 0.0242  |ddm|= 0.0208
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0470652
diis-c [-0.00143957  0.04746924  0.95253076]
  HOMO = -0.568015428140158  LUMO = 1.15074340994417
  mo_energy =
[-1.18540916e+02 -1.21792351e+01 -9.53056317e+00 -9.53056317e+00
 -9.53056317e+00 -1.24579442e+00 -5.68015428e-01 -5.68015428e-01
 -5.68015428e-01  1.15074341e+00  1.15074341e+00  1.15074341e+00
  1.00497786e+01  1.00497786e+01  1.00497786e+01  5.08142813e+01
  5.08142813e+01  5.08142813e+01  7.89656057e+01  1.88774134e+02
  1.88774134e+02  1.88774134e+02  5.57522304e+02  5.87086613e+02
  5.87086613e+02  5.87086613e+02  1.45300310e+03  1.45300310e+03
  1.45300310e+03  2.59377234e+03  3.14929595e+03  3.14929595e+03
  3.14929595e+03  6.76389926e+03  6.76389926e+03  6.76389926e+03
  8.99422627e+03  2.53566744e+04  7.61058142e+04]
E1 = -728.3072390750336  E_coul = 201.86928275096486
cycle= 3 E= -526.437956324069  delta_E= -1.25e-05  |g|= 0.0029  |ddm|= 0.00513
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00627998
diis-c [-3.55489198e-07 -1.05179329e-03  1.11047099e-01  8.90004695e-01]
  HOMO = -0.568654313610178  LUMO = 1.1501968467235
  mo_energy =
[-1.18546046e+02 -1.21820008e+01 -9.53343123e+00 -9.53343123e+00
 -9.53343123e+00 -1.24662669e+00 -5.68654314e-01 -5.68654314e-01
 -5.68654314e-01  1.15019685e+00  1.15019685e+00  1.15019685e+00
  1.00477290e+01  1.00477290e+01  1.00477290e+01  5.08109083e+01
  5.08109083e+01  5.08109083e+01  7.89614545e+01  1.88769717e+02
  1.88769717e+02  1.88769717e+02  5.57517008e+02  5.87081540e+02
  5.87081540e+02  5.87081540e+02  1.45299768e+03  1.45299768e+03
  1.45299768e+03  2.59376652e+03  3.14929030e+03  3.14929030e+03
  3.14929030e+03  6.76389335e+03  6.76389335e+03  6.76389335e+03
  8.99422023e+03  2.53566683e+04  7.61058080e+04]
E1 = -728.3152003446739  E_coul = 201.87724374957332
cycle= 4 E= -526.437956595101  delta_E= -2.71e-07  |g|= 4.26e-05  |ddm|= 0.000754
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.6691e-05
diis-c [-1.67061293e-09  9.90049313e-06 -1.93634082e-03 -8.81870183e-03
  1.01074514e+00]
  HOMO = -0.568627094579873  LUMO = 1.15021939298029
  mo_energy =
[-1.18545951e+02 -1.21819135e+01 -9.53334485e+00 -9.53334485e+00
 -9.53334485e+00 -1.24659140e+00 -5.68627095e-01 -5.68627095e-01
 -5.68627095e-01  1.15021939e+00  1.15021939e+00  1.15021939e+00
  1.00477991e+01  1.00477991e+01  1.00477991e+01  5.08109962e+01
  5.08109962e+01  5.08109962e+01  7.89615521e+01  1.88769812e+02
  1.88769812e+02  1.88769812e+02  5.57517100e+02  5.87081635e+02
  5.87081635e+02  5.87081635e+02  1.45299778e+03  1.45299778e+03
  1.45299778e+03  2.59376660e+03  3.14929039e+03  3.14929039e+03
  3.14929039e+03  6.76389344e+03  6.76389344e+03  6.76389344e+03
  8.99422031e+03  2.53566684e+04  7.61058080e+04]
E1 = -728.3149990038966  E_coul = 201.87704240866148
cycle= 5 E= -526.437956595235  delta_E= -1.34e-10  |g|= 7.04e-06  |ddm|= 2.35e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3149990038966  E_coul = 201.87704240866148
  HOMO = -0.568630751902034  LUMO = 1.15021634782985
  mo_energy =
[-1.18545969e+02 -1.21819263e+01 -9.53335786e+00 -9.53335786e+00
 -9.53335786e+00 -1.24659615e+00 -5.68630752e-01 -5.68630752e-01
 -5.68630752e-01  1.15021635e+00  1.15021635e+00  1.15021635e+00
  1.00477890e+01  1.00477890e+01  1.00477890e+01  5.08109823e+01
  5.08109823e+01  5.08109823e+01  7.89615363e+01  1.88769795e+02
  1.88769795e+02  1.88769795e+02  5.57517082e+02  5.87081618e+02
  5.87081618e+02  5.87081618e+02  1.45299776e+03  1.45299776e+03
  1.45299776e+03  2.59376659e+03  3.14929037e+03  3.14929037e+03
  3.14929037e+03  6.76389342e+03  6.76389342e+03  6.76389342e+03
  8.99422029e+03  2.53566683e+04  7.61058080e+04]
E1 = -728.3150316871211  E_coul = 201.87707509188402
Extra cycle  E= -526.437956595237  delta_E= -1.93e-12  |g|= 1.77e-06  |ddm|= 3.57e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.23 sec
exp = [2.61825400e+04 7.61784355e+03 3.61737494e+03 1.60536930e+03
 3.60866626e+02 1.11430028e+02 3.62725939e+01 4.58004405e+00
 3.95952611e-01 1.36276484e+03 6.64816788e+02 3.01322734e+02
 3.14384486e+02 8.35366845e+01 1.02802997e+01 3.02670788e+01
 8.43741215e-01 3.61371715e+00 2.38222707e-01]
E = -526.437956595237
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:43:51 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5399515        1
[INPUT] 0    0    [1    /1   ]  7617.84354833        1
[INPUT] 0    0    [1    /1   ]  3617.3749374         1
[INPUT] 0    0    [1    /1   ]  1605.36929519        1
[INPUT] 0    0    [1    /1   ]  360.866626034        1
[INPUT] 0    0    [1    /1   ]  111.430028084        1
[INPUT] 0    0    [1    /1   ]  36.2725939268        1
[INPUT] 0    0    [1    /1   ]  4.58004405145        1
[INPUT] 0    0    [1    /1   ]  0.395952610913       1
[INPUT] 1    0    [1    /1   ]  1362.76483966        1
[INPUT] 1    0    [1    /1   ]  664.816787968        1
[INPUT] 1    0    [1    /1   ]  301.322733575        1
[INPUT] 1    0    [1    /1   ]  314.384485754        1
[INPUT] 1    0    [1    /1   ]  83.5366845067        1
[INPUT] 1    0    [1    /1   ]  10.28029972          1
[INPUT] 1    0    [1    /1   ]  30.2670787642        1
[INPUT] 1    0    [1    /1   ]  0.843741214711       1
[INPUT] 1    0    [1    /1   ]  3.61371715461        1
[INPUT] 1    0    [1    /1   ]  0.238222706804       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.539951467606, 1.0]], [0, [7617.843548328728, 1.0]], [0, [3617.374937399999, 1.0]], [0, [1605.369295189555, 1.0]], [0, [360.86662603355416, 1.0]], [0, [111.4300280835948, 1.0]], [0, [36.27259392679184, 1.0]], [0, [4.580044051452113, 1.0]], [0, [0.3959526109127369, 1.0]], [1, [1362.764839661025, 1.0]], [1, [664.8167879676262, 1.0]], [1, [301.3227335746845, 1.0]], [1, [314.3844857542056, 1.0]], [1, [83.53668450674581, 1.0]], [1, [10.280299719996965, 1.0]], [1, [30.267078764193275, 1.0]], [1, [0.8437412147111685, 1.0]], [1, [3.6137171546146054, 1.0]], [1, [0.23822270680380533, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.53995147]
bas 1, expnt(s) = [7617.84354833]
bas 2, expnt(s) = [3617.3749374]
bas 3, expnt(s) = [1605.36929519]
bas 4, expnt(s) = [360.86662603]
bas 5, expnt(s) = [111.43002808]
bas 6, expnt(s) = [36.27259393]
bas 7, expnt(s) = [4.58004405]
bas 8, expnt(s) = [0.39595261]
bas 9, expnt(s) = [1362.76483966]
bas 10, expnt(s) = [664.81678797]
bas 11, expnt(s) = [301.32273357]
bas 12, expnt(s) = [314.38448575]
bas 13, expnt(s) = [83.53668451]
bas 14, expnt(s) = [10.28029972]
bas 15, expnt(s) = [30.26707876]
bas 16, expnt(s) = [0.84374121]
bas 17, expnt(s) = [3.61371715]
bas 18, expnt(s) = [0.23822271]
CPU time:       579.11
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825400e+04 5.20024560e+03 7.61784355e+03 2.06010360e+03
 3.61737494e+03 1.17844731e+03 1.60536930e+03 6.40761248e+02
 3.60866626e+02 2.09182362e+02 1.11430028e+02 8.66496283e+01
 3.62725939e+01 3.73421212e+01 4.58004405e+00 7.90983211e+00
 3.95952611e-01 1.26109392e+00 1.36276484e+03 2.41551947e+04
 6.64816788e+02 9.84831349e+03 3.01322734e+02 3.66247160e+03
 3.14384486e+02 3.86198671e+03 8.35366845e+01 7.36768307e+02
 1.02802997e+01 5.37021426e+01 3.02670788e+01 2.07108311e+02
 8.43741215e-01 2.35909795e+00 3.61371715e+00 1.45354034e+01
 2.38222707e-01 4.85526945e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.973379881736413
cond(S) = 156704.07696794329
E1 = -728.7865307841482  E_coul = 203.12180163722874
init E= -525.66472914692
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558330687656556  LUMO = 1.15702629493545
  mo_energy =
[-1.18308444e+02 -1.21026649e+01 -9.44729977e+00 -9.44729977e+00
 -9.44729977e+00 -1.23000178e+00 -5.58330688e-01 -5.58330688e-01
 -5.58330688e-01  1.15702629e+00  1.15702629e+00  1.15702629e+00
  1.01050509e+01  1.01050509e+01  1.01050509e+01  5.09270580e+01
  5.09270580e+01  5.09270580e+01  7.90994668e+01  1.88944261e+02
  1.88944261e+02  1.88944261e+02  5.57785761e+02  5.87315797e+02
  5.87315797e+02  5.87315797e+02  1.45328468e+03  1.45328468e+03
  1.45328468e+03  2.59418622e+03  3.14964108e+03  3.14964108e+03
  3.14964108e+03  6.76435910e+03  6.76435910e+03  6.76435910e+03
  8.99476359e+03  2.53573071e+04  7.61065383e+04]
E1 = -728.0744689793141  E_coul = 201.63690532850367
cycle= 1 E= -526.43756365081  delta_E= -0.773  |g|= 0.188  |ddm|= 0.647
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.560111
diis-c [-0.31372424  1.        ]
  HOMO = -0.571605908339935  LUMO = 1.14755112477696
  mo_energy =
[-1.18583263e+02 -1.21991952e+01 -9.55090697e+00 -9.55090697e+00
 -9.55090697e+00 -1.25056051e+00 -5.71605908e-01 -5.71605908e-01
 -5.71605908e-01  1.14755112e+00  1.14755112e+00  1.14755112e+00
  1.00362023e+01  1.00362023e+01  1.00362023e+01  5.07889531e+01
  5.07889531e+01  5.07889531e+01  7.89314837e+01  1.88738578e+02
  1.88738578e+02  1.88738578e+02  5.57478596e+02  5.87044750e+02
  5.87044750e+02  5.87044750e+02  1.45295837e+03  1.45295837e+03
  1.45295837e+03  2.59372530e+03  3.14924961e+03  3.14924961e+03
  3.14924961e+03  6.76385189e+03  6.76385189e+03  6.76385189e+03
  8.99417849e+03  2.53566265e+04  7.61057662e+04]
E1 = -728.3663815657969  E_coul = 201.92843779159233
cycle= 2 E= -526.437943774205  delta_E= -0.00038  |g|= 0.0242  |ddm|= 0.0208
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0470652
diis-c [-0.00143957  0.04746924  0.95253076]
  HOMO = -0.568015428140158  LUMO = 1.15074340994417
  mo_energy =
[-1.18540916e+02 -1.21792351e+01 -9.53056317e+00 -9.53056317e+00
 -9.53056317e+00 -1.24579442e+00 -5.68015428e-01 -5.68015428e-01
 -5.68015428e-01  1.15074341e+00  1.15074341e+00  1.15074341e+00
  1.00497786e+01  1.00497786e+01  1.00497786e+01  5.08142813e+01
  5.08142813e+01  5.08142813e+01  7.89656057e+01  1.88774134e+02
  1.88774134e+02  1.88774134e+02  5.57522304e+02  5.87086613e+02
  5.87086613e+02  5.87086613e+02  1.45300310e+03  1.45300310e+03
  1.45300310e+03  2.59377234e+03  3.14929595e+03  3.14929595e+03
  3.14929595e+03  6.76389926e+03  6.76389926e+03  6.76389926e+03
  8.99422627e+03  2.53566744e+04  7.61058142e+04]
E1 = -728.3072390750336  E_coul = 201.86928275096486
cycle= 3 E= -526.437956324069  delta_E= -1.25e-05  |g|= 0.0029  |ddm|= 0.00513
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00627998
diis-c [-3.55489198e-07 -1.05179329e-03  1.11047099e-01  8.90004695e-01]
  HOMO = -0.568654313610178  LUMO = 1.1501968467235
  mo_energy =
[-1.18546046e+02 -1.21820008e+01 -9.53343123e+00 -9.53343123e+00
 -9.53343123e+00 -1.24662669e+00 -5.68654314e-01 -5.68654314e-01
 -5.68654314e-01  1.15019685e+00  1.15019685e+00  1.15019685e+00
  1.00477290e+01  1.00477290e+01  1.00477290e+01  5.08109083e+01
  5.08109083e+01  5.08109083e+01  7.89614545e+01  1.88769717e+02
  1.88769717e+02  1.88769717e+02  5.57517008e+02  5.87081540e+02
  5.87081540e+02  5.87081540e+02  1.45299768e+03  1.45299768e+03
  1.45299768e+03  2.59376652e+03  3.14929030e+03  3.14929030e+03
  3.14929030e+03  6.76389335e+03  6.76389335e+03  6.76389335e+03
  8.99422023e+03  2.53566683e+04  7.61058080e+04]
E1 = -728.3152003446739  E_coul = 201.87724374957332
cycle= 4 E= -526.437956595101  delta_E= -2.71e-07  |g|= 4.26e-05  |ddm|= 0.000754
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.6691e-05
diis-c [-1.67061293e-09  9.90049313e-06 -1.93634082e-03 -8.81870183e-03
  1.01074514e+00]
  HOMO = -0.568627094579873  LUMO = 1.15021939298029
  mo_energy =
[-1.18545951e+02 -1.21819135e+01 -9.53334485e+00 -9.53334485e+00
 -9.53334485e+00 -1.24659140e+00 -5.68627095e-01 -5.68627095e-01
 -5.68627095e-01  1.15021939e+00  1.15021939e+00  1.15021939e+00
  1.00477991e+01  1.00477991e+01  1.00477991e+01  5.08109962e+01
  5.08109962e+01  5.08109962e+01  7.89615521e+01  1.88769812e+02
  1.88769812e+02  1.88769812e+02  5.57517100e+02  5.87081635e+02
  5.87081635e+02  5.87081635e+02  1.45299778e+03  1.45299778e+03
  1.45299778e+03  2.59376660e+03  3.14929039e+03  3.14929039e+03
  3.14929039e+03  6.76389344e+03  6.76389344e+03  6.76389344e+03
  8.99422031e+03  2.53566684e+04  7.61058080e+04]
E1 = -728.3149990038966  E_coul = 201.87704240866148
cycle= 5 E= -526.437956595235  delta_E= -1.34e-10  |g|= 7.04e-06  |ddm|= 2.35e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3149990038966  E_coul = 201.87704240866148
  HOMO = -0.568630751902034  LUMO = 1.15021634782985
  mo_energy =
[-1.18545969e+02 -1.21819263e+01 -9.53335786e+00 -9.53335786e+00
 -9.53335786e+00 -1.24659615e+00 -5.68630752e-01 -5.68630752e-01
 -5.68630752e-01  1.15021635e+00  1.15021635e+00  1.15021635e+00
  1.00477890e+01  1.00477890e+01  1.00477890e+01  5.08109823e+01
  5.08109823e+01  5.08109823e+01  7.89615363e+01  1.88769795e+02
  1.88769795e+02  1.88769795e+02  5.57517082e+02  5.87081618e+02
  5.87081618e+02  5.87081618e+02  1.45299776e+03  1.45299776e+03
  1.45299776e+03  2.59376659e+03  3.14929037e+03  3.14929037e+03
  3.14929037e+03  6.76389342e+03  6.76389342e+03  6.76389342e+03
  8.99422029e+03  2.53566683e+04  7.61058080e+04]
E1 = -728.3150316871211  E_coul = 201.87707509188402
Extra cycle  E= -526.437956595237  delta_E= -1.93e-12  |g|= 1.77e-06  |ddm|= 3.57e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156704.07696794329
E1 = -728.3150316871211  E_coul = 201.87707509188402
init E= -526.437956595237
    CPU time for initialize scf      2.74 sec, wall time      0.25 sec
  HOMO = -0.568630139447135  LUMO = 1.15021686578297
  mo_energy =
[-1.18545965e+02 -1.21819239e+01 -9.53335540e+00 -9.53335540e+00
 -9.53335540e+00 -1.24659535e+00 -5.68630139e-01 -5.68630139e-01
 -5.68630139e-01  1.15021687e+00  1.15021687e+00  1.15021687e+00
  1.00477908e+01  1.00477908e+01  1.00477908e+01  5.08109851e+01
  5.08109851e+01  5.08109851e+01  7.89615397e+01  1.88769799e+02
  1.88769799e+02  1.88769799e+02  5.57517086e+02  5.87081621e+02
  5.87081621e+02  5.87081621e+02  1.45299776e+03  1.45299776e+03
  1.45299776e+03  2.59376659e+03  3.14929037e+03  3.14929037e+03
  3.14929037e+03  6.76389342e+03  6.76389342e+03  6.76389342e+03
  8.99422030e+03  2.53566684e+04  7.61058080e+04]
E1 = -728.315025173026  E_coul = 201.87706857778818
cycle= 1 E= -526.437956595238  delta_E= -9.09e-13  |g|= 3.85e-07  |ddm|= 6.52e-07
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
E1 = -728.315025173026  E_coul = 201.87706857778818
  HOMO = -0.568630253958334  LUMO = 1.15021676830631
  mo_energy =
[-1.18545966e+02 -1.21819243e+01 -9.53335589e+00 -9.53335589e+00
 -9.53335589e+00 -1.24659550e+00 -5.68630254e-01 -5.68630254e-01
 -5.68630254e-01  1.15021677e+00  1.15021677e+00  1.15021677e+00
  1.00477905e+01  1.00477905e+01  1.00477905e+01  5.08109845e+01
  5.08109845e+01  5.08109845e+01  7.89615390e+01  1.88769798e+02
  1.88769798e+02  1.88769798e+02  5.57517086e+02  5.87081621e+02
  5.87081621e+02  5.87081621e+02  1.45299776e+03  1.45299776e+03
  1.45299776e+03  2.59376659e+03  3.14929037e+03  3.14929037e+03
  3.14929037e+03  6.76389342e+03  6.76389342e+03  6.76389342e+03
  8.99422029e+03  2.53566684e+04  7.61058080e+04]
E1 = -728.3150264929133  E_coul = 201.8770698976749
Extra cycle  E= -526.437956595238  delta_E= -4.55e-13  |g|= 8.07e-08  |ddm|= 1.29e-07
    CPU time for scf_cycle      2.88 sec, wall time      0.39 sec
exp = [2.61825400e+04 7.61784355e+03 3.61737494e+03 1.60536930e+03
 3.60866626e+02 1.11430028e+02 3.62725939e+01 4.58004405e+00
 3.95952611e-01 1.36276484e+03 6.64816788e+02 3.01322734e+02
 3.14384486e+02 8.35366845e+01 1.02802997e+01 3.02670788e+01
 8.43741215e-01 3.61371715e+00 2.38222707e-01]
grad_E = [-1.71313928e-06  6.21968783e-06  2.17144519e-06  1.68264138e-04
 -1.63405525e-03  5.05648421e-03 -4.13762349e-03 -5.75395281e-03
  1.66089476e-02 -6.98531946e-07  2.01017818e-06  8.74677691e-06
  7.21390674e-06 -4.46781386e-04 -7.41192372e-03  4.93861864e-03
 -2.12152706e-02  7.83603434e-03  1.26417709e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:43:56 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5406185        1
[INPUT] 0    0    [1    /1   ]  7617.83695741        1
[INPUT] 0    0    [1    /1   ]  3617.36224314        1
[INPUT] 0    0    [1    /1   ]  1605.16328771        1
[INPUT] 0    0    [1    /1   ]  363.16090798         1
[INPUT] 0    0    [1    /1   ]  110.221081355        1
[INPUT] 0    0    [1    /1   ]  35.8382666575        1
[INPUT] 0    0    [1    /1   ]  4.57741260105        1
[INPUT] 0    0    [1    /1   ]  0.397423429416       1
[INPUT] 1    0    [1    /1   ]  1362.76462657        1
[INPUT] 1    0    [1    /1   ]  664.812703057        1
[INPUT] 1    0    [1    /1   ]  301.300897056        1
[INPUT] 1    0    [1    /1   ]  314.365185211        1
[INPUT] 1    0    [1    /1   ]  83.5802853141        1
[INPUT] 1    0    [1    /1   ]  10.6368094895        1
[INPUT] 1    0    [1    /1   ]  31.4469618032        1
[INPUT] 1    0    [1    /1   ]  0.837388698131       1
[INPUT] 1    0    [1    /1   ]  3.68818985114        1
[INPUT] 1    0    [1    /1   ]  0.237680329443       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.540618543186, 1.0]], [0, [7617.836957413966, 1.0]], [0, [3617.3622431402596, 1.0]], [0, [1605.1632877113482, 1.0]], [0, [363.1609079797726, 1.0]], [0, [110.22108135527444, 1.0]], [0, [35.838266657544935, 1.0]], [0, [4.577412601051513, 1.0]], [0, [0.3974234294162935, 1.0]], [1, [1362.7646265735866, 1.0]], [1, [664.8127030571754, 1.0]], [1, [301.3008970564377, 1.0]], [1, [314.3651852106332, 1.0]], [1, [83.58028531408905, 1.0]], [1, [10.636809489502964, 1.0]], [1, [31.446961803213636, 1.0]], [1, [0.8373886981307196, 1.0]], [1, [3.6881898511402658, 1.0]], [1, [0.23768032944284745, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.54061854]
bas 1, expnt(s) = [7617.83695741]
bas 2, expnt(s) = [3617.36224314]
bas 3, expnt(s) = [1605.16328771]
bas 4, expnt(s) = [363.16090798]
bas 5, expnt(s) = [110.22108136]
bas 6, expnt(s) = [35.83826666]
bas 7, expnt(s) = [4.5774126]
bas 8, expnt(s) = [0.39742343]
bas 9, expnt(s) = [1362.76462657]
bas 10, expnt(s) = [664.81270306]
bas 11, expnt(s) = [301.30089706]
bas 12, expnt(s) = [314.36518521]
bas 13, expnt(s) = [83.58028531]
bas 14, expnt(s) = [10.63680949]
bas 15, expnt(s) = [31.4469618]
bas 16, expnt(s) = [0.8373887]
bas 17, expnt(s) = [3.68818985]
bas 18, expnt(s) = [0.23768033]
CPU time:       587.32
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825406e+04 5.20024570e+03 7.61783696e+03 2.06010226e+03
 3.61736224e+03 1.17844421e+03 1.60516329e+03 6.40699578e+02
 3.63160908e+02 2.10179011e+02 1.10221081e+02 8.59435967e+01
 3.58382667e+01 3.70062665e+01 4.57741260e+00 7.90642344e+00
 3.97423429e-01 1.26460567e+00 1.36276463e+03 2.41551900e+04
 6.64812703e+02 9.84823785e+03 3.01300897e+02 3.66213984e+03
 3.14365185e+02 3.86169035e+03 8.35802853e+01 7.37249020e+02
 1.06368095e+01 5.60400635e+01 3.14469618e+01 2.17248986e+02
 8.37388698e-01 2.33691686e+00 3.68818985e+00 1.49108011e+01
 2.37680329e-01 4.84145549e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.973252362275645
cond(S) = 159657.06553001195
E1 = -728.8128411511764  E_coul = 203.1368467852816
init E= -525.675994365895
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.557631378389937  LUMO = 1.1497891141977
  mo_energy =
[-1.18310962e+02 -1.21017731e+01 -9.44569477e+00 -9.44569477e+00
 -9.44569477e+00 -1.22940968e+00 -5.57631378e-01 -5.57631378e-01
 -5.57631378e-01  1.14978911e+00  1.14978911e+00  1.14978911e+00
  1.03569573e+01  1.03569573e+01  1.03569573e+01  5.28934092e+01
  5.28934092e+01  5.28934092e+01  7.77602438e+01  1.93481122e+02
  1.93481122e+02  1.93481122e+02  5.54818364e+02  5.92741319e+02
  5.92741319e+02  5.92741319e+02  1.45861104e+03  1.45861104e+03
  1.45861104e+03  2.59435449e+03  3.15469272e+03  3.15469272e+03
  3.15469272e+03  6.76899021e+03  6.76899021e+03  6.76899021e+03
  8.99656120e+03  2.53593259e+04  7.61084656e+04]
E1 = -728.0858981292915  E_coul = 201.64507084608542
cycle= 1 E= -526.440827283206  delta_E= -0.765  |g|= 0.188  |ddm|= 0.741
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.559817
diis-c [-0.31339504  1.        ]
  HOMO = -0.570595510498841  LUMO = 1.14065173870306
  mo_energy =
[-1.18587182e+02 -1.21989733e+01 -9.55011684e+00 -9.55011684e+00
 -9.55011684e+00 -1.24981613e+00 -5.70595510e-01 -5.70595510e-01
 -5.70595510e-01  1.14065174e+00  1.14065174e+00  1.14065174e+00
  1.02864054e+01  1.02864054e+01  1.02864054e+01  5.27521401e+01
  5.27521401e+01  5.27521401e+01  7.75920717e+01  1.93273816e+02
  1.93273816e+02  1.93273816e+02  5.54509482e+02  5.92468975e+02
  5.92468975e+02  5.92468975e+02  1.45828324e+03  1.45828324e+03
  1.45828324e+03  2.59389127e+03  3.15429933e+03  3.15429933e+03
  3.15429933e+03  6.76848104e+03  6.76848104e+03  6.76848104e+03
  8.99597404e+03  2.53586433e+04  7.61076917e+04]
E1 = -728.3781721171504  E_coul = 201.93696122425442
cycle= 2 E= -526.441210892896  delta_E= -0.000384  |g|= 0.0243  |ddm|= 0.0212
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0472261
diis-c [-0.00143949  0.04793557  0.95206443]
  HOMO = -0.566992479734964  LUMO = 1.14383755159928
  mo_energy =
[-1.18544759e+02 -1.21790227e+01 -9.52977989e+00 -9.52977989e+00
 -9.52977989e+00 -1.24503047e+00 -5.66992480e-01 -5.66992480e-01
 -5.66992480e-01  1.14383755e+00  1.14383755e+00  1.14383755e+00
  1.03002646e+01  1.03002646e+01  1.03002646e+01  5.27778484e+01
  5.27778484e+01  5.27778484e+01  7.76260927e+01  1.93309485e+02
  1.93309485e+02  1.93309485e+02  5.54553269e+02  5.92510891e+02
  5.92510891e+02  5.92510891e+02  1.45832804e+03  1.45832804e+03
  1.45832804e+03  2.59393841e+03  3.15434577e+03  3.15434577e+03
  3.15434577e+03  6.76852851e+03  6.76852851e+03  6.76852851e+03
  8.99602193e+03  2.53586914e+04  7.61077398e+04]
E1 = -728.3192594918196  E_coul = 201.87803605083187
cycle= 3 E= -526.441223440988  delta_E= -1.25e-05  |g|= 0.00288  |ddm|= 0.00513
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00625309
diis-c [-3.60590473e-07 -1.05954163e-03  1.10168743e-01  8.90890799e-01]
  HOMO = -0.567625308004682  LUMO = 1.14329919741429
  mo_energy =
[-1.18549855e+02 -1.21817637e+01 -9.53262466e+00 -9.53262466e+00
 -9.53262466e+00 -1.24585630e+00 -5.67625308e-01 -5.67625308e-01
 -5.67625308e-01  1.14329920e+00  1.14329920e+00  1.14329920e+00
  1.02981998e+01  1.02981998e+01  1.02981998e+01  5.27744632e+01
  5.27744632e+01  5.27744632e+01  7.76219890e+01  1.93305094e+02
  1.93305094e+02  1.93305094e+02  5.54548008e+02  5.92505855e+02
  5.92505855e+02  5.92505855e+02  1.45832266e+03  1.45832266e+03
  1.45832266e+03  2.59393262e+03  3.15434014e+03  3.15434014e+03
  3.15434014e+03  6.76852264e+03  6.76852264e+03  6.76852264e+03
  8.99601593e+03  2.53586852e+04  7.61077336e+04]
E1 = -728.3271219390017  E_coul = 201.8858982326648
cycle= 4 E= -526.441223706337  delta_E= -2.65e-07  |g|= 4.19e-05  |ddm|= 0.000749
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.52099e-05
diis-c [-1.66476967e-09  1.23862081e-05 -2.21091689e-03 -1.15107385e-02
  1.01370927e+00]
  HOMO = -0.567598368419852  LUMO = 1.14332138657368
  mo_energy =
[-1.18549762e+02 -1.21816777e+01 -9.53253979e+00 -9.53253979e+00
 -9.53253979e+00 -1.24582136e+00 -5.67598368e-01 -5.67598368e-01
 -5.67598368e-01  1.14332139e+00  1.14332139e+00  1.14332139e+00
  1.02982695e+01  1.02982695e+01  1.02982695e+01  5.27745500e+01
  5.27745500e+01  5.27745500e+01  7.76220849e+01  1.93305187e+02
  1.93305187e+02  1.93305187e+02  5.54548098e+02  5.92505947e+02
  5.92505947e+02  5.92505947e+02  1.45832275e+03  1.45832275e+03
  1.45832275e+03  2.59393271e+03  3.15434023e+03  3.15434023e+03
  3.15434023e+03  6.76852272e+03  6.76852272e+03  6.76852272e+03
  8.99601600e+03  2.53586853e+04  7.61077337e+04]
E1 = -728.3269260758962  E_coul = 201.88570236943266
cycle= 5 E= -526.441223706463  delta_E= -1.27e-10  |g|= 7.03e-06  |ddm|= 2.29e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3269260758962  E_coul = 201.88570236943266
  HOMO = -0.567602044515552  LUMO = 1.14331834390947
  mo_energy =
[-1.18549779e+02 -1.21816905e+01 -9.53255284e+00 -9.53255284e+00
 -9.53255284e+00 -1.24582614e+00 -5.67602045e-01 -5.67602045e-01
 -5.67602045e-01  1.14331834e+00  1.14331834e+00  1.14331834e+00
  1.02982593e+01  1.02982593e+01  1.02982593e+01  5.27745359e+01
  5.27745359e+01  5.27745359e+01  7.76220692e+01  1.93305171e+02
  1.93305171e+02  1.93305171e+02  5.54548080e+02  5.92505930e+02
  5.92505930e+02  5.92505930e+02  1.45832273e+03  1.45832273e+03
  1.45832273e+03  2.59393269e+03  3.15434021e+03  3.15434021e+03
  3.15434021e+03  6.76852270e+03  6.76852270e+03  6.76852270e+03
  8.99601598e+03  2.53586853e+04  7.61077337e+04]
E1 = -728.326958597265  E_coul = 201.88573489079795
Extra cycle  E= -526.441223706467  delta_E= -3.64e-12  |g|= 1.76e-06  |ddm|= 3.57e-06
    CPU time for scf_cycle      0.66 sec, wall time      0.27 sec
exp = [2.61825406e+04 7.61783696e+03 3.61736224e+03 1.60516329e+03
 3.63160908e+02 1.10221081e+02 3.58382667e+01 4.57741260e+00
 3.97423429e-01 1.36276463e+03 6.64812703e+02 3.01300897e+02
 3.14365185e+02 8.35802853e+01 1.06368095e+01 3.14469618e+01
 8.37388698e-01 3.68818985e+00 2.37680329e-01]
E = -526.4412237064671
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:43:56 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5406185        1
[INPUT] 0    0    [1    /1   ]  7617.83695741        1
[INPUT] 0    0    [1    /1   ]  3617.36224314        1
[INPUT] 0    0    [1    /1   ]  1605.16328771        1
[INPUT] 0    0    [1    /1   ]  363.16090798         1
[INPUT] 0    0    [1    /1   ]  110.221081355        1
[INPUT] 0    0    [1    /1   ]  35.8382666575        1
[INPUT] 0    0    [1    /1   ]  4.57741260105        1
[INPUT] 0    0    [1    /1   ]  0.397423429416       1
[INPUT] 1    0    [1    /1   ]  1362.76462657        1
[INPUT] 1    0    [1    /1   ]  664.812703057        1
[INPUT] 1    0    [1    /1   ]  301.300897056        1
[INPUT] 1    0    [1    /1   ]  314.365185211        1
[INPUT] 1    0    [1    /1   ]  83.5802853141        1
[INPUT] 1    0    [1    /1   ]  10.6368094895        1
[INPUT] 1    0    [1    /1   ]  31.4469618032        1
[INPUT] 1    0    [1    /1   ]  0.837388698131       1
[INPUT] 1    0    [1    /1   ]  3.68818985114        1
[INPUT] 1    0    [1    /1   ]  0.237680329443       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.540618543186, 1.0]], [0, [7617.836957413966, 1.0]], [0, [3617.3622431402596, 1.0]], [0, [1605.1632877113482, 1.0]], [0, [363.1609079797726, 1.0]], [0, [110.22108135527444, 1.0]], [0, [35.838266657544935, 1.0]], [0, [4.577412601051513, 1.0]], [0, [0.3974234294162935, 1.0]], [1, [1362.7646265735866, 1.0]], [1, [664.8127030571754, 1.0]], [1, [301.3008970564377, 1.0]], [1, [314.3651852106332, 1.0]], [1, [83.58028531408905, 1.0]], [1, [10.636809489502964, 1.0]], [1, [31.446961803213636, 1.0]], [1, [0.8373886981307196, 1.0]], [1, [3.6881898511402658, 1.0]], [1, [0.23768032944284745, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.54061854]
bas 1, expnt(s) = [7617.83695741]
bas 2, expnt(s) = [3617.36224314]
bas 3, expnt(s) = [1605.16328771]
bas 4, expnt(s) = [363.16090798]
bas 5, expnt(s) = [110.22108136]
bas 6, expnt(s) = [35.83826666]
bas 7, expnt(s) = [4.5774126]
bas 8, expnt(s) = [0.39742343]
bas 9, expnt(s) = [1362.76462657]
bas 10, expnt(s) = [664.81270306]
bas 11, expnt(s) = [301.30089706]
bas 12, expnt(s) = [314.36518521]
bas 13, expnt(s) = [83.58028531]
bas 14, expnt(s) = [10.63680949]
bas 15, expnt(s) = [31.4469618]
bas 16, expnt(s) = [0.8373887]
bas 17, expnt(s) = [3.68818985]
bas 18, expnt(s) = [0.23768033]
CPU time:       588.21
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825406e+04 5.20024570e+03 7.61783696e+03 2.06010226e+03
 3.61736224e+03 1.17844421e+03 1.60516329e+03 6.40699578e+02
 3.63160908e+02 2.10179011e+02 1.10221081e+02 8.59435967e+01
 3.58382667e+01 3.70062665e+01 4.57741260e+00 7.90642344e+00
 3.97423429e-01 1.26460567e+00 1.36276463e+03 2.41551900e+04
 6.64812703e+02 9.84823785e+03 3.01300897e+02 3.66213984e+03
 3.14365185e+02 3.86169035e+03 8.35802853e+01 7.37249020e+02
 1.06368095e+01 5.60400635e+01 3.14469618e+01 2.17248986e+02
 8.37388698e-01 2.33691686e+00 3.68818985e+00 1.49108011e+01
 2.37680329e-01 4.84145549e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.973252362275645
cond(S) = 159657.06553001195
E1 = -728.8128411511764  E_coul = 203.1368467852816
init E= -525.675994365895
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.557631378389937  LUMO = 1.1497891141977
  mo_energy =
[-1.18310962e+02 -1.21017731e+01 -9.44569477e+00 -9.44569477e+00
 -9.44569477e+00 -1.22940968e+00 -5.57631378e-01 -5.57631378e-01
 -5.57631378e-01  1.14978911e+00  1.14978911e+00  1.14978911e+00
  1.03569573e+01  1.03569573e+01  1.03569573e+01  5.28934092e+01
  5.28934092e+01  5.28934092e+01  7.77602438e+01  1.93481122e+02
  1.93481122e+02  1.93481122e+02  5.54818364e+02  5.92741319e+02
  5.92741319e+02  5.92741319e+02  1.45861104e+03  1.45861104e+03
  1.45861104e+03  2.59435449e+03  3.15469272e+03  3.15469272e+03
  3.15469272e+03  6.76899021e+03  6.76899021e+03  6.76899021e+03
  8.99656120e+03  2.53593259e+04  7.61084656e+04]
E1 = -728.0858981292915  E_coul = 201.64507084608542
cycle= 1 E= -526.440827283206  delta_E= -0.765  |g|= 0.188  |ddm|= 0.741
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.559817
diis-c [-0.31339504  1.        ]
  HOMO = -0.570595510498841  LUMO = 1.14065173870306
  mo_energy =
[-1.18587182e+02 -1.21989733e+01 -9.55011684e+00 -9.55011684e+00
 -9.55011684e+00 -1.24981613e+00 -5.70595510e-01 -5.70595510e-01
 -5.70595510e-01  1.14065174e+00  1.14065174e+00  1.14065174e+00
  1.02864054e+01  1.02864054e+01  1.02864054e+01  5.27521401e+01
  5.27521401e+01  5.27521401e+01  7.75920717e+01  1.93273816e+02
  1.93273816e+02  1.93273816e+02  5.54509482e+02  5.92468975e+02
  5.92468975e+02  5.92468975e+02  1.45828324e+03  1.45828324e+03
  1.45828324e+03  2.59389127e+03  3.15429933e+03  3.15429933e+03
  3.15429933e+03  6.76848104e+03  6.76848104e+03  6.76848104e+03
  8.99597404e+03  2.53586433e+04  7.61076917e+04]
E1 = -728.3781721171504  E_coul = 201.93696122425442
cycle= 2 E= -526.441210892896  delta_E= -0.000384  |g|= 0.0243  |ddm|= 0.0212
    CPU time for cycle= 2      0.03 sec, wall time      0.04 sec
diis-norm(errvec)=0.0472261
diis-c [-0.00143949  0.04793557  0.95206443]
  HOMO = -0.566992479734964  LUMO = 1.14383755159928
  mo_energy =
[-1.18544759e+02 -1.21790227e+01 -9.52977989e+00 -9.52977989e+00
 -9.52977989e+00 -1.24503047e+00 -5.66992480e-01 -5.66992480e-01
 -5.66992480e-01  1.14383755e+00  1.14383755e+00  1.14383755e+00
  1.03002646e+01  1.03002646e+01  1.03002646e+01  5.27778484e+01
  5.27778484e+01  5.27778484e+01  7.76260927e+01  1.93309485e+02
  1.93309485e+02  1.93309485e+02  5.54553269e+02  5.92510891e+02
  5.92510891e+02  5.92510891e+02  1.45832804e+03  1.45832804e+03
  1.45832804e+03  2.59393841e+03  3.15434577e+03  3.15434577e+03
  3.15434577e+03  6.76852851e+03  6.76852851e+03  6.76852851e+03
  8.99602193e+03  2.53586914e+04  7.61077398e+04]
E1 = -728.3192594918196  E_coul = 201.87803605083187
cycle= 3 E= -526.441223440988  delta_E= -1.25e-05  |g|= 0.00288  |ddm|= 0.00513
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00625309
diis-c [-3.60590473e-07 -1.05954163e-03  1.10168743e-01  8.90890799e-01]
  HOMO = -0.567625308004682  LUMO = 1.14329919741429
  mo_energy =
[-1.18549855e+02 -1.21817637e+01 -9.53262466e+00 -9.53262466e+00
 -9.53262466e+00 -1.24585630e+00 -5.67625308e-01 -5.67625308e-01
 -5.67625308e-01  1.14329920e+00  1.14329920e+00  1.14329920e+00
  1.02981998e+01  1.02981998e+01  1.02981998e+01  5.27744632e+01
  5.27744632e+01  5.27744632e+01  7.76219890e+01  1.93305094e+02
  1.93305094e+02  1.93305094e+02  5.54548008e+02  5.92505855e+02
  5.92505855e+02  5.92505855e+02  1.45832266e+03  1.45832266e+03
  1.45832266e+03  2.59393262e+03  3.15434014e+03  3.15434014e+03
  3.15434014e+03  6.76852264e+03  6.76852264e+03  6.76852264e+03
  8.99601593e+03  2.53586852e+04  7.61077336e+04]
E1 = -728.3271219390017  E_coul = 201.8858982326648
cycle= 4 E= -526.441223706337  delta_E= -2.65e-07  |g|= 4.19e-05  |ddm|= 0.000749
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.52099e-05
diis-c [-1.66476967e-09  1.23862081e-05 -2.21091689e-03 -1.15107385e-02
  1.01370927e+00]
  HOMO = -0.567598368419852  LUMO = 1.14332138657368
  mo_energy =
[-1.18549762e+02 -1.21816777e+01 -9.53253979e+00 -9.53253979e+00
 -9.53253979e+00 -1.24582136e+00 -5.67598368e-01 -5.67598368e-01
 -5.67598368e-01  1.14332139e+00  1.14332139e+00  1.14332139e+00
  1.02982695e+01  1.02982695e+01  1.02982695e+01  5.27745500e+01
  5.27745500e+01  5.27745500e+01  7.76220849e+01  1.93305187e+02
  1.93305187e+02  1.93305187e+02  5.54548098e+02  5.92505947e+02
  5.92505947e+02  5.92505947e+02  1.45832275e+03  1.45832275e+03
  1.45832275e+03  2.59393271e+03  3.15434023e+03  3.15434023e+03
  3.15434023e+03  6.76852272e+03  6.76852272e+03  6.76852272e+03
  8.99601600e+03  2.53586853e+04  7.61077337e+04]
E1 = -728.3269260758962  E_coul = 201.88570236943266
cycle= 5 E= -526.441223706463  delta_E= -1.27e-10  |g|= 7.03e-06  |ddm|= 2.29e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3269260758962  E_coul = 201.88570236943266
  HOMO = -0.567602044515552  LUMO = 1.14331834390947
  mo_energy =
[-1.18549779e+02 -1.21816905e+01 -9.53255284e+00 -9.53255284e+00
 -9.53255284e+00 -1.24582614e+00 -5.67602045e-01 -5.67602045e-01
 -5.67602045e-01  1.14331834e+00  1.14331834e+00  1.14331834e+00
  1.02982593e+01  1.02982593e+01  1.02982593e+01  5.27745359e+01
  5.27745359e+01  5.27745359e+01  7.76220692e+01  1.93305171e+02
  1.93305171e+02  1.93305171e+02  5.54548080e+02  5.92505930e+02
  5.92505930e+02  5.92505930e+02  1.45832273e+03  1.45832273e+03
  1.45832273e+03  2.59393269e+03  3.15434021e+03  3.15434021e+03
  3.15434021e+03  6.76852270e+03  6.76852270e+03  6.76852270e+03
  8.99601598e+03  2.53586853e+04  7.61077337e+04]
E1 = -728.326958597265  E_coul = 201.88573489079795
Extra cycle  E= -526.441223706467  delta_E= -3.64e-12  |g|= 1.76e-06  |ddm|= 3.57e-06
    CPU time for scf_cycle      0.67 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 159657.06553001195
E1 = -728.326958597265  E_coul = 201.88573489079795
init E= -526.441223706467
    CPU time for initialize scf      2.73 sec, wall time      0.26 sec
  HOMO = -0.567601434269823  LUMO = 1.14331885705089
  mo_energy =
[-1.18549775e+02 -1.21816881e+01 -9.53255039e+00 -9.53255039e+00
 -9.53255039e+00 -1.24582534e+00 -5.67601434e-01 -5.67601434e-01
 -5.67601434e-01  1.14331886e+00  1.14331886e+00  1.14331886e+00
  1.02982611e+01  1.02982611e+01  1.02982611e+01  5.27745387e+01
  5.27745387e+01  5.27745387e+01  7.76220725e+01  1.93305174e+02
  1.93305174e+02  1.93305174e+02  5.54548084e+02  5.92505934e+02
  5.92505934e+02  5.92505934e+02  1.45832273e+03  1.45832273e+03
  1.45832273e+03  2.59393269e+03  3.15434022e+03  3.15434022e+03
  3.15434022e+03  6.76852271e+03  6.76852271e+03  6.76852271e+03
  8.99601599e+03  2.53586853e+04  7.61077337e+04]
E1 = -728.3269521545841  E_coul = 201.88572844811802
cycle= 1 E= -526.441223706466  delta_E= 1.02e-12  |g|= 3.82e-07  |ddm|= 6.49e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3269521545841  E_coul = 201.88572844811802
  HOMO = -0.567601547527332  LUMO = 1.14331876117807
  mo_energy =
[-1.18549776e+02 -1.21816886e+01 -9.53255087e+00 -9.53255087e+00
 -9.53255087e+00 -1.24582549e+00 -5.67601548e-01 -5.67601548e-01
 -5.67601548e-01  1.14331876e+00  1.14331876e+00  1.14331876e+00
  1.02982608e+01  1.02982608e+01  1.02982608e+01  5.27745382e+01
  5.27745382e+01  5.27745382e+01  7.76220718e+01  1.93305174e+02
  1.93305174e+02  1.93305174e+02  5.54548083e+02  5.92505933e+02
  5.92505933e+02  5.92505933e+02  1.45832273e+03  1.45832273e+03
  1.45832273e+03  2.59393269e+03  3.15434021e+03  3.15434021e+03
  3.15434021e+03  6.76852270e+03  6.76852270e+03  6.76852270e+03
  8.99601599e+03  2.53586853e+04  7.61077337e+04]
E1 = -728.3269534530059  E_coul = 201.88572974653917
Extra cycle  E= -526.441223706467  delta_E= -6.82e-13  |g|= 7.96e-08  |ddm|= 1.27e-07
    CPU time for scf_cycle      2.88 sec, wall time      0.40 sec
exp = [2.61825406e+04 7.61783696e+03 3.61736224e+03 1.60516329e+03
 3.63160908e+02 1.10221081e+02 3.58382667e+01 4.57741260e+00
 3.97423429e-01 1.36276463e+03 6.64812703e+02 3.01300897e+02
 3.14365185e+02 8.35802853e+01 1.06368095e+01 3.14469618e+01
 8.37388698e-01 3.68818985e+00 2.37680329e-01]
grad_E = [-1.68895601e-06  5.77638058e-06  1.46024711e-06  1.52883957e-04
 -1.38584713e-03  4.42176309e-03 -3.84465065e-03 -7.64015283e-03
  3.93201056e-02 -6.81570932e-07  2.72681859e-06  1.24217067e-05
  1.03769663e-05 -5.11205986e-04 -5.41472087e-03  4.88564250e-03
 -4.70218363e-02  4.99880182e-03  4.92640911e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:44:01 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5414152        1
[INPUT] 0    0    [1    /1   ]  7617.82995644        1
[INPUT] 0    0    [1    /1   ]  3617.34960709        1
[INPUT] 0    0    [1    /1   ]  1604.94610953        1
[INPUT] 0    0    [1    /1   ]  365.743969813        1
[INPUT] 0    0    [1    /1   ]  107.82225202         1
[INPUT] 0    0    [1    /1   ]  35.0605848547        1
[INPUT] 0    0    [1    /1   ]  4.57514484206        1
[INPUT] 0    0    [1    /1   ]  0.398305974093       1
[INPUT] 1    0    [1    /1   ]  1362.76448225        1
[INPUT] 1    0    [1    /1   ]  664.808905108        1
[INPUT] 1    0    [1    /1   ]  301.28076814         1
[INPUT] 1    0    [1    /1   ]  314.3473777          1
[INPUT] 1    0    [1    /1   ]  83.577090684         1
[INPUT] 1    0    [1    /1   ]  10.9685105401        1
[INPUT] 1    0    [1    /1   ]  32.5643203185        1
[INPUT] 1    0    [1    /1   ]  0.840615360709       1
[INPUT] 1    0    [1    /1   ]  3.75710086924        1
[INPUT] 1    0    [1    /1   ]  0.239462761889       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.54141519585, 1.0]], [0, [7617.829956443135, 1.0]], [0, [3617.3496070853494, 1.0]], [0, [1604.9461095260017, 1.0]], [0, [365.7439698125275, 1.0]], [0, [107.82225201978395, 1.0]], [0, [35.06058485465936, 1.0]], [0, [4.5751448420608165, 1.0]], [0, [0.398305974093013, 1.0]], [1, [1362.7644822478562, 1.0]], [1, [664.8089051076929, 1.0]], [1, [301.2807681403134, 1.0]], [1, [314.3473777001229, 1.0]], [1, [83.57709068398538, 1.0]], [1, [10.96851054011291, 1.0]], [1, [32.56432031850209, 1.0]], [1, [0.8406153607088794, 1.0]], [1, [3.757100869235511, 1.0]], [1, [0.2394627618889975, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.5414152]
bas 1, expnt(s) = [7617.82995644]
bas 2, expnt(s) = [3617.34960709]
bas 3, expnt(s) = [1604.94610953]
bas 4, expnt(s) = [365.74396981]
bas 5, expnt(s) = [107.82225202]
bas 6, expnt(s) = [35.06058485]
bas 7, expnt(s) = [4.57514484]
bas 8, expnt(s) = [0.39830597]
bas 9, expnt(s) = [1362.76448225]
bas 10, expnt(s) = [664.80890511]
bas 11, expnt(s) = [301.28076814]
bas 12, expnt(s) = [314.3473777]
bas 13, expnt(s) = [83.57709068]
bas 14, expnt(s) = [10.96851054]
bas 15, expnt(s) = [32.56432032]
bas 16, expnt(s) = [0.84061536]
bas 17, expnt(s) = [3.75710087]
bas 18, expnt(s) = [0.23946276]
CPU time:       596.53
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825414e+04 5.20024582e+03 7.61782996e+03 2.06010084e+03
 3.61734961e+03 1.17844112e+03 1.60494611e+03 6.40634562e+02
 3.65743970e+02 2.11299225e+02 1.07822252e+02 8.45369010e+01
 3.50605849e+01 3.64023475e+01 4.57514484e+00 7.90348548e+00
 3.98305974e-01 1.26671128e+00 1.36276448e+03 2.41551868e+04
 6.64808905e+02 9.84816753e+03 3.01280768e+02 3.66183402e+03
 3.14347378e+02 3.86141692e+03 8.35770907e+01 7.37213796e+02
 1.09685105e+01 5.82329731e+01 3.25643203e+01 2.26940452e+02
 8.40615361e-01 2.34817816e+00 3.75710087e+00 1.52598569e+01
 2.39462762e-01 4.88688227e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97274100470151
cond(S) = 162435.1895836825
E1 = -728.846327350457  E_coul = 203.1474213221367
init E= -525.69890602832
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.557107966723827  LUMO = 1.16064221054857
  mo_energy =
[-1.18314342e+02 -1.21014417e+01 -9.44445891e+00 -9.44445891e+00
 -9.44445891e+00 -1.22903072e+00 -5.57107967e-01 -5.57107967e-01
 -5.57107967e-01  1.16064221e+00  1.16064221e+00  1.16064221e+00
  1.06386546e+01  1.06386546e+01  1.06386546e+01  5.47626898e+01
  5.47626898e+01  5.47626898e+01  7.52803086e+01  1.97697906e+02
  1.97697906e+02  1.97697906e+02  5.47759718e+02  5.97770858e+02
  5.97770858e+02  5.97770858e+02  1.46353421e+03  1.46353421e+03
  1.46353421e+03  2.58974282e+03  3.15935316e+03  3.15935316e+03
  3.15935316e+03  6.77325914e+03  6.77325914e+03  6.77325914e+03
  8.99390201e+03  2.53571211e+04  7.61064535e+04]
E1 = -728.1183299980155  E_coul = 201.67216395049238
cycle= 1 E= -526.446166047523  delta_E= -0.747  |g|= 0.187  |ddm|= 0.792
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.557445
diis-c [-0.31074506  1.        ]
  HOMO = -0.569265222151356  LUMO = 1.15204781166859
  mo_energy =
[-1.18589521e+02 -1.21976293e+01 -9.54790360e+00 -9.54790360e+00
 -9.54790360e+00 -1.24857135e+00 -5.69265222e-01 -5.69265222e-01
 -5.69265222e-01  1.15204781e+00  1.15204781e+00  1.15204781e+00
  1.05678479e+01  1.05678479e+01  1.05678479e+01  5.46204660e+01
  5.46204660e+01  5.46204660e+01  7.51150029e+01  1.97491148e+02
  1.97491148e+02  1.97491148e+02  5.47451818e+02  5.97499603e+02
  5.97499603e+02  5.97499603e+02  1.46320735e+03  1.46320735e+03
  1.46320735e+03  2.58927936e+03  3.15896007e+03  3.15896007e+03
  3.15896007e+03  6.77275019e+03  6.77275019e+03  6.77275019e+03
  8.99331492e+03  2.53564388e+04  7.61056801e+04]
E1 = -728.4063897915281  E_coul = 201.95984411026555
cycle= 2 E= -526.446545681263  delta_E= -0.00038  |g|= 0.0242  |ddm|= 0.0209
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0470203
diis-c [-0.00142178  0.04808042  0.95191958]
  HOMO = -0.565744805451893  LUMO = 1.15519192200199
  mo_energy =
[-1.18547497e+02 -1.21779958e+01 -9.52788536e+00 -9.52788536e+00
 -9.52788536e+00 -1.24389168e+00 -5.65744805e-01 -5.65744805e-01
 -5.65744805e-01  1.15519192e+00  1.15519192e+00  1.15519192e+00
  1.05817180e+01  1.05817180e+01  1.05817180e+01  5.46461583e+01
  5.46461583e+01  5.46461583e+01  7.51483744e+01  1.97526496e+02
  1.97526496e+02  1.97526496e+02  5.47495184e+02  5.97541106e+02
  5.97541106e+02  5.97541106e+02  1.46325174e+03  1.46325174e+03
  1.46325174e+03  2.58932611e+03  3.15900611e+03  3.15900611e+03
  3.15900611e+03  6.77279726e+03  6.77279726e+03  6.77279726e+03
  8.99336242e+03  2.53564865e+04  7.61057278e+04]
E1 = -728.3484779922284  E_coul = 201.90192004719012
cycle= 3 E= -526.446557945038  delta_E= -1.23e-05  |g|= 0.00285  |ddm|= 0.00505
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0061965
diis-c [-3.65340493e-07 -1.07024938e-03  1.09570991e-01  8.91499258e-01]
  HOMO = -0.566362732718509  LUMO = 1.15466169452442
  mo_energy =
[-1.18552518e+02 -1.21806836e+01 -9.53067808e+00 -9.53067808e+00
 -9.53067808e+00 -1.24469878e+00 -5.66362733e-01 -5.66362733e-01
 -5.66362733e-01  1.15466169e+00  1.15466169e+00  1.15466169e+00
  1.05796638e+01  1.05796638e+01  1.05796638e+01  5.46427975e+01
  5.46427975e+01  5.46427975e+01  7.51443671e+01  1.97522169e+02
  1.97522169e+02  1.97522169e+02  5.47490001e+02  5.97536145e+02
  5.97536145e+02  5.97536145e+02  1.46324644e+03  1.46324644e+03
  1.46324644e+03  2.58932040e+03  3.15900056e+03  3.15900056e+03
  3.15900056e+03  6.77279147e+03  6.77279147e+03  6.77279147e+03
  8.99335648e+03  2.53564805e+04  7.61057217e+04]
E1 = -728.3561693589995  E_coul = 201.9096111582745
cycle= 4 E= -526.446558200725  delta_E= -2.56e-07  |g|= 4.13e-05  |ddm|= 0.000735
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.3677e-05
diis-c [-1.65325620e-09  1.43274531e-05 -2.42192030e-03 -1.36701052e-02
  1.01607770e+00]
  HOMO = -0.566336233850907  LUMO = 1.15468368380731
  mo_energy =
[-1.18552427e+02 -1.21805991e+01 -9.53059475e+00 -9.53059475e+00
 -9.53059475e+00 -1.24466439e+00 -5.66336234e-01 -5.66336234e-01
 -5.66336234e-01  1.15468368e+00  1.15468368e+00  1.15468368e+00
  1.05797329e+01  1.05797329e+01  1.05797329e+01  5.46428828e+01
  5.46428828e+01  5.46428828e+01  7.51444613e+01  1.97522260e+02
  1.97522260e+02  1.97522260e+02  5.47490089e+02  5.97536236e+02
  5.97536236e+02  5.97536236e+02  1.46324653e+03  1.46324653e+03
  1.46324653e+03  2.58932048e+03  3.15900065e+03  3.15900065e+03
  3.15900065e+03  6.77279154e+03  6.77279154e+03  6.77279154e+03
  8.99335656e+03  2.53564805e+04  7.61057217e+04]
E1 = -728.3559790466593  E_coul = 201.90942084581351
cycle= 5 E= -526.446558200846  delta_E= -1.21e-10  |g|= 7.04e-06  |ddm|= 2.24e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3559790466593  E_coul = 201.90942084581351
  HOMO = -0.566339904879829  LUMO = 1.15468062189296
  mo_energy =
[-1.18552445e+02 -1.21806119e+01 -9.53060780e+00 -9.53060780e+00
 -9.53060780e+00 -1.24466917e+00 -5.66339905e-01 -5.66339905e-01
 -5.66339905e-01  1.15468062e+00  1.15468062e+00  1.15468062e+00
  1.05797226e+01  1.05797226e+01  1.05797226e+01  5.46428687e+01
  5.46428687e+01  5.46428687e+01  7.51444456e+01  1.97522243e+02
  1.97522243e+02  1.97522243e+02  5.47490071e+02  5.97536219e+02
  5.97536219e+02  5.97536219e+02  1.46324651e+03  1.46324651e+03
  1.46324651e+03  2.58932046e+03  3.15900063e+03  3.15900063e+03
  3.15900063e+03  6.77279153e+03  6.77279153e+03  6.77279153e+03
  8.99335654e+03  2.53564805e+04  7.61057217e+04]
E1 = -728.3560113149013  E_coul = 201.9094531140532
Extra cycle  E= -526.446558200848  delta_E= -2.27e-12  |g|= 1.75e-06  |ddm|= 3.56e-06
    CPU time for scf_cycle      0.67 sec, wall time      0.28 sec
exp = [2.61825414e+04 7.61782996e+03 3.61734961e+03 1.60494611e+03
 3.65743970e+02 1.07822252e+02 3.50605849e+01 4.57514484e+00
 3.98305974e-01 1.36276448e+03 6.64808905e+02 3.01280768e+02
 3.14347378e+02 8.35770907e+01 1.09685105e+01 3.25643203e+01
 8.40615361e-01 3.75710087e+00 2.39462762e-01]
E = -526.446558200848
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:44:01 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5414152        1
[INPUT] 0    0    [1    /1   ]  7617.82995644        1
[INPUT] 0    0    [1    /1   ]  3617.34960709        1
[INPUT] 0    0    [1    /1   ]  1604.94610953        1
[INPUT] 0    0    [1    /1   ]  365.743969813        1
[INPUT] 0    0    [1    /1   ]  107.82225202         1
[INPUT] 0    0    [1    /1   ]  35.0605848547        1
[INPUT] 0    0    [1    /1   ]  4.57514484206        1
[INPUT] 0    0    [1    /1   ]  0.398305974093       1
[INPUT] 1    0    [1    /1   ]  1362.76448225        1
[INPUT] 1    0    [1    /1   ]  664.808905108        1
[INPUT] 1    0    [1    /1   ]  301.28076814         1
[INPUT] 1    0    [1    /1   ]  314.3473777          1
[INPUT] 1    0    [1    /1   ]  83.577090684         1
[INPUT] 1    0    [1    /1   ]  10.9685105401        1
[INPUT] 1    0    [1    /1   ]  32.5643203185        1
[INPUT] 1    0    [1    /1   ]  0.840615360709       1
[INPUT] 1    0    [1    /1   ]  3.75710086924        1
[INPUT] 1    0    [1    /1   ]  0.239462761889       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.54141519585, 1.0]], [0, [7617.829956443135, 1.0]], [0, [3617.3496070853494, 1.0]], [0, [1604.9461095260017, 1.0]], [0, [365.7439698125275, 1.0]], [0, [107.82225201978395, 1.0]], [0, [35.06058485465936, 1.0]], [0, [4.5751448420608165, 1.0]], [0, [0.398305974093013, 1.0]], [1, [1362.7644822478562, 1.0]], [1, [664.8089051076929, 1.0]], [1, [301.2807681403134, 1.0]], [1, [314.3473777001229, 1.0]], [1, [83.57709068398538, 1.0]], [1, [10.96851054011291, 1.0]], [1, [32.56432031850209, 1.0]], [1, [0.8406153607088794, 1.0]], [1, [3.757100869235511, 1.0]], [1, [0.2394627618889975, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.5414152]
bas 1, expnt(s) = [7617.82995644]
bas 2, expnt(s) = [3617.34960709]
bas 3, expnt(s) = [1604.94610953]
bas 4, expnt(s) = [365.74396981]
bas 5, expnt(s) = [107.82225202]
bas 6, expnt(s) = [35.06058485]
bas 7, expnt(s) = [4.57514484]
bas 8, expnt(s) = [0.39830597]
bas 9, expnt(s) = [1362.76448225]
bas 10, expnt(s) = [664.80890511]
bas 11, expnt(s) = [301.28076814]
bas 12, expnt(s) = [314.3473777]
bas 13, expnt(s) = [83.57709068]
bas 14, expnt(s) = [10.96851054]
bas 15, expnt(s) = [32.56432032]
bas 16, expnt(s) = [0.84061536]
bas 17, expnt(s) = [3.75710087]
bas 18, expnt(s) = [0.23946276]
CPU time:       597.43
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825414e+04 5.20024582e+03 7.61782996e+03 2.06010084e+03
 3.61734961e+03 1.17844112e+03 1.60494611e+03 6.40634562e+02
 3.65743970e+02 2.11299225e+02 1.07822252e+02 8.45369010e+01
 3.50605849e+01 3.64023475e+01 4.57514484e+00 7.90348548e+00
 3.98305974e-01 1.26671128e+00 1.36276448e+03 2.41551868e+04
 6.64808905e+02 9.84816753e+03 3.01280768e+02 3.66183402e+03
 3.14347378e+02 3.86141692e+03 8.35770907e+01 7.37213796e+02
 1.09685105e+01 5.82329731e+01 3.25643203e+01 2.26940452e+02
 8.40615361e-01 2.34817816e+00 3.75710087e+00 1.52598569e+01
 2.39462762e-01 4.88688227e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97274100470151
cond(S) = 162435.1895836825
E1 = -728.846327350457  E_coul = 203.1474213221367
init E= -525.69890602832
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.557107966723827  LUMO = 1.16064221054857
  mo_energy =
[-1.18314342e+02 -1.21014417e+01 -9.44445891e+00 -9.44445891e+00
 -9.44445891e+00 -1.22903072e+00 -5.57107967e-01 -5.57107967e-01
 -5.57107967e-01  1.16064221e+00  1.16064221e+00  1.16064221e+00
  1.06386546e+01  1.06386546e+01  1.06386546e+01  5.47626898e+01
  5.47626898e+01  5.47626898e+01  7.52803086e+01  1.97697906e+02
  1.97697906e+02  1.97697906e+02  5.47759718e+02  5.97770858e+02
  5.97770858e+02  5.97770858e+02  1.46353421e+03  1.46353421e+03
  1.46353421e+03  2.58974282e+03  3.15935316e+03  3.15935316e+03
  3.15935316e+03  6.77325914e+03  6.77325914e+03  6.77325914e+03
  8.99390201e+03  2.53571211e+04  7.61064535e+04]
E1 = -728.1183299980155  E_coul = 201.67216395049238
cycle= 1 E= -526.446166047523  delta_E= -0.747  |g|= 0.187  |ddm|= 0.792
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.557445
diis-c [-0.31074506  1.        ]
  HOMO = -0.569265222151356  LUMO = 1.15204781166859
  mo_energy =
[-1.18589521e+02 -1.21976293e+01 -9.54790360e+00 -9.54790360e+00
 -9.54790360e+00 -1.24857135e+00 -5.69265222e-01 -5.69265222e-01
 -5.69265222e-01  1.15204781e+00  1.15204781e+00  1.15204781e+00
  1.05678479e+01  1.05678479e+01  1.05678479e+01  5.46204660e+01
  5.46204660e+01  5.46204660e+01  7.51150029e+01  1.97491148e+02
  1.97491148e+02  1.97491148e+02  5.47451818e+02  5.97499603e+02
  5.97499603e+02  5.97499603e+02  1.46320735e+03  1.46320735e+03
  1.46320735e+03  2.58927936e+03  3.15896007e+03  3.15896007e+03
  3.15896007e+03  6.77275019e+03  6.77275019e+03  6.77275019e+03
  8.99331492e+03  2.53564388e+04  7.61056801e+04]
E1 = -728.4063897915281  E_coul = 201.95984411026555
cycle= 2 E= -526.446545681263  delta_E= -0.00038  |g|= 0.0242  |ddm|= 0.0209
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0470203
diis-c [-0.00142178  0.04808042  0.95191958]
  HOMO = -0.565744805451893  LUMO = 1.15519192200199
  mo_energy =
[-1.18547497e+02 -1.21779958e+01 -9.52788536e+00 -9.52788536e+00
 -9.52788536e+00 -1.24389168e+00 -5.65744805e-01 -5.65744805e-01
 -5.65744805e-01  1.15519192e+00  1.15519192e+00  1.15519192e+00
  1.05817180e+01  1.05817180e+01  1.05817180e+01  5.46461583e+01
  5.46461583e+01  5.46461583e+01  7.51483744e+01  1.97526496e+02
  1.97526496e+02  1.97526496e+02  5.47495184e+02  5.97541106e+02
  5.97541106e+02  5.97541106e+02  1.46325174e+03  1.46325174e+03
  1.46325174e+03  2.58932611e+03  3.15900611e+03  3.15900611e+03
  3.15900611e+03  6.77279726e+03  6.77279726e+03  6.77279726e+03
  8.99336242e+03  2.53564865e+04  7.61057278e+04]
E1 = -728.3484779922284  E_coul = 201.90192004719012
cycle= 3 E= -526.446557945038  delta_E= -1.23e-05  |g|= 0.00285  |ddm|= 0.00505
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0061965
diis-c [-3.65340493e-07 -1.07024938e-03  1.09570991e-01  8.91499258e-01]
  HOMO = -0.566362732718509  LUMO = 1.15466169452442
  mo_energy =
[-1.18552518e+02 -1.21806836e+01 -9.53067808e+00 -9.53067808e+00
 -9.53067808e+00 -1.24469878e+00 -5.66362733e-01 -5.66362733e-01
 -5.66362733e-01  1.15466169e+00  1.15466169e+00  1.15466169e+00
  1.05796638e+01  1.05796638e+01  1.05796638e+01  5.46427975e+01
  5.46427975e+01  5.46427975e+01  7.51443671e+01  1.97522169e+02
  1.97522169e+02  1.97522169e+02  5.47490001e+02  5.97536145e+02
  5.97536145e+02  5.97536145e+02  1.46324644e+03  1.46324644e+03
  1.46324644e+03  2.58932040e+03  3.15900056e+03  3.15900056e+03
  3.15900056e+03  6.77279147e+03  6.77279147e+03  6.77279147e+03
  8.99335648e+03  2.53564805e+04  7.61057217e+04]
E1 = -728.3561693589995  E_coul = 201.9096111582745
cycle= 4 E= -526.446558200725  delta_E= -2.56e-07  |g|= 4.13e-05  |ddm|= 0.000735
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.3677e-05
diis-c [-1.65325620e-09  1.43274531e-05 -2.42192030e-03 -1.36701052e-02
  1.01607770e+00]
  HOMO = -0.566336233850907  LUMO = 1.15468368380731
  mo_energy =
[-1.18552427e+02 -1.21805991e+01 -9.53059475e+00 -9.53059475e+00
 -9.53059475e+00 -1.24466439e+00 -5.66336234e-01 -5.66336234e-01
 -5.66336234e-01  1.15468368e+00  1.15468368e+00  1.15468368e+00
  1.05797329e+01  1.05797329e+01  1.05797329e+01  5.46428828e+01
  5.46428828e+01  5.46428828e+01  7.51444613e+01  1.97522260e+02
  1.97522260e+02  1.97522260e+02  5.47490089e+02  5.97536236e+02
  5.97536236e+02  5.97536236e+02  1.46324653e+03  1.46324653e+03
  1.46324653e+03  2.58932048e+03  3.15900065e+03  3.15900065e+03
  3.15900065e+03  6.77279154e+03  6.77279154e+03  6.77279154e+03
  8.99335656e+03  2.53564805e+04  7.61057217e+04]
E1 = -728.3559790466593  E_coul = 201.90942084581351
cycle= 5 E= -526.446558200846  delta_E= -1.21e-10  |g|= 7.04e-06  |ddm|= 2.24e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3559790466593  E_coul = 201.90942084581351
  HOMO = -0.566339904879829  LUMO = 1.15468062189296
  mo_energy =
[-1.18552445e+02 -1.21806119e+01 -9.53060780e+00 -9.53060780e+00
 -9.53060780e+00 -1.24466917e+00 -5.66339905e-01 -5.66339905e-01
 -5.66339905e-01  1.15468062e+00  1.15468062e+00  1.15468062e+00
  1.05797226e+01  1.05797226e+01  1.05797226e+01  5.46428687e+01
  5.46428687e+01  5.46428687e+01  7.51444456e+01  1.97522243e+02
  1.97522243e+02  1.97522243e+02  5.47490071e+02  5.97536219e+02
  5.97536219e+02  5.97536219e+02  1.46324651e+03  1.46324651e+03
  1.46324651e+03  2.58932046e+03  3.15900063e+03  3.15900063e+03
  3.15900063e+03  6.77279153e+03  6.77279153e+03  6.77279153e+03
  8.99335654e+03  2.53564805e+04  7.61057217e+04]
E1 = -728.3560113149013  E_coul = 201.9094531140532
Extra cycle  E= -526.446558200848  delta_E= -2.27e-12  |g|= 1.75e-06  |ddm|= 3.56e-06
    CPU time for scf_cycle      0.67 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 162435.1895836825
E1 = -728.3560113149013  E_coul = 201.9094531140532
init E= -526.446558200848
    CPU time for initialize scf      2.73 sec, wall time      0.25 sec
  HOMO = -0.566339301118807  LUMO = 1.15468113372464
  mo_energy =
[-1.18552441e+02 -1.21806095e+01 -9.53060537e+00 -9.53060537e+00
 -9.53060537e+00 -1.24466838e+00 -5.66339301e-01 -5.66339301e-01
 -5.66339301e-01  1.15468113e+00  1.15468113e+00  1.15468113e+00
  1.05797245e+01  1.05797245e+01  1.05797245e+01  5.46428715e+01
  5.46428715e+01  5.46428715e+01  7.51444489e+01  1.97522247e+02
  1.97522247e+02  1.97522247e+02  5.47490075e+02  5.97536222e+02
  5.97536222e+02  5.97536222e+02  1.46324651e+03  1.46324651e+03
  1.46324651e+03  2.58932046e+03  3.15900063e+03  3.15900063e+03
  3.15900063e+03  6.77279153e+03  6.77279153e+03  6.77279153e+03
  8.99335654e+03  2.53564805e+04  7.61057217e+04]
E1 = -728.3560049558017  E_coul = 201.90944675495422
cycle= 1 E= -526.446558200847  delta_E= 5.68e-13  |g|= 3.79e-07  |ddm|= 6.42e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3560049558017  E_coul = 201.90944675495422
  HOMO = -0.56633941246458  LUMO = 1.15468103867485
  mo_energy =
[-1.18552441e+02 -1.21806100e+01 -9.53060584e+00 -9.53060584e+00
 -9.53060584e+00 -1.24466853e+00 -5.66339412e-01 -5.66339412e-01
 -5.66339412e-01  1.15468104e+00  1.15468104e+00  1.15468104e+00
  1.05797241e+01  1.05797241e+01  1.05797241e+01  5.46428709e+01
  5.46428709e+01  5.46428709e+01  7.51444482e+01  1.97522246e+02
  1.97522246e+02  1.97522246e+02  5.47490074e+02  5.97536222e+02
  5.97536222e+02  5.97536222e+02  1.46324651e+03  1.46324651e+03
  1.46324651e+03  2.58932046e+03  3.15900063e+03  3.15900063e+03
  3.15900063e+03  6.77279153e+03  6.77279153e+03  6.77279153e+03
  8.99335654e+03  2.53564805e+04  7.61057217e+04]
E1 = -728.3560062315146  E_coul = 201.90944803066571
Extra cycle  E= -526.446558200849  delta_E= -1.36e-12  |g|= 7.88e-08  |ddm|= 1.25e-07
    CPU time for scf_cycle      2.88 sec, wall time      0.39 sec
exp = [2.61825414e+04 7.61782996e+03 3.61734961e+03 1.60494611e+03
 3.65743970e+02 1.07822252e+02 3.50605849e+01 4.57514484e+00
 3.98305974e-01 1.36276448e+03 6.64808905e+02 3.01280768e+02
 3.14347378e+02 8.35770907e+01 1.09685105e+01 3.25643203e+01
 8.40615361e-01 3.75710087e+00 2.39462762e-01]
grad_E = [-1.64911828e-06  5.11266801e-06  5.04792501e-07  1.29423756e-04
 -9.48246633e-04  3.03381533e-03 -2.83425359e-03 -7.88214238e-03
  5.46592339e-02 -6.50917477e-07  3.38430172e-06  1.58162148e-05
  1.33255911e-05 -5.39936802e-04 -3.29331290e-03  4.68131594e-03
 -5.97257198e-02  1.04450211e-03  8.04562962e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:44:06 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5422733        1
[INPUT] 0    0    [1    /1   ]  7617.82202217        1
[INPUT] 0    0    [1    /1   ]  3617.33477087        1
[INPUT] 0    0    [1    /1   ]  1604.69933341        1
[INPUT] 0    0    [1    /1   ]  368.570808673        1
[INPUT] 0    0    [1    /1   ]  105.727838066        1
[INPUT] 0    0    [1    /1   ]  34.3609710442        1
[INPUT] 0    0    [1    /1   ]  4.57707384837        1
[INPUT] 0    0    [1    /1   ]  0.397606392556       1
[INPUT] 1    0    [1    /1   ]  1362.76414077        1
[INPUT] 1    0    [1    /1   ]  664.803180897        1
[INPUT] 1    0    [1    /1   ]  301.249536539        1
[INPUT] 1    0    [1    /1   ]  314.319808352        1
[INPUT] 1    0    [1    /1   ]  84.1741123143        1
[INPUT] 1    0    [1    /1   ]  10.8886367957        1
[INPUT] 1    0    [1    /1   ]  32.345803139         1
[INPUT] 1    0    [1    /1   ]  0.849980034086       1
[INPUT] 1    0    [1    /1   ]  3.73477581884        1
[INPUT] 1    0    [1    /1   ]  0.24151057452        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.542273301187, 1.0]], [0, [7617.822022172291, 1.0]], [0, [3617.3347708680203, 1.0]], [0, [1604.6993334064894, 1.0]], [0, [368.57080867280285, 1.0]], [0, [105.72783806561335, 1.0]], [0, [34.360971044157175, 1.0]], [0, [4.577073848373152, 1.0]], [0, [0.39760639255642427, 1.0]], [1, [1362.7641407669748, 1.0]], [1, [664.8031808966407, 1.0]], [1, [301.24953653888025, 1.0]], [1, [314.319808352045, 1.0]], [1, [84.17411231430543, 1.0]], [1, [10.888636795681776, 1.0]], [1, [32.34580313901986, 1.0]], [1, [0.849980034085947, 1.0]], [1, [3.7347758188421487, 1.0]], [1, [0.2415105745199892, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.5422733]
bas 1, expnt(s) = [7617.82202217]
bas 2, expnt(s) = [3617.33477087]
bas 3, expnt(s) = [1604.69933341]
bas 4, expnt(s) = [368.57080867]
bas 5, expnt(s) = [105.72783807]
bas 6, expnt(s) = [34.36097104]
bas 7, expnt(s) = [4.57707385]
bas 8, expnt(s) = [0.39760639]
bas 9, expnt(s) = [1362.76414077]
bas 10, expnt(s) = [664.8031809]
bas 11, expnt(s) = [301.24953654]
bas 12, expnt(s) = [314.31980835]
bas 13, expnt(s) = [84.17411231]
bas 14, expnt(s) = [10.8886368]
bas 15, expnt(s) = [32.34580314]
bas 16, expnt(s) = [0.84998003]
bas 17, expnt(s) = [3.73477582]
bas 18, expnt(s) = [0.24151057]
CPU time:       605.71
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825423e+04 5.20024595e+03 7.61782202e+03 2.06009923e+03
 3.61733477e+03 1.17843749e+03 1.60469933e+03 6.40560683e+02
 3.68570809e+02 2.12522896e+02 1.05727838e+02 8.33023087e+01
 3.43609710e+01 3.58561863e+01 4.57707385e+00 7.90598460e+00
 3.97606393e-01 1.26504229e+00 1.36276414e+03 2.41551792e+04
 6.64803181e+02 9.84806153e+03 3.01249537e+02 3.66135953e+03
 3.14319808e+02 3.86099360e+03 8.41741123e+01 7.43802398e+02
 1.08886368e+01 5.77033839e+01 3.23458031e+01 2.25038496e+02
 8.49980034e-01 2.38092271e+00 3.73477582e+00 1.51465968e+01
 2.41510575e-01 4.93917690e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.972477091552832
cond(S) = 163037.40077351153
E1 = -728.8718911424955  E_coul = 203.1458997723349
init E= -525.725991370161
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.557292777375887  LUMO = 1.17739608317246
  mo_energy =
[-1.18316286e+02 -1.21018676e+01 -9.44477339e+00 -9.44477339e+00
 -9.44477339e+00 -1.22926626e+00 -5.57292777e-01 -5.57292777e-01
 -5.57292777e-01  1.17739608e+00  1.17739608e+00  1.17739608e+00
  1.06076436e+01  1.06076436e+01  1.06076436e+01  5.43826454e+01
  5.43826454e+01  5.43826454e+01  7.30981244e+01  1.97351000e+02
  1.97351000e+02  1.97351000e+02  5.41850507e+02  5.98197026e+02
  5.98197026e+02  5.98197026e+02  1.46440001e+03  1.46440001e+03
  1.46440001e+03  2.58713797e+03  3.16032387e+03  3.16032387e+03
  3.16032387e+03  6.77418227e+03  6.77418227e+03  6.77418227e+03
  8.99341418e+03  2.53570377e+04  7.61064313e+04]
E1 = -728.1414628131815  E_coul = 201.68864320987174
cycle= 1 E= -526.45281960331  delta_E= -0.727  |g|= 0.186  |ddm|= 0.723
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.553549
diis-c [-0.30641603  1.        ]
  HOMO = -0.569132675071403  LUMO = 1.16888171507815
  mo_energy =
[-1.18589247e+02 -1.21969041e+01 -9.54682048e+00 -9.54682048e+00
 -9.54682048e+00 -1.24830014e+00 -5.69132675e-01 -5.69132675e-01
 -5.69132675e-01  1.16888172e+00  1.16888172e+00  1.16888172e+00
  1.05382031e+01  1.05382031e+01  1.05382031e+01  5.42423769e+01
  5.42423769e+01  5.42423769e+01  7.29362349e+01  1.97145739e+02
  1.97145739e+02  1.97145739e+02  5.41544794e+02  5.97927778e+02
  5.97927778e+02  5.97927778e+02  1.46407531e+03  1.46407531e+03
  1.46407531e+03  2.58667575e+03  3.15993243e+03  3.15993243e+03
  3.15993243e+03  6.77367501e+03  6.77367501e+03  6.77367501e+03
  8.99282871e+03  2.53563573e+04  7.61056601e+04]
E1 = -728.4260429517698  E_coul = 201.97285167891613
cycle= 2 E= -526.453191272854  delta_E= -0.000372  |g|= 0.024  |ddm|= 0.0205
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0467161
diis-c [-0.00140485  0.04806311  0.95193689]
  HOMO = -0.565682930656984  LUMO = 1.17200586417556
  mo_energy =
[-1.18547621e+02 -1.21775059e+01 -9.52703923e+00 -9.52703923e+00
 -9.52703923e+00 -1.24371440e+00 -5.65682931e-01 -5.65682931e-01
 -5.65682931e-01  1.17200586e+00  1.17200586e+00  1.17200586e+00
  1.05518207e+01  1.05518207e+01  1.05518207e+01  5.42677338e+01
  5.42677338e+01  5.42677338e+01  7.29690117e+01  1.97180758e+02
  1.97180758e+02  1.97180758e+02  5.41587740e+02  5.97968903e+02
  5.97968903e+02  5.97968903e+02  1.46411929e+03  1.46411929e+03
  1.46411929e+03  2.58672208e+03  3.15997805e+03  3.15997805e+03
  3.15997805e+03  6.77372166e+03  6.77372166e+03  6.77372166e+03
  8.99287579e+03  2.53564046e+04  7.61057073e+04]
E1 = -728.3686153735439  E_coul = 201.9154120206645
cycle= 3 E= -526.453203352879  delta_E= -1.21e-05  |g|= 0.00284  |ddm|= 0.00499
    CPU time for cycle= 3      0.03 sec, wall time      0.04 sec
diis-norm(errvec)=0.0061873
diis-c [-3.64071426e-07 -1.07954646e-03  1.10042807e-01  8.91036739e-01]
  HOMO = -0.5662938293307  LUMO = 1.17147476297144
  mo_energy =
[-1.18552615e+02 -1.21801726e+01 -9.52981091e+00 -9.52981091e+00
 -9.52981091e+00 -1.24451147e+00 -5.66293829e-01 -5.66293829e-01
 -5.66293829e-01  1.17147476e+00  1.17147476e+00  1.17147476e+00
  1.05497911e+01  1.05497911e+01  1.05497911e+01  5.42644010e+01
  5.42644010e+01  5.42644010e+01  7.29650552e+01  1.97176454e+02
  1.97176454e+02  1.97176454e+02  5.41582586e+02  5.97963968e+02
  5.97963968e+02  5.97963968e+02  1.46411402e+03  1.46411402e+03
  1.46411402e+03  2.58671639e+03  3.15997253e+03  3.15997253e+03
  3.15997253e+03  6.77371590e+03  6.77371590e+03  6.77371590e+03
  8.99286988e+03  2.53563986e+04  7.61057012e+04]
E1 = -728.3762677959766  E_coul = 201.92306418931037
cycle= 4 E= -526.453203606666  delta_E= -2.54e-07  |g|= 4.1e-05  |ddm|= 0.000727
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.27073e-05
diis-c [-1.64759023e-09  1.39115629e-05 -2.38180122e-03 -1.34787126e-02
  1.01584660e+00]
  HOMO = -0.566267662641071  LUMO = 1.17149673869623
  mo_energy =
[-1.18552525e+02 -1.21800887e+01 -9.52972829e+00 -9.52972829e+00
 -9.52972829e+00 -1.24447748e+00 -5.66267663e-01 -5.66267663e-01
 -5.66267663e-01  1.17149674e+00  1.17149674e+00  1.17149674e+00
  1.05498593e+01  1.05498593e+01  1.05498593e+01  5.42644855e+01
  5.42644855e+01  5.42644855e+01  7.29651484e+01  1.97176544e+02
  1.97176544e+02  1.97176544e+02  5.41582673e+02  5.97964058e+02
  5.97964058e+02  5.97964058e+02  1.46411411e+03  1.46411411e+03
  1.46411411e+03  2.58671647e+03  3.15997262e+03  3.15997262e+03
  3.15997262e+03  6.77371597e+03  6.77371597e+03  6.77371597e+03
  8.99286996e+03  2.53563986e+04  7.61057013e+04]
E1 = -728.376079075513  E_coul = 201.92287546872984
cycle= 5 E= -526.453203606783  delta_E= -1.17e-10  |g|= 7.08e-06  |ddm|= 2.22e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.376079075513  E_coul = 201.92287546872984
  HOMO = -0.566271311975596  LUMO = 1.1714936562772
  mo_energy =
[-1.18552542e+02 -1.21801015e+01 -9.52974131e+00 -9.52974131e+00
 -9.52974131e+00 -1.24448223e+00 -5.66271312e-01 -5.66271312e-01
 -5.66271312e-01  1.17149366e+00  1.17149366e+00  1.17149366e+00
  1.05498491e+01  1.05498491e+01  1.05498491e+01  5.42644714e+01
  5.42644714e+01  5.42644714e+01  7.29651328e+01  1.97176527e+02
  1.97176527e+02  1.97176527e+02  5.41582655e+02  5.97964040e+02
  5.97964040e+02  5.97964040e+02  1.46411409e+03  1.46411409e+03
  1.46411409e+03  2.58671645e+03  3.15997260e+03  3.15997260e+03
  3.15997260e+03  6.77371595e+03  6.77371595e+03  6.77371595e+03
  8.99286994e+03  2.53563986e+04  7.61057013e+04]
E1 = -728.3761113487939  E_coul = 201.92290774200788
Extra cycle  E= -526.453203606786  delta_E= -2.96e-12  |g|= 1.77e-06  |ddm|= 3.54e-06
    CPU time for scf_cycle      0.67 sec, wall time      0.28 sec
exp = [2.61825423e+04 7.61782202e+03 3.61733477e+03 1.60469933e+03
 3.68570809e+02 1.05727838e+02 3.43609710e+01 4.57707385e+00
 3.97606393e-01 1.36276414e+03 6.64803181e+02 3.01249537e+02
 3.14319808e+02 8.41741123e+01 1.08886368e+01 3.23458031e+01
 8.49980034e-01 3.73477582e+00 2.41510575e-01]
E = -526.453203606786
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:44:06 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5422733        1
[INPUT] 0    0    [1    /1   ]  7617.82202217        1
[INPUT] 0    0    [1    /1   ]  3617.33477087        1
[INPUT] 0    0    [1    /1   ]  1604.69933341        1
[INPUT] 0    0    [1    /1   ]  368.570808673        1
[INPUT] 0    0    [1    /1   ]  105.727838066        1
[INPUT] 0    0    [1    /1   ]  34.3609710442        1
[INPUT] 0    0    [1    /1   ]  4.57707384837        1
[INPUT] 0    0    [1    /1   ]  0.397606392556       1
[INPUT] 1    0    [1    /1   ]  1362.76414077        1
[INPUT] 1    0    [1    /1   ]  664.803180897        1
[INPUT] 1    0    [1    /1   ]  301.249536539        1
[INPUT] 1    0    [1    /1   ]  314.319808352        1
[INPUT] 1    0    [1    /1   ]  84.1741123143        1
[INPUT] 1    0    [1    /1   ]  10.8886367957        1
[INPUT] 1    0    [1    /1   ]  32.345803139         1
[INPUT] 1    0    [1    /1   ]  0.849980034086       1
[INPUT] 1    0    [1    /1   ]  3.73477581884        1
[INPUT] 1    0    [1    /1   ]  0.24151057452        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.542273301187, 1.0]], [0, [7617.822022172291, 1.0]], [0, [3617.3347708680203, 1.0]], [0, [1604.6993334064894, 1.0]], [0, [368.57080867280285, 1.0]], [0, [105.72783806561335, 1.0]], [0, [34.360971044157175, 1.0]], [0, [4.577073848373152, 1.0]], [0, [0.39760639255642427, 1.0]], [1, [1362.7641407669748, 1.0]], [1, [664.8031808966407, 1.0]], [1, [301.24953653888025, 1.0]], [1, [314.319808352045, 1.0]], [1, [84.17411231430543, 1.0]], [1, [10.888636795681776, 1.0]], [1, [32.34580313901986, 1.0]], [1, [0.849980034085947, 1.0]], [1, [3.7347758188421487, 1.0]], [1, [0.2415105745199892, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.5422733]
bas 1, expnt(s) = [7617.82202217]
bas 2, expnt(s) = [3617.33477087]
bas 3, expnt(s) = [1604.69933341]
bas 4, expnt(s) = [368.57080867]
bas 5, expnt(s) = [105.72783807]
bas 6, expnt(s) = [34.36097104]
bas 7, expnt(s) = [4.57707385]
bas 8, expnt(s) = [0.39760639]
bas 9, expnt(s) = [1362.76414077]
bas 10, expnt(s) = [664.8031809]
bas 11, expnt(s) = [301.24953654]
bas 12, expnt(s) = [314.31980835]
bas 13, expnt(s) = [84.17411231]
bas 14, expnt(s) = [10.8886368]
bas 15, expnt(s) = [32.34580314]
bas 16, expnt(s) = [0.84998003]
bas 17, expnt(s) = [3.73477582]
bas 18, expnt(s) = [0.24151057]
CPU time:       606.61
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825423e+04 5.20024595e+03 7.61782202e+03 2.06009923e+03
 3.61733477e+03 1.17843749e+03 1.60469933e+03 6.40560683e+02
 3.68570809e+02 2.12522896e+02 1.05727838e+02 8.33023087e+01
 3.43609710e+01 3.58561863e+01 4.57707385e+00 7.90598460e+00
 3.97606393e-01 1.26504229e+00 1.36276414e+03 2.41551792e+04
 6.64803181e+02 9.84806153e+03 3.01249537e+02 3.66135953e+03
 3.14319808e+02 3.86099360e+03 8.41741123e+01 7.43802398e+02
 1.08886368e+01 5.77033839e+01 3.23458031e+01 2.25038496e+02
 8.49980034e-01 2.38092271e+00 3.73477582e+00 1.51465968e+01
 2.41510575e-01 4.93917690e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.972477091552832
cond(S) = 163037.40077351153
E1 = -728.8718911424955  E_coul = 203.1458997723349
init E= -525.725991370161
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.557292777375887  LUMO = 1.17739608317246
  mo_energy =
[-1.18316286e+02 -1.21018676e+01 -9.44477339e+00 -9.44477339e+00
 -9.44477339e+00 -1.22926626e+00 -5.57292777e-01 -5.57292777e-01
 -5.57292777e-01  1.17739608e+00  1.17739608e+00  1.17739608e+00
  1.06076436e+01  1.06076436e+01  1.06076436e+01  5.43826454e+01
  5.43826454e+01  5.43826454e+01  7.30981244e+01  1.97351000e+02
  1.97351000e+02  1.97351000e+02  5.41850507e+02  5.98197026e+02
  5.98197026e+02  5.98197026e+02  1.46440001e+03  1.46440001e+03
  1.46440001e+03  2.58713797e+03  3.16032387e+03  3.16032387e+03
  3.16032387e+03  6.77418227e+03  6.77418227e+03  6.77418227e+03
  8.99341418e+03  2.53570377e+04  7.61064313e+04]
E1 = -728.1414628131815  E_coul = 201.68864320987174
cycle= 1 E= -526.45281960331  delta_E= -0.727  |g|= 0.186  |ddm|= 0.723
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.553549
diis-c [-0.30641603  1.        ]
  HOMO = -0.569132675071403  LUMO = 1.16888171507815
  mo_energy =
[-1.18589247e+02 -1.21969041e+01 -9.54682048e+00 -9.54682048e+00
 -9.54682048e+00 -1.24830014e+00 -5.69132675e-01 -5.69132675e-01
 -5.69132675e-01  1.16888172e+00  1.16888172e+00  1.16888172e+00
  1.05382031e+01  1.05382031e+01  1.05382031e+01  5.42423769e+01
  5.42423769e+01  5.42423769e+01  7.29362349e+01  1.97145739e+02
  1.97145739e+02  1.97145739e+02  5.41544794e+02  5.97927778e+02
  5.97927778e+02  5.97927778e+02  1.46407531e+03  1.46407531e+03
  1.46407531e+03  2.58667575e+03  3.15993243e+03  3.15993243e+03
  3.15993243e+03  6.77367501e+03  6.77367501e+03  6.77367501e+03
  8.99282871e+03  2.53563573e+04  7.61056601e+04]
E1 = -728.4260429517698  E_coul = 201.97285167891613
cycle= 2 E= -526.453191272854  delta_E= -0.000372  |g|= 0.024  |ddm|= 0.0205
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0467161
diis-c [-0.00140485  0.04806311  0.95193689]
  HOMO = -0.565682930656984  LUMO = 1.17200586417556
  mo_energy =
[-1.18547621e+02 -1.21775059e+01 -9.52703923e+00 -9.52703923e+00
 -9.52703923e+00 -1.24371440e+00 -5.65682931e-01 -5.65682931e-01
 -5.65682931e-01  1.17200586e+00  1.17200586e+00  1.17200586e+00
  1.05518207e+01  1.05518207e+01  1.05518207e+01  5.42677338e+01
  5.42677338e+01  5.42677338e+01  7.29690117e+01  1.97180758e+02
  1.97180758e+02  1.97180758e+02  5.41587740e+02  5.97968903e+02
  5.97968903e+02  5.97968903e+02  1.46411929e+03  1.46411929e+03
  1.46411929e+03  2.58672208e+03  3.15997805e+03  3.15997805e+03
  3.15997805e+03  6.77372166e+03  6.77372166e+03  6.77372166e+03
  8.99287579e+03  2.53564046e+04  7.61057073e+04]
E1 = -728.3686153735439  E_coul = 201.9154120206645
cycle= 3 E= -526.453203352879  delta_E= -1.21e-05  |g|= 0.00284  |ddm|= 0.00499
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0061873
diis-c [-3.64071426e-07 -1.07954646e-03  1.10042807e-01  8.91036739e-01]
  HOMO = -0.5662938293307  LUMO = 1.17147476297144
  mo_energy =
[-1.18552615e+02 -1.21801726e+01 -9.52981091e+00 -9.52981091e+00
 -9.52981091e+00 -1.24451147e+00 -5.66293829e-01 -5.66293829e-01
 -5.66293829e-01  1.17147476e+00  1.17147476e+00  1.17147476e+00
  1.05497911e+01  1.05497911e+01  1.05497911e+01  5.42644010e+01
  5.42644010e+01  5.42644010e+01  7.29650552e+01  1.97176454e+02
  1.97176454e+02  1.97176454e+02  5.41582586e+02  5.97963968e+02
  5.97963968e+02  5.97963968e+02  1.46411402e+03  1.46411402e+03
  1.46411402e+03  2.58671639e+03  3.15997253e+03  3.15997253e+03
  3.15997253e+03  6.77371590e+03  6.77371590e+03  6.77371590e+03
  8.99286988e+03  2.53563986e+04  7.61057012e+04]
E1 = -728.3762677959766  E_coul = 201.92306418931037
cycle= 4 E= -526.453203606666  delta_E= -2.54e-07  |g|= 4.1e-05  |ddm|= 0.000727
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.27073e-05
diis-c [-1.64759023e-09  1.39115629e-05 -2.38180122e-03 -1.34787126e-02
  1.01584660e+00]
  HOMO = -0.566267662641071  LUMO = 1.17149673869623
  mo_energy =
[-1.18552525e+02 -1.21800887e+01 -9.52972829e+00 -9.52972829e+00
 -9.52972829e+00 -1.24447748e+00 -5.66267663e-01 -5.66267663e-01
 -5.66267663e-01  1.17149674e+00  1.17149674e+00  1.17149674e+00
  1.05498593e+01  1.05498593e+01  1.05498593e+01  5.42644855e+01
  5.42644855e+01  5.42644855e+01  7.29651484e+01  1.97176544e+02
  1.97176544e+02  1.97176544e+02  5.41582673e+02  5.97964058e+02
  5.97964058e+02  5.97964058e+02  1.46411411e+03  1.46411411e+03
  1.46411411e+03  2.58671647e+03  3.15997262e+03  3.15997262e+03
  3.15997262e+03  6.77371597e+03  6.77371597e+03  6.77371597e+03
  8.99286996e+03  2.53563986e+04  7.61057013e+04]
E1 = -728.376079075513  E_coul = 201.92287546872984
cycle= 5 E= -526.453203606783  delta_E= -1.17e-10  |g|= 7.08e-06  |ddm|= 2.22e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.376079075513  E_coul = 201.92287546872984
  HOMO = -0.566271311975596  LUMO = 1.1714936562772
  mo_energy =
[-1.18552542e+02 -1.21801015e+01 -9.52974131e+00 -9.52974131e+00
 -9.52974131e+00 -1.24448223e+00 -5.66271312e-01 -5.66271312e-01
 -5.66271312e-01  1.17149366e+00  1.17149366e+00  1.17149366e+00
  1.05498491e+01  1.05498491e+01  1.05498491e+01  5.42644714e+01
  5.42644714e+01  5.42644714e+01  7.29651328e+01  1.97176527e+02
  1.97176527e+02  1.97176527e+02  5.41582655e+02  5.97964040e+02
  5.97964040e+02  5.97964040e+02  1.46411409e+03  1.46411409e+03
  1.46411409e+03  2.58671645e+03  3.15997260e+03  3.15997260e+03
  3.15997260e+03  6.77371595e+03  6.77371595e+03  6.77371595e+03
  8.99286994e+03  2.53563986e+04  7.61057013e+04]
E1 = -728.3761113487939  E_coul = 201.92290774200788
Extra cycle  E= -526.453203606786  delta_E= -2.96e-12  |g|= 1.77e-06  |ddm|= 3.54e-06
    CPU time for scf_cycle      0.66 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 163037.40077351153
E1 = -728.3761113487939  E_coul = 201.92290774200788
init E= -526.453203606786
    CPU time for initialize scf      2.74 sec, wall time      0.25 sec
  HOMO = -0.566270710832568  LUMO = 1.17149417245907
  mo_energy =
[-1.18552539e+02 -1.21800991e+01 -9.52973888e+00 -9.52973888e+00
 -9.52973888e+00 -1.24448145e+00 -5.66270711e-01 -5.66270711e-01
 -5.66270711e-01  1.17149417e+00  1.17149417e+00  1.17149417e+00
  1.05498509e+01  1.05498509e+01  1.05498509e+01  5.42644742e+01
  5.42644742e+01  5.42644742e+01  7.29651361e+01  1.97176531e+02
  1.97176531e+02  1.97176531e+02  5.41582659e+02  5.97964044e+02
  5.97964044e+02  5.97964044e+02  1.46411409e+03  1.46411409e+03
  1.46411409e+03  2.58671646e+03  3.15997260e+03  3.15997260e+03
  3.15997260e+03  6.77371596e+03  6.77371596e+03  6.77371596e+03
  8.99286994e+03  2.53563986e+04  7.61057013e+04]
E1 = -728.3761049716121  E_coul = 201.92290136482566
cycle= 1 E= -526.453203606786  delta_E= -4.55e-13  |g|= 3.83e-07  |ddm|= 6.41e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3761049716121  E_coul = 201.92290136482566
  HOMO = -0.566270822010963  LUMO = 1.1714940763183
  mo_energy =
[-1.18552539e+02 -1.21800996e+01 -9.52973936e+00 -9.52973936e+00
 -9.52973936e+00 -1.24448159e+00 -5.66270822e-01 -5.66270822e-01
 -5.66270822e-01  1.17149408e+00  1.17149408e+00  1.17149408e+00
  1.05498505e+01  1.05498505e+01  1.05498505e+01  5.42644736e+01
  5.42644736e+01  5.42644736e+01  7.29651354e+01  1.97176530e+02
  1.97176530e+02  1.97176530e+02  5.41582658e+02  5.97964043e+02
  5.97964043e+02  5.97964043e+02  1.46411409e+03  1.46411409e+03
  1.46411409e+03  2.58671646e+03  3.15997260e+03  3.15997260e+03
  3.15997260e+03  6.77371596e+03  6.77371596e+03  6.77371596e+03
  8.99286994e+03  2.53563986e+04  7.61057013e+04]
E1 = -728.3761062544196  E_coul = 201.9229026476345
Extra cycle  E= -526.453203606785  delta_E= 1.36e-12  |g|= 7.97e-08  |ddm|= 1.25e-07
    CPU time for scf_cycle      2.88 sec, wall time      0.39 sec
exp = [2.61825423e+04 7.61782202e+03 3.61733477e+03 1.60469933e+03
 3.68570809e+02 1.05727838e+02 3.43609710e+01 4.57707385e+00
 3.97606393e-01 1.36276414e+03 6.64803181e+02 3.01249537e+02
 3.14319808e+02 8.41741123e+01 1.08886368e+01 3.23458031e+01
 8.49980034e-01 3.73477582e+00 2.41510575e-01]
grad_E = [-1.60545406e-06  4.46529153e-06 -2.94245267e-07  1.06390966e-04
 -4.78983230e-04  1.38982766e-03 -1.56067748e-03 -4.24070451e-03
  4.57164080e-02 -6.69486143e-07  3.03558326e-06  1.39802933e-05
  1.17279308e-05 -5.12609502e-04 -2.96677143e-03  4.64372469e-03
 -4.32192332e-02 -1.88653719e-03  7.15689312e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:44:11 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5438624        1
[INPUT] 0    0    [1    /1   ]  7617.80496793        1
[INPUT] 0    0    [1    /1   ]  3617.30026131        1
[INPUT] 0    0    [1    /1   ]  1604.16450329        1
[INPUT] 0    0    [1    /1   ]  374.168161648        1
[INPUT] 0    0    [1    /1   ]  104.586233202        1
[INPUT] 0    0    [1    /1   ]  33.8520370824        1
[INPUT] 0    0    [1    /1   ]  4.5838267212         1
[INPUT] 0    0    [1    /1   ]  0.394919520493       1
[INPUT] 1    0    [1    /1   ]  1362.76290903        1
[INPUT] 1    0    [1    /1   ]  664.787121081        1
[INPUT] 1    0    [1    /1   ]  301.160411968        1
[INPUT] 1    0    [1    /1   ]  314.241243963        1
[INPUT] 1    0    [1    /1   ]  86.7001820699        1
[INPUT] 1    0    [1    /1   ]  9.97198491304        1
[INPUT] 1    0    [1    /1   ]  29.2906808231        1
[INPUT] 1    0    [1    /1   ]  0.858120909925       1
[INPUT] 1    0    [1    /1   ]  3.52750961739        1
[INPUT] 1    0    [1    /1   ]  0.241831807643       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.543862377257, 1.0]], [0, [7617.804967929886, 1.0]], [0, [3617.300261307594, 1.0]], [0, [1604.1645032895449, 1.0]], [0, [374.1681616480129, 1.0]], [0, [104.58623320174834, 1.0]], [0, [33.85203708244386, 1.0]], [0, [4.583826721198274, 1.0]], [0, [0.39491952049287504, 1.0]], [1, [1362.7629090333537, 1.0]], [1, [664.787121081102, 1.0]], [1, [301.1604119684083, 1.0]], [1, [314.24124396331234, 1.0]], [1, [86.70018206992675, 1.0]], [1, [9.971984913043165, 1.0]], [1, [29.29068082309385, 1.0]], [1, [0.8581209099245093, 1.0]], [1, [3.527509617391876, 1.0]], [1, [0.24183180764287865, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.54386238]
bas 1, expnt(s) = [7617.80496793]
bas 2, expnt(s) = [3617.30026131]
bas 3, expnt(s) = [1604.16450329]
bas 4, expnt(s) = [374.16816165]
bas 5, expnt(s) = [104.5862332]
bas 6, expnt(s) = [33.85203708]
bas 7, expnt(s) = [4.58382672]
bas 8, expnt(s) = [0.39491952]
bas 9, expnt(s) = [1362.76290903]
bas 10, expnt(s) = [664.78712108]
bas 11, expnt(s) = [301.16041197]
bas 12, expnt(s) = [314.24124396]
bas 13, expnt(s) = [86.70018207]
bas 14, expnt(s) = [9.97198491]
bas 15, expnt(s) = [29.29068082]
bas 16, expnt(s) = [0.85812091]
bas 17, expnt(s) = [3.52750962]
bas 18, expnt(s) = [0.24183181]
CPU time:       614.90
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825439e+04 5.20024618e+03 7.61780497e+03 2.06009578e+03
 3.61730026e+03 1.17842906e+03 1.60416450e+03 6.40400557e+02
 3.74168162e+02 2.14938962e+02 1.04586233e+02 8.26267966e+01
 3.38520371e+01 3.54571341e+01 4.58382672e+00 7.91473117e+00
 3.94919520e-01 1.25862535e+00 1.36276291e+03 2.41551519e+04
 6.64787121e+02 9.84776416e+03 3.01160412e+02 3.66000557e+03
 3.14241244e+02 3.85978731e+03 8.67001821e+01 7.71808228e+02
 9.97198491e+00 5.16965318e+01 2.92906808e+01 1.98790774e+02
 8.58120910e-01 2.40946154e+00 3.52750962e+00 1.41032645e+01
 2.41831808e-01 4.94739027e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.972953497965676
cond(S) = 160470.2715332199
E1 = -728.8802429805024  E_coul = 203.12284460994312
init E= -525.757398370559
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558527724815302  LUMO = 1.18400580914897
  mo_energy =
[-1.18318187e+02 -1.21033913e+01 -9.44790751e+00 -9.44790751e+00
 -9.44790751e+00 -1.23029556e+00 -5.58527725e-01 -5.58527725e-01
 -5.58527725e-01  1.18400581e+00  1.18400581e+00  1.18400581e+00
  9.90134561e+00  9.90134561e+00  9.90134561e+00  4.92648008e+01
  4.92648008e+01  4.92648008e+01  7.16762423e+01  1.87773170e+02
  1.87773170e+02  1.87773170e+02  5.40929559e+02  5.90527869e+02
  5.90527869e+02  5.90527869e+02  1.45888776e+03  1.45888776e+03
  1.45888776e+03  2.59592399e+03  3.15580227e+03  3.15580227e+03
  3.15580227e+03  6.77021621e+03  6.77021621e+03  6.77021621e+03
  9.00612239e+03  2.53699839e+04  7.61186454e+04]
E1 = -728.1368446943927  E_coul = 201.67199879655473
cycle= 1 E= -526.464845897838  delta_E= -0.707  |g|= 0.184  |ddm|= 0.469
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.54837
diis-c [-0.30070965  1.        ]
  HOMO = -0.571046752747992  LUMO = 1.17489706432401
  mo_energy =
[-1.18588909e+02 -1.21979344e+01 -9.54896924e+00 -9.54896924e+00
 -9.54896924e+00 -1.24975067e+00 -5.71046753e-01 -5.71046753e-01
 -5.71046753e-01  1.17489706e+00  1.17489706e+00  1.17489706e+00
  9.83579990e+00  9.83579990e+00  9.83579990e+00  4.91313154e+01
  4.91313154e+01  4.91313154e+01  7.15171529e+01  1.87569030e+02
  1.87569030e+02  1.87569030e+02  5.40625311e+02  5.90259945e+02
  5.90259945e+02  5.90259945e+02  1.45856493e+03  1.45856493e+03
  1.45856493e+03  2.59546298e+03  3.15541245e+03  3.15541245e+03
  3.15541245e+03  6.76971076e+03  6.76971076e+03  6.76971076e+03
  9.00553884e+03  2.53693058e+04  7.61178765e+04]
E1 = -728.4219045721779  E_coul = 201.95669481080358
cycle= 2 E= -526.465209761374  delta_E= -0.000364  |g|= 0.024  |ddm|= 0.0199
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.046394
diis-c [-0.00139187  0.04798831  0.95201169]
  HOMO = -0.567595388242362  LUMO = 1.17802681833339
  mo_energy =
[-1.18547362e+02 -1.21784581e+01 -9.52910731e+00 -9.52910731e+00
 -9.52910731e+00 -1.24516849e+00 -5.67595388e-01 -5.67595388e-01
 -5.67595388e-01  1.17802682e+00  1.17802682e+00  1.17802682e+00
  9.84875146e+00  9.84875146e+00  9.84875146e+00  4.91558202e+01
  4.91558202e+01  4.91558202e+01  7.15497452e+01  1.87604016e+02
  1.87604016e+02  1.87604016e+02  5.40668188e+02  5.90301096e+02
  5.90301096e+02  5.90301096e+02  1.45860885e+03  1.45860885e+03
  1.45860885e+03  2.59550921e+03  3.15545798e+03  3.15545798e+03
  3.15545798e+03  6.76975730e+03  6.76975730e+03  6.76975730e+03
  9.00558580e+03  2.53693529e+04  7.61179237e+04]
E1 = -728.3637129118913  E_coul = 201.89849092884708
cycle= 3 E= -526.465221983044  delta_E= -1.22e-05  |g|= 0.0029  |ddm|= 0.00499
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00625921
diis-c [-3.60763635e-07 -1.09143141e-03  1.11969508e-01  8.89121923e-01]
  HOMO = -0.568216427297231  LUMO = 1.17748545921025
  mo_energy =
[-1.18552425e+02 -1.21811681e+01 -9.53192173e+00 -9.53192173e+00
 -9.53192173e+00 -1.24597578e+00 -5.68216427e-01 -5.68216427e-01
 -5.68216427e-01  1.17748546e+00  1.17748546e+00  1.17748546e+00
  9.84677617e+00  9.84677617e+00  9.84677617e+00  4.91525313e+01
  4.91525313e+01  4.91525313e+01  7.15457452e+01  1.87599648e+02
  1.87599648e+02  1.87599648e+02  5.40662962e+02  5.90296082e+02
  5.90296082e+02  5.90296082e+02  1.45860351e+03  1.45860351e+03
  1.45860351e+03  2.59550345e+03  3.15545239e+03  3.15545239e+03
  3.15545239e+03  6.76975146e+03  6.76975146e+03  6.76975146e+03
  9.00557982e+03  2.53693468e+04  7.61179175e+04]
E1 = -728.3715679654476  E_coul = 201.90634571648246
cycle= 4 E= -526.465222248965  delta_E= -2.66e-07  |g|= 4.09e-05  |ddm|= 0.000733
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.21018e-05
diis-c [-1.66207081e-09  1.04032859e-05 -2.04413260e-03 -1.06306563e-02
  1.01266439e+00]
  HOMO = -0.568190374595268  LUMO = 1.17750739915414
  mo_energy =
[-1.18552336e+02 -1.21810839e+01 -9.53183880e+00 -9.53183880e+00
 -9.53183880e+00 -1.24594193e+00 -5.68190375e-01 -5.68190375e-01
 -5.68190375e-01  1.17750740e+00  1.17750740e+00  1.17750740e+00
  9.84684275e+00  9.84684275e+00  9.84684275e+00  4.91526150e+01
  4.91526150e+01  4.91526150e+01  7.15458382e+01  1.87599737e+02
  1.87599737e+02  1.87599737e+02  5.40663049e+02  5.90296171e+02
  5.90296171e+02  5.90296171e+02  1.45860359e+03  1.45860359e+03
  1.45860359e+03  2.59550353e+03  3.15545247e+03  3.15545247e+03
  3.15545247e+03  6.76975153e+03  6.76975153e+03  6.76975153e+03
  9.00557989e+03  2.53693469e+04  7.61179176e+04]
E1 = -728.371375750186  E_coul = 201.9061535011001
cycle= 5 E= -526.465222249086  delta_E= -1.21e-10  |g|= 7.18e-06  |ddm|= 2.25e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.371375750186  E_coul = 201.9061535011001
  HOMO = -0.568194013095082  LUMO = 1.17750431471612
  mo_energy =
[-1.18552353e+02 -1.21810967e+01 -9.53185185e+00 -9.53185185e+00
 -9.53185185e+00 -1.24594665e+00 -5.68194013e-01 -5.68194013e-01
 -5.68194013e-01  1.17750431e+00  1.17750431e+00  1.17750431e+00
  9.84683278e+00  9.84683278e+00  9.84683278e+00  4.91526011e+01
  4.91526011e+01  4.91526011e+01  7.15458225e+01  1.87599721e+02
  1.87599721e+02  1.87599721e+02  5.40663031e+02  5.90296154e+02
  5.90296154e+02  5.90296154e+02  1.45860358e+03  1.45860358e+03
  1.45860358e+03  2.59550351e+03  3.15545245e+03  3.15545245e+03
  3.15545245e+03  6.76975151e+03  6.76975151e+03  6.76975151e+03
  9.00557987e+03  2.53693468e+04  7.61179176e+04]
E1 = -728.3714085948152  E_coul = 201.90618634572652
Extra cycle  E= -526.465222249089  delta_E= -2.84e-12  |g|= 1.81e-06  |ddm|= 3.55e-06
    CPU time for scf_cycle      0.67 sec, wall time      0.28 sec
exp = [2.61825439e+04 7.61780497e+03 3.61730026e+03 1.60416450e+03
 3.74168162e+02 1.04586233e+02 3.38520371e+01 4.58382672e+00
 3.94919520e-01 1.36276291e+03 6.64787121e+02 3.01160412e+02
 3.14241244e+02 8.67001821e+01 9.97198491e+00 2.92906808e+01
 8.58120910e-01 3.52750962e+00 2.41831808e-01]
E = -526.4652222490887
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:44:11 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5438624        1
[INPUT] 0    0    [1    /1   ]  7617.80496793        1
[INPUT] 0    0    [1    /1   ]  3617.30026131        1
[INPUT] 0    0    [1    /1   ]  1604.16450329        1
[INPUT] 0    0    [1    /1   ]  374.168161648        1
[INPUT] 0    0    [1    /1   ]  104.586233202        1
[INPUT] 0    0    [1    /1   ]  33.8520370824        1
[INPUT] 0    0    [1    /1   ]  4.5838267212         1
[INPUT] 0    0    [1    /1   ]  0.394919520493       1
[INPUT] 1    0    [1    /1   ]  1362.76290903        1
[INPUT] 1    0    [1    /1   ]  664.787121081        1
[INPUT] 1    0    [1    /1   ]  301.160411968        1
[INPUT] 1    0    [1    /1   ]  314.241243963        1
[INPUT] 1    0    [1    /1   ]  86.7001820699        1
[INPUT] 1    0    [1    /1   ]  9.97198491304        1
[INPUT] 1    0    [1    /1   ]  29.2906808231        1
[INPUT] 1    0    [1    /1   ]  0.858120909925       1
[INPUT] 1    0    [1    /1   ]  3.52750961739        1
[INPUT] 1    0    [1    /1   ]  0.241831807643       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.543862377257, 1.0]], [0, [7617.804967929886, 1.0]], [0, [3617.300261307594, 1.0]], [0, [1604.1645032895449, 1.0]], [0, [374.1681616480129, 1.0]], [0, [104.58623320174834, 1.0]], [0, [33.85203708244386, 1.0]], [0, [4.583826721198274, 1.0]], [0, [0.39491952049287504, 1.0]], [1, [1362.7629090333537, 1.0]], [1, [664.787121081102, 1.0]], [1, [301.1604119684083, 1.0]], [1, [314.24124396331234, 1.0]], [1, [86.70018206992675, 1.0]], [1, [9.971984913043165, 1.0]], [1, [29.29068082309385, 1.0]], [1, [0.8581209099245093, 1.0]], [1, [3.527509617391876, 1.0]], [1, [0.24183180764287865, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.54386238]
bas 1, expnt(s) = [7617.80496793]
bas 2, expnt(s) = [3617.30026131]
bas 3, expnt(s) = [1604.16450329]
bas 4, expnt(s) = [374.16816165]
bas 5, expnt(s) = [104.5862332]
bas 6, expnt(s) = [33.85203708]
bas 7, expnt(s) = [4.58382672]
bas 8, expnt(s) = [0.39491952]
bas 9, expnt(s) = [1362.76290903]
bas 10, expnt(s) = [664.78712108]
bas 11, expnt(s) = [301.16041197]
bas 12, expnt(s) = [314.24124396]
bas 13, expnt(s) = [86.70018207]
bas 14, expnt(s) = [9.97198491]
bas 15, expnt(s) = [29.29068082]
bas 16, expnt(s) = [0.85812091]
bas 17, expnt(s) = [3.52750962]
bas 18, expnt(s) = [0.24183181]
CPU time:       615.81
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825439e+04 5.20024618e+03 7.61780497e+03 2.06009578e+03
 3.61730026e+03 1.17842906e+03 1.60416450e+03 6.40400557e+02
 3.74168162e+02 2.14938962e+02 1.04586233e+02 8.26267966e+01
 3.38520371e+01 3.54571341e+01 4.58382672e+00 7.91473117e+00
 3.94919520e-01 1.25862535e+00 1.36276291e+03 2.41551519e+04
 6.64787121e+02 9.84776416e+03 3.01160412e+02 3.66000557e+03
 3.14241244e+02 3.85978731e+03 8.67001821e+01 7.71808228e+02
 9.97198491e+00 5.16965318e+01 2.92906808e+01 1.98790774e+02
 8.58120910e-01 2.40946154e+00 3.52750962e+00 1.41032645e+01
 2.41831808e-01 4.94739027e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.972953497965676
cond(S) = 160470.2715332199
E1 = -728.8802429805024  E_coul = 203.12284460994312
init E= -525.757398370559
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558527724815302  LUMO = 1.18400580914897
  mo_energy =
[-1.18318187e+02 -1.21033913e+01 -9.44790751e+00 -9.44790751e+00
 -9.44790751e+00 -1.23029556e+00 -5.58527725e-01 -5.58527725e-01
 -5.58527725e-01  1.18400581e+00  1.18400581e+00  1.18400581e+00
  9.90134561e+00  9.90134561e+00  9.90134561e+00  4.92648008e+01
  4.92648008e+01  4.92648008e+01  7.16762423e+01  1.87773170e+02
  1.87773170e+02  1.87773170e+02  5.40929559e+02  5.90527869e+02
  5.90527869e+02  5.90527869e+02  1.45888776e+03  1.45888776e+03
  1.45888776e+03  2.59592399e+03  3.15580227e+03  3.15580227e+03
  3.15580227e+03  6.77021621e+03  6.77021621e+03  6.77021621e+03
  9.00612239e+03  2.53699839e+04  7.61186454e+04]
E1 = -728.1368446943927  E_coul = 201.67199879655473
cycle= 1 E= -526.464845897838  delta_E= -0.707  |g|= 0.184  |ddm|= 0.469
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.54837
diis-c [-0.30070965  1.        ]
  HOMO = -0.571046752747992  LUMO = 1.17489706432401
  mo_energy =
[-1.18588909e+02 -1.21979344e+01 -9.54896924e+00 -9.54896924e+00
 -9.54896924e+00 -1.24975067e+00 -5.71046753e-01 -5.71046753e-01
 -5.71046753e-01  1.17489706e+00  1.17489706e+00  1.17489706e+00
  9.83579990e+00  9.83579990e+00  9.83579990e+00  4.91313154e+01
  4.91313154e+01  4.91313154e+01  7.15171529e+01  1.87569030e+02
  1.87569030e+02  1.87569030e+02  5.40625311e+02  5.90259945e+02
  5.90259945e+02  5.90259945e+02  1.45856493e+03  1.45856493e+03
  1.45856493e+03  2.59546298e+03  3.15541245e+03  3.15541245e+03
  3.15541245e+03  6.76971076e+03  6.76971076e+03  6.76971076e+03
  9.00553884e+03  2.53693058e+04  7.61178765e+04]
E1 = -728.4219045721779  E_coul = 201.95669481080358
cycle= 2 E= -526.465209761374  delta_E= -0.000364  |g|= 0.024  |ddm|= 0.0199
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.046394
diis-c [-0.00139187  0.04798831  0.95201169]
  HOMO = -0.567595388242362  LUMO = 1.17802681833339
  mo_energy =
[-1.18547362e+02 -1.21784581e+01 -9.52910731e+00 -9.52910731e+00
 -9.52910731e+00 -1.24516849e+00 -5.67595388e-01 -5.67595388e-01
 -5.67595388e-01  1.17802682e+00  1.17802682e+00  1.17802682e+00
  9.84875146e+00  9.84875146e+00  9.84875146e+00  4.91558202e+01
  4.91558202e+01  4.91558202e+01  7.15497452e+01  1.87604016e+02
  1.87604016e+02  1.87604016e+02  5.40668188e+02  5.90301096e+02
  5.90301096e+02  5.90301096e+02  1.45860885e+03  1.45860885e+03
  1.45860885e+03  2.59550921e+03  3.15545798e+03  3.15545798e+03
  3.15545798e+03  6.76975730e+03  6.76975730e+03  6.76975730e+03
  9.00558580e+03  2.53693529e+04  7.61179237e+04]
E1 = -728.3637129118913  E_coul = 201.89849092884708
cycle= 3 E= -526.465221983044  delta_E= -1.22e-05  |g|= 0.0029  |ddm|= 0.00499
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00625921
diis-c [-3.60763635e-07 -1.09143141e-03  1.11969508e-01  8.89121923e-01]
  HOMO = -0.568216427297231  LUMO = 1.17748545921025
  mo_energy =
[-1.18552425e+02 -1.21811681e+01 -9.53192173e+00 -9.53192173e+00
 -9.53192173e+00 -1.24597578e+00 -5.68216427e-01 -5.68216427e-01
 -5.68216427e-01  1.17748546e+00  1.17748546e+00  1.17748546e+00
  9.84677617e+00  9.84677617e+00  9.84677617e+00  4.91525313e+01
  4.91525313e+01  4.91525313e+01  7.15457452e+01  1.87599648e+02
  1.87599648e+02  1.87599648e+02  5.40662962e+02  5.90296082e+02
  5.90296082e+02  5.90296082e+02  1.45860351e+03  1.45860351e+03
  1.45860351e+03  2.59550345e+03  3.15545239e+03  3.15545239e+03
  3.15545239e+03  6.76975146e+03  6.76975146e+03  6.76975146e+03
  9.00557982e+03  2.53693468e+04  7.61179175e+04]
E1 = -728.3715679654476  E_coul = 201.90634571648246
cycle= 4 E= -526.465222248965  delta_E= -2.66e-07  |g|= 4.09e-05  |ddm|= 0.000733
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.21018e-05
diis-c [-1.66207081e-09  1.04032859e-05 -2.04413260e-03 -1.06306563e-02
  1.01266439e+00]
  HOMO = -0.568190374595268  LUMO = 1.17750739915414
  mo_energy =
[-1.18552336e+02 -1.21810839e+01 -9.53183880e+00 -9.53183880e+00
 -9.53183880e+00 -1.24594193e+00 -5.68190375e-01 -5.68190375e-01
 -5.68190375e-01  1.17750740e+00  1.17750740e+00  1.17750740e+00
  9.84684275e+00  9.84684275e+00  9.84684275e+00  4.91526150e+01
  4.91526150e+01  4.91526150e+01  7.15458382e+01  1.87599737e+02
  1.87599737e+02  1.87599737e+02  5.40663049e+02  5.90296171e+02
  5.90296171e+02  5.90296171e+02  1.45860359e+03  1.45860359e+03
  1.45860359e+03  2.59550353e+03  3.15545247e+03  3.15545247e+03
  3.15545247e+03  6.76975153e+03  6.76975153e+03  6.76975153e+03
  9.00557989e+03  2.53693469e+04  7.61179176e+04]
E1 = -728.371375750186  E_coul = 201.9061535011001
cycle= 5 E= -526.465222249086  delta_E= -1.21e-10  |g|= 7.18e-06  |ddm|= 2.25e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.371375750186  E_coul = 201.9061535011001
  HOMO = -0.568194013095082  LUMO = 1.17750431471612
  mo_energy =
[-1.18552353e+02 -1.21810967e+01 -9.53185185e+00 -9.53185185e+00
 -9.53185185e+00 -1.24594665e+00 -5.68194013e-01 -5.68194013e-01
 -5.68194013e-01  1.17750431e+00  1.17750431e+00  1.17750431e+00
  9.84683278e+00  9.84683278e+00  9.84683278e+00  4.91526011e+01
  4.91526011e+01  4.91526011e+01  7.15458225e+01  1.87599721e+02
  1.87599721e+02  1.87599721e+02  5.40663031e+02  5.90296154e+02
  5.90296154e+02  5.90296154e+02  1.45860358e+03  1.45860358e+03
  1.45860358e+03  2.59550351e+03  3.15545245e+03  3.15545245e+03
  3.15545245e+03  6.76975151e+03  6.76975151e+03  6.76975151e+03
  9.00557987e+03  2.53693468e+04  7.61179176e+04]
E1 = -728.3714085948152  E_coul = 201.90618634572652
Extra cycle  E= -526.465222249089  delta_E= -2.84e-12  |g|= 1.81e-06  |ddm|= 3.55e-06
    CPU time for scf_cycle      0.67 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 160470.2715332199
E1 = -728.3714085948152  E_coul = 201.90618634572652
init E= -526.465222249089
    CPU time for initialize scf      3.16 sec, wall time      0.27 sec
  HOMO = -0.568193403653159  LUMO = 1.17750483962397
  mo_energy =
[-1.18552349e+02 -1.21810943e+01 -9.53184937e+00 -9.53184937e+00
 -9.53184937e+00 -1.24594586e+00 -5.68193404e-01 -5.68193404e-01
 -5.68193404e-01  1.17750484e+00  1.17750484e+00  1.17750484e+00
  9.84683459e+00  9.84683459e+00  9.84683459e+00  4.91526039e+01
  4.91526039e+01  4.91526039e+01  7.15458258e+01  1.87599725e+02
  1.87599725e+02  1.87599725e+02  5.40663035e+02  5.90296158e+02
  5.90296158e+02  5.90296158e+02  1.45860358e+03  1.45860358e+03
  1.45860358e+03  2.59550351e+03  3.15545246e+03  3.15545246e+03
  3.15545246e+03  6.76975152e+03  6.76975152e+03  6.76975152e+03
  9.00557988e+03  2.53693468e+04  7.61179176e+04]
E1 = -728.3714020164578  E_coul = 201.90617976736866
cycle= 1 E= -526.465222249089  delta_E= -3.41e-13  |g|= 3.95e-07  |ddm|= 6.51e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3714020164578  E_coul = 201.90617976736866
  HOMO = -0.568193518102851  LUMO = 1.17750474037414
  mo_energy =
[-1.18552350e+02 -1.21810948e+01 -9.53184987e+00 -9.53184987e+00
 -9.53184987e+00 -1.24594601e+00 -5.68193518e-01 -5.68193518e-01
 -5.68193518e-01  1.17750474e+00  1.17750474e+00  1.17750474e+00
  9.84683424e+00  9.84683424e+00  9.84683424e+00  4.91526033e+01
  4.91526033e+01  4.91526033e+01  7.15458251e+01  1.87599724e+02
  1.87599724e+02  1.87599724e+02  5.40663034e+02  5.90296157e+02
  5.90296157e+02  5.90296157e+02  1.45860358e+03  1.45860358e+03
  1.45860358e+03  2.59550351e+03  3.15545245e+03  3.15545245e+03
  3.15545245e+03  6.76975152e+03  6.76975152e+03  6.76975152e+03
  9.00557987e+03  2.53693468e+04  7.61179176e+04]
E1 = -728.3714033566666  E_coul = 201.90618110757882
Extra cycle  E= -526.465222249088  delta_E= 1.25e-12  |g|= 8.34e-08  |ddm|= 1.29e-07
    CPU time for scf_cycle      3.30 sec, wall time      0.42 sec
exp = [2.61825439e+04 7.61780497e+03 3.61730026e+03 1.60416450e+03
 3.74168162e+02 1.04586233e+02 3.38520371e+01 4.58382672e+00
 3.94919520e-01 1.36276291e+03 6.64787121e+02 3.01160412e+02
 3.14241244e+02 8.67001821e+01 9.97198491e+00 2.92906808e+01
 8.58120910e-01 3.52750962e+00 2.41831808e-01]
grad_E = [-1.54615753e-06  3.69840164e-06 -1.05129283e-06  7.95889323e-05
  4.00226667e-05 -4.10063727e-04 -3.38585036e-04  2.70483945e-03
  5.20443814e-03 -6.18046192e-07  5.39549682e-07  1.55278721e-06
  1.19124544e-06 -1.25259153e-04 -2.08091234e-03  3.12638368e-03
  3.00315830e-03 -2.80538710e-03  1.37275823e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:44:16 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5447217        1
[INPUT] 0    0    [1    /1   ]  7617.79437664        1
[INPUT] 0    0    [1    /1   ]  3617.27745772        1
[INPUT] 0    0    [1    /1   ]  1603.83034425        1
[INPUT] 0    0    [1    /1   ]  377.364309045        1
[INPUT] 0    0    [1    /1   ]  105.685435465        1
[INPUT] 0    0    [1    /1   ]  34.148356799         1
[INPUT] 0    0    [1    /1   ]  4.58685375402        1
[INPUT] 0    0    [1    /1   ]  0.393035759072       1
[INPUT] 1    0    [1    /1   ]  1362.76179542        1
[INPUT] 1    0    [1    /1   ]  664.774425383        1
[INPUT] 1    0    [1    /1   ]  301.089014256        1
[INPUT] 1    0    [1    /1   ]  314.178369132        1
[INPUT] 1    0    [1    /1   ]  89.3076269481        1
[INPUT] 1    0    [1    /1   ]  8.68467400308        1
[INPUT] 1    0    [1    /1   ]  24.9758594201        1
[INPUT] 1    0    [1    /1   ]  0.845693795685       1
[INPUT] 1    0    [1    /1   ]  3.23198334484        1
[INPUT] 1    0    [1    /1   ]  0.23733716832        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.544721675345, 1.0]], [0, [7617.794376640195, 1.0]], [0, [3617.2774577246196, 1.0]], [0, [1603.8303442527283, 1.0]], [0, [377.36430904499986, 1.0]], [0, [105.68543546511162, 1.0]], [0, [34.14835679896163, 1.0]], [0, [4.586853754021837, 1.0]], [0, [0.39303575907235505, 1.0]], [1, [1362.7617954154296, 1.0]], [1, [664.7744253829853, 1.0]], [1, [301.0890142555126, 1.0]], [1, [314.1783691324901, 1.0]], [1, [89.30762694813177, 1.0]], [1, [8.684674003080485, 1.0]], [1, [24.97585942013761, 1.0]], [1, [0.845693795685312, 1.0]], [1, [3.2319833448438597, 1.0]], [1, [0.23733716832032517, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.54472168]
bas 1, expnt(s) = [7617.79437664]
bas 2, expnt(s) = [3617.27745772]
bas 3, expnt(s) = [1603.83034425]
bas 4, expnt(s) = [377.36430904]
bas 5, expnt(s) = [105.68543547]
bas 6, expnt(s) = [34.1483568]
bas 7, expnt(s) = [4.58685375]
bas 8, expnt(s) = [0.39303576]
bas 9, expnt(s) = [1362.76179542]
bas 10, expnt(s) = [664.77442538]
bas 11, expnt(s) = [301.08901426]
bas 12, expnt(s) = [314.17836913]
bas 13, expnt(s) = [89.30762695]
bas 14, expnt(s) = [8.684674]
bas 15, expnt(s) = [24.97585942]
bas 16, expnt(s) = [0.8456938]
bas 17, expnt(s) = [3.23198334]
bas 18, expnt(s) = [0.23733717]
CPU time:       624.57
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825447e+04 5.20024631e+03 7.61779438e+03 2.06009363e+03
 3.61727746e+03 1.17842349e+03 1.60383034e+03 6.40300504e+02
 3.77364309e+02 2.16314504e+02 1.05685435e+02 8.32772509e+01
 3.41483568e+01 3.56896577e+01 4.58685375e+00 7.91865085e+00
 3.93035759e-01 1.25411994e+00 1.36276180e+03 2.41551273e+04
 6.64774425e+02 9.84752907e+03 3.01089014e+02 3.65892098e+03
 3.14178369e+02 3.85882198e+03 8.93076269e+01 8.00930956e+02
 8.68467400e+00 4.34936939e+01 2.49758594e+01 1.62886445e+02
 8.45693796e-01 2.36592418e+00 3.23198334e+00 1.26421455e+01
 2.37337168e-01 4.83271949e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.974196117169665
cond(S) = 155485.8199205642
E1 = -728.8370778587017  E_coul = 203.0966109701013
init E= -525.7404668886
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559558995269251  LUMO = 1.15134146939298
  mo_energy =
[-1.18320870e+02 -1.21050538e+01 -9.44880057e+00 -9.44880057e+00
 -9.44880057e+00 -1.23108718e+00 -5.59558995e-01 -5.59558995e-01
 -5.59558995e-01  1.15134147e+00  1.15134147e+00  1.15134147e+00
  8.86045669e+00  8.86045669e+00  8.86045669e+00  4.18552466e+01
  4.18552466e+01  4.18552466e+01  7.26797555e+01  1.72666132e+02
  1.72666132e+02  1.72666132e+02  5.47050932e+02  5.77386767e+02
  5.77386767e+02  5.77386767e+02  1.44842513e+03  1.44842513e+03
  1.44842513e+03  2.60933926e+03  3.14675361e+03  3.14675361e+03
  3.14675361e+03  6.76217277e+03  6.76217277e+03  6.76217277e+03
  9.02158321e+03  2.53852359e+04  7.61329652e+04]
E1 = -728.0502680802888  E_coul = 201.58994800143043
cycle= 1 E= -526.460320078858  delta_E= -0.72  |g|= 0.185  |ddm|= 0.818
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.547782
diis-c [-0.30006503  1.        ]
  HOMO = -0.573957889463468  LUMO = 1.1411421384744
  mo_energy =
[-1.18598766e+02 -1.22030424e+01 -9.55305204e+00 -9.55305204e+00
 -9.55305204e+00 -1.25257818e+00 -5.73957889e-01 -5.73957889e-01
 -5.73957889e-01  1.14114214e+00  1.14114214e+00  1.14114214e+00
  8.79733582e+00  8.79733582e+00  8.79733582e+00  4.17277073e+01
  4.17277073e+01  4.17277073e+01  7.25152707e+01  1.72455640e+02
  1.72455640e+02  1.72455640e+02  5.46738243e+02  5.77110686e+02
  5.77110686e+02  5.77110686e+02  1.44809399e+03  1.44809399e+03
  1.44809399e+03  2.60887008e+03  3.14635563e+03  3.14635563e+03
  3.14635563e+03  6.76165927e+03  6.76165927e+03  6.76165927e+03
  9.02099180e+03  2.53845498e+04  7.61321884e+04]
E1 = -728.3486541475878  E_coul = 201.88795422500218
cycle= 2 E= -526.460699922586  delta_E= -0.00038  |g|= 0.0246  |ddm|= 0.0204
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0472577
diis-c [-0.00142804  0.04936392  0.95063608]
  HOMO = -0.570291141619049  LUMO = 1.14434912249401
  mo_energy =
[-1.18555815e+02 -1.21826342e+01 -9.53223286e+00 -9.53223286e+00
 -9.53223286e+00 -1.24771657e+00 -5.70291142e-01 -5.70291142e-01
 -5.70291142e-01  1.14434912e+00  1.14434912e+00  1.14434912e+00
  8.80987528e+00  8.80987528e+00  8.80987528e+00  4.17516661e+01
  4.17516661e+01  4.17516661e+01  7.25491885e+01  1.72491869e+02
  1.72491869e+02  1.72491869e+02  5.46782611e+02  5.77153383e+02
  5.77153383e+02  5.77153383e+02  1.44813944e+03  1.44813944e+03
  1.44813944e+03  2.60891789e+03  3.14640271e+03  3.14640271e+03
  3.14640271e+03  6.76170742e+03  6.76170742e+03  6.76170742e+03
  9.02104039e+03  2.53845986e+04  7.61322373e+04]
E1 = -728.2871172374347  E_coul = 201.82640396423386
cycle= 3 E= -526.460713273201  delta_E= -1.34e-05  |g|= 0.00301  |ddm|= 0.00526
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00639687
diis-c [-3.45212223e-07 -1.07069592e-03  1.12565313e-01  8.88505383e-01]
  HOMO = -0.570952030074024  LUMO = 1.1437910672973
  mo_energy =
[-1.18561085e+02 -1.21854851e+01 -9.53518844e+00 -9.53518844e+00
 -9.53518844e+00 -1.24857300e+00 -5.70952030e-01 -5.70952030e-01
 -5.70952030e-01  1.14379107e+00  1.14379107e+00  1.14379107e+00
  8.80792836e+00  8.80792836e+00  8.80792836e+00  4.17483939e+01
  4.17483939e+01  4.17483939e+01  7.25449924e+01  1.72487312e+02
  1.72487312e+02  1.72487312e+02  5.46777172e+02  5.77148150e+02
  5.77148150e+02  5.77148150e+02  1.44813388e+03  1.44813388e+03
  1.44813388e+03  2.60891192e+03  3.14639690e+03  3.14639690e+03
  3.14639690e+03  6.76170136e+03  6.76170136e+03  6.76170136e+03
  9.02103420e+03  2.53845923e+04  7.61322309e+04]
E1 = -728.2954595387345  E_coul = 201.83474597039654
cycle= 4 E= -526.460713568338  delta_E= -2.95e-07  |g|= 4.28e-05  |ddm|= 0.00077
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.5338e-05
diis-c [-1.72923934e-09  2.96782035e-06 -1.28996624e-03 -3.98331075e-03
  1.00527031e+00]
  HOMO = -0.570924845446411  LUMO = 1.14381330071737
  mo_energy =
[-1.18560990e+02 -1.21853967e+01 -9.53510104e+00 -9.53510104e+00
 -9.53510104e+00 -1.24853765e+00 -5.70924845e-01 -5.70924845e-01
 -5.70924845e-01  1.14381330e+00  1.14381330e+00  1.14381330e+00
  8.80799527e+00  8.80799527e+00  8.80799527e+00  4.17484805e+01
  4.17484805e+01  4.17484805e+01  7.25450901e+01  1.72487407e+02
  1.72487407e+02  1.72487407e+02  5.46777264e+02  5.77148244e+02
  5.77148244e+02  5.77148244e+02  1.44813397e+03  1.44813397e+03
  1.44813397e+03  2.60891200e+03  3.14639699e+03  3.14639699e+03
  3.14639699e+03  6.76170145e+03  6.76170145e+03  6.76170145e+03
  9.02103428e+03  2.53845924e+04  7.61322310e+04]
E1 = -728.2952514006375  E_coul = 201.8345378321592
cycle= 5 E= -526.460713568478  delta_E= -1.4e-10  |g|= 7.3e-06  |ddm|= 2.42e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.2952514006375  E_coul = 201.8345378321592
  HOMO = -0.570928520952367  LUMO = 1.14381027329714
  mo_energy =
[-1.18561008e+02 -1.21854096e+01 -9.53511420e+00 -9.53511420e+00
 -9.53511420e+00 -1.24854240e+00 -5.70928521e-01 -5.70928521e-01
 -5.70928521e-01  1.14381027e+00  1.14381027e+00  1.14381027e+00
  8.80798571e+00  8.80798571e+00  8.80798571e+00  4.17484668e+01
  4.17484668e+01  4.17484668e+01  7.25450742e+01  1.72487390e+02
  1.72487390e+02  1.72487390e+02  5.46777246e+02  5.77148226e+02
  5.77148226e+02  5.77148226e+02  1.44813396e+03  1.44813396e+03
  1.44813396e+03  2.60891198e+03  3.14639697e+03  3.14639697e+03
  3.14639697e+03  6.76170143e+03  6.76170143e+03  6.76170143e+03
  9.02103426e+03  2.53845924e+04  7.61322309e+04]
E1 = -728.2952852260697  E_coul = 201.8345716575875
Extra cycle  E= -526.460713568482  delta_E= -3.87e-12  |g|= 1.85e-06  |ddm|= 3.59e-06
    CPU time for scf_cycle      0.68 sec, wall time      0.29 sec
exp = [2.61825447e+04 7.61779438e+03 3.61727746e+03 1.60383034e+03
 3.77364309e+02 1.05685435e+02 3.41483568e+01 4.58685375e+00
 3.93035759e-01 1.36276180e+03 6.64774425e+02 3.01089014e+02
 3.14178369e+02 8.93076269e+01 8.68467400e+00 2.49758594e+01
 8.45693796e-01 3.23198334e+00 2.37337168e-01]
E = -526.4607135684822
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:44:16 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.544166         1
[INPUT] 0    0    [1    /1   ]  7617.80122595        1
[INPUT] 0    0    [1    /1   ]  3617.29220462        1
[INPUT] 0    0    [1    /1   ]  1604.04644231        1
[INPUT] 0    0    [1    /1   ]  375.297385332        1
[INPUT] 0    0    [1    /1   ]  104.974589893        1
[INPUT] 0    0    [1    /1   ]  33.9567291383        1
[INPUT] 0    0    [1    /1   ]  4.58489619539        1
[INPUT] 0    0    [1    /1   ]  0.394253972961       1
[INPUT] 1    0    [1    /1   ]  1362.76251558        1
[INPUT] 1    0    [1    /1   ]  664.782635592        1
[INPUT] 1    0    [1    /1   ]  301.135186602        1
[INPUT] 1    0    [1    /1   ]  314.219029798        1
[INPUT] 1    0    [1    /1   ]  87.6214125844        1
[INPUT] 1    0    [1    /1   ]  9.51716797642        1
[INPUT] 1    0    [1    /1   ]  27.7662209297        1
[INPUT] 1    0    [1    /1   ]  0.853730314004       1
[INPUT] 1    0    [1    /1   ]  3.42309789142        1
[INPUT] 1    0    [1    /1   ]  0.240243816683       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.54416597394, 1.0]], [0, [7617.801225945028, 1.0]], [0, [3617.292204624727, 1.0]], [0, [1604.0464423080887, 1.0]], [0, [375.297385331926, 1.0]], [0, [104.97458989342371, 1.0]], [0, [33.956729138328924, 1.0]], [0, [4.5848961953907255, 1.0]], [0, [0.39425397296121295, 1.0]], [1, [1362.7625155834971, 1.0]], [1, [664.7826355924132, 1.0]], [1, [301.13518660225185, 1.0]], [1, [314.2190297975472, 1.0]], [1, [87.62141258443391, 1.0]], [1, [9.517167976421295, 1.0]], [1, [27.76622092970265, 1.0]], [1, [0.853730314004301, 1.0]], [1, [3.4230978914200474, 1.0]], [1, [0.24024381668274358, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.54416597]
bas 1, expnt(s) = [7617.80122595]
bas 2, expnt(s) = [3617.29220462]
bas 3, expnt(s) = [1604.04644231]
bas 4, expnt(s) = [375.29738533]
bas 5, expnt(s) = [104.97458989]
bas 6, expnt(s) = [33.95672914]
bas 7, expnt(s) = [4.5848962]
bas 8, expnt(s) = [0.39425397]
bas 9, expnt(s) = [1362.76251558]
bas 10, expnt(s) = [664.78263559]
bas 11, expnt(s) = [301.1351866]
bas 12, expnt(s) = [314.2190298]
bas 13, expnt(s) = [87.62141258]
bas 14, expnt(s) = [9.51716798]
bas 15, expnt(s) = [27.76622093]
bas 16, expnt(s) = [0.85373031]
bas 17, expnt(s) = [3.42309789]
bas 18, expnt(s) = [0.24024382]
CPU time:       625.50
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825442e+04 5.20024623e+03 7.61780123e+03 2.06009502e+03
 3.61729220e+03 1.17842709e+03 1.60404644e+03 6.40365208e+02
 3.75297385e+02 2.15425286e+02 1.04974590e+02 8.28568015e+01
 3.39567291e+01 3.55393444e+01 4.58489620e+00 7.91611610e+00
 3.94253973e-01 1.25703417e+00 1.36276252e+03 2.41551432e+04
 6.64782636e+02 9.84768110e+03 3.01135187e+02 3.65962236e+03
 3.14219030e+02 3.85944625e+03 8.76214126e+01 7.82072843e+02
 9.51716798e+00 4.87662163e+01 2.77662209e+01 1.85943226e+02
 8.53730314e-01 2.39406132e+00 3.42309789e+00 1.35834016e+01
 2.40243817e-01 4.90681479e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.973431952865635
cond(S) = 158626.7856067754
E1 = -728.8745607729979  E_coul = 203.11449029520978
init E= -525.760070477788
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558931244775636  LUMO = 1.17242186076788
  mo_energy =
[-1.18318965e+02 -1.21039294e+01 -9.44880822e+00 -9.44880822e+00
 -9.44880822e+00 -1.23055734e+00 -5.58931245e-01 -5.58931245e-01
 -5.58931245e-01  1.17242186e+00  1.17242186e+00  1.17242186e+00
  9.52366565e+00  9.52366565e+00  9.52366565e+00  4.66502954e+01
  4.66502954e+01  4.66502954e+01  7.20302587e+01  1.82524672e+02
  1.82524672e+02  1.82524672e+02  5.43092762e+02  5.85866881e+02
  5.85866881e+02  5.85866881e+02  1.45513339e+03  1.45513339e+03
  1.45513339e+03  2.60066694e+03  3.15253429e+03  3.15253429e+03
  3.15253429e+03  6.76730153e+03  6.76730153e+03  6.76730153e+03
  9.01158536e+03  2.53753718e+04  7.61237034e+04]
E1 = -728.1167589018127  E_coul = 201.6493114399747
cycle= 1 E= -526.467447461838  delta_E= -0.707  |g|= 0.184  |ddm|= 0.435
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.547979
diis-c [-0.30028069  1.        ]
  HOMO = -0.572076865904168  LUMO = 1.16295251695831
  mo_energy =
[-1.18590958e+02 -1.21993677e+01 -9.55068614e+00 -9.55068614e+00
 -9.55068614e+00 -1.25067496e+00 -5.72076866e-01 -5.72076866e-01
 -5.72076866e-01  1.16295252e+00  1.16295252e+00  1.16295252e+00
  9.45915272e+00  9.45915272e+00  9.45915272e+00  4.65190563e+01
  4.65190563e+01  4.65190563e+01  7.18699961e+01  1.82319257e+02
  1.82319257e+02  1.82319257e+02  5.42786904e+02  5.85597334e+02
  5.85597334e+02  5.85597334e+02  1.45480906e+03  1.45480906e+03
  1.45480906e+03  2.60020459e+03  3.15214309e+03  3.15214309e+03
  3.15214309e+03  6.76679480e+03  6.76679480e+03  6.76679480e+03
  9.01100062e+03  2.53746924e+04  7.61229334e+04]
E1 = -728.4054664267197  E_coul = 201.93765209199168
cycle= 2 E= -526.467814334728  delta_E= -0.000367  |g|= 0.0241  |ddm|= 0.02
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0465381
diis-c [-0.00139976  0.04818655  0.95181345]
  HOMO = -0.568560960947461  LUMO = 1.16610115528508
  mo_energy =
[-1.18549058e+02 -1.21796265e+01 -9.53055335e+00 -9.53055335e+00
 -9.53055335e+00 -1.24600933e+00 -5.68560961e-01 -5.68560961e-01
 -5.68560961e-01  1.16610116e+00  1.16610116e+00  1.16610116e+00
  9.47193010e+00  9.47193010e+00  9.47193010e+00  4.65433378e+01
  4.65433378e+01  4.65433378e+01  7.19029490e+01  1.82354557e+02
  1.82354557e+02  1.82354557e+02  5.42830155e+02  5.85638884e+02
  5.85638884e+02  5.85638884e+02  1.45485337e+03  1.45485337e+03
  1.45485337e+03  2.60025120e+03  3.15218900e+03  3.15218900e+03
  3.15218900e+03  6.76684172e+03  6.76684172e+03  6.76684172e+03
  9.01104797e+03  2.53747399e+04  7.61229810e+04]
E1 = -728.3463029718229  E_coul = 201.87847611945048
cycle= 3 E= -526.467826852372  delta_E= -1.25e-05  |g|= 0.00293  |ddm|= 0.00506
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00630991
diis-c [-3.58509463e-07 -1.08986373e-03  1.12541355e-01  8.88548509e-01]
  HOMO = -0.569194415067427  LUMO = 1.16555499245996
  mo_energy =
[-1.18554188e+02 -1.21823809e+01 -9.53341236e+00 -9.53341236e+00
 -9.53341236e+00 -1.24683188e+00 -5.69194415e-01 -5.69194415e-01
 -5.69194415e-01  1.16555499e+00  1.16555499e+00  1.16555499e+00
  9.46996689e+00  9.46996689e+00  9.46996689e+00  4.65400543e+01
  4.65400543e+01  4.65400543e+01  7.18988861e+01  1.82350130e+02
  1.82350130e+02  1.82350130e+02  5.42824860e+02  5.85633799e+02
  5.85633799e+02  5.85633799e+02  1.45484795e+03  1.45484795e+03
  1.45484795e+03  2.60024537e+03  3.15218334e+03  3.15218334e+03
  3.15218334e+03  6.76683581e+03  6.76683581e+03  6.76683581e+03
  9.01104192e+03  2.53747338e+04  7.61229747e+04]
E1 = -728.3543168887865  E_coul = 201.8864897610948
cycle= 4 E= -526.467827127692  delta_E= -2.75e-07  |g|= 4.11e-05  |ddm|= 0.000744
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.25402e-05
diis-c [-1.68027625e-09  8.52357696e-06 -1.85998803e-03 -9.03282533e-03
  1.01088429e+00]
  HOMO = -0.569168131761506  LUMO = 1.16557690556617
  mo_energy =
[-1.18554097e+02 -1.21822959e+01 -9.53332854e+00 -9.53332854e+00
 -9.53332854e+00 -1.24679772e+00 -5.69168132e-01 -5.69168132e-01
 -5.69168132e-01  1.16557691e+00  1.16557691e+00  1.16557691e+00
  9.47003316e+00  9.47003316e+00  9.47003316e+00  4.65401384e+01
  4.65401384e+01  4.65401384e+01  7.18989799e+01  1.82350220e+02
  1.82350220e+02  1.82350220e+02  5.42824947e+02  5.85633889e+02
  5.85633889e+02  5.85633889e+02  1.45484804e+03  1.45484804e+03
  1.45484804e+03  2.60024545e+03  3.15218342e+03  3.15218342e+03
  3.15218342e+03  6.76683589e+03  6.76683589e+03  6.76683589e+03
  9.01104199e+03  2.53747338e+04  7.61229748e+04]
E1 = -728.354120987062  E_coul = 201.88629385924528
cycle= 5 E= -526.467827127817  delta_E= -1.25e-10  |g|= 7.22e-06  |ddm|= 2.29e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.354120987062  E_coul = 201.88629385924528
  HOMO = -0.569171787309594  LUMO = 1.16557383739493
  mo_energy =
[-1.18554115e+02 -1.21823088e+01 -9.53334164e+00 -9.53334164e+00
 -9.53334164e+00 -1.24680246e+00 -5.69171787e-01 -5.69171787e-01
 -5.69171787e-01  1.16557384e+00  1.16557384e+00  1.16557384e+00
  9.47002332e+00  9.47002332e+00  9.47002332e+00  4.65401245e+01
  4.65401245e+01  4.65401245e+01  7.18989641e+01  1.82350204e+02
  1.82350204e+02  1.82350204e+02  5.42824929e+02  5.85633872e+02
  5.85633872e+02  5.85633872e+02  1.45484802e+03  1.45484802e+03
  1.45484802e+03  2.60024543e+03  3.15218340e+03  3.15218340e+03
  3.15218340e+03  6.76683587e+03  6.76683587e+03  6.76683587e+03
  9.01104198e+03  2.53747338e+04  7.61229748e+04]
E1 = -728.354154207449  E_coul = 201.88632707962876
Extra cycle  E= -526.46782712782  delta_E= -3.64e-12  |g|= 1.82e-06  |ddm|= 3.56e-06
    CPU time for scf_cycle      0.69 sec, wall time      0.30 sec
exp = [2.61825442e+04 7.61780123e+03 3.61729220e+03 1.60404644e+03
 3.75297385e+02 1.04974590e+02 3.39567291e+01 4.58489620e+00
 3.94253973e-01 1.36276252e+03 6.64782636e+02 3.01135187e+02
 3.14219030e+02 8.76214126e+01 9.51716798e+00 2.77662209e+01
 8.53730314e-01 3.42309789e+00 2.40243817e-01]
E = -526.4678271278203
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:44:17 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.544166         1
[INPUT] 0    0    [1    /1   ]  7617.80122595        1
[INPUT] 0    0    [1    /1   ]  3617.29220462        1
[INPUT] 0    0    [1    /1   ]  1604.04644231        1
[INPUT] 0    0    [1    /1   ]  375.297385332        1
[INPUT] 0    0    [1    /1   ]  104.974589893        1
[INPUT] 0    0    [1    /1   ]  33.9567291383        1
[INPUT] 0    0    [1    /1   ]  4.58489619539        1
[INPUT] 0    0    [1    /1   ]  0.394253972961       1
[INPUT] 1    0    [1    /1   ]  1362.76251558        1
[INPUT] 1    0    [1    /1   ]  664.782635592        1
[INPUT] 1    0    [1    /1   ]  301.135186602        1
[INPUT] 1    0    [1    /1   ]  314.219029798        1
[INPUT] 1    0    [1    /1   ]  87.6214125844        1
[INPUT] 1    0    [1    /1   ]  9.51716797642        1
[INPUT] 1    0    [1    /1   ]  27.7662209297        1
[INPUT] 1    0    [1    /1   ]  0.853730314004       1
[INPUT] 1    0    [1    /1   ]  3.42309789142        1
[INPUT] 1    0    [1    /1   ]  0.240243816683       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.54416597394, 1.0]], [0, [7617.801225945028, 1.0]], [0, [3617.292204624727, 1.0]], [0, [1604.0464423080887, 1.0]], [0, [375.297385331926, 1.0]], [0, [104.97458989342371, 1.0]], [0, [33.956729138328924, 1.0]], [0, [4.5848961953907255, 1.0]], [0, [0.39425397296121295, 1.0]], [1, [1362.7625155834971, 1.0]], [1, [664.7826355924132, 1.0]], [1, [301.13518660225185, 1.0]], [1, [314.2190297975472, 1.0]], [1, [87.62141258443391, 1.0]], [1, [9.517167976421295, 1.0]], [1, [27.76622092970265, 1.0]], [1, [0.853730314004301, 1.0]], [1, [3.4230978914200474, 1.0]], [1, [0.24024381668274358, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.54416597]
bas 1, expnt(s) = [7617.80122595]
bas 2, expnt(s) = [3617.29220462]
bas 3, expnt(s) = [1604.04644231]
bas 4, expnt(s) = [375.29738533]
bas 5, expnt(s) = [104.97458989]
bas 6, expnt(s) = [33.95672914]
bas 7, expnt(s) = [4.5848962]
bas 8, expnt(s) = [0.39425397]
bas 9, expnt(s) = [1362.76251558]
bas 10, expnt(s) = [664.78263559]
bas 11, expnt(s) = [301.1351866]
bas 12, expnt(s) = [314.2190298]
bas 13, expnt(s) = [87.62141258]
bas 14, expnt(s) = [9.51716798]
bas 15, expnt(s) = [27.76622093]
bas 16, expnt(s) = [0.85373031]
bas 17, expnt(s) = [3.42309789]
bas 18, expnt(s) = [0.24024382]
CPU time:       626.44
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825442e+04 5.20024623e+03 7.61780123e+03 2.06009502e+03
 3.61729220e+03 1.17842709e+03 1.60404644e+03 6.40365208e+02
 3.75297385e+02 2.15425286e+02 1.04974590e+02 8.28568015e+01
 3.39567291e+01 3.55393444e+01 4.58489620e+00 7.91611610e+00
 3.94253973e-01 1.25703417e+00 1.36276252e+03 2.41551432e+04
 6.64782636e+02 9.84768110e+03 3.01135187e+02 3.65962236e+03
 3.14219030e+02 3.85944625e+03 8.76214126e+01 7.82072843e+02
 9.51716798e+00 4.87662163e+01 2.77662209e+01 1.85943226e+02
 8.53730314e-01 2.39406132e+00 3.42309789e+00 1.35834016e+01
 2.40243817e-01 4.90681479e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.973431952865635
cond(S) = 158626.7856067754
E1 = -728.8745607729979  E_coul = 203.11449029520978
init E= -525.760070477788
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558931244775636  LUMO = 1.17242186076788
  mo_energy =
[-1.18318965e+02 -1.21039294e+01 -9.44880822e+00 -9.44880822e+00
 -9.44880822e+00 -1.23055734e+00 -5.58931245e-01 -5.58931245e-01
 -5.58931245e-01  1.17242186e+00  1.17242186e+00  1.17242186e+00
  9.52366565e+00  9.52366565e+00  9.52366565e+00  4.66502954e+01
  4.66502954e+01  4.66502954e+01  7.20302587e+01  1.82524672e+02
  1.82524672e+02  1.82524672e+02  5.43092762e+02  5.85866881e+02
  5.85866881e+02  5.85866881e+02  1.45513339e+03  1.45513339e+03
  1.45513339e+03  2.60066694e+03  3.15253429e+03  3.15253429e+03
  3.15253429e+03  6.76730153e+03  6.76730153e+03  6.76730153e+03
  9.01158536e+03  2.53753718e+04  7.61237034e+04]
E1 = -728.1167589018127  E_coul = 201.6493114399747
cycle= 1 E= -526.467447461838  delta_E= -0.707  |g|= 0.184  |ddm|= 0.435
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.547979
diis-c [-0.30028069  1.        ]
  HOMO = -0.572076865904168  LUMO = 1.16295251695831
  mo_energy =
[-1.18590958e+02 -1.21993677e+01 -9.55068614e+00 -9.55068614e+00
 -9.55068614e+00 -1.25067496e+00 -5.72076866e-01 -5.72076866e-01
 -5.72076866e-01  1.16295252e+00  1.16295252e+00  1.16295252e+00
  9.45915272e+00  9.45915272e+00  9.45915272e+00  4.65190563e+01
  4.65190563e+01  4.65190563e+01  7.18699961e+01  1.82319257e+02
  1.82319257e+02  1.82319257e+02  5.42786904e+02  5.85597334e+02
  5.85597334e+02  5.85597334e+02  1.45480906e+03  1.45480906e+03
  1.45480906e+03  2.60020459e+03  3.15214309e+03  3.15214309e+03
  3.15214309e+03  6.76679480e+03  6.76679480e+03  6.76679480e+03
  9.01100062e+03  2.53746924e+04  7.61229334e+04]
E1 = -728.4054664267197  E_coul = 201.93765209199168
cycle= 2 E= -526.467814334728  delta_E= -0.000367  |g|= 0.0241  |ddm|= 0.02
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0465381
diis-c [-0.00139976  0.04818655  0.95181345]
  HOMO = -0.568560960947461  LUMO = 1.16610115528508
  mo_energy =
[-1.18549058e+02 -1.21796265e+01 -9.53055335e+00 -9.53055335e+00
 -9.53055335e+00 -1.24600933e+00 -5.68560961e-01 -5.68560961e-01
 -5.68560961e-01  1.16610116e+00  1.16610116e+00  1.16610116e+00
  9.47193010e+00  9.47193010e+00  9.47193010e+00  4.65433378e+01
  4.65433378e+01  4.65433378e+01  7.19029490e+01  1.82354557e+02
  1.82354557e+02  1.82354557e+02  5.42830155e+02  5.85638884e+02
  5.85638884e+02  5.85638884e+02  1.45485337e+03  1.45485337e+03
  1.45485337e+03  2.60025120e+03  3.15218900e+03  3.15218900e+03
  3.15218900e+03  6.76684172e+03  6.76684172e+03  6.76684172e+03
  9.01104797e+03  2.53747399e+04  7.61229810e+04]
E1 = -728.3463029718229  E_coul = 201.87847611945048
cycle= 3 E= -526.467826852372  delta_E= -1.25e-05  |g|= 0.00293  |ddm|= 0.00506
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00630991
diis-c [-3.58509463e-07 -1.08986373e-03  1.12541355e-01  8.88548509e-01]
  HOMO = -0.569194415067427  LUMO = 1.16555499245996
  mo_energy =
[-1.18554188e+02 -1.21823809e+01 -9.53341236e+00 -9.53341236e+00
 -9.53341236e+00 -1.24683188e+00 -5.69194415e-01 -5.69194415e-01
 -5.69194415e-01  1.16555499e+00  1.16555499e+00  1.16555499e+00
  9.46996689e+00  9.46996689e+00  9.46996689e+00  4.65400543e+01
  4.65400543e+01  4.65400543e+01  7.18988861e+01  1.82350130e+02
  1.82350130e+02  1.82350130e+02  5.42824860e+02  5.85633799e+02
  5.85633799e+02  5.85633799e+02  1.45484795e+03  1.45484795e+03
  1.45484795e+03  2.60024537e+03  3.15218334e+03  3.15218334e+03
  3.15218334e+03  6.76683581e+03  6.76683581e+03  6.76683581e+03
  9.01104192e+03  2.53747338e+04  7.61229747e+04]
E1 = -728.3543168887865  E_coul = 201.8864897610948
cycle= 4 E= -526.467827127692  delta_E= -2.75e-07  |g|= 4.11e-05  |ddm|= 0.000744
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.25402e-05
diis-c [-1.68027625e-09  8.52357696e-06 -1.85998803e-03 -9.03282533e-03
  1.01088429e+00]
  HOMO = -0.569168131761506  LUMO = 1.16557690556617
  mo_energy =
[-1.18554097e+02 -1.21822959e+01 -9.53332854e+00 -9.53332854e+00
 -9.53332854e+00 -1.24679772e+00 -5.69168132e-01 -5.69168132e-01
 -5.69168132e-01  1.16557691e+00  1.16557691e+00  1.16557691e+00
  9.47003316e+00  9.47003316e+00  9.47003316e+00  4.65401384e+01
  4.65401384e+01  4.65401384e+01  7.18989799e+01  1.82350220e+02
  1.82350220e+02  1.82350220e+02  5.42824947e+02  5.85633889e+02
  5.85633889e+02  5.85633889e+02  1.45484804e+03  1.45484804e+03
  1.45484804e+03  2.60024545e+03  3.15218342e+03  3.15218342e+03
  3.15218342e+03  6.76683589e+03  6.76683589e+03  6.76683589e+03
  9.01104199e+03  2.53747338e+04  7.61229748e+04]
E1 = -728.354120987062  E_coul = 201.88629385924528
cycle= 5 E= -526.467827127817  delta_E= -1.25e-10  |g|= 7.22e-06  |ddm|= 2.29e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.354120987062  E_coul = 201.88629385924528
  HOMO = -0.569171787309594  LUMO = 1.16557383739493
  mo_energy =
[-1.18554115e+02 -1.21823088e+01 -9.53334164e+00 -9.53334164e+00
 -9.53334164e+00 -1.24680246e+00 -5.69171787e-01 -5.69171787e-01
 -5.69171787e-01  1.16557384e+00  1.16557384e+00  1.16557384e+00
  9.47002332e+00  9.47002332e+00  9.47002332e+00  4.65401245e+01
  4.65401245e+01  4.65401245e+01  7.18989641e+01  1.82350204e+02
  1.82350204e+02  1.82350204e+02  5.42824929e+02  5.85633872e+02
  5.85633872e+02  5.85633872e+02  1.45484802e+03  1.45484802e+03
  1.45484802e+03  2.60024543e+03  3.15218340e+03  3.15218340e+03
  3.15218340e+03  6.76683587e+03  6.76683587e+03  6.76683587e+03
  9.01104198e+03  2.53747338e+04  7.61229748e+04]
E1 = -728.354154207449  E_coul = 201.88632707962876
Extra cycle  E= -526.46782712782  delta_E= -3.64e-12  |g|= 1.82e-06  |ddm|= 3.56e-06
    CPU time for scf_cycle      0.68 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 158626.7856067754
E1 = -728.354154207449  E_coul = 201.88632707962876
init E= -526.46782712782
    CPU time for initialize scf      2.74 sec, wall time      0.25 sec
  HOMO = -0.569171170089689  LUMO = 1.16557436345155
  mo_energy =
[-1.18554111e+02 -1.21823063e+01 -9.53333914e+00 -9.53333914e+00
 -9.53333914e+00 -1.24680166e+00 -5.69171170e-01 -5.69171170e-01
 -5.69171170e-01  1.16557436e+00  1.16557436e+00  1.16557436e+00
  9.47002511e+00  9.47002511e+00  9.47002511e+00  4.65401273e+01
  4.65401273e+01  4.65401273e+01  7.18989675e+01  1.82350207e+02
  1.82350207e+02  1.82350207e+02  5.42824933e+02  5.85633876e+02
  5.85633876e+02  5.85633876e+02  1.45484802e+03  1.45484802e+03
  1.45484802e+03  2.60024543e+03  3.15218340e+03  3.15218340e+03
  3.15218340e+03  6.76683587e+03  6.76683587e+03  6.76683587e+03
  9.01104198e+03  2.53747338e+04  7.61229748e+04]
E1 = -728.3541475152966  E_coul = 201.88632038747667
cycle= 1 E= -526.46782712782  delta_E= 3.41e-13  |g|= 4.01e-07  |ddm|= 6.59e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3541475152966  E_coul = 201.88632038747667
  HOMO = -0.569171286791759  LUMO = 1.16557426332939
  mo_energy =
[-1.18554112e+02 -1.21823068e+01 -9.53333964e+00 -9.53333964e+00
 -9.53333964e+00 -1.24680181e+00 -5.69171287e-01 -5.69171287e-01
 -5.69171287e-01  1.16557426e+00  1.16557426e+00  1.16557426e+00
  9.47002476e+00  9.47002476e+00  9.47002476e+00  4.65401267e+01
  4.65401267e+01  4.65401267e+01  7.18989668e+01  1.82350207e+02
  1.82350207e+02  1.82350207e+02  5.42824932e+02  5.85633875e+02
  5.85633875e+02  5.85633875e+02  1.45484802e+03  1.45484802e+03
  1.45484802e+03  2.60024543e+03  3.15218340e+03  3.15218340e+03
  3.15218340e+03  6.76683587e+03  6.76683587e+03  6.76683587e+03
  9.01104198e+03  2.53747338e+04  7.61229748e+04]
E1 = -728.3541488859023  E_coul = 201.8863217580815
Extra cycle  E= -526.467827127821  delta_E= -7.96e-13  |g|= 8.49e-08  |ddm|= 1.31e-07
    CPU time for scf_cycle      3.13 sec, wall time      0.64 sec
exp = [2.61825442e+04 7.61780123e+03 3.61729220e+03 1.60404644e+03
 3.75297385e+02 1.04974590e+02 3.39567291e+01 4.58489620e+00
 3.94253973e-01 1.36276252e+03 6.64782636e+02 3.01135187e+02
 3.14219030e+02 8.76214126e+01 9.51716798e+00 2.77662209e+01
 8.53730314e-01 3.42309789e+00 2.40243817e-01]
grad_E = [-1.54141272e-06  3.64197815e-06 -1.10314782e-06  7.78580527e-05
  4.78302313e-05 -4.10469061e-04 -2.22942569e-04  3.22848666e-03
 -6.04371364e-03 -3.61634677e-07  1.61317477e-08 -2.14544037e-07
  8.21139456e-08  2.61655352e-04  9.93776836e-04  7.22738004e-04
  1.45262426e-02 -3.92134956e-03 -7.29258049e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:44:22 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.543913         1
[INPUT] 0    0    [1    /1   ]  7617.80379735        1
[INPUT] 0    0    [1    /1   ]  3617.29720957        1
[INPUT] 0    0    [1    /1   ]  1604.12703283        1
[INPUT] 0    0    [1    /1   ]  374.389572702        1
[INPUT] 0    0    [1    /1   ]  105.44738122         1
[INPUT] 0    0    [1    /1   ]  34.1895465112        1
[INPUT] 0    0    [1    /1   ]  4.58264599487        1
[INPUT] 0    0    [1    /1   ]  0.394272072572       1
[INPUT] 1    0    [1    /1   ]  1362.76258031        1
[INPUT] 1    0    [1    /1   ]  664.78405904         1
[INPUT] 1    0    [1    /1   ]  301.142677726        1
[INPUT] 1    0    [1    /1   ]  314.225658095        1
[INPUT] 1    0    [1    /1   ]  87.7001279761        1
[INPUT] 1    0    [1    /1   ]  9.28170615314        1
[INPUT] 1    0    [1    /1   ]  27.0316008297        1
[INPUT] 1    0    [1    /1   ]  0.84344555862        1
[INPUT] 1    0    [1    /1   ]  3.37004903494        1
[INPUT] 1    0    [1    /1   ]  0.237631744765       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.543912989622, 1.0]], [0, [7617.803797346892, 1.0]], [0, [3617.297209572292, 1.0]], [0, [1604.1270328324724, 1.0]], [0, [374.38957270161535, 1.0]], [0, [105.44738121997788, 1.0]], [0, [34.189546511220456, 1.0]], [0, [4.582645994867464, 1.0]], [0, [0.3942720725722036, 1.0]], [1, [1362.7625803121905, 1.0]], [1, [664.7840590395734, 1.0]], [1, [301.14267772591995, 1.0]], [1, [314.22565809486156, 1.0]], [1, [87.70012797614038, 1.0]], [1, [9.28170615313563, 1.0]], [1, [27.031600829690746, 1.0]], [1, [0.8434455586201247, 1.0]], [1, [3.3700490349445005, 1.0]], [1, [0.2376317447652951, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.54391299]
bas 1, expnt(s) = [7617.80379735]
bas 2, expnt(s) = [3617.29720957]
bas 3, expnt(s) = [1604.12703283]
bas 4, expnt(s) = [374.3895727]
bas 5, expnt(s) = [105.44738122]
bas 6, expnt(s) = [34.18954651]
bas 7, expnt(s) = [4.58264599]
bas 8, expnt(s) = [0.39427207]
bas 9, expnt(s) = [1362.76258031]
bas 10, expnt(s) = [664.78405904]
bas 11, expnt(s) = [301.14267773]
bas 12, expnt(s) = [314.22565809]
bas 13, expnt(s) = [87.70012798]
bas 14, expnt(s) = [9.28170615]
bas 15, expnt(s) = [27.03160083]
bas 16, expnt(s) = [0.84344556]
bas 17, expnt(s) = [3.37004903]
bas 18, expnt(s) = [0.23763174]
CPU time:       635.03
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825439e+04 5.20024619e+03 7.61780380e+03 2.06009554e+03
 3.61729721e+03 1.17842832e+03 1.60412703e+03 6.40389338e+02
 3.74389573e+02 2.15034346e+02 1.05447381e+02 8.31365261e+01
 3.41895465e+01 3.57219394e+01 4.58264599e+00 7.91320208e+00
 3.94272073e-01 1.25707745e+00 1.36276258e+03 2.41551446e+04
 6.64784059e+02 9.84770746e+03 3.01142678e+02 3.65973616e+03
 3.14225658e+02 3.85954801e+03 8.77001280e+01 7.82951168e+02
 9.28170615e+00 4.72627689e+01 2.70316008e+01 1.79814247e+02
 8.43445559e-01 2.35806467e+00 3.37004903e+00 1.33207804e+01
 2.37631745e-01 4.84021846e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.974014069382456
cond(S) = 157006.99927878042
E1 = -728.8673398737756  E_coul = 203.1111495493078
init E= -525.756190324468
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559051587000379  LUMO = 1.15205253831758
  mo_energy =
[-1.18319241e+02 -1.21044620e+01 -9.44905171e+00 -9.44905171e+00
 -9.44905171e+00 -1.23055519e+00 -5.59051587e-01 -5.59051587e-01
 -5.59051587e-01  1.15205254e+00  1.15205254e+00  1.15205254e+00
  9.29531969e+00  9.29531969e+00  9.29531969e+00  4.53024053e+01
  4.53024053e+01  4.53024053e+01  7.26569938e+01  1.79574790e+02
  1.79574790e+02  1.79574790e+02  5.44536118e+02  5.82673072e+02
  5.82673072e+02  5.82673072e+02  1.45212943e+03  1.45212943e+03
  1.45212943e+03  2.60082698e+03  3.14972863e+03  3.14972863e+03
  3.14972863e+03  6.76474280e+03  6.76474280e+03  6.76474280e+03
  9.01105242e+03  2.53747272e+04  7.61230793e+04]
E1 = -728.09058484732  E_coul = 201.62270162200375
cycle= 1 E= -526.467883225316  delta_E= -0.712  |g|= 0.184  |ddm|= 0.475
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.549107
diis-c [-0.30151887  1.        ]
  HOMO = -0.572880796635326  LUMO = 1.14226888324444
  mo_energy =
[-1.18593635e+02 -1.22014379e+01 -9.55253121e+00 -9.55253121e+00
 -9.55253121e+00 -1.25150759e+00 -5.72880797e-01 -5.72880797e-01
 -5.72880797e-01  1.14226888e+00  1.14226888e+00  1.14226888e+00
  9.23052090e+00  9.23052090e+00  9.23052090e+00  4.51711028e+01
  4.51711028e+01  4.51711028e+01  7.24943783e+01  1.79367347e+02
  1.79367347e+02  1.79367347e+02  5.44228017e+02  5.82401092e+02
  5.82401092e+02  5.82401092e+02  1.45180269e+03  1.45180269e+03
  1.45180269e+03  2.60036262e+03  3.14933521e+03  3.14933521e+03
  3.14933521e+03  6.76423390e+03  6.76423390e+03  6.76423390e+03
  9.01046557e+03  2.53740457e+04  7.61223071e+04]
E1 = -728.3847074333025  E_coul = 201.9164500798631
cycle= 2 E= -526.468257353439  delta_E= -0.000374  |g|= 0.0243  |ddm|= 0.0204
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0469284
diis-c [-0.00141999  0.04857628  0.95142372]
  HOMO = -0.569260680393505  LUMO = 1.14545019675309
  mo_energy =
[-1.18551186e+02 -1.21813224e+01 -9.53201652e+00 -9.53201652e+00
 -9.53201652e+00 -1.24670688e+00 -5.69260680e-01 -5.69260680e-01
 -5.69260680e-01  1.14545020e+00  1.14545020e+00  1.14545020e+00
  9.24338226e+00  9.24338226e+00  9.24338226e+00  4.51955268e+01
  4.51955268e+01  4.51955268e+01  7.25278879e+01  1.79403124e+02
  1.79403124e+02  1.79403124e+02  5.44271830e+02  5.82443208e+02
  5.82443208e+02  5.82443208e+02  1.45184757e+03  1.45184757e+03
  1.45184757e+03  2.60040981e+03  3.14938170e+03  3.14938170e+03
  3.14938170e+03  6.76428142e+03  6.76428142e+03  6.76428142e+03
  9.01051351e+03  2.53740938e+04  7.61223552e+04]
E1 = -728.324373148369  E_coul = 201.8561028808095
cycle= 3 E= -526.46827026756  delta_E= -1.29e-05  |g|= 0.00297  |ddm|= 0.00516
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00636687
diis-c [-3.57597520e-07 -1.08711992e-03  1.12667795e-01  8.88419325e-01]
  HOMO = -0.569908513423442  LUMO = 1.14490115777026
  mo_energy =
[-1.18556387e+02 -1.21841248e+01 -9.53492425e+00 -9.53492425e+00
 -9.53492425e+00 -1.24754787e+00 -5.69908513e-01 -5.69908513e-01
 -5.69908513e-01  1.14490116e+00  1.14490116e+00  1.14490116e+00
  9.24140717e+00  9.24140717e+00  9.24140717e+00  4.51922199e+01
  4.51922199e+01  4.51922199e+01  7.25237558e+01  1.79398635e+02
  1.79398635e+02  1.79398635e+02  5.44266464e+02  5.82438052e+02
  5.82438052e+02  5.82438052e+02  1.45184208e+03  1.45184208e+03
  1.45184208e+03  2.60040391e+03  3.14937597e+03  3.14937597e+03
  3.14937597e+03  6.76427544e+03  6.76427544e+03  6.76427544e+03
  9.01050739e+03  2.53740876e+04  7.61223489e+04]
E1 = -728.3325441245165  E_coul = 201.86427357234862
cycle= 4 E= -526.468270552168  delta_E= -2.85e-07  |g|= 4.15e-05  |ddm|= 0.000759
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.32009e-05
diis-c [-1.70315715e-09  7.81573545e-06 -1.78362174e-03 -8.34060679e-03
  1.01011641e+00]
  HOMO = -0.569881902448115  LUMO = 1.14492299722602
  mo_energy =
[-1.18556295e+02 -1.21840390e+01 -9.53483957e+00 -9.53483957e+00
 -9.53483957e+00 -1.24751330e+00 -5.69881902e-01 -5.69881902e-01
 -5.69881902e-01  1.14492300e+00  1.14492300e+00  1.14492300e+00
  9.24147364e+00  9.24147364e+00  9.24147364e+00  4.51923046e+01
  4.51923046e+01  4.51923046e+01  7.25238505e+01  1.79398726e+02
  1.79398726e+02  1.79398726e+02  5.44266552e+02  5.82438143e+02
  5.82438143e+02  5.82438143e+02  1.45184217e+03  1.45184217e+03
  1.45184217e+03  2.60040398e+03  3.14937605e+03  3.14937605e+03
  3.14937605e+03  6.76427551e+03  6.76427551e+03  6.76427551e+03
  9.01050746e+03  2.53740877e+04  7.61223490e+04]
E1 = -728.332345036151  E_coul = 201.86407448385407
cycle= 5 E= -526.468270552297  delta_E= -1.29e-10  |g|= 7.25e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.332345036151  E_coul = 201.86407448385407
  HOMO = -0.569885592757173  LUMO = 1.14491994960694
  mo_energy =
[-1.18556313e+02 -1.21840519e+01 -9.53485276e+00 -9.53485276e+00
 -9.53485276e+00 -1.24751809e+00 -5.69885593e-01 -5.69885593e-01
 -5.69885593e-01  1.14491995e+00  1.14491995e+00  1.14491995e+00
  9.24146382e+00  9.24146382e+00  9.24146382e+00  4.51922908e+01
  4.51922908e+01  4.51922908e+01  7.25238347e+01  1.79398709e+02
  1.79398709e+02  1.79398709e+02  5.44266534e+02  5.82438125e+02
  5.82438125e+02  5.82438125e+02  1.45184215e+03  1.45184215e+03
  1.45184215e+03  2.60040397e+03  3.14937603e+03  3.14937603e+03
  3.14937603e+03  6.76427550e+03  6.76427550e+03  6.76427550e+03
  9.01050745e+03  2.53740877e+04  7.61223489e+04]
E1 = -728.3323786336384  E_coul = 201.8641080813387
Extra cycle  E= -526.4682705523  delta_E= -2.84e-12  |g|= 1.84e-06  |ddm|= 3.6e-06
    CPU time for scf_cycle      0.68 sec, wall time      0.29 sec
exp = [2.61825439e+04 7.61780380e+03 3.61729721e+03 1.60412703e+03
 3.74389573e+02 1.05447381e+02 3.41895465e+01 4.58264599e+00
 3.94272073e-01 1.36276258e+03 6.64784059e+02 3.01142678e+02
 3.14225658e+02 8.77001280e+01 9.28170615e+00 2.70316008e+01
 8.43445559e-01 3.37004903e+00 2.37631745e-01]
E = -526.4682705522997
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:44:22 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.543913         1
[INPUT] 0    0    [1    /1   ]  7617.80379735        1
[INPUT] 0    0    [1    /1   ]  3617.29720957        1
[INPUT] 0    0    [1    /1   ]  1604.12703283        1
[INPUT] 0    0    [1    /1   ]  374.389572702        1
[INPUT] 0    0    [1    /1   ]  105.44738122         1
[INPUT] 0    0    [1    /1   ]  34.1895465112        1
[INPUT] 0    0    [1    /1   ]  4.58264599487        1
[INPUT] 0    0    [1    /1   ]  0.394272072572       1
[INPUT] 1    0    [1    /1   ]  1362.76258031        1
[INPUT] 1    0    [1    /1   ]  664.78405904         1
[INPUT] 1    0    [1    /1   ]  301.142677726        1
[INPUT] 1    0    [1    /1   ]  314.225658095        1
[INPUT] 1    0    [1    /1   ]  87.7001279761        1
[INPUT] 1    0    [1    /1   ]  9.28170615314        1
[INPUT] 1    0    [1    /1   ]  27.0316008297        1
[INPUT] 1    0    [1    /1   ]  0.84344555862        1
[INPUT] 1    0    [1    /1   ]  3.37004903494        1
[INPUT] 1    0    [1    /1   ]  0.237631744765       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.543912989622, 1.0]], [0, [7617.803797346892, 1.0]], [0, [3617.297209572292, 1.0]], [0, [1604.1270328324724, 1.0]], [0, [374.38957270161535, 1.0]], [0, [105.44738121997788, 1.0]], [0, [34.189546511220456, 1.0]], [0, [4.582645994867464, 1.0]], [0, [0.3942720725722036, 1.0]], [1, [1362.7625803121905, 1.0]], [1, [664.7840590395734, 1.0]], [1, [301.14267772591995, 1.0]], [1, [314.22565809486156, 1.0]], [1, [87.70012797614038, 1.0]], [1, [9.28170615313563, 1.0]], [1, [27.031600829690746, 1.0]], [1, [0.8434455586201247, 1.0]], [1, [3.3700490349445005, 1.0]], [1, [0.2376317447652951, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.54391299]
bas 1, expnt(s) = [7617.80379735]
bas 2, expnt(s) = [3617.29720957]
bas 3, expnt(s) = [1604.12703283]
bas 4, expnt(s) = [374.3895727]
bas 5, expnt(s) = [105.44738122]
bas 6, expnt(s) = [34.18954651]
bas 7, expnt(s) = [4.58264599]
bas 8, expnt(s) = [0.39427207]
bas 9, expnt(s) = [1362.76258031]
bas 10, expnt(s) = [664.78405904]
bas 11, expnt(s) = [301.14267773]
bas 12, expnt(s) = [314.22565809]
bas 13, expnt(s) = [87.70012798]
bas 14, expnt(s) = [9.28170615]
bas 15, expnt(s) = [27.03160083]
bas 16, expnt(s) = [0.84344556]
bas 17, expnt(s) = [3.37004903]
bas 18, expnt(s) = [0.23763174]
CPU time:       635.96
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825439e+04 5.20024619e+03 7.61780380e+03 2.06009554e+03
 3.61729721e+03 1.17842832e+03 1.60412703e+03 6.40389338e+02
 3.74389573e+02 2.15034346e+02 1.05447381e+02 8.31365261e+01
 3.41895465e+01 3.57219394e+01 4.58264599e+00 7.91320208e+00
 3.94272073e-01 1.25707745e+00 1.36276258e+03 2.41551446e+04
 6.64784059e+02 9.84770746e+03 3.01142678e+02 3.65973616e+03
 3.14225658e+02 3.85954801e+03 8.77001280e+01 7.82951168e+02
 9.28170615e+00 4.72627689e+01 2.70316008e+01 1.79814247e+02
 8.43445559e-01 2.35806467e+00 3.37004903e+00 1.33207804e+01
 2.37631745e-01 4.84021846e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.974014069382456
cond(S) = 157006.99927878042
E1 = -728.8673398737756  E_coul = 203.1111495493078
init E= -525.756190324468
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559051587000379  LUMO = 1.15205253831758
  mo_energy =
[-1.18319241e+02 -1.21044620e+01 -9.44905171e+00 -9.44905171e+00
 -9.44905171e+00 -1.23055519e+00 -5.59051587e-01 -5.59051587e-01
 -5.59051587e-01  1.15205254e+00  1.15205254e+00  1.15205254e+00
  9.29531969e+00  9.29531969e+00  9.29531969e+00  4.53024053e+01
  4.53024053e+01  4.53024053e+01  7.26569938e+01  1.79574790e+02
  1.79574790e+02  1.79574790e+02  5.44536118e+02  5.82673072e+02
  5.82673072e+02  5.82673072e+02  1.45212943e+03  1.45212943e+03
  1.45212943e+03  2.60082698e+03  3.14972863e+03  3.14972863e+03
  3.14972863e+03  6.76474280e+03  6.76474280e+03  6.76474280e+03
  9.01105242e+03  2.53747272e+04  7.61230793e+04]
E1 = -728.09058484732  E_coul = 201.62270162200375
cycle= 1 E= -526.467883225316  delta_E= -0.712  |g|= 0.184  |ddm|= 0.475
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.549107
diis-c [-0.30151887  1.        ]
  HOMO = -0.572880796635326  LUMO = 1.14226888324444
  mo_energy =
[-1.18593635e+02 -1.22014379e+01 -9.55253121e+00 -9.55253121e+00
 -9.55253121e+00 -1.25150759e+00 -5.72880797e-01 -5.72880797e-01
 -5.72880797e-01  1.14226888e+00  1.14226888e+00  1.14226888e+00
  9.23052090e+00  9.23052090e+00  9.23052090e+00  4.51711028e+01
  4.51711028e+01  4.51711028e+01  7.24943783e+01  1.79367347e+02
  1.79367347e+02  1.79367347e+02  5.44228017e+02  5.82401092e+02
  5.82401092e+02  5.82401092e+02  1.45180269e+03  1.45180269e+03
  1.45180269e+03  2.60036262e+03  3.14933521e+03  3.14933521e+03
  3.14933521e+03  6.76423390e+03  6.76423390e+03  6.76423390e+03
  9.01046557e+03  2.53740457e+04  7.61223071e+04]
E1 = -728.3847074333025  E_coul = 201.9164500798631
cycle= 2 E= -526.468257353439  delta_E= -0.000374  |g|= 0.0243  |ddm|= 0.0204
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0469284
diis-c [-0.00141999  0.04857628  0.95142372]
  HOMO = -0.569260680393505  LUMO = 1.14545019675309
  mo_energy =
[-1.18551186e+02 -1.21813224e+01 -9.53201652e+00 -9.53201652e+00
 -9.53201652e+00 -1.24670688e+00 -5.69260680e-01 -5.69260680e-01
 -5.69260680e-01  1.14545020e+00  1.14545020e+00  1.14545020e+00
  9.24338226e+00  9.24338226e+00  9.24338226e+00  4.51955268e+01
  4.51955268e+01  4.51955268e+01  7.25278879e+01  1.79403124e+02
  1.79403124e+02  1.79403124e+02  5.44271830e+02  5.82443208e+02
  5.82443208e+02  5.82443208e+02  1.45184757e+03  1.45184757e+03
  1.45184757e+03  2.60040981e+03  3.14938170e+03  3.14938170e+03
  3.14938170e+03  6.76428142e+03  6.76428142e+03  6.76428142e+03
  9.01051351e+03  2.53740938e+04  7.61223552e+04]
E1 = -728.324373148369  E_coul = 201.8561028808095
cycle= 3 E= -526.46827026756  delta_E= -1.29e-05  |g|= 0.00297  |ddm|= 0.00516
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00636687
diis-c [-3.57597520e-07 -1.08711992e-03  1.12667795e-01  8.88419325e-01]
  HOMO = -0.569908513423442  LUMO = 1.14490115777026
  mo_energy =
[-1.18556387e+02 -1.21841248e+01 -9.53492425e+00 -9.53492425e+00
 -9.53492425e+00 -1.24754787e+00 -5.69908513e-01 -5.69908513e-01
 -5.69908513e-01  1.14490116e+00  1.14490116e+00  1.14490116e+00
  9.24140717e+00  9.24140717e+00  9.24140717e+00  4.51922199e+01
  4.51922199e+01  4.51922199e+01  7.25237558e+01  1.79398635e+02
  1.79398635e+02  1.79398635e+02  5.44266464e+02  5.82438052e+02
  5.82438052e+02  5.82438052e+02  1.45184208e+03  1.45184208e+03
  1.45184208e+03  2.60040391e+03  3.14937597e+03  3.14937597e+03
  3.14937597e+03  6.76427544e+03  6.76427544e+03  6.76427544e+03
  9.01050739e+03  2.53740876e+04  7.61223489e+04]
E1 = -728.3325441245165  E_coul = 201.86427357234862
cycle= 4 E= -526.468270552168  delta_E= -2.85e-07  |g|= 4.15e-05  |ddm|= 0.000759
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.32009e-05
diis-c [-1.70315715e-09  7.81573545e-06 -1.78362174e-03 -8.34060679e-03
  1.01011641e+00]
  HOMO = -0.569881902448115  LUMO = 1.14492299722602
  mo_energy =
[-1.18556295e+02 -1.21840390e+01 -9.53483957e+00 -9.53483957e+00
 -9.53483957e+00 -1.24751330e+00 -5.69881902e-01 -5.69881902e-01
 -5.69881902e-01  1.14492300e+00  1.14492300e+00  1.14492300e+00
  9.24147364e+00  9.24147364e+00  9.24147364e+00  4.51923046e+01
  4.51923046e+01  4.51923046e+01  7.25238505e+01  1.79398726e+02
  1.79398726e+02  1.79398726e+02  5.44266552e+02  5.82438143e+02
  5.82438143e+02  5.82438143e+02  1.45184217e+03  1.45184217e+03
  1.45184217e+03  2.60040398e+03  3.14937605e+03  3.14937605e+03
  3.14937605e+03  6.76427551e+03  6.76427551e+03  6.76427551e+03
  9.01050746e+03  2.53740877e+04  7.61223490e+04]
E1 = -728.332345036151  E_coul = 201.86407448385407
cycle= 5 E= -526.468270552297  delta_E= -1.29e-10  |g|= 7.25e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.332345036151  E_coul = 201.86407448385407
  HOMO = -0.569885592757173  LUMO = 1.14491994960694
  mo_energy =
[-1.18556313e+02 -1.21840519e+01 -9.53485276e+00 -9.53485276e+00
 -9.53485276e+00 -1.24751809e+00 -5.69885593e-01 -5.69885593e-01
 -5.69885593e-01  1.14491995e+00  1.14491995e+00  1.14491995e+00
  9.24146382e+00  9.24146382e+00  9.24146382e+00  4.51922908e+01
  4.51922908e+01  4.51922908e+01  7.25238347e+01  1.79398709e+02
  1.79398709e+02  1.79398709e+02  5.44266534e+02  5.82438125e+02
  5.82438125e+02  5.82438125e+02  1.45184215e+03  1.45184215e+03
  1.45184215e+03  2.60040397e+03  3.14937603e+03  3.14937603e+03
  3.14937603e+03  6.76427550e+03  6.76427550e+03  6.76427550e+03
  9.01050745e+03  2.53740877e+04  7.61223489e+04]
E1 = -728.3323786336384  E_coul = 201.8641080813387
Extra cycle  E= -526.4682705523  delta_E= -2.84e-12  |g|= 1.84e-06  |ddm|= 3.6e-06
    CPU time for scf_cycle      0.67 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 157006.99927878042
E1 = -728.3323786336384  E_coul = 201.8641080813387
init E= -526.4682705523
    CPU time for initialize scf      2.98 sec, wall time      0.26 sec
  HOMO = -0.569884966128166  LUMO = 1.14492047487058
  mo_energy =
[-1.18556309e+02 -1.21840494e+01 -9.53485022e+00 -9.53485022e+00
 -9.53485022e+00 -1.24751727e+00 -5.69884966e-01 -5.69884966e-01
 -5.69884966e-01  1.14492047e+00  1.14492047e+00  1.14492047e+00
  9.24146561e+00  9.24146561e+00  9.24146561e+00  4.51922936e+01
  4.51922936e+01  4.51922936e+01  7.25238381e+01  1.79398713e+02
  1.79398713e+02  1.79398713e+02  5.44266538e+02  5.82438129e+02
  5.82438129e+02  5.82438129e+02  1.45184216e+03  1.45184216e+03
  1.45184216e+03  2.60040397e+03  3.14937604e+03  3.14937604e+03
  3.14937604e+03  6.76427550e+03  6.76427550e+03  6.76427550e+03
  9.01050745e+03  2.53740877e+04  7.61223489e+04]
E1 = -728.3323718429198  E_coul = 201.86410129061997
cycle= 1 E= -526.4682705523  delta_E= -1.14e-13  |g|= 4.05e-07  |ddm|= 6.68e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3323718429198  E_coul = 201.86410129061997
  HOMO = -0.569885085065783  LUMO = 1.14492037453942
  mo_energy =
[-1.18556310e+02 -1.21840499e+01 -9.53485073e+00 -9.53485073e+00
 -9.53485073e+00 -1.24751743e+00 -5.69885085e-01 -5.69885085e-01
 -5.69885085e-01  1.14492037e+00  1.14492037e+00  1.14492037e+00
  9.24146526e+00  9.24146526e+00  9.24146526e+00  4.51922930e+01
  4.51922930e+01  4.51922930e+01  7.25238374e+01  1.79398712e+02
  1.79398712e+02  1.79398712e+02  5.44266537e+02  5.82438128e+02
  5.82438128e+02  5.82438128e+02  1.45184215e+03  1.45184215e+03
  1.45184215e+03  2.60040397e+03  3.14937604e+03  3.14937604e+03
  3.14937604e+03  6.76427550e+03  6.76427550e+03  6.76427550e+03
  9.01050745e+03  2.53740877e+04  7.61223489e+04]
E1 = -728.3323732379843  E_coul = 201.8641026856831
Extra cycle  E= -526.468270552301  delta_E= -1.36e-12  |g|= 8.6e-08  |ddm|= 1.33e-07
    CPU time for scf_cycle      3.13 sec, wall time      0.41 sec
exp = [2.61825439e+04 7.61780380e+03 3.61729721e+03 1.60412703e+03
 3.74389573e+02 1.05447381e+02 3.41895465e+01 4.58264599e+00
 3.94272073e-01 1.36276258e+03 6.64784059e+02 3.01142678e+02
 3.14225658e+02 8.77001280e+01 9.28170615e+00 2.70316008e+01
 8.43445559e-01 3.37004903e+00 2.37631745e-01]
grad_E = [-1.55361868e-06  3.78847735e-06 -9.83532998e-07  8.30348898e-05
 -5.82784079e-05 -1.27451396e-04  6.27540617e-05  1.14083116e-03
 -7.38871761e-03 -1.92380842e-07  4.59977565e-08  4.97134331e-07
  9.56983843e-07  4.73450060e-04  1.57650841e-03 -5.40308047e-04
  1.19833523e-02 -2.16292798e-03 -1.40448475e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:44:27 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5436764        1
[INPUT] 0    0    [1    /1   ]  7617.80657732        1
[INPUT] 0    0    [1    /1   ]  3617.30302997        1
[INPUT] 0    0    [1    /1   ]  1604.21469145        1
[INPUT] 0    0    [1    /1   ]  373.503224899        1
[INPUT] 0    0    [1    /1   ]  105.387364723        1
[INPUT] 0    0    [1    /1   ]  34.2109004545        1
[INPUT] 0    0    [1    /1   ]  4.58137679582        1
[INPUT] 0    0    [1    /1   ]  0.394511124218       1
[INPUT] 1    0    [1    /1   ]  1362.76277278        1
[INPUT] 1    0    [1    /1   ]  664.786569343        1
[INPUT] 1    0    [1    /1   ]  301.156518158        1
[INPUT] 1    0    [1    /1   ]  314.237862294        1
[INPUT] 1    0    [1    /1   ]  87.3959182691        1
[INPUT] 1    0    [1    /1   ]  9.31781034579        1
[INPUT] 1    0    [1    /1   ]  27.1730094875        1
[INPUT] 1    0    [1    /1   ]  0.839190388681       1
[INPUT] 1    0    [1    /1   ]  3.37973429653        1
[INPUT] 1    0    [1    /1   ]  0.236780110768       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.543676363257, 1.0]], [0, [7617.806577322168, 1.0]], [0, [3617.303029965013, 1.0]], [0, [1604.214691453543, 1.0]], [0, [373.5032248991689, 1.0]], [0, [105.38736472302502, 1.0]], [0, [34.210900454502266, 1.0]], [0, [4.581376795823613, 1.0]], [0, [0.3945111242183829, 1.0]], [1, [1362.7627727842832, 1.0]], [1, [664.786569343381, 1.0]], [1, [301.15651815767234, 1.0]], [1, [314.2378622935212, 1.0]], [1, [87.39591826912466, 1.0]], [1, [9.317810345792635, 1.0]], [1, [27.1730094874746, 1.0]], [1, [0.8391903886814084, 1.0]], [1, [3.379734296526062, 1.0]], [1, [0.23678011076815325, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.54367636]
bas 1, expnt(s) = [7617.80657732]
bas 2, expnt(s) = [3617.30302997]
bas 3, expnt(s) = [1604.21469145]
bas 4, expnt(s) = [373.5032249]
bas 5, expnt(s) = [105.38736472]
bas 6, expnt(s) = [34.21090045]
bas 7, expnt(s) = [4.5813768]
bas 8, expnt(s) = [0.39451112]
bas 9, expnt(s) = [1362.76277278]
bas 10, expnt(s) = [664.78656934]
bas 11, expnt(s) = [301.15651816]
bas 12, expnt(s) = [314.23786229]
bas 13, expnt(s) = [87.39591827]
bas 14, expnt(s) = [9.31781035]
bas 15, expnt(s) = [27.17300949]
bas 16, expnt(s) = [0.83919039]
bas 17, expnt(s) = [3.3797343]
bas 18, expnt(s) = [0.23678011]
CPU time:       644.56
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825437e+04 5.20024616e+03 7.61780658e+03 2.06009610e+03
 3.61730303e+03 1.17842974e+03 1.60421469e+03 6.40415583e+02
 3.73503225e+02 2.14652421e+02 1.05387365e+02 8.31010350e+01
 3.42109005e+01 3.57386714e+01 4.58137680e+00 7.91155831e+00
 3.94511124e-01 1.25764904e+00 1.36276277e+03 2.41551489e+04
 6.64786569e+02 9.84775394e+03 3.01156518e+02 3.65994641e+03
 3.14237862e+02 3.85973539e+03 8.73959183e+01 7.79557815e+02
 9.31781035e+00 4.74926853e+01 2.71730095e+01 1.80990829e+02
 8.39190389e-01 2.34320356e+00 3.37973430e+00 1.33686512e+01
 2.36780111e-01 4.81854497e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97416817227631
cond(S) = 156722.36919268087
E1 = -728.8683961043732  E_coul = 203.11281505257327
init E= -525.7555810518
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558975579813077  LUMO = 1.14491977180469
  mo_energy =
[-1.18319014e+02 -1.21044840e+01 -9.44896579e+00 -9.44896579e+00
 -9.44896579e+00 -1.23045681e+00 -5.58975580e-01 -5.58975580e-01
 -5.58975580e-01  1.14491977e+00  1.14491977e+00  1.14491977e+00
  9.30510659e+00  9.30510659e+00  9.30510659e+00  4.55103834e+01
  4.55103834e+01  4.55103834e+01  7.26711852e+01  1.79856727e+02
  1.79856727e+02  1.79856727e+02  5.43846706e+02  5.82547942e+02
  5.82547942e+02  5.82547942e+02  1.45175774e+03  1.45175774e+03
  1.45175774e+03  2.59835779e+03  3.14928487e+03  3.14928487e+03
  3.14928487e+03  6.76431022e+03  6.76431022e+03  6.76431022e+03
  9.00798139e+03  2.53716607e+04  7.61201942e+04]
E1 = -728.0866286454531  E_coul = 201.61865854951515
cycle= 1 E= -526.467970095938  delta_E= -0.712  |g|= 0.185  |ddm|= 0.478
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.549706
diis-c [-0.30217716  1.        ]
  HOMO = -0.572914079527249  LUMO = 1.13512881227001
  mo_energy =
[-1.18593925e+02 -1.22018788e+01 -9.55291909e+00 -9.55291909e+00
 -9.55291909e+00 -1.25157982e+00 -5.72914080e-01 -5.72914080e-01
 -5.72914080e-01  1.13512881e+00  1.13512881e+00  1.13512881e+00
  9.23985380e+00  9.23985380e+00  9.23985380e+00  4.53783042e+01
  4.53783042e+01  4.53783042e+01  7.25080551e+01  1.79648910e+02
  1.79648910e+02  1.79648910e+02  5.43538318e+02  5.82275528e+02
  5.82275528e+02  5.82275528e+02  1.45143055e+03  1.45143055e+03
  1.45143055e+03  2.59789306e+03  3.14889102e+03  3.14889102e+03
  3.14889102e+03  6.76380087e+03  6.76380087e+03  6.76380087e+03
  9.00739407e+03  2.53709787e+04  7.61194215e+04]
E1 = -728.3820384181869  E_coul = 201.9136920669126
cycle= 2 E= -526.468346351274  delta_E= -0.000376  |g|= 0.0244  |ddm|= 0.0206
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0470542
diis-c [-0.00142666  0.04867809  0.95132191]
  HOMO = -0.569264829792046  LUMO = 1.13831666399496
  mo_energy =
[-1.18551347e+02 -1.21816786e+01 -9.53231843e+00 -9.53231843e+00
 -9.53231843e+00 -1.24674163e+00 -5.69264830e-01 -5.69264830e-01
 -5.69264830e-01  1.13831666e+00  1.13831666e+00  1.13831666e+00
  9.25281358e+00  9.25281358e+00  9.25281358e+00  4.54028716e+01
  4.54028716e+01  4.54028716e+01  7.25416787e+01  1.79684793e+02
  1.79684793e+02  1.79684793e+02  5.43582254e+02  5.82317764e+02
  5.82317764e+02  5.82317764e+02  1.45147556e+03  1.45147556e+03
  1.45147556e+03  2.59794038e+03  3.14893764e+03  3.14893764e+03
  3.14893764e+03  6.76384852e+03  6.76384852e+03  6.76384852e+03
  9.00744214e+03  2.53710270e+04  7.61194698e+04]
E1 = -728.3214946046187  E_coul = 201.8531352599508
cycle= 3 E= -526.468359344668  delta_E= -1.3e-05  |g|= 0.00297  |ddm|= 0.00519
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00637947
diis-c [-3.59007574e-07 -1.08834547e-03  1.12593520e-01  8.88494825e-01]
  HOMO = -0.569914984060075  LUMO = 1.13776874578332
  mo_energy =
[-1.18556557e+02 -1.21844876e+01 -9.53523329e+00 -9.53523329e+00
 -9.53523329e+00 -1.24758583e+00 -5.69914984e-01 -5.69914984e-01
 -5.69914984e-01  1.13776875e+00  1.13776875e+00  1.13776875e+00
  9.25082944e+00  9.25082944e+00  9.25082944e+00  4.53995519e+01
  4.53995519e+01  4.53995519e+01  7.25375384e+01  1.79680296e+02
  1.79680296e+02  1.79680296e+02  5.43576878e+02  5.82312599e+02
  5.82312599e+02  5.82312599e+02  1.45147006e+03  1.45147006e+03
  1.45147006e+03  2.59793447e+03  3.14893189e+03  3.14893189e+03
  3.14893189e+03  6.76384252e+03  6.76384252e+03  6.76384252e+03
  9.00743601e+03  2.53710207e+04  7.61194634e+04]
E1 = -728.3296840465975  E_coul = 201.8613244162583
cycle= 4 E= -526.468359630339  delta_E= -2.86e-07  |g|= 4.14e-05  |ddm|= 0.000761
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.31222e-05
diis-c [-1.70864509e-09  8.43665902e-06 -1.84563708e-03 -8.89232241e-03
  1.01072952e+00]
  HOMO = -0.569888344551851  LUMO = 1.13779049569608
  mo_energy =
[-1.18556466e+02 -1.21844019e+01 -9.53514875e+00 -9.53514875e+00
 -9.53514875e+00 -1.24755125e+00 -5.69888345e-01 -5.69888345e-01
 -5.69888345e-01  1.13779050e+00  1.13779050e+00  1.13779050e+00
  9.25089594e+00  9.25089594e+00  9.25089594e+00  4.53996366e+01
  4.53996366e+01  4.53996366e+01  7.25376330e+01  1.79680387e+02
  1.79680387e+02  1.79680387e+02  5.43576966e+02  5.82312690e+02
  5.82312690e+02  5.82312690e+02  1.45147015e+03  1.45147015e+03
  1.45147015e+03  2.59793455e+03  3.14893198e+03  3.14893198e+03
  3.14893198e+03  6.76384260e+03  6.76384260e+03  6.76384260e+03
  9.00743608e+03  2.53710208e+04  7.61194635e+04]
E1 = -728.3294854377962  E_coul = 201.86112580733075
cycle= 5 E= -526.468359630465  delta_E= -1.26e-10  |g|= 7.25e-06  |ddm|= 2.31e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3294854377962  E_coul = 201.86112580733075
  HOMO = -0.569892049260871  LUMO = 1.13778745287129
  mo_energy =
[-1.18556484e+02 -1.21844149e+01 -9.53516196e+00 -9.53516196e+00
 -9.53516196e+00 -1.24755605e+00 -5.69892049e-01 -5.69892049e-01
 -5.69892049e-01  1.13778745e+00  1.13778745e+00  1.13778745e+00
  9.25088608e+00  9.25088608e+00  9.25088608e+00  4.53996227e+01
  4.53996227e+01  4.53996227e+01  7.25376171e+01  1.79680370e+02
  1.79680370e+02  1.79680370e+02  5.43576948e+02  5.82312672e+02
  5.82312672e+02  5.82312672e+02  1.45147013e+03  1.45147013e+03
  1.45147013e+03  2.59793453e+03  3.14893196e+03  3.14893196e+03
  3.14893196e+03  6.76384258e+03  6.76384258e+03  6.76384258e+03
  9.00743606e+03  2.53710208e+04  7.61194635e+04]
E1 = -728.3295191079319  E_coul = 201.86115947746288
Extra cycle  E= -526.468359630469  delta_E= -3.52e-12  |g|= 1.84e-06  |ddm|= 3.61e-06
    CPU time for scf_cycle      0.67 sec, wall time      0.28 sec
exp = [2.61825437e+04 7.61780658e+03 3.61730303e+03 1.60421469e+03
 3.73503225e+02 1.05387365e+02 3.42109005e+01 4.58137680e+00
 3.94511124e-01 1.36276277e+03 6.64786569e+02 3.01156518e+02
 3.14237862e+02 8.73959183e+01 9.31781035e+00 2.71730095e+01
 8.39190389e-01 3.37973430e+00 2.36780111e-01]
E = -526.468359630469
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:44:27 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5436764        1
[INPUT] 0    0    [1    /1   ]  7617.80657732        1
[INPUT] 0    0    [1    /1   ]  3617.30302997        1
[INPUT] 0    0    [1    /1   ]  1604.21469145        1
[INPUT] 0    0    [1    /1   ]  373.503224899        1
[INPUT] 0    0    [1    /1   ]  105.387364723        1
[INPUT] 0    0    [1    /1   ]  34.2109004545        1
[INPUT] 0    0    [1    /1   ]  4.58137679582        1
[INPUT] 0    0    [1    /1   ]  0.394511124218       1
[INPUT] 1    0    [1    /1   ]  1362.76277278        1
[INPUT] 1    0    [1    /1   ]  664.786569343        1
[INPUT] 1    0    [1    /1   ]  301.156518158        1
[INPUT] 1    0    [1    /1   ]  314.237862294        1
[INPUT] 1    0    [1    /1   ]  87.3959182691        1
[INPUT] 1    0    [1    /1   ]  9.31781034579        1
[INPUT] 1    0    [1    /1   ]  27.1730094875        1
[INPUT] 1    0    [1    /1   ]  0.839190388681       1
[INPUT] 1    0    [1    /1   ]  3.37973429653        1
[INPUT] 1    0    [1    /1   ]  0.236780110768       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.543676363257, 1.0]], [0, [7617.806577322168, 1.0]], [0, [3617.303029965013, 1.0]], [0, [1604.214691453543, 1.0]], [0, [373.5032248991689, 1.0]], [0, [105.38736472302502, 1.0]], [0, [34.210900454502266, 1.0]], [0, [4.581376795823613, 1.0]], [0, [0.3945111242183829, 1.0]], [1, [1362.7627727842832, 1.0]], [1, [664.786569343381, 1.0]], [1, [301.15651815767234, 1.0]], [1, [314.2378622935212, 1.0]], [1, [87.39591826912466, 1.0]], [1, [9.317810345792635, 1.0]], [1, [27.1730094874746, 1.0]], [1, [0.8391903886814084, 1.0]], [1, [3.379734296526062, 1.0]], [1, [0.23678011076815325, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.54367636]
bas 1, expnt(s) = [7617.80657732]
bas 2, expnt(s) = [3617.30302997]
bas 3, expnt(s) = [1604.21469145]
bas 4, expnt(s) = [373.5032249]
bas 5, expnt(s) = [105.38736472]
bas 6, expnt(s) = [34.21090045]
bas 7, expnt(s) = [4.5813768]
bas 8, expnt(s) = [0.39451112]
bas 9, expnt(s) = [1362.76277278]
bas 10, expnt(s) = [664.78656934]
bas 11, expnt(s) = [301.15651816]
bas 12, expnt(s) = [314.23786229]
bas 13, expnt(s) = [87.39591827]
bas 14, expnt(s) = [9.31781035]
bas 15, expnt(s) = [27.17300949]
bas 16, expnt(s) = [0.83919039]
bas 17, expnt(s) = [3.3797343]
bas 18, expnt(s) = [0.23678011]
CPU time:       645.49
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825437e+04 5.20024616e+03 7.61780658e+03 2.06009610e+03
 3.61730303e+03 1.17842974e+03 1.60421469e+03 6.40415583e+02
 3.73503225e+02 2.14652421e+02 1.05387365e+02 8.31010350e+01
 3.42109005e+01 3.57386714e+01 4.58137680e+00 7.91155831e+00
 3.94511124e-01 1.25764904e+00 1.36276277e+03 2.41551489e+04
 6.64786569e+02 9.84775394e+03 3.01156518e+02 3.65994641e+03
 3.14237862e+02 3.85973539e+03 8.73959183e+01 7.79557815e+02
 9.31781035e+00 4.74926853e+01 2.71730095e+01 1.80990829e+02
 8.39190389e-01 2.34320356e+00 3.37973430e+00 1.33686512e+01
 2.36780111e-01 4.81854497e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97416817227631
cond(S) = 156722.36919268087
E1 = -728.8683961043732  E_coul = 203.11281505257327
init E= -525.7555810518
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558975579813077  LUMO = 1.14491977180469
  mo_energy =
[-1.18319014e+02 -1.21044840e+01 -9.44896579e+00 -9.44896579e+00
 -9.44896579e+00 -1.23045681e+00 -5.58975580e-01 -5.58975580e-01
 -5.58975580e-01  1.14491977e+00  1.14491977e+00  1.14491977e+00
  9.30510659e+00  9.30510659e+00  9.30510659e+00  4.55103834e+01
  4.55103834e+01  4.55103834e+01  7.26711852e+01  1.79856727e+02
  1.79856727e+02  1.79856727e+02  5.43846706e+02  5.82547942e+02
  5.82547942e+02  5.82547942e+02  1.45175774e+03  1.45175774e+03
  1.45175774e+03  2.59835779e+03  3.14928487e+03  3.14928487e+03
  3.14928487e+03  6.76431022e+03  6.76431022e+03  6.76431022e+03
  9.00798139e+03  2.53716607e+04  7.61201942e+04]
E1 = -728.0866286454531  E_coul = 201.61865854951515
cycle= 1 E= -526.467970095938  delta_E= -0.712  |g|= 0.185  |ddm|= 0.478
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.549706
diis-c [-0.30217716  1.        ]
  HOMO = -0.572914079527249  LUMO = 1.13512881227001
  mo_energy =
[-1.18593925e+02 -1.22018788e+01 -9.55291909e+00 -9.55291909e+00
 -9.55291909e+00 -1.25157982e+00 -5.72914080e-01 -5.72914080e-01
 -5.72914080e-01  1.13512881e+00  1.13512881e+00  1.13512881e+00
  9.23985380e+00  9.23985380e+00  9.23985380e+00  4.53783042e+01
  4.53783042e+01  4.53783042e+01  7.25080551e+01  1.79648910e+02
  1.79648910e+02  1.79648910e+02  5.43538318e+02  5.82275528e+02
  5.82275528e+02  5.82275528e+02  1.45143055e+03  1.45143055e+03
  1.45143055e+03  2.59789306e+03  3.14889102e+03  3.14889102e+03
  3.14889102e+03  6.76380087e+03  6.76380087e+03  6.76380087e+03
  9.00739407e+03  2.53709787e+04  7.61194215e+04]
E1 = -728.3820384181869  E_coul = 201.9136920669126
cycle= 2 E= -526.468346351274  delta_E= -0.000376  |g|= 0.0244  |ddm|= 0.0206
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0470542
diis-c [-0.00142666  0.04867809  0.95132191]
  HOMO = -0.569264829792046  LUMO = 1.13831666399496
  mo_energy =
[-1.18551347e+02 -1.21816786e+01 -9.53231843e+00 -9.53231843e+00
 -9.53231843e+00 -1.24674163e+00 -5.69264830e-01 -5.69264830e-01
 -5.69264830e-01  1.13831666e+00  1.13831666e+00  1.13831666e+00
  9.25281358e+00  9.25281358e+00  9.25281358e+00  4.54028716e+01
  4.54028716e+01  4.54028716e+01  7.25416787e+01  1.79684793e+02
  1.79684793e+02  1.79684793e+02  5.43582254e+02  5.82317764e+02
  5.82317764e+02  5.82317764e+02  1.45147556e+03  1.45147556e+03
  1.45147556e+03  2.59794038e+03  3.14893764e+03  3.14893764e+03
  3.14893764e+03  6.76384852e+03  6.76384852e+03  6.76384852e+03
  9.00744214e+03  2.53710270e+04  7.61194698e+04]
E1 = -728.3214946046187  E_coul = 201.8531352599508
cycle= 3 E= -526.468359344668  delta_E= -1.3e-05  |g|= 0.00297  |ddm|= 0.00519
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00637947
diis-c [-3.59007574e-07 -1.08834547e-03  1.12593520e-01  8.88494825e-01]
  HOMO = -0.569914984060075  LUMO = 1.13776874578332
  mo_energy =
[-1.18556557e+02 -1.21844876e+01 -9.53523329e+00 -9.53523329e+00
 -9.53523329e+00 -1.24758583e+00 -5.69914984e-01 -5.69914984e-01
 -5.69914984e-01  1.13776875e+00  1.13776875e+00  1.13776875e+00
  9.25082944e+00  9.25082944e+00  9.25082944e+00  4.53995519e+01
  4.53995519e+01  4.53995519e+01  7.25375384e+01  1.79680296e+02
  1.79680296e+02  1.79680296e+02  5.43576878e+02  5.82312599e+02
  5.82312599e+02  5.82312599e+02  1.45147006e+03  1.45147006e+03
  1.45147006e+03  2.59793447e+03  3.14893189e+03  3.14893189e+03
  3.14893189e+03  6.76384252e+03  6.76384252e+03  6.76384252e+03
  9.00743601e+03  2.53710207e+04  7.61194634e+04]
E1 = -728.3296840465975  E_coul = 201.8613244162583
cycle= 4 E= -526.468359630339  delta_E= -2.86e-07  |g|= 4.14e-05  |ddm|= 0.000761
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.31222e-05
diis-c [-1.70864509e-09  8.43665902e-06 -1.84563708e-03 -8.89232241e-03
  1.01072952e+00]
  HOMO = -0.569888344551851  LUMO = 1.13779049569608
  mo_energy =
[-1.18556466e+02 -1.21844019e+01 -9.53514875e+00 -9.53514875e+00
 -9.53514875e+00 -1.24755125e+00 -5.69888345e-01 -5.69888345e-01
 -5.69888345e-01  1.13779050e+00  1.13779050e+00  1.13779050e+00
  9.25089594e+00  9.25089594e+00  9.25089594e+00  4.53996366e+01
  4.53996366e+01  4.53996366e+01  7.25376330e+01  1.79680387e+02
  1.79680387e+02  1.79680387e+02  5.43576966e+02  5.82312690e+02
  5.82312690e+02  5.82312690e+02  1.45147015e+03  1.45147015e+03
  1.45147015e+03  2.59793455e+03  3.14893198e+03  3.14893198e+03
  3.14893198e+03  6.76384260e+03  6.76384260e+03  6.76384260e+03
  9.00743608e+03  2.53710208e+04  7.61194635e+04]
E1 = -728.3294854377962  E_coul = 201.86112580733075
cycle= 5 E= -526.468359630465  delta_E= -1.26e-10  |g|= 7.25e-06  |ddm|= 2.31e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3294854377962  E_coul = 201.86112580733075
  HOMO = -0.569892049260871  LUMO = 1.13778745287129
  mo_energy =
[-1.18556484e+02 -1.21844149e+01 -9.53516196e+00 -9.53516196e+00
 -9.53516196e+00 -1.24755605e+00 -5.69892049e-01 -5.69892049e-01
 -5.69892049e-01  1.13778745e+00  1.13778745e+00  1.13778745e+00
  9.25088608e+00  9.25088608e+00  9.25088608e+00  4.53996227e+01
  4.53996227e+01  4.53996227e+01  7.25376171e+01  1.79680370e+02
  1.79680370e+02  1.79680370e+02  5.43576948e+02  5.82312672e+02
  5.82312672e+02  5.82312672e+02  1.45147013e+03  1.45147013e+03
  1.45147013e+03  2.59793453e+03  3.14893196e+03  3.14893196e+03
  3.14893196e+03  6.76384258e+03  6.76384258e+03  6.76384258e+03
  9.00743606e+03  2.53710208e+04  7.61194635e+04]
E1 = -728.3295191079319  E_coul = 201.86115947746288
Extra cycle  E= -526.468359630469  delta_E= -3.52e-12  |g|= 1.84e-06  |ddm|= 3.61e-06
    CPU time for scf_cycle      0.68 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156722.36919268087
E1 = -728.3295191079319  E_coul = 201.86115947746288
init E= -526.468359630469
    CPU time for initialize scf      2.72 sec, wall time      0.25 sec
  HOMO = -0.569891420267391  LUMO = 1.13778797722641
  mo_energy =
[-1.18556480e+02 -1.21844124e+01 -9.53515943e+00 -9.53515943e+00
 -9.53515943e+00 -1.24755523e+00 -5.69891420e-01 -5.69891420e-01
 -5.69891420e-01  1.13778798e+00  1.13778798e+00  1.13778798e+00
  9.25088788e+00  9.25088788e+00  9.25088788e+00  4.53996255e+01
  4.53996255e+01  4.53996255e+01  7.25376205e+01  1.79680374e+02
  1.79680374e+02  1.79680374e+02  5.43576952e+02  5.82312676e+02
  5.82312676e+02  5.82312676e+02  1.45147013e+03  1.45147013e+03
  1.45147013e+03  2.59793453e+03  3.14893196e+03  3.14893196e+03
  3.14893196e+03  6.76384258e+03  6.76384258e+03  6.76384258e+03
  9.00743607e+03  2.53710208e+04  7.61194635e+04]
E1 = -728.3295123058369  E_coul = 201.86115267536707
cycle= 1 E= -526.46835963047  delta_E= -9.09e-13  |g|= 4.05e-07  |ddm|= 6.7e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3295123058369  E_coul = 201.86115267536707
  HOMO = -0.5698915395625  LUMO = 1.13778787714846
  mo_energy =
[-1.18556481e+02 -1.21844129e+01 -9.53515994e+00 -9.53515994e+00
 -9.53515994e+00 -1.24755539e+00 -5.69891540e-01 -5.69891540e-01
 -5.69891540e-01  1.13778788e+00  1.13778788e+00  1.13778788e+00
  9.25088752e+00  9.25088752e+00  9.25088752e+00  4.53996249e+01
  4.53996249e+01  4.53996249e+01  7.25376198e+01  1.79680373e+02
  1.79680373e+02  1.79680373e+02  5.43576951e+02  5.82312675e+02
  5.82312675e+02  5.82312675e+02  1.45147013e+03  1.45147013e+03
  1.45147013e+03  2.59793453e+03  3.14893196e+03  3.14893196e+03
  3.14893196e+03  6.76384258e+03  6.76384258e+03  6.76384258e+03
  9.00743607e+03  2.53710208e+04  7.61194635e+04]
E1 = -728.3295137027262  E_coul = 201.8611540722565
Extra cycle  E= -526.46835963047  delta_E= 2.27e-13  |g|= 8.61e-08  |ddm|= 1.34e-07
    CPU time for scf_cycle      2.87 sec, wall time      0.39 sec
exp = [2.61825437e+04 7.61780658e+03 3.61730303e+03 1.60421469e+03
 3.73503225e+02 1.05387365e+02 3.42109005e+01 4.58137680e+00
 3.94511124e-01 1.36276277e+03 6.64786569e+02 3.01156518e+02
 3.14237862e+02 8.73959183e+01 9.31781035e+00 2.71730095e+01
 8.39190389e-01 3.37973430e+00 2.36780111e-01]
grad_E = [-1.55979614e-06  3.86438587e-06 -9.13782283e-07  8.55717522e-05
 -9.45644627e-05 -5.32347559e-05  1.28822041e-04  2.31957820e-04
 -4.07408071e-03 -2.62031278e-07  1.62657259e-08  9.55667910e-08
  5.07432005e-07  3.95283025e-04  1.75796435e-04  1.20608956e-04
  5.35615060e-03 -2.96677097e-04 -7.81418982e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:44:32 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5435096        1
[INPUT] 0    0    [1    /1   ]  7617.80870328        1
[INPUT] 0    0    [1    /1   ]  3617.30760874        1
[INPUT] 0    0    [1    /1   ]  1604.28200819        1
[INPUT] 0    0    [1    /1   ]  372.849441798        1
[INPUT] 0    0    [1    /1   ]  105.157634456        1
[INPUT] 0    0    [1    /1   ]  34.1562214114        1
[INPUT] 0    0    [1    /1   ]  4.58080022717        1
[INPUT] 0    0    [1    /1   ]  0.394679872775       1
[INPUT] 1    0    [1    /1   ]  1362.76292111        1
[INPUT] 1    0    [1    /1   ]  664.788475909        1
[INPUT] 1    0    [1    /1   ]  301.166994058        1
[INPUT] 1    0    [1    /1   ]  314.247100646        1
[INPUT] 1    0    [1    /1   ]  87.2064168737        1
[INPUT] 1    0    [1    /1   ]  9.29928685946        1
[INPUT] 1    0    [1    /1   ]  27.1204615952        1
[INPUT] 1    0    [1    /1   ]  0.83588867048        1
[INPUT] 1    0    [1    /1   ]  3.37520011232        1
[INPUT] 1    0    [1    /1   ]  0.236152962518       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.54350962665, 1.0]], [0, [7617.80870327653, 1.0]], [0, [3617.307608737625, 1.0]], [0, [1604.2820081913417, 1.0]], [0, [372.8494417983123, 1.0]], [0, [105.15763445572246, 1.0]], [0, [34.15622141142881, 1.0]], [0, [4.580800227174064, 1.0]], [0, [0.39467987277505007, 1.0]], [1, [1362.7629211077876, 1.0]], [1, [664.7884759091281, 1.0]], [1, [301.1669940577406, 1.0]], [1, [314.24710064613254, 1.0]], [1, [87.20641687369844, 1.0]], [1, [9.299286859463365, 1.0]], [1, [27.12046159516821, 1.0]], [1, [0.8358886704804019, 1.0]], [1, [3.3752001123223065, 1.0]], [1, [0.23615296251845752, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.54350963]
bas 1, expnt(s) = [7617.80870328]
bas 2, expnt(s) = [3617.30760874]
bas 3, expnt(s) = [1604.28200819]
bas 4, expnt(s) = [372.8494418]
bas 5, expnt(s) = [105.15763446]
bas 6, expnt(s) = [34.15622141]
bas 7, expnt(s) = [4.58080023]
bas 8, expnt(s) = [0.39467987]
bas 9, expnt(s) = [1362.76292111]
bas 10, expnt(s) = [664.78847591]
bas 11, expnt(s) = [301.16699406]
bas 12, expnt(s) = [314.24710065]
bas 13, expnt(s) = [87.20641687]
bas 14, expnt(s) = [9.29928686]
bas 15, expnt(s) = [27.1204616]
bas 16, expnt(s) = [0.83588867]
bas 17, expnt(s) = [3.37520011]
bas 18, expnt(s) = [0.23615296]
CPU time:       653.99
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825435e+04 5.20024613e+03 7.61780870e+03 2.06009653e+03
 3.61730761e+03 1.17843086e+03 1.60428201e+03 6.40435738e+02
 3.72849442e+02 2.14370562e+02 1.05157634e+02 8.29651362e+01
 3.41562214e+01 3.56958222e+01 4.58080023e+00 7.91081154e+00
 3.94679873e-01 1.25805248e+00 1.36276292e+03 2.41551522e+04
 6.64788476e+02 9.84778924e+03 3.01166994e+02 3.66010556e+03
 3.14247101e+02 3.85987723e+03 8.72064169e+01 7.77445485e+02
 9.29928686e+00 4.73746974e+01 2.71204616e+01 1.80553428e+02
 8.35888670e-01 2.33168533e+00 3.37520011e+00 1.33462360e+01
 2.36152963e-01 4.80259694e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.974291123024113
cond(S) = 156216.27065501385
E1 = -728.8708296490795  E_coul = 203.11463447424129
init E= -525.756195174838
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.55891655066443  LUMO = 1.13942380724369
  mo_energy =
[-1.18318812e+02 -1.21044112e+01 -9.44884347e+00 -9.44884347e+00
 -9.44884347e+00 -1.23037666e+00 -5.58916551e-01 -5.58916551e-01
 -5.58916551e-01  1.13942381e+00  1.13942381e+00  1.13942381e+00
  9.27498461e+00  9.27498461e+00  9.27498461e+00  4.53961699e+01
  4.53961699e+01  4.53961699e+01  7.24742251e+01  1.79470739e+02
  1.79470739e+02  1.79470739e+02  5.42603334e+02  5.81837108e+02
  5.81837108e+02  5.81837108e+02  1.45091749e+03  1.45091749e+03
  1.45091749e+03  2.59561211e+03  3.14843441e+03  3.14843441e+03
  3.14843441e+03  6.76351528e+03  6.76351528e+03  6.76351528e+03
  9.00481724e+03  2.53685393e+04  7.61172633e+04]
E1 = -728.0843054365373  E_coul = 201.61632158811094
cycle= 1 E= -526.467983848426  delta_E= -0.712  |g|= 0.185  |ddm|= 0.49
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.549974
diis-c [-0.30247121  1.        ]
  HOMO = -0.572926809964717  LUMO = 1.12964473315793
  mo_energy =
[-1.18594174e+02 -1.22021139e+01 -9.55312654e+00 -9.55312654e+00
 -9.55312654e+00 -1.25161101e+00 -5.72926810e-01 -5.72926810e-01
 -5.72926810e-01  1.12964473e+00  1.12964473e+00  1.12964473e+00
  9.20961865e+00  9.20961865e+00  9.20961865e+00  4.52638719e+01
  4.52638719e+01  4.52638719e+01  7.23108445e+01  1.79262604e+02
  1.79262604e+02  1.79262604e+02  5.42294643e+02  5.81564242e+02
  5.81564242e+02  5.81564242e+02  1.45058979e+03  1.45058979e+03
  1.45058979e+03  2.59514685e+03  3.14804001e+03  3.14804001e+03
  3.14804001e+03  6.76300534e+03  6.76300534e+03  6.76300534e+03
  9.00422929e+03  2.53678567e+04  7.61164900e+04]
E1 = -728.3807034689434  E_coul = 201.9123418615989
cycle= 2 E= -526.468361607344  delta_E= -0.000378  |g|= 0.0245  |ddm|= 0.0207
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0471548
diis-c [-0.00143137  0.04879583  0.95120417]
  HOMO = -0.569257338700162  LUMO = 1.13283409517291
  mo_energy =
[-1.18551493e+02 -1.21818496e+01 -9.53246019e+00 -9.53246019e+00
 -9.53246019e+00 -1.24674652e+00 -5.69257339e-01 -5.69257339e-01
 -5.69257339e-01  1.13283410e+00  1.13283410e+00  1.13283410e+00
  9.22261082e+00  9.22261082e+00  9.22261082e+00  4.52884911e+01
  4.52884911e+01  4.52884911e+01  7.23445315e+01  1.79298566e+02
  1.79298566e+02  1.79298566e+02  5.42338676e+02  5.81606580e+02
  5.81606580e+02  5.81606580e+02  1.45063491e+03  1.45063491e+03
  1.45063491e+03  2.59519429e+03  3.14808674e+03  3.14808674e+03
  3.14808674e+03  6.76305311e+03  6.76305311e+03  6.76305311e+03
  9.00427748e+03  2.53679050e+04  7.61165384e+04]
E1 = -728.3199716224867  E_coul = 201.85159694988295
cycle= 3 E= -526.468374672604  delta_E= -1.31e-05  |g|= 0.00298  |ddm|= 0.0052
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00639155
diis-c [-3.59961892e-07 -1.08971377e-03  1.12565968e-01  8.88523746e-01]
  HOMO = -0.56990931751811  LUMO = 1.13228724623592
  mo_energy =
[-1.18556712e+02 -1.21846646e+01 -9.53538134e+00 -9.53538134e+00
 -9.53538134e+00 -1.24759321e+00 -5.69909318e-01 -5.69909318e-01
 -5.69909318e-01  1.13228725e+00  1.13228725e+00  1.13228725e+00
  9.22062438e+00  9.22062438e+00  9.22062438e+00  4.52851670e+01
  4.52851670e+01  4.52851670e+01  7.23403859e+01  1.79294062e+02
  1.79294062e+02  1.79294062e+02  5.42333292e+02  5.81601405e+02
  5.81601405e+02  5.81601405e+02  1.45062940e+03  1.45062940e+03
  1.45062940e+03  2.59518836e+03  3.14808098e+03  3.14808098e+03
  3.14808098e+03  6.76304710e+03  6.76304710e+03  6.76304710e+03
  9.00427134e+03  2.53678988e+04  7.61165320e+04]
E1 = -728.3281800923072  E_coul = 201.85980513287933
cycle= 4 E= -526.468374959428  delta_E= -2.87e-07  |g|= 4.14e-05  |ddm|= 0.000764
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.30074e-05
diis-c [-1.71579853e-09  8.74961391e-06 -1.87926286e-03 -9.22286226e-03
  1.01109338e+00]
  HOMO = -0.56988266077131  LUMO = 1.13230891387589
  mo_energy =
[-1.18556621e+02 -1.21845790e+01 -9.53529689e+00 -9.53529689e+00
 -9.53529689e+00 -1.24755861e+00 -5.69882661e-01 -5.69882661e-01
 -5.69882661e-01  1.13230891e+00  1.13230891e+00  1.13230891e+00
  9.22069080e+00  9.22069080e+00  9.22069080e+00  4.52852516e+01
  4.52852516e+01  4.52852516e+01  7.23404804e+01  1.79294153e+02
  1.79294153e+02  1.79294153e+02  5.42333379e+02  5.81601496e+02
  5.81601496e+02  5.81601496e+02  1.45062949e+03  1.45062949e+03
  1.45062949e+03  2.59518844e+03  3.14808107e+03  3.14808107e+03
  3.14808107e+03  6.76304718e+03  6.76304718e+03  6.76304718e+03
  9.00427141e+03  2.53678988e+04  7.61165321e+04]
E1 = -728.3279818060817  E_coul = 201.85960684652667
cycle= 5 E= -526.468374959555  delta_E= -1.27e-10  |g|= 7.26e-06  |ddm|= 2.31e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3279818060817  E_coul = 201.85960684652667
  HOMO = -0.569886376696746  LUMO = 1.13230587585402
  mo_energy =
[-1.18556639e+02 -1.21845920e+01 -9.53531014e+00 -9.53531014e+00
 -9.53531014e+00 -1.24756342e+00 -5.69886377e-01 -5.69886377e-01
 -5.69886377e-01  1.13230588e+00  1.13230588e+00  1.13230588e+00
  9.22068092e+00  9.22068092e+00  9.22068092e+00  4.52852376e+01
  4.52852376e+01  4.52852376e+01  7.23404645e+01  1.79294136e+02
  1.79294136e+02  1.79294136e+02  5.42333361e+02  5.81601478e+02
  5.81601478e+02  5.81601478e+02  1.45062947e+03  1.45062947e+03
  1.45062947e+03  2.59518842e+03  3.14808105e+03  3.14808105e+03
  3.14808105e+03  6.76304716e+03  6.76304716e+03  6.76304716e+03
  9.00427139e+03  2.53678988e+04  7.61165321e+04]
E1 = -728.3280155544728  E_coul = 201.85964059491417
Extra cycle  E= -526.468374959559  delta_E= -3.75e-12  |g|= 1.84e-06  |ddm|= 3.62e-06
    CPU time for scf_cycle      0.63 sec, wall time      0.24 sec
exp = [2.61825435e+04 7.61780870e+03 3.61730761e+03 1.60428201e+03
 3.72849442e+02 1.05157634e+02 3.41562214e+01 4.58080023e+00
 3.94679873e-01 1.36276292e+03 6.64788476e+02 3.01166994e+02
 3.14247101e+02 8.72064169e+01 9.29928686e+00 2.71204616e+01
 8.35888670e-01 3.37520011e+00 2.36152963e-01]
E = -526.4683749595587
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:44:32 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5435096        1
[INPUT] 0    0    [1    /1   ]  7617.80870328        1
[INPUT] 0    0    [1    /1   ]  3617.30760874        1
[INPUT] 0    0    [1    /1   ]  1604.28200819        1
[INPUT] 0    0    [1    /1   ]  372.849441798        1
[INPUT] 0    0    [1    /1   ]  105.157634456        1
[INPUT] 0    0    [1    /1   ]  34.1562214114        1
[INPUT] 0    0    [1    /1   ]  4.58080022717        1
[INPUT] 0    0    [1    /1   ]  0.394679872775       1
[INPUT] 1    0    [1    /1   ]  1362.76292111        1
[INPUT] 1    0    [1    /1   ]  664.788475909        1
[INPUT] 1    0    [1    /1   ]  301.166994058        1
[INPUT] 1    0    [1    /1   ]  314.247100646        1
[INPUT] 1    0    [1    /1   ]  87.2064168737        1
[INPUT] 1    0    [1    /1   ]  9.29928685946        1
[INPUT] 1    0    [1    /1   ]  27.1204615952        1
[INPUT] 1    0    [1    /1   ]  0.83588867048        1
[INPUT] 1    0    [1    /1   ]  3.37520011232        1
[INPUT] 1    0    [1    /1   ]  0.236152962518       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.54350962665, 1.0]], [0, [7617.80870327653, 1.0]], [0, [3617.307608737625, 1.0]], [0, [1604.2820081913417, 1.0]], [0, [372.8494417983123, 1.0]], [0, [105.15763445572246, 1.0]], [0, [34.15622141142881, 1.0]], [0, [4.580800227174064, 1.0]], [0, [0.39467987277505007, 1.0]], [1, [1362.7629211077876, 1.0]], [1, [664.7884759091281, 1.0]], [1, [301.1669940577406, 1.0]], [1, [314.24710064613254, 1.0]], [1, [87.20641687369844, 1.0]], [1, [9.299286859463365, 1.0]], [1, [27.12046159516821, 1.0]], [1, [0.8358886704804019, 1.0]], [1, [3.3752001123223065, 1.0]], [1, [0.23615296251845752, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.54350963]
bas 1, expnt(s) = [7617.80870328]
bas 2, expnt(s) = [3617.30760874]
bas 3, expnt(s) = [1604.28200819]
bas 4, expnt(s) = [372.8494418]
bas 5, expnt(s) = [105.15763446]
bas 6, expnt(s) = [34.15622141]
bas 7, expnt(s) = [4.58080023]
bas 8, expnt(s) = [0.39467987]
bas 9, expnt(s) = [1362.76292111]
bas 10, expnt(s) = [664.78847591]
bas 11, expnt(s) = [301.16699406]
bas 12, expnt(s) = [314.24710065]
bas 13, expnt(s) = [87.20641687]
bas 14, expnt(s) = [9.29928686]
bas 15, expnt(s) = [27.1204616]
bas 16, expnt(s) = [0.83588867]
bas 17, expnt(s) = [3.37520011]
bas 18, expnt(s) = [0.23615296]
CPU time:       654.84
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825435e+04 5.20024613e+03 7.61780870e+03 2.06009653e+03
 3.61730761e+03 1.17843086e+03 1.60428201e+03 6.40435738e+02
 3.72849442e+02 2.14370562e+02 1.05157634e+02 8.29651362e+01
 3.41562214e+01 3.56958222e+01 4.58080023e+00 7.91081154e+00
 3.94679873e-01 1.25805248e+00 1.36276292e+03 2.41551522e+04
 6.64788476e+02 9.84778924e+03 3.01166994e+02 3.66010556e+03
 3.14247101e+02 3.85987723e+03 8.72064169e+01 7.77445485e+02
 9.29928686e+00 4.73746974e+01 2.71204616e+01 1.80553428e+02
 8.35888670e-01 2.33168533e+00 3.37520011e+00 1.33462360e+01
 2.36152963e-01 4.80259694e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.974291123024113
cond(S) = 156216.27065501385
E1 = -728.8708296490795  E_coul = 203.11463447424129
init E= -525.756195174838
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.55891655066443  LUMO = 1.13942380724369
  mo_energy =
[-1.18318812e+02 -1.21044112e+01 -9.44884347e+00 -9.44884347e+00
 -9.44884347e+00 -1.23037666e+00 -5.58916551e-01 -5.58916551e-01
 -5.58916551e-01  1.13942381e+00  1.13942381e+00  1.13942381e+00
  9.27498461e+00  9.27498461e+00  9.27498461e+00  4.53961699e+01
  4.53961699e+01  4.53961699e+01  7.24742251e+01  1.79470739e+02
  1.79470739e+02  1.79470739e+02  5.42603334e+02  5.81837108e+02
  5.81837108e+02  5.81837108e+02  1.45091749e+03  1.45091749e+03
  1.45091749e+03  2.59561211e+03  3.14843441e+03  3.14843441e+03
  3.14843441e+03  6.76351528e+03  6.76351528e+03  6.76351528e+03
  9.00481724e+03  2.53685393e+04  7.61172633e+04]
E1 = -728.0843054365373  E_coul = 201.61632158811094
cycle= 1 E= -526.467983848426  delta_E= -0.712  |g|= 0.185  |ddm|= 0.49
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.549974
diis-c [-0.30247121  1.        ]
  HOMO = -0.572926809964717  LUMO = 1.12964473315793
  mo_energy =
[-1.18594174e+02 -1.22021139e+01 -9.55312654e+00 -9.55312654e+00
 -9.55312654e+00 -1.25161101e+00 -5.72926810e-01 -5.72926810e-01
 -5.72926810e-01  1.12964473e+00  1.12964473e+00  1.12964473e+00
  9.20961865e+00  9.20961865e+00  9.20961865e+00  4.52638719e+01
  4.52638719e+01  4.52638719e+01  7.23108445e+01  1.79262604e+02
  1.79262604e+02  1.79262604e+02  5.42294643e+02  5.81564242e+02
  5.81564242e+02  5.81564242e+02  1.45058979e+03  1.45058979e+03
  1.45058979e+03  2.59514685e+03  3.14804001e+03  3.14804001e+03
  3.14804001e+03  6.76300534e+03  6.76300534e+03  6.76300534e+03
  9.00422929e+03  2.53678567e+04  7.61164900e+04]
E1 = -728.3807034689434  E_coul = 201.9123418615989
cycle= 2 E= -526.468361607344  delta_E= -0.000378  |g|= 0.0245  |ddm|= 0.0207
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0471548
diis-c [-0.00143137  0.04879583  0.95120417]
  HOMO = -0.569257338700162  LUMO = 1.13283409517291
  mo_energy =
[-1.18551493e+02 -1.21818496e+01 -9.53246019e+00 -9.53246019e+00
 -9.53246019e+00 -1.24674652e+00 -5.69257339e-01 -5.69257339e-01
 -5.69257339e-01  1.13283410e+00  1.13283410e+00  1.13283410e+00
  9.22261082e+00  9.22261082e+00  9.22261082e+00  4.52884911e+01
  4.52884911e+01  4.52884911e+01  7.23445315e+01  1.79298566e+02
  1.79298566e+02  1.79298566e+02  5.42338676e+02  5.81606580e+02
  5.81606580e+02  5.81606580e+02  1.45063491e+03  1.45063491e+03
  1.45063491e+03  2.59519429e+03  3.14808674e+03  3.14808674e+03
  3.14808674e+03  6.76305311e+03  6.76305311e+03  6.76305311e+03
  9.00427748e+03  2.53679050e+04  7.61165384e+04]
E1 = -728.3199716224867  E_coul = 201.85159694988295
cycle= 3 E= -526.468374672604  delta_E= -1.31e-05  |g|= 0.00298  |ddm|= 0.0052
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00639155
diis-c [-3.59961892e-07 -1.08971377e-03  1.12565968e-01  8.88523746e-01]
  HOMO = -0.56990931751811  LUMO = 1.13228724623592
  mo_energy =
[-1.18556712e+02 -1.21846646e+01 -9.53538134e+00 -9.53538134e+00
 -9.53538134e+00 -1.24759321e+00 -5.69909318e-01 -5.69909318e-01
 -5.69909318e-01  1.13228725e+00  1.13228725e+00  1.13228725e+00
  9.22062438e+00  9.22062438e+00  9.22062438e+00  4.52851670e+01
  4.52851670e+01  4.52851670e+01  7.23403859e+01  1.79294062e+02
  1.79294062e+02  1.79294062e+02  5.42333292e+02  5.81601405e+02
  5.81601405e+02  5.81601405e+02  1.45062940e+03  1.45062940e+03
  1.45062940e+03  2.59518836e+03  3.14808098e+03  3.14808098e+03
  3.14808098e+03  6.76304710e+03  6.76304710e+03  6.76304710e+03
  9.00427134e+03  2.53678988e+04  7.61165320e+04]
E1 = -728.3281800923072  E_coul = 201.85980513287933
cycle= 4 E= -526.468374959428  delta_E= -2.87e-07  |g|= 4.14e-05  |ddm|= 0.000764
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.30074e-05
diis-c [-1.71579853e-09  8.74961391e-06 -1.87926286e-03 -9.22286226e-03
  1.01109338e+00]
  HOMO = -0.56988266077131  LUMO = 1.13230891387589
  mo_energy =
[-1.18556621e+02 -1.21845790e+01 -9.53529689e+00 -9.53529689e+00
 -9.53529689e+00 -1.24755861e+00 -5.69882661e-01 -5.69882661e-01
 -5.69882661e-01  1.13230891e+00  1.13230891e+00  1.13230891e+00
  9.22069080e+00  9.22069080e+00  9.22069080e+00  4.52852516e+01
  4.52852516e+01  4.52852516e+01  7.23404804e+01  1.79294153e+02
  1.79294153e+02  1.79294153e+02  5.42333379e+02  5.81601496e+02
  5.81601496e+02  5.81601496e+02  1.45062949e+03  1.45062949e+03
  1.45062949e+03  2.59518844e+03  3.14808107e+03  3.14808107e+03
  3.14808107e+03  6.76304718e+03  6.76304718e+03  6.76304718e+03
  9.00427141e+03  2.53678988e+04  7.61165321e+04]
E1 = -728.3279818060817  E_coul = 201.85960684652667
cycle= 5 E= -526.468374959555  delta_E= -1.27e-10  |g|= 7.26e-06  |ddm|= 2.31e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3279818060817  E_coul = 201.85960684652667
  HOMO = -0.569886376696746  LUMO = 1.13230587585402
  mo_energy =
[-1.18556639e+02 -1.21845920e+01 -9.53531014e+00 -9.53531014e+00
 -9.53531014e+00 -1.24756342e+00 -5.69886377e-01 -5.69886377e-01
 -5.69886377e-01  1.13230588e+00  1.13230588e+00  1.13230588e+00
  9.22068092e+00  9.22068092e+00  9.22068092e+00  4.52852376e+01
  4.52852376e+01  4.52852376e+01  7.23404645e+01  1.79294136e+02
  1.79294136e+02  1.79294136e+02  5.42333361e+02  5.81601478e+02
  5.81601478e+02  5.81601478e+02  1.45062947e+03  1.45062947e+03
  1.45062947e+03  2.59518842e+03  3.14808105e+03  3.14808105e+03
  3.14808105e+03  6.76304716e+03  6.76304716e+03  6.76304716e+03
  9.00427139e+03  2.53678988e+04  7.61165321e+04]
E1 = -728.3280155544728  E_coul = 201.85964059491417
Extra cycle  E= -526.468374959559  delta_E= -3.75e-12  |g|= 1.84e-06  |ddm|= 3.62e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156216.27065501385
E1 = -728.3280155544728  E_coul = 201.85964059491417
init E= -526.468374959559
    CPU time for initialize scf      2.72 sec, wall time      0.25 sec
  HOMO = -0.56988574569281  LUMO = 1.13230639944575
  mo_energy =
[-1.18556635e+02 -1.21845895e+01 -9.53530759e+00 -9.53530759e+00
 -9.53530759e+00 -1.24756260e+00 -5.69885746e-01 -5.69885746e-01
 -5.69885746e-01  1.13230640e+00  1.13230640e+00  1.13230640e+00
  9.22068272e+00  9.22068272e+00  9.22068272e+00  4.52852404e+01
  4.52852404e+01  4.52852404e+01  7.23404679e+01  1.79294140e+02
  1.79294140e+02  1.79294140e+02  5.42333366e+02  5.81601482e+02
  5.81601482e+02  5.81601482e+02  1.45062947e+03  1.45062947e+03
  1.45062947e+03  2.59518843e+03  3.14808105e+03  3.14808105e+03
  3.14808105e+03  6.76304716e+03  6.76304716e+03  6.76304716e+03
  9.00427140e+03  2.53678988e+04  7.61165321e+04]
E1 = -728.3280087365998  E_coul = 201.85963377704093
cycle= 1 E= -526.468374959559  delta_E= -2.27e-13  |g|= 4.06e-07  |ddm|= 6.72e-07
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
E1 = -728.3280087365998  E_coul = 201.85963377704093
  HOMO = -0.569885865348227  LUMO = 1.13230629953536
  mo_energy =
[-1.18556636e+02 -1.21845900e+01 -9.53530810e+00 -9.53530810e+00
 -9.53530810e+00 -1.24756276e+00 -5.69885865e-01 -5.69885865e-01
 -5.69885865e-01  1.13230630e+00  1.13230630e+00  1.13230630e+00
  9.22068237e+00  9.22068237e+00  9.22068237e+00  4.52852398e+01
  4.52852398e+01  4.52852398e+01  7.23404672e+01  1.79294139e+02
  1.79294139e+02  1.79294139e+02  5.42333365e+02  5.81601481e+02
  5.81601481e+02  5.81601481e+02  1.45062947e+03  1.45062947e+03
  1.45062947e+03  2.59518843e+03  3.14808105e+03  3.14808105e+03
  3.14808105e+03  6.76304716e+03  6.76304716e+03  6.76304716e+03
  9.00427140e+03  2.53678988e+04  7.61165321e+04]
E1 = -728.3280101368446  E_coul = 201.8596351772868
Extra cycle  E= -526.468374959558  delta_E= 1.14e-12  |g|= 8.62e-08  |ddm|= 1.34e-07
    CPU time for scf_cycle      2.87 sec, wall time      0.40 sec
exp = [2.61825435e+04 7.61780870e+03 3.61730761e+03 1.60428201e+03
 3.72849442e+02 1.05157634e+02 3.41562214e+01 4.58080023e+00
 3.94679873e-01 1.36276292e+03 6.64788476e+02 3.01166994e+02
 3.14247101e+02 8.72064169e+01 9.29928686e+00 2.71204616e+01
 8.35888670e-01 3.37520011e+00 2.36152963e-01]
grad_E = [-1.56233381e-06  3.89591384e-06 -8.81443761e-07  8.65269172e-05
 -9.70395419e-05 -7.60505656e-05  1.26957851e-04 -1.03721951e-05
 -1.64582236e-03 -2.67444368e-07  1.50660082e-08  5.61151913e-08
  4.67840906e-07  3.95116903e-04 -7.10643205e-05  1.68747911e-04
  1.22774980e-03  2.68547958e-04 -2.43695991e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:44:37 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5434449        1
[INPUT] 0    0    [1    /1   ]  7617.80954853        1
[INPUT] 0    0    [1    /1   ]  3617.3094404         1
[INPUT] 0    0    [1    /1   ]  1604.3088121         1
[INPUT] 0    0    [1    /1   ]  372.590842899        1
[INPUT] 0    0    [1    /1   ]  105.054584537        1
[INPUT] 0    0    [1    /1   ]  34.1207637939        1
[INPUT] 0    0    [1    /1   ]  4.58071455203        1
[INPUT] 0    0    [1    /1   ]  0.394787302856       1
[INPUT] 1    0    [1    /1   ]  1362.76297991        1
[INPUT] 1    0    [1    /1   ]  664.789231528        1
[INPUT] 1    0    [1    /1   ]  301.171141653        1
[INPUT] 1    0    [1    /1   ]  314.25075799         1
[INPUT] 1    0    [1    /1   ]  87.1346981119        1
[INPUT] 1    0    [1    /1   ]  9.28676601766        1
[INPUT] 1    0    [1    /1   ]  27.0869589852        1
[INPUT] 1    0    [1    /1   ]  0.834599589691       1
[INPUT] 1    0    [1    /1   ]  3.37105613979        1
[INPUT] 1    0    [1    /1   ]  0.235929965649       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.54344487766, 1.0]], [0, [7617.809548532583, 1.0]], [0, [3617.3094403952227, 1.0]], [0, [1604.3088120953134, 1.0]], [0, [372.59084289948925, 1.0]], [0, [105.05458453702722, 1.0]], [0, [34.12076379385083, 1.0]], [0, [4.580714552033246, 1.0]], [0, [0.39478730285625047, 1.0]], [1, [1362.7629799084687, 1.0]], [1, [664.7892315275094, 1.0]], [1, [301.17114165333294, 1.0]], [1, [314.250757990337, 1.0]], [1, [87.1346981119486, 1.0]], [1, [9.286766017658588, 1.0]], [1, [27.086958985208923, 1.0]], [1, [0.8345995896913165, 1.0]], [1, [3.3710561397851677, 1.0]], [1, [0.23592996564923657, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.54344488]
bas 1, expnt(s) = [7617.80954853]
bas 2, expnt(s) = [3617.3094404]
bas 3, expnt(s) = [1604.3088121]
bas 4, expnt(s) = [372.5908429]
bas 5, expnt(s) = [105.05458454]
bas 6, expnt(s) = [34.12076379]
bas 7, expnt(s) = [4.58071455]
bas 8, expnt(s) = [0.3947873]
bas 9, expnt(s) = [1362.76297991]
bas 10, expnt(s) = [664.78923153]
bas 11, expnt(s) = [301.17114165]
bas 12, expnt(s) = [314.25075799]
bas 13, expnt(s) = [87.13469811]
bas 14, expnt(s) = [9.28676602]
bas 15, expnt(s) = [27.08695899]
bas 16, expnt(s) = [0.83459959]
bas 17, expnt(s) = [3.37105614]
bas 18, expnt(s) = [0.23592997]
CPU time:       663.15
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825434e+04 5.20024612e+03 7.61780955e+03 2.06009670e+03
 3.61730944e+03 1.17843130e+03 1.60430881e+03 6.40443764e+02
 3.72590843e+02 2.14259041e+02 1.05054585e+02 8.29041520e+01
 3.41207638e+01 3.56680266e+01 4.58071455e+00 7.91070057e+00
 3.94787303e-01 1.25830930e+00 1.36276298e+03 2.41551535e+04
 6.64789232e+02 9.84780323e+03 3.01171142e+02 3.66016856e+03
 3.14250758e+02 3.85993339e+03 8.71346981e+01 7.76646351e+02
 9.28676602e+00 4.72949774e+01 2.70869590e+01 1.80274668e+02
 8.34599590e-01 2.32719139e+00 3.37105614e+00 1.33257565e+01
 2.35929966e-01 4.79692881e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.974331213538576
cond(S) = 155988.96050154712
E1 = -728.8727910829084  E_coul = 203.11610481551736
init E= -525.756686267391
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558873361508291  LUMO = 1.13735645496412
  mo_energy =
[-1.18318716e+02 -1.21042797e+01 -9.44873673e+00 -9.44873673e+00
 -9.44873673e+00 -1.23032252e+00 -5.58873362e-01 -5.58873362e-01
 -5.58873362e-01  1.13735645e+00  1.13735645e+00  1.13735645e+00
  9.25706533e+00  9.25706533e+00  9.25706533e+00  4.53206829e+01
  4.53206829e+01  4.53206829e+01  7.23658008e+01  1.79260633e+02
  1.79260633e+02  1.79260633e+02  5.42029657e+02  5.81498287e+02
  5.81498287e+02  5.81498287e+02  1.45053291e+03  1.45053291e+03
  1.45053291e+03  2.59443202e+03  3.14804989e+03  3.14804989e+03
  3.14804989e+03  6.76315713e+03  6.76315713e+03  6.76315713e+03
  9.00347575e+03  2.53672190e+04  7.61160241e+04]
E1 = -728.0841411242408  E_coul = 201.61615541717813
cycle= 1 E= -526.467985707063  delta_E= -0.711  |g|= 0.185  |ddm|= 0.495
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.550147
diis-c [-0.30266171  1.        ]
  HOMO = -0.572899432116433  LUMO = 1.12759278885813
  mo_energy =
[-1.18594301e+02 -1.22021023e+01 -9.55315129e+00 -9.55315129e+00
 -9.55315129e+00 -1.25158874e+00 -5.72899432e-01 -5.72899432e-01
 -5.72899432e-01  1.12759279e+00  1.12759279e+00  1.12759279e+00
  9.19169457e+00  9.19169457e+00  9.19169457e+00  4.51883142e+01
  4.51883142e+01  4.51883142e+01  7.22023101e+01  1.79052338e+02
  1.79052338e+02  1.79052338e+02  5.41720774e+02  5.81225178e+02
  5.81225178e+02  5.81225178e+02  1.45020492e+03  1.45020492e+03
  1.45020492e+03  2.59396646e+03  3.14765519e+03  3.14765519e+03
  3.14765519e+03  6.76264687e+03  6.76264687e+03  6.76264687e+03
  9.00288746e+03  2.53665360e+04  7.61152503e+04]
E1 = -728.3809434237762  E_coul = 201.91257923333438
cycle= 2 E= -526.468364190442  delta_E= -0.000378  |g|= 0.0245  |ddm|= 0.0208
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0472048
diis-c [-0.0014334   0.04885988  0.95114012]
  HOMO = -0.569222987013984  LUMO = 1.13078184342923
  mo_energy =
[-1.18551571e+02 -1.21818125e+01 -9.53245872e+00 -9.53245872e+00
 -9.53245872e+00 -1.24671480e+00 -5.69222987e-01 -5.69222987e-01
 -5.69222987e-01  1.13078184e+00  1.13078184e+00  1.13078184e+00
  9.20469246e+00  9.20469246e+00  9.20469246e+00  4.52129501e+01
  4.52129501e+01  4.52129501e+01  7.22360222e+01  1.79088337e+02
  1.79088337e+02  1.79088337e+02  5.41764852e+02  5.81267563e+02
  5.81267563e+02  5.81267563e+02  1.45025010e+03  1.45025010e+03
  1.45025010e+03  2.59401395e+03  3.14770198e+03  3.14770198e+03
  3.14770198e+03  6.76269468e+03  6.76269468e+03  6.76269468e+03
  9.00293571e+03  2.53665844e+04  7.61152988e+04]
E1 = -728.320131320963  E_coul = 201.8517540322577
cycle= 3 E= -526.468377288705  delta_E= -1.31e-05  |g|= 0.00298  |ddm|= 0.00521
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00639706
diis-c [-3.60724438e-07 -1.09054514e-03  1.12540825e-01  8.88549720e-01]
  HOMO = -0.569875624220287  LUMO = 1.13023548166068
  mo_energy =
[-1.18556795e+02 -1.21846298e+01 -9.53538238e+00 -9.53538238e+00
 -9.53538238e+00 -1.24756244e+00 -5.69875624e-01 -5.69875624e-01
 -5.69875624e-01  1.13023548e+00  1.13023548e+00  1.13023548e+00
  9.20270593e+00  9.20270593e+00  9.20270593e+00  4.52096246e+01
  4.52096246e+01  4.52096246e+01  7.22318749e+01  1.79083830e+02
  1.79083830e+02  1.79083830e+02  5.41759464e+02  5.81262384e+02
  5.81262384e+02  5.81262384e+02  1.45024458e+03  1.45024458e+03
  1.45024458e+03  2.59400802e+03  3.14769622e+03  3.14769622e+03
  3.14769622e+03  6.76268867e+03  6.76268867e+03  6.76268867e+03
  9.00292956e+03  2.53665781e+04  7.61152924e+04]
E1 = -728.3283474013081  E_coul = 201.85996982530233
cycle= 4 E= -526.468377576006  delta_E= -2.87e-07  |g|= 4.14e-05  |ddm|= 0.000764
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.29597e-05
diis-c [-1.72047649e-09  8.85367318e-06 -1.89155751e-03 -9.35290587e-03
  1.01123561e+00]
  HOMO = -0.56984895386177  LUMO = 1.13025712168011
  mo_energy =
[-1.18556704e+02 -1.21845442e+01 -9.53529794e+00 -9.53529794e+00
 -9.53529794e+00 -1.24752782e+00 -5.69848954e-01 -5.69848954e-01
 -5.69848954e-01  1.13025712e+00  1.13025712e+00  1.13025712e+00
  9.20277232e+00  9.20277232e+00  9.20277232e+00  4.52097092e+01
  4.52097092e+01  4.52097092e+01  7.22319694e+01  1.79083921e+02
  1.79083921e+02  1.79083921e+02  5.41759552e+02  5.81262475e+02
  5.81262475e+02  5.81262475e+02  1.45024467e+03  1.45024467e+03
  1.45024467e+03  2.59400810e+03  3.14769630e+03  3.14769630e+03
  3.14769630e+03  6.76268875e+03  6.76268875e+03  6.76268875e+03
  9.00292963e+03  2.53665782e+04  7.61152925e+04]
E1 = -728.3281492116877  E_coul = 201.85977163555364
cycle= 5 E= -526.468377576134  delta_E= -1.28e-10  |g|= 7.27e-06  |ddm|= 2.31e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3281492116877  E_coul = 201.85977163555364
  HOMO = -0.569852675488811  LUMO = 1.13025408458635
  mo_energy =
[-1.18556721e+02 -1.21845572e+01 -9.53531121e+00 -9.53531121e+00
 -9.53531121e+00 -1.24753264e+00 -5.69852675e-01 -5.69852675e-01
 -5.69852675e-01  1.13025408e+00  1.13025408e+00  1.13025408e+00
  9.20276243e+00  9.20276243e+00  9.20276243e+00  4.52096952e+01
  4.52096952e+01  4.52096952e+01  7.22319535e+01  1.79083904e+02
  1.79083904e+02  1.79083904e+02  5.41759534e+02  5.81262457e+02
  5.81262457e+02  5.81262457e+02  1.45024465e+03  1.45024465e+03
  1.45024465e+03  2.59400808e+03  3.14769628e+03  3.14769628e+03
  3.14769628e+03  6.76268873e+03  6.76268873e+03  6.76268873e+03
  9.00292961e+03  2.53665782e+04  7.61152925e+04]
E1 = -728.3281830043296  E_coul = 201.8598054281925
Extra cycle  E= -526.468377576137  delta_E= -3.07e-12  |g|= 1.84e-06  |ddm|= 3.63e-06
    CPU time for scf_cycle      0.68 sec, wall time      0.29 sec
exp = [2.61825434e+04 7.61780955e+03 3.61730944e+03 1.60430881e+03
 3.72590843e+02 1.05054585e+02 3.41207638e+01 4.58071455e+00
 3.94787303e-01 1.36276298e+03 6.64789232e+02 3.01171142e+02
 3.14250758e+02 8.71346981e+01 9.28676602e+00 2.70869590e+01
 8.34599590e-01 3.37105614e+00 2.35929966e-01]
E = -526.4683775761371
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:44:37 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5434449        1
[INPUT] 0    0    [1    /1   ]  7617.80954853        1
[INPUT] 0    0    [1    /1   ]  3617.3094404         1
[INPUT] 0    0    [1    /1   ]  1604.3088121         1
[INPUT] 0    0    [1    /1   ]  372.590842899        1
[INPUT] 0    0    [1    /1   ]  105.054584537        1
[INPUT] 0    0    [1    /1   ]  34.1207637939        1
[INPUT] 0    0    [1    /1   ]  4.58071455203        1
[INPUT] 0    0    [1    /1   ]  0.394787302856       1
[INPUT] 1    0    [1    /1   ]  1362.76297991        1
[INPUT] 1    0    [1    /1   ]  664.789231528        1
[INPUT] 1    0    [1    /1   ]  301.171141653        1
[INPUT] 1    0    [1    /1   ]  314.25075799         1
[INPUT] 1    0    [1    /1   ]  87.1346981119        1
[INPUT] 1    0    [1    /1   ]  9.28676601766        1
[INPUT] 1    0    [1    /1   ]  27.0869589852        1
[INPUT] 1    0    [1    /1   ]  0.834599589691       1
[INPUT] 1    0    [1    /1   ]  3.37105613979        1
[INPUT] 1    0    [1    /1   ]  0.235929965649       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.54344487766, 1.0]], [0, [7617.809548532583, 1.0]], [0, [3617.3094403952227, 1.0]], [0, [1604.3088120953134, 1.0]], [0, [372.59084289948925, 1.0]], [0, [105.05458453702722, 1.0]], [0, [34.12076379385083, 1.0]], [0, [4.580714552033246, 1.0]], [0, [0.39478730285625047, 1.0]], [1, [1362.7629799084687, 1.0]], [1, [664.7892315275094, 1.0]], [1, [301.17114165333294, 1.0]], [1, [314.250757990337, 1.0]], [1, [87.1346981119486, 1.0]], [1, [9.286766017658588, 1.0]], [1, [27.086958985208923, 1.0]], [1, [0.8345995896913165, 1.0]], [1, [3.3710561397851677, 1.0]], [1, [0.23592996564923657, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.54344488]
bas 1, expnt(s) = [7617.80954853]
bas 2, expnt(s) = [3617.3094404]
bas 3, expnt(s) = [1604.3088121]
bas 4, expnt(s) = [372.5908429]
bas 5, expnt(s) = [105.05458454]
bas 6, expnt(s) = [34.12076379]
bas 7, expnt(s) = [4.58071455]
bas 8, expnt(s) = [0.3947873]
bas 9, expnt(s) = [1362.76297991]
bas 10, expnt(s) = [664.78923153]
bas 11, expnt(s) = [301.17114165]
bas 12, expnt(s) = [314.25075799]
bas 13, expnt(s) = [87.13469811]
bas 14, expnt(s) = [9.28676602]
bas 15, expnt(s) = [27.08695899]
bas 16, expnt(s) = [0.83459959]
bas 17, expnt(s) = [3.37105614]
bas 18, expnt(s) = [0.23592997]
CPU time:       664.10
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825434e+04 5.20024612e+03 7.61780955e+03 2.06009670e+03
 3.61730944e+03 1.17843130e+03 1.60430881e+03 6.40443764e+02
 3.72590843e+02 2.14259041e+02 1.05054585e+02 8.29041520e+01
 3.41207638e+01 3.56680266e+01 4.58071455e+00 7.91070057e+00
 3.94787303e-01 1.25830930e+00 1.36276298e+03 2.41551535e+04
 6.64789232e+02 9.84780323e+03 3.01171142e+02 3.66016856e+03
 3.14250758e+02 3.85993339e+03 8.71346981e+01 7.76646351e+02
 9.28676602e+00 4.72949774e+01 2.70869590e+01 1.80274668e+02
 8.34599590e-01 2.32719139e+00 3.37105614e+00 1.33257565e+01
 2.35929966e-01 4.79692881e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.974331213538576
cond(S) = 155988.96050154712
E1 = -728.8727910829084  E_coul = 203.11610481551736
init E= -525.756686267391
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558873361508291  LUMO = 1.13735645496412
  mo_energy =
[-1.18318716e+02 -1.21042797e+01 -9.44873673e+00 -9.44873673e+00
 -9.44873673e+00 -1.23032252e+00 -5.58873362e-01 -5.58873362e-01
 -5.58873362e-01  1.13735645e+00  1.13735645e+00  1.13735645e+00
  9.25706533e+00  9.25706533e+00  9.25706533e+00  4.53206829e+01
  4.53206829e+01  4.53206829e+01  7.23658008e+01  1.79260633e+02
  1.79260633e+02  1.79260633e+02  5.42029657e+02  5.81498287e+02
  5.81498287e+02  5.81498287e+02  1.45053291e+03  1.45053291e+03
  1.45053291e+03  2.59443202e+03  3.14804989e+03  3.14804989e+03
  3.14804989e+03  6.76315713e+03  6.76315713e+03  6.76315713e+03
  9.00347575e+03  2.53672190e+04  7.61160241e+04]
E1 = -728.0841411242408  E_coul = 201.61615541717813
cycle= 1 E= -526.467985707063  delta_E= -0.711  |g|= 0.185  |ddm|= 0.495
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.550147
diis-c [-0.30266171  1.        ]
  HOMO = -0.572899432116433  LUMO = 1.12759278885813
  mo_energy =
[-1.18594301e+02 -1.22021023e+01 -9.55315129e+00 -9.55315129e+00
 -9.55315129e+00 -1.25158874e+00 -5.72899432e-01 -5.72899432e-01
 -5.72899432e-01  1.12759279e+00  1.12759279e+00  1.12759279e+00
  9.19169457e+00  9.19169457e+00  9.19169457e+00  4.51883142e+01
  4.51883142e+01  4.51883142e+01  7.22023101e+01  1.79052338e+02
  1.79052338e+02  1.79052338e+02  5.41720774e+02  5.81225178e+02
  5.81225178e+02  5.81225178e+02  1.45020492e+03  1.45020492e+03
  1.45020492e+03  2.59396646e+03  3.14765519e+03  3.14765519e+03
  3.14765519e+03  6.76264687e+03  6.76264687e+03  6.76264687e+03
  9.00288746e+03  2.53665360e+04  7.61152503e+04]
E1 = -728.3809434237762  E_coul = 201.91257923333438
cycle= 2 E= -526.468364190442  delta_E= -0.000378  |g|= 0.0245  |ddm|= 0.0208
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0472048
diis-c [-0.0014334   0.04885988  0.95114012]
  HOMO = -0.569222987013984  LUMO = 1.13078184342923
  mo_energy =
[-1.18551571e+02 -1.21818125e+01 -9.53245872e+00 -9.53245872e+00
 -9.53245872e+00 -1.24671480e+00 -5.69222987e-01 -5.69222987e-01
 -5.69222987e-01  1.13078184e+00  1.13078184e+00  1.13078184e+00
  9.20469246e+00  9.20469246e+00  9.20469246e+00  4.52129501e+01
  4.52129501e+01  4.52129501e+01  7.22360222e+01  1.79088337e+02
  1.79088337e+02  1.79088337e+02  5.41764852e+02  5.81267563e+02
  5.81267563e+02  5.81267563e+02  1.45025010e+03  1.45025010e+03
  1.45025010e+03  2.59401395e+03  3.14770198e+03  3.14770198e+03
  3.14770198e+03  6.76269468e+03  6.76269468e+03  6.76269468e+03
  9.00293571e+03  2.53665844e+04  7.61152988e+04]
E1 = -728.320131320963  E_coul = 201.8517540322577
cycle= 3 E= -526.468377288705  delta_E= -1.31e-05  |g|= 0.00298  |ddm|= 0.00521
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00639706
diis-c [-3.60724438e-07 -1.09054514e-03  1.12540825e-01  8.88549720e-01]
  HOMO = -0.569875624220287  LUMO = 1.13023548166068
  mo_energy =
[-1.18556795e+02 -1.21846298e+01 -9.53538238e+00 -9.53538238e+00
 -9.53538238e+00 -1.24756244e+00 -5.69875624e-01 -5.69875624e-01
 -5.69875624e-01  1.13023548e+00  1.13023548e+00  1.13023548e+00
  9.20270593e+00  9.20270593e+00  9.20270593e+00  4.52096246e+01
  4.52096246e+01  4.52096246e+01  7.22318749e+01  1.79083830e+02
  1.79083830e+02  1.79083830e+02  5.41759464e+02  5.81262384e+02
  5.81262384e+02  5.81262384e+02  1.45024458e+03  1.45024458e+03
  1.45024458e+03  2.59400802e+03  3.14769622e+03  3.14769622e+03
  3.14769622e+03  6.76268867e+03  6.76268867e+03  6.76268867e+03
  9.00292956e+03  2.53665781e+04  7.61152924e+04]
E1 = -728.3283474013081  E_coul = 201.85996982530233
cycle= 4 E= -526.468377576006  delta_E= -2.87e-07  |g|= 4.14e-05  |ddm|= 0.000764
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.29597e-05
diis-c [-1.72047649e-09  8.85367318e-06 -1.89155751e-03 -9.35290587e-03
  1.01123561e+00]
  HOMO = -0.56984895386177  LUMO = 1.13025712168011
  mo_energy =
[-1.18556704e+02 -1.21845442e+01 -9.53529794e+00 -9.53529794e+00
 -9.53529794e+00 -1.24752782e+00 -5.69848954e-01 -5.69848954e-01
 -5.69848954e-01  1.13025712e+00  1.13025712e+00  1.13025712e+00
  9.20277232e+00  9.20277232e+00  9.20277232e+00  4.52097092e+01
  4.52097092e+01  4.52097092e+01  7.22319694e+01  1.79083921e+02
  1.79083921e+02  1.79083921e+02  5.41759552e+02  5.81262475e+02
  5.81262475e+02  5.81262475e+02  1.45024467e+03  1.45024467e+03
  1.45024467e+03  2.59400810e+03  3.14769630e+03  3.14769630e+03
  3.14769630e+03  6.76268875e+03  6.76268875e+03  6.76268875e+03
  9.00292963e+03  2.53665782e+04  7.61152925e+04]
E1 = -728.3281492116877  E_coul = 201.85977163555364
cycle= 5 E= -526.468377576134  delta_E= -1.28e-10  |g|= 7.27e-06  |ddm|= 2.31e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3281492116877  E_coul = 201.85977163555364
  HOMO = -0.569852675488811  LUMO = 1.13025408458635
  mo_energy =
[-1.18556721e+02 -1.21845572e+01 -9.53531121e+00 -9.53531121e+00
 -9.53531121e+00 -1.24753264e+00 -5.69852675e-01 -5.69852675e-01
 -5.69852675e-01  1.13025408e+00  1.13025408e+00  1.13025408e+00
  9.20276243e+00  9.20276243e+00  9.20276243e+00  4.52096952e+01
  4.52096952e+01  4.52096952e+01  7.22319535e+01  1.79083904e+02
  1.79083904e+02  1.79083904e+02  5.41759534e+02  5.81262457e+02
  5.81262457e+02  5.81262457e+02  1.45024465e+03  1.45024465e+03
  1.45024465e+03  2.59400808e+03  3.14769628e+03  3.14769628e+03
  3.14769628e+03  6.76268873e+03  6.76268873e+03  6.76268873e+03
  9.00292961e+03  2.53665782e+04  7.61152925e+04]
E1 = -728.3281830043296  E_coul = 201.8598054281925
Extra cycle  E= -526.468377576137  delta_E= -3.07e-12  |g|= 1.84e-06  |ddm|= 3.63e-06
    CPU time for scf_cycle      0.68 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 155988.96050154712
E1 = -728.3281830043296  E_coul = 201.8598054281925
init E= -526.468377576137
    CPU time for initialize scf      2.84 sec, wall time      0.27 sec
  HOMO = -0.569852043509037  LUMO = 1.13025460801365
  mo_energy =
[-1.18556717e+02 -1.21845547e+01 -9.53530866e+00 -9.53530866e+00
 -9.53530866e+00 -1.24753182e+00 -5.69852044e-01 -5.69852044e-01
 -5.69852044e-01  1.13025461e+00  1.13025461e+00  1.13025461e+00
  9.20276424e+00  9.20276424e+00  9.20276424e+00  4.52096980e+01
  4.52096980e+01  4.52096980e+01  7.22319569e+01  1.79083908e+02
  1.79083908e+02  1.79083908e+02  5.41759538e+02  5.81262461e+02
  5.81262461e+02  5.81262461e+02  1.45024465e+03  1.45024465e+03
  1.45024465e+03  2.59400808e+03  3.14769629e+03  3.14769629e+03
  3.14769629e+03  6.76268873e+03  6.76268873e+03  6.76268873e+03
  9.00292962e+03  2.53665782e+04  7.61152925e+04]
E1 = -728.3281761775679  E_coul = 201.85979860143135
cycle= 1 E= -526.468377576137  delta_E= 4.55e-13  |g|= 4.07e-07  |ddm|= 6.73e-07
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
E1 = -728.3281761775679  E_coul = 201.85979860143135
  HOMO = -0.569852163339537  LUMO = 1.13025450814487
  mo_energy =
[-1.18556718e+02 -1.21845552e+01 -9.53530918e+00 -9.53530918e+00
 -9.53530918e+00 -1.24753198e+00 -5.69852163e-01 -5.69852163e-01
 -5.69852163e-01  1.13025451e+00  1.13025451e+00  1.13025451e+00
  9.20276388e+00  9.20276388e+00  9.20276388e+00  4.52096974e+01
  4.52096974e+01  4.52096974e+01  7.22319561e+01  1.79083907e+02
  1.79083907e+02  1.79083907e+02  5.41759537e+02  5.81262460e+02
  5.81262460e+02  5.81262460e+02  1.45024465e+03  1.45024465e+03
  1.45024465e+03  2.59400808e+03  3.14769629e+03  3.14769629e+03
  3.14769629e+03  6.76268873e+03  6.76268873e+03  6.76268873e+03
  9.00292962e+03  2.53665782e+04  7.61152925e+04]
E1 = -728.328177579689  E_coul = 201.85980000355173
Extra cycle  E= -526.468377576137  delta_E= -6.82e-13  |g|= 8.64e-08  |ddm|= 1.34e-07
    CPU time for scf_cycle      2.99 sec, wall time      0.42 sec
exp = [2.61825434e+04 7.61780955e+03 3.61730944e+03 1.60430881e+03
 3.72590843e+02 1.05054585e+02 3.41207638e+01 4.58071455e+00
 3.94787303e-01 1.36276298e+03 6.64789232e+02 3.01171142e+02
 3.14250758e+02 8.71346981e+01 9.28676602e+00 2.70869590e+01
 8.34599590e-01 3.37105614e+00 2.35929966e-01]
grad_E = [-1.56341714e-06  3.90946600e-06 -8.67686973e-07  8.69496455e-05
 -1.00015752e-04 -5.84832893e-05  3.28428657e-05 -3.18702131e-05
 -9.60494781e-06 -2.66236957e-07  1.53547189e-08  5.52734249e-08
  4.70104758e-07  3.99443150e-04 -3.90555502e-05  1.52497046e-04
 -3.49413752e-04  1.71954447e-04  4.02362353e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:44:42 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5434332        1
[INPUT] 0    0    [1    /1   ]  7617.80971574        1
[INPUT] 0    0    [1    /1   ]  3617.30981109        1
[INPUT] 0    0    [1    /1   ]  1604.31414851        1
[INPUT] 0    0    [1    /1   ]  372.538542392        1
[INPUT] 0    0    [1    /1   ]  105.034549698        1
[INPUT] 0    0    [1    /1   ]  34.1140200011        1
[INPUT] 0    0    [1    /1   ]  4.58071634634        1
[INPUT] 0    0    [1    /1   ]  0.394802840022       1
[INPUT] 1    0    [1    /1   ]  1362.76299205        1
[INPUT] 1    0    [1    /1   ]  664.789384352        1
[INPUT] 1    0    [1    /1   ]  301.17198068         1
[INPUT] 1    0    [1    /1   ]  314.251497439        1
[INPUT] 1    0    [1    /1   ]  87.1196516757        1
[INPUT] 1    0    [1    /1   ]  9.28473250495        1
[INPUT] 1    0    [1    /1   ]  27.0805724064        1
[INPUT] 1    0    [1    /1   ]  0.834551500867       1
[INPUT] 1    0    [1    /1   ]  3.37012869213        1
[INPUT] 1    0    [1    /1   ]  0.235913142413       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.543433210798, 1.0]], [0, [7617.809715742916, 1.0]], [0, [3617.3098110883648, 1.0]], [0, [1604.3141485144852, 1.0]], [0, [372.53854239187416, 1.0]], [0, [105.03454969765669, 1.0]], [0, [34.1140200011323, 1.0]], [0, [4.580716346338952, 1.0]], [0, [0.39480284002173704, 1.0]], [1, [1362.7629920454772, 1.0]], [1, [664.7893843518583, 1.0]], [1, [301.1719806802127, 1.0]], [1, [314.2514974388252, 1.0]], [1, [87.11965167566214, 1.0]], [1, [9.2847325049483, 1.0]], [1, [27.08057240642471, 1.0]], [1, [0.8345515008668083, 1.0]], [1, [3.370128692132361, 1.0]], [1, [0.23591314241259423, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.54343321]
bas 1, expnt(s) = [7617.80971574]
bas 2, expnt(s) = [3617.30981109]
bas 3, expnt(s) = [1604.31414851]
bas 4, expnt(s) = [372.53854239]
bas 5, expnt(s) = [105.0345497]
bas 6, expnt(s) = [34.11402]
bas 7, expnt(s) = [4.58071635]
bas 8, expnt(s) = [0.39480284]
bas 9, expnt(s) = [1362.76299205]
bas 10, expnt(s) = [664.78938435]
bas 11, expnt(s) = [301.17198068]
bas 12, expnt(s) = [314.25149744]
bas 13, expnt(s) = [87.11965168]
bas 14, expnt(s) = [9.2847325]
bas 15, expnt(s) = [27.08057241]
bas 16, expnt(s) = [0.8345515]
bas 17, expnt(s) = [3.37012869]
bas 18, expnt(s) = [0.23591314]
CPU time:       672.59
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825434e+04 5.20024612e+03 7.61780972e+03 2.06009674e+03
 3.61730981e+03 1.17843139e+03 1.60431415e+03 6.40445361e+02
 3.72538542e+02 2.14236484e+02 1.05034550e+02 8.28922938e+01
 3.41140200e+01 3.56627393e+01 4.58071635e+00 7.91070290e+00
 3.94802840e-01 1.25834644e+00 1.36276299e+03 2.41551538e+04
 6.64789384e+02 9.84780606e+03 3.01171981e+02 3.66018131e+03
 3.14251497e+02 3.85994474e+03 8.71196517e+01 7.76478715e+02
 9.28473250e+00 4.72820326e+01 2.70805724e+01 1.80221538e+02
 8.34551501e-01 2.32702378e+00 3.37012869e+00 1.33211739e+01
 2.35913142e-01 4.79650125e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.974333186354215
cond(S) = 155943.5246413735
E1 = -728.8731861612004  E_coul = 203.11637171647848
init E= -525.756814444722
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558867007303552  LUMO = 1.13723969769339
  mo_energy =
[-1.18318696e+02 -1.21042537e+01 -9.44871664e+00 -9.44871664e+00
 -9.44871664e+00 -1.23031493e+00 -5.58867007e-01 -5.58867007e-01
 -5.58867007e-01  1.13723970e+00  1.13723970e+00  1.13723970e+00
  9.25437192e+00  9.25437192e+00  9.25437192e+00  4.53074018e+01
  4.53074018e+01  4.53074018e+01  7.23450812e+01  1.79220769e+02
  1.79220769e+02  1.79220769e+02  5.41917334e+02  5.81431540e+02
  5.81431540e+02  5.81431540e+02  1.45045628e+03  1.45045628e+03
  1.45045628e+03  2.59419779e+03  3.14797298e+03  3.14797298e+03
  3.14797298e+03  6.76308538e+03  6.76308538e+03  6.76308538e+03
  9.00320866e+03  2.53669559e+04  7.61157771e+04]
E1 = -728.0840408719772  E_coul = 201.6160549632343
cycle= 1 E= -526.467985908743  delta_E= -0.711  |g|= 0.185  |ddm|= 0.495
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.55017
diis-c [-0.30268674  1.        ]
  HOMO = -0.572900327299776  LUMO = 1.12747179449666
  mo_energy =
[-1.18594321e+02 -1.22021031e+01 -9.55315912e+00 -9.55315912e+00
 -9.55315912e+00 -1.25159130e+00 -5.72900327e-01 -5.72900327e-01
 -5.72900327e-01  1.12747179e+00  1.12747179e+00  1.12747179e+00
  9.18899318e+00  9.18899318e+00  9.18899318e+00  4.51750168e+01
  4.51750168e+01  4.51750168e+01  7.21815682e+01  1.79012444e+02
  1.79012444e+02  1.79012444e+02  5.41608418e+02  5.81158387e+02
  5.81158387e+02  5.81158387e+02  1.45012824e+03  1.45012824e+03
  1.45012824e+03  2.59373218e+03  3.14757823e+03  3.14757823e+03
  3.14757823e+03  6.76257506e+03  6.76257506e+03  6.76257506e+03
  9.00262030e+03  2.53662728e+04  7.61150033e+04]
E1 = -728.3809245783178  E_coul = 201.91256006442597
cycle= 2 E= -526.468364513892  delta_E= -0.000379  |g|= 0.0245  |ddm|= 0.0208
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0472149
diis-c [-0.00143384  0.04887278  0.95112722]
  HOMO = -0.569222641328244  LUMO = 1.13066152142172
  mo_energy =
[-1.18551582e+02 -1.21818080e+01 -9.53246104e+00 -9.53246104e+00
 -9.53246104e+00 -1.24671561e+00 -5.69222641e-01 -5.69222641e-01
 -5.69222641e-01  1.13066152e+00  1.13066152e+00  1.13066152e+00
  9.20199240e+00  9.20199240e+00  9.20199240e+00  4.51996563e+01
  4.51996563e+01  4.51996563e+01  7.22152854e+01  1.79048450e+02
  1.79048450e+02  1.79048450e+02  5.41652505e+02  5.81200782e+02
  5.81200782e+02  5.81200782e+02  1.45017343e+03  1.45017343e+03
  1.45017343e+03  2.59377968e+03  3.14762502e+03  3.14762502e+03
  3.14762502e+03  6.76262289e+03  6.76262289e+03  6.76262289e+03
  9.00266856e+03  2.53663212e+04  7.61150517e+04]
E1 = -728.320093529023  E_coul = 201.8517159094451
cycle= 3 E= -526.468377619578  delta_E= -1.31e-05  |g|= 0.00298  |ddm|= 0.00521
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00639848
diis-c [-3.60865388e-07 -1.09069902e-03  1.12541411e-01  8.88549288e-01]
  HOMO = -0.569875446577499  LUMO = 1.13011507912507
  mo_energy =
[-1.18556807e+02 -1.21846259e+01 -9.53538536e+00 -9.53538536e+00
 -9.53538536e+00 -1.24756348e+00 -5.69875447e-01 -5.69875447e-01
 -5.69875447e-01  1.13011508e+00  1.13011508e+00  1.13011508e+00
  9.20000570e+00  9.20000570e+00  9.20000570e+00  4.51963304e+01
  4.51963304e+01  4.51963304e+01  7.22111374e+01  1.79043942e+02
  1.79043942e+02  1.79043942e+02  5.41647116e+02  5.81195602e+02
  5.81195602e+02  5.81195602e+02  1.45016791e+03  1.45016791e+03
  1.45016791e+03  2.59377375e+03  3.14761926e+03  3.14761926e+03
  3.14761926e+03  6.76261687e+03  6.76261687e+03  6.76261687e+03
  9.00266241e+03  2.53663150e+04  7.61150454e+04]
E1 = -728.3283118628041  E_coul = 201.85993395577876
cycle= 4 E= -526.468377907025  delta_E= -2.87e-07  |g|= 4.14e-05  |ddm|= 0.000764
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.29516e-05
diis-c [-1.72106898e-09  8.84993564e-06 -1.89137968e-03 -9.35608948e-03
  1.01123862e+00]
  HOMO = -0.569848775124075  LUMO = 1.13013671774831
  mo_energy =
[-1.18556716e+02 -1.21845403e+01 -9.53530093e+00 -9.53530093e+00
 -9.53530093e+00 -1.24752885e+00 -5.69848775e-01 -5.69848775e-01
 -5.69848775e-01  1.13013672e+00  1.13013672e+00  1.13013672e+00
  9.20007208e+00  9.20007208e+00  9.20007208e+00  4.51964149e+01
  4.51964149e+01  4.51964149e+01  7.22112319e+01  1.79044032e+02
  1.79044032e+02  1.79044032e+02  5.41647203e+02  5.81195693e+02
  5.81195693e+02  5.81195693e+02  1.45016800e+03  1.45016800e+03
  1.45016800e+03  2.59377383e+03  3.14761934e+03  3.14761934e+03
  3.14761934e+03  6.76261695e+03  6.76261695e+03  6.76261695e+03
  9.00266248e+03  2.53663150e+04  7.61150455e+04]
E1 = -728.3281136625003  E_coul = 201.85973575534612
cycle= 5 E= -526.468377907154  delta_E= -1.29e-10  |g|= 7.27e-06  |ddm|= 2.31e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3281136625003  E_coul = 201.85973575534612
  HOMO = -0.569852497553663  LUMO = 1.13013368030828
  mo_energy =
[-1.18556734e+02 -1.21845533e+01 -9.53531420e+00 -9.53531420e+00
 -9.53531420e+00 -1.24753368e+00 -5.69852498e-01 -5.69852498e-01
 -5.69852498e-01  1.13013368e+00  1.13013368e+00  1.13013368e+00
  9.20006220e+00  9.20006220e+00  9.20006220e+00  4.51964010e+01
  4.51964010e+01  4.51964010e+01  7.22112160e+01  1.79044016e+02
  1.79044016e+02  1.79044016e+02  5.41647185e+02  5.81195675e+02
  5.81195675e+02  5.81195675e+02  1.45016798e+03  1.45016798e+03
  1.45016798e+03  2.59377381e+03  3.14761932e+03  3.14761932e+03
  3.14761932e+03  6.76261693e+03  6.76261693e+03  6.76261693e+03
  9.00266246e+03  2.53663150e+04  7.61150454e+04]
E1 = -728.3281474641021  E_coul = 201.8597695569452
Extra cycle  E= -526.468377907157  delta_E= -2.84e-12  |g|= 1.84e-06  |ddm|= 3.63e-06
    CPU time for scf_cycle      0.69 sec, wall time      0.30 sec
exp = [2.61825434e+04 7.61780972e+03 3.61730981e+03 1.60431415e+03
 3.72538542e+02 1.05034550e+02 3.41140200e+01 4.58071635e+00
 3.94802840e-01 1.36276299e+03 6.64789384e+02 3.01171981e+02
 3.14251497e+02 8.71196517e+01 9.28473250e+00 2.70805724e+01
 8.34551501e-01 3.37012869e+00 2.35913142e-01]
E = -526.468377907157
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:44:43 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5434332        1
[INPUT] 0    0    [1    /1   ]  7617.80971574        1
[INPUT] 0    0    [1    /1   ]  3617.30981109        1
[INPUT] 0    0    [1    /1   ]  1604.31414851        1
[INPUT] 0    0    [1    /1   ]  372.538542392        1
[INPUT] 0    0    [1    /1   ]  105.034549698        1
[INPUT] 0    0    [1    /1   ]  34.1140200011        1
[INPUT] 0    0    [1    /1   ]  4.58071634634        1
[INPUT] 0    0    [1    /1   ]  0.394802840022       1
[INPUT] 1    0    [1    /1   ]  1362.76299205        1
[INPUT] 1    0    [1    /1   ]  664.789384352        1
[INPUT] 1    0    [1    /1   ]  301.17198068         1
[INPUT] 1    0    [1    /1   ]  314.251497439        1
[INPUT] 1    0    [1    /1   ]  87.1196516757        1
[INPUT] 1    0    [1    /1   ]  9.28473250495        1
[INPUT] 1    0    [1    /1   ]  27.0805724064        1
[INPUT] 1    0    [1    /1   ]  0.834551500867       1
[INPUT] 1    0    [1    /1   ]  3.37012869213        1
[INPUT] 1    0    [1    /1   ]  0.235913142413       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.543433210798, 1.0]], [0, [7617.809715742916, 1.0]], [0, [3617.3098110883648, 1.0]], [0, [1604.3141485144852, 1.0]], [0, [372.53854239187416, 1.0]], [0, [105.03454969765669, 1.0]], [0, [34.1140200011323, 1.0]], [0, [4.580716346338952, 1.0]], [0, [0.39480284002173704, 1.0]], [1, [1362.7629920454772, 1.0]], [1, [664.7893843518583, 1.0]], [1, [301.1719806802127, 1.0]], [1, [314.2514974388252, 1.0]], [1, [87.11965167566214, 1.0]], [1, [9.2847325049483, 1.0]], [1, [27.08057240642471, 1.0]], [1, [0.8345515008668083, 1.0]], [1, [3.370128692132361, 1.0]], [1, [0.23591314241259423, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.54343321]
bas 1, expnt(s) = [7617.80971574]
bas 2, expnt(s) = [3617.30981109]
bas 3, expnt(s) = [1604.31414851]
bas 4, expnt(s) = [372.53854239]
bas 5, expnt(s) = [105.0345497]
bas 6, expnt(s) = [34.11402]
bas 7, expnt(s) = [4.58071635]
bas 8, expnt(s) = [0.39480284]
bas 9, expnt(s) = [1362.76299205]
bas 10, expnt(s) = [664.78938435]
bas 11, expnt(s) = [301.17198068]
bas 12, expnt(s) = [314.25149744]
bas 13, expnt(s) = [87.11965168]
bas 14, expnt(s) = [9.2847325]
bas 15, expnt(s) = [27.08057241]
bas 16, expnt(s) = [0.8345515]
bas 17, expnt(s) = [3.37012869]
bas 18, expnt(s) = [0.23591314]
CPU time:       673.55
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825434e+04 5.20024612e+03 7.61780972e+03 2.06009674e+03
 3.61730981e+03 1.17843139e+03 1.60431415e+03 6.40445361e+02
 3.72538542e+02 2.14236484e+02 1.05034550e+02 8.28922938e+01
 3.41140200e+01 3.56627393e+01 4.58071635e+00 7.91070290e+00
 3.94802840e-01 1.25834644e+00 1.36276299e+03 2.41551538e+04
 6.64789384e+02 9.84780606e+03 3.01171981e+02 3.66018131e+03
 3.14251497e+02 3.85994474e+03 8.71196517e+01 7.76478715e+02
 9.28473250e+00 4.72820326e+01 2.70805724e+01 1.80221538e+02
 8.34551501e-01 2.32702378e+00 3.37012869e+00 1.33211739e+01
 2.35913142e-01 4.79650125e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.974333186354215
cond(S) = 155943.5246413735
E1 = -728.8731861612004  E_coul = 203.11637171647848
init E= -525.756814444722
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558867007303552  LUMO = 1.13723969769339
  mo_energy =
[-1.18318696e+02 -1.21042537e+01 -9.44871664e+00 -9.44871664e+00
 -9.44871664e+00 -1.23031493e+00 -5.58867007e-01 -5.58867007e-01
 -5.58867007e-01  1.13723970e+00  1.13723970e+00  1.13723970e+00
  9.25437192e+00  9.25437192e+00  9.25437192e+00  4.53074018e+01
  4.53074018e+01  4.53074018e+01  7.23450812e+01  1.79220769e+02
  1.79220769e+02  1.79220769e+02  5.41917334e+02  5.81431540e+02
  5.81431540e+02  5.81431540e+02  1.45045628e+03  1.45045628e+03
  1.45045628e+03  2.59419779e+03  3.14797298e+03  3.14797298e+03
  3.14797298e+03  6.76308538e+03  6.76308538e+03  6.76308538e+03
  9.00320866e+03  2.53669559e+04  7.61157771e+04]
E1 = -728.0840408719772  E_coul = 201.6160549632343
cycle= 1 E= -526.467985908743  delta_E= -0.711  |g|= 0.185  |ddm|= 0.495
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.55017
diis-c [-0.30268674  1.        ]
  HOMO = -0.572900327299776  LUMO = 1.12747179449666
  mo_energy =
[-1.18594321e+02 -1.22021031e+01 -9.55315912e+00 -9.55315912e+00
 -9.55315912e+00 -1.25159130e+00 -5.72900327e-01 -5.72900327e-01
 -5.72900327e-01  1.12747179e+00  1.12747179e+00  1.12747179e+00
  9.18899318e+00  9.18899318e+00  9.18899318e+00  4.51750168e+01
  4.51750168e+01  4.51750168e+01  7.21815682e+01  1.79012444e+02
  1.79012444e+02  1.79012444e+02  5.41608418e+02  5.81158387e+02
  5.81158387e+02  5.81158387e+02  1.45012824e+03  1.45012824e+03
  1.45012824e+03  2.59373218e+03  3.14757823e+03  3.14757823e+03
  3.14757823e+03  6.76257506e+03  6.76257506e+03  6.76257506e+03
  9.00262030e+03  2.53662728e+04  7.61150033e+04]
E1 = -728.3809245783178  E_coul = 201.91256006442597
cycle= 2 E= -526.468364513892  delta_E= -0.000379  |g|= 0.0245  |ddm|= 0.0208
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0472149
diis-c [-0.00143384  0.04887278  0.95112722]
  HOMO = -0.569222641328244  LUMO = 1.13066152142172
  mo_energy =
[-1.18551582e+02 -1.21818080e+01 -9.53246104e+00 -9.53246104e+00
 -9.53246104e+00 -1.24671561e+00 -5.69222641e-01 -5.69222641e-01
 -5.69222641e-01  1.13066152e+00  1.13066152e+00  1.13066152e+00
  9.20199240e+00  9.20199240e+00  9.20199240e+00  4.51996563e+01
  4.51996563e+01  4.51996563e+01  7.22152854e+01  1.79048450e+02
  1.79048450e+02  1.79048450e+02  5.41652505e+02  5.81200782e+02
  5.81200782e+02  5.81200782e+02  1.45017343e+03  1.45017343e+03
  1.45017343e+03  2.59377968e+03  3.14762502e+03  3.14762502e+03
  3.14762502e+03  6.76262289e+03  6.76262289e+03  6.76262289e+03
  9.00266856e+03  2.53663212e+04  7.61150517e+04]
E1 = -728.320093529023  E_coul = 201.8517159094451
cycle= 3 E= -526.468377619578  delta_E= -1.31e-05  |g|= 0.00298  |ddm|= 0.00521
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00639848
diis-c [-3.60865388e-07 -1.09069902e-03  1.12541411e-01  8.88549288e-01]
  HOMO = -0.569875446577499  LUMO = 1.13011507912507
  mo_energy =
[-1.18556807e+02 -1.21846259e+01 -9.53538536e+00 -9.53538536e+00
 -9.53538536e+00 -1.24756348e+00 -5.69875447e-01 -5.69875447e-01
 -5.69875447e-01  1.13011508e+00  1.13011508e+00  1.13011508e+00
  9.20000570e+00  9.20000570e+00  9.20000570e+00  4.51963304e+01
  4.51963304e+01  4.51963304e+01  7.22111374e+01  1.79043942e+02
  1.79043942e+02  1.79043942e+02  5.41647116e+02  5.81195602e+02
  5.81195602e+02  5.81195602e+02  1.45016791e+03  1.45016791e+03
  1.45016791e+03  2.59377375e+03  3.14761926e+03  3.14761926e+03
  3.14761926e+03  6.76261687e+03  6.76261687e+03  6.76261687e+03
  9.00266241e+03  2.53663150e+04  7.61150454e+04]
E1 = -728.3283118628041  E_coul = 201.85993395577876
cycle= 4 E= -526.468377907025  delta_E= -2.87e-07  |g|= 4.14e-05  |ddm|= 0.000764
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.29516e-05
diis-c [-1.72106898e-09  8.84993564e-06 -1.89137968e-03 -9.35608948e-03
  1.01123862e+00]
  HOMO = -0.569848775124075  LUMO = 1.13013671774831
  mo_energy =
[-1.18556716e+02 -1.21845403e+01 -9.53530093e+00 -9.53530093e+00
 -9.53530093e+00 -1.24752885e+00 -5.69848775e-01 -5.69848775e-01
 -5.69848775e-01  1.13013672e+00  1.13013672e+00  1.13013672e+00
  9.20007208e+00  9.20007208e+00  9.20007208e+00  4.51964149e+01
  4.51964149e+01  4.51964149e+01  7.22112319e+01  1.79044032e+02
  1.79044032e+02  1.79044032e+02  5.41647203e+02  5.81195693e+02
  5.81195693e+02  5.81195693e+02  1.45016800e+03  1.45016800e+03
  1.45016800e+03  2.59377383e+03  3.14761934e+03  3.14761934e+03
  3.14761934e+03  6.76261695e+03  6.76261695e+03  6.76261695e+03
  9.00266248e+03  2.53663150e+04  7.61150455e+04]
E1 = -728.3281136625003  E_coul = 201.85973575534612
cycle= 5 E= -526.468377907154  delta_E= -1.29e-10  |g|= 7.27e-06  |ddm|= 2.31e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3281136625003  E_coul = 201.85973575534612
  HOMO = -0.569852497553663  LUMO = 1.13013368030828
  mo_energy =
[-1.18556734e+02 -1.21845533e+01 -9.53531420e+00 -9.53531420e+00
 -9.53531420e+00 -1.24753368e+00 -5.69852498e-01 -5.69852498e-01
 -5.69852498e-01  1.13013368e+00  1.13013368e+00  1.13013368e+00
  9.20006220e+00  9.20006220e+00  9.20006220e+00  4.51964010e+01
  4.51964010e+01  4.51964010e+01  7.22112160e+01  1.79044016e+02
  1.79044016e+02  1.79044016e+02  5.41647185e+02  5.81195675e+02
  5.81195675e+02  5.81195675e+02  1.45016798e+03  1.45016798e+03
  1.45016798e+03  2.59377381e+03  3.14761932e+03  3.14761932e+03
  3.14761932e+03  6.76261693e+03  6.76261693e+03  6.76261693e+03
  9.00266246e+03  2.53663150e+04  7.61150454e+04]
E1 = -728.3281474641021  E_coul = 201.8597695569452
Extra cycle  E= -526.468377907157  delta_E= -2.84e-12  |g|= 1.84e-06  |ddm|= 3.63e-06
    CPU time for scf_cycle      0.68 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 155943.5246413735
E1 = -728.3281474641021  E_coul = 201.8597695569452
init E= -526.468377907157
    CPU time for initialize scf      2.73 sec, wall time      0.25 sec
  HOMO = -0.569851865405721  LUMO = 1.13013420381907
  mo_energy =
[-1.18556730e+02 -1.21845508e+01 -9.53531165e+00 -9.53531165e+00
 -9.53531165e+00 -1.24753286e+00 -5.69851865e-01 -5.69851865e-01
 -5.69851865e-01  1.13013420e+00  1.13013420e+00  1.13013420e+00
  9.20006400e+00  9.20006400e+00  9.20006400e+00  4.51964038e+01
  4.51964038e+01  4.51964038e+01  7.22112194e+01  1.79044019e+02
  1.79044019e+02  1.79044019e+02  5.41647190e+02  5.81195679e+02
  5.81195679e+02  5.81195679e+02  1.45016799e+03  1.45016799e+03
  1.45016799e+03  2.59377381e+03  3.14761933e+03  3.14761933e+03
  3.14761933e+03  6.76261694e+03  6.76261694e+03  6.76261694e+03
  9.00266247e+03  2.53663150e+04  7.61150455e+04]
E1 = -728.328140635116  E_coul = 201.85976272795813
cycle= 1 E= -526.468377907158  delta_E= -9.09e-13  |g|= 4.07e-07  |ddm|= 6.73e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.328140635116  E_coul = 201.85976272795813
  HOMO = -0.569851985275112  LUMO = 1.13013410392818
  mo_energy =
[-1.18556731e+02 -1.21845513e+01 -9.53531216e+00 -9.53531216e+00
 -9.53531216e+00 -1.24753301e+00 -5.69851985e-01 -5.69851985e-01
 -5.69851985e-01  1.13013410e+00  1.13013410e+00  1.13013410e+00
  9.20006365e+00  9.20006365e+00  9.20006365e+00  4.51964032e+01
  4.51964032e+01  4.51964032e+01  7.22112187e+01  1.79044019e+02
  1.79044019e+02  1.79044019e+02  5.41647189e+02  5.81195678e+02
  5.81195678e+02  5.81195678e+02  1.45016798e+03  1.45016798e+03
  1.45016798e+03  2.59377381e+03  3.14761933e+03  3.14761933e+03
  3.14761933e+03  6.76261694e+03  6.76261694e+03  6.76261694e+03
  9.00266247e+03  2.53663150e+04  7.61150455e+04]
E1 = -728.3281420377714  E_coul = 201.8597641306139
Extra cycle  E= -526.468377907157  delta_E= 4.55e-13  |g|= 8.64e-08  |ddm|= 1.34e-07
    CPU time for scf_cycle      2.88 sec, wall time      0.39 sec
exp = [2.61825434e+04 7.61780972e+03 3.61730981e+03 1.60431415e+03
 3.72538542e+02 1.05034550e+02 3.41140200e+01 4.58071635e+00
 3.94802840e-01 1.36276299e+03 6.64789384e+02 3.01171981e+02
 3.14251497e+02 8.71196517e+01 9.28473250e+00 2.70805724e+01
 8.34551501e-01 3.37012869e+00 2.35913142e-01]
grad_E = [-1.56364227e-06  3.91228172e-06 -8.64835793e-07  8.70378681e-05
 -1.00674463e-04 -5.50875195e-05  1.54228988e-05 -1.96660219e-05
  2.22634093e-04 -2.65772366e-07  1.54048136e-08  5.55848066e-08
  4.71371059e-07  4.00812011e-04  2.25097072e-05  1.38647007e-04
 -2.82852006e-04  3.59618230e-05  3.18927298e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:44:47 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5434126        1
[INPUT] 0    0    [1    /1   ]  7617.81004084        1
[INPUT] 0    0    [1    /1   ]  3617.3105462         1
[INPUT] 0    0    [1    /1   ]  1604.32458813        1
[INPUT] 0    0    [1    /1   ]  372.433867613        1
[INPUT] 0    0    [1    /1   ]  105.000650014        1
[INPUT] 0    0    [1    /1   ]  34.1034983713        1
[INPUT] 0    0    [1    /1   ]  4.58071358117        1
[INPUT] 0    0    [1    /1   ]  0.394811138767       1
[INPUT] 1    0    [1    /1   ]  1362.7630165         1
[INPUT] 1    0    [1    /1   ]  664.789687311        1
[INPUT] 1    0    [1    /1   ]  301.173644447        1
[INPUT] 1    0    [1    /1   ]  314.252962949        1
[INPUT] 1    0    [1    /1   ]  87.0883549591        1
[INPUT] 1    0    [1    /1   ]  9.28173983716        1
[INPUT] 1    0    [1    /1   ]  27.070431299         1
[INPUT] 1    0    [1    /1   ]  0.834636749992       1
[INPUT] 1    0    [1    /1   ]  3.36868767366        1
[INPUT] 1    0    [1    /1   ]  0.235930131933       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.54341257374, 1.0]], [0, [7617.8100408399, 1.0]], [0, [3617.3105461959694, 1.0]], [0, [1604.3245881278742, 1.0]], [0, [372.43386761303105, 1.0]], [0, [105.00065001400831, 1.0]], [0, [34.10349837131225, 1.0]], [0, [4.580713581170416, 1.0]], [0, [0.3948111387669461, 1.0]], [1, [1362.7630165024295, 1.0]], [1, [664.78968731123, 1.0]], [1, [301.1736444465385, 1.0]], [1, [314.2529629490517, 1.0]], [1, [87.08835495908122, 1.0]], [1, [9.28173983716384, 1.0]], [1, [27.070431298992162, 1.0]], [1, [0.8346367499918279, 1.0]], [1, [3.3686876736626004, 1.0]], [1, [0.23593013193294743, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.54341257]
bas 1, expnt(s) = [7617.81004084]
bas 2, expnt(s) = [3617.3105462]
bas 3, expnt(s) = [1604.32458813]
bas 4, expnt(s) = [372.43386761]
bas 5, expnt(s) = [105.00065001]
bas 6, expnt(s) = [34.10349837]
bas 7, expnt(s) = [4.58071358]
bas 8, expnt(s) = [0.39481114]
bas 9, expnt(s) = [1362.7630165]
bas 10, expnt(s) = [664.78968731]
bas 11, expnt(s) = [301.17364445]
bas 12, expnt(s) = [314.25296295]
bas 13, expnt(s) = [87.08835496]
bas 14, expnt(s) = [9.28173984]
bas 15, expnt(s) = [27.0704313]
bas 16, expnt(s) = [0.83463675]
bas 17, expnt(s) = [3.36868767]
bas 18, expnt(s) = [0.23593013]
CPU time:       681.98
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825434e+04 5.20024612e+03 7.61781004e+03 2.06009680e+03
 3.61731055e+03 1.17843157e+03 1.60432459e+03 6.40448487e+02
 3.72433868e+02 2.14191336e+02 1.05000650e+02 8.28722280e+01
 3.41034984e+01 3.56544895e+01 4.58071358e+00 7.91069931e+00
 3.94811139e-01 1.25836628e+00 1.36276302e+03 2.41551543e+04
 6.64789687e+02 9.84781167e+03 3.01173644e+02 3.66020658e+03
 3.14252963e+02 3.85996724e+03 8.70883550e+01 7.76130055e+02
 9.28173984e+00 4.72629833e+01 2.70704313e+01 1.80137181e+02
 8.34636750e-01 2.32732091e+00 3.36868767e+00 1.33140544e+01
 2.35930132e-01 4.79693303e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.974330346272765
cond(S) = 155857.39040186311
E1 = -728.8735757531404  E_coul = 203.1165722283987
init E= -525.757003524742
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558862378607251  LUMO = 1.13737176538354
  mo_energy =
[-1.18318680e+02 -1.21042297e+01 -9.44870347e+00 -9.44870347e+00
 -9.44870347e+00 -1.23030929e+00 -5.58862379e-01 -5.58862379e-01
 -5.58862379e-01  1.13737177e+00  1.13737177e+00  1.13737177e+00
  9.25099983e+00  9.25099983e+00  9.25099983e+00  4.52875966e+01
  4.52875966e+01  4.52875966e+01  7.23116478e+01  1.79152792e+02
  1.79152792e+02  1.79152792e+02  5.41719323e+02  5.81308873e+02
  5.81308873e+02  5.81308873e+02  1.45031226e+03  1.45031226e+03
  1.45031226e+03  2.59376196e+03  3.14782736e+03  3.14782736e+03
  3.14782736e+03  6.76294920e+03  6.76294920e+03  6.76294920e+03
  9.00270585e+03  2.53664595e+04  7.61153109e+04]
E1 = -728.0841008366369  E_coul = 201.61611432632498
cycle= 1 E= -526.467986510312  delta_E= -0.711  |g|= 0.185  |ddm|= 0.495
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.550205
diis-c [-0.30272521  1.        ]
  HOMO = -0.572895533375199  LUMO = 1.12760282468753
  mo_energy =
[-1.18594331e+02 -1.22020888e+01 -9.55315765e+00 -9.55315765e+00
 -9.55315765e+00 -1.25158520e+00 -5.72895533e-01 -5.72895533e-01
 -5.72895533e-01  1.12760282e+00  1.12760282e+00  1.12760282e+00
  9.18563345e+00  9.18563345e+00  9.18563345e+00  4.51552192e+01
  4.51552192e+01  4.51552192e+01  7.21481374e+01  1.78944461e+02
  1.78944461e+02  1.78944461e+02  5.41410396e+02  5.81035689e+02
  5.81035689e+02  5.81035689e+02  1.44998418e+03  1.44998418e+03
  1.44998418e+03  2.59329631e+03  3.14743256e+03  3.14743256e+03
  3.14743256e+03  6.76243882e+03  6.76243882e+03  6.76243882e+03
  9.00211744e+03  2.53657764e+04  7.61145370e+04]
E1 = -728.3810301206962  E_coul = 201.91266491095317
cycle= 2 E= -526.468365209743  delta_E= -0.000379  |g|= 0.0245  |ddm|= 0.0208
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0472252
diis-c [-0.00143429  0.04888524  0.95111476]
  HOMO = -0.5692176738908  LUMO = 1.13079292527418
  mo_energy =
[-1.18551585e+02 -1.21817908e+01 -9.53245659e+00 -9.53245659e+00
 -9.53245659e+00 -1.24670915e+00 -5.69217674e-01 -5.69217674e-01
 -5.69217674e-01  1.13079293e+00  1.13079293e+00  1.13079293e+00
  9.19863052e+00  9.19863052e+00  9.19863052e+00  4.51798582e+01
  4.51798582e+01  4.51798582e+01  7.21818555e+01  1.78980470e+02
  1.78980470e+02  1.78980470e+02  5.41454490e+02  5.81078091e+02
  5.81078091e+02  5.81078091e+02  1.45002937e+03  1.45002937e+03
  1.45002937e+03  2.59334382e+03  3.14747936e+03  3.14747936e+03
  3.14747936e+03  6.76248666e+03  6.76248666e+03  6.76248666e+03
  9.00216571e+03  2.53658248e+04  7.61145855e+04]
E1 = -728.3201857614456  E_coul = 201.85180744009133
cycle= 3 E= -526.468378321354  delta_E= -1.31e-05  |g|= 0.00298  |ddm|= 0.00521
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00639997
diis-c [-3.61092252e-07 -1.09091620e-03  1.12541936e-01  8.88548980e-01]
  HOMO = -0.569870555444125  LUMO = 1.13024638059361
  mo_energy =
[-1.18556811e+02 -1.21846091e+01 -9.53538135e+00 -9.53538135e+00
 -9.53538135e+00 -1.24755711e+00 -5.69870555e-01 -5.69870555e-01
 -5.69870555e-01  1.13024638e+00  1.13024638e+00  1.13024638e+00
  9.19664399e+00  9.19664399e+00  9.19664399e+00  4.51765322e+01
  4.51765322e+01  4.51765322e+01  7.21777073e+01  1.78975961e+02
  1.78975961e+02  1.78975961e+02  5.41449100e+02  5.81072910e+02
  5.81072910e+02  5.81072910e+02  1.45002385e+03  1.45002385e+03
  1.45002385e+03  2.59333788e+03  3.14747360e+03  3.14747360e+03
  3.14747360e+03  6.76248064e+03  6.76248064e+03  6.76248064e+03
  9.00215955e+03  2.53658186e+04  7.61145791e+04]
E1 = -728.3284057134235  E_coul = 201.86002710449964
cycle= 4 E= -526.468378608924  delta_E= -2.88e-07  |g|= 4.14e-05  |ddm|= 0.000764
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.29429e-05
diis-c [-1.72192021e-09  8.83761197e-06 -1.89041474e-03 -9.35372679e-03
  1.01123530e+00]
  HOMO = -0.569843883668398  LUMO = 1.1302680207455
  mo_energy =
[-1.18556720e+02 -1.21845235e+01 -9.53529691e+00 -9.53529691e+00
 -9.53529691e+00 -1.24752248e+00 -5.69843884e-01 -5.69843884e-01
 -5.69843884e-01  1.13026802e+00  1.13026802e+00  1.13026802e+00
  9.19671037e+00  9.19671037e+00  9.19671037e+00  4.51766167e+01
  4.51766167e+01  4.51766167e+01  7.21778018e+01  1.78976052e+02
  1.78976052e+02  1.78976052e+02  5.41449187e+02  5.81073001e+02
  5.81073001e+02  5.81073001e+02  1.45002394e+03  1.45002394e+03
  1.45002394e+03  2.59333796e+03  3.14747368e+03  3.14747368e+03
  3.14747368e+03  6.76248072e+03  6.76248072e+03  6.76248072e+03
  9.00215963e+03  2.53658186e+04  7.61145792e+04]
E1 = -728.328207499315  E_coul = 201.8598288902653
cycle= 5 E= -526.46837860905  delta_E= -1.26e-10  |g|= 7.28e-06  |ddm|= 2.31e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.328207499315  E_coul = 201.8598288902653
  HOMO = -0.569847606826867  LUMO = 1.13026498249181
  mo_energy =
[-1.18556738e+02 -1.21845365e+01 -9.53531018e+00 -9.53531018e+00
 -9.53531018e+00 -1.24752731e+00 -5.69847607e-01 -5.69847607e-01
 -5.69847607e-01  1.13026498e+00  1.13026498e+00  1.13026498e+00
  9.19670049e+00  9.19670049e+00  9.19670049e+00  4.51766027e+01
  4.51766027e+01  4.51766027e+01  7.21777859e+01  1.78976035e+02
  1.78976035e+02  1.78976035e+02  5.41449169e+02  5.81072983e+02
  5.81072983e+02  5.81072983e+02  1.45002392e+03  1.45002392e+03
  1.45002392e+03  2.59333794e+03  3.14747366e+03  3.14747366e+03
  3.14747366e+03  6.76248070e+03  6.76248070e+03  6.76248070e+03
  9.00215961e+03  2.53658186e+04  7.61145792e+04]
E1 = -728.328241310464  E_coul = 201.85986270141004
Extra cycle  E= -526.468378609054  delta_E= -4.21e-12  |g|= 1.84e-06  |ddm|= 3.63e-06
    CPU time for scf_cycle      0.69 sec, wall time      0.30 sec
exp = [2.61825434e+04 7.61781004e+03 3.61731055e+03 1.60432459e+03
 3.72433868e+02 1.05000650e+02 3.41034984e+01 4.58071358e+00
 3.94811139e-01 1.36276302e+03 6.64789687e+02 3.01173644e+02
 3.14252963e+02 8.70883550e+01 9.28173984e+00 2.70704313e+01
 8.34636750e-01 3.36868767e+00 2.35930132e-01]
E = -526.468378609054
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:44:48 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5434126        1
[INPUT] 0    0    [1    /1   ]  7617.81004084        1
[INPUT] 0    0    [1    /1   ]  3617.3105462         1
[INPUT] 0    0    [1    /1   ]  1604.32458813        1
[INPUT] 0    0    [1    /1   ]  372.433867613        1
[INPUT] 0    0    [1    /1   ]  105.000650014        1
[INPUT] 0    0    [1    /1   ]  34.1034983713        1
[INPUT] 0    0    [1    /1   ]  4.58071358117        1
[INPUT] 0    0    [1    /1   ]  0.394811138767       1
[INPUT] 1    0    [1    /1   ]  1362.7630165         1
[INPUT] 1    0    [1    /1   ]  664.789687311        1
[INPUT] 1    0    [1    /1   ]  301.173644447        1
[INPUT] 1    0    [1    /1   ]  314.252962949        1
[INPUT] 1    0    [1    /1   ]  87.0883549591        1
[INPUT] 1    0    [1    /1   ]  9.28173983716        1
[INPUT] 1    0    [1    /1   ]  27.070431299         1
[INPUT] 1    0    [1    /1   ]  0.834636749992       1
[INPUT] 1    0    [1    /1   ]  3.36868767366        1
[INPUT] 1    0    [1    /1   ]  0.235930131933       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.54341257374, 1.0]], [0, [7617.8100408399, 1.0]], [0, [3617.3105461959694, 1.0]], [0, [1604.3245881278742, 1.0]], [0, [372.43386761303105, 1.0]], [0, [105.00065001400831, 1.0]], [0, [34.10349837131225, 1.0]], [0, [4.580713581170416, 1.0]], [0, [0.3948111387669461, 1.0]], [1, [1362.7630165024295, 1.0]], [1, [664.78968731123, 1.0]], [1, [301.1736444465385, 1.0]], [1, [314.2529629490517, 1.0]], [1, [87.08835495908122, 1.0]], [1, [9.28173983716384, 1.0]], [1, [27.070431298992162, 1.0]], [1, [0.8346367499918279, 1.0]], [1, [3.3686876736626004, 1.0]], [1, [0.23593013193294743, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.54341257]
bas 1, expnt(s) = [7617.81004084]
bas 2, expnt(s) = [3617.3105462]
bas 3, expnt(s) = [1604.32458813]
bas 4, expnt(s) = [372.43386761]
bas 5, expnt(s) = [105.00065001]
bas 6, expnt(s) = [34.10349837]
bas 7, expnt(s) = [4.58071358]
bas 8, expnt(s) = [0.39481114]
bas 9, expnt(s) = [1362.7630165]
bas 10, expnt(s) = [664.78968731]
bas 11, expnt(s) = [301.17364445]
bas 12, expnt(s) = [314.25296295]
bas 13, expnt(s) = [87.08835496]
bas 14, expnt(s) = [9.28173984]
bas 15, expnt(s) = [27.0704313]
bas 16, expnt(s) = [0.83463675]
bas 17, expnt(s) = [3.36868767]
bas 18, expnt(s) = [0.23593013]
CPU time:       682.95
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825434e+04 5.20024612e+03 7.61781004e+03 2.06009680e+03
 3.61731055e+03 1.17843157e+03 1.60432459e+03 6.40448487e+02
 3.72433868e+02 2.14191336e+02 1.05000650e+02 8.28722280e+01
 3.41034984e+01 3.56544895e+01 4.58071358e+00 7.91069931e+00
 3.94811139e-01 1.25836628e+00 1.36276302e+03 2.41551543e+04
 6.64789687e+02 9.84781167e+03 3.01173644e+02 3.66020658e+03
 3.14252963e+02 3.85996724e+03 8.70883550e+01 7.76130055e+02
 9.28173984e+00 4.72629833e+01 2.70704313e+01 1.80137181e+02
 8.34636750e-01 2.32732091e+00 3.36868767e+00 1.33140544e+01
 2.35930132e-01 4.79693303e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.974330346272765
cond(S) = 155857.39040186311
E1 = -728.8735757531404  E_coul = 203.1165722283987
init E= -525.757003524742
    CPU time for initialize scf      0.45 sec, wall time      0.06 sec
  HOMO = -0.558862378607251  LUMO = 1.13737176538354
  mo_energy =
[-1.18318680e+02 -1.21042297e+01 -9.44870347e+00 -9.44870347e+00
 -9.44870347e+00 -1.23030929e+00 -5.58862379e-01 -5.58862379e-01
 -5.58862379e-01  1.13737177e+00  1.13737177e+00  1.13737177e+00
  9.25099983e+00  9.25099983e+00  9.25099983e+00  4.52875966e+01
  4.52875966e+01  4.52875966e+01  7.23116478e+01  1.79152792e+02
  1.79152792e+02  1.79152792e+02  5.41719323e+02  5.81308873e+02
  5.81308873e+02  5.81308873e+02  1.45031226e+03  1.45031226e+03
  1.45031226e+03  2.59376196e+03  3.14782736e+03  3.14782736e+03
  3.14782736e+03  6.76294920e+03  6.76294920e+03  6.76294920e+03
  9.00270585e+03  2.53664595e+04  7.61153109e+04]
E1 = -728.0841008366369  E_coul = 201.61611432632498
cycle= 1 E= -526.467986510312  delta_E= -0.711  |g|= 0.185  |ddm|= 0.495
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.550205
diis-c [-0.30272521  1.        ]
  HOMO = -0.572895533375199  LUMO = 1.12760282468753
  mo_energy =
[-1.18594331e+02 -1.22020888e+01 -9.55315765e+00 -9.55315765e+00
 -9.55315765e+00 -1.25158520e+00 -5.72895533e-01 -5.72895533e-01
 -5.72895533e-01  1.12760282e+00  1.12760282e+00  1.12760282e+00
  9.18563345e+00  9.18563345e+00  9.18563345e+00  4.51552192e+01
  4.51552192e+01  4.51552192e+01  7.21481374e+01  1.78944461e+02
  1.78944461e+02  1.78944461e+02  5.41410396e+02  5.81035689e+02
  5.81035689e+02  5.81035689e+02  1.44998418e+03  1.44998418e+03
  1.44998418e+03  2.59329631e+03  3.14743256e+03  3.14743256e+03
  3.14743256e+03  6.76243882e+03  6.76243882e+03  6.76243882e+03
  9.00211744e+03  2.53657764e+04  7.61145370e+04]
E1 = -728.3810301206962  E_coul = 201.91266491095317
cycle= 2 E= -526.468365209743  delta_E= -0.000379  |g|= 0.0245  |ddm|= 0.0208
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0472252
diis-c [-0.00143429  0.04888524  0.95111476]
  HOMO = -0.5692176738908  LUMO = 1.13079292527418
  mo_energy =
[-1.18551585e+02 -1.21817908e+01 -9.53245659e+00 -9.53245659e+00
 -9.53245659e+00 -1.24670915e+00 -5.69217674e-01 -5.69217674e-01
 -5.69217674e-01  1.13079293e+00  1.13079293e+00  1.13079293e+00
  9.19863052e+00  9.19863052e+00  9.19863052e+00  4.51798582e+01
  4.51798582e+01  4.51798582e+01  7.21818555e+01  1.78980470e+02
  1.78980470e+02  1.78980470e+02  5.41454490e+02  5.81078091e+02
  5.81078091e+02  5.81078091e+02  1.45002937e+03  1.45002937e+03
  1.45002937e+03  2.59334382e+03  3.14747936e+03  3.14747936e+03
  3.14747936e+03  6.76248666e+03  6.76248666e+03  6.76248666e+03
  9.00216571e+03  2.53658248e+04  7.61145855e+04]
E1 = -728.3201857614456  E_coul = 201.85180744009133
cycle= 3 E= -526.468378321354  delta_E= -1.31e-05  |g|= 0.00298  |ddm|= 0.00521
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00639997
diis-c [-3.61092252e-07 -1.09091620e-03  1.12541936e-01  8.88548980e-01]
  HOMO = -0.569870555444125  LUMO = 1.13024638059361
  mo_energy =
[-1.18556811e+02 -1.21846091e+01 -9.53538135e+00 -9.53538135e+00
 -9.53538135e+00 -1.24755711e+00 -5.69870555e-01 -5.69870555e-01
 -5.69870555e-01  1.13024638e+00  1.13024638e+00  1.13024638e+00
  9.19664399e+00  9.19664399e+00  9.19664399e+00  4.51765322e+01
  4.51765322e+01  4.51765322e+01  7.21777073e+01  1.78975961e+02
  1.78975961e+02  1.78975961e+02  5.41449100e+02  5.81072910e+02
  5.81072910e+02  5.81072910e+02  1.45002385e+03  1.45002385e+03
  1.45002385e+03  2.59333788e+03  3.14747360e+03  3.14747360e+03
  3.14747360e+03  6.76248064e+03  6.76248064e+03  6.76248064e+03
  9.00215955e+03  2.53658186e+04  7.61145791e+04]
E1 = -728.3284057134235  E_coul = 201.86002710449964
cycle= 4 E= -526.468378608924  delta_E= -2.88e-07  |g|= 4.14e-05  |ddm|= 0.000764
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.29429e-05
diis-c [-1.72192021e-09  8.83761197e-06 -1.89041474e-03 -9.35372679e-03
  1.01123530e+00]
  HOMO = -0.569843883668398  LUMO = 1.1302680207455
  mo_energy =
[-1.18556720e+02 -1.21845235e+01 -9.53529691e+00 -9.53529691e+00
 -9.53529691e+00 -1.24752248e+00 -5.69843884e-01 -5.69843884e-01
 -5.69843884e-01  1.13026802e+00  1.13026802e+00  1.13026802e+00
  9.19671037e+00  9.19671037e+00  9.19671037e+00  4.51766167e+01
  4.51766167e+01  4.51766167e+01  7.21778018e+01  1.78976052e+02
  1.78976052e+02  1.78976052e+02  5.41449187e+02  5.81073001e+02
  5.81073001e+02  5.81073001e+02  1.45002394e+03  1.45002394e+03
  1.45002394e+03  2.59333796e+03  3.14747368e+03  3.14747368e+03
  3.14747368e+03  6.76248072e+03  6.76248072e+03  6.76248072e+03
  9.00215963e+03  2.53658186e+04  7.61145792e+04]
E1 = -728.328207499315  E_coul = 201.8598288902653
cycle= 5 E= -526.46837860905  delta_E= -1.26e-10  |g|= 7.28e-06  |ddm|= 2.31e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.328207499315  E_coul = 201.8598288902653
  HOMO = -0.569847606826867  LUMO = 1.13026498249181
  mo_energy =
[-1.18556738e+02 -1.21845365e+01 -9.53531018e+00 -9.53531018e+00
 -9.53531018e+00 -1.24752731e+00 -5.69847607e-01 -5.69847607e-01
 -5.69847607e-01  1.13026498e+00  1.13026498e+00  1.13026498e+00
  9.19670049e+00  9.19670049e+00  9.19670049e+00  4.51766027e+01
  4.51766027e+01  4.51766027e+01  7.21777859e+01  1.78976035e+02
  1.78976035e+02  1.78976035e+02  5.41449169e+02  5.81072983e+02
  5.81072983e+02  5.81072983e+02  1.45002392e+03  1.45002392e+03
  1.45002392e+03  2.59333794e+03  3.14747366e+03  3.14747366e+03
  3.14747366e+03  6.76248070e+03  6.76248070e+03  6.76248070e+03
  9.00215961e+03  2.53658186e+04  7.61145792e+04]
E1 = -728.328241310464  E_coul = 201.85986270141004
Extra cycle  E= -526.468378609054  delta_E= -4.21e-12  |g|= 1.84e-06  |ddm|= 3.63e-06
    CPU time for scf_cycle      0.70 sec, wall time      0.31 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 155857.39040186311
E1 = -728.328241310464  E_coul = 201.85986270141004
init E= -526.468378609054
    CPU time for initialize scf      2.75 sec, wall time      0.25 sec
  HOMO = -0.569846974539197  LUMO = 1.13026550615432
  mo_energy =
[-1.18556734e+02 -1.21845340e+01 -9.53530763e+00 -9.53530763e+00
 -9.53530763e+00 -1.24752649e+00 -5.69846975e-01 -5.69846975e-01
 -5.69846975e-01  1.13026551e+00  1.13026551e+00  1.13026551e+00
  9.19670229e+00  9.19670229e+00  9.19670229e+00  4.51766055e+01
  4.51766055e+01  4.51766055e+01  7.21777893e+01  1.78976039e+02
  1.78976039e+02  1.78976039e+02  5.41449174e+02  5.81072987e+02
  5.81072987e+02  5.81072987e+02  1.45002392e+03  1.45002392e+03
  1.45002392e+03  2.59333795e+03  3.14747367e+03  3.14747367e+03
  3.14747367e+03  6.76248071e+03  6.76248071e+03  6.76248071e+03
  9.00215961e+03  2.53658186e+04  7.61145792e+04]
E1 = -728.3282344791576  E_coul = 201.85985587010288
cycle= 1 E= -526.468378609055  delta_E= -7.96e-13  |g|= 4.07e-07  |ddm|= 6.73e-07
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
E1 = -728.3282344791576  E_coul = 201.85985587010288
  HOMO = -0.569847094444174  LUMO = 1.13026540622708
  mo_energy =
[-1.18556734e+02 -1.21845345e+01 -9.53530815e+00 -9.53530815e+00
 -9.53530815e+00 -1.24752665e+00 -5.69847094e-01 -5.69847094e-01
 -5.69847094e-01  1.13026541e+00  1.13026541e+00  1.13026541e+00
  9.19670194e+00  9.19670194e+00  9.19670194e+00  4.51766050e+01
  4.51766050e+01  4.51766050e+01  7.21777885e+01  1.78976038e+02
  1.78976038e+02  1.78976038e+02  5.41449173e+02  5.81072986e+02
  5.81072986e+02  5.81072986e+02  1.45002392e+03  1.45002392e+03
  1.45002392e+03  2.59333795e+03  3.14747367e+03  3.14747367e+03
  3.14747367e+03  6.76248070e+03  6.76248070e+03  6.76248070e+03
  9.00215961e+03  2.53658186e+04  7.61145792e+04]
E1 = -728.3282358823641  E_coul = 201.85985727330927
Extra cycle  E= -526.468378609055  delta_E=    0  |g|= 8.64e-08  |ddm|= 1.34e-07
    CPU time for scf_cycle      2.90 sec, wall time      0.40 sec
exp = [2.61825434e+04 7.61781004e+03 3.61731055e+03 1.60432459e+03
 3.72433868e+02 1.05000650e+02 3.41034984e+01 4.58071358e+00
 3.94811139e-01 1.36276302e+03 6.64789687e+02 3.01173644e+02
 3.14252963e+02 8.70883550e+01 9.28173984e+00 2.70704313e+01
 8.34636750e-01 3.36868767e+00 2.35930132e-01]
grad_E = [-1.56414554e-06  3.91858092e-06 -8.58550170e-07  8.72389792e-05
 -1.02577597e-04 -4.78661720e-05 -1.15234463e-05  1.84927640e-06
  3.68879656e-04 -2.65542731e-07  1.53102546e-08  5.28715619e-08
  4.69960130e-07  4.02692532e-04  1.30016852e-04  1.16621211e-04
 -3.84081044e-05 -2.12371725e-04  2.60026418e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:44:52 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5433935        1
[INPUT] 0    0    [1    /1   ]  7617.81041247        1
[INPUT] 0    0    [1    /1   ]  3617.31141991        1
[INPUT] 0    0    [1    /1   ]  1604.33665726        1
[INPUT] 0    0    [1    /1   ]  372.309608195        1
[INPUT] 0    0    [1    /1   ]  104.963378741        1
[INPUT] 0    0    [1    /1   ]  34.0929521809        1
[INPUT] 0    0    [1    /1   ]  4.58073954527        1
[INPUT] 0    0    [1    /1   ]  0.394814037431       1
[INPUT] 1    0    [1    /1   ]  1362.76304649        1
[INPUT] 1    0    [1    /1   ]  664.790046996        1
[INPUT] 1    0    [1    /1   ]  301.175620421        1
[INPUT] 1    0    [1    /1   ]  314.254701945        1
[INPUT] 1    0    [1    /1   ]  87.0491518358        1
[INPUT] 1    0    [1    /1   ]  9.27889625224        1
[INPUT] 1    0    [1    /1   ]  27.0600803737        1
[INPUT] 1    0    [1    /1   ]  0.834810259519       1
[INPUT] 1    0    [1    /1   ]  3.36737162898        1
[INPUT] 1    0    [1    /1   ]  0.23595727954        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.543393531923, 1.0]], [0, [7617.810412467907, 1.0]], [0, [3617.3114199059733, 1.0]], [0, [1604.3366572606346, 1.0]], [0, [372.3096081951255, 1.0]], [0, [104.9633787412774, 1.0]], [0, [34.09295218088999, 1.0]], [0, [4.580739545269741, 1.0]], [0, [0.3948140374305313, 1.0]], [1, [1362.7630464852637, 1.0]], [1, [664.790046996046, 1.0]], [1, [301.1756204213642, 1.0]], [1, [314.2547019445662, 1.0]], [1, [87.04915183575761, 1.0]], [1, [9.278896252241376, 1.0]], [1, [27.060080373741844, 1.0]], [1, [0.834810259519459, 1.0]], [1, [3.3673716289818127, 1.0]], [1, [0.23595727954015863, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.54339353]
bas 1, expnt(s) = [7617.81041247]
bas 2, expnt(s) = [3617.31141991]
bas 3, expnt(s) = [1604.33665726]
bas 4, expnt(s) = [372.3096082]
bas 5, expnt(s) = [104.96337874]
bas 6, expnt(s) = [34.09295218]
bas 7, expnt(s) = [4.58073955]
bas 8, expnt(s) = [0.39481404]
bas 9, expnt(s) = [1362.76304649]
bas 10, expnt(s) = [664.790047]
bas 11, expnt(s) = [301.17562042]
bas 12, expnt(s) = [314.25470194]
bas 13, expnt(s) = [87.04915184]
bas 14, expnt(s) = [9.27889625]
bas 15, expnt(s) = [27.06008037]
bas 16, expnt(s) = [0.83481026]
bas 17, expnt(s) = [3.36737163]
bas 18, expnt(s) = [0.23595728]
CPU time:       691.38
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825434e+04 5.20024612e+03 7.61781041e+03 2.06009688e+03
 3.61731142e+03 1.17843179e+03 1.60433666e+03 6.40452100e+02
 3.72309608e+02 2.14137736e+02 1.04963379e+02 8.28501646e+01
 3.40929522e+01 3.56462198e+01 4.58073955e+00 7.91073294e+00
 3.94814037e-01 1.25837321e+00 1.36276305e+03 2.41551550e+04
 6.64790047e+02 9.84781833e+03 3.01175620e+02 3.66023660e+03
 3.14254702e+02 3.85999394e+03 8.70491518e+01 7.75693357e+02
 9.27889625e+00 4.72448845e+01 2.70600804e+01 1.80051086e+02
 8.34810260e-01 2.32792570e+00 3.36737163e+00 1.33075530e+01
 2.35957280e-01 4.79762300e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.974325246630052
cond(S) = 155755.63672318248
E1 = -728.8739953225308  E_coul = 203.11675387023246
init E= -525.757241452298
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558860109551815  LUMO = 1.13762439088403
  mo_energy =
[-1.18318658e+02 -1.21042089e+01 -9.44869093e+00 -9.44869093e+00
 -9.44869093e+00 -1.23030668e+00 -5.58860110e-01 -5.58860110e-01
 -5.58860110e-01  1.13762439e+00  1.13762439e+00  1.13762439e+00
  9.24828608e+00  9.24828608e+00  9.24828608e+00  4.52687223e+01
  4.52687223e+01  4.52687223e+01  7.22769810e+01  1.79078918e+02
  1.79078918e+02  1.79078918e+02  5.41499170e+02  5.81167356e+02
  5.81167356e+02  5.81167356e+02  1.45014329e+03  1.45014329e+03
  1.45014329e+03  2.59326225e+03  3.14765552e+03  3.14765552e+03
  3.14765552e+03  6.76278812e+03  6.76278812e+03  6.76278812e+03
  9.00212564e+03  2.53658859e+04  7.61147718e+04]
E1 = -728.0841857953212  E_coul = 201.6161982082627
cycle= 1 E= -526.467987587059  delta_E= -0.711  |g|= 0.185  |ddm|= 0.494
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.550223
diis-c [-0.30274506  1.        ]
  HOMO = -0.572895626533665  LUMO = 1.12785071020627
  mo_energy =
[-1.18594319e+02 -1.22020754e+01 -9.55315247e+00 -9.55315247e+00
 -9.55315247e+00 -1.25158454e+00 -5.72895627e-01 -5.72895627e-01
 -5.72895627e-01  1.12785071e+00  1.12785071e+00  1.12785071e+00
  9.18293022e+00  9.18293022e+00  9.18293022e+00  4.51363602e+01
  4.51363602e+01  4.51363602e+01  7.21134831e+01  1.78870598e+02
  1.78870598e+02  1.78870598e+02  5.41190256e+02  5.80894160e+02
  5.80894160e+02  5.80894160e+02  1.44981519e+03  1.44981519e+03
  1.44981519e+03  2.59279657e+03  3.14726069e+03  3.14726069e+03
  3.14726069e+03  6.76227771e+03  6.76227771e+03  6.76227771e+03
  9.00153719e+03  2.53652027e+04  7.61139979e+04]
E1 = -728.3811460785654  E_coul = 201.91277975034308
cycle= 2 E= -526.468366328222  delta_E= -0.000379  |g|= 0.0245  |ddm|= 0.0208
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0472335
diis-c [-0.0014347   0.04889447  0.95110553]
  HOMO = -0.56921779113836  LUMO = 1.13104139191185
  mo_energy =
[-1.18551568e+02 -1.21817754e+01 -9.53244923e+00 -9.53244923e+00
 -9.53244923e+00 -1.24670838e+00 -5.69217791e-01 -5.69217791e-01
 -5.69217791e-01  1.13104139e+00  1.13104139e+00  1.13104139e+00
  9.19592489e+00  9.19592489e+00  9.19592489e+00  4.51609975e+01
  4.51609975e+01  4.51609975e+01  7.21472002e+01  1.78906608e+02
  1.78906608e+02  1.78906608e+02  5.41234353e+02  5.80936566e+02
  5.80936566e+02  5.80936566e+02  1.44986038e+03  1.44986038e+03
  1.44986038e+03  2.59284409e+03  3.14730750e+03  3.14730750e+03
  3.14730750e+03  6.76232555e+03  6.76232555e+03  6.76232555e+03
  9.00158546e+03  2.53652512e+04  7.61140464e+04]
E1 = -728.320290023142  E_coul = 201.85191057847467
cycle= 3 E= -526.468379444667  delta_E= -1.31e-05  |g|= 0.00298  |ddm|= 0.00521
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00640148
diis-c [-3.61261436e-07 -1.09106076e-03  1.12548079e-01  8.88542981e-01]
  HOMO = -0.569870751074339  LUMO = 1.1304946784493
  mo_energy =
[-1.18556795e+02 -1.21845941e+01 -9.53537442e+00 -9.53537442e+00
 -9.53537442e+00 -1.24755644e+00 -5.69870751e-01 -5.69870751e-01
 -5.69870751e-01  1.13049468e+00  1.13049468e+00  1.13049468e+00
  9.19393850e+00  9.19393850e+00  9.19393850e+00  4.51576714e+01
  4.51576714e+01  4.51576714e+01  7.21430518e+01  1.78902099e+02
  1.78902099e+02  1.78902099e+02  5.41228962e+02  5.80931384e+02
  5.80931384e+02  5.80931384e+02  1.44985486e+03  1.44985486e+03
  1.44985486e+03  2.59283815e+03  3.14730174e+03  3.14730174e+03
  3.14730174e+03  6.76231953e+03  6.76231953e+03  6.76231953e+03
  9.00157931e+03  2.53652449e+04  7.61140400e+04]
E1 = -728.328511744726  E_coul = 201.86013201236278
cycle= 4 E= -526.468379732363  delta_E= -2.88e-07  |g|= 4.14e-05  |ddm|= 0.000764
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.29369e-05
diis-c [-1.72250933e-09  8.81732561e-06 -1.88845505e-03 -9.34140779e-03
  1.01122105e+00]
  HOMO = -0.569844080267842  LUMO = 1.13051632150202
  mo_energy =
[-1.18556704e+02 -1.21845084e+01 -9.53528998e+00 -9.53528998e+00
 -9.53528998e+00 -1.24752181e+00 -5.69844080e-01 -5.69844080e-01
 -5.69844080e-01  1.13051632e+00  1.13051632e+00  1.13051632e+00
  9.19400486e+00  9.19400486e+00  9.19400486e+00  4.51577559e+01
  4.51577559e+01  4.51577559e+01  7.21431463e+01  1.78902190e+02
  1.78902190e+02  1.78902190e+02  5.41229050e+02  5.80931475e+02
  5.80931475e+02  5.80931475e+02  1.44985495e+03  1.44985495e+03
  1.44985495e+03  2.59283823e+03  3.14730182e+03  3.14730182e+03
  3.14730182e+03  6.76231961e+03  6.76231961e+03  6.76231961e+03
  9.00157938e+03  2.53652450e+04  7.61140401e+04]
E1 = -728.3283135039972  E_coul = 201.8599337715065
cycle= 5 E= -526.468379732491  delta_E= -1.27e-10  |g|= 7.28e-06  |ddm|= 2.31e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3283135039972  E_coul = 201.8599337715065
  HOMO = -0.569847803913657  LUMO = 1.13051328227776
  mo_energy =
[-1.18556722e+02 -1.21845214e+01 -9.53530326e+00 -9.53530326e+00
 -9.53530326e+00 -1.24752664e+00 -5.69847804e-01 -5.69847804e-01
 -5.69847804e-01  1.13051328e+00  1.13051328e+00  1.13051328e+00
  9.19399498e+00  9.19399498e+00  9.19399498e+00  4.51577420e+01
  4.51577420e+01  4.51577420e+01  7.21431304e+01  1.78902173e+02
  1.78902173e+02  1.78902173e+02  5.41229032e+02  5.80931457e+02
  5.80931457e+02  5.80931457e+02  1.44985493e+03  1.44985493e+03
  1.44985493e+03  2.59283821e+03  3.14730180e+03  3.14730180e+03
  3.14730180e+03  6.76231959e+03  6.76231959e+03  6.76231959e+03
  9.00157936e+03  2.53652449e+04  7.61140401e+04]
E1 = -728.3283473239715  E_coul = 201.85996759147682
Extra cycle  E= -526.468379732495  delta_E= -3.98e-12  |g|= 1.85e-06  |ddm|= 3.63e-06
    CPU time for scf_cycle      0.69 sec, wall time      0.30 sec
exp = [2.61825434e+04 7.61781041e+03 3.61731142e+03 1.60433666e+03
 3.72309608e+02 1.04963379e+02 3.40929522e+01 4.58073955e+00
 3.94814037e-01 1.36276305e+03 6.64790047e+02 3.01175620e+02
 3.14254702e+02 8.70491518e+01 9.27889625e+00 2.70600804e+01
 8.34810260e-01 3.36737163e+00 2.35957280e-01]
E = -526.4683797324947
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:44:53 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5433935        1
[INPUT] 0    0    [1    /1   ]  7617.81041247        1
[INPUT] 0    0    [1    /1   ]  3617.31141991        1
[INPUT] 0    0    [1    /1   ]  1604.33665726        1
[INPUT] 0    0    [1    /1   ]  372.309608195        1
[INPUT] 0    0    [1    /1   ]  104.963378741        1
[INPUT] 0    0    [1    /1   ]  34.0929521809        1
[INPUT] 0    0    [1    /1   ]  4.58073954527        1
[INPUT] 0    0    [1    /1   ]  0.394814037431       1
[INPUT] 1    0    [1    /1   ]  1362.76304649        1
[INPUT] 1    0    [1    /1   ]  664.790046996        1
[INPUT] 1    0    [1    /1   ]  301.175620421        1
[INPUT] 1    0    [1    /1   ]  314.254701945        1
[INPUT] 1    0    [1    /1   ]  87.0491518358        1
[INPUT] 1    0    [1    /1   ]  9.27889625224        1
[INPUT] 1    0    [1    /1   ]  27.0600803737        1
[INPUT] 1    0    [1    /1   ]  0.834810259519       1
[INPUT] 1    0    [1    /1   ]  3.36737162898        1
[INPUT] 1    0    [1    /1   ]  0.23595727954        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.543393531923, 1.0]], [0, [7617.810412467907, 1.0]], [0, [3617.3114199059733, 1.0]], [0, [1604.3366572606346, 1.0]], [0, [372.3096081951255, 1.0]], [0, [104.9633787412774, 1.0]], [0, [34.09295218088999, 1.0]], [0, [4.580739545269741, 1.0]], [0, [0.3948140374305313, 1.0]], [1, [1362.7630464852637, 1.0]], [1, [664.790046996046, 1.0]], [1, [301.1756204213642, 1.0]], [1, [314.2547019445662, 1.0]], [1, [87.04915183575761, 1.0]], [1, [9.278896252241376, 1.0]], [1, [27.060080373741844, 1.0]], [1, [0.834810259519459, 1.0]], [1, [3.3673716289818127, 1.0]], [1, [0.23595727954015863, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.54339353]
bas 1, expnt(s) = [7617.81041247]
bas 2, expnt(s) = [3617.31141991]
bas 3, expnt(s) = [1604.33665726]
bas 4, expnt(s) = [372.3096082]
bas 5, expnt(s) = [104.96337874]
bas 6, expnt(s) = [34.09295218]
bas 7, expnt(s) = [4.58073955]
bas 8, expnt(s) = [0.39481404]
bas 9, expnt(s) = [1362.76304649]
bas 10, expnt(s) = [664.790047]
bas 11, expnt(s) = [301.17562042]
bas 12, expnt(s) = [314.25470194]
bas 13, expnt(s) = [87.04915184]
bas 14, expnt(s) = [9.27889625]
bas 15, expnt(s) = [27.06008037]
bas 16, expnt(s) = [0.83481026]
bas 17, expnt(s) = [3.36737163]
bas 18, expnt(s) = [0.23595728]
CPU time:       692.35
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825434e+04 5.20024612e+03 7.61781041e+03 2.06009688e+03
 3.61731142e+03 1.17843179e+03 1.60433666e+03 6.40452100e+02
 3.72309608e+02 2.14137736e+02 1.04963379e+02 8.28501646e+01
 3.40929522e+01 3.56462198e+01 4.58073955e+00 7.91073294e+00
 3.94814037e-01 1.25837321e+00 1.36276305e+03 2.41551550e+04
 6.64790047e+02 9.84781833e+03 3.01175620e+02 3.66023660e+03
 3.14254702e+02 3.85999394e+03 8.70491518e+01 7.75693357e+02
 9.27889625e+00 4.72448845e+01 2.70600804e+01 1.80051086e+02
 8.34810260e-01 2.32792570e+00 3.36737163e+00 1.33075530e+01
 2.35957280e-01 4.79762300e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.974325246630052
cond(S) = 155755.63672318248
E1 = -728.8739953225308  E_coul = 203.11675387023246
init E= -525.757241452298
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558860109551815  LUMO = 1.13762439088403
  mo_energy =
[-1.18318658e+02 -1.21042089e+01 -9.44869093e+00 -9.44869093e+00
 -9.44869093e+00 -1.23030668e+00 -5.58860110e-01 -5.58860110e-01
 -5.58860110e-01  1.13762439e+00  1.13762439e+00  1.13762439e+00
  9.24828608e+00  9.24828608e+00  9.24828608e+00  4.52687223e+01
  4.52687223e+01  4.52687223e+01  7.22769810e+01  1.79078918e+02
  1.79078918e+02  1.79078918e+02  5.41499170e+02  5.81167356e+02
  5.81167356e+02  5.81167356e+02  1.45014329e+03  1.45014329e+03
  1.45014329e+03  2.59326225e+03  3.14765552e+03  3.14765552e+03
  3.14765552e+03  6.76278812e+03  6.76278812e+03  6.76278812e+03
  9.00212564e+03  2.53658859e+04  7.61147718e+04]
E1 = -728.0841857953212  E_coul = 201.6161982082627
cycle= 1 E= -526.467987587059  delta_E= -0.711  |g|= 0.185  |ddm|= 0.494
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.550223
diis-c [-0.30274506  1.        ]
  HOMO = -0.572895626533665  LUMO = 1.12785071020627
  mo_energy =
[-1.18594319e+02 -1.22020754e+01 -9.55315247e+00 -9.55315247e+00
 -9.55315247e+00 -1.25158454e+00 -5.72895627e-01 -5.72895627e-01
 -5.72895627e-01  1.12785071e+00  1.12785071e+00  1.12785071e+00
  9.18293022e+00  9.18293022e+00  9.18293022e+00  4.51363602e+01
  4.51363602e+01  4.51363602e+01  7.21134831e+01  1.78870598e+02
  1.78870598e+02  1.78870598e+02  5.41190256e+02  5.80894160e+02
  5.80894160e+02  5.80894160e+02  1.44981519e+03  1.44981519e+03
  1.44981519e+03  2.59279657e+03  3.14726069e+03  3.14726069e+03
  3.14726069e+03  6.76227771e+03  6.76227771e+03  6.76227771e+03
  9.00153719e+03  2.53652027e+04  7.61139979e+04]
E1 = -728.3811460785654  E_coul = 201.91277975034308
cycle= 2 E= -526.468366328222  delta_E= -0.000379  |g|= 0.0245  |ddm|= 0.0208
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0472335
diis-c [-0.0014347   0.04889447  0.95110553]
  HOMO = -0.56921779113836  LUMO = 1.13104139191185
  mo_energy =
[-1.18551568e+02 -1.21817754e+01 -9.53244923e+00 -9.53244923e+00
 -9.53244923e+00 -1.24670838e+00 -5.69217791e-01 -5.69217791e-01
 -5.69217791e-01  1.13104139e+00  1.13104139e+00  1.13104139e+00
  9.19592489e+00  9.19592489e+00  9.19592489e+00  4.51609975e+01
  4.51609975e+01  4.51609975e+01  7.21472002e+01  1.78906608e+02
  1.78906608e+02  1.78906608e+02  5.41234353e+02  5.80936566e+02
  5.80936566e+02  5.80936566e+02  1.44986038e+03  1.44986038e+03
  1.44986038e+03  2.59284409e+03  3.14730750e+03  3.14730750e+03
  3.14730750e+03  6.76232555e+03  6.76232555e+03  6.76232555e+03
  9.00158546e+03  2.53652512e+04  7.61140464e+04]
E1 = -728.320290023142  E_coul = 201.85191057847467
cycle= 3 E= -526.468379444667  delta_E= -1.31e-05  |g|= 0.00298  |ddm|= 0.00521
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00640148
diis-c [-3.61261436e-07 -1.09106076e-03  1.12548079e-01  8.88542981e-01]
  HOMO = -0.569870751074339  LUMO = 1.1304946784493
  mo_energy =
[-1.18556795e+02 -1.21845941e+01 -9.53537442e+00 -9.53537442e+00
 -9.53537442e+00 -1.24755644e+00 -5.69870751e-01 -5.69870751e-01
 -5.69870751e-01  1.13049468e+00  1.13049468e+00  1.13049468e+00
  9.19393850e+00  9.19393850e+00  9.19393850e+00  4.51576714e+01
  4.51576714e+01  4.51576714e+01  7.21430518e+01  1.78902099e+02
  1.78902099e+02  1.78902099e+02  5.41228962e+02  5.80931384e+02
  5.80931384e+02  5.80931384e+02  1.44985486e+03  1.44985486e+03
  1.44985486e+03  2.59283815e+03  3.14730174e+03  3.14730174e+03
  3.14730174e+03  6.76231953e+03  6.76231953e+03  6.76231953e+03
  9.00157931e+03  2.53652449e+04  7.61140400e+04]
E1 = -728.328511744726  E_coul = 201.86013201236278
cycle= 4 E= -526.468379732363  delta_E= -2.88e-07  |g|= 4.14e-05  |ddm|= 0.000764
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.29369e-05
diis-c [-1.72250933e-09  8.81732561e-06 -1.88845505e-03 -9.34140779e-03
  1.01122105e+00]
  HOMO = -0.569844080267842  LUMO = 1.13051632150202
  mo_energy =
[-1.18556704e+02 -1.21845084e+01 -9.53528998e+00 -9.53528998e+00
 -9.53528998e+00 -1.24752181e+00 -5.69844080e-01 -5.69844080e-01
 -5.69844080e-01  1.13051632e+00  1.13051632e+00  1.13051632e+00
  9.19400486e+00  9.19400486e+00  9.19400486e+00  4.51577559e+01
  4.51577559e+01  4.51577559e+01  7.21431463e+01  1.78902190e+02
  1.78902190e+02  1.78902190e+02  5.41229050e+02  5.80931475e+02
  5.80931475e+02  5.80931475e+02  1.44985495e+03  1.44985495e+03
  1.44985495e+03  2.59283823e+03  3.14730182e+03  3.14730182e+03
  3.14730182e+03  6.76231961e+03  6.76231961e+03  6.76231961e+03
  9.00157938e+03  2.53652450e+04  7.61140401e+04]
E1 = -728.3283135039972  E_coul = 201.8599337715065
cycle= 5 E= -526.468379732491  delta_E= -1.27e-10  |g|= 7.28e-06  |ddm|= 2.31e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3283135039972  E_coul = 201.8599337715065
  HOMO = -0.569847803913657  LUMO = 1.13051328227776
  mo_energy =
[-1.18556722e+02 -1.21845214e+01 -9.53530326e+00 -9.53530326e+00
 -9.53530326e+00 -1.24752664e+00 -5.69847804e-01 -5.69847804e-01
 -5.69847804e-01  1.13051328e+00  1.13051328e+00  1.13051328e+00
  9.19399498e+00  9.19399498e+00  9.19399498e+00  4.51577420e+01
  4.51577420e+01  4.51577420e+01  7.21431304e+01  1.78902173e+02
  1.78902173e+02  1.78902173e+02  5.41229032e+02  5.80931457e+02
  5.80931457e+02  5.80931457e+02  1.44985493e+03  1.44985493e+03
  1.44985493e+03  2.59283821e+03  3.14730180e+03  3.14730180e+03
  3.14730180e+03  6.76231959e+03  6.76231959e+03  6.76231959e+03
  9.00157936e+03  2.53652449e+04  7.61140401e+04]
E1 = -728.3283473239715  E_coul = 201.85996759147682
Extra cycle  E= -526.468379732495  delta_E= -3.98e-12  |g|= 1.85e-06  |ddm|= 3.63e-06
    CPU time for scf_cycle      0.69 sec, wall time      0.30 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 155755.63672318248
E1 = -728.3283473239715  E_coul = 201.85996759147682
init E= -526.468379732495
    CPU time for initialize scf      2.77 sec, wall time      0.26 sec
  HOMO = -0.569847171508768  LUMO = 1.13051380613708
  mo_energy =
[-1.18556718e+02 -1.21845190e+01 -9.53530071e+00 -9.53530071e+00
 -9.53530071e+00 -1.24752582e+00 -5.69847172e-01 -5.69847172e-01
 -5.69847172e-01  1.13051381e+00  1.13051381e+00  1.13051381e+00
  9.19399678e+00  9.19399678e+00  9.19399678e+00  4.51577448e+01
  4.51577448e+01  4.51577448e+01  7.21431338e+01  1.78902177e+02
  1.78902177e+02  1.78902177e+02  5.41229036e+02  5.80931461e+02
  5.80931461e+02  5.80931461e+02  1.44985494e+03  1.44985494e+03
  1.44985494e+03  2.59283822e+03  3.14730180e+03  3.14730180e+03
  3.14730180e+03  6.76231960e+03  6.76231960e+03  6.76231960e+03
  9.00157937e+03  2.53652449e+04  7.61140401e+04]
E1 = -728.3283404902543  E_coul = 201.8599607577609
cycle= 1 E= -526.468379732493  delta_E= 1.25e-12  |g|= 4.07e-07  |ddm|= 6.73e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3283404902543  E_coul = 201.8599607577609
  HOMO = -0.569847291447349  LUMO = 1.13051370616266
  mo_energy =
[-1.18556719e+02 -1.21845195e+01 -9.53530122e+00 -9.53530122e+00
 -9.53530122e+00 -1.24752597e+00 -5.69847291e-01 -5.69847291e-01
 -5.69847291e-01  1.13051371e+00  1.13051371e+00  1.13051371e+00
  9.19399643e+00  9.19399643e+00  9.19399643e+00  4.51577442e+01
  4.51577442e+01  4.51577442e+01  7.21431331e+01  1.78902176e+02
  1.78902176e+02  1.78902176e+02  5.41229035e+02  5.80931460e+02
  5.80931460e+02  5.80931460e+02  1.44985494e+03  1.44985494e+03
  1.44985494e+03  2.59283822e+03  3.14730180e+03  3.14730180e+03
  3.14730180e+03  6.76231960e+03  6.76231960e+03  6.76231960e+03
  9.00157937e+03  2.53652449e+04  7.61140401e+04]
E1 = -728.3283418940867  E_coul = 201.8599621615929
Extra cycle  E= -526.468379732494  delta_E= -4.55e-13  |g|= 8.65e-08  |ddm|= 1.34e-07
    CPU time for scf_cycle      2.92 sec, wall time      0.41 sec
exp = [2.61825434e+04 7.61781041e+03 3.61731142e+03 1.60433666e+03
 3.72309608e+02 1.04963379e+02 3.40929522e+01 4.58073955e+00
 3.94814037e-01 1.36276305e+03 6.64790047e+02 3.01175620e+02
 3.14254702e+02 8.70491518e+01 9.27889625e+00 2.70600804e+01
 8.34810260e-01 3.36737163e+00 2.35957280e-01]
grad_E = [-1.56475693e-06  3.92623046e-06 -8.50925086e-07  8.74837437e-05
 -1.04912872e-04 -4.09858375e-05 -3.44188463e-05  5.48634744e-05
  4.28204955e-04 -2.65913674e-07  1.50316131e-08  4.65963257e-08
  4.64674068e-07  4.04126564e-04  2.25571082e-04  9.79647912e-05
  3.72533105e-04 -4.40886496e-04 -1.53933714e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:44:58 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5433742        1
[INPUT] 0    0    [1    /1   ]  7617.81105683        1
[INPUT] 0    0    [1    /1   ]  3617.31303589        1
[INPUT] 0    0    [1    /1   ]  1604.35798747        1
[INPUT] 0    0    [1    /1   ]  372.081524227        1
[INPUT] 0    0    [1    /1   ]  104.897575771        1
[INPUT] 0    0    [1    /1   ]  34.0750898425        1
[INPUT] 0    0    [1    /1   ]  4.58077274816        1
[INPUT] 0    0    [1    /1   ]  0.394802515407       1
[INPUT] 1    0    [1    /1   ]  1362.76310442        1
[INPUT] 1    0    [1    /1   ]  664.790709434        1
[INPUT] 1    0    [1    /1   ]  301.179260502        1
[INPUT] 1    0    [1    /1   ]  314.257901182        1
[INPUT] 1    0    [1    /1   ]  86.972301046         1
[INPUT] 1    0    [1    /1   ]  9.27399417153        1
[INPUT] 1    0    [1    /1   ]  27.0416653043        1
[INPUT] 1    0    [1    /1   ]  0.835208671512       1
[INPUT] 1    0    [1    /1   ]  3.36528139839        1
[INPUT] 1    0    [1    /1   ]  0.236031693424       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.543374223842, 1.0]], [0, [7617.8110568250395, 1.0]], [0, [3617.313035888991, 1.0]], [0, [1604.3579874705915, 1.0]], [0, [372.0815242269355, 1.0]], [0, [104.89757577133754, 1.0]], [0, [34.07508984250867, 1.0]], [0, [4.580772748160883, 1.0]], [0, [0.3948025154071261, 1.0]], [1, [1362.763104421065, 1.0]], [1, [664.7907094340723, 1.0]], [1, [301.1792605024111, 1.0]], [1, [314.257901182322, 1.0]], [1, [86.97230104597993, 1.0]], [1, [9.273994171527404, 1.0]], [1, [27.04166530427319, 1.0]], [1, [0.8352086715118014, 1.0]], [1, [3.3652813983867786, 1.0]], [1, [0.23603169342377425, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.54337422]
bas 1, expnt(s) = [7617.81105683]
bas 2, expnt(s) = [3617.31303589]
bas 3, expnt(s) = [1604.35798747]
bas 4, expnt(s) = [372.08152423]
bas 5, expnt(s) = [104.89757577]
bas 6, expnt(s) = [34.07508984]
bas 7, expnt(s) = [4.58077275]
bas 8, expnt(s) = [0.39480252]
bas 9, expnt(s) = [1362.76310442]
bas 10, expnt(s) = [664.79070943]
bas 11, expnt(s) = [301.1792605]
bas 12, expnt(s) = [314.25790118]
bas 13, expnt(s) = [86.97230105]
bas 14, expnt(s) = [9.27399417]
bas 15, expnt(s) = [27.0416653]
bas 16, expnt(s) = [0.83520867]
bas 17, expnt(s) = [3.3652814]
bas 18, expnt(s) = [0.23603169]
CPU time:       700.80
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825434e+04 5.20024611e+03 7.61781106e+03 2.06009701e+03
 3.61731304e+03 1.17843218e+03 1.60435799e+03 6.40458487e+02
 3.72081524e+02 2.14039340e+02 1.04897576e+02 8.28112067e+01
 3.40750898e+01 3.56322118e+01 4.58077275e+00 7.91077595e+00
 3.94802515e-01 1.25834567e+00 1.36276310e+03 2.41551563e+04
 6.64790709e+02 9.84783060e+03 3.01179261e+02 3.66029190e+03
 3.14257901e+02 3.86004306e+03 8.69723010e+01 7.74837432e+02
 9.27399417e+00 4.72136869e+01 2.70416653e+01 1.79897937e+02
 8.35208672e-01 2.32931453e+00 3.36528140e+00 1.32972283e+01
 2.36031693e-01 4.79951436e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97431341953506
cond(S) = 155560.72391944335
E1 = -728.8744478070952  E_coul = 203.11682357630391
init E= -525.757624230791
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558862536876693  LUMO = 1.13825888774248
  mo_energy =
[-1.18318637e+02 -1.21041929e+01 -9.44868936e+00 -9.44868936e+00
 -9.44868936e+00 -1.23030887e+00 -5.58862537e-01 -5.58862537e-01
 -5.58862537e-01  1.13825889e+00  1.13825889e+00  1.13825889e+00
  9.24441031e+00  9.24441031e+00  9.24441031e+00  4.52367303e+01
  4.52367303e+01  4.52367303e+01  7.22171196e+01  1.78943242e+02
  1.78943242e+02  1.78943242e+02  5.41107163e+02  5.80899587e+02
  5.80899587e+02  5.80899587e+02  1.44982087e+03  1.44982087e+03
  1.44982087e+03  2.59235917e+03  3.14732640e+03  3.14732640e+03
  3.14732640e+03  6.76247899e+03  6.76247899e+03  6.76247899e+03
  9.00107325e+03  2.53648441e+04  7.61137923e+04]
E1 = -728.0844409799095  E_coul = 201.6164503565981
cycle= 1 E= -526.467990623311  delta_E= -0.71  |g|= 0.185  |ddm|= 0.492
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.550252
diis-c [-0.30277763  1.        ]
  HOMO = -0.572894295184925  LUMO = 1.12848096288451
  mo_energy =
[-1.18594282e+02 -1.22020450e+01 -9.55313695e+00 -9.55313695e+00
 -9.55313695e+00 -1.25157835e+00 -5.72894295e-01 -5.72894295e-01
 -5.72894295e-01  1.12848096e+00  1.12848096e+00  1.12848096e+00
  9.17909162e+00  9.17909162e+00  9.17909162e+00  4.51044245e+01
  4.51044245e+01  4.51044245e+01  7.20536763e+01  1.78734976e+02
  1.78734976e+02  1.78734976e+02  5.40798308e+02  5.80626404e+02
  5.80626404e+02  5.80626404e+02  1.44949276e+03  1.44949276e+03
  1.44949276e+03  2.59189350e+03  3.14693156e+03  3.14693156e+03
  3.14693156e+03  6.76196856e+03  6.76196856e+03  6.76196856e+03
  9.00048478e+03  2.53641609e+04  7.61130183e+04]
E1 = -728.3813923798224  E_coul = 201.91302301713534
cycle= 2 E= -526.468369362687  delta_E= -0.000379  |g|= 0.0245  |ddm|= 0.0208
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0472433
diis-c [-0.00143522  0.04890404  0.95109596]
  HOMO = -0.569217776476573  LUMO = 1.13167209827098
  mo_energy =
[-1.18551529e+02 -1.21817457e+01 -9.53243424e+00 -9.53243424e+00
 -9.53243424e+00 -1.24670375e+00 -5.69217776e-01 -5.69217776e-01
 -5.69217776e-01  1.13167210e+00  1.13167210e+00  1.13167210e+00
  9.19207917e+00  9.19207917e+00  9.19207917e+00  4.51290539e+01
  4.51290539e+01  4.51290539e+01  7.20873863e+01  1.78770982e+02
  1.78770982e+02  1.78770982e+02  5.40842404e+02  5.80668811e+02
  5.80668811e+02  5.80668811e+02  1.44953796e+03  1.44953796e+03
  1.44953796e+03  2.59194101e+03  3.14697837e+03  3.14697837e+03
  3.14697837e+03  6.76201640e+03  6.76201640e+03  6.76201640e+03
  9.00053305e+03  2.53642093e+04  7.61130668e+04]
E1 = -728.320528980505  E_coul = 201.85214649765052
cycle= 3 E= -526.468382482854  delta_E= -1.31e-05  |g|= 0.00298  |ddm|= 0.00521
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00640346
diis-c [-3.61566216e-07 -1.09128805e-03  1.12558184e-01  8.88533104e-01]
  HOMO = -0.569870735535516  LUMO = 1.13112512236483
  mo_energy =
[-1.18556756e+02 -1.21845646e+01 -9.53535971e+00 -9.53535971e+00
 -9.53535971e+00 -1.24755178e+00 -5.69870736e-01 -5.69870736e-01
 -5.69870736e-01  1.13112512e+00  1.13112512e+00  1.13112512e+00
  9.19009332e+00  9.19009332e+00  9.19009332e+00  4.51257283e+01
  4.51257283e+01  4.51257283e+01  7.20832382e+01  1.78766473e+02
  1.78766473e+02  1.78766473e+02  5.40837013e+02  5.80663629e+02
  5.80663629e+02  5.80663629e+02  1.44953244e+03  1.44953244e+03
  1.44953244e+03  2.59193508e+03  3.14697261e+03  3.14697261e+03
  3.14697261e+03  6.76201038e+03  6.76201038e+03  6.76201038e+03
  9.00052690e+03  2.53642030e+04  7.61130605e+04]
E1 = -728.3287522758457  E_coul = 201.8603695051643
cycle= 4 E= -526.468382770681  delta_E= -2.88e-07  |g|= 4.14e-05  |ddm|= 0.000764
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.29327e-05
diis-c [-1.72355352e-09  8.78237756e-06 -1.88508011e-03 -9.31815676e-03
  1.01119445e+00]
  HOMO = -0.5698440665867  LUMO = 1.13114677341241
  mo_energy =
[-1.18556665e+02 -1.21844790e+01 -9.53527525e+00 -9.53527525e+00
 -9.53527525e+00 -1.24751716e+00 -5.69844067e-01 -5.69844067e-01
 -5.69844067e-01  1.13114677e+00  1.13114677e+00  1.13114677e+00
  9.19015968e+00  9.19015968e+00  9.19015968e+00  4.51258128e+01
  4.51258128e+01  4.51258128e+01  7.20833327e+01  1.78766564e+02
  1.78766564e+02  1.78766564e+02  5.40837101e+02  5.80663719e+02
  5.80663719e+02  5.80663719e+02  1.44953253e+03  1.44953253e+03
  1.44953253e+03  2.59193516e+03  3.14697269e+03  3.14697269e+03
  3.14697269e+03  6.76201046e+03  6.76201046e+03  6.76201046e+03
  9.00052697e+03  2.53642031e+04  7.61130605e+04]
E1 = -728.3285539858375  E_coul = 201.8601712150282
cycle= 5 E= -526.468382770809  delta_E= -1.28e-10  |g|= 7.28e-06  |ddm|= 2.31e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3285539858375  E_coul = 201.8601712150282
  HOMO = -0.569847790851459  LUMO = 1.1311437322461
  mo_energy =
[-1.18556683e+02 -1.21844920e+01 -9.53528853e+00 -9.53528853e+00
 -9.53528853e+00 -1.24752199e+00 -5.69847791e-01 -5.69847791e-01
 -5.69847791e-01  1.13114373e+00  1.13114373e+00  1.13114373e+00
  9.19014979e+00  9.19014979e+00  9.19014979e+00  4.51257988e+01
  4.51257988e+01  4.51257988e+01  7.20833168e+01  1.78766547e+02
  1.78766547e+02  1.78766547e+02  5.40837083e+02  5.80663702e+02
  5.80663702e+02  5.80663702e+02  1.44953251e+03  1.44953251e+03
  1.44953251e+03  2.59193514e+03  3.14697267e+03  3.14697267e+03
  3.14697267e+03  6.76201044e+03  6.76201044e+03  6.76201044e+03
  9.00052695e+03  2.53642031e+04  7.61130605e+04]
E1 = -728.3285878189776  E_coul = 201.86020504816585
Extra cycle  E= -526.468382770812  delta_E= -2.39e-12  |g|= 1.85e-06  |ddm|= 3.63e-06
    CPU time for scf_cycle      0.68 sec, wall time      0.29 sec
exp = [2.61825434e+04 7.61781106e+03 3.61731304e+03 1.60435799e+03
 3.72081524e+02 1.04897576e+02 3.40750898e+01 4.58077275e+00
 3.94802515e-01 1.36276310e+03 6.64790709e+02 3.01179261e+02
 3.14257901e+02 8.69723010e+01 9.27399417e+00 2.70416653e+01
 8.35208672e-01 3.36528140e+00 2.36031693e-01]
E = -526.4683827708117
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:44:58 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5433742        1
[INPUT] 0    0    [1    /1   ]  7617.81105683        1
[INPUT] 0    0    [1    /1   ]  3617.31303589        1
[INPUT] 0    0    [1    /1   ]  1604.35798747        1
[INPUT] 0    0    [1    /1   ]  372.081524227        1
[INPUT] 0    0    [1    /1   ]  104.897575771        1
[INPUT] 0    0    [1    /1   ]  34.0750898425        1
[INPUT] 0    0    [1    /1   ]  4.58077274816        1
[INPUT] 0    0    [1    /1   ]  0.394802515407       1
[INPUT] 1    0    [1    /1   ]  1362.76310442        1
[INPUT] 1    0    [1    /1   ]  664.790709434        1
[INPUT] 1    0    [1    /1   ]  301.179260502        1
[INPUT] 1    0    [1    /1   ]  314.257901182        1
[INPUT] 1    0    [1    /1   ]  86.972301046         1
[INPUT] 1    0    [1    /1   ]  9.27399417153        1
[INPUT] 1    0    [1    /1   ]  27.0416653043        1
[INPUT] 1    0    [1    /1   ]  0.835208671512       1
[INPUT] 1    0    [1    /1   ]  3.36528139839        1
[INPUT] 1    0    [1    /1   ]  0.236031693424       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.543374223842, 1.0]], [0, [7617.8110568250395, 1.0]], [0, [3617.313035888991, 1.0]], [0, [1604.3579874705915, 1.0]], [0, [372.0815242269355, 1.0]], [0, [104.89757577133754, 1.0]], [0, [34.07508984250867, 1.0]], [0, [4.580772748160883, 1.0]], [0, [0.3948025154071261, 1.0]], [1, [1362.763104421065, 1.0]], [1, [664.7907094340723, 1.0]], [1, [301.1792605024111, 1.0]], [1, [314.257901182322, 1.0]], [1, [86.97230104597993, 1.0]], [1, [9.273994171527404, 1.0]], [1, [27.04166530427319, 1.0]], [1, [0.8352086715118014, 1.0]], [1, [3.3652813983867786, 1.0]], [1, [0.23603169342377425, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.54337422]
bas 1, expnt(s) = [7617.81105683]
bas 2, expnt(s) = [3617.31303589]
bas 3, expnt(s) = [1604.35798747]
bas 4, expnt(s) = [372.08152423]
bas 5, expnt(s) = [104.89757577]
bas 6, expnt(s) = [34.07508984]
bas 7, expnt(s) = [4.58077275]
bas 8, expnt(s) = [0.39480252]
bas 9, expnt(s) = [1362.76310442]
bas 10, expnt(s) = [664.79070943]
bas 11, expnt(s) = [301.1792605]
bas 12, expnt(s) = [314.25790118]
bas 13, expnt(s) = [86.97230105]
bas 14, expnt(s) = [9.27399417]
bas 15, expnt(s) = [27.0416653]
bas 16, expnt(s) = [0.83520867]
bas 17, expnt(s) = [3.3652814]
bas 18, expnt(s) = [0.23603169]
CPU time:       701.76
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825434e+04 5.20024611e+03 7.61781106e+03 2.06009701e+03
 3.61731304e+03 1.17843218e+03 1.60435799e+03 6.40458487e+02
 3.72081524e+02 2.14039340e+02 1.04897576e+02 8.28112067e+01
 3.40750898e+01 3.56322118e+01 4.58077275e+00 7.91077595e+00
 3.94802515e-01 1.25834567e+00 1.36276310e+03 2.41551563e+04
 6.64790709e+02 9.84783060e+03 3.01179261e+02 3.66029190e+03
 3.14257901e+02 3.86004306e+03 8.69723010e+01 7.74837432e+02
 9.27399417e+00 4.72136869e+01 2.70416653e+01 1.79897937e+02
 8.35208672e-01 2.32931453e+00 3.36528140e+00 1.32972283e+01
 2.36031693e-01 4.79951436e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97431341953506
cond(S) = 155560.72391944335
E1 = -728.8744478070952  E_coul = 203.11682357630391
init E= -525.757624230791
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558862536876693  LUMO = 1.13825888774248
  mo_energy =
[-1.18318637e+02 -1.21041929e+01 -9.44868936e+00 -9.44868936e+00
 -9.44868936e+00 -1.23030887e+00 -5.58862537e-01 -5.58862537e-01
 -5.58862537e-01  1.13825889e+00  1.13825889e+00  1.13825889e+00
  9.24441031e+00  9.24441031e+00  9.24441031e+00  4.52367303e+01
  4.52367303e+01  4.52367303e+01  7.22171196e+01  1.78943242e+02
  1.78943242e+02  1.78943242e+02  5.41107163e+02  5.80899587e+02
  5.80899587e+02  5.80899587e+02  1.44982087e+03  1.44982087e+03
  1.44982087e+03  2.59235917e+03  3.14732640e+03  3.14732640e+03
  3.14732640e+03  6.76247899e+03  6.76247899e+03  6.76247899e+03
  9.00107325e+03  2.53648441e+04  7.61137923e+04]
E1 = -728.0844409799095  E_coul = 201.6164503565981
cycle= 1 E= -526.467990623311  delta_E= -0.71  |g|= 0.185  |ddm|= 0.492
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.550252
diis-c [-0.30277763  1.        ]
  HOMO = -0.572894295184925  LUMO = 1.12848096288451
  mo_energy =
[-1.18594282e+02 -1.22020450e+01 -9.55313695e+00 -9.55313695e+00
 -9.55313695e+00 -1.25157835e+00 -5.72894295e-01 -5.72894295e-01
 -5.72894295e-01  1.12848096e+00  1.12848096e+00  1.12848096e+00
  9.17909162e+00  9.17909162e+00  9.17909162e+00  4.51044245e+01
  4.51044245e+01  4.51044245e+01  7.20536763e+01  1.78734976e+02
  1.78734976e+02  1.78734976e+02  5.40798308e+02  5.80626404e+02
  5.80626404e+02  5.80626404e+02  1.44949276e+03  1.44949276e+03
  1.44949276e+03  2.59189350e+03  3.14693156e+03  3.14693156e+03
  3.14693156e+03  6.76196856e+03  6.76196856e+03  6.76196856e+03
  9.00048478e+03  2.53641609e+04  7.61130183e+04]
E1 = -728.3813923798224  E_coul = 201.91302301713534
cycle= 2 E= -526.468369362687  delta_E= -0.000379  |g|= 0.0245  |ddm|= 0.0208
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0472433
diis-c [-0.00143522  0.04890404  0.95109596]
  HOMO = -0.569217776476573  LUMO = 1.13167209827098
  mo_energy =
[-1.18551529e+02 -1.21817457e+01 -9.53243424e+00 -9.53243424e+00
 -9.53243424e+00 -1.24670375e+00 -5.69217776e-01 -5.69217776e-01
 -5.69217776e-01  1.13167210e+00  1.13167210e+00  1.13167210e+00
  9.19207917e+00  9.19207917e+00  9.19207917e+00  4.51290539e+01
  4.51290539e+01  4.51290539e+01  7.20873863e+01  1.78770982e+02
  1.78770982e+02  1.78770982e+02  5.40842404e+02  5.80668811e+02
  5.80668811e+02  5.80668811e+02  1.44953796e+03  1.44953796e+03
  1.44953796e+03  2.59194101e+03  3.14697837e+03  3.14697837e+03
  3.14697837e+03  6.76201640e+03  6.76201640e+03  6.76201640e+03
  9.00053305e+03  2.53642093e+04  7.61130668e+04]
E1 = -728.320528980505  E_coul = 201.85214649765052
cycle= 3 E= -526.468382482854  delta_E= -1.31e-05  |g|= 0.00298  |ddm|= 0.00521
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00640346
diis-c [-3.61566216e-07 -1.09128805e-03  1.12558184e-01  8.88533104e-01]
  HOMO = -0.569870735535516  LUMO = 1.13112512236483
  mo_energy =
[-1.18556756e+02 -1.21845646e+01 -9.53535971e+00 -9.53535971e+00
 -9.53535971e+00 -1.24755178e+00 -5.69870736e-01 -5.69870736e-01
 -5.69870736e-01  1.13112512e+00  1.13112512e+00  1.13112512e+00
  9.19009332e+00  9.19009332e+00  9.19009332e+00  4.51257283e+01
  4.51257283e+01  4.51257283e+01  7.20832382e+01  1.78766473e+02
  1.78766473e+02  1.78766473e+02  5.40837013e+02  5.80663629e+02
  5.80663629e+02  5.80663629e+02  1.44953244e+03  1.44953244e+03
  1.44953244e+03  2.59193508e+03  3.14697261e+03  3.14697261e+03
  3.14697261e+03  6.76201038e+03  6.76201038e+03  6.76201038e+03
  9.00052690e+03  2.53642030e+04  7.61130605e+04]
E1 = -728.3287522758457  E_coul = 201.8603695051643
cycle= 4 E= -526.468382770681  delta_E= -2.88e-07  |g|= 4.14e-05  |ddm|= 0.000764
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.29327e-05
diis-c [-1.72355352e-09  8.78237756e-06 -1.88508011e-03 -9.31815676e-03
  1.01119445e+00]
  HOMO = -0.5698440665867  LUMO = 1.13114677341241
  mo_energy =
[-1.18556665e+02 -1.21844790e+01 -9.53527525e+00 -9.53527525e+00
 -9.53527525e+00 -1.24751716e+00 -5.69844067e-01 -5.69844067e-01
 -5.69844067e-01  1.13114677e+00  1.13114677e+00  1.13114677e+00
  9.19015968e+00  9.19015968e+00  9.19015968e+00  4.51258128e+01
  4.51258128e+01  4.51258128e+01  7.20833327e+01  1.78766564e+02
  1.78766564e+02  1.78766564e+02  5.40837101e+02  5.80663719e+02
  5.80663719e+02  5.80663719e+02  1.44953253e+03  1.44953253e+03
  1.44953253e+03  2.59193516e+03  3.14697269e+03  3.14697269e+03
  3.14697269e+03  6.76201046e+03  6.76201046e+03  6.76201046e+03
  9.00052697e+03  2.53642031e+04  7.61130605e+04]
E1 = -728.3285539858375  E_coul = 201.8601712150282
cycle= 5 E= -526.468382770809  delta_E= -1.28e-10  |g|= 7.28e-06  |ddm|= 2.31e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3285539858375  E_coul = 201.8601712150282
  HOMO = -0.569847790851459  LUMO = 1.1311437322461
  mo_energy =
[-1.18556683e+02 -1.21844920e+01 -9.53528853e+00 -9.53528853e+00
 -9.53528853e+00 -1.24752199e+00 -5.69847791e-01 -5.69847791e-01
 -5.69847791e-01  1.13114373e+00  1.13114373e+00  1.13114373e+00
  9.19014979e+00  9.19014979e+00  9.19014979e+00  4.51257988e+01
  4.51257988e+01  4.51257988e+01  7.20833168e+01  1.78766547e+02
  1.78766547e+02  1.78766547e+02  5.40837083e+02  5.80663702e+02
  5.80663702e+02  5.80663702e+02  1.44953251e+03  1.44953251e+03
  1.44953251e+03  2.59193514e+03  3.14697267e+03  3.14697267e+03
  3.14697267e+03  6.76201044e+03  6.76201044e+03  6.76201044e+03
  9.00052695e+03  2.53642031e+04  7.61130605e+04]
E1 = -728.3285878189776  E_coul = 201.86020504816585
Extra cycle  E= -526.468382770812  delta_E= -2.39e-12  |g|= 1.85e-06  |ddm|= 3.63e-06
    CPU time for scf_cycle      0.68 sec, wall time      0.30 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 155560.72391944335
E1 = -728.3285878189776  E_coul = 201.86020504816585
init E= -526.468382770812
    CPU time for initialize scf      2.72 sec, wall time      0.25 sec
  HOMO = -0.56984715830715  LUMO = 1.13114425646904
  mo_energy =
[-1.18556679e+02 -1.21844895e+01 -9.53528598e+00 -9.53528598e+00
 -9.53528598e+00 -1.24752116e+00 -5.69847158e-01 -5.69847158e-01
 -5.69847158e-01  1.13114426e+00  1.13114426e+00  1.13114426e+00
  9.19015160e+00  9.19015160e+00  9.19015160e+00  4.51258016e+01
  4.51258016e+01  4.51258016e+01  7.20833202e+01  1.78766551e+02
  1.78766551e+02  1.78766551e+02  5.40837087e+02  5.80663706e+02
  5.80663706e+02  5.80663706e+02  1.44953252e+03  1.44953252e+03
  1.44953252e+03  2.59193515e+03  3.14697268e+03  3.14697268e+03
  3.14697268e+03  6.76201045e+03  6.76201045e+03  6.76201045e+03
  9.00052695e+03  2.53642031e+04  7.61130605e+04]
E1 = -728.32858098172  E_coul = 201.8601982109077
cycle= 1 E= -526.468382770812  delta_E= -6.82e-13  |g|= 4.07e-07  |ddm|= 6.73e-07
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
E1 = -728.32858098172  E_coul = 201.8601982109077
  HOMO = -0.569847278288709  LUMO = 1.13114415640966
  mo_energy =
[-1.18556680e+02 -1.21844900e+01 -9.53528649e+00 -9.53528649e+00
 -9.53528649e+00 -1.24752132e+00 -5.69847278e-01 -5.69847278e-01
 -5.69847278e-01  1.13114416e+00  1.13114416e+00  1.13114416e+00
  9.19015124e+00  9.19015124e+00  9.19015124e+00  4.51258011e+01
  4.51258011e+01  4.51258011e+01  7.20833195e+01  1.78766550e+02
  1.78766550e+02  1.78766550e+02  5.40837086e+02  5.80663705e+02
  5.80663705e+02  5.80663705e+02  1.44953252e+03  1.44953252e+03
  1.44953252e+03  2.59193514e+03  3.14697268e+03  3.14697268e+03
  3.14697268e+03  6.76201045e+03  6.76201045e+03  6.76201045e+03
  9.00052695e+03  2.53642031e+04  7.61130605e+04]
E1 = -728.328582386466  E_coul = 201.86019961565376
Extra cycle  E= -526.468382770812  delta_E= 1.14e-13  |g|= 8.66e-08  |ddm|= 1.34e-07
    CPU time for scf_cycle      2.87 sec, wall time      0.40 sec
exp = [2.61825434e+04 7.61781106e+03 3.61731304e+03 1.60435799e+03
 3.72081524e+02 1.04897576e+02 3.40750898e+01 4.58077275e+00
 3.94802515e-01 1.36276310e+03 6.64790709e+02 3.01179261e+02
 3.14257901e+02 8.69723010e+01 9.27399417e+00 2.70416653e+01
 8.35208672e-01 3.36528140e+00 2.36031693e-01]
grad_E = [-1.56589497e-06  3.94050407e-06 -8.36663471e-07  8.79415950e-05
 -1.09362552e-04 -2.90081514e-05 -7.06336774e-05  1.43924959e-04
  2.99196433e-04 -2.67275127e-07  1.43482853e-08  3.16404413e-08
  4.51015559e-07  4.06011367e-04  3.61452702e-04  7.20940019e-05
  1.15604362e-03 -7.82326106e-04 -8.46153092e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:45:03 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5433848        1
[INPUT] 0    0    [1    /1   ]  7617.81195208        1
[INPUT] 0    0    [1    /1   ]  3617.31555719        1
[INPUT] 0    0    [1    /1   ]  1604.38872051        1
[INPUT] 0    0    [1    /1   ]  371.731175817        1
[INPUT] 0    0    [1    /1   ]  104.798314964        1
[INPUT] 0    0    [1    /1   ]  34.0489147029        1
[INPUT] 0    0    [1    /1   ]  4.58084297381        1
[INPUT] 0    0    [1    /1   ]  0.394776460595       1
[INPUT] 1    0    [1    /1   ]  1362.76320112        1
[INPUT] 1    0    [1    /1   ]  664.79173517         1
[INPUT] 1    0    [1    /1   ]  301.184898732        1
[INPUT] 1    0    [1    /1   ]  314.262845678        1
[INPUT] 1    0    [1    /1   ]  86.8421218917        1
[INPUT] 1    0    [1    /1   ]  9.26634259718        1
[INPUT] 1    0    [1    /1   ]  27.0123094837        1
[INPUT] 1    0    [1    /1   ]  0.835865391466       1
[INPUT] 1    0    [1    /1   ]  3.36227979851        1
[INPUT] 1    0    [1    /1   ]  0.236148239911       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.543384766774, 1.0]], [0, [7617.811952079179, 1.0]], [0, [3617.315557192031, 1.0]], [0, [1604.3887205134654, 1.0]], [0, [371.73117581661364, 1.0]], [0, [104.79831496377538, 1.0]], [0, [34.048914702893086, 1.0]], [0, [4.580842973807526, 1.0]], [0, [0.39477646059509025, 1.0]], [1, [1362.763201116836, 1.0]], [1, [664.7917351702655, 1.0]], [1, [301.1848987322556, 1.0]], [1, [314.2628456777107, 1.0]], [1, [86.84212189168774, 1.0]], [1, [9.266342597182211, 1.0]], [1, [27.01230948370581, 1.0]], [1, [0.8358653914660916, 1.0]], [1, [3.362279798508496, 1.0]], [1, [0.23614823991070405, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.54338477]
bas 1, expnt(s) = [7617.81195208]
bas 2, expnt(s) = [3617.31555719]
bas 3, expnt(s) = [1604.38872051]
bas 4, expnt(s) = [371.73117582]
bas 5, expnt(s) = [104.79831496]
bas 6, expnt(s) = [34.0489147]
bas 7, expnt(s) = [4.58084297]
bas 8, expnt(s) = [0.39477646]
bas 9, expnt(s) = [1362.76320112]
bas 10, expnt(s) = [664.79173517]
bas 11, expnt(s) = [301.18489873]
bas 12, expnt(s) = [314.26284568]
bas 13, expnt(s) = [86.84212189]
bas 14, expnt(s) = [9.2663426]
bas 15, expnt(s) = [27.01230948]
bas 16, expnt(s) = [0.83586539]
bas 17, expnt(s) = [3.3622798]
bas 18, expnt(s) = [0.23614824]
CPU time:       710.16
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825434e+04 5.20024611e+03 7.61781195e+03 2.06009719e+03
 3.61731556e+03 1.17843280e+03 1.60438872e+03 6.40467688e+02
 3.71731176e+02 2.13888169e+02 1.04798315e+02 8.27524288e+01
 3.40489147e+01 3.56116814e+01 4.58084297e+00 7.91086691e+00
 3.94776461e-01 1.25828338e+00 1.36276320e+03 2.41551584e+04
 6.64791735e+02 9.84784959e+03 3.01184899e+02 3.66037755e+03
 3.14262846e+02 3.86011898e+03 8.68421219e+01 7.73387994e+02
 9.26634260e+00 4.71649995e+01 2.70123095e+01 1.79653854e+02
 8.35865391e-01 2.33160416e+00 3.36227980e+00 1.32824046e+01
 2.36148240e-01 4.80247689e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.974294897757822
cond(S) = 155234.2080788095
E1 = -728.8750533996214  E_coul = 203.11683633412247
init E= -525.758217065499
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558870360328431  LUMO = 1.1392837736678
  mo_energy =
[-1.18318606e+02 -1.21041778e+01 -9.44869379e+00 -9.44869379e+00
 -9.44869379e+00 -1.23031662e+00 -5.58870360e-01 -5.58870360e-01
 -5.58870360e-01  1.13928377e+00  1.13928377e+00  1.13928377e+00
  9.23898074e+00  9.23898074e+00  9.23898074e+00  4.51873333e+01
  4.51873333e+01  4.51873333e+01  7.21283979e+01  1.78722239e+02
  1.78722239e+02  1.78722239e+02  5.40514355e+02  5.80455063e+02
  5.80455063e+02  5.80455063e+02  1.44928247e+03  1.44928247e+03
  1.44928247e+03  2.59098173e+03  3.14677488e+03  3.14677488e+03
  3.14677488e+03  6.76195974e+03  6.76195974e+03  6.76195974e+03
  8.99946329e+03  2.53632476e+04  7.61122901e+04]
E1 = -728.0847939860718  E_coul = 201.61679605193606
cycle= 1 E= -526.467997934136  delta_E= -0.71  |g|= 0.185  |ddm|= 0.488
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.550282
diis-c [-0.3028106  1.       ]
  HOMO = -0.572899145069651  LUMO = 1.12949627563856
  mo_energy =
[-1.18594209e+02 -1.22020040e+01 -9.55311446e+00 -9.55311446e+00
 -9.55311446e+00 -1.25157574e+00 -5.72899145e-01 -5.72899145e-01
 -5.72899145e-01  1.12949628e+00  1.12949628e+00  1.12949628e+00
  9.17371853e+00  9.17371853e+00  9.17371853e+00  4.50551256e+01
  4.50551256e+01  4.50551256e+01  7.19650475e+01  1.78514078e+02
  1.78514078e+02  1.78514078e+02  5.40205612e+02  5.80181919e+02
  5.80181919e+02  5.80181919e+02  1.44895437e+03  1.44895437e+03
  1.44895437e+03  2.59051608e+03  3.14638005e+03  3.14638005e+03
  3.14638005e+03  6.76144930e+03  6.76144930e+03  6.76144930e+03
  8.99887480e+03  2.53625644e+04  7.61115161e+04]
E1 = -728.3817187576103  E_coul = 201.91334213107544
cycle= 2 E= -526.468376626535  delta_E= -0.000379  |g|= 0.0245  |ddm|= 0.0207
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0472563
diis-c [-0.00143596  0.04891559  0.95108441]
  HOMO = -0.569224754053488  LUMO = 1.13268820203311
  mo_energy =
[-1.18551455e+02 -1.21817063e+01 -9.53241328e+00 -9.53241328e+00
 -9.53241328e+00 -1.24670370e+00 -5.69224754e-01 -5.69224754e-01
 -5.69224754e-01  1.13268820e+00  1.13268820e+00  1.13268820e+00
  9.18669497e+00  9.18669497e+00  9.18669497e+00  4.50797413e+01
  4.50797413e+01  4.50797413e+01  7.19987454e+01  1.78550074e+02
  1.78550074e+02  1.78550074e+02  5.40249704e+02  5.80224326e+02
  5.80224326e+02  5.80224326e+02  1.44899957e+03  1.44899957e+03
  1.44899957e+03  2.59056360e+03  3.14642686e+03  3.14642686e+03
  3.14642686e+03  6.76149714e+03  6.76149714e+03  6.76149714e+03
  8.99892307e+03  2.53626128e+04  7.61115646e+04]
E1 = -728.3208461171644  E_coul = 201.8524563660524
cycle= 3 E= -526.468389751112  delta_E= -1.31e-05  |g|= 0.00298  |ddm|= 0.00521
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0064064
diis-c [-3.61985038e-07 -1.09156253e-03  1.12577402e-01  8.88514160e-01]
  HOMO = -0.569877716515513  LUMO = 1.13214078676324
  mo_energy =
[-1.18556683e+02 -1.21845256e+01 -9.53533913e+00 -9.53533913e+00
 -9.53533913e+00 -1.24755170e+00 -5.69877717e-01 -5.69877717e-01
 -5.69877717e-01  1.13214079e+00  1.13214079e+00  1.13214079e+00
  9.18470995e+00  9.18470995e+00  9.18470995e+00  4.50764164e+01
  4.50764164e+01  4.50764164e+01  7.19945978e+01  1.78545565e+02
  1.78545565e+02  1.78545565e+02  5.40244313e+02  5.80219143e+02
  5.80219143e+02  5.80219143e+02  1.44899405e+03  1.44899405e+03
  1.44899405e+03  2.59055766e+03  3.14642109e+03  3.14642109e+03
  3.14642109e+03  6.76149113e+03  6.76149113e+03  6.76149113e+03
  8.99891691e+03  2.53626066e+04  7.61115582e+04]
E1 = -728.3290718596913  E_coul = 201.86068182055467
cycle= 4 E= -526.468390039137  delta_E= -2.88e-07  |g|= 4.14e-05  |ddm|= 0.000764
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.29331e-05
diis-c [-1.72498260e-09  8.72503913e-06 -1.87937906e-03 -9.27556744e-03
  1.01114622e+00]
  HOMO = -0.569851050476219  LUMO = 1.13216245130541
  mo_energy =
[-1.18556592e+02 -1.21844399e+01 -9.53525465e+00 -9.53525465e+00
 -9.53525465e+00 -1.24751708e+00 -5.69851050e-01 -5.69851050e-01
 -5.69851050e-01  1.13216245e+00  1.13216245e+00  1.13216245e+00
  9.18477630e+00  9.18477630e+00  9.18477630e+00  4.50765010e+01
  4.50765010e+01  4.50765010e+01  7.19946923e+01  1.78545656e+02
  1.78545656e+02  1.78545656e+02  5.40244400e+02  5.80219234e+02
  5.80219234e+02  5.80219234e+02  1.44899414e+03  1.44899414e+03
  1.44899414e+03  2.59055774e+03  3.14642118e+03  3.14642118e+03
  3.14642118e+03  6.76149120e+03  6.76149120e+03  6.76149120e+03
  8.99891699e+03  2.53626066e+04  7.61115583e+04]
E1 = -728.3288734763344  E_coul = 201.8604834370706
cycle= 5 E= -526.468390039264  delta_E= -1.27e-10  |g|= 7.29e-06  |ddm|= 2.31e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3288734763344  E_coul = 201.8604834370706
  HOMO = -0.569854775571362  LUMO = 1.13215940707663
  mo_energy =
[-1.18556610e+02 -1.21844529e+01 -9.53526794e+00 -9.53526794e+00
 -9.53526794e+00 -1.24752191e+00 -5.69854776e-01 -5.69854776e-01
 -5.69854776e-01  1.13215941e+00  1.13215941e+00  1.13215941e+00
  9.18476641e+00  9.18476641e+00  9.18476641e+00  4.50764870e+01
  4.50764870e+01  4.50764870e+01  7.19946764e+01  1.78545639e+02
  1.78545639e+02  1.78545639e+02  5.40244382e+02  5.80219216e+02
  5.80219216e+02  5.80219216e+02  1.44899412e+03  1.44899412e+03
  1.44899412e+03  2.59055772e+03  3.14642116e+03  3.14642116e+03
  3.14642116e+03  6.76149118e+03  6.76149118e+03  6.76149118e+03
  8.99891697e+03  2.53626066e+04  7.61115583e+04]
E1 = -728.3289073294018  E_coul = 201.86051729013454
Extra cycle  E= -526.468390039267  delta_E= -3.41e-12  |g|= 1.85e-06  |ddm|= 3.63e-06
    CPU time for scf_cycle      0.69 sec, wall time      0.30 sec
exp = [2.61825434e+04 7.61781195e+03 3.61731556e+03 1.60438872e+03
 3.71731176e+02 1.04798315e+02 3.40489147e+01 4.58084297e+00
 3.94776461e-01 1.36276320e+03 6.64791735e+02 3.01184899e+02
 3.14262846e+02 8.68421219e+01 9.26634260e+00 2.70123095e+01
 8.35865391e-01 3.36227980e+00 2.36148240e-01]
E = -526.4683900392672
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:45:03 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5433848        1
[INPUT] 0    0    [1    /1   ]  7617.81195208        1
[INPUT] 0    0    [1    /1   ]  3617.31555719        1
[INPUT] 0    0    [1    /1   ]  1604.38872051        1
[INPUT] 0    0    [1    /1   ]  371.731175817        1
[INPUT] 0    0    [1    /1   ]  104.798314964        1
[INPUT] 0    0    [1    /1   ]  34.0489147029        1
[INPUT] 0    0    [1    /1   ]  4.58084297381        1
[INPUT] 0    0    [1    /1   ]  0.394776460595       1
[INPUT] 1    0    [1    /1   ]  1362.76320112        1
[INPUT] 1    0    [1    /1   ]  664.79173517         1
[INPUT] 1    0    [1    /1   ]  301.184898732        1
[INPUT] 1    0    [1    /1   ]  314.262845678        1
[INPUT] 1    0    [1    /1   ]  86.8421218917        1
[INPUT] 1    0    [1    /1   ]  9.26634259718        1
[INPUT] 1    0    [1    /1   ]  27.0123094837        1
[INPUT] 1    0    [1    /1   ]  0.835865391466       1
[INPUT] 1    0    [1    /1   ]  3.36227979851        1
[INPUT] 1    0    [1    /1   ]  0.236148239911       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.543384766774, 1.0]], [0, [7617.811952079179, 1.0]], [0, [3617.315557192031, 1.0]], [0, [1604.3887205134654, 1.0]], [0, [371.73117581661364, 1.0]], [0, [104.79831496377538, 1.0]], [0, [34.048914702893086, 1.0]], [0, [4.580842973807526, 1.0]], [0, [0.39477646059509025, 1.0]], [1, [1362.763201116836, 1.0]], [1, [664.7917351702655, 1.0]], [1, [301.1848987322556, 1.0]], [1, [314.2628456777107, 1.0]], [1, [86.84212189168774, 1.0]], [1, [9.266342597182211, 1.0]], [1, [27.01230948370581, 1.0]], [1, [0.8358653914660916, 1.0]], [1, [3.362279798508496, 1.0]], [1, [0.23614823991070405, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.54338477]
bas 1, expnt(s) = [7617.81195208]
bas 2, expnt(s) = [3617.31555719]
bas 3, expnt(s) = [1604.38872051]
bas 4, expnt(s) = [371.73117582]
bas 5, expnt(s) = [104.79831496]
bas 6, expnt(s) = [34.0489147]
bas 7, expnt(s) = [4.58084297]
bas 8, expnt(s) = [0.39477646]
bas 9, expnt(s) = [1362.76320112]
bas 10, expnt(s) = [664.79173517]
bas 11, expnt(s) = [301.18489873]
bas 12, expnt(s) = [314.26284568]
bas 13, expnt(s) = [86.84212189]
bas 14, expnt(s) = [9.2663426]
bas 15, expnt(s) = [27.01230948]
bas 16, expnt(s) = [0.83586539]
bas 17, expnt(s) = [3.3622798]
bas 18, expnt(s) = [0.23614824]
CPU time:       711.14
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825434e+04 5.20024611e+03 7.61781195e+03 2.06009719e+03
 3.61731556e+03 1.17843280e+03 1.60438872e+03 6.40467688e+02
 3.71731176e+02 2.13888169e+02 1.04798315e+02 8.27524288e+01
 3.40489147e+01 3.56116814e+01 4.58084297e+00 7.91086691e+00
 3.94776461e-01 1.25828338e+00 1.36276320e+03 2.41551584e+04
 6.64791735e+02 9.84784959e+03 3.01184899e+02 3.66037755e+03
 3.14262846e+02 3.86011898e+03 8.68421219e+01 7.73387994e+02
 9.26634260e+00 4.71649995e+01 2.70123095e+01 1.79653854e+02
 8.35865391e-01 2.33160416e+00 3.36227980e+00 1.32824046e+01
 2.36148240e-01 4.80247689e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.974294897757822
cond(S) = 155234.2080788095
E1 = -728.8750533996214  E_coul = 203.11683633412247
init E= -525.758217065499
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558870360328431  LUMO = 1.1392837736678
  mo_energy =
[-1.18318606e+02 -1.21041778e+01 -9.44869379e+00 -9.44869379e+00
 -9.44869379e+00 -1.23031662e+00 -5.58870360e-01 -5.58870360e-01
 -5.58870360e-01  1.13928377e+00  1.13928377e+00  1.13928377e+00
  9.23898074e+00  9.23898074e+00  9.23898074e+00  4.51873333e+01
  4.51873333e+01  4.51873333e+01  7.21283979e+01  1.78722239e+02
  1.78722239e+02  1.78722239e+02  5.40514355e+02  5.80455063e+02
  5.80455063e+02  5.80455063e+02  1.44928247e+03  1.44928247e+03
  1.44928247e+03  2.59098173e+03  3.14677488e+03  3.14677488e+03
  3.14677488e+03  6.76195974e+03  6.76195974e+03  6.76195974e+03
  8.99946329e+03  2.53632476e+04  7.61122901e+04]
E1 = -728.0847939860718  E_coul = 201.61679605193606
cycle= 1 E= -526.467997934136  delta_E= -0.71  |g|= 0.185  |ddm|= 0.488
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.550282
diis-c [-0.3028106  1.       ]
  HOMO = -0.572899145069651  LUMO = 1.12949627563856
  mo_energy =
[-1.18594209e+02 -1.22020040e+01 -9.55311446e+00 -9.55311446e+00
 -9.55311446e+00 -1.25157574e+00 -5.72899145e-01 -5.72899145e-01
 -5.72899145e-01  1.12949628e+00  1.12949628e+00  1.12949628e+00
  9.17371853e+00  9.17371853e+00  9.17371853e+00  4.50551256e+01
  4.50551256e+01  4.50551256e+01  7.19650475e+01  1.78514078e+02
  1.78514078e+02  1.78514078e+02  5.40205612e+02  5.80181919e+02
  5.80181919e+02  5.80181919e+02  1.44895437e+03  1.44895437e+03
  1.44895437e+03  2.59051608e+03  3.14638005e+03  3.14638005e+03
  3.14638005e+03  6.76144930e+03  6.76144930e+03  6.76144930e+03
  8.99887480e+03  2.53625644e+04  7.61115161e+04]
E1 = -728.3817187576103  E_coul = 201.91334213107544
cycle= 2 E= -526.468376626535  delta_E= -0.000379  |g|= 0.0245  |ddm|= 0.0207
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0472563
diis-c [-0.00143596  0.04891559  0.95108441]
  HOMO = -0.569224754053488  LUMO = 1.13268820203311
  mo_energy =
[-1.18551455e+02 -1.21817063e+01 -9.53241328e+00 -9.53241328e+00
 -9.53241328e+00 -1.24670370e+00 -5.69224754e-01 -5.69224754e-01
 -5.69224754e-01  1.13268820e+00  1.13268820e+00  1.13268820e+00
  9.18669497e+00  9.18669497e+00  9.18669497e+00  4.50797413e+01
  4.50797413e+01  4.50797413e+01  7.19987454e+01  1.78550074e+02
  1.78550074e+02  1.78550074e+02  5.40249704e+02  5.80224326e+02
  5.80224326e+02  5.80224326e+02  1.44899957e+03  1.44899957e+03
  1.44899957e+03  2.59056360e+03  3.14642686e+03  3.14642686e+03
  3.14642686e+03  6.76149714e+03  6.76149714e+03  6.76149714e+03
  8.99892307e+03  2.53626128e+04  7.61115646e+04]
E1 = -728.3208461171644  E_coul = 201.8524563660524
cycle= 3 E= -526.468389751112  delta_E= -1.31e-05  |g|= 0.00298  |ddm|= 0.00521
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0064064
diis-c [-3.61985038e-07 -1.09156253e-03  1.12577402e-01  8.88514160e-01]
  HOMO = -0.569877716515513  LUMO = 1.13214078676324
  mo_energy =
[-1.18556683e+02 -1.21845256e+01 -9.53533913e+00 -9.53533913e+00
 -9.53533913e+00 -1.24755170e+00 -5.69877717e-01 -5.69877717e-01
 -5.69877717e-01  1.13214079e+00  1.13214079e+00  1.13214079e+00
  9.18470995e+00  9.18470995e+00  9.18470995e+00  4.50764164e+01
  4.50764164e+01  4.50764164e+01  7.19945978e+01  1.78545565e+02
  1.78545565e+02  1.78545565e+02  5.40244313e+02  5.80219143e+02
  5.80219143e+02  5.80219143e+02  1.44899405e+03  1.44899405e+03
  1.44899405e+03  2.59055766e+03  3.14642109e+03  3.14642109e+03
  3.14642109e+03  6.76149113e+03  6.76149113e+03  6.76149113e+03
  8.99891691e+03  2.53626066e+04  7.61115582e+04]
E1 = -728.3290718596913  E_coul = 201.86068182055467
cycle= 4 E= -526.468390039137  delta_E= -2.88e-07  |g|= 4.14e-05  |ddm|= 0.000764
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.29331e-05
diis-c [-1.72498260e-09  8.72503913e-06 -1.87937906e-03 -9.27556744e-03
  1.01114622e+00]
  HOMO = -0.569851050476219  LUMO = 1.13216245130541
  mo_energy =
[-1.18556592e+02 -1.21844399e+01 -9.53525465e+00 -9.53525465e+00
 -9.53525465e+00 -1.24751708e+00 -5.69851050e-01 -5.69851050e-01
 -5.69851050e-01  1.13216245e+00  1.13216245e+00  1.13216245e+00
  9.18477630e+00  9.18477630e+00  9.18477630e+00  4.50765010e+01
  4.50765010e+01  4.50765010e+01  7.19946923e+01  1.78545656e+02
  1.78545656e+02  1.78545656e+02  5.40244400e+02  5.80219234e+02
  5.80219234e+02  5.80219234e+02  1.44899414e+03  1.44899414e+03
  1.44899414e+03  2.59055774e+03  3.14642118e+03  3.14642118e+03
  3.14642118e+03  6.76149120e+03  6.76149120e+03  6.76149120e+03
  8.99891699e+03  2.53626066e+04  7.61115583e+04]
E1 = -728.3288734763344  E_coul = 201.8604834370706
cycle= 5 E= -526.468390039264  delta_E= -1.27e-10  |g|= 7.29e-06  |ddm|= 2.31e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3288734763344  E_coul = 201.8604834370706
  HOMO = -0.569854775571362  LUMO = 1.13215940707663
  mo_energy =
[-1.18556610e+02 -1.21844529e+01 -9.53526794e+00 -9.53526794e+00
 -9.53526794e+00 -1.24752191e+00 -5.69854776e-01 -5.69854776e-01
 -5.69854776e-01  1.13215941e+00  1.13215941e+00  1.13215941e+00
  9.18476641e+00  9.18476641e+00  9.18476641e+00  4.50764870e+01
  4.50764870e+01  4.50764870e+01  7.19946764e+01  1.78545639e+02
  1.78545639e+02  1.78545639e+02  5.40244382e+02  5.80219216e+02
  5.80219216e+02  5.80219216e+02  1.44899412e+03  1.44899412e+03
  1.44899412e+03  2.59055772e+03  3.14642116e+03  3.14642116e+03
  3.14642116e+03  6.76149118e+03  6.76149118e+03  6.76149118e+03
  8.99891697e+03  2.53626066e+04  7.61115583e+04]
E1 = -728.3289073294018  E_coul = 201.86051729013454
Extra cycle  E= -526.468390039267  delta_E= -3.41e-12  |g|= 1.85e-06  |ddm|= 3.63e-06
    CPU time for scf_cycle      0.69 sec, wall time      0.30 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 155234.2080788095
E1 = -728.3289073294018  E_coul = 201.86051729013454
init E= -526.468390039267
    CPU time for initialize scf      2.73 sec, wall time      0.25 sec
  HOMO = -0.569854142808077  LUMO = 1.13215993189105
  mo_energy =
[-1.18556606e+02 -1.21844505e+01 -9.53526538e+00 -9.53526538e+00
 -9.53526538e+00 -1.24752108e+00 -5.69854143e-01 -5.69854143e-01
 -5.69854143e-01  1.13215993e+00  1.13215993e+00  1.13215993e+00
  9.18476822e+00  9.18476822e+00  9.18476822e+00  4.50764898e+01
  4.50764898e+01  4.50764898e+01  7.19946798e+01  1.78545643e+02
  1.78545643e+02  1.78545643e+02  5.40244386e+02  5.80219220e+02
  5.80219220e+02  5.80219220e+02  1.44899412e+03  1.44899412e+03
  1.44899412e+03  2.59055773e+03  3.14642116e+03  3.14642116e+03
  3.14642116e+03  6.76149119e+03  6.76149119e+03  6.76149119e+03
  8.99891697e+03  2.53626066e+04  7.61115583e+04]
E1 = -728.3289004865942  E_coul = 201.86051044732636
cycle= 1 E= -526.468390039268  delta_E= -6.82e-13  |g|= 4.08e-07  |ddm|= 6.74e-07
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
E1 = -728.3289004865942  E_coul = 201.86051044732636
  HOMO = -0.569854262863221  LUMO = 1.13215983169148
  mo_energy =
[-1.18556607e+02 -1.21844510e+01 -9.53526590e+00 -9.53526590e+00
 -9.53526590e+00 -1.24752124e+00 -5.69854263e-01 -5.69854263e-01
 -5.69854263e-01  1.13215983e+00  1.13215983e+00  1.13215983e+00
  9.18476786e+00  9.18476786e+00  9.18476786e+00  4.50764892e+01
  4.50764892e+01  4.50764892e+01  7.19946791e+01  1.78545642e+02
  1.78545642e+02  1.78545642e+02  5.40244386e+02  5.80219219e+02
  5.80219219e+02  5.80219219e+02  1.44899412e+03  1.44899412e+03
  1.44899412e+03  2.59055772e+03  3.14642116e+03  3.14642116e+03
  3.14642116e+03  6.76149119e+03  6.76149119e+03  6.76149119e+03
  8.99891697e+03  2.53626066e+04  7.61115583e+04]
E1 = -728.328901892767  E_coul = 201.86051185349868
Extra cycle  E= -526.468390039268  delta_E= -4.55e-13  |g|= 8.67e-08  |ddm|= 1.35e-07
    CPU time for scf_cycle      2.89 sec, wall time      0.41 sec
exp = [2.61825434e+04 7.61781195e+03 3.61731556e+03 1.60438872e+03
 3.71731176e+02 1.04798315e+02 3.40489147e+01 4.58084297e+00
 3.94776461e-01 1.36276320e+03 6.64791735e+02 3.01184899e+02
 3.14262846e+02 8.68421219e+01 9.26634260e+00 2.70123095e+01
 8.35865391e-01 3.36227980e+00 2.36148240e-01]
grad_E = [-1.56764845e-06  3.96257030e-06 -8.14482982e-07  8.86501752e-05
 -1.16244700e-04 -1.19131625e-05 -1.19725614e-04  3.00069872e-04
 -3.19912913e-05 -2.70260283e-07  1.30940302e-08  3.72978064e-09
  4.24574029e-07  4.08194298e-04  5.29663388e-04  4.06614517e-05
  2.45699320e-03 -1.22422370e-03 -2.21248098e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:45:08 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5435105        1
[INPUT] 0    0    [1    /1   ]  7617.81317255        1
[INPUT] 0    0    [1    /1   ]  3617.31981769        1
[INPUT] 0    0    [1    /1   ]  1604.43388718        1
[INPUT] 0    0    [1    /1   ]  371.154505324        1
[INPUT] 0    0    [1    /1   ]  104.636571397        1
[INPUT] 0    0    [1    /1   ]  34.0068226671        1
[INPUT] 0    0    [1    /1   ]  4.58094700559        1
[INPUT] 0    0    [1    /1   ]  0.394717350918       1
[INPUT] 1    0    [1    /1   ]  1362.76338113        1
[INPUT] 1    0    [1    /1   ]  664.793446639        1
[INPUT] 1    0    [1    /1   ]  301.194310502        1
[INPUT] 1    0    [1    /1   ]  314.271070319        1
[INPUT] 1    0    [1    /1   ]  86.5957499028        1
[INPUT] 1    0    [1    /1   ]  9.2524561542         1
[INPUT] 1    0    [1    /1   ]  26.9585511309        1
[INPUT] 1    0    [1    /1   ]  0.836993681696       1
[INPUT] 1    0    [1    /1   ]  3.3572513599         1
[INPUT] 1    0    [1    /1   ]  0.236354323143       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.54351053925, 1.0]], [0, [7617.8131725516805, 1.0]], [0, [3617.319817689373, 1.0]], [0, [1604.4338871797543, 1.0]], [0, [371.1545053239113, 1.0]], [0, [104.63657139733097, 1.0]], [0, [34.00682266714349, 1.0]], [0, [4.580947005585159, 1.0]], [0, [0.3947173509175376, 1.0]], [1, [1362.7633811327964, 1.0]], [1, [664.7934466389842, 1.0]], [1, [301.1943105023982, 1.0]], [1, [314.2710703187004, 1.0]], [1, [86.59574990281025, 1.0]], [1, [9.252456154200708, 1.0]], [1, [26.95855113088514, 1.0]], [1, [0.8369936816961561, 1.0]], [1, [3.3572513598978184, 1.0]], [1, [0.23635432314297916, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.54351054]
bas 1, expnt(s) = [7617.81317255]
bas 2, expnt(s) = [3617.31981769]
bas 3, expnt(s) = [1604.43388718]
bas 4, expnt(s) = [371.15450532]
bas 5, expnt(s) = [104.6365714]
bas 6, expnt(s) = [34.00682267]
bas 7, expnt(s) = [4.58094701]
bas 8, expnt(s) = [0.39471735]
bas 9, expnt(s) = [1362.76338113]
bas 10, expnt(s) = [664.79344664]
bas 11, expnt(s) = [301.1943105]
bas 12, expnt(s) = [314.27107032]
bas 13, expnt(s) = [86.5957499]
bas 14, expnt(s) = [9.25245615]
bas 15, expnt(s) = [26.95855113]
bas 16, expnt(s) = [0.83699368]
bas 17, expnt(s) = [3.35725136]
bas 18, expnt(s) = [0.23635432]
CPU time:       719.57
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825435e+04 5.20024613e+03 7.61781317e+03 2.06009744e+03
 3.61731982e+03 1.17843384e+03 1.60443389e+03 6.40481211e+02
 3.71154505e+02 2.13639266e+02 1.04636571e+02 8.26566215e+01
 3.40068227e+01 3.55786583e+01 4.58094701e+00 7.91100165e+00
 3.94717351e-01 1.25814208e+00 1.36276338e+03 2.41551624e+04
 6.64793447e+02 9.84788128e+03 3.01194311e+02 3.66052053e+03
 3.14271070e+02 3.86024526e+03 8.65957499e+01 7.70646330e+02
 9.25245615e+00 4.70766648e+01 2.69585511e+01 1.79207044e+02
 8.36993682e-01 2.33553896e+00 3.35725136e+00 1.32575788e+01
 2.36354323e-01 4.80771628e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.974263762449322
cond(S) = 154618.44460808788
E1 = -728.8757537719672  E_coul = 203.11660223938514
init E= -525.759151532582
    CPU time for initialize scf      0.45 sec, wall time      0.05 sec
  HOMO = -0.558890238078214  LUMO = 1.1410671626445
  mo_energy =
[-1.18318571e+02 -1.21041740e+01 -9.44872285e+00 -9.44872285e+00
 -9.44872285e+00 -1.23033621e+00 -5.58890238e-01 -5.58890238e-01
 -5.58890238e-01  1.14106716e+00  1.14106716e+00  1.14106716e+00
  9.22964159e+00  9.22964159e+00  9.22964159e+00  4.50985532e+01
  4.50985532e+01  4.50985532e+01  7.19848732e+01  1.78312359e+02
  1.78312359e+02  1.78312359e+02  5.39546253e+02  5.79621587e+02
  5.79621587e+02  5.79621587e+02  1.44826887e+03  1.44826887e+03
  1.44826887e+03  2.58871999e+03  3.14573302e+03  3.14573302e+03
  3.14573302e+03  6.76097621e+03  6.76097621e+03  6.76097621e+03
  8.99681104e+03  2.53606112e+04  7.61098061e+04]
E1 = -728.0854016024616  E_coul = 201.61738449134884
cycle= 1 E= -526.468017111113  delta_E= -0.709  |g|= 0.185  |ddm|= 0.481
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.55033
diis-c [-0.30286266  1.        ]
  HOMO = -0.572909263313707  LUMO = 1.13126685326374
  mo_energy =
[-1.18594078e+02 -1.22019356e+01 -9.55307773e+00 -9.55307773e+00
 -9.55307773e+00 -1.25157024e+00 -5.72909263e-01 -5.72909263e-01
 -5.72909263e-01  1.13126685e+00  1.13126685e+00  1.13126685e+00
  9.16449273e+00  9.16449273e+00  9.16449273e+00  4.49665442e+01
  4.49665442e+01  4.49665442e+01  7.18217017e+01  1.78104415e+02
  1.78104415e+02  1.78104415e+02  5.39237722e+02  5.79348541e+02
  5.79348541e+02  5.79348541e+02  1.44794082e+03  1.44794082e+03
  1.44794082e+03  2.58825441e+03  3.14533823e+03  3.14533823e+03
  3.14533823e+03  6.76046579e+03  6.76046579e+03  6.76046579e+03
  8.99622254e+03  2.53599279e+04  7.61090321e+04]
E1 = -728.3822372734479  E_coul = 201.9138416008563
cycle= 2 E= -526.468395672592  delta_E= -0.000379  |g|= 0.0245  |ddm|= 0.0207
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0472751
diis-c [-0.00143709  0.04893082  0.95106918]
  HOMO = -0.569239282299214  LUMO = 1.13445953533311
  mo_energy =
[-1.18551328e+02 -1.21816437e+01 -9.53238213e+00 -9.53238213e+00
 -9.53238213e+00 -1.24670371e+00 -5.69239282e-01 -5.69239282e-01
 -5.69239282e-01  1.13445954e+00  1.13445954e+00  1.13445954e+00
  9.17744771e+00  9.17744771e+00  9.17744771e+00  4.49911317e+01
  4.49911317e+01  4.49911317e+01  7.18553761e+01  1.78140389e+02
  1.78140389e+02  1.78140389e+02  5.39281804e+02  5.79390942e+02
  5.79390942e+02  5.79390942e+02  1.44798601e+03  1.44798601e+03
  1.44798601e+03  2.58830193e+03  3.14538504e+03  3.14538504e+03
  3.14538504e+03  6.76051363e+03  6.76051363e+03  6.76051363e+03
  8.99627081e+03  2.53599764e+04  7.61090806e+04]
E1 = -728.3213586966262  E_coul = 201.8529498956792
cycle= 3 E= -526.468408800947  delta_E= -1.31e-05  |g|= 0.00298  |ddm|= 0.00521
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00641082
diis-c [-3.62699665e-07 -1.09198982e-03  1.12607613e-01  8.88484377e-01]
  HOMO = -0.569892158856599  LUMO = 1.13391143779013
  mo_energy =
[-1.18556557e+02 -1.21844632e+01 -9.53530826e+00 -9.53530826e+00
 -9.53530826e+00 -1.24755151e+00 -5.69892159e-01 -5.69892159e-01
 -5.69892159e-01  1.13391144e+00  1.13391144e+00  1.13391144e+00
  9.17546440e+00  9.17546440e+00  9.17546440e+00  4.49878088e+01
  4.49878088e+01  4.49878088e+01  7.18512297e+01  1.78135881e+02
  1.78135881e+02  1.78135881e+02  5.39276412e+02  5.79385758e+02
  5.79385758e+02  5.79385758e+02  1.44798049e+03  1.44798049e+03
  1.44798049e+03  2.58829599e+03  3.14537927e+03  3.14537927e+03
  3.14537927e+03  6.76050761e+03  6.76050761e+03  6.76050761e+03
  8.99626465e+03  2.53599701e+04  7.61090742e+04]
E1 = -728.32958740823  E_coul = 201.86117831900089
cycle= 4 E= -526.468409089229  delta_E= -2.88e-07  |g|= 4.14e-05  |ddm|= 0.000764
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.29462e-05
diis-c [-1.72748279e-09  8.63045459e-06 -1.86998815e-03 -9.20235059e-03
  1.01106371e+00]
  HOMO = -0.569865496493573  LUMO = 1.13393312681431
  mo_energy =
[-1.18556466e+02 -1.21843775e+01 -9.53522374e+00 -9.53522374e+00
 -9.53522374e+00 -1.24751689e+00 -5.69865496e-01 -5.69865496e-01
 -5.69865496e-01  1.13393313e+00  1.13393313e+00  1.13393313e+00
  9.17553072e+00  9.17553072e+00  9.17553072e+00  4.49878933e+01
  4.49878933e+01  4.49878933e+01  7.18513242e+01  1.78135972e+02
  1.78135972e+02  1.78135972e+02  5.39276500e+02  5.79385849e+02
  5.79385849e+02  5.79385849e+02  1.44798058e+03  1.44798058e+03
  1.44798058e+03  2.58829607e+03  3.14537936e+03  3.14537936e+03
  3.14537936e+03  6.76050769e+03  6.76050769e+03  6.76050769e+03
  8.99626473e+03  2.53599702e+04  7.61090743e+04]
E1 = -728.3293888546091  E_coul = 201.86097976525141
cycle= 5 E= -526.468409089358  delta_E= -1.28e-10  |g|= 7.3e-06  |ddm|= 2.31e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3293888546091  E_coul = 201.86097976525141
  HOMO = -0.569869222849798  LUMO = 1.13393007743331
  mo_energy =
[-1.18556484e+02 -1.21843905e+01 -9.53523703e+00 -9.53523703e+00
 -9.53523703e+00 -1.24752172e+00 -5.69869223e-01 -5.69869223e-01
 -5.69869223e-01  1.13393008e+00  1.13393008e+00  1.13393008e+00
  9.17552084e+00  9.17552084e+00  9.17552084e+00  4.49878794e+01
  4.49878794e+01  4.49878794e+01  7.18513083e+01  1.78135955e+02
  1.78135955e+02  1.78135955e+02  5.39276482e+02  5.79385831e+02
  5.79385831e+02  5.79385831e+02  1.44798056e+03  1.44798056e+03
  1.44798056e+03  2.58829605e+03  3.14537934e+03  3.14537934e+03
  3.14537934e+03  6.76050767e+03  6.76050767e+03  6.76050767e+03
  8.99626471e+03  2.53599701e+04  7.61090743e+04]
E1 = -728.3294227394337  E_coul = 201.8610136500742
Extra cycle  E= -526.46840908936  delta_E= -1.82e-12  |g|= 1.85e-06  |ddm|= 3.63e-06
    CPU time for scf_cycle      0.69 sec, wall time      0.30 sec
exp = [2.61825435e+04 7.61781317e+03 3.61731982e+03 1.60443389e+03
 3.71154505e+02 1.04636571e+02 3.40068227e+01 4.58094701e+00
 3.94717351e-01 1.36276338e+03 6.64793447e+02 3.01194311e+02
 3.14271070e+02 8.65957499e+01 9.25245615e+00 2.69585511e+01
 8.36993682e-01 3.35725136e+00 2.36354323e-01]
E = -526.4684090893595
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:45:09 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5435105        1
[INPUT] 0    0    [1    /1   ]  7617.81317255        1
[INPUT] 0    0    [1    /1   ]  3617.31981769        1
[INPUT] 0    0    [1    /1   ]  1604.43388718        1
[INPUT] 0    0    [1    /1   ]  371.154505324        1
[INPUT] 0    0    [1    /1   ]  104.636571397        1
[INPUT] 0    0    [1    /1   ]  34.0068226671        1
[INPUT] 0    0    [1    /1   ]  4.58094700559        1
[INPUT] 0    0    [1    /1   ]  0.394717350918       1
[INPUT] 1    0    [1    /1   ]  1362.76338113        1
[INPUT] 1    0    [1    /1   ]  664.793446639        1
[INPUT] 1    0    [1    /1   ]  301.194310502        1
[INPUT] 1    0    [1    /1   ]  314.271070319        1
[INPUT] 1    0    [1    /1   ]  86.5957499028        1
[INPUT] 1    0    [1    /1   ]  9.2524561542         1
[INPUT] 1    0    [1    /1   ]  26.9585511309        1
[INPUT] 1    0    [1    /1   ]  0.836993681696       1
[INPUT] 1    0    [1    /1   ]  3.3572513599         1
[INPUT] 1    0    [1    /1   ]  0.236354323143       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.54351053925, 1.0]], [0, [7617.8131725516805, 1.0]], [0, [3617.319817689373, 1.0]], [0, [1604.4338871797543, 1.0]], [0, [371.1545053239113, 1.0]], [0, [104.63657139733097, 1.0]], [0, [34.00682266714349, 1.0]], [0, [4.580947005585159, 1.0]], [0, [0.3947173509175376, 1.0]], [1, [1362.7633811327964, 1.0]], [1, [664.7934466389842, 1.0]], [1, [301.1943105023982, 1.0]], [1, [314.2710703187004, 1.0]], [1, [86.59574990281025, 1.0]], [1, [9.252456154200708, 1.0]], [1, [26.95855113088514, 1.0]], [1, [0.8369936816961561, 1.0]], [1, [3.3572513598978184, 1.0]], [1, [0.23635432314297916, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.54351054]
bas 1, expnt(s) = [7617.81317255]
bas 2, expnt(s) = [3617.31981769]
bas 3, expnt(s) = [1604.43388718]
bas 4, expnt(s) = [371.15450532]
bas 5, expnt(s) = [104.6365714]
bas 6, expnt(s) = [34.00682267]
bas 7, expnt(s) = [4.58094701]
bas 8, expnt(s) = [0.39471735]
bas 9, expnt(s) = [1362.76338113]
bas 10, expnt(s) = [664.79344664]
bas 11, expnt(s) = [301.1943105]
bas 12, expnt(s) = [314.27107032]
bas 13, expnt(s) = [86.5957499]
bas 14, expnt(s) = [9.25245615]
bas 15, expnt(s) = [26.95855113]
bas 16, expnt(s) = [0.83699368]
bas 17, expnt(s) = [3.35725136]
bas 18, expnt(s) = [0.23635432]
CPU time:       720.56
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825435e+04 5.20024613e+03 7.61781317e+03 2.06009744e+03
 3.61731982e+03 1.17843384e+03 1.60443389e+03 6.40481211e+02
 3.71154505e+02 2.13639266e+02 1.04636571e+02 8.26566215e+01
 3.40068227e+01 3.55786583e+01 4.58094701e+00 7.91100165e+00
 3.94717351e-01 1.25814208e+00 1.36276338e+03 2.41551624e+04
 6.64793447e+02 9.84788128e+03 3.01194311e+02 3.66052053e+03
 3.14271070e+02 3.86024526e+03 8.65957499e+01 7.70646330e+02
 9.25245615e+00 4.70766648e+01 2.69585511e+01 1.79207044e+02
 8.36993682e-01 2.33553896e+00 3.35725136e+00 1.32575788e+01
 2.36354323e-01 4.80771628e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.974263762449322
cond(S) = 154618.44460808788
E1 = -728.8757537719672  E_coul = 203.11660223938514
init E= -525.759151532582
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558890238078214  LUMO = 1.1410671626445
  mo_energy =
[-1.18318571e+02 -1.21041740e+01 -9.44872285e+00 -9.44872285e+00
 -9.44872285e+00 -1.23033621e+00 -5.58890238e-01 -5.58890238e-01
 -5.58890238e-01  1.14106716e+00  1.14106716e+00  1.14106716e+00
  9.22964159e+00  9.22964159e+00  9.22964159e+00  4.50985532e+01
  4.50985532e+01  4.50985532e+01  7.19848732e+01  1.78312359e+02
  1.78312359e+02  1.78312359e+02  5.39546253e+02  5.79621587e+02
  5.79621587e+02  5.79621587e+02  1.44826887e+03  1.44826887e+03
  1.44826887e+03  2.58871999e+03  3.14573302e+03  3.14573302e+03
  3.14573302e+03  6.76097621e+03  6.76097621e+03  6.76097621e+03
  8.99681104e+03  2.53606112e+04  7.61098061e+04]
E1 = -728.0854016024616  E_coul = 201.61738449134884
cycle= 1 E= -526.468017111113  delta_E= -0.709  |g|= 0.185  |ddm|= 0.481
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.55033
diis-c [-0.30286266  1.        ]
  HOMO = -0.572909263313707  LUMO = 1.13126685326374
  mo_energy =
[-1.18594078e+02 -1.22019356e+01 -9.55307773e+00 -9.55307773e+00
 -9.55307773e+00 -1.25157024e+00 -5.72909263e-01 -5.72909263e-01
 -5.72909263e-01  1.13126685e+00  1.13126685e+00  1.13126685e+00
  9.16449273e+00  9.16449273e+00  9.16449273e+00  4.49665442e+01
  4.49665442e+01  4.49665442e+01  7.18217017e+01  1.78104415e+02
  1.78104415e+02  1.78104415e+02  5.39237722e+02  5.79348541e+02
  5.79348541e+02  5.79348541e+02  1.44794082e+03  1.44794082e+03
  1.44794082e+03  2.58825441e+03  3.14533823e+03  3.14533823e+03
  3.14533823e+03  6.76046579e+03  6.76046579e+03  6.76046579e+03
  8.99622254e+03  2.53599279e+04  7.61090321e+04]
E1 = -728.3822372734479  E_coul = 201.9138416008563
cycle= 2 E= -526.468395672592  delta_E= -0.000379  |g|= 0.0245  |ddm|= 0.0207
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0472751
diis-c [-0.00143709  0.04893082  0.95106918]
  HOMO = -0.569239282299214  LUMO = 1.13445953533311
  mo_energy =
[-1.18551328e+02 -1.21816437e+01 -9.53238213e+00 -9.53238213e+00
 -9.53238213e+00 -1.24670371e+00 -5.69239282e-01 -5.69239282e-01
 -5.69239282e-01  1.13445954e+00  1.13445954e+00  1.13445954e+00
  9.17744771e+00  9.17744771e+00  9.17744771e+00  4.49911317e+01
  4.49911317e+01  4.49911317e+01  7.18553761e+01  1.78140389e+02
  1.78140389e+02  1.78140389e+02  5.39281804e+02  5.79390942e+02
  5.79390942e+02  5.79390942e+02  1.44798601e+03  1.44798601e+03
  1.44798601e+03  2.58830193e+03  3.14538504e+03  3.14538504e+03
  3.14538504e+03  6.76051363e+03  6.76051363e+03  6.76051363e+03
  8.99627081e+03  2.53599764e+04  7.61090806e+04]
E1 = -728.3213586966262  E_coul = 201.8529498956792
cycle= 3 E= -526.468408800947  delta_E= -1.31e-05  |g|= 0.00298  |ddm|= 0.00521
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00641082
diis-c [-3.62699665e-07 -1.09198982e-03  1.12607613e-01  8.88484377e-01]
  HOMO = -0.569892158856599  LUMO = 1.13391143779013
  mo_energy =
[-1.18556557e+02 -1.21844632e+01 -9.53530826e+00 -9.53530826e+00
 -9.53530826e+00 -1.24755151e+00 -5.69892159e-01 -5.69892159e-01
 -5.69892159e-01  1.13391144e+00  1.13391144e+00  1.13391144e+00
  9.17546440e+00  9.17546440e+00  9.17546440e+00  4.49878088e+01
  4.49878088e+01  4.49878088e+01  7.18512297e+01  1.78135881e+02
  1.78135881e+02  1.78135881e+02  5.39276412e+02  5.79385758e+02
  5.79385758e+02  5.79385758e+02  1.44798049e+03  1.44798049e+03
  1.44798049e+03  2.58829599e+03  3.14537927e+03  3.14537927e+03
  3.14537927e+03  6.76050761e+03  6.76050761e+03  6.76050761e+03
  8.99626465e+03  2.53599701e+04  7.61090742e+04]
E1 = -728.32958740823  E_coul = 201.86117831900089
cycle= 4 E= -526.468409089229  delta_E= -2.88e-07  |g|= 4.14e-05  |ddm|= 0.000764
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.29462e-05
diis-c [-1.72748279e-09  8.63045459e-06 -1.86998815e-03 -9.20235059e-03
  1.01106371e+00]
  HOMO = -0.569865496493573  LUMO = 1.13393312681431
  mo_energy =
[-1.18556466e+02 -1.21843775e+01 -9.53522374e+00 -9.53522374e+00
 -9.53522374e+00 -1.24751689e+00 -5.69865496e-01 -5.69865496e-01
 -5.69865496e-01  1.13393313e+00  1.13393313e+00  1.13393313e+00
  9.17553072e+00  9.17553072e+00  9.17553072e+00  4.49878933e+01
  4.49878933e+01  4.49878933e+01  7.18513242e+01  1.78135972e+02
  1.78135972e+02  1.78135972e+02  5.39276500e+02  5.79385849e+02
  5.79385849e+02  5.79385849e+02  1.44798058e+03  1.44798058e+03
  1.44798058e+03  2.58829607e+03  3.14537936e+03  3.14537936e+03
  3.14537936e+03  6.76050769e+03  6.76050769e+03  6.76050769e+03
  8.99626473e+03  2.53599702e+04  7.61090743e+04]
E1 = -728.3293888546091  E_coul = 201.86097976525141
cycle= 5 E= -526.468409089358  delta_E= -1.28e-10  |g|= 7.3e-06  |ddm|= 2.31e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3293888546091  E_coul = 201.86097976525141
  HOMO = -0.569869222849798  LUMO = 1.13393007743331
  mo_energy =
[-1.18556484e+02 -1.21843905e+01 -9.53523703e+00 -9.53523703e+00
 -9.53523703e+00 -1.24752172e+00 -5.69869223e-01 -5.69869223e-01
 -5.69869223e-01  1.13393008e+00  1.13393008e+00  1.13393008e+00
  9.17552084e+00  9.17552084e+00  9.17552084e+00  4.49878794e+01
  4.49878794e+01  4.49878794e+01  7.18513083e+01  1.78135955e+02
  1.78135955e+02  1.78135955e+02  5.39276482e+02  5.79385831e+02
  5.79385831e+02  5.79385831e+02  1.44798056e+03  1.44798056e+03
  1.44798056e+03  2.58829605e+03  3.14537934e+03  3.14537934e+03
  3.14537934e+03  6.76050767e+03  6.76050767e+03  6.76050767e+03
  8.99626471e+03  2.53599701e+04  7.61090743e+04]
E1 = -728.3294227394337  E_coul = 201.8610136500742
Extra cycle  E= -526.46840908936  delta_E= -1.82e-12  |g|= 1.85e-06  |ddm|= 3.63e-06
    CPU time for scf_cycle      0.69 sec, wall time      0.30 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 154618.44460808788
E1 = -728.3294227394337  E_coul = 201.8610136500742
init E= -526.46840908936
    CPU time for initialize scf      2.73 sec, wall time      0.25 sec
  HOMO = -0.569868589758521  LUMO = 1.13393060322943
  mo_energy =
[-1.18556480e+02 -1.21843880e+01 -9.53523448e+00 -9.53523448e+00
 -9.53523448e+00 -1.24752090e+00 -5.69868590e-01 -5.69868590e-01
 -5.69868590e-01  1.13393060e+00  1.13393060e+00  1.13393060e+00
  9.17552265e+00  9.17552265e+00  9.17552265e+00  4.49878822e+01
  4.49878822e+01  4.49878822e+01  7.18513117e+01  1.78135959e+02
  1.78135959e+02  1.78135959e+02  5.39276486e+02  5.79385835e+02
  5.79385835e+02  5.79385835e+02  1.44798057e+03  1.44798057e+03
  1.44798057e+03  2.58829605e+03  3.14537934e+03  3.14537934e+03
  3.14537934e+03  6.76050767e+03  6.76050767e+03  6.76050767e+03
  8.99626471e+03  2.53599701e+04  7.61090743e+04]
E1 = -728.3294158878045  E_coul = 201.86100679844455
cycle= 1 E= -526.46840908936  delta_E= -4.55e-13  |g|= 4.09e-07  |ddm|= 6.74e-07
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
E1 = -728.3294158878045  E_coul = 201.86100679844455
  HOMO = -0.569868709925325  LUMO = 1.13393050280121
  mo_energy =
[-1.18556480e+02 -1.21843885e+01 -9.53523499e+00 -9.53523499e+00
 -9.53523499e+00 -1.24752105e+00 -5.69868710e-01 -5.69868710e-01
 -5.69868710e-01  1.13393050e+00  1.13393050e+00  1.13393050e+00
  9.17552229e+00  9.17552229e+00  9.17552229e+00  4.49878816e+01
  4.49878816e+01  4.49878816e+01  7.18513110e+01  1.78135958e+02
  1.78135958e+02  1.78135958e+02  5.39276485e+02  5.79385834e+02
  5.79385834e+02  5.79385834e+02  1.44798057e+03  1.44798057e+03
  1.44798057e+03  2.58829605e+03  3.14537934e+03  3.14537934e+03
  3.14537934e+03  6.76050767e+03  6.76050767e+03  6.76050767e+03
  8.99626471e+03  2.53599701e+04  7.61090743e+04]
E1 = -728.3294172962345  E_coul = 201.86100820687483
Extra cycle  E= -526.46840908936  delta_E= 2.27e-13  |g|= 8.68e-08  |ddm|= 1.35e-07
    CPU time for scf_cycle      2.88 sec, wall time      0.40 sec
exp = [2.61825435e+04 7.61781317e+03 3.61731982e+03 1.60443389e+03
 3.71154505e+02 1.04636571e+02 3.40068227e+01 4.58094701e+00
 3.94717351e-01 1.36276338e+03 6.64793447e+02 3.01194311e+02
 3.14271070e+02 8.65957499e+01 9.25245615e+00 2.69585511e+01
 8.36993682e-01 3.35725136e+00 2.36354323e-01]
grad_E = [-1.57053952e-06  3.99917381e-06 -7.77315420e-07  8.98277899e-05
 -1.27734782e-04  1.56360070e-05 -1.95796459e-04  5.52020557e-04
 -8.11209442e-04 -2.76717597e-07  1.07857540e-08 -5.12153439e-08
  3.71399646e-07  4.11084188e-04  7.63544342e-04 -2.35215847e-06
  4.64485404e-03 -1.86718435e-03 -4.47421238e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:45:13 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5439973        1
[INPUT] 0    0    [1    /1   ]  7617.8144541         1
[INPUT] 0    0    [1    /1   ]  3617.32691286        1
[INPUT] 0    0    [1    /1   ]  1604.4917201         1
[INPUT] 0    0    [1    /1   ]  370.234338441        1
[INPUT] 0    0    [1    /1   ]  104.379273853        1
[INPUT] 0    0    [1    /1   ]  33.9403055393        1
[INPUT] 0    0    [1    /1   ]  4.58112855469        1
[INPUT] 0    0    [1    /1   ]  0.394612214228       1
[INPUT] 1    0    [1    /1   ]  1362.76372356        1
[INPUT] 1    0    [1    /1   ]  664.796240137        1
[INPUT] 1    0    [1    /1   ]  301.209683195        1
[INPUT] 1    0    [1    /1   ]  314.284428433        1
[INPUT] 1    0    [1    /1   ]  86.1183588193        1
[INPUT] 1    0    [1    /1   ]  9.22615466234        1
[INPUT] 1    0    [1    /1   ]  26.8562908097        1
[INPUT] 1    0    [1    /1   ]  0.838787261286       1
[INPUT] 1    0    [1    /1   ]  3.34838478428        1
[INPUT] 1    0    [1    /1   ]  0.23667397272        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.54399726904, 1.0]], [0, [7617.8144541037, 1.0]], [0, [3617.326912861058, 1.0]], [0, [1604.4917200972982, 1.0]], [0, [370.23433844149235, 1.0]], [0, [104.37927385278918, 1.0]], [0, [33.94030553930464, 1.0]], [0, [4.581128554688736, 1.0]], [0, [0.39461221422803355, 1.0]], [1, [1362.7637235570596, 1.0]], [1, [664.7962401371013, 1.0]], [1, [301.2096831954726, 1.0]], [1, [314.28442843254646, 1.0]], [1, [86.11835881934165, 1.0]], [1, [9.226154662342543, 1.0]], [1, [26.8562908097269, 1.0]], [1, [0.8387872612864993, 1.0]], [1, [3.3483847842802894, 1.0]], [1, [0.23667397272019502, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.54399727]
bas 1, expnt(s) = [7617.8144541]
bas 2, expnt(s) = [3617.32691286]
bas 3, expnt(s) = [1604.4917201]
bas 4, expnt(s) = [370.23433844]
bas 5, expnt(s) = [104.37927385]
bas 6, expnt(s) = [33.94030554]
bas 7, expnt(s) = [4.58112855]
bas 8, expnt(s) = [0.39461221]
bas 9, expnt(s) = [1362.76372356]
bas 10, expnt(s) = [664.79624014]
bas 11, expnt(s) = [301.2096832]
bas 12, expnt(s) = [314.28442843]
bas 13, expnt(s) = [86.11835882]
bas 14, expnt(s) = [9.22615466]
bas 15, expnt(s) = [26.85629081]
bas 16, expnt(s) = [0.83878726]
bas 17, expnt(s) = [3.34838478]
bas 18, expnt(s) = [0.23667397]
CPU time:       728.97
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825440e+04 5.20024620e+03 7.61781445e+03 2.06009770e+03
 3.61732691e+03 1.17843557e+03 1.60449172e+03 6.40498526e+02
 3.70234338e+02 2.13241901e+02 1.04379274e+02 8.25041373e+01
 3.39403055e+01 3.55264518e+01 4.58112855e+00 7.91123679e+00
 3.94612214e-01 1.25789073e+00 1.36276372e+03 2.41551700e+04
 6.64796240e+02 9.84793301e+03 3.01209683e+02 3.66075407e+03
 3.14284428e+02 3.86045036e+03 8.61183588e+01 7.65339403e+02
 9.22615466e+00 4.69094462e+01 2.68562908e+01 1.78357728e+02
 8.38787261e-01 2.34179662e+00 3.34838478e+00 1.32138263e+01
 2.36673973e-01 4.81584520e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97421649287468
cond(S) = 153427.34014344728
E1 = -728.8767346285614  E_coul = 203.11608114432903
init E= -525.760653484232
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558928169140956  LUMO = 1.14386031855696
  mo_energy =
[-1.18318518e+02 -1.21041812e+01 -9.44878361e+00 -9.44878361e+00
 -9.44878361e+00 -1.23037293e+00 -5.58928169e-01 -5.58928169e-01
 -5.58928169e-01  1.14386032e+00  1.14386032e+00  1.14386032e+00
  9.21163083e+00  9.21163083e+00  9.21163083e+00  4.49311607e+01
  4.49311607e+01  4.49311607e+01  7.17576643e+01  1.77525949e+02
  1.77525949e+02  1.77525949e+02  5.38005644e+02  5.78011741e+02
  5.78011741e+02  5.78011741e+02  1.44630556e+03  1.44630556e+03
  1.44630556e+03  2.58510602e+03  3.14370826e+03  3.14370826e+03
  3.14370826e+03  6.75905929e+03  6.75905929e+03  6.75905929e+03
  8.99255397e+03  2.53563632e+04  7.61057957e+04]
E1 = -728.0862772267088  E_coul = 201.61821076450266
cycle= 1 E= -526.468066462206  delta_E= -0.707  |g|= 0.185  |ddm|= 0.468
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.550393
diis-c [-0.30293298  1.        ]
  HOMO = -0.572936137983425  LUMO = 1.13403704306458
  mo_energy =
[-1.18593855e+02 -1.22018361e+01 -9.55302855e+00 -9.55302855e+00
 -9.55302855e+00 -1.25157092e+00 -5.72936138e-01 -5.72936138e-01
 -5.72936138e-01  1.13403704e+00  1.13403704e+00  1.13403704e+00
  9.14668144e+00  9.14668144e+00  9.14668144e+00  4.47995194e+01
  4.47995194e+01  4.47995194e+01  7.15947879e+01  1.77318413e+02
  1.77318413e+02  1.77318413e+02  5.37697473e+02  5.77738882e+02
  5.77738882e+02  5.77738882e+02  1.44597760e+03  1.44597760e+03
  1.44597760e+03  2.58464058e+03  3.14331355e+03  3.14331355e+03
  3.14331355e+03  6.75854891e+03  6.75854891e+03  6.75854891e+03
  8.99196548e+03  2.53556799e+04  7.61050217e+04]
E1 = -728.3829700502286  E_coul = 201.9145252581987
cycle= 2 E= -526.46844479203  delta_E= -0.000378  |g|= 0.0245  |ddm|= 0.0206
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0473072
diis-c [-0.00143904  0.04895723  0.95104277]
  HOMO = -0.569273188600056  LUMO = 1.1372307024415
  mo_energy =
[-1.18551111e+02 -1.21815532e+01 -9.53234177e+00 -9.53234177e+00
 -9.53234177e+00 -1.24671321e+00 -5.69273189e-01 -5.69273189e-01
 -5.69273189e-01  1.13723070e+00  1.13723070e+00  1.13723070e+00
  9.15959870e+00  9.15959870e+00  9.15959870e+00  4.48240547e+01
  4.48240547e+01  4.48240547e+01  7.16284243e+01  1.77354345e+02
  1.77354345e+02  1.77354345e+02  5.37741536e+02  5.77781271e+02
  5.77781271e+02  5.77781271e+02  1.44602279e+03  1.44602279e+03
  1.44602279e+03  2.58468809e+03  3.14336035e+03  3.14336035e+03
  3.14336035e+03  6.75859675e+03  6.75859675e+03  6.75859675e+03
  8.99201375e+03  2.53557284e+04  7.61050702e+04]
E1 = -728.3220803980478  E_coul = 201.8536224716775
cycle= 3 E= -526.46845792637  delta_E= -1.31e-05  |g|= 0.00299  |ddm|= 0.00521
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00641818
diis-c [-3.63865633e-07 -1.09261855e-03  1.12657048e-01  8.88435571e-01]
  HOMO = -0.569925968317159  LUMO = 1.13668151637061
  mo_energy =
[-1.18556342e+02 -1.21843731e+01 -9.53526840e+00 -9.53526840e+00
 -9.53526840e+00 -1.24756073e+00 -5.69925968e-01 -5.69925968e-01
 -5.69925968e-01  1.13668152e+00  1.13668152e+00  1.13668152e+00
  9.15761851e+00  9.15761851e+00  9.15761851e+00  4.48207356e+01
  4.48207356e+01  4.48207356e+01  7.16242798e+01  1.77349839e+02
  1.77349839e+02  1.77349839e+02  5.37736144e+02  5.77776086e+02
  5.77776086e+02  5.77776086e+02  1.44601727e+03  1.44601727e+03
  1.44601727e+03  2.58468215e+03  3.14335458e+03  3.14335458e+03
  3.14335458e+03  6.75859073e+03  6.75859073e+03  6.75859073e+03
  8.99200759e+03  2.53557221e+04  7.61050638e+04]
E1 = -728.3303143125506  E_coul = 201.86185609747136
cycle= 4 E= -526.468458215079  delta_E= -2.89e-07  |g|= 4.14e-05  |ddm|= 0.000764
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.29897e-05
diis-c [-1.73173445e-09  8.47056411e-06 -1.85398031e-03 -9.07225954e-03
  1.01091777e+00]
  HOMO = -0.569899309409534  LUMO = 1.13670324529103
  mo_energy =
[-1.18556251e+02 -1.21842873e+01 -9.53518379e+00 -9.53518379e+00
 -9.53518379e+00 -1.24752610e+00 -5.69899309e-01 -5.69899309e-01
 -5.69899309e-01  1.13670325e+00  1.13670325e+00  1.13670325e+00
  9.15768480e+00  9.15768480e+00  9.15768480e+00  4.48208202e+01
  4.48208202e+01  4.48208202e+01  7.16243744e+01  1.77349930e+02
  1.77349930e+02  1.77349930e+02  5.37736232e+02  5.77776176e+02
  5.77776176e+02  5.77776176e+02  1.44601736e+03  1.44601736e+03
  1.44601736e+03  2.58468223e+03  3.14335467e+03  3.14335467e+03
  3.14335467e+03  6.75859081e+03  6.75859081e+03  6.75859081e+03
  8.99200766e+03  2.53557222e+04  7.61050639e+04]
E1 = -728.3301154375539  E_coul = 201.8616572223455
cycle= 5 E= -526.468458215208  delta_E= -1.29e-10  |g|= 7.31e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3301154375539  E_coul = 201.8616572223455
  HOMO = -0.569903037797615  LUMO = 1.13670018783535
  mo_energy =
[-1.18556269e+02 -1.21843004e+01 -9.53519709e+00 -9.53519709e+00
 -9.53519709e+00 -1.24753093e+00 -5.69903038e-01 -5.69903038e-01
 -5.69903038e-01  1.13670019e+00  1.13670019e+00  1.13670019e+00
  9.15767492e+00  9.15767492e+00  9.15767492e+00  4.48208062e+01
  4.48208062e+01  4.48208062e+01  7.16243584e+01  1.77349913e+02
  1.77349913e+02  1.77349913e+02  5.37736214e+02  5.77776159e+02
  5.77776159e+02  5.77776159e+02  1.44601734e+03  1.44601734e+03
  1.44601734e+03  2.58468221e+03  3.14335465e+03  3.14335465e+03
  3.14335465e+03  6.75859079e+03  6.75859079e+03  6.75859079e+03
  8.99200765e+03  2.53557221e+04  7.61050639e+04]
E1 = -728.3301493745236  E_coul = 201.861691159313
Extra cycle  E= -526.468458215211  delta_E= -2.27e-12  |g|= 1.85e-06  |ddm|= 3.63e-06
    CPU time for scf_cycle      0.68 sec, wall time      0.30 sec
exp = [2.61825440e+04 7.61781445e+03 3.61732691e+03 1.60449172e+03
 3.70234338e+02 1.04379274e+02 3.39403055e+01 4.58112855e+00
 3.94612214e-01 1.36276372e+03 6.64796240e+02 3.01209683e+02
 3.14284428e+02 8.61183588e+01 9.22615466e+00 2.68562908e+01
 8.38787261e-01 3.34838478e+00 2.36673973e-01]
E = -526.4684582152106
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:45:14 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5439973        1
[INPUT] 0    0    [1    /1   ]  7617.8144541         1
[INPUT] 0    0    [1    /1   ]  3617.32691286        1
[INPUT] 0    0    [1    /1   ]  1604.4917201         1
[INPUT] 0    0    [1    /1   ]  370.234338441        1
[INPUT] 0    0    [1    /1   ]  104.379273853        1
[INPUT] 0    0    [1    /1   ]  33.9403055393        1
[INPUT] 0    0    [1    /1   ]  4.58112855469        1
[INPUT] 0    0    [1    /1   ]  0.394612214228       1
[INPUT] 1    0    [1    /1   ]  1362.76372356        1
[INPUT] 1    0    [1    /1   ]  664.796240137        1
[INPUT] 1    0    [1    /1   ]  301.209683195        1
[INPUT] 1    0    [1    /1   ]  314.284428433        1
[INPUT] 1    0    [1    /1   ]  86.1183588193        1
[INPUT] 1    0    [1    /1   ]  9.22615466234        1
[INPUT] 1    0    [1    /1   ]  26.8562908097        1
[INPUT] 1    0    [1    /1   ]  0.838787261286       1
[INPUT] 1    0    [1    /1   ]  3.34838478428        1
[INPUT] 1    0    [1    /1   ]  0.23667397272        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.54399726904, 1.0]], [0, [7617.8144541037, 1.0]], [0, [3617.326912861058, 1.0]], [0, [1604.4917200972982, 1.0]], [0, [370.23433844149235, 1.0]], [0, [104.37927385278918, 1.0]], [0, [33.94030553930464, 1.0]], [0, [4.581128554688736, 1.0]], [0, [0.39461221422803355, 1.0]], [1, [1362.7637235570596, 1.0]], [1, [664.7962401371013, 1.0]], [1, [301.2096831954726, 1.0]], [1, [314.28442843254646, 1.0]], [1, [86.11835881934165, 1.0]], [1, [9.226154662342543, 1.0]], [1, [26.8562908097269, 1.0]], [1, [0.8387872612864993, 1.0]], [1, [3.3483847842802894, 1.0]], [1, [0.23667397272019502, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.54399727]
bas 1, expnt(s) = [7617.8144541]
bas 2, expnt(s) = [3617.32691286]
bas 3, expnt(s) = [1604.4917201]
bas 4, expnt(s) = [370.23433844]
bas 5, expnt(s) = [104.37927385]
bas 6, expnt(s) = [33.94030554]
bas 7, expnt(s) = [4.58112855]
bas 8, expnt(s) = [0.39461221]
bas 9, expnt(s) = [1362.76372356]
bas 10, expnt(s) = [664.79624014]
bas 11, expnt(s) = [301.2096832]
bas 12, expnt(s) = [314.28442843]
bas 13, expnt(s) = [86.11835882]
bas 14, expnt(s) = [9.22615466]
bas 15, expnt(s) = [26.85629081]
bas 16, expnt(s) = [0.83878726]
bas 17, expnt(s) = [3.34838478]
bas 18, expnt(s) = [0.23667397]
CPU time:       729.95
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825440e+04 5.20024620e+03 7.61781445e+03 2.06009770e+03
 3.61732691e+03 1.17843557e+03 1.60449172e+03 6.40498526e+02
 3.70234338e+02 2.13241901e+02 1.04379274e+02 8.25041373e+01
 3.39403055e+01 3.55264518e+01 4.58112855e+00 7.91123679e+00
 3.94612214e-01 1.25789073e+00 1.36276372e+03 2.41551700e+04
 6.64796240e+02 9.84793301e+03 3.01209683e+02 3.66075407e+03
 3.14284428e+02 3.86045036e+03 8.61183588e+01 7.65339403e+02
 9.22615466e+00 4.69094462e+01 2.68562908e+01 1.78357728e+02
 8.38787261e-01 2.34179662e+00 3.34838478e+00 1.32138263e+01
 2.36673973e-01 4.81584520e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97421649287468
cond(S) = 153427.34014344728
E1 = -728.8767346285614  E_coul = 203.11608114432903
init E= -525.760653484232
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.558928169140956  LUMO = 1.14386031855696
  mo_energy =
[-1.18318518e+02 -1.21041812e+01 -9.44878361e+00 -9.44878361e+00
 -9.44878361e+00 -1.23037293e+00 -5.58928169e-01 -5.58928169e-01
 -5.58928169e-01  1.14386032e+00  1.14386032e+00  1.14386032e+00
  9.21163083e+00  9.21163083e+00  9.21163083e+00  4.49311607e+01
  4.49311607e+01  4.49311607e+01  7.17576643e+01  1.77525949e+02
  1.77525949e+02  1.77525949e+02  5.38005644e+02  5.78011741e+02
  5.78011741e+02  5.78011741e+02  1.44630556e+03  1.44630556e+03
  1.44630556e+03  2.58510602e+03  3.14370826e+03  3.14370826e+03
  3.14370826e+03  6.75905929e+03  6.75905929e+03  6.75905929e+03
  8.99255397e+03  2.53563632e+04  7.61057957e+04]
E1 = -728.0862772267088  E_coul = 201.61821076450266
cycle= 1 E= -526.468066462206  delta_E= -0.707  |g|= 0.185  |ddm|= 0.468
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.550393
diis-c [-0.30293298  1.        ]
  HOMO = -0.572936137983425  LUMO = 1.13403704306458
  mo_energy =
[-1.18593855e+02 -1.22018361e+01 -9.55302855e+00 -9.55302855e+00
 -9.55302855e+00 -1.25157092e+00 -5.72936138e-01 -5.72936138e-01
 -5.72936138e-01  1.13403704e+00  1.13403704e+00  1.13403704e+00
  9.14668144e+00  9.14668144e+00  9.14668144e+00  4.47995194e+01
  4.47995194e+01  4.47995194e+01  7.15947879e+01  1.77318413e+02
  1.77318413e+02  1.77318413e+02  5.37697473e+02  5.77738882e+02
  5.77738882e+02  5.77738882e+02  1.44597760e+03  1.44597760e+03
  1.44597760e+03  2.58464058e+03  3.14331355e+03  3.14331355e+03
  3.14331355e+03  6.75854891e+03  6.75854891e+03  6.75854891e+03
  8.99196548e+03  2.53556799e+04  7.61050217e+04]
E1 = -728.3829700502286  E_coul = 201.9145252581987
cycle= 2 E= -526.46844479203  delta_E= -0.000378  |g|= 0.0245  |ddm|= 0.0206
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0473072
diis-c [-0.00143904  0.04895723  0.95104277]
  HOMO = -0.569273188600056  LUMO = 1.1372307024415
  mo_energy =
[-1.18551111e+02 -1.21815532e+01 -9.53234177e+00 -9.53234177e+00
 -9.53234177e+00 -1.24671321e+00 -5.69273189e-01 -5.69273189e-01
 -5.69273189e-01  1.13723070e+00  1.13723070e+00  1.13723070e+00
  9.15959870e+00  9.15959870e+00  9.15959870e+00  4.48240547e+01
  4.48240547e+01  4.48240547e+01  7.16284243e+01  1.77354345e+02
  1.77354345e+02  1.77354345e+02  5.37741536e+02  5.77781271e+02
  5.77781271e+02  5.77781271e+02  1.44602279e+03  1.44602279e+03
  1.44602279e+03  2.58468809e+03  3.14336035e+03  3.14336035e+03
  3.14336035e+03  6.75859675e+03  6.75859675e+03  6.75859675e+03
  8.99201375e+03  2.53557284e+04  7.61050702e+04]
E1 = -728.3220803980478  E_coul = 201.8536224716775
cycle= 3 E= -526.46845792637  delta_E= -1.31e-05  |g|= 0.00299  |ddm|= 0.00521
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00641818
diis-c [-3.63865633e-07 -1.09261855e-03  1.12657048e-01  8.88435571e-01]
  HOMO = -0.569925968317159  LUMO = 1.13668151637061
  mo_energy =
[-1.18556342e+02 -1.21843731e+01 -9.53526840e+00 -9.53526840e+00
 -9.53526840e+00 -1.24756073e+00 -5.69925968e-01 -5.69925968e-01
 -5.69925968e-01  1.13668152e+00  1.13668152e+00  1.13668152e+00
  9.15761851e+00  9.15761851e+00  9.15761851e+00  4.48207356e+01
  4.48207356e+01  4.48207356e+01  7.16242798e+01  1.77349839e+02
  1.77349839e+02  1.77349839e+02  5.37736144e+02  5.77776086e+02
  5.77776086e+02  5.77776086e+02  1.44601727e+03  1.44601727e+03
  1.44601727e+03  2.58468215e+03  3.14335458e+03  3.14335458e+03
  3.14335458e+03  6.75859073e+03  6.75859073e+03  6.75859073e+03
  8.99200759e+03  2.53557221e+04  7.61050638e+04]
E1 = -728.3303143125506  E_coul = 201.86185609747136
cycle= 4 E= -526.468458215079  delta_E= -2.89e-07  |g|= 4.14e-05  |ddm|= 0.000764
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.29897e-05
diis-c [-1.73173445e-09  8.47056411e-06 -1.85398031e-03 -9.07225954e-03
  1.01091777e+00]
  HOMO = -0.569899309409534  LUMO = 1.13670324529103
  mo_energy =
[-1.18556251e+02 -1.21842873e+01 -9.53518379e+00 -9.53518379e+00
 -9.53518379e+00 -1.24752610e+00 -5.69899309e-01 -5.69899309e-01
 -5.69899309e-01  1.13670325e+00  1.13670325e+00  1.13670325e+00
  9.15768480e+00  9.15768480e+00  9.15768480e+00  4.48208202e+01
  4.48208202e+01  4.48208202e+01  7.16243744e+01  1.77349930e+02
  1.77349930e+02  1.77349930e+02  5.37736232e+02  5.77776176e+02
  5.77776176e+02  5.77776176e+02  1.44601736e+03  1.44601736e+03
  1.44601736e+03  2.58468223e+03  3.14335467e+03  3.14335467e+03
  3.14335467e+03  6.75859081e+03  6.75859081e+03  6.75859081e+03
  8.99200766e+03  2.53557222e+04  7.61050639e+04]
E1 = -728.3301154375539  E_coul = 201.8616572223455
cycle= 5 E= -526.468458215208  delta_E= -1.29e-10  |g|= 7.31e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3301154375539  E_coul = 201.8616572223455
  HOMO = -0.569903037797615  LUMO = 1.13670018783535
  mo_energy =
[-1.18556269e+02 -1.21843004e+01 -9.53519709e+00 -9.53519709e+00
 -9.53519709e+00 -1.24753093e+00 -5.69903038e-01 -5.69903038e-01
 -5.69903038e-01  1.13670019e+00  1.13670019e+00  1.13670019e+00
  9.15767492e+00  9.15767492e+00  9.15767492e+00  4.48208062e+01
  4.48208062e+01  4.48208062e+01  7.16243584e+01  1.77349913e+02
  1.77349913e+02  1.77349913e+02  5.37736214e+02  5.77776159e+02
  5.77776159e+02  5.77776159e+02  1.44601734e+03  1.44601734e+03
  1.44601734e+03  2.58468221e+03  3.14335465e+03  3.14335465e+03
  3.14335465e+03  6.75859079e+03  6.75859079e+03  6.75859079e+03
  8.99200765e+03  2.53557221e+04  7.61050639e+04]
E1 = -728.3301493745236  E_coul = 201.861691159313
Extra cycle  E= -526.468458215211  delta_E= -2.27e-12  |g|= 1.85e-06  |ddm|= 3.63e-06
    CPU time for scf_cycle      0.69 sec, wall time      0.30 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 153427.34014344728
E1 = -728.3301493745236  E_coul = 201.861691159313
init E= -526.468458215211
    CPU time for initialize scf      2.73 sec, wall time      0.25 sec
  HOMO = -0.569902404144909  LUMO = 1.13670071520221
  mo_energy =
[-1.18556265e+02 -1.21842979e+01 -9.53519454e+00 -9.53519454e+00
 -9.53519454e+00 -1.24753011e+00 -5.69902404e-01 -5.69902404e-01
 -5.69902404e-01  1.13670072e+00  1.13670072e+00  1.13670072e+00
  9.15767673e+00  9.15767673e+00  9.15767673e+00  4.48208090e+01
  4.48208090e+01  4.48208090e+01  7.16243618e+01  1.77349917e+02
  1.77349917e+02  1.77349917e+02  5.37736218e+02  5.77776163e+02
  5.77776163e+02  5.77776163e+02  1.44601734e+03  1.44601734e+03
  1.44601734e+03  2.58468221e+03  3.14335465e+03  3.14335465e+03
  3.14335465e+03  6.75859079e+03  6.75859079e+03  6.75859079e+03
  8.99200765e+03  2.53557221e+04  7.61050639e+04]
E1 = -728.3301425082094  E_coul = 201.86168429299883
cycle= 1 E= -526.468458215211  delta_E=    0  |g|= 4.1e-07  |ddm|= 6.75e-07
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
E1 = -728.3301425082094  E_coul = 201.86168429299883
  HOMO = -0.569902524503591  LUMO = 1.13670061440047
  mo_energy =
[-1.18556266e+02 -1.21842984e+01 -9.53519505e+00 -9.53519505e+00
 -9.53519505e+00 -1.24753027e+00 -5.69902525e-01 -5.69902525e-01
 -5.69902525e-01  1.13670061e+00  1.13670061e+00  1.13670061e+00
  9.15767637e+00  9.15767637e+00  9.15767637e+00  4.48208084e+01
  4.48208084e+01  4.48208084e+01  7.16243611e+01  1.77349916e+02
  1.77349916e+02  1.77349916e+02  5.37736217e+02  5.77776162e+02
  5.77776162e+02  5.77776162e+02  1.44601734e+03  1.44601734e+03
  1.44601734e+03  2.58468221e+03  3.14335465e+03  3.14335465e+03
  3.14335465e+03  6.75859079e+03  6.75859079e+03  6.75859079e+03
  8.99200765e+03  2.53557221e+04  7.61050639e+04]
E1 = -728.3301439204525  E_coul = 201.86168570524188
Extra cycle  E= -526.468458215211  delta_E=    0  |g|= 8.71e-08  |ddm|= 1.35e-07
    CPU time for scf_cycle      2.88 sec, wall time      0.40 sec
exp = [2.61825440e+04 7.61781445e+03 3.61732691e+03 1.60449172e+03
 3.70234338e+02 1.04379274e+02 3.39403055e+01 4.58112855e+00
 3.94612214e-01 1.36276372e+03 6.64796240e+02 3.01209683e+02
 3.14284428e+02 8.61183588e+01 9.22615466e+00 2.68562908e+01
 8.38787261e-01 3.34838478e+00 2.36673973e-01]
grad_E = [-1.57514260e-06  4.05801440e-06 -7.16581463e-07  9.17254142e-05
 -1.46263938e-04  5.86651745e-05 -3.11836404e-04  9.72690705e-04
 -2.22767205e-03 -2.90324141e-07  7.09314033e-09 -1.57006859e-07
  2.67133095e-07  4.14915572e-04  1.09215844e-03 -6.17109939e-05
  8.25660845e-03 -2.80502704e-03 -8.39961133e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:45:18 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5455394        1
[INPUT] 0    0    [1    /1   ]  7617.81473297        1
[INPUT] 0    0    [1    /1   ]  3617.33907245        1
[INPUT] 0    0    [1    /1   ]  1604.54644127        1
[INPUT] 0    0    [1    /1   ]  368.760557132        1
[INPUT] 0    0    [1    /1   ]  103.966559162        1
[INPUT] 0    0    [1    /1   ]  33.833413975         1
[INPUT] 0    0    [1    /1   ]  4.58141464408        1
[INPUT] 0    0    [1    /1   ]  0.394425410992       1
[INPUT] 1    0    [1    /1   ]  1362.76441911        1
[INPUT] 1    0    [1    /1   ]  664.800881466        1
[INPUT] 1    0    [1    /1   ]  301.235251348        1
[INPUT] 1    0    [1    /1   ]  314.30644911         1
[INPUT] 1    0    [1    /1   ]  85.1298966141        1
[INPUT] 1    0    [1    /1   ]  9.17195076639        1
[INPUT] 1    0    [1    /1   ]  26.6457120679        1
[INPUT] 1    0    [1    /1   ]  0.841565952715       1
[INPUT] 1    0    [1    /1   ]  3.33122031338        1
[INPUT] 1    0    [1    /1   ]  0.237164531792       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.54553938161, 1.0]], [0, [7617.8147329731055, 1.0]], [0, [3617.339072450368, 1.0]], [0, [1604.5464412741005, 1.0]], [0, [368.76055713244614, 1.0]], [0, [103.96655916163456, 1.0]], [0, [33.833413975033785, 1.0]], [0, [4.581414644082624, 1.0]], [0, [0.3944254109916935, 1.0]], [1, [1362.7644191126283, 1.0]], [1, [664.8008814661815, 1.0]], [1, [301.2352513477513, 1.0]], [1, [314.3064491098684, 1.0]], [1, [85.1298966141252, 1.0]], [1, [9.171950766387557, 1.0]], [1, [26.64571206786581, 1.0]], [1, [0.8415659527151527, 1.0]], [1, [3.3312203133845677, 1.0]], [1, [0.23716453179244334, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.54553938]
bas 1, expnt(s) = [7617.81473297]
bas 2, expnt(s) = [3617.33907245]
bas 3, expnt(s) = [1604.54644127]
bas 4, expnt(s) = [368.76055713]
bas 5, expnt(s) = [103.96655916]
bas 6, expnt(s) = [33.83341398]
bas 7, expnt(s) = [4.58141464]
bas 8, expnt(s) = [0.39442541]
bas 9, expnt(s) = [1362.76441911]
bas 10, expnt(s) = [664.80088147]
bas 11, expnt(s) = [301.23525135]
bas 12, expnt(s) = [314.30644911]
bas 13, expnt(s) = [85.12989661]
bas 14, expnt(s) = [9.17195077]
bas 15, expnt(s) = [26.64571207]
bas 16, expnt(s) = [0.84156595]
bas 17, expnt(s) = [3.33122031]
bas 18, expnt(s) = [0.23716453]
CPU time:       738.36
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825455e+04 5.20024643e+03 7.61781473e+03 2.06009776e+03
 3.61733907e+03 1.17843854e+03 1.60454644e+03 6.40514909e+02
 3.68760557e+02 2.12604950e+02 1.03966559e+02 8.22593508e+01
 3.38334140e+01 3.54425035e+01 4.58141464e+00 7.91160733e+00
 3.94425411e-01 1.25744411e+00 1.36276442e+03 2.41551854e+04
 6.64800881e+02 9.84801895e+03 3.01235251e+02 3.66114251e+03
 3.14306449e+02 3.86078847e+03 8.51298966e+01 7.54374544e+02
 9.17195077e+00 4.65652068e+01 2.66457121e+01 1.76611328e+02
 8.41565953e-01 2.35149786e+00 3.33122031e+00 1.31292098e+01
 2.37164532e-01 4.82832581e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.974147553062988
cond(S) = 150974.42383247733
E1 = -728.8779920742173  E_coul = 203.11493403249258
init E= -525.763058041725
    CPU time for initialize scf      0.45 sec, wall time      0.06 sec
  HOMO = -0.559000045776111  LUMO = 1.14812980111068
  mo_energy =
[-1.18318444e+02 -1.21042182e+01 -9.44891537e+00 -9.44891537e+00
 -9.44891537e+00 -1.23044006e+00 -5.59000046e-01 -5.59000046e-01
 -5.59000046e-01  1.14812980e+00  1.14812980e+00  1.14812980e+00
  9.17256824e+00  9.17256824e+00  9.17256824e+00  4.45873182e+01
  4.45873182e+01  4.45873182e+01  7.13933181e+01  1.75898320e+02
  1.75898320e+02  1.75898320e+02  5.35534404e+02  5.74669274e+02
  5.74669274e+02  5.74669274e+02  1.44222538e+03  1.44222538e+03
  1.44222538e+03  2.57928706e+03  3.13948971e+03  3.13948971e+03
  3.13948971e+03  6.75505505e+03  6.75505505e+03  6.75505505e+03
  8.98565221e+03  2.53494337e+04  7.60992327e+04]
E1 = -728.0875714789903  E_coul = 201.6193760760821
cycle= 1 E= -526.468195402908  delta_E= -0.705  |g|= 0.185  |ddm|= 0.447
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.550493
diis-c [-0.30304215  1.        ]
  HOMO = -0.572993080069545  LUMO = 1.13827198372226
  mo_energy =
[-1.18593483e+02 -1.22016874e+01 -9.55296928e+00 -9.55296928e+00
 -9.55296928e+00 -1.25158057e+00 -5.72993080e-01 -5.72993080e-01
 -5.72993080e-01  1.13827198e+00  1.13827198e+00  1.13827198e+00
  9.10800526e+00  9.10800526e+00  9.10800526e+00  4.44564042e+01
  4.44564042e+01  4.44564042e+01  7.12309367e+01  1.75691591e+02
  1.75691591e+02  1.75691591e+02  5.35226837e+02  5.74396768e+02
  5.74396768e+02  5.74396768e+02  1.44189758e+03  1.44189758e+03
  1.44189758e+03  2.57882188e+03  3.13909514e+03  3.13909514e+03
  3.13909514e+03  6.75454477e+03  6.75454477e+03  6.75454477e+03
  8.98506379e+03  2.53487504e+04  7.60984586e+04]
E1 = -728.3840298654832  E_coul = 201.91545650787026
cycle= 2 E= -526.468573357613  delta_E= -0.000378  |g|= 0.0245  |ddm|= 0.0205
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0473669
diis-c [-0.00144263  0.04900911  0.95099089]
  HOMO = -0.569341796287003  LUMO = 1.14146591555415
  mo_energy =
[-1.18550750e+02 -1.21814193e+01 -9.53229693e+00 -9.53229693e+00
 -9.53229693e+00 -1.24673754e+00 -5.69341796e-01 -5.69341796e-01
 -5.69341796e-01  1.14146592e+00  1.14146592e+00  1.14146592e+00
  9.12085045e+00  9.12085045e+00  9.12085045e+00  4.44808354e+01
  4.44808354e+01  4.44808354e+01  7.12645113e+01  1.75727436e+02
  1.75727436e+02  1.75727436e+02  5.35270871e+02  5.74439135e+02
  5.74439135e+02  5.74439135e+02  1.44194277e+03  1.44194277e+03
  1.44194277e+03  2.57886938e+03  3.13914194e+03  3.13914194e+03
  3.13914194e+03  6.75459259e+03  6.75459259e+03  6.75459259e+03
  8.98511205e+03  2.53487989e+04  7.60985071e+04]
E1 = -728.323120124701  E_coul = 201.85453362287925
cycle= 3 E= -526.468586501822  delta_E= -1.31e-05  |g|= 0.00299  |ddm|= 0.0052
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00643068
diis-c [-3.65924881e-07 -1.09361617e-03  1.12730769e-01  8.88362848e-01]
  HOMO = -0.569994459116876  LUMO = 1.14091510379153
  mo_energy =
[-1.18555983e+02 -1.21842398e+01 -9.53522434e+00 -9.53522434e+00
 -9.53522434e+00 -1.24758464e+00 -5.69994459e-01 -5.69994459e-01
 -5.69994459e-01  1.14091510e+00  1.14091510e+00  1.14091510e+00
  9.11887663e+00  9.11887663e+00  9.11887663e+00  4.44775246e+01
  4.44775246e+01  4.44775246e+01  7.12603699e+01  1.75722936e+02
  1.75722936e+02  1.75722936e+02  5.35265479e+02  5.74433948e+02
  5.74433948e+02  5.74433948e+02  1.44193724e+03  1.44193724e+03
  1.44193724e+03  2.57886343e+03  3.13913617e+03  3.13913617e+03
  3.13913617e+03  6.75458657e+03  6.75458657e+03  6.75458657e+03
  8.98510588e+03  2.53487926e+04  7.60985007e+04]
E1 = -728.3313628528075  E_coul = 201.862776061579
cycle= 4 E= -526.468586791229  delta_E= -2.89e-07  |g|= 4.15e-05  |ddm|= 0.000763
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.31155e-05
diis-c [-1.73973416e-09  8.19634857e-06 -1.82652261e-03 -8.83913673e-03
  1.01065746e+00]
  HOMO = -0.56996779838648  LUMO = 1.14093689728681
  mo_energy =
[-1.18555892e+02 -1.21841538e+01 -9.53513956e+00 -9.53513956e+00
 -9.53513956e+00 -1.24754999e+00 -5.69967798e-01 -5.69967798e-01
 -5.69967798e-01  1.14093690e+00  1.14093690e+00  1.14093690e+00
  9.11894287e+00  9.11894287e+00  9.11894287e+00  4.44776092e+01
  4.44776092e+01  4.44776092e+01  7.12604646e+01  1.75723027e+02
  1.75723027e+02  1.75723027e+02  5.35265567e+02  5.74434039e+02
  5.74434039e+02  5.74434039e+02  1.44193733e+03  1.44193733e+03
  1.44193733e+03  2.57886351e+03  3.13913625e+03  3.13913625e+03
  3.13913625e+03  6.75458665e+03  6.75458665e+03  6.75458665e+03
  8.98510596e+03  2.53487927e+04  7.60985008e+04]
E1 = -728.3311633539273  E_coul = 201.8625765625714
cycle= 5 E= -526.468586791356  delta_E= -1.27e-10  |g|= 7.34e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3311633539273  E_coul = 201.8625765625714
  HOMO = -0.56997153023025  LUMO = 1.14093382749487
  mo_energy =
[-1.18555910e+02 -1.21841669e+01 -9.53515288e+00 -9.53515288e+00
 -9.53515288e+00 -1.24755483e+00 -5.69971530e-01 -5.69971530e-01
 -5.69971530e-01  1.14093383e+00  1.14093383e+00  1.14093383e+00
  9.11893300e+00  9.11893300e+00  9.11893300e+00  4.44775952e+01
  4.44775952e+01  4.44775952e+01  7.12604487e+01  1.75723010e+02
  1.75723010e+02  1.75723010e+02  5.35265549e+02  5.74434021e+02
  5.74434021e+02  5.74434021e+02  1.44193731e+03  1.44193731e+03
  1.44193731e+03  2.57886349e+03  3.13913623e+03  3.13913623e+03
  3.13913623e+03  6.75458663e+03  6.75458663e+03  6.75458663e+03
  8.98510594e+03  2.53487926e+04  7.60985008e+04]
E1 = -728.3311973778101  E_coul = 201.86261058645061
Extra cycle  E= -526.468586791359  delta_E= -3.64e-12  |g|= 1.86e-06  |ddm|= 3.64e-06
    CPU time for scf_cycle      0.71 sec, wall time      0.31 sec
exp = [2.61825455e+04 7.61781473e+03 3.61733907e+03 1.60454644e+03
 3.68760557e+02 1.03966559e+02 3.38334140e+01 4.58141464e+00
 3.94425411e-01 1.36276442e+03 6.64800881e+02 3.01235251e+02
 3.14306449e+02 8.51298966e+01 9.17195077e+00 2.66457121e+01
 8.41565953e-01 3.33122031e+00 2.37164532e-01]
E = -526.4685867913595
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:45:19 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5455394        1
[INPUT] 0    0    [1    /1   ]  7617.81473297        1
[INPUT] 0    0    [1    /1   ]  3617.33907245        1
[INPUT] 0    0    [1    /1   ]  1604.54644127        1
[INPUT] 0    0    [1    /1   ]  368.760557132        1
[INPUT] 0    0    [1    /1   ]  103.966559162        1
[INPUT] 0    0    [1    /1   ]  33.833413975         1
[INPUT] 0    0    [1    /1   ]  4.58141464408        1
[INPUT] 0    0    [1    /1   ]  0.394425410992       1
[INPUT] 1    0    [1    /1   ]  1362.76441911        1
[INPUT] 1    0    [1    /1   ]  664.800881466        1
[INPUT] 1    0    [1    /1   ]  301.235251348        1
[INPUT] 1    0    [1    /1   ]  314.30644911         1
[INPUT] 1    0    [1    /1   ]  85.1298966141        1
[INPUT] 1    0    [1    /1   ]  9.17195076639        1
[INPUT] 1    0    [1    /1   ]  26.6457120679        1
[INPUT] 1    0    [1    /1   ]  0.841565952715       1
[INPUT] 1    0    [1    /1   ]  3.33122031338        1
[INPUT] 1    0    [1    /1   ]  0.237164531792       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.54553938161, 1.0]], [0, [7617.8147329731055, 1.0]], [0, [3617.339072450368, 1.0]], [0, [1604.5464412741005, 1.0]], [0, [368.76055713244614, 1.0]], [0, [103.96655916163456, 1.0]], [0, [33.833413975033785, 1.0]], [0, [4.581414644082624, 1.0]], [0, [0.3944254109916935, 1.0]], [1, [1362.7644191126283, 1.0]], [1, [664.8008814661815, 1.0]], [1, [301.2352513477513, 1.0]], [1, [314.3064491098684, 1.0]], [1, [85.1298966141252, 1.0]], [1, [9.171950766387557, 1.0]], [1, [26.64571206786581, 1.0]], [1, [0.8415659527151527, 1.0]], [1, [3.3312203133845677, 1.0]], [1, [0.23716453179244334, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.54553938]
bas 1, expnt(s) = [7617.81473297]
bas 2, expnt(s) = [3617.33907245]
bas 3, expnt(s) = [1604.54644127]
bas 4, expnt(s) = [368.76055713]
bas 5, expnt(s) = [103.96655916]
bas 6, expnt(s) = [33.83341398]
bas 7, expnt(s) = [4.58141464]
bas 8, expnt(s) = [0.39442541]
bas 9, expnt(s) = [1362.76441911]
bas 10, expnt(s) = [664.80088147]
bas 11, expnt(s) = [301.23525135]
bas 12, expnt(s) = [314.30644911]
bas 13, expnt(s) = [85.12989661]
bas 14, expnt(s) = [9.17195077]
bas 15, expnt(s) = [26.64571207]
bas 16, expnt(s) = [0.84156595]
bas 17, expnt(s) = [3.33122031]
bas 18, expnt(s) = [0.23716453]
CPU time:       739.37
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825455e+04 5.20024643e+03 7.61781473e+03 2.06009776e+03
 3.61733907e+03 1.17843854e+03 1.60454644e+03 6.40514909e+02
 3.68760557e+02 2.12604950e+02 1.03966559e+02 8.22593508e+01
 3.38334140e+01 3.54425035e+01 4.58141464e+00 7.91160733e+00
 3.94425411e-01 1.25744411e+00 1.36276442e+03 2.41551854e+04
 6.64800881e+02 9.84801895e+03 3.01235251e+02 3.66114251e+03
 3.14306449e+02 3.86078847e+03 8.51298966e+01 7.54374544e+02
 9.17195077e+00 4.65652068e+01 2.66457121e+01 1.76611328e+02
 8.41565953e-01 2.35149786e+00 3.33122031e+00 1.31292098e+01
 2.37164532e-01 4.82832581e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.974147553062988
cond(S) = 150974.42383247733
E1 = -728.8779920742173  E_coul = 203.11493403249258
init E= -525.763058041725
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559000045776111  LUMO = 1.14812980111068
  mo_energy =
[-1.18318444e+02 -1.21042182e+01 -9.44891537e+00 -9.44891537e+00
 -9.44891537e+00 -1.23044006e+00 -5.59000046e-01 -5.59000046e-01
 -5.59000046e-01  1.14812980e+00  1.14812980e+00  1.14812980e+00
  9.17256824e+00  9.17256824e+00  9.17256824e+00  4.45873182e+01
  4.45873182e+01  4.45873182e+01  7.13933181e+01  1.75898320e+02
  1.75898320e+02  1.75898320e+02  5.35534404e+02  5.74669274e+02
  5.74669274e+02  5.74669274e+02  1.44222538e+03  1.44222538e+03
  1.44222538e+03  2.57928706e+03  3.13948971e+03  3.13948971e+03
  3.13948971e+03  6.75505505e+03  6.75505505e+03  6.75505505e+03
  8.98565221e+03  2.53494337e+04  7.60992327e+04]
E1 = -728.0875714789903  E_coul = 201.6193760760821
cycle= 1 E= -526.468195402908  delta_E= -0.705  |g|= 0.185  |ddm|= 0.447
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.550493
diis-c [-0.30304215  1.        ]
  HOMO = -0.572993080069545  LUMO = 1.13827198372226
  mo_energy =
[-1.18593483e+02 -1.22016874e+01 -9.55296928e+00 -9.55296928e+00
 -9.55296928e+00 -1.25158057e+00 -5.72993080e-01 -5.72993080e-01
 -5.72993080e-01  1.13827198e+00  1.13827198e+00  1.13827198e+00
  9.10800526e+00  9.10800526e+00  9.10800526e+00  4.44564042e+01
  4.44564042e+01  4.44564042e+01  7.12309367e+01  1.75691591e+02
  1.75691591e+02  1.75691591e+02  5.35226837e+02  5.74396768e+02
  5.74396768e+02  5.74396768e+02  1.44189758e+03  1.44189758e+03
  1.44189758e+03  2.57882188e+03  3.13909514e+03  3.13909514e+03
  3.13909514e+03  6.75454477e+03  6.75454477e+03  6.75454477e+03
  8.98506379e+03  2.53487504e+04  7.60984586e+04]
E1 = -728.3840298654832  E_coul = 201.91545650787026
cycle= 2 E= -526.468573357613  delta_E= -0.000378  |g|= 0.0245  |ddm|= 0.0205
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0473669
diis-c [-0.00144263  0.04900911  0.95099089]
  HOMO = -0.569341796287003  LUMO = 1.14146591555415
  mo_energy =
[-1.18550750e+02 -1.21814193e+01 -9.53229693e+00 -9.53229693e+00
 -9.53229693e+00 -1.24673754e+00 -5.69341796e-01 -5.69341796e-01
 -5.69341796e-01  1.14146592e+00  1.14146592e+00  1.14146592e+00
  9.12085045e+00  9.12085045e+00  9.12085045e+00  4.44808354e+01
  4.44808354e+01  4.44808354e+01  7.12645113e+01  1.75727436e+02
  1.75727436e+02  1.75727436e+02  5.35270871e+02  5.74439135e+02
  5.74439135e+02  5.74439135e+02  1.44194277e+03  1.44194277e+03
  1.44194277e+03  2.57886938e+03  3.13914194e+03  3.13914194e+03
  3.13914194e+03  6.75459259e+03  6.75459259e+03  6.75459259e+03
  8.98511205e+03  2.53487989e+04  7.60985071e+04]
E1 = -728.323120124701  E_coul = 201.85453362287925
cycle= 3 E= -526.468586501822  delta_E= -1.31e-05  |g|= 0.00299  |ddm|= 0.0052
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00643068
diis-c [-3.65924881e-07 -1.09361617e-03  1.12730769e-01  8.88362848e-01]
  HOMO = -0.569994459116876  LUMO = 1.14091510379153
  mo_energy =
[-1.18555983e+02 -1.21842398e+01 -9.53522434e+00 -9.53522434e+00
 -9.53522434e+00 -1.24758464e+00 -5.69994459e-01 -5.69994459e-01
 -5.69994459e-01  1.14091510e+00  1.14091510e+00  1.14091510e+00
  9.11887663e+00  9.11887663e+00  9.11887663e+00  4.44775246e+01
  4.44775246e+01  4.44775246e+01  7.12603699e+01  1.75722936e+02
  1.75722936e+02  1.75722936e+02  5.35265479e+02  5.74433948e+02
  5.74433948e+02  5.74433948e+02  1.44193724e+03  1.44193724e+03
  1.44193724e+03  2.57886343e+03  3.13913617e+03  3.13913617e+03
  3.13913617e+03  6.75458657e+03  6.75458657e+03  6.75458657e+03
  8.98510588e+03  2.53487926e+04  7.60985007e+04]
E1 = -728.3313628528075  E_coul = 201.862776061579
cycle= 4 E= -526.468586791229  delta_E= -2.89e-07  |g|= 4.15e-05  |ddm|= 0.000763
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.31155e-05
diis-c [-1.73973416e-09  8.19634857e-06 -1.82652261e-03 -8.83913673e-03
  1.01065746e+00]
  HOMO = -0.56996779838648  LUMO = 1.14093689728681
  mo_energy =
[-1.18555892e+02 -1.21841538e+01 -9.53513956e+00 -9.53513956e+00
 -9.53513956e+00 -1.24754999e+00 -5.69967798e-01 -5.69967798e-01
 -5.69967798e-01  1.14093690e+00  1.14093690e+00  1.14093690e+00
  9.11894287e+00  9.11894287e+00  9.11894287e+00  4.44776092e+01
  4.44776092e+01  4.44776092e+01  7.12604646e+01  1.75723027e+02
  1.75723027e+02  1.75723027e+02  5.35265567e+02  5.74434039e+02
  5.74434039e+02  5.74434039e+02  1.44193733e+03  1.44193733e+03
  1.44193733e+03  2.57886351e+03  3.13913625e+03  3.13913625e+03
  3.13913625e+03  6.75458665e+03  6.75458665e+03  6.75458665e+03
  8.98510596e+03  2.53487927e+04  7.60985008e+04]
E1 = -728.3311633539273  E_coul = 201.8625765625714
cycle= 5 E= -526.468586791356  delta_E= -1.27e-10  |g|= 7.34e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3311633539273  E_coul = 201.8625765625714
  HOMO = -0.56997153023025  LUMO = 1.14093382749487
  mo_energy =
[-1.18555910e+02 -1.21841669e+01 -9.53515288e+00 -9.53515288e+00
 -9.53515288e+00 -1.24755483e+00 -5.69971530e-01 -5.69971530e-01
 -5.69971530e-01  1.14093383e+00  1.14093383e+00  1.14093383e+00
  9.11893300e+00  9.11893300e+00  9.11893300e+00  4.44775952e+01
  4.44775952e+01  4.44775952e+01  7.12604487e+01  1.75723010e+02
  1.75723010e+02  1.75723010e+02  5.35265549e+02  5.74434021e+02
  5.74434021e+02  5.74434021e+02  1.44193731e+03  1.44193731e+03
  1.44193731e+03  2.57886349e+03  3.13913623e+03  3.13913623e+03
  3.13913623e+03  6.75458663e+03  6.75458663e+03  6.75458663e+03
  8.98510594e+03  2.53487926e+04  7.60985008e+04]
E1 = -728.3311973778101  E_coul = 201.86261058645061
Extra cycle  E= -526.468586791359  delta_E= -3.64e-12  |g|= 1.86e-06  |ddm|= 3.64e-06
    CPU time for scf_cycle      0.70 sec, wall time      0.31 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 150974.42383247733
E1 = -728.3311973778101  E_coul = 201.86261058645061
init E= -526.468586791359
    CPU time for initialize scf      2.74 sec, wall time      0.25 sec
  HOMO = -0.569970895610118  LUMO = 1.14093435729979
  mo_energy =
[-1.18555906e+02 -1.21841644e+01 -9.53515032e+00 -9.53515032e+00
 -9.53515032e+00 -1.24755400e+00 -5.69970896e-01 -5.69970896e-01
 -5.69970896e-01  1.14093436e+00  1.14093436e+00  1.14093436e+00
  9.11893480e+00  9.11893480e+00  9.11893480e+00  4.44775981e+01
  4.44775981e+01  4.44775981e+01  7.12604521e+01  1.75723014e+02
  1.75723014e+02  1.75723014e+02  5.35265553e+02  5.74434025e+02
  5.74434025e+02  5.74434025e+02  1.44193731e+03  1.44193731e+03
  1.44193731e+03  2.57886350e+03  3.13913624e+03  3.13913624e+03
  3.13913624e+03  6.75458663e+03  6.75458663e+03  6.75458663e+03
  8.98510594e+03  2.53487926e+04  7.60985008e+04]
E1 = -728.3311904867356  E_coul = 201.8626036953754
cycle= 1 E= -526.46858679136  delta_E= -6.82e-13  |g|= 4.12e-07  |ddm|= 6.77e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3311904867356  E_coul = 201.8626036953754
  HOMO = -0.569971016298119  LUMO = 1.14093425590698
  mo_energy =
[-1.18555907e+02 -1.21841649e+01 -9.53515084e+00 -9.53515084e+00
 -9.53515084e+00 -1.24755416e+00 -5.69971016e-01 -5.69971016e-01
 -5.69971016e-01  1.14093426e+00  1.14093426e+00  1.14093426e+00
  9.11893445e+00  9.11893445e+00  9.11893445e+00  4.44775975e+01
  4.44775975e+01  4.44775975e+01  7.12604514e+01  1.75723013e+02
  1.75723013e+02  1.75723013e+02  5.35265552e+02  5.74434024e+02
  5.74434024e+02  5.74434024e+02  1.44193731e+03  1.44193731e+03
  1.44193731e+03  2.57886350e+03  3.13913624e+03  3.13913624e+03
  3.13913624e+03  6.75458663e+03  6.75458663e+03  6.75458663e+03
  8.98510594e+03  2.53487926e+04  7.60985008e+04]
E1 = -728.3311919054563  E_coul = 201.86260511409634
Extra cycle  E= -526.46858679136  delta_E= 2.27e-13  |g|= 8.76e-08  |ddm|= 1.35e-07
    CPU time for scf_cycle      2.87 sec, wall time      0.39 sec
exp = [2.61825455e+04 7.61781473e+03 3.61733907e+03 1.60454644e+03
 3.68760557e+02 1.03966559e+02 3.38334140e+01 4.58141464e+00
 3.94425411e-01 1.36276442e+03 6.64800881e+02 3.01235251e+02
 3.14306449e+02 8.51298966e+01 9.17195077e+00 2.66457121e+01
 8.41565953e-01 3.33122031e+00 2.37164532e-01]
grad_E = [-1.58248117e-06  4.15329093e-06 -6.15727874e-07  9.48107780e-05
 -1.76490871e-04  1.27727314e-04 -4.94873563e-04  1.65281433e-03
 -4.77974629e-03 -3.20109956e-07  3.86086223e-09 -3.58228919e-07
  6.36784619e-08  4.19783915e-04  1.56743866e-03 -1.44800668e-04
  1.41775067e-02 -4.21167030e-03 -1.48581245e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:45:24 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5500037        1
[INPUT] 0    0    [1    /1   ]  7617.81042685        1
[INPUT] 0    0    [1    /1   ]  3617.36031846        1
[INPUT] 0    0    [1    /1   ]  1604.53107672        1
[INPUT] 0    0    [1    /1   ]  366.443955558        1
[INPUT] 0    0    [1    /1   ]  103.313475134        1
[INPUT] 0    0    [1    /1   ]  33.6626958865        1
[INPUT] 0    0    [1    /1   ]  4.58189045044        1
[INPUT] 0    0    [1    /1   ]  0.39411143071        1
[INPUT] 1    0    [1    /1   ]  1362.76590586        1
[INPUT] 1    0    [1    /1   ]  664.808622567        1
[INPUT] 1    0    [1    /1   ]  301.277963021        1
[INPUT] 1    0    [1    /1   ]  314.342727575        1
[INPUT] 1    0    [1    /1   ]  82.9789760629        1
[INPUT] 1    0    [1    /1   ]  9.05251683923        1
[INPUT] 1    0    [1    /1   ]  26.184063068         1
[INPUT] 1    0    [1    /1   ]  0.845547268304       1
[INPUT] 1    0    [1    /1   ]  3.29524929519        1
[INPUT] 1    0    [1    /1   ]  0.237836703118       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.55000368018, 1.0]], [0, [7617.810426854403, 1.0]], [0, [3617.3603184615404, 1.0]], [0, [1604.5310767151389, 1.0]], [0, [366.4439555577428, 1.0]], [0, [103.31347513415136, 1.0]], [0, [33.66269588647991, 1.0]], [0, [4.581890450440762, 1.0]], [0, [0.3941114307098904, 1.0]], [1, [1362.7659058551862, 1.0]], [1, [664.8086225665885, 1.0]], [1, [301.27796302070135, 1.0]], [1, [314.3427275748807, 1.0]], [1, [82.97897606290205, 1.0]], [1, [9.052516839227982, 1.0]], [1, [26.184063068023384, 1.0]], [1, [0.8455472683043895, 1.0]], [1, [3.295249295190312, 1.0]], [1, [0.23783670311819188, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.55000368]
bas 1, expnt(s) = [7617.81042685]
bas 2, expnt(s) = [3617.36031846]
bas 3, expnt(s) = [1604.53107672]
bas 4, expnt(s) = [366.44395556]
bas 5, expnt(s) = [103.31347513]
bas 6, expnt(s) = [33.66269589]
bas 7, expnt(s) = [4.58189045]
bas 8, expnt(s) = [0.39411143]
bas 9, expnt(s) = [1362.76590586]
bas 10, expnt(s) = [664.80862257]
bas 11, expnt(s) = [301.27796302]
bas 12, expnt(s) = [314.34272757]
bas 13, expnt(s) = [82.97897606]
bas 14, expnt(s) = [9.05251684]
bas 15, expnt(s) = [26.18406307]
bas 16, expnt(s) = [0.84554727]
bas 17, expnt(s) = [3.2952493]
bas 18, expnt(s) = [0.2378367]
CPU time:       747.78
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825500e+04 5.20024710e+03 7.61781043e+03 2.06009688e+03
 3.61736032e+03 1.17844373e+03 1.60453108e+03 6.40510309e+02
 3.66443956e+02 2.11602452e+02 1.03313475e+02 8.18715008e+01
 3.36626959e+01 3.53082908e+01 4.58189045e+00 7.91222357e+00
 3.94111431e-01 1.25669329e+00 1.36276591e+03 2.41552183e+04
 6.64808623e+02 9.84816230e+03 3.01277963e+02 3.66179140e+03
 3.14342728e+02 3.86134551e+03 8.29789761e+01 7.30624922e+02
 9.05251684e+00 4.58084998e+01 2.61840631e+01 1.72794809e+02
 8.45547268e-01 2.36541178e+00 3.29524930e+00 1.29522357e+01
 2.37836703e-01 4.84543741e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.974061501477394
cond(S) = 145740.33002591436
E1 = -728.8796854321772  E_coul = 203.1127499313668
init E= -525.76693550081
    CPU time for initialize scf      0.45 sec, wall time      0.05 sec
  HOMO = -0.559132268655577  LUMO = 1.15398945973015
  mo_energy =
[-1.18318323e+02 -1.21043076e+01 -9.44917626e+00 -9.44917626e+00
 -9.44917626e+00 -1.23055631e+00 -5.59132269e-01 -5.59132269e-01
 -5.59132269e-01  1.15398946e+00  1.15398946e+00  1.15398946e+00
  9.08084974e+00  9.08084974e+00  9.08084974e+00  4.38327931e+01
  4.38327931e+01  4.38327931e+01  7.08152657e+01  1.72320612e+02
  1.72320612e+02  1.72320612e+02  5.31626946e+02  5.67321323e+02
  5.67321323e+02  5.67321323e+02  1.43327934e+03  1.43327934e+03
  1.43327934e+03  2.57004351e+03  3.13023603e+03  3.13023603e+03
  3.13023603e+03  6.74625785e+03  6.74625785e+03  6.74625785e+03
  8.97456516e+03  2.53381901e+04  7.60885280e+04]
E1 = -728.0892326955551  E_coul = 201.62070192507895
cycle= 1 E= -526.468530770476  delta_E= -0.702  |g|= 0.184  |ddm|= 0.41
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.550617
diis-c [-0.30317916  1.        ]
  HOMO = -0.573123752692489  LUMO = 1.1440757108927
  mo_energy =
[-1.18592867e+02 -1.22014865e+01 -9.55292987e+00 -9.55292987e+00
 -9.55292987e+00 -1.25162825e+00 -5.73123753e-01 -5.73123753e-01
 -5.73123753e-01  1.14407571e+00  1.14407571e+00  1.14407571e+00
  9.01705433e+00  9.01705433e+00  9.01705433e+00  4.37033709e+01
  4.37033709e+01  4.37033709e+01  7.06536776e+01  1.72115539e+02
  1.72115539e+02  1.72115539e+02  5.31320367e+02  5.67049479e+02
  5.67049479e+02  5.67049479e+02  1.43295180e+03  1.43295180e+03
  1.43295180e+03  2.56957876e+03  3.12984168e+03  3.12984168e+03
  3.12984168e+03  6.74574772e+03  6.74574772e+03  6.74574772e+03
  8.97397686e+03  2.53375069e+04  7.60877540e+04]
E1 = -728.3853951373396  E_coul = 201.916486919263
cycle= 2 E= -526.468908218077  delta_E= -0.000377  |g|= 0.0245  |ddm|= 0.0203
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0474879
diis-c [-0.00144982  0.04912361  0.95087639]
  HOMO = -0.569490169341855  LUMO = 1.14726718708728
  mo_energy =
[-1.18550146e+02 -1.21812364e+01 -9.53227489e+00 -9.53227489e+00
 -9.53227489e+00 -1.24680733e+00 -5.69490169e-01 -5.69490169e-01
 -5.69490169e-01  1.14726719e+00  1.14726719e+00  1.14726719e+00
  9.02975687e+00  9.02975687e+00  9.02975687e+00  4.37275865e+01
  4.37275865e+01  4.37275865e+01  7.06871592e+01  1.72151203e+02
  1.72151203e+02  1.72151203e+02  5.31364359e+02  5.67091808e+02
  5.67091808e+02  5.67091808e+02  1.43299698e+03  1.43299698e+03
  1.43299698e+03  2.56962625e+03  3.12988847e+03  3.12988847e+03
  3.12988847e+03  6.74579554e+03  6.74579554e+03  6.74579554e+03
  8.97402511e+03  2.53375554e+04  7.60878025e+04]
E1 = -728.3244272859412  E_coul = 201.85550590050937
cycle= 3 E= -526.468921385432  delta_E= -1.32e-05  |g|= 0.003  |ddm|= 0.00519
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00645321
diis-c [-3.69695787e-07 -1.09513256e-03  1.12836983e-01  8.88258150e-01]
  HOMO = -0.570142998453734  LUMO = 1.14671406965397
  mo_energy =
[-1.18555384e+02 -1.21840587e+01 -9.53520435e+00 -9.53520435e+00
 -9.53520435e+00 -1.24765417e+00 -5.70142998e-01 -5.70142998e-01
 -5.70142998e-01  1.14671407e+00  1.14671407e+00  1.14671407e+00
  9.02779651e+00  9.02779651e+00  9.02779651e+00  4.37242942e+01
  4.37242942e+01  4.37242942e+01  7.06830221e+01  1.72146716e+02
  1.72146716e+02  1.72146716e+02  5.31358965e+02  5.67086620e+02
  5.67086620e+02  5.67086620e+02  1.43299145e+03  1.43299145e+03
  1.43299145e+03  2.56962030e+03  3.12988269e+03  3.12988269e+03
  3.12988269e+03  6.74578951e+03  6.74578951e+03  6.74578951e+03
  8.97401894e+03  2.53375491e+04  7.60877961e+04]
E1 = -728.332687908589  E_coul = 201.86376623245917
cycle= 4 E= -526.46892167613  delta_E= -2.91e-07  |g|= 4.17e-05  |ddm|= 0.000762
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.34696e-05
diis-c [-1.75568745e-09  7.70462872e-06 -1.77729339e-03 -8.39613770e-03
  1.01016573e+00]
  HOMO = -0.570116313443521  LUMO = 1.14673596261035
  mo_energy =
[-1.18555293e+02 -1.21839724e+01 -9.53511918e+00 -9.53511918e+00
 -9.53511918e+00 -1.24761947e+00 -5.70116313e-01 -5.70116313e-01
 -5.70116313e-01  1.14673596e+00  1.14673596e+00  1.14673596e+00
  9.02786263e+00  9.02786263e+00  9.02786263e+00  4.37243790e+01
  4.37243790e+01  4.37243790e+01  7.06831172e+01  1.72146808e+02
  1.72146808e+02  1.72146808e+02  5.31359053e+02  5.67086711e+02
  5.67086711e+02  5.67086711e+02  1.43299153e+03  1.43299153e+03
  1.43299153e+03  2.56962038e+03  3.12988277e+03  3.12988277e+03
  3.12988277e+03  6.74578958e+03  6.74578958e+03  6.74578958e+03
  8.97401901e+03  2.53375492e+04  7.60877962e+04]
E1 = -728.3324870968981  E_coul = 201.86356542063703
cycle= 5 E= -526.468921676261  delta_E= -1.31e-10  |g|= 7.37e-06  |ddm|= 2.34e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3324870968981  E_coul = 201.86356542063703
  HOMO = -0.570120051753694  LUMO = 1.1467328753854
  mo_energy =
[-1.18555311e+02 -1.21839855e+01 -9.53513254e+00 -9.53513254e+00
 -9.53513254e+00 -1.24762431e+00 -5.70120052e-01 -5.70120052e-01
 -5.70120052e-01  1.14673288e+00  1.14673288e+00  1.14673288e+00
  9.02785279e+00  9.02785279e+00  9.02785279e+00  4.37243650e+01
  4.37243650e+01  4.37243650e+01  7.06831012e+01  1.72146791e+02
  1.72146791e+02  1.72146791e+02  5.31359035e+02  5.67086693e+02
  5.67086693e+02  5.67086693e+02  1.43299151e+03  1.43299151e+03
  1.43299151e+03  2.56962036e+03  3.12988276e+03  3.12988276e+03
  3.12988276e+03  6.74578956e+03  6.74578956e+03  6.74578956e+03
  8.97401899e+03  2.53375491e+04  7.60877962e+04]
E1 = -728.3325212710569  E_coul = 201.86359959479333
Extra cycle  E= -526.468921676264  delta_E= -2.5e-12  |g|= 1.87e-06  |ddm|= 3.64e-06
    CPU time for scf_cycle      0.70 sec, wall time      0.31 sec
exp = [2.61825500e+04 7.61781043e+03 3.61736032e+03 1.60453108e+03
 3.66443956e+02 1.03313475e+02 3.36626959e+01 4.58189045e+00
 3.94111431e-01 1.36276591e+03 6.64808623e+02 3.01277963e+02
 3.14342728e+02 8.29789761e+01 9.05251684e+00 2.61840631e+01
 8.45547268e-01 3.29524930e+00 2.37836703e-01]
E = -526.4689216762636
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:45:24 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5500037        1
[INPUT] 0    0    [1    /1   ]  7617.81042685        1
[INPUT] 0    0    [1    /1   ]  3617.36031846        1
[INPUT] 0    0    [1    /1   ]  1604.53107672        1
[INPUT] 0    0    [1    /1   ]  366.443955558        1
[INPUT] 0    0    [1    /1   ]  103.313475134        1
[INPUT] 0    0    [1    /1   ]  33.6626958865        1
[INPUT] 0    0    [1    /1   ]  4.58189045044        1
[INPUT] 0    0    [1    /1   ]  0.39411143071        1
[INPUT] 1    0    [1    /1   ]  1362.76590586        1
[INPUT] 1    0    [1    /1   ]  664.808622567        1
[INPUT] 1    0    [1    /1   ]  301.277963021        1
[INPUT] 1    0    [1    /1   ]  314.342727575        1
[INPUT] 1    0    [1    /1   ]  82.9789760629        1
[INPUT] 1    0    [1    /1   ]  9.05251683923        1
[INPUT] 1    0    [1    /1   ]  26.184063068         1
[INPUT] 1    0    [1    /1   ]  0.845547268304       1
[INPUT] 1    0    [1    /1   ]  3.29524929519        1
[INPUT] 1    0    [1    /1   ]  0.237836703118       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.55000368018, 1.0]], [0, [7617.810426854403, 1.0]], [0, [3617.3603184615404, 1.0]], [0, [1604.5310767151389, 1.0]], [0, [366.4439555577428, 1.0]], [0, [103.31347513415136, 1.0]], [0, [33.66269588647991, 1.0]], [0, [4.581890450440762, 1.0]], [0, [0.3941114307098904, 1.0]], [1, [1362.7659058551862, 1.0]], [1, [664.8086225665885, 1.0]], [1, [301.27796302070135, 1.0]], [1, [314.3427275748807, 1.0]], [1, [82.97897606290205, 1.0]], [1, [9.052516839227982, 1.0]], [1, [26.184063068023384, 1.0]], [1, [0.8455472683043895, 1.0]], [1, [3.295249295190312, 1.0]], [1, [0.23783670311819188, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.55000368]
bas 1, expnt(s) = [7617.81042685]
bas 2, expnt(s) = [3617.36031846]
bas 3, expnt(s) = [1604.53107672]
bas 4, expnt(s) = [366.44395556]
bas 5, expnt(s) = [103.31347513]
bas 6, expnt(s) = [33.66269589]
bas 7, expnt(s) = [4.58189045]
bas 8, expnt(s) = [0.39411143]
bas 9, expnt(s) = [1362.76590586]
bas 10, expnt(s) = [664.80862257]
bas 11, expnt(s) = [301.27796302]
bas 12, expnt(s) = [314.34272757]
bas 13, expnt(s) = [82.97897606]
bas 14, expnt(s) = [9.05251684]
bas 15, expnt(s) = [26.18406307]
bas 16, expnt(s) = [0.84554727]
bas 17, expnt(s) = [3.2952493]
bas 18, expnt(s) = [0.2378367]
CPU time:       748.78
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825500e+04 5.20024710e+03 7.61781043e+03 2.06009688e+03
 3.61736032e+03 1.17844373e+03 1.60453108e+03 6.40510309e+02
 3.66443956e+02 2.11602452e+02 1.03313475e+02 8.18715008e+01
 3.36626959e+01 3.53082908e+01 4.58189045e+00 7.91222357e+00
 3.94111431e-01 1.25669329e+00 1.36276591e+03 2.41552183e+04
 6.64808623e+02 9.84816230e+03 3.01277963e+02 3.66179140e+03
 3.14342728e+02 3.86134551e+03 8.29789761e+01 7.30624922e+02
 9.05251684e+00 4.58084998e+01 2.61840631e+01 1.72794809e+02
 8.45547268e-01 2.36541178e+00 3.29524930e+00 1.29522357e+01
 2.37836703e-01 4.84543741e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.974061501477394
cond(S) = 145740.33002591436
E1 = -728.8796854321772  E_coul = 203.1127499313668
init E= -525.76693550081
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559132268655577  LUMO = 1.15398945973015
  mo_energy =
[-1.18318323e+02 -1.21043076e+01 -9.44917626e+00 -9.44917626e+00
 -9.44917626e+00 -1.23055631e+00 -5.59132269e-01 -5.59132269e-01
 -5.59132269e-01  1.15398946e+00  1.15398946e+00  1.15398946e+00
  9.08084974e+00  9.08084974e+00  9.08084974e+00  4.38327931e+01
  4.38327931e+01  4.38327931e+01  7.08152657e+01  1.72320612e+02
  1.72320612e+02  1.72320612e+02  5.31626946e+02  5.67321323e+02
  5.67321323e+02  5.67321323e+02  1.43327934e+03  1.43327934e+03
  1.43327934e+03  2.57004351e+03  3.13023603e+03  3.13023603e+03
  3.13023603e+03  6.74625785e+03  6.74625785e+03  6.74625785e+03
  8.97456516e+03  2.53381901e+04  7.60885280e+04]
E1 = -728.0892326955551  E_coul = 201.62070192507895
cycle= 1 E= -526.468530770476  delta_E= -0.702  |g|= 0.184  |ddm|= 0.41
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.550617
diis-c [-0.30317916  1.        ]
  HOMO = -0.573123752692489  LUMO = 1.1440757108927
  mo_energy =
[-1.18592867e+02 -1.22014865e+01 -9.55292987e+00 -9.55292987e+00
 -9.55292987e+00 -1.25162825e+00 -5.73123753e-01 -5.73123753e-01
 -5.73123753e-01  1.14407571e+00  1.14407571e+00  1.14407571e+00
  9.01705433e+00  9.01705433e+00  9.01705433e+00  4.37033709e+01
  4.37033709e+01  4.37033709e+01  7.06536776e+01  1.72115539e+02
  1.72115539e+02  1.72115539e+02  5.31320367e+02  5.67049479e+02
  5.67049479e+02  5.67049479e+02  1.43295180e+03  1.43295180e+03
  1.43295180e+03  2.56957876e+03  3.12984168e+03  3.12984168e+03
  3.12984168e+03  6.74574772e+03  6.74574772e+03  6.74574772e+03
  8.97397686e+03  2.53375069e+04  7.60877540e+04]
E1 = -728.3853951373396  E_coul = 201.916486919263
cycle= 2 E= -526.468908218077  delta_E= -0.000377  |g|= 0.0245  |ddm|= 0.0203
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0474879
diis-c [-0.00144982  0.04912361  0.95087639]
  HOMO = -0.569490169341855  LUMO = 1.14726718708728
  mo_energy =
[-1.18550146e+02 -1.21812364e+01 -9.53227489e+00 -9.53227489e+00
 -9.53227489e+00 -1.24680733e+00 -5.69490169e-01 -5.69490169e-01
 -5.69490169e-01  1.14726719e+00  1.14726719e+00  1.14726719e+00
  9.02975687e+00  9.02975687e+00  9.02975687e+00  4.37275865e+01
  4.37275865e+01  4.37275865e+01  7.06871592e+01  1.72151203e+02
  1.72151203e+02  1.72151203e+02  5.31364359e+02  5.67091808e+02
  5.67091808e+02  5.67091808e+02  1.43299698e+03  1.43299698e+03
  1.43299698e+03  2.56962625e+03  3.12988847e+03  3.12988847e+03
  3.12988847e+03  6.74579554e+03  6.74579554e+03  6.74579554e+03
  8.97402511e+03  2.53375554e+04  7.60878025e+04]
E1 = -728.3244272859412  E_coul = 201.85550590050937
cycle= 3 E= -526.468921385432  delta_E= -1.32e-05  |g|= 0.003  |ddm|= 0.00519
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00645321
diis-c [-3.69695787e-07 -1.09513256e-03  1.12836983e-01  8.88258150e-01]
  HOMO = -0.570142998453734  LUMO = 1.14671406965397
  mo_energy =
[-1.18555384e+02 -1.21840587e+01 -9.53520435e+00 -9.53520435e+00
 -9.53520435e+00 -1.24765417e+00 -5.70142998e-01 -5.70142998e-01
 -5.70142998e-01  1.14671407e+00  1.14671407e+00  1.14671407e+00
  9.02779651e+00  9.02779651e+00  9.02779651e+00  4.37242942e+01
  4.37242942e+01  4.37242942e+01  7.06830221e+01  1.72146716e+02
  1.72146716e+02  1.72146716e+02  5.31358965e+02  5.67086620e+02
  5.67086620e+02  5.67086620e+02  1.43299145e+03  1.43299145e+03
  1.43299145e+03  2.56962030e+03  3.12988269e+03  3.12988269e+03
  3.12988269e+03  6.74578951e+03  6.74578951e+03  6.74578951e+03
  8.97401894e+03  2.53375491e+04  7.60877961e+04]
E1 = -728.332687908589  E_coul = 201.86376623245917
cycle= 4 E= -526.46892167613  delta_E= -2.91e-07  |g|= 4.17e-05  |ddm|= 0.000762
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.34696e-05
diis-c [-1.75568745e-09  7.70462872e-06 -1.77729339e-03 -8.39613770e-03
  1.01016573e+00]
  HOMO = -0.570116313443521  LUMO = 1.14673596261035
  mo_energy =
[-1.18555293e+02 -1.21839724e+01 -9.53511918e+00 -9.53511918e+00
 -9.53511918e+00 -1.24761947e+00 -5.70116313e-01 -5.70116313e-01
 -5.70116313e-01  1.14673596e+00  1.14673596e+00  1.14673596e+00
  9.02786263e+00  9.02786263e+00  9.02786263e+00  4.37243790e+01
  4.37243790e+01  4.37243790e+01  7.06831172e+01  1.72146808e+02
  1.72146808e+02  1.72146808e+02  5.31359053e+02  5.67086711e+02
  5.67086711e+02  5.67086711e+02  1.43299153e+03  1.43299153e+03
  1.43299153e+03  2.56962038e+03  3.12988277e+03  3.12988277e+03
  3.12988277e+03  6.74578958e+03  6.74578958e+03  6.74578958e+03
  8.97401901e+03  2.53375492e+04  7.60877962e+04]
E1 = -728.3324870968981  E_coul = 201.86356542063703
cycle= 5 E= -526.468921676261  delta_E= -1.31e-10  |g|= 7.37e-06  |ddm|= 2.34e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3324870968981  E_coul = 201.86356542063703
  HOMO = -0.570120051753694  LUMO = 1.1467328753854
  mo_energy =
[-1.18555311e+02 -1.21839855e+01 -9.53513254e+00 -9.53513254e+00
 -9.53513254e+00 -1.24762431e+00 -5.70120052e-01 -5.70120052e-01
 -5.70120052e-01  1.14673288e+00  1.14673288e+00  1.14673288e+00
  9.02785279e+00  9.02785279e+00  9.02785279e+00  4.37243650e+01
  4.37243650e+01  4.37243650e+01  7.06831012e+01  1.72146791e+02
  1.72146791e+02  1.72146791e+02  5.31359035e+02  5.67086693e+02
  5.67086693e+02  5.67086693e+02  1.43299151e+03  1.43299151e+03
  1.43299151e+03  2.56962036e+03  3.12988276e+03  3.12988276e+03
  3.12988276e+03  6.74578956e+03  6.74578956e+03  6.74578956e+03
  8.97401899e+03  2.53375491e+04  7.60877962e+04]
E1 = -728.3325212710569  E_coul = 201.86359959479333
Extra cycle  E= -526.468921676264  delta_E= -2.5e-12  |g|= 1.87e-06  |ddm|= 3.64e-06
    CPU time for scf_cycle      0.69 sec, wall time      0.30 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 145740.33002591436
E1 = -728.3325212710569  E_coul = 201.86359959479333
init E= -526.468921676264
    CPU time for initialize scf      2.73 sec, wall time      0.25 sec
  HOMO = -0.570119415300173  LUMO = 1.14673340878346
  mo_energy =
[-1.18555306e+02 -1.21839829e+01 -9.53512997e+00 -9.53512997e+00
 -9.53512997e+00 -1.24762348e+00 -5.70119415e-01 -5.70119415e-01
 -5.70119415e-01  1.14673341e+00  1.14673341e+00  1.14673341e+00
  9.02785459e+00  9.02785459e+00  9.02785459e+00  4.37243678e+01
  4.37243678e+01  4.37243678e+01  7.06831046e+01  1.72146795e+02
  1.72146795e+02  1.72146795e+02  5.31359039e+02  5.67086697e+02
  5.67086697e+02  5.67086697e+02  1.43299152e+03  1.43299152e+03
  1.43299152e+03  2.56962037e+03  3.12988276e+03  3.12988276e+03
  3.12988276e+03  6.74578957e+03  6.74578957e+03  6.74578957e+03
  8.97401900e+03  2.53375491e+04  7.60877962e+04]
E1 = -728.3325143365115  E_coul = 201.86359266024755
cycle= 1 E= -526.468921676264  delta_E= -4.55e-13  |g|= 4.15e-07  |ddm|= 6.79e-07
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
E1 = -728.3325143365115  E_coul = 201.86359266024755
  HOMO = -0.570119536599419  LUMO = 1.14673330647886
  mo_energy =
[-1.18555307e+02 -1.21839834e+01 -9.53513049e+00 -9.53513049e+00
 -9.53513049e+00 -1.24762364e+00 -5.70119537e-01 -5.70119537e-01
 -5.70119537e-01  1.14673331e+00  1.14673331e+00  1.14673331e+00
  9.02785424e+00  9.02785424e+00  9.02785424e+00  4.37243672e+01
  4.37243672e+01  4.37243672e+01  7.06831039e+01  1.72146794e+02
  1.72146794e+02  1.72146794e+02  5.31359038e+02  5.67086696e+02
  5.67086696e+02  5.67086696e+02  1.43299152e+03  1.43299152e+03
  1.43299152e+03  2.56962036e+03  3.12988276e+03  3.12988276e+03
  3.12988276e+03  6.74578957e+03  6.74578957e+03  6.74578957e+03
  8.97401900e+03  2.53375491e+04  7.60877962e+04]
E1 = -728.3325157666883  E_coul = 201.86359409042473
Extra cycle  E= -526.468921676264  delta_E= 4.55e-13  |g|= 8.85e-08  |ddm|= 1.36e-07
    CPU time for scf_cycle      2.88 sec, wall time      0.40 sec
exp = [2.61825500e+04 7.61781043e+03 3.61736032e+03 1.60453108e+03
 3.66443956e+02 1.03313475e+02 3.36626959e+01 4.58189045e+00
 3.94111431e-01 1.36276591e+03 6.64808623e+02 3.01277963e+02
 3.14342728e+02 8.29789761e+01 9.05251684e+00 2.61840631e+01
 8.45547268e-01 3.29524930e+00 2.37836703e-01]
grad_E = [-1.59391084e-06  4.30535867e-06 -4.48666484e-07  9.97692435e-05
 -2.25262106e-04  2.37774376e-04 -7.82943161e-04  2.76381538e-03
 -9.14426445e-03 -3.87199579e-07  2.29647841e-08 -6.67099174e-07
 -2.73725353e-07  4.22460805e-04  2.22555044e-03 -2.46900949e-04
  2.38498706e-02 -6.26510379e-03 -2.57117765e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:45:29 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5622294        1
[INPUT] 0    0    [1    /1   ]  7617.79105019        1
[INPUT] 0    0    [1    /1   ]  3617.39780281        1
[INPUT] 0    0    [1    /1   ]  1604.23126024        1
[INPUT] 0    0    [1    /1   ]  362.991388708        1
[INPUT] 0    0    [1    /1   ]  102.329651178        1
[INPUT] 0    0    [1    /1   ]  33.4000329651        1
[INPUT] 0    0    [1    /1   ]  4.58266156742        1
[INPUT] 0    0    [1    /1   ]  0.393587209815       1
[INPUT] 1    0    [1    /1   ]  1362.76919402        1
[INPUT] 1    0    [1    /1   ]  664.82135812         1
[INPUT] 1    0    [1    /1   ]  301.348397687        1
[INPUT] 1    0    [1    /1   ]  314.401247118        1
[INPUT] 1    0    [1    /1   ]  78.150896684         1
[INPUT] 1    0    [1    /1   ]  8.77318436162        1
[INPUT] 1    0    [1    /1   ]  25.1170006867        1
[INPUT] 1    0    [1    /1   ]  0.850322681377       1
[INPUT] 1    0    [1    /1   ]  3.21401560997        1
[INPUT] 1    0    [1    /1   ]  0.238566349945       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.562229444313, 1.0]], [0, [7617.7910501921115, 1.0]], [0, [3617.397802810595, 1.0]], [0, [1604.2312602394068, 1.0]], [0, [362.99138870793496, 1.0]], [0, [102.32965117843257, 1.0]], [0, [33.40003296509219, 1.0]], [0, [4.582661567415118, 1.0]], [0, [0.39358720981537687, 1.0]], [1, [1362.7691940221348, 1.0]], [1, [664.8213581199925, 1.0]], [1, [301.3483976874033, 1.0]], [1, [314.40124711810495, 1.0]], [1, [78.15089668395726, 1.0]], [1, [8.773184361622427, 1.0]], [1, [25.117000686669186, 1.0]], [1, [0.8503226813773586, 1.0]], [1, [3.214015609971779, 1.0]], [1, [0.23856634994510853, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.56222944]
bas 1, expnt(s) = [7617.79105019]
bas 2, expnt(s) = [3617.39780281]
bas 3, expnt(s) = [1604.23126024]
bas 4, expnt(s) = [362.99138871]
bas 5, expnt(s) = [102.32965118]
bas 6, expnt(s) = [33.40003297]
bas 7, expnt(s) = [4.58266157]
bas 8, expnt(s) = [0.39358721]
bas 9, expnt(s) = [1362.76919402]
bas 10, expnt(s) = [664.82135812]
bas 11, expnt(s) = [301.34839769]
bas 12, expnt(s) = [314.40124712]
bas 13, expnt(s) = [78.15089668]
bas 14, expnt(s) = [8.77318436]
bas 15, expnt(s) = [25.11700069]
bas 16, expnt(s) = [0.85032268]
bas 17, expnt(s) = [3.21401561]
bas 18, expnt(s) = [0.23856635]
CPU time:       757.22
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825622e+04 5.20024892e+03 7.61779105e+03 2.06009295e+03
 3.61739780e+03 1.17845289e+03 1.60423126e+03 6.40420544e+02
 3.62991389e+02 2.10105425e+02 1.02329651e+02 8.12860733e+01
 3.34000330e+01 3.51014612e+01 4.58266157e+00 7.91322225e+00
 3.93587210e-01 1.25543941e+00 1.36276919e+03 2.41552912e+04
 6.64821358e+02 9.84839812e+03 3.01348398e+02 3.66286153e+03
 3.14401247e+02 3.86224409e+03 7.81508967e+01 6.77878484e+02
 8.77318436e+00 4.40484836e+01 2.51170007e+01 1.64037867e+02
 8.50322681e-01 2.38212253e+00 3.21401561e+00 1.25543540e+01
 2.38566350e-01 4.86402586e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.973997139471578
cond(S) = 134609.29163483568
E1 = -728.8813128971065  E_coul = 203.10836965485584
init E= -525.772943242251
    CPU time for initialize scf      0.45 sec, wall time      0.05 sec
  HOMO = -0.559384539420992  LUMO = 1.16021860384601
  mo_energy =
[-1.18318160e+02 -1.21045272e+01 -9.44971033e+00 -9.44971033e+00
 -9.44971033e+00 -1.23075738e+00 -5.59384539e-01 -5.59384539e-01
 -5.59384539e-01  1.16021860e+00  1.16021860e+00  1.16021860e+00
  8.85447739e+00  8.85447739e+00  8.85447739e+00  4.20867026e+01
  4.20867026e+01  4.20867026e+01  6.99374400e+01  1.64057459e+02
  1.64057459e+02  1.64057459e+02  5.25741657e+02  5.50420602e+02
  5.50420602e+02  5.50420602e+02  1.41291635e+03  1.41291635e+03
  1.41291635e+03  2.55601020e+03  3.10925709e+03  3.10925709e+03
  3.10925709e+03  6.72632715e+03  6.72632715e+03  6.72632715e+03
  8.95739343e+03  2.53204744e+04  7.60715137e+04]
E1 = -728.0908702179274  E_coul = 201.6214929862223
cycle= 1 E= -526.469377231705  delta_E= -0.696  |g|= 0.184  |ddm|= 0.349
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.550618
diis-c [-0.30318064  1.        ]
  HOMO = -0.573430480606781  LUMO = 1.15022439450922
  mo_energy =
[-1.18591873e+02 -1.22012498e+01 -9.55299164e+00 -9.55299164e+00
 -9.55299164e+00 -1.25178134e+00 -5.73430481e-01 -5.73430481e-01
 -5.73430481e-01  1.15022439e+00  1.15022439e+00  1.15022439e+00
  8.79233042e+00  8.79233042e+00  8.79233042e+00  4.19605688e+01
  4.19605688e+01  4.19605688e+01  6.97770988e+01  1.63856051e+02
  1.63856051e+02  1.63856051e+02  5.25436665e+02  5.50150033e+02
  5.50150033e+02  5.50150033e+02  1.41258920e+03  1.41258920e+03
  1.41258920e+03  2.55554623e+03  3.10886306e+03  3.10886306e+03
  3.10886306e+03  6.72581728e+03  6.72581728e+03  6.72581728e+03
  8.95680543e+03  2.53197915e+04  7.60707398e+04]
E1 = -728.3867265293923  E_coul = 201.91697237474625
cycle= 2 E= -526.469754154646  delta_E= -0.000377  |g|= 0.0246  |ddm|= 0.02
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0477305
diis-c [-0.00146437  0.04937176  0.95062824]
  HOMO = -0.569823427834878  LUMO = 1.15340180362874
  mo_energy =
[-1.18549158e+02 -1.21810163e+01 -9.53235215e+00 -9.53235215e+00
 -9.53235215e+00 -1.24699306e+00 -5.69823428e-01 -5.69823428e-01
 -5.69823428e-01  1.15340180e+00  1.15340180e+00  1.15340180e+00
  8.80472660e+00  8.80472660e+00  8.80472660e+00  4.19843002e+01
  4.19843002e+01  4.19843002e+01  6.98104493e+01  1.63891303e+02
  1.63891303e+02  1.63891303e+02  5.25480604e+02  5.50192301e+02
  5.50192301e+02  5.50192301e+02  1.41263439e+03  1.41263439e+03
  1.41263439e+03  2.55559370e+03  3.10890986e+03  3.10890986e+03
  3.10890986e+03  6.72586510e+03  6.72586510e+03  6.72586510e+03
  8.95685367e+03  2.53198399e+04  7.60707883e+04]
E1 = -728.3256078108299  E_coul = 201.8558404369472
cycle= 3 E= -526.469767373883  delta_E= -1.32e-05  |g|= 0.00301  |ddm|= 0.00518
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00649288
diis-c [-3.77140713e-07 -1.09703194e-03  1.12968276e-01  8.88128756e-01]
  HOMO = -0.57047751924284  LUMO = 1.15284605708479
  mo_energy =
[-1.18554405e+02 -1.21838434e+01 -9.53528674e+00 -9.53528674e+00
 -9.53528674e+00 -1.24784069e+00 -5.70477519e-01 -5.70477519e-01
 -5.70477519e-01  1.15284606e+00  1.15284606e+00  1.15284606e+00
  8.80279704e+00  8.80279704e+00  8.80279704e+00  4.19810523e+01
  4.19810523e+01  4.19810523e+01  6.98063170e+01  1.63886849e+02
  1.63886849e+02  1.63886849e+02  5.25475205e+02  5.50187109e+02
  5.50187109e+02  5.50187109e+02  1.41262885e+03  1.41262885e+03
  1.41262885e+03  2.55558775e+03  3.10890406e+03  3.10890406e+03
  3.10890406e+03  6.72585906e+03  6.72585906e+03  6.72585906e+03
  8.95684749e+03  2.53198336e+04  7.60707819e+04]
E1 = -728.3339062168253  E_coul = 201.86413854978835
cycle= 4 E= -526.469767667037  delta_E= -2.93e-07  |g|= 4.23e-05  |ddm|= 0.00076
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.45244e-05
diis-c [-1.79107690e-09  6.77820222e-06 -1.68485758e-03 -7.48847424e-03
  1.00916655e+00]
  HOMO = -0.570450724389321  LUMO = 1.15286809849821
  mo_energy =
[-1.18554313e+02 -1.21837561e+01 -9.53520065e+00 -9.53520065e+00
 -9.53520065e+00 -1.24780580e+00 -5.70450724e-01 -5.70450724e-01
 -5.70450724e-01  1.15286810e+00  1.15286810e+00  1.15286810e+00
  8.80286294e+00  8.80286294e+00  8.80286294e+00  4.19811375e+01
  4.19811375e+01  4.19811375e+01  6.98064130e+01  1.63886942e+02
  1.63886942e+02  1.63886942e+02  5.25475295e+02  5.50187202e+02
  5.50187202e+02  5.50187202e+02  1.41262893e+03  1.41262893e+03
  1.41262893e+03  2.55558783e+03  3.10890415e+03  3.10890415e+03
  3.10890415e+03  6.72585913e+03  6.72585913e+03  6.72585913e+03
  8.95684756e+03  2.53198337e+04  7.60707819e+04]
E1 = -728.3337023132103  E_coul = 201.86393464603867
cycle= 5 E= -526.469767667172  delta_E= -1.35e-10  |g|= 7.43e-06  |ddm|= 2.37e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3337023132103  E_coul = 201.86393464603867
  HOMO = -0.570454476817705  LUMO = 1.15286499027095
  mo_energy =
[-1.18554331e+02 -1.21837693e+01 -9.53521407e+00 -9.53521407e+00
 -9.53521407e+00 -1.24781066e+00 -5.70454477e-01 -5.70454477e-01
 -5.70454477e-01  1.15286499e+00  1.15286499e+00  1.15286499e+00
  8.80285319e+00  8.80285319e+00  8.80285319e+00  4.19811236e+01
  4.19811236e+01  4.19811236e+01  6.98063970e+01  1.63886925e+02
  1.63886925e+02  1.63886925e+02  5.25475276e+02  5.50187184e+02
  5.50187184e+02  5.50187184e+02  1.41262892e+03  1.41262892e+03
  1.41262892e+03  2.55558781e+03  3.10890413e+03  3.10890413e+03
  3.10890413e+03  6.72585912e+03  6.72585912e+03  6.72585912e+03
  8.95684754e+03  2.53198336e+04  7.60707819e+04]
E1 = -728.3337367596491  E_coul = 201.86396909247406
Extra cycle  E= -526.469767667175  delta_E= -3.41e-12  |g|= 1.89e-06  |ddm|= 3.65e-06
    CPU time for scf_cycle      0.69 sec, wall time      0.30 sec
exp = [2.61825622e+04 7.61779105e+03 3.61739780e+03 1.60423126e+03
 3.62991389e+02 1.02329651e+02 3.34000330e+01 4.58266157e+00
 3.93587210e-01 1.36276919e+03 6.64821358e+02 3.01348398e+02
 3.14401247e+02 7.81508967e+01 8.77318436e+00 2.51170007e+01
 8.50322681e-01 3.21401561e+00 2.38566350e-01]
E = -526.4697676671751
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:45:29 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5622294        1
[INPUT] 0    0    [1    /1   ]  7617.79105019        1
[INPUT] 0    0    [1    /1   ]  3617.39780281        1
[INPUT] 0    0    [1    /1   ]  1604.23126024        1
[INPUT] 0    0    [1    /1   ]  362.991388708        1
[INPUT] 0    0    [1    /1   ]  102.329651178        1
[INPUT] 0    0    [1    /1   ]  33.4000329651        1
[INPUT] 0    0    [1    /1   ]  4.58266156742        1
[INPUT] 0    0    [1    /1   ]  0.393587209815       1
[INPUT] 1    0    [1    /1   ]  1362.76919402        1
[INPUT] 1    0    [1    /1   ]  664.82135812         1
[INPUT] 1    0    [1    /1   ]  301.348397687        1
[INPUT] 1    0    [1    /1   ]  314.401247118        1
[INPUT] 1    0    [1    /1   ]  78.150896684         1
[INPUT] 1    0    [1    /1   ]  8.77318436162        1
[INPUT] 1    0    [1    /1   ]  25.1170006867        1
[INPUT] 1    0    [1    /1   ]  0.850322681377       1
[INPUT] 1    0    [1    /1   ]  3.21401560997        1
[INPUT] 1    0    [1    /1   ]  0.238566349945       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.562229444313, 1.0]], [0, [7617.7910501921115, 1.0]], [0, [3617.397802810595, 1.0]], [0, [1604.2312602394068, 1.0]], [0, [362.99138870793496, 1.0]], [0, [102.32965117843257, 1.0]], [0, [33.40003296509219, 1.0]], [0, [4.582661567415118, 1.0]], [0, [0.39358720981537687, 1.0]], [1, [1362.7691940221348, 1.0]], [1, [664.8213581199925, 1.0]], [1, [301.3483976874033, 1.0]], [1, [314.40124711810495, 1.0]], [1, [78.15089668395726, 1.0]], [1, [8.773184361622427, 1.0]], [1, [25.117000686669186, 1.0]], [1, [0.8503226813773586, 1.0]], [1, [3.214015609971779, 1.0]], [1, [0.23856634994510853, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.56222944]
bas 1, expnt(s) = [7617.79105019]
bas 2, expnt(s) = [3617.39780281]
bas 3, expnt(s) = [1604.23126024]
bas 4, expnt(s) = [362.99138871]
bas 5, expnt(s) = [102.32965118]
bas 6, expnt(s) = [33.40003297]
bas 7, expnt(s) = [4.58266157]
bas 8, expnt(s) = [0.39358721]
bas 9, expnt(s) = [1362.76919402]
bas 10, expnt(s) = [664.82135812]
bas 11, expnt(s) = [301.34839769]
bas 12, expnt(s) = [314.40124712]
bas 13, expnt(s) = [78.15089668]
bas 14, expnt(s) = [8.77318436]
bas 15, expnt(s) = [25.11700069]
bas 16, expnt(s) = [0.85032268]
bas 17, expnt(s) = [3.21401561]
bas 18, expnt(s) = [0.23856635]
CPU time:       758.22
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825622e+04 5.20024892e+03 7.61779105e+03 2.06009295e+03
 3.61739780e+03 1.17845289e+03 1.60423126e+03 6.40420544e+02
 3.62991389e+02 2.10105425e+02 1.02329651e+02 8.12860733e+01
 3.34000330e+01 3.51014612e+01 4.58266157e+00 7.91322225e+00
 3.93587210e-01 1.25543941e+00 1.36276919e+03 2.41552912e+04
 6.64821358e+02 9.84839812e+03 3.01348398e+02 3.66286153e+03
 3.14401247e+02 3.86224409e+03 7.81508967e+01 6.77878484e+02
 8.77318436e+00 4.40484836e+01 2.51170007e+01 1.64037867e+02
 8.50322681e-01 2.38212253e+00 3.21401561e+00 1.25543540e+01
 2.38566350e-01 4.86402586e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.973997139471578
cond(S) = 134609.29163483568
E1 = -728.8813128971065  E_coul = 203.10836965485584
init E= -525.772943242251
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559384539420992  LUMO = 1.16021860384601
  mo_energy =
[-1.18318160e+02 -1.21045272e+01 -9.44971033e+00 -9.44971033e+00
 -9.44971033e+00 -1.23075738e+00 -5.59384539e-01 -5.59384539e-01
 -5.59384539e-01  1.16021860e+00  1.16021860e+00  1.16021860e+00
  8.85447739e+00  8.85447739e+00  8.85447739e+00  4.20867026e+01
  4.20867026e+01  4.20867026e+01  6.99374400e+01  1.64057459e+02
  1.64057459e+02  1.64057459e+02  5.25741657e+02  5.50420602e+02
  5.50420602e+02  5.50420602e+02  1.41291635e+03  1.41291635e+03
  1.41291635e+03  2.55601020e+03  3.10925709e+03  3.10925709e+03
  3.10925709e+03  6.72632715e+03  6.72632715e+03  6.72632715e+03
  8.95739343e+03  2.53204744e+04  7.60715137e+04]
E1 = -728.0908702179274  E_coul = 201.6214929862223
cycle= 1 E= -526.469377231705  delta_E= -0.696  |g|= 0.184  |ddm|= 0.349
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.550618
diis-c [-0.30318064  1.        ]
  HOMO = -0.573430480606781  LUMO = 1.15022439450922
  mo_energy =
[-1.18591873e+02 -1.22012498e+01 -9.55299164e+00 -9.55299164e+00
 -9.55299164e+00 -1.25178134e+00 -5.73430481e-01 -5.73430481e-01
 -5.73430481e-01  1.15022439e+00  1.15022439e+00  1.15022439e+00
  8.79233042e+00  8.79233042e+00  8.79233042e+00  4.19605688e+01
  4.19605688e+01  4.19605688e+01  6.97770988e+01  1.63856051e+02
  1.63856051e+02  1.63856051e+02  5.25436665e+02  5.50150033e+02
  5.50150033e+02  5.50150033e+02  1.41258920e+03  1.41258920e+03
  1.41258920e+03  2.55554623e+03  3.10886306e+03  3.10886306e+03
  3.10886306e+03  6.72581728e+03  6.72581728e+03  6.72581728e+03
  8.95680543e+03  2.53197915e+04  7.60707398e+04]
E1 = -728.3867265293923  E_coul = 201.91697237474625
cycle= 2 E= -526.469754154646  delta_E= -0.000377  |g|= 0.0246  |ddm|= 0.02
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0477305
diis-c [-0.00146437  0.04937176  0.95062824]
  HOMO = -0.569823427834878  LUMO = 1.15340180362874
  mo_energy =
[-1.18549158e+02 -1.21810163e+01 -9.53235215e+00 -9.53235215e+00
 -9.53235215e+00 -1.24699306e+00 -5.69823428e-01 -5.69823428e-01
 -5.69823428e-01  1.15340180e+00  1.15340180e+00  1.15340180e+00
  8.80472660e+00  8.80472660e+00  8.80472660e+00  4.19843002e+01
  4.19843002e+01  4.19843002e+01  6.98104493e+01  1.63891303e+02
  1.63891303e+02  1.63891303e+02  5.25480604e+02  5.50192301e+02
  5.50192301e+02  5.50192301e+02  1.41263439e+03  1.41263439e+03
  1.41263439e+03  2.55559370e+03  3.10890986e+03  3.10890986e+03
  3.10890986e+03  6.72586510e+03  6.72586510e+03  6.72586510e+03
  8.95685367e+03  2.53198399e+04  7.60707883e+04]
E1 = -728.3256078108299  E_coul = 201.8558404369472
cycle= 3 E= -526.469767373883  delta_E= -1.32e-05  |g|= 0.00301  |ddm|= 0.00518
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00649288
diis-c [-3.77140713e-07 -1.09703194e-03  1.12968276e-01  8.88128756e-01]
  HOMO = -0.57047751924284  LUMO = 1.15284605708479
  mo_energy =
[-1.18554405e+02 -1.21838434e+01 -9.53528674e+00 -9.53528674e+00
 -9.53528674e+00 -1.24784069e+00 -5.70477519e-01 -5.70477519e-01
 -5.70477519e-01  1.15284606e+00  1.15284606e+00  1.15284606e+00
  8.80279704e+00  8.80279704e+00  8.80279704e+00  4.19810523e+01
  4.19810523e+01  4.19810523e+01  6.98063170e+01  1.63886849e+02
  1.63886849e+02  1.63886849e+02  5.25475205e+02  5.50187109e+02
  5.50187109e+02  5.50187109e+02  1.41262885e+03  1.41262885e+03
  1.41262885e+03  2.55558775e+03  3.10890406e+03  3.10890406e+03
  3.10890406e+03  6.72585906e+03  6.72585906e+03  6.72585906e+03
  8.95684749e+03  2.53198336e+04  7.60707819e+04]
E1 = -728.3339062168253  E_coul = 201.86413854978835
cycle= 4 E= -526.469767667037  delta_E= -2.93e-07  |g|= 4.23e-05  |ddm|= 0.00076
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.45244e-05
diis-c [-1.79107690e-09  6.77820222e-06 -1.68485758e-03 -7.48847424e-03
  1.00916655e+00]
  HOMO = -0.570450724389321  LUMO = 1.15286809849821
  mo_energy =
[-1.18554313e+02 -1.21837561e+01 -9.53520065e+00 -9.53520065e+00
 -9.53520065e+00 -1.24780580e+00 -5.70450724e-01 -5.70450724e-01
 -5.70450724e-01  1.15286810e+00  1.15286810e+00  1.15286810e+00
  8.80286294e+00  8.80286294e+00  8.80286294e+00  4.19811375e+01
  4.19811375e+01  4.19811375e+01  6.98064130e+01  1.63886942e+02
  1.63886942e+02  1.63886942e+02  5.25475295e+02  5.50187202e+02
  5.50187202e+02  5.50187202e+02  1.41262893e+03  1.41262893e+03
  1.41262893e+03  2.55558783e+03  3.10890415e+03  3.10890415e+03
  3.10890415e+03  6.72585913e+03  6.72585913e+03  6.72585913e+03
  8.95684756e+03  2.53198337e+04  7.60707819e+04]
E1 = -728.3337023132103  E_coul = 201.86393464603867
cycle= 5 E= -526.469767667172  delta_E= -1.35e-10  |g|= 7.43e-06  |ddm|= 2.37e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3337023132103  E_coul = 201.86393464603867
  HOMO = -0.570454476817705  LUMO = 1.15286499027095
  mo_energy =
[-1.18554331e+02 -1.21837693e+01 -9.53521407e+00 -9.53521407e+00
 -9.53521407e+00 -1.24781066e+00 -5.70454477e-01 -5.70454477e-01
 -5.70454477e-01  1.15286499e+00  1.15286499e+00  1.15286499e+00
  8.80285319e+00  8.80285319e+00  8.80285319e+00  4.19811236e+01
  4.19811236e+01  4.19811236e+01  6.98063970e+01  1.63886925e+02
  1.63886925e+02  1.63886925e+02  5.25475276e+02  5.50187184e+02
  5.50187184e+02  5.50187184e+02  1.41262892e+03  1.41262892e+03
  1.41262892e+03  2.55558781e+03  3.10890413e+03  3.10890413e+03
  3.10890413e+03  6.72585912e+03  6.72585912e+03  6.72585912e+03
  8.95684754e+03  2.53198336e+04  7.60707819e+04]
E1 = -728.3337367596491  E_coul = 201.86396909247406
Extra cycle  E= -526.469767667175  delta_E= -3.41e-12  |g|= 1.89e-06  |ddm|= 3.65e-06
    CPU time for scf_cycle      0.69 sec, wall time      0.31 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 134609.29163483568
E1 = -728.3337367596491  E_coul = 201.86396909247406
init E= -526.469767667175
    CPU time for initialize scf      2.89 sec, wall time      0.27 sec
  HOMO = -0.570453836550147  LUMO = 1.15286552837922
  mo_energy =
[-1.18554327e+02 -1.21837667e+01 -9.53521147e+00 -9.53521147e+00
 -9.53521147e+00 -1.24780983e+00 -5.70453837e-01 -5.70453837e-01
 -5.70453837e-01  1.15286553e+00  1.15286553e+00  1.15286553e+00
  8.80285497e+00  8.80285497e+00  8.80285497e+00  4.19811264e+01
  4.19811264e+01  4.19811264e+01  6.98064004e+01  1.63886929e+02
  1.63886929e+02  1.63886929e+02  5.25475281e+02  5.50187188e+02
  5.50187188e+02  5.50187188e+02  1.41262892e+03  1.41262892e+03
  1.41262892e+03  2.55558781e+03  3.10890413e+03  3.10890413e+03
  3.10890413e+03  6.72585912e+03  6.72585912e+03  6.72585912e+03
  8.95684755e+03  2.53198336e+04  7.60707819e+04]
E1 = -728.3337297450937  E_coul = 201.86396207791904
cycle= 1 E= -526.469767667175  delta_E= 4.55e-13  |g|= 4.2e-07  |ddm|= 6.84e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3337297450937  E_coul = 201.86396207791904
  HOMO = -0.570453959072653  LUMO = 1.15286542474994
  mo_energy =
[-1.18554328e+02 -1.21837672e+01 -9.53521200e+00 -9.53521200e+00
 -9.53521200e+00 -1.24780999e+00 -5.70453959e-01 -5.70453959e-01
 -5.70453959e-01  1.15286542e+00  1.15286542e+00  1.15286542e+00
  8.80285462e+00  8.80285462e+00  8.80285462e+00  4.19811258e+01
  4.19811258e+01  4.19811258e+01  6.98063997e+01  1.63886928e+02
  1.63886928e+02  1.63886928e+02  5.25475280e+02  5.50187187e+02
  5.50187187e+02  5.50187187e+02  1.41262892e+03  1.41262892e+03
  1.41262892e+03  2.55558781e+03  3.10890413e+03  3.10890413e+03
  3.10890413e+03  6.72585912e+03  6.72585912e+03  6.72585912e+03
  8.95684754e+03  2.53198336e+04  7.60707819e+04]
E1 = -728.3337311965676  E_coul = 201.86396352939286
Extra cycle  E= -526.469767667175  delta_E=    0  |g|= 8.99e-08  |ddm|= 1.37e-07
    CPU time for scf_cycle      3.04 sec, wall time      0.42 sec
exp = [2.61825622e+04 7.61779105e+03 3.61739780e+03 1.60423126e+03
 3.62991389e+02 1.02329651e+02 3.34000330e+01 4.58266157e+00
 3.93587210e-01 1.36276919e+03 6.64821358e+02 3.01348398e+02
 3.14401247e+02 7.81508967e+01 8.77318436e+00 2.51170007e+01
 8.50322681e-01 3.21401561e+00 2.38566350e-01]
grad_E = [-1.61068604e-06  4.53697642e-06 -1.81401919e-07  1.07418770e-04
 -3.01292328e-04  4.10468873e-04 -1.22856417e-03  4.51259280e-03
 -1.66016174e-02 -5.32696137e-07  2.57007496e-07 -3.32817436e-07
 -1.54998530e-07  3.90963654e-04  2.86105831e-03 -2.55849932e-04
  3.93625570e-02 -8.77113342e-03 -4.38426574e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:45:34 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5902225        1
[INPUT] 0    0    [1    /1   ]  7617.73497891        1
[INPUT] 0    0    [1    /1   ]  3617.45167358        1
[INPUT] 0    0    [1    /1   ]  1603.14702412        1
[INPUT] 0    0    [1    /1   ]  359.542837152        1
[INPUT] 0    0    [1    /1   ]  101.343293701        1
[INPUT] 0    0    [1    /1   ]  33.1196963667        1
[INPUT] 0    0    [1    /1   ]  4.5839194996         1
[INPUT] 0    0    [1    /1   ]  0.392820352321       1
[INPUT] 1    0    [1    /1   ]  1362.77550259        1
[INPUT] 1    0    [1    /1   ]  664.837361589        1
[INPUT] 1    0    [1    /1   ]  301.437290397        1
[INPUT] 1    0    [1    /1   ]  314.471727739        1
[INPUT] 1    0    [1    /1   ]  68.7799381569        1
[INPUT] 1    0    [1    /1   ]  8.16782055632        1
[INPUT] 1    0    [1    /1   ]  22.8621792447        1
[INPUT] 1    0    [1    /1   ]  0.852043854836       1
[INPUT] 1    0    [1    /1   ]  3.04136584766        1
[INPUT] 1    0    [1    /1   ]  0.23857072658        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.59022252476, 1.0]], [0, [7617.734978914549, 1.0]], [0, [3617.451673577136, 1.0]], [0, [1603.1470241243674, 1.0]], [0, [359.5428371516651, 1.0]], [0, [101.34329370124145, 1.0]], [0, [33.11969636673962, 1.0]], [0, [4.583919499598562, 1.0]], [0, [0.3928203523210848, 1.0]], [1, [1362.7755025924362, 1.0]], [1, [664.8373615891574, 1.0]], [1, [301.43729039734336, 1.0]], [1, [314.4717277388598, 1.0]], [1, [68.77993815690337, 1.0]], [1, [8.16782055631761, 1.0]], [1, [22.862179244714984, 1.0]], [1, [0.8520438548363596, 1.0]], [1, [3.0413658476584935, 1.0]], [1, [0.23857072658029613, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.59022252]
bas 1, expnt(s) = [7617.73497891]
bas 2, expnt(s) = [3617.45167358]
bas 3, expnt(s) = [1603.14702412]
bas 4, expnt(s) = [359.54283715]
bas 5, expnt(s) = [101.3432937]
bas 6, expnt(s) = [33.11969637]
bas 7, expnt(s) = [4.5839195]
bas 8, expnt(s) = [0.39282035]
bas 9, expnt(s) = [1362.77550259]
bas 10, expnt(s) = [664.83736159]
bas 11, expnt(s) = [301.4372904]
bas 12, expnt(s) = [314.47172774]
bas 13, expnt(s) = [68.77993816]
bas 14, expnt(s) = [8.16782056]
bas 15, expnt(s) = [22.86217924]
bas 16, expnt(s) = [0.85204385]
bas 17, expnt(s) = [3.04136585]
bas 18, expnt(s) = [0.23857073]
CPU time:       766.77
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825902e+04 5.20025309e+03 7.61773498e+03 2.06008158e+03
 3.61745167e+03 1.17846606e+03 1.60314702e+03 6.40095891e+02
 3.59542837e+02 2.08606581e+02 1.01343294e+02 8.06977239e+01
 3.31196964e+01 3.48802657e+01 4.58391950e+00 7.91485132e+00
 3.92820352e-01 1.25360441e+00 1.36277550e+03 2.41554310e+04
 6.64837362e+02 9.84869446e+03 3.01437290e+02 3.66421218e+03
 3.14471728e+02 3.86332639e+03 6.87799382e+01 5.77845345e+02
 8.16782056e+00 4.02825660e+01 2.28621792e+01 1.45841601e+02
 8.52043855e-01 2.38815125e+00 3.04136585e+00 1.17171024e+01
 2.38570727e-01 4.86413740e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97411643466777
cond(S) = 115338.01715815817
E1 = -728.8791417819989  E_coul = 203.09992363527562
init E= -525.779218146723
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559830535878069  LUMO = 1.15947109250023
  mo_energy =
[-1.18318300e+02 -1.21050053e+01 -9.45061981e+00 -9.45061981e+00
 -9.45061981e+00 -1.23106403e+00 -5.59830536e-01 -5.59830536e-01
 -5.59830536e-01  1.15947109e+00  1.15947109e+00  1.15947109e+00
  8.34722516e+00  8.34722516e+00  8.34722516e+00  3.84030474e+01
  3.84030474e+01  3.84030474e+01  6.90299882e+01  1.46873755e+02
  1.46873755e+02  1.46873755e+02  5.15775047e+02  5.15775047e+02
  5.15775047e+02  5.19778725e+02  1.37225220e+03  1.37225220e+03
  1.37225220e+03  2.54142147e+03  3.06784920e+03  3.06784920e+03
  3.06784920e+03  6.68714900e+03  6.68714900e+03  6.68714900e+03
  8.93852351e+03  2.53001582e+04  7.60515969e+04]
E1 = -728.0885668607671  E_coul = 201.61765086359003
cycle= 1 E= -526.470915997177  delta_E= -0.692  |g|= 0.184  |ddm|= 0.302
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.549534
diis-c [-0.30198779  1.        ]
  HOMO = -0.574130842718634  LUMO = 1.14938079585078
  mo_energy =
[-1.18591005e+02 -1.22011952e+01 -9.55334775e+00 -9.55334775e+00
 -9.55334775e+00 -1.25222489e+00 -5.74130843e-01 -5.74130843e-01
 -5.74130843e-01  1.14938080e+00  1.14938080e+00  1.14938080e+00
  8.28836826e+00  8.28836826e+00  8.28836826e+00  3.82836690e+01
  3.82836690e+01  3.82836690e+01  6.88709887e+01  1.46679881e+02
  1.46679881e+02  1.46679881e+02  5.15506367e+02  5.15506367e+02
  5.15506367e+02  5.19475495e+02  1.37192523e+03  1.37192523e+03
  1.37192523e+03  2.54095841e+03  3.06745526e+03  3.06745526e+03
  3.06745526e+03  6.68663929e+03  6.68663929e+03  6.68663929e+03
  8.93793589e+03  2.52994755e+04  7.60508233e+04]
E1 = -728.3845473884676  E_coul = 201.91325392882732
cycle= 2 E= -526.47129345964  delta_E= -0.000377  |g|= 0.0246  |ddm|= 0.0197
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0481214
diis-c [-0.00148882  0.04984118  0.95015882]
  HOMO = -0.570554676055169  LUMO = 1.15251006861577
  mo_energy =
[-1.18548247e+02 -1.21809446e+01 -9.53268909e+00 -9.53268909e+00
 -9.53268909e+00 -1.24747297e+00 -5.70554676e-01 -5.70554676e-01
 -5.70554676e-01  1.15251007e+00  1.15251007e+00  1.15251007e+00
  8.30014525e+00  8.30014525e+00  8.30014525e+00  3.83063752e+01
  3.83063752e+01  3.83063752e+01  6.89042456e+01  1.46714240e+02
  1.46714240e+02  1.46714240e+02  5.15548579e+02  5.15548579e+02
  5.15548579e+02  5.19519430e+02  1.37197050e+03  1.37197050e+03
  1.37197050e+03  2.54100592e+03  3.06750213e+03  3.06750213e+03
  3.06750213e+03  6.68668717e+03  6.68668717e+03  6.68668717e+03
  8.93798419e+03  2.52995240e+04  7.60508718e+04]
E1 = -728.323047465522  E_coul = 201.85174066966113
cycle= 3 E= -526.471306795861  delta_E= -1.33e-05  |g|= 0.00302  |ddm|= 0.00519
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00654433
diis-c [-3.90563553e-07 -1.09556717e-03  1.13016934e-01  8.88078633e-01]
  HOMO = -0.571214085874825  LUMO = 1.15195331178087
  mo_energy =
[-1.18553513e+02 -1.21837852e+01 -9.53563764e+00 -9.53563764e+00
 -9.53563764e+00 -1.24832605e+00 -5.71214086e-01 -5.71214086e-01
 -5.71214086e-01  1.15195331e+00  1.15195331e+00  1.15195331e+00
  8.29828082e+00  8.29828082e+00  8.29828082e+00  3.83032261e+01
  3.83032261e+01  3.83032261e+01  6.89001094e+01  1.46709864e+02
  1.46709864e+02  1.46709864e+02  5.15543380e+02  5.15543380e+02
  5.15543380e+02  5.19514018e+02  1.37196493e+03  1.37196493e+03
  1.37196493e+03  2.54099994e+03  3.06749631e+03  3.06749631e+03
  3.06749631e+03  6.68668110e+03  6.68668110e+03  6.68668110e+03
  8.93797798e+03  2.52995177e+04  7.60508654e+04]
E1 = -728.3314267874731  E_coul = 201.86011969380962
cycle= 4 E= -526.471307093663  delta_E= -2.98e-07  |g|= 4.38e-05  |ddm|= 0.00076
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=5.76587e-05
diis-c [-1.87100493e-09  4.96839328e-06 -1.50166351e-03 -5.48516952e-03
  1.00698186e+00]
  HOMO = -0.571186883466373  LUMO = 1.15197556026269
  mo_energy =
[-1.18553417e+02 -1.21836955e+01 -9.53554914e+00 -9.53554914e+00
 -9.53554914e+00 -1.24829057e+00 -5.71186883e-01 -5.71186883e-01
 -5.71186883e-01  1.15197556e+00  1.15197556e+00  1.15197556e+00
  8.29834642e+00  8.29834642e+00  8.29834642e+00  3.83033126e+01
  3.83033126e+01  3.83033126e+01  6.89002081e+01  1.46709959e+02
  1.46709959e+02  1.46709959e+02  5.15543475e+02  5.15543475e+02
  5.15543475e+02  5.19514110e+02  1.37196502e+03  1.37196502e+03
  1.37196502e+03  2.54100003e+03  3.06749640e+03  3.06749640e+03
  3.06749640e+03  6.68668118e+03  6.68668118e+03  6.68668118e+03
  8.93797806e+03  2.52995178e+04  7.60508654e+04]
E1 = -728.3312150634297  E_coul = 201.85990796962196
cycle= 5 E= -526.471307093808  delta_E= -1.44e-10  |g|= 7.5e-06  |ddm|= 2.46e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3312150634297  E_coul = 201.85990796962196
  HOMO = -0.571190669454765  LUMO = 1.15197244139279
  mo_energy =
[-1.18553435e+02 -1.21837088e+01 -9.53556266e+00 -9.53556266e+00
 -9.53556266e+00 -1.24829546e+00 -5.71190669e-01 -5.71190669e-01
 -5.71190669e-01  1.15197244e+00  1.15197244e+00  1.15197244e+00
  8.29833689e+00  8.29833689e+00  8.29833689e+00  3.83032989e+01
  3.83032989e+01  3.83032989e+01  6.89001920e+01  1.46709942e+02
  1.46709942e+02  1.46709942e+02  5.15543457e+02  5.15543457e+02
  5.15543457e+02  5.19514092e+02  1.37196500e+03  1.37196500e+03
  1.37196500e+03  2.54100001e+03  3.06749638e+03  3.06749638e+03
  3.06749638e+03  6.68668116e+03  6.68668116e+03  6.68668116e+03
  8.93797804e+03  2.52995178e+04  7.60508654e+04]
E1 = -728.3312499821727  E_coul = 201.85994288836307
Extra cycle  E= -526.47130709381  delta_E= -1.93e-12  |g|= 1.92e-06  |ddm|= 3.66e-06
    CPU time for scf_cycle      0.70 sec, wall time      0.31 sec
exp = [2.61825902e+04 7.61773498e+03 3.61745167e+03 1.60314702e+03
 3.59542837e+02 1.01343294e+02 3.31196964e+01 4.58391950e+00
 3.92820352e-01 1.36277550e+03 6.64837362e+02 3.01437290e+02
 3.14471728e+02 6.87799382e+01 8.16782056e+00 2.28621792e+01
 8.52043855e-01 3.04136585e+00 2.38570727e-01]
E = -526.4713070938096
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:45:35 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.5902225        1
[INPUT] 0    0    [1    /1   ]  7617.73497891        1
[INPUT] 0    0    [1    /1   ]  3617.45167358        1
[INPUT] 0    0    [1    /1   ]  1603.14702412        1
[INPUT] 0    0    [1    /1   ]  359.542837152        1
[INPUT] 0    0    [1    /1   ]  101.343293701        1
[INPUT] 0    0    [1    /1   ]  33.1196963667        1
[INPUT] 0    0    [1    /1   ]  4.5839194996         1
[INPUT] 0    0    [1    /1   ]  0.392820352321       1
[INPUT] 1    0    [1    /1   ]  1362.77550259        1
[INPUT] 1    0    [1    /1   ]  664.837361589        1
[INPUT] 1    0    [1    /1   ]  301.437290397        1
[INPUT] 1    0    [1    /1   ]  314.471727739        1
[INPUT] 1    0    [1    /1   ]  68.7799381569        1
[INPUT] 1    0    [1    /1   ]  8.16782055632        1
[INPUT] 1    0    [1    /1   ]  22.8621792447        1
[INPUT] 1    0    [1    /1   ]  0.852043854836       1
[INPUT] 1    0    [1    /1   ]  3.04136584766        1
[INPUT] 1    0    [1    /1   ]  0.23857072658        1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.59022252476, 1.0]], [0, [7617.734978914549, 1.0]], [0, [3617.451673577136, 1.0]], [0, [1603.1470241243674, 1.0]], [0, [359.5428371516651, 1.0]], [0, [101.34329370124145, 1.0]], [0, [33.11969636673962, 1.0]], [0, [4.583919499598562, 1.0]], [0, [0.3928203523210848, 1.0]], [1, [1362.7755025924362, 1.0]], [1, [664.8373615891574, 1.0]], [1, [301.43729039734336, 1.0]], [1, [314.4717277388598, 1.0]], [1, [68.77993815690337, 1.0]], [1, [8.16782055631761, 1.0]], [1, [22.862179244714984, 1.0]], [1, [0.8520438548363596, 1.0]], [1, [3.0413658476584935, 1.0]], [1, [0.23857072658029613, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.59022252]
bas 1, expnt(s) = [7617.73497891]
bas 2, expnt(s) = [3617.45167358]
bas 3, expnt(s) = [1603.14702412]
bas 4, expnt(s) = [359.54283715]
bas 5, expnt(s) = [101.3432937]
bas 6, expnt(s) = [33.11969637]
bas 7, expnt(s) = [4.5839195]
bas 8, expnt(s) = [0.39282035]
bas 9, expnt(s) = [1362.77550259]
bas 10, expnt(s) = [664.83736159]
bas 11, expnt(s) = [301.4372904]
bas 12, expnt(s) = [314.47172774]
bas 13, expnt(s) = [68.77993816]
bas 14, expnt(s) = [8.16782056]
bas 15, expnt(s) = [22.86217924]
bas 16, expnt(s) = [0.85204385]
bas 17, expnt(s) = [3.04136585]
bas 18, expnt(s) = [0.23857073]
CPU time:       767.73
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61825902e+04 5.20025309e+03 7.61773498e+03 2.06008158e+03
 3.61745167e+03 1.17846606e+03 1.60314702e+03 6.40095891e+02
 3.59542837e+02 2.08606581e+02 1.01343294e+02 8.06977239e+01
 3.31196964e+01 3.48802657e+01 4.58391950e+00 7.91485132e+00
 3.92820352e-01 1.25360441e+00 1.36277550e+03 2.41554310e+04
 6.64837362e+02 9.84869446e+03 3.01437290e+02 3.66421218e+03
 3.14471728e+02 3.86332639e+03 6.87799382e+01 5.77845345e+02
 8.16782056e+00 4.02825660e+01 2.28621792e+01 1.45841601e+02
 8.52043855e-01 2.38815125e+00 3.04136585e+00 1.17171024e+01
 2.38570727e-01 4.86413740e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97411643466777
cond(S) = 115338.01715815817
E1 = -728.8791417819989  E_coul = 203.09992363527562
init E= -525.779218146723
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559830535878069  LUMO = 1.15947109250023
  mo_energy =
[-1.18318300e+02 -1.21050053e+01 -9.45061981e+00 -9.45061981e+00
 -9.45061981e+00 -1.23106403e+00 -5.59830536e-01 -5.59830536e-01
 -5.59830536e-01  1.15947109e+00  1.15947109e+00  1.15947109e+00
  8.34722516e+00  8.34722516e+00  8.34722516e+00  3.84030474e+01
  3.84030474e+01  3.84030474e+01  6.90299882e+01  1.46873755e+02
  1.46873755e+02  1.46873755e+02  5.15775047e+02  5.15775047e+02
  5.15775047e+02  5.19778725e+02  1.37225220e+03  1.37225220e+03
  1.37225220e+03  2.54142147e+03  3.06784920e+03  3.06784920e+03
  3.06784920e+03  6.68714900e+03  6.68714900e+03  6.68714900e+03
  8.93852351e+03  2.53001582e+04  7.60515969e+04]
E1 = -728.0885668607671  E_coul = 201.61765086359003
cycle= 1 E= -526.470915997177  delta_E= -0.692  |g|= 0.184  |ddm|= 0.302
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.549534
diis-c [-0.30198779  1.        ]
  HOMO = -0.574130842718634  LUMO = 1.14938079585078
  mo_energy =
[-1.18591005e+02 -1.22011952e+01 -9.55334775e+00 -9.55334775e+00
 -9.55334775e+00 -1.25222489e+00 -5.74130843e-01 -5.74130843e-01
 -5.74130843e-01  1.14938080e+00  1.14938080e+00  1.14938080e+00
  8.28836826e+00  8.28836826e+00  8.28836826e+00  3.82836690e+01
  3.82836690e+01  3.82836690e+01  6.88709887e+01  1.46679881e+02
  1.46679881e+02  1.46679881e+02  5.15506367e+02  5.15506367e+02
  5.15506367e+02  5.19475495e+02  1.37192523e+03  1.37192523e+03
  1.37192523e+03  2.54095841e+03  3.06745526e+03  3.06745526e+03
  3.06745526e+03  6.68663929e+03  6.68663929e+03  6.68663929e+03
  8.93793589e+03  2.52994755e+04  7.60508233e+04]
E1 = -728.3845473884676  E_coul = 201.91325392882732
cycle= 2 E= -526.47129345964  delta_E= -0.000377  |g|= 0.0246  |ddm|= 0.0197
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0481214
diis-c [-0.00148882  0.04984118  0.95015882]
  HOMO = -0.570554676055169  LUMO = 1.15251006861577
  mo_energy =
[-1.18548247e+02 -1.21809446e+01 -9.53268909e+00 -9.53268909e+00
 -9.53268909e+00 -1.24747297e+00 -5.70554676e-01 -5.70554676e-01
 -5.70554676e-01  1.15251007e+00  1.15251007e+00  1.15251007e+00
  8.30014525e+00  8.30014525e+00  8.30014525e+00  3.83063752e+01
  3.83063752e+01  3.83063752e+01  6.89042456e+01  1.46714240e+02
  1.46714240e+02  1.46714240e+02  5.15548579e+02  5.15548579e+02
  5.15548579e+02  5.19519430e+02  1.37197050e+03  1.37197050e+03
  1.37197050e+03  2.54100592e+03  3.06750213e+03  3.06750213e+03
  3.06750213e+03  6.68668717e+03  6.68668717e+03  6.68668717e+03
  8.93798419e+03  2.52995240e+04  7.60508718e+04]
E1 = -728.323047465522  E_coul = 201.85174066966113
cycle= 3 E= -526.471306795861  delta_E= -1.33e-05  |g|= 0.00302  |ddm|= 0.00519
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00654433
diis-c [-3.90563553e-07 -1.09556717e-03  1.13016934e-01  8.88078633e-01]
  HOMO = -0.571214085874825  LUMO = 1.15195331178087
  mo_energy =
[-1.18553513e+02 -1.21837852e+01 -9.53563764e+00 -9.53563764e+00
 -9.53563764e+00 -1.24832605e+00 -5.71214086e-01 -5.71214086e-01
 -5.71214086e-01  1.15195331e+00  1.15195331e+00  1.15195331e+00
  8.29828082e+00  8.29828082e+00  8.29828082e+00  3.83032261e+01
  3.83032261e+01  3.83032261e+01  6.89001094e+01  1.46709864e+02
  1.46709864e+02  1.46709864e+02  5.15543380e+02  5.15543380e+02
  5.15543380e+02  5.19514018e+02  1.37196493e+03  1.37196493e+03
  1.37196493e+03  2.54099994e+03  3.06749631e+03  3.06749631e+03
  3.06749631e+03  6.68668110e+03  6.68668110e+03  6.68668110e+03
  8.93797798e+03  2.52995177e+04  7.60508654e+04]
E1 = -728.3314267874731  E_coul = 201.86011969380962
cycle= 4 E= -526.471307093663  delta_E= -2.98e-07  |g|= 4.38e-05  |ddm|= 0.00076
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.76587e-05
diis-c [-1.87100493e-09  4.96839328e-06 -1.50166351e-03 -5.48516952e-03
  1.00698186e+00]
  HOMO = -0.571186883466373  LUMO = 1.15197556026269
  mo_energy =
[-1.18553417e+02 -1.21836955e+01 -9.53554914e+00 -9.53554914e+00
 -9.53554914e+00 -1.24829057e+00 -5.71186883e-01 -5.71186883e-01
 -5.71186883e-01  1.15197556e+00  1.15197556e+00  1.15197556e+00
  8.29834642e+00  8.29834642e+00  8.29834642e+00  3.83033126e+01
  3.83033126e+01  3.83033126e+01  6.89002081e+01  1.46709959e+02
  1.46709959e+02  1.46709959e+02  5.15543475e+02  5.15543475e+02
  5.15543475e+02  5.19514110e+02  1.37196502e+03  1.37196502e+03
  1.37196502e+03  2.54100003e+03  3.06749640e+03  3.06749640e+03
  3.06749640e+03  6.68668118e+03  6.68668118e+03  6.68668118e+03
  8.93797806e+03  2.52995178e+04  7.60508654e+04]
E1 = -728.3312150634297  E_coul = 201.85990796962196
cycle= 5 E= -526.471307093808  delta_E= -1.44e-10  |g|= 7.5e-06  |ddm|= 2.46e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3312150634297  E_coul = 201.85990796962196
  HOMO = -0.571190669454765  LUMO = 1.15197244139279
  mo_energy =
[-1.18553435e+02 -1.21837088e+01 -9.53556266e+00 -9.53556266e+00
 -9.53556266e+00 -1.24829546e+00 -5.71190669e-01 -5.71190669e-01
 -5.71190669e-01  1.15197244e+00  1.15197244e+00  1.15197244e+00
  8.29833689e+00  8.29833689e+00  8.29833689e+00  3.83032989e+01
  3.83032989e+01  3.83032989e+01  6.89001920e+01  1.46709942e+02
  1.46709942e+02  1.46709942e+02  5.15543457e+02  5.15543457e+02
  5.15543457e+02  5.19514092e+02  1.37196500e+03  1.37196500e+03
  1.37196500e+03  2.54100001e+03  3.06749638e+03  3.06749638e+03
  3.06749638e+03  6.68668116e+03  6.68668116e+03  6.68668116e+03
  8.93797804e+03  2.52995178e+04  7.60508654e+04]
E1 = -728.3312499821727  E_coul = 201.85994288836307
Extra cycle  E= -526.47130709381  delta_E= -1.93e-12  |g|= 1.92e-06  |ddm|= 3.66e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 115338.01715815817
E1 = -728.3312499821727  E_coul = 201.85994288836307
init E= -526.47130709381
    CPU time for initialize scf      2.75 sec, wall time      0.26 sec
  HOMO = -0.571190021079024  LUMO = 1.15197298301254
  mo_energy =
[-1.18553431e+02 -1.21837062e+01 -9.53556002e+00 -9.53556002e+00
 -9.53556002e+00 -1.24829462e+00 -5.71190021e-01 -5.71190021e-01
 -5.71190021e-01  1.15197298e+00  1.15197298e+00  1.15197298e+00
  8.29833863e+00  8.29833863e+00  8.29833863e+00  3.83033017e+01
  3.83033017e+01  3.83033017e+01  6.89001955e+01  1.46709946e+02
  1.46709946e+02  1.46709946e+02  5.15543461e+02  5.15543461e+02
  5.15543461e+02  5.19514096e+02  1.37196501e+03  1.37196501e+03
  1.37196501e+03  2.54100001e+03  3.06749639e+03  3.06749639e+03
  3.06749639e+03  6.68668117e+03  6.68668117e+03  6.68668117e+03
  8.93797804e+03  2.52995178e+04  7.60508654e+04]
E1 = -728.3312428269287  E_coul = 201.8599357331192
cycle= 1 E= -526.47130709381  delta_E= 1.14e-13  |g|= 4.29e-07  |ddm|= 6.92e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3312428269287  E_coul = 201.8599357331192
  HOMO = -0.57119014606813  LUMO = 1.15197287794871
  mo_energy =
[-1.18553432e+02 -1.21837067e+01 -9.53556056e+00 -9.53556056e+00
 -9.53556056e+00 -1.24829478e+00 -5.71190146e-01 -5.71190146e-01
 -5.71190146e-01  1.15197288e+00  1.15197288e+00  1.15197288e+00
  8.29833829e+00  8.29833829e+00  8.29833829e+00  3.83033011e+01
  3.83033011e+01  3.83033011e+01  6.89001947e+01  1.46709945e+02
  1.46709945e+02  1.46709945e+02  5.15543460e+02  5.15543460e+02
  5.15543460e+02  5.19514095e+02  1.37196501e+03  1.37196501e+03
  1.37196501e+03  2.54100001e+03  3.06749638e+03  3.06749638e+03
  3.06749638e+03  6.68668117e+03  6.68668117e+03  6.68668117e+03
  8.93797804e+03  2.52995178e+04  7.60508654e+04]
E1 = -728.3312443160287  E_coul = 201.8599372222174
Extra cycle  E= -526.471307093811  delta_E= -1.71e-12  |g|= 9.22e-08  |ddm|= 1.4e-07
    CPU time for scf_cycle      2.90 sec, wall time      0.41 sec
exp = [2.61825902e+04 7.61773498e+03 3.61745167e+03 1.60314702e+03
 3.59542837e+02 1.01343294e+02 3.31196964e+01 4.58391950e+00
 3.92820352e-01 1.36277550e+03 6.64837362e+02 3.01437290e+02
 3.14471728e+02 6.87799382e+01 8.16782056e+00 2.28621792e+01
 8.52043855e-01 3.04136585e+00 2.38570727e-01]
grad_E = [-1.62700028e-06  4.77201756e-06  9.74453791e-08  1.15451267e-04
 -3.85312180e-04  6.31865281e-04 -1.78948155e-03  6.66211066e-03
 -2.79797513e-02 -6.68794401e-07  2.15805451e-06  8.57504398e-06
  7.28667110e-06  8.92619855e-05  1.99108486e-03  4.69044337e-04
  6.06825487e-02 -9.25555744e-03 -7.17025096e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:45:39 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6103955        1
[INPUT] 0    0    [1    /1   ]  7617.67831164        1
[INPUT] 0    0    [1    /1   ]  3617.44607302        1
[INPUT] 0    0    [1    /1   ]  1601.81323756        1
[INPUT] 0    0    [1    /1   ]  363.22906834         1
[INPUT] 0    0    [1    /1   ]  102.479741438        1
[INPUT] 0    0    [1    /1   ]  33.3758619953        1
[INPUT] 0    0    [1    /1   ]  4.58554926281        1
[INPUT] 0    0    [1    /1   ]  0.39251408396        1
[INPUT] 1    0    [1    /1   ]  1362.77832879        1
[INPUT] 1    0    [1    /1   ]  664.830416438        1
[INPUT] 1    0    [1    /1   ]  301.399601904        1
[INPUT] 1    0    [1    /1   ]  314.433237138        1
[INPUT] 1    0    [1    /1   ]  64.4546251935        1
[INPUT] 1    0    [1    /1   ]  7.70369075561        1
[INPUT] 1    0    [1    /1   ]  21.2707448852        1
[INPUT] 1    0    [1    /1   ]  0.843926033828       1
[INPUT] 1    0    [1    /1   ]  2.91143586212        1
[INPUT] 1    0    [1    /1   ]  0.236931651721       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.610395471314, 1.0]], [0, [7617.67831164222, 1.0]], [0, [3617.4460730208402, 1.0]], [0, [1601.813237561833, 1.0]], [0, [363.22906834017715, 1.0]], [0, [102.47974143753564, 1.0]], [0, [33.37586199525157, 1.0]], [0, [4.585549262805151, 1.0]], [0, [0.3925140839600677, 1.0]], [1, [1362.7783287884297, 1.0]], [1, [664.8304164377009, 1.0]], [1, [301.39960190408476, 1.0]], [1, [314.43323713848116, 1.0]], [1, [64.45462519347407, 1.0]], [1, [7.703690755609526, 1.0]], [1, [21.270744885160717, 1.0]], [1, [0.8439260338283625, 1.0]], [1, [2.9114358621185215, 1.0]], [1, [0.2369316517212446, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.61039547]
bas 1, expnt(s) = [7617.67831164]
bas 2, expnt(s) = [3617.44607302]
bas 3, expnt(s) = [1601.81323756]
bas 4, expnt(s) = [363.22906834]
bas 5, expnt(s) = [102.47974144]
bas 6, expnt(s) = [33.375862]
bas 7, expnt(s) = [4.58554926]
bas 8, expnt(s) = [0.39251408]
bas 9, expnt(s) = [1362.77832879]
bas 10, expnt(s) = [664.83041644]
bas 11, expnt(s) = [301.3996019]
bas 12, expnt(s) = [314.43323714]
bas 13, expnt(s) = [64.45462519]
bas 14, expnt(s) = [7.70369076]
bas 15, expnt(s) = [21.27074489]
bas 16, expnt(s) = [0.84392603]
bas 17, expnt(s) = [2.91143586]
bas 18, expnt(s) = [0.23693165]
CPU time:       776.14
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826104e+04 5.20025610e+03 7.61767831e+03 2.06007009e+03
 3.61744607e+03 1.17846469e+03 1.60181324e+03 6.39696439e+02
 3.63229068e+02 2.10208596e+02 1.02479741e+02 8.13754756e+01
 3.33758620e+01 3.50824078e+01 4.58554926e+00 7.91696175e+00
 3.92514084e-01 1.25287129e+00 1.36277833e+03 2.41554936e+04
 6.64830416e+02 9.84856585e+03 3.01399602e+02 3.66363952e+03
 3.14433237e+02 3.86273532e+03 6.44546252e+01 5.32785015e+02
 7.70369076e+00 3.74419056e+01 2.12707449e+01 1.33263976e+02
 8.43926034e-01 2.35974391e+00 2.91143586e+00 1.10947731e+01
 2.36931652e-01 4.82240016e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.974505290279254
cond(S) = 106473.57707162321
E1 = -728.8714143839288  E_coul = 203.09413993957244
init E= -525.777274444356
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.560098854434999  LUMO = 1.14390918455075
  mo_energy =
[-1.18319730e+02 -1.21051828e+01 -9.45106520e+00 -9.45106520e+00
 -9.45106520e+00 -1.23117922e+00 -5.60098854e-01 -5.60098854e-01
 -5.60098854e-01  1.14390918e+00  1.14390918e+00  1.14390918e+00
  7.94092277e+00  7.94092277e+00  7.94092277e+00  3.57174891e+01
  3.57174891e+01  3.57174891e+01  6.99548829e+01  1.36468781e+02
  1.36468781e+02  1.36468781e+02  4.96760540e+02  4.96760540e+02
  4.96760540e+02  5.26182302e+02  1.35084583e+03  1.35084583e+03
  1.35084583e+03  2.55568047e+03  3.04626659e+03  3.04626659e+03
  3.04626659e+03  6.66673117e+03  6.66673117e+03  6.66673117e+03
  8.95363418e+03  2.53138909e+04  7.60639098e+04]
E1 = -728.0805936288568  E_coul = 201.60772603730203
cycle= 1 E= -526.472867591555  delta_E= -0.696  |g|= 0.184  |ddm|= 0.302
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.548122
diis-c [-0.30043727  1.        ]
  HOMO = -0.574697217350138  LUMO = 1.13385293922942
  mo_energy =
[-1.18592988e+02 -1.22014694e+01 -9.55387040e+00 -9.55387040e+00
 -9.55387040e+00 -1.25264064e+00 -5.74697217e-01 -5.74697217e-01
 -5.74697217e-01  1.13385294e+00  1.13385294e+00  1.13385294e+00
  7.88423472e+00  7.88423472e+00  7.88423472e+00  3.56025127e+01
  3.56025127e+01  3.56025127e+01  6.97949164e+01  1.36278312e+02
  1.36278312e+02  1.36278312e+02  4.96491733e+02  4.96491733e+02
  4.96491733e+02  5.25877528e+02  1.35051792e+03  1.35051792e+03
  1.35051792e+03  2.55521679e+03  3.04587176e+03  3.04587176e+03
  3.04587176e+03  6.66622088e+03  6.66622088e+03  6.66622088e+03
  8.95304642e+03  2.53132081e+04  7.60631361e+04]
E1 = -728.3775869127704  E_coul = 201.9043400889381
cycle= 2 E= -526.473246823832  delta_E= -0.000379  |g|= 0.0247  |ddm|= 0.0196
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0481771
diis-c [-0.0014921  0.0500238  0.9499762]
  HOMO = -0.571113333425649  LUMO = 1.13693036799378
  mo_energy =
[-1.18550122e+02 -1.21811413e+01 -9.53313377e+00 -9.53313377e+00
 -9.53313377e+00 -1.24787663e+00 -5.71113333e-01 -5.71113333e-01
 -5.71113333e-01  1.13693037e+00  1.13693037e+00  1.13693037e+00
  7.89559183e+00  7.89559183e+00  7.89559183e+00  3.56245232e+01
  3.56245232e+01  3.56245232e+01  6.98283939e+01  1.36312222e+02
  1.36312222e+02  1.36312222e+02  4.96534026e+02  4.96534026e+02
  4.96534026e+02  5.25921622e+02  1.35056333e+03  1.35056333e+03
  1.35056333e+03  2.55526442e+03  3.04591876e+03  3.04591876e+03
  3.04591876e+03  6.66626889e+03  6.66626889e+03  6.66626889e+03
  8.95309483e+03  2.53132567e+04  7.60631848e+04]
E1 = -728.3156848655971  E_coul = 201.84242460408825
cycle= 3 E= -526.473260261509  delta_E= -1.34e-05  |g|= 0.00303  |ddm|= 0.0052
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00654187
diis-c [-3.93501572e-07 -1.08888095e-03  1.12917078e-01  8.88171803e-01]
  HOMO = -0.571780497283773  LUMO = 1.13637697028698
  mo_energy =
[-1.18555409e+02 -1.21840015e+01 -9.53610123e+00 -9.53610123e+00
 -9.53610123e+00 -1.24873905e+00 -5.71780497e-01 -5.71780497e-01
 -5.71780497e-01  1.13637697e+00  1.13637697e+00  1.13637697e+00
  7.89377178e+00  7.89377178e+00  7.89377178e+00  3.56214403e+01
  3.56214403e+01  3.56214403e+01  6.98242236e+01  1.36307882e+02
  1.36307882e+02  1.36307882e+02  4.96528809e+02  4.96528809e+02
  4.96528809e+02  5.25916184e+02  1.35055774e+03  1.35055774e+03
  1.35055774e+03  2.55525843e+03  3.04591292e+03  3.04591292e+03
  3.04591292e+03  6.66626280e+03  6.66626280e+03  6.66626280e+03
  8.95308861e+03  2.53132503e+04  7.60631783e+04]
E1 = -728.3241393186815  E_coul = 201.850878755682
cycle= 4 E= -526.473260562999  delta_E= -3.01e-07  |g|= 4.52e-05  |ddm|= 0.000762
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=6.06435e-05
diis-c [-1.91624041e-09  2.78730541e-06 -1.28029838e-03 -3.15080769e-03
  1.00442832e+00]
  HOMO = -0.57175276908115  LUMO = 1.13639927278047
  mo_energy =
[-1.18555310e+02 -1.21839096e+01 -9.53601038e+00 -9.53601038e+00
 -9.53601038e+00 -1.24870287e+00 -5.71752769e-01 -5.71752769e-01
 -5.71752769e-01  1.13639927e+00  1.13639927e+00  1.13639927e+00
  7.89383737e+00  7.89383737e+00  7.89383737e+00  3.56215283e+01
  3.56215283e+01  3.56215283e+01  6.98243250e+01  1.36307979e+02
  1.36307979e+02  1.36307979e+02  4.96528908e+02  4.96528908e+02
  4.96528908e+02  5.25916279e+02  1.35055783e+03  1.35055783e+03
  1.35055783e+03  2.55525851e+03  3.04591301e+03  3.04591301e+03
  3.04591301e+03  6.66626288e+03  6.66626288e+03  6.66626288e+03
  8.95308869e+03  2.53132504e+04  7.60631784e+04]
E1 = -728.323920079656  E_coul = 201.85065951650088
cycle= 5 E= -526.473260563155  delta_E= -1.56e-10  |g|= 7.48e-06  |ddm|= 2.54e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.323920079656  E_coul = 201.85065951650088
  HOMO = -0.571756568533567  LUMO = 1.13639619471223
  mo_energy =
[-1.18555329e+02 -1.21839228e+01 -9.53602390e+00 -9.53602390e+00
 -9.53602390e+00 -1.24870777e+00 -5.71756569e-01 -5.71756569e-01
 -5.71756569e-01  1.13639619e+00  1.13639619e+00  1.13639619e+00
  7.89382807e+00  7.89382807e+00  7.89382807e+00  3.56215148e+01
  3.56215148e+01  3.56215148e+01  6.98243089e+01  1.36307962e+02
  1.36307962e+02  1.36307962e+02  4.96528889e+02  4.96528889e+02
  4.96528889e+02  5.25916261e+02  1.35055782e+03  1.35055782e+03
  1.35055782e+03  2.55525849e+03  3.04591300e+03  3.04591300e+03
  3.04591300e+03  6.66626286e+03  6.66626286e+03  6.66626286e+03
  8.95308867e+03  2.53132504e+04  7.60631784e+04]
E1 = -728.3239551525944  E_coul = 201.8506945894365
Extra cycle  E= -526.473260563158  delta_E= -2.84e-12  |g|= 1.92e-06  |ddm|= 3.65e-06
    CPU time for scf_cycle      0.70 sec, wall time      0.31 sec
exp = [2.61826104e+04 7.61767831e+03 3.61744607e+03 1.60181324e+03
 3.63229068e+02 1.02479741e+02 3.33758620e+01 4.58554926e+00
 3.92514084e-01 1.36277833e+03 6.64830416e+02 3.01399602e+02
 3.14433237e+02 6.44546252e+01 7.70369076e+00 2.12707449e+01
 8.43926034e-01 2.91143586e+00 2.36931652e-01]
E = -526.473260563158
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:45:40 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6103955        1
[INPUT] 0    0    [1    /1   ]  7617.67831164        1
[INPUT] 0    0    [1    /1   ]  3617.44607302        1
[INPUT] 0    0    [1    /1   ]  1601.81323756        1
[INPUT] 0    0    [1    /1   ]  363.22906834         1
[INPUT] 0    0    [1    /1   ]  102.479741438        1
[INPUT] 0    0    [1    /1   ]  33.3758619953        1
[INPUT] 0    0    [1    /1   ]  4.58554926281        1
[INPUT] 0    0    [1    /1   ]  0.39251408396        1
[INPUT] 1    0    [1    /1   ]  1362.77832879        1
[INPUT] 1    0    [1    /1   ]  664.830416438        1
[INPUT] 1    0    [1    /1   ]  301.399601904        1
[INPUT] 1    0    [1    /1   ]  314.433237138        1
[INPUT] 1    0    [1    /1   ]  64.4546251935        1
[INPUT] 1    0    [1    /1   ]  7.70369075561        1
[INPUT] 1    0    [1    /1   ]  21.2707448852        1
[INPUT] 1    0    [1    /1   ]  0.843926033828       1
[INPUT] 1    0    [1    /1   ]  2.91143586212        1
[INPUT] 1    0    [1    /1   ]  0.236931651721       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.610395471314, 1.0]], [0, [7617.67831164222, 1.0]], [0, [3617.4460730208402, 1.0]], [0, [1601.813237561833, 1.0]], [0, [363.22906834017715, 1.0]], [0, [102.47974143753564, 1.0]], [0, [33.37586199525157, 1.0]], [0, [4.585549262805151, 1.0]], [0, [0.3925140839600677, 1.0]], [1, [1362.7783287884297, 1.0]], [1, [664.8304164377009, 1.0]], [1, [301.39960190408476, 1.0]], [1, [314.43323713848116, 1.0]], [1, [64.45462519347407, 1.0]], [1, [7.703690755609526, 1.0]], [1, [21.270744885160717, 1.0]], [1, [0.8439260338283625, 1.0]], [1, [2.9114358621185215, 1.0]], [1, [0.2369316517212446, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.61039547]
bas 1, expnt(s) = [7617.67831164]
bas 2, expnt(s) = [3617.44607302]
bas 3, expnt(s) = [1601.81323756]
bas 4, expnt(s) = [363.22906834]
bas 5, expnt(s) = [102.47974144]
bas 6, expnt(s) = [33.375862]
bas 7, expnt(s) = [4.58554926]
bas 8, expnt(s) = [0.39251408]
bas 9, expnt(s) = [1362.77832879]
bas 10, expnt(s) = [664.83041644]
bas 11, expnt(s) = [301.3996019]
bas 12, expnt(s) = [314.43323714]
bas 13, expnt(s) = [64.45462519]
bas 14, expnt(s) = [7.70369076]
bas 15, expnt(s) = [21.27074489]
bas 16, expnt(s) = [0.84392603]
bas 17, expnt(s) = [2.91143586]
bas 18, expnt(s) = [0.23693165]
CPU time:       777.14
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826104e+04 5.20025610e+03 7.61767831e+03 2.06007009e+03
 3.61744607e+03 1.17846469e+03 1.60181324e+03 6.39696439e+02
 3.63229068e+02 2.10208596e+02 1.02479741e+02 8.13754756e+01
 3.33758620e+01 3.50824078e+01 4.58554926e+00 7.91696175e+00
 3.92514084e-01 1.25287129e+00 1.36277833e+03 2.41554936e+04
 6.64830416e+02 9.84856585e+03 3.01399602e+02 3.66363952e+03
 3.14433237e+02 3.86273532e+03 6.44546252e+01 5.32785015e+02
 7.70369076e+00 3.74419056e+01 2.12707449e+01 1.33263976e+02
 8.43926034e-01 2.35974391e+00 2.91143586e+00 1.10947731e+01
 2.36931652e-01 4.82240016e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.974505290279254
cond(S) = 106473.57707162321
E1 = -728.8714143839288  E_coul = 203.09413993957244
init E= -525.777274444356
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.560098854434999  LUMO = 1.14390918455075
  mo_energy =
[-1.18319730e+02 -1.21051828e+01 -9.45106520e+00 -9.45106520e+00
 -9.45106520e+00 -1.23117922e+00 -5.60098854e-01 -5.60098854e-01
 -5.60098854e-01  1.14390918e+00  1.14390918e+00  1.14390918e+00
  7.94092277e+00  7.94092277e+00  7.94092277e+00  3.57174891e+01
  3.57174891e+01  3.57174891e+01  6.99548829e+01  1.36468781e+02
  1.36468781e+02  1.36468781e+02  4.96760540e+02  4.96760540e+02
  4.96760540e+02  5.26182302e+02  1.35084583e+03  1.35084583e+03
  1.35084583e+03  2.55568047e+03  3.04626659e+03  3.04626659e+03
  3.04626659e+03  6.66673117e+03  6.66673117e+03  6.66673117e+03
  8.95363418e+03  2.53138909e+04  7.60639098e+04]
E1 = -728.0805936288568  E_coul = 201.60772603730203
cycle= 1 E= -526.472867591555  delta_E= -0.696  |g|= 0.184  |ddm|= 0.302
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.548122
diis-c [-0.30043727  1.        ]
  HOMO = -0.574697217350138  LUMO = 1.13385293922942
  mo_energy =
[-1.18592988e+02 -1.22014694e+01 -9.55387040e+00 -9.55387040e+00
 -9.55387040e+00 -1.25264064e+00 -5.74697217e-01 -5.74697217e-01
 -5.74697217e-01  1.13385294e+00  1.13385294e+00  1.13385294e+00
  7.88423472e+00  7.88423472e+00  7.88423472e+00  3.56025127e+01
  3.56025127e+01  3.56025127e+01  6.97949164e+01  1.36278312e+02
  1.36278312e+02  1.36278312e+02  4.96491733e+02  4.96491733e+02
  4.96491733e+02  5.25877528e+02  1.35051792e+03  1.35051792e+03
  1.35051792e+03  2.55521679e+03  3.04587176e+03  3.04587176e+03
  3.04587176e+03  6.66622088e+03  6.66622088e+03  6.66622088e+03
  8.95304642e+03  2.53132081e+04  7.60631361e+04]
E1 = -728.3775869127704  E_coul = 201.9043400889381
cycle= 2 E= -526.473246823832  delta_E= -0.000379  |g|= 0.0247  |ddm|= 0.0196
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0481771
diis-c [-0.0014921  0.0500238  0.9499762]
  HOMO = -0.571113333425649  LUMO = 1.13693036799378
  mo_energy =
[-1.18550122e+02 -1.21811413e+01 -9.53313377e+00 -9.53313377e+00
 -9.53313377e+00 -1.24787663e+00 -5.71113333e-01 -5.71113333e-01
 -5.71113333e-01  1.13693037e+00  1.13693037e+00  1.13693037e+00
  7.89559183e+00  7.89559183e+00  7.89559183e+00  3.56245232e+01
  3.56245232e+01  3.56245232e+01  6.98283939e+01  1.36312222e+02
  1.36312222e+02  1.36312222e+02  4.96534026e+02  4.96534026e+02
  4.96534026e+02  5.25921622e+02  1.35056333e+03  1.35056333e+03
  1.35056333e+03  2.55526442e+03  3.04591876e+03  3.04591876e+03
  3.04591876e+03  6.66626889e+03  6.66626889e+03  6.66626889e+03
  8.95309483e+03  2.53132567e+04  7.60631848e+04]
E1 = -728.3156848655971  E_coul = 201.84242460408825
cycle= 3 E= -526.473260261509  delta_E= -1.34e-05  |g|= 0.00303  |ddm|= 0.0052
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00654187
diis-c [-3.93501572e-07 -1.08888095e-03  1.12917078e-01  8.88171803e-01]
  HOMO = -0.571780497283773  LUMO = 1.13637697028698
  mo_energy =
[-1.18555409e+02 -1.21840015e+01 -9.53610123e+00 -9.53610123e+00
 -9.53610123e+00 -1.24873905e+00 -5.71780497e-01 -5.71780497e-01
 -5.71780497e-01  1.13637697e+00  1.13637697e+00  1.13637697e+00
  7.89377178e+00  7.89377178e+00  7.89377178e+00  3.56214403e+01
  3.56214403e+01  3.56214403e+01  6.98242236e+01  1.36307882e+02
  1.36307882e+02  1.36307882e+02  4.96528809e+02  4.96528809e+02
  4.96528809e+02  5.25916184e+02  1.35055774e+03  1.35055774e+03
  1.35055774e+03  2.55525843e+03  3.04591292e+03  3.04591292e+03
  3.04591292e+03  6.66626280e+03  6.66626280e+03  6.66626280e+03
  8.95308861e+03  2.53132503e+04  7.60631783e+04]
E1 = -728.3241393186815  E_coul = 201.850878755682
cycle= 4 E= -526.473260562999  delta_E= -3.01e-07  |g|= 4.52e-05  |ddm|= 0.000762
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=6.06435e-05
diis-c [-1.91624041e-09  2.78730541e-06 -1.28029838e-03 -3.15080769e-03
  1.00442832e+00]
  HOMO = -0.57175276908115  LUMO = 1.13639927278047
  mo_energy =
[-1.18555310e+02 -1.21839096e+01 -9.53601038e+00 -9.53601038e+00
 -9.53601038e+00 -1.24870287e+00 -5.71752769e-01 -5.71752769e-01
 -5.71752769e-01  1.13639927e+00  1.13639927e+00  1.13639927e+00
  7.89383737e+00  7.89383737e+00  7.89383737e+00  3.56215283e+01
  3.56215283e+01  3.56215283e+01  6.98243250e+01  1.36307979e+02
  1.36307979e+02  1.36307979e+02  4.96528908e+02  4.96528908e+02
  4.96528908e+02  5.25916279e+02  1.35055783e+03  1.35055783e+03
  1.35055783e+03  2.55525851e+03  3.04591301e+03  3.04591301e+03
  3.04591301e+03  6.66626288e+03  6.66626288e+03  6.66626288e+03
  8.95308869e+03  2.53132504e+04  7.60631784e+04]
E1 = -728.323920079656  E_coul = 201.85065951650088
cycle= 5 E= -526.473260563155  delta_E= -1.56e-10  |g|= 7.48e-06  |ddm|= 2.54e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.323920079656  E_coul = 201.85065951650088
  HOMO = -0.571756568533567  LUMO = 1.13639619471223
  mo_energy =
[-1.18555329e+02 -1.21839228e+01 -9.53602390e+00 -9.53602390e+00
 -9.53602390e+00 -1.24870777e+00 -5.71756569e-01 -5.71756569e-01
 -5.71756569e-01  1.13639619e+00  1.13639619e+00  1.13639619e+00
  7.89382807e+00  7.89382807e+00  7.89382807e+00  3.56215148e+01
  3.56215148e+01  3.56215148e+01  6.98243089e+01  1.36307962e+02
  1.36307962e+02  1.36307962e+02  4.96528889e+02  4.96528889e+02
  4.96528889e+02  5.25916261e+02  1.35055782e+03  1.35055782e+03
  1.35055782e+03  2.55525849e+03  3.04591300e+03  3.04591300e+03
  3.04591300e+03  6.66626286e+03  6.66626286e+03  6.66626286e+03
  8.95308867e+03  2.53132504e+04  7.60631784e+04]
E1 = -728.3239551525944  E_coul = 201.8506945894365
Extra cycle  E= -526.473260563158  delta_E= -2.84e-12  |g|= 1.92e-06  |ddm|= 3.65e-06
    CPU time for scf_cycle      0.70 sec, wall time      0.31 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 106473.57707162321
E1 = -728.3239551525944  E_coul = 201.8506945894365
init E= -526.473260563158
    CPU time for initialize scf      2.73 sec, wall time      0.25 sec
  HOMO = -0.571755916066751  LUMO = 1.13639673033527
  mo_energy =
[-1.18555324e+02 -1.21839202e+01 -9.53602125e+00 -9.53602125e+00
 -9.53602125e+00 -1.24870692e+00 -5.71755916e-01 -5.71755916e-01
 -5.71755916e-01  1.13639673e+00  1.13639673e+00  1.13639673e+00
  7.89382978e+00  7.89382978e+00  7.89382978e+00  3.56215175e+01
  3.56215175e+01  3.56215175e+01  6.98243124e+01  1.36307966e+02
  1.36307966e+02  1.36307966e+02  4.96528894e+02  4.96528894e+02
  4.96528894e+02  5.25916265e+02  1.35055782e+03  1.35055782e+03
  1.35055782e+03  2.55525850e+03  3.04591300e+03  3.04591300e+03
  3.04591300e+03  6.66626287e+03  6.66626287e+03  6.66626287e+03
  8.95308867e+03  2.53132504e+04  7.60631784e+04]
E1 = -728.3239479383485  E_coul = 201.8506873751894
cycle= 1 E= -526.473260563159  delta_E= -1.14e-12  |g|= 4.3e-07  |ddm|= 6.95e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3239479383485  E_coul = 201.8506873751894
  HOMO = -0.571756042491606  LUMO = 1.13639662592074
  mo_energy =
[-1.18555325e+02 -1.21839208e+01 -9.53602179e+00 -9.53602179e+00
 -9.53602179e+00 -1.24870709e+00 -5.71756042e-01 -5.71756042e-01
 -5.71756042e-01  1.13639663e+00  1.13639663e+00  1.13639663e+00
  7.89382944e+00  7.89382944e+00  7.89382944e+00  3.56215170e+01
  3.56215170e+01  3.56215170e+01  6.98243116e+01  1.36307965e+02
  1.36307965e+02  1.36307965e+02  4.96528893e+02  4.96528893e+02
  4.96528893e+02  5.25916264e+02  1.35055782e+03  1.35055782e+03
  1.35055782e+03  2.55525850e+03  3.04591300e+03  3.04591300e+03
  3.04591300e+03  6.66626287e+03  6.66626287e+03  6.66626287e+03
  8.95308867e+03  2.53132504e+04  7.60631784e+04]
E1 = -728.3239494445314  E_coul = 201.85068888137323
Extra cycle  E= -526.473260563158  delta_E= 9.09e-13  |g|= 9.29e-08  |ddm|= 1.41e-07
    CPU time for scf_cycle      2.88 sec, wall time      0.40 sec
exp = [2.61826104e+04 7.61767831e+03 3.61744607e+03 1.60181324e+03
 3.63229068e+02 1.02479741e+02 3.33758620e+01 4.58554926e+00
 3.92514084e-01 1.36277833e+03 6.64830416e+02 3.01399602e+02
 3.14433237e+02 6.44546252e+01 7.70369076e+00 2.12707449e+01
 8.43926034e-01 2.91143586e+00 2.36931652e-01]
grad_E = [-1.60949994e-06  4.51871381e-06 -2.39071732e-07  1.07591393e-04
 -3.27488813e-04  6.65396597e-04 -1.84850309e-03  6.42968008e-03
 -3.33734347e-02 -6.15524535e-07  3.42806452e-06  1.49897731e-05
  1.28699269e-05  1.70115161e-04  3.65430821e-03 -8.61575376e-04
  6.61203646e-02 -9.31598208e-03 -7.81386092e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:45:44 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6351467        1
[INPUT] 0    0    [1    /1   ]  7617.58652381        1
[INPUT] 0    0    [1    /1   ]  3617.37844927        1
[INPUT] 0    0    [1    /1   ]  1599.42029987        1
[INPUT] 0    0    [1    /1   ]  376.221756665        1
[INPUT] 0    0    [1    /1   ]  106.322887945        1
[INPUT] 0    0    [1    /1   ]  34.3318818258        1
[INPUT] 0    0    [1    /1   ]  4.58707177979        1
[INPUT] 0    0    [1    /1   ]  0.393901757592       1
[INPUT] 1    0    [1    /1   ]  1362.7795125         1
[INPUT] 1    0    [1    /1   ]  664.797176864        1
[INPUT] 1    0    [1    /1   ]  301.217535286        1
[INPUT] 1    0    [1    /1   ]  314.266830816        1
[INPUT] 1    0    [1    /1   ]  62.187694786         1
[INPUT] 1    0    [1    /1   ]  7.28440866527        1
[INPUT] 1    0    [1    /1   ]  20.1356590178        1
[INPUT] 1    0    [1    /1   ]  0.805140431619       1
[INPUT] 1    0    [1    /1   ]  2.7778687988         1
[INPUT] 1    0    [1    /1   ]  0.229439738143       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.635146708035, 1.0]], [0, [7617.5865238117285, 1.0]], [0, [3617.3784492653003, 1.0]], [0, [1599.4202998686967, 1.0]], [0, [376.2217566649331, 1.0]], [0, [106.32288794505703, 1.0]], [0, [34.33188182580277, 1.0]], [0, [4.587071779793092, 1.0]], [0, [0.3939017575920441, 1.0]], [1, [1362.7795124999564, 1.0]], [1, [664.7971768641755, 1.0]], [1, [301.21753528563585, 1.0]], [1, [314.26683081558065, 1.0]], [1, [62.1876947859683, 1.0]], [1, [7.284408665271232, 1.0]], [1, [20.135659017836126, 1.0]], [1, [0.80514043161917, 1.0]], [1, [2.7778687987979422, 1.0]], [1, [0.2294397381427536, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.63514671]
bas 1, expnt(s) = [7617.58652381]
bas 2, expnt(s) = [3617.37844927]
bas 3, expnt(s) = [1599.42029987]
bas 4, expnt(s) = [376.22175666]
bas 5, expnt(s) = [106.32288795]
bas 6, expnt(s) = [34.33188183]
bas 7, expnt(s) = [4.58707178]
bas 8, expnt(s) = [0.39390176]
bas 9, expnt(s) = [1362.7795125]
bas 10, expnt(s) = [664.79717686]
bas 11, expnt(s) = [301.21753529]
bas 12, expnt(s) = [314.26683082]
bas 13, expnt(s) = [62.18769479]
bas 14, expnt(s) = [7.28440867]
bas 15, expnt(s) = [20.13565902]
bas 16, expnt(s) = [0.80514043]
bas 17, expnt(s) = [2.7778688]
bas 18, expnt(s) = [0.22943974]
CPU time:       785.58
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826351e+04 5.20025978e+03 7.61758652e+03 2.06005147e+03
 3.61737845e+03 1.17844816e+03 1.59942030e+03 6.38979576e+02
 3.76221757e+02 2.15823114e+02 1.06322888e+02 8.36536890e+01
 3.43318818e+01 3.58334176e+01 4.58707178e+00 7.91893314e+00
 3.93901758e-01 1.25619183e+00 1.36277951e+03 2.41555198e+04
 6.64797177e+02 9.84795036e+03 3.01217535e+02 3.66087336e+03
 3.14266831e+02 3.86018017e+03 6.21876948e+01 5.09465718e+02
 7.28440867e+00 3.49122043e+01 2.01356590e+01 1.24434757e+02
 8.05140432e-01 2.22496886e+00 2.77786880e+00 1.04622250e+01
 2.29439738e-01 4.63255080e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97584865466409
cond(S) = 101100.5001171146
E1 = -728.8787899790576  E_coul = 203.1098306115072
init E= -525.76895936755
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559824561500773  LUMO = 1.0797534030792
  mo_energy =
[-1.18320200e+02 -1.21040702e+01 -9.44972332e+00 -9.44972332e+00
 -9.44972332e+00 -1.23056994e+00 -5.59824562e-01 -5.59824562e-01
 -5.59824562e-01  1.07975340e+00  1.07975340e+00  1.07975340e+00
  7.41871978e+00  7.41871978e+00  7.41871978e+00  3.33414472e+01
  3.33414472e+01  3.33414472e+01  7.32902222e+01  1.29217951e+02
  1.29217951e+02  1.29217951e+02  4.84807512e+02  4.84807512e+02
  4.84807512e+02  5.48529255e+02  1.33757452e+03  1.33757452e+03
  1.33757452e+03  2.60661570e+03  3.03263485e+03  3.03263485e+03
  3.03263485e+03  6.65357354e+03  6.65357354e+03  6.65357354e+03
  9.01127102e+03  2.53695122e+04  7.61155006e+04]
E1 = -728.0675484839047  E_coul = 201.5912033502925
cycle= 1 E= -526.476345133612  delta_E= -0.707  |g|= 0.184  |ddm|= 0.302
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.545688
diis-c [-0.29777552  1.        ]
  HOMO = -0.575280338351866  LUMO = 1.06991362973407
  mo_energy =
[-1.18596891e+02 -1.22026593e+01 -9.55471278e+00 -9.55471278e+00
 -9.55471278e+00 -1.25327443e+00 -5.75280338e-01 -5.75280338e-01
 -5.75280338e-01  1.06991363e+00  1.06991363e+00  1.06991363e+00
  7.36286975e+00  7.36286975e+00  7.36286975e+00  3.32278123e+01
  3.32278123e+01  3.32278123e+01  7.31248476e+01  1.29026664e+02
  1.29026664e+02  1.29026664e+02  4.84535850e+02  4.84535850e+02
  4.84535850e+02  5.48218166e+02  1.33724362e+03  1.33724362e+03
  1.33724362e+03  2.60614908e+03  3.03223720e+03  3.03223720e+03
  3.03223720e+03  6.65306122e+03  6.65306122e+03  6.65306122e+03
  9.01068210e+03  2.53688285e+04  7.61147263e+04]
E1 = -728.370397523776  E_coul = 201.89366829406376
cycle= 2 E= -526.476729229712  delta_E= -0.000384  |g|= 0.0247  |ddm|= 0.0202
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0481851
diis-c [-0.00149232  0.05025271  0.94974729]
  HOMO = -0.571548539834106  LUMO = 1.07292152147277
  mo_energy =
[-1.18553547e+02 -1.21819269e+01 -9.53356862e+00 -9.53356862e+00
 -9.53356862e+00 -1.24831424e+00 -5.71548540e-01 -5.71548540e-01
 -5.71548540e-01  1.07292152e+00  1.07292152e+00  1.07292152e+00
  7.37406794e+00  7.37406794e+00  7.37406794e+00  3.32496224e+01
  3.32496224e+01  3.32496224e+01  7.31592089e+01  1.29060707e+02
  1.29060707e+02  1.29060707e+02  4.84578623e+02  4.84578623e+02
  4.84578623e+02  5.48262912e+02  1.33728953e+03  1.33728953e+03
  1.33728953e+03  2.60619722e+03  3.03228470e+03  3.03228470e+03
  3.03228470e+03  6.65310972e+03  6.65310972e+03  6.65310972e+03
  9.01073101e+03  2.53688776e+04  7.61147755e+04]
E1 = -728.3071364718912  E_coul = 201.8303934500152
cycle= 3 E= -526.476743021876  delta_E= -1.38e-05  |g|= 0.00305  |ddm|= 0.00531
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00653721
diis-c [-3.81638057e-07 -1.07851922e-03  1.12932362e-01  8.88146157e-01]
  HOMO = -0.572238172577494  LUMO = 1.07238257331152
  mo_energy =
[-1.18558906e+02 -1.21848507e+01 -9.53659819e+00 -9.53659819e+00
 -9.53659819e+00 -1.24920693e+00 -5.72238173e-01 -5.72238173e-01
 -5.72238173e-01  1.07238257e+00  1.07238257e+00  1.07238257e+00
  7.37226432e+00  7.37226432e+00  7.37226432e+00  3.32465463e+01
  3.32465463e+01  3.32465463e+01  7.31549227e+01  1.29056330e+02
  1.29056330e+02  1.29056330e+02  4.84573335e+02  4.84573335e+02
  4.84573335e+02  5.48257382e+02  1.33728387e+03  1.33728387e+03
  1.33728387e+03  2.60619115e+03  3.03227879e+03  3.03227879e+03
  3.03227879e+03  6.65310357e+03  6.65310357e+03  6.65310357e+03
  9.01072473e+03  2.53688712e+04  7.61147690e+04]
E1 = -728.3157956681928  E_coul = 201.8390523347028
cycle= 4 E= -526.47674333349  delta_E= -3.12e-07  |g|= 4.66e-05  |ddm|= 0.00078
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=6.43081e-05
diis-c [-1.93394318e-09 -4.09744319e-07 -9.32917142e-04  3.26907144e-04
  1.00060642e+00]
  HOMO = -0.572209494640934  LUMO = 1.07240438595789
  mo_energy =
[-1.18558804e+02 -1.21847563e+01 -9.53650468e+00 -9.53650468e+00
 -9.53650468e+00 -1.24916954e+00 -5.72209495e-01 -5.72209495e-01
 -5.72209495e-01  1.07240439e+00  1.07240439e+00  1.07240439e+00
  7.37233020e+00  7.37233020e+00  7.37233020e+00  3.32466363e+01
  3.32466363e+01  3.32466363e+01  7.31550275e+01  1.29056430e+02
  1.29056430e+02  1.29056430e+02  4.84573437e+02  4.84573437e+02
  4.84573437e+02  5.48257482e+02  1.33728397e+03  1.33728397e+03
  1.33728397e+03  2.60619124e+03  3.03227889e+03  3.03227889e+03
  3.03227889e+03  6.65310366e+03  6.65310366e+03  6.65310366e+03
  9.01072481e+03  2.53688713e+04  7.61147691e+04]
E1 = -728.3155670118867  E_coul = 201.8388236782265
cycle= 5 E= -526.47674333366  delta_E= -1.7e-10  |g|= 7.33e-06  |ddm|= 2.62e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3155670118867  E_coul = 201.8388236782265
  HOMO = -0.572213284771583  LUMO = 1.0724014862834
  mo_energy =
[-1.18558822e+02 -1.21847694e+01 -9.53651804e+00 -9.53651804e+00
 -9.53651804e+00 -1.24917444e+00 -5.72213285e-01 -5.72213285e-01
 -5.72213285e-01  1.07240149e+00  1.07240149e+00  1.07240149e+00
  7.37232123e+00  7.37232123e+00  7.37232123e+00  3.32466231e+01
  3.32466231e+01  3.32466231e+01  7.31550114e+01  1.29056414e+02
  1.29056414e+02  1.29056414e+02  4.84573419e+02  4.84573419e+02
  4.84573419e+02  5.48257464e+02  1.33728395e+03  1.33728395e+03
  1.33728395e+03  2.60619122e+03  3.03227887e+03  3.03227887e+03
  3.03227887e+03  6.65310364e+03  6.65310364e+03  6.65310364e+03
  9.01072479e+03  2.53688713e+04  7.61147690e+04]
E1 = -728.3156019559152  E_coul = 201.83885862225054
Extra cycle  E= -526.476743333665  delta_E= -4.43e-12  |g|= 1.89e-06  |ddm|= 3.61e-06
    CPU time for scf_cycle      0.66 sec, wall time      0.27 sec
exp = [2.61826351e+04 7.61758652e+03 3.61737845e+03 1.59942030e+03
 3.76221757e+02 1.06322888e+02 3.43318818e+01 4.58707178e+00
 3.93901758e-01 1.36277951e+03 6.64797177e+02 3.01217535e+02
 3.14266831e+02 6.21876948e+01 7.28440867e+00 2.01356590e+01
 8.05140432e-01 2.77786880e+00 2.29439738e-01]
E = -526.4767433336647
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:45:45 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6351467        1
[INPUT] 0    0    [1    /1   ]  7617.58652381        1
[INPUT] 0    0    [1    /1   ]  3617.37844927        1
[INPUT] 0    0    [1    /1   ]  1599.42029987        1
[INPUT] 0    0    [1    /1   ]  376.221756665        1
[INPUT] 0    0    [1    /1   ]  106.322887945        1
[INPUT] 0    0    [1    /1   ]  34.3318818258        1
[INPUT] 0    0    [1    /1   ]  4.58707177979        1
[INPUT] 0    0    [1    /1   ]  0.393901757592       1
[INPUT] 1    0    [1    /1   ]  1362.7795125         1
[INPUT] 1    0    [1    /1   ]  664.797176864        1
[INPUT] 1    0    [1    /1   ]  301.217535286        1
[INPUT] 1    0    [1    /1   ]  314.266830816        1
[INPUT] 1    0    [1    /1   ]  62.187694786         1
[INPUT] 1    0    [1    /1   ]  7.28440866527        1
[INPUT] 1    0    [1    /1   ]  20.1356590178        1
[INPUT] 1    0    [1    /1   ]  0.805140431619       1
[INPUT] 1    0    [1    /1   ]  2.7778687988         1
[INPUT] 1    0    [1    /1   ]  0.229439738143       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.635146708035, 1.0]], [0, [7617.5865238117285, 1.0]], [0, [3617.3784492653003, 1.0]], [0, [1599.4202998686967, 1.0]], [0, [376.2217566649331, 1.0]], [0, [106.32288794505703, 1.0]], [0, [34.33188182580277, 1.0]], [0, [4.587071779793092, 1.0]], [0, [0.3939017575920441, 1.0]], [1, [1362.7795124999564, 1.0]], [1, [664.7971768641755, 1.0]], [1, [301.21753528563585, 1.0]], [1, [314.26683081558065, 1.0]], [1, [62.1876947859683, 1.0]], [1, [7.284408665271232, 1.0]], [1, [20.135659017836126, 1.0]], [1, [0.80514043161917, 1.0]], [1, [2.7778687987979422, 1.0]], [1, [0.2294397381427536, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.63514671]
bas 1, expnt(s) = [7617.58652381]
bas 2, expnt(s) = [3617.37844927]
bas 3, expnt(s) = [1599.42029987]
bas 4, expnt(s) = [376.22175666]
bas 5, expnt(s) = [106.32288795]
bas 6, expnt(s) = [34.33188183]
bas 7, expnt(s) = [4.58707178]
bas 8, expnt(s) = [0.39390176]
bas 9, expnt(s) = [1362.7795125]
bas 10, expnt(s) = [664.79717686]
bas 11, expnt(s) = [301.21753529]
bas 12, expnt(s) = [314.26683082]
bas 13, expnt(s) = [62.18769479]
bas 14, expnt(s) = [7.28440867]
bas 15, expnt(s) = [20.13565902]
bas 16, expnt(s) = [0.80514043]
bas 17, expnt(s) = [2.7778688]
bas 18, expnt(s) = [0.22943974]
CPU time:       786.56
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826351e+04 5.20025978e+03 7.61758652e+03 2.06005147e+03
 3.61737845e+03 1.17844816e+03 1.59942030e+03 6.38979576e+02
 3.76221757e+02 2.15823114e+02 1.06322888e+02 8.36536890e+01
 3.43318818e+01 3.58334176e+01 4.58707178e+00 7.91893314e+00
 3.93901758e-01 1.25619183e+00 1.36277951e+03 2.41555198e+04
 6.64797177e+02 9.84795036e+03 3.01217535e+02 3.66087336e+03
 3.14266831e+02 3.86018017e+03 6.21876948e+01 5.09465718e+02
 7.28440867e+00 3.49122043e+01 2.01356590e+01 1.24434757e+02
 8.05140432e-01 2.22496886e+00 2.77786880e+00 1.04622250e+01
 2.29439738e-01 4.63255080e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97584865466409
cond(S) = 101100.5001171146
E1 = -728.8787899790576  E_coul = 203.1098306115072
init E= -525.76895936755
    CPU time for initialize scf      0.45 sec, wall time      0.05 sec
  HOMO = -0.559824561500773  LUMO = 1.0797534030792
  mo_energy =
[-1.18320200e+02 -1.21040702e+01 -9.44972332e+00 -9.44972332e+00
 -9.44972332e+00 -1.23056994e+00 -5.59824562e-01 -5.59824562e-01
 -5.59824562e-01  1.07975340e+00  1.07975340e+00  1.07975340e+00
  7.41871978e+00  7.41871978e+00  7.41871978e+00  3.33414472e+01
  3.33414472e+01  3.33414472e+01  7.32902222e+01  1.29217951e+02
  1.29217951e+02  1.29217951e+02  4.84807512e+02  4.84807512e+02
  4.84807512e+02  5.48529255e+02  1.33757452e+03  1.33757452e+03
  1.33757452e+03  2.60661570e+03  3.03263485e+03  3.03263485e+03
  3.03263485e+03  6.65357354e+03  6.65357354e+03  6.65357354e+03
  9.01127102e+03  2.53695122e+04  7.61155006e+04]
E1 = -728.0675484839047  E_coul = 201.5912033502925
cycle= 1 E= -526.476345133612  delta_E= -0.707  |g|= 0.184  |ddm|= 0.302
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.545688
diis-c [-0.29777552  1.        ]
  HOMO = -0.575280338351866  LUMO = 1.06991362973407
  mo_energy =
[-1.18596891e+02 -1.22026593e+01 -9.55471278e+00 -9.55471278e+00
 -9.55471278e+00 -1.25327443e+00 -5.75280338e-01 -5.75280338e-01
 -5.75280338e-01  1.06991363e+00  1.06991363e+00  1.06991363e+00
  7.36286975e+00  7.36286975e+00  7.36286975e+00  3.32278123e+01
  3.32278123e+01  3.32278123e+01  7.31248476e+01  1.29026664e+02
  1.29026664e+02  1.29026664e+02  4.84535850e+02  4.84535850e+02
  4.84535850e+02  5.48218166e+02  1.33724362e+03  1.33724362e+03
  1.33724362e+03  2.60614908e+03  3.03223720e+03  3.03223720e+03
  3.03223720e+03  6.65306122e+03  6.65306122e+03  6.65306122e+03
  9.01068210e+03  2.53688285e+04  7.61147263e+04]
E1 = -728.370397523776  E_coul = 201.89366829406376
cycle= 2 E= -526.476729229712  delta_E= -0.000384  |g|= 0.0247  |ddm|= 0.0202
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0481851
diis-c [-0.00149232  0.05025271  0.94974729]
  HOMO = -0.571548539834106  LUMO = 1.07292152147277
  mo_energy =
[-1.18553547e+02 -1.21819269e+01 -9.53356862e+00 -9.53356862e+00
 -9.53356862e+00 -1.24831424e+00 -5.71548540e-01 -5.71548540e-01
 -5.71548540e-01  1.07292152e+00  1.07292152e+00  1.07292152e+00
  7.37406794e+00  7.37406794e+00  7.37406794e+00  3.32496224e+01
  3.32496224e+01  3.32496224e+01  7.31592089e+01  1.29060707e+02
  1.29060707e+02  1.29060707e+02  4.84578623e+02  4.84578623e+02
  4.84578623e+02  5.48262912e+02  1.33728953e+03  1.33728953e+03
  1.33728953e+03  2.60619722e+03  3.03228470e+03  3.03228470e+03
  3.03228470e+03  6.65310972e+03  6.65310972e+03  6.65310972e+03
  9.01073101e+03  2.53688776e+04  7.61147755e+04]
E1 = -728.3071364718912  E_coul = 201.8303934500152
cycle= 3 E= -526.476743021876  delta_E= -1.38e-05  |g|= 0.00305  |ddm|= 0.00531
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00653721
diis-c [-3.81638057e-07 -1.07851922e-03  1.12932362e-01  8.88146157e-01]
  HOMO = -0.572238172577494  LUMO = 1.07238257331152
  mo_energy =
[-1.18558906e+02 -1.21848507e+01 -9.53659819e+00 -9.53659819e+00
 -9.53659819e+00 -1.24920693e+00 -5.72238173e-01 -5.72238173e-01
 -5.72238173e-01  1.07238257e+00  1.07238257e+00  1.07238257e+00
  7.37226432e+00  7.37226432e+00  7.37226432e+00  3.32465463e+01
  3.32465463e+01  3.32465463e+01  7.31549227e+01  1.29056330e+02
  1.29056330e+02  1.29056330e+02  4.84573335e+02  4.84573335e+02
  4.84573335e+02  5.48257382e+02  1.33728387e+03  1.33728387e+03
  1.33728387e+03  2.60619115e+03  3.03227879e+03  3.03227879e+03
  3.03227879e+03  6.65310357e+03  6.65310357e+03  6.65310357e+03
  9.01072473e+03  2.53688712e+04  7.61147690e+04]
E1 = -728.3157956681928  E_coul = 201.8390523347028
cycle= 4 E= -526.47674333349  delta_E= -3.12e-07  |g|= 4.66e-05  |ddm|= 0.00078
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=6.43081e-05
diis-c [-1.93394318e-09 -4.09744319e-07 -9.32917142e-04  3.26907144e-04
  1.00060642e+00]
  HOMO = -0.572209494640934  LUMO = 1.07240438595789
  mo_energy =
[-1.18558804e+02 -1.21847563e+01 -9.53650468e+00 -9.53650468e+00
 -9.53650468e+00 -1.24916954e+00 -5.72209495e-01 -5.72209495e-01
 -5.72209495e-01  1.07240439e+00  1.07240439e+00  1.07240439e+00
  7.37233020e+00  7.37233020e+00  7.37233020e+00  3.32466363e+01
  3.32466363e+01  3.32466363e+01  7.31550275e+01  1.29056430e+02
  1.29056430e+02  1.29056430e+02  4.84573437e+02  4.84573437e+02
  4.84573437e+02  5.48257482e+02  1.33728397e+03  1.33728397e+03
  1.33728397e+03  2.60619124e+03  3.03227889e+03  3.03227889e+03
  3.03227889e+03  6.65310366e+03  6.65310366e+03  6.65310366e+03
  9.01072481e+03  2.53688713e+04  7.61147691e+04]
E1 = -728.3155670118867  E_coul = 201.8388236782265
cycle= 5 E= -526.47674333366  delta_E= -1.7e-10  |g|= 7.33e-06  |ddm|= 2.62e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3155670118867  E_coul = 201.8388236782265
  HOMO = -0.572213284771583  LUMO = 1.0724014862834
  mo_energy =
[-1.18558822e+02 -1.21847694e+01 -9.53651804e+00 -9.53651804e+00
 -9.53651804e+00 -1.24917444e+00 -5.72213285e-01 -5.72213285e-01
 -5.72213285e-01  1.07240149e+00  1.07240149e+00  1.07240149e+00
  7.37232123e+00  7.37232123e+00  7.37232123e+00  3.32466231e+01
  3.32466231e+01  3.32466231e+01  7.31550114e+01  1.29056414e+02
  1.29056414e+02  1.29056414e+02  4.84573419e+02  4.84573419e+02
  4.84573419e+02  5.48257464e+02  1.33728395e+03  1.33728395e+03
  1.33728395e+03  2.60619122e+03  3.03227887e+03  3.03227887e+03
  3.03227887e+03  6.65310364e+03  6.65310364e+03  6.65310364e+03
  9.01072479e+03  2.53688713e+04  7.61147690e+04]
E1 = -728.3156019559152  E_coul = 201.83885862225054
Extra cycle  E= -526.476743333665  delta_E= -4.43e-12  |g|= 1.89e-06  |ddm|= 3.61e-06
    CPU time for scf_cycle      0.70 sec, wall time      0.31 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 101100.5001171146
E1 = -728.3156019559152  E_coul = 201.83885862225054
init E= -526.476743333665
    CPU time for initialize scf      2.75 sec, wall time      0.25 sec
  HOMO = -0.572212628337325  LUMO = 1.07240199461875
  mo_energy =
[-1.18558818e+02 -1.21847668e+01 -9.53651541e+00 -9.53651541e+00
 -9.53651541e+00 -1.24917359e+00 -5.72212628e-01 -5.72212628e-01
 -5.72212628e-01  1.07240199e+00  1.07240199e+00  1.07240199e+00
  7.37232288e+00  7.37232288e+00  7.37232288e+00  3.32466258e+01
  3.32466258e+01  3.32466258e+01  7.31550149e+01  1.29056418e+02
  1.29056418e+02  1.29056418e+02  4.84573423e+02  4.84573423e+02
  4.84573423e+02  5.48257468e+02  1.33728395e+03  1.33728395e+03
  1.33728395e+03  2.60619123e+03  3.03227887e+03  3.03227887e+03
  3.03227887e+03  6.65310365e+03  6.65310365e+03  6.65310365e+03
  9.01072480e+03  2.53688713e+04  7.61147690e+04]
E1 = -728.3155947337408  E_coul = 201.8388514000783
cycle= 1 E= -526.476743333663  delta_E= 2.16e-12  |g|= 4.25e-07  |ddm|= 6.93e-07
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
E1 = -728.3155947337408  E_coul = 201.8388514000783
  HOMO = -0.572212756335616  LUMO = 1.07240189496538
  mo_energy =
[-1.18558819e+02 -1.21847674e+01 -9.53651595e+00 -9.53651595e+00
 -9.53651595e+00 -1.24917375e+00 -5.72212756e-01 -5.72212756e-01
 -5.72212756e-01  1.07240189e+00  1.07240189e+00  1.07240189e+00
  7.37232255e+00  7.37232255e+00  7.37232255e+00  3.32466252e+01
  3.32466252e+01  3.32466252e+01  7.31550142e+01  1.29056417e+02
  1.29056417e+02  1.29056417e+02  4.84573423e+02  4.84573423e+02
  4.84573423e+02  5.48257467e+02  1.33728395e+03  1.33728395e+03
  1.33728395e+03  2.60619123e+03  3.03227887e+03  3.03227887e+03
  3.03227887e+03  6.65310365e+03  6.65310365e+03  6.65310365e+03
  9.01072480e+03  2.53688713e+04  7.61147690e+04]
E1 = -728.3155962478545  E_coul = 201.83885291419045
Extra cycle  E= -526.476743333664  delta_E= -1.48e-12  |g|= 9.2e-08  |ddm|= 1.41e-07
    CPU time for scf_cycle      2.90 sec, wall time      0.40 sec
exp = [2.61826351e+04 7.61758652e+03 3.61737845e+03 1.59942030e+03
 3.76221757e+02 1.06322888e+02 3.43318818e+01 4.58707178e+00
 3.93901758e-01 1.36277951e+03 6.64797177e+02 3.01217535e+02
 3.14266831e+02 6.21876948e+01 7.28440867e+00 2.01356590e+01
 8.05140432e-01 2.77786880e+00 2.29439738e-01]
grad_E = [-1.54675391e-06  3.70390496e-06 -1.12305669e-06  8.16814668e-05
 -1.03621002e-04  3.25688524e-04 -7.89542430e-04  3.29918947e-03
 -1.56652829e-02 -5.77071304e-07  3.98521889e-06  1.76573236e-05
  1.52333592e-05  4.35985566e-04  4.37272814e-03 -2.31189241e-03
  4.15157248e-02 -7.60541701e-03 -4.11342074e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:45:50 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6557792        1
[INPUT] 0    0    [1    /1   ]  7617.52173985        1
[INPUT] 0    0    [1    /1   ]  3617.35417723        1
[INPUT] 0    0    [1    /1   ]  1597.8239074         1
[INPUT] 0    0    [1    /1   ]  382.634904444        1
[INPUT] 0    0    [1    /1   ]  108.044680055        1
[INPUT] 0    0    [1    /1   ]  34.7711199258        1
[INPUT] 0    0    [1    /1   ]  4.58572225587        1
[INPUT] 0    0    [1    /1   ]  0.39545368655        1
[INPUT] 1    0    [1    /1   ]  1362.78178988        1
[INPUT] 1    0    [1    /1   ]  664.783194906        1
[INPUT] 1    0    [1    /1   ]  301.141545266        1
[INPUT] 1    0    [1    /1   ]  314.194615025        1
[INPUT] 1    0    [1    /1   ]  58.3639236213        1
[INPUT] 1    0    [1    /1   ]  7.1055451649         1
[INPUT] 1    0    [1    /1   ]  19.6438920056        1
[INPUT] 1    0    [1    /1   ]  0.76340722609        1
[INPUT] 1    0    [1    /1   ]  2.70946248948        1
[INPUT] 1    0    [1    /1   ]  0.220926968827       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.655779175504, 1.0]], [0, [7617.52173984852, 1.0]], [0, [3617.35417722823, 1.0]], [0, [1597.8239073971515, 1.0]], [0, [382.63490444446455, 1.0]], [0, [108.04468005491752, 1.0]], [0, [34.77111992581162, 1.0]], [0, [4.585722255866042, 1.0]], [0, [0.3954536865498542, 1.0]], [1, [1362.7817898826406, 1.0]], [1, [664.783194905745, 1.0]], [1, [301.14154526614544, 1.0]], [1, [314.1946150249529, 1.0]], [1, [58.36392362125249, 1.0]], [1, [7.105545164902309, 1.0]], [1, [19.643892005558815, 1.0]], [1, [0.763407226089863, 1.0]], [1, [2.7094624894780615, 1.0]], [1, [0.22092696882676643, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65577918]
bas 1, expnt(s) = [7617.52173985]
bas 2, expnt(s) = [3617.35417723]
bas 3, expnt(s) = [1597.8239074]
bas 4, expnt(s) = [382.63490444]
bas 5, expnt(s) = [108.04468005]
bas 6, expnt(s) = [34.77111993]
bas 7, expnt(s) = [4.58572226]
bas 8, expnt(s) = [0.39545369]
bas 9, expnt(s) = [1362.78178988]
bas 10, expnt(s) = [664.78319491]
bas 11, expnt(s) = [301.14154527]
bas 12, expnt(s) = [314.19461502]
bas 13, expnt(s) = [58.36392362]
bas 14, expnt(s) = [7.10554516]
bas 15, expnt(s) = [19.64389201]
bas 16, expnt(s) = [0.76340723]
bas 17, expnt(s) = [2.70946249]
bas 18, expnt(s) = [0.22092697]
CPU time:       794.97
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826558e+04 5.20026286e+03 7.61752174e+03 2.06003833e+03
 3.61735418e+03 1.17844223e+03 1.59782391e+03 6.38501189e+02
 3.82634904e+02 2.18576498e+02 1.08044680e+02 8.46676615e+01
 3.47711199e+01 3.61767071e+01 4.58572226e+00 7.91718576e+00
 3.95453687e-01 1.25990194e+00 1.36278179e+03 2.41555703e+04
 6.64783195e+02 9.84769146e+03 3.01141545e+02 3.65971896e+03
 3.14194615e+02 3.85907140e+03 5.83639236e+01 4.70614163e+02
 7.10554516e+00 3.38439580e+01 1.96438920e+01 1.20647636e+02
 7.63407226e-01 2.08175552e+00 2.70946249e+00 1.01411760e+01
 2.20926969e-01 4.41870807e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97711759619681
cond(S) = 96074.55177913727
E1 = -728.8865871201325  E_coul = 203.12698768906776
init E= -525.759599431065
    CPU time for initialize scf      0.49 sec, wall time      0.07 sec
  HOMO = -0.559417492042029  LUMO = 1.01173255795412
  mo_energy =
[-1.18319073e+02 -1.21031801e+01 -9.44814927e+00 -9.44814927e+00
 -9.44814927e+00 -1.22996236e+00 -5.59417492e-01 -5.59417492e-01
 -5.59417492e-01  1.01173256e+00  1.01173256e+00  1.01173256e+00
  7.05632046e+00  7.05632046e+00  7.05632046e+00  3.21952393e+01
  3.21952393e+01  3.21952393e+01  7.48208849e+01  1.23271941e+02
  1.23271941e+02  1.23271941e+02  4.71468474e+02  4.71468474e+02
  4.71468474e+02  5.58965096e+02  1.32218309e+03  1.32218309e+03
  1.32218309e+03  2.63058705e+03  3.01695999e+03  3.01695999e+03
  3.01695999e+03  6.63864404e+03  6.63864404e+03  6.63864404e+03
  9.03807830e+03  2.53949383e+04  7.61388417e+04]
E1 = -728.0411631723704  E_coul = 201.56484599300634
cycle= 1 E= -526.476317179364  delta_E= -0.717  |g|= 0.185  |ddm|= 0.452
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.543452
diis-c [-0.29533957  1.        ]
  HOMO = -0.575788790001372  LUMO = 1.00215108798164
  mo_energy =
[-1.18599954e+02 -1.22051702e+01 -9.55648295e+00 -9.55648295e+00
 -9.55648295e+00 -1.25403602e+00 -5.75788790e-01 -5.75788790e-01
 -5.75788790e-01  1.00215109e+00  1.00215109e+00  1.00215109e+00
  6.99985691e+00  6.99985691e+00  6.99985691e+00  3.20801133e+01
  3.20801133e+01  3.20801133e+01  7.46500664e+01  1.23080337e+02
  1.23080337e+02  1.23080337e+02  4.71193276e+02  4.71193276e+02
  4.71193276e+02  5.58648605e+02  1.32184818e+03  1.32184818e+03
  1.32184818e+03  2.63011638e+03  3.01655822e+03  3.01655822e+03
  3.01655822e+03  6.63812799e+03  6.63812799e+03  6.63812799e+03
  9.03748612e+03  2.53942516e+04  7.61380645e+04]
E1 = -728.3530016344564  E_coul = 201.87629070831255
cycle= 2 E= -526.476710926144  delta_E= -0.000394  |g|= 0.025  |ddm|= 0.0215
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0487633
diis-c [-0.00152086  0.05123971  0.94876029]
  HOMO = -0.571843150824289  LUMO = 1.00512443716505
  mo_energy =
[-1.18555812e+02 -1.21838471e+01 -9.53473780e+00 -9.53473780e+00
 -9.53473780e+00 -1.24879772e+00 -5.71843151e-01 -5.71843151e-01
 -5.71843151e-01  1.00512444e+00  1.00512444e+00  1.00512444e+00
  7.01123800e+00  7.01123800e+00  7.01123800e+00  3.21022259e+01
  3.21022259e+01  3.21022259e+01  7.46853309e+01  1.23114614e+02
  1.23114614e+02  1.23114614e+02  4.71236796e+02  4.71236796e+02
  4.71236796e+02  5.58694235e+02  1.32189493e+03  1.32189493e+03
  1.32189493e+03  2.63016537e+03  3.01660656e+03  3.01660656e+03
  3.01660656e+03  6.63817733e+03  6.63817733e+03  6.63817733e+03
  9.03753587e+03  2.53943015e+04  7.61381145e+04]
E1 = -728.2879052965511  E_coul = 201.81117996779656
cycle= 3 E= -526.476725328755  delta_E= -1.44e-05  |g|= 0.00308  |ddm|= 0.00549
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00659061
diis-c [-3.74705551e-07 -1.07480768e-03  1.12653835e-01  8.88420973e-01]
  HOMO = -0.572554804301704  LUMO = 1.00460288266666
  mo_energy =
[-1.18561253e+02 -1.21868361e+01 -9.53783306e+00 -9.53783306e+00
 -9.53783306e+00 -1.24972045e+00 -5.72554804e-01 -5.72554804e-01
 -5.72554804e-01  1.00460288e+00  1.00460288e+00  1.00460288e+00
  7.00942435e+00  7.00942435e+00  7.00942435e+00  3.20991192e+01
  3.20991192e+01  3.20991192e+01  7.46809492e+01  1.23110213e+02
  1.23110213e+02  1.23110213e+02  4.71231431e+02  4.71231431e+02
  4.71231431e+02  5.58688615e+02  1.32188918e+03  1.32188918e+03
  1.32188918e+03  2.63015922e+03  3.01660057e+03  3.01660057e+03
  3.01660057e+03  6.63817110e+03  6.63817110e+03  6.63817110e+03
  9.03752951e+03  2.53942950e+04  7.61381079e+04]
E1 = -728.2967747226904  E_coul = 201.82004907097087
cycle= 4 E= -526.47672565172  delta_E= -3.23e-07  |g|= 4.7e-05  |ddm|= 0.000805
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.59055e-05
diis-c [-1.97849208e-09 -4.34923709e-07 -9.05337156e-04  7.07333778e-04
  1.00019844e+00]
  HOMO = -0.572525570437049  LUMO = 1.00462383198996
  mo_energy =
[-1.18561150e+02 -1.21867412e+01 -9.53773899e+00 -9.53773899e+00
 -9.53773899e+00 -1.24968242e+00 -5.72525570e-01 -5.72525570e-01
 -5.72525570e-01  1.00462383e+00  1.00462383e+00  1.00462383e+00
  7.00948997e+00  7.00948997e+00  7.00948997e+00  3.20992095e+01
  3.20992095e+01  3.20992095e+01  7.46810548e+01  1.23110313e+02
  1.23110313e+02  1.23110313e+02  4.71231534e+02  4.71231534e+02
  4.71231534e+02  5.58688715e+02  1.32188928e+03  1.32188928e+03
  1.32188928e+03  2.63015931e+03  3.01660066e+03  3.01660066e+03
  3.01660066e+03  6.63817119e+03  6.63817119e+03  6.63817119e+03
  9.03752959e+03  2.53942951e+04  7.61381080e+04]
E1 = -728.296543716708  E_coul = 201.81981806481662
cycle= 5 E= -526.476725651891  delta_E= -1.72e-10  |g|= 7.2e-06  |ddm|= 2.61e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.296543716708  E_coul = 201.81981806481662
  HOMO = -0.572529361418526  LUMO = 1.00462110699102
  mo_energy =
[-1.18561167e+02 -1.21867542e+01 -9.53775227e+00 -9.53775227e+00
 -9.53775227e+00 -1.24968733e+00 -5.72529361e-01 -5.72529361e-01
 -5.72529361e-01  1.00462111e+00  1.00462111e+00  1.00462111e+00
  7.00948119e+00  7.00948119e+00  7.00948119e+00  3.20991965e+01
  3.20991965e+01  3.20991965e+01  7.46810389e+01  1.23110298e+02
  1.23110298e+02  1.23110298e+02  4.71231517e+02  4.71231517e+02
  4.71231517e+02  5.58688697e+02  1.32188926e+03  1.32188926e+03
  1.32188926e+03  2.63015929e+03  3.01660064e+03  3.01660064e+03
  3.01660064e+03  6.63817117e+03  6.63817117e+03  6.63817117e+03
  9.03752957e+03  2.53942951e+04  7.61381080e+04]
E1 = -728.2965786056624  E_coul = 201.8198529537655
Extra cycle  E= -526.476725651897  delta_E= -5.46e-12  |g|= 1.87e-06  |ddm|= 3.63e-06
    CPU time for scf_cycle      0.72 sec, wall time      0.30 sec
exp = [2.61826558e+04 7.61752174e+03 3.61735418e+03 1.59782391e+03
 3.82634904e+02 1.08044680e+02 3.47711199e+01 4.58572226e+00
 3.95453687e-01 1.36278179e+03 6.64783195e+02 3.01141545e+02
 3.14194615e+02 5.83639236e+01 7.10554516e+00 1.96438920e+01
 7.63407226e-01 2.70946249e+00 2.20926969e-01]
E = -526.4767256518969
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:45:50 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6453979        1
[INPUT] 0    0    [1    /1   ]  7617.55433605        1
[INPUT] 0    0    [1    /1   ]  3617.36638976        1
[INPUT] 0    0    [1    /1   ]  1598.62713586        1
[INPUT] 0    0    [1    /1   ]  379.408114724        1
[INPUT] 0    0    [1    /1   ]  107.178356485        1
[INPUT] 0    0    [1    /1   ]  34.5501162885        1
[INPUT] 0    0    [1    /1   ]  4.58640127186        1
[INPUT] 0    0    [1    /1   ]  0.394672830006       1
[INPUT] 1    0    [1    /1   ]  1362.78064401        1
[INPUT] 1    0    [1    /1   ]  664.79022996         1
[INPUT] 1    0    [1    /1   ]  301.179779815        1
[INPUT] 1    0    [1    /1   ]  314.230950562        1
[INPUT] 1    0    [1    /1   ]  60.2878626776        1
[INPUT] 1    0    [1    /1   ]  7.19554073715        1
[INPUT] 1    0    [1    /1   ]  19.8913256831        1
[INPUT] 1    0    [1    /1   ]  0.784405382257       1
[INPUT] 1    0    [1    /1   ]  2.74388127777        1
[INPUT] 1    0    [1    /1   ]  0.225210187843       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.64539790312, 1.0]], [0, [7617.554336045226, 1.0]], [0, [3617.366389758239, 1.0]], [0, [1598.627135857483, 1.0]], [0, [379.4081147241117, 1.0]], [0, [107.17835648470216, 1.0]], [0, [34.550116288499616, 1.0]], [0, [4.5864012718633145, 1.0]], [0, [0.394672830006401, 1.0]], [1, [1362.780644012424, 1.0]], [1, [664.7902299595571, 1.0]], [1, [301.17977981525775, 1.0]], [1, [314.2309505623295, 1.0]], [1, [60.28786267761833, 1.0]], [1, [7.195540737151375, 1.0]], [1, [19.891325683149972, 1.0]], [1, [0.7844053822572821, 1.0]], [1, [2.74388127777188, 1.0]], [1, [0.22521018784258787, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.6453979]
bas 1, expnt(s) = [7617.55433605]
bas 2, expnt(s) = [3617.36638976]
bas 3, expnt(s) = [1598.62713586]
bas 4, expnt(s) = [379.40811472]
bas 5, expnt(s) = [107.17835648]
bas 6, expnt(s) = [34.55011629]
bas 7, expnt(s) = [4.58640127]
bas 8, expnt(s) = [0.39467283]
bas 9, expnt(s) = [1362.78064401]
bas 10, expnt(s) = [664.79022996]
bas 11, expnt(s) = [301.17977982]
bas 12, expnt(s) = [314.23095056]
bas 13, expnt(s) = [60.28786268]
bas 14, expnt(s) = [7.19554074]
bas 15, expnt(s) = [19.89132568]
bas 16, expnt(s) = [0.78440538]
bas 17, expnt(s) = [2.74388128]
bas 18, expnt(s) = [0.22521019]
CPU time:       796.00
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826454e+04 5.20026131e+03 7.61755434e+03 2.06004494e+03
 3.61736639e+03 1.17844522e+03 1.59862714e+03 6.38741906e+02
 3.79408115e+02 2.17192581e+02 1.07178356e+02 8.41579880e+01
 3.45501163e+01 3.60041166e+01 4.58640127e+00 7.91806497e+00
 3.94672830e-01 1.25803565e+00 1.36278064e+03 2.41555449e+04
 6.64790230e+02 9.84782172e+03 3.01179780e+02 3.66029979e+03
 3.14230951e+02 3.85962927e+03 6.02878627e+01 4.90085386e+02
 7.19554074e+00 3.43806187e+01 1.98913257e+01 1.22550208e+02
 7.84405382e-01 2.15357548e+00 2.74388128e+00 1.03024624e+01
 2.25210188e-01 4.52605090e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.976517756134633
cond(S) = 98527.13807519566
E1 = -728.8849166874033  E_coul = 203.1188053270426
init E= -525.766111360361
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559633123433898  LUMO = 1.04574685256373
  mo_energy =
[-1.18319638e+02 -1.21035919e+01 -9.44899886e+00 -9.44899886e+00
 -9.44899886e+00 -1.23024951e+00 -5.59633123e-01 -5.59633123e-01
 -5.59633123e-01  1.04574685e+00  1.04574685e+00  1.04574685e+00
  7.23841514e+00  7.23841514e+00  7.23841514e+00  3.27707612e+01
  3.27707612e+01  3.27707612e+01  7.40491040e+01  1.26271470e+02
  1.26271470e+02  1.26271470e+02  4.78203982e+02  4.78203982e+02
  4.78203982e+02  5.53715823e+02  1.32992462e+03  1.32992462e+03
  1.32992462e+03  2.61853975e+03  3.02483048e+03  3.02483048e+03
  3.02483048e+03  6.64613478e+03  6.64613478e+03  6.64613478e+03
  9.02459300e+03  2.53821420e+04  7.61270927e+04]
E1 = -728.0557356298633  E_coul = 201.57865665780568
cycle= 1 E= -526.477078972058  delta_E= -0.711  |g|= 0.185  |ddm|= 0.345
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.544607
diis-c [-0.2965973  1.       ]
  HOMO = -0.575578952558071  LUMO = 1.03599703521452
  mo_energy =
[-1.18598290e+02 -1.22038492e+01 -9.55563327e+00 -9.55563327e+00
 -9.55563327e+00 -1.25367102e+00 -5.75578953e-01 -5.75578953e-01
 -5.75578953e-01  1.03599704e+00  1.03599704e+00  1.03599704e+00
  7.18221838e+00  7.18221838e+00  7.18221838e+00  3.26563915e+01
  3.26563915e+01  3.26563915e+01  7.38811130e+01  1.26080049e+02
  1.26080049e+02  1.26080049e+02  4.77930688e+02  4.77930688e+02
  4.77930688e+02  5.53402175e+02  1.32959187e+03  1.32959187e+03
  1.32959187e+03  2.61807127e+03  3.02443093e+03  3.02443093e+03
  3.02443093e+03  6.64562077e+03  6.64562077e+03  6.64562077e+03
  9.02400262e+03  2.53814570e+04  7.61263171e+04]
E1 = -728.3630247898803  E_coul = 201.88555722230365
cycle= 2 E= -526.477467567577  delta_E= -0.000389  |g|= 0.0249  |ddm|= 0.0208
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0484576
diis-c [-0.00150617  0.05070714  0.94929286]
  HOMO = -0.571740905495553  LUMO = 1.0389900065633
  mo_energy =
[-1.18554558e+02 -1.21828227e+01 -9.53419023e+00 -9.53419023e+00
 -9.53419023e+00 -1.24857251e+00 -5.71740905e-01 -5.71740905e-01
 -5.71740905e-01  1.03899001e+00  1.03899001e+00  1.03899001e+00
  7.19351013e+00  7.19351013e+00  7.19351013e+00  3.26783534e+01
  3.26783534e+01  3.26783534e+01  7.39159199e+01  1.26114211e+02
  1.26114211e+02  1.26114211e+02  4.77973825e+02  4.77973825e+02
  4.77973825e+02  5.53447352e+02  1.32963818e+03  1.32963818e+03
  1.32963818e+03  2.61811982e+03  3.02447884e+03  3.02447884e+03
  3.02447884e+03  6.64566968e+03  6.64566968e+03  6.64566968e+03
  9.02405194e+03  2.53815065e+04  7.61263666e+04]
E1 = -728.2988302907447  E_coul = 201.82134862959694
cycle= 3 E= -526.477481661148  delta_E= -1.41e-05  |g|= 0.00306  |ddm|= 0.0054
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00656672
diis-c [-3.78920429e-07 -1.07748928e-03  1.12868063e-01  8.88209426e-01]
  HOMO = -0.572442263071734  LUMO = 1.03845884485853
  mo_energy =
[-1.18559960e+02 -1.21857810e+01 -9.53725451e+00 -9.53725451e+00
 -9.53725451e+00 -1.24948107e+00 -5.72442263e-01 -5.72442263e-01
 -5.72442263e-01  1.03845884e+00  1.03845884e+00  1.03845884e+00
  7.19169963e+00  7.19169963e+00  7.19169963e+00  3.26752597e+01
  3.26752597e+01  3.26752597e+01  7.39115838e+01  1.26109819e+02
  1.26109819e+02  1.26109819e+02  4.77968496e+02  4.77968496e+02
  4.77968496e+02  5.53441775e+02  1.32963247e+03  1.32963247e+03
  1.32963247e+03  2.61811371e+03  3.02447289e+03  3.02447289e+03
  3.02447289e+03  6.64566348e+03  6.64566348e+03  6.64566348e+03
  9.02404561e+03  2.53815001e+04  7.61263601e+04]
E1 = -728.3076030853783  E_coul = 201.83012110644728
cycle= 4 E= -526.477481978931  delta_E= -3.18e-07  |g|= 4.68e-05  |ddm|= 0.000793
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=6.51657e-05
diis-c [-1.95647411e-09 -5.15404764e-07 -9.10825570e-04  5.96896056e-04
  1.00031444e+00]
  HOMO = -0.572413282442836  LUMO = 1.03848025378243
  mo_energy =
[-1.18559857e+02 -1.21856862e+01 -9.53716060e+00 -9.53716060e+00
 -9.53716060e+00 -1.24944333e+00 -5.72413282e-01 -5.72413282e-01
 -5.72413282e-01  1.03848025e+00  1.03848025e+00  1.03848025e+00
  7.19176546e+00  7.19176546e+00  7.19176546e+00  3.26753500e+01
  3.26753500e+01  3.26753500e+01  7.39116892e+01  1.26109919e+02
  1.26109919e+02  1.26109919e+02  4.77968599e+02  4.77968599e+02
  4.77968599e+02  5.53441875e+02  1.32963257e+03  1.32963257e+03
  1.32963257e+03  2.61811380e+03  3.02447299e+03  3.02447299e+03
  3.02447299e+03  6.64566357e+03  6.64566357e+03  6.64566357e+03
  9.02404570e+03  2.53815002e+04  7.61263602e+04]
E1 = -728.3073727349841  E_coul = 201.82989075588048
cycle= 5 E= -526.477481979104  delta_E= -1.73e-10  |g|= 7.28e-06  |ddm|= 2.62e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.3073727349841  E_coul = 201.82989075588048
  HOMO = -0.572417081095977  LUMO = 1.03847743469641
  mo_energy =
[-1.18559875e+02 -1.21856993e+01 -9.53717395e+00 -9.53717395e+00
 -9.53717395e+00 -1.24944824e+00 -5.72417081e-01 -5.72417081e-01
 -5.72417081e-01  1.03847743e+00  1.03847743e+00  1.03847743e+00
  7.19175657e+00  7.19175657e+00  7.19175657e+00  3.26753369e+01
  3.26753369e+01  3.26753369e+01  7.39116731e+01  1.26109903e+02
  1.26109903e+02  1.26109903e+02  4.77968581e+02  4.77968581e+02
  4.77968581e+02  5.53441856e+02  1.32963256e+03  1.32963256e+03
  1.32963256e+03  2.61811379e+03  3.02447297e+03  3.02447297e+03
  3.02447297e+03  6.64566355e+03  6.64566355e+03  6.64566355e+03
  9.02404568e+03  2.53815001e+04  7.61263601e+04]
E1 = -728.3074077272506  E_coul = 201.8299257481438
Extra cycle  E= -526.477481979107  delta_E= -3.18e-12  |g|= 1.88e-06  |ddm|= 3.63e-06
    CPU time for scf_cycle      0.66 sec, wall time      0.28 sec
exp = [2.61826454e+04 7.61755434e+03 3.61736639e+03 1.59862714e+03
 3.79408115e+02 1.07178356e+02 3.45501163e+01 4.58640127e+00
 3.94672830e-01 1.36278064e+03 6.64790230e+02 3.01179780e+02
 3.14230951e+02 6.02878627e+01 7.19554074e+00 1.98913257e+01
 7.84405382e-01 2.74388128e+00 2.25210188e-01]
E = -526.4774819791069
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:45:51 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6453979        1
[INPUT] 0    0    [1    /1   ]  7617.55433605        1
[INPUT] 0    0    [1    /1   ]  3617.36638976        1
[INPUT] 0    0    [1    /1   ]  1598.62713586        1
[INPUT] 0    0    [1    /1   ]  379.408114724        1
[INPUT] 0    0    [1    /1   ]  107.178356485        1
[INPUT] 0    0    [1    /1   ]  34.5501162885        1
[INPUT] 0    0    [1    /1   ]  4.58640127186        1
[INPUT] 0    0    [1    /1   ]  0.394672830006       1
[INPUT] 1    0    [1    /1   ]  1362.78064401        1
[INPUT] 1    0    [1    /1   ]  664.79022996         1
[INPUT] 1    0    [1    /1   ]  301.179779815        1
[INPUT] 1    0    [1    /1   ]  314.230950562        1
[INPUT] 1    0    [1    /1   ]  60.2878626776        1
[INPUT] 1    0    [1    /1   ]  7.19554073715        1
[INPUT] 1    0    [1    /1   ]  19.8913256831        1
[INPUT] 1    0    [1    /1   ]  0.784405382257       1
[INPUT] 1    0    [1    /1   ]  2.74388127777        1
[INPUT] 1    0    [1    /1   ]  0.225210187843       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.64539790312, 1.0]], [0, [7617.554336045226, 1.0]], [0, [3617.366389758239, 1.0]], [0, [1598.627135857483, 1.0]], [0, [379.4081147241117, 1.0]], [0, [107.17835648470216, 1.0]], [0, [34.550116288499616, 1.0]], [0, [4.5864012718633145, 1.0]], [0, [0.394672830006401, 1.0]], [1, [1362.780644012424, 1.0]], [1, [664.7902299595571, 1.0]], [1, [301.17977981525775, 1.0]], [1, [314.2309505623295, 1.0]], [1, [60.28786267761833, 1.0]], [1, [7.195540737151375, 1.0]], [1, [19.891325683149972, 1.0]], [1, [0.7844053822572821, 1.0]], [1, [2.74388127777188, 1.0]], [1, [0.22521018784258787, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.6453979]
bas 1, expnt(s) = [7617.55433605]
bas 2, expnt(s) = [3617.36638976]
bas 3, expnt(s) = [1598.62713586]
bas 4, expnt(s) = [379.40811472]
bas 5, expnt(s) = [107.17835648]
bas 6, expnt(s) = [34.55011629]
bas 7, expnt(s) = [4.58640127]
bas 8, expnt(s) = [0.39467283]
bas 9, expnt(s) = [1362.78064401]
bas 10, expnt(s) = [664.79022996]
bas 11, expnt(s) = [301.17977982]
bas 12, expnt(s) = [314.23095056]
bas 13, expnt(s) = [60.28786268]
bas 14, expnt(s) = [7.19554074]
bas 15, expnt(s) = [19.89132568]
bas 16, expnt(s) = [0.78440538]
bas 17, expnt(s) = [2.74388128]
bas 18, expnt(s) = [0.22521019]
CPU time:       796.96
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826454e+04 5.20026131e+03 7.61755434e+03 2.06004494e+03
 3.61736639e+03 1.17844522e+03 1.59862714e+03 6.38741906e+02
 3.79408115e+02 2.17192581e+02 1.07178356e+02 8.41579880e+01
 3.45501163e+01 3.60041166e+01 4.58640127e+00 7.91806497e+00
 3.94672830e-01 1.25803565e+00 1.36278064e+03 2.41555449e+04
 6.64790230e+02 9.84782172e+03 3.01179780e+02 3.66029979e+03
 3.14230951e+02 3.85962927e+03 6.02878627e+01 4.90085386e+02
 7.19554074e+00 3.43806187e+01 1.98913257e+01 1.22550208e+02
 7.84405382e-01 2.15357548e+00 2.74388128e+00 1.03024624e+01
 2.25210188e-01 4.52605090e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.976517756134633
cond(S) = 98527.13807519566
E1 = -728.8849166874033  E_coul = 203.1188053270426
init E= -525.766111360361
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559633123433898  LUMO = 1.04574685256373
  mo_energy =
[-1.18319638e+02 -1.21035919e+01 -9.44899886e+00 -9.44899886e+00
 -9.44899886e+00 -1.23024951e+00 -5.59633123e-01 -5.59633123e-01
 -5.59633123e-01  1.04574685e+00  1.04574685e+00  1.04574685e+00
  7.23841514e+00  7.23841514e+00  7.23841514e+00  3.27707612e+01
  3.27707612e+01  3.27707612e+01  7.40491040e+01  1.26271470e+02
  1.26271470e+02  1.26271470e+02  4.78203982e+02  4.78203982e+02
  4.78203982e+02  5.53715823e+02  1.32992462e+03  1.32992462e+03
  1.32992462e+03  2.61853975e+03  3.02483048e+03  3.02483048e+03
  3.02483048e+03  6.64613478e+03  6.64613478e+03  6.64613478e+03
  9.02459300e+03  2.53821420e+04  7.61270927e+04]
E1 = -728.0557356298633  E_coul = 201.57865665780568
cycle= 1 E= -526.477078972058  delta_E= -0.711  |g|= 0.185  |ddm|= 0.345
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.544607
diis-c [-0.2965973  1.       ]
  HOMO = -0.575578952558071  LUMO = 1.03599703521452
  mo_energy =
[-1.18598290e+02 -1.22038492e+01 -9.55563327e+00 -9.55563327e+00
 -9.55563327e+00 -1.25367102e+00 -5.75578953e-01 -5.75578953e-01
 -5.75578953e-01  1.03599704e+00  1.03599704e+00  1.03599704e+00
  7.18221838e+00  7.18221838e+00  7.18221838e+00  3.26563915e+01
  3.26563915e+01  3.26563915e+01  7.38811130e+01  1.26080049e+02
  1.26080049e+02  1.26080049e+02  4.77930688e+02  4.77930688e+02
  4.77930688e+02  5.53402175e+02  1.32959187e+03  1.32959187e+03
  1.32959187e+03  2.61807127e+03  3.02443093e+03  3.02443093e+03
  3.02443093e+03  6.64562077e+03  6.64562077e+03  6.64562077e+03
  9.02400262e+03  2.53814570e+04  7.61263171e+04]
E1 = -728.3630247898803  E_coul = 201.88555722230365
cycle= 2 E= -526.477467567577  delta_E= -0.000389  |g|= 0.0249  |ddm|= 0.0208
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0484576
diis-c [-0.00150617  0.05070714  0.94929286]
  HOMO = -0.571740905495553  LUMO = 1.0389900065633
  mo_energy =
[-1.18554558e+02 -1.21828227e+01 -9.53419023e+00 -9.53419023e+00
 -9.53419023e+00 -1.24857251e+00 -5.71740905e-01 -5.71740905e-01
 -5.71740905e-01  1.03899001e+00  1.03899001e+00  1.03899001e+00
  7.19351013e+00  7.19351013e+00  7.19351013e+00  3.26783534e+01
  3.26783534e+01  3.26783534e+01  7.39159199e+01  1.26114211e+02
  1.26114211e+02  1.26114211e+02  4.77973825e+02  4.77973825e+02
  4.77973825e+02  5.53447352e+02  1.32963818e+03  1.32963818e+03
  1.32963818e+03  2.61811982e+03  3.02447884e+03  3.02447884e+03
  3.02447884e+03  6.64566968e+03  6.64566968e+03  6.64566968e+03
  9.02405194e+03  2.53815065e+04  7.61263666e+04]
E1 = -728.2988302907447  E_coul = 201.82134862959694
cycle= 3 E= -526.477481661148  delta_E= -1.41e-05  |g|= 0.00306  |ddm|= 0.0054
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00656672
diis-c [-3.78920429e-07 -1.07748928e-03  1.12868063e-01  8.88209426e-01]
  HOMO = -0.572442263071734  LUMO = 1.03845884485853
  mo_energy =
[-1.18559960e+02 -1.21857810e+01 -9.53725451e+00 -9.53725451e+00
 -9.53725451e+00 -1.24948107e+00 -5.72442263e-01 -5.72442263e-01
 -5.72442263e-01  1.03845884e+00  1.03845884e+00  1.03845884e+00
  7.19169963e+00  7.19169963e+00  7.19169963e+00  3.26752597e+01
  3.26752597e+01  3.26752597e+01  7.39115838e+01  1.26109819e+02
  1.26109819e+02  1.26109819e+02  4.77968496e+02  4.77968496e+02
  4.77968496e+02  5.53441775e+02  1.32963247e+03  1.32963247e+03
  1.32963247e+03  2.61811371e+03  3.02447289e+03  3.02447289e+03
  3.02447289e+03  6.64566348e+03  6.64566348e+03  6.64566348e+03
  9.02404561e+03  2.53815001e+04  7.61263601e+04]
E1 = -728.3076030853783  E_coul = 201.83012110644728
cycle= 4 E= -526.477481978931  delta_E= -3.18e-07  |g|= 4.68e-05  |ddm|= 0.000793
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=6.51657e-05
diis-c [-1.95647411e-09 -5.15404764e-07 -9.10825570e-04  5.96896056e-04
  1.00031444e+00]
  HOMO = -0.572413282442836  LUMO = 1.03848025378243
  mo_energy =
[-1.18559857e+02 -1.21856862e+01 -9.53716060e+00 -9.53716060e+00
 -9.53716060e+00 -1.24944333e+00 -5.72413282e-01 -5.72413282e-01
 -5.72413282e-01  1.03848025e+00  1.03848025e+00  1.03848025e+00
  7.19176546e+00  7.19176546e+00  7.19176546e+00  3.26753500e+01
  3.26753500e+01  3.26753500e+01  7.39116892e+01  1.26109919e+02
  1.26109919e+02  1.26109919e+02  4.77968599e+02  4.77968599e+02
  4.77968599e+02  5.53441875e+02  1.32963257e+03  1.32963257e+03
  1.32963257e+03  2.61811380e+03  3.02447299e+03  3.02447299e+03
  3.02447299e+03  6.64566357e+03  6.64566357e+03  6.64566357e+03
  9.02404570e+03  2.53815002e+04  7.61263602e+04]
E1 = -728.3073727349841  E_coul = 201.82989075588048
cycle= 5 E= -526.477481979104  delta_E= -1.73e-10  |g|= 7.28e-06  |ddm|= 2.62e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.3073727349841  E_coul = 201.82989075588048
  HOMO = -0.572417081095977  LUMO = 1.03847743469641
  mo_energy =
[-1.18559875e+02 -1.21856993e+01 -9.53717395e+00 -9.53717395e+00
 -9.53717395e+00 -1.24944824e+00 -5.72417081e-01 -5.72417081e-01
 -5.72417081e-01  1.03847743e+00  1.03847743e+00  1.03847743e+00
  7.19175657e+00  7.19175657e+00  7.19175657e+00  3.26753369e+01
  3.26753369e+01  3.26753369e+01  7.39116731e+01  1.26109903e+02
  1.26109903e+02  1.26109903e+02  4.77968581e+02  4.77968581e+02
  4.77968581e+02  5.53441856e+02  1.32963256e+03  1.32963256e+03
  1.32963256e+03  2.61811379e+03  3.02447297e+03  3.02447297e+03
  3.02447297e+03  6.64566355e+03  6.64566355e+03  6.64566355e+03
  9.02404568e+03  2.53815001e+04  7.61263601e+04]
E1 = -728.3074077272506  E_coul = 201.8299257481438
Extra cycle  E= -526.477481979107  delta_E= -3.18e-12  |g|= 1.88e-06  |ddm|= 3.63e-06
    CPU time for scf_cycle      0.67 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 98527.13807519566
E1 = -728.3074077272506  E_coul = 201.8299257481438
init E= -526.477481979107
    CPU time for initialize scf      2.81 sec, wall time      0.26 sec
  HOMO = -0.572416420121424  LUMO = 1.03847793110526
  mo_energy =
[-1.18559871e+02 -1.21856967e+01 -9.53717131e+00 -9.53717131e+00
 -9.53717131e+00 -1.24944738e+00 -5.72416420e-01 -5.72416420e-01
 -5.72416420e-01  1.03847793e+00  1.03847793e+00  1.03847793e+00
  7.19175821e+00  7.19175821e+00  7.19175821e+00  3.26753395e+01
  3.26753395e+01  3.26753395e+01  7.39116767e+01  1.26109907e+02
  1.26109907e+02  1.26109907e+02  4.77968585e+02  4.77968585e+02
  4.77968585e+02  5.53441861e+02  1.32963256e+03  1.32963256e+03
  1.32963256e+03  2.61811379e+03  3.02447297e+03  3.02447297e+03
  3.02447297e+03  6.64566356e+03  6.64566356e+03  6.64566356e+03
  9.02404568e+03  2.53815001e+04  7.61263601e+04]
E1 = -728.3074004835973  E_coul = 201.82991850449017
cycle= 1 E= -526.477481979107  delta_E= -3.41e-13  |g|= 4.24e-07  |ddm|= 6.96e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3074004835973  E_coul = 201.82991850449017
  HOMO = -0.572416549158839  LUMO = 1.03847783370989
  mo_energy =
[-1.18559872e+02 -1.21856972e+01 -9.53717185e+00 -9.53717185e+00
 -9.53717185e+00 -1.24944755e+00 -5.72416549e-01 -5.72416549e-01
 -5.72416549e-01  1.03847783e+00  1.03847783e+00  1.03847783e+00
  7.19175788e+00  7.19175788e+00  7.19175788e+00  3.26753390e+01
  3.26753390e+01  3.26753390e+01  7.39116759e+01  1.26109906e+02
  1.26109906e+02  1.26109906e+02  4.77968585e+02  4.77968585e+02
  4.77968585e+02  5.53441860e+02  1.32963256e+03  1.32963256e+03
  1.32963256e+03  2.61811379e+03  3.02447297e+03  3.02447297e+03
  3.02447297e+03  6.64566355e+03  6.64566355e+03  6.64566355e+03
  9.02404568e+03  2.53815001e+04  7.61263601e+04]
E1 = -728.3074020049805  E_coul = 201.82992002587403
Extra cycle  E= -526.477481979107  delta_E= 6.82e-13  |g|= 9.2e-08  |ddm|= 1.42e-07
    CPU time for scf_cycle      2.96 sec, wall time      0.41 sec
exp = [2.61826454e+04 7.61755434e+03 3.61736639e+03 1.59862714e+03
 3.79408115e+02 1.07178356e+02 3.45501163e+01 4.58640127e+00
 3.94672830e-01 1.36278064e+03 6.64790230e+02 3.01179780e+02
 3.14230951e+02 6.02878627e+01 7.19554074e+00 1.98913257e+01
 7.84405382e-01 2.74388128e+00 2.25210188e-01]
grad_E = [-1.52999360e-06  3.50785551e-06 -1.29232133e-06  7.54372798e-05
 -3.99184742e-05  1.52408949e-04 -3.36947733e-04  1.88736987e-03
 -5.51291940e-03 -4.01247187e-07  6.23346727e-06  3.05150391e-05
  2.63842631e-05 -2.65187520e-04  1.09295506e-04  5.86436441e-04
  2.31492587e-02 -4.04223625e-03 -1.90669601e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:45:55 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6394282        1
[INPUT] 0    0    [1    /1   ]  7617.55420091        1
[INPUT] 0    0    [1    /1   ]  3617.32190978        1
[INPUT] 0    0    [1    /1   ]  1598.44735325        1
[INPUT] 0    0    [1    /1   ]  384.760111625        1
[INPUT] 0    0    [1    /1   ]  108.646153598        1
[INPUT] 0    0    [1    /1   ]  34.9393250638        1
[INPUT] 0    0    [1    /1   ]  4.58482249789        1
[INPUT] 0    0    [1    /1   ]  0.395738273332       1
[INPUT] 1    0    [1    /1   ]  1362.77806274        1
[INPUT] 1    0    [1    /1   ]  664.773413212        1
[INPUT] 1    0    [1    /1   ]  301.087187936        1
[INPUT] 1    0    [1    /1   ]  314.151311556        1
[INPUT] 1    0    [1    /1   ]  63.932642944         1
[INPUT] 1    0    [1    /1   ]  7.43255303756        1
[INPUT] 1    0    [1    /1   ]  20.8169081464        1
[INPUT] 1    0    [1    /1   ]  0.755047888866       1
[INPUT] 1    0    [1    /1   ]  2.81538075382        1
[INPUT] 1    0    [1    /1   ]  0.219038517861       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.63942821507, 1.0]], [0, [7617.554200906936, 1.0]], [0, [3617.3219097836995, 1.0]], [0, [1598.4473532538314, 1.0]], [0, [384.7601116249952, 1.0]], [0, [108.64615359796262, 1.0]], [0, [34.93932506377578, 1.0]], [0, [4.5848224978931125, 1.0]], [0, [0.39573827333173045, 1.0]], [1, [1362.7780627368968, 1.0]], [1, [664.7734132119903, 1.0]], [1, [301.08718793582625, 1.0]], [1, [314.1513115559821, 1.0]], [1, [63.9326429440103, 1.0]], [1, [7.432553037563396, 1.0]], [1, [20.816908146433143, 1.0]], [1, [0.7550478888658805, 1.0]], [1, [2.8153807538207394, 1.0]], [1, [0.21903851786067713, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.63942822]
bas 1, expnt(s) = [7617.55420091]
bas 2, expnt(s) = [3617.32190978]
bas 3, expnt(s) = [1598.44735325]
bas 4, expnt(s) = [384.76011162]
bas 5, expnt(s) = [108.6461536]
bas 6, expnt(s) = [34.93932506]
bas 7, expnt(s) = [4.5848225]
bas 8, expnt(s) = [0.39573827]
bas 9, expnt(s) = [1362.77806274]
bas 10, expnt(s) = [664.77341321]
bas 11, expnt(s) = [301.08718794]
bas 12, expnt(s) = [314.15131156]
bas 13, expnt(s) = [63.93264294]
bas 14, expnt(s) = [7.43255304]
bas 15, expnt(s) = [20.81690815]
bas 16, expnt(s) = [0.75504789]
bas 17, expnt(s) = [2.81538075]
bas 18, expnt(s) = [0.21903852]
CPU time:       805.42
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826394e+04 5.20026042e+03 7.61755420e+03 2.06004491e+03
 3.61732191e+03 1.17843435e+03 1.59844735e+03 6.38688030e+02
 3.84760112e+02 2.19486370e+02 1.08646154e+02 8.50209182e+01
 3.49393251e+01 3.63078814e+01 4.58482250e+00 7.91602066e+00
 3.95738273e-01 1.26058189e+00 1.36277806e+03 2.41554877e+04
 6.64773413e+02 9.84751033e+03 3.01087188e+02 3.65889323e+03
 3.14151312e+02 3.85840658e+03 6.39326429e+01 5.27397073e+02
 7.43255304e+00 3.58019691e+01 2.08169081e+01 1.29719323e+02
 7.55047889e-01 2.05330051e+00 2.81538075e+00 1.06391226e+01
 2.19038518e-01 4.37154555e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.977310836030092
cond(S) = 103865.78187600244
E1 = -728.8828399940639  E_coul = 203.12580350630708
init E= -525.757036487757
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559225336933547  LUMO = 0.99828671107835
  mo_energy =
[-1.18318991e+02 -1.21034224e+01 -9.44857269e+00 -9.44857269e+00
 -9.44857269e+00 -1.22999274e+00 -5.59225337e-01 -5.59225337e-01
 -5.59225337e-01  9.98286711e-01  9.98286711e-01  9.98286711e-01
  7.29224463e+00  7.29224463e+00  7.29224463e+00  3.40638851e+01
  3.40638851e+01  3.40638851e+01  7.53851664e+01  1.33194677e+02
  1.33194677e+02  1.33194677e+02  4.92287660e+02  4.92287660e+02
  4.92287660e+02  5.62596174e+02  1.34564807e+03  1.34564807e+03
  1.34564807e+03  2.63939187e+03  3.04035151e+03  3.04035151e+03
  3.04035151e+03  6.66055786e+03  6.66055786e+03  6.66055786e+03
  9.04955693e+03  2.54073096e+04  7.61509671e+04]
E1 = -728.0250030153048  E_coul = 201.5481073333727
cycle= 1 E= -526.476895681932  delta_E= -0.72  |g|= 0.186  |ddm|= 0.431
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.546498
diis-c [-0.29866022  1.        ]
  HOMO = -0.575622312968731  LUMO = 0.988812029987215
  mo_energy =
[-1.18601625e+02 -1.22068348e+01 -9.55835192e+00 -9.55835192e+00
 -9.55835192e+00 -1.25425380e+00 -5.75622313e-01 -5.75622313e-01
 -5.75622313e-01  9.88812030e-01  9.88812030e-01  9.88812030e-01
  7.23309058e+00  7.23309058e+00  7.23309058e+00  3.39435628e+01
  3.39435628e+01  3.39435628e+01  7.52126020e+01  1.32996074e+02
  1.32996074e+02  1.32996074e+02  4.92010429e+02  4.92010429e+02
  4.92010429e+02  5.62277613e+02  1.34531214e+03  1.34531214e+03
  1.34531214e+03  2.63891983e+03  3.03994884e+03  3.03994884e+03
  3.03994884e+03  6.66004090e+03  6.66004090e+03  6.66004090e+03
  9.04896372e+03  2.54066219e+04  7.61501889e+04]
E1 = -728.3400879335907  E_coul = 201.8627950489516
cycle= 2 E= -526.477292884639  delta_E= -0.000397  |g|= 0.0251  |ddm|= 0.0221
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.048846
diis-c [-0.00152155  0.05117497  0.94882503]
  HOMO = -0.571572175415931  LUMO = 0.991837739624913
  mo_energy =
[-1.18557222e+02 -1.21853004e+01 -9.53639482e+00 -9.53639482e+00
 -9.53639482e+00 -1.24888766e+00 -5.71572175e-01 -5.71572175e-01
 -5.71572175e-01  9.91837740e-01  9.91837740e-01  9.91837740e-01
  7.24502804e+00  7.24502804e+00  7.24502804e+00  3.39665522e+01
  3.39665522e+01  3.39665522e+01  7.52481848e+01  1.33031347e+02
  1.33031347e+02  1.33031347e+02  4.92054261e+02  4.92054261e+02
  4.92054261e+02  5.62323531e+02  1.34535912e+03  1.34535912e+03
  1.34535912e+03  2.63896909e+03  3.03999743e+03  3.03999743e+03
  3.03999743e+03  6.66009051e+03  6.66009051e+03  6.66009051e+03
  9.04901374e+03  2.54066721e+04  7.61502391e+04]
E1 = -728.2747846765793  E_coul = 201.79747727473463
cycle= 3 E= -526.477307401845  delta_E= -1.45e-05  |g|= 0.00308  |ddm|= 0.00552
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00660682
diis-c [-3.62570873e-07 -1.08416021e-03  1.12650874e-01  8.88433286e-01]
  HOMO = -0.572281981912249  LUMO = 0.991321888760927
  mo_energy =
[-1.18562673e+02 -1.21882924e+01 -9.53949343e+00 -9.53949343e+00
 -9.53949343e+00 -1.24980914e+00 -5.72281982e-01 -5.72281982e-01
 -5.72281982e-01  9.91321889e-01  9.91321889e-01  9.91321889e-01
  7.24316638e+00  7.24316638e+00  7.24316638e+00  3.39633689e+01
  3.39633689e+01  3.39633689e+01  7.52437889e+01  1.33026861e+02
  1.33026861e+02  1.33026861e+02  4.92048881e+02  4.92048881e+02
  4.92048881e+02  5.62317898e+02  1.34535337e+03  1.34535337e+03
  1.34535337e+03  2.63896293e+03  3.03999143e+03  3.03999143e+03
  3.03999143e+03  6.66008426e+03  6.66008426e+03  6.66008426e+03
  9.04900736e+03  2.54066656e+04  7.61502325e+04]
E1 = -728.2836228754417  E_coul = 201.80631515199062
cycle= 4 E= -526.477307723451  delta_E= -3.22e-07  |g|= 4.45e-05  |ddm|= 0.000807
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.10486e-05
diis-c [-1.89042150e-09  2.49259733e-06 -1.22570355e-03 -2.69240387e-03
  1.00391561e+00]
  HOMO = -0.572253483211953  LUMO = 0.991342161558787
  mo_energy =
[-1.18562575e+02 -1.21882014e+01 -9.53940339e+00 -9.53940339e+00
 -9.53940339e+00 -1.24977217e+00 -5.72253483e-01 -5.72253483e-01
 -5.72253483e-01  9.91342162e-01  9.91342162e-01  9.91342162e-01
  7.24323099e+00  7.24323099e+00  7.24323099e+00  3.39634562e+01
  3.39634562e+01  3.39634562e+01  7.52438898e+01  1.33026957e+02
  1.33026957e+02  1.33026957e+02  4.92048979e+02  4.92048979e+02
  4.92048979e+02  5.62317993e+02  1.34535346e+03  1.34535346e+03
  1.34535346e+03  2.63896301e+03  3.03999152e+03  3.03999152e+03
  3.03999152e+03  6.66008435e+03  6.66008435e+03  6.66008435e+03
  9.04900744e+03  2.54066657e+04  7.61502326e+04]
E1 = -728.2834048080185  E_coul = 201.8060970844142
cycle= 5 E= -526.477307723604  delta_E= -1.53e-10  |g|= 7.1e-06  |ddm|= 2.45e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.2834048080185  E_coul = 201.8060970844142
  HOMO = -0.572257223520496  LUMO = 0.991339496092975
  mo_energy =
[-1.18562593e+02 -1.21882143e+01 -9.53941653e+00 -9.53941653e+00
 -9.53941653e+00 -1.24977702e+00 -5.72257224e-01 -5.72257224e-01
 -5.72257224e-01  9.91339496e-01  9.91339496e-01  9.91339496e-01
  7.24322213e+00  7.24322213e+00  7.24322213e+00  3.39634431e+01
  3.39634431e+01  3.39634431e+01  7.52438741e+01  1.33026941e+02
  1.33026941e+02  1.33026941e+02  4.92048962e+02  4.92048962e+02
  4.92048962e+02  5.62317975e+02  1.34535344e+03  1.34535344e+03
  1.34535344e+03  2.63896299e+03  3.03999150e+03  3.03999150e+03
  3.03999150e+03  6.66008433e+03  6.66008433e+03  6.66008433e+03
  9.04900743e+03  2.54066657e+04  7.61502326e+04]
E1 = -728.2834391096652  E_coul = 201.8061313860584
Extra cycle  E= -526.477307723607  delta_E= -2.5e-12  |g|= 1.84e-06  |ddm|= 3.6e-06
    CPU time for scf_cycle      0.67 sec, wall time      0.28 sec
exp = [2.61826394e+04 7.61755420e+03 3.61732191e+03 1.59844735e+03
 3.84760112e+02 1.08646154e+02 3.49393251e+01 4.58482250e+00
 3.95738273e-01 1.36277806e+03 6.64773413e+02 3.01087188e+02
 3.14151312e+02 6.39326429e+01 7.43255304e+00 2.08169081e+01
 7.55047889e-01 2.81538075e+00 2.19038518e-01]
E = -526.4773077236068
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:45:56 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.642744         1
[INPUT] 0    0    [1    /1   ]  7617.55427597        1
[INPUT] 0    0    [1    /1   ]  3617.34661583        1
[INPUT] 0    0    [1    /1   ]  1598.54721205        1
[INPUT] 0    0    [1    /1   ]  381.787388255        1
[INPUT] 0    0    [1    /1   ]  107.830877569        1
[INPUT] 0    0    [1    /1   ]  34.723142199         1
[INPUT] 0    0    [1    /1   ]  4.58569941512        1
[INPUT] 0    0    [1    /1   ]  0.395146481458       1
[INPUT] 1    0    [1    /1   ]  1362.77949649        1
[INPUT] 1    0    [1    /1   ]  664.782753938        1
[INPUT] 1    0    [1    /1   ]  301.138617346        1
[INPUT] 1    0    [1    /1   ]  314.195546398        1
[INPUT] 1    0    [1    /1   ]  61.9081792384        1
[INPUT] 1    0    [1    /1   ]  7.30090647319        1
[INPUT] 1    0    [1    /1   ]  20.302800857         1
[INPUT] 1    0    [1    /1   ]  0.771354271011       1
[INPUT] 1    0    [1    /1   ]  2.77566694842        1
[INPUT] 1    0    [1    /1   ]  0.222466522011       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.642744029992, 1.0]], [0, [7617.554275968405, 1.0]], [0, [3617.3466158256274, 1.0]], [0, [1598.547212046237, 1.0]], [0, [381.7873882545121, 1.0]], [0, [107.83087756874879, 1.0]], [0, [34.72314219900814, 1.0]], [0, [4.585699415119495, 1.0]], [0, [0.3951464814581946, 1.0]], [1, [1362.7794964855009, 1.0]], [1, [664.7827539383459, 1.0]], [1, [301.1386173460072, 1.0]], [1, [314.1955463976226, 1.0]], [1, [61.90817923843706, 1.0]], [1, [7.300906473192167, 1.0]], [1, [20.302800856973203, 1.0]], [1, [0.771354271010649, 1.0]], [1, [2.7756669484198704, 1.0]], [1, [0.22246652201126, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.64274403]
bas 1, expnt(s) = [7617.55427597]
bas 2, expnt(s) = [3617.34661583]
bas 3, expnt(s) = [1598.54721205]
bas 4, expnt(s) = [381.78738825]
bas 5, expnt(s) = [107.83087757]
bas 6, expnt(s) = [34.7231422]
bas 7, expnt(s) = [4.58569942]
bas 8, expnt(s) = [0.39514648]
bas 9, expnt(s) = [1362.77949649]
bas 10, expnt(s) = [664.78275394]
bas 11, expnt(s) = [301.13861735]
bas 12, expnt(s) = [314.1955464]
bas 13, expnt(s) = [61.90817924]
bas 14, expnt(s) = [7.30090647]
bas 15, expnt(s) = [20.30280086]
bas 16, expnt(s) = [0.77135427]
bas 17, expnt(s) = [2.77566695]
bas 18, expnt(s) = [0.22246652]
CPU time:       806.39
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826427e+04 5.20026091e+03 7.61755428e+03 2.06004493e+03
 3.61734662e+03 1.17844039e+03 1.59854721e+03 6.38717955e+02
 3.81787388e+02 2.18213295e+02 1.07830878e+02 8.45419730e+01
 3.47231422e+01 3.61392627e+01 4.58569942e+00 7.91715618e+00
 3.95146481e-01 1.25916781e+00 1.36277950e+03 2.41555194e+04
 6.64782754e+02 9.84768329e+03 3.01138617e+02 3.65967448e+03
 3.14195546e+02 3.85908570e+03 6.19081792e+01 5.06604953e+02
 7.30090647e+00 3.50110692e+01 2.03028009e+01 1.25727227e+02
 7.71354271e-01 2.10887944e+00 2.77566695e+00 1.04518600e+01
 2.22466522e-01 4.45723184e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.976898508699776
cond(S) = 100798.8738535941
E1 = -728.885775385704  E_coul = 203.1226658100612
init E= -525.763109575643
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559463347893535  LUMO = 1.02463753832297
  mo_energy =
[-1.18319324e+02 -1.21034536e+01 -9.44877632e+00 -9.44877632e+00
 -9.44877632e+00 -1.23010784e+00 -5.59463348e-01 -5.59463348e-01
 -5.59463348e-01  1.02463754e+00  1.02463754e+00  1.02463754e+00
  7.26223186e+00  7.26223186e+00  7.26223186e+00  3.33425075e+01
  3.33425075e+01  3.33425075e+01  7.46419018e+01  1.29354007e+02
  1.29354007e+02  1.29354007e+02  4.84485549e+02  4.84485549e+02
  4.84485549e+02  5.57664586e+02  1.33690988e+03  1.33690988e+03
  1.33690988e+03  2.62781871e+03  3.03171299e+03  3.03171299e+03
  3.03171299e+03  6.65252498e+03  6.65252498e+03  6.65252498e+03
  9.03569270e+03  2.53933283e+04  7.61377028e+04]
E1 = -728.0437788077709  E_coul = 201.56639696897335
cycle= 1 E= -526.477381838798  delta_E= -0.714  |g|= 0.185  |ddm|= 0.361
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.545437
diis-c [-0.29750116  1.        ]
  HOMO = -0.575630980032617  LUMO = 1.01498439319558
  mo_energy =
[-1.18599631e+02 -1.22050494e+01 -9.55674585e+00 -9.55674585e+00
 -9.55674585e+00 -1.25392008e+00 -5.75630980e-01 -5.75630980e-01
 -5.75630980e-01  1.01498439e+00  1.01498439e+00  1.01498439e+00
  7.20473063e+00  7.20473063e+00  7.20473063e+00  3.32255470e+01
  3.32255470e+01  3.32255470e+01  7.44719801e+01  1.29159448e+02
  1.29159448e+02  1.29159448e+02  4.84210624e+02  4.84210624e+02
  4.84210624e+02  5.57348865e+02  1.33657583e+03  1.33657583e+03
  1.33657583e+03  2.62734877e+03  3.03131218e+03  3.03131218e+03
  3.03131218e+03  6.65200978e+03  6.65200978e+03  6.65200978e+03
  9.03510119e+03  2.53926422e+04  7.61369262e+04]
E1 = -728.3544471505103  E_coul = 201.87667335298394
cycle= 2 E= -526.477773797526  delta_E= -0.000392  |g|= 0.025  |ddm|= 0.0213
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0486171
diis-c [-0.0015126   0.05089201  0.94910799]
  HOMO = -0.571700407601572  LUMO = 1.01799274386928
  mo_energy =
[-1.18555612e+02 -1.21838013e+01 -9.53507870e+00 -9.53507870e+00
 -9.53507870e+00 -1.24870470e+00 -5.71700408e-01 -5.71700408e-01
 -5.71700408e-01  1.01799274e+00  1.01799274e+00  1.01799274e+00
  7.21630480e+00  7.21630480e+00  7.21630480e+00  3.32479614e+01
  3.32479614e+01  3.32479614e+01  7.45071234e+01  1.29194100e+02
  1.29194100e+02  1.29194100e+02  4.84254058e+02  4.84254058e+02
  4.84254058e+02  5.57394359e+02  1.33662243e+03  1.33662243e+03
  1.33662243e+03  2.62739762e+03  3.03136038e+03  3.03136038e+03
  3.03136038e+03  6.65205899e+03  6.65205899e+03  6.65205899e+03
  9.03515081e+03  2.53926920e+04  7.61369760e+04]
E1 = -728.2897325224333  E_coul = 201.81194444380918
cycle= 3 E= -526.477788078624  delta_E= -1.43e-05  |g|= 0.00307  |ddm|= 0.00545
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00658736
diis-c [-3.71903267e-07 -1.08104020e-03  1.12841478e-01  8.88239562e-01]
  HOMO = -0.572406395400996  LUMO = 1.01746755134271
  mo_energy =
[-1.18561039e+02 -1.21867769e+01 -9.53816059e+00 -9.53816059e+00
 -9.53816059e+00 -1.24962006e+00 -5.72406395e-01 -5.72406395e-01
 -5.72406395e-01  1.01746755e+00  1.01746755e+00  1.01746755e+00
  7.21446984e+00  7.21446984e+00  7.21446984e+00  3.32448254e+01
  3.32448254e+01  3.32448254e+01  7.45027580e+01  1.29189663e+02
  1.29189663e+02  1.29189663e+02  4.84248704e+02  4.84248704e+02
  4.84248704e+02  5.57388754e+02  1.33661670e+03  1.33661670e+03
  1.33661670e+03  2.62739148e+03  3.03135440e+03  3.03135440e+03
  3.03135440e+03  6.65205277e+03  6.65205277e+03  6.65205277e+03
  9.03514445e+03  2.53926856e+04  7.61369695e+04]
E1 = -728.2985457543347  E_coul = 201.8207573555805
cycle= 4 E= -526.477788398754  delta_E= -3.2e-07  |g|= 4.59e-05  |ddm|= 0.0008
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.34901e-05
diis-c [-1.93006845e-09  5.32043250e-07 -1.02271832e-03 -6.08245202e-04
  1.00163043e+00]
  HOMO = -0.572377565044297  LUMO = 1.0174885023339
  mo_energy =
[-1.18560938e+02 -1.21866836e+01 -9.53806816e+00 -9.53806816e+00
 -9.53806816e+00 -1.24958257e+00 -5.72377565e-01 -5.72377565e-01
 -5.72377565e-01  1.01748850e+00  1.01748850e+00  1.01748850e+00
  7.21453530e+00  7.21453530e+00  7.21453530e+00  3.32449146e+01
  3.32449146e+01  3.32449146e+01  7.45028617e+01  1.29189762e+02
  1.29189762e+02  1.29189762e+02  4.84248805e+02  4.84248805e+02
  4.84248805e+02  5.57388852e+02  1.33661680e+03  1.33661680e+03
  1.33661680e+03  2.62739157e+03  3.03135450e+03  3.03135450e+03
  3.03135450e+03  6.65205285e+03  6.65205285e+03  6.65205285e+03
  9.03514454e+03  2.53926856e+04  7.61369695e+04]
E1 = -728.2983199589478  E_coul = 201.82053156002937
cycle= 5 E= -526.477788398918  delta_E= -1.64e-10  |g|= 7.21e-06  |ddm|= 2.55e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.04 sec
E1 = -728.2983199589478  E_coul = 201.82053156002937
  HOMO = -0.572381344846606  LUMO = 1.01748574605924
  mo_energy =
[-1.18560956e+02 -1.21866966e+01 -9.53808144e+00 -9.53808144e+00
 -9.53808144e+00 -1.24958746e+00 -5.72381345e-01 -5.72381345e-01
 -5.72381345e-01  1.01748575e+00  1.01748575e+00  1.01748575e+00
  7.21452640e+00  7.21452640e+00  7.21452640e+00  3.32449015e+01
  3.32449015e+01  3.32449015e+01  7.45028457e+01  1.29189746e+02
  1.29189746e+02  1.29189746e+02  4.84248787e+02  4.84248787e+02
  4.84248787e+02  5.57388834e+02  1.33661678e+03  1.33661678e+03
  1.33661678e+03  2.62739155e+03  3.03135448e+03  3.03135448e+03
  3.03135448e+03  6.65205284e+03  6.65205284e+03  6.65205284e+03
  9.03514452e+03  2.53926856e+04  7.61369695e+04]
E1 = -728.298354731897  E_coul = 201.82056633297438
Extra cycle  E= -526.477788398923  delta_E= -4.21e-12  |g|= 1.87e-06  |ddm|= 3.62e-06
    CPU time for scf_cycle      0.67 sec, wall time      0.28 sec
exp = [2.61826427e+04 7.61755428e+03 3.61734662e+03 1.59854721e+03
 3.81787388e+02 1.07830878e+02 3.47231422e+01 4.58569942e+00
 3.95146481e-01 1.36277950e+03 6.64782754e+02 3.01138617e+02
 3.14195546e+02 6.19081792e+01 7.30090647e+00 2.03028009e+01
 7.71354271e-01 2.77566695e+00 2.22466522e-01]
E = -526.4777883989226
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:45:57 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.642744         1
[INPUT] 0    0    [1    /1   ]  7617.55427597        1
[INPUT] 0    0    [1    /1   ]  3617.34661583        1
[INPUT] 0    0    [1    /1   ]  1598.54721205        1
[INPUT] 0    0    [1    /1   ]  381.787388255        1
[INPUT] 0    0    [1    /1   ]  107.830877569        1
[INPUT] 0    0    [1    /1   ]  34.723142199         1
[INPUT] 0    0    [1    /1   ]  4.58569941512        1
[INPUT] 0    0    [1    /1   ]  0.395146481458       1
[INPUT] 1    0    [1    /1   ]  1362.77949649        1
[INPUT] 1    0    [1    /1   ]  664.782753938        1
[INPUT] 1    0    [1    /1   ]  301.138617346        1
[INPUT] 1    0    [1    /1   ]  314.195546398        1
[INPUT] 1    0    [1    /1   ]  61.9081792384        1
[INPUT] 1    0    [1    /1   ]  7.30090647319        1
[INPUT] 1    0    [1    /1   ]  20.302800857         1
[INPUT] 1    0    [1    /1   ]  0.771354271011       1
[INPUT] 1    0    [1    /1   ]  2.77566694842        1
[INPUT] 1    0    [1    /1   ]  0.222466522011       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.642744029992, 1.0]], [0, [7617.554275968405, 1.0]], [0, [3617.3466158256274, 1.0]], [0, [1598.547212046237, 1.0]], [0, [381.7873882545121, 1.0]], [0, [107.83087756874879, 1.0]], [0, [34.72314219900814, 1.0]], [0, [4.585699415119495, 1.0]], [0, [0.3951464814581946, 1.0]], [1, [1362.7794964855009, 1.0]], [1, [664.7827539383459, 1.0]], [1, [301.1386173460072, 1.0]], [1, [314.1955463976226, 1.0]], [1, [61.90817923843706, 1.0]], [1, [7.300906473192167, 1.0]], [1, [20.302800856973203, 1.0]], [1, [0.771354271010649, 1.0]], [1, [2.7756669484198704, 1.0]], [1, [0.22246652201126, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.64274403]
bas 1, expnt(s) = [7617.55427597]
bas 2, expnt(s) = [3617.34661583]
bas 3, expnt(s) = [1598.54721205]
bas 4, expnt(s) = [381.78738825]
bas 5, expnt(s) = [107.83087757]
bas 6, expnt(s) = [34.7231422]
bas 7, expnt(s) = [4.58569942]
bas 8, expnt(s) = [0.39514648]
bas 9, expnt(s) = [1362.77949649]
bas 10, expnt(s) = [664.78275394]
bas 11, expnt(s) = [301.13861735]
bas 12, expnt(s) = [314.1955464]
bas 13, expnt(s) = [61.90817924]
bas 14, expnt(s) = [7.30090647]
bas 15, expnt(s) = [20.30280086]
bas 16, expnt(s) = [0.77135427]
bas 17, expnt(s) = [2.77566695]
bas 18, expnt(s) = [0.22246652]
CPU time:       807.37
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826427e+04 5.20026091e+03 7.61755428e+03 2.06004493e+03
 3.61734662e+03 1.17844039e+03 1.59854721e+03 6.38717955e+02
 3.81787388e+02 2.18213295e+02 1.07830878e+02 8.45419730e+01
 3.47231422e+01 3.61392627e+01 4.58569942e+00 7.91715618e+00
 3.95146481e-01 1.25916781e+00 1.36277950e+03 2.41555194e+04
 6.64782754e+02 9.84768329e+03 3.01138617e+02 3.65967448e+03
 3.14195546e+02 3.85908570e+03 6.19081792e+01 5.06604953e+02
 7.30090647e+00 3.50110692e+01 2.03028009e+01 1.25727227e+02
 7.71354271e-01 2.10887944e+00 2.77566695e+00 1.04518600e+01
 2.22466522e-01 4.45723184e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.976898508699776
cond(S) = 100798.8738535941
E1 = -728.885775385704  E_coul = 203.1226658100612
init E= -525.763109575643
    CPU time for initialize scf      0.45 sec, wall time      0.05 sec
  HOMO = -0.559463347893535  LUMO = 1.02463753832297
  mo_energy =
[-1.18319324e+02 -1.21034536e+01 -9.44877632e+00 -9.44877632e+00
 -9.44877632e+00 -1.23010784e+00 -5.59463348e-01 -5.59463348e-01
 -5.59463348e-01  1.02463754e+00  1.02463754e+00  1.02463754e+00
  7.26223186e+00  7.26223186e+00  7.26223186e+00  3.33425075e+01
  3.33425075e+01  3.33425075e+01  7.46419018e+01  1.29354007e+02
  1.29354007e+02  1.29354007e+02  4.84485549e+02  4.84485549e+02
  4.84485549e+02  5.57664586e+02  1.33690988e+03  1.33690988e+03
  1.33690988e+03  2.62781871e+03  3.03171299e+03  3.03171299e+03
  3.03171299e+03  6.65252498e+03  6.65252498e+03  6.65252498e+03
  9.03569270e+03  2.53933283e+04  7.61377028e+04]
E1 = -728.0437788077709  E_coul = 201.56639696897335
cycle= 1 E= -526.477381838798  delta_E= -0.714  |g|= 0.185  |ddm|= 0.361
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.545437
diis-c [-0.29750116  1.        ]
  HOMO = -0.575630980032617  LUMO = 1.01498439319558
  mo_energy =
[-1.18599631e+02 -1.22050494e+01 -9.55674585e+00 -9.55674585e+00
 -9.55674585e+00 -1.25392008e+00 -5.75630980e-01 -5.75630980e-01
 -5.75630980e-01  1.01498439e+00  1.01498439e+00  1.01498439e+00
  7.20473063e+00  7.20473063e+00  7.20473063e+00  3.32255470e+01
  3.32255470e+01  3.32255470e+01  7.44719801e+01  1.29159448e+02
  1.29159448e+02  1.29159448e+02  4.84210624e+02  4.84210624e+02
  4.84210624e+02  5.57348865e+02  1.33657583e+03  1.33657583e+03
  1.33657583e+03  2.62734877e+03  3.03131218e+03  3.03131218e+03
  3.03131218e+03  6.65200978e+03  6.65200978e+03  6.65200978e+03
  9.03510119e+03  2.53926422e+04  7.61369262e+04]
E1 = -728.3544471505103  E_coul = 201.87667335298394
cycle= 2 E= -526.477773797526  delta_E= -0.000392  |g|= 0.025  |ddm|= 0.0213
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0486171
diis-c [-0.0015126   0.05089201  0.94910799]
  HOMO = -0.571700407601572  LUMO = 1.01799274386928
  mo_energy =
[-1.18555612e+02 -1.21838013e+01 -9.53507870e+00 -9.53507870e+00
 -9.53507870e+00 -1.24870470e+00 -5.71700408e-01 -5.71700408e-01
 -5.71700408e-01  1.01799274e+00  1.01799274e+00  1.01799274e+00
  7.21630480e+00  7.21630480e+00  7.21630480e+00  3.32479614e+01
  3.32479614e+01  3.32479614e+01  7.45071234e+01  1.29194100e+02
  1.29194100e+02  1.29194100e+02  4.84254058e+02  4.84254058e+02
  4.84254058e+02  5.57394359e+02  1.33662243e+03  1.33662243e+03
  1.33662243e+03  2.62739762e+03  3.03136038e+03  3.03136038e+03
  3.03136038e+03  6.65205899e+03  6.65205899e+03  6.65205899e+03
  9.03515081e+03  2.53926920e+04  7.61369760e+04]
E1 = -728.2897325224333  E_coul = 201.81194444380918
cycle= 3 E= -526.477788078624  delta_E= -1.43e-05  |g|= 0.00307  |ddm|= 0.00545
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00658736
diis-c [-3.71903267e-07 -1.08104020e-03  1.12841478e-01  8.88239562e-01]
  HOMO = -0.572406395400996  LUMO = 1.01746755134271
  mo_energy =
[-1.18561039e+02 -1.21867769e+01 -9.53816059e+00 -9.53816059e+00
 -9.53816059e+00 -1.24962006e+00 -5.72406395e-01 -5.72406395e-01
 -5.72406395e-01  1.01746755e+00  1.01746755e+00  1.01746755e+00
  7.21446984e+00  7.21446984e+00  7.21446984e+00  3.32448254e+01
  3.32448254e+01  3.32448254e+01  7.45027580e+01  1.29189663e+02
  1.29189663e+02  1.29189663e+02  4.84248704e+02  4.84248704e+02
  4.84248704e+02  5.57388754e+02  1.33661670e+03  1.33661670e+03
  1.33661670e+03  2.62739148e+03  3.03135440e+03  3.03135440e+03
  3.03135440e+03  6.65205277e+03  6.65205277e+03  6.65205277e+03
  9.03514445e+03  2.53926856e+04  7.61369695e+04]
E1 = -728.2985457543347  E_coul = 201.8207573555805
cycle= 4 E= -526.477788398754  delta_E= -3.2e-07  |g|= 4.59e-05  |ddm|= 0.0008
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=6.34901e-05
diis-c [-1.93006845e-09  5.32043250e-07 -1.02271832e-03 -6.08245202e-04
  1.00163043e+00]
  HOMO = -0.572377565044297  LUMO = 1.0174885023339
  mo_energy =
[-1.18560938e+02 -1.21866836e+01 -9.53806816e+00 -9.53806816e+00
 -9.53806816e+00 -1.24958257e+00 -5.72377565e-01 -5.72377565e-01
 -5.72377565e-01  1.01748850e+00  1.01748850e+00  1.01748850e+00
  7.21453530e+00  7.21453530e+00  7.21453530e+00  3.32449146e+01
  3.32449146e+01  3.32449146e+01  7.45028617e+01  1.29189762e+02
  1.29189762e+02  1.29189762e+02  4.84248805e+02  4.84248805e+02
  4.84248805e+02  5.57388852e+02  1.33661680e+03  1.33661680e+03
  1.33661680e+03  2.62739157e+03  3.03135450e+03  3.03135450e+03
  3.03135450e+03  6.65205285e+03  6.65205285e+03  6.65205285e+03
  9.03514454e+03  2.53926856e+04  7.61369695e+04]
E1 = -728.2983199589478  E_coul = 201.82053156002937
cycle= 5 E= -526.477788398918  delta_E= -1.64e-10  |g|= 7.21e-06  |ddm|= 2.55e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.2983199589478  E_coul = 201.82053156002937
  HOMO = -0.572381344846606  LUMO = 1.01748574605924
  mo_energy =
[-1.18560956e+02 -1.21866966e+01 -9.53808144e+00 -9.53808144e+00
 -9.53808144e+00 -1.24958746e+00 -5.72381345e-01 -5.72381345e-01
 -5.72381345e-01  1.01748575e+00  1.01748575e+00  1.01748575e+00
  7.21452640e+00  7.21452640e+00  7.21452640e+00  3.32449015e+01
  3.32449015e+01  3.32449015e+01  7.45028457e+01  1.29189746e+02
  1.29189746e+02  1.29189746e+02  4.84248787e+02  4.84248787e+02
  4.84248787e+02  5.57388834e+02  1.33661678e+03  1.33661678e+03
  1.33661678e+03  2.62739155e+03  3.03135448e+03  3.03135448e+03
  3.03135448e+03  6.65205284e+03  6.65205284e+03  6.65205284e+03
  9.03514452e+03  2.53926856e+04  7.61369695e+04]
E1 = -728.298354731897  E_coul = 201.82056633297438
Extra cycle  E= -526.477788398923  delta_E= -4.21e-12  |g|= 1.87e-06  |ddm|= 3.62e-06
    CPU time for scf_cycle      0.67 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 100798.8738535941
E1 = -728.298354731897  E_coul = 201.82056633297438
init E= -526.477788398923
    CPU time for initialize scf      2.86 sec, wall time      0.27 sec
  HOMO = -0.572380685784784  LUMO = 1.01748623252112
  mo_energy =
[-1.18560952e+02 -1.21866941e+01 -9.53807882e+00 -9.53807882e+00
 -9.53807882e+00 -1.24958661e+00 -5.72380686e-01 -5.72380686e-01
 -5.72380686e-01  1.01748623e+00  1.01748623e+00  1.01748623e+00
  7.21452804e+00  7.21452804e+00  7.21452804e+00  3.32449041e+01
  3.32449041e+01  3.32449041e+01  7.45028492e+01  1.29189750e+02
  1.29189750e+02  1.29189750e+02  4.84248791e+02  4.84248791e+02
  4.84248791e+02  5.57388838e+02  1.33661678e+03  1.33661678e+03
  1.33661678e+03  2.62739155e+03  3.03135448e+03  3.03135448e+03
  3.03135448e+03  6.65205284e+03  6.65205284e+03  6.65205284e+03
  9.03514452e+03  2.53926856e+04  7.61369695e+04]
E1 = -728.2983475485834  E_coul = 201.82055914966182
cycle= 1 E= -526.477788398922  delta_E= 1.02e-12  |g|= 4.2e-07  |ddm|= 6.9e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2983475485834  E_coul = 201.82055914966182
  HOMO = -0.572380814017105  LUMO = 1.01748613742009
  mo_energy =
[-1.18560953e+02 -1.21866946e+01 -9.53807936e+00 -9.53807936e+00
 -9.53807936e+00 -1.24958677e+00 -5.72380814e-01 -5.72380814e-01
 -5.72380814e-01  1.01748614e+00  1.01748614e+00  1.01748614e+00
  7.21452772e+00  7.21452772e+00  7.21452772e+00  3.32449036e+01
  3.32449036e+01  3.32449036e+01  7.45028485e+01  1.29189749e+02
  1.29189749e+02  1.29189749e+02  4.84248790e+02  4.84248790e+02
  4.84248790e+02  5.57388837e+02  1.33661678e+03  1.33661678e+03
  1.33661678e+03  2.62739155e+03  3.03135448e+03  3.03135448e+03
  3.03135448e+03  6.65205284e+03  6.65205284e+03  6.65205284e+03
  9.03514452e+03  2.53926856e+04  7.61369695e+04]
E1 = -728.2983490552081  E_coul = 201.8205606562857
Extra cycle  E= -526.477788398922  delta_E= -7.96e-13  |g|= 9.09e-08  |ddm|= 1.41e-07
    CPU time for scf_cycle      3.01 sec, wall time      0.41 sec
exp = [2.61826427e+04 7.61755428e+03 3.61734662e+03 1.59854721e+03
 3.81787388e+02 1.07830878e+02 3.47231422e+01 4.58569942e+00
 3.95146481e-01 1.36277950e+03 6.64782754e+02 3.01138617e+02
 3.14195546e+02 6.19081792e+01 7.30090647e+00 2.03028009e+01
 7.71354271e-01 2.77566695e+00 2.22466522e-01]
grad_E = [-1.51809749e-06  3.37383818e-06 -1.39225418e-06  7.10993557e-05
  3.34296400e-06  1.86000324e-05  6.12031665e-05  6.94229682e-04
  3.78692023e-04 -5.19332904e-07  4.84449828e-06  2.27237969e-05
  1.95889818e-05 -1.80237381e-05  6.49369024e-04  1.84620599e-04
  9.35027119e-04 -3.32312357e-03  6.00118918e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:46:01 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.644356         1
[INPUT] 0    0    [1    /1   ]  7617.55106746        1
[INPUT] 0    0    [1    /1   ]  3617.34978218        1
[INPUT] 0    0    [1    /1   ]  1598.48541538        1
[INPUT] 0    0    [1    /1   ]  381.594493475        1
[INPUT] 0    0    [1    /1   ]  107.703722024        1
[INPUT] 0    0    [1    /1   ]  34.6900241777        1
[INPUT] 0    0    [1    /1   ]  4.58475937073        1
[INPUT] 0    0    [1    /1   ]  0.395310947938       1
[INPUT] 1    0    [1    /1   ]  1362.77985986        1
[INPUT] 1    0    [1    /1   ]  664.783667766        1
[INPUT] 1    0    [1    /1   ]  301.143682946        1
[INPUT] 1    0    [1    /1   ]  314.199560968        1
[INPUT] 1    0    [1    /1   ]  61.3884739552        1
[INPUT] 1    0    [1    /1   ]  7.25534719714        1
[INPUT] 1    0    [1    /1   ]  20.1015533436        1
[INPUT] 1    0    [1    /1   ]  0.766698721339       1
[INPUT] 1    0    [1    /1   ]  2.77263137338        1
[INPUT] 1    0    [1    /1   ]  0.221239373369       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.64435603301, 1.0]], [0, [7617.5510674581155, 1.0]], [0, [3617.3497821796573, 1.0]], [0, [1598.4854153807603, 1.0]], [0, [381.59449347489164, 1.0]], [0, [107.70372202423347, 1.0]], [0, [34.690024177665926, 1.0]], [0, [4.584759370733785, 1.0]], [0, [0.3953109479378685, 1.0]], [1, [1362.7798598633585, 1.0]], [1, [664.7836677663778, 1.0]], [1, [301.14368294566117, 1.0]], [1, [314.19956096774524, 1.0]], [1, [61.38847395522004, 1.0]], [1, [7.25534719713647, 1.0]], [1, [20.101553343605012, 1.0]], [1, [0.7666987213390979, 1.0]], [1, [2.772631373383186, 1.0]], [1, [0.2212393733686952, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.64435603]
bas 1, expnt(s) = [7617.55106746]
bas 2, expnt(s) = [3617.34978218]
bas 3, expnt(s) = [1598.48541538]
bas 4, expnt(s) = [381.59449347]
bas 5, expnt(s) = [107.70372202]
bas 6, expnt(s) = [34.69002418]
bas 7, expnt(s) = [4.58475937]
bas 8, expnt(s) = [0.39531095]
bas 9, expnt(s) = [1362.77985986]
bas 10, expnt(s) = [664.78366777]
bas 11, expnt(s) = [301.14368295]
bas 12, expnt(s) = [314.19956097]
bas 13, expnt(s) = [61.38847396]
bas 14, expnt(s) = [7.2553472]
bas 15, expnt(s) = [20.10155334]
bas 16, expnt(s) = [0.76669872]
bas 17, expnt(s) = [2.77263137]
bas 18, expnt(s) = [0.22123937]
CPU time:       815.88
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826444e+04 5.20026115e+03 7.61755107e+03 2.06004428e+03
 3.61734978e+03 1.17844116e+03 1.59848542e+03 6.38699436e+02
 3.81594493e+02 2.18130602e+02 1.07703722e+02 8.44671923e+01
 3.46900242e+01 3.61134081e+01 4.58475937e+00 7.91593892e+00
 3.95310948e-01 1.25956086e+00 1.36277986e+03 2.41555275e+04
 6.64783668e+02 9.84770021e+03 3.01143683e+02 3.65975143e+03
 3.14199561e+02 3.85914734e+03 6.13884740e+01 5.01294500e+02
 7.25534720e+00 3.47381865e+01 2.01015533e+01 1.24171354e+02
 7.66698721e-01 2.09298115e+00 2.77263137e+00 1.04375738e+01
 2.21239373e-01 4.42651986e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.977067043743396
cond(S) = 99979.55208560241
E1 = -728.8867805915687  E_coul = 203.12387882635628
init E= -525.762901765212
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559425938777016  LUMO = 1.01604224879687
  mo_energy =
[-1.18319255e+02 -1.21033919e+01 -9.44868657e+00 -9.44868657e+00
 -9.44868657e+00 -1.23003578e+00 -5.59425939e-01 -5.59425939e-01
 -5.59425939e-01  1.01604225e+00  1.01604225e+00  1.01604225e+00
  7.22235468e+00  7.22235468e+00  7.22235468e+00  3.30736015e+01
  3.30736015e+01  3.30736015e+01  7.45233712e+01  1.28131055e+02
  1.28131055e+02  1.28131055e+02  4.82200596e+02  4.82200596e+02
  4.82200596e+02  5.57079836e+02  1.33439489e+03  1.33439489e+03
  1.33439489e+03  2.62668612e+03  3.02922168e+03  3.02922168e+03
  3.02922168e+03  6.65019595e+03  6.65019595e+03  6.65019595e+03
  9.03431564e+03  2.53918769e+04  7.61362916e+04]
E1 = -728.0348205661799  E_coul = 201.55740566098834
cycle= 1 E= -526.477414905191  delta_E= -0.715  |g|= 0.185  |ddm|= 0.367
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.545786
diis-c [-0.29788271  1.        ]
  HOMO = -0.575867720373223  LUMO = 1.00630017787308
  mo_energy =
[-1.18600573e+02 -1.22056865e+01 -9.55739272e+00 -9.55739272e+00
 -9.55739272e+00 -1.25420402e+00 -5.75867720e-01 -5.75867720e-01
 -5.75867720e-01  1.00630018e+00  1.00630018e+00  1.00630018e+00
  7.16449046e+00  7.16449046e+00  7.16449046e+00  3.29564786e+01
  3.29564786e+01  3.29564786e+01  7.43527020e+01  1.27936160e+02
  1.27936160e+02  1.27936160e+02  4.81924686e+02  4.81924686e+02
  4.81924686e+02  5.56763126e+02  1.33405971e+03  1.33405971e+03
  1.33405971e+03  2.62621501e+03  3.02881968e+03  3.02881968e+03
  3.02881968e+03  6.64967953e+03  6.64967953e+03  6.64967953e+03
  9.03372290e+03  2.53911896e+04  7.61355137e+04]
E1 = -728.3478889255133  E_coul = 201.87007871504096
cycle= 2 E= -526.477810210472  delta_E= -0.000395  |g|= 0.0251  |ddm|= 0.0216
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0488372
diis-c [-0.00152272  0.05118174  0.94881826]
  HOMO = -0.57188906303108  LUMO = 1.00932039508735
  mo_energy =
[-1.18556320e+02 -1.21842784e+01 -9.53556203e+00 -9.53556203e+00
 -9.53556203e+00 -1.24892592e+00 -5.71889063e-01 -5.71889063e-01
 -5.71889063e-01  1.00932040e+00  1.00932040e+00  1.00932040e+00
  7.17613865e+00  7.17613865e+00  7.17613865e+00  3.29789584e+01
  3.29789584e+01  3.29789584e+01  7.43880380e+01  1.27970938e+02
  1.27970938e+02  1.27970938e+02  4.81968350e+02  4.81968350e+02
  4.81968350e+02  5.56808855e+02  1.33410655e+03  1.33410655e+03
  1.33410655e+03  2.62626411e+03  3.02886813e+03  3.02886813e+03
  3.02886813e+03  6.64972899e+03  6.64972899e+03  6.64972899e+03
  9.03377277e+03  2.53912397e+04  7.61355638e+04]
E1 = -728.2826697022848  E_coul = 201.80484502197865
cycle= 3 E= -526.477824680306  delta_E= -1.45e-05  |g|= 0.00308  |ddm|= 0.0055
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00661434
diis-c [-3.73435947e-07 -1.08295297e-03  1.12800118e-01  8.88282835e-01]
  HOMO = -0.572600511621117  LUMO = 1.00879521272047
  mo_energy =
[-1.18561772e+02 -1.21872709e+01 -9.53866148e+00 -9.53866148e+00
 -9.53866148e+00 -1.24984841e+00 -5.72600512e-01 -5.72600512e-01
 -5.72600512e-01  1.00879521e+00  1.00879521e+00  1.00879521e+00
  7.17429636e+00  7.17429636e+00  7.17429636e+00  3.29758157e+01
  3.29758157e+01  3.29758157e+01  7.43836529e+01  1.27966488e+02
  1.27966488e+02  1.27966488e+02  4.81962972e+02  4.81962972e+02
  4.81962972e+02  5.56803225e+02  1.33410079e+03  1.33410079e+03
  1.33410079e+03  2.62625795e+03  3.02886212e+03  3.02886212e+03
  3.02886212e+03  6.64972274e+03  6.64972274e+03  6.64972274e+03
  9.03376638e+03  2.53912332e+04  7.61355572e+04]
E1 = -728.2915408304359  E_coul = 201.81371582637615
cycle= 4 E= -526.47782500406  delta_E= -3.24e-07  |g|= 4.59e-05  |ddm|= 0.000805
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=6.34736e-05
diis-c [-1.94258019e-09  6.60047064e-07 -1.04224390e-03 -8.14491341e-04
  1.00185608e+00]
  HOMO = -0.572571604578765  LUMO = 1.00881606752139
  mo_energy =
[-1.18561670e+02 -1.21871775e+01 -9.53856896e+00 -9.53856896e+00
 -9.53856896e+00 -1.24981083e+00 -5.72571605e-01 -5.72571605e-01
 -5.72571605e-01  1.00881607e+00  1.00881607e+00  1.00881607e+00
  7.17436181e+00  7.17436181e+00  7.17436181e+00  3.29759049e+01
  3.29759049e+01  3.29759049e+01  7.43837566e+01  1.27966587e+02
  1.27966587e+02  1.27966587e+02  4.81963072e+02  4.81963072e+02
  4.81963072e+02  5.56803323e+02  1.33410089e+03  1.33410089e+03
  1.33410089e+03  2.62625804e+03  3.02886222e+03  3.02886222e+03
  3.02886222e+03  6.64972283e+03  6.64972283e+03  6.64972283e+03
  9.03376647e+03  2.53912332e+04  7.61355573e+04]
E1 = -728.2913145482346  E_coul = 201.81348954400968
cycle= 5 E= -526.477825004225  delta_E= -1.65e-10  |g|= 7.23e-06  |ddm|= 2.56e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.2913145482346  E_coul = 201.81348954400968
  HOMO = -0.572575405517017  LUMO = 1.00881331640039
  mo_energy =
[-1.18561688e+02 -1.21871906e+01 -9.53858230e+00 -9.53858230e+00
 -9.53858230e+00 -1.24981575e+00 -5.72575406e-01 -5.72575406e-01
 -5.72575406e-01  1.00881332e+00  1.00881332e+00  1.00881332e+00
  7.17435289e+00  7.17435289e+00  7.17435289e+00  3.29758918e+01
  3.29758918e+01  3.29758918e+01  7.43837406e+01  1.27966571e+02
  1.27966571e+02  1.27966571e+02  4.81963055e+02  4.81963055e+02
  4.81963055e+02  5.56803305e+02  1.33410087e+03  1.33410087e+03
  1.33410087e+03  2.62625802e+03  3.02886220e+03  3.02886220e+03
  3.02886220e+03  6.64972281e+03  6.64972281e+03  6.64972281e+03
  9.03376645e+03  2.53912332e+04  7.61355573e+04]
E1 = -728.2913495173135  E_coul = 201.81352451308496
Extra cycle  E= -526.477825004229  delta_E= -3.64e-12  |g|= 1.87e-06  |ddm|= 3.64e-06
    CPU time for scf_cycle      0.68 sec, wall time      0.29 sec
exp = [2.61826444e+04 7.61755107e+03 3.61734978e+03 1.59848542e+03
 3.81594493e+02 1.07703722e+02 3.46900242e+01 4.58475937e+00
 3.95310948e-01 1.36277986e+03 6.64783668e+02 3.01143683e+02
 3.14199561e+02 6.13884740e+01 7.25534720e+00 2.01015533e+01
 7.66698721e-01 2.77263137e+00 2.21239373e-01]
E = -526.4778250042285
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:46:02 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.644356         1
[INPUT] 0    0    [1    /1   ]  7617.55106746        1
[INPUT] 0    0    [1    /1   ]  3617.34978218        1
[INPUT] 0    0    [1    /1   ]  1598.48541538        1
[INPUT] 0    0    [1    /1   ]  381.594493475        1
[INPUT] 0    0    [1    /1   ]  107.703722024        1
[INPUT] 0    0    [1    /1   ]  34.6900241777        1
[INPUT] 0    0    [1    /1   ]  4.58475937073        1
[INPUT] 0    0    [1    /1   ]  0.395310947938       1
[INPUT] 1    0    [1    /1   ]  1362.77985986        1
[INPUT] 1    0    [1    /1   ]  664.783667766        1
[INPUT] 1    0    [1    /1   ]  301.143682946        1
[INPUT] 1    0    [1    /1   ]  314.199560968        1
[INPUT] 1    0    [1    /1   ]  61.3884739552        1
[INPUT] 1    0    [1    /1   ]  7.25534719714        1
[INPUT] 1    0    [1    /1   ]  20.1015533436        1
[INPUT] 1    0    [1    /1   ]  0.766698721339       1
[INPUT] 1    0    [1    /1   ]  2.77263137338        1
[INPUT] 1    0    [1    /1   ]  0.221239373369       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.64435603301, 1.0]], [0, [7617.5510674581155, 1.0]], [0, [3617.3497821796573, 1.0]], [0, [1598.4854153807603, 1.0]], [0, [381.59449347489164, 1.0]], [0, [107.70372202423347, 1.0]], [0, [34.690024177665926, 1.0]], [0, [4.584759370733785, 1.0]], [0, [0.3953109479378685, 1.0]], [1, [1362.7798598633585, 1.0]], [1, [664.7836677663778, 1.0]], [1, [301.14368294566117, 1.0]], [1, [314.19956096774524, 1.0]], [1, [61.38847395522004, 1.0]], [1, [7.25534719713647, 1.0]], [1, [20.101553343605012, 1.0]], [1, [0.7666987213390979, 1.0]], [1, [2.772631373383186, 1.0]], [1, [0.2212393733686952, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.64435603]
bas 1, expnt(s) = [7617.55106746]
bas 2, expnt(s) = [3617.34978218]
bas 3, expnt(s) = [1598.48541538]
bas 4, expnt(s) = [381.59449347]
bas 5, expnt(s) = [107.70372202]
bas 6, expnt(s) = [34.69002418]
bas 7, expnt(s) = [4.58475937]
bas 8, expnt(s) = [0.39531095]
bas 9, expnt(s) = [1362.77985986]
bas 10, expnt(s) = [664.78366777]
bas 11, expnt(s) = [301.14368295]
bas 12, expnt(s) = [314.19956097]
bas 13, expnt(s) = [61.38847396]
bas 14, expnt(s) = [7.2553472]
bas 15, expnt(s) = [20.10155334]
bas 16, expnt(s) = [0.76669872]
bas 17, expnt(s) = [2.77263137]
bas 18, expnt(s) = [0.22123937]
CPU time:       816.87
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826444e+04 5.20026115e+03 7.61755107e+03 2.06004428e+03
 3.61734978e+03 1.17844116e+03 1.59848542e+03 6.38699436e+02
 3.81594493e+02 2.18130602e+02 1.07703722e+02 8.44671923e+01
 3.46900242e+01 3.61134081e+01 4.58475937e+00 7.91593892e+00
 3.95310948e-01 1.25956086e+00 1.36277986e+03 2.41555275e+04
 6.64783668e+02 9.84770021e+03 3.01143683e+02 3.65975143e+03
 3.14199561e+02 3.85914734e+03 6.13884740e+01 5.01294500e+02
 7.25534720e+00 3.47381865e+01 2.01015533e+01 1.24171354e+02
 7.66698721e-01 2.09298115e+00 2.77263137e+00 1.04375738e+01
 2.21239373e-01 4.42651986e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.977067043743396
cond(S) = 99979.55208560241
E1 = -728.8867805915687  E_coul = 203.12387882635628
init E= -525.762901765212
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559425938777016  LUMO = 1.01604224879687
  mo_energy =
[-1.18319255e+02 -1.21033919e+01 -9.44868657e+00 -9.44868657e+00
 -9.44868657e+00 -1.23003578e+00 -5.59425939e-01 -5.59425939e-01
 -5.59425939e-01  1.01604225e+00  1.01604225e+00  1.01604225e+00
  7.22235468e+00  7.22235468e+00  7.22235468e+00  3.30736015e+01
  3.30736015e+01  3.30736015e+01  7.45233712e+01  1.28131055e+02
  1.28131055e+02  1.28131055e+02  4.82200596e+02  4.82200596e+02
  4.82200596e+02  5.57079836e+02  1.33439489e+03  1.33439489e+03
  1.33439489e+03  2.62668612e+03  3.02922168e+03  3.02922168e+03
  3.02922168e+03  6.65019595e+03  6.65019595e+03  6.65019595e+03
  9.03431564e+03  2.53918769e+04  7.61362916e+04]
E1 = -728.0348205661799  E_coul = 201.55740566098834
cycle= 1 E= -526.477414905191  delta_E= -0.715  |g|= 0.185  |ddm|= 0.367
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.545786
diis-c [-0.29788271  1.        ]
  HOMO = -0.575867720373223  LUMO = 1.00630017787308
  mo_energy =
[-1.18600573e+02 -1.22056865e+01 -9.55739272e+00 -9.55739272e+00
 -9.55739272e+00 -1.25420402e+00 -5.75867720e-01 -5.75867720e-01
 -5.75867720e-01  1.00630018e+00  1.00630018e+00  1.00630018e+00
  7.16449046e+00  7.16449046e+00  7.16449046e+00  3.29564786e+01
  3.29564786e+01  3.29564786e+01  7.43527020e+01  1.27936160e+02
  1.27936160e+02  1.27936160e+02  4.81924686e+02  4.81924686e+02
  4.81924686e+02  5.56763126e+02  1.33405971e+03  1.33405971e+03
  1.33405971e+03  2.62621501e+03  3.02881968e+03  3.02881968e+03
  3.02881968e+03  6.64967953e+03  6.64967953e+03  6.64967953e+03
  9.03372290e+03  2.53911896e+04  7.61355137e+04]
E1 = -728.3478889255133  E_coul = 201.87007871504096
cycle= 2 E= -526.477810210472  delta_E= -0.000395  |g|= 0.0251  |ddm|= 0.0216
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0488372
diis-c [-0.00152272  0.05118174  0.94881826]
  HOMO = -0.57188906303108  LUMO = 1.00932039508735
  mo_energy =
[-1.18556320e+02 -1.21842784e+01 -9.53556203e+00 -9.53556203e+00
 -9.53556203e+00 -1.24892592e+00 -5.71889063e-01 -5.71889063e-01
 -5.71889063e-01  1.00932040e+00  1.00932040e+00  1.00932040e+00
  7.17613865e+00  7.17613865e+00  7.17613865e+00  3.29789584e+01
  3.29789584e+01  3.29789584e+01  7.43880380e+01  1.27970938e+02
  1.27970938e+02  1.27970938e+02  4.81968350e+02  4.81968350e+02
  4.81968350e+02  5.56808855e+02  1.33410655e+03  1.33410655e+03
  1.33410655e+03  2.62626411e+03  3.02886813e+03  3.02886813e+03
  3.02886813e+03  6.64972899e+03  6.64972899e+03  6.64972899e+03
  9.03377277e+03  2.53912397e+04  7.61355638e+04]
E1 = -728.2826697022848  E_coul = 201.80484502197865
cycle= 3 E= -526.477824680306  delta_E= -1.45e-05  |g|= 0.00308  |ddm|= 0.0055
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00661434
diis-c [-3.73435947e-07 -1.08295297e-03  1.12800118e-01  8.88282835e-01]
  HOMO = -0.572600511621117  LUMO = 1.00879521272047
  mo_energy =
[-1.18561772e+02 -1.21872709e+01 -9.53866148e+00 -9.53866148e+00
 -9.53866148e+00 -1.24984841e+00 -5.72600512e-01 -5.72600512e-01
 -5.72600512e-01  1.00879521e+00  1.00879521e+00  1.00879521e+00
  7.17429636e+00  7.17429636e+00  7.17429636e+00  3.29758157e+01
  3.29758157e+01  3.29758157e+01  7.43836529e+01  1.27966488e+02
  1.27966488e+02  1.27966488e+02  4.81962972e+02  4.81962972e+02
  4.81962972e+02  5.56803225e+02  1.33410079e+03  1.33410079e+03
  1.33410079e+03  2.62625795e+03  3.02886212e+03  3.02886212e+03
  3.02886212e+03  6.64972274e+03  6.64972274e+03  6.64972274e+03
  9.03376638e+03  2.53912332e+04  7.61355572e+04]
E1 = -728.2915408304359  E_coul = 201.81371582637615
cycle= 4 E= -526.47782500406  delta_E= -3.24e-07  |g|= 4.59e-05  |ddm|= 0.000805
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=6.34736e-05
diis-c [-1.94258019e-09  6.60047064e-07 -1.04224390e-03 -8.14491341e-04
  1.00185608e+00]
  HOMO = -0.572571604578765  LUMO = 1.00881606752139
  mo_energy =
[-1.18561670e+02 -1.21871775e+01 -9.53856896e+00 -9.53856896e+00
 -9.53856896e+00 -1.24981083e+00 -5.72571605e-01 -5.72571605e-01
 -5.72571605e-01  1.00881607e+00  1.00881607e+00  1.00881607e+00
  7.17436181e+00  7.17436181e+00  7.17436181e+00  3.29759049e+01
  3.29759049e+01  3.29759049e+01  7.43837566e+01  1.27966587e+02
  1.27966587e+02  1.27966587e+02  4.81963072e+02  4.81963072e+02
  4.81963072e+02  5.56803323e+02  1.33410089e+03  1.33410089e+03
  1.33410089e+03  2.62625804e+03  3.02886222e+03  3.02886222e+03
  3.02886222e+03  6.64972283e+03  6.64972283e+03  6.64972283e+03
  9.03376647e+03  2.53912332e+04  7.61355573e+04]
E1 = -728.2913145482346  E_coul = 201.81348954400968
cycle= 5 E= -526.477825004225  delta_E= -1.65e-10  |g|= 7.23e-06  |ddm|= 2.56e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.2913145482346  E_coul = 201.81348954400968
  HOMO = -0.572575405517017  LUMO = 1.00881331640039
  mo_energy =
[-1.18561688e+02 -1.21871906e+01 -9.53858230e+00 -9.53858230e+00
 -9.53858230e+00 -1.24981575e+00 -5.72575406e-01 -5.72575406e-01
 -5.72575406e-01  1.00881332e+00  1.00881332e+00  1.00881332e+00
  7.17435289e+00  7.17435289e+00  7.17435289e+00  3.29758918e+01
  3.29758918e+01  3.29758918e+01  7.43837406e+01  1.27966571e+02
  1.27966571e+02  1.27966571e+02  4.81963055e+02  4.81963055e+02
  4.81963055e+02  5.56803305e+02  1.33410087e+03  1.33410087e+03
  1.33410087e+03  2.62625802e+03  3.02886220e+03  3.02886220e+03
  3.02886220e+03  6.64972281e+03  6.64972281e+03  6.64972281e+03
  9.03376645e+03  2.53912332e+04  7.61355573e+04]
E1 = -728.2913495173135  E_coul = 201.81352451308496
Extra cycle  E= -526.477825004229  delta_E= -3.64e-12  |g|= 1.87e-06  |ddm|= 3.64e-06
    CPU time for scf_cycle      0.67 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 99979.55208560241
E1 = -728.2913495173135  E_coul = 201.81352451308496
init E= -526.477825004229
    CPU time for initialize scf      2.73 sec, wall time      0.25 sec
  HOMO = -0.572574741656627  LUMO = 1.00881380272358
  mo_energy =
[-1.18561684e+02 -1.21871880e+01 -9.53857966e+00 -9.53857966e+00
 -9.53857966e+00 -1.24981488e+00 -5.72574742e-01 -5.72574742e-01
 -5.72574742e-01  1.00881380e+00  1.00881380e+00  1.00881380e+00
  7.17435454e+00  7.17435454e+00  7.17435454e+00  3.29758944e+01
  3.29758944e+01  3.29758944e+01  7.43837441e+01  1.27966574e+02
  1.27966574e+02  1.27966574e+02  4.81963059e+02  4.81963059e+02
  4.81963059e+02  5.56803309e+02  1.33410088e+03  1.33410088e+03
  1.33410088e+03  2.62625802e+03  3.02886220e+03  3.02886220e+03
  3.02886220e+03  6.64972282e+03  6.64972282e+03  6.64972282e+03
  9.03376645e+03  2.53912332e+04  7.61355573e+04]
E1 = -728.2913422865063  E_coul = 201.8135172822772
cycle= 1 E= -526.477825004229  delta_E= -5.68e-13  |g|= 4.22e-07  |ddm|= 6.95e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2913422865063  E_coul = 201.8135172822772
  HOMO = -0.572574870944191  LUMO = 1.00881370756699
  mo_energy =
[-1.18561685e+02 -1.21871885e+01 -9.53858020e+00 -9.53858020e+00
 -9.53858020e+00 -1.24981505e+00 -5.72574871e-01 -5.72574871e-01
 -5.72574871e-01  1.00881371e+00  1.00881371e+00  1.00881371e+00
  7.17435421e+00  7.17435421e+00  7.17435421e+00  3.29758939e+01
  3.29758939e+01  3.29758939e+01  7.43837434e+01  1.27966574e+02
  1.27966574e+02  1.27966574e+02  4.81963058e+02  4.81963058e+02
  4.81963058e+02  5.56803308e+02  1.33410088e+03  1.33410088e+03
  1.33410088e+03  2.62625802e+03  3.02886220e+03  3.02886220e+03
  3.02886220e+03  6.64972282e+03  6.64972282e+03  6.64972282e+03
  9.03376645e+03  2.53912332e+04  7.61355573e+04]
E1 = -728.2913438045645  E_coul = 201.81351880033534
Extra cycle  E= -526.477825004229  delta_E=    0  |g|= 9.15e-08  |ddm|= 1.42e-07
    CPU time for scf_cycle      2.88 sec, wall time      0.39 sec
exp = [2.61826444e+04 7.61755107e+03 3.61734978e+03 1.59848542e+03
 3.81594493e+02 1.07703722e+02 3.46900242e+01 4.58475937e+00
 3.95310948e-01 1.36277986e+03 6.64783668e+02 3.01143683e+02
 3.14199561e+02 6.13884740e+01 7.25534720e+00 2.01015533e+01
 7.66698721e-01 2.77263137e+00 2.21239373e-01]
grad_E = [-1.51793290e-06  3.37213167e-06 -1.39223070e-06  7.09888407e-05
  1.22419796e-05 -2.59516161e-05  8.44987722e-05  9.63743506e-06
  2.44842401e-03 -4.99761515e-07  5.07864840e-06  2.39564858e-05
  2.06733155e-05  1.48906542e-05  9.72230723e-04 -2.07206655e-04
 -2.36789228e-03 -2.14525727e-03  4.57833797e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:46:06 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6439253        1
[INPUT] 0    0    [1    /1   ]  7617.55231522        1
[INPUT] 0    0    [1    /1   ]  3617.35000694        1
[INPUT] 0    0    [1    /1   ]  1598.51515717        1
[INPUT] 0    0    [1    /1   ]  381.50846516         1
[INPUT] 0    0    [1    /1   ]  107.64560577         1
[INPUT] 0    0    [1    /1   ]  34.6613952336        1
[INPUT] 0    0    [1    /1   ]  4.5845591435         1
[INPUT] 0    0    [1    /1   ]  0.395258189346       1
[INPUT] 1    0    [1    /1   ]  1362.77980573        1
[INPUT] 1    0    [1    /1   ]  664.783868532        1
[INPUT] 1    0    [1    /1   ]  301.144787782        1
[INPUT] 1    0    [1    /1   ]  314.20064731         1
[INPUT] 1    0    [1    /1   ]  61.4708261527        1
[INPUT] 1    0    [1    /1   ]  7.27733163386        1
[INPUT] 1    0    [1    /1   ]  20.1443826499        1
[INPUT] 1    0    [1    /1   ]  0.768436315244       1
[INPUT] 1    0    [1    /1   ]  2.78624413841        1
[INPUT] 1    0    [1    /1   ]  0.221540217187       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.64392529993, 1.0]], [0, [7617.552315220235, 1.0]], [0, [3617.3500069363135, 1.0]], [0, [1598.5151571734984, 1.0]], [0, [381.50846516014315, 1.0]], [0, [107.64560576998986, 1.0]], [0, [34.661395233636505, 1.0]], [0, [4.584559143499966, 1.0]], [0, [0.395258189345662, 1.0]], [1, [1362.77980572921, 1.0]], [1, [664.7838685315043, 1.0]], [1, [301.144787781833, 1.0]], [1, [314.20064730965504, 1.0]], [1, [61.47082615267426, 1.0]], [1, [7.277331633864271, 1.0]], [1, [20.144382649882683, 1.0]], [1, [0.7684363152443556, 1.0]], [1, [2.7862441384115946, 1.0]], [1, [0.22154021718712522, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.6439253]
bas 1, expnt(s) = [7617.55231522]
bas 2, expnt(s) = [3617.35000694]
bas 3, expnt(s) = [1598.51515717]
bas 4, expnt(s) = [381.50846516]
bas 5, expnt(s) = [107.64560577]
bas 6, expnt(s) = [34.66139523]
bas 7, expnt(s) = [4.58455914]
bas 8, expnt(s) = [0.39525819]
bas 9, expnt(s) = [1362.77980573]
bas 10, expnt(s) = [664.78386853]
bas 11, expnt(s) = [301.14478778]
bas 12, expnt(s) = [314.20064731]
bas 13, expnt(s) = [61.47082615]
bas 14, expnt(s) = [7.27733163]
bas 15, expnt(s) = [20.14438265]
bas 16, expnt(s) = [0.76843632]
bas 17, expnt(s) = [2.78624414]
bas 18, expnt(s) = [0.22154022]
CPU time:       825.26
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826439e+04 5.20026109e+03 7.61755232e+03 2.06004453e+03
 3.61735001e+03 1.17844122e+03 1.59851516e+03 6.38708349e+02
 3.81508465e+02 2.18093719e+02 1.07645606e+02 8.44330065e+01
 3.46613952e+01 3.60910531e+01 4.58455914e+00 7.91567964e+00
 3.95258189e-01 1.25943478e+00 1.36277981e+03 2.41555263e+04
 6.64783869e+02 9.84770393e+03 3.01144788e+02 3.65976822e+03
 3.14200647e+02 3.85916402e+03 6.14708262e+01 5.02135244e+02
 7.27733163e+00 3.48698116e+01 2.01443826e+01 1.24502148e+02
 7.68436315e-01 2.09891206e+00 2.78624414e+00 1.05016696e+01
 2.21540217e-01 4.43404518e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.9770245697132
cond(S) = 100136.09789429948
E1 = -728.8857314799883  E_coul = 203.12293654598184
init E= -525.762794934006
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.55943835411861  LUMO = 1.0187525151351
  mo_energy =
[-1.18319399e+02 -1.21033954e+01 -9.44878148e+00 -9.44878148e+00
 -9.44878148e+00 -1.23004427e+00 -5.59438354e-01 -5.59438354e-01
 -5.59438354e-01  1.01875252e+00  1.01875252e+00  1.01875252e+00
  7.25913671e+00  7.25913671e+00  7.25913671e+00  3.32088642e+01
  3.32088642e+01  3.32088642e+01  7.44434152e+01  1.28453011e+02
  1.28453011e+02  1.28453011e+02  4.82681754e+02  4.82681754e+02
  4.82681754e+02  5.56764998e+02  1.33490441e+03  1.33490441e+03
  1.33490441e+03  2.62615991e+03  3.02972509e+03  3.02972509e+03
  3.02972509e+03  6.65066843e+03  6.65066843e+03  6.65066843e+03
  9.03376935e+03  2.53913670e+04  7.61358255e+04]
E1 = -728.0341383350902  E_coul = 201.55671006258726
cycle= 1 E= -526.477428272503  delta_E= -0.715  |g|= 0.185  |ddm|= 0.367
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.546186
diis-c [-0.29831906  1.        ]
  HOMO = -0.575877822622369  LUMO = 1.0089644939626
  mo_energy =
[-1.18600742e+02 -1.22056361e+01 -9.55746292e+00 -9.55746292e+00
 -9.55746292e+00 -1.25419930e+00 -5.75877823e-01 -5.75877823e-01
 -5.75877823e-01  1.00896449e+00  1.00896449e+00  1.00896449e+00
  7.20109455e+00  7.20109455e+00  7.20109455e+00  3.30916004e+01
  3.30916004e+01  3.30916004e+01  7.42728304e+01  1.28258053e+02
  1.28258053e+02  1.28258053e+02  4.82405807e+02  4.82405807e+02
  4.82405807e+02  5.56448244e+02  1.33456916e+03  1.33456916e+03
  1.33456916e+03  2.62568866e+03  3.02932298e+03  3.02932298e+03
  3.02932298e+03  6.65015186e+03  6.65015186e+03  6.65015186e+03
  9.03317644e+03  2.53906795e+04  7.61350474e+04]
E1 = -728.3472526194549  E_coul = 201.86942848420588
cycle= 2 E= -526.477824135249  delta_E= -0.000396  |g|= 0.0251  |ddm|= 0.0216
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0488883
diis-c [-0.00152393  0.05125237  0.94874763]
  HOMO = -0.571901331207607  LUMO = 1.01199312255662
  mo_energy =
[-1.18556475e+02 -1.21842266e+01 -9.53563062e+00 -9.53563062e+00
 -9.53563062e+00 -1.24892426e+00 -5.71901331e-01 -5.71901331e-01
 -5.71901331e-01  1.01199312e+00  1.01199312e+00  1.01199312e+00
  7.21277751e+00  7.21277751e+00  7.21277751e+00  3.31141096e+01
  3.31141096e+01  3.31141096e+01  7.43081675e+01  1.28292851e+02
  1.28292851e+02  1.28292851e+02  4.82449484e+02  4.82449484e+02
  4.82449484e+02  5.56493985e+02  1.33461601e+03  1.33461601e+03
  1.33461601e+03  2.62573778e+03  3.02937144e+03  3.02937144e+03
  3.02937144e+03  6.65020133e+03  6.65020133e+03  6.65020133e+03
  9.03322632e+03  2.53907296e+04  7.61350975e+04]
E1 = -728.2820427001895  E_coul = 201.80420408747636
cycle= 3 E= -526.477838612713  delta_E= -1.45e-05  |g|= 0.00308  |ddm|= 0.0055
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00661605
diis-c [-3.75053871e-07 -1.08425772e-03  1.12701977e-01  8.88382281e-01]
  HOMO = -0.5726122696239  LUMO = 1.01146667750279
  mo_energy =
[-1.18561924e+02 -1.21872170e+01 -9.53872810e+00 -9.53872810e+00
 -9.53872810e+00 -1.24984602e+00 -5.72612270e-01 -5.72612270e-01
 -5.72612270e-01  1.01146668e+00  1.01146668e+00  1.01146668e+00
  7.21093145e+00  7.21093145e+00  7.21093145e+00  3.31109658e+01
  3.31109658e+01  3.31109658e+01  7.43037862e+01  1.28288402e+02
  1.28288402e+02  1.28288402e+02  4.82444109e+02  4.82444109e+02
  4.82444109e+02  5.56488358e+02  1.33461026e+03  1.33461026e+03
  1.33461026e+03  2.62573162e+03  3.02936544e+03  3.02936544e+03
  3.02936544e+03  6.65019509e+03  6.65019509e+03  6.65019509e+03
  9.03321994e+03  2.53907231e+04  7.61350909e+04]
E1 = -728.2909069316938  E_coul = 201.81306799561048
cycle= 4 E= -526.477838936083  delta_E= -3.23e-07  |g|= 4.59e-05  |ddm|= 0.000805
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=6.34384e-05
diis-c [-1.94786570e-09  8.56619361e-07 -1.06770458e-03 -1.03622345e-03
  1.00210307e+00]
  HOMO = -0.572583345542204  LUMO = 1.01148760711299
  mo_energy =
[-1.18561823e+02 -1.21871235e+01 -9.53863552e+00 -9.53863552e+00
 -9.53863552e+00 -1.24980842e+00 -5.72583346e-01 -5.72583346e-01
 -5.72583346e-01  1.01148761e+00  1.01148761e+00  1.01148761e+00
  7.21099708e+00  7.21099708e+00  7.21099708e+00  3.31110551e+01
  3.31110551e+01  3.31110551e+01  7.43038900e+01  1.28288501e+02
  1.28288501e+02  1.28288501e+02  4.82444210e+02  4.82444210e+02
  4.82444210e+02  5.56488456e+02  1.33461036e+03  1.33461036e+03
  1.33461036e+03  2.62573171e+03  3.02936554e+03  3.02936554e+03
  3.02936554e+03  6.65019518e+03  6.65019518e+03  6.65019518e+03
  9.03322002e+03  2.53907232e+04  7.61350910e+04]
E1 = -728.290680610275  E_coul = 201.81284167402757
cycle= 5 E= -526.477838936247  delta_E= -1.64e-10  |g|= 7.26e-06  |ddm|= 2.56e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.290680610275  E_coul = 201.81284167402757
  HOMO = -0.572587157409841  LUMO = 1.01148483973095
  mo_energy =
[-1.18561840e+02 -1.21871366e+01 -9.53864890e+00 -9.53864890e+00
 -9.53864890e+00 -1.24981335e+00 -5.72587157e-01 -5.72587157e-01
 -5.72587157e-01  1.01148484e+00  1.01148484e+00  1.01148484e+00
  7.21098811e+00  7.21098811e+00  7.21098811e+00  3.31110419e+01
  3.31110419e+01  3.31110419e+01  7.43038740e+01  1.28288485e+02
  1.28288485e+02  1.28288485e+02  4.82444192e+02  4.82444192e+02
  4.82444192e+02  5.56488438e+02  1.33461034e+03  1.33461034e+03
  1.33461034e+03  2.62573169e+03  3.02936552e+03  3.02936552e+03
  3.02936552e+03  6.65019516e+03  6.65019516e+03  6.65019516e+03
  9.03322000e+03  2.53907232e+04  7.61350910e+04]
E1 = -728.2907156759601  E_coul = 201.81287673970792
Extra cycle  E= -526.477838936252  delta_E= -4.77e-12  |g|= 1.88e-06  |ddm|= 3.66e-06
    CPU time for scf_cycle      0.67 sec, wall time      0.28 sec
exp = [2.61826439e+04 7.61755232e+03 3.61735001e+03 1.59851516e+03
 3.81508465e+02 1.07645606e+02 3.46613952e+01 4.58455914e+00
 3.95258189e-01 1.36277981e+03 6.64783869e+02 3.01144788e+02
 3.14200647e+02 6.14708262e+01 7.27733163e+00 2.01443826e+01
 7.68436315e-01 2.78624414e+00 2.21540217e-01]
E = -526.4778389362522
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:46:07 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6439253        1
[INPUT] 0    0    [1    /1   ]  7617.55231522        1
[INPUT] 0    0    [1    /1   ]  3617.35000694        1
[INPUT] 0    0    [1    /1   ]  1598.51515717        1
[INPUT] 0    0    [1    /1   ]  381.50846516         1
[INPUT] 0    0    [1    /1   ]  107.64560577         1
[INPUT] 0    0    [1    /1   ]  34.6613952336        1
[INPUT] 0    0    [1    /1   ]  4.5845591435         1
[INPUT] 0    0    [1    /1   ]  0.395258189346       1
[INPUT] 1    0    [1    /1   ]  1362.77980573        1
[INPUT] 1    0    [1    /1   ]  664.783868532        1
[INPUT] 1    0    [1    /1   ]  301.144787782        1
[INPUT] 1    0    [1    /1   ]  314.20064731         1
[INPUT] 1    0    [1    /1   ]  61.4708261527        1
[INPUT] 1    0    [1    /1   ]  7.27733163386        1
[INPUT] 1    0    [1    /1   ]  20.1443826499        1
[INPUT] 1    0    [1    /1   ]  0.768436315244       1
[INPUT] 1    0    [1    /1   ]  2.78624413841        1
[INPUT] 1    0    [1    /1   ]  0.221540217187       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.64392529993, 1.0]], [0, [7617.552315220235, 1.0]], [0, [3617.3500069363135, 1.0]], [0, [1598.5151571734984, 1.0]], [0, [381.50846516014315, 1.0]], [0, [107.64560576998986, 1.0]], [0, [34.661395233636505, 1.0]], [0, [4.584559143499966, 1.0]], [0, [0.395258189345662, 1.0]], [1, [1362.77980572921, 1.0]], [1, [664.7838685315043, 1.0]], [1, [301.144787781833, 1.0]], [1, [314.20064730965504, 1.0]], [1, [61.47082615267426, 1.0]], [1, [7.277331633864271, 1.0]], [1, [20.144382649882683, 1.0]], [1, [0.7684363152443556, 1.0]], [1, [2.7862441384115946, 1.0]], [1, [0.22154021718712522, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.6439253]
bas 1, expnt(s) = [7617.55231522]
bas 2, expnt(s) = [3617.35000694]
bas 3, expnt(s) = [1598.51515717]
bas 4, expnt(s) = [381.50846516]
bas 5, expnt(s) = [107.64560577]
bas 6, expnt(s) = [34.66139523]
bas 7, expnt(s) = [4.58455914]
bas 8, expnt(s) = [0.39525819]
bas 9, expnt(s) = [1362.77980573]
bas 10, expnt(s) = [664.78386853]
bas 11, expnt(s) = [301.14478778]
bas 12, expnt(s) = [314.20064731]
bas 13, expnt(s) = [61.47082615]
bas 14, expnt(s) = [7.27733163]
bas 15, expnt(s) = [20.14438265]
bas 16, expnt(s) = [0.76843632]
bas 17, expnt(s) = [2.78624414]
bas 18, expnt(s) = [0.22154022]
CPU time:       826.24
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826439e+04 5.20026109e+03 7.61755232e+03 2.06004453e+03
 3.61735001e+03 1.17844122e+03 1.59851516e+03 6.38708349e+02
 3.81508465e+02 2.18093719e+02 1.07645606e+02 8.44330065e+01
 3.46613952e+01 3.60910531e+01 4.58455914e+00 7.91567964e+00
 3.95258189e-01 1.25943478e+00 1.36277981e+03 2.41555263e+04
 6.64783869e+02 9.84770393e+03 3.01144788e+02 3.65976822e+03
 3.14200647e+02 3.85916402e+03 6.14708262e+01 5.02135244e+02
 7.27733163e+00 3.48698116e+01 2.01443826e+01 1.24502148e+02
 7.68436315e-01 2.09891206e+00 2.78624414e+00 1.05016696e+01
 2.21540217e-01 4.43404518e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.9770245697132
cond(S) = 100136.09789429948
E1 = -728.8857314799883  E_coul = 203.12293654598184
init E= -525.762794934006
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.55943835411861  LUMO = 1.0187525151351
  mo_energy =
[-1.18319399e+02 -1.21033954e+01 -9.44878148e+00 -9.44878148e+00
 -9.44878148e+00 -1.23004427e+00 -5.59438354e-01 -5.59438354e-01
 -5.59438354e-01  1.01875252e+00  1.01875252e+00  1.01875252e+00
  7.25913671e+00  7.25913671e+00  7.25913671e+00  3.32088642e+01
  3.32088642e+01  3.32088642e+01  7.44434152e+01  1.28453011e+02
  1.28453011e+02  1.28453011e+02  4.82681754e+02  4.82681754e+02
  4.82681754e+02  5.56764998e+02  1.33490441e+03  1.33490441e+03
  1.33490441e+03  2.62615991e+03  3.02972509e+03  3.02972509e+03
  3.02972509e+03  6.65066843e+03  6.65066843e+03  6.65066843e+03
  9.03376935e+03  2.53913670e+04  7.61358255e+04]
E1 = -728.0341383350902  E_coul = 201.55671006258726
cycle= 1 E= -526.477428272503  delta_E= -0.715  |g|= 0.185  |ddm|= 0.367
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.546186
diis-c [-0.29831906  1.        ]
  HOMO = -0.575877822622369  LUMO = 1.0089644939626
  mo_energy =
[-1.18600742e+02 -1.22056361e+01 -9.55746292e+00 -9.55746292e+00
 -9.55746292e+00 -1.25419930e+00 -5.75877823e-01 -5.75877823e-01
 -5.75877823e-01  1.00896449e+00  1.00896449e+00  1.00896449e+00
  7.20109455e+00  7.20109455e+00  7.20109455e+00  3.30916004e+01
  3.30916004e+01  3.30916004e+01  7.42728304e+01  1.28258053e+02
  1.28258053e+02  1.28258053e+02  4.82405807e+02  4.82405807e+02
  4.82405807e+02  5.56448244e+02  1.33456916e+03  1.33456916e+03
  1.33456916e+03  2.62568866e+03  3.02932298e+03  3.02932298e+03
  3.02932298e+03  6.65015186e+03  6.65015186e+03  6.65015186e+03
  9.03317644e+03  2.53906795e+04  7.61350474e+04]
E1 = -728.3472526194549  E_coul = 201.86942848420588
cycle= 2 E= -526.477824135249  delta_E= -0.000396  |g|= 0.0251  |ddm|= 0.0216
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0488883
diis-c [-0.00152393  0.05125237  0.94874763]
  HOMO = -0.571901331207607  LUMO = 1.01199312255662
  mo_energy =
[-1.18556475e+02 -1.21842266e+01 -9.53563062e+00 -9.53563062e+00
 -9.53563062e+00 -1.24892426e+00 -5.71901331e-01 -5.71901331e-01
 -5.71901331e-01  1.01199312e+00  1.01199312e+00  1.01199312e+00
  7.21277751e+00  7.21277751e+00  7.21277751e+00  3.31141096e+01
  3.31141096e+01  3.31141096e+01  7.43081675e+01  1.28292851e+02
  1.28292851e+02  1.28292851e+02  4.82449484e+02  4.82449484e+02
  4.82449484e+02  5.56493985e+02  1.33461601e+03  1.33461601e+03
  1.33461601e+03  2.62573778e+03  3.02937144e+03  3.02937144e+03
  3.02937144e+03  6.65020133e+03  6.65020133e+03  6.65020133e+03
  9.03322632e+03  2.53907296e+04  7.61350975e+04]
E1 = -728.2820427001895  E_coul = 201.80420408747636
cycle= 3 E= -526.477838612713  delta_E= -1.45e-05  |g|= 0.00308  |ddm|= 0.0055
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00661605
diis-c [-3.75053871e-07 -1.08425772e-03  1.12701977e-01  8.88382281e-01]
  HOMO = -0.5726122696239  LUMO = 1.01146667750279
  mo_energy =
[-1.18561924e+02 -1.21872170e+01 -9.53872810e+00 -9.53872810e+00
 -9.53872810e+00 -1.24984602e+00 -5.72612270e-01 -5.72612270e-01
 -5.72612270e-01  1.01146668e+00  1.01146668e+00  1.01146668e+00
  7.21093145e+00  7.21093145e+00  7.21093145e+00  3.31109658e+01
  3.31109658e+01  3.31109658e+01  7.43037862e+01  1.28288402e+02
  1.28288402e+02  1.28288402e+02  4.82444109e+02  4.82444109e+02
  4.82444109e+02  5.56488358e+02  1.33461026e+03  1.33461026e+03
  1.33461026e+03  2.62573162e+03  3.02936544e+03  3.02936544e+03
  3.02936544e+03  6.65019509e+03  6.65019509e+03  6.65019509e+03
  9.03321994e+03  2.53907231e+04  7.61350909e+04]
E1 = -728.2909069316938  E_coul = 201.81306799561048
cycle= 4 E= -526.477838936083  delta_E= -3.23e-07  |g|= 4.59e-05  |ddm|= 0.000805
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=6.34384e-05
diis-c [-1.94786570e-09  8.56619361e-07 -1.06770458e-03 -1.03622345e-03
  1.00210307e+00]
  HOMO = -0.572583345542204  LUMO = 1.01148760711299
  mo_energy =
[-1.18561823e+02 -1.21871235e+01 -9.53863552e+00 -9.53863552e+00
 -9.53863552e+00 -1.24980842e+00 -5.72583346e-01 -5.72583346e-01
 -5.72583346e-01  1.01148761e+00  1.01148761e+00  1.01148761e+00
  7.21099708e+00  7.21099708e+00  7.21099708e+00  3.31110551e+01
  3.31110551e+01  3.31110551e+01  7.43038900e+01  1.28288501e+02
  1.28288501e+02  1.28288501e+02  4.82444210e+02  4.82444210e+02
  4.82444210e+02  5.56488456e+02  1.33461036e+03  1.33461036e+03
  1.33461036e+03  2.62573171e+03  3.02936554e+03  3.02936554e+03
  3.02936554e+03  6.65019518e+03  6.65019518e+03  6.65019518e+03
  9.03322002e+03  2.53907232e+04  7.61350910e+04]
E1 = -728.290680610275  E_coul = 201.81284167402757
cycle= 5 E= -526.477838936247  delta_E= -1.64e-10  |g|= 7.26e-06  |ddm|= 2.56e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.290680610275  E_coul = 201.81284167402757
  HOMO = -0.572587157409841  LUMO = 1.01148483973095
  mo_energy =
[-1.18561840e+02 -1.21871366e+01 -9.53864890e+00 -9.53864890e+00
 -9.53864890e+00 -1.24981335e+00 -5.72587157e-01 -5.72587157e-01
 -5.72587157e-01  1.01148484e+00  1.01148484e+00  1.01148484e+00
  7.21098811e+00  7.21098811e+00  7.21098811e+00  3.31110419e+01
  3.31110419e+01  3.31110419e+01  7.43038740e+01  1.28288485e+02
  1.28288485e+02  1.28288485e+02  4.82444192e+02  4.82444192e+02
  4.82444192e+02  5.56488438e+02  1.33461034e+03  1.33461034e+03
  1.33461034e+03  2.62573169e+03  3.02936552e+03  3.02936552e+03
  3.02936552e+03  6.65019516e+03  6.65019516e+03  6.65019516e+03
  9.03322000e+03  2.53907232e+04  7.61350910e+04]
E1 = -728.2907156759601  E_coul = 201.81287673970792
Extra cycle  E= -526.477838936252  delta_E= -4.77e-12  |g|= 1.88e-06  |ddm|= 3.66e-06
    CPU time for scf_cycle      0.67 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 100136.09789429948
E1 = -728.2907156759601  E_coul = 201.81287673970792
init E= -526.477838936252
    CPU time for initialize scf      2.76 sec, wall time      0.25 sec
  HOMO = -0.572586491759981  LUMO = 1.01148532886597
  mo_energy =
[-1.18561836e+02 -1.21871340e+01 -9.53864626e+00 -9.53864626e+00
 -9.53864626e+00 -1.24981249e+00 -5.72586492e-01 -5.72586492e-01
 -5.72586492e-01  1.01148533e+00  1.01148533e+00  1.01148533e+00
  7.21098977e+00  7.21098977e+00  7.21098977e+00  3.31110446e+01
  3.31110446e+01  3.31110446e+01  7.43038775e+01  1.28288488e+02
  1.28288488e+02  1.28288488e+02  4.82444196e+02  4.82444196e+02
  4.82444196e+02  5.56488442e+02  1.33461034e+03  1.33461034e+03
  1.33461034e+03  2.62573169e+03  3.02936552e+03  3.02936552e+03
  3.02936552e+03  6.65019516e+03  6.65019516e+03  6.65019516e+03
  9.03322001e+03  2.53907232e+04  7.61350910e+04]
E1 = -728.2907084265811  E_coul = 201.81286949033066
cycle= 1 E= -526.47783893625  delta_E= 1.71e-12  |g|= 4.23e-07  |ddm|= 6.97e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2907084265811  E_coul = 201.81286949033066
  HOMO = -0.572586621361277  LUMO = 1.01148523318173
  mo_energy =
[-1.18561837e+02 -1.21871346e+01 -9.53864680e+00 -9.53864680e+00
 -9.53864680e+00 -1.24981265e+00 -5.72586621e-01 -5.72586621e-01
 -5.72586621e-01  1.01148523e+00  1.01148523e+00  1.01148523e+00
  7.21098944e+00  7.21098944e+00  7.21098944e+00  3.31110440e+01
  3.31110440e+01  3.31110440e+01  7.43038767e+01  1.28288487e+02
  1.28288487e+02  1.28288487e+02  4.82444195e+02  4.82444195e+02
  4.82444195e+02  5.56488441e+02  1.33461034e+03  1.33461034e+03
  1.33461034e+03  2.62573169e+03  3.02936552e+03  3.02936552e+03
  3.02936552e+03  6.65019516e+03  6.65019516e+03  6.65019516e+03
  9.03322001e+03  2.53907232e+04  7.61350910e+04]
E1 = -728.2907099482567  E_coul = 201.81287101200542
Extra cycle  E= -526.477838936251  delta_E= -7.96e-13  |g|= 9.17e-08  |ddm|= 1.42e-07
    CPU time for scf_cycle      2.91 sec, wall time      0.40 sec
exp = [2.61826439e+04 7.61755232e+03 3.61735001e+03 1.59851516e+03
 3.81508465e+02 1.07645606e+02 3.46613952e+01 4.58455914e+00
 3.95258189e-01 1.36277981e+03 6.64783869e+02 3.01144788e+02
 3.14200647e+02 6.14708262e+01 7.27733163e+00 2.01443826e+01
 7.68436315e-01 2.78624414e+00 2.21540217e-01]
grad_E = [-1.51823007e-06  3.37558664e-06 -1.38926929e-06  7.10926976e-05
  1.12064128e-05 -2.61887712e-07 -4.11995792e-05 -1.50873303e-04
  1.84467111e-03 -5.02194592e-07  5.05067299e-06  2.38147419e-05
  2.05477742e-05  5.27181889e-06  5.36727283e-04 -1.20208628e-04
 -1.10738857e-03 -1.29930374e-03  1.65226764e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:46:11 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6433858        1
[INPUT] 0    0    [1    /1   ]  7617.55332843        1
[INPUT] 0    0    [1    /1   ]  3617.34878117        1
[INPUT] 0    0    [1    /1   ]  1598.53376428        1
[INPUT] 0    0    [1    /1   ]  381.600301127        1
[INPUT] 0    0    [1    /1   ]  107.678486606        1
[INPUT] 0    0    [1    /1   ]  34.6663660209        1
[INPUT] 0    0    [1    /1   ]  4.58464522806        1
[INPUT] 0    0    [1    /1   ]  0.395139161513       1
[INPUT] 1    0    [1    /1   ]  1362.77968145        1
[INPUT] 1    0    [1    /1   ]  664.783501637        1
[INPUT] 1    0    [1    /1   ]  301.142781509        1
[INPUT] 1    0    [1    /1   ]  314.199033378        1
[INPUT] 1    0    [1    /1   ]  61.6440912554        1
[INPUT] 1    0    [1    /1   ]  7.32236740812        1
[INPUT] 1    0    [1    /1   ]  20.2349265126        1
[INPUT] 1    0    [1    /1   ]  0.771358643426       1
[INPUT] 1    0    [1    /1   ]  2.8110114689         1
[INPUT] 1    0    [1    /1   ]  0.222128535943       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.6433857563, 1.0]], [0, [7617.55332843054, 1.0]], [0, [3617.3487811664704, 1.0]], [0, [1598.5337642846753, 1.0]], [0, [381.6003011273975, 1.0]], [0, [107.67848660628756, 1.0]], [0, [34.666366020872715, 1.0]], [0, [4.584645228062396, 1.0]], [0, [0.39513916151330253, 1.0]], [1, [1362.779681454167, 1.0]], [1, [664.7835016366544, 1.0]], [1, [301.1427815085792, 1.0]], [1, [314.1990333780741, 1.0]], [1, [61.64409125543972, 1.0]], [1, [7.322367408124719, 1.0]], [1, [20.234926512625577, 1.0]], [1, [0.7713586434261305, 1.0]], [1, [2.8110114689024948, 1.0]], [1, [0.22212853594261714, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.64338576]
bas 1, expnt(s) = [7617.55332843]
bas 2, expnt(s) = [3617.34878117]
bas 3, expnt(s) = [1598.53376428]
bas 4, expnt(s) = [381.60030113]
bas 5, expnt(s) = [107.67848661]
bas 6, expnt(s) = [34.66636602]
bas 7, expnt(s) = [4.58464523]
bas 8, expnt(s) = [0.39513916]
bas 9, expnt(s) = [1362.77968145]
bas 10, expnt(s) = [664.78350164]
bas 11, expnt(s) = [301.14278151]
bas 12, expnt(s) = [314.19903338]
bas 13, expnt(s) = [61.64409126]
bas 14, expnt(s) = [7.32236741]
bas 15, expnt(s) = [20.23492651]
bas 16, expnt(s) = [0.77135864]
bas 17, expnt(s) = [2.81101147]
bas 18, expnt(s) = [0.22212854]
CPU time:       834.68
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826434e+04 5.20026101e+03 7.61755333e+03 2.06004474e+03
 3.61734878e+03 1.17844092e+03 1.59853376e+03 6.38713925e+02
 3.81600301e+02 2.18133092e+02 1.07678487e+02 8.44523486e+01
 3.46663660e+01 3.60949349e+01 4.58464523e+00 7.91579111e+00
 3.95139162e-01 1.25915032e+00 1.36277968e+03 2.41555235e+04
 6.64783502e+02 9.84769714e+03 3.01142782e+02 3.65973774e+03
 3.14199033e+02 3.85913924e+03 6.16440913e+01 5.03905050e+02
 7.32236741e+00 3.51397598e+01 2.02349265e+01 1.25202048e+02
 7.71358643e-01 2.10889438e+00 2.81101147e+00 1.06184876e+01
 2.22128536e-01 4.44876879e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97694168681413
cond(S) = 100466.96633136382
E1 = -728.8836969381935  E_coul = 203.12129412666434
init E= -525.762402811529
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559464780527137  LUMO = 1.02364753191983
  mo_energy =
[-1.18319543e+02 -1.21034915e+01 -9.44893469e+00 -9.44893469e+00
 -9.44893469e+00 -1.23008855e+00 -5.59464781e-01 -5.59464781e-01
 -5.59464781e-01  1.02364753e+00  1.02364753e+00  1.02364753e+00
  7.32685858e+00  7.32685858e+00  7.32685858e+00  3.34744371e+01
  3.34744371e+01  3.34744371e+01  7.44659022e+01  1.29112105e+02
  1.29112105e+02  1.29112105e+02  4.83677194e+02  4.83677194e+02
  4.83677194e+02  5.56930885e+02  1.33595303e+03  1.33595303e+03
  1.33595303e+03  2.62655223e+03  3.03075041e+03  3.03075041e+03
  3.03075041e+03  6.65162209e+03  6.65162209e+03  6.65162209e+03
  9.03426486e+03  2.53918907e+04  7.61363341e+04]
E1 = -728.035387399794  E_coul = 201.5579481541831
cycle= 1 E= -526.477439245611  delta_E= -0.715  |g|= 0.185  |ddm|= 0.37
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.546461
diis-c [-0.29862005  1.        ]
  HOMO = -0.575837963983451  LUMO = 1.01382629168123
  mo_energy =
[-1.18600594e+02 -1.22055156e+01 -9.55740399e+00 -9.55740399e+00
 -9.55740399e+00 -1.25415054e+00 -5.75837964e-01 -5.75837964e-01
 -5.75837964e-01  1.01382629e+00  1.01382629e+00  1.01382629e+00
  7.26859992e+00  7.26859992e+00  7.26859992e+00  3.33570638e+01
  3.33570638e+01  3.33570638e+01  7.42955720e+01  1.28917268e+02
  1.28917268e+02  1.28917268e+02  4.83401553e+02  4.83401553e+02
  4.83401553e+02  5.56614402e+02  1.33561810e+03  1.33561810e+03
  1.33561810e+03  2.62608128e+03  3.03034863e+03  3.03034863e+03
  3.03034863e+03  6.65110584e+03  6.65110584e+03  6.65110584e+03
  9.03367224e+03  2.53912035e+04  7.61355563e+04]
E1 = -728.3478608763405  E_coul = 201.87002640511042
cycle= 2 E= -526.47783447123  delta_E= -0.000395  |g|= 0.0251  |ddm|= 0.0215
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.048875
diis-c [-0.00152222  0.05123905  0.94876095]
  HOMO = -0.571874188885874  LUMO = 1.01686291222565
  mo_energy =
[-1.18556392e+02 -1.21841505e+01 -9.53561715e+00 -9.53561715e+00
 -9.53561715e+00 -1.24889295e+00 -5.71874189e-01 -5.71874189e-01
 -5.71874189e-01  1.01686291e+00  1.01686291e+00  1.01686291e+00
  7.28032206e+00  7.28032206e+00  7.28032206e+00  3.33795850e+01
  3.33795850e+01  3.33795850e+01  7.43308561e+01  1.28952032e+02
  1.28952032e+02  1.28952032e+02  4.83445163e+02  4.83445163e+02
  4.83445163e+02  5.56660077e+02  1.33566489e+03  1.33566489e+03
  1.33566489e+03  2.62613032e+03  3.03039702e+03  3.03039702e+03
  3.03039702e+03  6.65115524e+03  6.65115524e+03  6.65115524e+03
  9.03372205e+03  2.53912534e+04  7.61356064e+04]
E1 = -728.2828303056544  E_coul = 201.80498141443218
cycle= 3 E= -526.477848891222  delta_E= -1.44e-05  |g|= 0.00308  |ddm|= 0.00549
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00660821
diis-c [-3.74865362e-07 -1.08424558e-03  1.12595617e-01  8.88488629e-01]
  HOMO = -0.572582710989617  LUMO = 1.01633538406091
  mo_energy =
[-1.18561828e+02 -1.21871325e+01 -9.53870608e+00 -9.53870608e+00
 -9.53870608e+00 -1.24981153e+00 -5.72582711e-01 -5.72582711e-01
 -5.72582711e-01  1.01633538e+00  1.01633538e+00  1.01633538e+00
  7.27847229e+00  7.27847229e+00  7.27847229e+00  3.33764434e+01
  3.33764434e+01  3.33764434e+01  7.43264858e+01  1.28947592e+02
  1.28947592e+02  1.28947592e+02  4.83439801e+02  4.83439801e+02
  4.83439801e+02  5.56654463e+02  1.33565915e+03  1.33565915e+03
  1.33565915e+03  2.62612418e+03  3.03039103e+03  3.03039103e+03
  3.03039103e+03  6.65114901e+03  6.65114901e+03  6.65114901e+03
  9.03371569e+03  2.53912470e+04  7.61355998e+04]
E1 = -728.291664777989  E_coul = 201.8138155652697
cycle= 4 E= -526.477849212719  delta_E= -3.21e-07  |g|= 4.59e-05  |ddm|= 0.000804
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=6.33174e-05
diis-c [-1.94381359e-09  1.15126950e-06 -1.09955194e-03 -1.30386596e-03
  1.00240227e+00]
  HOMO = -0.572553821335599  LUMO = 1.01635639877079
  mo_energy =
[-1.18561727e+02 -1.21870391e+01 -9.53861362e+00 -9.53861362e+00
 -9.53861362e+00 -1.24977398e+00 -5.72553821e-01 -5.72553821e-01
 -5.72553821e-01  1.01635640e+00  1.01635640e+00  1.01635640e+00
  7.27853810e+00  7.27853810e+00  7.27853810e+00  3.33765326e+01
  3.33765326e+01  3.33765326e+01  7.43265894e+01  1.28947691e+02
  1.28947691e+02  1.28947691e+02  4.83439901e+02  4.83439901e+02
  4.83439901e+02  5.56654561e+02  1.33565925e+03  1.33565925e+03
  1.33565925e+03  2.62612426e+03  3.03039113e+03  3.03039113e+03
  3.03039113e+03  6.65114909e+03  6.65114909e+03  6.65114909e+03
  9.03371577e+03  2.53912470e+04  7.61355999e+04]
E1 = -728.2914390062106  E_coul = 201.81358979332643
cycle= 5 E= -526.477849212884  delta_E= -1.65e-10  |g|= 7.26e-06  |ddm|= 2.56e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.2914390062106  E_coul = 201.81358979332643
  HOMO = -0.572557633431929  LUMO = 1.01635361666624
  mo_energy =
[-1.18561745e+02 -1.21870522e+01 -9.53862701e+00 -9.53862701e+00
 -9.53862701e+00 -1.24977891e+00 -5.72557633e-01 -5.72557633e-01
 -5.72557633e-01  1.01635362e+00  1.01635362e+00  1.01635362e+00
  7.27852909e+00  7.27852909e+00  7.27852909e+00  3.33765195e+01
  3.33765195e+01  3.33765195e+01  7.43265734e+01  1.28947675e+02
  1.28947675e+02  1.28947675e+02  4.83439883e+02  4.83439883e+02
  4.83439883e+02  5.56654543e+02  1.33565923e+03  1.33565923e+03
  1.33565923e+03  2.62612425e+03  3.03039111e+03  3.03039111e+03
  3.03039111e+03  6.65114908e+03  6.65114908e+03  6.65114908e+03
  9.03371575e+03  2.53912470e+04  7.61355999e+04]
E1 = -728.291474060812  E_coul = 201.81362484792547
Extra cycle  E= -526.477849212887  delta_E= -2.39e-12  |g|= 1.88e-06  |ddm|= 3.66e-06
    CPU time for scf_cycle      0.67 sec, wall time      0.29 sec
exp = [2.61826434e+04 7.61755333e+03 3.61734878e+03 1.59853376e+03
 3.81600301e+02 1.07678487e+02 3.46663660e+01 4.58464523e+00
 3.95139162e-01 1.36277968e+03 6.64783502e+02 3.01142782e+02
 3.14199033e+02 6.16440913e+01 7.32236741e+00 2.02349265e+01
 7.71358643e-01 2.81101147e+00 2.22128536e-01]
E = -526.4778492128866
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:46:12 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6433858        1
[INPUT] 0    0    [1    /1   ]  7617.55332843        1
[INPUT] 0    0    [1    /1   ]  3617.34878117        1
[INPUT] 0    0    [1    /1   ]  1598.53376428        1
[INPUT] 0    0    [1    /1   ]  381.600301127        1
[INPUT] 0    0    [1    /1   ]  107.678486606        1
[INPUT] 0    0    [1    /1   ]  34.6663660209        1
[INPUT] 0    0    [1    /1   ]  4.58464522806        1
[INPUT] 0    0    [1    /1   ]  0.395139161513       1
[INPUT] 1    0    [1    /1   ]  1362.77968145        1
[INPUT] 1    0    [1    /1   ]  664.783501637        1
[INPUT] 1    0    [1    /1   ]  301.142781509        1
[INPUT] 1    0    [1    /1   ]  314.199033378        1
[INPUT] 1    0    [1    /1   ]  61.6440912554        1
[INPUT] 1    0    [1    /1   ]  7.32236740812        1
[INPUT] 1    0    [1    /1   ]  20.2349265126        1
[INPUT] 1    0    [1    /1   ]  0.771358643426       1
[INPUT] 1    0    [1    /1   ]  2.8110114689         1
[INPUT] 1    0    [1    /1   ]  0.222128535943       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.6433857563, 1.0]], [0, [7617.55332843054, 1.0]], [0, [3617.3487811664704, 1.0]], [0, [1598.5337642846753, 1.0]], [0, [381.6003011273975, 1.0]], [0, [107.67848660628756, 1.0]], [0, [34.666366020872715, 1.0]], [0, [4.584645228062396, 1.0]], [0, [0.39513916151330253, 1.0]], [1, [1362.779681454167, 1.0]], [1, [664.7835016366544, 1.0]], [1, [301.1427815085792, 1.0]], [1, [314.1990333780741, 1.0]], [1, [61.64409125543972, 1.0]], [1, [7.322367408124719, 1.0]], [1, [20.234926512625577, 1.0]], [1, [0.7713586434261305, 1.0]], [1, [2.8110114689024948, 1.0]], [1, [0.22212853594261714, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.64338576]
bas 1, expnt(s) = [7617.55332843]
bas 2, expnt(s) = [3617.34878117]
bas 3, expnt(s) = [1598.53376428]
bas 4, expnt(s) = [381.60030113]
bas 5, expnt(s) = [107.67848661]
bas 6, expnt(s) = [34.66636602]
bas 7, expnt(s) = [4.58464523]
bas 8, expnt(s) = [0.39513916]
bas 9, expnt(s) = [1362.77968145]
bas 10, expnt(s) = [664.78350164]
bas 11, expnt(s) = [301.14278151]
bas 12, expnt(s) = [314.19903338]
bas 13, expnt(s) = [61.64409126]
bas 14, expnt(s) = [7.32236741]
bas 15, expnt(s) = [20.23492651]
bas 16, expnt(s) = [0.77135864]
bas 17, expnt(s) = [2.81101147]
bas 18, expnt(s) = [0.22212854]
CPU time:       835.67
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826434e+04 5.20026101e+03 7.61755333e+03 2.06004474e+03
 3.61734878e+03 1.17844092e+03 1.59853376e+03 6.38713925e+02
 3.81600301e+02 2.18133092e+02 1.07678487e+02 8.44523486e+01
 3.46663660e+01 3.60949349e+01 4.58464523e+00 7.91579111e+00
 3.95139162e-01 1.25915032e+00 1.36277968e+03 2.41555235e+04
 6.64783502e+02 9.84769714e+03 3.01142782e+02 3.65973774e+03
 3.14199033e+02 3.85913924e+03 6.16440913e+01 5.03905050e+02
 7.32236741e+00 3.51397598e+01 2.02349265e+01 1.25202048e+02
 7.71358643e-01 2.10889438e+00 2.81101147e+00 1.06184876e+01
 2.22128536e-01 4.44876879e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97694168681413
cond(S) = 100466.96633136382
E1 = -728.8836969381935  E_coul = 203.12129412666434
init E= -525.762402811529
    CPU time for initialize scf      0.45 sec, wall time      0.05 sec
  HOMO = -0.559464780527137  LUMO = 1.02364753191983
  mo_energy =
[-1.18319543e+02 -1.21034915e+01 -9.44893469e+00 -9.44893469e+00
 -9.44893469e+00 -1.23008855e+00 -5.59464781e-01 -5.59464781e-01
 -5.59464781e-01  1.02364753e+00  1.02364753e+00  1.02364753e+00
  7.32685858e+00  7.32685858e+00  7.32685858e+00  3.34744371e+01
  3.34744371e+01  3.34744371e+01  7.44659022e+01  1.29112105e+02
  1.29112105e+02  1.29112105e+02  4.83677194e+02  4.83677194e+02
  4.83677194e+02  5.56930885e+02  1.33595303e+03  1.33595303e+03
  1.33595303e+03  2.62655223e+03  3.03075041e+03  3.03075041e+03
  3.03075041e+03  6.65162209e+03  6.65162209e+03  6.65162209e+03
  9.03426486e+03  2.53918907e+04  7.61363341e+04]
E1 = -728.035387399794  E_coul = 201.5579481541831
cycle= 1 E= -526.477439245611  delta_E= -0.715  |g|= 0.185  |ddm|= 0.37
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.546461
diis-c [-0.29862005  1.        ]
  HOMO = -0.575837963983451  LUMO = 1.01382629168123
  mo_energy =
[-1.18600594e+02 -1.22055156e+01 -9.55740399e+00 -9.55740399e+00
 -9.55740399e+00 -1.25415054e+00 -5.75837964e-01 -5.75837964e-01
 -5.75837964e-01  1.01382629e+00  1.01382629e+00  1.01382629e+00
  7.26859992e+00  7.26859992e+00  7.26859992e+00  3.33570638e+01
  3.33570638e+01  3.33570638e+01  7.42955720e+01  1.28917268e+02
  1.28917268e+02  1.28917268e+02  4.83401553e+02  4.83401553e+02
  4.83401553e+02  5.56614402e+02  1.33561810e+03  1.33561810e+03
  1.33561810e+03  2.62608128e+03  3.03034863e+03  3.03034863e+03
  3.03034863e+03  6.65110584e+03  6.65110584e+03  6.65110584e+03
  9.03367224e+03  2.53912035e+04  7.61355563e+04]
E1 = -728.3478608763405  E_coul = 201.87002640511042
cycle= 2 E= -526.47783447123  delta_E= -0.000395  |g|= 0.0251  |ddm|= 0.0215
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.048875
diis-c [-0.00152222  0.05123905  0.94876095]
  HOMO = -0.571874188885874  LUMO = 1.01686291222565
  mo_energy =
[-1.18556392e+02 -1.21841505e+01 -9.53561715e+00 -9.53561715e+00
 -9.53561715e+00 -1.24889295e+00 -5.71874189e-01 -5.71874189e-01
 -5.71874189e-01  1.01686291e+00  1.01686291e+00  1.01686291e+00
  7.28032206e+00  7.28032206e+00  7.28032206e+00  3.33795850e+01
  3.33795850e+01  3.33795850e+01  7.43308561e+01  1.28952032e+02
  1.28952032e+02  1.28952032e+02  4.83445163e+02  4.83445163e+02
  4.83445163e+02  5.56660077e+02  1.33566489e+03  1.33566489e+03
  1.33566489e+03  2.62613032e+03  3.03039702e+03  3.03039702e+03
  3.03039702e+03  6.65115524e+03  6.65115524e+03  6.65115524e+03
  9.03372205e+03  2.53912534e+04  7.61356064e+04]
E1 = -728.2828303056544  E_coul = 201.80498141443218
cycle= 3 E= -526.477848891222  delta_E= -1.44e-05  |g|= 0.00308  |ddm|= 0.00549
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00660821
diis-c [-3.74865362e-07 -1.08424558e-03  1.12595617e-01  8.88488629e-01]
  HOMO = -0.572582710989617  LUMO = 1.01633538406091
  mo_energy =
[-1.18561828e+02 -1.21871325e+01 -9.53870608e+00 -9.53870608e+00
 -9.53870608e+00 -1.24981153e+00 -5.72582711e-01 -5.72582711e-01
 -5.72582711e-01  1.01633538e+00  1.01633538e+00  1.01633538e+00
  7.27847229e+00  7.27847229e+00  7.27847229e+00  3.33764434e+01
  3.33764434e+01  3.33764434e+01  7.43264858e+01  1.28947592e+02
  1.28947592e+02  1.28947592e+02  4.83439801e+02  4.83439801e+02
  4.83439801e+02  5.56654463e+02  1.33565915e+03  1.33565915e+03
  1.33565915e+03  2.62612418e+03  3.03039103e+03  3.03039103e+03
  3.03039103e+03  6.65114901e+03  6.65114901e+03  6.65114901e+03
  9.03371569e+03  2.53912470e+04  7.61355998e+04]
E1 = -728.291664777989  E_coul = 201.8138155652697
cycle= 4 E= -526.477849212719  delta_E= -3.21e-07  |g|= 4.59e-05  |ddm|= 0.000804
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=6.33174e-05
diis-c [-1.94381359e-09  1.15126950e-06 -1.09955194e-03 -1.30386596e-03
  1.00240227e+00]
  HOMO = -0.572553821335599  LUMO = 1.01635639877079
  mo_energy =
[-1.18561727e+02 -1.21870391e+01 -9.53861362e+00 -9.53861362e+00
 -9.53861362e+00 -1.24977398e+00 -5.72553821e-01 -5.72553821e-01
 -5.72553821e-01  1.01635640e+00  1.01635640e+00  1.01635640e+00
  7.27853810e+00  7.27853810e+00  7.27853810e+00  3.33765326e+01
  3.33765326e+01  3.33765326e+01  7.43265894e+01  1.28947691e+02
  1.28947691e+02  1.28947691e+02  4.83439901e+02  4.83439901e+02
  4.83439901e+02  5.56654561e+02  1.33565925e+03  1.33565925e+03
  1.33565925e+03  2.62612426e+03  3.03039113e+03  3.03039113e+03
  3.03039113e+03  6.65114909e+03  6.65114909e+03  6.65114909e+03
  9.03371577e+03  2.53912470e+04  7.61355999e+04]
E1 = -728.2914390062106  E_coul = 201.81358979332643
cycle= 5 E= -526.477849212884  delta_E= -1.65e-10  |g|= 7.26e-06  |ddm|= 2.56e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.2914390062106  E_coul = 201.81358979332643
  HOMO = -0.572557633431929  LUMO = 1.01635361666624
  mo_energy =
[-1.18561745e+02 -1.21870522e+01 -9.53862701e+00 -9.53862701e+00
 -9.53862701e+00 -1.24977891e+00 -5.72557633e-01 -5.72557633e-01
 -5.72557633e-01  1.01635362e+00  1.01635362e+00  1.01635362e+00
  7.27852909e+00  7.27852909e+00  7.27852909e+00  3.33765195e+01
  3.33765195e+01  3.33765195e+01  7.43265734e+01  1.28947675e+02
  1.28947675e+02  1.28947675e+02  4.83439883e+02  4.83439883e+02
  4.83439883e+02  5.56654543e+02  1.33565923e+03  1.33565923e+03
  1.33565923e+03  2.62612425e+03  3.03039111e+03  3.03039111e+03
  3.03039111e+03  6.65114908e+03  6.65114908e+03  6.65114908e+03
  9.03371575e+03  2.53912470e+04  7.61355999e+04]
E1 = -728.291474060812  E_coul = 201.81362484792547
Extra cycle  E= -526.477849212887  delta_E= -2.39e-12  |g|= 1.88e-06  |ddm|= 3.66e-06
    CPU time for scf_cycle      0.70 sec, wall time      0.30 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 100466.96633136382
E1 = -728.291474060812  E_coul = 201.81362484792547
init E= -526.477849212887
    CPU time for initialize scf      2.82 sec, wall time      0.26 sec
  HOMO = -0.572556968174146  LUMO = 1.01635410815
  mo_energy =
[-1.18561740e+02 -1.21870496e+01 -9.53862437e+00 -9.53862437e+00
 -9.53862437e+00 -1.24977804e+00 -5.72556968e-01 -5.72556968e-01
 -5.72556968e-01  1.01635411e+00  1.01635411e+00  1.01635411e+00
  7.27853076e+00  7.27853076e+00  7.27853076e+00  3.33765221e+01
  3.33765221e+01  3.33765221e+01  7.43265769e+01  1.28947678e+02
  1.28947678e+02  1.28947678e+02  4.83439888e+02  4.83439888e+02
  4.83439888e+02  5.56654548e+02  1.33565923e+03  1.33565923e+03
  1.33565923e+03  2.62612425e+03  3.03039111e+03  3.03039111e+03
  3.03039111e+03  6.65114908e+03  6.65114908e+03  6.65114908e+03
  9.03371576e+03  2.53912470e+04  7.61355999e+04]
E1 = -728.2914668194078  E_coul = 201.81361760652
cycle= 1 E= -526.477849212888  delta_E= -1.25e-12  |g|= 4.23e-07  |ddm|= 6.97e-07
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
E1 = -728.2914668194078  E_coul = 201.81361760652
  HOMO = -0.57255709757337  LUMO = 1.01635401209451
  mo_energy =
[-1.18561741e+02 -1.21870502e+01 -9.53862491e+00 -9.53862491e+00
 -9.53862491e+00 -1.24977821e+00 -5.72557098e-01 -5.72557098e-01
 -5.72557098e-01  1.01635401e+00  1.01635401e+00  1.01635401e+00
  7.27853042e+00  7.27853042e+00  7.27853042e+00  3.33765216e+01
  3.33765216e+01  3.33765216e+01  7.43265762e+01  1.28947678e+02
  1.28947678e+02  1.28947678e+02  4.83439887e+02  4.83439887e+02
  4.83439887e+02  5.56654547e+02  1.33565923e+03  1.33565923e+03
  1.33565923e+03  2.62612425e+03  3.03039111e+03  3.03039111e+03
  3.03039111e+03  6.65114908e+03  6.65114908e+03  6.65114908e+03
  9.03371576e+03  2.53912470e+04  7.61355999e+04]
E1 = -728.2914683383248  E_coul = 201.8136191254385
Extra cycle  E= -526.477849212886  delta_E= 1.59e-12  |g|= 9.16e-08  |ddm|= 1.42e-07
    CPU time for scf_cycle      2.98 sec, wall time      0.41 sec
exp = [2.61826434e+04 7.61755333e+03 3.61734878e+03 1.59853376e+03
 3.81600301e+02 1.07678487e+02 3.46663660e+01 4.58464523e+00
 3.95139162e-01 1.36277968e+03 6.64783502e+02 3.01142782e+02
 3.14199033e+02 6.16440913e+01 7.32236741e+00 2.02349265e+01
 7.71358643e-01 2.81101147e+00 2.22128536e-01]
grad_E = [-1.51799088e-06  3.37297494e-06 -1.39127727e-06  7.10193043e-05
  1.01231666e-05  1.31419789e-05 -6.88504260e-05 -9.53614358e-05
  2.53568766e-04 -5.07612075e-07  4.98713202e-06  2.34874659e-05
  2.02587070e-05 -9.77138153e-06 -7.75563473e-06 -2.10991710e-06
  2.94793051e-05 -6.73446604e-05 -7.21045022e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:46:17 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6434104        1
[INPUT] 0    0    [1    /1   ]  7617.55303443        1
[INPUT] 0    0    [1    /1   ]  3617.34815784        1
[INPUT] 0    0    [1    /1   ]  1598.52450981        1
[INPUT] 0    0    [1    /1   ]  381.686666773        1
[INPUT] 0    0    [1    /1   ]  107.722064007        1
[INPUT] 0    0    [1    /1   ]  34.682729554         1
[INPUT] 0    0    [1    /1   ]  4.58474149611        1
[INPUT] 0    0    [1    /1   ]  0.39511928474        1
[INPUT] 1    0    [1    /1   ]  1362.77966207        1
[INPUT] 1    0    [1    /1   ]  664.783236599        1
[INPUT] 1    0    [1    /1   ]  301.141332297        1
[INPUT] 1    0    [1    /1   ]  314.197755775        1
[INPUT] 1    0    [1    /1   ]  61.6676248472        1
[INPUT] 1    0    [1    /1   ]  7.3295616328         1
[INPUT] 1    0    [1    /1   ]  20.2485338167        1
[INPUT] 1    0    [1    /1   ]  0.771869077212       1
[INPUT] 1    0    [1    /1   ]  2.81453997852        1
[INPUT] 1    0    [1    /1   ]  0.222266460952       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.64341042803, 1.0]], [0, [7617.553034429508, 1.0]], [0, [3617.348157842948, 1.0]], [0, [1598.5245098061994, 1.0]], [0, [381.6866667731503, 1.0]], [0, [107.72206400713466, 1.0]], [0, [34.68272955401823, 1.0]], [0, [4.584741496105113, 1.0]], [0, [0.39511928474030084, 1.0]], [1, [1362.779662072771, 1.0]], [1, [664.7832365989668, 1.0]], [1, [301.14133229691805, 1.0]], [1, [314.19775577467396, 1.0]], [1, [61.66762484718812, 1.0]], [1, [7.329561632798924, 1.0]], [1, [20.248533816718414, 1.0]], [1, [0.7718690772123369, 1.0]], [1, [2.814539978516298, 1.0]], [1, [0.22226646095196223, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.64341043]
bas 1, expnt(s) = [7617.55303443]
bas 2, expnt(s) = [3617.34815784]
bas 3, expnt(s) = [1598.52450981]
bas 4, expnt(s) = [381.68666677]
bas 5, expnt(s) = [107.72206401]
bas 6, expnt(s) = [34.68272955]
bas 7, expnt(s) = [4.5847415]
bas 8, expnt(s) = [0.39511928]
bas 9, expnt(s) = [1362.77966207]
bas 10, expnt(s) = [664.7832366]
bas 11, expnt(s) = [301.1413323]
bas 12, expnt(s) = [314.19775577]
bas 13, expnt(s) = [61.66762485]
bas 14, expnt(s) = [7.32956163]
bas 15, expnt(s) = [20.24853382]
bas 16, expnt(s) = [0.77186908]
bas 17, expnt(s) = [2.81453998]
bas 18, expnt(s) = [0.22226646]
CPU time:       844.27
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826434e+04 5.20026101e+03 7.61755303e+03 2.06004468e+03
 3.61734816e+03 1.17844076e+03 1.59852451e+03 6.38711152e+02
 3.81686667e+02 2.18170118e+02 1.07722064e+02 8.44779806e+01
 3.46827296e+01 3.61077125e+01 4.58474150e+00 7.91591577e+00
 3.95119285e-01 1.25910281e+00 1.36277966e+03 2.41555231e+04
 6.64783237e+02 9.84769223e+03 3.01141332e+02 3.65971572e+03
 3.14197756e+02 3.85911962e+03 6.16676248e+01 5.04145529e+02
 7.32956163e+00 3.51829211e+01 2.02485338e+01 1.25307299e+02
 7.71869077e-01 2.11063894e+00 2.81453998e+00 1.06351512e+01
 2.22266461e-01 4.45222199e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97692253101201
cond(S) = 100514.89265854156
E1 = -728.8833704144429  E_coul = 203.1211017528719
init E= -525.762268661571
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559467553707072  LUMO = 1.0246337702809
  mo_energy =
[-1.18319533e+02 -1.21035282e+01 -9.44895104e+00 -9.44895104e+00
 -9.44895104e+00 -1.23009961e+00 -5.59467554e-01 -5.59467554e-01
 -5.59467554e-01  1.02463377e+00  1.02463377e+00  1.02463377e+00
  7.33731438e+00  7.33731438e+00  7.33731438e+00  3.35150833e+01
  3.35150833e+01  3.35150833e+01  7.45153670e+01  1.29209896e+02
  1.29209896e+02  1.29209896e+02  4.83819964e+02  4.83819964e+02
  4.83819964e+02  5.57162771e+02  1.33609998e+03  1.33609998e+03
  1.33609998e+03  2.62699379e+03  3.03089058e+03  3.03089058e+03
  3.03089058e+03  6.65174985e+03  6.65174985e+03  6.65174985e+03
  9.03476055e+03  2.53923779e+04  7.61367915e+04]
E1 = -728.0365596063468  E_coul = 201.55911911488153
cycle= 1 E= -526.477440491465  delta_E= -0.715  |g|= 0.185  |ddm|= 0.37
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.546385
diis-c [-0.29853684  1.        ]
  HOMO = -0.575806446177405  LUMO = 1.01482359965961
  mo_energy =
[-1.18600431e+02 -1.22054648e+01 -9.55732204e+00 -9.55732204e+00
 -9.55732204e+00 -1.25411928e+00 -5.75806446e-01 -5.75806446e-01
 -5.75806446e-01  1.01482360e+00  1.01482360e+00  1.01482360e+00
  7.27907174e+00  7.27907174e+00  7.27907174e+00  3.33977640e+01
  3.33977640e+01  3.33977640e+01  7.43451233e+01  1.29015171e+02
  1.29015171e+02  1.29015171e+02  4.83544487e+02  4.83544487e+02
  4.83544487e+02  5.56846439e+02  1.33576524e+03  1.33576524e+03
  1.33576524e+03  2.62652305e+03  3.03048900e+03  3.03048900e+03
  3.03048900e+03  6.65123381e+03  6.65123381e+03  6.65123381e+03
  9.03416817e+03  2.53916909e+04  7.61360139e+04]
E1 = -728.3486853326683  E_coul = 201.87085019972832
cycle= 2 E= -526.47783513294  delta_E= -0.000395  |g|= 0.0251  |ddm|= 0.0215
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0488415
diis-c [-0.00152074  0.05119562  0.94880438]
  HOMO = -0.571848374821974  LUMO = 1.01785905251
  mo_energy =
[-1.18556268e+02 -1.21841228e+01 -9.53555895e+00 -9.53555895e+00
 -9.53555895e+00 -1.24886931e+00 -5.71848375e-01 -5.71848375e-01
 -5.71848375e-01  1.01785905e+00  1.01785905e+00  1.01785905e+00
  7.29078958e+00  7.29078958e+00  7.29078958e+00  3.34202700e+01
  3.34202700e+01  3.34202700e+01  7.43803806e+01  1.29049905e+02
  1.29049905e+02  1.29049905e+02  4.83588058e+02  4.83588058e+02
  4.83588058e+02  5.56892077e+02  1.33581199e+03  1.33581199e+03
  1.33581199e+03  2.62657206e+03  3.03053735e+03  3.03053735e+03
  3.03053735e+03  6.65128317e+03  6.65128317e+03  6.65128317e+03
  9.03421794e+03  2.53917409e+04  7.61360639e+04]
E1 = -728.2837366323024  E_coul = 201.80588711099108
cycle= 3 E= -526.477849521311  delta_E= -1.44e-05  |g|= 0.00307  |ddm|= 0.00549
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00660348
diis-c [-3.74063748e-07 -1.08360362e-03  1.12594873e-01  8.88488730e-01]
  HOMO = -0.572556006870739  LUMO = 1.0173316699097
  mo_energy =
[-1.18561699e+02 -1.21871019e+01 -9.53864484e+00 -9.53864484e+00
 -9.53864484e+00 -1.24978675e+00 -5.72556007e-01 -5.72556007e-01
 -5.72556007e-01  1.01733167e+00  1.01733167e+00  1.01733167e+00
  7.28894048e+00  7.28894048e+00  7.28894048e+00  3.34171305e+01
  3.34171305e+01  3.34171305e+01  7.43760135e+01  1.29045469e+02
  1.29045469e+02  1.29045469e+02  4.83582700e+02  4.83582700e+02
  4.83582700e+02  5.56886467e+02  1.33580625e+03  1.33580625e+03
  1.33580625e+03  2.62656591e+03  3.03053137e+03  3.03053137e+03
  3.03053137e+03  6.65127695e+03  6.65127695e+03  6.65127695e+03
  9.03421158e+03  2.53917344e+04  7.61360574e+04]
E1 = -728.2925606303993  E_coul = 201.81471078827445
cycle= 4 E= -526.477849842125  delta_E= -3.21e-07  |g|= 4.59e-05  |ddm|= 0.000803
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.33003e-05
diis-c [-1.93987136e-09  1.16910186e-06 -1.09963060e-03 -1.29754616e-03
  1.00239601e+00]
  HOMO = -0.572527137733074  LUMO = 1.01735268944859
  mo_energy =
[-1.18561598e+02 -1.21870086e+01 -9.53855244e+00 -9.53855244e+00
 -9.53855244e+00 -1.24974922e+00 -5.72527138e-01 -5.72527138e-01
 -5.72527138e-01  1.01735269e+00  1.01735269e+00  1.01735269e+00
  7.28900628e+00  7.28900628e+00  7.28900628e+00  3.34172197e+01
  3.34172197e+01  3.34172197e+01  7.43761171e+01  1.29045568e+02
  1.29045568e+02  1.29045568e+02  4.83582801e+02  4.83582801e+02
  4.83582801e+02  5.56886565e+02  1.33580635e+03  1.33580635e+03
  1.33580635e+03  2.62656600e+03  3.03053146e+03  3.03053146e+03
  3.03053146e+03  6.65127703e+03  6.65127703e+03  6.65127703e+03
  9.03421166e+03  2.53917345e+04  7.61360574e+04]
E1 = -728.2923350721555  E_coul = 201.81448522986614
cycle= 5 E= -526.477849842289  delta_E= -1.65e-10  |g|= 7.25e-06  |ddm|= 2.55e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.2923350721555  E_coul = 201.81448522986614
  HOMO = -0.572530944624217  LUMO = 1.01734990855359
  mo_energy =
[-1.18561616e+02 -1.21870217e+01 -9.53856581e+00 -9.53856581e+00
 -9.53856581e+00 -1.24975415e+00 -5.72530945e-01 -5.72530945e-01
 -5.72530945e-01  1.01734991e+00  1.01734991e+00  1.01734991e+00
  7.28899728e+00  7.28899728e+00  7.28899728e+00  3.34172066e+01
  3.34172066e+01  3.34172066e+01  7.43761011e+01  1.29045552e+02
  1.29045552e+02  1.29045552e+02  4.83582783e+02  4.83582783e+02
  4.83582783e+02  5.56886547e+02  1.33580633e+03  1.33580633e+03
  1.33580633e+03  2.62656598e+03  3.03053144e+03  3.03053144e+03
  3.03053144e+03  6.65127701e+03  6.65127701e+03  6.65127701e+03
  9.03421164e+03  2.53917345e+04  7.61360574e+04]
E1 = -728.2923700753871  E_coul = 201.81452023309473
Extra cycle  E= -526.477849842292  delta_E= -2.96e-12  |g|= 1.88e-06  |ddm|= 3.66e-06
    CPU time for scf_cycle      0.66 sec, wall time      0.27 sec
exp = [2.61826434e+04 7.61755303e+03 3.61734816e+03 1.59852451e+03
 3.81686667e+02 1.07722064e+02 3.46827296e+01 4.58474150e+00
 3.95119285e-01 1.36277966e+03 6.64783237e+02 3.01141332e+02
 3.14197756e+02 6.16676248e+01 7.32956163e+00 2.02485338e+01
 7.71869077e-01 2.81453998e+00 2.22266461e-01]
E = -526.4778498422924
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:46:17 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6434104        1
[INPUT] 0    0    [1    /1   ]  7617.55303443        1
[INPUT] 0    0    [1    /1   ]  3617.34815784        1
[INPUT] 0    0    [1    /1   ]  1598.52450981        1
[INPUT] 0    0    [1    /1   ]  381.686666773        1
[INPUT] 0    0    [1    /1   ]  107.722064007        1
[INPUT] 0    0    [1    /1   ]  34.682729554         1
[INPUT] 0    0    [1    /1   ]  4.58474149611        1
[INPUT] 0    0    [1    /1   ]  0.39511928474        1
[INPUT] 1    0    [1    /1   ]  1362.77966207        1
[INPUT] 1    0    [1    /1   ]  664.783236599        1
[INPUT] 1    0    [1    /1   ]  301.141332297        1
[INPUT] 1    0    [1    /1   ]  314.197755775        1
[INPUT] 1    0    [1    /1   ]  61.6676248472        1
[INPUT] 1    0    [1    /1   ]  7.3295616328         1
[INPUT] 1    0    [1    /1   ]  20.2485338167        1
[INPUT] 1    0    [1    /1   ]  0.771869077212       1
[INPUT] 1    0    [1    /1   ]  2.81453997852        1
[INPUT] 1    0    [1    /1   ]  0.222266460952       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.64341042803, 1.0]], [0, [7617.553034429508, 1.0]], [0, [3617.348157842948, 1.0]], [0, [1598.5245098061994, 1.0]], [0, [381.6866667731503, 1.0]], [0, [107.72206400713466, 1.0]], [0, [34.68272955401823, 1.0]], [0, [4.584741496105113, 1.0]], [0, [0.39511928474030084, 1.0]], [1, [1362.779662072771, 1.0]], [1, [664.7832365989668, 1.0]], [1, [301.14133229691805, 1.0]], [1, [314.19775577467396, 1.0]], [1, [61.66762484718812, 1.0]], [1, [7.329561632798924, 1.0]], [1, [20.248533816718414, 1.0]], [1, [0.7718690772123369, 1.0]], [1, [2.814539978516298, 1.0]], [1, [0.22226646095196223, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.64341043]
bas 1, expnt(s) = [7617.55303443]
bas 2, expnt(s) = [3617.34815784]
bas 3, expnt(s) = [1598.52450981]
bas 4, expnt(s) = [381.68666677]
bas 5, expnt(s) = [107.72206401]
bas 6, expnt(s) = [34.68272955]
bas 7, expnt(s) = [4.5847415]
bas 8, expnt(s) = [0.39511928]
bas 9, expnt(s) = [1362.77966207]
bas 10, expnt(s) = [664.7832366]
bas 11, expnt(s) = [301.1413323]
bas 12, expnt(s) = [314.19775577]
bas 13, expnt(s) = [61.66762485]
bas 14, expnt(s) = [7.32956163]
bas 15, expnt(s) = [20.24853382]
bas 16, expnt(s) = [0.77186908]
bas 17, expnt(s) = [2.81453998]
bas 18, expnt(s) = [0.22226646]
CPU time:       845.25
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826434e+04 5.20026101e+03 7.61755303e+03 2.06004468e+03
 3.61734816e+03 1.17844076e+03 1.59852451e+03 6.38711152e+02
 3.81686667e+02 2.18170118e+02 1.07722064e+02 8.44779806e+01
 3.46827296e+01 3.61077125e+01 4.58474150e+00 7.91591577e+00
 3.95119285e-01 1.25910281e+00 1.36277966e+03 2.41555231e+04
 6.64783237e+02 9.84769223e+03 3.01141332e+02 3.65971572e+03
 3.14197756e+02 3.85911962e+03 6.16676248e+01 5.04145529e+02
 7.32956163e+00 3.51829211e+01 2.02485338e+01 1.25307299e+02
 7.71869077e-01 2.11063894e+00 2.81453998e+00 1.06351512e+01
 2.22266461e-01 4.45222199e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97692253101201
cond(S) = 100514.89265854156
E1 = -728.8833704144429  E_coul = 203.1211017528719
init E= -525.762268661571
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559467553707072  LUMO = 1.0246337702809
  mo_energy =
[-1.18319533e+02 -1.21035282e+01 -9.44895104e+00 -9.44895104e+00
 -9.44895104e+00 -1.23009961e+00 -5.59467554e-01 -5.59467554e-01
 -5.59467554e-01  1.02463377e+00  1.02463377e+00  1.02463377e+00
  7.33731438e+00  7.33731438e+00  7.33731438e+00  3.35150833e+01
  3.35150833e+01  3.35150833e+01  7.45153670e+01  1.29209896e+02
  1.29209896e+02  1.29209896e+02  4.83819964e+02  4.83819964e+02
  4.83819964e+02  5.57162771e+02  1.33609998e+03  1.33609998e+03
  1.33609998e+03  2.62699379e+03  3.03089058e+03  3.03089058e+03
  3.03089058e+03  6.65174985e+03  6.65174985e+03  6.65174985e+03
  9.03476055e+03  2.53923779e+04  7.61367915e+04]
E1 = -728.0365596063468  E_coul = 201.55911911488153
cycle= 1 E= -526.477440491465  delta_E= -0.715  |g|= 0.185  |ddm|= 0.37
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.546385
diis-c [-0.29853684  1.        ]
  HOMO = -0.575806446177405  LUMO = 1.01482359965961
  mo_energy =
[-1.18600431e+02 -1.22054648e+01 -9.55732204e+00 -9.55732204e+00
 -9.55732204e+00 -1.25411928e+00 -5.75806446e-01 -5.75806446e-01
 -5.75806446e-01  1.01482360e+00  1.01482360e+00  1.01482360e+00
  7.27907174e+00  7.27907174e+00  7.27907174e+00  3.33977640e+01
  3.33977640e+01  3.33977640e+01  7.43451233e+01  1.29015171e+02
  1.29015171e+02  1.29015171e+02  4.83544487e+02  4.83544487e+02
  4.83544487e+02  5.56846439e+02  1.33576524e+03  1.33576524e+03
  1.33576524e+03  2.62652305e+03  3.03048900e+03  3.03048900e+03
  3.03048900e+03  6.65123381e+03  6.65123381e+03  6.65123381e+03
  9.03416817e+03  2.53916909e+04  7.61360139e+04]
E1 = -728.3486853326683  E_coul = 201.87085019972832
cycle= 2 E= -526.47783513294  delta_E= -0.000395  |g|= 0.0251  |ddm|= 0.0215
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0488415
diis-c [-0.00152074  0.05119562  0.94880438]
  HOMO = -0.571848374821974  LUMO = 1.01785905251
  mo_energy =
[-1.18556268e+02 -1.21841228e+01 -9.53555895e+00 -9.53555895e+00
 -9.53555895e+00 -1.24886931e+00 -5.71848375e-01 -5.71848375e-01
 -5.71848375e-01  1.01785905e+00  1.01785905e+00  1.01785905e+00
  7.29078958e+00  7.29078958e+00  7.29078958e+00  3.34202700e+01
  3.34202700e+01  3.34202700e+01  7.43803806e+01  1.29049905e+02
  1.29049905e+02  1.29049905e+02  4.83588058e+02  4.83588058e+02
  4.83588058e+02  5.56892077e+02  1.33581199e+03  1.33581199e+03
  1.33581199e+03  2.62657206e+03  3.03053735e+03  3.03053735e+03
  3.03053735e+03  6.65128317e+03  6.65128317e+03  6.65128317e+03
  9.03421794e+03  2.53917409e+04  7.61360639e+04]
E1 = -728.2837366323024  E_coul = 201.80588711099108
cycle= 3 E= -526.477849521311  delta_E= -1.44e-05  |g|= 0.00307  |ddm|= 0.00549
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00660348
diis-c [-3.74063748e-07 -1.08360362e-03  1.12594873e-01  8.88488730e-01]
  HOMO = -0.572556006870739  LUMO = 1.0173316699097
  mo_energy =
[-1.18561699e+02 -1.21871019e+01 -9.53864484e+00 -9.53864484e+00
 -9.53864484e+00 -1.24978675e+00 -5.72556007e-01 -5.72556007e-01
 -5.72556007e-01  1.01733167e+00  1.01733167e+00  1.01733167e+00
  7.28894048e+00  7.28894048e+00  7.28894048e+00  3.34171305e+01
  3.34171305e+01  3.34171305e+01  7.43760135e+01  1.29045469e+02
  1.29045469e+02  1.29045469e+02  4.83582700e+02  4.83582700e+02
  4.83582700e+02  5.56886467e+02  1.33580625e+03  1.33580625e+03
  1.33580625e+03  2.62656591e+03  3.03053137e+03  3.03053137e+03
  3.03053137e+03  6.65127695e+03  6.65127695e+03  6.65127695e+03
  9.03421158e+03  2.53917344e+04  7.61360574e+04]
E1 = -728.2925606303993  E_coul = 201.81471078827445
cycle= 4 E= -526.477849842125  delta_E= -3.21e-07  |g|= 4.59e-05  |ddm|= 0.000803
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.33003e-05
diis-c [-1.93987136e-09  1.16910186e-06 -1.09963060e-03 -1.29754616e-03
  1.00239601e+00]
  HOMO = -0.572527137733074  LUMO = 1.01735268944859
  mo_energy =
[-1.18561598e+02 -1.21870086e+01 -9.53855244e+00 -9.53855244e+00
 -9.53855244e+00 -1.24974922e+00 -5.72527138e-01 -5.72527138e-01
 -5.72527138e-01  1.01735269e+00  1.01735269e+00  1.01735269e+00
  7.28900628e+00  7.28900628e+00  7.28900628e+00  3.34172197e+01
  3.34172197e+01  3.34172197e+01  7.43761171e+01  1.29045568e+02
  1.29045568e+02  1.29045568e+02  4.83582801e+02  4.83582801e+02
  4.83582801e+02  5.56886565e+02  1.33580635e+03  1.33580635e+03
  1.33580635e+03  2.62656600e+03  3.03053146e+03  3.03053146e+03
  3.03053146e+03  6.65127703e+03  6.65127703e+03  6.65127703e+03
  9.03421166e+03  2.53917345e+04  7.61360574e+04]
E1 = -728.2923350721555  E_coul = 201.81448522986614
cycle= 5 E= -526.477849842289  delta_E= -1.65e-10  |g|= 7.25e-06  |ddm|= 2.55e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.2923350721555  E_coul = 201.81448522986614
  HOMO = -0.572530944624217  LUMO = 1.01734990855359
  mo_energy =
[-1.18561616e+02 -1.21870217e+01 -9.53856581e+00 -9.53856581e+00
 -9.53856581e+00 -1.24975415e+00 -5.72530945e-01 -5.72530945e-01
 -5.72530945e-01  1.01734991e+00  1.01734991e+00  1.01734991e+00
  7.28899728e+00  7.28899728e+00  7.28899728e+00  3.34172066e+01
  3.34172066e+01  3.34172066e+01  7.43761011e+01  1.29045552e+02
  1.29045552e+02  1.29045552e+02  4.83582783e+02  4.83582783e+02
  4.83582783e+02  5.56886547e+02  1.33580633e+03  1.33580633e+03
  1.33580633e+03  2.62656598e+03  3.03053144e+03  3.03053144e+03
  3.03053144e+03  6.65127701e+03  6.65127701e+03  6.65127701e+03
  9.03421164e+03  2.53917345e+04  7.61360574e+04]
E1 = -728.2923700753871  E_coul = 201.81452023309473
Extra cycle  E= -526.477849842292  delta_E= -2.96e-12  |g|= 1.88e-06  |ddm|= 3.66e-06
    CPU time for scf_cycle      0.66 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 100514.89265854156
E1 = -728.2923700753871  E_coul = 201.81452023309473
init E= -526.477849842292
    CPU time for initialize scf      2.73 sec, wall time      0.26 sec
  HOMO = -0.572530280425993  LUMO = 1.01735039972697
  mo_energy =
[-1.18561612e+02 -1.21870191e+01 -9.53856317e+00 -9.53856317e+00
 -9.53856317e+00 -1.24975329e+00 -5.72530280e-01 -5.72530280e-01
 -5.72530280e-01  1.01735040e+00  1.01735040e+00  1.01735040e+00
  7.28899894e+00  7.28899894e+00  7.28899894e+00  3.34172092e+01
  3.34172092e+01  3.34172092e+01  7.43761046e+01  1.29045555e+02
  1.29045555e+02  1.29045555e+02  4.83582787e+02  4.83582787e+02
  4.83582787e+02  5.56886552e+02  1.33580634e+03  1.33580634e+03
  1.33580634e+03  2.62656599e+03  3.03053145e+03  3.03053145e+03
  3.03053145e+03  6.65127702e+03  6.65127702e+03  6.65127702e+03
  9.03421164e+03  2.53917345e+04  7.61360574e+04]
E1 = -728.2923628464051  E_coul = 201.81451300411118
cycle= 1 E= -526.477849842294  delta_E= -1.59e-12  |g|= 4.22e-07  |ddm|= 6.96e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2923628464051  E_coul = 201.81451300411118
  HOMO = -0.572530409582615  LUMO = 1.01735030375812
  mo_energy =
[-1.18561613e+02 -1.21870197e+01 -9.53856371e+00 -9.53856371e+00
 -9.53856371e+00 -1.24975346e+00 -5.72530410e-01 -5.72530410e-01
 -5.72530410e-01  1.01735030e+00  1.01735030e+00  1.01735030e+00
  7.28899861e+00  7.28899861e+00  7.28899861e+00  3.34172087e+01
  3.34172087e+01  3.34172087e+01  7.43761039e+01  1.29045554e+02
  1.29045554e+02  1.29045554e+02  4.83582787e+02  4.83582787e+02
  4.83582787e+02  5.56886551e+02  1.33580634e+03  1.33580634e+03
  1.33580634e+03  2.62656599e+03  3.03053145e+03  3.03053145e+03
  3.03053145e+03  6.65127702e+03  6.65127702e+03  6.65127702e+03
  9.03421164e+03  2.53917345e+04  7.61360574e+04]
E1 = -728.2923643623387  E_coul = 201.81451452004626
Extra cycle  E= -526.477849842292  delta_E= 1.48e-12  |g|= 9.14e-08  |ddm|= 1.42e-07
    CPU time for scf_cycle      2.87 sec, wall time      0.40 sec
exp = [2.61826434e+04 7.61755303e+03 3.61734816e+03 1.59852451e+03
 3.81686667e+02 1.07722064e+02 3.46827296e+01 4.58474150e+00
 3.95119285e-01 1.36277966e+03 6.64783237e+02 3.01141332e+02
 3.14197756e+02 6.16676248e+01 7.32956163e+00 2.02485338e+01
 7.71869077e-01 2.81453998e+00 2.22266461e-01]
grad_E = [-1.51771263e-06  3.36983795e-06 -1.39382777e-06  7.09267627e-05
  1.02873348e-05  6.04370663e-06 -1.87992763e-05 -2.57183256e-05
 -3.06982590e-05 -5.08347700e-07  4.97844563e-06  2.34423717e-05
  2.02189007e-05 -1.11604653e-05 -2.37442802e-05  6.23574156e-07
  5.29653361e-05  2.83611874e-05 -2.62781816e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:46:22 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6434499        1
[INPUT] 0    0    [1    /1   ]  7617.55285133        1
[INPUT] 0    0    [1    /1   ]  3617.34794866        1
[INPUT] 0    0    [1    /1   ]  1598.51944969        1
[INPUT] 0    0    [1    /1   ]  381.720240415        1
[INPUT] 0    0    [1    /1   ]  107.73749748         1
[INPUT] 0    0    [1    /1   ]  34.6885548374        1
[INPUT] 0    0    [1    /1   ]  4.58478081819        1
[INPUT] 0    0    [1    /1   ]  0.395120923075       1
[INPUT] 1    0    [1    /1   ]  1362.7796604         1
[INPUT] 1    0    [1    /1   ]  664.783135562        1
[INPUT] 1    0    [1    /1   ]  301.140783145        1
[INPUT] 1    0    [1    /1   ]  314.197264175        1
[INPUT] 1    0    [1    /1   ]  61.6691167602        1
[INPUT] 1    0    [1    /1   ]  7.33027404273        1
[INPUT] 1    0    [1    /1   ]  20.2497853197        1
[INPUT] 1    0    [1    /1   ]  0.771914164506       1
[INPUT] 1    0    [1    /1   ]  2.81473923749        1
[INPUT] 1    0    [1    /1   ]  0.222286169691       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.643449943833, 1.0]], [0, [7617.552851325008, 1.0]], [0, [3617.3479486551287, 1.0]], [0, [1598.519449694881, 1.0]], [0, [381.7202404145532, 1.0]], [0, [107.73749748026574, 1.0]], [0, [34.688554837372614, 1.0]], [0, [4.584780818194337, 1.0]], [0, [0.39512092307483054, 1.0]], [1, [1362.7796604023865, 1.0]], [1, [664.7831355623878, 1.0]], [1, [301.1407831450638, 1.0]], [1, [314.1972641754867, 1.0]], [1, [61.66911676022609, 1.0]], [1, [7.3302740427325475, 1.0]], [1, [20.249785319729845, 1.0]], [1, [0.7719141645058758, 1.0]], [1, [2.8147392374851754, 1.0]], [1, [0.22228616969131346, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.64344994]
bas 1, expnt(s) = [7617.55285133]
bas 2, expnt(s) = [3617.34794866]
bas 3, expnt(s) = [1598.51944969]
bas 4, expnt(s) = [381.72024041]
bas 5, expnt(s) = [107.73749748]
bas 6, expnt(s) = [34.68855484]
bas 7, expnt(s) = [4.58478082]
bas 8, expnt(s) = [0.39512092]
bas 9, expnt(s) = [1362.7796604]
bas 10, expnt(s) = [664.78313556]
bas 11, expnt(s) = [301.14078315]
bas 12, expnt(s) = [314.19726418]
bas 13, expnt(s) = [61.66911676]
bas 14, expnt(s) = [7.33027404]
bas 15, expnt(s) = [20.24978532]
bas 16, expnt(s) = [0.77191416]
bas 17, expnt(s) = [2.81473924]
bas 18, expnt(s) = [0.22228617]
CPU time:       853.65
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826434e+04 5.20026102e+03 7.61755285e+03 2.06004464e+03
 3.61734795e+03 1.17844071e+03 1.59851945e+03 6.38709635e+02
 3.81720240e+02 2.18184511e+02 1.07737497e+02 8.44870579e+01
 3.46885548e+01 3.61122609e+01 4.58478082e+00 7.91596669e+00
 3.95120923e-01 1.25910673e+00 1.36277966e+03 2.41555231e+04
 6.64783136e+02 9.84769036e+03 3.01140783e+02 3.65970738e+03
 3.14197264e+02 3.85911208e+03 6.16691168e+01 5.04160775e+02
 7.33027404e+00 3.51871957e+01 2.02497853e+01 1.25316980e+02
 7.71914165e-01 2.11079305e+00 2.81473924e+00 1.06360924e+01
 2.22286170e-01 4.45271548e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.9769192624767
cond(S) = 100518.49647703802
E1 = -728.8834114734645  E_coul = 203.1211646054736
init E= -525.762246867991
    CPU time for initialize scf      0.46 sec, wall time      0.05 sec
  HOMO = -0.559465959367906  LUMO = 1.02474973210115
  mo_energy =
[-1.18319518e+02 -1.21035325e+01 -9.44894536e+00 -9.44894536e+00
 -9.44894536e+00 -1.23010029e+00 -5.59465959e-01 -5.59465959e-01
 -5.59465959e-01  1.02474973e+00  1.02474973e+00  1.02474973e+00
  7.33810246e+00  7.33810246e+00  7.33810246e+00  3.35185163e+01
  3.35185163e+01  3.35185163e+01  7.45330098e+01  1.29218021e+02
  1.29218021e+02  1.29218021e+02  4.83830753e+02  4.83830753e+02
  4.83830753e+02  5.57247095e+02  1.33610995e+03  1.33610995e+03
  1.33610995e+03  2.62715722e+03  3.03089879e+03  3.03089879e+03
  3.03089879e+03  6.65175631e+03  6.65175631e+03  6.65175631e+03
  9.03494298e+03  2.53925557e+04  7.61369575e+04]
E1 = -728.0369401655161  E_coul = 201.55949943870525
cycle= 1 E= -526.477440726811  delta_E= -0.715  |g|= 0.185  |ddm|= 0.37
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.546343
diis-c [-0.29849065  1.        ]
  HOMO = -0.575796752664544  LUMO = 1.01494433463628
  mo_energy =
[-1.18600377e+02 -1.22054510e+01 -9.55729376e+00 -9.55729376e+00
 -9.55729376e+00 -1.25411092e+00 -5.75796753e-01 -5.75796753e-01
 -5.75796753e-01  1.01494433e+00  1.01494433e+00  1.01494433e+00
  7.27987179e+00  7.27987179e+00  7.27987179e+00  3.34012168e+01
  3.34012168e+01  3.34012168e+01  7.43627814e+01  1.29023326e+02
  1.29023326e+02  1.29023326e+02  4.83555319e+02  4.83555319e+02
  4.83555319e+02  5.56930802e+02  1.33577527e+03  1.33577527e+03
  1.33577527e+03  2.62668654e+03  3.03049726e+03  3.03049726e+03
  3.03049726e+03  6.65124034e+03  6.65124034e+03  6.65124034e+03
  9.03435066e+03  2.53918687e+04  7.61361800e+04]
E1 = -728.3489749041513  E_coul = 201.87113971633948
cycle= 2 E= -526.477835187812  delta_E= -0.000394  |g|= 0.0251  |ddm|= 0.0215
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0488303
diis-c [-0.00152029  0.0511811   0.9488189 ]
  HOMO = -0.571840019861573  LUMO = 1.01797907942105
  mo_energy =
[-1.18556225e+02 -1.21841151e+01 -9.53553681e+00 -9.53553681e+00
 -9.53553681e+00 -1.24886270e+00 -5.71840020e-01 -5.71840020e-01
 -5.71840020e-01  1.01797908e+00  1.01797908e+00  1.01797908e+00
  7.29158678e+00  7.29158678e+00  7.29158678e+00  3.34237174e+01
  3.34237174e+01  3.34237174e+01  7.43980319e+01  1.29058052e+02
  1.29058052e+02  1.29058052e+02  4.83598879e+02  4.83598879e+02
  4.83598879e+02  5.56976429e+02  1.33582200e+03  1.33582200e+03
  1.33582200e+03  2.62673553e+03  3.03054560e+03  3.03054560e+03
  3.03054560e+03  6.65128968e+03  6.65128968e+03  6.65128968e+03
  9.03440042e+03  2.53919187e+04  7.61362299e+04]
E1 = -728.2840464781598  E_coul = 201.8061969104276
cycle= 3 E= -526.477849567732  delta_E= -1.44e-05  |g|= 0.00307  |ddm|= 0.00548
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00660217
diis-c [-3.73767513e-07 -1.08336413e-03  1.12599673e-01  8.88483691e-01]
  HOMO = -0.57254745374482  LUMO = 1.01745179339235
  mo_energy =
[-1.18561655e+02 -1.21870935e+01 -9.53862203e+00 -9.53862203e+00
 -9.53862203e+00 -1.24977989e+00 -5.72547454e-01 -5.72547454e-01
 -5.72547454e-01  1.01745179e+00  1.01745179e+00  1.01745179e+00
  7.28973803e+00  7.28973803e+00  7.28973803e+00  3.34205785e+01
  3.34205785e+01  3.34205785e+01  7.43936654e+01  1.29053616e+02
  1.29053616e+02  1.29053616e+02  4.83593523e+02  4.83593523e+02
  4.83593523e+02  5.56970821e+02  1.33581627e+03  1.33581627e+03
  1.33581627e+03  2.62672939e+03  3.03053962e+03  3.03053962e+03
  3.03053962e+03  6.65128346e+03  6.65128346e+03  6.65128346e+03
  9.03439406e+03  2.53919122e+04  7.61362234e+04]
E1 = -728.2928681801475  E_coul = 201.81501829175562
cycle= 4 E= -526.477849888392  delta_E= -3.21e-07  |g|= 4.59e-05  |ddm|= 0.000803
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.32991e-05
diis-c [-1.93855455e-09  1.16189619e-06 -1.09815767e-03 -1.28271846e-03
  1.00237971e+00]
  HOMO = -0.572518590636476  LUMO = 1.01747281049062
  mo_energy =
[-1.18561554e+02 -1.21870002e+01 -9.53852965e+00 -9.53852965e+00
 -9.53852965e+00 -1.24974238e+00 -5.72518591e-01 -5.72518591e-01
 -5.72518591e-01  1.01747281e+00  1.01747281e+00  1.01747281e+00
  7.28980382e+00  7.28980382e+00  7.28980382e+00  3.34206677e+01
  3.34206677e+01  3.34206677e+01  7.43937690e+01  1.29053715e+02
  1.29053715e+02  1.29053715e+02  4.83593623e+02  4.83593623e+02
  4.83593623e+02  5.56970919e+02  1.33581636e+03  1.33581636e+03
  1.33581636e+03  2.62672948e+03  3.03053971e+03  3.03053971e+03
  3.03053971e+03  6.65128355e+03  6.65128355e+03  6.65128355e+03
  9.03439414e+03  2.53919123e+04  7.61362235e+04]
E1 = -728.2926426751181  E_coul = 201.81479278656235
cycle= 5 E= -526.477849888556  delta_E= -1.64e-10  |g|= 7.25e-06  |ddm|= 2.55e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.2926426751181  E_coul = 201.81479278656235
  HOMO = -0.572522395603677  LUMO = 1.01747003075327
  mo_energy =
[-1.18561572e+02 -1.21870133e+01 -9.53854301e+00 -9.53854301e+00
 -9.53854301e+00 -1.24974730e+00 -5.72522396e-01 -5.72522396e-01
 -5.72522396e-01  1.01747003e+00  1.01747003e+00  1.01747003e+00
  7.28979482e+00  7.28979482e+00  7.28979482e+00  3.34206545e+01
  3.34206545e+01  3.34206545e+01  7.43937530e+01  1.29053699e+02
  1.29053699e+02  1.29053699e+02  4.83593605e+02  4.83593605e+02
  4.83593605e+02  5.56970901e+02  1.33581635e+03  1.33581635e+03
  1.33581635e+03  2.62672946e+03  3.03053969e+03  3.03053969e+03
  3.03053969e+03  6.65128353e+03  6.65128353e+03  6.65128353e+03
  9.03439413e+03  2.53919123e+04  7.61362235e+04]
E1 = -728.2926776600655  E_coul = 201.81482777150546
Extra cycle  E= -526.47784988856  delta_E= -4.32e-12  |g|= 1.88e-06  |ddm|= 3.66e-06
    CPU time for scf_cycle      0.69 sec, wall time      0.29 sec
exp = [2.61826434e+04 7.61755285e+03 3.61734795e+03 1.59851945e+03
 3.81720240e+02 1.07737497e+02 3.46885548e+01 4.58478082e+00
 3.95120923e-01 1.36277966e+03 6.64783136e+02 3.01140783e+02
 3.14197264e+02 6.16691168e+01 7.33027404e+00 2.02497853e+01
 7.71914165e-01 2.81473924e+00 2.22286170e-01]
E = -526.4778498885601
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:46:23 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6434499        1
[INPUT] 0    0    [1    /1   ]  7617.55285133        1
[INPUT] 0    0    [1    /1   ]  3617.34794866        1
[INPUT] 0    0    [1    /1   ]  1598.51944969        1
[INPUT] 0    0    [1    /1   ]  381.720240415        1
[INPUT] 0    0    [1    /1   ]  107.73749748         1
[INPUT] 0    0    [1    /1   ]  34.6885548374        1
[INPUT] 0    0    [1    /1   ]  4.58478081819        1
[INPUT] 0    0    [1    /1   ]  0.395120923075       1
[INPUT] 1    0    [1    /1   ]  1362.7796604         1
[INPUT] 1    0    [1    /1   ]  664.783135562        1
[INPUT] 1    0    [1    /1   ]  301.140783145        1
[INPUT] 1    0    [1    /1   ]  314.197264175        1
[INPUT] 1    0    [1    /1   ]  61.6691167602        1
[INPUT] 1    0    [1    /1   ]  7.33027404273        1
[INPUT] 1    0    [1    /1   ]  20.2497853197        1
[INPUT] 1    0    [1    /1   ]  0.771914164506       1
[INPUT] 1    0    [1    /1   ]  2.81473923749        1
[INPUT] 1    0    [1    /1   ]  0.222286169691       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.643449943833, 1.0]], [0, [7617.552851325008, 1.0]], [0, [3617.3479486551287, 1.0]], [0, [1598.519449694881, 1.0]], [0, [381.7202404145532, 1.0]], [0, [107.73749748026574, 1.0]], [0, [34.688554837372614, 1.0]], [0, [4.584780818194337, 1.0]], [0, [0.39512092307483054, 1.0]], [1, [1362.7796604023865, 1.0]], [1, [664.7831355623878, 1.0]], [1, [301.1407831450638, 1.0]], [1, [314.1972641754867, 1.0]], [1, [61.66911676022609, 1.0]], [1, [7.3302740427325475, 1.0]], [1, [20.249785319729845, 1.0]], [1, [0.7719141645058758, 1.0]], [1, [2.8147392374851754, 1.0]], [1, [0.22228616969131346, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.64344994]
bas 1, expnt(s) = [7617.55285133]
bas 2, expnt(s) = [3617.34794866]
bas 3, expnt(s) = [1598.51944969]
bas 4, expnt(s) = [381.72024041]
bas 5, expnt(s) = [107.73749748]
bas 6, expnt(s) = [34.68855484]
bas 7, expnt(s) = [4.58478082]
bas 8, expnt(s) = [0.39512092]
bas 9, expnt(s) = [1362.7796604]
bas 10, expnt(s) = [664.78313556]
bas 11, expnt(s) = [301.14078315]
bas 12, expnt(s) = [314.19726418]
bas 13, expnt(s) = [61.66911676]
bas 14, expnt(s) = [7.33027404]
bas 15, expnt(s) = [20.24978532]
bas 16, expnt(s) = [0.77191416]
bas 17, expnt(s) = [2.81473924]
bas 18, expnt(s) = [0.22228617]
CPU time:       854.66
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826434e+04 5.20026102e+03 7.61755285e+03 2.06004464e+03
 3.61734795e+03 1.17844071e+03 1.59851945e+03 6.38709635e+02
 3.81720240e+02 2.18184511e+02 1.07737497e+02 8.44870579e+01
 3.46885548e+01 3.61122609e+01 4.58478082e+00 7.91596669e+00
 3.95120923e-01 1.25910673e+00 1.36277966e+03 2.41555231e+04
 6.64783136e+02 9.84769036e+03 3.01140783e+02 3.65970738e+03
 3.14197264e+02 3.85911208e+03 6.16691168e+01 5.04160775e+02
 7.33027404e+00 3.51871957e+01 2.02497853e+01 1.25316980e+02
 7.71914165e-01 2.11079305e+00 2.81473924e+00 1.06360924e+01
 2.22286170e-01 4.45271548e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.9769192624767
cond(S) = 100518.49647703802
E1 = -728.8834114734645  E_coul = 203.1211646054736
init E= -525.762246867991
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559465959367906  LUMO = 1.02474973210115
  mo_energy =
[-1.18319518e+02 -1.21035325e+01 -9.44894536e+00 -9.44894536e+00
 -9.44894536e+00 -1.23010029e+00 -5.59465959e-01 -5.59465959e-01
 -5.59465959e-01  1.02474973e+00  1.02474973e+00  1.02474973e+00
  7.33810246e+00  7.33810246e+00  7.33810246e+00  3.35185163e+01
  3.35185163e+01  3.35185163e+01  7.45330098e+01  1.29218021e+02
  1.29218021e+02  1.29218021e+02  4.83830753e+02  4.83830753e+02
  4.83830753e+02  5.57247095e+02  1.33610995e+03  1.33610995e+03
  1.33610995e+03  2.62715722e+03  3.03089879e+03  3.03089879e+03
  3.03089879e+03  6.65175631e+03  6.65175631e+03  6.65175631e+03
  9.03494298e+03  2.53925557e+04  7.61369575e+04]
E1 = -728.0369401655161  E_coul = 201.55949943870525
cycle= 1 E= -526.477440726811  delta_E= -0.715  |g|= 0.185  |ddm|= 0.37
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.546343
diis-c [-0.29849065  1.        ]
  HOMO = -0.575796752664544  LUMO = 1.01494433463628
  mo_energy =
[-1.18600377e+02 -1.22054510e+01 -9.55729376e+00 -9.55729376e+00
 -9.55729376e+00 -1.25411092e+00 -5.75796753e-01 -5.75796753e-01
 -5.75796753e-01  1.01494433e+00  1.01494433e+00  1.01494433e+00
  7.27987179e+00  7.27987179e+00  7.27987179e+00  3.34012168e+01
  3.34012168e+01  3.34012168e+01  7.43627814e+01  1.29023326e+02
  1.29023326e+02  1.29023326e+02  4.83555319e+02  4.83555319e+02
  4.83555319e+02  5.56930802e+02  1.33577527e+03  1.33577527e+03
  1.33577527e+03  2.62668654e+03  3.03049726e+03  3.03049726e+03
  3.03049726e+03  6.65124034e+03  6.65124034e+03  6.65124034e+03
  9.03435066e+03  2.53918687e+04  7.61361800e+04]
E1 = -728.3489749041513  E_coul = 201.87113971633948
cycle= 2 E= -526.477835187812  delta_E= -0.000394  |g|= 0.0251  |ddm|= 0.0215
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0488303
diis-c [-0.00152029  0.0511811   0.9488189 ]
  HOMO = -0.571840019861573  LUMO = 1.01797907942105
  mo_energy =
[-1.18556225e+02 -1.21841151e+01 -9.53553681e+00 -9.53553681e+00
 -9.53553681e+00 -1.24886270e+00 -5.71840020e-01 -5.71840020e-01
 -5.71840020e-01  1.01797908e+00  1.01797908e+00  1.01797908e+00
  7.29158678e+00  7.29158678e+00  7.29158678e+00  3.34237174e+01
  3.34237174e+01  3.34237174e+01  7.43980319e+01  1.29058052e+02
  1.29058052e+02  1.29058052e+02  4.83598879e+02  4.83598879e+02
  4.83598879e+02  5.56976429e+02  1.33582200e+03  1.33582200e+03
  1.33582200e+03  2.62673553e+03  3.03054560e+03  3.03054560e+03
  3.03054560e+03  6.65128968e+03  6.65128968e+03  6.65128968e+03
  9.03440042e+03  2.53919187e+04  7.61362299e+04]
E1 = -728.2840464781598  E_coul = 201.8061969104276
cycle= 3 E= -526.477849567732  delta_E= -1.44e-05  |g|= 0.00307  |ddm|= 0.00548
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00660217
diis-c [-3.73767513e-07 -1.08336413e-03  1.12599673e-01  8.88483691e-01]
  HOMO = -0.57254745374482  LUMO = 1.01745179339235
  mo_energy =
[-1.18561655e+02 -1.21870935e+01 -9.53862203e+00 -9.53862203e+00
 -9.53862203e+00 -1.24977989e+00 -5.72547454e-01 -5.72547454e-01
 -5.72547454e-01  1.01745179e+00  1.01745179e+00  1.01745179e+00
  7.28973803e+00  7.28973803e+00  7.28973803e+00  3.34205785e+01
  3.34205785e+01  3.34205785e+01  7.43936654e+01  1.29053616e+02
  1.29053616e+02  1.29053616e+02  4.83593523e+02  4.83593523e+02
  4.83593523e+02  5.56970821e+02  1.33581627e+03  1.33581627e+03
  1.33581627e+03  2.62672939e+03  3.03053962e+03  3.03053962e+03
  3.03053962e+03  6.65128346e+03  6.65128346e+03  6.65128346e+03
  9.03439406e+03  2.53919122e+04  7.61362234e+04]
E1 = -728.2928681801475  E_coul = 201.81501829175562
cycle= 4 E= -526.477849888392  delta_E= -3.21e-07  |g|= 4.59e-05  |ddm|= 0.000803
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=6.32991e-05
diis-c [-1.93855455e-09  1.16189619e-06 -1.09815767e-03 -1.28271846e-03
  1.00237971e+00]
  HOMO = -0.572518590636476  LUMO = 1.01747281049062
  mo_energy =
[-1.18561554e+02 -1.21870002e+01 -9.53852965e+00 -9.53852965e+00
 -9.53852965e+00 -1.24974238e+00 -5.72518591e-01 -5.72518591e-01
 -5.72518591e-01  1.01747281e+00  1.01747281e+00  1.01747281e+00
  7.28980382e+00  7.28980382e+00  7.28980382e+00  3.34206677e+01
  3.34206677e+01  3.34206677e+01  7.43937690e+01  1.29053715e+02
  1.29053715e+02  1.29053715e+02  4.83593623e+02  4.83593623e+02
  4.83593623e+02  5.56970919e+02  1.33581636e+03  1.33581636e+03
  1.33581636e+03  2.62672948e+03  3.03053971e+03  3.03053971e+03
  3.03053971e+03  6.65128355e+03  6.65128355e+03  6.65128355e+03
  9.03439414e+03  2.53919123e+04  7.61362235e+04]
E1 = -728.2926426751181  E_coul = 201.81479278656235
cycle= 5 E= -526.477849888556  delta_E= -1.64e-10  |g|= 7.25e-06  |ddm|= 2.55e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.2926426751181  E_coul = 201.81479278656235
  HOMO = -0.572522395603677  LUMO = 1.01747003075327
  mo_energy =
[-1.18561572e+02 -1.21870133e+01 -9.53854301e+00 -9.53854301e+00
 -9.53854301e+00 -1.24974730e+00 -5.72522396e-01 -5.72522396e-01
 -5.72522396e-01  1.01747003e+00  1.01747003e+00  1.01747003e+00
  7.28979482e+00  7.28979482e+00  7.28979482e+00  3.34206545e+01
  3.34206545e+01  3.34206545e+01  7.43937530e+01  1.29053699e+02
  1.29053699e+02  1.29053699e+02  4.83593605e+02  4.83593605e+02
  4.83593605e+02  5.56970901e+02  1.33581635e+03  1.33581635e+03
  1.33581635e+03  2.62672946e+03  3.03053969e+03  3.03053969e+03
  3.03053969e+03  6.65128353e+03  6.65128353e+03  6.65128353e+03
  9.03439413e+03  2.53919123e+04  7.61362235e+04]
E1 = -728.2926776600655  E_coul = 201.81482777150546
Extra cycle  E= -526.47784988856  delta_E= -4.32e-12  |g|= 1.88e-06  |ddm|= 3.66e-06
    CPU time for scf_cycle      0.66 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 100518.49647703802
E1 = -728.2926776600655  E_coul = 201.81482777150546
init E= -526.47784988856
    CPU time for initialize scf      2.76 sec, wall time      0.25 sec
  HOMO = -0.572521731771468  LUMO = 1.01747052170189
  mo_energy =
[-1.18561568e+02 -1.21870107e+01 -9.53854037e+00 -9.53854037e+00
 -9.53854037e+00 -1.24974644e+00 -5.72521732e-01 -5.72521732e-01
 -5.72521732e-01  1.01747052e+00  1.01747052e+00  1.01747052e+00
  7.28979648e+00  7.28979648e+00  7.28979648e+00  3.34206572e+01
  3.34206572e+01  3.34206572e+01  7.43937565e+01  1.29053703e+02
  1.29053703e+02  1.29053703e+02  4.83593610e+02  4.83593610e+02
  4.83593610e+02  5.56970905e+02  1.33581635e+03  1.33581635e+03
  1.33581635e+03  2.62672946e+03  3.03053970e+03  3.03053970e+03
  3.03053970e+03  6.65128353e+03  6.65128353e+03  6.65128353e+03
  9.03439413e+03  2.53919123e+04  7.61362235e+04]
E1 = -728.2926704352096  E_coul = 201.81482054664846
cycle= 1 E= -526.477849888561  delta_E= -1.14e-12  |g|= 4.22e-07  |ddm|= 6.96e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2926704352096  E_coul = 201.81482054664846
  HOMO = -0.572521860849729  LUMO = 1.01747042578256
  mo_energy =
[-1.18561568e+02 -1.21870113e+01 -9.53854091e+00 -9.53854091e+00
 -9.53854091e+00 -1.24974661e+00 -5.72521861e-01 -5.72521861e-01
 -5.72521861e-01  1.01747043e+00  1.01747043e+00  1.01747043e+00
  7.28979615e+00  7.28979615e+00  7.28979615e+00  3.34206566e+01
  3.34206566e+01  3.34206566e+01  7.43937557e+01  1.29053702e+02
  1.29053702e+02  1.29053702e+02  4.83593609e+02  4.83593609e+02
  4.83593609e+02  5.56970904e+02  1.33581635e+03  1.33581635e+03
  1.33581635e+03  2.62672946e+03  3.03053970e+03  3.03053970e+03
  3.03053970e+03  6.65128353e+03  6.65128353e+03  6.65128353e+03
  9.03439413e+03  2.53919123e+04  7.61362235e+04]
E1 = -728.2926719502087  E_coul = 201.814822061649
Extra cycle  E= -526.47784988856  delta_E= 1.48e-12  |g|= 9.14e-08  |ddm|= 1.42e-07
    CPU time for scf_cycle      2.90 sec, wall time      0.39 sec
exp = [2.61826434e+04 7.61755285e+03 3.61734795e+03 1.59851945e+03
 3.81720240e+02 1.07737497e+02 3.46885548e+01 4.58478082e+00
 3.95120923e-01 1.36277966e+03 6.64783136e+02 3.01140783e+02
 3.14197264e+02 6.16691168e+01 7.33027404e+00 2.02497853e+01
 7.71914165e-01 2.81473924e+00 2.22286170e-01]
grad_E = [-1.51758551e-06  3.36840634e-06 -1.39495571e-06  7.08831003e-05
  1.05484244e-05  2.62454980e-06  3.75369496e-07  1.90661079e-06
 -1.31082052e-05 -5.08394430e-07  4.97789479e-06  2.34394435e-05
  2.02163120e-05 -1.10886241e-05 -4.60560998e-06 -3.16912648e-06
  4.38532075e-06  6.37538079e-06 -1.45475923e-05]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:46:27 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6434585        1
[INPUT] 0    0    [1    /1   ]  7617.55281834        1
[INPUT] 0    0    [1    /1   ]  3617.34792091        1
[INPUT] 0    0    [1    /1   ]  1598.51857834        1
[INPUT] 0    0    [1    /1   ]  381.725213422        1
[INPUT] 0    0    [1    /1   ]  107.739334332        1
[INPUT] 0    0    [1    /1   ]  34.6891738705        1
[INPUT] 0    0    [1    /1   ]  4.58478303819        1
[INPUT] 0    0    [1    /1   ]  0.395121580949       1
[INPUT] 1    0    [1    /1   ]  1362.77966092        1
[INPUT] 1    0    [1    /1   ]  664.78311601         1
[INPUT] 1    0    [1    /1   ]  301.140680643        1
[INPUT] 1    0    [1    /1   ]  314.197172856        1
[INPUT] 1    0    [1    /1   ]  61.6690266336        1
[INPUT] 1    0    [1    /1   ]  7.33027986392        1
[INPUT] 1    0    [1    /1   ]  20.2497746575        1
[INPUT] 1    0    [1    /1   ]  0.771914846717       1
[INPUT] 1    0    [1    /1   ]  2.81471343757        1
[INPUT] 1    0    [1    /1   ]  0.222287817111       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.643458479557, 1.0]], [0, [7617.552818340005, 1.0]], [0, [3617.3479209067323, 1.0]], [0, [1598.5185783408554, 1.0]], [0, [381.72521342156676, 1.0]], [0, [107.73933433229563, 1.0]], [0, [34.68917387052355, 1.0]], [0, [4.584783038189404, 1.0]], [0, [0.3951215809492585, 1.0]], [1, [1362.7796609215152, 1.0]], [1, [664.7831160096351, 1.0]], [1, [301.14068064288915, 1.0]], [1, [314.19717285646374, 1.0]], [1, [61.669026633568095, 1.0]], [1, [7.330279863919227, 1.0]], [1, [20.249774657539344, 1.0]], [1, [0.7719148467170306, 1.0]], [1, [2.814713437568223, 1.0]], [1, [0.22228781711080303, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.64345848]
bas 1, expnt(s) = [7617.55281834]
bas 2, expnt(s) = [3617.34792091]
bas 3, expnt(s) = [1598.51857834]
bas 4, expnt(s) = [381.72521342]
bas 5, expnt(s) = [107.73933433]
bas 6, expnt(s) = [34.68917387]
bas 7, expnt(s) = [4.58478304]
bas 8, expnt(s) = [0.39512158]
bas 9, expnt(s) = [1362.77966092]
bas 10, expnt(s) = [664.78311601]
bas 11, expnt(s) = [301.14068064]
bas 12, expnt(s) = [314.19717286]
bas 13, expnt(s) = [61.66902663]
bas 14, expnt(s) = [7.33027986]
bas 15, expnt(s) = [20.24977466]
bas 16, expnt(s) = [0.77191485]
bas 17, expnt(s) = [2.81471344]
bas 18, expnt(s) = [0.22228782]
CPU time:       863.03
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826435e+04 5.20026102e+03 7.61755282e+03 2.06004463e+03
 3.61734792e+03 1.17844071e+03 1.59851858e+03 6.38709374e+02
 3.81725213e+02 2.18186642e+02 1.07739334e+02 8.44881382e+01
 3.46891739e+01 3.61127442e+01 4.58478304e+00 7.91596957e+00
 3.95121581e-01 1.25910830e+00 1.36277966e+03 2.41555231e+04
 6.64783116e+02 9.84769000e+03 3.01140681e+02 3.65970582e+03
 3.14197173e+02 3.85911067e+03 6.16690266e+01 5.04159854e+02
 7.33027986e+00 3.51872306e+01 2.02497747e+01 1.25316898e+02
 7.71914847e-01 2.11079538e+00 2.81471344e+00 1.06359705e+01
 2.22287817e-01 4.45275673e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.976918974790213
cond(S) = 100518.26407811345
E1 = -728.8834180467281  E_coul = 203.1211754670096
init E= -525.762242579719
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559465622288017  LUMO = 1.02475656878513
  mo_energy =
[-1.18319517e+02 -1.21035325e+01 -9.44894446e+00 -9.44894446e+00
 -9.44894446e+00 -1.23010013e+00 -5.59465622e-01 -5.59465622e-01
 -5.59465622e-01  1.02475657e+00  1.02475657e+00  1.02475657e+00
  7.33807015e+00  7.33807015e+00  7.33807015e+00  3.35184392e+01
  3.35184392e+01  3.35184392e+01  7.45349548e+01  1.29217845e+02
  1.29217845e+02  1.29217845e+02  4.83830347e+02  4.83830347e+02
  4.83830347e+02  5.57257517e+02  1.33610930e+03  1.33610930e+03
  1.33610930e+03  2.62717883e+03  3.03089786e+03  3.03089786e+03
  3.03089786e+03  6.65175522e+03  6.65175522e+03  6.65175522e+03
  9.03496729e+03  2.53925792e+04  7.61369794e+04]
E1 = -728.0369835216982  E_coul = 201.55954276940446
cycle= 1 E= -526.477440752294  delta_E= -0.715  |g|= 0.185  |ddm|= 0.37
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.546339
diis-c [-0.29848589  1.        ]
  HOMO = -0.575795446673848  LUMO = 1.01495187134071
  mo_energy =
[-1.18600372e+02 -1.22054491e+01 -9.55729057e+00 -9.55729057e+00
 -9.55729057e+00 -1.25410970e+00 -5.75795447e-01 -5.75795447e-01
 -5.75795447e-01  1.01495187e+00  1.01495187e+00  1.01495187e+00
  7.27984144e+00  7.27984144e+00  7.27984144e+00  3.34011421e+01
  3.34011421e+01  3.34011421e+01  7.43647277e+01  1.29023153e+02
  1.29023153e+02  1.29023153e+02  4.83554917e+02  4.83554917e+02
  4.83554917e+02  5.56941227e+02  1.33577461e+03  1.33577461e+03
  1.33577461e+03  2.62670816e+03  3.03049634e+03  3.03049634e+03
  3.03049634e+03  6.65123926e+03  6.65123926e+03  6.65123926e+03
  9.03437498e+03  2.53918923e+04  7.61362019e+04]
E1 = -728.3490091755041  E_coul = 201.87117397948458
cycle= 2 E= -526.477835196019  delta_E= -0.000394  |g|= 0.0251  |ddm|= 0.0215
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0488291
diis-c [-0.00152024  0.05117964  0.94882036]
  HOMO = -0.571838852283669  LUMO = 1.01798651993005
  mo_energy =
[-1.18556221e+02 -1.21841138e+01 -9.53553423e+00 -9.53553423e+00
 -9.53553423e+00 -1.24886166e+00 -5.71838852e-01 -5.71838852e-01
 -5.71838852e-01  1.01798652e+00  1.01798652e+00  1.01798652e+00
  7.29155602e+00  7.29155602e+00  7.29155602e+00  3.34236421e+01
  3.34236421e+01  3.34236421e+01  7.43999775e+01  1.29057878e+02
  1.29057878e+02  1.29057878e+02  4.83598477e+02  4.83598477e+02
  4.83598477e+02  5.56986853e+02  1.33582135e+03  1.33582135e+03
  1.33582135e+03  2.62675714e+03  3.03054467e+03  3.03054467e+03
  3.03054467e+03  6.65128860e+03  6.65128860e+03  6.65128860e+03
  9.03442474e+03  2.53919423e+04  7.61362519e+04]
E1 = -728.2840827480054  E_coul = 201.8062331728938
cycle= 3 E= -526.477849575112  delta_E= -1.44e-05  |g|= 0.00307  |ddm|= 0.00548
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00660204
diis-c [-3.73740106e-07 -1.08334288e-03  1.12600127e-01  8.88483216e-01]
  HOMO = -0.572546266387423  LUMO = 1.01745924718721
  mo_energy =
[-1.18561651e+02 -1.21870922e+01 -9.53861939e+00 -9.53861939e+00
 -9.53861939e+00 -1.24977882e+00 -5.72546266e-01 -5.72546266e-01
 -5.72546266e-01  1.01745925e+00  1.01745925e+00  1.01745925e+00
  7.28970732e+00  7.28970732e+00  7.28970732e+00  3.34205033e+01
  3.34205033e+01  3.34205033e+01  7.43956111e+01  1.29053442e+02
  1.29053442e+02  1.29053442e+02  4.83593120e+02  4.83593120e+02
  4.83593120e+02  5.56981245e+02  1.33581561e+03  1.33581561e+03
  1.33581561e+03  2.62675100e+03  3.03053869e+03  3.03053869e+03
  3.03053869e+03  6.65128238e+03  6.65128238e+03  6.65128238e+03
  9.03441838e+03  2.53919358e+04  7.61362453e+04]
E1 = -728.2929042247724  E_coul = 201.81505432901585
cycle= 4 E= -526.477849895757  delta_E= -3.21e-07  |g|= 4.59e-05  |ddm|= 0.000803
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=6.3299e-05
diis-c [-1.93843128e-09  1.16060466e-06 -1.09797033e-03 -1.28090419e-03
  1.00237771e+00]
  HOMO = -0.572517403834496  LUMO = 1.01748026393377
  mo_energy =
[-1.18561550e+02 -1.21869989e+01 -9.53852701e+00 -9.53852701e+00
 -9.53852701e+00 -1.24974131e+00 -5.72517404e-01 -5.72517404e-01
 -5.72517404e-01  1.01748026e+00  1.01748026e+00  1.01748026e+00
  7.28977311e+00  7.28977311e+00  7.28977311e+00  3.34205925e+01
  3.34205925e+01  3.34205925e+01  7.43957146e+01  1.29053541e+02
  1.29053541e+02  1.29053541e+02  4.83593221e+02  4.83593221e+02
  4.83593221e+02  5.56981343e+02  1.33581571e+03  1.33581571e+03
  1.33581571e+03  2.62675109e+03  3.03053879e+03  3.03053879e+03
  3.03053879e+03  6.65128246e+03  6.65128246e+03  6.65128246e+03
  9.03441846e+03  2.53919359e+04  7.61362454e+04]
E1 = -728.2926787248551  E_coul = 201.81482882893434
cycle= 5 E= -526.477849895921  delta_E= -1.64e-10  |g|= 7.25e-06  |ddm|= 2.55e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.2926787248551  E_coul = 201.81482882893434
  HOMO = -0.572521208600856  LUMO = 1.01747748433708
  mo_energy =
[-1.18561568e+02 -1.21870120e+01 -9.53854037e+00 -9.53854037e+00
 -9.53854037e+00 -1.24974623e+00 -5.72521209e-01 -5.72521209e-01
 -5.72521209e-01  1.01747748e+00  1.01747748e+00  1.01747748e+00
  7.28976411e+00  7.28976411e+00  7.28976411e+00  3.34205793e+01
  3.34205793e+01  3.34205793e+01  7.43956986e+01  1.29053525e+02
  1.29053525e+02  1.29053525e+02  4.83593203e+02  4.83593203e+02
  4.83593203e+02  5.56981325e+02  1.33581569e+03  1.33581569e+03
  1.33581569e+03  2.62675107e+03  3.03053877e+03  3.03053877e+03
  3.03053877e+03  6.65128245e+03  6.65128245e+03  6.65128245e+03
  9.03441844e+03  2.53919358e+04  7.61362454e+04]
E1 = -728.2927137078842  E_coul = 201.8148638119607
Extra cycle  E= -526.477849895924  delta_E= -2.73e-12  |g|= 1.88e-06  |ddm|= 3.66e-06
    CPU time for scf_cycle      0.67 sec, wall time      0.28 sec
exp = [2.61826435e+04 7.61755282e+03 3.61734792e+03 1.59851858e+03
 3.81725213e+02 1.07739334e+02 3.46891739e+01 4.58478304e+00
 3.95121581e-01 1.36277966e+03 6.64783116e+02 3.01140681e+02
 3.14197173e+02 6.16690266e+01 7.33027986e+00 2.02497747e+01
 7.71914847e-01 2.81471344e+00 2.22287817e-01]
E = -526.4778498959236
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:46:28 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6434585        1
[INPUT] 0    0    [1    /1   ]  7617.55281834        1
[INPUT] 0    0    [1    /1   ]  3617.34792091        1
[INPUT] 0    0    [1    /1   ]  1598.51857834        1
[INPUT] 0    0    [1    /1   ]  381.725213422        1
[INPUT] 0    0    [1    /1   ]  107.739334332        1
[INPUT] 0    0    [1    /1   ]  34.6891738705        1
[INPUT] 0    0    [1    /1   ]  4.58478303819        1
[INPUT] 0    0    [1    /1   ]  0.395121580949       1
[INPUT] 1    0    [1    /1   ]  1362.77966092        1
[INPUT] 1    0    [1    /1   ]  664.78311601         1
[INPUT] 1    0    [1    /1   ]  301.140680643        1
[INPUT] 1    0    [1    /1   ]  314.197172856        1
[INPUT] 1    0    [1    /1   ]  61.6690266336        1
[INPUT] 1    0    [1    /1   ]  7.33027986392        1
[INPUT] 1    0    [1    /1   ]  20.2497746575        1
[INPUT] 1    0    [1    /1   ]  0.771914846717       1
[INPUT] 1    0    [1    /1   ]  2.81471343757        1
[INPUT] 1    0    [1    /1   ]  0.222287817111       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.643458479557, 1.0]], [0, [7617.552818340005, 1.0]], [0, [3617.3479209067323, 1.0]], [0, [1598.5185783408554, 1.0]], [0, [381.72521342156676, 1.0]], [0, [107.73933433229563, 1.0]], [0, [34.68917387052355, 1.0]], [0, [4.584783038189404, 1.0]], [0, [0.3951215809492585, 1.0]], [1, [1362.7796609215152, 1.0]], [1, [664.7831160096351, 1.0]], [1, [301.14068064288915, 1.0]], [1, [314.19717285646374, 1.0]], [1, [61.669026633568095, 1.0]], [1, [7.330279863919227, 1.0]], [1, [20.249774657539344, 1.0]], [1, [0.7719148467170306, 1.0]], [1, [2.814713437568223, 1.0]], [1, [0.22228781711080303, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.64345848]
bas 1, expnt(s) = [7617.55281834]
bas 2, expnt(s) = [3617.34792091]
bas 3, expnt(s) = [1598.51857834]
bas 4, expnt(s) = [381.72521342]
bas 5, expnt(s) = [107.73933433]
bas 6, expnt(s) = [34.68917387]
bas 7, expnt(s) = [4.58478304]
bas 8, expnt(s) = [0.39512158]
bas 9, expnt(s) = [1362.77966092]
bas 10, expnt(s) = [664.78311601]
bas 11, expnt(s) = [301.14068064]
bas 12, expnt(s) = [314.19717286]
bas 13, expnt(s) = [61.66902663]
bas 14, expnt(s) = [7.33027986]
bas 15, expnt(s) = [20.24977466]
bas 16, expnt(s) = [0.77191485]
bas 17, expnt(s) = [2.81471344]
bas 18, expnt(s) = [0.22228782]
CPU time:       864.02
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826435e+04 5.20026102e+03 7.61755282e+03 2.06004463e+03
 3.61734792e+03 1.17844071e+03 1.59851858e+03 6.38709374e+02
 3.81725213e+02 2.18186642e+02 1.07739334e+02 8.44881382e+01
 3.46891739e+01 3.61127442e+01 4.58478304e+00 7.91596957e+00
 3.95121581e-01 1.25910830e+00 1.36277966e+03 2.41555231e+04
 6.64783116e+02 9.84769000e+03 3.01140681e+02 3.65970582e+03
 3.14197173e+02 3.85911067e+03 6.16690266e+01 5.04159854e+02
 7.33027986e+00 3.51872306e+01 2.02497747e+01 1.25316898e+02
 7.71914847e-01 2.11079538e+00 2.81471344e+00 1.06359705e+01
 2.22287817e-01 4.45275673e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.976918974790213
cond(S) = 100518.26407811345
E1 = -728.8834180467281  E_coul = 203.1211754670096
init E= -525.762242579719
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559465622288017  LUMO = 1.02475656878513
  mo_energy =
[-1.18319517e+02 -1.21035325e+01 -9.44894446e+00 -9.44894446e+00
 -9.44894446e+00 -1.23010013e+00 -5.59465622e-01 -5.59465622e-01
 -5.59465622e-01  1.02475657e+00  1.02475657e+00  1.02475657e+00
  7.33807015e+00  7.33807015e+00  7.33807015e+00  3.35184392e+01
  3.35184392e+01  3.35184392e+01  7.45349548e+01  1.29217845e+02
  1.29217845e+02  1.29217845e+02  4.83830347e+02  4.83830347e+02
  4.83830347e+02  5.57257517e+02  1.33610930e+03  1.33610930e+03
  1.33610930e+03  2.62717883e+03  3.03089786e+03  3.03089786e+03
  3.03089786e+03  6.65175522e+03  6.65175522e+03  6.65175522e+03
  9.03496729e+03  2.53925792e+04  7.61369794e+04]
E1 = -728.0369835216982  E_coul = 201.55954276940446
cycle= 1 E= -526.477440752294  delta_E= -0.715  |g|= 0.185  |ddm|= 0.37
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.546339
diis-c [-0.29848589  1.        ]
  HOMO = -0.575795446673848  LUMO = 1.01495187134071
  mo_energy =
[-1.18600372e+02 -1.22054491e+01 -9.55729057e+00 -9.55729057e+00
 -9.55729057e+00 -1.25410970e+00 -5.75795447e-01 -5.75795447e-01
 -5.75795447e-01  1.01495187e+00  1.01495187e+00  1.01495187e+00
  7.27984144e+00  7.27984144e+00  7.27984144e+00  3.34011421e+01
  3.34011421e+01  3.34011421e+01  7.43647277e+01  1.29023153e+02
  1.29023153e+02  1.29023153e+02  4.83554917e+02  4.83554917e+02
  4.83554917e+02  5.56941227e+02  1.33577461e+03  1.33577461e+03
  1.33577461e+03  2.62670816e+03  3.03049634e+03  3.03049634e+03
  3.03049634e+03  6.65123926e+03  6.65123926e+03  6.65123926e+03
  9.03437498e+03  2.53918923e+04  7.61362019e+04]
E1 = -728.3490091755041  E_coul = 201.87117397948458
cycle= 2 E= -526.477835196019  delta_E= -0.000394  |g|= 0.0251  |ddm|= 0.0215
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0488291
diis-c [-0.00152024  0.05117964  0.94882036]
  HOMO = -0.571838852283669  LUMO = 1.01798651993005
  mo_energy =
[-1.18556221e+02 -1.21841138e+01 -9.53553423e+00 -9.53553423e+00
 -9.53553423e+00 -1.24886166e+00 -5.71838852e-01 -5.71838852e-01
 -5.71838852e-01  1.01798652e+00  1.01798652e+00  1.01798652e+00
  7.29155602e+00  7.29155602e+00  7.29155602e+00  3.34236421e+01
  3.34236421e+01  3.34236421e+01  7.43999775e+01  1.29057878e+02
  1.29057878e+02  1.29057878e+02  4.83598477e+02  4.83598477e+02
  4.83598477e+02  5.56986853e+02  1.33582135e+03  1.33582135e+03
  1.33582135e+03  2.62675714e+03  3.03054467e+03  3.03054467e+03
  3.03054467e+03  6.65128860e+03  6.65128860e+03  6.65128860e+03
  9.03442474e+03  2.53919423e+04  7.61362519e+04]
E1 = -728.2840827480054  E_coul = 201.8062331728938
cycle= 3 E= -526.477849575112  delta_E= -1.44e-05  |g|= 0.00307  |ddm|= 0.00548
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00660204
diis-c [-3.73740106e-07 -1.08334288e-03  1.12600127e-01  8.88483216e-01]
  HOMO = -0.572546266387423  LUMO = 1.01745924718721
  mo_energy =
[-1.18561651e+02 -1.21870922e+01 -9.53861939e+00 -9.53861939e+00
 -9.53861939e+00 -1.24977882e+00 -5.72546266e-01 -5.72546266e-01
 -5.72546266e-01  1.01745925e+00  1.01745925e+00  1.01745925e+00
  7.28970732e+00  7.28970732e+00  7.28970732e+00  3.34205033e+01
  3.34205033e+01  3.34205033e+01  7.43956111e+01  1.29053442e+02
  1.29053442e+02  1.29053442e+02  4.83593120e+02  4.83593120e+02
  4.83593120e+02  5.56981245e+02  1.33581561e+03  1.33581561e+03
  1.33581561e+03  2.62675100e+03  3.03053869e+03  3.03053869e+03
  3.03053869e+03  6.65128238e+03  6.65128238e+03  6.65128238e+03
  9.03441838e+03  2.53919358e+04  7.61362453e+04]
E1 = -728.2929042247724  E_coul = 201.81505432901585
cycle= 4 E= -526.477849895757  delta_E= -3.21e-07  |g|= 4.59e-05  |ddm|= 0.000803
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=6.3299e-05
diis-c [-1.93843128e-09  1.16060466e-06 -1.09797033e-03 -1.28090419e-03
  1.00237771e+00]
  HOMO = -0.572517403834496  LUMO = 1.01748026393377
  mo_energy =
[-1.18561550e+02 -1.21869989e+01 -9.53852701e+00 -9.53852701e+00
 -9.53852701e+00 -1.24974131e+00 -5.72517404e-01 -5.72517404e-01
 -5.72517404e-01  1.01748026e+00  1.01748026e+00  1.01748026e+00
  7.28977311e+00  7.28977311e+00  7.28977311e+00  3.34205925e+01
  3.34205925e+01  3.34205925e+01  7.43957146e+01  1.29053541e+02
  1.29053541e+02  1.29053541e+02  4.83593221e+02  4.83593221e+02
  4.83593221e+02  5.56981343e+02  1.33581571e+03  1.33581571e+03
  1.33581571e+03  2.62675109e+03  3.03053879e+03  3.03053879e+03
  3.03053879e+03  6.65128246e+03  6.65128246e+03  6.65128246e+03
  9.03441846e+03  2.53919359e+04  7.61362454e+04]
E1 = -728.2926787248551  E_coul = 201.81482882893434
cycle= 5 E= -526.477849895921  delta_E= -1.64e-10  |g|= 7.25e-06  |ddm|= 2.55e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.2926787248551  E_coul = 201.81482882893434
  HOMO = -0.572521208600856  LUMO = 1.01747748433708
  mo_energy =
[-1.18561568e+02 -1.21870120e+01 -9.53854037e+00 -9.53854037e+00
 -9.53854037e+00 -1.24974623e+00 -5.72521209e-01 -5.72521209e-01
 -5.72521209e-01  1.01747748e+00  1.01747748e+00  1.01747748e+00
  7.28976411e+00  7.28976411e+00  7.28976411e+00  3.34205793e+01
  3.34205793e+01  3.34205793e+01  7.43956986e+01  1.29053525e+02
  1.29053525e+02  1.29053525e+02  4.83593203e+02  4.83593203e+02
  4.83593203e+02  5.56981325e+02  1.33581569e+03  1.33581569e+03
  1.33581569e+03  2.62675107e+03  3.03053877e+03  3.03053877e+03
  3.03053877e+03  6.65128245e+03  6.65128245e+03  6.65128245e+03
  9.03441844e+03  2.53919358e+04  7.61362454e+04]
E1 = -728.2927137078842  E_coul = 201.8148638119607
Extra cycle  E= -526.477849895924  delta_E= -2.73e-12  |g|= 1.88e-06  |ddm|= 3.66e-06
    CPU time for scf_cycle      0.67 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 100518.26407811345
E1 = -728.2927137078842  E_coul = 201.8148638119607
init E= -526.477849895924
    CPU time for initialize scf      2.72 sec, wall time      0.25 sec
  HOMO = -0.572520544807667  LUMO = 1.01747797525796
  mo_energy =
[-1.18561563e+02 -1.21870094e+01 -9.53853773e+00 -9.53853773e+00
 -9.53853773e+00 -1.24974537e+00 -5.72520545e-01 -5.72520545e-01
 -5.72520545e-01  1.01747798e+00  1.01747798e+00  1.01747798e+00
  7.28976577e+00  7.28976577e+00  7.28976577e+00  3.34205819e+01
  3.34205819e+01  3.34205819e+01  7.43957022e+01  1.29053529e+02
  1.29053529e+02  1.29053529e+02  4.83593207e+02  4.83593207e+02
  4.83593207e+02  5.56981329e+02  1.33581570e+03  1.33581570e+03
  1.33581570e+03  2.62675108e+03  3.03053877e+03  3.03053877e+03
  3.03053877e+03  6.65128245e+03  6.65128245e+03  6.65128245e+03
  9.03441845e+03  2.53919358e+04  7.61362454e+04]
E1 = -728.2927064834769  E_coul = 201.81485658755332
cycle= 1 E= -526.477849895924  delta_E=    0  |g|= 4.22e-07  |ddm|= 6.96e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2927064834769  E_coul = 201.81485658755332
  HOMO = -0.572520673876505  LUMO = 1.01747787934515
  mo_energy =
[-1.18561564e+02 -1.21870099e+01 -9.53853827e+00 -9.53853827e+00
 -9.53853827e+00 -1.24974554e+00 -5.72520674e-01 -5.72520674e-01
 -5.72520674e-01  1.01747788e+00  1.01747788e+00  1.01747788e+00
  7.28976544e+00  7.28976544e+00  7.28976544e+00  3.34205814e+01
  3.34205814e+01  3.34205814e+01  7.43957014e+01  1.29053528e+02
  1.29053528e+02  1.29053528e+02  4.83593206e+02  4.83593206e+02
  4.83593206e+02  5.56981328e+02  1.33581570e+03  1.33581570e+03
  1.33581570e+03  2.62675108e+03  3.03053877e+03  3.03053877e+03
  3.03053877e+03  6.65128245e+03  6.65128245e+03  6.65128245e+03
  9.03441844e+03  2.53919358e+04  7.61362454e+04]
E1 = -728.2927079983677  E_coul = 201.81485810244396
Extra cycle  E= -526.477849895924  delta_E= -2.27e-13  |g|= 9.14e-08  |ddm|= 1.42e-07
    CPU time for scf_cycle      2.87 sec, wall time      0.40 sec
exp = [2.61826435e+04 7.61755282e+03 3.61734792e+03 1.59851858e+03
 3.81725213e+02 1.07739334e+02 3.46891739e+01 4.58478304e+00
 3.95121581e-01 1.36277966e+03 6.64783116e+02 3.01140681e+02
 3.14197173e+02 6.16690266e+01 7.33027986e+00 2.02497747e+01
 7.71914847e-01 2.81471344e+00 2.22287817e-01]
grad_E = [-1.51756332e-06  3.36815853e-06 -1.39514393e-06  7.08753580e-05
  1.06126147e-05  2.22537924e-06  2.24833645e-06  2.78546278e-06
 -3.60758516e-06 -5.08396905e-07  4.97785949e-06  2.34391952e-05
  2.02160998e-05 -1.10151725e-05 -3.68076755e-07 -4.11230136e-06
 -4.25895337e-06  1.16573844e-07  2.52888269e-05]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:46:32 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6434915        1
[INPUT] 0    0    [1    /1   ]  7617.55270354        1
[INPUT] 0    0    [1    /1   ]  3617.34784639        1
[INPUT] 0    0    [1    /1   ]  1598.5156392         1
[INPUT] 0    0    [1    /1   ]  381.739906239        1
[INPUT] 0    0    [1    /1   ]  107.744394111        1
[INPUT] 0    0    [1    /1   ]  34.6907667155        1
[INPUT] 0    0    [1    /1   ]  4.58478999361        1
[INPUT] 0    0    [1    /1   ]  0.395124099717       1
[INPUT] 1    0    [1    /1   ]  1362.77966504        1
[INPUT] 1    0    [1    /1   ]  664.783034079        1
[INPUT] 1    0    [1    /1   ]  301.140264254        1
[INPUT] 1    0    [1    /1   ]  314.196805043        1
[INPUT] 1    0    [1    /1   ]  61.6686914478        1
[INPUT] 1    0    [1    /1   ]  7.33028983478        1
[INPUT] 1    0    [1    /1   ]  20.2497093885        1
[INPUT] 1    0    [1    /1   ]  0.771916549148       1
[INPUT] 1    0    [1    /1   ]  2.81464025364        1
[INPUT] 1    0    [1    /1   ]  0.222291512446       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.643491526345, 1.0]], [0, [7617.5527035379455, 1.0]], [0, [3617.347846392218, 1.0]], [0, [1598.5156391975595, 1.0]], [0, [381.7399062387789, 1.0]], [0, [107.74439411083556, 1.0]], [0, [34.690766715533364, 1.0]], [0, [4.5847899936125, 1.0]], [0, [0.39512409971719664, 1.0]], [1, [1362.7796650404136, 1.0]], [1, [664.7830340790941, 1.0]], [1, [301.14026425379893, 1.0]], [1, [314.19680504288027, 1.0]], [1, [61.66869144776969, 1.0]], [1, [7.330289834779676, 1.0]], [1, [20.249709388481726, 1.0]], [1, [0.7719165491481365, 1.0]], [1, [2.814640253642959, 1.0]], [1, [0.22229151244585088, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.64349153]
bas 1, expnt(s) = [7617.55270354]
bas 2, expnt(s) = [3617.34784639]
bas 3, expnt(s) = [1598.5156392]
bas 4, expnt(s) = [381.73990624]
bas 5, expnt(s) = [107.74439411]
bas 6, expnt(s) = [34.69076672]
bas 7, expnt(s) = [4.58478999]
bas 8, expnt(s) = [0.3951241]
bas 9, expnt(s) = [1362.77966504]
bas 10, expnt(s) = [664.78303408]
bas 11, expnt(s) = [301.14026425]
bas 12, expnt(s) = [314.19680504]
bas 13, expnt(s) = [61.66869145]
bas 14, expnt(s) = [7.33028983]
bas 15, expnt(s) = [20.24970939]
bas 16, expnt(s) = [0.77191655]
bas 17, expnt(s) = [2.81464025]
bas 18, expnt(s) = [0.22229151]
CPU time:       872.42
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826435e+04 5.20026103e+03 7.61755270e+03 2.06004461e+03
 3.61734785e+03 1.17844069e+03 1.59851564e+03 6.38708494e+02
 3.81739906e+02 2.18192941e+02 1.07744394e+02 8.44911141e+01
 3.46907667e+01 3.61139879e+01 4.58478999e+00 7.91597857e+00
 3.95124100e-01 1.25911432e+00 1.36277967e+03 2.41555232e+04
 6.64783034e+02 9.84768848e+03 3.01140264e+02 3.65969950e+03
 3.14196805e+02 3.85910503e+03 6.16686914e+01 5.04156428e+02
 7.33028983e+00 3.51872905e+01 2.02497094e+01 1.25316393e+02
 7.71916549e-01 2.11080120e+00 2.81464025e+00 1.06356249e+01
 2.22291512e-01 4.45284926e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.976918161255597
cond(S) = 100517.05006407437
E1 = -728.8834492740992  E_coul = 203.12121647711845
init E= -525.762232796981
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559464439499135  LUMO = 1.02477206008011
  mo_energy =
[-1.18319512e+02 -1.21035313e+01 -9.44894106e+00 -9.44894106e+00
 -9.44894106e+00 -1.23009935e+00 -5.59464439e-01 -5.59464439e-01
 -5.59464439e-01  1.02477206e+00  1.02477206e+00  1.02477206e+00
  7.33797265e+00  7.33797265e+00  7.33797265e+00  3.35181792e+01
  3.35181792e+01  3.35181792e+01  7.45400998e+01  1.29217148e+02
  1.29217148e+02  1.29217148e+02  4.83828751e+02  4.83828751e+02
  4.83828751e+02  5.57286492e+02  1.33610670e+03  1.33610670e+03
  1.33610670e+03  2.62724029e+03  3.03089415e+03  3.03089415e+03
  3.03089415e+03  6.65175087e+03  6.65175087e+03  6.65175087e+03
  9.03503623e+03  2.53926456e+04  7.61370410e+04]
E1 = -728.0370973267168  E_coul = 201.5596564820093
cycle= 1 E= -526.477440844707  delta_E= -0.715  |g|= 0.185  |ddm|= 0.37
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.546327
diis-c [-0.29847345  1.        ]
  HOMO = -0.575792105298521  LUMO = 1.01496894726462
  mo_energy =
[-1.18600359e+02 -1.22054438e+01 -9.55728205e+00 -9.55728205e+00
 -9.55728205e+00 -1.25410670e+00 -5.75792105e-01 -5.75792105e-01
 -5.75792105e-01  1.01496895e+00  1.01496895e+00  1.01496895e+00
  7.27974837e+00  7.27974837e+00  7.27974837e+00  3.34008877e+01
  3.34008877e+01  3.34008877e+01  7.43698749e+01  1.29022463e+02
  1.29022463e+02  1.29022463e+02  4.83553330e+02  4.83553330e+02
  4.83553330e+02  5.56970208e+02  1.33577203e+03  1.33577203e+03
  1.33577203e+03  2.62676962e+03  3.03049264e+03  3.03049264e+03
  3.03049264e+03  6.65123492e+03  6.65123492e+03  6.65123492e+03
  9.03444393e+03  2.53919587e+04  7.61362635e+04]
E1 = -728.3491012995481  E_coul = 201.87126605355098
cycle= 2 E= -526.477835245997  delta_E= -0.000394  |g|= 0.0251  |ddm|= 0.0215
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0488263
diis-c [-0.00152013  0.05117612  0.94882388]
  HOMO = -0.571835836993207  LUMO = 1.01800336685125
  mo_energy =
[-1.18556210e+02 -1.21841098e+01 -9.53552718e+00 -9.53552718e+00
 -9.53552718e+00 -1.24885907e+00 -5.71835837e-01 -5.71835837e-01
 -5.71835837e-01  1.01800337e+00  1.01800337e+00  1.01800337e+00
  7.29146196e+00  7.29146196e+00  7.29146196e+00  3.34233862e+01
  3.34233862e+01  3.34233862e+01  7.44051232e+01  1.29057186e+02
  1.29057186e+02  1.29057186e+02  4.83596887e+02  4.83596887e+02
  4.83596887e+02  5.57015832e+02  1.33581876e+03  1.33581876e+03
  1.33581876e+03  2.62681861e+03  3.03054097e+03  3.03054097e+03
  3.03054097e+03  6.65128426e+03  6.65128426e+03  6.65128426e+03
  9.03449369e+03  2.53920087e+04  7.61363134e+04]
E1 = -728.28417959143  E_coul = 201.806329968328
cycle= 3 E= -526.477849623102  delta_E= -1.44e-05  |g|= 0.00307  |ddm|= 0.00548
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00660171
diis-c [-3.73671642e-07 -1.08328916e-03  1.12601300e-01  8.88481990e-01]
  HOMO = -0.572543205337746  LUMO = 1.01747612502652
  mo_energy =
[-1.18561640e+02 -1.21870881e+01 -9.53861218e+00 -9.53861218e+00
 -9.53861218e+00 -1.24977617e+00 -5.72543205e-01 -5.72543205e-01
 -5.72543205e-01  1.01747613e+00  1.01747613e+00  1.01747613e+00
  7.28961338e+00  7.28961338e+00  7.28961338e+00  3.34202475e+01
  3.34202475e+01  3.34202475e+01  7.44007569e+01  1.29052750e+02
  1.29052750e+02  1.29052750e+02  4.83591530e+02  4.83591530e+02
  4.83591530e+02  5.57010224e+02  1.33581303e+03  1.33581303e+03
  1.33581303e+03  2.62681247e+03  3.03053500e+03  3.03053500e+03
  3.03053500e+03  6.65127804e+03  6.65127804e+03  6.65127804e+03
  9.03448733e+03  2.53920022e+04  7.61363069e+04]
E1 = -728.2930005450708  E_coul = 201.81515060135973
cycle= 4 E= -526.477849943711  delta_E= -3.21e-07  |g|= 4.59e-05  |ddm|= 0.000803
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=6.32992e-05
diis-c [-1.93811927e-09  1.15699367e-06 -1.09743570e-03 -1.27578440e-03
  1.00237206e+00]
  HOMO = -0.57251434411046  LUMO = 1.017497140921
  mo_energy =
[-1.18561539e+02 -1.21869948e+01 -9.53851981e+00 -9.53851981e+00
 -9.53851981e+00 -1.24973866e+00 -5.72514344e-01 -5.72514344e-01
 -5.72514344e-01  1.01749714e+00  1.01749714e+00  1.01749714e+00
  7.28967917e+00  7.28967917e+00  7.28967917e+00  3.34203367e+01
  3.34203367e+01  3.34203367e+01  7.44008605e+01  1.29052849e+02
  1.29052849e+02  1.29052849e+02  4.83591631e+02  4.83591631e+02
  4.83591631e+02  5.57010322e+02  1.33581313e+03  1.33581313e+03
  1.33581313e+03  2.62681256e+03  3.03053509e+03  3.03053509e+03
  3.03053509e+03  6.65127813e+03  6.65127813e+03  6.65127813e+03
  9.03448741e+03  2.53920023e+04  7.61363070e+04]
E1 = -728.2927750563825  E_coul = 201.81492511250693
cycle= 5 E= -526.477849943876  delta_E= -1.65e-10  |g|= 7.24e-06  |ddm|= 2.55e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.2927750563825  E_coul = 201.81492511250693
  HOMO = -0.572518148375964  LUMO = 1.01749436167675
  mo_energy =
[-1.18561557e+02 -1.21870079e+01 -9.53853316e+00 -9.53853316e+00
 -9.53853316e+00 -1.24974358e+00 -5.72518148e-01 -5.72518148e-01
 -5.72518148e-01  1.01749436e+00  1.01749436e+00  1.01749436e+00
  7.28967017e+00  7.28967017e+00  7.28967017e+00  3.34203235e+01
  3.34203235e+01  3.34203235e+01  7.44008445e+01  1.29052833e+02
  1.29052833e+02  1.29052833e+02  4.83591613e+02  4.83591613e+02
  4.83591613e+02  5.57010304e+02  1.33581311e+03  1.33581311e+03
  1.33581311e+03  2.62681254e+03  3.03053507e+03  3.03053507e+03
  3.03053507e+03  6.65127811e+03  6.65127811e+03  6.65127811e+03
  9.03448739e+03  2.53920023e+04  7.61363070e+04]
E1 = -728.2928100346684  E_coul = 201.81496009078865
Extra cycle  E= -526.47784994388  delta_E= -4.09e-12  |g|= 1.88e-06  |ddm|= 3.66e-06
    CPU time for scf_cycle      0.68 sec, wall time      0.29 sec
exp = [2.61826435e+04 7.61755270e+03 3.61734785e+03 1.59851564e+03
 3.81739906e+02 1.07744394e+02 3.46907667e+01 4.58478999e+00
 3.95124100e-01 1.36277967e+03 6.64783034e+02 3.01140264e+02
 3.14196805e+02 6.16686914e+01 7.33028983e+00 2.02497094e+01
 7.71916549e-01 2.81464025e+00 2.22291512e-01]
E = -526.4778499438797
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:46:33 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6434915        1
[INPUT] 0    0    [1    /1   ]  7617.55270354        1
[INPUT] 0    0    [1    /1   ]  3617.34784639        1
[INPUT] 0    0    [1    /1   ]  1598.5156392         1
[INPUT] 0    0    [1    /1   ]  381.739906239        1
[INPUT] 0    0    [1    /1   ]  107.744394111        1
[INPUT] 0    0    [1    /1   ]  34.6907667155        1
[INPUT] 0    0    [1    /1   ]  4.58478999361        1
[INPUT] 0    0    [1    /1   ]  0.395124099717       1
[INPUT] 1    0    [1    /1   ]  1362.77966504        1
[INPUT] 1    0    [1    /1   ]  664.783034079        1
[INPUT] 1    0    [1    /1   ]  301.140264254        1
[INPUT] 1    0    [1    /1   ]  314.196805043        1
[INPUT] 1    0    [1    /1   ]  61.6686914478        1
[INPUT] 1    0    [1    /1   ]  7.33028983478        1
[INPUT] 1    0    [1    /1   ]  20.2497093885        1
[INPUT] 1    0    [1    /1   ]  0.771916549148       1
[INPUT] 1    0    [1    /1   ]  2.81464025364        1
[INPUT] 1    0    [1    /1   ]  0.222291512446       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.643491526345, 1.0]], [0, [7617.5527035379455, 1.0]], [0, [3617.347846392218, 1.0]], [0, [1598.5156391975595, 1.0]], [0, [381.7399062387789, 1.0]], [0, [107.74439411083556, 1.0]], [0, [34.690766715533364, 1.0]], [0, [4.5847899936125, 1.0]], [0, [0.39512409971719664, 1.0]], [1, [1362.7796650404136, 1.0]], [1, [664.7830340790941, 1.0]], [1, [301.14026425379893, 1.0]], [1, [314.19680504288027, 1.0]], [1, [61.66869144776969, 1.0]], [1, [7.330289834779676, 1.0]], [1, [20.249709388481726, 1.0]], [1, [0.7719165491481365, 1.0]], [1, [2.814640253642959, 1.0]], [1, [0.22229151244585088, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.64349153]
bas 1, expnt(s) = [7617.55270354]
bas 2, expnt(s) = [3617.34784639]
bas 3, expnt(s) = [1598.5156392]
bas 4, expnt(s) = [381.73990624]
bas 5, expnt(s) = [107.74439411]
bas 6, expnt(s) = [34.69076672]
bas 7, expnt(s) = [4.58478999]
bas 8, expnt(s) = [0.3951241]
bas 9, expnt(s) = [1362.77966504]
bas 10, expnt(s) = [664.78303408]
bas 11, expnt(s) = [301.14026425]
bas 12, expnt(s) = [314.19680504]
bas 13, expnt(s) = [61.66869145]
bas 14, expnt(s) = [7.33028983]
bas 15, expnt(s) = [20.24970939]
bas 16, expnt(s) = [0.77191655]
bas 17, expnt(s) = [2.81464025]
bas 18, expnt(s) = [0.22229151]
CPU time:       873.39
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826435e+04 5.20026103e+03 7.61755270e+03 2.06004461e+03
 3.61734785e+03 1.17844069e+03 1.59851564e+03 6.38708494e+02
 3.81739906e+02 2.18192941e+02 1.07744394e+02 8.44911141e+01
 3.46907667e+01 3.61139879e+01 4.58478999e+00 7.91597857e+00
 3.95124100e-01 1.25911432e+00 1.36277967e+03 2.41555232e+04
 6.64783034e+02 9.84768848e+03 3.01140264e+02 3.65969950e+03
 3.14196805e+02 3.85910503e+03 6.16686914e+01 5.04156428e+02
 7.33028983e+00 3.51872905e+01 2.02497094e+01 1.25316393e+02
 7.71916549e-01 2.11080120e+00 2.81464025e+00 1.06356249e+01
 2.22291512e-01 4.45284926e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.976918161255597
cond(S) = 100517.05006407437
E1 = -728.8834492740992  E_coul = 203.12121647711845
init E= -525.762232796981
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559464439499135  LUMO = 1.02477206008011
  mo_energy =
[-1.18319512e+02 -1.21035313e+01 -9.44894106e+00 -9.44894106e+00
 -9.44894106e+00 -1.23009935e+00 -5.59464439e-01 -5.59464439e-01
 -5.59464439e-01  1.02477206e+00  1.02477206e+00  1.02477206e+00
  7.33797265e+00  7.33797265e+00  7.33797265e+00  3.35181792e+01
  3.35181792e+01  3.35181792e+01  7.45400998e+01  1.29217148e+02
  1.29217148e+02  1.29217148e+02  4.83828751e+02  4.83828751e+02
  4.83828751e+02  5.57286492e+02  1.33610670e+03  1.33610670e+03
  1.33610670e+03  2.62724029e+03  3.03089415e+03  3.03089415e+03
  3.03089415e+03  6.65175087e+03  6.65175087e+03  6.65175087e+03
  9.03503623e+03  2.53926456e+04  7.61370410e+04]
E1 = -728.0370973267168  E_coul = 201.5596564820093
cycle= 1 E= -526.477440844707  delta_E= -0.715  |g|= 0.185  |ddm|= 0.37
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.546327
diis-c [-0.29847345  1.        ]
  HOMO = -0.575792105298521  LUMO = 1.01496894726462
  mo_energy =
[-1.18600359e+02 -1.22054438e+01 -9.55728205e+00 -9.55728205e+00
 -9.55728205e+00 -1.25410670e+00 -5.75792105e-01 -5.75792105e-01
 -5.75792105e-01  1.01496895e+00  1.01496895e+00  1.01496895e+00
  7.27974837e+00  7.27974837e+00  7.27974837e+00  3.34008877e+01
  3.34008877e+01  3.34008877e+01  7.43698749e+01  1.29022463e+02
  1.29022463e+02  1.29022463e+02  4.83553330e+02  4.83553330e+02
  4.83553330e+02  5.56970208e+02  1.33577203e+03  1.33577203e+03
  1.33577203e+03  2.62676962e+03  3.03049264e+03  3.03049264e+03
  3.03049264e+03  6.65123492e+03  6.65123492e+03  6.65123492e+03
  9.03444393e+03  2.53919587e+04  7.61362635e+04]
E1 = -728.3491012995481  E_coul = 201.87126605355098
cycle= 2 E= -526.477835245997  delta_E= -0.000394  |g|= 0.0251  |ddm|= 0.0215
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0488263
diis-c [-0.00152013  0.05117612  0.94882388]
  HOMO = -0.571835836993207  LUMO = 1.01800336685125
  mo_energy =
[-1.18556210e+02 -1.21841098e+01 -9.53552718e+00 -9.53552718e+00
 -9.53552718e+00 -1.24885907e+00 -5.71835837e-01 -5.71835837e-01
 -5.71835837e-01  1.01800337e+00  1.01800337e+00  1.01800337e+00
  7.29146196e+00  7.29146196e+00  7.29146196e+00  3.34233862e+01
  3.34233862e+01  3.34233862e+01  7.44051232e+01  1.29057186e+02
  1.29057186e+02  1.29057186e+02  4.83596887e+02  4.83596887e+02
  4.83596887e+02  5.57015832e+02  1.33581876e+03  1.33581876e+03
  1.33581876e+03  2.62681861e+03  3.03054097e+03  3.03054097e+03
  3.03054097e+03  6.65128426e+03  6.65128426e+03  6.65128426e+03
  9.03449369e+03  2.53920087e+04  7.61363134e+04]
E1 = -728.28417959143  E_coul = 201.806329968328
cycle= 3 E= -526.477849623102  delta_E= -1.44e-05  |g|= 0.00307  |ddm|= 0.00548
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00660171
diis-c [-3.73671642e-07 -1.08328916e-03  1.12601300e-01  8.88481990e-01]
  HOMO = -0.572543205337746  LUMO = 1.01747612502652
  mo_energy =
[-1.18561640e+02 -1.21870881e+01 -9.53861218e+00 -9.53861218e+00
 -9.53861218e+00 -1.24977617e+00 -5.72543205e-01 -5.72543205e-01
 -5.72543205e-01  1.01747613e+00  1.01747613e+00  1.01747613e+00
  7.28961338e+00  7.28961338e+00  7.28961338e+00  3.34202475e+01
  3.34202475e+01  3.34202475e+01  7.44007569e+01  1.29052750e+02
  1.29052750e+02  1.29052750e+02  4.83591530e+02  4.83591530e+02
  4.83591530e+02  5.57010224e+02  1.33581303e+03  1.33581303e+03
  1.33581303e+03  2.62681247e+03  3.03053500e+03  3.03053500e+03
  3.03053500e+03  6.65127804e+03  6.65127804e+03  6.65127804e+03
  9.03448733e+03  2.53920022e+04  7.61363069e+04]
E1 = -728.2930005450708  E_coul = 201.81515060135973
cycle= 4 E= -526.477849943711  delta_E= -3.21e-07  |g|= 4.59e-05  |ddm|= 0.000803
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.32992e-05
diis-c [-1.93811927e-09  1.15699367e-06 -1.09743570e-03 -1.27578440e-03
  1.00237206e+00]
  HOMO = -0.57251434411046  LUMO = 1.017497140921
  mo_energy =
[-1.18561539e+02 -1.21869948e+01 -9.53851981e+00 -9.53851981e+00
 -9.53851981e+00 -1.24973866e+00 -5.72514344e-01 -5.72514344e-01
 -5.72514344e-01  1.01749714e+00  1.01749714e+00  1.01749714e+00
  7.28967917e+00  7.28967917e+00  7.28967917e+00  3.34203367e+01
  3.34203367e+01  3.34203367e+01  7.44008605e+01  1.29052849e+02
  1.29052849e+02  1.29052849e+02  4.83591631e+02  4.83591631e+02
  4.83591631e+02  5.57010322e+02  1.33581313e+03  1.33581313e+03
  1.33581313e+03  2.62681256e+03  3.03053509e+03  3.03053509e+03
  3.03053509e+03  6.65127813e+03  6.65127813e+03  6.65127813e+03
  9.03448741e+03  2.53920023e+04  7.61363070e+04]
E1 = -728.2927750563825  E_coul = 201.81492511250693
cycle= 5 E= -526.477849943876  delta_E= -1.65e-10  |g|= 7.24e-06  |ddm|= 2.55e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.2927750563825  E_coul = 201.81492511250693
  HOMO = -0.572518148375964  LUMO = 1.01749436167675
  mo_energy =
[-1.18561557e+02 -1.21870079e+01 -9.53853316e+00 -9.53853316e+00
 -9.53853316e+00 -1.24974358e+00 -5.72518148e-01 -5.72518148e-01
 -5.72518148e-01  1.01749436e+00  1.01749436e+00  1.01749436e+00
  7.28967017e+00  7.28967017e+00  7.28967017e+00  3.34203235e+01
  3.34203235e+01  3.34203235e+01  7.44008445e+01  1.29052833e+02
  1.29052833e+02  1.29052833e+02  4.83591613e+02  4.83591613e+02
  4.83591613e+02  5.57010304e+02  1.33581311e+03  1.33581311e+03
  1.33581311e+03  2.62681254e+03  3.03053507e+03  3.03053507e+03
  3.03053507e+03  6.65127811e+03  6.65127811e+03  6.65127811e+03
  9.03448739e+03  2.53920023e+04  7.61363070e+04]
E1 = -728.2928100346684  E_coul = 201.81496009078865
Extra cycle  E= -526.47784994388  delta_E= -4.09e-12  |g|= 1.88e-06  |ddm|= 3.66e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 100517.05006407437
E1 = -728.2928100346684  E_coul = 201.81496009078865
init E= -526.47784994388
    CPU time for initialize scf      2.73 sec, wall time      0.25 sec
  HOMO = -0.572517484678632  LUMO = 1.01749485252914
  mo_energy =
[-1.18561553e+02 -1.21870053e+01 -9.53853053e+00 -9.53853053e+00
 -9.53853053e+00 -1.24974272e+00 -5.72517485e-01 -5.72517485e-01
 -5.72517485e-01  1.01749485e+00  1.01749485e+00  1.01749485e+00
  7.28967183e+00  7.28967183e+00  7.28967183e+00  3.34203262e+01
  3.34203262e+01  3.34203262e+01  7.44008480e+01  1.29052837e+02
  1.29052837e+02  1.29052837e+02  4.83591617e+02  4.83591617e+02
  4.83591617e+02  5.57010308e+02  1.33581311e+03  1.33581311e+03
  1.33581311e+03  2.62681254e+03  3.03053508e+03  3.03053508e+03
  3.03053508e+03  6.65127811e+03  6.65127811e+03  6.65127811e+03
  9.03448740e+03  2.53920023e+04  7.61363070e+04]
E1 = -728.2928028113103  E_coul = 201.8149528674311
cycle= 1 E= -526.477849943879  delta_E= 5.68e-13  |g|= 4.22e-07  |ddm|= 6.96e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2928028113103  E_coul = 201.8149528674311
  HOMO = -0.572517613728606  LUMO = 1.01749475663059
  mo_energy =
[-1.18561554e+02 -1.21870059e+01 -9.53853107e+00 -9.53853107e+00
 -9.53853107e+00 -1.24974289e+00 -5.72517614e-01 -5.72517614e-01
 -5.72517614e-01  1.01749476e+00  1.01749476e+00  1.01749476e+00
  7.28967150e+00  7.28967150e+00  7.28967150e+00  3.34203256e+01
  3.34203256e+01  3.34203256e+01  7.44008473e+01  1.29052836e+02
  1.29052836e+02  1.29052836e+02  4.83591616e+02  4.83591616e+02
  4.83591616e+02  5.57010308e+02  1.33581311e+03  1.33581311e+03
  1.33581311e+03  2.62681254e+03  3.03053507e+03  3.03053507e+03
  3.03053507e+03  6.65127811e+03  6.65127811e+03  6.65127811e+03
  9.03448739e+03  2.53920023e+04  7.61363070e+04]
E1 = -728.2928043259776  E_coul = 201.8149543820978
Extra cycle  E= -526.47784994388  delta_E= -6.82e-13  |g|= 9.14e-08  |ddm|= 1.42e-07
    CPU time for scf_cycle      2.85 sec, wall time      0.37 sec
exp = [2.61826435e+04 7.61755270e+03 3.61734785e+03 1.59851564e+03
 3.81739906e+02 1.07744394e+02 3.46907667e+01 4.58478999e+00
 3.95124100e-01 1.36277967e+03 6.64783034e+02 3.01140264e+02
 3.14196805e+02 6.16686914e+01 7.33028983e+00 2.02497094e+01
 7.71916549e-01 2.81464025e+00 2.22291512e-01]
grad_E = [-1.51749568e-06  3.36740406e-06 -1.39571738e-06  7.08517817e-05
  1.08103879e-05  1.25167784e-06  6.63113639e-06  5.32758600e-06
  3.28416087e-05 -5.08403321e-07  4.97777160e-06  2.34385495e-05
  2.02155457e-05 -1.07916014e-05  1.17361102e-05 -6.90030739e-06
 -2.26042267e-05 -1.75495763e-05  1.15165533e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:46:37 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6436388        1
[INPUT] 0    0    [1    /1   ]  7617.5522416         1
[INPUT] 0    0    [1    /1   ]  3617.34764099        1
[INPUT] 0    0    [1    /1   ]  1598.50421539        1
[INPUT] 0    0    [1    /1   ]  381.7874918          1
[INPUT] 0    0    [1    /1   ]  107.760433217        1
[INPUT] 0    0    [1    /1   ]  34.6956798778        1
[INPUT] 0    0    [1    /1   ]  4.5848088949         1
[INPUT] 0    0    [1    /1   ]  0.39513183329        1
[INPUT] 1    0    [1    /1   ]  1362.77969157        1
[INPUT] 1    0    [1    /1   ]  664.78264253         1
[INPUT] 1    0    [1    /1   ]  301.138321452        1
[INPUT] 1    0    [1    /1   ]  314.195100776        1
[INPUT] 1    0    [1    /1   ]  61.6674210141        1
[INPUT] 1    0    [1    /1   ]  7.33032129099        1
[INPUT] 1    0    [1    /1   ]  20.249448397         1
[INPUT] 1    0    [1    /1   ]  0.771923912059       1
[INPUT] 1    0    [1    /1   ]  2.81441380928        1
[INPUT] 1    0    [1    /1   ]  0.2223037227         1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.643638847785, 1.0]], [0, [7617.5522415972955, 1.0]], [0, [3617.3476409877594, 1.0]], [0, [1598.504215389275, 1.0]], [0, [381.7874917996479, 1.0]], [0, [107.76043321651605, 1.0]], [0, [34.69567987783957, 1.0]], [0, [4.584808894897402, 1.0]], [0, [0.3951318332900063, 1.0]], [1, [1362.77969157124, 1.0]], [1, [664.7826425300175, 1.0]], [1, [301.1383214515867, 1.0]], [1, [314.19510077572534, 1.0]], [1, [61.66742101413339, 1.0]], [1, [7.3303212909899935, 1.0]], [1, [20.24944839697969, 1.0]], [1, [0.7719239120593303, 1.0]], [1, [2.8144138092810618, 1.0]], [1, [0.22230372270040727, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.64363885]
bas 1, expnt(s) = [7617.5522416]
bas 2, expnt(s) = [3617.34764099]
bas 3, expnt(s) = [1598.50421539]
bas 4, expnt(s) = [381.7874918]
bas 5, expnt(s) = [107.76043322]
bas 6, expnt(s) = [34.69567988]
bas 7, expnt(s) = [4.58480889]
bas 8, expnt(s) = [0.39513183]
bas 9, expnt(s) = [1362.77969157]
bas 10, expnt(s) = [664.78264253]
bas 11, expnt(s) = [301.13832145]
bas 12, expnt(s) = [314.19510078]
bas 13, expnt(s) = [61.66742101]
bas 14, expnt(s) = [7.33032129]
bas 15, expnt(s) = [20.2494484]
bas 16, expnt(s) = [0.77192391]
bas 17, expnt(s) = [2.81441381]
bas 18, expnt(s) = [0.22230372]
CPU time:       881.68
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826436e+04 5.20026105e+03 7.61755224e+03 2.06004452e+03
 3.61734764e+03 1.17844064e+03 1.59850422e+03 6.38705070e+02
 3.81787492e+02 2.18213340e+02 1.07760433e+02 8.45005471e+01
 3.46956799e+01 3.61178239e+01 4.58480889e+00 7.91600305e+00
 3.95131833e-01 1.25913280e+00 1.36277969e+03 2.41555238e+04
 6.64782643e+02 9.84768123e+03 3.01138321e+02 3.65966999e+03
 3.14195101e+02 3.85907886e+03 6.16674210e+01 5.04143446e+02
 7.33032129e+00 3.51874792e+01 2.02494484e+01 1.25314374e+02
 7.71923912e-01 2.11082637e+00 2.81441381e+00 1.06345553e+01
 2.22303723e-01 4.45315500e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97691557327574
cond(S) = 100510.8652640161
E1 = -728.8835359469703  E_coul = 203.1213382246889
init E= -525.762197722281
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559460805419987  LUMO = 1.02482469727385
  mo_energy =
[-1.18319498e+02 -1.21035275e+01 -9.44893108e+00 -9.44893108e+00
 -9.44893108e+00 -1.23009689e+00 -5.59460805e-01 -5.59460805e-01
 -5.59460805e-01  1.02482470e+00  1.02482470e+00  1.02482470e+00
  7.33768189e+00  7.33768189e+00  7.33768189e+00  3.35173463e+01
  3.35173463e+01  3.35173463e+01  7.45561262e+01  1.29214606e+02
  1.29214606e+02  1.29214606e+02  4.83822517e+02  4.83822517e+02
  4.83822517e+02  5.57378491e+02  1.33609595e+03  1.33609595e+03
  1.33609595e+03  2.62743600e+03  3.03087822e+03  3.03087822e+03
  3.03087822e+03  6.65173187e+03  6.65173187e+03  6.65173187e+03
  9.03525341e+03  2.53928525e+04  7.61372314e+04]
E1 = -728.037447654299  E_coul = 201.56000640505064
cycle= 1 E= -526.477441249248  delta_E= -0.715  |g|= 0.185  |ddm|= 0.37
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.546294
diis-c [-0.29843675  1.        ]
  HOMO = -0.575781568740725  LUMO = 1.01502659064797
  mo_energy =
[-1.18600321e+02 -1.22054267e+01 -9.55725595e+00 -9.55725595e+00
 -9.55725595e+00 -1.25409704e+00 -5.75781569e-01 -5.75781569e-01
 -5.75781569e-01  1.01502659e+00  1.01502659e+00  1.01502659e+00
  7.27947164e+00  7.27947164e+00  7.27947164e+00  3.34000725e+01
  3.34000725e+01  3.34000725e+01  7.43859083e+01  1.29019943e+02
  1.29019943e+02  1.29019943e+02  4.83547123e+02  4.83547123e+02
  4.83547123e+02  5.57062225e+02  1.33576130e+03  1.33576130e+03
  1.33576130e+03  2.62696538e+03  3.03047674e+03  3.03047674e+03
  3.03047674e+03  6.65121595e+03  6.65121595e+03  6.65121595e+03
  9.03466115e+03  2.53921656e+04  7.61364540e+04]
E1 = -728.3493846987373  E_coul = 201.87154917616658
cycle= 2 E= -526.477835522571  delta_E= -0.000394  |g|= 0.025  |ddm|= 0.0215
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0488176
diis-c [-0.00151976  0.05116553  0.94883447]
  HOMO = -0.571826324425691  LUMO = 1.01806030242026
  mo_energy =
[-1.18556180e+02 -1.21840972e+01 -9.53550561e+00 -9.53550561e+00
 -9.53550561e+00 -1.24885070e+00 -5.71826324e-01 -5.71826324e-01
 -5.71826324e-01  1.01806030e+00  1.01806030e+00  1.01806030e+00
  7.29118215e+00  7.29118215e+00  7.29118215e+00  3.34225662e+01
  3.34225662e+01  3.34225662e+01  7.44211521e+01  1.29054660e+02
  1.29054660e+02  1.29054660e+02  4.83590673e+02  4.83590673e+02
  4.83590673e+02  5.57107842e+02  1.33580803e+03  1.33580803e+03
  1.33580803e+03  2.62701435e+03  3.03052507e+03  3.03052507e+03
  3.03052507e+03  6.65126529e+03  6.65126529e+03  6.65126529e+03
  9.03471090e+03  2.53922155e+04  7.61365040e+04]
E1 = -728.284477617203  E_coul = 201.80662772363186
cycle= 3 E= -526.477849893571  delta_E= -1.44e-05  |g|= 0.00307  |ddm|= 0.00548
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00660067
diis-c [-3.73469521e-07 -1.08313096e-03  1.12604433e-01  8.88478698e-01]
  HOMO = -0.572533549016399  LUMO = 1.0175331560164
  mo_energy =
[-1.18561609e+02 -1.21870750e+01 -9.53859014e+00 -9.53859014e+00
 -9.53859014e+00 -1.24976763e+00 -5.72533549e-01 -5.72533549e-01
 -5.72533549e-01  1.01753316e+00  1.01753316e+00  1.01753316e+00
  7.28933395e+00  7.28933395e+00  7.28933395e+00  3.34194281e+01
  3.34194281e+01  3.34194281e+01  7.44167862e+01  1.29050225e+02
  1.29050225e+02  1.29050225e+02  4.83585317e+02  4.83585317e+02
  4.83585317e+02  5.57102235e+02  1.33580230e+03  1.33580230e+03
  1.33580230e+03  2.62700821e+03  3.03051909e+03  3.03051909e+03
  3.03051909e+03  6.65125907e+03  6.65125907e+03  6.65125907e+03
  9.03470454e+03  2.53922091e+04  7.61364974e+04]
E1 = -728.2932969243732  E_coul = 201.815446710303
cycle= 4 E= -526.47785021407  delta_E= -3.2e-07  |g|= 4.59e-05  |ddm|= 0.000802
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.33001e-05
diis-c [-1.93718347e-09  1.14567466e-06 -1.09583893e-03 -1.26041889e-03
  1.00235511e+00]
  HOMO = -0.572504691733174  LUMO = 1.01755416945652
  mo_energy =
[-1.18561508e+02 -1.21869817e+01 -9.53849778e+00 -9.53849778e+00
 -9.53849778e+00 -1.24973012e+00 -5.72504692e-01 -5.72504692e-01
 -5.72504692e-01  1.01755417e+00  1.01755417e+00  1.01755417e+00
  7.28939972e+00  7.28939972e+00  7.28939972e+00  3.34195173e+01
  3.34195173e+01  3.34195173e+01  7.44168897e+01  1.29050324e+02
  1.29050324e+02  1.29050324e+02  4.83585418e+02  4.83585418e+02
  4.83585418e+02  5.57102333e+02  1.33580239e+03  1.33580239e+03
  1.33580239e+03  2.62700830e+03  3.03051918e+03  3.03051918e+03
  3.03051918e+03  6.65125915e+03  6.65125915e+03  6.65125915e+03
  9.03470462e+03  2.53922091e+04  7.61364975e+04]
E1 = -728.2930714697984  E_coul = 201.8152212555658
cycle= 5 E= -526.477850214233  delta_E= -1.62e-10  |g|= 7.24e-06  |ddm|= 2.55e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.2930714697984  E_coul = 201.8152212555658
  HOMO = -0.572508494482586  LUMO = 1.01755139126804
  mo_energy =
[-1.18561526e+02 -1.21869948e+01 -9.53851113e+00 -9.53851113e+00
 -9.53851113e+00 -1.24973504e+00 -5.72508494e-01 -5.72508494e-01
 -5.72508494e-01  1.01755139e+00  1.01755139e+00  1.01755139e+00
  7.28939073e+00  7.28939073e+00  7.28939073e+00  3.34195041e+01
  3.34195041e+01  3.34195041e+01  7.44168737e+01  1.29050308e+02
  1.29050308e+02  1.29050308e+02  4.83585400e+02  4.83585400e+02
  4.83585400e+02  5.57102314e+02  1.33580238e+03  1.33580238e+03
  1.33580238e+03  2.62700829e+03  3.03051917e+03  3.03051917e+03
  3.03051917e+03  6.65125913e+03  6.65125913e+03  6.65125913e+03
  9.03470460e+03  2.53922091e+04  7.61364975e+04]
E1 = -728.2931064337307  E_coul = 201.81525621949487
Extra cycle  E= -526.477850214236  delta_E= -3.18e-12  |g|= 1.87e-06  |ddm|= 3.65e-06
    CPU time for scf_cycle      0.66 sec, wall time      0.27 sec
exp = [2.61826436e+04 7.61755224e+03 3.61734764e+03 1.59850422e+03
 3.81787492e+02 1.07760433e+02 3.46956799e+01 4.58480889e+00
 3.95131833e-01 1.36277969e+03 6.64782643e+02 3.01138321e+02
 3.14195101e+02 6.16674210e+01 7.33032129e+00 2.02494484e+01
 7.71923912e-01 2.81441381e+00 2.22303723e-01]
E = -526.4778502142358
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:46:38 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6436388        1
[INPUT] 0    0    [1    /1   ]  7617.5522416         1
[INPUT] 0    0    [1    /1   ]  3617.34764099        1
[INPUT] 0    0    [1    /1   ]  1598.50421539        1
[INPUT] 0    0    [1    /1   ]  381.7874918          1
[INPUT] 0    0    [1    /1   ]  107.760433217        1
[INPUT] 0    0    [1    /1   ]  34.6956798778        1
[INPUT] 0    0    [1    /1   ]  4.5848088949         1
[INPUT] 0    0    [1    /1   ]  0.39513183329        1
[INPUT] 1    0    [1    /1   ]  1362.77969157        1
[INPUT] 1    0    [1    /1   ]  664.78264253         1
[INPUT] 1    0    [1    /1   ]  301.138321452        1
[INPUT] 1    0    [1    /1   ]  314.195100776        1
[INPUT] 1    0    [1    /1   ]  61.6674210141        1
[INPUT] 1    0    [1    /1   ]  7.33032129099        1
[INPUT] 1    0    [1    /1   ]  20.249448397         1
[INPUT] 1    0    [1    /1   ]  0.771923912059       1
[INPUT] 1    0    [1    /1   ]  2.81441380928        1
[INPUT] 1    0    [1    /1   ]  0.2223037227         1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.643638847785, 1.0]], [0, [7617.5522415972955, 1.0]], [0, [3617.3476409877594, 1.0]], [0, [1598.504215389275, 1.0]], [0, [381.7874917996479, 1.0]], [0, [107.76043321651605, 1.0]], [0, [34.69567987783957, 1.0]], [0, [4.584808894897402, 1.0]], [0, [0.3951318332900063, 1.0]], [1, [1362.77969157124, 1.0]], [1, [664.7826425300175, 1.0]], [1, [301.1383214515867, 1.0]], [1, [314.19510077572534, 1.0]], [1, [61.66742101413339, 1.0]], [1, [7.3303212909899935, 1.0]], [1, [20.24944839697969, 1.0]], [1, [0.7719239120593303, 1.0]], [1, [2.8144138092810618, 1.0]], [1, [0.22230372270040727, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.64363885]
bas 1, expnt(s) = [7617.5522416]
bas 2, expnt(s) = [3617.34764099]
bas 3, expnt(s) = [1598.50421539]
bas 4, expnt(s) = [381.7874918]
bas 5, expnt(s) = [107.76043322]
bas 6, expnt(s) = [34.69567988]
bas 7, expnt(s) = [4.58480889]
bas 8, expnt(s) = [0.39513183]
bas 9, expnt(s) = [1362.77969157]
bas 10, expnt(s) = [664.78264253]
bas 11, expnt(s) = [301.13832145]
bas 12, expnt(s) = [314.19510078]
bas 13, expnt(s) = [61.66742101]
bas 14, expnt(s) = [7.33032129]
bas 15, expnt(s) = [20.2494484]
bas 16, expnt(s) = [0.77192391]
bas 17, expnt(s) = [2.81441381]
bas 18, expnt(s) = [0.22230372]
CPU time:       882.63
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826436e+04 5.20026105e+03 7.61755224e+03 2.06004452e+03
 3.61734764e+03 1.17844064e+03 1.59850422e+03 6.38705070e+02
 3.81787492e+02 2.18213340e+02 1.07760433e+02 8.45005471e+01
 3.46956799e+01 3.61178239e+01 4.58480889e+00 7.91600305e+00
 3.95131833e-01 1.25913280e+00 1.36277969e+03 2.41555238e+04
 6.64782643e+02 9.84768123e+03 3.01138321e+02 3.65966999e+03
 3.14195101e+02 3.85907886e+03 6.16674210e+01 5.04143446e+02
 7.33032129e+00 3.51874792e+01 2.02494484e+01 1.25314374e+02
 7.71923912e-01 2.11082637e+00 2.81441381e+00 1.06345553e+01
 2.22303723e-01 4.45315500e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97691557327574
cond(S) = 100510.8652640161
E1 = -728.8835359469703  E_coul = 203.1213382246889
init E= -525.762197722281
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559460805419987  LUMO = 1.02482469727385
  mo_energy =
[-1.18319498e+02 -1.21035275e+01 -9.44893108e+00 -9.44893108e+00
 -9.44893108e+00 -1.23009689e+00 -5.59460805e-01 -5.59460805e-01
 -5.59460805e-01  1.02482470e+00  1.02482470e+00  1.02482470e+00
  7.33768189e+00  7.33768189e+00  7.33768189e+00  3.35173463e+01
  3.35173463e+01  3.35173463e+01  7.45561262e+01  1.29214606e+02
  1.29214606e+02  1.29214606e+02  4.83822517e+02  4.83822517e+02
  4.83822517e+02  5.57378491e+02  1.33609595e+03  1.33609595e+03
  1.33609595e+03  2.62743600e+03  3.03087822e+03  3.03087822e+03
  3.03087822e+03  6.65173187e+03  6.65173187e+03  6.65173187e+03
  9.03525341e+03  2.53928525e+04  7.61372314e+04]
E1 = -728.037447654299  E_coul = 201.56000640505064
cycle= 1 E= -526.477441249248  delta_E= -0.715  |g|= 0.185  |ddm|= 0.37
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.546294
diis-c [-0.29843675  1.        ]
  HOMO = -0.575781568740725  LUMO = 1.01502659064797
  mo_energy =
[-1.18600321e+02 -1.22054267e+01 -9.55725595e+00 -9.55725595e+00
 -9.55725595e+00 -1.25409704e+00 -5.75781569e-01 -5.75781569e-01
 -5.75781569e-01  1.01502659e+00  1.01502659e+00  1.01502659e+00
  7.27947164e+00  7.27947164e+00  7.27947164e+00  3.34000725e+01
  3.34000725e+01  3.34000725e+01  7.43859083e+01  1.29019943e+02
  1.29019943e+02  1.29019943e+02  4.83547123e+02  4.83547123e+02
  4.83547123e+02  5.57062225e+02  1.33576130e+03  1.33576130e+03
  1.33576130e+03  2.62696538e+03  3.03047674e+03  3.03047674e+03
  3.03047674e+03  6.65121595e+03  6.65121595e+03  6.65121595e+03
  9.03466115e+03  2.53921656e+04  7.61364540e+04]
E1 = -728.3493846987373  E_coul = 201.87154917616658
cycle= 2 E= -526.477835522571  delta_E= -0.000394  |g|= 0.025  |ddm|= 0.0215
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0488176
diis-c [-0.00151976  0.05116553  0.94883447]
  HOMO = -0.571826324425691  LUMO = 1.01806030242026
  mo_energy =
[-1.18556180e+02 -1.21840972e+01 -9.53550561e+00 -9.53550561e+00
 -9.53550561e+00 -1.24885070e+00 -5.71826324e-01 -5.71826324e-01
 -5.71826324e-01  1.01806030e+00  1.01806030e+00  1.01806030e+00
  7.29118215e+00  7.29118215e+00  7.29118215e+00  3.34225662e+01
  3.34225662e+01  3.34225662e+01  7.44211521e+01  1.29054660e+02
  1.29054660e+02  1.29054660e+02  4.83590673e+02  4.83590673e+02
  4.83590673e+02  5.57107842e+02  1.33580803e+03  1.33580803e+03
  1.33580803e+03  2.62701435e+03  3.03052507e+03  3.03052507e+03
  3.03052507e+03  6.65126529e+03  6.65126529e+03  6.65126529e+03
  9.03471090e+03  2.53922155e+04  7.61365040e+04]
E1 = -728.284477617203  E_coul = 201.80662772363186
cycle= 3 E= -526.477849893571  delta_E= -1.44e-05  |g|= 0.00307  |ddm|= 0.00548
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00660067
diis-c [-3.73469521e-07 -1.08313096e-03  1.12604433e-01  8.88478698e-01]
  HOMO = -0.572533549016399  LUMO = 1.0175331560164
  mo_energy =
[-1.18561609e+02 -1.21870750e+01 -9.53859014e+00 -9.53859014e+00
 -9.53859014e+00 -1.24976763e+00 -5.72533549e-01 -5.72533549e-01
 -5.72533549e-01  1.01753316e+00  1.01753316e+00  1.01753316e+00
  7.28933395e+00  7.28933395e+00  7.28933395e+00  3.34194281e+01
  3.34194281e+01  3.34194281e+01  7.44167862e+01  1.29050225e+02
  1.29050225e+02  1.29050225e+02  4.83585317e+02  4.83585317e+02
  4.83585317e+02  5.57102235e+02  1.33580230e+03  1.33580230e+03
  1.33580230e+03  2.62700821e+03  3.03051909e+03  3.03051909e+03
  3.03051909e+03  6.65125907e+03  6.65125907e+03  6.65125907e+03
  9.03470454e+03  2.53922091e+04  7.61364974e+04]
E1 = -728.2932969243732  E_coul = 201.815446710303
cycle= 4 E= -526.47785021407  delta_E= -3.2e-07  |g|= 4.59e-05  |ddm|= 0.000802
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.33001e-05
diis-c [-1.93718347e-09  1.14567466e-06 -1.09583893e-03 -1.26041889e-03
  1.00235511e+00]
  HOMO = -0.572504691733174  LUMO = 1.01755416945652
  mo_energy =
[-1.18561508e+02 -1.21869817e+01 -9.53849778e+00 -9.53849778e+00
 -9.53849778e+00 -1.24973012e+00 -5.72504692e-01 -5.72504692e-01
 -5.72504692e-01  1.01755417e+00  1.01755417e+00  1.01755417e+00
  7.28939972e+00  7.28939972e+00  7.28939972e+00  3.34195173e+01
  3.34195173e+01  3.34195173e+01  7.44168897e+01  1.29050324e+02
  1.29050324e+02  1.29050324e+02  4.83585418e+02  4.83585418e+02
  4.83585418e+02  5.57102333e+02  1.33580239e+03  1.33580239e+03
  1.33580239e+03  2.62700830e+03  3.03051918e+03  3.03051918e+03
  3.03051918e+03  6.65125915e+03  6.65125915e+03  6.65125915e+03
  9.03470462e+03  2.53922091e+04  7.61364975e+04]
E1 = -728.2930714697984  E_coul = 201.8152212555658
cycle= 5 E= -526.477850214233  delta_E= -1.62e-10  |g|= 7.24e-06  |ddm|= 2.55e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.2930714697984  E_coul = 201.8152212555658
  HOMO = -0.572508494482586  LUMO = 1.01755139126804
  mo_energy =
[-1.18561526e+02 -1.21869948e+01 -9.53851113e+00 -9.53851113e+00
 -9.53851113e+00 -1.24973504e+00 -5.72508494e-01 -5.72508494e-01
 -5.72508494e-01  1.01755139e+00  1.01755139e+00  1.01755139e+00
  7.28939073e+00  7.28939073e+00  7.28939073e+00  3.34195041e+01
  3.34195041e+01  3.34195041e+01  7.44168737e+01  1.29050308e+02
  1.29050308e+02  1.29050308e+02  4.83585400e+02  4.83585400e+02
  4.83585400e+02  5.57102314e+02  1.33580238e+03  1.33580238e+03
  1.33580238e+03  2.62700829e+03  3.03051917e+03  3.03051917e+03
  3.03051917e+03  6.65125913e+03  6.65125913e+03  6.65125913e+03
  9.03470460e+03  2.53922091e+04  7.61364975e+04]
E1 = -728.2931064337307  E_coul = 201.81525621949487
Extra cycle  E= -526.477850214236  delta_E= -3.18e-12  |g|= 1.87e-06  |ddm|= 3.65e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 100510.8652640161
E1 = -728.2931064337307  E_coul = 201.81525621949487
init E= -526.477850214236
    CPU time for initialize scf      2.72 sec, wall time      0.25 sec
  HOMO = -0.572507831075001  LUMO = 1.01755188191674
  mo_energy =
[-1.18561522e+02 -1.21869922e+01 -9.53850850e+00 -9.53850850e+00
 -9.53850850e+00 -1.24973418e+00 -5.72507831e-01 -5.72507831e-01
 -5.72507831e-01  1.01755188e+00  1.01755188e+00  1.01755188e+00
  7.28939239e+00  7.28939239e+00  7.28939239e+00  3.34195067e+01
  3.34195067e+01  3.34195067e+01  7.44168773e+01  1.29050311e+02
  1.29050311e+02  1.29050311e+02  4.83585404e+02  4.83585404e+02
  4.83585404e+02  5.57102319e+02  1.33580238e+03  1.33580238e+03
  1.33580238e+03  2.62700829e+03  3.03051917e+03  3.03051917e+03
  3.03051917e+03  6.65125914e+03  6.65125914e+03  6.65125914e+03
  9.03470461e+03  2.53922091e+04  7.61364975e+04]
E1 = -728.293099213597  E_coul = 201.81524899936053
cycle= 1 E= -526.477850214236  delta_E= -6.82e-13  |g|= 4.22e-07  |ddm|= 6.95e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.293099213597  E_coul = 201.81524899936053
  HOMO = -0.572507960064242  LUMO = 1.01755178606142
  mo_energy =
[-1.18561523e+02 -1.21869928e+01 -9.53850904e+00 -9.53850904e+00
 -9.53850904e+00 -1.24973435e+00 -5.72507960e-01 -5.72507960e-01
 -5.72507960e-01  1.01755179e+00  1.01755179e+00  1.01755179e+00
  7.28939206e+00  7.28939206e+00  7.28939206e+00  3.34195062e+01
  3.34195062e+01  3.34195062e+01  7.44168765e+01  1.29050310e+02
  1.29050310e+02  1.29050310e+02  4.83585403e+02  4.83585403e+02
  4.83585403e+02  5.57102318e+02  1.33580238e+03  1.33580238e+03
  1.33580238e+03  2.62700829e+03  3.03051917e+03  3.03051917e+03
  3.03051917e+03  6.65125914e+03  6.65125914e+03  6.65125914e+03
  9.03470461e+03  2.53922091e+04  7.61364975e+04]
E1 = -728.2931007275266  E_coul = 201.81525051329146
Extra cycle  E= -526.477850214235  delta_E= 1.36e-12  |g|= 9.13e-08  |ddm|= 1.42e-07
    CPU time for scf_cycle      2.84 sec, wall time      0.37 sec
exp = [2.61826436e+04 7.61755224e+03 3.61734764e+03 1.59850422e+03
 3.81787492e+02 1.07760433e+02 3.46956799e+01 4.58480889e+00
 3.95131833e-01 1.36277969e+03 6.64782643e+02 3.01138321e+02
 3.14195101e+02 6.16674210e+01 7.33032129e+00 2.02494484e+01
 7.71923912e-01 2.81441381e+00 2.22303723e-01]
grad_E = [-1.51727344e-06  3.36492785e-06 -1.39761282e-06  7.07746960e-05
  1.14551228e-05 -1.63663418e-06  1.95187118e-05  1.02295864e-05
  1.45823796e-04 -5.08420234e-07  4.97756998e-06  2.34369497e-05
  2.02141520e-05 -1.00728965e-05  5.04873458e-05 -1.59411231e-05
 -7.90392424e-05 -7.35504584e-05  3.99198030e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:46:42 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6443392        1
[INPUT] 0    0    [1    /1   ]  7617.55021061        1
[INPUT] 0    0    [1    /1   ]  3617.34708345        1
[INPUT] 0    0    [1    /1   ]  1598.45546581        1
[INPUT] 0    0    [1    /1   ]  381.954173393        1
[INPUT] 0    0    [1    /1   ]  107.816367562        1
[INPUT] 0    0    [1    /1   ]  34.7126915415        1
[INPUT] 0    0    [1    /1   ]  4.58487557254        1
[INPUT] 0    0    [1    /1   ]  0.395159396167       1
[INPUT] 1    0    [1    /1   ]  1362.77984486        1
[INPUT] 1    0    [1    /1   ]  664.780688856        1
[INPUT] 1    0    [1    /1   ]  301.128773734        1
[INPUT] 1    0    [1    /1   ]  314.186763576        1
[INPUT] 1    0    [1    /1   ]  61.6625767082        1
[INPUT] 1    0    [1    /1   ]  7.33041907555        1
[INPUT] 1    0    [1    /1   ]  20.2484360778        1
[INPUT] 1    0    [1    /1   ]  0.771950560114       1
[INPUT] 1    0    [1    /1   ]  2.81362451313        1
[INPUT] 1    0    [1    /1   ]  0.222345458094       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.64433917677, 1.0]], [0, [7617.550210612153, 1.0]], [0, [3617.3470834453055, 1.0]], [0, [1598.455465808256, 1.0]], [0, [381.9541733934535, 1.0]], [0, [107.81636756172212, 1.0]], [0, [34.71269154152245, 1.0]], [0, [4.584875572543589, 1.0]], [0, [0.3951593961674389, 1.0]], [1, [1362.7798448641965, 1.0]], [1, [664.7806888561217, 1.0]], [1, [301.1287737344687, 1.0]], [1, [314.1867635756343, 1.0]], [1, [61.66257670818838, 1.0]], [1, [7.330419075545799, 1.0]], [1, [20.248436077818607, 1.0]], [1, [0.7719505601142724, 1.0]], [1, [2.813624513131029, 1.0]], [1, [0.22234545809437944, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.64433918]
bas 1, expnt(s) = [7617.55021061]
bas 2, expnt(s) = [3617.34708345]
bas 3, expnt(s) = [1598.45546581]
bas 4, expnt(s) = [381.95417339]
bas 5, expnt(s) = [107.81636756]
bas 6, expnt(s) = [34.71269154]
bas 7, expnt(s) = [4.58487557]
bas 8, expnt(s) = [0.3951594]
bas 9, expnt(s) = [1362.77984486]
bas 10, expnt(s) = [664.78068886]
bas 11, expnt(s) = [301.12877373]
bas 12, expnt(s) = [314.18676358]
bas 13, expnt(s) = [61.66257671]
bas 14, expnt(s) = [7.33041908]
bas 15, expnt(s) = [20.24843608]
bas 16, expnt(s) = [0.77195056]
bas 17, expnt(s) = [2.81362451]
bas 18, expnt(s) = [0.22234546]
CPU time:       890.91
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826443e+04 5.20026115e+03 7.61755021e+03 2.06004410e+03
 3.61734708e+03 1.17844050e+03 1.59845547e+03 6.38690461e+02
 3.81954173e+02 2.18284787e+02 1.07816368e+02 8.45334407e+01
 3.47126915e+01 3.61311048e+01 4.58487557e+00 7.91608939e+00
 3.95159396e-01 1.25919868e+00 1.36277984e+03 2.41555272e+04
 6.64780689e+02 9.84764505e+03 3.01128774e+02 3.65952495e+03
 3.14186764e+02 3.85895086e+03 6.16625767e+01 5.04093942e+02
 7.33041908e+00 3.51880659e+01 2.02484361e+01 1.25306543e+02
 7.71950560e-01 2.11091745e+00 2.81362451e+00 1.06308274e+01
 2.22345458e-01 4.45420007e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.976906506523836
cond(S) = 100479.57160613021
E1 = -728.8838493423424  E_coul = 203.12177239765626
init E= -525.762076944686
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559447936046482  LUMO = 1.02500581778585
  mo_energy =
[-1.18319450e+02 -1.21035131e+01 -9.44889545e+00 -9.44889545e+00
 -9.44889545e+00 -1.23008803e+00 -5.59447936e-01 -5.59447936e-01
 -5.59447936e-01  1.02500582e+00  1.02500582e+00  1.02500582e+00
  7.33666586e+00  7.33666586e+00  7.33666586e+00  3.35143470e+01
  3.35143470e+01  3.35143470e+01  7.46117861e+01  1.29204985e+02
  1.29204985e+02  1.29204985e+02  4.83797345e+02  4.83797345e+02
  4.83797345e+02  5.57699262e+02  1.33604924e+03  1.33604924e+03
  1.33604924e+03  2.62811465e+03  3.03080610e+03  3.03080610e+03
  3.03080610e+03  6.65164430e+03  6.65164430e+03  6.65164430e+03
  9.03599425e+03  2.53935469e+04  7.61378653e+04]
E1 = -728.0386605875066  E_coul = 201.56121772562798
cycle= 1 E= -526.477442861879  delta_E= -0.715  |g|= 0.185  |ddm|= 0.37
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.546177
diis-c [-0.29830973  1.        ]
  HOMO = -0.575745251281225  LUMO = 1.01522472605744
  mo_energy =
[-1.18600189e+02 -1.22053671e+01 -9.55716541e+00 -9.55716541e+00
 -9.55716541e+00 -1.25406389e+00 -5.75745251e-01 -5.75745251e-01
 -5.75745251e-01  1.01522473e+00  1.01522473e+00  1.01522473e+00
  7.27850342e+00  7.27850342e+00  7.27850342e+00  3.33971337e+01
  3.33971337e+01  3.33971337e+01  7.44415911e+01  1.29010396e+02
  1.29010396e+02  1.29010396e+02  4.83522047e+02  4.83522047e+02
  4.83522047e+02  5.57383057e+02  1.33571471e+03  1.33571471e+03
  1.33571471e+03  2.62764415e+03  3.03040475e+03  3.03040475e+03
  3.03040475e+03  6.65112853e+03  6.65112853e+03  6.65112853e+03
  9.03540215e+03  2.53928602e+04  7.61370880e+04]
E1 = -728.3503679788043  E_coul = 201.87253128412
cycle= 2 E= -526.477836694684  delta_E= -0.000394  |g|= 0.025  |ddm|= 0.0215
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0487878
diis-c [-0.00151851  0.05112926  0.94887074]
  HOMO = -0.571793516139218  LUMO = 1.01825601406755
  mo_energy =
[-1.18556074e+02 -1.21840528e+01 -9.53543063e+00 -9.53543063e+00
 -9.53543063e+00 -1.24882195e+00 -5.71793516e-01 -5.71793516e-01
 -5.71793516e-01  1.01825601e+00  1.01825601e+00  1.01825601e+00
  7.29020333e+00  7.29020333e+00  7.29020333e+00  3.34196113e+01
  3.34196113e+01  3.34196113e+01  7.44768195e+01  1.29045090e+02
  1.29045090e+02  1.29045090e+02  4.83565571e+02  4.83565571e+02
  4.83565571e+02  5.57428649e+02  1.33576141e+03  1.33576141e+03
  1.33576141e+03  2.62769310e+03  3.03045305e+03  3.03045305e+03
  3.03045305e+03  6.65117784e+03  6.65117784e+03  6.65117784e+03
  9.03545187e+03  2.53929101e+04  7.61371379e+04]
E1 = -728.2855110044844  E_coul = 201.8076599597389
cycle= 3 E= -526.477851044746  delta_E= -1.44e-05  |g|= 0.00307  |ddm|= 0.00548
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00659713
diis-c [-3.72773738e-07 -1.08258461e-03  1.12615243e-01  8.88467342e-01]
  HOMO = -0.572500249399358  LUMO = 1.01772919314814
  mo_energy =
[-1.18561501e+02 -1.21870291e+01 -9.53851354e+00 -9.53851354e+00
 -9.53851354e+00 -1.24973830e+00 -5.72500249e-01 -5.72500249e-01
 -5.72500249e-01  1.01772919e+00  1.01772919e+00  1.01772919e+00
  7.28835641e+00  7.28835641e+00  7.28835641e+00  3.34164749e+01
  3.34164749e+01  3.34164749e+01  7.44724548e+01  1.29040657e+02
  1.29040657e+02  1.29040657e+02  4.83560218e+02  4.83560218e+02
  4.83560218e+02  5.57423044e+02  1.33575568e+03  1.33575568e+03
  1.33575568e+03  2.62768696e+03  3.03044707e+03  3.03044707e+03
  3.03044707e+03  6.65117162e+03  6.65117162e+03  6.65117162e+03
  9.03544551e+03  2.53929036e+04  7.61371314e+04]
E1 = -728.2943246794055  E_coul = 201.81647331454323
cycle= 4 E= -526.477851364862  delta_E= -3.2e-07  |g|= 4.58e-05  |ddm|= 0.000802
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=6.33035e-05
diis-c [-1.93395025e-09  1.10562674e-06 -1.09023745e-03 -1.20657197e-03
  1.00229570e+00]
  HOMO = -0.572471405640072  LUMO = 1.01775019818815
  mo_energy =
[-1.18561400e+02 -1.21869359e+01 -9.53842121e+00 -9.53842121e+00
 -9.53842121e+00 -1.24970081e+00 -5.72471406e-01 -5.72471406e-01
 -5.72471406e-01  1.01775020e+00  1.01775020e+00  1.01775020e+00
  7.28842215e+00  7.28842215e+00  7.28842215e+00  3.34165640e+01
  3.34165640e+01  3.34165640e+01  7.44725583e+01  1.29040756e+02
  1.29040756e+02  1.29040756e+02  4.83560318e+02  4.83560318e+02
  4.83560318e+02  5.57423142e+02  1.33575577e+03  1.33575577e+03
  1.33575577e+03  2.62768705e+03  3.03044716e+03  3.03044716e+03
  3.03044716e+03  6.65117170e+03  6.65117170e+03  6.65117170e+03
  9.03544560e+03  2.53929037e+04  7.61371315e+04]
E1 = -728.2940993401784  E_coul = 201.81624797515212
cycle= 5 E= -526.477851365026  delta_E= -1.64e-10  |g|= 7.23e-06  |ddm|= 2.55e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.2940993401784  E_coul = 201.81624797515212
  HOMO = -0.572475203166025  LUMO = 1.01774742363578
  mo_energy =
[-1.18561418e+02 -1.21869490e+01 -9.53843455e+00 -9.53843455e+00
 -9.53843455e+00 -1.24970573e+00 -5.72475203e-01 -5.72475203e-01
 -5.72475203e-01  1.01774742e+00  1.01774742e+00  1.01774742e+00
  7.28841317e+00  7.28841317e+00  7.28841317e+00  3.34165509e+01
  3.34165509e+01  3.34165509e+01  7.44725424e+01  1.29040740e+02
  1.29040740e+02  1.29040740e+02  4.83560300e+02  4.83560300e+02
  4.83560300e+02  5.57423124e+02  1.33575576e+03  1.33575576e+03
  1.33575576e+03  2.62768703e+03  3.03044715e+03  3.03044715e+03
  3.03044715e+03  6.65117168e+03  6.65117168e+03  6.65117168e+03
  9.03544558e+03  2.53929037e+04  7.61371314e+04]
E1 = -728.2941342546723  E_coul = 201.81628288964183
Extra cycle  E= -526.47785136503  delta_E= -4.21e-12  |g|= 1.87e-06  |ddm|= 3.65e-06
    CPU time for scf_cycle      0.66 sec, wall time      0.28 sec
exp = [2.61826443e+04 7.61755021e+03 3.61734708e+03 1.59845547e+03
 3.81954173e+02 1.07816368e+02 3.47126915e+01 4.58487557e+00
 3.95159396e-01 1.36277984e+03 6.64780689e+02 3.01128774e+02
 3.14186764e+02 6.16625767e+01 7.33041908e+00 2.02484361e+01
 7.71950560e-01 2.81362451e+00 2.22345458e-01]
E = -526.4778513650305
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:46:43 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6443392        1
[INPUT] 0    0    [1    /1   ]  7617.55021061        1
[INPUT] 0    0    [1    /1   ]  3617.34708345        1
[INPUT] 0    0    [1    /1   ]  1598.45546581        1
[INPUT] 0    0    [1    /1   ]  381.954173393        1
[INPUT] 0    0    [1    /1   ]  107.816367562        1
[INPUT] 0    0    [1    /1   ]  34.7126915415        1
[INPUT] 0    0    [1    /1   ]  4.58487557254        1
[INPUT] 0    0    [1    /1   ]  0.395159396167       1
[INPUT] 1    0    [1    /1   ]  1362.77984486        1
[INPUT] 1    0    [1    /1   ]  664.780688856        1
[INPUT] 1    0    [1    /1   ]  301.128773734        1
[INPUT] 1    0    [1    /1   ]  314.186763576        1
[INPUT] 1    0    [1    /1   ]  61.6625767082        1
[INPUT] 1    0    [1    /1   ]  7.33041907555        1
[INPUT] 1    0    [1    /1   ]  20.2484360778        1
[INPUT] 1    0    [1    /1   ]  0.771950560114       1
[INPUT] 1    0    [1    /1   ]  2.81362451313        1
[INPUT] 1    0    [1    /1   ]  0.222345458094       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.64433917677, 1.0]], [0, [7617.550210612153, 1.0]], [0, [3617.3470834453055, 1.0]], [0, [1598.455465808256, 1.0]], [0, [381.9541733934535, 1.0]], [0, [107.81636756172212, 1.0]], [0, [34.71269154152245, 1.0]], [0, [4.584875572543589, 1.0]], [0, [0.3951593961674389, 1.0]], [1, [1362.7798448641965, 1.0]], [1, [664.7806888561217, 1.0]], [1, [301.1287737344687, 1.0]], [1, [314.1867635756343, 1.0]], [1, [61.66257670818838, 1.0]], [1, [7.330419075545799, 1.0]], [1, [20.248436077818607, 1.0]], [1, [0.7719505601142724, 1.0]], [1, [2.813624513131029, 1.0]], [1, [0.22234545809437944, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.64433918]
bas 1, expnt(s) = [7617.55021061]
bas 2, expnt(s) = [3617.34708345]
bas 3, expnt(s) = [1598.45546581]
bas 4, expnt(s) = [381.95417339]
bas 5, expnt(s) = [107.81636756]
bas 6, expnt(s) = [34.71269154]
bas 7, expnt(s) = [4.58487557]
bas 8, expnt(s) = [0.3951594]
bas 9, expnt(s) = [1362.77984486]
bas 10, expnt(s) = [664.78068886]
bas 11, expnt(s) = [301.12877373]
bas 12, expnt(s) = [314.18676358]
bas 13, expnt(s) = [61.66257671]
bas 14, expnt(s) = [7.33041908]
bas 15, expnt(s) = [20.24843608]
bas 16, expnt(s) = [0.77195056]
bas 17, expnt(s) = [2.81362451]
bas 18, expnt(s) = [0.22234546]
CPU time:       891.92
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826443e+04 5.20026115e+03 7.61755021e+03 2.06004410e+03
 3.61734708e+03 1.17844050e+03 1.59845547e+03 6.38690461e+02
 3.81954173e+02 2.18284787e+02 1.07816368e+02 8.45334407e+01
 3.47126915e+01 3.61311048e+01 4.58487557e+00 7.91608939e+00
 3.95159396e-01 1.25919868e+00 1.36277984e+03 2.41555272e+04
 6.64780689e+02 9.84764505e+03 3.01128774e+02 3.65952495e+03
 3.14186764e+02 3.85895086e+03 6.16625767e+01 5.04093942e+02
 7.33041908e+00 3.51880659e+01 2.02484361e+01 1.25306543e+02
 7.71950560e-01 2.11091745e+00 2.81362451e+00 1.06308274e+01
 2.22345458e-01 4.45420007e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.976906506523836
cond(S) = 100479.57160613021
E1 = -728.8838493423424  E_coul = 203.12177239765626
init E= -525.762076944686
    CPU time for initialize scf      0.45 sec, wall time      0.06 sec
  HOMO = -0.559447936046482  LUMO = 1.02500581778585
  mo_energy =
[-1.18319450e+02 -1.21035131e+01 -9.44889545e+00 -9.44889545e+00
 -9.44889545e+00 -1.23008803e+00 -5.59447936e-01 -5.59447936e-01
 -5.59447936e-01  1.02500582e+00  1.02500582e+00  1.02500582e+00
  7.33666586e+00  7.33666586e+00  7.33666586e+00  3.35143470e+01
  3.35143470e+01  3.35143470e+01  7.46117861e+01  1.29204985e+02
  1.29204985e+02  1.29204985e+02  4.83797345e+02  4.83797345e+02
  4.83797345e+02  5.57699262e+02  1.33604924e+03  1.33604924e+03
  1.33604924e+03  2.62811465e+03  3.03080610e+03  3.03080610e+03
  3.03080610e+03  6.65164430e+03  6.65164430e+03  6.65164430e+03
  9.03599425e+03  2.53935469e+04  7.61378653e+04]
E1 = -728.0386605875066  E_coul = 201.56121772562798
cycle= 1 E= -526.477442861879  delta_E= -0.715  |g|= 0.185  |ddm|= 0.37
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.546177
diis-c [-0.29830973  1.        ]
  HOMO = -0.575745251281225  LUMO = 1.01522472605744
  mo_energy =
[-1.18600189e+02 -1.22053671e+01 -9.55716541e+00 -9.55716541e+00
 -9.55716541e+00 -1.25406389e+00 -5.75745251e-01 -5.75745251e-01
 -5.75745251e-01  1.01522473e+00  1.01522473e+00  1.01522473e+00
  7.27850342e+00  7.27850342e+00  7.27850342e+00  3.33971337e+01
  3.33971337e+01  3.33971337e+01  7.44415911e+01  1.29010396e+02
  1.29010396e+02  1.29010396e+02  4.83522047e+02  4.83522047e+02
  4.83522047e+02  5.57383057e+02  1.33571471e+03  1.33571471e+03
  1.33571471e+03  2.62764415e+03  3.03040475e+03  3.03040475e+03
  3.03040475e+03  6.65112853e+03  6.65112853e+03  6.65112853e+03
  9.03540215e+03  2.53928602e+04  7.61370880e+04]
E1 = -728.3503679788043  E_coul = 201.87253128412
cycle= 2 E= -526.477836694684  delta_E= -0.000394  |g|= 0.025  |ddm|= 0.0215
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0487878
diis-c [-0.00151851  0.05112926  0.94887074]
  HOMO = -0.571793516139218  LUMO = 1.01825601406755
  mo_energy =
[-1.18556074e+02 -1.21840528e+01 -9.53543063e+00 -9.53543063e+00
 -9.53543063e+00 -1.24882195e+00 -5.71793516e-01 -5.71793516e-01
 -5.71793516e-01  1.01825601e+00  1.01825601e+00  1.01825601e+00
  7.29020333e+00  7.29020333e+00  7.29020333e+00  3.34196113e+01
  3.34196113e+01  3.34196113e+01  7.44768195e+01  1.29045090e+02
  1.29045090e+02  1.29045090e+02  4.83565571e+02  4.83565571e+02
  4.83565571e+02  5.57428649e+02  1.33576141e+03  1.33576141e+03
  1.33576141e+03  2.62769310e+03  3.03045305e+03  3.03045305e+03
  3.03045305e+03  6.65117784e+03  6.65117784e+03  6.65117784e+03
  9.03545187e+03  2.53929101e+04  7.61371379e+04]
E1 = -728.2855110044844  E_coul = 201.8076599597389
cycle= 3 E= -526.477851044746  delta_E= -1.44e-05  |g|= 0.00307  |ddm|= 0.00548
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00659713
diis-c [-3.72773738e-07 -1.08258461e-03  1.12615243e-01  8.88467342e-01]
  HOMO = -0.572500249399358  LUMO = 1.01772919314814
  mo_energy =
[-1.18561501e+02 -1.21870291e+01 -9.53851354e+00 -9.53851354e+00
 -9.53851354e+00 -1.24973830e+00 -5.72500249e-01 -5.72500249e-01
 -5.72500249e-01  1.01772919e+00  1.01772919e+00  1.01772919e+00
  7.28835641e+00  7.28835641e+00  7.28835641e+00  3.34164749e+01
  3.34164749e+01  3.34164749e+01  7.44724548e+01  1.29040657e+02
  1.29040657e+02  1.29040657e+02  4.83560218e+02  4.83560218e+02
  4.83560218e+02  5.57423044e+02  1.33575568e+03  1.33575568e+03
  1.33575568e+03  2.62768696e+03  3.03044707e+03  3.03044707e+03
  3.03044707e+03  6.65117162e+03  6.65117162e+03  6.65117162e+03
  9.03544551e+03  2.53929036e+04  7.61371314e+04]
E1 = -728.2943246794055  E_coul = 201.81647331454323
cycle= 4 E= -526.477851364862  delta_E= -3.2e-07  |g|= 4.58e-05  |ddm|= 0.000802
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.33035e-05
diis-c [-1.93395025e-09  1.10562674e-06 -1.09023745e-03 -1.20657197e-03
  1.00229570e+00]
  HOMO = -0.572471405640072  LUMO = 1.01775019818815
  mo_energy =
[-1.18561400e+02 -1.21869359e+01 -9.53842121e+00 -9.53842121e+00
 -9.53842121e+00 -1.24970081e+00 -5.72471406e-01 -5.72471406e-01
 -5.72471406e-01  1.01775020e+00  1.01775020e+00  1.01775020e+00
  7.28842215e+00  7.28842215e+00  7.28842215e+00  3.34165640e+01
  3.34165640e+01  3.34165640e+01  7.44725583e+01  1.29040756e+02
  1.29040756e+02  1.29040756e+02  4.83560318e+02  4.83560318e+02
  4.83560318e+02  5.57423142e+02  1.33575577e+03  1.33575577e+03
  1.33575577e+03  2.62768705e+03  3.03044716e+03  3.03044716e+03
  3.03044716e+03  6.65117170e+03  6.65117170e+03  6.65117170e+03
  9.03544560e+03  2.53929037e+04  7.61371315e+04]
E1 = -728.2940993401784  E_coul = 201.81624797515212
cycle= 5 E= -526.477851365026  delta_E= -1.64e-10  |g|= 7.23e-06  |ddm|= 2.55e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.2940993401784  E_coul = 201.81624797515212
  HOMO = -0.572475203166025  LUMO = 1.01774742363578
  mo_energy =
[-1.18561418e+02 -1.21869490e+01 -9.53843455e+00 -9.53843455e+00
 -9.53843455e+00 -1.24970573e+00 -5.72475203e-01 -5.72475203e-01
 -5.72475203e-01  1.01774742e+00  1.01774742e+00  1.01774742e+00
  7.28841317e+00  7.28841317e+00  7.28841317e+00  3.34165509e+01
  3.34165509e+01  3.34165509e+01  7.44725424e+01  1.29040740e+02
  1.29040740e+02  1.29040740e+02  4.83560300e+02  4.83560300e+02
  4.83560300e+02  5.57423124e+02  1.33575576e+03  1.33575576e+03
  1.33575576e+03  2.62768703e+03  3.03044715e+03  3.03044715e+03
  3.03044715e+03  6.65117168e+03  6.65117168e+03  6.65117168e+03
  9.03544558e+03  2.53929037e+04  7.61371314e+04]
E1 = -728.2941342546723  E_coul = 201.81628288964183
Extra cycle  E= -526.47785136503  delta_E= -4.21e-12  |g|= 1.87e-06  |ddm|= 3.65e-06
    CPU time for scf_cycle      0.65 sec, wall time      0.25 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 100479.57160613021
E1 = -728.2941342546723  E_coul = 201.81628288964183
init E= -526.47785136503
    CPU time for initialize scf      2.74 sec, wall time      0.26 sec
  HOMO = -0.572474540759671  LUMO = 1.01774791357876
  mo_energy =
[-1.18561414e+02 -1.21869464e+01 -9.53843192e+00 -9.53843192e+00
 -9.53843192e+00 -1.24970487e+00 -5.72474541e-01 -5.72474541e-01
 -5.72474541e-01  1.01774791e+00  1.01774791e+00  1.01774791e+00
  7.28841483e+00  7.28841483e+00  7.28841483e+00  3.34165535e+01
  3.34165535e+01  3.34165535e+01  7.44725459e+01  1.29040744e+02
  1.29040744e+02  1.29040744e+02  4.83560305e+02  4.83560305e+02
  4.83560305e+02  5.57423128e+02  1.33575576e+03  1.33575576e+03
  1.33575576e+03  2.62768704e+03  3.03044715e+03  3.03044715e+03
  3.03044715e+03  6.65117169e+03  6.65117169e+03  6.65117169e+03
  9.03544558e+03  2.53929037e+04  7.61371314e+04]
E1 = -728.2941270456497  E_coul = 201.81627568061913
cycle= 1 E= -526.477851365031  delta_E= -1.14e-13  |g|= 4.21e-07  |ddm|= 6.94e-07
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
E1 = -728.2941270456497  E_coul = 201.81627568061913
  HOMO = -0.572474669536949  LUMO = 1.01774781787404
  mo_energy =
[-1.18561415e+02 -1.21869469e+01 -9.53843246e+00 -9.53843246e+00
 -9.53843246e+00 -1.24970503e+00 -5.72474670e-01 -5.72474670e-01
 -5.72474670e-01  1.01774782e+00  1.01774782e+00  1.01774782e+00
  7.28841450e+00  7.28841450e+00  7.28841450e+00  3.34165530e+01
  3.34165530e+01  3.34165530e+01  7.44725451e+01  1.29040743e+02
  1.29040743e+02  1.29040743e+02  4.83560304e+02  4.83560304e+02
  4.83560304e+02  5.57423127e+02  1.33575576e+03  1.33575576e+03
  1.33575576e+03  2.62768704e+03  3.03044715e+03  3.03044715e+03
  3.03044715e+03  6.65117169e+03  6.65117169e+03  6.65117169e+03
  9.03544558e+03  2.53929037e+04  7.61371314e+04]
E1 = -728.2941285570776  E_coul = 201.81627719204724
Extra cycle  E= -526.47785136503  delta_E= 2.27e-13  |g|= 9.12e-08  |ddm|= 1.42e-07
    CPU time for scf_cycle      2.89 sec, wall time      0.42 sec
exp = [2.61826443e+04 7.61755021e+03 3.61734708e+03 1.59845547e+03
 3.81954173e+02 1.07816368e+02 3.47126915e+01 4.58487557e+00
 3.95159396e-01 1.36277984e+03 6.64780689e+02 3.01128774e+02
 3.14186764e+02 6.16625767e+01 7.33041908e+00 2.02484361e+01
 7.71950560e-01 2.81362451e+00 2.22345458e-01]
grad_E = [-1.51648560e-06  3.35615966e-06 -1.40437973e-06  7.05031329e-05
  1.37295715e-05 -1.15621273e-05  6.36630557e-05  2.74841965e-05
  5.48194396e-04 -5.08485286e-07  4.97694611e-06  2.34319646e-05
  2.02096807e-05 -7.55245018e-06  1.86287391e-04 -4.77346854e-05
 -2.67119890e-04 -2.69279268e-04  1.36124213e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:46:48 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.64532          1
[INPUT] 0    0    [1    /1   ]  7617.54760094        1
[INPUT] 0    0    [1    /1   ]  3617.34689849        1
[INPUT] 0    0    [1    /1   ]  1598.39509807        1
[INPUT] 0    0    [1    /1   ]  382.102809417        1
[INPUT] 0    0    [1    /1   ]  107.866296582        1
[INPUT] 0    0    [1    /1   ]  34.7278355854        1
[INPUT] 0    0    [1    /1   ]  4.58493321289        1
[INPUT] 0    0    [1    /1   ]  0.395184014202       1
[INPUT] 1    0    [1    /1   ]  1362.7800982         1
[INPUT] 1    0    [1    /1   ]  664.777820892        1
[INPUT] 1    0    [1    /1   ]  301.114955738        1
[INPUT] 1    0    [1    /1   ]  314.17475019         1
[INPUT] 1    0    [1    /1   ]  61.6575413412        1
[INPUT] 1    0    [1    /1   ]  7.33045695267        1
[INPUT] 1    0    [1    /1   ]  20.2473383511        1
[INPUT] 1    0    [1    /1   ]  0.77197376572        1
[INPUT] 1    0    [1    /1   ]  2.81290138669        1
[INPUT] 1    0    [1    /1   ]  0.222382938795       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.64531997614, 1.0]], [0, [7617.547600944543, 1.0]], [0, [3617.346898490411, 1.0]], [0, [1598.3950980722695, 1.0]], [0, [382.1028094169469, 1.0]], [0, [107.86629658187111, 1.0]], [0, [34.72783558535875, 1.0]], [0, [4.584933212885689, 1.0]], [0, [0.39518401420179566, 1.0]], [1, [1362.7800981989064, 1.0]], [1, [664.7778208915801, 1.0]], [1, [301.1149557382409, 1.0]], [1, [314.17475018983754, 1.0]], [1, [61.65754134117342, 1.0]], [1, [7.330456952669997, 1.0]], [1, [20.247338351129475, 1.0]], [1, [0.7719737657202486, 1.0]], [1, [2.8129013866871886, 1.0]], [1, [0.22238293879499008, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.64531998]
bas 1, expnt(s) = [7617.54760094]
bas 2, expnt(s) = [3617.34689849]
bas 3, expnt(s) = [1598.39509807]
bas 4, expnt(s) = [382.10280942]
bas 5, expnt(s) = [107.86629658]
bas 6, expnt(s) = [34.72783559]
bas 7, expnt(s) = [4.58493321]
bas 8, expnt(s) = [0.39518401]
bas 9, expnt(s) = [1362.7800982]
bas 10, expnt(s) = [664.77782089]
bas 11, expnt(s) = [301.11495574]
bas 12, expnt(s) = [314.17475019]
bas 13, expnt(s) = [61.65754134]
bas 14, expnt(s) = [7.33045695]
bas 15, expnt(s) = [20.24733835]
bas 16, expnt(s) = [0.77197377]
bas 17, expnt(s) = [2.81290139]
bas 18, expnt(s) = [0.22238294]
CPU time:       900.34
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826453e+04 5.20026130e+03 7.61754760e+03 2.06004357e+03
 3.61734690e+03 1.17844046e+03 1.59839510e+03 6.38672370e+02
 3.82102809e+02 2.18348492e+02 1.07866297e+02 8.45627992e+01
 3.47278356e+01 3.61429263e+01 4.58493321e+00 7.91616403e+00
 3.95184014e-01 1.25925751e+00 1.36278010e+03 2.41555328e+04
 6.64777821e+02 9.84759195e+03 3.01114956e+02 3.65931504e+03
 3.14174750e+02 3.85876642e+03 6.16575413e+01 5.04042487e+02
 7.33045695e+00 3.51882932e+01 2.02473384e+01 1.25298052e+02
 7.71973766e-01 2.11099677e+00 2.81290139e+00 1.06274122e+01
 2.22382939e-01 4.45513865e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97689839557547
cond(S) = 100433.12341103297
E1 = -728.8841254171631  E_coul = 203.1221581019934
init E= -525.76196731517
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559436455470021  LUMO = 1.02516769216289
  mo_energy =
[-1.18319408e+02 -1.21035003e+01 -9.44886383e+00 -9.44886383e+00
 -9.44886383e+00 -1.23008009e+00 -5.59436455e-01 -5.59436455e-01
 -5.59436455e-01  1.02516769e+00  1.02516769e+00  1.02516769e+00
  7.33571153e+00  7.33571153e+00  7.33571153e+00  3.35113527e+01
  3.35113527e+01  3.35113527e+01  7.46613798e+01  1.29194861e+02
  1.29194861e+02  1.29194861e+02  4.83768413e+02  4.83768413e+02
  4.83768413e+02  5.57985108e+02  1.33599014e+03  1.33599014e+03
  1.33599014e+03  2.62870969e+03  3.03071028e+03  3.03071028e+03
  3.03071028e+03  6.65152566e+03  6.65152566e+03  6.65152566e+03
  9.03661955e+03  2.53941110e+04  7.61383686e+04]
E1 = -728.0397461287247  E_coul = 201.56230111997542
cycle= 1 E= -526.477445008749  delta_E= -0.715  |g|= 0.185  |ddm|= 0.369
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.546075
diis-c [-0.29819739  1.        ]
  HOMO = -0.575712672449766  LUMO = 1.01540193270295
  mo_energy =
[-1.18600072e+02 -1.22053137e+01 -9.55708450e+00 -9.55708450e+00
 -9.55708450e+00 -1.25403403e+00 -5.75712672e-01 -5.75712672e-01
 -5.75712672e-01  1.01540193e+00  1.01540193e+00  1.01540193e+00
  7.27759237e+00  7.27759237e+00  7.27759237e+00  3.33941941e+01
  3.33941941e+01  3.33941941e+01  7.44912057e+01  1.29000340e+02
  1.29000340e+02  1.29000340e+02  4.83493202e+02  4.83493202e+02
  4.83493202e+02  5.57668957e+02  1.33565571e+03  1.33565571e+03
  1.33565571e+03  2.62823930e+03  3.03030904e+03  3.03030904e+03
  3.03030904e+03  6.65101001e+03  6.65101001e+03  6.65101001e+03
  9.03602759e+03  2.53934245e+04  7.61375915e+04]
E1 = -728.3512481933527  E_coul = 201.87340974414852
cycle= 2 E= -526.477838449204  delta_E= -0.000393  |g|= 0.025  |ddm|= 0.0215
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0487614
diis-c [-0.0015174   0.05109709  0.94890291]
  HOMO = -0.571764083662081  LUMO = 1.01843104257176
  mo_energy =
[-1.18555981e+02 -1.21840130e+01 -9.53536364e+00 -9.53536364e+00
 -9.53536364e+00 -1.24879605e+00 -5.71764084e-01 -5.71764084e-01
 -5.71764084e-01  1.01843104e+00  1.01843104e+00  1.01843104e+00
  7.28928272e+00  7.28928272e+00  7.28928272e+00  3.34166573e+01
  3.34166573e+01  3.34166573e+01  7.45264202e+01  1.29035014e+02
  1.29035014e+02  1.29035014e+02  4.83536702e+02  4.83536702e+02
  4.83536702e+02  5.57714527e+02  1.33570239e+03  1.33570239e+03
  1.33570239e+03  2.62828822e+03  3.03035731e+03  3.03035731e+03
  3.03035731e+03  6.65105929e+03  6.65105929e+03  6.65105929e+03
  9.03607728e+03  2.53934743e+04  7.61376414e+04]
E1 = -728.2864360137686  E_coul = 201.8085832331878
cycle= 3 E= -526.477852780581  delta_E= -1.43e-05  |g|= 0.00307  |ddm|= 0.00547
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00659397
diis-c [-3.72158605e-07 -1.08210186e-03  1.12624633e-01  8.88457469e-01]
  HOMO = -0.57247037633768  LUMO = 1.0179045144205
  mo_energy =
[-1.18561405e+02 -1.21869880e+01 -9.53844508e+00 -9.53844508e+00
 -9.53844508e+00 -1.24971188e+00 -5.72470376e-01 -5.72470376e-01
 -5.72470376e-01  1.01790451e+00  1.01790451e+00  1.01790451e+00
  7.28743698e+00  7.28743698e+00  7.28743698e+00  3.34135223e+01
  3.34135223e+01  3.34135223e+01  7.45220568e+01  1.29030583e+02
  1.29030583e+02  1.29030583e+02  4.83531351e+02  4.83531351e+02
  4.83531351e+02  5.57708924e+02  1.33569666e+03  1.33569666e+03
  1.33569666e+03  2.62828209e+03  3.03035134e+03  3.03035134e+03
  3.03035134e+03  6.65105307e+03  6.65105307e+03  6.65105307e+03
  9.03607092e+03  2.53934679e+04  7.61376349e+04]
E1 = -728.2952446377714  E_coul = 201.8173915374136
cycle= 4 E= -526.477853100358  delta_E= -3.2e-07  |g|= 4.58e-05  |ddm|= 0.000801
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.33065e-05
diis-c [-1.93109132e-09  1.06989488e-06 -1.08524438e-03 -1.15862493e-03
  1.00224280e+00]
  HOMO = -0.572441544603982  LUMO = 1.01792551196565
  mo_energy =
[-1.18561304e+02 -1.21868948e+01 -9.53835279e+00 -9.53835279e+00
 -9.53835279e+00 -1.24967440e+00 -5.72441545e-01 -5.72441545e-01
 -5.72441545e-01  1.01792551e+00  1.01792551e+00  1.01792551e+00
  7.28750268e+00  7.28750268e+00  7.28750268e+00  3.34136114e+01
  3.34136114e+01  3.34136114e+01  7.45221603e+01  1.29030682e+02
  1.29030682e+02  1.29030682e+02  4.83531451e+02  4.83531451e+02
  4.83531451e+02  5.57709022e+02  1.33569675e+03  1.33569675e+03
  1.33569675e+03  2.62828218e+03  3.03035143e+03  3.03035143e+03
  3.03035143e+03  6.65105316e+03  6.65105316e+03  6.65105316e+03
  9.03607101e+03  2.53934680e+04  7.61376350e+04]
E1 = -728.2950194013717  E_coul = 201.81716630084978
cycle= 5 E= -526.477853100522  delta_E= -1.64e-10  |g|= 7.23e-06  |ddm|= 2.55e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.2950194013717  E_coul = 201.81716630084978
  HOMO = -0.572445337485911  LUMO = 1.01792274065007
  mo_energy =
[-1.18561322e+02 -1.21869078e+01 -9.53836611e+00 -9.53836611e+00
 -9.53836611e+00 -1.24967931e+00 -5.72445337e-01 -5.72445337e-01
 -5.72445337e-01  1.01792274e+00  1.01792274e+00  1.01792274e+00
  7.28749372e+00  7.28749372e+00  7.28749372e+00  3.34135983e+01
  3.34135983e+01  3.34135983e+01  7.45221443e+01  1.29030666e+02
  1.29030666e+02  1.29030666e+02  4.83531434e+02  4.83531434e+02
  4.83531434e+02  5.57709004e+02  1.33569674e+03  1.33569674e+03
  1.33569674e+03  2.62828216e+03  3.03035141e+03  3.03035141e+03
  3.03035141e+03  6.65105314e+03  6.65105314e+03  6.65105314e+03
  9.03607099e+03  2.53934679e+04  7.61376350e+04]
E1 = -728.2950542719295  E_coul = 201.81720117140515
Extra cycle  E= -526.477853100524  delta_E= -2.39e-12  |g|= 1.87e-06  |ddm|= 3.64e-06
    CPU time for scf_cycle      0.63 sec, wall time      0.24 sec
exp = [2.61826453e+04 7.61754760e+03 3.61734690e+03 1.59839510e+03
 3.82102809e+02 1.07866297e+02 3.47278356e+01 4.58493321e+00
 3.95184014e-01 1.36278010e+03 6.64777821e+02 3.01114956e+02
 3.14174750e+02 6.16575413e+01 7.33045695e+00 2.02473384e+01
 7.71973766e-01 2.81290139e+00 2.22382939e-01]
E = -526.4778531005244
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:46:48 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.64532          1
[INPUT] 0    0    [1    /1   ]  7617.54760094        1
[INPUT] 0    0    [1    /1   ]  3617.34689849        1
[INPUT] 0    0    [1    /1   ]  1598.39509807        1
[INPUT] 0    0    [1    /1   ]  382.102809417        1
[INPUT] 0    0    [1    /1   ]  107.866296582        1
[INPUT] 0    0    [1    /1   ]  34.7278355854        1
[INPUT] 0    0    [1    /1   ]  4.58493321289        1
[INPUT] 0    0    [1    /1   ]  0.395184014202       1
[INPUT] 1    0    [1    /1   ]  1362.7800982         1
[INPUT] 1    0    [1    /1   ]  664.777820892        1
[INPUT] 1    0    [1    /1   ]  301.114955738        1
[INPUT] 1    0    [1    /1   ]  314.17475019         1
[INPUT] 1    0    [1    /1   ]  61.6575413412        1
[INPUT] 1    0    [1    /1   ]  7.33045695267        1
[INPUT] 1    0    [1    /1   ]  20.2473383511        1
[INPUT] 1    0    [1    /1   ]  0.77197376572        1
[INPUT] 1    0    [1    /1   ]  2.81290138669        1
[INPUT] 1    0    [1    /1   ]  0.222382938795       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.64531997614, 1.0]], [0, [7617.547600944543, 1.0]], [0, [3617.346898490411, 1.0]], [0, [1598.3950980722695, 1.0]], [0, [382.1028094169469, 1.0]], [0, [107.86629658187111, 1.0]], [0, [34.72783558535875, 1.0]], [0, [4.584933212885689, 1.0]], [0, [0.39518401420179566, 1.0]], [1, [1362.7800981989064, 1.0]], [1, [664.7778208915801, 1.0]], [1, [301.1149557382409, 1.0]], [1, [314.17475018983754, 1.0]], [1, [61.65754134117342, 1.0]], [1, [7.330456952669997, 1.0]], [1, [20.247338351129475, 1.0]], [1, [0.7719737657202486, 1.0]], [1, [2.8129013866871886, 1.0]], [1, [0.22238293879499008, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.64531998]
bas 1, expnt(s) = [7617.54760094]
bas 2, expnt(s) = [3617.34689849]
bas 3, expnt(s) = [1598.39509807]
bas 4, expnt(s) = [382.10280942]
bas 5, expnt(s) = [107.86629658]
bas 6, expnt(s) = [34.72783559]
bas 7, expnt(s) = [4.58493321]
bas 8, expnt(s) = [0.39518401]
bas 9, expnt(s) = [1362.7800982]
bas 10, expnt(s) = [664.77782089]
bas 11, expnt(s) = [301.11495574]
bas 12, expnt(s) = [314.17475019]
bas 13, expnt(s) = [61.65754134]
bas 14, expnt(s) = [7.33045695]
bas 15, expnt(s) = [20.24733835]
bas 16, expnt(s) = [0.77197377]
bas 17, expnt(s) = [2.81290139]
bas 18, expnt(s) = [0.22238294]
CPU time:       901.27
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826453e+04 5.20026130e+03 7.61754760e+03 2.06004357e+03
 3.61734690e+03 1.17844046e+03 1.59839510e+03 6.38672370e+02
 3.82102809e+02 2.18348492e+02 1.07866297e+02 8.45627992e+01
 3.47278356e+01 3.61429263e+01 4.58493321e+00 7.91616403e+00
 3.95184014e-01 1.25925751e+00 1.36278010e+03 2.41555328e+04
 6.64777821e+02 9.84759195e+03 3.01114956e+02 3.65931504e+03
 3.14174750e+02 3.85876642e+03 6.16575413e+01 5.04042487e+02
 7.33045695e+00 3.51882932e+01 2.02473384e+01 1.25298052e+02
 7.71973766e-01 2.11099677e+00 2.81290139e+00 1.06274122e+01
 2.22382939e-01 4.45513865e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97689839557547
cond(S) = 100433.12341103297
E1 = -728.8841254171631  E_coul = 203.1221581019934
init E= -525.76196731517
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559436455470021  LUMO = 1.02516769216289
  mo_energy =
[-1.18319408e+02 -1.21035003e+01 -9.44886383e+00 -9.44886383e+00
 -9.44886383e+00 -1.23008009e+00 -5.59436455e-01 -5.59436455e-01
 -5.59436455e-01  1.02516769e+00  1.02516769e+00  1.02516769e+00
  7.33571153e+00  7.33571153e+00  7.33571153e+00  3.35113527e+01
  3.35113527e+01  3.35113527e+01  7.46613798e+01  1.29194861e+02
  1.29194861e+02  1.29194861e+02  4.83768413e+02  4.83768413e+02
  4.83768413e+02  5.57985108e+02  1.33599014e+03  1.33599014e+03
  1.33599014e+03  2.62870969e+03  3.03071028e+03  3.03071028e+03
  3.03071028e+03  6.65152566e+03  6.65152566e+03  6.65152566e+03
  9.03661955e+03  2.53941110e+04  7.61383686e+04]
E1 = -728.0397461287247  E_coul = 201.56230111997542
cycle= 1 E= -526.477445008749  delta_E= -0.715  |g|= 0.185  |ddm|= 0.369
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.546075
diis-c [-0.29819739  1.        ]
  HOMO = -0.575712672449766  LUMO = 1.01540193270295
  mo_energy =
[-1.18600072e+02 -1.22053137e+01 -9.55708450e+00 -9.55708450e+00
 -9.55708450e+00 -1.25403403e+00 -5.75712672e-01 -5.75712672e-01
 -5.75712672e-01  1.01540193e+00  1.01540193e+00  1.01540193e+00
  7.27759237e+00  7.27759237e+00  7.27759237e+00  3.33941941e+01
  3.33941941e+01  3.33941941e+01  7.44912057e+01  1.29000340e+02
  1.29000340e+02  1.29000340e+02  4.83493202e+02  4.83493202e+02
  4.83493202e+02  5.57668957e+02  1.33565571e+03  1.33565571e+03
  1.33565571e+03  2.62823930e+03  3.03030904e+03  3.03030904e+03
  3.03030904e+03  6.65101001e+03  6.65101001e+03  6.65101001e+03
  9.03602759e+03  2.53934245e+04  7.61375915e+04]
E1 = -728.3512481933527  E_coul = 201.87340974414852
cycle= 2 E= -526.477838449204  delta_E= -0.000393  |g|= 0.025  |ddm|= 0.0215
    CPU time for cycle= 2      0.03 sec, wall time      0.04 sec
diis-norm(errvec)=0.0487614
diis-c [-0.0015174   0.05109709  0.94890291]
  HOMO = -0.571764083662081  LUMO = 1.01843104257176
  mo_energy =
[-1.18555981e+02 -1.21840130e+01 -9.53536364e+00 -9.53536364e+00
 -9.53536364e+00 -1.24879605e+00 -5.71764084e-01 -5.71764084e-01
 -5.71764084e-01  1.01843104e+00  1.01843104e+00  1.01843104e+00
  7.28928272e+00  7.28928272e+00  7.28928272e+00  3.34166573e+01
  3.34166573e+01  3.34166573e+01  7.45264202e+01  1.29035014e+02
  1.29035014e+02  1.29035014e+02  4.83536702e+02  4.83536702e+02
  4.83536702e+02  5.57714527e+02  1.33570239e+03  1.33570239e+03
  1.33570239e+03  2.62828822e+03  3.03035731e+03  3.03035731e+03
  3.03035731e+03  6.65105929e+03  6.65105929e+03  6.65105929e+03
  9.03607728e+03  2.53934743e+04  7.61376414e+04]
E1 = -728.2864360137686  E_coul = 201.8085832331878
cycle= 3 E= -526.477852780581  delta_E= -1.43e-05  |g|= 0.00307  |ddm|= 0.00547
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00659397
diis-c [-3.72158605e-07 -1.08210186e-03  1.12624633e-01  8.88457469e-01]
  HOMO = -0.57247037633768  LUMO = 1.0179045144205
  mo_energy =
[-1.18561405e+02 -1.21869880e+01 -9.53844508e+00 -9.53844508e+00
 -9.53844508e+00 -1.24971188e+00 -5.72470376e-01 -5.72470376e-01
 -5.72470376e-01  1.01790451e+00  1.01790451e+00  1.01790451e+00
  7.28743698e+00  7.28743698e+00  7.28743698e+00  3.34135223e+01
  3.34135223e+01  3.34135223e+01  7.45220568e+01  1.29030583e+02
  1.29030583e+02  1.29030583e+02  4.83531351e+02  4.83531351e+02
  4.83531351e+02  5.57708924e+02  1.33569666e+03  1.33569666e+03
  1.33569666e+03  2.62828209e+03  3.03035134e+03  3.03035134e+03
  3.03035134e+03  6.65105307e+03  6.65105307e+03  6.65105307e+03
  9.03607092e+03  2.53934679e+04  7.61376349e+04]
E1 = -728.2952446377714  E_coul = 201.8173915374136
cycle= 4 E= -526.477853100358  delta_E= -3.2e-07  |g|= 4.58e-05  |ddm|= 0.000801
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.33065e-05
diis-c [-1.93109132e-09  1.06989488e-06 -1.08524438e-03 -1.15862493e-03
  1.00224280e+00]
  HOMO = -0.572441544603982  LUMO = 1.01792551196565
  mo_energy =
[-1.18561304e+02 -1.21868948e+01 -9.53835279e+00 -9.53835279e+00
 -9.53835279e+00 -1.24967440e+00 -5.72441545e-01 -5.72441545e-01
 -5.72441545e-01  1.01792551e+00  1.01792551e+00  1.01792551e+00
  7.28750268e+00  7.28750268e+00  7.28750268e+00  3.34136114e+01
  3.34136114e+01  3.34136114e+01  7.45221603e+01  1.29030682e+02
  1.29030682e+02  1.29030682e+02  4.83531451e+02  4.83531451e+02
  4.83531451e+02  5.57709022e+02  1.33569675e+03  1.33569675e+03
  1.33569675e+03  2.62828218e+03  3.03035143e+03  3.03035143e+03
  3.03035143e+03  6.65105316e+03  6.65105316e+03  6.65105316e+03
  9.03607101e+03  2.53934680e+04  7.61376350e+04]
E1 = -728.2950194013717  E_coul = 201.81716630084978
cycle= 5 E= -526.477853100522  delta_E= -1.64e-10  |g|= 7.23e-06  |ddm|= 2.55e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.2950194013717  E_coul = 201.81716630084978
  HOMO = -0.572445337485911  LUMO = 1.01792274065007
  mo_energy =
[-1.18561322e+02 -1.21869078e+01 -9.53836611e+00 -9.53836611e+00
 -9.53836611e+00 -1.24967931e+00 -5.72445337e-01 -5.72445337e-01
 -5.72445337e-01  1.01792274e+00  1.01792274e+00  1.01792274e+00
  7.28749372e+00  7.28749372e+00  7.28749372e+00  3.34135983e+01
  3.34135983e+01  3.34135983e+01  7.45221443e+01  1.29030666e+02
  1.29030666e+02  1.29030666e+02  4.83531434e+02  4.83531434e+02
  4.83531434e+02  5.57709004e+02  1.33569674e+03  1.33569674e+03
  1.33569674e+03  2.62828216e+03  3.03035141e+03  3.03035141e+03
  3.03035141e+03  6.65105314e+03  6.65105314e+03  6.65105314e+03
  9.03607099e+03  2.53934679e+04  7.61376350e+04]
E1 = -728.2950542719295  E_coul = 201.81720117140515
Extra cycle  E= -526.477853100524  delta_E= -2.39e-12  |g|= 1.87e-06  |ddm|= 3.64e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.25 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 100433.12341103297
E1 = -728.2950542719295  E_coul = 201.81720117140515
init E= -526.477853100524
    CPU time for initialize scf      2.76 sec, wall time      0.26 sec
  HOMO = -0.572444675969001  LUMO = 1.01792322996505
  mo_energy =
[-1.18561318e+02 -1.21869052e+01 -9.53836349e+00 -9.53836349e+00
 -9.53836349e+00 -1.24967845e+00 -5.72444676e-01 -5.72444676e-01
 -5.72444676e-01  1.01792323e+00  1.01792323e+00  1.01792323e+00
  7.28749537e+00  7.28749537e+00  7.28749537e+00  3.34136009e+01
  3.34136009e+01  3.34136009e+01  7.45221478e+01  1.29030670e+02
  1.29030670e+02  1.29030670e+02  4.83531438e+02  4.83531438e+02
  4.83531438e+02  5.57709008e+02  1.33569674e+03  1.33569674e+03
  1.33569674e+03  2.62828216e+03  3.03035142e+03  3.03035142e+03
  3.03035142e+03  6.65105315e+03  6.65105315e+03  6.65105315e+03
  9.03607099e+03  2.53934679e+04  7.61376350e+04]
E1 = -728.295047072768  E_coul = 201.8171939722435
cycle= 1 E= -526.477853100524  delta_E= -1.14e-13  |g|= 4.2e-07  |ddm|= 6.93e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.295047072768  E_coul = 201.8171939722435
  HOMO = -0.572444804558884  LUMO = 1.01792313439361
  mo_energy =
[-1.18561319e+02 -1.21869058e+01 -9.53836402e+00 -9.53836402e+00
 -9.53836402e+00 -1.24967862e+00 -5.72444805e-01 -5.72444805e-01
 -5.72444805e-01  1.01792313e+00  1.01792313e+00  1.01792313e+00
  7.28749504e+00  7.28749504e+00  7.28749504e+00  3.34136004e+01
  3.34136004e+01  3.34136004e+01  7.45221470e+01  1.29030669e+02
  1.29030669e+02  1.29030669e+02  4.83531437e+02  4.83531437e+02
  4.83531437e+02  5.57709007e+02  1.33569674e+03  1.33569674e+03
  1.33569674e+03  2.62828216e+03  3.03035142e+03  3.03035142e+03
  3.03035142e+03  6.65105315e+03  6.65105315e+03  6.65105315e+03
  9.03607099e+03  2.53934679e+04  7.61376350e+04]
E1 = -728.2950485819593  E_coul = 201.81719548143582
Extra cycle  E= -526.477853100524  delta_E= 9.09e-13  |g|= 9.1e-08  |ddm|= 1.41e-07
    CPU time for scf_cycle      2.88 sec, wall time      0.39 sec
exp = [2.61826453e+04 7.61754760e+03 3.61734690e+03 1.59839510e+03
 3.82102809e+02 1.07866297e+02 3.47278356e+01 4.58493321e+00
 3.95184014e-01 1.36278010e+03 6.64777821e+02 3.01114956e+02
 3.14174750e+02 6.16575413e+01 7.33045695e+00 2.02473384e+01
 7.71973766e-01 2.81290139e+00 2.22382939e-01]
grad_E = [-1.51576679e-06  3.34817206e-06 -1.41066625e-06  7.02584393e-05
  1.57874307e-05 -2.03941542e-05  1.02877394e-04  4.13462915e-05
  9.08100587e-04 -5.08558772e-07  4.97649370e-06  2.34284007e-05
  2.02062139e-05 -5.28243025e-06  3.08698162e-04 -7.64498022e-05
 -4.35561121e-04 -4.45424300e-04  2.22677991e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:46:53 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.648487         1
[INPUT] 0    0    [1    /1   ]  7617.53964791        1
[INPUT] 0    0    [1    /1   ]  3617.34750335        1
[INPUT] 0    0    [1    /1   ]  1598.21612246        1
[INPUT] 0    0    [1    /1   ]  382.411562461        1
[INPUT] 0    0    [1    /1   ]  107.970642086        1
[INPUT] 0    0    [1    /1   ]  34.7595361645        1
[INPUT] 0    0    [1    /1   ]  4.58505330189        1
[INPUT] 0    0    [1    /1   ]  0.39523634617        1
[INPUT] 1    0    [1    /1   ]  1362.7809943         1
[INPUT] 1    0    [1    /1   ]  664.768291157        1
[INPUT] 1    0    [1    /1   ]  301.069421983        1
[INPUT] 1    0    [1    /1   ]  314.135266222        1
[INPUT] 1    0    [1    /1   ]  61.6450622554        1
[INPUT] 1    0    [1    /1   ]  7.33038593667        1
[INPUT] 1    0    [1    /1   ]  20.2445129525        1
[INPUT] 1    0    [1    /1   ]  0.772018098721       1
[INPUT] 1    0    [1    /1   ]  2.8113246513         1
[INPUT] 1    0    [1    /1   ]  0.222460972137       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.648486985727, 1.0]], [0, [7617.539647908465, 1.0]], [0, [3617.3475033503214, 1.0]], [0, [1598.2161224559775, 1.0]], [0, [382.4115624609066, 1.0]], [0, [107.97064208638157, 1.0]], [0, [34.75953616452642, 1.0]], [0, [4.5850533018923825, 1.0]], [0, [0.39523634617039394, 1.0]], [1, [1362.7809943013035, 1.0]], [1, [664.7682911574483, 1.0]], [1, [301.06942198309804, 1.0]], [1, [314.13526622153876, 1.0]], [1, [61.645062255437104, 1.0]], [1, [7.330385936673332, 1.0]], [1, [20.24451295252531, 1.0]], [1, [0.7720180987208106, 1.0]], [1, [2.8113246512997185, 1.0]], [1, [0.22246097213684082, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.64848699]
bas 1, expnt(s) = [7617.53964791]
bas 2, expnt(s) = [3617.34750335]
bas 3, expnt(s) = [1598.21612246]
bas 4, expnt(s) = [382.41156246]
bas 5, expnt(s) = [107.97064209]
bas 6, expnt(s) = [34.75953616]
bas 7, expnt(s) = [4.5850533]
bas 8, expnt(s) = [0.39523635]
bas 9, expnt(s) = [1362.7809943]
bas 10, expnt(s) = [664.76829116]
bas 11, expnt(s) = [301.06942198]
bas 12, expnt(s) = [314.13526622]
bas 13, expnt(s) = [61.64506226]
bas 14, expnt(s) = [7.33038594]
bas 15, expnt(s) = [20.24451295]
bas 16, expnt(s) = [0.7720181]
bas 17, expnt(s) = [2.81132465]
bas 18, expnt(s) = [0.22246097]
CPU time:       909.71
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826485e+04 5.20026177e+03 7.61753965e+03 2.06004196e+03
 3.61734750e+03 1.17844060e+03 1.59821612e+03 6.38618734e+02
 3.82411562e+02 2.18480804e+02 1.07970642e+02 8.46241437e+01
 3.47595362e+01 3.61676677e+01 4.58505330e+00 7.91631954e+00
 3.95236346e-01 1.25938258e+00 1.36278099e+03 2.41555526e+04
 6.64768291e+02 9.84741549e+03 3.01069422e+02 3.65862336e+03
 3.14135266e+02 3.85816024e+03 6.16450623e+01 5.03914972e+02
 7.33038594e+00 3.51878671e+01 2.02445130e+01 1.25276196e+02
 7.72018099e-01 2.11114831e+00 2.81132465e+00 1.06199664e+01
 2.22460972e-01 4.45709285e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.976881347413343
cond(S) = 100278.34812695814
E1 = -728.8847190881173  E_coul = 203.12297867064368
init E= -525.761740417474
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559412132614102  LUMO = 1.02550088204444
  mo_energy =
[-1.18319318e+02 -1.21034733e+01 -9.44879653e+00 -9.44879653e+00
 -9.44879653e+00 -1.23006316e+00 -5.59412133e-01 -5.59412133e-01
 -5.59412133e-01  1.02550088e+00  1.02550088e+00  1.02550088e+00
  7.33354590e+00  7.33354590e+00  7.33354590e+00  3.35041262e+01
  3.35041262e+01  3.35041262e+01  7.47651229e+01  1.29169343e+02
  1.29169343e+02  1.29169343e+02  4.83688667e+02  4.83688667e+02
  4.83688667e+02  5.58580691e+02  1.33581307e+03  1.33581307e+03
  1.33581307e+03  2.62991648e+03  3.03041231e+03  3.03041231e+03
  3.03041231e+03  6.65115152e+03  6.65115152e+03  6.65115152e+03
  9.03780921e+03  2.53951107e+04  7.61392208e+04]
E1 = -728.0420410459719  E_coul = 201.5645893132149
cycle= 1 E= -526.477451732757  delta_E= -0.716  |g|= 0.185  |ddm|= 0.369
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.545859
diis-c [-0.2979618  1.       ]
  HOMO = -0.575644048347863  LUMO = 1.01576747735197
  mo_energy =
[-1.18599825e+02 -1.22052012e+01 -9.55691354e+00 -9.55691354e+00
 -9.55691354e+00 -1.25397114e+00 -5.75644048e-01 -5.75644048e-01
 -5.75644048e-01  1.01576748e+00  1.01576748e+00  1.01576748e+00
  7.27551863e+00  7.27551863e+00  7.27551863e+00  3.33870847e+01
  3.33870847e+01  3.33870847e+01  7.45949936e+01  1.28974968e+02
  1.28974968e+02  1.28974968e+02  4.83413641e+02  4.83413641e+02
  4.83413641e+02  5.58264655e+02  1.33547886e+03  1.33547886e+03
  1.33547886e+03  2.62944632e+03  3.03001130e+03  3.03001130e+03
  3.03001130e+03  6.65063613e+03  6.65063613e+03  6.65063613e+03
  9.03721754e+03  2.53944244e+04  7.61384440e+04]
E1 = -728.353111213395  E_coul = 201.87526686642332
cycle= 2 E= -526.477844346972  delta_E= -0.000393  |g|= 0.025  |ddm|= 0.0214
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.048706
diis-c [-0.00151506  0.05102984  0.94897016]
  HOMO = -0.571702075344428  LUMO = 1.01879197664765
  mo_energy =
[-1.18555783e+02 -1.21839291e+01 -9.53522197e+00 -9.53522197e+00
 -9.53522197e+00 -1.24874148e+00 -5.71702075e-01 -5.71702075e-01
 -5.71702075e-01  1.01879198e+00  1.01879198e+00  1.01879198e+00
  7.28718870e+00  7.28718870e+00  7.28718870e+00  3.34095170e+01
  3.34095170e+01  3.34095170e+01  7.46301789e+01  1.29009599e+02
  1.29009599e+02  1.29009599e+02  4.83457091e+02  4.83457091e+02
  4.83457091e+02  5.58310179e+02  1.33552549e+03  1.33552549e+03
  1.33552549e+03  2.62949520e+03  3.03005952e+03  3.03005952e+03
  3.03005952e+03  6.65068536e+03  6.65068536e+03  6.65068536e+03
  9.03726717e+03  2.53944742e+04  7.61384938e+04]
E1 = -728.2883931174586  E_coul = 201.81053447834262
cycle= 3 E= -526.477858639116  delta_E= -1.43e-05  |g|= 0.00307  |ddm|= 0.00546
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00658735
diis-c [-3.70870009e-07 -1.08108966e-03  1.12644368e-01  8.88436722e-01]
  HOMO = -0.572407442028488  LUMO = 1.01826606872468
  mo_energy =
[-1.18561203e+02 -1.21869012e+01 -9.53830034e+00 -9.53830034e+00
 -9.53830034e+00 -1.24965620e+00 -5.72407442e-01 -5.72407442e-01
 -5.72407442e-01  1.01826607e+00  1.01826607e+00  1.01826607e+00
  7.28534543e+00  7.28534543e+00  7.28534543e+00  3.34063853e+01
  3.34063853e+01  3.34063853e+01  7.46258179e+01  1.29005172e+02
  1.29005172e+02  1.29005172e+02  4.83451745e+02  4.83451745e+02
  4.83451745e+02  5.58304581e+02  1.33551976e+03  1.33551976e+03
  1.33551976e+03  2.62948907e+03  3.03005355e+03  3.03005355e+03
  3.03005355e+03  6.65067915e+03  6.65067915e+03  6.65067915e+03
  9.03726083e+03  2.53944678e+04  7.61384873e+04]
E1 = -728.2971911281492  E_coul = 201.81933216997436
cycle= 4 E= -526.477858958175  delta_E= -3.19e-07  |g|= 4.58e-05  |ddm|= 0.0008
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.3313e-05
diis-c [-1.92510685e-09  9.93794956e-07 -1.07467462e-03 -1.05733064e-03
  1.00213101e+00]
  HOMO = -0.572378635646387  LUMO = 1.01828705027253
  mo_energy =
[-1.18561102e+02 -1.21868081e+01 -9.53820811e+00 -9.53820811e+00
 -9.53820811e+00 -1.24961876e+00 -5.72378636e-01 -5.72378636e-01
 -5.72378636e-01  1.01828705e+00  1.01828705e+00  1.01828705e+00
  7.28541107e+00  7.28541107e+00  7.28541107e+00  3.34064743e+01
  3.34064743e+01  3.34064743e+01  7.46259213e+01  1.29005271e+02
  1.29005271e+02  1.29005271e+02  4.83451846e+02  4.83451846e+02
  4.83451846e+02  5.58304679e+02  1.33551986e+03  1.33551986e+03
  1.33551986e+03  2.62948916e+03  3.03005364e+03  3.03005364e+03
  3.03005364e+03  6.65067924e+03  6.65067924e+03  6.65067924e+03
  9.03726091e+03  2.53944678e+04  7.61384874e+04]
E1 = -728.2969661076222  E_coul = 201.81910714928412
cycle= 5 E= -526.477858958338  delta_E= -1.63e-10  |g|= 7.21e-06  |ddm|= 2.55e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.2969661076222  E_coul = 201.81910714928412
  HOMO = -0.572382418775924  LUMO = 1.01828428577721
  mo_energy =
[-1.18561120e+02 -1.21868211e+01 -9.53822140e+00 -9.53822140e+00
 -9.53822140e+00 -1.24962365e+00 -5.72382419e-01 -5.72382419e-01
 -5.72382419e-01  1.01828429e+00  1.01828429e+00  1.01828429e+00
  7.28540213e+00  7.28540213e+00  7.28540213e+00  3.34064612e+01
  3.34064612e+01  3.34064612e+01  7.46259054e+01  1.29005255e+02
  1.29005255e+02  1.29005255e+02  4.83451828e+02  4.83451828e+02
  4.83451828e+02  5.58304661e+02  1.33551984e+03  1.33551984e+03
  1.33551984e+03  2.62948914e+03  3.03005363e+03  3.03005363e+03
  3.03005363e+03  6.65067922e+03  6.65067922e+03  6.65067922e+03
  9.03726089e+03  2.53944678e+04  7.61384874e+04]
E1 = -728.2970008859901  E_coul = 201.8191419276493
Extra cycle  E= -526.477858958341  delta_E= -2.73e-12  |g|= 1.87e-06  |ddm|= 3.63e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.23 sec
exp = [2.61826485e+04 7.61753965e+03 3.61734750e+03 1.59821612e+03
 3.82411562e+02 1.07970642e+02 3.47595362e+01 4.58505330e+00
 3.95236346e-01 1.36278099e+03 6.64768291e+02 3.01069422e+02
 3.14135266e+02 6.16450623e+01 7.33038594e+00 2.02445130e+01
 7.72018099e-01 2.81132465e+00 2.22460972e-01]
E = -526.4778589583408
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:46:53 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.648487         1
[INPUT] 0    0    [1    /1   ]  7617.53964791        1
[INPUT] 0    0    [1    /1   ]  3617.34750335        1
[INPUT] 0    0    [1    /1   ]  1598.21612246        1
[INPUT] 0    0    [1    /1   ]  382.411562461        1
[INPUT] 0    0    [1    /1   ]  107.970642086        1
[INPUT] 0    0    [1    /1   ]  34.7595361645        1
[INPUT] 0    0    [1    /1   ]  4.58505330189        1
[INPUT] 0    0    [1    /1   ]  0.39523634617        1
[INPUT] 1    0    [1    /1   ]  1362.7809943         1
[INPUT] 1    0    [1    /1   ]  664.768291157        1
[INPUT] 1    0    [1    /1   ]  301.069421983        1
[INPUT] 1    0    [1    /1   ]  314.135266222        1
[INPUT] 1    0    [1    /1   ]  61.6450622554        1
[INPUT] 1    0    [1    /1   ]  7.33038593667        1
[INPUT] 1    0    [1    /1   ]  20.2445129525        1
[INPUT] 1    0    [1    /1   ]  0.772018098721       1
[INPUT] 1    0    [1    /1   ]  2.8113246513         1
[INPUT] 1    0    [1    /1   ]  0.222460972137       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.648486985727, 1.0]], [0, [7617.539647908465, 1.0]], [0, [3617.3475033503214, 1.0]], [0, [1598.2161224559775, 1.0]], [0, [382.4115624609066, 1.0]], [0, [107.97064208638157, 1.0]], [0, [34.75953616452642, 1.0]], [0, [4.5850533018923825, 1.0]], [0, [0.39523634617039394, 1.0]], [1, [1362.7809943013035, 1.0]], [1, [664.7682911574483, 1.0]], [1, [301.06942198309804, 1.0]], [1, [314.13526622153876, 1.0]], [1, [61.645062255437104, 1.0]], [1, [7.330385936673332, 1.0]], [1, [20.24451295252531, 1.0]], [1, [0.7720180987208106, 1.0]], [1, [2.8113246512997185, 1.0]], [1, [0.22246097213684082, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.64848699]
bas 1, expnt(s) = [7617.53964791]
bas 2, expnt(s) = [3617.34750335]
bas 3, expnt(s) = [1598.21612246]
bas 4, expnt(s) = [382.41156246]
bas 5, expnt(s) = [107.97064209]
bas 6, expnt(s) = [34.75953616]
bas 7, expnt(s) = [4.5850533]
bas 8, expnt(s) = [0.39523635]
bas 9, expnt(s) = [1362.7809943]
bas 10, expnt(s) = [664.76829116]
bas 11, expnt(s) = [301.06942198]
bas 12, expnt(s) = [314.13526622]
bas 13, expnt(s) = [61.64506226]
bas 14, expnt(s) = [7.33038594]
bas 15, expnt(s) = [20.24451295]
bas 16, expnt(s) = [0.7720181]
bas 17, expnt(s) = [2.81132465]
bas 18, expnt(s) = [0.22246097]
CPU time:       910.64
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826485e+04 5.20026177e+03 7.61753965e+03 2.06004196e+03
 3.61734750e+03 1.17844060e+03 1.59821612e+03 6.38618734e+02
 3.82411562e+02 2.18480804e+02 1.07970642e+02 8.46241437e+01
 3.47595362e+01 3.61676677e+01 4.58505330e+00 7.91631954e+00
 3.95236346e-01 1.25938258e+00 1.36278099e+03 2.41555526e+04
 6.64768291e+02 9.84741549e+03 3.01069422e+02 3.65862336e+03
 3.14135266e+02 3.85816024e+03 6.16450623e+01 5.03914972e+02
 7.33038594e+00 3.51878671e+01 2.02445130e+01 1.25276196e+02
 7.72018099e-01 2.11114831e+00 2.81132465e+00 1.06199664e+01
 2.22460972e-01 4.45709285e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.976881347413343
cond(S) = 100278.34812695814
E1 = -728.8847190881173  E_coul = 203.12297867064368
init E= -525.761740417474
    CPU time for initialize scf      0.44 sec, wall time      0.05 sec
  HOMO = -0.559412132614102  LUMO = 1.02550088204444
  mo_energy =
[-1.18319318e+02 -1.21034733e+01 -9.44879653e+00 -9.44879653e+00
 -9.44879653e+00 -1.23006316e+00 -5.59412133e-01 -5.59412133e-01
 -5.59412133e-01  1.02550088e+00  1.02550088e+00  1.02550088e+00
  7.33354590e+00  7.33354590e+00  7.33354590e+00  3.35041262e+01
  3.35041262e+01  3.35041262e+01  7.47651229e+01  1.29169343e+02
  1.29169343e+02  1.29169343e+02  4.83688667e+02  4.83688667e+02
  4.83688667e+02  5.58580691e+02  1.33581307e+03  1.33581307e+03
  1.33581307e+03  2.62991648e+03  3.03041231e+03  3.03041231e+03
  3.03041231e+03  6.65115152e+03  6.65115152e+03  6.65115152e+03
  9.03780921e+03  2.53951107e+04  7.61392208e+04]
E1 = -728.0420410459719  E_coul = 201.5645893132149
cycle= 1 E= -526.477451732757  delta_E= -0.716  |g|= 0.185  |ddm|= 0.369
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.545859
diis-c [-0.2979618  1.       ]
  HOMO = -0.575644048347863  LUMO = 1.01576747735197
  mo_energy =
[-1.18599825e+02 -1.22052012e+01 -9.55691354e+00 -9.55691354e+00
 -9.55691354e+00 -1.25397114e+00 -5.75644048e-01 -5.75644048e-01
 -5.75644048e-01  1.01576748e+00  1.01576748e+00  1.01576748e+00
  7.27551863e+00  7.27551863e+00  7.27551863e+00  3.33870847e+01
  3.33870847e+01  3.33870847e+01  7.45949936e+01  1.28974968e+02
  1.28974968e+02  1.28974968e+02  4.83413641e+02  4.83413641e+02
  4.83413641e+02  5.58264655e+02  1.33547886e+03  1.33547886e+03
  1.33547886e+03  2.62944632e+03  3.03001130e+03  3.03001130e+03
  3.03001130e+03  6.65063613e+03  6.65063613e+03  6.65063613e+03
  9.03721754e+03  2.53944244e+04  7.61384440e+04]
E1 = -728.353111213395  E_coul = 201.87526686642332
cycle= 2 E= -526.477844346972  delta_E= -0.000393  |g|= 0.025  |ddm|= 0.0214
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.048706
diis-c [-0.00151506  0.05102984  0.94897016]
  HOMO = -0.571702075344428  LUMO = 1.01879197664765
  mo_energy =
[-1.18555783e+02 -1.21839291e+01 -9.53522197e+00 -9.53522197e+00
 -9.53522197e+00 -1.24874148e+00 -5.71702075e-01 -5.71702075e-01
 -5.71702075e-01  1.01879198e+00  1.01879198e+00  1.01879198e+00
  7.28718870e+00  7.28718870e+00  7.28718870e+00  3.34095170e+01
  3.34095170e+01  3.34095170e+01  7.46301789e+01  1.29009599e+02
  1.29009599e+02  1.29009599e+02  4.83457091e+02  4.83457091e+02
  4.83457091e+02  5.58310179e+02  1.33552549e+03  1.33552549e+03
  1.33552549e+03  2.62949520e+03  3.03005952e+03  3.03005952e+03
  3.03005952e+03  6.65068536e+03  6.65068536e+03  6.65068536e+03
  9.03726717e+03  2.53944742e+04  7.61384938e+04]
E1 = -728.2883931174586  E_coul = 201.81053447834262
cycle= 3 E= -526.477858639116  delta_E= -1.43e-05  |g|= 0.00307  |ddm|= 0.00546
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00658735
diis-c [-3.70870009e-07 -1.08108966e-03  1.12644368e-01  8.88436722e-01]
  HOMO = -0.572407442028488  LUMO = 1.01826606872468
  mo_energy =
[-1.18561203e+02 -1.21869012e+01 -9.53830034e+00 -9.53830034e+00
 -9.53830034e+00 -1.24965620e+00 -5.72407442e-01 -5.72407442e-01
 -5.72407442e-01  1.01826607e+00  1.01826607e+00  1.01826607e+00
  7.28534543e+00  7.28534543e+00  7.28534543e+00  3.34063853e+01
  3.34063853e+01  3.34063853e+01  7.46258179e+01  1.29005172e+02
  1.29005172e+02  1.29005172e+02  4.83451745e+02  4.83451745e+02
  4.83451745e+02  5.58304581e+02  1.33551976e+03  1.33551976e+03
  1.33551976e+03  2.62948907e+03  3.03005355e+03  3.03005355e+03
  3.03005355e+03  6.65067915e+03  6.65067915e+03  6.65067915e+03
  9.03726083e+03  2.53944678e+04  7.61384873e+04]
E1 = -728.2971911281492  E_coul = 201.81933216997436
cycle= 4 E= -526.477858958175  delta_E= -3.19e-07  |g|= 4.58e-05  |ddm|= 0.0008
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.3313e-05
diis-c [-1.92510685e-09  9.93794956e-07 -1.07467462e-03 -1.05733064e-03
  1.00213101e+00]
  HOMO = -0.572378635646387  LUMO = 1.01828705027253
  mo_energy =
[-1.18561102e+02 -1.21868081e+01 -9.53820811e+00 -9.53820811e+00
 -9.53820811e+00 -1.24961876e+00 -5.72378636e-01 -5.72378636e-01
 -5.72378636e-01  1.01828705e+00  1.01828705e+00  1.01828705e+00
  7.28541107e+00  7.28541107e+00  7.28541107e+00  3.34064743e+01
  3.34064743e+01  3.34064743e+01  7.46259213e+01  1.29005271e+02
  1.29005271e+02  1.29005271e+02  4.83451846e+02  4.83451846e+02
  4.83451846e+02  5.58304679e+02  1.33551986e+03  1.33551986e+03
  1.33551986e+03  2.62948916e+03  3.03005364e+03  3.03005364e+03
  3.03005364e+03  6.65067924e+03  6.65067924e+03  6.65067924e+03
  9.03726091e+03  2.53944678e+04  7.61384874e+04]
E1 = -728.2969661076222  E_coul = 201.81910714928412
cycle= 5 E= -526.477858958338  delta_E= -1.63e-10  |g|= 7.21e-06  |ddm|= 2.55e-05
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
E1 = -728.2969661076222  E_coul = 201.81910714928412
  HOMO = -0.572382418775924  LUMO = 1.01828428577721
  mo_energy =
[-1.18561120e+02 -1.21868211e+01 -9.53822140e+00 -9.53822140e+00
 -9.53822140e+00 -1.24962365e+00 -5.72382419e-01 -5.72382419e-01
 -5.72382419e-01  1.01828429e+00  1.01828429e+00  1.01828429e+00
  7.28540213e+00  7.28540213e+00  7.28540213e+00  3.34064612e+01
  3.34064612e+01  3.34064612e+01  7.46259054e+01  1.29005255e+02
  1.29005255e+02  1.29005255e+02  4.83451828e+02  4.83451828e+02
  4.83451828e+02  5.58304661e+02  1.33551984e+03  1.33551984e+03
  1.33551984e+03  2.62948914e+03  3.03005363e+03  3.03005363e+03
  3.03005363e+03  6.65067922e+03  6.65067922e+03  6.65067922e+03
  9.03726089e+03  2.53944678e+04  7.61384874e+04]
E1 = -728.2970008859901  E_coul = 201.8191419276493
Extra cycle  E= -526.477858958341  delta_E= -2.73e-12  |g|= 1.87e-06  |ddm|= 3.63e-06
    CPU time for scf_cycle      0.62 sec, wall time      0.23 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 100278.34812695814
E1 = -728.2970008859901  E_coul = 201.8191419276493
init E= -526.477858958341
    CPU time for initialize scf      2.72 sec, wall time      0.25 sec
  HOMO = -0.572381759125615  LUMO = 1.01828477377255
  mo_energy =
[-1.18561116e+02 -1.21868185e+01 -9.53821878e+00 -9.53821878e+00
 -9.53821878e+00 -1.24962279e+00 -5.72381759e-01 -5.72381759e-01
 -5.72381759e-01  1.01828477e+00  1.01828477e+00  1.01828477e+00
  7.28540378e+00  7.28540378e+00  7.28540378e+00  3.34064638e+01
  3.34064638e+01  3.34064638e+01  7.46259089e+01  1.29005259e+02
  1.29005259e+02  1.29005259e+02  4.83451832e+02  4.83451832e+02
  4.83451832e+02  5.58304665e+02  1.33551985e+03  1.33551985e+03
  1.33551985e+03  2.62948914e+03  3.03005363e+03  3.03005363e+03
  3.03005363e+03  6.65067922e+03  6.65067922e+03  6.65067922e+03
  9.03726090e+03  2.53944678e+04  7.61384874e+04]
E1 = -728.2969937075142  E_coul = 201.81913474917314
cycle= 1 E= -526.477858958341  delta_E= -2.27e-13  |g|= 4.19e-07  |ddm|= 6.91e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2969937075142  E_coul = 201.81913474917314
  HOMO = -0.572381887322079  LUMO = 1.01828467848213
  mo_energy =
[-1.18561116e+02 -1.21868191e+01 -9.53821932e+00 -9.53821932e+00
 -9.53821932e+00 -1.24962296e+00 -5.72381887e-01 -5.72381887e-01
 -5.72381887e-01  1.01828468e+00  1.01828468e+00  1.01828468e+00
  7.28540345e+00  7.28540345e+00  7.28540345e+00  3.34064633e+01
  3.34064633e+01  3.34064633e+01  7.46259081e+01  1.29005258e+02
  1.29005258e+02  1.29005258e+02  4.83451831e+02  4.83451831e+02
  4.83451831e+02  5.58304664e+02  1.33551984e+03  1.33551984e+03
  1.33551984e+03  2.62948914e+03  3.03005363e+03  3.03005363e+03
  3.03005363e+03  6.65067922e+03  6.65067922e+03  6.65067922e+03
  9.03726089e+03  2.53944678e+04  7.61384874e+04]
E1 = -728.2969952120466  E_coul = 201.81913625370552
Extra cycle  E= -526.477858958341  delta_E=    0  |g|= 9.08e-08  |ddm|= 1.41e-07
    CPU time for scf_cycle      2.85 sec, wall time      0.37 sec
exp = [2.61826485e+04 7.61753965e+03 3.61734750e+03 1.59821612e+03
 3.82411562e+02 1.07970642e+02 3.47595362e+01 4.58505330e+00
 3.95236346e-01 1.36278099e+03 6.64768291e+02 3.01069422e+02
 3.14135266e+02 6.16450623e+01 7.33038594e+00 2.02445130e+01
 7.72018099e-01 2.81132465e+00 2.22460972e-01]
grad_E = [-1.51422374e-06  3.33106227e-06 -1.42450697e-06  6.97425840e-05
  2.01561378e-05 -3.90378625e-05  1.85579334e-04  7.07311735e-05
  1.67302506e-03 -5.08774336e-07  4.97570838e-06  2.34228233e-05
  2.01998178e-05 -4.72422875e-07  5.68061477e-04 -1.37338487e-04
 -7.88707641e-04 -8.18440740e-04  4.04811092e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:46:58 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558552        1
[INPUT] 0    0    [1    /1   ]  7617.52191563        1
[INPUT] 0    0    [1    /1   ]  3617.35086742        1
[INPUT] 0    0    [1    /1   ]  1597.82569303        1
[INPUT] 0    0    [1    /1   ]  382.851149473        1
[INPUT] 0    0    [1    /1   ]  108.121083403        1
[INPUT] 0    0    [1    /1   ]  34.8054690698        1
[INPUT] 0    0    [1    /1   ]  4.58522390534        1
[INPUT] 0    0    [1    /1   ]  0.395313490558       1
[INPUT] 1    0    [1    /1   ]  1362.78320627        1
[INPUT] 1    0    [1    /1   ]  664.745680987        1
[INPUT] 1    0    [1    /1   ]  300.961991574        1
[INPUT] 1    0    [1    /1   ]  314.042273999        1
[INPUT] 1    0    [1    /1   ]  61.6222358638        1
[INPUT] 1    0    [1    /1   ]  7.32989794841        1
[INPUT] 1    0    [1    /1   ]  20.2391201296        1
[INPUT] 1    0    [1    /1   ]  0.772070364573       1
[INPUT] 1    0    [1    /1   ]  2.80887843481        1
[INPUT] 1    0    [1    /1   ]  0.222573632039       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.65585524854, 1.0]], [0, [7617.521915627052, 1.0]], [0, [3617.3508674245704, 1.0]], [0, [1597.8256930291025, 1.0]], [0, [382.85114947300525, 1.0]], [0, [108.1210834029935, 1.0]], [0, [34.80546906975482, 1.0]], [0, [4.585223905343421, 1.0]], [0, [0.39531349055767473, 1.0]], [1, [1362.7832062666114, 1.0]], [1, [664.7456809871924, 1.0]], [1, [300.9619915744506, 1.0]], [1, [314.0422739991703, 1.0]], [1, [61.622235863813884, 1.0]], [1, [7.329897948406479, 1.0]], [1, [20.239120129550937, 1.0]], [1, [0.7720703645725635, 1.0]], [1, [2.8088784348099196, 1.0]], [1, [0.22257363203907735, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65585525]
bas 1, expnt(s) = [7617.52191563]
bas 2, expnt(s) = [3617.35086742]
bas 3, expnt(s) = [1597.82569303]
bas 4, expnt(s) = [382.85114947]
bas 5, expnt(s) = [108.1210834]
bas 6, expnt(s) = [34.80546907]
bas 7, expnt(s) = [4.58522391]
bas 8, expnt(s) = [0.39531349]
bas 9, expnt(s) = [1362.78320627]
bas 10, expnt(s) = [664.74568099]
bas 11, expnt(s) = [300.96199157]
bas 12, expnt(s) = [314.042274]
bas 13, expnt(s) = [61.62223586]
bas 14, expnt(s) = [7.32989795]
bas 15, expnt(s) = [20.23912013]
bas 16, expnt(s) = [0.77207036]
bas 17, expnt(s) = [2.80887843]
bas 18, expnt(s) = [0.22257363]
CPU time:       919.33
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752192e+03 2.06003837e+03
 3.61735087e+03 1.17844143e+03 1.59782569e+03 6.38501724e+02
 3.82851149e+02 2.18669137e+02 1.08121083e+02 8.47125619e+01
 3.48054691e+01 3.62035070e+01 4.58522391e+00 7.91654045e+00
 3.95313491e-01 1.25956693e+00 1.36278321e+03 2.41556016e+04
 6.64745681e+02 9.84699683e+03 3.00961992e+02 3.65699156e+03
 3.14042274e+02 3.85673265e+03 6.16222359e+01 5.03681741e+02
 7.32989795e+00 3.51849390e+01 2.02391201e+01 1.25234483e+02
 7.72070365e-01 2.11132697e+00 2.80887843e+00 1.06084167e+01
 2.22573632e-01 4.45991451e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97685654436697
cond(S) = 99911.36193712578
E1 = -728.8856047386636  E_coul = 203.12418858982087
init E= -525.761416148843
    CPU time for initialize scf      0.45 sec, wall time      0.06 sec
  HOMO = -0.559376415127525  LUMO = 1.02597080227682
  mo_energy =
[-1.18319187e+02 -1.21034345e+01 -9.44869724e+00 -9.44869724e+00
 -9.44869724e+00 -1.23003815e+00 -5.59376415e-01 -5.59376415e-01
 -5.59376415e-01  1.02597080e+00  1.02597080e+00  1.02597080e+00
  7.32997550e+00  7.32997550e+00  7.32997550e+00  3.34912321e+01
  3.34912321e+01  3.34912321e+01  7.49151213e+01  1.29121660e+02
  1.29121660e+02  1.29121660e+02  4.83525515e+02  4.83525515e+02
  4.83525515e+02  5.59434626e+02  1.33542366e+03  1.33542366e+03
  1.33542366e+03  2.63156228e+03  3.02973780e+03  3.02973780e+03
  3.02973780e+03  6.65029577e+03  6.65029577e+03  6.65029577e+03
  9.03922807e+03  2.53960997e+04  7.61399457e+04]
E1 = -728.045425590601  E_coul = 201.56795854096006
cycle= 1 E= -526.477467049641  delta_E= -0.716  |g|= 0.185  |ddm|= 0.368
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.545545
diis-c [-0.29761961  1.        ]
  HOMO = -0.575543271152619  LUMO = 1.01628531411305
  mo_energy =
[-1.18599462e+02 -1.22050365e+01 -9.55666182e+00 -9.55666182e+00
 -9.55666182e+00 -1.25387862e+00 -5.75543271e-01 -5.75543271e-01
 -5.75543271e-01  1.01628531e+00  1.01628531e+00  1.01628531e+00
  7.27208567e+00  7.27208567e+00  7.27208567e+00  3.33743670e+01
  3.33743670e+01  3.33743670e+01  7.47450606e+01  1.28927505e+02
  1.28927505e+02  1.28927505e+02  4.83250770e+02  4.83250770e+02
  4.83250770e+02  5.59118766e+02  1.33508978e+03  1.33508978e+03
  1.33508978e+03  2.63109248e+03  3.02933713e+03  3.02933713e+03
  3.02933713e+03  6.64978077e+03  6.64978077e+03  6.64978077e+03
  9.03863683e+03  2.53954139e+04  7.61391693e+04]
E1 = -728.3558623619144  E_coul = 201.87800391007633
cycle= 2 E= -526.477858451838  delta_E= -0.000391  |g|= 0.0249  |ddm|= 0.0214
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0486254
diis-c [-0.00151164  0.05093228  0.94906772]
  HOMO = -0.571611002009587  LUMO = 1.01930297083905
  mo_energy =
[-1.18555493e+02 -1.21838066e+01 -9.53501323e+00 -9.53501323e+00
 -9.53501323e+00 -1.24866116e+00 -5.71611002e-01 -5.71611002e-01
 -5.71611002e-01  1.01930297e+00  1.01930297e+00  1.01930297e+00
  7.28372554e+00  7.28372554e+00  7.28372554e+00  3.33967533e+01
  3.33967533e+01  3.33967533e+01  7.47802025e+01  1.28962072e+02
  1.28962072e+02  1.28962072e+02  4.83294147e+02  4.83294147e+02
  4.83294147e+02  5.59164222e+02  1.33513632e+03  1.33513632e+03
  1.33513632e+03  2.63114127e+03  3.02938527e+03  3.02938527e+03
  3.02938527e+03  6.64982992e+03  6.64982992e+03  6.64982992e+03
  9.03868639e+03  2.53954636e+04  7.61392191e+04]
E1 = -728.2912819711299  E_coul = 201.81340928450317
cycle= 3 E= -526.477872686627  delta_E= -1.42e-05  |g|= 0.00306  |ddm|= 0.00545
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00657773
diis-c [-3.68998756e-07 -1.07961955e-03  1.12673102e-01  8.88406518e-01]
  HOMO = -0.572315010168722  LUMO = 1.0187779860514
  mo_energy =
[-1.18560906e+02 -1.21867744e+01 -9.53808708e+00 -9.53808708e+00
 -9.53808708e+00 -1.24957425e+00 -5.72315010e-01 -5.72315010e-01
 -5.72315010e-01  1.01877799e+00  1.01877799e+00  1.01877799e+00
  7.28188596e+00  7.28188596e+00  7.28188596e+00  3.33936264e+01
  3.33936264e+01  3.33936264e+01  7.47758452e+01  1.28957652e+02
  1.28957652e+02  1.28957652e+02  4.83288808e+02  4.83288808e+02
  4.83288808e+02  5.59158630e+02  1.33513060e+03  1.33513060e+03
  1.33513060e+03  2.63113515e+03  3.02937931e+03  3.02937931e+03
  3.02937931e+03  6.64982371e+03  6.64982371e+03  6.64982371e+03
  9.03868005e+03  2.53954572e+04  7.61392126e+04]
E1 = -728.3000644217392  E_coul = 201.82219141710627
cycle= 4 E= -526.477873004633  delta_E= -3.18e-07  |g|= 4.58e-05  |ddm|= 0.000799
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=6.33219e-05
diis-c [-1.91644099e-09  8.81293268e-07 -1.05912967e-03 -9.08857841e-04
  1.00196711e+00]
  HOMO = -0.57228624107958  LUMO = 1.0187989435518
  mo_energy =
[-1.18560805e+02 -1.21866814e+01 -9.53799496e+00 -9.53799496e+00
 -9.53799496e+00 -1.24953685e+00 -5.72286241e-01 -5.72286241e-01
 -5.72286241e-01  1.01879894e+00  1.01879894e+00  1.01879894e+00
  7.28195150e+00  7.28195150e+00  7.28195150e+00  3.33937154e+01
  3.33937154e+01  3.33937154e+01  7.47759485e+01  1.28957750e+02
  1.28957750e+02  1.28957750e+02  4.83288908e+02  4.83288908e+02
  4.83288908e+02  5.59158728e+02  1.33513070e+03  1.33513070e+03
  1.33513070e+03  2.63113524e+03  3.02937941e+03  3.02937941e+03
  3.02937941e+03  6.64982380e+03  6.64982380e+03  6.64982380e+03
  9.03868013e+03  2.53954572e+04  7.61392127e+04]
E1 = -728.2998397181486  E_coul = 201.82196671335282
cycle= 5 E= -526.477873004796  delta_E= -1.63e-10  |g|= 7.18e-06  |ddm|= 2.54e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.2998397181486  E_coul = 201.82196671335282
  HOMO = -0.572290009983499  LUMO = 1.0187961890717
  mo_energy =
[-1.18560822e+02 -1.21866944e+01 -9.53800820e+00 -9.53800820e+00
 -9.53800820e+00 -1.24954173e+00 -5.72290010e-01 -5.72290010e-01
 -5.72290010e-01  1.01879619e+00  1.01879619e+00  1.01879619e+00
  7.28194259e+00  7.28194259e+00  7.28194259e+00  3.33937023e+01
  3.33937023e+01  3.33937023e+01  7.47759326e+01  1.28957735e+02
  1.28957735e+02  1.28957735e+02  4.83288891e+02  4.83288891e+02
  4.83288891e+02  5.59158710e+02  1.33513068e+03  1.33513068e+03
  1.33513068e+03  2.63113522e+03  3.02937939e+03  3.02937939e+03
  3.02937939e+03  6.64982378e+03  6.64982378e+03  6.64982378e+03
  9.03868011e+03  2.53954572e+04  7.61392126e+04]
E1 = -728.2998743622319  E_coul = 201.82200135743201
Extra cycle  E= -526.4778730048  delta_E= -4.09e-12  |g|= 1.86e-06  |ddm|= 3.62e-06
    CPU time for scf_cycle      0.73 sec, wall time      0.33 sec
exp = [2.61826559e+04 7.61752192e+03 3.61735087e+03 1.59782569e+03
 3.82851149e+02 1.08121083e+02 3.48054691e+01 4.58522391e+00
 3.95313491e-01 1.36278321e+03 6.64745681e+02 3.00961992e+02
 3.14042274e+02 6.16222359e+01 7.32989795e+00 2.02391201e+01
 7.72070365e-01 2.80887843e+00 2.22573632e-01]
E = -526.4778730047999
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:46:59 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558552        1
[INPUT] 0    0    [1    /1   ]  7617.52191563        1
[INPUT] 0    0    [1    /1   ]  3617.35086742        1
[INPUT] 0    0    [1    /1   ]  1597.82569303        1
[INPUT] 0    0    [1    /1   ]  382.851149473        1
[INPUT] 0    0    [1    /1   ]  108.121083403        1
[INPUT] 0    0    [1    /1   ]  34.8054690698        1
[INPUT] 0    0    [1    /1   ]  4.58522390534        1
[INPUT] 0    0    [1    /1   ]  0.395313490558       1
[INPUT] 1    0    [1    /1   ]  1362.78320627        1
[INPUT] 1    0    [1    /1   ]  664.745680987        1
[INPUT] 1    0    [1    /1   ]  300.961991574        1
[INPUT] 1    0    [1    /1   ]  314.042273999        1
[INPUT] 1    0    [1    /1   ]  61.6222358638        1
[INPUT] 1    0    [1    /1   ]  7.32989794841        1
[INPUT] 1    0    [1    /1   ]  20.2391201296        1
[INPUT] 1    0    [1    /1   ]  0.772070364573       1
[INPUT] 1    0    [1    /1   ]  2.80887843481        1
[INPUT] 1    0    [1    /1   ]  0.222573632039       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.65585524854, 1.0]], [0, [7617.521915627052, 1.0]], [0, [3617.3508674245704, 1.0]], [0, [1597.8256930291025, 1.0]], [0, [382.85114947300525, 1.0]], [0, [108.1210834029935, 1.0]], [0, [34.80546906975482, 1.0]], [0, [4.585223905343421, 1.0]], [0, [0.39531349055767473, 1.0]], [1, [1362.7832062666114, 1.0]], [1, [664.7456809871924, 1.0]], [1, [300.9619915744506, 1.0]], [1, [314.0422739991703, 1.0]], [1, [61.622235863813884, 1.0]], [1, [7.329897948406479, 1.0]], [1, [20.239120129550937, 1.0]], [1, [0.7720703645725635, 1.0]], [1, [2.8088784348099196, 1.0]], [1, [0.22257363203907735, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65585525]
bas 1, expnt(s) = [7617.52191563]
bas 2, expnt(s) = [3617.35086742]
bas 3, expnt(s) = [1597.82569303]
bas 4, expnt(s) = [382.85114947]
bas 5, expnt(s) = [108.1210834]
bas 6, expnt(s) = [34.80546907]
bas 7, expnt(s) = [4.58522391]
bas 8, expnt(s) = [0.39531349]
bas 9, expnt(s) = [1362.78320627]
bas 10, expnt(s) = [664.74568099]
bas 11, expnt(s) = [300.96199157]
bas 12, expnt(s) = [314.042274]
bas 13, expnt(s) = [61.62223586]
bas 14, expnt(s) = [7.32989795]
bas 15, expnt(s) = [20.23912013]
bas 16, expnt(s) = [0.77207036]
bas 17, expnt(s) = [2.80887843]
bas 18, expnt(s) = [0.22257363]
CPU time:       920.43
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752192e+03 2.06003837e+03
 3.61735087e+03 1.17844143e+03 1.59782569e+03 6.38501724e+02
 3.82851149e+02 2.18669137e+02 1.08121083e+02 8.47125619e+01
 3.48054691e+01 3.62035070e+01 4.58522391e+00 7.91654045e+00
 3.95313491e-01 1.25956693e+00 1.36278321e+03 2.41556016e+04
 6.64745681e+02 9.84699683e+03 3.00961992e+02 3.65699156e+03
 3.14042274e+02 3.85673265e+03 6.16222359e+01 5.03681741e+02
 7.32989795e+00 3.51849390e+01 2.02391201e+01 1.25234483e+02
 7.72070365e-01 2.11132697e+00 2.80887843e+00 1.06084167e+01
 2.22573632e-01 4.45991451e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97685654436697
cond(S) = 99911.36193712578
E1 = -728.8856047386636  E_coul = 203.12418858982087
init E= -525.761416148843
    CPU time for initialize scf      0.45 sec, wall time      0.06 sec
  HOMO = -0.559376415127525  LUMO = 1.02597080227682
  mo_energy =
[-1.18319187e+02 -1.21034345e+01 -9.44869724e+00 -9.44869724e+00
 -9.44869724e+00 -1.23003815e+00 -5.59376415e-01 -5.59376415e-01
 -5.59376415e-01  1.02597080e+00  1.02597080e+00  1.02597080e+00
  7.32997550e+00  7.32997550e+00  7.32997550e+00  3.34912321e+01
  3.34912321e+01  3.34912321e+01  7.49151213e+01  1.29121660e+02
  1.29121660e+02  1.29121660e+02  4.83525515e+02  4.83525515e+02
  4.83525515e+02  5.59434626e+02  1.33542366e+03  1.33542366e+03
  1.33542366e+03  2.63156228e+03  3.02973780e+03  3.02973780e+03
  3.02973780e+03  6.65029577e+03  6.65029577e+03  6.65029577e+03
  9.03922807e+03  2.53960997e+04  7.61399457e+04]
E1 = -728.045425590601  E_coul = 201.56795854096006
cycle= 1 E= -526.477467049641  delta_E= -0.716  |g|= 0.185  |ddm|= 0.368
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.545545
diis-c [-0.29761961  1.        ]
  HOMO = -0.575543271152619  LUMO = 1.01628531411305
  mo_energy =
[-1.18599462e+02 -1.22050365e+01 -9.55666182e+00 -9.55666182e+00
 -9.55666182e+00 -1.25387862e+00 -5.75543271e-01 -5.75543271e-01
 -5.75543271e-01  1.01628531e+00  1.01628531e+00  1.01628531e+00
  7.27208567e+00  7.27208567e+00  7.27208567e+00  3.33743670e+01
  3.33743670e+01  3.33743670e+01  7.47450606e+01  1.28927505e+02
  1.28927505e+02  1.28927505e+02  4.83250770e+02  4.83250770e+02
  4.83250770e+02  5.59118766e+02  1.33508978e+03  1.33508978e+03
  1.33508978e+03  2.63109248e+03  3.02933713e+03  3.02933713e+03
  3.02933713e+03  6.64978077e+03  6.64978077e+03  6.64978077e+03
  9.03863683e+03  2.53954139e+04  7.61391693e+04]
E1 = -728.3558623619144  E_coul = 201.87800391007633
cycle= 2 E= -526.477858451838  delta_E= -0.000391  |g|= 0.0249  |ddm|= 0.0214
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0486254
diis-c [-0.00151164  0.05093228  0.94906772]
  HOMO = -0.571611002009587  LUMO = 1.01930297083905
  mo_energy =
[-1.18555493e+02 -1.21838066e+01 -9.53501323e+00 -9.53501323e+00
 -9.53501323e+00 -1.24866116e+00 -5.71611002e-01 -5.71611002e-01
 -5.71611002e-01  1.01930297e+00  1.01930297e+00  1.01930297e+00
  7.28372554e+00  7.28372554e+00  7.28372554e+00  3.33967533e+01
  3.33967533e+01  3.33967533e+01  7.47802025e+01  1.28962072e+02
  1.28962072e+02  1.28962072e+02  4.83294147e+02  4.83294147e+02
  4.83294147e+02  5.59164222e+02  1.33513632e+03  1.33513632e+03
  1.33513632e+03  2.63114127e+03  3.02938527e+03  3.02938527e+03
  3.02938527e+03  6.64982992e+03  6.64982992e+03  6.64982992e+03
  9.03868639e+03  2.53954636e+04  7.61392191e+04]
E1 = -728.2912819711299  E_coul = 201.81340928450317
cycle= 3 E= -526.477872686627  delta_E= -1.42e-05  |g|= 0.00306  |ddm|= 0.00545
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00657773
diis-c [-3.68998756e-07 -1.07961955e-03  1.12673102e-01  8.88406518e-01]
  HOMO = -0.572315010168722  LUMO = 1.0187779860514
  mo_energy =
[-1.18560906e+02 -1.21867744e+01 -9.53808708e+00 -9.53808708e+00
 -9.53808708e+00 -1.24957425e+00 -5.72315010e-01 -5.72315010e-01
 -5.72315010e-01  1.01877799e+00  1.01877799e+00  1.01877799e+00
  7.28188596e+00  7.28188596e+00  7.28188596e+00  3.33936264e+01
  3.33936264e+01  3.33936264e+01  7.47758452e+01  1.28957652e+02
  1.28957652e+02  1.28957652e+02  4.83288808e+02  4.83288808e+02
  4.83288808e+02  5.59158630e+02  1.33513060e+03  1.33513060e+03
  1.33513060e+03  2.63113515e+03  3.02937931e+03  3.02937931e+03
  3.02937931e+03  6.64982371e+03  6.64982371e+03  6.64982371e+03
  9.03868005e+03  2.53954572e+04  7.61392126e+04]
E1 = -728.3000644217392  E_coul = 201.82219141710627
cycle= 4 E= -526.477873004633  delta_E= -3.18e-07  |g|= 4.58e-05  |ddm|= 0.000799
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=6.33219e-05
diis-c [-1.91644099e-09  8.81293268e-07 -1.05912967e-03 -9.08857841e-04
  1.00196711e+00]
  HOMO = -0.57228624107958  LUMO = 1.0187989435518
  mo_energy =
[-1.18560805e+02 -1.21866814e+01 -9.53799496e+00 -9.53799496e+00
 -9.53799496e+00 -1.24953685e+00 -5.72286241e-01 -5.72286241e-01
 -5.72286241e-01  1.01879894e+00  1.01879894e+00  1.01879894e+00
  7.28195150e+00  7.28195150e+00  7.28195150e+00  3.33937154e+01
  3.33937154e+01  3.33937154e+01  7.47759485e+01  1.28957750e+02
  1.28957750e+02  1.28957750e+02  4.83288908e+02  4.83288908e+02
  4.83288908e+02  5.59158728e+02  1.33513070e+03  1.33513070e+03
  1.33513070e+03  2.63113524e+03  3.02937941e+03  3.02937941e+03
  3.02937941e+03  6.64982380e+03  6.64982380e+03  6.64982380e+03
  9.03868013e+03  2.53954572e+04  7.61392127e+04]
E1 = -728.2998397181486  E_coul = 201.82196671335282
cycle= 5 E= -526.477873004796  delta_E= -1.63e-10  |g|= 7.18e-06  |ddm|= 2.54e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.2998397181486  E_coul = 201.82196671335282
  HOMO = -0.572290009983499  LUMO = 1.0187961890717
  mo_energy =
[-1.18560822e+02 -1.21866944e+01 -9.53800820e+00 -9.53800820e+00
 -9.53800820e+00 -1.24954173e+00 -5.72290010e-01 -5.72290010e-01
 -5.72290010e-01  1.01879619e+00  1.01879619e+00  1.01879619e+00
  7.28194259e+00  7.28194259e+00  7.28194259e+00  3.33937023e+01
  3.33937023e+01  3.33937023e+01  7.47759326e+01  1.28957735e+02
  1.28957735e+02  1.28957735e+02  4.83288891e+02  4.83288891e+02
  4.83288891e+02  5.59158710e+02  1.33513068e+03  1.33513068e+03
  1.33513068e+03  2.63113522e+03  3.02937939e+03  3.02937939e+03
  3.02937939e+03  6.64982378e+03  6.64982378e+03  6.64982378e+03
  9.03868011e+03  2.53954572e+04  7.61392126e+04]
E1 = -728.2998743622319  E_coul = 201.82200135743201
Extra cycle  E= -526.4778730048  delta_E= -4.09e-12  |g|= 1.86e-06  |ddm|= 3.62e-06
    CPU time for scf_cycle      0.72 sec, wall time      0.33 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 99911.36193712578
E1 = -728.2998743622319  E_coul = 201.82200135743201
init E= -526.4778730048
    CPU time for initialize scf      2.82 sec, wall time      0.26 sec
  HOMO = -0.572289353052807  LUMO = 1.01879667512992
  mo_energy =
[-1.18560818e+02 -1.21866918e+01 -9.53800559e+00 -9.53800559e+00
 -9.53800559e+00 -1.24954088e+00 -5.72289353e-01 -5.72289353e-01
 -5.72289353e-01  1.01879668e+00  1.01879668e+00  1.01879668e+00
  7.28194423e+00  7.28194423e+00  7.28194423e+00  3.33937049e+01
  3.33937049e+01  3.33937049e+01  7.47759361e+01  1.28957738e+02
  1.28957738e+02  1.28957738e+02  4.83288895e+02  4.83288895e+02
  4.83288895e+02  5.59158714e+02  1.33513069e+03  1.33513069e+03
  1.33513069e+03  2.63113523e+03  3.02937939e+03  3.02937939e+03
  3.02937939e+03  6.64982379e+03  6.64982379e+03  6.64982379e+03
  9.03868012e+03  2.53954572e+04  7.61392126e+04]
E1 = -728.2998672138591  E_coul = 201.82199420905985
cycle= 1 E= -526.477873004799  delta_E= 6.82e-13  |g|= 4.17e-07  |ddm|= 6.88e-07
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
E1 = -728.2998672138591  E_coul = 201.82199420905985
  HOMO = -0.572289480676298  LUMO = 1.01879658025057
  mo_energy =
[-1.18560819e+02 -1.21866923e+01 -9.53800613e+00 -9.53800613e+00
 -9.53800613e+00 -1.24954104e+00 -5.72289481e-01 -5.72289481e-01
 -5.72289481e-01  1.01879658e+00  1.01879658e+00  1.01879658e+00
  7.28194391e+00  7.28194391e+00  7.28194391e+00  3.33937044e+01
  3.33937044e+01  3.33937044e+01  7.47759354e+01  1.28957737e+02
  1.28957737e+02  1.28957737e+02  4.83288894e+02  4.83288894e+02
  4.83288894e+02  5.59158713e+02  1.33513069e+03  1.33513069e+03
  1.33513069e+03  2.63113523e+03  3.02937939e+03  3.02937939e+03
  3.02937939e+03  6.64982379e+03  6.64982379e+03  6.64982379e+03
  9.03868012e+03  2.53954572e+04  7.61392126e+04]
E1 = -728.2998687116168  E_coul = 201.8219957068163
Extra cycle  E= -526.4778730048  delta_E= -1.25e-12  |g|= 9.04e-08  |ddm|= 1.4e-07
    CPU time for scf_cycle      2.98 sec, wall time      0.42 sec
exp = [2.61826559e+04 7.61752192e+03 3.61735087e+03 1.59782569e+03
 3.82851149e+02 1.08121083e+02 3.48054691e+01 4.58522391e+00
 3.95313491e-01 1.36278321e+03 6.64745681e+02 3.00961992e+02
 3.14042274e+02 6.16222359e+01 7.32989795e+00 2.02391201e+01
 7.72070365e-01 2.80887843e+00 2.22573632e-01]
grad_E = [-1.51190118e-06  3.30540668e-06 -1.44615363e-06  6.89891055e-05
  2.66110689e-05 -6.65020646e-05  3.07359617e-04  1.13241952e-04
  2.80078878e-03 -5.09243799e-07  4.97493890e-06  2.34192587e-05
  2.01925350e-05  6.62615799e-06  9.50883407e-04 -2.27246052e-04
 -1.30928759e-03 -1.36879082e-03  6.73513357e-03]
 message: Iteration limit reached
 success: False
  status: 9
     fun: -526.4778730047999
       x: [ 2.618e+04  7.618e+03 ...  2.809e+00  2.226e-01]
     nit: 100
     jac: [-1.512e-06  3.305e-06 ... -1.369e-03  6.735e-03]
    nfev: 110
    njev: 100
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 9
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182507849929175e+04  0 ;\
7.6182507849929175e+03  0 ;\
3.6182507849929175e+03  0 ;\
1.6182507849929175e+03  0 ;\
2.3978398735110531e+02  0 ;\
5.1897914206496637e+01  0 ;\
4.3870852942693928e+00  0 ;\
4.3870852942693928e-01  0 ;\
9.3870852942693928e-02  0 ;\
1.3627930032386791e+03  0 ;\
6.6518072575151780e+02  0 ;\
3.0332064186335555e+02  0 ;\
3.1614645606305231e+02  0 ;\
4.9300144018458525e+01  0 ;\
4.7537785732569198e+00  0 ;\
1.4747293500057861e+01  0 ;\
4.0328123273769173e-01  0 ;\
1.2333383692864934e+00  0 ;\
3.8716558480433622e-02  0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr1419.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 08:47:04 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62937957.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558552        1
[INPUT] 0    0    [1    /1   ]  7617.52191563        1
[INPUT] 0    0    [1    /1   ]  3617.35086742        1
[INPUT] 0    0    [1    /1   ]  1597.82569303        1
[INPUT] 0    0    [1    /1   ]  382.851149473        1
[INPUT] 0    0    [1    /1   ]  108.121083403        1
[INPUT] 0    0    [1    /1   ]  34.8054690698        1
[INPUT] 0    0    [1    /1   ]  4.58522390534        1
[INPUT] 0    0    [1    /1   ]  0.395313490558       1
[INPUT] 1    0    [1    /1   ]  1362.78320627        1
[INPUT] 1    0    [1    /1   ]  664.745680987        1
[INPUT] 1    0    [1    /1   ]  300.961991574        1
[INPUT] 1    0    [1    /1   ]  314.042273999        1
[INPUT] 1    0    [1    /1   ]  61.6222358638        1
[INPUT] 1    0    [1    /1   ]  7.32989794841        1
[INPUT] 1    0    [1    /1   ]  20.2391201296        1
[INPUT] 1    0    [1    /1   ]  0.772070364573       1
[INPUT] 1    0    [1    /1   ]  2.80887843481        1
[INPUT] 1    0    [1    /1   ]  0.222573632039       1

nuclear repulsion = 0
number of shells = 19
number of NR pGTOs = 39
number of NR cGTOs = 39
basis = {'Ar': [[0, [26182.65585524854, 1.0]], [0, [7617.521915627052, 1.0]], [0, [3617.3508674245704, 1.0]], [0, [1597.8256930291025, 1.0]], [0, [382.85114947300525, 1.0]], [0, [108.1210834029935, 1.0]], [0, [34.80546906975482, 1.0]], [0, [4.585223905343421, 1.0]], [0, [0.39531349055767473, 1.0]], [1, [1362.7832062666114, 1.0]], [1, [664.7456809871924, 1.0]], [1, [300.9619915744506, 1.0]], [1, [314.0422739991703, 1.0]], [1, [61.622235863813884, 1.0]], [1, [7.329897948406479, 1.0]], [1, [20.239120129550937, 1.0]], [1, [0.7720703645725635, 1.0]], [1, [2.8088784348099196, 1.0]], [1, [0.22257363203907735, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65585525]
bas 1, expnt(s) = [7617.52191563]
bas 2, expnt(s) = [3617.35086742]
bas 3, expnt(s) = [1597.82569303]
bas 4, expnt(s) = [382.85114947]
bas 5, expnt(s) = [108.1210834]
bas 6, expnt(s) = [34.80546907]
bas 7, expnt(s) = [4.58522391]
bas 8, expnt(s) = [0.39531349]
bas 9, expnt(s) = [1362.78320627]
bas 10, expnt(s) = [664.74568099]
bas 11, expnt(s) = [300.96199157]
bas 12, expnt(s) = [314.042274]
bas 13, expnt(s) = [61.62223586]
bas 14, expnt(s) = [7.32989795]
bas 15, expnt(s) = [20.23912013]
bas 16, expnt(s) = [0.77207036]
bas 17, expnt(s) = [2.80887843]
bas 18, expnt(s) = [0.22257363]
CPU time:       929.33
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752192e+03 2.06003837e+03
 3.61735087e+03 1.17844143e+03 1.59782569e+03 6.38501724e+02
 3.82851149e+02 2.18669137e+02 1.08121083e+02 8.47125619e+01
 3.48054691e+01 3.62035070e+01 4.58522391e+00 7.91654045e+00
 3.95313491e-01 1.25956693e+00 1.36278321e+03 2.41556016e+04
 6.64745681e+02 9.84699683e+03 3.00961992e+02 3.65699156e+03
 3.14042274e+02 3.85673265e+03 6.16222359e+01 5.03681741e+02
 7.32989795e+00 3.51849390e+01 2.02391201e+01 1.25234483e+02
 7.72070365e-01 2.11132697e+00 2.80887843e+00 1.06084167e+01
 2.22573632e-01 4.45991451e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.97685654436697
cond(S) = 99911.36193712578
E1 = -728.8856047386636  E_coul = 203.12418858982087
init E= -525.761416148843
    CPU time for initialize scf      0.45 sec, wall time      0.06 sec
  HOMO = -0.559376415127525  LUMO = 1.02597080227682
  mo_energy =
[-1.18319187e+02 -1.21034345e+01 -9.44869724e+00 -9.44869724e+00
 -9.44869724e+00 -1.23003815e+00 -5.59376415e-01 -5.59376415e-01
 -5.59376415e-01  1.02597080e+00  1.02597080e+00  1.02597080e+00
  7.32997550e+00  7.32997550e+00  7.32997550e+00  3.34912321e+01
  3.34912321e+01  3.34912321e+01  7.49151213e+01  1.29121660e+02
  1.29121660e+02  1.29121660e+02  4.83525515e+02  4.83525515e+02
  4.83525515e+02  5.59434626e+02  1.33542366e+03  1.33542366e+03
  1.33542366e+03  2.63156228e+03  3.02973780e+03  3.02973780e+03
  3.02973780e+03  6.65029577e+03  6.65029577e+03  6.65029577e+03
  9.03922807e+03  2.53960997e+04  7.61399457e+04]
E1 = -728.045425590601  E_coul = 201.56795854096006
cycle= 1 E= -526.477467049641  delta_E= -0.716  |g|= 0.185  |ddm|= 0.368
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.545545
diis-c [-0.29761961  1.        ]
  HOMO = -0.575543271152619  LUMO = 1.01628531411305
  mo_energy =
[-1.18599462e+02 -1.22050365e+01 -9.55666182e+00 -9.55666182e+00
 -9.55666182e+00 -1.25387862e+00 -5.75543271e-01 -5.75543271e-01
 -5.75543271e-01  1.01628531e+00  1.01628531e+00  1.01628531e+00
  7.27208567e+00  7.27208567e+00  7.27208567e+00  3.33743670e+01
  3.33743670e+01  3.33743670e+01  7.47450606e+01  1.28927505e+02
  1.28927505e+02  1.28927505e+02  4.83250770e+02  4.83250770e+02
  4.83250770e+02  5.59118766e+02  1.33508978e+03  1.33508978e+03
  1.33508978e+03  2.63109248e+03  3.02933713e+03  3.02933713e+03
  3.02933713e+03  6.64978077e+03  6.64978077e+03  6.64978077e+03
  9.03863683e+03  2.53954139e+04  7.61391693e+04]
E1 = -728.3558623619144  E_coul = 201.87800391007633
cycle= 2 E= -526.477858451838  delta_E= -0.000391  |g|= 0.0249  |ddm|= 0.0214
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0486254
diis-c [-0.00151164  0.05093228  0.94906772]
  HOMO = -0.571611002009587  LUMO = 1.01930297083905
  mo_energy =
[-1.18555493e+02 -1.21838066e+01 -9.53501323e+00 -9.53501323e+00
 -9.53501323e+00 -1.24866116e+00 -5.71611002e-01 -5.71611002e-01
 -5.71611002e-01  1.01930297e+00  1.01930297e+00  1.01930297e+00
  7.28372554e+00  7.28372554e+00  7.28372554e+00  3.33967533e+01
  3.33967533e+01  3.33967533e+01  7.47802025e+01  1.28962072e+02
  1.28962072e+02  1.28962072e+02  4.83294147e+02  4.83294147e+02
  4.83294147e+02  5.59164222e+02  1.33513632e+03  1.33513632e+03
  1.33513632e+03  2.63114127e+03  3.02938527e+03  3.02938527e+03
  3.02938527e+03  6.64982992e+03  6.64982992e+03  6.64982992e+03
  9.03868639e+03  2.53954636e+04  7.61392191e+04]
E1 = -728.2912819711299  E_coul = 201.81340928450317
cycle= 3 E= -526.477872686627  delta_E= -1.42e-05  |g|= 0.00306  |ddm|= 0.00545
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00657773
diis-c [-3.68998756e-07 -1.07961955e-03  1.12673102e-01  8.88406518e-01]
  HOMO = -0.572315010168722  LUMO = 1.0187779860514
  mo_energy =
[-1.18560906e+02 -1.21867744e+01 -9.53808708e+00 -9.53808708e+00
 -9.53808708e+00 -1.24957425e+00 -5.72315010e-01 -5.72315010e-01
 -5.72315010e-01  1.01877799e+00  1.01877799e+00  1.01877799e+00
  7.28188596e+00  7.28188596e+00  7.28188596e+00  3.33936264e+01
  3.33936264e+01  3.33936264e+01  7.47758452e+01  1.28957652e+02
  1.28957652e+02  1.28957652e+02  4.83288808e+02  4.83288808e+02
  4.83288808e+02  5.59158630e+02  1.33513060e+03  1.33513060e+03
  1.33513060e+03  2.63113515e+03  3.02937931e+03  3.02937931e+03
  3.02937931e+03  6.64982371e+03  6.64982371e+03  6.64982371e+03
  9.03868005e+03  2.53954572e+04  7.61392126e+04]
E1 = -728.3000644217392  E_coul = 201.82219141710627
cycle= 4 E= -526.477873004633  delta_E= -3.18e-07  |g|= 4.58e-05  |ddm|= 0.000799
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=6.33219e-05
diis-c [-1.91644099e-09  8.81293268e-07 -1.05912967e-03 -9.08857841e-04
  1.00196711e+00]
  HOMO = -0.57228624107958  LUMO = 1.0187989435518
  mo_energy =
[-1.18560805e+02 -1.21866814e+01 -9.53799496e+00 -9.53799496e+00
 -9.53799496e+00 -1.24953685e+00 -5.72286241e-01 -5.72286241e-01
 -5.72286241e-01  1.01879894e+00  1.01879894e+00  1.01879894e+00
  7.28195150e+00  7.28195150e+00  7.28195150e+00  3.33937154e+01
  3.33937154e+01  3.33937154e+01  7.47759485e+01  1.28957750e+02
  1.28957750e+02  1.28957750e+02  4.83288908e+02  4.83288908e+02
  4.83288908e+02  5.59158728e+02  1.33513070e+03  1.33513070e+03
  1.33513070e+03  2.63113524e+03  3.02937941e+03  3.02937941e+03
  3.02937941e+03  6.64982380e+03  6.64982380e+03  6.64982380e+03
  9.03868013e+03  2.53954572e+04  7.61392127e+04]
E1 = -728.2998397181486  E_coul = 201.82196671335282
cycle= 5 E= -526.477873004796  delta_E= -1.63e-10  |g|= 7.18e-06  |ddm|= 2.54e-05
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
E1 = -728.2998397181486  E_coul = 201.82196671335282
  HOMO = -0.572290009983499  LUMO = 1.0187961890717
  mo_energy =
[-1.18560822e+02 -1.21866944e+01 -9.53800820e+00 -9.53800820e+00
 -9.53800820e+00 -1.24954173e+00 -5.72290010e-01 -5.72290010e-01
 -5.72290010e-01  1.01879619e+00  1.01879619e+00  1.01879619e+00
  7.28194259e+00  7.28194259e+00  7.28194259e+00  3.33937023e+01
  3.33937023e+01  3.33937023e+01  7.47759326e+01  1.28957735e+02
  1.28957735e+02  1.28957735e+02  4.83288891e+02  4.83288891e+02
  4.83288891e+02  5.59158710e+02  1.33513068e+03  1.33513068e+03
  1.33513068e+03  2.63113522e+03  3.02937939e+03  3.02937939e+03
  3.02937939e+03  6.64982378e+03  6.64982378e+03  6.64982378e+03
  9.03868011e+03  2.53954572e+04  7.61392126e+04]
E1 = -728.2998743622319  E_coul = 201.82200135743201
Extra cycle  E= -526.4778730048  delta_E= -4.09e-12  |g|= 1.86e-06  |ddm|= 3.62e-06
    CPU time for scf_cycle      0.72 sec, wall time      0.33 sec
exp = [2.61826559e+04 7.61752192e+03 3.61735087e+03 1.59782569e+03
 3.82851149e+02 1.08121083e+02 3.48054691e+01 4.58522391e+00
 3.95313491e-01 1.36278321e+03 6.64745681e+02 3.00961992e+02
 3.14042274e+02 6.16222359e+01 7.32989795e+00 2.02391201e+01
 7.72070365e-01 2.80887843e+00 2.22573632e-01]
E = -526.4778730047999
E = -526.4778730047999
exp = [2.6182655855248540e+04,7.6175219156270523e+03,3.6173508674245704e+03,1.5978256930291025e+03,3.8285114947300525e+02,1.0812108340299351e+02,3.4805469069754821e+01,4.5852239053434207e+00,3.9531349055767473e-01,1.3627832062666114e+03,6.6474568098719237e+02,3.0096199157445062e+02,3.1404227399917028e+02,6.1622235863813884e+01,7.3298979484064786e+00,2.0239120129550937e+01,7.7207036457256351e-01,2.8088784348099196e+00,2.2257363203907735e-01]

real	8m22.307s
user	13m52.612s
sys	1m40.115s
